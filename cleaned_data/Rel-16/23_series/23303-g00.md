# Foreword
This Technical Specification has been produced by the 3^rd^ Generation
Partnership Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# 1 Scope
The present document specifies the Stage 2 of the Proximity Services (ProSe)
features in EPS. ProSe features consist of: ProSe discovery (direct or EPC-
level) and ProSe Direct Communication.
ProSe discovery identifies that ProSe-enabled UEs are in proximity, using
E-UTRAN (with or without E-UTRAN), WLAN technology or EPC. The details of
WLAN-based ProSe Direct Discovery are described in clause 5.3.1.3 and Annex C.
ProSe Direct Communication enables establishment of communication paths
between two or more ProSe-enabled UEs that are in direct communication range.
The ProSe Direct Communication path could use E-UTRAN or WLAN.
For Public Safety specific usage:
\- ProSe-enabled Public Safety UEs can establish the communication path
directly between two or more ProSe-enabled Public Safety UEs, regardless of
whether the ProSe-enabled Public Safety UE is served by E-UTRAN.
\- ProSe Direct Communication is also facilitated by the use of a ProSe UE-to-
Network Relay, which acts as a relay between E-UTRAN and UEs.
Security aspects of ProSe are defined in TS 33.303 [29].
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or nonâ€‘specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
[1] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[2] Open Mobile Alliance, OMA AD SUPL: \"Secure User Plane Location
Architecture\", (http://www.openmobilealliance.org).
[3] 3GPP TS 23.032: \"Universal Geographical Area Description (GAD)\".
[4] Void.
[5] 3GPP TS 23.401: \"General Packet Radio Service (GPRS) enhancements for
Evolved Universal Terrestrial Radio Access Network (E-UTRAN) access\".
[6] IETF RFC 4862: \"IPv6 Stateless Address Autoconfiguration\".
[7] IETF RFC 2131: \"Dynamic Host Configuration Protocol\".
[8] IETF RFC 4039: \"Rapid Commit Option for the Dynamic Host Configuration
Protocol version 4 (DHCPv4)\".
[9] 3GPP TS 23.402: \"Architecture enhancements for non-3GPP accesses\".
[10] IETF RFC 4861: \"Neighbor Discovery for IP version 6 (IPv6)\".
[11] 3GPP TS 23.221: \"Architectural requirements\".
[12] 3GPP TS 23.003: \"Numbering, addressing and identification\".
[13] Wi-Fi Alliance Technical Committee P2P Task Group: \"Wi-Fi Peer-to-Peer
(P2P) Technical Specification\", Version 1.1.
[14] IEEE Std 802.11-2012: \"IEEE Standard for Information technology \-
Telecommunications and information exchange between systems - Local and
metropolitan area networks - Specific requirements - Part 11: Wireless LAN
Medium Access Control (MAC) and Physical Layer (PHY) Specifications\".
[15] Void.
[16] IETF RFC 3927: \"Dynamic Configuration of IPv4 Link-Local Addresses\".
[17] 3GPP TS 36.300: \"Evolved Universal Terrestrial Radio Access (E-UTRA) and
Evolved Universal Terrestrial Radio Access Network (E-UTRAN); Overall
description; Stage 2\".
[18] IETF RFC 3588: \"Diameter Base Protocol\".
[19] IETF RFC 4960: \"Stream Control Transmission Protocol\".
[20] Open Mobile Alliance, OMA LIF MLP: \"Mobile Location Protocol\",
(http://www.openmobilealliance.org).
[21] 3GPP TS 29.343: \"Proximity-services (Prose) Function to Proximity-
services (ProSe) Application Server aspects (PC2); Stage 3\".
[22] 3GPP TS 29.344: \"Proximity-services (Prose) Function to Home Subscriber
Server (HSS) aspects; Stage 3\".
[23] 3GPP TS 29.345: \"Inter-Proximity-services (Prose) Function signalling
aspects; Stage 3\".
[24] 3GPP TS 24.334: \"Proximity-services (Prose) User Equipment (UE) to
Proximity-services (ProSe) Function Protocol aspects; Stage 3\".
[25] 3GPP TS 22.278: \"Service requirements for the Evolved Packet System
(EPS)\".
[26] 3GPP TS 23.468: \"Group Communication System Enablers for LTE (GCSE_LTE);
Stage 2\".
[27] Void.
[28] IETF RFC 826: \"An Ethernet Address Resolution Protocol\".
[29] 3GPP TS 33.303: \"Proximity-based Services (ProSe); Security aspects\".
[30] OMA-TS-DM_Protocol-V1_2: \"OMA Device Management Protocol\".
[31] 3GPP TS 23.122: \"Non-Access-Stratum (NAS) functions related to Mobile
Station (MS) in idle mode\".
[32] 3GPP TS 36.304: \"Evolved Universal Terrestrial Radio Access (E-UTRA);
User Equipment (UE) procedures in idle mode\".
[33] 3GPP TS 36.331: \"Evolved Universal Terrestrial Radio Access (E-UTRA);
Radio Resource Control (RRC); Protocol specification\".
[34] IETF RFC 6762: \"Multicast DNS\".
[35] 3GPP TS 23.203: \"Policy and charging control architecture\".
[36] 3GPP TS 23.060: \"General Packet Radio Service (GPRS); Service
description; Stage 2\".
[37] 3GPP TS 29.272: \"Mobility Management Entity (MME) and Serving GPRS
Support Node (SGSN) related interfaces based on Diameter protocol\".
[38] Wi-Fi Alliance Technical Task Group: \"Wi-Fi Neighbor Awareness
Networking Technical Specification\", Version 1.0.
# 3 Definitions and abbreviations
## 3.1 Definitions
For the purposes of the present document, the terms and definitions given in
TR 21.905 [1] and the following apply. A term defined in the present document
takes precedence over the definition of the same term, if any, in TR 21.905
[1].
**Application ID:** A globally unique identifier identifying a specific
application. This is the identifier used in mobile operating systems by the
applications within the mobile operating system. All mobile operating systems
have namespaces that identify the applications within the mobile operating
system.
**Application Layer User ID:** An identity identifying a user within the
context of a specific application (e.g. alice\@social.net). The format of this
identifier is outside the scope of 3GPP.
**Application Layer Group ID:** An identity uniquely identifying a group of
users within the context of a specific application.
**Application Level Container:** An application layer package opaque to the
3GPP networks.
**Destination Layer-2 ID:** A link-layer identity that identifies a device or
a group of devices that are recipients of ProSe communication frames.
**Discovery Entry ID:** An identifier allocated by the ProSe Function to
reference a discovery entry in the UE\'s context as a result of a discovery
request. It is returned to the UE in a Discovery Response, and can be used in
the following procedures by either the ProSe Function or the UE to refer to
the discovery entry.
**Discovery Filter:** A container of a ProSe Application code / ProSe
Restricted code, zero or more ProSe Application Mask(s) and Time To Live
value. These are used by the monitoring UE to match ProSe Application Codes /
ProSe Restricted codes that are received on the PC5 interface for Direct
Discovery.
**Discovery Group ID:** The Discovery Group ID identifies a group of Public
Safety users that are affiliated for Group Member Discovery. It is configured
for Model A or Model B Public Safety Direct Discovery based on the policy of
the HPLMN or 3rd party public safety provider application server that
allocates it. The Discovery Group ID is sent by the announcing, discoverer or
discoveree UE over the air. The definition of values of Discovery Group ID is
out of scope of this specification.
**Discovery Query Filter:** This is a Discovery Filter that is allocated by
the ProSe Function in the HPLMN to the Discoveree UE for Model B discovery.
The Discovery Query Filter is used by the Discoveree UE to determine if a
ProSe Query Code received over the air should trigger sending of a ProSe
Response Code.
**Discovery Response Filter:** This is a Discovery Filter that is allocated by
the ProSe Function in the HPLMN to the Discoverer UE for Model B discovery.
The Discovery Response Filter is used by the Discoverer UE to determine if
there is a match with a ProSe Response Code received over the air in response
to a previously announced ProSe Query Code by the Discoverer UE.
**EPC ProSe User ID:** An identifier for EPC-level ProSe Discovery and EPC
support for WLAN direct communication that uniquely identifies a UE registered
for ProSe. This identifier can be occasionally reassigned by the ProSe
Function.
**EPC-level ProSe Discovery:** A ProSe Discovery procedure by which the EPC
determines the proximity of two ProSe-enabled UEs and informs them of their
proximity.
**Geographical Area:** The Geographical Area identifies a region, whose
borders are defined by means of suitable geographic coordinates of e.g. a
polygon or circle outlining its borders.
**Local PLMN:** A PLMN which is not the serving PLMN of the monitoring UE or
announcing UE, and in whose radio resources the monitoring UE or announcing UE
is authorized by the HPLMN to engage in ProSe Direct Discovery.
**Model A:** involves one UE announcing \"I am here\"
**Model B:** involves one UE asking \"who is there\" and/or \"are you there\"
**Metadata Index:** The Metadata Index is part of the ProSe Application Code
that reflects the current metadata version.
**Metadata Index Mask:** The Metadata Index Mask indicates the part used for
the Metadata Index in the ProSe Application Code.
**ProSe Application ID:** The ProSe Application ID is an identity used for
open ProSe Direct Discovery, identifying application related information for
the ProSe-enabled UE. Each ProSe Application ID could be globally unique.
**ProSe Application Code:** The ProSe Application Code is associated with the
ProSe Application ID and used in the open ProSe Direct Discovery procedures.
**ProSe Application Mask:** The ProSe Application Mask is provided by the
ProSe Function in order to allow the monitoring UE to perform partial matching
of ProSe Application Codes / ProSe Restricted Codes on the PC5 interface.
**ProSe Per-Packet Priority:** A scalar value associated with a protocol data
unit that defines the priority handling to be applied for transmission of that
protocol data unit.
**ProSe Per-Packet Reliability** : A scalar value associated with a protocol
data unit that defines the reliability to be applied for transmission of that
protocol data unit.
**ProSe Query Code:** The ProSe Query Code is a ProSe Application Code or
ProSe Restricted Code allocated by the ProSe Function in the HPLMN to the
Discoverer UE for Model B discovery. The ProSe Query Code is sent by the
Discoverer UE over the air.
**ProSe Response Code:** The ProSe Response Code is a ProSe Application Code
or ProSe Restricted Code allocated by the ProSe Function in the HPLMN to the
Discoveree UE for Model B discovery. The ProSe Response Code is sent by the
Discoveree UE over the air upon receiving a ProSe Query Code matching the
Discovery Query Filter.
**ProSe Restricted Code:** ProSe Restricted Code is allocated by the ProSe
Function in the HPLMN for Restricted Direct Discovery and is associated with
one or more Restricted ProSe App User IDs based on the policy of the ProSe
Function that allocates it. The ProSe Restricted Code is sent by the
announcing UE over the air.
**ProSe Restricted Code Prefix:** For restricted Direct Discovery with
application-controlled extension, a part of the ProSe Restricted Code that is
assigned by the ProSe Function in the HPLMN
**ProSe Restricted Code Suffix:** For restricted Direct Discovery with
application-controlled extension, a part of the ProSe Restricted Code that is
under the control of the ProSe Application Server. The ProSe Restricted Code
Suffix represents application specific information pertaining to the
application that is indicated in the restricted ProSe App User ID.
**ProSe Direct Communication:** A communication between two or more UEs in
proximity that are ProSe-enabled, by means of user plane transmission using
E-UTRA technology via a path not traversing any network node.
**ProSe Direct Discovery:** A procedure employed by a ProSe-enabled UE to
discover other ProSe-enabled UEs in its vicinity by using only the
capabilities of the two UEs with E-UTRA or WLAN technology.
**ProSe Discovery:** A process that identifies that a UE that is ProSe-enabled
is in proximity of another, using E-UTRA (with or without E-UTRAN) or EPC.
**ProSe Discovery UE ID:** A temporary identifier assigned by the ProSe
Function in the HPLMN to the UE for the restricted direct discovery service.
It includes the PLMN ID and a temporary identifier that uniquely identifies
the UE in the HPLMN.
**ProSe Function ID:** An FQDN that identifies a ProSe Function.
**ProSe Layer-2 Group ID:** A layer-2 group identifier that may be used to
address a set of users at the 3GPP lower layers. This ID needs to be
configured in the UE before enabling one-to-many ProSe Direct Communication.
**ProSe-enabled non-Public Safety UE:** A UE that supports ProSe procedures
but not capabilities specific to Public Safety.
**ProSe-enabled Public Safety UE:** A UE that the HPLMN has configured to be
authorized for Public Safety use, and which is ProSe-enabled and supports
ProSe procedures and capabilities specific to Public Safety. The UE may, but
need not, have a USIM with one of the special access classes {12, 13, 14}.
**ProSe-enabled UE:** A UE that supports ProSe requirements and associated
procedures. Unless explicitly stated otherwise, a Prose-enabled UE refers both
to a non-Public Safety UE and a Public Safety UE.
**ProSe UE-to-Network Relay:** A UE that provides functionality to support
connectivity to the network for Remote UE(s).
**Relay Service Code:** A Relay Service Code is used to identify a
connectivity service the ProSe UE-to-Network Relay provides, and the
authorized users the ProSe UE-to-Network Relay would offer service to, and may
select the related security policies or information e.g. necessary for
authentication and authorization between the Remote UE and the ProSe UE-to-
Network Relay. The definition of values of Relay Service Code is out of scope
of this specification.
**Remote UE:** A ProSe-enabled Public Safety UE that communicates with a PDN
via a ProSe UE-to-Network Relay.
**Restricted ProSe Application User ID:** An identifier associated with the
Application Layer User ID in the ProSe Application Server in order to
hide/protect the application level user identity from the 3GPP layer. It
unambiguously identifies the user within a given application. The format of
this identifier is outside the scope of 3GPP.
**Source Layer-2 ID:** A link-layer identity that identifies a device that
originates ProSe communication frames.
**User Info ID:** The User Info ID is configured for Model A or Model B Public
Safety Direct Discovery based on the policy of the HPLMN or 3rd party public
safety provider application server that allocates it. The User Info ID is sent
by the announcing or discoverer or discoveree UE over the air. The definition
of values of User Info ID is out of scope of this specification.
**WLAN Link Layer ID:** A link layer identity used for WLAN direct discovery
and/or WLAN direct communication. Depending on the WLAN technology it can be
temporary (e.g. temporary MAC address) or permanent (e.g. permanent MAC
address). The format of this identifier depends on the WLAN technology and is
outside of 3GPP scope.
For the purposes of the present document, the following terms and definitions
given in TS 22.278 [25] apply:
**Open ProSe Discovery**
**Restricted ProSe Discovery**
## 3.2 Abbreviations
For the purposes of the present document, the abbreviations given in TR 21.905
[1] and the following apply. An abbreviation defined in the present document
takes precedence over the definition of the same abbreviation, if any, in TR
21.905 [1].
ALUID Application Layer User ID
DPF Direct Provisioning Function
EPUID EPC ProSe User ID
PFID ProSe Function ID
ProSe Proximity-based Services
PDUID ProSe Discovery UE ID
RPAUID Restricted ProSe Application User ID
SLP SUPL Location Platform
SUPL Secure User Plane Location
TTL Time to Live
WLLID WLAN Link Layer ID
# 4 Architecture Model and Concepts
## 4.1 General Concept
Proximity Services (ProSe) are services that can be provided by the 3GPP
system based on UEs being in proximity to each other.
The 3GPP system enablers for ProSe include the following functions:
\- EPC-level ProSe Discovery;
\- EPC support for WLAN direct discovery and communication;
\- Direct discovery;
\- Direct communication;
\- UE-to-Network Relay.
## 4.2 Architectural Reference Model
Figure 4.2-1 shows the high level view of the non-roaming architecture. In
this figure, UE A and UE B use a subscription of the same PLMN.
Figure 4.2-1: Non-Roaming Reference Architecture
The following figure 4.2-2 show the high level view of the non-roaming inter-
PLMN architecture. In this figure, PLMN A is the HPLMN of UE A and PLMN B is
the HPLMN of UE B.
Figure 4.2-2: Inter-PLMN Reference Architecture
Figure 4.2-3 shows the high level view of the roaming architecture. In this
figure, UE A uses a subscription of PLMN A and UE B uses a subscription of
PLMN B; UE A is roaming in PLMN C while UE B is not roaming.
Figure 4.2-3: Roaming Reference Architecture
NOTE: For EPC-level ProSe discovery the roaming architecture is not specified
in this release.
## 4.3 Reference points
### 4.3.1 List of Reference Points
**PC1** : The reference point between the ProSe application in the UE and in
the ProSe Application Server. It is used to define application level
signalling requirements. This reference point is not specified in this release
of the specification.
**PC2** : The reference point between the ProSe Application Server and the
ProSe Function. It is used to define the interaction between ProSe Application
Server and ProSe functionality provided by the 3GPP EPS via ProSe Function
(e.g. name translation) for ProSe Direct Discovery and EPC-level ProSe
discovery.
**PC3** : The reference point between the UE and the ProSe Function. PC3
relies on EPC user plane for transport (i.e. an \"over IP\" reference point).
It is used to authorise ProSe Direct Discovery and EPC-level ProSe Discovery
requests, and perform allocation of ProSe Application Codes / ProSe Restricted
Codes corresponding to ProSe Application Identities used for ProSe Direct
Discovery. It is used to define the authorisation policy per PLMN for ProSe
Direct Discovery (for Public Safety and non -Public Safety) and communication
(for Public Safety only) between UE and ProSe Function.
**PC4a** : The reference point between the HSS and ProSe Function. It is used
to provide subscription information in order to authorise access for ProSe
Direct Discovery and ProSe Direct Communication on a per PLMN basis. It is
also used by the ProSe Function (i.e. EPC-level ProSe Discovery Function) for
retrieval of EPC-level ProSe Discovery related subscriber data.
**PC4b** : The reference point between the SUPL Location Platform (SLP)
defined in OMA AD SUPL [2] and the ProSe Function. It is used by the ProSe
Function (i.e. EPC-level ProSe Discovery Function) (in the role of LCS client
to query the SLP defined in OMA AD SUPL [2].
**PC5** : The reference point between ProSe-enabled UEs used for control and
user plane for ProSe Direct Discovery, ProSe Direct Communication and ProSe
UE-to-Network Relay. The lower protocol layers of the PC5 reference point can
be based on E-UTRA sidelink capabilities specified in TS 36.300 [17] or on
WLAN technology.
**PC6** : The reference point between ProSe Functions in different PLMNs (EPC-
level ProSe Discovery) or between the ProSe Function in the HPLMN and the
ProSe Function in a Local PLMN (ProSe Direct Discovery). With ProSe Direct
Discovery this reference point is used for HPLMN control of ProSe service
authorization. It is also used to authorise ProSe Direct Discovery requests,
retrieve the Discovery Filter(s) corresponding ProSe Application ID name(s)
and translate the ProSe Application Code to the ProSe Application ID Name.
**PC7** : The reference point between the ProSe Function in the HPLMN and the
ProSe Function in the VPLMN. It is used for HPLMN control of ProSe service
authorization. It is also used to authorise ProSe Direct Discovery requests,
retrieve the Discovery Filter(s) corresponding ProSe Application ID name(s)
and translate the ProSe Application Code to the ProSe Application ID Name.
**S6a** : In addition to the relevant functions defined in TS 23.401 [5] for
S6a, in case of ProSe S6a is used to download ProSe related subscription
information to MME during E UTRAN attach procedure or to inform MME
subscription information in the HSS has changed.
**S1-MME:** In addition to the relevant functions defined in TS 23.401 [5] for
S1-MME, in case of ProSe it is also used to convey the ProSe direct services
authorization from MME to eNodeB.
## 4.4 Functional Entities
### 4.4.1 ProSe Function
#### 4.4.1.1 General
The ProSe Function is the logical function that is used for network related
actions required for ProSe. The ProSe Function plays different roles for each
of the features of ProSe. In this version of the specification it is assumed
that there is only one logical ProSe Function in each PLMN that supports
Proximity Services.
NOTE: If multiple ProSe Functions are deployed within the same PLMN (e.g., for
load reasons), then the method to locate the ProSe Function that has allocated
a specific ProSe Application Code or ProSe Restricted Code (e.g. through a
database lookup, etc.) is not defined in this version of the specification.
Figure 4.4.1-1: UE to ProSe Function Interfaces for each sub-function
Figure 4.4.1-2: ProSe Function Interfaces to other network elements and PLMNs
The ProSe Function consists of three main sub-functions that perform different
roles depending on the ProSe feature:
\- Direct Provisioning Function (DPF) is used to provision the UE with
necessary parameters in order use ProSe Direct Discovery and Prose Direct
Communication. It is used to provision the UEs with PLMN specific parameters
that allow the UE to use ProSe in this specific PLMN. For direct communication
used for Public Safety DPF is also used to provision the UE with parameters
that are needed when the UE is not served by E-UTRAN. For restricted ProSe
Direct Discovery, it also generates and maintains the ProSe Discovery UE ID
(PDUID).
\- Direct Discovery Name Management Function is used for open Prose Direct
Discovery to allocate and process the mapping of ProSe Applications IDs and
ProSe Application Codes used in ProSe Direct Discovery. It uses ProSe related
subscriber data stored in HSS for authorisation for each discovery request. It
also provides the UE with the necessary security material in order to protect
discovery messages transmitted over the air. In restricted ProSe Direct
Discovery, it also interacts with the Application Server via PC2 reference
points for the authorization of the discovery requests.
\- EPC-level Discovery ProSe Function has a reference point towards the
Application Server (PC2), towards other ProSe Functions (PC6), towards the HSS
(PC4a) and the UE (PC3). The functionality includes the following:
\- Storage of ProSe-related subscriber data and/or retrieval of ProSe-related
subscriber data from the HSS;
\- Authorization and configuration of the UE for EPC-level ProSe Discovery and
EPC-assisted WLAN direct discovery and communication over PC3;
\- Storage of a list of applications that are authorized to use EPC-level
ProSe Discovery and EPC-assisted WLAN direct discovery and communication;
\- Acting as location services client (SLP agent) to enable EPC-level ProSe
Discovery;
\- Providing the UE with information to assist WLAN direct discovery and
communications;
\- Handling of EPC ProSe User IDs and Application Layer User IDs;
\- Exchange of signalling with 3^rd^ party Application Servers over PC2
reference point for application registration and identifier mapping;
\- Exchange of signalling with ProSe Functions in other PLMNs over PC6
reference points for sending proximity requests, proximity alerts and location
reporting;
\- Optional support for functionality for requesting UE location via the HSS.
The ProSe Function may support \"on demand\" announcing requested by UE based
on operator\'s policy, in case of ProSe restricted discovery model A.
The ProSe Function provides the necessary charging and security functionality
for usage of ProSe (both ProSe via the EPC and for ProSe Direct Discovery,
ProSe Direct Communication and WLAN direct discovery and communication).
NOTE: The ProSe Function in HPLMN can be always reached if Home Routed
configuration is applied for PDN connection (e.g. PDN GW is located in the
HPLMN), when such function is supported by the HPLMN. In case of Local
Breakout (e.g. PDN GW is located in the VPLMN), a ProSe Proxy Function can be
deployed by the VPLMN to support UE to Home ProSe Function communication, if
inter-PLMN signalling is required. Whether a PDN connection is provided by
Local Breakout or Home Routed is determined by the HSS configuration described
in TS 23.401 [5]. UE is not aware of this and as such will not know which APN
can be used for communication with ProSe Function unless specific APN
information is configured in the UE indicating that this APN provides
signalling connectivity between the UE and the Home ProSe Function.
#### 4.4.1.2 ProSe Function Discovery
The ProSe Functions of HPLMN is discovered through interaction with the Domain
Name Service function. The FQDN of a ProSe Function in the Home PLMN may
either be pre-configured on the UE or provisioned by the network or self-
constructed by the UE, e.g. derived from PLMN ID of the HPLMN. The IP address
of a ProSe Function in the Home PLMN may also be provisioned to the UE.
### 4.4.2 UE
Any ProSe-enabled UE may support the following functions:
\- Exchange of ProSe control information between ProSe-enabled UE and the
ProSe Function over PC3 reference point.
\- Procedures for open and restricted ProSe Direct Discovery of other ProSe-
enabled UEs over PC5 reference point.
The ProSe-enabled Public Safety UE may support the following functions:
\- Procedures for one-to-many ProSe Direct Communication over PC5 reference
point.
\- Procedures for one-to-one ProSe Direct Communication over PC5 reference
point.
\- Procedures to act as a ProSe UE-to-Network Relay. The Remote UE
communicates with the ProSe UE-to-Network Relay over PC5 reference point. The
Prose UE-to-Network Relay uses layer-3 packet forwarding.
\- Exchange of control information between ProSe-UEs over PC5 reference point,
e.g. for UE-to-Network Relay Discovery and Group Member Discovery.
\- Exchange of ProSe control information between another ProSe-enabled UE and
the ProSe Function over PC3 reference point. In the ProSe UE-to-Network Relay
case the Remote UE will send this control information over PC5 user plane to
be relayed over the LTE-Uu interface towards the ProSe Function.
\- Configuration of parameters (e.g. including IP addresses, ProSe Layer-2
Group IDs, Group security material, radio resource parameters). These
parameters can be pre-configured in the UE, or, if in coverage, provisioned by
signalling over the PC3 reference point to the ProSe Function in the network.
### 4.4.3 ProSe UE-to-Network Relay for Public Safety
The ProSe UE-to-Network Relay entity provides the functionality to support
connectivity to the network for Remote UEs (see figure 4.4.3-1).
A UE is considered to be a Remote UE for a certain ProSe UE-to-Network relay
if it has successfully established a PC5 link to this ProSe UE-to-Network
Relay. A Remote UE can be located within E-UTRAN coverage or outside of
E-UTRAN coverage.
NOTE 1: If a Remote UE maintains both PC5 and Uu, the EPS core network
entities on the Uu side of the Remote UE are not aware of the ProSe UE-to-
Network Relay path via PC5.
Figure 4.4.3-1: Architecture model using a ProSe UE-to-Network Relay
The ProSe UE-to-Network Relay shall relay unicast traffic (UL and DL) between
the Remote UE and the network. The ProSe UE-to-Network Relay shall provide
generic function that can relay any IP traffic.
NOTE 2: IP Address preservation is not supported.
One-to-one Direct Communication is used between Remote UEs and ProSe UE-to-
Network Relays for unicast traffic as specified in clause 5.4.5.
The ProSe UE-to-Network Relay may also relay eMBMS traffic using one-to-many
ProSe Direct Communication as specified in clause 5.4.4.4.
### 4.4.4 ProSe Application Server
The ProSe Application Server supports the following capability:
\- Storage of EPC ProSe User IDs: ProSe Function IDs, ProSe Discovery UE ID,
metadata;
\- Mapping of Application Layer User IDs and EPC ProSe User IDs;
\- Mapping of RPAUID and PDUID for restricted ProSe Direct Discovery;
\- Maintaining permission information for the restricted ProSe Direct
Discovery using RPAUIDs;
\- Allocation of the ProSe Restricted Code Suffix pool, if restricted Direct
Discovery with application-controlled extension is used;
\- Allocation of the mask(s) for ProSe Restricted Code Suffix, if restricted
Direct Discovery with application-controlled extension is used.
### 4.4.5 MME
In addition to the function defined in TS 23.401 [5] in case of ProSe MME
performs the following functions:
\- receives subscription information related to ProSe from the HSS;
\- provides indication to the E-UTRAN that the UE is authorized to use ProSe.
\- maintains a list of Remote UEs handled by a UE-to-Network Relay UE for the
specific PDN and forwards the Remote UE information towards S-GW.
### 4.4.6 P-GW
In addition to the function defined in TS 23.401 [5], the P-GW performs the
following functions:
\- receives information related to the ProSe UE-to-Network Relay from the
S-GW;
\- maintains a list of Remote UEs handled by the UE-to-Network Relay UE for
the specific PDN.
### 4.4.7 S-GW
In addition to the function defined in TS 23.401 [5], the S-GW performs the
following functions:
\- receives information related to the ProSe UE-to-Network Relay from the MME;
\- maintains a list of Remote UEs handled by the UE-to-Network Relay UE for
the specific PDN and forwards the Remote UE information towards P-GW.
## 4.5 High Level Function
### 4.5.1 Provisioning for ProSe Direct Discovery and ProSe Direct
Communication
#### 4.5.1.1 Authorization and provisioning for ProSe
##### 4.5.1.1.1 General
The basic principles of service authorization for ProSe Direct Discovery and
ProSe Direct Communication are as follows:
\- the UE gets authorization to use E-UTRA based ProSe Direct Discovery on a
per PLMN basis.
\- for WLAN-based ProSe Direct Discovery the service authorisation information
provided by the HPLMN contains a list of PLMNs whose ProSe Application IDs the
UE may use.
\- the UE gets authorization to use ProSe Direct Communication on a per PLMN
basis in the serving PLMN by the ProSe Function in the HPLMN,
\- the ProSe Function in the HPLMN requests authorisation information from the
ProSe Function of the serving PLMN and Local PLMN(s).
NOTE: The UE does not need to be registered in the Local PLMN.
\- The ProSe Function in the HPLMN merges authorization information from home,
serving and local PLMNs.
\- Final authorization always comes from the ProSe Function in the Home PLMN.
The ProSe Function in the Local PLMN or the VPLMN or HPLMN may revoke the
authorization at any time. The ProSe Function in the HPLMN shall be notified
when authorization is revoked by the Local PLMN or the VPLMN.
OMA DM [30] is used as the protocol to provision ProSe related configuration
and authorization information in the ME. Provisioning is performed via the PC3
reference point.
##### 4.5.1.1.2 Provisioning information for ProSe Direct Discovery and ProSe
Direct Communication
##### 4.5.1.1.2.1 General {#general-2 .H6}
The following information can be contained in the authorisation info that is
provided by the ProSe Function to the UE for authorisation of using ProSe
Direct Discovery and ProSe Direct Communication in a particular PLMN.
##### 4.5.1.1.2.2 Authorisation for ProSe Direct Discovery {#authorisation-
for-prose-direct-discovery .H6}
The following information is provisioned to the non-Public Safety UE for open
ProSe Direct Discovery authorisation:
1) open ProSe Direct Discovery Model A monitoring authorisation policy:
\- PLMNs in which the UE is authorised to perform ProSe Direct Discovery
monitoring.
2) open ProSe Direct Discovery Model A announcing authorisation policy:
\- PLMNs in which the UE is authorized to perform announcing.
\- Authorised discovery range for announcing per PLMN.
The following information is provisioned to the UE for restricted ProSe Direct
Discovery authorisation:
1) restricted ProSe Direct Discovery Model A monitoring authorisation policy:
\- PLMNs in which the UE is authorised to perform restricted ProSe Direct
Discovery Model A monitoring.
2) restricted ProSe Direct Discovery Model A announcing authorisation policy:
\- PLMNs in which the UE is authorized to perform restricted ProSe Direct
Discovery Model A announcing;
\- Authorised discovery range for announcing per PLMN.
3) restricted ProSe Direct Discovery Model B Discoverer operation
authorization policy:
\- PLMNs in which the UE is authorized to perform Model B Discoverer
operation;
\- Authorised discovery range for announcing per PLMN.
4) restricted ProSe Direct Discovery Model B Discoveree operation
authorization policy:
\- PLMNs in which the UE is authorized to perform Model B Discoveree
operation.
\- Authorised discovery range for announcing per PLMN.
5) restricted ProSe Discovery UE ID for Restricted Direct Discovery,
applicable only to non-Public Safety UEs:
\- ProSe Discovery UE ID.
NOTE: The authorised discovery range above does not apply to WLAN-based ProSe
Direct Discovery. When WLAN-based ProSe Direct Discovery is used the discovery
range is determined by the underlying WLAN technology.
##### 4.5.1.1.2.3 Provisioning for ProSe Direct Discovery and ProSe Direct
Communication (Public Safety UE) {#provisioning-for-prose-direct-discovery-
and-prose-direct-communication-public-safety-ue .H6}
##### 4.5.1.1.2.3.1 General {#general-3 .H6}
The content of clause 4.5.1.1.2.3 is applicable to ProSe-enabled Public Safety
UEs only.
Clause 3 provides the definition of a ProSe-enabled Public Safety UE. To
comply with international and national regulations, the HPLMN shall endeavour
to ensure that the UE only uses the specific Public Safety capabilities in
territories in which the HPLMN is authorised to permit such rights to the UE.
For Public Safety usage the operator may pre-configure ProSe-enabled Public
Safety UEs with the required provisioning parameters for ProSe Direct
Discovery and ProSe Direct Communication, without the need for the ProSe-
enabled Public Safety UEs to connect to the ProSe Function to get this initial
configuration. The following apply:
\- The provisioning parameters for ProSe Direct Discovery and ProSe Direct
Communication may be configured in the UICC, in the ME, or in both the UICC
and the ME.
\- The UICC shall indicate whether the UE is authorized to use provisioning
parameters.
\- ProSe Direct Discovery and ProSe Direct Communication shall be accessible
only when a USIM authorized for ProSe Direct Discovery and ProSe Direct
Communication is selected.
\- The ME provisioning parameters shall not be erased when a USIM is
deselected or replaced.
\- If both the USIM and the ME contain the same set of provisioning
parameters, the set of parameters from the UICC shall take precedence.
\- The UE shall use radio resources for ProSe Direct Communication as follows:
\- While a UE has a serving cell and is camped on a cell and the UE intends to
use for ProSe the radio resources (i.e. carrier frequency) operated by this
cell, then the UE shall use the radio resource description indicated by this
cell the UE is camped on and ignore any radio resource description of the same
radio resource provisioned in the ME or the UICC. If the cell does not provide
radio resources for ProSe, the UE shall not perform ProSe transmission and
reception on radio resources operated by this cell.
\- If the UE intends to use radio resources (i.e. carrier frequency) for ProSe
that are not operated by the UE\'s serving cell or if the UE is out of
coverage, the UE shall search for a cell in any PLMN that is operating the
provisioned radio resources (i.e. carrier frequency) as defined in TS 36.300
[17] and TS 36.304 [32], and:
\- If the UE finds such cell in the registered PLMN or a PLMN equivalent to
the registered PLMN, and authorisation for ProSe Direct Communication to this
PLMN is confirmed, the UE shall use the radio resource description indicated
by that cell. If that cell does not provide radio resources for ProSe, the UE
shall not perform ProSe transmission and reception on those radio resources.
\- If the UE finds such cell but not in the registered PLMN or a PLMN
equivalent to the registered PLMN, and that cell belongs to a PLMN authorised
for ProSe Direct Communication and provides radio resources for ProSe then the
UE shall perform PLMN selection triggered by ProSe Direct Communication as
defined in TS 23.122 [31].
\- If the UE finds such cell but not in a PLMN authorised for ProSe Direct
Communication the UE shall not use ProSe.
\- If the UE does not find any such cell in any PLMN, then the UE shall use
radio resources provisioned in the ME or the UICC. If no such provision exists
in the ME or the UICC or the provision does not authorise ProSe Direct
Communication then the UE is not authorised to transmit.
\- The UE shall use radio resources for ProSe Direct Discovery as follows:
\- While a UE has a serving cell, the UE shall use the radio resource
description obtained via dedicated signalling or broadcasted by this cell
(same or different from that of the serving cell), if the corresponding PLMN
is permitted by the configured authorization information.
\- If the UE intends to use radio resources (i.e. carrier frequency) not
operated by the UE\'s serving cell for ProSe, which are indicated by the UE\'s
serving cell, and the corresponding PLMN is permitted by the configured
authorization information, the UE shall search for a cell with the indicated
PLMN operating the indicated radio resources as defined in TS 36.300 [17] and
TS 36.304 [32], and obtain the radio resource description for ProSe Direct
Discovery from that cell, without performing PLMN selection.
\- If the UE intends to use provisioned radio resources (i.e. carrier
frequency) not operated by the UE\'s serving cell for ProSe Direct Discovery,
the UE shall search for a cell with any PLMN operating the indicated radio
resources as defined in TS 36.300 [17] and TS 36.304 [32], and
\- If the UE finds such a cell belongs to a PLMN authorised for ProSe Direct
Discovery and the cell provides radio resources description for ProSe Direct
Discovery, then the UE shall use the indicated radio resources description for
Direct Discovery.
\- If the UE finds such a cell but not in a PLMN authorised for ProSe Direct
Discovery, the UE shall not use ProSe Direct Discovery in that carrier
frequency.
\- If the UE does not find any such cell in any PLMN, then the UE shall use
radio resources provisioned in the ME or the UICC.
\- The UE provisioning shall support setting Geographical Areas.
NOTE 1: It is possible for a UE to use other radio resources for ProSe based
on the Geographical Area instead of those operated by the serving Eâ€‘UTRAN
cell, when provisioned in the UE, even if the UE\'s serving cell offers normal
service and the ProSe SIB indicates that the service (discovery or
communication or both) is available. This is to cover the scenario when e.g.
the radio resources used for ProSe Direct Communication are not owned by the
serving network of the UE.
NOTE 2: The UE can only use ProSe Direct Discovery and ProSe Direct
Communication when it contains a UICC that has been configured for ProSe, i.e.
the selected USIM indicates that the UE is authorized to use the provisioning
parameters for ProSe.
NOTE 3: The scenario that a cell is detected and the cell does not provide
support for ProSe Direct Communications when the UE attempts to use a carrier
frequency configured for ProSe Direct Communication, is considered a
configuration error. Therefore the UE does not transmit on that frequency to
avoid interference to the network.
\- The ProSe Direct Communication is only specified for E-UTRA.
NOTE 4: It is out of scope of the present specification to define how the UE
can locate itself in a specific Geographical Area. When the UE is in coverage
of a 3GPP RAT, it can for example, use information derived from the serving
PLMN. When the UE is not in coverage of a 3GPP RAT, it can use other
techniques, including user provided location, as determined by local
regulations.
NOTE 5: The provisioning and use of of radio resources for ProSe Direct
Discovery described in this clause does not apply to WLAN-based ProSe Direct
Discovery.
##### 4.5.1.1.2.3.2 Additional provisioning information for ProSe Direct
Discovery {#additional-provisioning-information-for-prose-direct-discovery
.H6}
In addition to the parameters indicated in clause 4.5.1.1.2.2, the ProSe-
enabled Public Safety UE is provisioned with the following information:
1) Authorisation policy when the UE is \"not served by E-UTRAN\":
\- Indicates whether the UE is authorised to perform ProSe Direct Discovery
for Model A and Model B when \"not served by E-UTRAN\".
2) Radio parameters for when the UE is \"not served by E-UTRAN\":
\- Includes the radio parameters with Geographical Area(s) that need to be
configured in the UE in order to be able perform ProSe Direct Discovery
procedures when not \"served by E-UTRAN\". These radio parameters (e.g.
frequency bands) are defined in TS 36.331 [33] and are common for all types of
ProSe Direct Discovery (Group Member Discovery, ProSe UE-to-Network Relay
Discovery or ProSe UE-to-Network Relay Discovery Additional Information). The
UE uses the radio parameters only if the UE can locate itself in the
corresponding Geographical Area. Otherwise, the UE is not authorised to
transmit.
3) Group Member Discovery parameters:
\- For each discovery group that the UE belongs to include the following
parameters that enable the UE to perform Group Member Discovery when
provisioned in ME from DPF or configured in UICC:
\- Application Layer Group ID: Identifies an application layer group that the
UE belongs to.
\- User Info ID: For Model A, this corresponds to the Announcer Info parameter
when the UE is acting as an announcing UE. For Model B, this corresponds to
the Discoverer Info in Solicitation messages and the Discoveree Info in
Response messages, when the UE is acting as a discoverer or discoveree UE
respectively.
NOTE 1: The provisioning of radio parameters for ProSe Direct Discovery
described in this clause does not apply to WLAN-based ProSe Direct Discovery.
NOTE 2: User Info ID is expected to be assigned uniquely to a user within the
discovery group.
\- Discovery Group ID: identifier of a discovery group that the UE belongs to.
NOTE 3: The relationship between the Discovery Group ID and the ProSe Layer-2
Group ID described in clause 4.5.1.1.2.3.3 is out of scope of this
specification. It is expected that the Discovery Group ID and ProSe Layer-2
Group ID are of equal bit size.
\- Alternatively these parameters can be provided from the 3rd party public
safety provider application server (e.g. GCS AS as in TS 23.468 [26]). If UE
receives a set of data with the same Application Layer Group ID from AS that
has been previously provided by DPF then UE uses the data set provided by AS
for Group Member Discovery.
4) ProSe UE-to-Network Relay Discovery parameters:
\- Include the parameters that enable the UE to perform ProSe UE-to-Network
Relay Discovery when provisioned in ME from DPF or configured in UICC:
\- User Info ID: For Model A, this corresponds to the Announcer Info parameter
when the UE is acting as an announcing UE. For Model B, this corresponds to
the Discoverer Info in Solicitation messages and the Discoveree Info in
Response messages, when the UE is acting as a discoverer or discoveree UE
respectively.
\- Relay Service Code(s): A Relay Service Code identifies a connectivity
service the ProSe UE-to-Network Relay provides to Public Safety applications.
The Relay Service Codes are configured in the ProSe UE-to-Network Relays that
provide connectivity services to Public Safety applications. The Relay Service
Codes are configured in the Remote UEs interested in related connectivity
services.
\- Alternatively these parameters can be provided from the 3rd party public
safety provider application server (e.g. GCS AS as in TS 23.468 [26]). If UE
receives the same set of data from AS that has been previously provided by DPF
then UE uses the data set provided by AS for ProSe UE-to-Network Relay
Discovery.
##### 4.5.1.1.2.3.3 Provisioning information for one-to-many ProSe Direct
Communication {#provisioning-information-for-one-to-many-prose-direct-
communication .H6}
The following information is provisioned to the UE for one-to-many ProSe
Direct Communication:
1) Authorisation policy:
\- When the UE is \"served by E-UTRAN\":
\- PLMNs in which the UE is authorised to perform one-to-many ProSe Direct
Communication.
\- When the UE is \"not served by E-UTRAN\":
\- Indicates whether the UE is authorised to perform one-to-many ProSe Direct
Communication procedures when \"not served by E-UTRAN\".
2) ProSe Direct Communication policy/parameters:
\- For each application layer group supported include the parameters that
enable the UE to perform one-to-many ProSe Direct Communication when
provisioned from DPF in the ME or configured in the UICC:
\- Application Layer Group ID: Identifies an application layer group that the
UE belongs to.
\- ProSe Layer-2 Group ID;
\- ProSe Group IP multicast address
\- Indication whether the UE should use IPv4 or IPv6 for that group
\- For a specific Group configured to operate using IPv4, optionally an IPv4
address to be used by the UE as a source address. If none is provisioned, then
the UE shall use Dynamic Configuration of IPv4 Link-Local Addresses IETF RFC
3927 [16] to obtain a link local address for the Group.
\- Include group security related content for one-to-many ProSe Direct
Communication.
NOTE 1: More details on the necessary security aspect will be defined in SA3
specifications.
\- Alternatively these parameters can be provided from the 3rd party public
safety provider application server (e.g. GCS AS as in TS 23.468 [26]). If UE
receives a set of data with the same Application Layer Group ID from AS that
has been previously provided by DPF then UE uses the data set provided by AS
for one-to-many ProSe Direct Communication.
3) Radio parameters for when the UE is \"not served by E-UTRAN\":
\- Includes the radio parameters with Geographical Area(s) that need to be
configured in the UE in order to be able perform one-to-many ProSe Direct
Communication procedures when \"not served by E-UTRAN\". These radio
parameters (e.g. frequency bands) are defined in TS 36.331 [33] and are common
for all types of ProSe Direct Communication (one-to-one, one-to-many or ProSe
UE-to-Network Relaying). The UE uses the radio parameters only if the UE can
locate itself in the corresponding Geographical Area. Otherwise, the UE is not
authorised to transmit.
NOTE 2: The \"not served by E-UTRAN\" cover the cases when the UE is not
served by the E-UTRAN cell operating on the carrier frequency provisioned for
ProSe Direct Communication.
##### 4.5.1.1.2.3.3a Provisioning information for one-to-one ProSe Direct
Communication {#a-provisioning-information-for-one-to-one-prose-direct-
communication .H6}
The following information is provisioned in the UE for one-to-one ProSe Direct
Communication:
1) Authorisation policy:
\- When the UE is \"served by E-UTRAN\":
\- PLMNs in which the UE is authorised to perform one-to-one ProSe Direct
Communication.
\- When the UE is \"not served by E-UTRAN\":
\- Indicates whether the UE is authorised to perform one-to-one ProSe Direct
Communication procedures when \"not served by E-UTRAN\".
2) ProSe Direct Communication policy/parameters:
\- For each application layer group supported include the parameters that
enable the UE to perform one-to-one ProSe Direct Communication when
provisioned from DPF including Application Layer Group ID and the Layer-2 ID
for unicast communication and the related security parameters.
NOTE 1: More details on the necessary security aspect will be defined in SA
WG3 specifications.
3) Radio parameters for when the UE is \"not served by E-UTRAN\":
\- Includes the radio parameters with Geographical Area(s) that need to be
configured in the UE in order to be able to perform one-to-one ProSe Direct
Communication procedures when \"not served by E-UTRAN\". These radio
parameters (e.g. frequency bands) are defined in TS 36.331 [33] and are common
for all types of ProSe Direct Communication (one-to-one, one-to-many or ProSe
UE-to-Network Relaying). The UE uses the radio parameters only if the UE can
locate itself in the corresponding Geographical Area. Otherwise, the UE is not
authorised to transmit.
NOTE 2: The \"not served by E-UTRAN\" cover the cases when the UE is not
served by the E-UTRAN cell operating on the carrier frequency provisioned for
ProSe Direct Communication but may be served by the E-UTRAN cell operating on
some other carrier frequency.
##### 4.5.1.1.2.3.4 Provisioning information for ProSe UE-to-Network Relaying
{#provisioning-information-for-prose-ue-to-network-relaying .H6}
The following information is provisioned in the UE in support of the UE
assuming the role of a ProSe UE-to-Network Relay:
1) Authorisation policy for acting as a ProSe UE-to-Network Relay when
\"served by E-UTRAN\":
\- PLMNs in which the UE is authorized to relay traffic for Remote UEs.
2) ProSe Relay Discovery policy/parameters for ProSe UE-to-Network Relay:
\- Includes the parameters that enable the UE to perform ProSe Relay Discovery
when provisioned from the DPF in the ME or configured in the UICC:
\- ProSe UE-to-Network Relay Discovery parameters (User Info ID, Relay Service
Code(s)) as described in clause 4.5.1.1.2.3.2;
\- The PDN connection parameters (PDN type, APN) to be used for the relayed
traffic for each ProSe Relay Service Code;
NOTE 1: The behaviour of the UE in case of missing PDN connection parameters
is the behaviour described in TS 23.401 [5]. E.g. if PDN type is not pre-
configured the UE requests PDN type IPv4v6.
\- Includes security related content for ProSe Relay Discovery for each ProSe
Relay Service Code.
NOTE 2: More details on the necessary security aspects are defined in TS
33.303 [29].
\- Alternatively these parameters can be provided from a 3rd party public
safety provider application server (e.g. a GCS AS as in TS 23.468 [26]). If
the UE receives the same set of data from the AS that has previously been
provided by the DPF then the UE uses the data set provided by the AS for ProSe
Relay Discovery.
3) Radio parameters for ProSe Relay Discovery:
\- Includes the radio parameters with Geographical Area(s) that need to be
configured in the UE in order to be able perform ProSe Discovery procedures
when acting as a ProSe UE-to-Network Relay. These radio parameters (e.g.
frequency bands) are defined in TS 36.331 [33] and are common for all types of
ProSe Direct Discovery (Group Member Discovery, ProSe UE-to-Network Relay
Discovery or ProSe UE-to-Network Relay Discovery Additional Information). The
UE uses the radio parameters only if the UE can locate itself in the
corresponding Geographical Area. Otherwise, the UE is not authorised to
transmit.
NOTE 3: The provisioning of radio parameters for ProSe Direct Discovery
described in this clause does not apply to WLAN-based ProSe Direct Discovery.
4) Radio parameters for ProSe Relay Communication:
\- Includes the radio parameters with Geographical Area(s) that need to be
configured in the UE in order to be able perform ProSe Communication
procedures when acting as a ProSe UE-to-Network Relay. These radio parameters
(e.g. frequency bands) are defined in TS 36.331 [33] and are common for all
types of ProSe Direct Communication (one-to-one, one-to-many or ProSe UE-to-
Network Relaying). The UE uses the radio parameters only if the UE can locate
itself in the corresponding Geographical Area. Otherwise, the UE is not
authorised to transmit.
5) Mapping rules between ProSe Per-Packet Priority and QCI values.
\- Includes the rules that determine how the ProSe UE-to-Network Relay maps
the QCI of the EPS bearer into a ProSe Per-Packet Priority value to be applied
for the downlink relayed unicast packets over PC5.
The following information is provisioned in the UE in support of the UE
assuming the role of a Remote UE and thereby enabling the use of a ProSe UE-
to-Network Relay:
1) Authorisation policy for using a ProSe UE-to-Network Relay:
\- Indicates whether the UE is authorised to use a ProSe UE-to-Network Relay.
2) Policy/parameters for ProSe Relay Discovery and for enabling connection to
the ProSe UE-to-Network Relay after discovery is performed as defined in
clause 5.3.7:
\- Includes the parameters for ProSe Relay Discovery and for enabling the UE
to connect to the ProSe UE-to-Network Relay after discovery when provisioned
from the DPF in the ME or configured in the UICC:
\- ProSe UE-to-Network Relay Discovery parameters (User Info ID, Relay Service
Code(s)) as described in clause 4.5.1.1.2.3.2;
\- IP version(s) that can be used for the relay traffic for each ProSe Relay
Service Codes;
\- Includes security related content for ProSe Relay Discovery for each ProSe
Relay Service Codes.
NOTE 4: More details on the necessary security aspect are defined in TS 33.303
[29].
\- Alternatively these parameters can be provided from a 3rd party public
safety provider application server (e.g. a GCS AS as in TS 23.468 [26]). If
the UE receives the same set of data from the AS that has previously been
provided by the DPF then the UE uses the data set provided by the AS for the
use of a ProSe UE-to-Network Relay.
3) Radio parameters for when the UE is not \"served by E-UTRAN\":
\- Includes the radio parameters with Geographical Area(s) that need to be
configured in the UE in order to be able perform ProSe Discovery procedures in
the role of a Remote UE when not \"served by E-UTRAN\". These radio parameters
(e.g. frequency bands) are defined in TS 36.331 [33] and are common for all
types of ProSe Direct Discovery (Group Member Discovery, ProSe UE-to-Network
Relay Discovery or ProSe UE-to-Network Relay Discovery Additional
Information). The UE uses the radio parameters only if the UE can locate
itself in the corresponding Geographical Area. Otherwise, the UE is not
authorised to transmit.
\- Includes the radio parameters with Geographical Area(s) that need to be
configured in the UE in order to be able perform ProSe Communication
procedures in the role of a Remote UE when not \"served by E-UTRAN\". These
radio parameters (e.g. frequency bands) are defined in TS 36.331 [33] and are
common for all types of ProSe Direct Communication (one-to-one, one-to-many or
ProSe UE-to-Network Relaying). The UE uses the radio parameters only if the UE
can locate itself in the corresponding Geographical Area. Otherwise, the UE is
not authorised to transmit.
NOTE 5: The phrase \"not served by E-UTRAN\" cover the cases when the UE is
not served by the E-UTRAN cell operating on the carrier frequency provisioned
for ProSe Direct Discovery but may be served by the E-UTRAN cell operating on
some other carrier frequency.
### 4.5.2 Subscription to ProSe
The user\'s profile in the HSS contains the subscription information to give
the user permission to use ProSe.
At any time, the operator can remove the ProSe UE subscription rights from
user\'s profile in the HSS, and revoke the user\'s permission to use ProSe.
The following subscription information is defined for ProSe:
\- subscription for open ProSe Direct Discovery:
\- open ProSe Direct Discovery Model A.
\- subscription for restricted ProSe Direct Discovery:
\- restricted ProSe Direct Discovery Model A;
\- restricted ProSe Direct Discovery Model A with application-controlled
extension;
\- restricted ProSe Direct Discovery Model A with \"on demand\" announcing;
\- restricted ProSe Direct Discovery Model B.
\- subscription for EPC-level ProSe Discovery.
\- subscription for EPC support WLAN direct discovery and communication.
\- subscription for one-to-many ProSe Direct Communication, applicable only to
Public Safety subscribers.
\- subscription for one-to-one ProSe Direct Communication, applicable only to
Public Safety subscribers.
\- subscription for ProSe UE acting as UE-to-Network Relay, applicable only to
Public Safety subscribers.
\- subscription for Remote UE access to ProSe UE-to-Network Relay, applicable
only to Public Safety subscribers.
Additional parameters related to the ProSe Direct service may be stored in the
user\'s profile, such as:
\- the list of the PLMNs where the UE is authorised for open Direct Discovery
Model A, i.e. to announce or monitor or both.
\- the list of the PLMNs where the UE is authorised for restricted ProSe
Direct Discovery Model A, i.e. to announce or monitor or both.
\- the list of the PLMNs whether the UE is authorized for restricted ProSe
Direct Discovery Model B , i.e. to perform Discoverer operation or Discoveree
operation or both.
\- the list of the PLMNs where the UE is authorised to perform one-to-many
ProSe Direct Communication, applicable only to Public Safety subscribers.
\- the list of the PLMNs where the UE is authorised to perform one-to-one
ProSe Direct Communication, applicable only to Public Safety subscribers.
### 4.5.3 IP address allocation
For one-to-many ProSe Direct Communication:
\- when the UE is configured to use IPv6 on the direct link, the UE auto-
configures a link local IPv6 Address following procedures defined in RFC 4862
[6]. This address can only be used as the source IP address for one-to-many
ProSe Direct Communication.
\- when the UE is configured to use IPv4 for a certain Group for one-to-many
ProSe Direct Communication, then either it uses the configured IPv4 address
for the Group or, if it is not configured with an address for the Group, it
uses Dynamic Configuration of IPv4 Link-Local Addresses IETF RFC 3927 [16].
For communication with a ProSe UE-to-Network Relay:
a) When the Remote UE uses IPv4 to access the external PDN:
a1) The IPv4 address allocation and IPv4 parameter configuration via DHCPv4 is
performed according to RFC 2131 [7] and RFC 4039 [8] procedures. The IPv4
address provided to the Remote UE from the ProSe UE-to-Network Relay by DHCPv4
procedure shall correspond to a local IPv4 address range configured in the
ProSe UE-to-Network Relay.
a2) The DHCPv4 request from the Remote UE is always sent subsequent to the
establishment of the One-to-one ProSe Direct Communication, see details in
clause 5.4.4.3.
b) When the Remote UE uses IPv6 to access the external PDN:
b1) IPv6 network prefix allocation via IPv6 Stateless Address auto-
configuration. Router solicitation from the Remote UE is always sent
subsequent to the establishment of the One-to-one ProSe Direct Communication,
see details in clause 5.4.4.2.
b2) IPv6 parameter configuration via Stateless DHCPv6: The UE may use
stateless DHCPv6 for additional parameter configuration.
The PDN type of the PDN connection used for the relay traffic shall support
the IP version used by the Remote UE. If the Remote UE initiates an allocation
of IPv4 address or an IPv6 prefix when the requested IP version is not
supported in the corresponding PDN connection then IP address/prefix
allocation fails.
In case of IPv4 the ProSe UE-to-Network Relay performs IPv4 NAT between IPv4
addresses assigned to the Remote UEs and the IPv4 address assigned to the PDN
connection used for the relay traffic. In case of IPv6 the ProSe UE-to-Network
Relay assigns IPv6 prefixes from IPv6 prefix range that have been assigned to
the PDN connection used for the relay traffic via IPv6 prefix delegation.
For one-to-one ProSe Direct Communication between two UEs neither of which
acts as a ProSe UE-to-Network Relay the following mechanism for IP
address/prefix allocation may be used:
a) DHCP-based IPv4 address allocation with one of the two UEs acting as a DHCP
server.
b) IPv6 Stateless Address auto configuration specified in RFC 4862 [6] for
assignment of IPv6 prefix, with one of the two UEs acting as IPv6 default
router.
NOTE: Which UE acts as a DHCPv4 server or IPv6 default router is negotiated
during secure layer-2 link establishment.
c) IPv6 link-local addresses as defined in RFC 4862 [6] are formed by UEs
locally. The IPv6 link-local addresses are exchanged during the establishment
of a secure layer-2 link over PC5. The UEs shall disable duplicate address
detection after the layer-2 link is established.
### 4.5.4 ProSe UE-to-Network Relaying
A UE supporting ProSe UE-to-Network Relaying shall include the following
functions:
\- ProSe Direct discovery for ProSe UE-to-Network Relay;
\- One-to-one ProSe Direct Communication;
\- Acting as a default router to the Remote UEs forwarding IP packets between
the UE-ProSe UE-to-Network Relay point-to-point link and the corresponding PDN
connection;
\- Relaying eMBMS traffic using one-to-many ProSe Direct Communication;
\- ProSe Per-Packet Priority handling for unicast and eMBMS downlink traffic;
\- IPv6 prefix allocation and delegation if IPv6 is used;
\- IPv4 address allocation and IPv4 NAT function if IPv4 is used.
In order to use a ProSe UE-to-Network Relay a ProSe-enabled Public Safety UE
shall include the following functions:
\- ProSe Direct discovery for ProSe UE-to-Network Relay;
\- One-to-one ProSe Direct Communication with dynamic IP address/prefix
allocation.
NOTE 1: The aspects of the radio layers for the PC5 reference point are
defined in RAN specifications.
In order to support mission critical applications (e.g. MCPTT) for Remote UEs,
policy control and charging functionality as defined in TS 23.203 [35] needs
to be provided for the UE-to-Network Relay UE to enable resource utilisation
for Remote UEs.
In this release of the specification, the following functionalities shall be
provided to enable support for policy control for Remote UEs:
\- The Remote UEs shall be assigned a /64 IPv6 Prefix from a shorter IPv6
prefix by the UE-to-Network Relay.
\- The UE-to-Network Relay UE and the PCRF and the PDN GW supporting the PDN
connection shall support the extended TFT filter format, so that services can
be authorized separately for each Remote UE.
\- The UE-to-Network Relay UE and PDN GW shall support the TFT packet filter
attribute Local Address and Mask as defined in TS 23.060 [36], clause
15.3.2.2A.
\- There shall be a dedicated PDN connection to provide support for UE-to-
Network Relay connectivity.
\- The UE-to-Network Relay UE, the PDN GW and PCRF shall be configured with a
dedicated APN for UE-to-Network Relay connectivity.
NOTE 2: If Local Breakout configuration is supported for relay connectivity,
the dedicated APN needs to be well-known APN to allow seamless operation
across various operators\' networks.
\- The AF determines the PCRF realm using the IPv6 prefix of the Remote UE and
contacts the PCRF serving the UE-to-Network Relay PDN connection.
NOTE 3: If the AF and the PCRF are in different PLMNs, the AF appears as a
third party application server as described in TS 23.203 [35], clause 5.2.1.
\- The PCRF validates any Remote UE related service information from the AF
based on roaming agreement and the dedicated APN for UE-to-Network Relay
functionality.
NOTE 4: Once the AF has derived the PLMN ID of the PCRF and contacted the
corresponding domain, then the session binding can continue using procedures
defined in TS 23.203 [35].
### 4.5.5 ProSe Proxy Function
ProSe Proxy Function enables support for UE to Home ProSe Function/ProSe Key
Management Function communication as defined in clause 4.4.1.1 and in TS
33.303 [29], where the Home ProSe Function/ProSe Key Management Function is
not located in the same network as the PDN GW for the PDN connection being
used. Such proxy functions are needed when requirements on security are not
met by signalling over Internet. Inter-PLMN signalling may be used in that
case. Due to restrictions on the inter-PLMN network, the UE to Server traffic
over the user plane may not be sent between networks directly. Only tunnelled
server to server traffic may be sent between networks.
A roaming UE, which has a Local Breakout PDN Connection in the VPLMN, uses
this access to reach a ProSe Function in the Home network and a ProSe Key
Management Function in the Home network or another network. UE is not aware of
the presence of a ProSe Proxy Function.
A ProSe Proxy implemented in the VPLMN on the SGi interface may be used to
reach the ProSe Function located in the HPLMN. The ProSe Proxy Function
forwards signalling traffic between the UE and the ProSe Function in the
HPLMN.
A ProSe Proxy implemented in either the HPLMN or the VPLMN on the SGi
interface may be used to reach a ProSe Key Management Function located in a
different network. The ProSe Proxy Function forwards the signalling traffic
(as defined in clause 6.2.2.3.1 in TS 33.303 [29]) between the UE and the
ProSe Key Management Function.
### 4.5.6 Support for ProSe for UEs in limited service state
ProSe-enabled non-Public Safety UE shall not use ProSe when in limited service
state.
ProSe-enabled Public Safety UEs that are authorised to use ProSe Direct
Communication and/or ProSe Direct Discovery shall be able to use ProSe Direct
Communication and/or ProSe Direct Discovery when in limited service state
following the procedures defined in clause 4.5.1.1.2.3.1 for ProSe Direct
Communication and ProSe Direct Discovery when the UE enters in limited service
state:
\- because it cannot find a suitable cell of the selected PLMN as described in
TS 23.122 [31] or
\- as the result of receiving one of the following reject reasons defined in
TS 23.122 [31]:
\- a \"PLMN not allowed\" response to a registration request or;
\- a \"GPRS not allowed\" response to a registration request
A ProSe-enabled Public Safety UE in limited service state shall only use ProSe
mechanisms available in ECM-IDLE, for details see TS 36.300 [17].
A ProSe-enabled Public Safety UE in limited service state shall not use ProSe
in ECM-CONNECTED mode.
ProSe-enabled Public Safety UEs shall not use ProSe Direct Communication or
ProSe Direct Discovery if the UE has entered in limited service state due to
all other situations (e.g. no SIM in the MS, an \"illegal MS\" or \"illegal
ME\" response to a registration request, or an \"IMSI unknown in HLR\"
response to a registration request) defined in TS 23.122 [31], where the UE is
unable to obtain normal service from a PLMN.
## 4.6 Identifiers
### 4.6.1 Identifiers for EPC-level ProSe Discovery
The following identities are used for EPC-level ProSe Discovery: EPC ProSe
User ID, Application Layer User ID and Application ID.
The ProSe Function is identified by an FQDN that the UE constructs using the
HPLMN ID.
### 4.6.2 Identifiers for EPC support for WLAN direct discovery and
communication
The following identifier is used in addition to those in clause 4.6.1 for EPC
support for WLAN direct discovery and communication: WLAN Link Layer ID.
### 4.6.3 Identifiers for ProSe Direct Communication
#### 4.6.3.1 ProSe UE ID
This is a link layer identifier that is used as a source Layer-2 ID in all the
packets the UE sends for one-to-many and one-to-one ProSe Direct
Communication.
When bearer-level security is configured to be used, the ProSe UE ID is
assigned by the ProSe Key Management Function as defined in TS 33.303 [29].
The ProSe Key Management Function ensures that the ProSe UE ID is unique in
the context of one-to-many ProSe Direct Communication for this group.
When bearer-level security is configured not to be used (including the case of
Layer-2 broadcast communication required to support Dynamic Configuration of
IPv4 Link-Local Addresses IETF RFC 3927 [16]), the ProSe UE ID is either
configured in the UE or self-assigned by the UE.
Assuming that global uniqueness of ProSe UE ID cannot be ensured, the UE
should be prepared to handle conflicts of ProSe UE IDs using mechanisms that
are out of scope of this release of the specification (e.g. by self-assigning
a new ProSe UE ID when a conflict is detected).
#### 4.6.3.2 ProSe Layer-2 Group ID
This is a link layer identifier that identifies the group in the context of
one-to-many ProSe Direct Communication. It is used as a destination Layer-2 ID
in all the packets the UE sends to this group for one-to-many ProSe Direct
Communication.
### 4.6.4 Identifiers for ProSe Direct Discovery
#### 4.6.4.1 ProSe Application ID
For Open ProSe Discovery, (as described in TS 22.278 [25]) the ProSe
Application ID is called the Public ProSe Application ID. The geographic scope
of the Public ProSe Application ID may be PLMN-specific, country specific or
global.
Each Public ProSe Application ID is composed of the following parts:
a. The ProSe Application ID Name is described in its entirety by a data
structure characterized by different levels e.g., broad-level business
category (Level 0) / business sub-category (Level 1) / business name (Level 2)
/ shop ID (Level 3). For the purpose of presentation, a ProSe Application ID
Name is usually displayed as a string of labels in which the labels represent
hierarchical levels.
b. The PLMN ID that corresponds to the PLMN that assigned the ProSe
Application ID Name.
NOTE: If the Public ProSe Application ID is country specific then the Mobile
Network Code (MNC) of the PLMN ID is wild carded. If global, both the MCC and
MNC are wild carded. The use of wild carded ProSe Application IDs is further
explained in Annex B.
#### 4.6.4.2 ProSe Application Code
For the announcing UE, the ProSe Application Code is obtained from the HPLMN
ProSe Function using the Announce Request procedure (see clauses 5.3.3.1 and
5.3.3.2). The ProSe Application Code is contained in the message that is
actually transmitted over the radio interface (on PC5) by a UE engaged in the
ProSe Direct Discovery procedure (see clause 5.3) to \"monitoring\" UEs.
For the \"monitoring\" UE, Discovery Filter(s) to monitor the ProSe
Application Code(s) over the radio interface (on PC5) are obtained from the
HPLMN ProSe Function using the Monitor Request procedure (see clauses 5.3.3.4
and 5.3.3.5).
Each ProSe Application Code is composed of the following parts:
a. A temporary identity that corresponds to the ProSe Application ID Name.
Given the data structure associated with the Public ProSe Application ID, each
ProSe Application ID can be associated with various temporary identities that
contains as many identifiers as there are levels in the corresponding ProSe
Application ID Name: this allows partial matching at the monitoring UE side
using a ProSe Application Mask (see clause 4.6.4.2b) or a Discovery Filter,
making more effective and flexible the filtering of the received temporary
identity in a monitoring UE. See clause 4.6.4.2a..
b. The PLMN ID of the ProSe Function that assigned the ProSe Application Code,
i.e. Mobile Country Code (MCC) and Mobile Network Code (MNC).
NOTE 1: In this version of the specification the ProSe Application Code is
always assigned by a HPLMN ProSe Function.
ProSe Application Code matching considers all components listed above. In
ProSe Application Code matching, the \"monitoring\" UE shall consider it a
full match, if both PLMN ID and temporary identity match with the
corresponding contents of the Discovery Filter. A partial match is obtained if
the PLMN ID matches fully and the temporary identity matches partially with
the corresponding contents of the ProSe Application Mask (see clause
4.6.4.2b).
A ProSe Application Code is allocated per \"announcing\" UE and per
application and has an associated validity timer that runs both in the ProSe
Function and in the UE.
In case of Open ProSe Discovery:
\- when the \"announcing\" UE wants to announce something, it shall send a
Discovery Request containing the Public ProSe Application ID to the ProSe
Function, and the ProSe Function assigns a ProSe Application Code.
\- when the \"monitoring\" UE wants to monitor something, it shall send a
discovery request containing the full or a subset of the Public ProSe
Application ID, e.g. it may provide 2 out of the n levels of the full Public
ProSe Application ID.
NOTE 2: The ProSe Application ID Name data structure is not expected to change
often.
#### 4.6.4.2a Discovery Filter
In open ProSe Direct Discovery, a Discovery Filter consists of a ProSe
Application Code, ProSe Application Mask(s) and a time to live (TTL). In
restricted ProSe Direct Discovery, a Discovery Filter consists of a ProSe
Restricted Code, ProSe Application Masks(s) and a TTL. A TTL indicates for how
long the related Discovery Filter is valid after it is received.
NOTE: In order for the ProSe Application Mask not to change often, the ProSe
Application Mask does not extend to the last level of the corresponding Prose
Application ID data structure (typically the leaf, i.e. the lowest level).
A Discovery Filter is provided to a monitoring UE by its HPLMN ProSe Function.
It is used by the monitoring UE to selectively match ProSe Application Codes
or ProSe Restricted Codes received on the PC5 interface.
In Model B discovery, Discovery Filters are provided to the Discoveree UE and
Discoverer UE. The Discoveree UE needs to obtain a Discovery Query Filter
before it can participate in the discovery operation. The Discoveree UE
applies the Discovery Query Filter to determine which of the ProSe Query Codes
that it monitors is to be responded to. For each of the ProSe Query Codes it
is configured to announce, the Discoverer UE needs to be configured with one
or more Discovery Response Filters for processing the ProSe Response Codes
that may be received in response.
Discovery Filters allow full matching and partial matching of as many parts of
ProSe Application Code or ProSe Restricted Code as are contained in the ProSe
Application Mask. A Discovery Filter may contain more than one mask in order
to support allocation of masks for different parts of the ProSe Application
Code or ProSe Restricted Code.
#### 4.6.4.2b ProSe Application Mask
A ProSe Application Mask shall be used for partial matching of ProSe
Application Codes or ProSe Restricted Codes received on the PC5 interface. A
ProSe Application Mask is contained in a Discovery Filter.
NOTE 1: It is up to stage 3 specifications whether a ProSe Application Mask is
used in case of full matching, or the lack of the ProSe Application Mask
indicates the need of full matching.
A ProSe Application Mask consists of one or more applicable parts of temporary
identities of ProSe Application Codes or ProSe Restricted Codes to allow
partial matching.
NOTE 2: The ProSe Application Mask is not expected to change often.
#### 4.6.4.3 Identifiers for ProSe UE-to-Network Relay discovery and selection
The following parameters are used in the UE-to-Network Relay Discovery
Announcement message (Model A):
\- ProSe Relay UE ID: link layer identifier that is used for direct
communication and is associated with a Relay Service Code. A UE-to-Network
Relay shall have a distinct ProSe Relay UE ID for each Relay Service Code. For
support of multiple PDN Connections, the ProSe UE-to-Network Relay is assigned
a different ProSe Relay UE ID for each PDN Connection.
\- Announcer Info: provides information about the announcing user.
\- Relay Service Code: parameter identifying a connectivity service the ProSe
UE-to-Network Relay provides to Public Safety applications. The Relay Service
Codes are configured in a ProSe UE-to-Network Relay for advertisement.
Additionally, the Relay Service Code also identifies authorized users the
ProSe UE-to-Network Relay would offer service to, and may select the related
security policies or information e.g. necessary for authentication and
authorization between the Remote UE and the ProSe UE-to-Network Relay (e.g. a
Relay Service Code for relays for police members only would be different than
a Relay Service Code for relays for Fire Fighters only, even though
potentially they provided connectivity to same APN e.g. to support Internet
Access).
The following parameters are used in the UE-to-Network Relay Discovery
Solicitation message (Model B):
\- Discoverer Info: provides information about the discoverer user.
\- Relay Service Code: information about connectivity that the discoverer UE
is interested in. The Relay Service Codes are configured in the Remote UEs
interested in related connectivity services.
\- ProSe Relay UE ID: link layer identifier of a UE-to-Network Relay that is
used for direct communication and is associated with a Relay Service Code. A
UE-to-Network Relay shall have a distinct ProSe Relay UE ID for each Relay
Service Code. The ProSe Relay UE ID is optional.
The following parameters are used in the UE-to-Network Relay Discovery
Response message (Model B):
\- ProSe Relay UE ID: link layer identifier that is used for direct
communication and is associated with a Relay Service Code. A UE-to-Network
Relay shall have a distinct ProSe Relay UE ID for each Relay Service Code.
NOTE: It is up to stage 3 specifications how the UE-to-Network Relay indicates
in the response message which Relay Service Code it can support.
\- Discoveree Info: provides information about the discoveree.
#### 4.6.4.4 ProSe Query Code
The ProSe Query Code is used for Model B discovery. It is obtained by a
Discoverer UE from its HPLMN ProSe Function. The ProSe Query Code is sent by
the Discoverer UE over the air.
#### 4.6.4.5 ProSe Response Code
The ProSe Response Code is used for Model B discovery. It is obtained by a
Discoveree UE from its HPLMN ProSe Function before its starts the discovery
operation. There is one ore more Discovery Query Filter(s) associated with the
ProSe Response Code and provided to the Discoveree UE. The Discoveree UE sends
the ProSe Response Code over the air when a monitored ProSe Query Code matches
the Discovery Query Filter(s).
#### 4.6.4.6 ProSe Restricted Code
The ProSe Restricted Code is used for restricted ProSe Direct Discovery.
For the announcing UE, the ProSe Restricted Code is obtained from the HPLMN
ProSe Function using the Announce Request procedure (see clause 5.3.3.2A, and
5.3.3.3A). The ProSe Restricted Code is contained in the message that is
transmitted over the radio interface (on PC5) by a UE engaged in the ProSe
Direct Discovery procedure (see clause 5.3) to monitoring UEs.
For the announcing UE requesting \"on demand\" announcing in restricted ProSe
Direct Discovery Model A, the ProSe Restricted Code can be allocated by the
HPLMN ProSe Function using the Announcing Alert procedures (see clause 5.3.5).
The monitoring UE, a set of Discovery Filter(s) to monitor the ProSe
Restricted Code(s) over the radio interface (PC5) are obtained from the HPLMN
ProSe Function using the Monitor Request procedure (see clause 5.3.3.4A and
5.3.3.5A).
Each ProSe Restricted Code is composed of the following parts:
a. A temporary identifier that corresponds to one or more RPAUIDs.
b. The PLMN ID of the ProSe Function that assigned the ProSe Restricted Code.
It is up to the policy in the ProSe Function whether to allocate the same
ProSe Restricted Code for all RPAUIDs or different ProSe Restricted Codes for
different RPAUIDs. The ProSe Restricted Code has an associated validity timer
that runs both in the ProSe Function and in the UE.
The ProSe Function may update the ProSe Restricted Code or the Discovery
Filter(s) using the Restricted Discovery Authorization Update procedure in
clause 5.3.6A.
To support restricted Direct Discovery with application-controlled extension,
the ProSe Restricted Code contains a prefix, which is assigned by the ProSe
Function in the HPLMN, and a suffix which is assigned by the ProSe Application
Server.
#### 4.6.4.7 ProSe Discovery UE ID (PDUID)
The 3GPP layer identity of the UE is concealed from application layer via the
creation by the ProSe Function of a corresponding PDUID. The mapping of the
PDUID to the 3GPP layer UE ID is maintained by the ProSe Function.
The ProSe Protocol layer in the UE gets the PDUID during the procedure of
service authorisation for ProSe Direct Discovery, from the ProSe Function of
the HPLMN. The PDUID is stored in the ProSe Function as part of the service
authorization information, and is associated with a validity timer. The ProSe
function may update the PDUID using the ProSe service notification message
before the validity timer expires.
#### 4.6.4.8 Restricted ProSe Application User ID (RPAUID)
The application layer user identity is concealed from 3GPP network via the
creation by the ProSe Application Server of a corresponding Restricted ProSe
Application User ID. The mapping of the RPAUID to the actual application layer
identity is maintained by the ProSe Application Server.
NOTE: RAPUID is a temporary identifier and can be changed by ProSe Application
Server, e.g. in order to further protect the application level user identity.
The structure and value of the RPAUID is out of scope of 3GPP. The UE obtains
the RPAUID using application layer signalling prior to the execution of the
Discovery Request procedures described in clause 5.3.3.
#### 4.6.4.9 Identifiers for Group Member Discovery
The following parameters are used in the Group Member Discovery Announcement
message (Model A):
\- ProSe UE ID: link layer identifier that is used for subsequent direct one-
to-one and one-to-many communication.
\- Announcer Info: provides information about the announcing user.
\- Discovery Group ID: identifier of a discovery group that the UE belongs to.
The following parameters are used in the Group Member Discovery Solicitation
message (Model B):
\- Discoverer Info: provides information about the discoverer user.
\- Discovery Group ID: identifier of a discovery group that the targeted UE
should belong to.
\- Target Info: provides information about the targeted discoverees (single
user or group). The Target Info is provided by the upper layers of the UE.
The following parameters are used in the Group Member Discovery Response
message (Model B):
\- ProSe UE ID: link layer identifier that is used for subsequent direct one-
to-one and one-to-many communication.
\- Discoveree Info: provides information about the discoveree.
\- Discovery Group ID: identifier of the discovery group that the discoveree
UE belongs to.
#### 4.6.4.10 Identifiers for Relay Discovery Additional Information
The following parameters may be used in the Relay Discovery Additional
Information message:
\- Relay Service Code: the Relay Service Code associated with the message. The
Relay Service Code is used to identify the security parameters needed by the
receiving UE to process the discovery message as specified in TS 33.303 [29].
\- ProSe Relay UE ID: link layer identifier that is used for direct
communication and is associated with a Relay Service Code.
\- Announcer info: provides information about the announcing user.
\- TMGI: indicates the MBMS the ProSe UE-to-Network Relay is relaying.
\- ProSe Layer-2 Group ID: link layer identifier of the group that transmits
the MBMS traffic corresponding to the TMGI.
\- ECGI: indicates the ECGI of the serving cell of the ProSe UE-to-Network
Relay.
A single Relay Discovery Additional Information message may carry:
\- the ECGI that the ProSe UE-to-Network Relay is camped on or;
\- one or more advertised TMGIs and their corresponding ProSe Layer-2 Group
IDs up to the maximum allowed message size or;
\- the ECGI that the ProSe UE-to-Network Relay is camped on, and one or more
advertised TMGIs and their corresponding ProSe Layer-2 Group IDs up to the
maximum allowed message size.
#### 4.6.4.11 Metadata Index
Some bits of the ProSe Application Code may be used as Metadata Index to
reflect the current metadata version. It is allocated and updated by the Home
ProSe Function when new metadata are uploaded and stored in the ProSe Function
for a given ProSe Application ID. The length of the Metadata Index is decided
by the ProSe Function under operator\'s control.
#### 4.6.4.12 Metadata Index Mask
The Metadata Index Mask indicates the part used for the Metadata Index in the
ProSe Application Code. It is provided to the monitoring UE during the Match
Report procedure for the ProSe Application Code(s) containing a Metadata
Index. The monitoring UE can use the Metadata Index Mask to locate the
Metadata Index in the ProSe Application Codes.
# 5 Functional Description and Information Flow
## 5.1 Control and user plane stacks
### 5.1.1 Control Plane
#### 5.1.1.1 General
The control plane stack consists of protocols for control and support of the
user plane functions:
\- controlling the configuration of the ProSe-enabled UE;
\- controlling ProSe Direct Discovery;
\- controlling the set-up of the connection between the Remote UE and the
ProSe UE-to-Network Relay; and
\- controlling the attributes of an established network access connection,
such as activation of an IP address.
The following control planes are used in E-UTRAN mode.
#### 5.1.1.2 UE - ProSe Function
**Legend:**
\- ProSe Control Signalling between UE and ProSe Function is carried over the
user plane and is specified in TS 24.334 [24].
NOTE: PC3 may be realized with one or more protocols.
Figure 5.1.1.2-1: Control Plane for PC3 Interface
#### 5.1.1.3 HSS - ProSe Function
**Legend:**
\- Diameter: This protocol supports the transfer of subscription and
authentication data for authenticating/authorizing user access to ProSe
between ProSe Function and HSS (PC4a). Diameter is defined in RFC 3588 [18].
\- Stream Control Transmission Protocol (SCTP): This protocol transfers
signalling messages. SCTP is defined in RFC 4960 [19].
\- PC4a between the ProSe Function and the HSS is specified in TS 29.344 [22].
Figure 5.1.1.3-1: Control Plane for PC4a Interface
#### 5.1.1.4 SLP - ProSe Function
**Legend:**
\- Mobile Location Protocol (MLP) is specified in OMA LIF MLP [20].
Figure 5.1.1.4-1: Control Plane for PC4b Interface
#### 5.1.1.5 UE - UE
##### 5.1.1.5.1 Discovery plane PC5 interface
**Legend:**
\- **PC5-D:** The MAC/PHY functionality for E-UTRA based PC5 is specified in
TS 36.300 [17].
\- The \"ProSe protocol\" is used for handling ProSe Direct Discovery
specified in TS 24.334 [24].
Figure 5.1.1.5.1-1: Discovery Plane PC5 Interface
##### 5.1.1.5.2 PC5 Signalling Protocol
**Legend:**
\- The PDCP/RLC/MAC/PHY functionality is specified in TS 36.300 [17].
\- PC5 Signalling Protocol\" is used for control plane signalling over PC5
(e.g. establishment, maintenance and release of secure layer-2 link over PC5,
TMGI monitoring requests, Cell ID announcement requests etc. as described
elsewhere in this specification).
\- The SDU Type field (3 bits) in the PDCP header is used to discriminate
between IP, ARP and PC5 Signalling Protocol. ARP is not supported for one-to-
one communication.
\- PC5 Signalling Protocol messages are sent on a unicast Destination Layer-2
ID.
Figure 5.1.1.5.3-1: PC5 Signalling Protocol stack
#### 5.1.1.6 ProSe Function - ProSe Function
**Legend:**
\- PC6 is an inter-PLMN interface between the ProSe Functions in different
PLMNs (EPC-level ProSe Discovery) and between the ProSe function in the HPLMN
and the ProSe function in Local PLMN (ProSe Direct Discovery). PC7 is a
roaming interface between the ProSe function in the HPLMN and the ProSe
function in VPLMN. PC6 and PC7 are specified in TS 29.345 [23]
\- Diameter: This protocol supports the transfer of subscriber location
related information between ProSe Functions (PC6/PC7). Diameter is defined in
RFC 3588 [18].
\- Stream Control Transmission Protocol (SCTP): This protocol transfers
signalling messages. SCTP is defined in RFC 4960 [19].
Figure 5.1.1.6-1: Control Plane for PC6 and PC7 interface
#### 5.1.1.7 ProSe Function - ProSe Application Server
**Legend:**
\- PC2-AP is the PC2 Application Protocol and is specified in TS 29.343 [21].
Figure 5.1.1.7-1: Control Plane for PC2 interface
### 5.1.2 User Plane
#### 5.1.2.1 UE - UE
**Legend:**
\- **PC5-U:** The PDCP/RLC/MAC/PHY functionality is specified in TS 36.300
[17].
\- For PDCP SDU type \"Non-IP\", a \"Non-IP Type\" header is included in the
SDU by upper layer to indicate the type of non-IP messages carried as
specified in TS 24.334 [24].
NOTE: In this Release of the specification, \"Non-IP\" SDU type is not used by
ProSe Direct Communication.
Figure 5.1.2.1-1: User Plane for PC5 interface
#### 5.1.2.2 UE - UE-to-Network Relay
**Legend:**
\- GPRS Tunnelling Protocol for the user plane (GTPâ€‘U): This protocol tunnels
user data between eNodeB and the Sâ€‘GW as well as between the Sâ€‘GW and the Pâ€‘GW
in the backbone network. GTP shall encapsulate all end user IP packets.
\- MME controls the user plane tunnel establishment and establishes User Plane
Bearers between eNodeB and Sâ€‘GW.
\- UDP/IP: These are the backbone network protocols used for routing user data
and control signalling.
\- LTE-Uu: The radio protocols of E-UTRAN between the UE and the eNodeB are
specified in TS 36.300 [17].
\- PC5-U: The radio protocols of E-UTRAN between the UE and the UE-to-Network
Relay are specified in clause 5.1.2.1.
Editor\'s Note: Access Stratum stack to be reviewed and finally decided in RAN
WGs.
Figure 5.1.2.2-1: User Plane for UE-to-Network Relay
## 5.2 Service authorisation and revocation for ProSe Direct Discovery and
ProSe Direct Communication
### 5.2.1 Service authorisation procedures
Figure 5.2-1: Pre-configuration for ProSe Direct Discovery or ProSe Direct
Communication or both
The HPLMN pre-configures the UE with the authorization information for a list
of PLMNs where the UE is authorized to perform ProSe Direct Discovery or ProSe
Direct Communication or both and in addition information regarding out-of-
coverage operation may be provided. If there is no associated UE context, the
ProSe Function gets the subscription information for ProSe Direct Discovery
and/or ProSe Direct Communication from HSS.
Figure 5.2-2: Service authorisation for ProSe Direct Discovery or ProSe Direct
Communication or both
The UE gets the service authorisation for ProSe Direct Discovery or ProSe
Direct Communication or both, with a given validity time, from the ProSe
Function of the HPLMN. In addition, if the UE is authorized to use restricted
ProSe Direct Discovery service, the ProSe Function of the HPLMN assigns a
ProSe Discovery UE ID and sends it to the UE.
The service authorisation procedure is executed:
\- before starting the setup of ProSe Direct Discovery or ProSe Direct
Communication if the UE has no valid authorization information, or
\- when the UE already engaged in a ProSe Direct Discovery or ProSe Direct
Communication changes its registered PLMN and has no valid authorization
information for the new registered PLMN, or
\- when the service authorisation expires.
The authorisation is happening using \"over IP\" mechanisms and only IP
connectivity is required to allow the UE to access this ProSe Function.
In this signalling flow, shown in Figure 5.2-2, the following steps are
performed:
Step 1: The UE requests authorisation for Direct Discovery or Direct
Communication or both for HPLMN or for the VPLMN or for Direct Discovery for
some Local PLMNs from the ProSe Function in HPLMN.
Step 2: The ProSe Function in HPLMN obtains authorization info from Local PLMN
or VPLMN and merges with own policy.
Step 3: The ProSe Function in HPLMN provides authorisation info to UE. The
authorisation info provided to the UE applies to the serving PLMN and to PLMNs
determined by the HPLMN as Local PLMNs (e.g. based on the Serving PLMN) to be
available to the UE. The UE stores the authorisation information obtained from
this ProSe Function in a secure way. If needed at any point the authorization
can be revoked by the ProSe Function in Local PLMN or VPLMN or Prose Function
in the HPLMN.
NOTE: The notion of \"Local PLMN\" does not apply for WLAN-based ProSe Direct
Discovery. UE can engage in WLAN-based ProSe Direct Discovery as announcing or
monitoring UE regardless of the serving PLMN or other PLMNs that provide
E-UTRAN coverage in the UE location.
### 5.2.2 Service authorization update procedures
#### 5.2.2.1 General
The allowed PLMN for ProSe direct service can be updated at any point by the
HSS or the ProSe function. And the ProSe function can be the ProSe function in
HPLMN, in VPLMN or in Local PLMN.
The update of the allowed PLMN for ProSe direct service applies to ProSe
Direct Discovery or ProSe Direct Communication or both.
NOTE: The addition of the PLMN into allowed PLMN list for ProSe direct service
is triggered by HSS.
If UE is authorized to use restricted ProSe Direct Discovery service, and the
ProSe Function needs to update the ProSe Discovery UE ID before the UE context
validity timer expires, the ProSe Function uses the ProSe Service Notification
message to send the updated ProSe Discovery UE ID to the UE immediately or
waits to the next time communication with the ProSe Function per operator\'s
policy. The UE sends the updated ProSe Discovery UE ID to the ProSe
Application Server via PC1 interface.
#### 5.2.2.2 HSS triggered ProSe direct Service authorization update
Figure 5.2.2.2-1: HSS triggered ProSe direct services authorization update
NOTE: Steps 3, 4 can be executed at the same time as step 2.
1\. The ProSe related subscription data is updated, e.g. the authorization for
ProSe direct discovery service is updated. The HSS sends a Subscription Data
Updated Notify (IMSI, updated ProSe data) message to the ProSe Function in
HPLMN. The Subscription Data Updated Notify message may add or remove the
PLMNs from the allowed PLMN list for ProSe direct service. The updated ProSe
data includes the indication and the PLMN ID. The PLMN ID is optional. If it
is not included, it denotes the authorization for ProSe direct service
(discovery or communication or both) identified by the indication is to be
updated on all PLMNs. Otherwise only the authorization for ProSe direct
service in the indicated PLMN is to be updated. Upon receiving the message,
the ProSe Function in HPLMN updates the associated ProSe UE context if it has
been stored before.
2\. The UE get the updated authorisation for ProSe direct service via the
ProSe Service Notification message immediately or waits to the next time
communication with the ProSe function in HPLMN per operator\'s policy.
3\. If the authorization for ProSe direct service includes the change to the
PLMN which UE is registered, e.g. remove the PLMN UE registered from allowed
ProSe direct discovery PLMN list, and the ProSe direct service to be updated
includes ProSe direct discovery announcing or ProSe direct communication, the
HSS notifies the updated ProSe subscription data to the MME via the Insert
Subscriber Data message. If only the authorization for ProSe direct discovery
monitoring is to be updated, the notification to the MME is not need. The MME
updates the stored UE context.
4\. If the S1 bearer is established, the MME sends the updated UE ProSe
context to eNodeB via the UE Context Modification Request (ProSe Authorized)
message. The eNodeB take the following action based on the updated \"ProSe
Authorized\" indication.
#### 5.2.2.3 ProSe function triggered ProSe Direct Service revocation (non-
roaming)
Figure 5.2.2.3-1: ProSe Function triggered ProSe direct services revocation
(non-roaming)
NOTE: Steps 2, 3, 4 can be executed at the same time as step 1.
1\. The HPLMN ProSe Function decides to revoke the authorization for ProSe
direct service, e.g. ProSe Direct Discovery service is revoked on one PLMN.
The UE get the updated authorization for ProSe direct service via the ProSe
Service Notification message immediately or waits to the next time
communication with the ProSe function in HPLMN per operator\'s policy.
2\. The ProSe Function notifies the HSS to change the subscription data by
sending an Update ProSe Policy Data (IMSI, updated ProSe data) message. The
updated ProSe data includes the indication and the PLMN ID. The combination of
the indication and the PLMN ID denotes the authorization for ProSe direct
service (discovery or communication or both) identified by the indication is
to be revoked on the indicated PLMN. Upon receiving the message, the HSS
updates the ProSe subscription data.
The description of steps 3-4 are the same as steps 3-4 in clause 5.2.2.2.
#### 5.2.2.4 ProSe function triggered ProSe Direct Service revocation
(roaming)
Figure 5.2.2.4-1: ProSe Function triggered ProSe direct services revocation
(roaming)
NOTE: Steps 3, 4, 5, 6 can be executed at the same time as step 2.
1\. The VPLMN or Local PLMN ProSe Function decides to revoke the authorization
for ProSe direct service, e.g. ProSe direct discovery service is revoked for
the inbound roamer. The VPLMN or Local PLMN ProSe Function sends a ProSe
Service Policy change Notification (UE identity, indication, revoked PLMN ID,
HPLMN ID) message to HPLMN ProSe Function. The UE identity is optional, e.g.
it is not included if the Local PLMN ProSe Function wants to revoke ProSe
direct discovery service for all UEs of the HPLMN. The UE identity can be
either IMSI or MSISDN. If UE identity is not included in the message, the
ProSe direct service to be revoked aims to all the UE from the indicated HPLMN
ID. The combination of the indication and the revoked PLMN ID denotes the
authorization for ProSe direct service (discovery or communication or both)
identified by the indication is to be revoked on the indicated PLMN.
2\. The UE get the updated authorization for ProSe direct service via the
ProSe Service Notification message immediately or waits to the next time
communication with the ProSe function in HPLMN per operator\'s policy.
3\. The HPLMN ProSe Function notifies the HSS to change the subscription data
by sending an Update ProSe Policy Data (IMSI, updated ProSe data) message. If
the UE identity is received in step 1, the ProSe Function includes the IMSI of
the UE in the message. The updated ProSe data includes the indication and the
Revoked PLMN ID received in step 1.
4\. If the IMSI is not received, the HSS determines the affected UE based on
the revoked PLMN ID, i.e. all UE\'s whose ProSe direct service authorization
includes the revoked PLMN ID, and updates the corresponding ProSe subscription
data.
For each affected UE the HSS trigger the update procedure as the steps 5-6.
The description of steps 5-6 are the same as steps 3-4 in clause 5.2.2.2.
## 5.3 ProSe Direct Discovery
### 5.3.1 General
#### 5.3.1.1 Overview
ProSe Direct Discovery is defined as the process that detects and identifies
another UE in proximity using E-UTRA or WLAN direct radio signals.
There are two types of ProSe Direct Discovery: open and restricted. Open is
the case where there is no explicit permission that is needed from the UE
being discovered, whereas restricted discovery only takes place with explicit
permission from the UE that is being discovered.
ProSe Direct Discovery can be a standalone service enabler that could for
example use information from the discovered UE for certain applications in the
UE that are permitted to use this information e.g. \"find a taxi nearby\",
\"find me a coffee shop\". Additionally depending on the information obtained
ProSe Direct Discovery can be used for subsequent actions e.g. to initiate
ProSe Direct Communication.
ProSe-enabled non-Public Safety UEs which have obtained authorization to
participate in ProSe Direct Discovery procedures shall not continue in
participating in ProSe Direct Discovery procedures as soon as they detect loss
of E-UTRA coverage in the serving PLMN.
With E-UTRA-based ProSe Direct Discovery the UE can use inter-PLMN discovery
transmission based on the indication from the serving eNodeB or the
provisioned radio resource on the UE. How the serving cell authorizes the UE
to use inter-PLMN radio resource is specified in TS 36.331 [33].
#### 5.3.1.2 ProSe Direct Discovery Models
The following models for ProSe Direct Discovery exist:
**Model A (\"I am here\")**
This model defines two roles for the ProSe-enabled UEs that are participating
in ProSe Direct Discovery.
\- Announcing UE: The UE announces certain information that could be used by
UEs in proximity that have permission to discover.
\- Monitoring UE: The UE that monitors certain information of interest in
proximity of announcing UEs.
In this model the announcing UE broadcasts discovery messages at pre-defined
discovery intervals and the monitoring UEs that are interested in these
messages read them and process them.
NOTE: This model is equivalent to \"I am here\" since the announcing UE would
broadcast information about itself e.g. its ProSe Application Code in the
discovery message.
With E-UTRA-based ProSe Direct Discovery the UE can act as \"announcing UE\"
only in the carrier frequency signalled by the serving PLMN but may act as a
\"monitoring\" UE also in the resources of the serving PLMN and Local PLMNs,
when using Model A mode. When inter-PLMN discovery transmission is supported,
the carrier frequency may be operated by a PLMN other than the serving PLMN,
as described in TS 36.331 [33].
Both open and restricted discovery types are supported by Model A.
**Model B (\"who is there?\" / \"are you there?\")**
This model when restricted discovery type is used, defines two roles for the
ProSe-enabled UEs that are participating in ProSe Direct Discovery.
\- **Discoverer UE:** The UE transmits a request containing certain
information about what it is interested to discover.
\- **Discoveree UE:** The UE that receives the request message can respond
with some information related to the discoverer\'s request.
It is equivalent to \" who is there/are you there\" since the discoverer UE
sends information about other UEs that would like to receive responses from,
e.g. the information can be about a ProSe Application Identity corresponding
to a group and the members of the group can respond.
With E-UTRA-based ProSe Direct Discovery when using Model B discovery, the
discoverer UE and discoveree UE can announce in the carrier frequency
signalled by the serving PLMN. When inter-PLMN discovery transmission is
supported, the carrier frequency may be operated by a PLMN other than the
serving PLMN, as described in TS 36.331 [33]. The discoverer UE and discoveree
UE are allowed to monitor or announce in the serving PLMN and Local PLMNs when
authorized.
Only restricted discovery type is supported by Model B.
The Public Safety discovery is considered restricted. The monitoring
UE/discoverer UE needs to have authorization (such as through pre-provisioned
parameters) to perform discovery of the appropriate service(s).
#### 5.3.1.3 WLAN-based ProSe Direct Discovery
This clause summarises the specifics of WLAN-based ProSe Direct Discovery in
reference to the call flows for Discovery Request (clause 5.3.3) and Discovery
Reporting (clause 5.3.4), without modifying the call flows themselves:
\- The notion of \"Local PLMN\" in the sense of \"PLMN operating the carrier
frequency for inter-PLMN transmission\" does not apply. The \"Announcing PLMN
ID\" parameter in the Discovery Request for open discovery is therefore not
used.
\- In the Match Report the UE indicates that the report is for WLAN-based
ProSe Direct Discovery for charging purposes.
### 5.3.2 Overall procedure for ProSe Direct Discovery (Model A)
Figure 5.3.2-1: Overall procedure for ProSe Direct Discovery
This procedure is only applied for open and restricted ProSe Direct Discovery
when the ProSe enabled UE is served by E-UTRAN.
1\. Service authorisation for ProSe direct services is performed for ProSe
Direct Discovery as defined in clauses 5.2, and 4.5.1.
If the UE is authorised to announce:
2a. When the UE is triggered to announce, then it sends a discovery request
for announcing to the ProSe Function in HPLMN as defined in clauses 5.3.3.2
and 5.3.3.3 for open ProSe Direct Discovery, and in clauses 5.3.3.2A and
5.3.3.3A for restricted ProSe Direct Discovery. In addition, for restricted
ProSe Direct Discovery, the ProSe Function further interacts with the ProSe
Application server for the authorization of the discovery request.
3a. If the request is successful and is provided with ProSe Application
Code/ProSe Restricted Code then it starts announcing on PC5 interface.
For ProSe restricted discovery and UE requests \"on demand\" announcing, ProSe
Restricted Code may be provided to UE after this procedure. In this case, UE
waits for the ProSe Restricted Code allocation and starts to announce the
ProSe Restricted Code on PC5 after receiving it in Announcing Alert procedure
specified in clause 5.3.5.
NOTE 1: More details on the Access Stratum protocol of this step are provided
in RAN specifications.
If the UE is authorised to monitor:
2b. When the UE is triggered to monitor, it sends a discovery request for
monitoring to the ProSe Function as defined in clauses 5.3.3.4 and 5.3.3.5 for
open ProSe Direct Discovery, and in clauses 5.3.3.2A and 5.3.3.3A for
restricted ProSe Direct Discovery. In addition, for restricted ProSe Direct
Discovery, the ProSe Function further interacts with the ProSe Application
server for the authorization of the discovery request.
3b. If the request is successful and the UE is provided with a Discovery
Filter consisting of ProSe Application Code(s)/ProSe Restricted Code(s) and/or
ProSe Application Mask(s) it starts monitoring for these ProSe Application
Codes/ProSe Restricted Codes on the PC5 interface.
NOTE 2: More details on the Access Stratum protocol of this step are provided
in RAN specifications.
4b. When the UE detects that one or more ProSe Application Code(s)/ProSe
Restricted Code(s) that match the filter (see clause 4.6.4.2), it reports the
ProSe Application Code(s)/ProSe Restricted Code(s) to the ProSe Function as
defined in clause 5.3.4.
Non roaming direct discovery procedures cover the case where both the
\"announcing UE\" and \"monitoring UE\" are served by their respective HPLMN.
Roaming direct discovery procedures cover the other cases.
### 5.3.2A Overall procedure for ProSe Direct Discovery (Model B)
Figure 5.3.2A-1: Overall procedure for ProSe Direct Discovery (Model B)
This procedure is applied for restricted ProSe Direct Discovery when the ProSe
enabled UE is served by E-UTRAN.
1\. Service authorisation for ProSe direct services is performed for ProSe
Direct Discovery as defined in clauses 5.2 and 4.5.1.
If the UE is authorised to perform restricted ProSe Direct Discovery, Model B,
as a Discoveree UE, the following steps take place:
2a. When the UE is triggered to perform restricted ProSe Direct Discovery,
Model B, it sends a discovery request to the ProSe Function in the HPLMN to
obtain a ProSe Response Code as defined in clauses 5.3.3A.2 and 5.3.3A.3 The
ProSe Function further interacts with ProSe Application Server for the
authorization of the discovery request.
3a. If the request is successful and the UE is provided with a ProSe Response
Code and an associated Discovery Query Filter(s), then the UE starts
monitoring for the ProSe Query Code on PC5 interface.
4a. If a received ProSe Query Code matches any of the Discovery Query
Filter(s), the UE announces the associated ProSe Response Code on the PC5
interface.
NOTE 1: More details on the Access Stratum protocol of this step are provided
in RAN specifications.
If the UE is authorised to perform restricted ProSe Direct Discovery, Model B,
as a Discoverer UE, the following steps take place:
2b. When the UE is triggered to perform restricted ProSe Direct Discovery,
Model B, it sends a discovery request to the ProSe Function in the HPLMN for a
ProSe Query Code as defined in clauses 5.3.3A.4 and 5.3.3A.5. The ProSe
Function further interacts with ProSe Application Server for the authorization
of the discovery request.
3b. If the request is successful and the UE is provided with a ProSe Query
Code and the Discovery Response Filter(s) consisting of ProSe Response Code(s)
and ProSe Application Mask(s), the UE announces the ProSe Query Code on the
PC5 interface.
4b. The UE starts to monitor on PC5 interface for any ProSe Response Code(s)
that might match the Discovery Response Filter(s).
NOTE 2: More details on the Access Stratum protocol of this step are provided
in RAN specifications.
5b. When the UE detects a match for one or more ProSe Response Code(s), it
reports the ProSe Response Code to the ProSe Function as defined in clauses
5.3.4A.1 and 5.3.4A.2.
Non roaming direct discovery procedures cover the case where both the
Discoveree UE and Discoverer UE are served by their respective HPLMN. Roaming
direct discovery procedures cover the other cases.
### 5.3.3 Discovery Request
#### 5.3.3.1 General
The Discovery Request is sent by the \"announcing UE\" or \"monitoring UE\" in
order to be authorised to access the discovery resources and perform ProSe
Direct Discovery.
#### 5.3.3.2 Announce request (non-roaming) - open discovery
Figure 5.3.3.2-1: Announce request procedure (non-roaming)
0\. The UE is configured with the data structure of the ProSe Application IDs
corresponding to HPLMN. This step is performed using mechanisms that are out
of scope of 3GPP.
1\. If the UE is authorised to announce in HPLMN, or if UE intends to make
announcement using WLAN-based PC5 and is triggered to announce, it shall
establish a secure connection with the ProSe Function and it shall send a
Discovery Request (ProSe Application ID, UE Identity, announce command,
Application ID, Discovery Entry ID, [Requested Timer], [Application Level
Container], [PC5_tech]) message for announcing. The ProSe Application ID
indicates what the UE is interested to announce. The UE Identity is set to
e.g. IMSI. The Application ID represents a unique identifier of the UE
application that has triggered the transmission of the Discovery Request
message. The Discovery Entry ID indicates whether this is a new request. The
Requested Timer is an optional parameter and indicates the length of validity
timer associated with the ProSe Application Code that the UE expects to
receive from the ProSe Function in step 3. When the Requested Timer is set to
zero, procedures in clause 5.3.6A.1.3 shall be followed. PC5_tech is an
optional parameter that indicates the PC5 radio technology (e.g. E-UTRA, WLAN)
that UE wishes to use for announcements. PC5_tech may include more than one
PC5 radio technology. When this parameter is omitted the intended PC5 radio
technology is E-UTRA. This request is always sent to the ProSe Function in
HPLMN.
If application-controlled extension is used, the Discovery Request message
also includes the Application Level Container. The Application Level Container
contains the request and any relevant information for the ProSe Application
Server to assign a (set of) ProSe Application Code Suffix(es).
If dynamic metadata is used, the Discovery Request message also includes the
metadata to be uploaded to the ProSe Function. Moreover, when the UE updates
the metadata for a valid ProSe Application Code, the command is set to
\"metadata _update\" in the Discovery Request message.
2\. The ProSe Function checks for the authorization of the application
represented by the Application ID. If there is no associated UE context, the
ProSe Function shall check with HSS the authorisation for discovery and create
a new context for this UE that contains the subscription parameters for this
UE. The HSS provides the MSISDN of the UE. When the Discovery Entry ID in the
Discovery Request message does not contain a valid value for this UE, the
ProSe Function will create a new discovery entry in the UE\'s context for this
request, and will return the corresponding identifier in the Discovery
Response message in step 3.
NOTE 1: Home ProSe Function can retain the previously camped PLMN ID and
associated ProSe Application Code for an operator configurable time when
informed by HSS of a PLMN change. When the configuration timer expires, the
previously camped PLMN ID and associated ProSe Application Code can be removed
from the UE context.
2.a If the UE indicated it desired application-controlled extension by the
inclusion of the Application Level Container, the ProSe Function sends an Auth
Request (ProSe Application ID, Request Type, Application Level Container,
Allowed number of suffixes) to the ProSe Application Server. The Request Type
is set to \"open discovery with application-controlled extension /announce \".
The Allowed Number of Suffixes indicates how many ProSe Restricted Code
Suffixes the ProSe Application Server can assign for the UE. The ProSe
Function locates the ProSe Application Server based on the Application ID.
2.b The ProSe Application Server returns an Auth Response (Response Type,
ProSe Application Code Suffix pool) message. The ProSe Application Code Suffix
pool contains the Suffix(es) allocated by the ProSe Application based on the
inputs in step 2.a. The Response Type is set to \"open discovery with
application-controlled extension /announce ack\".
NOTE 2: The length of the ProSe Restricted Code Suffix is chosen by the ProSe
Application Server from a set of allowable lengths (e.g. 8 bits, 24 bits, 48
bits). This choice is per application, so that all UEs announcing ProSe
application Codes assigned for ProSe Application IDs from that Application ID
use the same Suffix length (which may be zero if no application-controlled
extension is allowed for this Application).
NOTE 3: The ProSe Application Code Suffix pool needs to support the indication
of a large number of or a range of ProSe Application Code Suffixes.
3\. If the Discovery Request is authorised, then the ProSe Function shall
check whether the UE is authorized to use the ProSe Application ID contained
in the Discovery Request. If the UE is authorised to use that ProSe
Application ID, then the ProSe Function shall respond with a Discovery
Response (ProSe Application Code, validity timer, Discovery Entry ID,
[PC5_tech]) message. The ProSe Application Code is provided by the ProSe
Function and corresponds to the ProSe Application ID that was contained in the
Discovery Request. The validity timer indicates for how long this ProSe
Application Code is going to be valid; the ProSe Function takes into account
the Requested Timer parameter, if provided by the UE, when allocating the
validity timer. The UE will be authorised to announce this ProSe Application
Code for the duration of validity timer and if it remains in the HPLMN. When
the validity timer expires or the UE changes its registered PLMN the UE needs
to request a new ProSe Application Code. The optional PC5_tech parameter
indicates the PC5 radio technology(ies) that is/are authorized to be used for
the assigned ProSe Application Code. When this parameter is omitted, the
authorized PC5 radio technology is E-UTRA.
If dynamic metadata is used , the ProSe Function stores the metadata with the
associated ProSe Application ID in the UE context, and allocates a
corresponding Metadata Index to be included into the ProSe Application Code.
Moreover, if the command is set to \"metadata_update\" in step 1, the ProSe
Function only updates the Metadata Index portion of the ProSe Application
Code, and keeps the rest unchanged.
If application-controlled extension is used, the ProSe Application Code is
replaced by the ProSe Application Code Prefix, and the Discovery Response
message also contains the ProSe Application Code Suffix pool.
NOTE 4: To avoid interrupting the discovery procedure, if the UE changes its
registered PLMN but the validity timer of the Prose Application Code has not
yet expired then the ProSe Function may allocate the same ProSe Application
Code to the UE, with a validity timer set to the residual validity time of the
validity timer not yet expired.
NOTE 5: The UE appends a ProSe Application Code Suffix from the ProSe
Application Code Suffix pool to the ProSe Application Code Prefix to form a
ProSe Application Code. When the ProSe Application Code Suffix pool contains
multiple suffixes, the UE may use different suffixes from the ProSe
Application Code Suffix pool to form different ProSe Application Codes to
announce, without having to contact the ProSe Function as long as the ProSe
Application Code Prefix is valid.
4\. The UE may start announcing the provided ProSe Application Code in HPLMN,
using the radio resources authorised and configured by E-UTRAN to be used for
ProSe as defined in RAN specifications or using WLAN, or both.
If the validity timer associated with a ProSe Application Code expires
(because the UE has not refreshed the corresponding Discovery Request within
the duration of the validity timer), then the ProSe Function removes the entry
related to that ProSe Application Code from the UE context.
#### 5.3.3.2A Announce Request (non-roaming) - restricted discovery
Figure 5.3.3.2A-1: Announce Request procedure for restricted discovery (non-
roaming)
0\. The user sets the permission for the restricted discovery using
application layer mechanisms. In addition, the application client in the UE
retrieves the PDUID and provides it to the ProSe Application Server. The ProSe
Application Server allocates a RPAUID for that PDUID stores the binding
between the PDUID and the RPAUID and returns the RPAUID to the application
client in the UE. The UE may optionally provide metadata to be associated with
the RPAUID, and the ProSe Application Server stores the metadata. The
application client in the UE stores the binding between the PDUID and its own
RPAUID. If the application client in the UE intends to use the ProSe service,
it triggers the UE to perform the announce procedure, providing its own RPAUID
obtained by the ProSe Application Server.
NOTE 1: The procedures in step 0 are out of scope of 3GPP. However, it is
expected that the application client in the UE will be able to retrieve the
PDUID from the underlying ProSe Protocol layer.
1\. If the UE is authorized to announce in the serving PLMN, or if UE intends
to make announcement using WLAN-based PC5 and is triggered by the application
client to announce, it shall establish a secure connection with the ProSe
Function in HPLMN and send a Discovery Request message (RPAUID, UE Identity,
command=announce, Discovery Type, Application ID, Discovery Entry ID,
Requested Discovery Timer, Application Level Container, Announcing Type,
[PC5_tech]) for announcing. The RPAUID indicating what the UE is interested to
announce was obtained in step 0. The UE Identity is set to IMSI. The
Application ID represents a unique identifier of the UE application that has
triggered the transmission of the Discovery Request message. The Discovery
Type is set to \"restricted discovery\". The Discovery Entry ID indicates
whether this is a new request. The Requested Discovery Timer is an optional
parameter and indicates the length of validity timer associated with the ProSe
Restricted Code that the UE expects to receive from the ProSe Function in step
4. When the Requested Discovery Timer is set to zero, the ProSe Function shall
remove the discovery entry indicated by the Discovery Entry ID, and release
the associated resources. PC5_tech is an optional parameter that indicates the
PC5 radio technology (e.g. E-UTRA, WLAN) that UE wishes to use for
announcements. PC5_tech may include more than one PC5 radio technology. When
this parameter is omitted the intended PC5 radio technology is E-UTRA.
If restricted Direct Discovery with application-controlled extension is used,
the Discovery Request message also includes the Application Level Container.
The Application Level Container contains the request and any relevant
information (e.g. intent to use metadata indication in the suffix) for the
ProSe Application Server to assign a (set of) ProSe Restricted Code
Suffix(es). The Discovery Type is set to \"restricted discovery with
application-controlled extension\".
Announcing type can be set to \"on demand\" to indicate the \"on demand\"
announcing is requested by UE for the indicated application.
If the Requested Discovery Timer is included in step 1 and the value is set to
zero, step 2 to step 3 are skipped.
2\. The ProSe Function checks for the authorization of the application
represented by the Application ID. If there is no associated UE context, the
ProSe Function shall check with HSS the authorisation for discovery and, if
necessary, create a new context for this UE that contains the subscription
parameters for this UE. The HSS provides the MSISDN of the UE. The HSS also
provides the serving PLMN ID of where the UE is registered. When the Discovery
Entry ID in the Discovery Request message does not contain a valid value for
this UE, the ProSe Function creates a new discovery entry in the UE\'s context
for this request, and returns the corresponding identifier in the Discovery
Response message in step 4.
2.a Optionally, the ProSe Function sends an Auth Request (RPAUID, Request
Type) to the ProSe Application Server. The ProSe Function locates the ProSe
Application Server based on the Application ID. The Request Type is set to
\"restricted discovery/announce\".
If restricted Direct Discovery with application-controlled extension is used,
the Auth Request message also includes the Allowed Number of Suffixes. The
Allowed Number of Suffixes indicates how many ProSe Restricted Code Suffixes
the ProSe Application Server can assign for the UE. The Request Type is set to
\"restricted discovery with application-controlled extension /announce\".
2.b The ProSe Application Server returns an Auth Response (PDUID(s), Response
Type) message. The PDUID(s) corresponds to the RPAUID stored in the ProSe
Application Server. The Response Type is set to \"restricted
discovery/announce ack\".
If restricted Direct Discovery with application-controlled extension is used,
the Auth Response message also includes the ProSe Restricted Code Suffix pool.
The ProSe Restricted Code Suffix pool contains the Suffix(es) allocated by the
ProSe Application based on the inputs in step 2.a. The Request Type is set to
\"restricted discovery with application-controlled extension /announce ack\".
The ProSe Function verifies that at least one of the received PDUID(s) belongs
to the requesting UE.
NOTE 2: Whether steps 2.a and 2.b are executed depends on ProSe Function
configuration, or policy regarding the specific Application Server. For
example, if the ProSe Function can already verify the ownership locally, it
does not have to perform the two steps.
NOTE 3: The length of the ProSe Restricted Code Suffix is chosen by the ProSe
Application Server from a set of allowable lengths (e.g. 8 bits, 24 bits, 48
bits). This choice is per application, so that all UEs announcing ProSe
Restricted Codes assigned for Restricted ProSe Application User IDs from that
Application ID use the same Suffix length (which may be zero if no
application-controlled extension is allowed for this Application).
NOTE 4: The ProSe Restricted Code Suffix pool needs to support the indication
of a large number of or a range of ProSe Restricted Code Suffixes.
3\. The ProSe Function in HPLMN allocates a ProSe Restricted Code and the
associated validity timer. The ProSe Restricted Code corresponds to the RPAUID
that was contained in the Discovery Request from the UE. The validity timer
shall indicate for how long this ProSe Restricted Code is going to be valid.
The UE will be authorised to announce this ProSe Restricted Code for the
duration of validity timer and if it remains in the same PLMN. The ProSe
Function stores the RPAUID, the ProSe Restricted Code and the associated
validity timer in the user context.
If restricted Direct Discovery with application-controlled extension is used,
the ProSe Function in the HPLMN allocates a ProSe Restricted Code Prefix
(rather than a ProSe Restricted Code) based on the Application ID and/or the
Restricted ProSe App User ID.
If restricted ProSe Direct Discovery with \"on demand\" announcing has been
requested, the ProSe Function determines if \"on demand\" announcing is
authorized and enabled based on the Application ID and operator\'s policy. If
\"on demand\" announcing is authorized and enabled, the ProSe Function stores
the RPAUID, the ProSe Restricted Code with the associated validity timer and
the Announcing Enabled indicator in the user context.
NOTE 5: It is up to the policy in the ProSe Function whether to allocate the
same ProSe Restricted Code for a set of several RPAUIDs or different ProSe
Restricted Codes for the different RPAUIDs.
4\. The ProSe Function in HPLMN responds to the UE with a Discovery Response
(ProSe Restricted Code, validity timer, Discovery Entry ID, [PC5_tech])
message.
If restricted Direct Discovery with application-controlled extension is used,
the ProSe Restricted Code is replaced by the ProSe Restricted Code Prefix, and
the Discovery Response message also contains the ProSe Restricted Code Suffix
pool.
If the \"on demand\" announcing is authorized and enabled in step 3 and there
is no ongoing monitoring request, the ProSe Function in HPLMN does not provide
a ProSe Restricted Code to the UE and responds to the UE with a Discovery
Response (validity timer, Announcing Enabled indicator, Discovery Entry ID)
message.
If the Requested Discovery Timer is included in step 1 and the value is set to
zero, the validity timer in the Discovery Response message is set to zero.
The optional PC5_tech parameter indicates the PC5 radio technology(ies) that
is/are authorized to be used for the assigned ProSe Application Code. When
this parameter is omitted, the authorized PC5 radio technology is E-UTRA.
NOTE 6: The announcing UE may receive the same ProSe Restricted Code as a
result of different Announce Request procedures.
NOTE 7: The UE appends a ProSe Restricted Code Suffix from the ProSe
Restricted Code Suffix pool to the ProSe Restricted Code Prefix to form a
ProSe Restricted Code. When the ProSe Restricted Code Suffix pool contains
multiple suffixes, the UE may use different suffixes from the ProSe Restricted
Code Suffix pool to form different ProSe Restricted Codes to announce, without
having to contact the ProSe Function as long as the ProSe Restricted Code
Prefix is valid.
5\. The UE may start announcing the provided ProSe Restricted Code in the
serving PLMN, using the radio resources authorised and configured by E-UTRAN
to be used for ProSe as defined in RAN specifications or using WLAN, or both.
If the \"on demand\" announcing is used and ProSe Function does not provide a
ProSe Restricted Code to the UE in step 4, the UE waits for an Announcing
Alert Request message from the ProSe Function in HPLMN before starting to
announce over the air (see clause 5.3.5.1).
NOTE 8: The ProSe Protocol layer in the UE may inform the application client
that it has started announcing. This is out of scope of 3GPP.
If the validity timer associated with a ProSe Restricted Code expires (because
the UE has not refreshed the corresponding Discovery Request within the
duration of the validity timer), then the ProSe Function removes the entry
related to that ProSe Restricted Code from the UE context.
#### 5.3.3.3 Announce request (roaming/inter-PLMN transmission) - open
discovery
Figure 5.3.3.3-1: Announce request procedure (roaming/inter-PLMN transmission)
The UE is only allowed to announce in the carrier frequency signalled from
serving PLMN. When inter-PLMN discovery transmission is supported, the carrier
frequency may be operated by Local PLMN.
0\. The UE is configured with the data structure of the ProSe Application IDs
corresponding to HPLMN. This step is performed using mechanisms that are out
of scope of 3GPP.
1\. If the UE is authorised to announce in the PLMN operating the carrier
frequency signalled from the serving PLMN (VPLMN or Local PLMN), or if UE
intends to make announcement using WLAN-based PC5 and is triggered to
announce, it shall establish a secure connection with the ProSe Function in
HPLMN and it shall then send a Discovery Request (ProSe Application ID, UE
Identity, announce command, Application ID, Discovery Entry ID, [Requested
Timer], [metadata], [Announcing PLMN ID], [Application Level Container],
[PC5_tech]) message for announcing. The ProSe Application ID indicates what
the UE is interested to announce. The UE Identity is set to e.g. IMSI. The
Application ID represents a unique identifier of the UE application that has
triggered the transmission of the Discovery Request message. The Discovery
Entry ID indicates whether this is a new request. The Requested Timer is an
optional parameter and indicates the length of validity timer associated with
the ProSe Application Code that the UE expects to receive from the ProSe
Function in step 5. When the Requested Timer is set to zero, procedures in
clause 5.3.6A.1.3 shall be followed. PC5_tech is an optional parameter that
indicates the PC5 radio technology (e.g. E-UTRA, WLAN) that UE wishes to use
for announcements. PC5_tech may include more than one PC5 radio technology.
When this parameter is omitted the intended PC5 radio technology is E-UTRA.
This request is always sent by the UE to the ProSe Function in HPLMN.
If dynamic metadata is used, the Discovery Request message also includes the
metadata to be uploaded to the ProSe Function. Moreover, when the UE updates
the metadata for a valid ProSe Application Code, the command is set to
\"metadata_update\" in the Discovery Request message.
If inter-PLMN ProSe discovery transmission is supported, and the serving PLMN
signalled carrier frequency is not operated by HPLMN or VPLMN, the UE shall
include the PLMN ID of that carrier frequency in the Announcing PLMN ID.
If application-controlled extension is used, the Discovery Request message
also includes the Application Level Container. The Application Level Container
contains the request and any relevant information for the ProSe Application
Server to assign a (set of) ProSe Application Code Suffix(es).
2\. The ProSe Function checks for the authorization of the application
represented by the Application ID. If there is no associated UE context, the
ProSe Function shall check with HSS the authorisation for discovery and, if
necessary, create a new context for this UE that contains the subscription
parameters for this UE. The HSS provides the MSISDN of the UE. The HSS also
provides the VPLMN ID of where the UE is registered. When the Discovery Entry
ID in the Discovery Request message does not contain a valid value for this
UE, the ProSe Function will create a new discovery entry in the UE\'s context
for this request, and will return the corresponding identifier in the
Discovery Response message in step 5.
NOTE 1: Home ProSe Function can retain the previously camped PLMN ID and
associated ProSe Application Code for an operator configurable time when
informed by HSS of a PLMN change. When the configuration timer expires, the
previously camped PLMN ID and associated ProSe Application Code can be removed
from the UE context.
2.a If the UE indicated it desired application-controlled extension by the
inclusion of the Application Level Container, the ProSe Function sends an Auth
Request (ProSe Application ID, Request Type, Application Level Container,
Allowed number of suffixes) to the ProSe Application Server. The Request Type
is set to \"open discovery with application-controlled extension /announce \".
The Allowed Number of Suffixes indicates how many ProSe Restricted Code
Suffixes the ProSe Application Server can assign for the UE. The ProSe
Function locates the ProSe Application Server based on the Application ID.
2.b The ProSe Application Server returns an Auth Response (Response Type,
ProSe Application Code Suffix pool) message. The ProSe Application Code Suffix
pool contains the Suffix(es) allocated by the ProSe Application based on the
inputs in step 2.a. The Response Type is set to \"open discovery with
application-controlled extension /announce ack\".
NOTE 2: The length of the ProSe Restricted Code Suffix is chosen by the ProSe
Application Server from a set of allowable lengths (e.g. 8 bits, 24 bits, 48
bits). This choice is per application, so that all UEs announcing ProSe
application Codes assigned for ProSe Application IDs from that Application ID
use the same Suffix length (which may be zero if no application-controlled
extension is allowed for this Application).
NOTE 3: The ProSe Application Code Suffix pool needs to support the indication
of a large number of or a range of ProSe Application Code Suffixes.
3\. If the Discovery Request is authorised, then the HPLMN ProSe Function
shall check whether the UE is authorized to use the ProSe Application ID
contained in the Discovery Request. If the UE is authorised to use that ProSe
Application ID, then the HPLMN ProSe Function shall inform the ProSe Function
in VPLMN or Local PLMN if Announcing PLMN ID is included in step 1 with the
Announce Authorisation (ProSe Application ID, ProSe Application Code, UE
Identity, validity timer, Discovery Entry ID, [metadata], [PC5_tech]) message.
The ProSe Application ID corresponds to the request from the UE, whereas the
ProSe Application Code indicates the assigned code for this request. The
request also includes the UE identity information e.g. IMSI or MSISDN and
validity timer in order to allow the ProSe Function in VPLMN or Local PLMN to
perform charging. The validity timer indicates for how long this ProSe
Application Code is going to be valid; the ProSe Function in the HPLMN takes
into account the Requested Timer parameter, if provided by the UE, when
allocating the validity timer. If the ProSe Function in VPLMN or Local PLMN
receives the same Discovery Entry ID in a subsequent Announce Authorization
message, it updates the announcing UE\'s corresponding discovery entry
replacing the existing ProSe Application Code and validity timer with the last
received ones. The request may also include the PC5_tech parameter if it was
provided by the UE in step 1. When this parameter is omitted the intended PC5
radio technology is E-UTRA.
NOTE 4: The information provided in step 3 that is related to charging is used
only when the requested PC5 radio technology includes E-UTRA.
If dynamic metadata is used , the ProSe Function stores the metadata with the
associated ProSe Application ID in the UE context, and allocates a
corresponding Metadata Index to be included into the ProSe Application Code.
Moreover, if the command is set to \"metadata_update\" in step 1, the ProSe
Function only updates the Metadata Index portion of the ProSe Application
Code, and keeps the rest unchanged. The metadata is also included in the
Announce Authorisation message.
If application-controlled extension is used, the ProSe Function in the HPLMN
allocates a ProSe Application Code Prefix (rather than a ProSe Application
Code) based on the Application ID.
4\. The ProSe Function in VPLMN or Local PLMN authorizes the UE to perform
ProSe Direct Discovery announcing.
5\. The ProSe Function in HPLMN shall respond to the UE with a Discovery
Response (ProSe Application Code, validity timer, Discovery Entry ID,
[PC5_tech]) message. ProSe Application Code is provided by the ProSe Function
in HPLMN and corresponds to the ProSe Application ID that was contained in the
Discovery Request from the UE. The validity timer shall indicate for how long
this ProSe Application Code is going to be valid. The UE will be authorised to
announce this ProSe Application Code for the duration of validity timer and if
it remains in the same PLMN. The optional PC5_tech parameter indicates the PC5
radio technology(ies) that is/are authorized to be used for the assigned ProSe
Application Code. When this parameter is omitted, the authorized PC5 radio
technology is E-UTRA.
If application-controlled extension is used, the ProSe Application Code is
replaced by the ProSe Application Code Prefix, and the Discovery Response
message also contains the ProSe Application Code Suffix pool.
NOTE 5: To avoid interrupting the discovery procedure, if the UE changes PLMN
but the validity timer of the Prose Application Code has not yet expired then
the ProSe Function may allocate the same ProSe Application Code to the UE,
with a validity timer set to the residual validity time of the validity timer
not yet expired.
NOTE 6: The UE appends a ProSe Application Code Suffix from the ProSe
Application Code Suffix pool to the ProSe Application Code Prefix to form a
ProSe Application Code. When the ProSe Application Code Suffix pool contains
multiple suffixes, the UE may use different suffixes from the ProSe
Application Code Suffix pool to form different ProSe Application Codes to
announce, without having to contact the ProSe Function as long as the ProSe
Application Code Prefix is valid.
6\. The UE may start announcing the provided ProSe Application Code in the
VPLMN or Local PLMN, using the radio resources authorised and configured by
E-UTRAN to be used for ProSe as defined in RAN specifications or using WLAN,
or both.
If the validity timer associated with a ProSe Application Code expires
(because the UE has not refreshed the corresponding Discovery Request within
the duration of the validity timer), then the ProSe Function removes the entry
related to that ProSe Application Code from the UE context.
#### 5.3.3.3A Announce Request (roaming/inter-PLMN transmission) - restricted
discovery
Figure 5.3.3.3A-1: Announce Request procedure for restricted discovery
(roaming)
The UE is only allowed to announce in the carrier frequency signalled from
serving PLMN. When inter-PLMN discovery transmission is supported, the carrier
frequency may be operated by Local PLMN.
0\. The user sets the permission for the restricted discovery using
application layer mechanisms. In addition, the application client in the UE
retrieves the PDUID and provides it to the ProSe Application Server. The ProSe
Application Server allocates a RPAUID for that PDUID, stores the binding
between the PDUID and the RPAUID and returns the RPAUID to the application
client in the UE. The UE may optionally provide metadata to be associated with
the RPAUID, and the ProSe Application Server stores the metadata. The
application client in the UE stores the binding between the PDUID and its own
RPAUID. If the application client in the UE intends to use the ProSe service,
it triggers the UE to perform the announce procedure, providing its own RPAUID
obtained by the ProSe Application Server.
NOTE 1: The procedures in step 0 are out of scope of 3GPP. However, it is
expected that the application client in the UE will be able to retrieve the
PDUID from the underlying ProSe Protocol layer.
1\. If the UE is authorized to announce in the PLMN operating the carrier
frequency signalled by the serving PLMN, or if UE intends to make announcement
using WLAN-based PC5 and is triggered by the application client to announce,
it shall establish a secure connection with the ProSe Function in HPLMN and
send a Discovery Request message (RPAUID, UE Identity, command=announce,
Discovery Type, Application ID, Discovery Entry ID, Requested Discovery Timer,
Application Level Container, Announcing Type, [Announcing PLMN ID],
[PC5_tech]) for announcing. The RPAUID indicating what the UE is interested to
announce was obtained in step 0. The UE Identity is set to IMSI. The
Application ID represents a unique identifier of the UE application that has
triggered the transmission of the Discovery Request message. The Discovery
Type is set to \"restricted discovery\". The Discovery Entry ID indicates
whether this is a new request. The Requested Discovery Timer is an optional
parameter and indicates the length of validity timer associated with the ProSe
Restricted Code that the UE expects to receive from the ProSe Function in step
6. When the Requested Discovery Timer is set to zero, the ProSe Function shall
remove the discovery entry indicated by the Discovery Entry ID, and release
the associated resources. PC5_tech is an optional parameter that indicates the
PC5 radio technology (e.g. E-UTRA, WLAN) that UE wishes to use for
announcements. PC5_tech may include more than one PC5 radio technology. When
this parameter is omitted the intended PC5 radio technology is E-UTRA.
If the Requested Discovery Timer is included in step 1 and the value is set to
zero, step 2 to step 3 are skipped.
If restricted Direct Discovery with application-controlled extension is used,
the Discovery Request message also includes the Application Level Container.
The Application Level Container contains the request and any relevant
information (e.g. intent to use metadata indication in the suffix) for the
ProSe Application Server to assign a (set of) ProSe Restricted Code
Suffix(es). The Discovery Type is set to \"restricted discovery with
application-controlled extension\".
Announcing type can be set to \"on demand\" to indicate the \"on demand\"
announcing is requested by UE for the indicated application.
If inter-PLMN ProSe discovery transmission is supported, and the serving PLMN
signalled carrier frequency is not operated by HPLMN or VPLMN, the UE shall
include the PLMN ID of that carrier frequency in the Announcing PLMN ID.
2\. The ProSe Function checks for the authorization of the application
represented by the Application ID. If there is no associated UE context, the
ProSe Function shall check with HSS the authorisation for discovery and, if
necessary, create a new context for this UE that contains the subscription
parameters for this UE. The HSS provides the MSISDN of the UE. The HSS also
provides the serving PLMN ID of where the UE is registered. When the Discovery
Entry ID in the Discovery Request message does not contain a valid value for
this UE, the ProSe Function creates a new discovery entry in the UE\'s context
for this request, and returns the corresponding identifier in the Discovery
Response message in step 6.
2.a Optionally, the ProSe Function sends an Auth Request (RPAUID, Request
Type) to the ProSe Application Server. The ProSe Function locates the ProSe
Application Server based on the Application ID. The Request Type is set to
\"restricted discovery/announce\".
If restricted Direct Discovery with application-controlled extension is used,
the Auth Request message also includes the Allowed Number of Suffixes. The
Allowed Number of Suffixes indicates how many suffixes the ProSe Application
Server can provide to the UE. The Request Type is set to \"restricted
discovery with application-controlled extension /announce\".
2.b The ProSe Application Server returns an Auth Response (PDUID(s), Response
Type) message. The PDUID(s) corresponds to the RPAUID stored in the ProSe
Application Server. The Response Type is set to \"restricted
discovery/announce ack\".
If restricted Direct Discovery with application-controlled extension is used,
the Auth Response message also includes the ProSe Restricted Code Suffix pool.
The ProSe Restricted Code Suffix pool contains the Suffix(es) allocated by the
ProSe Application based on the inputs in step 2.a. The Response Type is set to
\"restricted discovery with application-controlled extension /announce ack\".
The ProSe Function verifies that at least one of the received PDUID(s) belongs
to the requesting UE.
NOTE 2: Whether steps 2.a and 2.b are executed depends on ProSe Function
configuration, or policy regarding the specific Application Server. For
example, if the ProSe Function can already verify the ownership locally, it
does not have to perform the two steps.
NOTE 3: The length of the ProSe Restricted Code Suffix is chosen by the ProSe
Application Server from a set of allowable lengths (e.g. 8 bits, 24 bits, 48
bits). This choice is per application, so that all UEs announcing ProSe
Restricted Codes assigned for Restricted ProSe Application User IDs from that
Application ID use the same Suffix length (which may be zero if no
application-controlled extension is allowed for this Application).
NOTE 4: The ProSe Restricted Code Suffix pool needs to support the indication
of a large number of or a range of ProSe Restricted Code Suffixes.
3\. The ProSe Function in HPLMN allocates a ProSe Restricted Code and the
associated validity timer. The ProSe Restricted Code corresponds to the RPAUID
that was contained in the Discovery Request from the UE. The validity timer
shall indicate for how long this ProSe Restricted Code is going to be valid.
The UE will be authorised to announce this ProSe Restricted Code for the
duration of validity timer and if it remains in the same PLMN. The ProSe
Function stores the RPAUID, the ProSe Restricted Code and the associated
validity timer in the user context.
If restricted Direct Discovery with application-controlled extension is used,
the ProSe Function in the HPLMN allocates a ProSe Restricted Code Prefix
(rather than a ProSe Restricted Code) based on the Application ID and/or the
Restricted ProSe App User ID.
If restricted ProSe Direct Discovery with \"on demand\" announcing has been
requested, the ProSe Function determines if \"on demand\" announcing is
authorized and enabled based on the Application ID and operator\'s policy. If
\"on demand\" announcing is authorized and enabled, the ProSe Function stores
the RPAUID, the ProSe Restricted Code with the associated validity timer and
the Announcing Enabled indicator in the user context.
NOTE 5: It is up to the policy in the ProSe Function whether to allocate the
same ProSe Restricted Code for a set of several RPAUIDs or different ProSe
Restricted Codes for the different RPAUIDs.
NOTE 6: If \"on demand\" announcing is authorized and enabled in step 3 and
there is no ongoing monitoring request, steps 4 and 5 are not executed.
4\. If the Discovery Request is authorized and verified, the HPLMN ProSe
Function shall inform the ProSe Function in VPLMN or Local PLMN if Announcing
PLMN ID is included in step 1 with the Announce Authorization (RPAUID,
Application ID, validity timer, ProSe Restricted Code, UE Identity, Discovery
Entry ID, [PC5_tech]) message. The RPAUID and Application ID correspond to the
request from the UE, whereas the ProSe Restricted Code indicates the assigned
code for this request. The request shall include the UE identity information
e.g. IMSI or MSISDN and validity timer in order to allow the ProSe Function in
VPLMN or Local PLMN to perform charging. The validity timer indicates for how
long this ProSe Restricted Code is going to be valid. If the ProSe Function in
VPLMN or Local PLMN receives the same Discovery Entry ID in a subsequent
Announce Authorization message, it updates the announcing UE\'s corresponding
discovery entry replacing the existing ProSe Restricted Code and validity
timer with the last received ones. The request may also include the PC5_tech
parameter if it was provided by the UE in step 1. When this parameter is
omitted the intended PC5 radio technology is E-UTRA.
NOTE 7: The information provided in step 4 that is related to charging is used
only when the requested PC5 radio technology includes E-UTRA.
If restricted Direct Discovery with application-controlled extension is used,
the ProSe Restricted Code is replaced by the ProSe Restricted Code Prefix, and
the Announce Authorization message also contains the ProSe Restricted Code
Suffix pool.
If the Requested Discovery Timer is included in step 1 and the value is set to
zero, the ProSe Function in HPLMN shall inform the ProSe Function in VPLMN or
Local PLMN with the validity timer set to zero. The ProSe Function removes the
discovery entry indicated by the Discovery Entry ID, and releases the
associated resources.
5\. The ProSe Function in VPLMN or Local PLMN authorizes the UE to perform
Restricted ProSe Discovery announcing.
6\. The ProSe Function in HPLMN responds to the UE with a Discovery Response
(ProSe Restricted Code, validity timer, Discovery Entry ID, [PC5_tech])
message.
If restricted Direct Discovery with application-controlled extension is used,
the ProSe Restricted Code is replaced by the ProSe Restricted Code Prefix, and
the Discovery Response message also contains the ProSe Restricted Code Suffix
pool.
If the \"on demand\" announcing is authorized and enabled in step 3 and there
is no ongoing monitoring request, the ProSe Function in HPLMN does not provide
a ProSe Restricted Code to the UE and responds to the UE with a Discovery
Response (validity timer, Announcing Enabled indicator, Discovery Entry ID)
message.
If the Requested Discovery Timer is included in step 1 and the value is set to
zero, the validity timer in the Discovery Response message is set to zero.
The optional PC5_tech parameter indicates the PC5 radio technology(ies) that
is/are authorized to be used for the assigned ProSe Restricted Code. When this
parameter is omitted, the authorized PC5 radio technology is E-UTRA.
NOTE 8: The announcing UE may receive the same ProSe Restricted Code as a
result of different Announce Request procedures.
NOTE 9: The UE appends a ProSe Restricted Code Suffix from the ProSe
Restricted Code Suffix pool to the ProSe Restricted Code Prefix to form a
ProSe Restricted Code. When the ProSe Restricted Code Suffix pool contains
multiple suffixes, the UE may use different suffixes from the ProSe Restricted
Code Suffix pool to form different ProSe Restricted Codes to announce, without
having to contact the ProSe Function as long as the ProSe Restricted Code
Prefix is valid.
7\. The UE may start announcing the provided ProSe Restricted Code in the
VPLMN or Local PLMN, using the radio resources authorised and configured by
E-UTRAN to be used for ProSe as defined in RAN specifications or using WLAN,
or both.
If the \"on demand\" announcing is used and ProSe Function does not provide a
ProSe Restricted Code to the UE in step 6, the UE waits for an Announcing
Alert Request message from the ProSe Function in HPLMN before starting to
announce over the air (see clause 5.3.5.2).
NOTE 10: The ProSe Protocol layer in the UE may inform the application client
that it has started announcing. This is out of scope of 3GPP.
If the validity timer associated with a ProSe Restricted Code expires (because
the UE has not refreshed the corresponding Discovery Request within the
duration of the validity timer), then the ProSe Function removes the entry
related to that ProSe Restricted Code from the UE context.
#### 5.3.3.4 Monitor request (non-roaming) - open discovery
Figure 5.3.3.4-1: Monitor request procedure (non-roaming)
0\. The UE is configured with the data structure of the ProSe Application IDs
corresponding to PLMNs the UE is authorised to monitor. This step is performed
using mechanisms that are out of scope of 3GPP.
1\. If the UE is authorised to monitor in at least one PLMN, or if UE intends
to use WLAN-based PC5 for monitoring and is interested to monitor certain
ProSe Application ID(s), it shall establish a secure connection with ProSe
Function in the HPLMN to which it shall then send a Discovery Request (ProSe
Application ID(s), UE Identity, monitor command, Application ID, Discovery
Entry ID, [Requested Timer], [PC5_tech]) message for monitoring. The ProSe
Application ID(s) indicate what the UE is interested to monitor and they
consist a subset of the data structure of the PLMN. The UE Identity is set to
e.g. IMSI. The Application ID represents a unique identifier of the
application that has triggered the transmission of the Discovery Request
message. The Discovery Entry ID indicates whether this is a new request. The
Requested Timer is an optional parameter. When the Requested Timer is set to
zero, procedures in clause 5.3.6A.1.3 shall be followed. PC5_tech is an
optional parameter that indicates the PC5 radio technology (e.g. E-UTRA, WLAN)
that UE wishes to use for monitoring. PC5_tech may include more than one PC5
radio technology. When this parameter is omitted the intended PC5 radio
technology is E-UTRA. This request is always sent to the ProSe Function in
HPLMN.
If application-controlled extension is used, the Application Level Container
is included; it contains information corresponding to the ProSe Application
Code Suffix.
2\. The ProSe Function checks for the authorization of the application
represented by the Application ID. If there is no associated UE context, the
ProSe Function shall check with HSS the authorisation for discovery and create
a new context for this UE that contains the subscription parameters for this
UE. The HSS provides the MSISDN of the UE. The authorisation information also
contains the PLMNs that this UE is allowed to perform discovery. When the
Discovery Entry ID in the Discovery Request message does not contain a valid
value for this UE, the ProSe Function will create a new discovery entry in the
UE\'s context for this request, and will return the corresponding identifier
in the Discovery Response message in step 5.
2a. If the UE indicated that it desires application-controlled extension by
the inclusion of the Application Level Container, the ProSe Function sends an
Auth Request (ProSe Application ID, Request Type, Application Level Container)
to the Application Server indicated by the Application ID. The Request Type is
set to \"open discovery with application controlled extension/monitor\".
2b. The ProSe Application Server returns an Auth Response (Response Type,
mask(s) for the ProSe Application Code Suffix(es) corresponding to ProSe
Application ID). The Response Type is set to \"open discovery with
application-controlled extension /monitor ack\".
If the Discovery Request is authorised, and the ProSe Application ID sent by
the UE in step 1 indicates another Local PLMN then steps 3-6 are executed,
otherwise (i.e. the ProSe Application ID indicates HPLMN) only steps 5-6 are
executed:
3\. When the ProSe Application ID has PLMN-specific scope then the ProSe
Function in HPLMN shall contact if needed) other PLMNs that are indicated by
the ProSe Application ID(s) sent by the UE, in order to resolve the
corresponding ProSe Application ID Name(s) to ProSe Application Code(s) and/or
a ProSe Application Mask. The request shall also include the UE identity
information e.g. IMSI or MSISDN in order to allow the ProSe Function in Local
PLMN to perform charging and the Discovery Entry ID. If the ProSe Function in
other PLMN receives the same Discovery Entry ID in a subsequent Monitor
Request message, it updates the monitoring UE\'s corresponding discovery entry
with the received corresponding parameters. The request may also include the
PC5_tech parameter if it was provided by the UE in step 1. When this parameter
is omitted the intended PC5 radio technology is E-UTRA.
NOTE 1: The information provided in step 3 that is related to charging is used
only when the requested PC5 radio technology includes E-UTRA.
4\. If the ProSe Function of the Local PLMN stores valid ProSe Application
Code(s) corresponding to the requested ProSe Application ID Name(s) and the
requested PC5 radio technology (as indicated in step 3), then the ProSe
Function of the Local PLMN returns the related ProSe Application Code(s)
and/or ProSe Application Mask(s) and the corresponding TTL for each.
The optional PC5_tech parameter indicates the PC5 radio technology that may be
used for monitoring. When the parameter is omitted the intended PC5 radio
technology is E-UTRA.
If application-controlled extension is used, the ProSe Application Code is
replaced by the ProSe Application Code Prefix.
5\. The ProSe Function in the HPLMN shall respond with a Discovery Response
(Discovery Filter(s), Discovery Entry ID, [PC5_tech]) message. The TTL(s) in
the Discovery Filter(s) indicates for how long the Discovery Filter(s) is
going to be valid.
If application-controlled extension is used, the ProSe Application Code in the
Discovery Filter is replaced by the ProSe Application Code Prefix. Besides the
ProSe Application Code(s), the Discovery Filter may also contain the mask(s)
for the ProSe Application Code Suffix, which is/are obtained in from ProSe
Application Server in step 2b. The UE may add additional mask(s) and values
for the Suffix part.
The optional PC5_tech parameter indicates the PC5 radio technology that may be
used for the Discovery Filter(s). When the parameter is omitted the intended
PC5 radio technology is E-UTRA.
NOTE 2: The UE can randomize the request for assignment of new Discovery
Filter in order to guard against a peak of Discovery Requests when the TTL
expires.
NOTE 3: To allow a change of the announced ProSe Application Code without
interrupting the discovery procedure, two Discovery Filters for the same ProSe
Application ID can be provided to the UE (as the monitoring UE would have
Discovery Filters for both the ProSe Application Code which is currently in
use by the announcing UE as well as the ProSe Application Code which will
replace the current one). Alternatively a ProSe Application Mask, which is
able to match both ProSe Application Codes, can be provided.
NOTE 4: It is up to Stage 3 to specify the behaviour of ProSe Functions in
HPLMN and/or Local PLMN when a valid ProSe Application Code is not available
for the requested ProSe Application ID.
6\. The UE may start monitoring using the Discovery Filter(s) in the radio
resources that are authorized and configured by the PLMN(s) to be used for
ProSe as defined in RAN specifications or using WLAN, or both.
If the TTL corresponding to a Discovery Filter expires (because the UE has not
refreshed the corresponding Discovery Request within the duration of the TTL),
then the ProSe Function removes the entry related to that Discovery Filter
from the UE context.
#### 5.3.3.4A Monitor Request (non-roaming) - restricted discovery
Figure 5.3.3.4A-1: Monitor Request procedure for restricted discovery (non-
roaming)
0\. In this step, the application client in the UE retrieves its own PDUID and
provides it to the ProSe Application Server. The ProSe Application Server
allocates a Restricted ProSe Application User ID (RPAUID) for that PDUID,
stores the binding between the PDUID and the RPAUID and returns the RPAUID to
the application client in the UE. The application client in the UE stores the
binding between the PDUID and its own RPAUID.
When the application client in the UE intends to discover the announcing UE of
other users (e.g. friends in the application), it obtains the RPAUID of those
users (Target RPAUID(s)) from the ProSe App Server and triggers the UE to
perform the monitor procedure, providing its own RPAUID and the Target
RPAUIDs. The Target RPAUIDs of the UEs to be monitored are passed in an
Application Level Container.
NOTE 1: The procedures in step 0 are out of scope of 3GPP. However, it is
expected that the application client in the UE will be able to retrieve the
PDUID from the underlying ProSe Protocol layer.
1\. If the UE is authorised to monitor in at least one PLMN, or if UE intends
to use WLAN-based PC5 for monitoring and is triggered by the application
client to monitor, it shall establish a secure connection with the ProSe
Function in HPLMN and it shall send a Discovery Request message to get the
Discovery Filter for monitoring (RPAUID, UE Identity, command=monitor,
Discovery Type, Application ID, Application Level Container, Discovery Entry
ID, Requested Discovery Timer, [PC5_tech]). The Application Level Container
contains the Target RPAUIDs indicating what the UE is interested to monitor.
The RPAUID indicates the identity the UE uses to obtain the permission to
monitor. The UE Identity is set to IMSI. The Application ID represents a
unique identifier of the application that has triggered the transmission of
the Discovery Request message. Discovery Type is set to \"restricted
discovery\". The Discovery Entry ID indicates whether this is a new request.
The Requested Discovery Timer is an optional parameter. When the Requested
Discovery Timer is set to zero, the ProSe Function shall delete the Discovery
Filter(s) indicated by the Discovery Entry ID, and release the associated
resources.
If restricted Direct Discovery with application-controlled extension is used,
the Application Level Container may also include some information
corresponding to the ProSe Restricted Code Suffix, e.g. group or user-specific
information. The Discovery Type is set to \"restricted discovery with
application-controlled extension\".
PC5_tech is an optional parameter that indicates the PC5 radio technology
(e.g. E-UTRA, WLAN) that UE wishes to use for monitoring. PC5_tech may include
more than one PC5 radio technology. When this parameter is omitted the
intended PC5 radio technology is E-UTRA.
If the Requested Discovery Timer is included in step 1 and the value is set to
zero, step 2 to step 9 are skipped.
2\. The ProSe Function checks for the authorization of the application
represented by the Application ID. If there is no associated UE context, the
ProSe Function shall check with HSS the authorisation for discovery and, if
necessary, create a new context for this UE that contains the subscription
parameters for this UE. The HSS provides also the PLMN ID where the UE is
registered. The HSS provides the MSISDN of the UE. When the Discovery Entry ID
in the Discovery Request message does not contain a valid value for this UE,
the ProSe Function creates a new discovery entry in the UE\'s context for this
request, and returns the corresponding identifier in the Discovery Response
message in step 10.
3\. The ProSe Function sends an Auth Request (RPAUID, Request Type,
Application Level Container) to the Application Server indicated by the
Application ID. The Request Type is set to \"restricted discovery/monitor\".
If restricted Direct Discovery with application-controlled extension is used,
the Request Type is set to \"restricted discovery with application-controlled
extension\".
4\. If, based on the permission setting, the RPAUID is allowed to discover at
least one of the Target RPAUID(s) contained in the Application Level
Container, the ProSe Application Server returns an Auth Response (PDUID,
Response Type, N sets of Target PDUID - Target RPAUID - Metadata Indicator,
Application Level Container). The Response Type is set to \"restricted
discovery/monitor ack\". Each Target PDUID is returned with the corresponding
Target RPAUID(s) that the RPAUID is allowed to discover. The ProSe Function
verifies that the returned PDUID belongs to the requesting UE. The Application
Level Container includes the successful authenticated Target RPAUID(s).
The Metadata Indicator is optional and signals whether there is metadata
associated with the RPAUID, and if so, whether update to the metadata is
allowed.
NOTE 2: If metadata update is allowed, the ProSe Function needs to contact the
ProSe Application Server in every Match Report procedure if the UE desires the
latest metadata.
If restricted Direct Discovery with application-controlled extension is used,
the Response Type is set to \"Restricted discovery with application-controlled
extension /monitor ack\". The Auth Response may also include the mask(s) for
the ProSe Restricted Code Suffix(es) corresponding to each of the Target
Restricted ProSe App User ID(s).
Step 5 is executed only when the PLMN ID in the Target ProSe Disc UE ID
indicates the HPLMN.
5\. If the PLMN ID in the Target PDUID indicates the HPLMN and at least one of
received pair of Target PDUID - Target RPAUID corresponds to a valid ProSe
Restricted Code including a valid PC5 radio technology match as indicated via
the PC5_tech parameter in step 1, the ProSe Function in the HPLMN retrieves
the ProSe Restricted Code corresponding to that Target PDUID, Application ID
and Target RPAUID. The Prose Function in the HPLMN stores, in the context of
the announcing UE, the PDUID of the monitoring UE.
If restricted Direct Discovery with application-controlled extension is used,
the ProSe Restricted Code is replaced by the ProSe Restricted Code Prefix.
If the Announcing Enabled indicator is stored in the UE context, the ProSe
Function of HPLMN shall trigger the Announcing Alert procedure (see clause
5.3.5) to notify the announcing UE to perform announcing.
Steps 6-9 are executed only when the PLMN ID in the Target ProSe Disc UE ID
indicates a different PLMN.
6\. If the PLMN ID in the Target PDUID indicates a PLMN different from the
HPLMN, the ProSe Function in the HPLMN contacts the ProSe Function in that
PLMN to retrieve the corresponding ProSe Restricted Code with a Monitor
Request (RPAUID, UE Identity, Target PDUID, Application ID, Target RPAUID,
Discovery Entry ID, [PC5_tech]) message. The request shall include the UE
identity information e.g. IMSI or MSISDN in order to allow the ProSe Function
in that PLMN to perform charging. If the ProSe Function in other PLMN receives
the same Discovery Entry ID in a subsequent Monitor Request message, it
updates the monitoring UE\'s corresponding discovery entry with the received
corresponding parameters. The request may also include the PC5_tech parameter
if it was provided by the UE in step 1. When this parameter is omitted the
intended PC5 radio technology is E-UTRA.
NOTE 3: The information provided in step 6 that is related to charging is used
only when the requested PC5 radio technology includes E-UTRA.
7\. If the pair of Target PDUID - Target RPAUID received from the HPLMN ProSe
Function corresponds to a valid ProSe Restricted Code including a valid PC5
radio technology match as indicated via the PC5_tech parameter in step 6, the
ProSe Function in the other PLMN retrieves the ProSe Restricted Code
corresponding to that Target PDUID, Application ID and Target RPAUID.
If restricted Direct Discovery with application-controlled extension is used,
the ProSe Restricted Code is replaced by the ProSe Restricted Code Prefix.
If the Announcing Enabled indicator is stored in the UE context at the ProSe
Function in the other PLMN (announcing UE\'s HPLMN), then the ProSe Function
in the other PLMN shall trigger the Announcing Alert procedure (see clause
5.3.5) to notify the announcing UE to perform announcing.
8.a Optionally, the ProSe Function in the other PLMN sends an Auth Request
(RPAUID , Request Type, Target RPAUID) to the Application Server indicated by
the Application ID. The Request Type is set to \"restricted
discovery/permission\".
8.b If, based on the permission setting, the RPAUID is allowed to discover the
Target RPAUID, the ProSe Application Server acknowledges the Auth Request with
an Auth Response (Target PDUID, Response Type). The Response Type is set to
\"restricted discovery/permission ack\". The ProSe Function in the other PLMN
verifies that the returned Target PDUID corresponds to the UE to be monitored.
NOTE 4: Whether steps 8.a and 8.b are executed depends on ProSe Function
configuration, or policy regarding the specific Application Server. For
example, if the ProSe Function can verify the permission locally, or the HPLMN
is trusted by the other PLMNs for permission control, these steps are not
needed.
If restricted Direct Discovery with application-controlled extension is used,
the ProSe Restricted Code is replaced by the ProSe Restricted Code Prefix.
9\. The ProSe Function in the other PLMN returns to the ProSe Function in the
HPLMN the ProSe Restricted Code and the corresponding residual validity timer
with a Monitor Response (ProSe Restricted Code, validity timer, [PC5_tech])
message. The Prose Function in the other PLMN also stores, in the context of
the announcing UE, the PDUID of the monitoring UE.
The optional PC5_tech parameter indicates the PC5 radio technology that may be
used for monitoring. When the parameter is omitted the intended PC5 radio
technology is E-UTRA.
10\. For each pair of Target PDUID - Target RPAUID returned by the application
server in step 4, if the ProSe Function in the HPLMN has retrieved a valid
ProSe Restricted Code, it builds the binding between ProSe Restricted Code
with validity timer, Application ID, Target RPAUID, Metadata Indicator and
Target PDUID and stores it into the discovery entry in the user context of the
monitoring UE. Based on the ProSe Restricted Code and the associated validity
timer the ProSe Function in the HPLMN allocates a Discovery Filter with the
corresponding TTL.
The ProSe Function in the HPLMN returns a Discovery Response (Discovery
Filter(s), Metadata Indicator, Discovery Entry ID, Application Level
Container, [PC5_tech]) message to the UE. The Discovery Filter includes the
ProSe Restricted Code to be monitored and the TTL that indicates for how long
the related ProSe Restricted Code in the Discovery Filter is valid after it is
received. If configured by the operator, the Target RPAUID(s) and metadata
corresponding to the ProSe Restricted Code(s) may be included in the Discovery
Response message. The ProSe Function stores in the user context all the
parameters passed to the UE.
If restricted Direct Discovery with application-controlled extension is used,
the ProSe Restricted Code is replaced by the ProSe Restricted Code Prefix.
Besides the ProSe Restricted Code(s), the Discovery Filter may also contain
the mask(s) for the ProSe Restricted Code Suffix, which is/are obtained in
from ProSe Application Server in step 4. The UE may add additional mask(s) and
values for the Suffix part.
If the Requested Discovery Timer is included in step 1 and the value is set to
zero, the TTL in the Discovery Response message is set to zero.
The optional PC5_tech parameter indicates the PC5 radio technology that may be
used for the Discovery Filter(s). When the parameter is omitted the intended
PC5 radio technology is E-UTRA.
NOTE 5: When the Target RPAUID, corresponding to the ProSe Restricted Code in
the Discovery Filter, is included in the Discovery Response message, then the
Match Report procedure may be skipped.
NOTE 6: The ProSe Restricted Code in different Discovery Filters may be the
same, for example, when the monitoring user is a friend of the announcing user
in more than one application, for which the announcing user was allocated the
same ProSe Restricted Code.
11\. The UE obtains the corresponding radio resources that are authorized and
configured by the PLMN(s) to be used for ProSe as defined in RAN
specifications or uses WLAN, or both and starts to monitor using the Discovery
Filter. The UE provides the Application Level Container, which contains the
successful authenticated Target RPAUID(s), to the application client.
NOTE 7: The ProSe Protocol layer in the UE may inform the application client
that it has started monitoring.
If the TTL corresponding to a Discovery Filter expires (because the UE has not
refreshed the corresponding Discovery Request within the duration of the TTL),
then the ProSe Function removes the entry related to that Discovery Filter
from the UE context.
#### 5.3.3.5 Monitor request (roaming) - open discovery
Figure 5.3.3.5-1: Monitor request procedure (roaming)
0\. The UE is configured with the data structure of the ProSe Application IDs
corresponding to PLMNs the UE is authorised to monitor. This step is performed
using mechanisms out of scope of 3GPP.
1\. If the UE is authorised to monitor in at least one PLMN, or if UE intends
to use WLAN-based PC5 for monitoring and is interested to monitor certain
ProSe Application ID(s), it shall establish a secure connection with the ProSe
Function in HPLMN and it shall send a Discovery Request (ProSe Application
ID(s), UE Identity, monitor command, Application ID, Discovery Entry ID,
[Requested Timer], [PC5_tech]) message for monitoring. The ProSe Application
ID(s) indicate what the UE is interested to monitor and they consist of a
subset of the data structure of the PLMN. The UE Identity is set to e.g. IMSI.
The Application ID represents a unique identifier of the application that has
triggered the transmission of the Discovery Request message. The Discovery
Entry ID indicates whether this is a new request. The Requested Timer is an
optional parameter. When the Requested Timer is set to zero, procedures in
clause 5.3.6A.1.3 shall be followed. PC5_tech is an optional parameter that
indicates the PC5 radio technology (e.g. E-UTRA, WLAN) that UE wishes to use
for monitoring. PC5_tech may include more than one PC5 radio technology. When
this parameter is omitted the intended PC5 radio technology is E-UTRA. This
request is always sent to the ProSe Function in HPLMN.
If application-controlled extension is used, the Application Level Container
is included; it contains information corresponding to the ProSe Application
Code Suffix.
2\. The ProSe Function checks for the authorization of the application
represented by the Application ID. If there is no associated UE context, the
ProSe Function shall check with HSS the authorisation for discovery and, if
necessary, create a new context for this UE that contains the subscription
parameters for this UE. The authorisation information also contains the PLMNs
that this UE is allowed to perform discovery. The HSS provides also the VPLMN
ID where the UE is registered. The HSS provides the MSISDN of the UE. When the
Discovery Entry ID in the Discovery Request message does not contain a valid
value for this UE, the ProSe Function will create a new discovery entry in the
UE\'s context for this request, and will return the corresponding identifier
in the Discovery Response message in step 5.
2a. If the UE indicated that it desires application-controlled extension by
the inclusion of the Application Level Container, the ProSe Function sends an
Auth Request (ProSe Application ID, Request Type, Application Level Container)
to the Application Server indicated by the Application ID. The Request Type is
set to \"open discovery with application controlled extension/monitor\".
2b. The ProSe Application Server returns an Auth Response (Response Type,
mask(s) for the ProSe Application Code Suffix(es) corresponding to ProSe
Application ID). The Response Type is set to \"open discovery with
application-controlled extension /monitor ack\".
If the Discovery Request is authorised, and the ProSe Application ID sent by
the UE in step 1 indicates another PLMN and not the HPLMN, then steps 3-6 are
executed, otherwise (i.e. the ProSe Application ID indicates HPLMN) only steps
5-6 are executed:
3\. When the ProSe Application ID has PLMN-specific scope then the ProSe
Function in HPLMN shall contact (if needed) other PLMNs that are indicated by
the ProSe Application ID(s) sent by the UE, in order to resolve the
corresponding ProSe Application ID Name(s) to ProSe Application Code(s) and/or
a ProSe Application Mask. The request shall also include the UE identity
information e.g. IMSI or MSISDN, in order to allow the ProSe Function in
Local/Visited PLMN to perform charging and the Discovery Entry ID. If the
ProSe Function in other PLMN receives the same Discovery Entry ID in a
subsequent Monitor Request message, it updates the monitoring UE\'s
corresponding discovery entry with the received corresponding parameters. The
request may also include the PC5_tech parameter if it was provided by the UE
in step 1. When this parameter is omitted the intended PC5 radio technology is
E-UTRA.
NOTE 1: The information provided in step 3 that is related to charging is used
only when the requested PC5 radio technology includes E-UTRA.
4\. If the ProSe Function of the other PLMN stores valid ProSe Application
Code(s) corresponding to the requested ProSe Application ID Name(s) and the
requested PC5 radio technology (as indicated in step 3), then the ProSe
Function of the VPLMN/Local PLMN returns the related ProSe Application Code(s)
and/or ProSe Application Mask(s) and the corresponding TTL for each. Based on
the UE context in the ProSe Function of the VPLMN/Local PLMN, it also includes
the PLMN ID of the PLMN that the \"announcing UE\" is registered (if roaming)
for the ProSe Function in HPLMN of the monitoring UE to store in the
associated UE context.
The optional PC5_tech parameter indicates the PC5 radio technology that may be
used for monitoring. When the parameter is omitted the intended PC5 radio
technology is E-UTRA.
If application-controlled extension is used, the ProSe Application Code is
replaced by the ProSe Application Code Prefix.
5\. The ProSe Function in the HPLMN responds with a Discovery Response
(Discovery Filter(s), Discovery Entry ID, [PC5_tech]) message. The TTL(s) in
the Discovery Filter(s) indicate for how long the Discovery Filter(s) are
going to be valid.
The optional PC5_tech parameter indicates the PC5 radio technology that may be
used for the Discovery Filter(s). When the parameter is omitted the intended
PC5 radio technology is E-UTRA.
If application-controlled extension is used, the ProSe Application Code in the
Discovery Filter is replaced by the ProSe Application Code Prefix. Besides the
ProSe Application Code(s), the Discovery Filter may also contain the mask(s)
for the ProSe Application Code Suffix, which is/are obtained in from ProSe
Application Server in step 2b. The UE may add additional mask(s) and values
for the Suffix part.
NOTE 2: The UE can randomize the request for assignment of new Discovery
Filter in order to guard against a peak of Discovery Requests when the TTL
expires.
NOTE 3: To allow a change of the announced ProSe Application Code without
interrupting the discovery procedure, two Discovery Filters for the same ProSe
Application ID can be provided to the UE (as the monitoring UE would have
Discovery Filters for both the ProSe Application Code which is currently in
use by the announcing UE as well as the ProSe Application Code which will
replace the current one). Alternatively a ProSe Application Mask, which is
able to match both ProSe Application Codes, can be provided.
NOTE 4: It is up to Stage 3 to specify the behaviour of ProSe Functions in
HPLMN and/or Local PLMN when a valid ProSe Application Code is not available
for the requested ProSe Application ID.
6\. The UE may start monitoring using the Discovery Filter(s) in the radio
resources that are authorized and configured by the PLMN(s) to be used for
ProSe as defined in RAN specifications or using WLAN, or both.
If the TTL corresponding to a Discovery Filter expires (because the UE has not
refreshed the corresponding Discovery Request within the duration of the TTL),
then the ProSe Function removes the entry related to that Discovery Filter
from the UE context.
#### 5.3.3.5A Monitor Request (roaming) - restricted discovery
Figure 5.3.3.5A-1: Monitor Request procedure for restricted discovery
(roaming)
0\. In this step, the application client in the UE retrieves its own PDUID and
provides it to the ProSe Application Server. The ProSe Application Server
allocates a Restricted ProSe Application User ID (RPAUID) for that PDUID,
stores the binding between the PDUID and the RPAUID and returns the RPAUID to
the application client in the UE. The application client in the UE stores the
binding between the PDUID and its own RPAUID.
When the application client in the UE intends to discover the announcing UE of
other users (e.g. friends in the application), it obtains the RPAUID of those
users (Target RPAUIDs) from the ProSe App Server and triggers the UE to
perform the monitor procedure, providing its own RPAUID and the Target
RPAUIDs. The Target RPAUIDs of the UEs to be monitored are passed in an
Application Level Container.
NOTE 1: The procedures in step 0 are out of scope of 3GPP. However, it is
expected that the application client in the UE will be able to retrieve the
PDUID from the underlying ProSe Protocol layer.
1\. If the UE is authorised to monitor in at least one PLMN, or if UE intends
to use WLAN-based PC5 for monitoring and is triggered by the application
client to monitor, it shall establish a secure connection with the ProSe
Function in HPLMN and it shall send a Discovery Request message to get the
Discovery Filter for monitoring (RPAUID, UE Identity, command=monitor,
Discovery Type, Application ID, Application Level Container, Discovery Entry
ID, Requested Discovery Timer, [PC5_tech]). The Application Level Container
contains the Target RPAUIDs indicating what the UE is interested to monitor.
The RPAUID indicates the identity the UE uses to obtain the permission to
monitor. The UE Identity is set to IMSI. The Application ID represents a
unique identifier of the application that has triggered the transmission of
the Discovery Request message. Discovery Type is set to \"restricted
discovery\". The Discovery Entry ID indicates whether this is a new request.
The Requested Discovery Timer is an optional parameter. When the Requested
Discovery Timer is set to zero, the ProSe Function shall delete the Discovery
Filter(s) indicated by the Discovery Entry ID, and release the associated
resources.
If restricted Direct Discovery with application-controlled extension is used,
the Application Level Container may also include some information
corresponding to the ProSe Restricted Code Suffix, e.g. group or user-specific
information. The Discovery Type is set to \"restricted discovery with
application-controlled extension\".
PC5_tech is an optional parameter that indicates the PC5 radio technology
(e.g. E-UTRA, WLAN) that UE wishes to use for monitoring. PC5_tech may include
more than one PC5 radio technology. When this parameter is omitted the
intended PC5 radio technology is E-UTRA.
If the Requested Discovery Timer is included in step 1 and the value is set to
zero, step 2 to step 9 are skipped.
2\. The ProSe Function checks for the authorization of the application
represented by the Application ID. If there is no associated UE context, the
ProSe Function shall check with HSS the authorisation for discovery and, if
necessary, create a new context for this UE that contains the subscription
parameters for this UE. The HSS provides also the PLMN ID where the UE is
registered. The HSS provides the MSISDN of the UE. When the Discovery Entry ID
in the Discovery Request message does not contain a valid value for this UE,
the ProSe Function creates a new discovery entry in the UE\'s context for this
request, and returns the corresponding identifier in the Discovery Response
message in step 10.
3\. The ProSe Function sends an Auth Request (RPAUID, Request Type,
Application Level Container) to the Application Server indicated by the
Application ID. The Request Type is set to \"restricted discovery/monitor\".
If restricted Direct Discovery with application-controlled extension is used,
the Request Type is set to \"restricted discovery with application-controlled
extension\".
4\. If, based on the permission setting, the RPAUID is allowed to discover at
least one of the Target RPAUID(s) contained in the Application Level
Container, the ProSe Application Server returns an Auth Response (PDUID,
Response Type, N sets of Target PDUID - Target RPAUID - Metadata Indicator,
Application Level Container). The Response Type is set to \"restricted
discovery/monitor ack\". Each Target PDUID is returned with the corresponding
Target RPAUID(s) that the RPAUID is allowed to discover. The ProSe Function
verifies that the returned PDUID belongs to the requesting UE. The Application
Level Container includes the successful authenticated Target RPAUID(s).
The Metadata Indicator is optional and signals whether there is metadata
associated with the RPAUID, and if so, whether update to the metadata is
allowed.
NOTE 2: If metadata update is allowed, the ProSe Function needs to contact the
ProSe Application Server in every Match Report procedure if the UE desires the
latest metadata.
If restricted Direct Discovery with application-controlled extension is used,
the Response Type is set to \"Restricted discovery with application-controlled
extension /monitor ack\". The Auth Response may also include the mask(s) for
the ProSe Restricted Code Suffix(es) corresponding to each of the Target
Restricted ProSe App User ID(s).
Step 5 is executed only when the PLMN ID in the Target ProSe Disc UE ID
indicates the HPLMN.
5\. If the PLMN ID in the Target PDUID indicates the HPLMN and at least one of
received pair of Target PDUID - Target RPAUID corresponds to a valid ProSe
Restricted Code including a valid PC5 radio technology match as indicated via
the PC5_tech parameter in step 1, the ProSe Function in the HPLMN retrieves
the ProSe Restricted Code corresponding to that Target PDUID, Application ID
and Target RPAUID. The Prose Function in the HPLMN stores, in the context of
the announcing UE, the PDUID of the monitoring UE and the allocated validity
timer.
If restricted Direct Discovery with application-controlled extension is used,
the ProSe Restricted Code is replaced by the ProSe Restricted Code Prefix.
If the Announcing Enabled indicator is stored in the UE context, the ProSe
Function of HPLMN shall trigger the Announcing Alert procedure (see clause
5.3.5) to notify the announcing UE to perform announcing.
Steps 6-9 are executed only when the PLMN ID in the Target ProSe Disc UE ID
indicates a different PLMN.
6\. If the PLMN ID in the Target ProSe Disc UE ID indicates a PLMN different
from the HPLMN, the ProSe Function in the HPLMN contacts the ProSe Function in
that PLMN to retrieve the corresponding ProSe Restricted Code with a Monitor
Request (RPAUID, UE Identity, Target PDUID, Application ID, Target RPAUID,
Discovery Entry ID, [PC5_tech]) message. The request shall include the UE
identity information e.g. IMSI or MSISDN in order to allow the ProSe Function
in that PLMN to perform charging. If the ProSe Function in other PLMN receives
the same Discovery Entry ID in a subsequent Monitor Request message, it
updates the monitoring UE\'s corresponding discovery entry with the received
corresponding parameters. The request may also include the PC5_tech parameter
if it was provided by the UE in step 1. When this parameter is omitted the
intended PC5 radio technology is E-UTRA.
NOTE 3: The information provided in step 3 that is related to charging is used
only when the requested PC5 radio technology includes E-UTRA.
7\. If the pair of Target PDUID - Target RPAUID received from the HPLMN ProSe
Function corresponds to a valid ProSe Restricted Code including a valid PC5
radio technology match as indicated via the PC5_tech parameter in step 6, the
ProSe Function in the other PLMN retrieves the ProSe Restricted Code
corresponding to that Target PDUID, Application ID and Target RPAUID.
If restricted Direct Discovery with application-controlled extension is used,
the ProSe Restricted Code is replaced by the ProSe Restricted Code Prefix.
If the Announcing Enabled indicator is stored in the UE context, the ProSe
Function of HPLMN shall trigger the Announcing Alert procedure (see clause
5.3.5) to notify the announcing UE to perform announcing.
8.a Optionally, the ProSe Function in the other PLMN sends an Auth Request
(RPAUID , Request Type, Target RPAUID) to the Application Server indicated by
the Application ID. The Request Type is set to \"restricted
discovery/permission\".
8.b If, based on the permission setting, the RPAUID is allowed to discover the
Target RPAUID, the ProSe Application Server acknowledges the Auth Request with
an Auth Response (Target PDUID, Response Type). The Response Type is set to
\"restricted discovery/permission ack\". The ProSe Function in the other PLMN
verifies that the returned Target PDUID corresponds to the UE to be monitored.
If the Requested Discovery Timer is included in step 1 and the value is set to
zero, the TTL in the Discovery Response message is set to zero.
NOTE 4: Whether steps 8.a and 8.b are executed depends on ProSe Function
configuration, or policy regarding the specific Application Server. For
example, if the ProSe Function can verify the permission locally, or the HPLMN
is trusted by the other PLMNs for permission control, these steps are not
needed.
9\. The ProSe Function in the other PLMN returns to the ProSe Function in the
HPLMN the ProSe Restricted Code and the corresponding residual validity timer
with a Monitor Response (ProSe Restricted Code, validity timer) message. The
Prose Function in the other PLMN also stores, in the context of the announcing
UE, the PDUID of the monitoring UE and the allocated validity timer. The
response may also include the PC5_tech parameter if it was provided by the
HPLMN ProSe Function in step 7. When this parameter is omitted the intended
PC5 radio technology is E-UTRA.
10\. For each pair of Target PDUID - Target RPAUID returned by the application
server in step 4, if the ProSe Function in the HPLMN has retrieved a valid
ProSe Restricted Code, it builds the binding between ProSe Restricted Code
with validity timer, Application ID, Target RPAUID, Metadata Indicator and
Target PDUID and stores it into the discovery entry in the user context of the
monitoring UE. Based on the ProSe Restricted Code and the associated validity
timer the ProSe Function in the HPLMN allocates a Discovery Filter with the
corresponding TTL.
The ProSe Function in the HPLMN returns a Discovery Response (Discovery
Filter(s), Metadata Indicator, Discovery Entry ID, Application Level
Container, [PC5_tech]) message to the UE. The Discovery Filter includes the
ProSe Restricted Code to be monitored and the TTL that indicates for how long
the related ProSe Restricted Code in the Discovery Filter is valid after it is
received. If configured by the operator, the Target RPAUID(s) and metadata
corresponding to the ProSe Restricted Code(s) may be included in the Discovery
Response message. The ProSe Function stores in the user context all the
parameters passed to the UE.
If restricted Direct Discovery with application-controlled extension is used,
the ProSe Restricted Code is replaced by the ProSe Restricted Code Prefix.
Besides the ProSe Restricted Code(s), the Discovery Filter may also contain
the mask(s) for the ProSe Restricted Code Suffix, which is/are obtained in
from ProSe Application Server in step 4. The UE may add additional mask(s) and
values for the Suffix part.
The optional PC5_tech parameter indicates the PC5 radio technology that may be
used for the Discovery Filter(s). When the parameter is omitted the intended
PC5 radio technology is E-UTRA.
NOTE 5: When the Target RPAUID, corresponding to the ProSe Restricted Code in
the Discovery Filter, is included in the Discovery Response message, then the
Match Report procedure may be skipped.
NOTE 6: The ProSe Restricted Code in different Discovery Filters may be the
same, for example, when the monitoring user is a friend of the announcing user
in more than one application, for which the announcing user was allocated the
same ProSe Restricted Code.
11\. The UE obtains the corresponding radio resources that are authorized and
configured by the PLMN(s) to be used for ProSe as defined in RAN
specifications or uses WLAN, or both and starts to monitor using the Discovery
Filter. The UE provides the Application Level Container, which contains the
successful authenticated Target RPAUID(s), to the application client.
NOTE 7: The ProSe Protocol layer in the UE may inform the application client
that it has started monitoring.
If the TTL corresponding to a Discovery Filter expires (because the UE has not
refreshed the corresponding Discovery Request within the duration of the TTL),
then the ProSe Function removes the entry related to that Discovery Filter
from the UE context.
### 5.3.3A Discovery Request - Model B procedures
#### 5.3.3A.1 General
The Discovery Request is sent by the Discoveree UE or the Discoverer UE in
order to be authorised to access the discovery resources and perform
restricted ProSe Direct Discovery, Model B.
#### 5.3.3A.2 Discoveree Request (non-roaming) - restricted discovery
Figure 5.3.3A.2A-1: Discoveree UE procedures for Model B restricted discovery
(non-roaming)
0\. The user sets the permission for the restricted discovery using
application layer mechanisms. In addition, the application client in the UE
retrieves its own PDUID and provides it to the ProSe Application Server. The
ProSe Application Server allocates a Restricted ProSe Application User ID
(RPAUID) for that PDUID, stores the binding between the PDUID and the RPAUID
and returns the RPAUID to the application client in the UE. The UE may
optionally provide metadata to be associated with the RPAUID, and the ProSe
Application Server stores the metadata. The application client in the UE
stores the binding between the PDUID and its own RPAUID. When the application
client in the UE intends to use the ProSe service, it triggers the UE to
perform a Discoveree request procedure providing its own RPAUID obtained from
the ProSe Application Server.
NOTE 1: The procedures in step 0 are out of scope of 3GPP. However, it is
expected that the application client in the UE will be able to retrieve the
PDUID from the underlying ProSe Protocol layer.
1\. If the Discoveree UE is authorised to use Model B discovery in the serving
PLMN, or if UE intends to use Model B discovery using WLAN-based PC5 and is
triggered by the application client to perform a Discoveree Request procedure,
the UE shall establish a secure connection to the ProSe Function in the HPLMN
and send a Discovery Request (RPAUID, UE Identity, command, Discovery Type,
Discovery Model, Application ID, Discovery Entry ID, [PC5_tech]) message. The
RPAUID indicates what the UE is interested to announce. The UE Identity is set
to IMSI. The command indicates that this is for ProSe Response operation, i.e.
for a Discoveree UE. The Discovery Type is set to \"restricted discovery\" and
the Discovery Model indicates \"Model B\". The Application ID represents a
unique identifier of the UE application that has triggered the transmission of
the Discovery Request message. The Discovery Entry ID indicates whether this
is a new request. PC5_tech is an optional parameter that indicates the PC5
radio technology (e.g. E-UTRA, WLAN) that UE wishes to use for Model B
discovery. PC5_tech may include more than one PC5 radio technology. When this
parameter is omitted the intended PC5 radio technology is E-UTRA. This request
is always sent to the ProSe Function in HPLMN.
2\. The ProSe Function checks for the authorization of the application
represented by the Application ID. If there is no associated UE context, the
ProSe Function shall check with HSS the authorisation for discovery and, if
necessary, create a new context for this UE that contains the subscription
parameters for this UE. The HSS provides the MSISDN of the UE. The HSS also
provides the serving PLMN ID of where the UE is registered. When the Discovery
Entry ID in the Discovery Request message does not contain a valid value for
this UE, the ProSe Function creates a new discovery entry in the UE\'s context
for this request, and returns the corresponding identifier in the Discovery
Response message in step 5.
3.a Optionally, the ProSe Function sends an Auth Request (RPAUID, Request
Type) to the ProSe Application Server. The ProSe Function locates the ProSe
Application Server based on the Application ID. The Request Type is set to
\"restricted discovery/response\".
3.b The ProSe Application Server returns an Auth Response (PDUID(s), Response
Type) message. The PDUID(s) corresponds to the RPAUID stored in the ProSe
Application Server. The Response Type is set to \"restricted
discovery/response ack\". The ProSe Function verifies that at least one of the
received PDUID(s) belongs to the requesting UE.
NOTE 2: Whether steps 3.a and 3.b are executed depends on ProSe Function
configuration, or policy regarding the specific Application Server. For
example, if the ProSe Function can already verify the ownership locally, it
does not have to perform the two steps.
4\. The ProSe Function in the HPLMN allocates a ProSe Response Code, a ProSe
Query Code, and an associated Discovery Query Filter(s). The ProSe Function
also allocates a validity timer that is associated to the ProSe Response Code.
The ProSe Response Code corresponds to the RPAUID that was contained in the
Discovery Request from the UE. The validity timer shall indicate for how long
this ProSe Response Code is going to be valid. The UE will be authorised to
respond with this ProSe Response Code for the duration of validity timer and
if it remains in the same PLMN. The ProSe Function stores the RPAUID, the
ProSe Response Code, the ProSe Query Code and Discovery Query Filter(s), and
the associated validity timer in the user context.
5\. The ProSe Function in HPLMN shall respond with a Discovery Response
(Discovery Model, ProSe Response Code, Discovery Query Filter(s), validity
timer, Discovery Entry ID, [PC5_tech]) message. The Discovery Model indicates
that Model B is used. Multiple Discovery Query Filters may be returned. The
Discovery Query Filter provides means for the Discoveree UE to determine if a
received ProSe Query Code should trigger an announcement of the assigned ProSe
Response Code. The ProSe Response Code is provided by the ProSe Function and
corresponds to the RPAUID that was contained in the Discovery Request. The
validity timer indicates for how long this ProSe Response Code and associated
Discovery Query Filter(s) is going to be valid. When the validity timer
expires or the UE changes its registered PLMN, the UE needs to initiate a new
Discoveree Request procedure. The optional PC5_tech parameter indicates the
PC5 radio technology(ies) that is/are authorized to be used for the assigned
ProSe Response Code. When this parameter is omitted, the authorized PC5 radio
technology is E-UTRA.
6\. The UE may then obtain the radio resources to monitor using the Discovery
Query Filter(s), as authorised and configured by E-UTRAN for ProSe as defined
in RAN specifications, or uses WLAN or both.
NOTE 3: When allowed by authorization configuration, the UE may perform
monitoring in Local PLMNs other than the registered PLMN.
NOTE 4: The ProSe Protocol layer in the UE may inform the application client
that it has started monitoring.
If the validity timer associated with a ProSe Response Code expires (because
the UE has not refreshed the corresponding Discovery Request within the
duration of the validity timer), then the ProSe Function removes the entry
related to that ProSe Response Code from the UE context.
#### 5.3.3A.3 Discoveree Request (roaming/inter-PLMN transmission) -
restricted discovery
Figure 5.3.3A.3A-1: Discoveree UE procedures for Model B restricted discovery
(roaming)
The UE is only allowed to announce in the carrier frequency signalled from
serving PLMN. When inter-PLMN discovery transmission is supported, the carrier
frequency may be operated by Local PLMN.
0\. The user sets the permission for the restricted discovery using
application layer mechanisms. In addition, the application client in the UE
retrieves its own PDUID and provides it to the ProSe Application Server. The
ProSe Application Server allocates a Restricted ProSe Application User ID
(RPAUID) for that PDUID, stores the binding between the PDUID and the RPAUID
and returns the RPAUID to the application client in the UE. The UE may
optionally provide metadata to be associated with the RPAUID, and the ProSe
Application Server stores the metadata. The application client in the UE
stores the binding between the PDUID and its own RPAUID. When the application
client in the UE intends to use the ProSe service, it triggers the UE to
perform a Discoveree request procedure providing its own RPAUID obtained from
the ProSe Application Server.
NOTE 1: The procedures in step 0 are out of scope of 3GPP. However, it is
expected that the application client in the UE will be able to retrieve the
PDUID from the underlying ProSe Protocol layer.
1\. If the Discoveree UE is authorised to use Model B discovery in the PLMN
operating the carrier frequency signalled from the serving PLMN (VPLMN or
Local PLMN), or if UE intends to use Model B discovery using WLAN-based PC5
and is triggered by the application client to perform a Discoveree Request
procedure, the UE shall establish a secure connection to the ProSe Function in
the HPLMN and send a Discovery Request (RPAUID, UE Identity, command,
Discovery Type, Discovery Model, Application ID, Discovery Entry ID,
[Announcing PLMN ID], [PC5_tech]) message. The RPAUID indicates what the UE is
interested to announce. The UE Identity is set to IMSI. The command indicates
that this is for ProSe Response operation, i.e. for a Discoveree UE. The
Discovery Type is set to \"restricted discovery\" and the Discovery Model
indicates \"Model B\". The Application ID represents a unique identifier of
the UE application that has triggered the transmission of the Discovery
Request message. The Discovery Entry ID indicates whether this is a new
request. If inter-PLMN ProSe discovery transmission is supported, and the
serving PLMN signalled carrier frequency is not operated by HPLMN or VPLMN,
the UE shall include the PLMN ID of that carrier frequency in the Announcing
PLMN ID. PC5_tech is an optional parameter that indicates the PC5 radio
technology (e.g. E-UTRA, WLAN) that UE wishes to use for Model B discovery.
PC5_tech may include more than one PC5 radio technology. When this parameter
is omitted the intended PC5 radio technology is E-UTRA. This request is always
sent to the ProSe Function in HPLMN.
2\. The ProSe Function checks for the authorization of the application
represented by the Application ID. If there is no associated UE context, the
ProSe Function shall check with HSS the authorisation for discovery and, if
necessary, create a new context for this UE that contains the subscription
parameters for this UE. The HSS provides the MSISDN of the UE. The HSS also
provides the serving PLMN ID of where the UE is registered. When the Discovery
Entry ID in the Discovery Request message does not contain a valid value for
this UE, the ProSe Function creates a new discovery entry in the UE\'s context
for this request, and returns the corresponding identifier in the Discovery
Response message in step 7.
3.a Optionally, the ProSe Function sends an Auth Request (RPAUID, Request
Type) to the ProSe Application Server. The ProSe Function locates the ProSe
Application Server based on the Application ID. The Request Type is set to
\"restricted discovery/response\".
3.b The ProSe Application Server returns an Auth Response (PDUID(s), Response
Type) message. The PDUID(s) corresponds to the RPAUID stored in the ProSe
Application Server. The Response Type is set to \"restricted
discovery/response ack\". The ProSe Function verifies that at least one of the
received PDUID(s) belongs to the requesting UE.
NOTE 2: Whether steps 3.a and 3.b are executed depends on ProSe Function
configuration, or policy regarding the specific Application Server. For
example, if the ProSe Function can already verify the ownership locally, it
does not have to perform the two steps.
4\. The ProSe Function in the HPLMN allocates a ProSe Response Code, a ProSe
Query Code, and an associated Discovery Query Filter(s). The ProSe Function
also allocates a validity timer that is associated to the ProSe Response Code.
The ProSe Response Code corresponds to the RPAUID that was contained in the
Discovery Request from the UE. The validity timer shall indicate for how long
this ProSe Response Code is going to be valid. The UE will be authorised to
respond with this ProSe Response Code for the duration of validity timer and
if it remains in the same PLMN. The ProSe Function stores the RPAUID, the
ProSe Response Code, the ProSe Query Code, and Discovery Query Filter(s), and
the associated validity timer in the user context.
5\. If the Discovery Request is authorised then the ProSe Function in the
HPLMN shall inform the ProSe Function in VPLMN or Local PLMN with the Announce
Authorisation (Restricted ProSe Application User ID, Application ID, ProSe
Response Code, validity timer, UE Identity, Discovery Entry ID, [PC5_tech])
message. The Restricted ProSe Application User ID corresponds to the request
from the UE, whereas the ProSe Response Code indicates the assigned code for
this request. The request also includes the UE identity information e.g. IMSI
or MSISDN in order to allow the ProSe Function in VPLMN or Local PLMN to
perform charging. The validity timer indicates for how long this ProSe
Response Code is going to be valid. If the ProSe Function in VPLMN or Local
PLMN receives the same Discovery Entry ID in a subsequent Announce
Authorization message, it updates the discoveree UE\'s corresponding discovery
entry replacing the existing ProSe Response Code and validity timer with the
last received ones. The request may also include the PC5_tech parameter if it
was provided by the UE in step 1. When this parameter is omitted the intended
PC5 radio technology is E-UTRA.
NOTE 3: The information provided in step 5 that is related to charging is used
only when the requested PC5 radio technology includes E-UTRA.
6\. The ProSe Function in VPLMN or Local PLMN authorizes the UE to perform
ProSe Direct Discovery announcing.
7\. The ProSe Function in HPLMN shall respond with a Discovery Response
(Discovery Model, ProSe Response Code, Discovery Query Filter(s), validity
timer, Discovery Entry ID, [PC5_tech]) message. The Discovery Model indicates
that Model B is used. Multiple Discovery Query Filters may be returned. The
Discovery Query Filter provides means for the Discoveree UE to determine if a
received ProSe Query Code should trigger an announcement of the assigned ProSe
Response Code. The ProSe Response Code is provided by the ProSe Function and
corresponds to the Restricted ProSe Application User ID that was contained in
the Discovery Request. The validity timer indicates for how long this ProSe
Response Code and associated Discovery Query Filter(s) is going to be valid.
When the validity timer expires or the UE changes its registered PLMN, the UE
needs to UE needs to initiate a new Discoveree Request procedure. The optional
PC5_tech parameter indicates the PC5 radio technology(ies) that is/are
authorized to be used for the assigned ProSe Response Code. When this
parameter is omitted, the authorized PC5 radio technology is E-UTRA.
8\. The UE may then obtain the radio resources to monitor using the Discovery
Query Filter, as authorised and configured by E-UTRAN for ProSe as defined in
RAN specifications, or uses WLAN or both.
NOTE 4: When allowed by authorization configuration, the UE may perform
monitoring in Local PLMNs other than the registered PLMN
NOTE 5: The ProSe Protocol layer in the UE may inform the application client
that it has started monitoring.
If the validity timer associated with a ProSe Response Code expires (because
the UE has not refreshed the corresponding Discovery Request within the
duration of the validity timer), then the ProSe Function removes the entry
related to that ProSe Response Code from the UE context.
#### 5.3.3A.4 Discoverer Request (non-roaming) - restricted discovery
Figure 5.3.3A.4A-1: Discoverer UE procedures for Model B restricted discovery
(non-roaming)
0\. In this step, the application client in the UE retrieves its own PDUID and
provides it to the ProSe Application Server. The ProSe Application Server
allocates a Restricted ProSe Application User ID (RPAUID) for that PDUID,
stores the binding between the PDUID and the RPAUID and returns the RPAUID to
the application client in the UE. The application client in the UE stores the
binding between the PDUID and its own RPAUID, obtains the RPAUID of those
users (Target RPAUIDs) from the ProSe Application Server and triggers the UE
to perform the ProSe query procedure, providing its own RPAUID and the Target
RPAUIDs. The Target RPAUIDs of the UEs to be queried are passed in an
Application Level Container.
NOTE 1: The procedures in step 0 are out of scope of 3GPP. However, it is
expected that the application client in the UE will be able to retrieve the
PDUID from the underlying ProSe Protocol layer.
1\. If the Discoverer UE is authorised to use Model B discovery in the serving
PLMN, or if UE intends to use Model B discovery using WLAN-based PC5 and is
triggered by the application client to perform a Discoverer Request procedure,
the UE shall establish a secure connection to the ProSe Function in the HPLMN
and send a Discovery Request (RPAUID, UE Identity, command, Discovery Type,
Discovery Model, Application ID, Application Transparent Container, Discovery
Entry ID, [PC5_tech]) message. The RPAUID indicates what the UE is interested
to announce. The UE Identity is set to IMSI. The command indicates that this
is for a ProSe Query operation, i.e. for a Discoverer UE. The Discovery Type
is set to \"restricted discovery\" and the Discovery Model indicates \"Model
B\". The Application ID represents a unique identifier of the UE application
that has triggered the transmission of the Discovery Request message. The
Discovery Entry ID indicates whether this is a new request. PC5_tech is an
optional parameter that indicates the PC5 radio technology (e.g. E-UTRA, WLAN)
that UE wishes to use for Model B discovery. PC5_tech may include more than
one PC5 radio technology. When this parameter is omitted the intended PC5
radio technology is E-UTRA. This request is always sent to the ProSe Function
in HPLMN.
2\. The ProSe Function checks for the authorization of the application
represented by the Application ID. If there is no associated UE context, the
ProSe Function shall check with HSS the authorisation for discovery and, if
necessary, create a new context for this UE that contains the subscription
parameters for this UE. The HSS provides the MSISDN of the UE. The HSS also
provides the serving PLMN ID of where the UE is registered. When the Discovery
Entry ID in the Discovery Request message does not contain a valid value for
this UE, the ProSe Function creates a new discovery entry in the UE\'s context
for this request, and returns the corresponding identifier in the Discovery
Response message in step 8.
3.a The ProSe Function sends an Auth Request (RPAUID, Request Type,
Application Level Container) to the ProSe Application Server. The ProSe
Function locates the ProSe Application Server based on the Application ID. The
Request Type is set to \"restricted discovery/query\".
3.b If, based on the permission setting, the RPAUID is allowed to discover at
least one of the Target RPAUID(s) contained in the Application Level
Container, the ProSe Application Server returns an Auth Response (PDUID,
Response Type, N sets of Target PDUID - Target RPAUID) message. The PDUID
corresponds to the RPAUID stored in the ProSe Application Server. The Response
Type is set to \"restricted discovery/query ack\". Each Target ProSe Discovery
UE ID is returned with the corresponding Target RPAUID that the RPAUID is
allowed to discover. The ProSe Function verifies that the received PDUID
belongs to the requesting UE.
Step 4 is executed only when the PLMN ID in the Target ProSe Discovery UE ID
indicates the HPLMN.
4\. If the PLMN ID in the Target PDUID indicates the HPLMN and at least one of
received pair of Target PDUID - Target RPAUID corresponds to a valid ProSe
Response Code including a valid PC5 radio technology match as indicated via
the PC5_tech parameter in step 1, the ProSe Function locates the Discoveree
UE(s) context. The ProSe Function in the HPLMN retrieves the ProSe Query Code
and an associated validity timer. The ProSe Query Code is the code used by the
ProSe Function to build the Discovery Query Filter of step 4 of clause
5.3.3A.2, such that it can trigger the Discoveree UE to send the response. The
ProSe Function allocates a Discovery Response Filter(s) based on the ProSe
Response Code. The ProSe Response Code is that allocated to the Discoveree UE
in step 4 of clause 5.3.3A.2. The validity timer indicates for how long a
ProSe Query Code and ProSe Response Code are going to be valid.
Steps 5-7 are executed only when the PLMN ID in the Target ProSe Discovery UE
ID indicates a different HPLMN.
5\. If the Discovery Request is authorized, and the PLMN ID in the Target
ProSe Discovery UE ID indicates a different PLMN, the ProSe Function contacts
the ProSe Function of the indicated PLMN(s) to obtain the necessary
information with a Discovery Request (Restricted ProSe App User ID, UE
Identity, Target ProSe Discovery UE ID, Application ID, Target Restricted
ProSe App User ID, Discovery Entry ID, [PC5_tech]). If the ProSe Function in
other PLMN receives the same Discovery Entry ID in a subsequent Discovery
Request message, it updates the discoverer UE\'s corresponding discovery entry
with the received corresponding parameters. The request may also include the
PC5_tech parameter if it was provided by the UE in step 1. When this parameter
is omitted the intended PC5 radio technology is E-UTRA.
6.a Optionally, the ProSe Function in the other PLMN sends an Auth Request
(RPAUID, Request Type, Target RPAUID) to the Application Server indicated by
the Application ID. The request type is set to \"restricted discovery/query\".
6.b If, based on the permission setting, the RPAUID is allowed to discover at
least one of the Target RPAUID(s), the ProSe Application Server returns an
Auth Response (PDUID, response type, Target PDUID) message. The PDUID
corresponds to the RPAUID stored in the ProSe Application Server. The response
type is set to \"restricted discovery/query ack\". The ProSe Function in the
other PLMN verifies that the received PDUID belongs to the UE to be
discovered.
NOTE 2: Whether steps 6.a and 6.b are executed depends on ProSe Function
configuration, or policy regarding the specific Application Server. For
example, if the ProSe Function can verify the permission locally, or the HPLMN
is trusted by the other PLMNs for permission control, these steps are not
needed.
7\. Based on the Target ProSe Discovery UE ID, Application ID, and Target
Restricted ProSe App User ID, the ProSe Function locates the Discoveree UE(s)
context, and responds with a Discovery Response (ProSe Query Code(s), ProSe
Response Code, validity timer, [PC5_tech]). The ProSe Query Code is the code
used by the ProSe Function to build the Discovery Query Filter of step 4 of
clause 5.3.3A.2, such that it can trigger the Discoveree UE to send the
response. The ProSe Response Code is that allocated to the Discoveree UE in
step 4 of clause 5.3.3A.2. The validity timer indicates for how long a ProSe
Query Code and ProSe Response Code are going to be valid. The optional
PC5_tech parameter indicates the PC5 radio technology(ies) that is/are
authorized to be used for the assigned ProSe Query Code. When this parameter
is omitted, the authorized PC5 radio technology is E-UTRA.
8\. The ProSe Function in the HPLMN shall respond with a Discovery Response
(Discovery Model, ProSe Query Code(s), Discovery Response Filter(s) validity
timer, [PC5_tech]) message. The Discovery Model indicates the Model B is used.
Multiple Discovery Response Filters may be returned. The Discovery Response
Filter is generated by the ProSe Function based on the ProSe Response Code of
step 4 or received in step 7. The ProSe Query Code is that of step 4 or is
received in step 7. The validity timer indicates for how long a ProSe Query
Code and corresponding Discovery Response Filter(s) are going to be valid.
When the validity timer expires the UE needs to UE needs to initiate a new
Discoverer Request procedure. The optional PC5_tech parameter indicates the
PC5 radio technology(ies) that is/are authorized to be used for the assigned
ProSe Query Code. When this parameter is omitted, the authorized PC5 radio
technology is E-UTRA.
9\. The UE may then obtain the radio resources to announce the ProSe Query
Code, as authorised and configured by E-UTRAN for ProSe as defined in RAN
specifications, or uses WLAN or both.
NOTE 3: The ProSe Protocol layer in the UE may inform the application client
that it has started announcing. This is out of scope of 3GPP.
If the validity timer associated with a ProSe Query Code expires (because the
UE has not refreshed the corresponding Discovery Request within the duration
of the validity timer), then the ProSe Function removes the entry related to
that ProSe Query Code from the UE context.
#### 5.3.3A.5 Discoverer request (roaming/inter-PLMN transmission) -
restricted discovery
Figure 5.3.3A.5A-1: Discoverer UE procedures for Model B restricted discovery
(roaming)
The UE is only allowed to announce in the carrier frequency signalled from
serving PLMN. When inter-PLMN discovery transmission is supported, the carrier
frequency may be operated by Local PLMN.
0\. In this step, the application client in the UE retrieves its own PDUID and
provides it to the ProSe Application Server. The ProSe Application Server
allocates a Restricted ProSe Application User ID (RPAUID) for that PDUID,
stores the binding between the PDUID and the RPAUID and returns the RPAUID to
the application client in the UE. The application client in the UE stores the
binding between the PDUID and its own RPAUID. When the application client in
the UE intends to query a UE of other users (e.g. friends in the application),
it obtains the RPAUID of those users (Target RPAUIDs) from the ProSe
Application Server and triggers the UE to perform the ProSe query procedure,
providing its own RPAUID and the Target RPAUIDs. The Target RPAUIDs of the UEs
to be queried are passed in an Application Level Container.
NOTE 1: The procedures in step 0 are out of scope of 3GPP. However, it is
expected that the application client in the UE will be able to retrieve the
PDUID from the underlying ProSe Protocol layer.
1\. If the Discoverer UE is authorised to use Model B discovery in the PLMN
operating the carrier frequency signalled by the serving PLMN, or if UE
intends to use Model B discovery using WLAN-based PC5 and is triggered by the
application client to perform a Discoverer Request procedure, the UE shall
establish a secure connection to the ProSe Function in the HPLMN and send a
Discovery Request (RPAUID, UE Identity, command, Discovery Type, Discovery
Model, Application ID, Application Transparent Container, Discovery Entry ID,
[Announcing PLMN ID], [PC5_tech]) message. The RPAUID indicates what the UE is
interested to announce. The UE Identity is set to IMSI. The command indicates
that this is for a ProSe Query operation, i.e. for a Discoverer UE. The
Discovery Type is set to \"restricted discovery\" and the Discovery Model
indicates \"Model B\". The Application ID represents a unique identifier of
the UE application that has triggered the transmission of the Discovery
Request message. The Discovery Entry ID indicates whether this is a new
request. If inter-PLMN ProSe discovery transmission is supported, and the
serving PLMN signalled carrier frequency is not operated by HPLMN or VPLMN,
the UE shall include the PLMN ID of that carrier frequency in the Announcing
PLMN ID. PC5_tech is an optional parameter that indicates the PC5 radio
technology (e.g. E-UTRA, WLAN) that UE wishes to use for Model B discovery.
PC5_tech may include more than one PC5 radio technology. When this parameter
is omitted the intended PC5 radio technology is E-UTRA. This request is always
sent to the ProSe Function in HPLMN.
2\. The ProSe Function checks for the authorization of the application
represented by the Application ID. If there is no associated UE context, the
ProSe Function shall check with HSS the authorisation for discovery and, if
necessary, create a new context for this UE that contains the subscription
parameters for this UE. The HSS provides the MSISDN of the UE. The HSS also
provides the serving PLMN ID of where the UE is registered. When the Discovery
Entry ID in the Discovery Request message does not contain a valid value for
this UE, the ProSe Function creates a new discovery entry in the UE\'s context
for this request, and returns the corresponding identifier in the Discovery
Response message in step 10.
3.a The ProSe Function sends an Auth Request (RPAUID, Request Type,
Application Level Container) to the ProSe Application Server. The ProSe
Function locates the ProSe Application Server based on the Application ID. The
Request Type is set to \"restricted discovery/query\".
3.b If, based on the permission setting, the RPAUID is allowed to discover at
least one of the Target RPAUID(s) contained in the Application Level
Container, the ProSe Application Server returns an Auth Response (PDUID,
Response Type, N sets of Target PDUID - Target RPAUID) message. The PDUID
corresponds to the RPAUID stored in the ProSe Application Server. The Response
Type is set to \"restricted discovery/query ack\". Each Target ProSe Discovery
UE ID is returned with the corresponding Target RPAUID that the RPAUID is
allowed to discover. The ProSe Function verifies that the received PDUID
belongs to the requesting UE.
Step 4 is executed only when the PLMN ID in the Target ProSe Discovery UE ID
indicates the HPLMN.
4\. If the PLMN ID in the Target PDUID indicates the HPLMN and at least one of
received pair of Target PDUID - Target RPAUID corresponds to a valid ProSe
Response Code including a valid PC5 radio technology match as indicated via
the PC5_tech parameter in step 1, the ProSe Function locates the Discoveree
UE(s) context. The ProSe Function in the HPLMN retrieves the ProSe Query Code
and an associated validity timer. The ProSe Query Code is the code used by the
ProSe Function to build the Discovery Query Filter of step 4 of clause
5.3.3A.3, such that it can trigger the Discoveree UE to send the response. The
ProSe Function allocates a Discovery Response Filter(s) based on the ProSe
Response Code. The ProSe Response Code is that allocated to the Discoveree UE
in step 4 of clause 5.3.3A.3. The validity timer indicates for how long a
ProSe Query Code and ProSe Response Code are going to be valid.
Steps 5-7 are executed only when the PLMN ID in the Target ProSe Discovery UE
ID indicates a different HPLMN.
5\. If the Discovery Request is authorized, and the PLMN ID in the Target
ProSe Discovery UE ID indicates a different PLMN, the ProSe Function contacts
the ProSe Function of the indicated PLMN(s) to obtain the necessary
information with a Discovery Request (Restricted ProSe App User ID, UE
Identity, Target ProSe Discovery UE ID, Application ID, Target Restricted
ProSe App User ID, Discovery Entry ID, [PC5_tech]). If the ProSe Function in
other PLMN receives the same Discovery Entry ID in a subsequent Discovery
Request message, it updates the discoverer UE\'s corresponding discovery entry
with the received corresponding parameters. The request may also include the
PC5_tech parameter if it was provided by the UE in step 1. When this parameter
is omitted the intended PC5 radio technology is E-UTRA.
6.a Optionally, the ProSe Function in the other PLMN sends an Auth Request
(RPAUID, Request Type, Target RPAUID) to the ProSe Application Server
indicated by the Application ID. The Request Type is set to \"restricted
discovery/query\".
6.b If, based on the permission setting, the RPAUID is allowed to discover at
least one of the Target RPAUID(s), the ProSe Application Server returns an
Auth Response (PDUID, Response Type, Target PDUID) message. The PDUID
corresponds to the RPAUID stored in the ProSe Application Server. The Response
Type is set to \"restricted discovery/query ack\". The ProSe Function in the
other PLMN verifies that the received PDUID belongs to the UE to be
discovered.
NOTE 2: Whether steps 6.a and 6.b are executed depends on ProSe Function
configuration, or policy regarding the specific Application Server. For
example, if the ProSe Function can verify the permission locally, or the HPLMN
is trusted by the other PLMNs for permission control, these steps are not
needed.
7\. Based on the Target ProSe Discovery UE ID, Application ID, and Target
Restricted ProSe App User ID, the ProSe Function locates the Discoveree UE(s)
context, and responds with a Discovery Response (ProSe Query Code(s), ProSe
Response Code, validity timer, [PC5_tech]). The ProSe Query Code is the code
used by the ProSe Function to build the Discovery Query Filter of step 4 of
clause 5.3.3A.3, such that it can trigger the Discoveree UE to send the
response. The ProSe Response Code is that allocated to the Discoveree UE in
step 4 of clause 5.3.3A.3. The validity timer indicates for how long a ProSe
Query Code and ProSe Response Code are going to be valid. The optional
PC5_tech parameter indicates the PC5 radio technology(ies) that is/are
authorized to be used for the assigned ProSe Query Code. When this parameter
is omitted, the authorized PC5 radio technology is E-UTRA.
8\. The ProSe Function in the HPLMN shall inform the ProSe Function in VPLMN
or Local PLMN if Announcing PLMN ID is included in step 1 with the Announce
Authorisation (Restricted ProSe Application User ID, Application ID, ProSe
Query Code(s), validity timer, UE Identity, Discovery Entry ID, [PC5_tech])
message. The Restricted ProSe Application User ID corresponds to the request
from the UE, whereas the ProSe Query Code is that of step 4 or is obtained in
step 7. The request also includes the UE identity information e.g. IMSI or
MSISDN in order to allow the ProSe Function in VPLMN or Local PLMN to perform
charging. The validity timer indicates for how long this ProSe Query Code is
going to be valid. If the ProSe Function in VPLMN or Local PLMN receives the
same Discovery Entry ID in a subsequent Announce Authorization message, it
updates the discoverer UE\'s corresponding discovery entry replacing the
existing ProSe Query Code(s) and validity timer with the last received ones.
The request may also include the PC5_tech parameter if it was provided by the
UE in step 1. When this parameter is omitted the intended PC5 radio technology
is E-UTRA.
NOTE 3: The information provided in step 8 that is related to charging is used
only when the requested PC5 radio technology includes E-UTRA.
9\. The ProSe Function in VPLMN or Local PLMN authorizes the UE to perform
ProSe Direct Discovery announcing.
10\. The ProSe Function in the HPLMN shall respond with a Discovery Response
(Discovery Model, ProSe Query Code(s), Discovery Response Filter(s) validity
timer, [PC5_tech]) message. The Discovery Model indicates the Model B is used.
Multiple Discovery Response Filters may be returned. The Discovery Response
Filter is generated by the ProSe Function based on the ProSe Response Code of
step 4 or received in step 7. The ProSe Query Code is that of step 4 or is
received in step 7. The validity timer indicates for how long a ProSe Query
Code and the corresponding Discovery Response Filter(s) are going to be valid.
When the validity timer expires the UE needs to initiate a new Discoverer
Request procedure. The optional PC5_tech parameter indicates the PC5 radio
technology(ies) that is/are authorized to be used for the assigned ProSe Query
Code. When this parameter is omitted, the authorized PC5 radio technology is
E-UTRA.
11\. The UE may then obtain the radio resources to announce the ProSe Query
Code, as authorised and configured by E-UTRAN for ProSe as defined in RAN
specifications or uses WLAN, or both.
NOTE 4: The ProSe Protocol layer in the UE may inform the application client
that it has started announcing. This is out of scope of 3GPP.
If the validity timer associated with a ProSe Query Code expires (because the
UE has not refreshed the corresponding Discovery Request within the duration
of the validity timer), then the ProSe Function removes the entry related to
that ProSe Query Code from the UE context.
### 5.3.4 Discovery reporting
#### 5.3.4.1 Match report (non-roaming) - open discovery
Figure 5.3.4.1-1: Match report procedure (non-roaming)
1\. If the UE finds ProSe Application Code(s) that matches the Discovery
Filters and does not have ProSe Application ID(s) already locally stored that
correspond to this ProSe Application Code(s), or these ProSe Application
Code(s) excluding the Metadata Index are stored locally with the corresponding
ProSe Application ID(s) but the Metadata Index(s) of the received and stored
codes are different, the UE it shall (re)establish a secure connection with
the ProSe Function in HPLMN to which it shall then send a Match Report (ProSe
Application Code(s), UE Identity, Monitored PLMN ID) message to the ProSe
Function in HPLMN. The ProSe Application Code is the code that the
corresponding Discovery Filter of the UE matched. This request is always sent
to the ProSe Function in HPLMN. The UE Identity is set to e.g. IMSI. The
Monitored PLMN ID is the PLMN in which the UE has monitored the ProSe
Application Code.
If application-controlled extension is used, the UE may initiate a Match
Report procedure if there is match on the ProSe Application Code Prefix, and
there is a match on the ProSe Restricted Code Suffix, but the ProSe Protocol
layer in the UE doesn\'t have the ProSe Application ID corresponding to the
ProSe Application Code Prefix stored locally.
NOTE: How the Monitored PLMN ID is derived will be defined in RAN
specifications.
2\. The ProSe Function shall check the context for this UE that contains its
subscription parameters. The authorisation information also contains the PLMN
that this UE is allowed to perform discovery. The HSS provides the MSISDN of
the UE.
3\. The ProSe Function analyses the ProSe Application Code(s) received from
the UE.
If the dynamic metadata is used and the PLMN that assigned the given ProSe
Application Code(s) is the HPLMN, the ProSe Function in the HPLMN locates the
latest metadata(s) associated with the ProSe Application Code(s).
If the PLMN that assigned the given ProSe Application Code is another Local
PLMN then steps 4-7 are executed, otherwise (i.e. the ProSe Application Code
was assigned by HPLMN) only step 7 is executed:
4\. The ProSe Function in HPLMN sends a Match Report (ProSe Application
Code(s), UE identity, Monitored PLMN ID) to the ProSe Function of the PLMN
that assigned the ProSe Application Code. The UE identity information e.g.
IMSI or MSISDN can be used by the ProSe Function in Local PLMN to perform
charging.
5\. The ProSe Function ensures that the received ProSe Application Code is
authorized to be transmitted on the monitored PLMN, i.e. the pair of ProSe
Application Code and the monitored PLMN is stored in the UE context. The ProSe
Function analyses the ProSe Application Code(s) received from the UE. As the
\"announcing\" UE is not roaming, the ProSe function only needs to check
whether the received ProSe Application Code(s) is still valid.
If the dynamic metadata is used, the ProSe Function(s) in the other PLMN(s)
locates the latest metadata(s) associated with the ProSe Application Code(s).
6\. If the ProSe Application Code is confirmed then the ProSe Function in
Local PLMN shall send Match Report Acknowledgement (ProSe Application ID
Name(s), validity timer(s)). This message may also contain certain metadata
corresponding to the ProSe Application ID Name e.g. postal address, phone
number, URL etc.
If the dynamic metadata is used, the metadata(s) and the Metadata Index
Mask(s) corresponding to the ProSe Application Code(s) are sent along with the
Match Report Acknowledgement message(s).
7\. The ProSe Function in HPLMN shall respond to the UE with Match Report
Acknowledgment (ProSe Application ID(s), validity timer(s), [metadata(s)],
[Metadata Index Mask(s)]). This message may also contain certain metadata
corresponding to the ProSe Application ID Name e.g. postal address, phone
number, URL etc. The validity timer(s) indicate for how long the mapping of
ProSe Application Code(s) and ProSe Application ID(s) provided are going to be
valid. The UE stores the mapping of ProSe Application Code(s) and
corresponding ProSe Application ID(s) for the duration of their validity
timer.
If the dynamic metadata is used, the Metadata Index Mask(s) for the
corresponding metadata(s) are also sent to the UE in the Match Report
Acknowledgment message. The UE stores the Metadata Index Mask with the
corresponding ProSe Application Code(s) and ProSe Application ID(s).
#### 5.3.4.1A Match Report (non-roaming) - restricted discovery
Figure 5.3.4.1A-1: Match Report procedure for restricted discovery (non-
roaming)
1\. When the monitoring UE has received a ProSe Restricted Code over the air
that matches the Discovery Filter it obtained from monitoring Request
procedure, and if the UE does not have a corresponding RPAUID associated with
it with a valid TTL, the UE sends a Match Report (RPAUID, UE Identity,
Discovery Type, Application ID, ProSe Restricted Code, Metadata Requested)
message to the ProSe Function in the HPLMN to get the Target RPAUID. The
RPAUID is the identifier the monitoring UE used to obtain the Discovery Filter
from the Monitoring Request. The UE Identity is set to e.g. IMSI. The
Application ID represents a unique identifier of the application that
triggered the monitoring Request. Discovery Type is set to \"restricted
discovery\". The ProSe Restricted Code is the code received over the air.
If restricted Direct Discovery with application-controlled extension is used,
the UE may initiate a Match Report procedure if there is match on the ProSe
Restricted Code Prefix, and there is a match on the ProSe Restricted Code
Suffix, but the ProSe Protocol layer in the UE doesn\'t have the ProSe
Restricted App User ID corresponding to the ProSe Restricted Code Prefix
stored locally. Once the ProSe Protocol layer in the UE has got the ProSe
Restricted App User ID corresponding to the ProSe Restricted Code Prefix
stored locally, the ProSe Restricted Code Suffix is passed to the application
in the UE.
If the monitoring UE decides that it needs to obtain the latest metadata, e.g.
when the Metadata Indicator allows metadata update, and the UE has noticed a
change of the metadata (e.g. from the suffix or via other means), it includes
Metadata Requested in the Match Report message.
NOTE 1: If the UE has received the Target RPAUID corresponding to the ProSe
Restricted Code in the Discovery Filter in the Discovery Response message, the
Match Report procedure may be skipped.
2\. The HPLMN ProSe Function checks the authorization for the monitoring UE to
perform restricted discovery.
3\. The HPLMN ProSe Function analyses the ProSe Restricted Code and identifies
in the UE context of the monitoring UE the corresponding Target RPAUID.
4.a Optionally, the ProSe Function sends a Auth Request (RPAUID, Target
RPAUID, Request Type) to the ProSe Application Server. The ProSe Function
locates the ProSe Application Server based on the Application ID. The Request
Type is set to \"restricted discovery/match\". If the Metadata Requested is
included in the Match Report in step 1, the ProSe Function shall send the Auth
Request message.
4.b If, based on the permission setting, the RPAUID is allowed to discover the
Target RPAUID, the ProSe Application Server returns a Auth Response (PDUID,
Target PDUID, Response Type, metadata) message. The PDUID corresponds to
RPAUID, the Target PDUID corresponds to the Target RPAUID stored in the ProSe
Application Server. The Response Type is set to \"restricted discovery/match
ack\". This message may also contain certain metadata corresponding to the
Target PDUID, e.g. welcome message, etc.
4.c The ProSe Function verifies that the returned PDUID belongs to the
requesting UE, and the Target PDUID is the same as the stored Target PDUID.
NOTE 2: The Auth Request and Auth Response messages may be extended with
additional contents depending on the configuration on the ProSe Function and
the Application Server.
NOTE 3: The Application logic triggered by the Auth Request message is out of
the scope of 3GPP.
5\. The ProSe Function in HPLMN returns a Match Report Ack (Application ID,
Target RPAUID, validity timer, metadata) to the UE. The UE stores the mapping
between the RPAUID, the ProSe Restricted Code and the Application ID for the
duration of the validity timer.
NOTE 4: The application client is notified of the successful discovery either
by ProSe Protocol layer in the UE or by the Application Server with procedures
out of the scope of 3GPP.
6\. The ProSe Function in HPLMN may optionally send a Match Report Info
(RPAUID, Target RPAUID, UE Identity, ProSe Restricted Code, Discovery Type) to
the ProSe Function of the announcing UE. Discovery Type is set to \"restricted
discovery\".
#### 5.3.4.2 Match report (roaming/inter-PLMN transmission) - open discovery
Figure 5.3.4.2-1: Match report procedure (roaming)
1\. If the UE finds ProSe Application Code(s) that matches the Discovery
Filters and does not have ProSe Application ID(s) already locally stored that
correspond to this ProSe Application Code(s) or these ProSe Application
Code(s) excluding the Metadata Index are stored locally with the corresponding
ProSe Application ID(s) but the Metadata Index(s) of the stored and received
codes are different, the UE (re)establishes a secure connection with the ProSe
Function in HPLMN and sends a Match Report (ProSe Application Code(s), UE
Identity, VPLMN ID, Monitored PLMN ID) message to the ProSe Function in HPLMN.
The ProSe Application Code is the code that the corresponding Discovery Filter
of the UE matched. The UE Identity is set to e.g. IMSI. The Monitored PLMN ID
is the PLMN in which the UE has monitored the ProSe Application Code.
If application-controlled extension is used, the UE may initiate a Match
Report procedure if there is match on the ProSe Application Code Prefix, and
there is a match on the ProSe Restricted Code Suffix, but the ProSe Protocol
layer in the UE doesn\'t have the ProSe Application ID corresponding to the
ProSe Application Code Prefix stored locally.
NOTE 1: The Monitored PLMN ID is needed in order to cover the case that the
announcing UE that broadcast the ProSe Application Code was registered in
another PLMN.
NOTE 2: How the Monitored PLMN ID is derived will be defined in RAN
specifications.
2\. The ProSe Function shall check the context for this UE that contains its
subscription parameters for this UE. The authorisation information also
contains the PLMN that this UE is allowed to perform discovery. The UE context
also contains the VPLMN ID where the UE is registered. The HSS provides the
MSISDN of the UE.
3\. The ProSe Function analyses the ProSe Application Code(s) received from
the UE.
If the dynamic metadata is used and the PLMN that assigned the given ProSe
Application Code(s) is the HPLMN, the ProSe Function in the HPLMN locates the
latest metadata(s) associated with the ProSe Application Code(s).
If the PLMN that assigned the given ProSe Application Code is not the HPLMN,
then steps 4-8 are executed, otherwise (i.e. the HPLMN assigned the ProSe
Application Code) only steps 7-8 are executed:
4\. The ProSe Function in HPLMN sends a Match Report (ProSe Application
Code(s), UE identity, Monitored PLMN ID) to the ProSe Function of the PLMN
that assigned the ProSe Application Code (i.e. the ProSe Function of the HPLMN
of the \"announcing UE\"). The UE identity information e.g. IMSI or MSISDN can
be used by the ProSe Function in Local/Visited PLMN to perform charging.
5\. The ProSe Function ensures that the received ProSe Application Code is
authorized to be transmitted on the monitored PLMN, i.e. the pair of ProSe
Application Code and the monitored PLMN is stored in the UE context. The ProSe
Function analyses the ProSe Application Code(s) received from the UE, and
confirms the ProSe Application Code(s).
If the dynamic metadata is used, the ProSe Function(s) in the other PLMN(s)
locates the latest metadata(s) associated with the ProSe Application Code(s).
6\. The ProSe Function shall send Match Report Acknowledgement (ProSe
Application ID Name(s), validity timer(s)). This message may also contain
certain metadata corresponding to the ProSe Application ID Name e.g. postal
address, phone number, URL etc.
If the dynamic metadata is used, the metadata(s) and the Metadata Index
Mask(s) corresponding to the ProSe Application Code(s) are sent along with the
Match Report Acknowledgement message(s).
7\. The ProSe Function in HPLMN shall respond to the UE with Match Report
Acknowledgment (ProSe Application ID(s), validity timer(s), [metadata(s)],
[Metadata Index Mask(s)]). This message may also contain certain metadata
corresponding to the ProSe Application ID Name e.g. postal address, phone
number, URL etc. The validity timer(s) indicate for how long the mapping of
ProSe Application Code(s) and ProSe Application ID(s) provided are going to be
valid. The UE stores the mapping of ProSe Application Code(s) and
corresponding ProSe Application ID(s) for the duration of their validity
timer.
If the dynamic metadata is used, the Metadata Index Mask(s) for the
corresponding metadata(s) are also sent to the UE in the Match Report
Acknowledgment message. The UE stores the Metadata Index Mask with the
corresponding ProSe Application Code(s) and ProSe Application ID(s).
8\. If the the Monitored PLMN ID is different from the PLMN ID contained in
the ProSe Application Code, i.e. the \"announcing UE\" is roaming or performs
inter-PLMN discovery transmission, the ProSe Function in HPLMN may optionally
send a Match Report Info (ProSe Application ID(s), UE Identity) to the ProSe
Function of the PLMN indicated by the Monitored PLMN ID.
#### 5.3.4.2A Match Report (roaming/inter-PLMN transmission) - restricted
discovery
Figure 5.3.4.2A-1: Match Report procedure for restricted discovery (roaming)
1\. When the monitoring UE has received a ProSe Restricted Code over the air
that matches the Discovery Filter it obtained from monitoring Request
procedure, and if the UE does not have a corresponding RPAUID associated with
it with a valid TTL, the UE sends a Match Report (RPAUID, UE Identity,
Discovery Type, Application ID, ProSe Restricted Code, Metadata Requested,
Monitored PLMN ID) message to the ProSe Function in the HPLMN to get the
Target RPAUID. The RPAUID is the identifier the monitoring UE used to obtain
the Discovery Filter from the Monitoring Request. The UE Identity is set to
e.g. IMSI. The Application ID represents a unique identifier of the
application that triggered the monitoring Request. Discovery Type is set to
\"restricted discovery\". The ProSe Restricted Code is the code received over
the air. The Monitored PLMN ID is that of the PLMN in which the UE monitored
the ProSe Restricted Code.
NOTE 1: How the Monitored PLMN ID is derived will be defined in RAN
specifications.
If restricted Direct Discovery with application-controlled extension is used,
the UE may initiate a Match Report procedure if there is match on the ProSe
Restricted Code Prefix, and there is a match on the ProSe Restricted Code
Suffix, but the ProSe Protocol layer in the UE doesn\'t have the ProSe
Restricted App User ID corresponding to the ProSe Restricted Code Prefix
stored locally. Once the ProSe Protocol layer in the UE has got the ProSe
Restricted App User ID corresponding to the ProSe Restricted Code Prefix
stored locally, the ProSe Restricted Code Suffix is passed to the application
in the UE.
If the monitoring UE decides that it needs to obtain the latest metadata, e.g.
when the Metadata Indicator allows metadata update, and the UE has noticed a
change of the metadata (e.g. from the suffix or via other means), it includes
the Metadata Requested in the Match Report message.
NOTE 2: If the UE has received the Target RPAUID corresponding to the ProSe
Restricted Code in the Discovery Filter in the Discovery Response message, the
Match Report procedure may be skipped.
2\. The HPLMN ProSe Function checks the authorization for the monitoring UE to
perform restricted discovery.
3\. The HPLMN ProSe Function analyses the ProSe Restricted Code and identifies
in the UE context of the monitoring UE the corresponding Target RPAUID.
4.a Optionally, the ProSe Function sends a Auth Request (RPAUID, Target
RPAUID, Request Type) to the ProSe Application Server. The ProSe Function
locates the ProSe Application Server based on the Application ID. The Request
Type is set to \"restricted discovery/match\". If the Metadata Requested is
included in the Match Report in step 1, the ProSe Function shall send the Auth
Request message.
4.b If, based on the permission setting, the RPAUID is allowed to discover the
Target RPAUID, the ProSe Application Server returns a Auth Response (PDUID,
Target PDUID, Response Type, metadata) message. The PDUID corresponds to
RPAUID, the Target PDUID corresponds to the Target RPAUID stored in the ProSe
Application Server. The Response Type is set to \"restricted discovery/match
ack\". This message may also contain certain metadata corresponding to the
Target PDUID, e.g. welcome message, etc.
4.c The ProSe Function verifies that the returned PDUID belongs to the
requesting UE, and the Target PDUID is the same as the stored Target PDUID.
NOTE 3: The Auth Request and Auth Response messages may be extended with
additional contents depending on the configuration on the ProSe Function and
the Application Server.
NOTE 4: The Application logic triggered by the Auth Request message is out of
the scope of 3GPP.
5\. The ProSe Function in HPLMN returns a Match Report Ack (Application ID,
Target RPAUID, validity timer, metadata (opt.)) to the UE. The UE stores the
mapping between the RPAUID, the ProSe Restricted Code and the Application ID
for the duration of the validity timer.
NOTE 5: The application client is notified of the successful discovery either
by ProSe Protocol layer in the UE or by the Application Server with procedures
out of the scope of 3GPP.
6\. The ProSe Function in HPLMN may optionally send a Match Report Info
(RPAUID, Target RPAUID, UE Identity, ProSe Restricted Code, Discovery Type) to
the ProSe Function in the HPLMN of the announcing UE. Discovery Type is set to
\"restricted discovery\". If the Monitored PLMN ID is different from that of
the Target PDUID, i.e. the \"announcing UE\" is roaming or performs inter-PLMN
discovery transmission, the ProSe Function in HPLMN of the Monitoring UE may
send another Match Report Info (RPAUID, Target RPAUID, UE Identity, ProSe
Restricted Code, Discovery Type) to the ProSe Function of the PLMN indicated
by the Monitored PLMN ID.
### 5.3.4A Discovery reporting - Model B procedures
#### 5.3.4A.1 Match report (non-roaming) - restricted discovery
Figure 5.3.4A.1-1: Match Report procedure for Model B restricted discovery
(non-roaming)
1\. When the Discoverer UE has received a ProSe Response Code over the air
that matches the Discovery Response Filter it obtained from Discoverer Request
procedure, and if the UE does not have a corresponding RPAUID associated with
it with a valid TTL, the UE sends a Match Report (RPAUID, UE Identity,
Discovery Type, Application ID, ProSe Response Code, Metadata Requested)
message to the ProSe Function in the HPLMN to get the Target RPAUID. The
RPAUID is the identifier that the Discoverer UE used to obtain the Discovery
Response Filter(s) from the Discoverer Request procedure. The UE Identity is
set to e.g. IMSI. The Application ID represents a unique identifier of the
application that triggered the Discoverer Request procedure. Discovery Type is
set to \"restricted discovery\". The ProSe Response Code is the code received
over the air.
If the monitoring UE decides that it needs to obtain the latest metadata, e.g.
when the Metadata Indicator allows metadata update, and the UE has noticed a
change of the metadata, it includes Metadata Requested in the Match Report
message.
NOTE 1: If the UE has received the Target RPAUID corresponding to the ProSe
Response Code in the Discovery Response Filter in the Discovery Response
message, the Match Report procedure may be skipped.
2\. The HPLMN ProSe Function checks the authorization for the Discoverer UE to
perform restricted discovery.
3\. The HPLMN ProSe Function analyses the ProSe Response Code and identifies
in the UE context of the Discoverer UE the corresponding Target RPAUID.
4.a Optionally, the ProSe Function sends a Auth Request (RPAUID, Target
RPAUID, Request Type) to the ProSe Application Server. The ProSe Function
locates the ProSe Application Server based on the Application ID. The Request
Type is set to \"restricted discovery/match\". If the Metadata Requested is
included in the Match Report in step 1, the ProSe Function shall send the Auth
Request message.
4.b If, based on the permission setting, the RPAUID is allowed to discover the
Target RPAUID, the ProSe Application Server returns a Auth Response (PDUID,
Target PDUID, Response Type, metadata) message. The PDUID corresponds to
RPAUID, the Target PDUID corresponds to the Target RPAUID stored in the ProSe
Application Server. The Response Type is set to \"restricted discovery/match
ack\". This message may also contain certain metadata corresponding to the
Target PDUID, e.g. welcome message, etc.
4.c The ProSe Function verifies that the returned PDUID belongs to the
requesting UE, and the Target PDUID is the same as the stored Target PDUID.
NOTE 2: The Auth Request and Auth Response messages may be extended with
additional contents depending on the configuration on the ProSe Function and
the ProSe Application Server.
NOTE 3: The Application logic triggered by the Auth Request message is out of
the scope of 3GPP.
5\. The ProSe Function in HPLMN returns a Match Report Acknowledgement
(Application ID, Target RPAUID, validity timer, metadata (optional)) message
to the UE. The UE stores the mapping between the RPAUID, the ProSe Response
Code and the Application ID for the duration of the validity timer.
NOTE 4: The application client is notified of the successful discovery either
by ProSe Protocol layer in the UE or by the Application Server with procedures
out of the scope of 3GPP.
6\. The ProSe Function in HPLMN may optionally send a Match Report Info
(RPAUID, Target RPAUID, UE Identity, ProSe Response Code, Discovery Type) to
the ProSe Function of the Discoveree UE. The Discovery Type is set to
\"restricted discovery\".
#### 5.3.4A.2 Match report (roaming/inter PLMN discovery transmission) -
restricted discovery
Figure 5.3.4A.2-1: Match Report procedure for Model B restricted discovery
(roaming)
1\. When the Discoverer UE has received a ProSe Response Code over the air
that matches a Discovery Response Filter it obtained from the Discoverer
Request procedure, and if the UE does not have a corresponding RPAUID
associated with it with a valid TTL, the UE sends a Match Report (RPAUID, UE
Identity, Discovery Type, Application ID, ProSe Response Code, Metadata
Requested, Monitored PLMN ID) message to the ProSe Function in the HPLMN to
get the Target RPAUID. The RPAUID is the identifier that the Discoverer UE
used to obtain the Discovery Response Filter from the Discoverer Request
procedure. The UE Identity is set to e.g. IMSI. The Application ID represents
a unique identifier of the application that triggered the Discoverer Request
procedure. Discovery Type is set to \"restricted discovery\". The ProSe
Response Code is the code received over the air. The Monitored PLMN ID is that
of the PLMN in which the UE monitored the ProSe Response Code.
If the monitoring UE decides that it needs to obtain the latest metadata, e.g.
when the Metadata Indicator allows metadata update, and the UE has noticed a
change of the metadata, it includes the Metadata Requested in the Match Report
message.
NOTE 1: How the Monitored PLMN ID is derived will be defined in RAN
specifications.
NOTE 2: If the UE has received the Target RPAUID corresponding to the ProSe
Response Code in the Discovery Response Filter in the Discovery Response
message, the Match Report procedure may be skipped.
2\. The HPLMN ProSe Function checks the authorization for the Discoverer UE to
perform restricted discovery.
3\. The HPLMN ProSe Function analyses the ProSe Response Code and identifies
in the UE context of the Discoverer UE the corresponding Target RPAUID.
4.a Optionally, the ProSe Function sends a Auth Request (RPAUID, Target
RPAUID, Request Type) to the ProSe Application Server. The ProSe Function
locates the ProSe Application Server based on the Application ID. The Request
Type is set to \"restricted discovery/match\". If the Metadata Requested is
included in the Match Report in step 1, the ProSe Function shall send the Auth
Request message.
4.b If, based on the permission setting, the RPAUID is allowed to discover the
Target RPAUID, the ProSe Application Server returns a Auth Response (PDUID,
Target PDUID, Response Type, metadata) message. The PDUID corresponds to
RPAUID, the Target PDUID corresponds to the Target RPAUID stored in the ProSe
Application Server. The Response Type is set to \"restricted discovery/match
ack\". This message may also contain certain metadata corresponding to the
Target PDUID, e.g. welcome message, etc.
4.c The ProSe Function verifies that the returned PDUID belongs to the
requesting UE, and the Target PDUID is the same as the stored Target PDUID.
NOTE 3: The Auth Request and Auth Response messages may be extended with
additional contents depending on the configuration on the ProSe Function and
the ProSe Application Server.
NOTE 4: The Application logic triggered by the Auth Request message is out of
the scope of 3GPP.
5\. The ProSe Function in HPLMN returns a Match Report Acknowledgement
(Application ID, Target RPAUID, validity timer, metadata (optional)) message
to the UE. The UE stores the mapping between the RPAUID, the ProSe Response
Code and the Application ID for the duration of the validity timer.
NOTE 5: The application client is notified of the successful discovery either
by ProSe Protocol layer in the UE or by the Application Server with procedures
out of the scope of 3GPP.
6\. The ProSe Function in HPLMN may optionally send a Match Report Info
(RPAUID, Target RPAUID, UE Identity, ProSe Response Code, Discovery Type) to
the ProSe Function in the HPLMN of the Discoveree UE. Discovery Type is set to
\"restricted discovery\". If the Monitored PLMN ID is different from that of
the Target PDUID, i.e. the \"announcing UE\" is roaming or performs inter-PLMN
discovery transmission, the ProSe Function in HPLMN of the Monitoring UE may
send another Match Report Info (RPAUID, Target RPAUID, UE Identity, ProSe
Restricted Code, Discovery Type) to the ProSe Function of the PLMN indicated
by the Monitored PLMN ID.
### 5.3.5 Announcing Alert Procedures - restricted discovery
#### 5.3.5.1 Announcing Alert (non-roaming)
Figure 5.3.5.1-1: Announcing Alert (non-roaming)
In non-roaming case, when the ProSe Function in the HPLMN of the announcing UE
receives a Monitor Request from a UE which is in the vicinity of the
announcing UE and detects the associated Announcing Enabled indication stored
in the announcing UE context, the ProSe Function triggers an Announcing Alert
procedure towards the announcing UE in HPLMN.
1\. The HPLMN ProSe Function informs the announcing UE with the Announcing
Alert Request (RPAUID, ProSe Restricted Code, Discovery Entry ID) message. The
RPAUID indicates what the UE is interested to announce which was obtained in
step 0 of Announce Request procedure in clauses 5.3.3.2A and 5.3.3.3A. The
Application ID represents a unique identifier of the UE application that has
triggered the transmission of the Discovery Request message. The ProSe
Restricted Code is retrieved from the announcing UE context. If restricted
Direct Discovery with application-controlled extension was requested by the
announcing UE, the ProSe Restricted Code is replaced by the ProSe Restricted
Code Prefix, and the Announcing Alert Request message also contains the ProSe
Restricted Code Suffix pool for the RPAUID retrieved from the announcing UE
context.
NOTE: How the ProSe Function in the HPLMN determines whether the announcing UE
and the monitoring UE are close enough to trigger the Announcing Alert
procedure is left to the implementation of ProSe Function.
2\. The UE responds with an Announce Alert Response message to the ProSe
Function. Upon receiving the Announce Alert Response message the ProSe
Function removes the Announcing Enabled indication associated to that ProSe
Restricted Code from the user context.
3\. The UE may start announcing the provided ProSe Restricted Code in the
serving PLMN, using the radio resources authorised and configured by E-UTRAN
to be used for ProSe as defined in RAN specifications.
#### 5.3.5.2 Announcing Alert (roaming)
Figure 5.3.5.2-1: Announcing Alert (roaming)
The UE is only allowed to announce in the carrier frequency signalled from
serving PLMN. When inter-PLMN discovery transmission is supported, the carrier
frequency may be operated by Local PLMN.
In roaming case or UE performs inter-PLMN discovery transmission, when the
ProSe Function in the HPLMN of the announcing UE receives a Monitor Request
from a UE which is in the vicinity of the announcing UE and detects the
associated Announcing Enabled indication stored in the UE context, the ProSe
Function triggers an Announcing Alert procedures towards the announcing UE in
VPLMN or Local PLMN.
1\. The HPLMN ProSe Function informs the ProSe Function in VPLMN or Local PLMN
with the Announce Authorization (RPAUID, Application ID, validity timer, ProSe
Restricted Code, UE Identity, Discovery Entry ID) message. The RPAUID and
Application ID correspond to the request from the UE, whereas the ProSe
Restricted Code indicates the assigned code for this request and retrieved
from the announcing UE context. The request shall include the UE identity
information e.g. IMSI or MSISDN and validity timer in order to allow the ProSe
Function in VPLMN or Local PLMN to perform charging. The validity timer
indicates for how long this ProSe Restricted Code is going to be valid. If the
ProSe Function in VPLMN or Local PLMN receives the same Discovery Entry ID in
a subsequent Announce Authorization message, it updates the announcing UE\'s
corresponding discovery entry replacing the existing ProSe Restricted Code and
validity timer with the last received ones.
NOTE How the ProSe Function in the HPLMN determines whether the announcing UE
and the monitoring UE are close enough to trigger the Announcing Alert
procedure is left to the implementation of ProSe Function.
2\. The ProSe Function in VPLMN or Local PLMN authorizes the UE to perform
Restricted ProSe Discovery announcing.
3\. The HPLMN ProSe Function informs the announcing UE with the Announcing
Alert Request (RPAUID, ProSe Restricted Code, Discovery Entry ID) message. The
RPAUID indicates what the UE is interested to announce which was obtained in
step 0 of Announce Request procedure in clauses 5.3.3.2A and 5.3.3.3A. The
Application ID represents a unique identifier of the UE application that has
triggered the transmission of the Discovery Request message. The ProSe
Restricted Code is retrieved from the announcing UE context. If restricted
Direct Discovery with application-controlled extension was requested by the
announcing UE, the ProSe Restricted Code is replaced by the ProSe Restricted
Code Prefix, and the Announcing Alert Request message also contains the ProSe
Restricted Code Suffix pool for the RPAUID retrieved from the announcing UE
context.
4\. The UE responds with an Announce Alert Response message to the ProSe
Function. Upon receiving the Announce Alert Response message the ProSe
Function removes the Announcing Enabled indication associated to that ProSe
Restricted Code from the user context.
5\. The UE may start announcing the provided ProSe Restricted Code in the
serving PLMN, using the radio resources authorised and configured by E-UTRAN
to be used for ProSe as defined in RAN specifications.
### 5.3.5A Void
### 5.3.6 Void
### 5.3.6A Direct Discovery Update Procedures
#### 5.3.6A.1 Discovery Update - open discovery
##### 5.3.6A.1.1 General
The ProSe Function can at any time update/revoke a previously allocated ProSe
Application Code, or Discovery Filters.
The UE can decide at any time to stop announcing a ProSe Application Code or
monitoring set of Discovery Filter(s).
##### 5.3.6A.1.2 Network-initiated discovery update procedure
Figure 5.3.6A.1.2-1: Discovery update procedure from ProSe Function
0\. The ProSe Function is triggered to update or revoke the ProSe Application
Code previously allocated to an announcing UE ,or the Discovery Filters
allocated to a monitoring UE.
1\. The ProSe Function sends a Discovery Update Request (UE Identity,
Discovery Entry ID, Update Info) message to the UE. The UE identity is set to
the IMSI of the UE. The Discovery Entry ID is set to the identifier of the
corresponding discovery entry that contains the ProSe App Code (or Discovery
Filters) to be updated or revoked. The Update Info is optional, and contains
the ProSe App Code and validity timer for an announcing UE, or Discovery
Filters for a monitoring UE. If the Update Info is included, the UE shall
replace the existing parameters with those in the Update Info. If the Update
Info is not included, the UE shall remove the ProSe App Code or Discovery
Filter(s) corresponding to the Discovery Entry ID.
2\. The UE responds with a Discovery Update Ack (Result, Discovery Entry ID)
to the ProSe Function to confirm the corresponding operation. If a ProSe
Application Code has been revoked, then the UE informs the lower layers to
take any appropriate action.
3\. If a ProSe Application Code or Discovery Filter(s) have been revoked, then
the ProSe Function removes the discovery entry indicated by the Discovery
Entry ID, and releases the associated resources
Steps 4.a-5.a are executed only when the UE is an announcing UE and is roaming
or only when UE is an announcing UE and performs inter-PLMN discovery
transmission and the ProSe Application ID announced has PLMN-specific scope
excluding the HPLMN..
4.a The HPLMN ProSe Function shall inform the ProSe Function in VPLMN or Local
PLMN with an Announce Update ((new) ProSe Application Code, UE Identity,
validity timer, Discovery Entry ID) message.
NOTE 1: The ProSe Function sets the validity timer to zero and does not
include a ProSe Application Code in the Announce Update message when it
revokes a previously allocated ProSe Application Code corresponding to a given
Discovery Entry ID.
5.a The ProSe Function in VPLMN or Local PLMN responds wtih an Announce Update
Ack message.
Alternative steps 4.b-5.b are executed only when the UE is a monitoring UE and
the ProSe Application ID monitored has PLMN-specific scope other than that of
the HPLMN.
4.b The HPLMN ProSe Function shall inform the ProSe Function(s) in the other
PLMN(s) with an Monitor Update (ProSe Application ID name, UE Identity, TTL,
Discovery Entry ID) message.
NOTE 2: The HPLMN ProSe Function sets the TTL to zero in the Monitor Update
message when it revokes the previously allocated Discovery Filter(s)
corresponding to a given Discovery Entry ID.
5.b The ProSe Function in the other PLMN responds with a Monitor Update Ack
message.
##### 5.3.6A.1.3 UE initiated discovery update procedures
##### 5.3.6A.1.3.1 Stop announce procedure {#a.1.3.1-stop-announce-procedure
.H6}
When the Announcing UE wants to stop announcing a ProSe Application Code
before the associated validity timer expires, it shall issue a Discovery
Request with the Requested Timer set to zero to enable the ProSe Function to
remove the discovery entry indicated by the Discovery Entry ID, and release
the associated resources.
Figure 5.3.6A.1.3.1-1: Stop announce request procedure
0\. The UE decides to stop announcing a ProSe Application Code before the
associated validity timer expires.
1\. The UE shall establish a secure connection with the ProSe Function in
HPLMN and shall then send a Discovery Request message identical to that of
clause 5.3.3.3 with the Discovery Entry ID that corresponds to the ProSe
Application Code the UE wants to stop announcing, and the Requested Timer set
to zero.
Steps 2-3 are executed only when the UE is roaming or only when UE performs
inter-PLMN discovery transmission and the ProSe Application ID announced has
PLMN-specific scope excluding the HPLMN.
2\. The HPLMN ProSe Function shall inform the ProSe Function in VPLMN or Local
PLMN that a previously allocated ProSe Application Code, corresponding to a
given Discovery Entry ID, is no longer being announced with an Announce Update
(UE Identity, validity timer, Discovery Entry ID) message that does not
include a ProSe Application Code and with the validity timer set to zero.
3\. The ProSe Function in VPLMN or Local PLMN responds with an Announce Update
Ack message.
4\. The ProSe Function removes the discovery entry indicated by the Discovery
Entry ID, and releases the associated resources.
5\. The ProSe Function in HPLMN shall respond to the UE with a Discovery
Response (Discovery Entry ID) message containing only the Discovery Entry ID.
6\. The UE removes and stops announcing the ProSe App Code corresponding to
the Discovery Entry ID, and informs the lower layers to take any appropriate
action.
##### 5.3.6A.1.3.2 Stop monitor procedure {#a.1.3.2-stop-monitor-procedure
.H6}
When the Monitoring UE wants to stop monitoring before the expiration of the
TTLs for the Discovery Filter(s) in a discovery entry it shall issue a
Discovery Request with the Requested Timer set to zero to enable the ProSe
Function to remove the discovery entry indicated by the Discovery Entry ID,
and release the associated resources.
Figure 5.3.6A.1.3.2-1: Stop monitor request procedure
0\. The UE decides to stop monitoring before the expiration of the TTL(s) of
the Discovery Filter(s) of a certain Discovery Entry.
1\. The UE shall establish a secure connection with the ProSe Function in
HPLMN and shall then send a Discovery Request message identical to that of
clause 5.3.3.4 or 5.3.3.5, with the Discovery Entry ID that corresponds to the
Discovery Filter(s) the UE wants to stop using for monitoring, and the
Requested Timer set to zero.
Steps 2-3 are executed only when the ProSe Application ID of the Discovery
Entry has PLMN-specific scope other than that of the HPLMN.
2\. The HPLMN ProSe Function shall inform the ProSe Function in the other PLMN
that the ProSe Application ID name, corresponding to a given Discovery Entry
ID, is no longer being monitored for this UE with a Monitor Update (ProSe
Application ID name, UE Identity, TTL, Discovery Entry ID) message where the
TTL is set to zero.
3\. The ProSe Function in the other PLMN responds with a Monitor Update Ack
message.
4\. The ProSe Function removes the discovery entry indicated by the Discovery
Entry ID and releases the associated resources.
5\. The ProSe Function in the HPLMN shall respond to the UE with a Discovery
Response (Discovery Entry ID) message containing only the Discovery Entry ID.
6\. The UE removes and stops using for monitoring the Discovery Filter(s)
corresponding to the Discovery Entry ID.
#### 5.3.6A.2 Discovery Authorization Update - restricted discovery
##### 5.3.6A.2.1 General
A user may decide at any time to change the discovery permissions relating to
other users in a ProSe Application Server.
For example user A, while announcing the ProSe Restricted Code for a given
Application ID, may revoke the permission to be discovered by users B and C.
However, changes in the discovery permissions will not be effective until the
validity timer associated to the corresponding ProSe Restricted Code expires.
In order to avoid such a delay, the procedure in clause 5.3.6A.2.2 is
triggered by the ProSe Application Server towards the ProSe Function serving
user A.
NOTE: If users A and C are de-authorised to discover each other in a given
application, the corresponding ProSe Application Server triggers the procedure
in clause 5.3.6A.2.2 or that in clause 5.3.6A.2.3 towards the affected ProSe
Functions, e.g. those of user A and user C.
##### 5.3.6A.2.2 Revocation of Discovery Filters
Figure 5.3.6A.2.2-1: Revocation of Discovery Filters for restricted discovery
(roaming or non-roaming)
0\. User A, while announcing the ProSe Restricted Code for a given Application
ID, revokes discovery permissions relating to some other users in the ProSe
Application Server.
1\. The ProSe Application Server sends to the ProSe Function serving user A
(identified by checking the PDUID of user A) an Authorization Update (RPAUID,
Request Type, N sets of Banned RPAUID - Banned PDUID) message. ProSe Function
identifies user A based on the RPAUID and the Application ID associated with
the ProSe Application Server. The Request Type is set to \"restricted
discovery/monitor nack\". The N sets of Banned RPAUID - Banned PDUID are those
that are no longer allowed to discover the ProSe Restricted Code corresponding
to user A\'s RPAUID for the Application ID associated with that ProSe
Application Server.
2\. The ProSe Function serving user A acknowledges the Authorization Update
message.
3\. The ProSe Function serving user A analyses the received N sets of Banned
RPAUID - Banned PDUID.
Steps 4 - 5 are executed only for the (sub)set of Banned PDUIDs whose PLMN ID
is the same PLMN ID of the PDUID associated with the RPAUID of user A (e.g. UE
of user B).
4\. If the ProSe Function serving user A has previously allocated to a Banned
RPAUID - Banned ProSe Discovery UE (e.g. user B) a Discovery Filter for
monitoring the ProSe Restricted Code corresponding to the RPAUID and
Application ID of user A, then the ProSe Function shall send a Discovery
Update Request (UE Identity, Discovery Entry ID, Update Info) message to that
UE (e.g. UE of user B). The UE identity is set to the IMSI of the UE. The
Discovery Entry ID is set to the identifier of the corresponding Discovery
Entry that contains the Discovery Filter to be revoked. The Update Info is
optional and contains Discovery Filter(s) to replace the existing one(s), if
the ProSe Function decides to remove only certain filter(s) and not others. If
the Update Info is not included, the UE shall remove all the Discovery Filters
corresponding to the Discovery Entry ID.
5\. The UE locates each Discovery Filter to be revoked, associated with the
Discovery Entry ID, removes it from the ProSe Discovery services operation and
sends back to the ProSe Function a Discovery Update Ack (Result, Discovery
Entry ID) message to confirm the corresponding operation.
Steps 6 - 11 are executed only for the (sub)set of Banned PDUIDs whose PLMN ID
is different from the PLMN ID of the PDUID associated with the RPAUID of user
A (e.g. UE of user C).
6\. If the ProSe Function serving user A has previously answered to a Monitor
Request coming from a ProSe Function in the PLMN of a Banned PDUID, related to
a Banned RPAUID (e.g. user C), then the ProSe Function serving user A sends to
that ProSe Function a Monitor Update (ProSe Restricted Code, Application ID,
Banned RPAUID, Banned PDUID) message. The ProSe Restricted Code is the code
the UE of user A is announcing and for which is requested the revocation of
the corresponding Discovery Filter. The Banned RPAUID and Banned PDUID
identify the UE that is using the Discovery Filter to be revoked (e.g. UE of
user C).
7\. The ProSe Function in the other PLMN acknowledges the Monitor Update
message.
8\. Upon receiving the ProSe Function a Monitor Update, the ProSe Function in
the other PLMN shall send a Discovery Update Request (UE Identity, Discovery
Entry ID, Update Info) message to that UE (e.g. UE of user C). The UE identity
is set to IMSI of the UE. The Discovery Entry ID is set to the identifier of
the corresponding Discovery Entry that contains the Discovery Filter to be
revoked. The Update Info is optional and contains Discovery Filter(s) to
replace the existing one(s), if the ProSe Function decides to remove only
certain filter(s) and not others. If the Update Info is not included, the UE
shall remove all the Discovery Filters corresponding to the Discovery Entry
ID.
9\. The UE locates each Discovery Filter to be revoked, associated with the
Discovery Entry ID, removes it from the ProSe Discovery services operation and
sends back to the ProSe Function a Discovery Update Ack (Result, Discovery
Entry ID) message to confirm the corresponding operation.
10\. After a time configured by the operator the ProSe Function in the other
PLMN sends a Monitor Update Result (ProSe Restricted Code, Application ID,
Banned RPAUID, Banned ProSe Discovery UE ID, Result) message to the ProSe
Function serving user A to report the result of the corresponding operation.
11\. The ProSe Function serving user A acknowledges the Monitor Update Result
message.
12\. After a time configured by the operator, the ProSe Function serving user
A sends an Authorization Update Result (RPAUID, Request Type, N sets of Banned
RPAUID - Banned PDUID with Result) message to the ProSe Application Server.
The sets Banned RPAUID - Banned PDUID are those received from the ProSe
Application Server in step 1. For each set, the Result indicates whether the
permission to discover the ProSe Restricted Code corresponding to user A
RPAUID for the Application ID specific of that ProSe Application Server has
been successfully revoked or not.
13\. The ProSe Application Server acknowledges the Authorization Update Result
message.
##### 5.3.6A.2.3 Allocation of a new ProSe Restricted Code and update of
Discovery Filters
Based on local policies the ProSe Function serving user A may decide that in
certain scenarios it is more convenient to allocate a new ProSe Restricted
Code to the user A and provide new corresponding Discovery Filters to the
monitoring UEs that are still allowed to perform discovery of user A (e.g. UE
of user D), rather than revoking the Discovery Filters from the monitoring UEs
whose discovery permissions for user A have been revoked.
In such case the procedure is executed as shown in Figure 5.3.6A.2.3-1.
Figure 5.3.6A.2.3-1: Allocation of a new ProSe Restricted Code and update of
Discovery Filters
Steps 0 - 3 are the same as in clause 5.3.6A.2.2.
4\. As step 3 in clause 5.3.3.2A and 5.3.3.3A with the following change: the
ProSe Function stores the new ProSe Restricted Code and the associated
validity timer in the user context and removes the old ProSe Restricted Code.
Steps 5 and 6 are executed only when the UE of user A is roaming.
5\. As step 4 in clause 5.3.3.3A.
6\. As step 5 in clause 5.3.3.3A.
7\. The ProSe Function serving user A sends a Discovery Update Request (UE
Identity, Discovery Entry ID, Update Info) message to the UE of user A. The UE
identity is set to IMSI of the UE. The Discovery Entry ID is set to the
identifier of the corresponding Discovery Entry that contains the ProSe
Restricted Code to be replaced. The Update Info contains the new ProSe
Restricted Code and the associated validity timer that should be used.
8\. The UE locates the ProSe Restricted Code to be replaced, associated with
the Discovery Entry ID, replaces it and sends back to the ProSe Function a
Discovery Update Ack (Result, Discovery Entry ID) message to confirm the
corresponding operation.
9\. If the Discovery Filters for monitoring the ProSe Restricted Code
corresponding to the RPAUID and Application ID of user A has been previously
allocated to a Target RPAUID - Target ProSe Disc UE still allowed to discover
user A (e.g. user D), then those monitoring UEs are updated as described in
figure 5.3.6A.2.2-1, with the following changes: the newly allocated ProSe
Restricted Code and validity timer are additionally delivered to the ProSe
Function(s) serving the monitoring UEs (e.g. user D) by the Monitor Update
message, and are used by the ProSe Function(s) to build the new Discovery
Filters that were conveyed in the Update Info information element of the
Discovery Update Request messages, and are used by the monitoring UEs to
replace the old Discovery Filters. The ProSe Application Server is finally
updated with the results of the overall procedure.
### 5.3.7 Direct Discovery for Public Safety use
#### 5.3.7.1 General
The following functions for public safety direct discovery are supported:
\- UE-to-Network Relay Discovery.
\- Determination is needed regarding within the ProSe Communication which
user(s) are in ProSe Communication range at any given time (shortly referred
to as \"Group Member Discovery\").
Group Member Discovery is a form of restricted discovery type in that only
users that are affiliated with each other are able to discover each other
(e.g. only users sharing the same Discovery Group ID).The parameters for Group
Member Discovery, as well as the overall procedure, are different from the
restricted discovery for non-Public Safety use.
UE-to-Network Relay Discovery involves the use of pre-provisioned parameters
to first discover a UE-to-Network Relay, and a subsequent communication link
establishment. This makes the overall discovery procedure as restricted type,
in that only Remote UEs with valid credentials and some form of pre-
affiliation are able to successfully complete the overall procedure.
Public Safety discovery for ProSe UE-to-Network Relay Discovery and Group
Member Discovery uses the PC5-D protocol stack that is depicted in Figure
5.1.1.5-1.
In the case of Direct Discovery for Public Safety (i.e. UE-to-Network Relay
Discovery and Group Member Discovery), the ProSe Restricted Code is not used,
and UEs use pre-configured or provisioned information for the Discovery
procedures as defined in clause 4.5.1.1.2.3.2 and clause 4.5.1.1.2.3.4.
Additional information not directly used for discovery can be also advertised
using the PC5-D protocol stack, like relayed TMGIs, the ECGI of the service
cell, in single or separate discovery messages of type \"Relay Discovery
Additional Information\".
Both Model A and Model B discovery are supported:
\- Model A uses a single discovery protocol message (Announcement).
\- Model B uses two discovery protocol messages (Solicitation and Response).
For Relay Discovery Additional Information, only Model A discovery is used.
Depicted in Figure 5.3.7.1-1 is the procedure for public safety direct
discovery with Model A.
Figure 5.3.7.1-1: Public safety direct discovery with Model A
For UE-to-Network Relay Discovery:
1\. The ProSe UE-to-Network Relay sends a UE-to-Network Relay Discovery
Announcement message. The parameters contained in this message are described
in clause 4.6.4.3.
For Group Member Discovery:
1\. The announcing UE sends a Group Member Discovery Announcement message. The
parameters contained in this message are described in clause 4.6.4.9.
NOTE: A UE may send multiple Group Member Discovery Announcement messages
(Model A) if the UE belongs to more than one discovery group.
For Relay Discovery Additional Information:
1\. The ProSe UE-to-Network Relay sends a Relay Discovery Additional
Information message. The parameters contained in this message are described in
clause 4.6.4.10.
Depicted in Figure 5.3.7.1-2 is the procedure for public safety direct
discovery with Model B.
Figure 5.3.7.1-2: Public safety direct discovery with Model B
For UE-to-Network Relay Discovery:
1\. The Remote UE sends a UE-to-Network Relay Discovery Solicitation message.
The parameters contained in this message are described in clause 4.6.4.3.
2\. The ProSe UE-to-Network Relays that match the values of the Relay Service
Code contained in the solicitation message respond to the Remote UE with a UE-
to-Network Relay Discovery Response message. The parameters contained in this
message are described in clause 4.6.4.3.
For Group Member Discovery:
1\. The discoverer UE sends a Group Member Discovery Solicitation message. The
parameters contained in this message are described in clause 4.6.4.9.
2\. The discoveree UEs that match the values of the parameters contained in
the solicitation message based on the Discovery Group ID, respond to the
discoverer UE with a Group Member Discovery Response message. The parameters
contained in this message are described in clause 4.6.4.9.
## 5.4 Procedures for ProSe Direct Communication
### 5.4.1 One-to-many ProSe Direct Communication general
One-to-many ProSe Direct Communication is applicable only to ProSe-enabled
Public Safety UEs and when authorised, can apply when the UE is served by
E-UTRAN and when the UE is outside of E-UTRA coverage.
One-to-many ProSe Direct Communication has the following characteristics:
\- One-to-many ProSe Direct Communication is connectionless. Thus there is no
signalling over PC5 control plane.
\- The radio layer provides a user plane communication service for
transmission of IP packets between UEs engaged in direct communication.
\- Members of a group share a secret from which a group security key may be
derived to encrypt all user data for that group.
\- Authorisation for one-to-many ProSe Direct Communication is configured in
the UE by the ProSe Function using PC3 reference point.
\- ProSe UE configuration parameters (e.g. including ProSe Group IP multicast
addresses, ProSe Group IDs, Group security material, radio related parameters)
are configured in the UE.
### 5.4.2 One-to-many ProSe Direct Communication transmission
This procedure is applicable to authorized ProSe-enabled Public Safety UEs.
Figure 5.4.2-1: One-to-many ProSe Direct Communication transmission
1\. UE is configured with the related information for one-to-many ProSe Direct
Communication as defined in clause 4.5.1.1.2.3.3. The UE obtains the necessary
group context (ProSe Layer-2 Group ID, ProSe Group IP multicast address) to
transmit IP-layer transport of data, and also the radio resource related
parameters used for the Direct Communication.
2\. The originating UE finds the appropriate radio resource to conduct one-to-
many ProSe Direct Communication as specified in clause 4.5.1.1.2.3.1.
The protocol data unit passed for transmission to the Access Stratum is
associated with:
\- a Layer-3 protocol data unit type. In this release of the specification the
following Layer-3 protocol data types are supported for one-to-many ProSe
Direct Communication: IP and Address Resolution Protocol (see RFC 826 [28]).
\- the corresponding Source Layer-2 ID and Destination Layer-2 ID. The Source
Layer-2 ID is set to the ProSe UE ID assigned from the ProSe Key Management
Function. The Destination Layer-2 ID is set to the ProSe Layer-2 Group ID.
\- the ProSe Per-Packet Priority associated with the protocol data unit.
NOTE: More details about step 2 to be defined in RAN specifications.
3\. The originating UE sends the IP data to the IP multicast address using the
ProSe Layer-2 Group ID as Destination Layer-2 ID.
### 5.4.3 One-to-many ProSe Direct Communication reception
This procedure is only applicable to authorized ProSe-enabled Public Safety
UEs.
Figure 5.4.3-1: One-to-many Direct Communication reception
1\. UE is configured with the related information for one-to-many ProSe Direct
Communication as defined in clause 4.5.1.1.2.3.3. The UE obtains the necessary
group context (ProSe Layer-2 Group ID, Group IP multicast address) to receive
IP-layer transport of data, and also the radio resource related parameters
used for the Direct Communication.
2\. The receiving UE listens to the allocated radio resource to receive one-
to-many ProSe Direct Communication.
NOTE: More details about step 2 to be defined in RAN specifications.
3\. The receiving UE filters out the received frames based on the ProSe
Layer-2 Group ID contained in the Destination Layer-2 ID and if it matches one
of the configured Group IDs, it delivers the enclosed packet to the upper
layers. The IP stack filters the received packets based on the Group IP
multicast address.
The protocol data unit passed to the upper layers is associated with a Layer-3
protocol data unit type. In this release of the specification the following
Layer-3 protocol data types are supported for one-to-many ProSe Direct
Communication: IP and Address Resolution Protocol (see RFC 826 [28]).
### 5.4.4 Direct communication via ProSe UE-to-Network Relay
#### 5.4.4.1 General
A ProSe UE-to-Network Relay capable UE may attach to the network (if it is not
already connected) and connect to a PDN connection enabling the necessary
relay traffic, or it may need to connect to additional PDN connection(s) in
order to provide relay traffic towards Remote UE(s). PDN connection(s)
supporting UE-to-Network Relay shall only be used for Remote ProSe UE(s) relay
traffic.
Figure 5.4.4.1-1: ProSe UE-to-Network Relay
1\. The ProSe UE-to-Network Relay performs initial E-UTRAN Attach (if not
already attached) and/or establishes a PDN connection for relaying (if no
appropriate PDN connection for this relaying exists). In case of IPv6, the
ProSe UE-to-Network Relay obtains the IPv6 prefix via prefix delegation
function from the network as defined in TS 23.401 [5].
2\. The Remote UE performs discovery of a ProSe UE-to-Network Relay using
Model A or Model B discovery. The details of this procedure are described in
clause 5.3.7.
3\. The Remote UE selects a ProSe UE-to-Network Relay and establishes a
connection for One-to-one ProSe Direct Communication. If there is no PDN
connection associated with the ProSe Relay UE ID or an additional PDN
connection for relaying is needed, the ProSe UE-to-Network Relay initiates a
new PDN connection establishment procedure for relaying. The details of this
procedure are described in clause 5.4.5.
4\. IPv6 prefix or IPv4 address is allocated for the remote UE as it is
specified in 5.4.4.2 and 5.4.4.3. From this point the uplink and downlink
relaying can start.
5\. The ProSe UE-to-Network Relay sends a Remote UE Report (Remote User ID, IP
info) message to the MME for the PDN connection associated with the relay. The
Remote User ID is an identity of the Remote UE user (provided via User Info)
that was successfully connected in step 3. The MME stores the Remote User IDs
and the related IP info in the ProSe UE-to-Network Relay\'s EPS bearer context
defined in TS 23.401 [5] for the PDN connection associated with the relay.
6\. The MME forwards the Remote UE Report message to the S-GW and S-GW
forwards the message to the P-GW of the UE-to-Network Relay UE. The MME may
report multiple Remote UEs in one Remote UE Report message.
For IP info the following principles apply:
\- for IPv4, the UE-to-network Relay shall report TCP/UDP port ranges assigned
to individual Remote UE(s) (along with the Remote User ID);
\- for IPv6, the UE-to-network Relay shall report IPv6 prefix(es) assigned to
individual Remote UE(s) (along with the Remote User ID).
NOTE 1: It is up to Stage 3 to select appropriate NAS procedure/GTPv2 protocol
enhancement to be used for the Remote UE Report message.
The Remote UE Report message shall be sent when the Remote UE disconnects from
the ProSe UE-to-Network Relay (e.g. upon explicit layer-2 link release or
based on the absence of keep alive messages over PC5) to inform the MME and
the S-GW and the P-GW that the Remote UE(s) have left.
In the case of Tracking Area Update involving MME change the Remote User IDs
and related IP info corresponding to the connected Remote UEs are transferred
to the new MME as part of the EPS bearer context transfer for the ProSe UE-to-
Network Relay.
NOTE 2: In order for the P-GW to have the Remote UE(s) information, the HPLMN
and the VPLMN where the ProSe UE-to-Network Relay is authorised to operate,
needs to support the transfer of the Remote UE related parameters in case the
P-GW is in the HPLMN.
NOTE 3: The connection of a new Remote UE most probably require the creation
and/or modification of additional dedicated bearers for the PDN connection
used for relaying.
NOTE 4: When Remote UE(s) disconnect from the ProSe UE-to-Network Relay, it is
up to implementation how relaying bearers are cleared/disconnected by the
ProSe UE-to-Network Relay.
After being connected to the ProSe UE-to-Network Relay, the Remote UE keeps
performing the measurement of the signal strength of the discovery message
sent by the ProSe UE-to-Network Relay (i.e. the UE-to-Network Relay Discovery
Announcement message in Model A or a UE-to-Network Relay Discovery Response
message in Model B) for relay reselection as defined in TS 36.300 [17]. For
Model B, to measure the PC5 link quality, the Remote UE sends a UE-to-Network
Relay Discovery Solicitation message periodically. The message may contain a
ProSe Relay UE ID of its serving ProSe UE-to-Network Relay. If the ProSe Relay
UE ID is included in the message, then only the ProSe UE-to-Network Relay,
which owns this ProSe Relay UE ID, shall respond to the UE-to-Network Relay
Discovery Solicitation message.
#### 5.4.4.2 IPv6 Stateless Address auto-configuration
After the establishment the One-to-one ProSe Direct Communication the Remote
UE may initiate the allocation of an IPv6 prefix as follows.
Figure 5.4.4.2-1: IPv6 prefix allocation using ProSe UE-to-Network Relay
1\. If the Remote UE is configured to perform IPv6 Stateless Address auto-
configuration, the Remote UE shall send a Router Solicitation message in order
to solicit a Router Advertisement message as specified in IETF RFC 4862 [6].
The message is sent using as Destination Layer-2 Address the ProSe Relay UE ID
of the ProSe UE-to-Network Relay discovered during the establishment the One-
to-one ProSe Direct Communication.
2\. Upon receiving the Router Solicitation message from the UE the ProSe UE-
to-Network Relay shall send an IPv6 Router Advertisement message as specified
in IETF RFC 4862 [6] to the Remote UE. The ProSe UE-to-Network Relay acts as
an advertising interface as specified in IETF RFC 4861 [10]. The Router
Advertisement messages shall contain the assigned IPv6 prefix. The ProSe UE-
to-Network Relay shall obtain the IPv6 prefix assigned to the Remote UE via
prefix delegation function from the network as defined in TS 23.401 [5] before
sending the IPv6 prefix to the Remote UE. After the Remote UE receives the
Router Advertisement message, it constructs a full IPv6 address via IPv6
Stateless Address auto-configuration in accordance with IETF RFC 4862 [6].
However, the Remote UE shall not use any identifiers defined in TS 23.003 [12]
as the basis for generating the interface identifier. For privacy, the Remote
UE may change the interface identifier used to generate the full IPv6 address,
as defined in TS 23.221 [11] without involving the network. The Remote UE
shall use the auto-configured IPv6 address while sending packets in this
implicitly created PDN connection.
#### 5.4.4.3 IPv4 Address allocation using DHCPv4
After the establishment the One-to-one ProSe Direct Communication the Remote
UE may initiate the allocation of an IPv4 address as follows.
Figure 5.4.4.3-1: IPv4 address allocation using ProSe UE-to-Network Relay
1\. If the Remote UE is configured to use IPv4, the Remote UE shall send
DHCPv4 Discovery message. The message shall be sent using as Destination
Layer-2 Address the ProSe Relay UE ID of the ProSe UE-to-Network Relay
discovered during the establishment the One-to-one ProSe Direct Communication.
2\. The ProSe UE-to-Network Relay acting as a DHCPv4 Server sends the DHCPv4
Offer with the assigned Remote UE IPv4 address. The IPv4 address provided to
the Remote UE from the ProSe UE-to-Network Relay shall correspond to a local
IPv4 address range configured in the ProSe UE-to-Network Relay.
3\. When the Remote UE receives the lease offer, it sends a DHCP REQUEST
message containing the received IPv4 address.
4\. The ProSe UE-to-Network Relay acting as DHCPv4 server sends a DHCPACK
message to the Remote UE. This message includes the lease duration and any
other configuration information that the client might have requested.
On receiving the DHCPACK message, the Remote UE completes the TCP/IP
configuration process.
NOTE: The DHCPv4 client may skip the DHCPv4 Discovery phase, and send DHCPv4
Request message in broadcast as the first message in accordance with the
DHCPv4 renewal process.
After the UE releases the IPv4 address using DHCPv4 or the IPv4 address lease
time expires, the same IPv4 address shall not be allocated to another Remote
UE immediately by the ProSe UE-to-Network Relay.
#### 5.4.4.4 TMGI advertisement and eMBMS traffic relay
The following procedure illustrated in Figure 5.4.4.4-1 is used by a ProSe-
enabled Public safety UE to request a ProSe UE-to-Network Relay to start
monitoring a specific TMGI availability and that the ProSe UE-to-Network Relay
broadcasts this TMGI and its corresponding ProSe Layer-2 Group ID by using
Relay Discovery Additional Information sent on the discovery transport, when
it is detected on the MCCH of the serving cell. The eMBMS traffic related to
this TMGI, if available, is also forwarded to the remote UE\'s served by the
relay over a one-to-many link identified by a specific ProSe Layer-2 Group ID
provided by the Relay when the procedure is executed.
Figure 5.4.4.4-1: TMGI monitoring request procedure
1\. The UE has successfully discovered the ProSe UE-to-Network Relay and has
obtained (perhaps after a one to one communication sessions with the relay)
from a Group communication application the related service description that
contains the TMGI, QCI, radio frequencies, and MBMS SAIs the UE should use to
receive related eMBMS content. This interaction can happen before or after the
UE has joined the relay. The application layer in the UE sets the ProSe Per-
Packet Priority associated with the TMGI.
2\. The UE sends to the ProSe UE-to-Network Relay a TMGI Monitoring Request
(TMGI, MBMS SAIs, ProSe Per-Packet Priority) where the TMGI value, MBMS SAIs
and ProSe Per-Packet Priority are obtained at step 1.
NOTE 1: The UE sends to the ProSe UE-to-Network Relay a TMGI Monitoring
Request message even if it has already known the ProSe Layer-2 Group ID for
the corresponding TMGI.
3\. The ProSe UE-to-Network Relay retrieves the list of MBMS SAIs from the
system information of the cell camped on as specified in TS 36.331 [33] and
checks whether at least one of the MBMS SAIs obtained at step 2 is included in
the MBMS SAI list.
4\. If the ProSe UE-to-Network Relay detects at least one of the request MBMS
SAIs, the ProSe UE-to-Network Relay acknowledges the request with a TMGI
Monitoring Response ( ProSe Layer 2 Group ID, TMGI_Monitoring_Refresh Timer,
SAI indicator = true). The ProSe Layer 2 Group ID is used to forward to Remote
UEs the eMBMS content related to the TMGI value received at step 2. The
TMGI_Monitoring_Refresh Timer (configurable in the ProSe UE-to-Network Relay)
is provided to the UE so that when this timer elapses the UE shall execute the
TMGI monitoring request procedure if it still needs to monitor the TMGI. If a
UE does not execute the TMGI Monitoring Request procedure when this
TMGI_Monitoring_Refresh Timer expires in the UE and no other UE executes the
refresh procedure for this TMGI, then when the TMGI_Monitoring_Refresh Timer
for the TMGI expires in the relay, the relay shall stop monitoring the TMGI
and also to forward any related content if it was doing so. If the ProSe UE-
to-Network Relay is not in the coverage of any requested SAIs, the SAI
indicator is set to false and the ProSe UE-to-Network Relay remains monitoring
the TMGI until the TMGI_Monitoring_Refresh Timer expires. It is assumed that
bearer level security is not applied to PC5 ProSe one-to-may link for MBMS
traffic relay.
5\. The ProSe UE-to-Network Relay detects the TMGI it has been requested to
monitor.
NOTE 2: The action applicable when the UE is unable to simultaneously receive
eMBMS and unicast services (e.g. eMBMS and unicast services use different
frequencies) is up to UE implementation.
6\. Upon detection of the TMGI, the ProSe UE-to-Network Relay broadcasts
availability of the TMGI and the corresponding ProSe Layer 2 Group ID by
sending a Relay Discovery Additional Information Message (TMGI, ProSe Layer 2
Group ID) as defined in clause 4.6.4.10. This is repeated with a configurable
(in the ProSe UE to Network Relay) repetition interval which should normally
be smaller than the TMGI_Monitoring_Refresh Timer. The value of the TMGI may
be used by devices discovering the UE-to-Network Relay as a preference
criterion for Relay selection, if they are interested in the TMGI the relay is
advertising.
7\. The UE detects the announcement of step 6 and subsequently starts to
receive the broadcast content on the PC5 ProSe one-to-many link associated to
the Prose Layer-2 Group ID defined at step 4, and may request to release
unicast distribution leg if any was being used. The ProSe UE-to-Network Relay
applies the received ProSe Per-Packet Priority value in step 2 to transmit the
eMBMS traffic over the PC5 interface. For a given TMGI, if different ProSe
Per-Packet Priority values are received from different UEs, the ProSe Per-
Packet Priority that the UE-to-Network Relay determines to use for
transmitting the eMBMS data associated with the TMGI is up to UE
implementation.
NOTE 3: The UE belonging to an announced TMGI may receive the relayed eMBMS
traffic via ProSe Layer-2 Group ID even if the UE does not yet complete the
TMGI monitoring request/response procedure.
8\. Upon detection of loss of TMGI, the ProSe UE-to-Network Relay stops
broadcasting availability of the TMGI. Optionally, it also sends a positive
indication of loss of TMGI so as to accelerate loss of TMGI detection in the
UE (not shown in the procedure). The UE may request a unicast distribution leg
from the GCS AS.
9\. The UE stops receiving the broadcast content on the PC5 ProSe one-to-many
link associated to the Prose Layer Group-2 ID defined at step 4.
NOTE 4: The relative ordering between step 8 and 9 may be dependent on when
the eMBMS content becomes unavailable in the cell.
#### 5.4.4.5 Cell ID announcement procedure
The following procedure outlined in figure 5.4.4.5-1 allows an authorized
ProSe-enabled Public safety UE, based on application requirements outside the
scope of the present procedure, to request a ProSe UE-to-Network Relay to
announce the EUTRAN Cell Global ID (ECGI) of the Cell serving the ProSe UE-to-
Network Relay.
Figure 5.4.4.5-1: Cell ID announcement request procedure
1) A UE has discovered a ProSe UE-to-Network relay and an application requires
serving cell ECGI reporting even when it is behind a relay (i.e. the
application benefits from this value even if it is the value of the cell
serving the relay and not the UE directly).
2) The UE sends to the ProSe UE-to-Network relay a Cell ID Announcement
Request() to support the needs of such application
3) The ProSe UE-to-Network relay acknowledges receipt of the request in step 2
with a Cell ID Announcement Request (ECGI_Announcement_Request_Refresh Timer).
The ECGI_Announcement_Request_Refresh Timer, (configurable in the ProSe UE to
network relay) is provided to the UE so that when this timer elapses the UE
shall repeat the Cell ID Announcement Request procedure if it still needs
obtain the ECGI. If a UE does not execute the Cell ID Announcement Request
procedure when this ECGI_Announcement_Request_Refresh Timer expires and no
other UE request ECGI announcement before the
ECGI_Announcement_Request_Refresh timer expires in the UE-to-Network relay,
then the relay shall stop announcing the ECGI of the serving cell.
4) The ProSe UE-to-Network Relay announces the ECGI of the serving cell by
sending Relay Discovery Additional Information Message (ECGI) as defined in
clause 4.6.4.10. This is repeated periodically with a configurable frequency
(normally Higher than the one related to the ECGI_Announcement_Request_Refresh
Timer) until there is no UE requesting to announce the ECGI as determined by
the ECGI_Announcement_Request_Refresh Timer running in the ProSe UE-to-Network
relay.
5) The ProSe UE-to-Network Relay may at any time detect the ECGI of a new
serving cell it is happening to be camping on
6) Step 5 triggers the ProSe UE-to-Network Relay to announce the ECGI of the
serving cell by sending a Relay Discovery Additional Information Message
(ECGI) immediately and repeat it periodically with a configurable frequency as
in step 4 until there is no UE requesting to announce the ECGI as determined
by the ECGI_Announcement_Request_Refresh Timer running in the ProSe UE-to-
Network relay.
### 5.4.5 One-to-one ProSe Direct Communication
#### 5.4.5.1 General
One-to-one ProSe Direct Communication is realised by establishing a secure
layer-2 link over PC5 between two UEs.
Each UE has a Layer-2 ID for unicast communication that is included in the
Source Layer-2 ID field of every frame that it sends on the layer-2 link and
in the Destination Layer-2 ID of every frame that it receives on the layer-2
link.
NOTE: Conflicts between Destination Layer-2 ID for unicast and one-to-many
communication will be resolved by RAN WG2.
The UE needs to ensure that the Layer-2 ID for unicast communication is at
least locally unique. To that effect the UE should be prepared to handle
Layer-2 ID conflicts with adjacent UEs using unspecified mechanisms (e.g.
self-assign a new Layer-2 ID for unicast communication when a conflict is
detected).
The layer-2 link for one-to-one ProSe Direct Communication is identified by
the combination of the Layer-2 IDs of the two UEs. This means that the UE can
engage in multiple layer-2 links for one-to-one ProSe Direct Communication
using the same Layer-2 ID.
#### 5.4.5.2 Establishment of secure layer-2 link over PC5
Depicted in figure 5.4.5.2-1 is the procedure for establishment of secure
layer-2 link over PC5.
UEs engaged in isolated (non-relay) one to one communication negotiate IP
address allocation mechanisms and optionally exchange link-local IPv6
addresses if needed during the link establishment procedure.
Figure 5.4.5.2-1: Establishment of secure layer-2 link over PC5
1\. UE-1 sends a Direct Communication Request message to UE-2 in order to
trigger mutual authentication. This message includes the User Info.
If the link is setup for isolated one-to-one communication (none of the UEs is
a relay), UE-1 shall indicate in the message whether it can act as a DHCPv4
server, IPv6 router, or both. If UE-1 does not support any of the IP address
allocation mechanisms, it shall include a link-local IPv6 address in the
message.
NOTE 1: The link initiator (UE-1) needs to know the Layer-2 ID of the peer
(UE-2) in order to perform step 1. As an example, the link initiator can learn
the Layer-2 ID of the peer by executing a discovery procedure first or by
having participated in one-to-many ProSe Direct Communication including the
peer.
2\. UE-2 initiates the procedure for mutual authentication. The successful
completion of the authentication procedure completes the establishment of the
secure layer-2 link over PC5. As part of this step, UE-2 includes the User
Info in a response to UE-1.
If the link is setup for isolated one-to-one communication (none of the UEs is
a relay), UE-2 shall indicate to UE-1 in the response message whether it can
act as a DHCPv4 server, IPv6 router, or both. If UE-2 does not support any of
the IP address allocation mechanisms and UE-1 included a link-local IPv6
address in step 1, UE-2 shall include a non-conflicting link-local IPv6
address in the response message.
If both UE-1 and UE-2 selected to use link-local IPv6 address, they shall
disable the duplicate address detection defined in RFC 4862 [6].
NOTE 2: When either UE-1 or UE-2 indicates the support of DHCPv4 or IPv6
router, corresponding address configuration procedure would be carried out
after the establishment of the layer 2 link, and the link-local IPv6 addresses
are ignored.
NOTE 3: In order to use link-local IPv6 addresses the applications using
isolated one-to-one ProSe Direct Communication use application layer
identifiers that are compatible with Multicast DNS as specified in RFC 6762
[34]. In order to make use of the mDNS, the upper layer need to be aware of
the use of link-local address over the L2 link, as the FQDN used for it would
be different.
#### 5.4.5.3 Layer-2 link maintenance over PC5
The PC5 Signalling Protocol shall support keep-alive functionality that is
used to detect that when the UEs are not in ProSe Communication range, so that
they can proceed with implicit layer-2 link release.
NOTE: It is left to Stage 3 to determine how and when the keep-alive messages
are used.
#### 5.4.5.4 Layer-2 link release over PC5
Depicted in figure 5.4.5.3-4 is layer-2 link release procedure over PC5. This
procedure can be also used to release the layer-2 link between the Remote UE
and the UE-to-Network Relay, initiated by either the Remote UE or the Relay
e.g. due to temporary loss of connectivity to the network, battery running low
of the relay, etc.
Figure 5.4.5.4-1: Layer-2 link release over PC5
1\. UE-1 sends a Disconnect Request message to UE-2 in order to release the
layer-2 link and deletes all context data associated with.
2\. Upon reception of the Disconnect Request message UE-2 responds with a
Disconnect Response message and deletes all context data associated with the
layer-2 link.
### 5.4.6 ProSe Per-Packet Priority
#### 5.4.6.1 General
When the ProSe upper layer (i.e. above PC5 access stratum) passes a protocol
data unit for transmission to the PC5 access stratum, the ProSe upper layer
provides a ProSe Per-Packet Priority from a range of 8 possible values.
The ProSe Per-Packet Priority is independent of the Destination Layer-2 ID and
applies to both one-to-one and one-to-many ProSe Direct Communication.
The ProSe Per-Packet Priority is selected by the application layer based on
criteria that are outside the scope of this specification.
A ProSe Per-Packet Priority value shall be assigned to PC5-S messages. The UE
is configured with one ProSe Per-Packet Priority value that is used for
transmitting any of the PC5-S messages as described in clause 4.5.1.1.2.3.1.
The ProSe Per-Packet Priority is neutral to the mode in which the UE accesses
the medium i.e. whether scheduled or autonomous transmission modes defined in
TS 36.300 [17] are used.
The ProSe access stratum uses the ProSe Per-Packet Priority associated with
the protocol data unit as received from the upper layers to prioritise the
transmission in respect with other intra-UE transmissions (i.e. protocol data
units associated with different priorities awaiting transmission inside the
same UE) and inter-UE transmissions (i.e. protocol data units associated with
different priorities awaiting transmission inside different UEs).
Priority queues (both intra-UE and inter-UE) are expected to be served in
priority order i.e. UE serves all packets associated with ProSe Per-Packet
Priority N before serving packets associated with priority N+1 (lower number
meaning higher priority).
NOTE: The way the medium is accessed in scheduled or autonomous transmission
modes, while respecting the ProSe Per-Packet Priority selected by
applications, is in the scope of RAN WGs.
#### 5.4.6.2 ProSe UE-to-Network Relay
For unicast uplink traffic the ProSe UE-to-Network Relay uses the uplink TFTs
to select the uplink EPS bearers for relayed uplink packets independently from
the ProSe Per Packet Priority applied over PC5 by Remote UEs.
For unicast downlink traffic the ProSe UE-to-Network Relay maps the QCI of the
EPS bearer into a ProSe Per-Packet Priority value to be applied for the
downlink relayed unicast packets over PC5. The mapping rules are provisioned
in the Relay UE.
NOTE 1: EPS bearers associated with the same QCI, but different ARP values
result in the same ProSe Per-Packet Priority over PC5.
For eMBMS traffic the ProSe UE-to-Network Relay uses the ProSe Per-Packet
Priority that is requested for a specific TMGI by Remote UEs using PC5-S
procedures to be applied for the multicast packets corresponding to that TMGI
when they are relayed over PC5.
NOTE 2: It is assumed that the Remote UE receives the QCI associated with the
TMGI at the application layer along with an associated priority value that the
application layer in the Remote UE maps into a ProSe Per-Packet Priority.
### 5.4.7 ProSe Per-Packet Reliability
#### 5.4.7.1 General
When the ProSe upper layer (i.e. above PC5 access stratum) passes a protocol
data unit for transmission to the PC5 access stratum, the ProSe upper layer
provides a ProSe Per-Packet Reliability from a range of 8 possible values.
The ProSe Per-Packet Reliability is selected by the application layer based on
criteria that are outside the scope of this specification.
The ProSe Per-Packet Reliability is neutral to the mode in which the UE
accesses the medium i.e. whether scheduled or autonomous transmission modes
defined in TS 36.300 [17] are used.
The ProSe access stratum uses the ProSe Per-Packet Reliability associated with
the protocol data unit as received from the upper layers to decide and adjust
the transmission behaviour as defined in TS 36.300 [17].
## 5.5 EPC-level ProSe Discovery procedures
### 5.5.1 General
EPC-level ProSe Discovery can be used independently or in conjunction with EPC
support for WLAN direct discovery and communication.
When EPC support for WLAN direct discovery and communication is requested as
part of the EPC-level ProSe Discovery procedure, the additional parameters for
support of WLAN direct discovery and communication are enclosed in brackets in
the figures.
### 5.5.2 Overall call flow for EPC-level ProSe Discovery
The overall call flow for EPC-level ProSe Discovery and optional EPC support
for WLAN direct discovery and communication is illustrated in Figure 5.5.2-1.
Each procedural box is subsequently described in more detail as a separate
call flow.
Figure 5.5.2-1: Overall call flow for EPC-level ProSe Discovery and optional
EPC support for WLAN direct discovery and communication
1\. UEs perform UE registration for ProSe with the ProSe Function residing in
their respective Home PLMNs;
2\. UEs perform application registration for ProSe with the ProSe Function
residing in their respective Home PLMNs;
3\. UE A makes a proximity request for UE B, i.e. requests that it be alerted
for proximity with UE B (possibly indicating a window of time during which the
request is valid). In response, ProSe Function A requests location updates for
UE A and UE B. These location updates can be periodic, based on a trigger, or
a combination of both. To request location updates for UE A, ProSe Function A
contacts SUPL Location Platform (SLP) A. To request location updates for UE B,
ProSe Function A contacts ProSe Function B, which requests location updates
for UE B from SLP B;
4\. The UEs\' locations are reported to their respective ProSe Functions
intermittently. ProSe Function B forwards UE B\'s location updates to ProSe
Function A based on the conditions set by ProSe Function A. Whenever ProSe
Function A receives location updates for UE A and/or UE B, it performs
proximity analysis on UE A and UE B\'s locations;
5\. When ProSe Function A detects that the UEs are in proximity, it informs UE
A that UE B is in proximity and (optionally) provides UE A with assistance
information for WLAN direct discovery and communication with UE B. ProSe
Function A also informs ProSe Function B, which in turn informs UE B of the
detected proximity and (optionally) provides UE B with assistance information
for WLAN direct discovery and communication with UE A.
### 5.5.3 UE registration for ProSe
To obtain ProSe service a ProSe-enabled UE needs to register with the ProSe
Function.
Depicted in Figure 5.5.3-1 is the procedure for UE registration for ProSe.
Figure 5.5.3-1: UE registration for ProSe
1\. To select ProSe Function A, UE A constructs an FQDN using the HPLMN ID and
relies on DNS translation to obtain the IP address of ProSe Function A. UE A
registers with ProSe Function A by sending a UE Registration Request (IMSI,
[WLLID_A]) message.
If UE A intends to use EPC support for WLAN direct discovery and communication
and if it uses a permanent WLAN Link Layer ID, the message also includes UE
A\'s permanent WLAN Link Layer ID (WLLID_A). Alternatively, the UE may obtain
a temporary WLAN Link Layer ID from the ProSe Function as part of the
Proximity Request procedure.
2\. ProSe Function A may interact with the HSS in order to authenticate the
user, obtain the user\'s profile and check whether the user is authorised for
ProSe. Alternatively, all user settings related to authentication and
authorisation for ProSe may be configured locally in ProSe Function A, in
which case the interaction with the HSS is not needed.
3\. ProSe Function A generates an EPC ProSe User ID for the authorized UE A
(EPUID_A), stores the EPUID_A together with user\'s IMSI and responds to UE A
by sending a UE Registration Response (EPUID_A) message.
### 5.5.4 Application registration for ProSe
When a user registers with a 3rd party application server, he/she is
designated an Application Layer User ID (e.g. ALUID_A for user A). This
procedure is out of 3GPP specification scope. Then to activate ProSe features
such as EPC-level ProSe Discovery for a specific application, the UE registers
the application with the ProSe Function, as illustrated in Figure 5.5.4-1.
Figure 5.5.4-1: Application registration for ProSe
1\. UE A sends Application Registration Request (EPUID_A, Application ID,
ALUID_A) message to ProSe Function A to register an application for ProSe.
EPUID_A is the EPC ProSe User ID for UE A. The Application ID is used to
identify the 3rd party App Server platform. ALUID_A is user A\'s Application
Layer User ID.
2\. ProSe Function A uses EPUID_A to retrieve user\'s profile, checks that the
requested application is on the stored list of authorised Application IDs and
sends a ProSe Registration Request (ALUID_A, EPUID_A, PFID_A) message to the
App Server indicating that a user of this application (identified as ALUID_A)
has requested to use ProSe for that application. PFID_A is the ProSe Function
ID of ProSe Function A. If the App Server accepts the request, it stores the
user\'s Application Layer User ID (ALUID_A) and EPC ProSe User ID (EPUID_A)
together with the PFID_A.
3\. The App Server sends a ProSe Registration Response message to ProSe
Function A indicating that the registration was successful (or not).
4\. ProSe Function A sends Application Registration Response (Allowed Range)
message to UE A indicating that the registration was successful (or not). The
Allowed Range parameter contains the set of range classes that are allowed for
this application.
### 5.5.5 Proximity Request
In order to request that it be alerted when it enters proximity with user B,
UE A triggers the Proximity Request procedure, as illustrated in Figure
5.5.5-1.
Figure 5.5.5-1: Proximity Request
1\. UE A sends a Proximity Request (EPUID_A, Application ID, ALUID_A, ALUID_B,
window, Range, A\'s location, [WLAN indication]) message to ProSe Function A.
The Application ID parameter identifies the 3rd party App Server platform.
ALUID_A and ALUID_B are the Application Layer User IDs for users A and B,
respectively. The window parameter indicates the time period during which the
request is valid. Range is a requested range class for this application chosen
from the set of allowed range classes. A\'s location is the current location
of UE A with the best accuracy known by UE A. UE A may optionally request EPC
support for WLAN direct discovery and communication with UE B by adding the
WLAN indication.
2\. ProSe Function A sends a Map Request (ALUID_A, ALUID_B) message to the App
Server, requesting that it provide the EPC ProSe User ID for the targeted user
B. ProSe Function A stores the Application Layer User IDs (ALUID_A and
ALUID_B) until the execution of the Proximity Alert procedure described in
clause 5.5.7, the Proximity Request Cancellation procedure described in clause
5.5.9 or until the expiry of the time window during which the request is
valid.
3\. The App Server checks user B\'s application-specific ProSe permissions,
confirms that user A is allowed to discover user B, and sends a Map Response
(EPUID_B PFID_B) message to ProSe Function A indicating user B\'s EPC ProSe
User ID (EPUID_B) as well as the ProSe Function ID of ProSe Function B
(PFID_B), ProSe Function A stores the EPUID_B and PFID_B until the execution
of the Proximity Alert procedure described in clause 5.5.7, the Proximity
Request Cancellation procedure described in clause 5.5.9 or until the expiry
of the time window during which the request is valid.
4\. ProSe Function A propagates the Proximity Request (EPUID_B, EPUID_A,
Application ID, window, A\'s location, [WLLID_A], SUPL Config) message to
ProSe Function B. A\'s location is the current location of UE A provided in
step 1 expressed in GAD shapes defined in TS 23.032 [3]. WLAN indication is
included if UE A has requested EPC support for WLAN direct discovery and
communication in step 1. SUPL Config is a set of parameters that enable ProSe
Function B to configure SUPL reporting in UE B using the \'\"Inside\" Trigger
with Repeated Reporting\' as defined in OMA AD SUPL [2].
5\. Based on EPUID_B received in the previous step, ProSe Function B retrieves
subscriber B\'s record. ProSe Function B may request UE B\'s last known
location via the HSS (step 5a). Based on the last known location of UE B
obtained via the HSS and UE A\'s location and time window provided by ProSe
Function A in step 4, ProSe Function B may determine that the users are
unlikely to enter proximity within the requested time window and rejects the
request by sending a Proximity Request Reject message towards UE A with an
appropriate cause value (steps 5b and 5c), in which case the remaining steps
of the procedure are skipped.
6\. Depending on UE B\'s ProSe profile, UE B may be asked to confirm
permission for the proximity request (e.g. user B may have temporarily
disabled the ProSe function on UE B).
7\. ProSe Function B requests location reporting on UE B from SLP B and
acknowledges the proximity request to ProSe Function A and provides UE B\'s
current location (if known). The WLAN Link Layer ID of UE B (WLLID_B) is
included if UE A has requested EPC support for WLAN direct discovery and
communication in step 1 and if UE B uses a permanent WLAN Link Layer ID.
8\. ProSe Function A requests location reporting on UE A from SLP A. If UE
A\'s current location is available and if UE B\'s location was included in
step 7, ProSe Function A may decide to cancel the Proximity Request procedure
if it determines that the UEs are unlikely to enter proximity within the
requested time window. Otherwise ProSe Function A acknowledges the proximity
request to UE A.
### 5.5.6 UE Location Reporting
SLP A and SLP B configure UE A and UE B, respectively, to report their
locations periodically, based on a trigger, or a combination of both depending
on what ProSe Function A and ProSe Function B requested (see Figure 5.5.6-1).
Figure 5.5.6-1: UE location reporting
1-4. The locations of UE A and UE B are reported to their corresponding Prose
Servers intermittently.
NOTE 1: If UE is engaged in multiple concurrent proximity request procedures,
the location reports are grouped together by the SLP.
NOTE 2: The UE location reporting procedure is executed until the time window
expires even if UE B \"unfriends\" UE A at application layer in the middle of
an active proximity request.
5\. Assuming that ProSe Function A is in charge of determining proximity,
ProSe Function B forwards UE B\'s location to ProSe Function A at the cadence
prescribed by ProSe Function A in the Proximity Request message. The UE
location information exchanged between ProSe Functions are expressed in GAD
shapes defined in TS 23.032 [3]. ProSe Function A may decide to cancel the
Proximity Request procedure if it determines that the UEs are unlikely to
enter proximity within the requested time window.
NOTE 3: Based on the last reported UE A\'s or UE B\'s location, ProSe Function
A may decide to send a new Proximity Request message over PC6 in order to
provide updated SUPL Config to ProSe Function B.
### 5.5.7 Proximity Alert
When the UEs enter into proximity, the network triggers the Proximity Alert
procedure, as illustrated in Figure 5.5.7-1.
Figure 5.5.7-1: Proximity Alert
1-3.The location of UE B is reported to ProSe Function B, which forwards it to
ProSe Function A.
4\. ProSe Function A detects that the two UEs are in proximity based on the
requested discovery range class and alerts UE A by sending a Proximity Alert
(Application ID, ALUID_B, Assistance Information) message. ALUID_B is the
Application Layer User ID of user B. The message optionally includes
Assistance Information for WLAN direct discovery and communications with UE B.
5\. If UE A has requested as part of the Proximity Request procedure as
described in step 1 of clause 5.5.5 to be assisted for WLAN direct discovery
and communication, ProSe Function A requests ProSe Function B to send a
Proximity Alert (Application ID, ALUID_A, Assistance Information) message to
UE B. ALUID_A is the Application Layer User ID of user A. The message includes
Assistance Information for WLAN direct discovery and communication with UE A.
ProSe Function A cancels location reporting on UE A from SLP A. ProSe Function
B also cancels location reporting on UE B from SLP B.
6\. If UE A has not requested as part of the Proximity Request procedure as
described in step 1 of clause 5.5.5 to be assisted for WLAN direct discovery
and communication, ProSe Function A initiates Proximity Request Cancellation
by sending a Cancel Proximity Request (EPUID_B, EPUID_A) message to ProSe
Function B as described in step 2 of clause 5.5.9.
NOTE 1: The WLAN interface in the UE need not be turned on before step 7 in
Figure 5.5.7-1.
NOTE 2: The assistance information is designed to expedite WLAN direct
discovery and communication. The content of the assistance information depends
on the technology used on the WLAN direct link. All the content in the
assistance information is dynamically generated by ProSe Function A, with the
exception of WLLID_B in case UE B supports only permanent WLLID.
### 5.5.8 UE deregistration for ProSe
#### 5.5.8.1 General
At any time the UE or the ProSe Function may initiate UE deregistration for
ProSe.
#### 5.5.8.2 Network-initiated deregistration
Depicted in Figure 5.5.8.2-1 is the procedure for network-initiated
deregistration for ProSe.
Figure 5.5.8.2-1: Network-initiated deregistration for ProSe
1\. At any time the ProSe Function may decide to deregister the UE by sending
a UE Deregistration Request (cause) message.
2\. UE acknowledges the deregistration request by sending a UE Deregistration
Response message.
#### 5.5.8.3 UE-initiated deregistration
The UE may decide to deregister for ProSe (e.g. when there are no ProSe-
enabled applications activated on the UE). Depicted in Figure 5.5.8.3-1 is the
procedure for UE-initiated deregistration for ProSe.
Figure 5.5.8.3-1: UE initiated deregistration
1\. At any time the UE may decide to deregister for ProSe by sending a UE
Deregistration Request (EPUID, cause) message.
2\. The ProSe Function acknowledges the deregistration request by sending a UE
Deregistration Response message and removes the stored ProSe context for the
UE.
### 5.5.9 Proximity Request Cancellation
The Proximity Request Cancellation may be initiated by the UE or the ProSe
Function.
UE A may decide to cancel Proximity Request it sent earlier (e.g. due to
change in its location, termination of corresponding application or due to
completion of certain event). The ProSe Function A may cancel Proximity
Request sent by UE A earlier (e.g. when time window is exceeded). In order to
cancel Proximity Request, UE A triggers procedure as illustrated in Figure
5.5.9-1.
Figure 5.5.9-1 Proximity Request Cancellation
1\. UE A sends Cancel Proximity Request (EPUID_A, Application ID, ALUID_B) to
Prose Function A. This optional step is performed only when the Proximity
Request Cancellation procedure is initiated by the UE.
2\. Prose Function A sends the Cancel Proximity Request (EPUID_B, EPUID_A)
message to ProSe Function B based on the stored PFID B information.
3\. If there are no other pending proximity requests for UE A, ProSe Function
A cancels location reporting on UE A from SLP A.
4-5. ProSe Function B cancels location reporting on UE B from SLP B and
acknowledges the proximity request cancellation to ProSe Function A.
6\. ProSe Function A sends Proximity Request Cancellation (Application ID,
ALUID_B) to UE A. The Application ID and ALUID_B parameters are included only
when the procedure is initiated by ProSe Function A.
## 5.6 EPC support for WLAN direct discovery and communication
### 5.6.1 General
The EPC network may decide to enable two or more ProSe-enabled WLAN-capable
UEs to directly communicate using WLAN technology. This decision can be taken,
for example, when the EPC network supports EPC-level ProSe discovery and
becomes aware that two or more UEs are in close proximity, when the EPC
network knows that UE-A requests to communicate with UE-B which is in close
proximity of UE-A, etc.
### 5.6.2 Enabling of EPC assisted WLAN direct communication
Figure 5.6.2-1 shows how the EPC network enables UE-A and UE-B to directly
communicate in WLAN direct mode. This is accomplished by triggering the two
UEs to establish a WLAN direct group and providing them with assistance
information which enables the EPC network to control and to expedite the
establishment of the WLAN direct group.
With the procedure shown in Figure 5.6.2-1 the EPC network can (_i_) control
when a WLAN direct group can be established, (_ii_) authorize the UEs that can
become members of this group (and thus communicate with each other in WLAN
direct mode) and (_iii_) control the operating parameters of the WLAN direct
group e.g. the SSID, the security keys, etc.
NOTE 1: When the WLAN direct discovery and communication is based on the Wi-Fi
Peer-to-Peer (P2P) specification [13], a WLAN direct group is autonomously
established by one or more UEs without any network involvement. However, with
the procedure shown in Figure 5.6.1-1 it is the EPC network that can authorize
and trigger the establishment of WLAN direct groups. An example on the
operating parameters provided by the ProSe Function when the direct
communication is based on Wi-Fi Peer-to-Peer specification [13] can be found
in Annex A.
NOTE 2: WLAN direct discovery and communication without Assistance Information
from EPC is outside the scope of 3GPP.
The ProSe Function shown in Figure 5.6.2-1 is the network function that
triggers and controls the establishment of a WLAN direct group between one or
more UEs.
Figure 5.6.2-1: Signalling flow for EPC support for WLAN direct communication
1\. The ProSe Function decides to trigger UE-A and UE-B to establish a WLAN
direct group under the control of the network.
2\. The ProSe Function sends a WLAN Direct Group Setup Request (Assistance
Information) to UE-A. The Assistance Information is a set of parameters which
can expedite the establishment of the WLAN direct group and enables the EPC
network to control the operating parameters of the WLAN direct group. The
Assistance Information content depends on the WLAN technology. If UE-A accepts
the request and the offered Assistance Information, it responds with a WLAN
Direct Group Setup Response. This response may include parameters for the WLAN
direct group proposed by UE-A (e.g. an operating channel).
NOTE 2: When EPC support for WLAN direct discovery and communication is used
in conjunction with EPC-level discovery, the assistance information for WLAN
direct discovery and communication is provided as part of the Proximity Alert
procedure.
3\. The ProSe Function sends also a WLAN Direct Group Setup Request
(Assistance Information) to UE-B. The Assistance Information in the request
may take into account the parameters proposed by UE-A in step 2b.
4\. The two UEs establish a WLAN direct group and may start communicating in
WLAN direct mode.
NOTE 3: In this release of the specification it is assumed that UE-A and UE-B
are controlled by the same ProSe Function.
### 5.6.3 Revocation of EPC assisted WLAN direct communication
At any time the ProSe Function may decide to revoke the EPC assisted WLAN
direct communication as shown in Figure 5.6.3-1.
Figure 5.6.3-1: Signalling flow for Revocation of EPC assisted WLAN direct
communication
1\. The ProSe Function decides to revoke EPC assisted WLAN direct
communication for UE-A and UE-B.
2a. The ProSe Function sends a WLAN Direct Communication Revocation Request to
the UE-A.
2b. The UE-A accepts the request.
3a. The ProSe Function sends a WLAN Direct Communication Revocation Request
(Control Information) to the UE-B.
3b. The UE-B accepts the request.
4\. The EPC assisted WLAN direct communication Assistance Information is no
longer valid and the EPC assisted WLAN direct communications using the EPC
Assistance Information are released.
## 5.7 ProSe impacts to EPC procedures
### 5.7.0 General
The impact to EPC procedures described in the subsequent clauses apply for
EUTRA-based PC5 only.
### 5.7.1 E-UTRAN attach procedure for ProSe-enabled UEs
E-UTRAN attach for ProSe-enabled UE is performed as defined in TS 23.401 [5]
with the following additions:
\- ProSe-enabled UE includes the ProSe capability indication as part of the
\"UE Network Capability\" in the Attach Request message. MME stores this
information for ProSe operation. ProSe capability can indicate whether the UE
is capable of supporting one or more of the following ProSe direct services:
ProSe Direct Discovery, ProSe Direct Communication and ProSe UE-to-Network
Relay.
\- If the MME is configured to indicate \"ProSe authorised\" to E-UTRAN, the
UE is ProSe-enabled, and the UE is authorised to use ProSe direct services
based on the subscription data, the MME shall include a \"ProSe authorised\"
indication in the S1 AP Initial Context Setup Request, indicating which of the
ProSe direct services the UE is authorised to use. If the UE\'s \"ProSe
authorised\" status indicates the UE is not authorised to act as UE-to-Network
Relay, then the eNodeB shall not authorise the UE to use radio resources for
Relay.
NOTE: If the TAI list sent to the UE includes different PLMNs, only the
\"ProSe authorised\" information associated with the registered PLMN is
available on the MME. The ProSe authorization for equivalent PLMNs of the
registered PLMN is not addressed in this release of specification.
### 5.7.2 Service Request procedures for ProSe-enabled UEs
Service Request procedures for ProSe-enabled UE are performed as defined in TS
23.401 [5] with the following additions:
\- If the MME is configured to indicate \"ProSe authorised\" to E-UTRAN, the
UE is ProSe-enabled, and the UE is authorised to use ProSe direct services
based on the subscription data, the MME shall include a \"ProSe authorised\"
indication in the S1 AP Initial Context Setup Request, indicating which of the
ProSe direct services the UE is authorised to use. If the UE\'s \"ProSe
authorised\" status indicates the UE is not authorised to act as UE-to-Network
Relay, then the eNodeB shall not authorise the UE to use radio resources for
Relay.
### 5.7.3 PS Handover procedures for ProSe-enabled UEs
Intra-E-UTRAN S1-based handover or the Inter-RAT to E-UTRAN handover
procedures for ProSe-enabled UE are performed as defined in TS 23.401 [5] with
the following additions:
\- If the MME is configured to indicate \"ProSe authorised\" to E-UTRAN, the
UE is ProSe-enabled, and the UE is authorised to use ProSe direct services
based on the subscription data, the target MME shall send the \"ProSe
authorised\" indication to the target eNodeB as follows:
\- For the intra MME handover, the \"ProSe authorized\" indication is included
in the S1-AP handover Request message. If after the handover procedure, the
\"ProSe authorized\" indication is changed, the updated \"ProSe authorized\"
indication is included in the S1-AP UE Context Modification Request message
sent to the target eNodeB.
\- For the inter MME handover or Inter-RAT handover to E-UTRAN, the \"ProSe
authorized\" indication is included in the S1-AP UE Context Modification
Request message sent to the target eNodeB after the handover procedure. If the
UE\'s \"ProSe authorised\" status indicates the UE is not authorised to act as
UE-to-Network Relay, then the eNB shall not authorise the UE to use radio
resources for Relay.
For X2-based handover, the \"ProSe authorized\" indication is sent to target
eNodeB as follows:
\- If the source eNodeB is ProSe-enabled and the \"ProSe authorized\"
indication is included in the UE context, the source eNodeB shall include a
\"ProSe authorised\" indication in the X2-AP Handover Request message to the
target eNodeB.
\- If the MME is configured to indicate \"ProSe authorised\" to E-UTRAN, the
UE is ProSe-enabled, and the UE is authorised to use ProSe direct services
based on the subscription data, the MME shall send the \"ProSe authorised\"
indication to the target eNodeB in the Path Switch Request Acknowledge
message. If after the handover procedure, the \"ProSe authorized\" indication
is changed, the updated \"ProSe authorized\" indication is included in the
S1-AP UE Context Modification Request message sent to the target eNodeB. If
the UE\'s \"ProSe authorised\" status indicates the UE is not authorised to
act as UE-to-Network Relay, then the eNB shall not authorise the UE to use
radio resources for Relay.
The \"ProSe authorised\" indication sent to target eNodeB denotes which of the
ProSe direct services UE is authorized to use.
### 5.7.4 Tracking Area Update procedure for ProSe-enabled UEs
Tracking Area Update procedures for ProSe-enabled UE are performed as defined
in TS 23.401 [5] with the following additions:
\- ProSe-enabled UE includes the ProSe capability indication as part of the
\"UE Network Capability\" in the Tracking Area Update Request message. MME
stores this information for ProSe operation.
\- If the MME is configured to indicate \"ProSe authorised\" to E-UTRAN and
determines to re-establish the radio and S1 bearers for all active EPS bearer
contexts due to the \"active\" flag included in the Tracking Area Update
Request message or the pending downlink data or signalling, the UE is ProSe-
enabled, and the UE is authorised to use ProSe direct services based on the
subscription data, the MME shall include a \"ProSe authorised\" indication in
the S1-AP Initial Context Setup Request. If the UE\'s \"ProSe authorised\"
status indicates the UE is not authorised to act as UE-to-Network Relay, then
the eNodeB shall not authorise the UE to use radio resources for Relay.
NOTE: If the TAI list sent to the UE includes different PLMNs, only the
\"ProSe authorised\" information associated with the registered PLMN is
available on the MME. The ProSe authorization for equivalent PLMNs of the
registered PLMN is not addressed in this release of specification.
### 5.7.5 Insert Subscriber Data procedure for ProSe-enabled UEs
Insert Subscriber Data procedure for ProSe-enabled UE are performed as defined
in TS 23.401 [5] with the following additions:
\- If the \"ProSe authorised\" indication needs to be changed due to the
changed subscription data and the S1 bearer is established, the MME shall
notify the eNodeB the updated \"ProSe authorised\" indication via the S1-AP UE
Context Modification Request message.
### 5.7.6 Delete Subscriber Data procedure for ProSe-enabled UEs
Delete Subscriber Data procedure for ProSe-enabled UE is performed as defined
in TS 29.272 [37] with the same additions as in clause 5.7.5.
###### ## Annex A (informative): Assistance Information for EPC support for
WLAN direct discovery and communication
# A.1 General
This Annex presents an example how the Assistance Information can be designed
to expedite WLAN direct discovery and communication. The Assistance
Information content depends on the WLAN technology.
# A.2 Wi-Fi Peer-to-Peer
Wi-Fi Peer-to-Peer (P2P) specification [13] defines an architecture and set of
protocols that facilitate direct discovery and communication using the IEEE
802.11 technology [14].
To assist WLAN direct discovery and communication as required by the Wi-Fi P2P
technology [13] the EPC needs to supply some or all of the following items as
part of the Assistance Information:
\- SSID: The SSID to use for Wi-Fi P2P operation. To be compliant with the Wi-
Fi P2P specification [13] the SSID should be in the form \"DIRECT-ab\" where
a, b are two random characters.
\- WLAN Secret Key: The pre-shared key to be used by UEs to secure their Wi-Fi
P2P communication. This is used by UEs as the Pairwise Master Key (PMK).
\- Group Owner indication: If set, the UE should implement the Group Owner
(GO) functionality specified in the Wi-Fi P2P specification [13]. The UE
implementing this functionality essentially becomes an AP that transmits
Beacons with the P2P Information Element and accepts associations from other
Wi-Fi P2P devices or from legacy Wi-Fi devices (those not implementing the Wi-
Fi P2P functionality). If not set, the UE should behave as a Wi-Fi P2P client
that attempts to discover and associate with a GO.
\- P2P Device Address of self: This is the WLAN Link Layer ID to be used by a
UE when participating in a Wi-Fi P2P group.
\- P2P Device Address of peers: This is a list of WLAN Link Layer IDs provided
to a UE implementing the Group Owner functionality in a Wi-Fi P2P group. Such
UEs should accept WLAN association requests only from devices that are
included in this list.
\- Operation channel: The channel on which Wi-Fi P2P discovery and
communication should take place.
\- Validity time: The time period during which the content provided in the
assistance information is valid.
###### ## Annex B (informative): Wild carded ProSe Application IDs
# B.1 General
The wildcard indicator, in the MNC or MCC part of the PLMN ID of the ProSe
Application ID indicates whether this particular ProSe Application ID is PLMN
specific (in which case neither MCC nor MNC will be wild carded) or
countrywide (in which case the MNC part will be wild-carded) or global (in
which case both the MCC and MNC parts will be wild-carded).
Countrywide or global ProSe Application IDs belong in different data
structures that are managed by \"authorities\" not associated with a specific
PLMN.
Notwithstanding the description in this annex, showing both PLMN specific and
country-wide or global data structures, this does not preclude that in the
future the country-wide or global data structures may supersede the PLMN
specific data structures.
Figure B.2-1: Country-wide, global and PLMN specific ProSe Application IDs
This arrangement between the PLMN and the \"authority\" that allocates these
ProSe Application IDs is out of scope of 3GPP in this release of the
specification.
NOTE: The interfaces between the ProSe Functions and the repositories of
global or country-wide ProSe Application IDs/ProSe Application Codes that are
shown in figure B.2-1 is out of scope of 3GPP in this Release.
# B.2 Use of wild-carded ProSe Application IDs
The monitoring or announcing UE can request to monitor or announce a ProSe
Application Code that has countrywide or global scope following the procedures
defined in clause 5.3.3 by wildcarding accordingly the MNC element of the PLMN
ID of the ProSe Application ID (for countrywide) or both the MCC and MNC (for
global) elements of the PLMN ID of the ProSe Application ID.
The monitoring UE will have to know whether to send a monitoring request for
PLMN specific, or countrywide, or global ProSe Application ID, based on the
configuration that applies to the particular data structure.
If country-wide or global data structures are used then PC6 and PC7 interfaces
are not used for monitoring requests.
For example if the UE is interested to monitor or announce for restaurants
that are registered in a configured PLMN specific data structure (e.g., local
restaurants in a particular geographical area) it will send a monitoring
request that contains only the following PLMN specific ProSe Application ID.
If on the other hand the UE is interested to monitor or announce for
restaurants that are registered in the configured global data structure (e.g.,
chain restaurants present in several countries/available all over the world)
it will send a monitoring or announcing request that contains only the global
ProSe Application ID. The monitoring UE can also send multiple ProSe
Application IDs with different scope in the same request, but overall it
should not be considered that one ProSe Application ID replaces the other.
###### ## Annex C (normative): WLAN-based ProSe Direct Discovery
# C.1 General
This Annex provides examples of how the WLAN technologies can be used in ProSe
Direct Discovery for transport of the ProSe Protocol messages and/or
information elements. The WLAN-based transport depends on the underlying WLAN
technology.
# C.2 Wi-Fi Neighbor Awareness Networking (NAN)
Wi-Fi Neighbor Awareness Networking (NAN) specification [38] defines an
architecture and set of protocols that facilitate direct discovery and
communication using the IEEE 802.11 [14] technology.
Figure C.2-1 shows the high-level architecture of a NAN Device.
Figure C.2-1: NAN Device Architecture (after Wi-Fi Neighbor Awareness
Networking (NAN) specification [38])
When a ProSe-enabled UE uses the Wi-Fi NAN technology in ProSe Direct
Discovery, the ProSe Protocol layer acts as one of the applications shown in
Figure C.2-1 and interacts with the underlying NAN Discovery Engine through a
logical interface that is described in terms of method and event primitives in
the NAN Wi-Fi Neighbor Awareness Networking (NAN) specification [38].
The PC5_DISCOVERY message, specified in TS 24.334 [24], is passed by means of
the \"Publish\" method from the ProSe Protocol layer to the NAN Discovery
Engine and inserted in the Service Descriptor Attribute (see Wi-Fi Neighbor
Awareness Networking (NAN) specification [38]).
The content of the Service Descriptor Attribute is illustrated in Table C.2-1.
The table also indicates how the individual fields of the Service Descriptor
Attribute are used for transport of the PC5_DISCOVERY message.
Table C.2-1: Service Descriptor Attribute Format (defined in Wi-Fi Neighbor
Awareness Networking (NAN) specification [38]) and 3GPP-specific settings for
ProSe
* * *
Field Description 3GPP-specific setting Attribute ID Identifies the type of
NAN attribute  
Length Length of the following fields in the attribute.  
Service ID Mandatory field that contains the hash of the Service Name. Always
set to a 3GPP-defined Service Category for ProSe(1) Instance ID Publish_ID or
Subscribe_ID  
Requestor Instance ID Instance ID from the frame that triggered the
transmission if available, otherwise set to 0x00.  
Service Control Mandatory field that defines the Service Control bitmap as
defined in Table 5 11 of Wi-Fi Neighbor Awareness Networking (NAN)
specification [38]. Always set to \"00: Publish\" Binding Bitmap Optional
field that indicates the binding of the SDA to post discovery connection
attributes Not used for ProSe Direct Discovery Matching Filter Length An
optional field and present if a matching service discovery filter is used Not
used for ProSe Direct Discovery Matching Filter An optional field that is a
sequence of length and value pairs that identify the matching service
discovery filters, as defined in Wi-Fi Neighbor Awareness Networking (NAN)
specification 38] Not used for ProSe Direct Discovery Service Response Filter
Length An optional field and present if a service response filter is used. Not
used for ProSe Direct Discovery Service Response Filter An optional field that
identifies the matching service response filters, refer to Table 5 13 of Wi-Fi
Neighbor Awareness Networking (NAN) specification [38]. Not used for ProSe
Direct Discovery Service Info Length An optional field and present if service
specific information is used Set to the length of the PC5_DISCOVERY message.
Service Info An optional field that contains the service specific information.
Its content may be determined by the application and not specified herein.
PC5_DISCOVERY message. NOTE: The definition of the text string for 3GPP-
defined Service Category for ProSe is defined in Stage 3 specifications.
* * *
The ProSe Protocol layer in the UE participating in the discovery process
using the Wi-Fi NAN technology subscribes to the Service ID for the 3GPP-
defined Service Category for ProSe.
The NAN Discovery Engine accepts all the Service Discovery Frames received
over the air with a matching Service ID, extracts the PC5_DISCOVERY messages
and generates a \"DiscoveryResult\" event that conveys the PC5_DISCOVERY
messages to the ProSe Protocol layer for further processing.
#
# Foreword
This Technical Specification (TS) has been produced by the 3^rd^ Generation
Partnership Project (3GPP).
The present document defines the location management procedures within the
3GPP system.
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# 1 Scope
The present document describes the location management procedures for the
circuit switched domain, with respect to the application level functional
behaviour. This is to be distinguished from the corresponding protocol
handling behaviour, which is specified in 3GPP TS 29.002 [8]. The following
location management procedures are included:
\- location updating;
\- location cancellation;
\- MS purging;
\- IMSI attach/detach.
The procedures in the Mobile Station (MS) are described in 3GPP TS 23.022 [6].
The procedures between MSC, VLR and HLR utilise the Mobile Application Part
(MAP) and details concerning the protocol handling are contained in 3GPP TS
29.002 [8].
The present document excludes location management procedures for the packet
switched domain, which are covered in 3GPP TS 23.060 [20].
The descriptions herein depict a logical separation between the MSC and VLR.
This logical separation, as well as the messages transferred between the two
logical entities are the basis of a model used to define the externally
visible behaviour of the MSC/VLR, which a may be a single physical entity.
They do not impose any requirement except the definition of the externally
visible behaviour.
## 1.1 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or non‑specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
[1] 3GPP TR 21.905: \"3G Vocabulary\".
[2] 3GPP TS 23.002: \"Network architecture\".
[3] 3GPP TS 23.003: \"Numbering, addressing and identification\".
[4] 3GPP TS 23.007: \"Restoration procedures\".
[5] 3GPP TS 23.008: \"Organization of subscriber data\".
[5a] 3GPP TS 23.018: \"Basic call handling; Technical realization\".
[6] 3GPP TS 23.022: \"Functions related to Mobile Station (MS) in idle mode\".
[7] 3GPP TS 23.116: \"Super-Charger Technical Realisation; Stage 2\".
[8] 3GPP TS 29.002: \"Mobile Application Part (MAP) specification\".
[9] 3GPP TS 29.007: \"General requirements on interworking between the Public
Land Mobile Network (PLMN) and the Integrated Services Digital Network (ISDN)
or Public Switched Telephone Network (PSTN)\".
[10] 3GPP TS 43.020: \"Security related network functions\".
[11] 3GPP TS 23.078: \" Customised Applications for Mobile network Enhanced
Logic (CAMEL) Phase 4 -- stage2\".
[11a] 3GPP TS 23.195: \"Provision of UE Specific Behaviour Information to
Network Entities\".
[12] 3GPP TS 23.236: \"Intra Domain Connection of RAN Nodes to Multiple CN
Nodes\".
[13] 3GPP TS 24.008: \"Mobile Radio Interface Layer 3 specification; Core
Network Protocols - Stage 3\".
[14] 3GPP TS 29.010: \"Information element mapping between Mobile Station -
Base Station System and BSS ‑ Mobile-services Switching Centre (MS - BSS -
MSC) Signalling procedures and the Mobile Application Part (MAP)\".
[15] 3GPP TS 32.422: \"Subscriber and equipment trace: Trace control and
configuration management\".
[16] 3GPP TS 32.421: \"Subscriber and equipment trace: Trace concepts and
requirements\".
[17] 3GPP TS 25.413: \"UTRAN Iu interface RANAP signalling\".
[18] 3GPP TR 29.994: \"Recommended infrastructure measures to overcome
specific Mobile Station (MS) faults\".
[19] 3GPP TS 24.368: \"Non-Access Stratum (NAS) configuration Management
Object (MO)\".
[20] 3GPP TS 23.060: \"General Packet Radio Service (GPRS); Service
description; Stage 2\".
## 1.2 Abbreviations
Abbreviations are listed in 3GPP TR 21.905 [1].
In addition, for the purposes of the present document, the following
abbreviations apply:
> ADD Automatic Device Detection
>
> CSG Closed Subscriber Group
>
> CSS CSG Subscriber Server
>
> PUESBINE Provision of User Equipment Specific Behaviour Information to
> Network Entities
>
> UESBI-Iu User Equipment Specific Behaviour Information over the Iu interface
# 2 Definitions
## 2.1 Location management
Location management means that the PLMNs keep track of where the MSs are
located in the system area. The location information for each MS is stored in
functional units called location registers. Functionally, there are two types
of location registers:
\- the Home Location Register where all subscriber parameters of an MS are
permanently stored, and where the current location may be stored;
\- the Visitor Location Register where all relevant data concerning an MS are
stored as long as the station is within the area controlled by that visitor
location register;
\- the CSG Subscriber Server where the CSG subscription data are stored in the
visited PLMN for inbound roaming MS, and where the current location may be
stored.
See also 3GPP TS 23.002 [2] where the network architecture is described, and
3GPP TS 23.008 [5] where the data stored in the location registers are
described.
The action taken by a MS in order to provide location information to the PLMN
will be referred to as location updating.
## 2.2 Location area and MSC area
The MSC area is composed of the area covered by all base stations controlled
by the MSC. An MSC area may consist of several location areas. A location area
is an area in which, after having performed a location update once, MSs may
roam without being required to perform subsequent location updates for reason
of location change. A location area consists of one or more cells.
For further details of the network architecture, see 3GPP TS 23.002 [2].
## 2.3 Location area identification
The Location Area Identification (LAI) plan is part of the base station
identification plan. The base stations are identified uniquely (see 3GPP TS
23.003 [3]).
## 2.4 IMSI detach/attach operation
The support of IMSI detach/attach operation is mandatory in MSs. The facility
is optional in the fixed infrastructure of the PLMN.
### 2.4.1 Explicit IMSI detach/attach
Explicit IMSI detach operation is the action taken by an MS to indicate to the
PLMN that the station has entered an inactive state (e.g. the station is
powered down). Explicit IMSI attach operation is the action taken by an MS to
indicate that the station has re-entered an active state (e.g. the station is
powered up).
### 2.4.2 Implicit IMSI detach
Implicit IMSI detach operation is the action taken by the VLR to mark an MS as
detached when there has been no successful contact between the MS and the
network for a time determined by the implicit detach timer. The value of the
implicit detach timer is derived from the periodic location updating timer;
when the MSC/VLR applies Mobility Management Congestion Control to a MS, the
MSC/VLR may need to adjust the Implicit Detach timer as specified in clause
3.7.2. During an established radio contact, the implicit detach timer shall be
prevented from triggering implicit detach. At the release of the radio
connection, the implicit detach timer shall be reset and restarted. Implicit
IMSI detach shall also be performed in the case of a negative response to an
IMEI check.
## 2.5 Use of the term mobile station (MS) in the present document
In order to simplify the text the term Mobile Station (MS) as used in relation
to location management refers to the entity where the IMSI is stored, i.e., in
card operated MSs the term Mobile Station (MS) refers to the card.
## 2.6 Paging area
As an option, and for paging optimization purpose, the VLR may control Paging
Areas. A Paging Area (PgA) is composed of up to 5 Location Areas, and the MSC
area is composed of several Paging Areas. Paging areas may overlap each other.
The Paging Area is stored in the HLR and updated at each paging area change.
The Paging Area is sent by the HLR to the VLR at roaming number request and
may be used by the MSC/VLR for paging (e.g. when LAI is not known, after
MSC/VLR restart) (see 3GPP TS 23.018 [5a]).
# 3 General procedures in the network related to Location Management
## 3.1 Procedures in the MSC related to Location Updating
The MSC shall pass messages related to location updating between the MS and
the VLR.
## 3.2 Procedures in the VLR related to Location Updating
FFS
## 3.3 Procedures in the HLR related to Location Updating
FFS
## 3.4 Normal Location Updating and IMSI detach/attach operation
When receiving a Location Updating Request or an IMSI detach/attach message
from an MS, the MSC shall convey the message to its associated Visitor
Location Register. Any response from the location register shall similarly be
conveyed to the MS.
## 3.5 IMSI enquiry procedure
The MS shall identify itself by either the IMSI or the TMSI plus Location Area
Identification of the previous VLR. In the latter case the new VLR shall
attempt to request the IMSI and authentication parameters from the previous
VLR by the methods defined in 3GPP TS 29.002 [8].
If this procedure fails, or if the TMSI is not allocated, the VLR shall
request that the MS identifies itself by use of the IMSI.
## 3.6 Information transfer between Visitor and Home Location Registers
### 3.6.1 Procedures for location management
Detailed procedures for exchange of and location updating information between
visitor and home location registers are given in 3GPP TS 29.002 [8]. Below
follows an overview of these procedures.
#### 3.6.1.1 Location updating procedure
This procedure is used when an MS registers with a Visitor Location Register.
The VLR provides its address to the HLR.
The VLR may also allocate an optional identity for the MS at location
updating: the Local Mobile Station Identity (see 3GPP TS 23.003 [3]).
#### 3.6.1.2 Downloading of subscriber parameters to the VLR
As a part of the location updating procedure, the Home Location Register will
convey the subscriber parameters of the MS which need to be known by the
visitor location register for proper call handling. This procedure is also
used whenever there is a change in the subscriber parameters that need to be
conveyed to the VLR (e.g. change in subscription, a change in supplementary
services activation status).
If the HPLMN applies the multinumbering option, different MSISDNs are
allocated for different Basic Services (see 3GPP TS 29.007 [9]) and stored in
the HLR. Among these MSISDNs, the Basic MSISDN Indicator as part of the HLR
subscriber data (see 3GPP TS 23.008 [5]) marks the \'Basic MSISDN\' to be sent
to the VLR at location update. It is used in the VLR for call handling as
calling party and as line identity.
If the HPLMN applies the Administrative Restriction of Subscribers\' Access
feature, the HLR shall convey the subscriber access restriction parameter
(AccessRestrictionData) to the VLR. The VLR shall check this subscription
parameter against the radio access technology that supports the LA/RA in which
the UE is roaming to decide whether the location update should be allowed or
rejected.
For further information of the Subscriber access restriction see 3GPP TS
23.008[5].
#### 3.6.1.3 Location cancellation procedure
The procedure is used by the home location register to remove a MS from a
visitor location register. The procedure will normally be used when the MS has
moved to an area controlled by a different location register. The procedure
can also be used in other cases, e.g. an MS ceases to be a subscriber of the
Home PLMN.
#### 3.6.1.4 Mobile subscriber purging procedure
A VLR may purge the subscriber data for an MS which has not established radio
contact for a period determined by the network operator. Purging means to
delete the subscriber data and to \"freeze\" the TMSI that has been allocated
to the purged MS in order to avoid double TMSI allocation. The VLR shall
inform the HLR of the purging.
When the HLR is informed of the purging, it shall set the flag \"MS purged\"
in the IMSI record of the MS concerned. Presence of the \"MS purged\" flag
will cause any request for routing information for a call or short message to
the MS to be treated as if the MS were not reachable.
In the VLR, the \"frozen\" TMSI is freed for usage in the TMSI allocation
procedure by location updating for the purged MS in the same VLR, location
cancellation for the purged MS or, in exceptional cases, by O&M.
In the HLR, the \"MS purged\" flag is reset by the location updating procedure
and after reload of data from the non-volatile back-up that is performed when
the HLR restarts after a failure.
#### 3.6.1.5 Support for subscription without MSISDN
An MSC/VLR may support delivery of SMS destined to an MS without MSISDN for
GPRS and EPS operation whereby a MSISDN is not allocated as part of the
subscription data (see 3GPP TS 23.060 [3] subclause 5.3.17 and 3GPP TS 23.401
[72]).
An MSC/VLR which supports MSISDN-less operation shall indicate such support to
the HLR in the MAP Update Location request.
The HLR should reject a MAP Update Location request received for an MSISDN-
less subscription from a VLR not indicating support of MSISDN-less operation,
with a cause indicating that roaming is not allowed.
The HLR shall download the subscriber parameters to the VLR as per subclause
3.6.1.2 but without an MSISDN for an MSISDN-less subscription if the VLR
indicates support of MSISDN-less operation.
NOTE 1: VLRs not supporting MSISDN-less operation can face unpredictable
problems if the HLR was downloading subscriber parameters without an MSISDN or
with a dummy MSISDN shared across multiple subscriptions.
NOTE 2: Some services have unresolved MSISDN dependencies and are not
supported at operation without MSISDN. See 3GPP TS 23.060 [3] subclause
5.3.17.
NOTE 3: The HLR can accept a MAP Update Location request received for an
MSISDN-less subscription from a VLR not indicating support of MSISDN-less
operation if the HLR knows by proprietary means that the VLR supports MSISDN-
less operation in a proprietary way (e.g. with a dummy MSISDN value).
## 3.7 Overload Protection
### 3.7.1 Overview
As the number of mobile devices increase and become more automated (Machine
Type Communication, MTC type devices) the network is at greater risk of
becoming overloaded. Additional mechanisms may be deployed to prevent and or
control overload and congestion. This sub-clause describes such optional
mechanisms.
The succeeding descriptions applies to Network Mode of Operation II
(requesting CS only). For NMO I (requesting both CS and PS) the procedures are
described in 3GPP TS 23.060 [20].
### 3.7.2 Congestion Control during Mobility Management
The MSC or VLR may support the capability to reject Location Updating Requests
or IMSI Attach messages from an MS if the node is experiencing congestion.
The MSC/VLR may indicate the rejection is due to congestion with a specific
congestion cause value and a specific back-off timer, see 3GPP TS 24.008 [13].
The Mobility Management back-off timer shall not impact Cell/RAT and PLMN
change. Cell/RAT and RA change do not stop the Mobility Management back-off
timer. The Mobility Management back-off timer shall not be a trigger for PLMN
reselection. The back-off timer is stopped as defined in 3GPP TS 24.008 [13]
when a new PLMN that is not an equivalent PLMN is accessed.
While the Mobility Management back-off timer is running, the MS shall not
initiate any Mobility Management procedures. However, the MS is allowed to
initiate Mobility Management procedures for priority/emergency services and
mobile terminated services even when the Mobility Management back-off timer is
running.
If the MS receives a paging request from the MSC/VLR while the Mobility
Management back-off timer is running, the MS shall stop the Mobility
Management back-off timer and initiate the CM Service Request procedure.To
avoid that large amounts of MSs initiate deferred requests (almost)
simultaneously, the MSC/VLR should select the Mobility Management back-off
timer value so that deferred requests are not synchronised.
The decision to apply congestion control is made by the MSC/VLR, the detailed
criteria for which is outside the scope of this specification but may for
example take into account the low access priority indication if signalled by
MSs.
The MSC/VLR should use implicit detach timer values that are larger than the
Mobility Management back-off timer values to avoid that the MSC/VLR implicitly
detaches the MS before the MS has performed a LAU procedure, which could lead
to unneccessary signalling after the back-off timer expires.
## 3.7.3 Extended periodic LAU Signalling
To reduce network load from periodic location updating (LAU) signalling and to
increase the time until the MS detects a potential need for changing the RAT
or PLMN (e.g. due to network problems) longer values of the periodic LAU timer
and implicit detach timer should be supported.
A long periodic LAU timer value may be locally configured at the MSC/VLR for
MS configured for low access priority (see 3GPP TS 24.368 [19]) or may be
stored as part of the subscription data in the HLR. During the IMSI Attach and
Location Updating procedures, the MSC/VLR should allocate the periodic LAU
timer value for the MS based on VPLMN operator policy, low access priority
indication from the MS, and subscription information received from the HSS. If
the allocated periodic LAU timer value is longer than T3212, the MSC/VLR shall
provide the MS with the periodic LAU timer in the Location Updating Accept
message as specified in 3GPP TS 24.008 [13].
If the subscriber is not roaming and the MSC/VLR receives a subscribed
periodic LAU timer value from the HSS, it should allocate the subscribed value
to the MS as periodic LAU timer. If the subscriber is roaming and the MSC/VLR
receives a subscribed periodic LAU timer value from the HSS, the MSC/VLR may
use the subscribed periodic LAU timer value as an indication to decide for
allocating a locally configured periodic LAU timer value to the MS.
## 3.8 Information transfer between VLR and CSG Subscriber Server
### 3.8.1 Procedures for location management
#### 3.8.1.1 General
Detailed procedures for exchange of and location updating information between
VLR and CSG Subscriber Server are given in 3GPP TS 29.002[8]. This clause
follows an overview of these procedures.
#### 3.8.1.2 Updating VCSG Location procedure
This procedure is used when an MS registers with a Visitor Location Register
and there is a need to do a registration with the CSS.
The VLR provides its address to the CSS.
#### 3.8.1.3 Downloading of VPLMN CSG subscription data to the VLR
As a part of the location updating procedure, the CSG Subscriber Server shall
convey the VPLMN CSG subscription data of the roaming MS which needs to be
known by the visitor location register for determine whether the MS can access
the current cell to have CS services. This procedure is also used whenever
there is a change in the VPLMN CSG subscription data that needs to be conveyed
to the VLR.
#### 3.8.1.4 VCSG Location cancellation procedure
The procedure is used by the CSS to remove a MS from a CSS. The procedure will
normally be used when there is a removal of the CSG subscription data in CSS
and of the MS registration including the case where a MS was registered in CSS
but without CSG data.
# 4 Detailed Procedures in the network related to Location Management
The text in this clause is a supplement to the definition in the SDL diagrams;
it does not duplicate the information in the SDL diagrams.
This specification shows the location management application processes
interworking with the MAP protocol handler, which is specified in 3GPP TS
29.002 [8]. The MAP protocol defines supervision timers. If a supervision
timer expires before a distant entity responds to a signal, the handling is as
defined in 3GPP TS 29.002 [8]. In general, the protocol handler reports timer
expiry to the application as an error condition or negative response. Where a
timer is shown in this specification, therefore, it is an **application
timer** rather than a **protocol** timer. Interworking with the protocol
handlers uses functional signal names which do not necessarily have a one-to-
one correspondence with the names of messages used in the MAP protocols.
## 4.1 Location Updating
### 4.1.1 Detailed procedure in the MSC
#### 4.1.1.1 Process Update_Location_Area_MSC
Sheet 1: Location Update corresponds to a Location_Registration_Request
indicating any of the following:
\- Normal location update;
\- Periodic location update;
\- IMSI attach.
Sheet 1: The procedures Check_IMEI_MSC, Obtain_IMEI_MSC and Obtain_IMSI_MSC
are specified in 3GPP TS 23.018 [5a].
Sheet 1: The input signal \"Send UESBI-Iu to Access Network\" carries the
IMEISV.
Sheet 1: The task \"Convert IMEISV to UESBI\" is defined in 3GPP TS 23.195
[11a].
Sheet 2: The procedure Check_IMEI_MSC is specified in 3GPP TS 23.018 [5a].
Sheet 2: When the MSC receives a Set Ciphering Mode request from the VLR, it
sends a Start ciphering request towards the MS. After that, the Forward new
TMSI and Update Location Area ack may be received in any order.
Sheet 2: The Forward new TMSI may also be received prior to Update Location
Area negative response if the option \"TMSI reallocation in case of Location
Update reject with cause #13 (roaming not allowed in Location Area) or #15 (no
suitable cells in Location Area)\" is applicable (see §4.1.2.3). The new TMSI
is forwarded together with the new LAI. They are kept in the UE/SIM on receipt
of the Location Update reject with cause #13 or #15 (see 3GPP TS 24.008 [13]).
Sheet 2: IMEISV trace list shall be made available to the MSC. The list may
contain IMEISV entries if Management Based Trace Activation is supported in
RAN and MSC has received the trace list in the Uplink Information Transfer
message (See 3GPP TS 32.422 [15] and 25.413 [17]). The test \"Current IMEISV
included in IMEISV trace list?\" will follow the \"no\" case when no entries
exist.
Sheet 2: For Trace Invocation in RAN concepts and procedures see 3GPP TSs
32.421 [16], 32.422[15] and 25.413[17].
Sheet 2: IMEISV trace list
{width="5.752083333333333in" height="6.956944444444445in"}
Figure 4.1.1.1 (sheet 1 of 2): Process Update_Location_Area_MSC
{width="6.691666666666666in" height="8.09375in"}
Figure 4.1.1.1 (sheet 2 of 2): Process Update_Location_Area_MSC
#### 4.1.1.2 Procedure Authenticate_MSC
Figure 4.1.1.2 (sheet 1 of 1): Procedure Authenticate_MSC
### 4.1.2 Detailed procedure in the VLR
#### 4.1.2.1 Process Update_Location_Area_VLR
General comment: at any stage in the location updating process the MSC may
receive an indication from the BSS that the MM transaction has been released.
The MSC then sends an Abort signal to the VLR. Upon receipt of this message,
the VLR shall follow one of two possible courses of action.
The two possible courses of action and the conditions determining which course
shall be taken are as follows:
1\. If a successfully authenticated radio connection is already established
before the Abort message is received, the VLR shall ignore the message.
2\. If a successfully authenticated radio connection has not been established
before the Abort message is received, the VLR shall abort the Update Location
Area process and return to the idle state.
Sheet 1: the location area updating process will be activated by receiving an
Update Location Area indication from the MSC. If there are parameter errors in
the indication, the process is terminated with the appropriate error sent in
the Update Location Area response to the MSC. Else, the behaviour will depend
on the subscriber identity received, either an IMSI or a TMSI.
The Automatic Device Detection (ADD) function is an optional feature that
allows the HLR to be updated with the current User Equipment (IMEISV) and thus
enables the network to configure the subscriber\'s equipment based on a
predefined profile. The mechanism for the IMEISV retrieval by device
management system (either from HLR or VLR) is outside the scope of this
specification. As an optimisation, the VLR may optionally store whether or not
the HLR supports the ADD feature and use this information to decide whether or
not to send an update to the HLR.
The Paging Area function is an optional feature that allows the HLR to be
updated with the current Paging Area (PgA) (see subclause 2.6). If supported,
whenever the paging area changes, the VLR shall send a MAP Update Location
request with the Paging Area parameter set to the location areas belonging to
the new paging area. The Paging Area is then sent by the HLR (if available) to
the VLR in the MAP Provide Roaming Number and may be used for paging
optimisation after a MSC/VLR restart (see 3GPP TS 23.018 [5a]).
Sheet 1: The usage of a Hop Counter is an optional optimization.
Sheet 2: at the decision \"HLR updating required?\" the \"True\" branch shall
be taken if and only if one or more of the following conditions is true:
(1) Location Info Confirmed in HLR is false.
(2) Data Confirmed by HLR is false.
Sheet 2: : The execution of the test \"HLR supports ADD?\" and the action
\"set: skip subscriber data update\" is an optional optimisation and depends
on the presence of the relevant indication from the HLR that ADD functionality
is supported. If this optimisation is not supported on the VLR or no
indication is received, both are bypassed in which case processing continues
at connector 4.
Sheet 2: The execution of the test \"HLR supports PgA?\" and the action \"set:
skip subscriber data update\" depends on the presence of the relevant
indication from the HLR that PgA functionality is supported.
Sheet 2: The \"Subscriber data dormant\" flag is an optional parameter that
shall at least be supported by VLR implementing the Mobile Terminating Roaming
Retry feature (see 3GPP TS 23.018 [5a]). A VLR not supporting this flag shall
behave as if the flag is set to false.
Sheet 2: A VLR supporting the Mobile Terminating Roaming Retry feature sets
the \"Cancel Location received\" flag to false after authenticating the radio
connection. This is used to determine whether to trigger MT roaming retry upon
receipt of an incoming call, see subclause 7.3.2.1 of 3GPP TS 23.018 [5a].
Sheet 3: the procedure Obtain_IMSI_VLR is specified in 3GPP TS 23.018 [5a].
The type of Location Update is retrieved in 3GPP TS 23.078 [11] procedure
\'Set_Notification_Type\' and is returned into the \'Notify\' variable; this
information is necessary for the CAMEL Mobility Management event notification
procedure 3GPP TS 23.078 [11] \'Notify_gsmSCF\'.
{width="6.684722222222222in" height="8.959722222222222in"}
Figure 4.1.2.1 (sheet 1 of 3): Process Update_Location_Area_VLR
{width="6.686111111111111in" height="8.01736111111111in"}
Figure 4.1.2.1 (sheet 2 of 3): Process Update_Location_Area_VLR
{width="6.688194444444444in" height="7.747916666666667in"}
Figure 4.1.2.1 (sheet 3 of 3): Process Update_Location_Area_VLR
{width="6.691666666666666in" height="8.09375in"}
Figure 4.1.2.1 (sheet 4 of 4): Process Update_Location_Area_VLR
#### 4.1.2.1a Procedure Retrieve_IMEISV_If_Required
The decision box \"received IMEISV = stored IMEISV\" takes the \"No\" exit if
no IMEISV is stored.
{width="5.752083333333333in" height="6.956944444444445in"}
Figure 4.1.2.1A: Procedure Retrieve_IMEISV_If_Required
#### 4.1.2.2 Procedure Authenticate_VLR
Sheet 2: The procedure Obtain_IMSI_VLR is specified in 3GPP TS 23.018 [5a].
{width="6.692361111111111in" height="8.444444444444445in"}
Figure 4.1.2.2 (sheet 1 of 2): Procedure Authenticate_VLR
{width="6.692361111111111in" height="8.444444444444445in"}
Figure 4.1.2.2 (sheet 2 of 2): Procedure Authenticate_VLR
#### 4.1.2.3 Procedure Location_Update_Completion_VLR
Sheet 1: Decision \"National Roaming Restrictions Exist?\" distinguishes
whether or not the subscriber is allowed service in the target LA, based on
the current location of the MS and the VLR\'s knowledge of other networks. The
\"Yes\" branch results in the sending of \"Update Location Area Negative
Response\" toward the MSC (and the MS), with cause \"National Roaming Not
Allowed.\" However, subscriber data shall not be deleted from the VLR. This is
to avoid unnecessary HLR updating should the subscriber be allowed
subsequently to roam in other LAs of the same MSC.
Sheet 1: Decision \"Access-Restriction-Data permits current RAT?\" performs a
check on the subscriber\'s AccessRestrictionData information received from the
HLR and either allows the operation to continue or rejects the Location
Update. The decision is taken according to the following:
-If AccessRestrictionData value includes \"GERAN not allowed\" and the LA/RA, where the MS accesses the network, is served by GERAN, then the subscriber\'s access is not permitted.
-If AccessRestrictionData value includes \"UTRAN not allowed\" and the LA/RA, where the MS accesses the network is served by UTRAN, then the subscriber\'s access is not permitted.
Sheet 1: When the Location Update is not allowed because the subscriber access
is restricted due to Administrative Restriction of Subscribers\' Access
feature, the flow results in the sending of \"Update Location Area Negative
Response\" toward the MSC (and the MS). The recommended cause code is \"RAT
not allowed\", but cause codes \"PLMN not allowed\" or \"National Roaming Not
allowed\" may also be used based on operator configuration and the required MS
behaviour.
Note: For the mapping of MAP Process cause code values to values on the MM
protocol interface see 3GPP TS 29.010 [14].
For the MS behaviour determined on the received cause code see 3GPP TS
24.008[13].
Sheet 1: Decision \"Roaming restriction due to Unsupported Feature received in
subscriber data?\" distinguishes whether or not the subscriber data received
from the HLR indicates \"roaming restriction due to unsupported feature.\" The
\"Yes\" branch results in the sending of \"Update Location Area Negative
Response\" toward the MSC (and the MS), with cause \"National Roaming Not
Allowed.\" However, subscriber data shall not be deleted from the VLR. This is
to avoid unnecessary HLR updating should the subscriber be allowed
subsequently to roam in other LAs of the same MSC.
Sheet 1: Decision \"Regional subscription restriction\" distinguishes whether
or not the subscriber is allowed service in the target LA, which the VLR
deduces based on regional subscription information received from the HLR. The
\"Yes\" branch results in the sending of \"Update Location Area Negative
Response\" toward the MSC (and the MS), with cause \"location area not
allowed.\" However, subscriber data shall not be deleted from the VLR. This is
to avoid unnecessary HLR updating should the subscriber be allowed
subsequently to roam in other LAs of the same MSC.
Sheet 1: Causes \"National Roaming Not Allowed\" and \"RAT not allowed\" lead
to sending of cause #13 (roaming not allowed in the Location Area) and #15 (no
suitable cells in Location Area) respectively to the MS (see 3GPP TS 29.010
[14]). On receipt of cause #13 or #15 the TMSI and LAI currently stored in the
MS are not deleted (see 3GPP TS 24.008 [13]). As an option (referred-to as
\"TMSI option\"), for these two reject causes, the VLR may forward a new TMSI
(with the new LAI) together with the sending of \"Update Location Area
Negative Response\" toward the MSC. The Location Updating Reject is sent to
the MS after forwarding of the new TMSI (and new LAI) (see subclause 4.1.1.1).
This optional TMSI allocation (with new LAI) ensures that:
\- a pre-Rel-8 MS will initiate a location updating if it roams back to the
previous Location Area (allowed), i.e. to the location area whose identity is
already stored in the MS, after having received the reject cause #13 or #15;
otherwise the location updating may not be initiated and mobile terminated
calls may not be delivered until the next mobile originated activity or
periodic location update (see 3GPP TR 29.994 [18]).
\- the next location update enables the new VLR to address the correct
previous VLR (which controls the not allowed Location Area) and to obtain the
right IMSI and security context; otherwise a wrong VLR is addressed
(corresponding to the TMSI/LAI of the VLR that controlled the previous allowed
LA) and a wrong IMSI / security context would be obtained if the TMSI was
reallocated.
Sheet 2: If the MS performs a location update procedure in a VPLMN supporting
Autonomous CSG Roaming and the HPLMN has enabled Autonomous CSG Roaming in the
VPLMN (via Service Level Agreement) and if the VLR needs to retrieve the CSG
Subscription Data of the MS from the CSS, the VLR shall initiate the Update
VCSG Location Procedure with the CSS and store the CSG Subscription data if
any received from the CSS. The stored CSG Subscription data is used by VLR to
perform access control for the MS.
If the Update VCSG Location Procedure fails, the VLR continues the location
update procedure.
Sheet 3: The procedure Check_IMEI_VLR is specified in 3GPP TS 23.018 [5a].
{width="6.692361111111111in" height="8.094444444444445in"}
Figure 4.1.2.3 (sheet 1 of 3): Procedure Location_Update_Completion_VLR
{width="6.6930555555555555in" height="6.784027777777778in"}
Figure 4.1.2.3 (sheet 2 of 3): Procedure Location_Update_Completion_VLR
{width="6.23125in" height="7.935416666666667in"}
Figure 4.1.2.3 (sheet 3 of 3): Procedure Location_Update_Completion_VLR
#### 4.1.2.4 Procedure Update_HLR_VLR
Sheet 1: The procedure Check_User_Error_In_Serving_Network_Entity is specific
to Super-Charger; it is specified in 3GPP TS 23.116 [7].
Sheet 1: A VLR supporting the MT Roaming Forwarding feature (see 3GPP TS
23.018 [5a]) includes the \"MTRF supported\" flag in the MAP Update Location
message sent to the HLR. After sending this message, the VLR may receive at
any time an MT Provide Roaming Number request including the MTRF Indicator
from the old VLR in the WAIT_FOR_DATA state _(not represented in the SDL)_.
{width="6.688194444444444in" height="8.520833333333334in"}
Figure 4.1.2.4 (sheet 1 of 1): Procedure Update_HLR_VLR
#### 4.1.2.5 Procedure Insert_Subs_Data_VLR
The procedure Check_Parameters is specified in 3GPP TS 23.018 [5a].
{width="6.299305555555556in" height="8.039583333333333in"}
Figure 4.1.2.5 (sheet 1 of 1): Procedure Insert_Subs_Data_VLR
#### 4.1.2.6 Procedure Activate_Tracing_VLR
The procedure Check_Parameters is specified in 3GPP TS 23.018 [5a].
{width="6.301388888888889in" height="7.621527777777778in"}
Figure 4.1.2.6 (sheet 1 of 1): Procedure Activate_Tracing_VLR
#### 4.1.2.7 Process Send_Identification_PVLR
Sheet 1: The procedure Check_Parameters is specified in 3GPP TS 23.018 [5a].
Sheet 1: Decision \"IuFlex applied?\" distinguishes whether or not the PVLR
applies \"Intra Domain Connection of RAN Nodes to Multiple CN Nodes\" as
described in 3GPP TS 23.236 [12]. If this feature is applied, the VLR shall
extract the NRI from the TMSI and attempt to derive the VLR address of the VLR
where the subscriber was previously registered, denoted in the following as
the \"real PVLR\".
Sheet 1: Decision \"Result = success?\" distinguishes whether the NRI could be
successfully converted into the \"real PVLR\" address. In case of successful
conversion, the PVLR shall relay the received Send_Identification message to
the \"real PVLR\" as specified in 3GPP TS 23.236 [12]. The new VLR and the
\"real PVLR\" shall not perceive that relaying is being performed, i.e. they
shall not notice the presence of the relaying node. The actual mechanism used
to perform the relay is an implementation choice. A possible mechanism is
described in section 4.1.2.9.
Sheet 1: If supported by the VLR, the \"Subscriber data dormant\" flag shall
be set to true to reflect that the MS has moved outside the VLR area. A VLR
not supporting this flag shall behave as if the flag is set to false.
NOTE: HLRs compliant with this release of the specification and supporting
mobile terminating roaming retry and Super-Charger will always send a Cancel
Location message to the old VLR even in a supercharged network (see 3GPP TS
23.018 [5a]). HLRs compliant with an earlier release of the specification may
not always send a Cancel Location message in a supercharged network. To
support mobile terminating roaming retry with such HLR implementations, the
old VLR can start a timer upon receipt of the MAP Send Identification message
while on-going paging to trigger the sending of an internal Cancel Location to
the old MSC and thus the sending of a MAP Resume Call Handling message by the
old MSC to the GMSC after the sending of the MAP Update Location by the new
VLR to the HLR.
{width="6.691666666666666in" height="8.269444444444444in"}
Figure 4.1.2.7 (sheet 1 of 1): Process Send_Identification_PVLR
#### 4.1.2.8 Process Trace_Subscriber_Activity_VLR
{width="6.298611111111111in" height="7.61875in"}
Figure 4.1.2.8 (sheet 1 of 1): Process Trace_Subscriber_Activity_VLR
#### 4.1.2.9 Procedure Perform Relaying
The relay may be performed by opening a new MAP dialogue to the \"real PVLR\"
and keeping it linked to the existing MAP dialogue between the new VLR and the
PVLR. Every message received for one of these dialogues shall be relayed to
the other one, until the two dialogues are closed. This mechanism is described
in figure 4.1.2.9.
In order to improve the signalling efficiency of the relaying function,
alternative mechanisms may be implemented as long as no difference shall be
perceived by the new VLR and the \"real PVLR\".
The usage of a Hop Counter is an optional optimization.
{width="6.29375in" height="7.611805555555556in"}
Figure 4.1.2.9 (sheet 1 of 1): Procedure Perform Relaying
#### 4.1.2.10 Procedure Update_VCSG_Location_VLR
The VLR uses this procedure to register the MS with the CSG Subscriber Server
and may retrieve the CSG subscription data from CSS.
When using this procedure, the VLR sends an Update VCSG Location request
towards the CSS, and waits for the answer from the CSS.
\- If the VLR receives a negative Update VCSG Location response from the CSS,
the VLR sets the result with failure cause and ends this procedure.
\- If the VLR receives an Insert VCSG Subscriber Data request, it shall update
the CSG Subscription Data and returns a response message to CSS. The CSG
Subscription Data received from the CSS is stored and managed in the VLR
independently from the CSG Subscription Data received from the HLR. If the
same CSG ID exists in both CSG Subscription Data from the CSS and CSG
Subscription Data from the HLR, the CSG Subscription Data from the HLR shall
take precedence over the CSG Subscription Data from the CSS.
\- If the VLR receives a successful Update VCSG Location ACK message, it ends
the procedure.
> \- If the successful Update VCSG Location ACK message indicates that there
> is no CSG Subscription data, the VLR shall not send any subsequent Update
> VCSG Location Request message to the CSS.
{width="6.6930555555555555in" height="7.772222222222222in"}
Figure 4.1.2.10 (sheet 1 of 1): Procedure Update_VCSG_Location_VLR
#### 4.1.2.11 Procedure Insert_VCSG_Subs_Data_VLR
Whenever the CSG subscription data is changed for a MS in the CSS, and the
changes affect the CSG subscription data stored in the VLR, the CSS shall
inform the VLR about the changes by the means of an Insert VCSG Subscriber
Data request (IMSI, CSG subscription data) which initiates the procedure
Insert_VCSG_Subs_Data_VLR.
The VLR checks the received parameters. If the MS is unknown, the VLR shall
send a negative Insert VCSG Subscriber Data response message to the CSS that
deregisters the VLR for this MS. If the MS is known, the VLR shall update the
stored CSG subscription data and acknowledge the Insert VCSG Subscriber Data
request by returning an Insert VCSG Subscriber Data Ack.
The CSG Subscription Data received from the CSS is stored and managed in the
VLR independently from the CSG Subscription Data received from the HLR. The
Insert VCSG Subscriber Data procedure shall only affect the CSG Subscription
Data received from the CSS.
If the same CSG ID exists in both CSG Subscription Data from the CSS and CSG
Subscription Data from the HLR, the CSG Subscription Data from the HLR shall
take precedence over the CSG Subscription Data from the CSS.
{width="6.6930555555555555in" height="5.253472222222222in"}
Figure 4.1.2.11 (sheet 1 of 1): Procedure Insert_VCSG_Subs_Data_VLR
### 4.1.3 Detailed procedure in the HLR
#### 4.1.3.1 Process Update_Location_HLR
The Paging Area function is an optional feature that allows the HLR to be
updated with the current Paging Area (PgA) (see subclause 2.6). If supported,
the HLR shall store the Paging Area received from the VLR in MAP Update
Location requests. If the Paging Area parameter is not included in a MAP
Update Location request and the VLR has not changed, the HLR shall keep the
stored Paging Area. If the Paging Area parameter is not included in a MAP
Update Location request and the VLR has changed, the HLR shall delete the
stored Paging Area.
Sheet 1: The procedure Check_Parameters is specified in 3GPP TS 23.018 [5a].
Sheet 1: The procedure Super_Charged_Cancel_Location_HLR is specific to Super-
Charger; it is specified in 3GPP TS 23.116 [7]. Sheet 2: The procedure
Super_Charged_Location_Updating_HLR is specific to Super-Charger; it is
specified in 3GPP TS 23.116 [7]. If subscription data needs to be sent to the
VLR, processing continues from the \"No\" exit of the test \"Result=Pass?\".
Sheet 2: The execution of the test \"skip subscriber data update?\" is
optional and depends on the presence of the relevant indication from the VLR.
If no indication is received, then the result of the test is \"No\". The HLR
may additionally skip the procedures Update_Routing_Info and
Control_Tracing_HLR if this indication is received from the VLR.
Sheet 2: If the HLR supports the Administrative Restriction of Subscribers
Access feature and roaming is allowed in the VPLMN then the HLR may check the
\"Supported RAT Types\" received from the VLR against the access restriction
parameters. If this check fails then the decision box \"Roaming allowed in
this PLMN\" shall take the exit \"No\".
Sheet 2: If the HLR supports MSISDN-less subscriptions and the subscriber\'s
subscription is MSISDN-less, the test \"Subscriber Allowed to Roam into
PLMN?\" takes the \"no\" exit e.g. if the VLR is known not to support MSISDN-
less operation (see clause 3.6.1.5).
{width="6.688888888888889in" height="8.075in"}
Figure 4.1.3.1 (sheet 1 of 3): Process Update_Location_HLR
{width="6.691666666666666in" height="8.09375in"}
Figure 4.1.3.1 (sheet 2 of 3): Process Update_Location_HLR
{width="6.692361111111111in" height="8.094444444444445in"}
Figure 4.1.3.1 (sheet 3 of 3): Process Update_Location_HLR
#### 4.1.3.2 Procedure Insert_Subscriber_Data_HLR
{width="6.692361111111111in" height="8.094444444444445in"}
Figure 4.1.3.2 (sheet 1 of 2): Procedure Insert_Subscriber_Data_HLR
{width="6.692361111111111in" height="8.094444444444445in"}
Figure 4.1.3.2 (sheet 2 of 2): Procedure Insert_Subscriber_Data_HLR
#### 4.1.3.3 Process Subscriber_Present_HLR
The macro Alert_Service_Centre_HLR is specified in 3GPP TS 29.002 [8].
{width="6.691666666666666in" height="8.09375in"}
Figure 4.1.3.3: Process Subscriber_Present_HLR
#### 4.1.3.4 Procedure Control_Tracing_HLR
{width="6.6930555555555555in" height="7.592361111111111in"}
Figure 4.1.3.4 (sheet 1 of 1): Procedure Control_Tracing_HLR
### 4.1.4 Detailed procedure in the CSS
#### 4.1.4.1 Process Update_VCSG_Location_CSS
The Update_VCSG_Location_CSS process takes place when the VLR needs to
register the MS with the CSS and retrieve the CSG Subscription Data of the MS
from the CSS.
The CSS receives an Update VCSG Location Request from the VLR.
If the MS is unknown in the CSS, and if the CSS supports creating the
temporary empty subscription data for the MS, the CSS should create
subscription data and sends successful update VCSG Location ACK message,
otherwise the CSS shall sends a negative Update VCSG Location response
message.
If the MS is known in the CSS, the CSS stores the received VLR number and
initiates the Process Insert_VCSG_Subs_Data _CSS and at the end of the process
acknowledges the Update VCSG Location request by sending an Update VCSG
Location ACK message to the VLR.
{width="6.7in" height="7.396527777777778in"}
Figure 4.1.4.1 (sheet 1 of 1): Process Update_VCSG_Location_CSS
#### 4.1.4.2 Procedure Insert_VCSG_Subs_Data_CSS
Whenever the CSG subscription data is changed for a MS in the CSS, and the
changes affect the CSG subscription data stored in the VLR, the CSS initiates
the Procedure Insert_VCSG_Subs_Data_CSS.
The Procedure Insert_VCSG_Subs_Data_CSS is also triggered by the
Update_VCSG_Location_CSS process as specified in subclause 4.1.4.1.
When executing this procedure, the CSS sends an Insert VCSG Subscriber Data
Request containing the CSG Subscription Data of the MS to the VLR and waits
for the response from the VLR.
If the VLR successfully updates the received CSG Subscription Data from the
CSS, it acknowledges the Insert VCSG Subscriber Data Request by returning an
Insert VCSG Subscriber Data Ack. The CSS may wait for each request to be
acknowledged before it ends the procedure.
If the CSS receives a negative response from the VLR, it sets the result with
failure cause and ends this procedure.
{width="6.6930555555555555in" height="8.13263888888889in"}
Figure 4.1.4.2 (sheet 1 of 2): Procedure Insert_VCSG_Subs_Data_CSS
{width="6.6930555555555555in" height="4.279861111111111in"}
Figure 4.1.4.2 (sheet 2 of 2): Procedure Insert_VCSG_Subs_Data_CSS
## 4.2 Location Cancellation
### 4.2.1 Detailed procedure in the VLR
#### 4.2.1.1 Process Cancel_Location_VLR
The procedure Check_Parameters is specified in 3GPP TS 23.018 [5a].
Sheet 1: If supported by the VLR, the \"Subscriber data dormant\" flag shall
be set to true to allow triggering Mobile Terminating Roaming Retry. A VLR not
supporting this flag shall behave as if the flag is set to false.
Sheet 1: A VLR not supporting the Mobile Terminating Roaming Retry feature and
the Mobile Terminating Roaming Forwarding fearture (see 3GPP TS 23.018 [5a])
may not send Cancel Location to MSC.
Sheet 1: A VLR supporting the Mobile Terminating Roaming Retry feature sets
the \"Cancel Location received\" flag to true when receiving the Cancel
Location message from the HLR. This is used to determine whether to trigger MT
roaming retry upon receipt of an incoming call, see subclause 7.3.2.1 of 3GPP
TS 23.018 [5a].
Sheet 1: A VLR supporting the Mobile Terminating Roaming Forwarding feature
may include the MTRF Supported And Authorized flag or the MTRF Supported And
Not Authorized flag in the Cancel Location message it sends to the MSC if
received in the Cancel Location message from the HLR.
{width="6.691666666666666in" height="8.61875in"}
Figure 4.2.1.1 (Sheet 1 of 2): Process Cancel_Location_VLR
{width="5.980555555555555in" height="7.231944444444444in"}
Figure 4.2.1.1 (Sheet 2 of 2): Process Cancel_Location_VLR
### 4.2.2 Detailed procedure in the HLR
#### 4.2.2.1 Process Cancel_Location_HLR
{width="6.692361111111111in" height="8.094444444444445in"}
Figure 4.2.2.1: Process Cancel_Location_HLR
## 4.2A VCSG Location Cancellation
### 4.2A.1 Detailed procedure in the VLR
#### 4.2A.1.1 Process Cancel_VCSG Location_VLR
The procedure Check_Parameters is specified in 3GPP TS 23.018 [5a].
Figure 4.2A.1.1 (Sheet 1 of 1): Process Cancel_VCSG_Location_VLR
### 4.2A.2 Detailed procedure in the CSS
#### 4.2A.2.1 Process Cancel_VCSG Location
If the CSS determines to delete the registration of the MS which does not have
the valid CSG subscription data, the CSS shall send the Cancel VCSG Location
to the VLR.
NOTE: How the CSS determines when to remove the registration of the MS is
implementation dependent.
Figure 4.2A.2.1: Process Cancel_Location_CSS
## 4.3 Detach IMSI
### 4.3.1 Detailed procedure in the MSC
#### 4.3.1.1 Process Detach_IMSI_MSC
{width="6.301388888888889in" height="7.621527777777778in"}
Figure 4.3.1.1 (Sheet 1 of 1): Process Detach_IMSI_MSC
### 4.3.2 Detailed procedure in the VLR
#### 4.3.2.1 Process Detach_IMSI_VLR
The signal \"Authenticated Radio Contact Terminated\" is sent to Process
Detach_IMSI_VLR from RR handling in the MSC whenever authenticated radio
contact is terminated, e.g. at the release of a call.
The procedure \"Notify_gsmSCF\" is specified in 3GPP TS 23.078 [11]. The
\"Notify\" parameter indicates whether the IMSI detach was explicit or
implicit.
{width="6.707638888888889in" height="8.121527777777779in"}
Figure 4.3.1.1 (Sheet 1 of 1): Process Detach_IMSI_VLR
## 4.4 Purge MS
### 4.4.1 Detailed procedure in the VLR
#### 4.4.1.1 Procedure Purge_MS_VLR
Sheet 1: The procedure Purge_MS_In_Serving_Network_Entity is specific to
Super-Charger; it is specified in 3GPP TS 23.116 [7]. If the VLR and the
originating HLR support the Super-Charger functionality, processing continues
from the \"Yes\" exit of the test \"Result=Pass?\".
{width="6.688888888888889in" height="8.60138888888889in"}
Figure 4.4.1.1 (Sheet 1 of 1): Procedure Purge_MS_VLR
### 4.4.2 Detailed procedure in the HLR
#### 4.4.2.1 Process Purge_MS_HLR
The procedure Check_Parameters is specified in 3GPP TS 23.018 [5a].
If the received VLR number and the stored VLR number do not match, the HLR
sends Purge MS ack containing an empty result to indicate successful outcome.
Since the MS is known by the HLR to be in a different VLR area, it is not
appropriate to block mobile terminated calls or short messages to the MS, but
the VLR which initiated the purging procedure can safely purge its record for
the MS without freezing the TMSI.
If the received SGSN number and the stored SGSN number do not match, the HLR
sends a Purge MS ack containing an empty result to indicate successful
outcome. Since the MS is known by the HLR to be in a different SGSN area, it
is not appropriate to block short messages to the MS, but the SGSN which
initiated the purging procedure can safely purge its record for the MS without
freezing the P-TMSI.
{width="6.692361111111111in" height="8.094444444444445in"}
Figure 4.4.2.1 (Sheet 1 of 1): Procedure Purge_MS_HLR
#
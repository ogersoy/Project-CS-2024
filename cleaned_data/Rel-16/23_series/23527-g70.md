# Foreword
This Technical Specification has been produced by the 3rd Generation
Partnership Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
In the present document, modal verbs have the following meanings:
**shall** indicates a mandatory requirement to do something
**shall not** indicates an interdiction (prohibition) to do something
The constructions \"shall\" and \"shall not\" are confined to the context of
normative provisions, and do not appear in Technical Reports.
The constructions \"must\" and \"must not\" are not used as substitutes for
\"shall\" and \"shall not\". Their use is avoided insofar as possible, and
they are not used in a normative context except in a direct citation from an
external, referenced, non-3GPP document, or so as to maintain continuity of
style when extending or modifying the provisions of such a referenced
document.
**should** indicates a recommendation to do something
**should not** indicates a recommendation not to do something
**may** indicates permission to do something
**need not** indicates permission not to do something
The construction \"may not\" is ambiguous and is not used in normative
elements. The unambiguous constructions \"might not\" or \"shall not\" are
used instead, depending upon the meaning intended.
**can** indicates that something is possible
**cannot** indicates that something is impossible
The constructions \"can\" and \"cannot\" are not substitutes for \"may\" and
\"need not\".
**will** indicates that something is certain or expected to happen as a result
of action taken by an agency the behaviour of which is outside the scope of
the present document
**will not** indicates that something is certain or expected not to happen as
a result of action taken by an agency the behaviour of which is outside the
scope of the present document
**might** indicates a likelihood that something will happen as a result of
action taken by some agency the behaviour of which is outside the scope of the
present document
**might not** indicates a likelihood that something will not happen as a
result of action taken by some agency the behaviour of which is outside the
scope of the present document
In addition:
**is** (or any other verb in the indicative mood) indicates a statement of
fact
**is not** (or any other negative verb in the indicative mood) indicates a
statement of fact
The constructions \"is\" and \"is not\" do not indicate requirements.
# 1 Scope
The present document defines the restoration procedures in the 5G System.
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or non‑specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
[1] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[2] 3GPP TS 23.007: \"Restoration procedures\".
[3] 3GPP TS 29.281: \"General Packet Radio System (GPRS) Tunneling Protocol
User Plane (GTPv1-U)\".
[4] 3GPP TS 29.244: \"Interface between the Control Plane and the User Plane
Nodes; Stage 3\".
[5] 3GPP TS 23.502:\"Procedures for the 5G System; Stage 2\"
[6] 3GPP TS 29.518: \"5G System; Access and Mobility Management Service; Stage
3\".
[7] 3GPP TS 29.510: \"5G System; Network Function Repository Services; Stage
3\".
[8] 3GPP TS 23.041: \"Technical realization of Cell Broadcast Service (CBS)\".
[9] 3GPP TS 23.501: \"System Architecture for the 5G System; Stage 2\".
[10] 3GPP TS 29.500: \"5G System; Technical Realization of Service Based
Architecture; Stage 3\".
# 3 Definitions and abbreviations
## 3.1 Definitions
For the purposes of the present document, the terms and definitions given in
3GPP TR 21.905 [1] and 3GPP TS 29.244 [4] and the following apply. A term
defined in the present document takes precedence over the definition of the
same term, if any, in 3GPP TR 21.905 [1] and 3GPP TS 29.244 [4].
## 3.2 Abbreviations
For the purposes of the present document, the abbreviations given in 3GPP TR
21.905 [1] and the following apply. An abbreviation defined in the present
document takes precedence over the definition of the same abbreviation, if
any, in 3GPP TR 21.905 [1].
F-SEID Fully Qualified SEID
PFCP Packet Forwarding Control Protocol
PSA PDU Session Anchor
# 4 Restoration Procedures related to the N4 Interface
## 4.1 General
This clause specifies the procedures supported in the 5G System to detect and
handle failures affecting the N4 interface.
## 4.2 N4 Failure and Restart Detection
Across PFCP based interfaces, an SMF and UPF shall utilize the PFCP Heartbeat
Request and Heartbeat Response messages to detect a peer PFCP entity failure
or restart as described in clause 19A of 3GPP TS 23.007 [2].
A PFCP function shall ignore the Recovery Timestamp received in PFCP
Association Setup Request and PFCP Association Setup Response messages (see
clause 6.2.6 of 3GPP TS 29.244 [4]).
## 4.3 UPF Restoration Procedures
### 4.3.1 General
When a UPF fails, all its Session contexts and PFCP associations affected by
the failure become invalid and may be deleted.
### 4.3.2 Restoration Procedure for PSA UPF Restart
If F-TEID and/or UE IP address allocation is performed in the UPF, the UPF
shall ensure that previously used F-TEID values and/or UE IP addresses are not
immediately reused after a UPF restart, in order to avoid inconsistent F-TEID
and/or UE IP address allocation throughout the network and to enable the
restoration of PFCP sessions affected by the failure. How this is ensured is
implementation specific.
The UPF shall not send GTP-U Error indication message for a configurable
period after an UPF restart when the UPF receives a G-PDU not matching any
PDRs.
During or immediately after an UPF Restart, the UPF shall place a local UPF
Recovery Time Stamp value in all Heartbeat Request/Response messages.
Immediately after the re-establishment of a PFCP association between the SMF
and the UPF, the SMF may start restoring PFCP sessions in the UPF.
The SMF should prioritize the PFCP sessions to restore based on operator\'s
policy.
The SMF should control the load induced on the UPF when performing the PFCP
restoration procedures, the way it is done is implementation specific.
When re-establishing a PFCP session and if F-TEID allocation and/or UE IP
address is performed in the PSA UPF by network configuration, the SMF shall
include a restoration indication in the PFCP Session Establishment Request
message to indicate to the UPF it is for a restoration of an existing PFCP
session and the UPF shall accept SMF allocated F-TEID and/or UE IP address if
possible.
### 4.3.3 Restoration Procedure for PSA UPF Failure without Restart
Procedures for PSA UPF failure without restart are implementation specific.
### 4.3.4 Restoration Procedure for Intermediate UPF Restart
The SMF will receive the UPF recovery time stamps in PFCP heartbeat
requests/responses.
After an Intermediate UPF restart, the PFCP association between the SMF(s) and
the Intermediate UPF has to be re-established.
The restoration of the PFCP sessions may start immediately after the PFCP
association setup procedure:
\- if the restoration is supported in the SMF on a proactive basis, the SMF
may start re-establishing PFCP sessions matching any PDRs.
\- as defined in clause 4.3.2, the SMF should prioritize the PFCP sessions
restoration.
\- if the restoration is supported in the SMF on a reactive basis:
\- the SMF shall establish an PFCP session with a wildcarded PDR to instruct
the Intermediate UPF to forward G-PDU packets which are not matching any other
PDRs to the SMF (to a F-TEID uniquely assigned in the SMF for this PFCP-u
tunnel);
\- upon receipt of G-PDUs from this PFCP-u tunnel, the SMF shall then check if
it has an active session for each received G-PDU packet:
\- if so, the SMF shall perform the PFCP Session establishment procedures to
re-establish the corresponding PFCP sessions in the Intermediate UPF;
\- otherwise the SMF shall generate a GTP-U Error Indication with a
destination address set to the source IP address of the received G-PDU, and
send it to the Intermediate UPF. The Intermediate UPF shall forward this GTP-U
Error Indication transparently. The SMF shall delete the G-PDU after the check
for active sessions.
NOTE 1: The UPF can filter the G-PDU packets with same target F-TEID and send
only one such G-PDU to the Intermediate SMF.
When re-establishing a PFCP session and if F-TEID allocation is performed in
the Intermediate UPF by network configuration, the SMF shall include a
restoration indication in the PFCP Session Establishment Request message to
indicate to the UPF it is for a restoration of an existing PFCP session and
the UPF shall accept SMF allocated F-TEID if possible.
The Intermediate UPF shall not send any Error indication messages for an
operator configurable period after an Intermediate UPF restart when the
Intermediate UPF receives G-PDU not matching any PDRs.
NOTE 2: If restoration on a reactive basis is used, the period needs to be
longer than the time required by the SMF to detect the UPF restart, to
establish the PFCP association and provision the wildcarded PDR. Otherwise,
the period needs to be longer than the time required by the SMF to restore all
the PFCP sessions on a proactive basis.
### 4.3.5 Restoration Procedure for Intermediate UPF Failure without Restart
Procedures for Intermediate UPF failure without restart are implementation
specific.
## 4.4 SMF Restoration Procedures
### 4.4.1 General
When a SMF fails, all its PDU session contexts and PFCP associations affected
by the failure may become invalid and may be deleted.
If F-TEID allocation is performed in the SMF, the SMF should ensure as far as
possible that previously used F-TEID values are not immediately reused after a
SMF restart, in order to avoid inconsistent TEID allocation throughout the
network.
NOTE: This is to ensure that F-TEIDs are not reused until earlier PDU sessions
using them are released.
### 4.4.2 Restoration Procedure for SMF Restart
During or immediately after a SMF Restart, the SMF shall place local SMF-C
Recovery Time Stamp value in all Heartbeat Request/Response messages.
The UPF will receive the SMF recovery time stamps in PFCP heartbeat
requests/responses.
When a UPF detects that a peer PFCP entity in the SMF has restarted (as
specified in clause 4.2), the UPF shall delete all session contexts affected
by the PFCP entity restart that it may have stored. When the UPF receives a
GTP‑U PDU not matching any PDRs, it shall discard the GTP‑U PDU and return a
GTP error indication to the originating node (e.g. other UPF, gNB or N3IWF).
### 4.4.3 Restoration Procedure for SMF Failure without Restart
When a UPF detects that a peer PFCP entity in the SMF is not reachable for a
preconfigured time, the UPF shall delete all the session contexts affected by
the peer PFCP entity failure that it may have stored.
## 4.5 N4 path failure
If the N4 path to the UPF is down, the SMF should handle this as an UPF
Failure without Restart, see clause 4.3.3.
If the N4 path to the SMF is down, the UPF should handle this as a SMF Failure
without Restart, see clause 4.4.3.
# 5 Restoration Procedures related to the User Plane Interfaces N3 and N9
## 5.1 General
This clause specifies the procedures supported in the 5G System to detect and
handle failures affecting the user plane interfaces N3 and N9
## 5.2 User Plane Failure Detection
### 5.2.1 Loss of GTP-U contexts
A GTP-U entity may lose its GTP-U contexts upon a failure or restart.
When a GTP-U node receives a G-PDU for which no corresponding GTP-U tunnel
exists, the GTP-U node shall discard the G-PDU and return a GTP-U Error
Indication to the sending node, as specified in clause 7.3.1 of 3GPP TS 29.281
[3].
The receipt of a GTP-U Error Indication is an indication for the sending GTP-U
entity that the peer GTP-U entity cannot receive any more user plane traffic
on the corresponding GTP-U tunnel.
### 5.2.2 User Plane Path Failure
A GTP-U entity may detect a user plane path failure by using GTP-U Echo
Request and Echo Response messages, as specified in clause 20.3.1 of 3GPP TS
23.007 [2].
## 5.3 Restoration Procedures upon Loss of GTP-U contexts
### 5.3.1 General
The following clauses specify the behaviour of the different network entities
when receiving a GTP-U Error Indication.
### 5.3.2 Procedure for GTP-U Error Indication received from 5G-AN
#### 5.3.2.1 Principles
Figure 5.3.2.1-1: GTP-U Error Indication from 5G-AN
1\. The user plane connection of an existing PDU session is activated.
Downlink G-PDUs are sent towards the 5G-AN.
2\. The 5G-AN returns a GTP-U Error Indication if it does not have a
corresponding GTP-U context (see clause 5.2).
3\. Upon receipt of a GTP-U Error Indication, the UPF shall identify the
related PFCP session and send an Error Indication Report to the SMF, as
specified in clause 5.10 of 3GPP TS 29.244 [4].
4\. For a GTP-U Error Indication received from a 5G-AN, the SMF shall modify
the PFCP session to instruct the UPF to buffer downlink packets.
5\. If the user plane connection of the PDU session is seen as activated by
the SMF, the SMF shall initiate an Namf_Communication_N1N2MessageTransfer
service operation to request the 5G-AN to release the PDU session\'s
resources, as specified in clause 4.3.7 of 3GPP TS 23.502 [5].
6\. Upon receipt of an Namf_Communication_N1N2MessageTransfer request to
transfer the PDU Session Resource Release Command, the AMF shall:
\- proceed with the request, as specified in clause 5.2.2.3.1 of 3GPP TS
29.518 [6], if the UE is in CM-CONNECTED state for the Access Network Type
associated to the PDU session;
\- otherwise, reject the request with an error indicating that the UE is in
CM-IDLE state for the Access Network Type associated to the PDU session.
7\. If the AMF sent a PDU Session Resource Release Command to the 5G-AN, the
PDU session\'s resource release is acknowledged to the SMF.
8\. The SMF initiates the Network Triggered Service Request procedure
specified in clause 4.2.3.3 of 3GPP TS 23.502 [5], to re-activate the user
plane connection of the PDU session.
### 5.3.3 Procedure for GTP-U Error Indication received from UPF
#### 5.3.3.1 GTP-U Error Indication received by 5G-AN
Upon receipt of a GTP-U Error Indication, the 5G-AN shall proceed as follows:
\- if the GTP-U Error Indication was received from an UPF over a NG-U tunnel
that is not an indirect forwarding tunnel, the 5G-AN shall initiate a PDU
Session Resource Notify procedure and release immediately the resources of the
PDU session for which the Error Indication was received;
\- if the GTP-U Error Indication was received from a peer5G-AN over a Xn-U
direct forwarding tunnel or an UPF over a NG-U indirect forwarding tunnel, the
5G-AN may ignore the error indication or delete the forwarding tunnel context
locally without deleting the corresponding PDU session and bearers.
NOTE: The 5G-AN behaviour for dual connectivity is not described in this
specification.
#### 5.3.3.2 GTP-U Error Indication received by another UPF
Upon receipt of a GTP-U Error Indication, the UPF shall identify the related
PFCP session and send an Error Indication Report to the SMF, as specified in
clause 5.10 of 3GPP TS 29.244 [4].
Upon receipt of an Error Indication Report from the UPF, the SMF shall
identify the PDU session for which the Error Indication is received using the
remote F-TEID included in the report.
For a GTP-U Error Indication received from another UPF, the SMF shall delete
the PFCP session and PDU session, unless the UPF from which the Error
Indication was received is controlled by the same SMF and the SMF is able to
restore the user plane connectivity of the PDU session (e.g. Error Indication
received from an Intermediate UPF controlled by the same SMF).
## 5.4 Restoration Procedures upon User Plane Path Failure
Upon detecting a GTP-U user plane path failure as specified in clause 5.2.2,
the UPF shall report the user plane path failure to the SMF, by sending a PFCP
Node Report Request (see 3GPP TS 29.244 [4]) including a User Plane Path
Failure Report with the IP address of the remote GTP-U peer(s) towards which a
failure has been detected. The UPF should also notify the GTP-U user plane
path failure via the Operation and Maintenance system.
When the SMF receives the PFCP Node Report Request with a User Plane Path
Failure Report, the SMF may:
\- delete the PDU session contexts associated with the path in failure; or
\- maintain the PDU session contexts associated with the path in failure
during an operator configurable maximum path failure duration. The SMF shall
delete the PDU session contexts associated with the path in failure if the
path is still down when this duration expires.
NOTE 1: During transient path failures (e.g. path failures not exceeding few
minutes at most), maintaining the PDU session contexts associated with the
peer\'s IP address enables the delivery of end user services (when the path is
re-established again) and this also avoids unnecessary signalling in the
network for restoring those PDU sessions.
NOTE 2: It is not intended to maintain PDU session contexts during long path
failures (e.g. exceeding few minutes at most) as this would imply undesirable
effects like undue charging.
When deciding to delete the PDU session contexts associated with the path in
failure, the SMF shall modify or delete the affected PFCP sessions in the UPF.
NOTE 3: The SMF need to take care to smoothen the signalling load towards the
UPF if a large number of PFCP sessions are affected by the user plane path
failure.
# 6 Restoration Procedures related to Service-Based Interfaces
## 6.1 General
A NF may detect a failure or a restart of a peer NF or NF service using the
NRF as specified in clause 6.2.
A NF may also detect a restart of a peer NF or NF service by receiving
recovery time information in signalling exchanged with that peer NF or NF
service.
When NF (Service) Set is deployed in the network as specified in clauses
5.21.3 and 6.3.1.0 of 3GPP TS 23.501[9], an NF Service Producer in a NF
(Service) Set creates resource contexts and the context data is shared by all
the NF (Service) instances pertaining to the same NF (Service) set, i.e. the
resource context is bound to the NF (Service) Set. So, requests targeting the
resource may be served by any NF (Service) Instance within the NF (Service)
set, unless the shared contexts are lost (which is further referenced in this
specification as \"the NF (Service) Set has failed or restarted\").
In order to enable peer NFs to detect the loss of the resource contexts, i.e.
the \"restart of the NF (Service) Set or NF instance\", and trigger
appropriate restoration procedures, the NF Service Producer may provide a
recovery timestamp associated to the highest resiliency level that it supports
for the resource context, i.e. the binding entity with which the context data
is shared (bound). Binding entities are sorted from the highest to the lowest
resilience levels as follows: an NF Set, NF Instance, NF service set or NF
service instance. The NF Service Producer may signal this recovery timestamp
and its corresponding binding entity, in direct HTTP signalling or via the
NRF.
NOTE 1: Signalling the recovery timestamp of an NF (Service) Set or an NF
(Service) Instance via the NF profile in the NRF does not require the support
of Binding Indication.
NOTE 2: Signalling the recovery timestamp and its corresponding binding entity
in direct HTTP signalling requires the use of a Binding Indication (i.e.
\"3gpp-sbi-binding\" HTTP header, see clause 5.2.3.2.6 of 3GPP TS 29.500
[10]). When multiple binding entities are present in a Binding Indication, the
binding entity with the highest resiliency level is associated with the
recovery timestamp; otherwise (if there is only one binding entity in a
Binding Indication), the recovery timestamp is associated with that binding
entity in the Binding Indication.
A NF may prioritize the contexts to restore based on operator\'s policy.
A NF should control/regulate the load induced on a peer NF or NF service when
performing the restoration procedures.
The restoration procedures initiated when detecting a failure or a restart are
not specified in this release.
## 6.2 NF (NF Service) Failure and Restart Detection using the NRF
### 6.2.1 General
This clause describes optional procedures that may be supported by NFs to
detect the failure or restart of a NF or a NF service using the NRF.
### 6.2.2 NF (NF Service) Failure
Figure 6.2.2-1 describes a NF failure scenario and how other NFs can be
notified of this failure.
Figure 6.2.2-1: NF Failure Detection and Notification
1\. NF A subscribes to the NRF to receive notifications of changes of the NF B
Profile, as specified in 3GPP TS 29.510 [7].
2\. A NF failure occurs at NF B.
3\. The NRF detects that NF B is no longer operative using the NF Heart-Beat
procedure as specified in clause 5.2.2.3.2 of 3GPP TS 29.510 [7]. The NRF
changes the NFStatus of NF B to SUSPENDED.
4\. The NRF notifies NFs having subscribed to receive notifications of changes
of the NF B Profile that the NFStatus of NF B is changed to SUSPENDED.
5\. NF A may trigger appropriate restoration or clean-up actions, if it cannot
communicate with NF B.
Figure 6.2.2-2 describes a NF service failure scenario and how other NFs can
be notified of this failure.
Figure 6.2.2-2: NF Service Failure Detection and Notification
1\. NF A subscribes to the NRF to receive notifications of changes of the NF B
Profile.
2\. A NF Service failure occurs at NF B. NF B (other than the failed NF
Service) is still operative.
3\. NF B (or OAM) updates its NF Profile in the NRF, by setting the
NFServiceStatus of the failed NF Service to SUSPENDED.
4\. The NRF notifies NFs having subscribed to receive notifications of changes
of NF B Profile that the NF Service status of the failed NF service of NF B is
changed to SUSPENDED.
5\. NF A triggers appropriate restoration or clean-up actions, if it cannot
communicate with the NF B service.
### 6.2.3 NF (NF Service) Restart
Figure 6.2.3-1 describes a NF restart scenario and how other NFs can be
notified of this restart.
Figure 6.2.3-1: NF Restart Detection and Notification
1\. NF B (or OAM) registers NF B Profile to the NRF. The NF B Profile may
include the recoveryTime attribute, if a restart of NF B results in losing
contexts.\ \ NF B Profile may include the recoveryTime attribute of the NF Set
to which NF B pertains to, when NF B pertains to an NF Set, i.e. when the
resource contexts created in the NF B is bound to the NF Set, i.e. resource
contexts are accessible by all NF Instances within the NF Set.NOTE 1: The
restart of an NF Set indicates that resource contexts bound to the NF Set
(i.e. that are accessible by all NF Instances within the NF Set) have been
lost.2 NF A subscribes to the NRF to receive notifications of changes of the
NF B Profile.
3\. NF B restarts.
4\. If contexts are lost during the restart, NF B (or OAM) updates the
recoveryTime in its NF Profile in the NRF.\ \ NF B Profile shall update the
recoveryTime attribute of the NF Set to which NF B pertains to, if the whole
NF Set has restarted and NF B has registered the recoveryTime for that NF Set.
5\. The NRF notifies NFs having subscribed to receive notifications of changes
of NF B Profile about the updated recoveryTime of the NF B Profile or updated
recoveryTime of NF Set to which the NF B pertains to.
6\. NF A may consider that all the resources created in the NF B before the NF
B recovery time as have been lost. NF A triggers then appropriate restoration
or clean-up actions.
Figure 6.2.3-2 describes a NF service restart scenario and how other NFs can
be notified of this restart.
Figure 6.2.3-2: NF Service Restart Detection and Notification
1\. NF B (or OAM) registers its NF B Profile (and its services) to the NRF.
The NF B Profile may include the recoveryTime attribute for the NF Services it
supports, if a restart of a NF B service results in losing contexts. The NF B
Profile may include the recoveryTime attribute of either the NF Service Set,
NF Instance or NF Set to which the NF Service Instance pertains to, when the
resource context for the NF Service created in NF B is bound to NF Service
Set, or NF Instance, or NF Set respectively, i.e. accessible by all NF Service
Instances within an NF Service Set, NF Instance or NF Set respectively (see
clause 6.3.1.0 of 3GPP TS 23.501 [9]).
NOTE 2: The restart of an NF Service Set indicates that the resource contexts
bound to the NF Service Set (i.e. accessible by all NF Service Instances
within the NF Service Set) have been lost.
2 NF A subscribes to the NRF to receive notifications of changes of the NF B
Profile.
3\. A NF B service restarts.
4\. If contexts are lost during the service restart, NF B (or OAM) updates the
recoveryTime of the corresponding NF Service in the NRF. NF B (or OAM) shall
update the recoveryTime attribute of the NF Service Set, NF Instance or NF Set
to which the NF Service Instance pertains to, when the whole NF Service Set,
NF Instance or NF Set has restarted respectively.
5\. The NRF notifies NFs having subscribed to receive notifications of changes
of the NF B Profile about the updated recoveryTime of the NF B Service or
updated recoveryTime of the NF B Service Set, NF Instance or NF Set.
6\. NF A may consider that all the resources created in the NF B service
before the NF B service recovery time as have been lost. NF A triggers then
appropriate restoration or clean-up actions.
## 6.3 NF Service Producer Restart Detection using direct signalling between
NFs
### 6.3.1 General
This clause describes an optional procedure that may be supported by NFs to
detect the restart of a peer NF service using direct signalling between NFs.
### 6.3.2 NF Service Producer Restart
Figure 6.3.2-1 describes a NF Service restart scenario of an NF Service
Producer and how the NF Service Consumer can detect this restart.
Figure 6.3.2-1: NF Service Producer Restart Detection
1\. NF A (NF Service Consumer) requests to create a resource in the NF B (NF
Service Producer).
2\. If the request is accepted, and if NF B implements the procedure specified
in this clause, NF B shall return its NF B service instance ID in the
response, and NF A shall associate the created resource with the NF B service
instance if no Binding Indication is received from NF B.
In the response message, the NF B that supports this procedure may include the
recovery timestamp in the Binding Indication (i.e. in the \"3gpp-sbi-binding\"
HTTP header). An NF A that supports this procedure shall associate the created
resource with the binding entity and the recovery timestamp as specified in
clause 6.1.
3\. A NF service produced by NF B restarts, e.g. an NF Service Instance in NF
B, an NF Service Set in NF B, NF B or the NF Set to which NF B pertains has
restarted.
4-5. NF B Service Producer may include its last recovery timestamp in
responses it sends to the NF A Service Consumer, if the restart of the NF
service resulted in losing contexts and e.g. if the NF service has restarted
recently.
6\. NF A may consider that all the resource contexts are lost, which were
created in the NF B service instance before the updated recovery timestamp, if
the recovery timestamp was associated to the NF B service instance.\ \ If the
recovery timestamp was associated to an NF Service Set, NF Instance or NF Set,
NF A may consider that all the resource contexts are lost, which were created
in these binding entities before the recovery, as indicated in the received
recovery timestamp.\ \ NF A may trigger then appropriate restoration or clean-
up actions.
NOTE 1: The recovery time signalled in this procedure is equivalent to the
recovery time of the NF service of Figure 6.2.3-2. For an entire NF restart
scenario, this procedure can be applied by each NF service instance of the NF.
NOTE 2: This procedure enables the detection of a restart of a peer NF service
when sending signalling towards that NF Service. It can fasten the detection
of a restart of a peer NF service when frequent signalling occurs towards that
peer NF Service.
NOTE 3: In some use cases, NF A is not aware of the NF B Service Instance ID
when creating the resource, e.g. a V-SMF just receives the H-SMF URI from the
AMF to create a PDU session resource in H-SMF. Besides, for APIs supporting
distributed collections (e.g. SMF), the response can contain a different
Service Instance ID (that need not be registered in the NRF) than the one
selected by NF A for sending the request.
## 6.4 NF Service Consumer Restart Detection using direct signalling between
NFs
### 6.4.1 General
This clause describes an optional procedure that may be supported by NFs to
detect the restart of a peer NF Service Consumer by NF Service Producer using
direct signalling between NFs.
When NF (Service) Set is deployed in the network as specified in clause 5.21.3
and 6.3.1.0 of 3GPP TS 23.501[9], an NF Service Consumer in an NF (Service)
Set may create a session context for callback (corresponding to the resource
context in the NF Service Producer) when invoking a NF Service and the session
context data is shared by all NF (Service) instances pertaining to the same NF
(Service) set, i.e. the context is bound to the NF (Service) Set. So, any NF
(service) instance within the NF (service) set is able to receive
notifications or callback request from the NF Service Producer, unless the
shared contexts are lost (which is further referenced in this specification as
\"the NF (Service) Set has failed or restarted\").
In order to enable peer NF Service Producers to detect the loss of the session
contexts in the NF Service Consumer, i.e. the \"restart of the NF (Service)
Set or NF instance\", and trigger appropriate restoration procedures, the NF
Service Consumer may provide a recovery timestamp associated to the highest
resiliency level it supports for the context, i.e. the binding entitiy with
which the context data is shared (bound). Binding entities are sorted from the
highest to the lowest resilience levels as follows: an NF Set, NF Instance, NF
service set or NF service instance. The NF Service Consumer may signal this
recovery timestamp in direct HTTP signalling, using a Binding Indication.
### 6.4.2 NF Service Consumer Restart
Figure 6.4.2-1 describes a NF Service Consumer restart scenario and how the NF
Service Producer can detect this restart.
Figure 6.4.2-1: NF Service Consumer Restart Detection
1\. NF A (NF Service Consumer) requests to create a resource in the NF B (NF
Service Producer). If NF A implements the procedure specified in this clause,
it shall include a Consumer Id together with the last recovery timestamp in
the request. The Consumer Id shall be identical for all service requests
triggered by the NF service consumer for that service and shall be globally
unique (e.g. using UUID).\ \ If NF A includes Binding Indication(s) (i.e. in
the \"3gpp-sbi-binding\" HTTP header) in the request, NF A may include the
recovery timestamp for the higher level binding entity indicated in the
Binding Indication with the scope set to \"callback\" (see clause 5.2.3.2.6 of
3GPP TS 29.500 [10]).
2\. If resource creation is successful, NF B as service producer shall store
the received Consumer Id and recovery timestamp and associate the created
resource with it.\ \ An NF B that supports this procedure shall associate the
callback resource and the recovery timestamp to the higher level binding
entity indicated in the received Binding Indication (with the scope set to
\"callback\").\ \ If the Service Request contains Binding Indication(s) with
the scope set to \"other service\", the NF B may use the the binding
information and associated recovery timestamp to detect whether resources that
NF B has created in NF A have been lost, according to the principles specified
in clause 6.3.2.
3\. The NF service consumer in NF A restarts.
4\. The NF service consumer in NF A shall include its last recovery timestamp
together with the Consumer Id in the request when invoking service provided by
NF B. The same Consumer Id shall be used after restarting.\ \ If NF A includes
Binding Indication(s) in the request, NF A shall include the updated recovery
timestamp for the higher level binding entity to which the callback resource
context is bound in the Binding Indication with the scope set to \"callback\".
5\. NF B as NF service producer may compare the received recovery timestamp
with previous stored and detect the NF service consumer has restarted, if the
received recovery timestamp is newer than the previous one.
The consumer Id for the resource or the Binding Indication with the scope set
to \"callback\" may be updated if another service consumer took over the usage
of the resource. e.g. if a new consumer Id is received during a service
operation of a resource. NF B as NF service producer shall consider the
service consumer handling the resource has changed and associate the resource
with the new consumer Id or according to the new Binding Indication and with
the corresponding recovery timestamp.
6\. NF B may consider that the contexts in NF A corresponding to all the
resources associated with the consumer Id or all resources bound to the entity
(with which the recovery timestamp is associated) and the previous stored
recovery time stamp have been lost. NF B triggers then appropriate restoration
or clean-up actions.
NOTE 1: This procedure is only supported by NF services that support
signalling the recovery timestamp attribute.
NOTE 2: This procedure can be used when the resource is exclusively used by an
NF service consumer.
NOTE 3: This procedure enables the detection of a restart of a peer NF service
consumer when sending signalling towards that NF service producer. It is
helpful if the NF A as a pure service consumer without registration of its
profile in NRF. If NF A does have a profile registered in NRF, it also can
fasten the detection of a restart of a peer NF service consumer when frequent
signalling occurs towards that peer NF Service.
## 6.5 NF Service Producer Instance Reselection
### 6.5.1 General
An NF Instance of an NF Service Producer may expose several service instances
of the same NF Service (e.g., an UDM instance may expose several service
instances of the \"Nudm_SubscriberDataManagement\" service).
An NF Service Consumer or SCP may discover, via NRF Nnrf_NFDiscovery service,
all available NF Service Instances for a given NF Service and select one of
them.
### 6.5.2 NF Service Instance Reselection when a (Routing) Binding Indication
is available
When using the Binding procedures specified in clause 6.12 of 3GPP TS 29.500
[10], Binding Indications and Routing Binding Indications include the Binding
level and one or more Binding entity IDs representing all NF service instances
that are capable to serve service requests targeting the resource, i.e. that
share the same resource contexts.
When a Binding Indication or a Routing Binding Indication is available for a
target resource, NF Service Instance selection and re-selection shall be
supported as specified in clause 6.12 of 3GPP TS 29.500 [10].
### 6.5.3 NF Service Instance Reselection when a (Routing) Binding Indication
is not available
If a formerly selected NF Service Instance becomes unavailable, the NF Service
Consumer or SCP may select a different instance of a same NF Service in:
\- the same NF Instance, if the NF Instance indicates in its NF Profile that
it supports the capability to persist their resources in shared storage inside
the NF Instance, and if the new NF Service Instance offers the same major
service version; or
\- the same NF Set or NF Service Set, if the NF (service) instance indicates
in its NF Profile that it belongs to an NF Set or an NF Service Set.
If so, the NF Service Consumer or SCP may invoke service operations in the
newly selected NF Service Instance by means of replacing the addressing
parameters with those of the new service instance, and the new NF Service
Instance in the NF Service Producer shall produce the same result as if the
service request would have been successfully delivered to the former NF
Service Instance.
NOTE 1: In some scenarios, the newly selected NF Service Producer might not
produce the exact same result as the former NF Service Producer would have
produced for the service request, e.g. when the former NF Service Producer
failed before it could update a change in the resource context to the USDF.
For indirect communication, if the NF service consumer delegates target NF
service instance reselection to the SCP (when the target NF service instance
is not reachable), the NF Service Consumer shall include at least one of the
3gpp-Sbi-Discovery-target-nf-instance-id, 3gpp-Sbi-Discovery-target-nf-set-id,
3gpp-Sbi-Discovery-target-nf-service-set-id, 3gpp-Sbi-Discovery-amf-region-id
and 3gpp-Sbi-Discovery-amf-set-id headers, and it should also include at least
the following information in its request to the SCP:
\- the target NF type, the service name, and the requested S-NSSAI in the
corresponding \"3gpp-Sbi-Discovery-*\" request header(s) (see clause
6.10.3.2).
NOTE 2: This is to allow the SCP to discover and reselect a target NF service
instance from the target NF instance or target NF (service) set for the
corresponding service request and supporting the requested S-NSSAI, e.g. when
the NF service producer supports different NF service instances serving
different network slices. Likewise, other \"3gpp-Sbi-Discovery-*\" request
header(s), e.g. target-plmn-list, can also be included for the same purpose.
NOTE 3: The inclusion of the 3gpp-Sbi-Discovery-target-nf-instance-id in an
HTTP request enables the SCP to discover the profile of the target NF instance
and to possibly reselect a different target NF service instance from the same
NF instance or from a different NF instance in the same set.
If so, the SCP shall use the information provided by the NF service consumer
to perform a NF service discovery procedure and reselect a NF (service)
producer instance as specified in the preceding bullets, if possible and if
the target NF Service Instance indicated in the \"3gpp-Sbi-Target-apiRoot\"
header or target URI is not reachable.
NOTE 4: This reselection mechanism is applicable only for the request/response
service semantics, but not for notify/callback requests.
If the NF instance does not indicate in its NF Profile the support of the
capability to persist their resources in shared storage across service
instances of the same NF Service, inside the NF Instance, and if it does not
indicate in its NF Profile that it belongs to an NF Set or an NF Service Set,
the NF Service Consumer or SCP may still reselect any of the exposed service
instances, but it shall not assume that the resources created in the former
service instance are still valid.
## 6.6 NF Service Consumer Instance Reselection
### 6.6.1 General
When NF (Service) Set is deployed in the network as specified in clauses
5.21.3 and 6.3.1.0 of 3GPP TS 23.501[9], an NF Service Consumer in an NF
(Service) Set may create a session context for callback (corresponding to the
resource context in the NF Service Producer) when invoking a NF Service and
the session context data is shared by all NF (Service) instances pertaining to
the same NF (Service) set, i.e. the context is bound to the NF (Service) Set.
An NF Service Producer or SCP may discover, via NRF Nnrf_NFDiscovery service,
all available NF (Service) Instances within the NF (service) set that are
capable to receive the notifications or callback requests and select one of
them.
NOTE: When an NF service consumer changes, if the new NF service consumer does
not support handling the notification or callback requests as described above,
the new NF service consumer updates NF service producers with new URI as
specified in clause 6.5.3.2 of 3GPP TS 29.500 [10].
### 6.6.2 NF Service Consumer Instance Reselection when a (Routing) Binding
Indication is available
When using the Binding procedures specified in clause 6.12 of 3GPP TS 29.500
[10], Binding Indications and Routing Binding Indications include the Binding
level and one or more Binding entity IDs representing all NF service consumer
instances that are capable to receive the notifications or callback requests
targeting the session context for callback (corresponding to the resource
context in the NF Service Producer). See also clause 6.5.3.2 of 3GPP TS 29.500
[10].
When a Binding Indication or a Routing Binding Indication is available for a
target context, NF Service Consumer selection and re-selection shall be
supported as specified in clause 6.12 of 3GPP TS 29.500 [10].
### 6.6.3 NF Service Consumer Instance Reselection when a (Routing) Binding
Indication is not available
When the target NF Service Consumer becomes unavailable, the NF Service
Producer or SCP may select a different instance of the Service Consumer which
is capable to receive the notifications or callback requests targeting the
session context for callback (corresponding to the resource context in the NF
Service Producer) in:
\- the same consumer NF instance, using an alternate endpoint address
information if any is configured at the NF instance level, or at the NF
service instance level when the name of the NF service to which these
notifications are to be sent is known and the (consumer) NF instance
registered in its NF Profile that it is capable to persist its resources in
shared storage across NF service instances of the same NF Service;
\- the same NF (service) Set or a backup NF Service Consumer if applicable.
NOTE 1: When binding procedures are not supported, the NF Service Consumer can
provide in certain APIs the name of the NF service to which these
notifications are to be sent. This service can be one of the service produced
by the NF (if this NF Service Consumer can also serve as a NF Service
Producer) and registered in the NRF, or a custom service registered in the NRF
for the purpose of receiving these notifications). See clause 6.5.2.2 of 3GPP
TS 29.500 [10].
NOTE 2: When the AMF serves as a NF Service Consumer, it can indicate to the
NF Service Producer its backup AMF. See clause 5.21.2 of 3GPP TS 23.501 [9].
NOTE 3: NF Service Consumer Reselection when a (Routing) Binding Indication is
not available is only supported when the NF Service Producer has the target NF
Service Consumer information available, e.g. for APIs where the NF Service
Consumer can communicate its NF Instance Id to the NF Service Producer in the
service request message.
If so, the NF Service Producer or SCP may send the notification or callback
request to the newly selected NF Service Consumer Instance by means of
replacing the addressing parameters with the those of the newly selected
instance.
For indirect communication, if the NF service producer delegates target NF
consumer instance reselection to the SCP (when the target NF consumer instance
is not reachable), an NF service producer may also include 3gpp-Sbi-
Discovery-*\" headers in a notification or callback request, if the \"3gpp-
Sbi-Routing-Binding\" header is not included in the HTTP/2 request message, to
enable the SCP to reselect a different NF service consumer instance as
specified in the preceding bullets, if possible and if the NF service consumer
instance indicated in the \"3gpp-Sbi-Target-apiRoot\" header or target URI is
not reachable.
## 6.7 Void
## 6.8 Restoration Procedures for Home Routed PDU Sessions or PDU sessions
with an I-SMF
### 6.8.1 General
This clause specifies requirements in the AMF, the V/I-SMF and the (H-)SMF to
restore Home Routed PDU Sessions or PDU sessions with an I-SMF.
During a PDU session establishment and update procedure, the V/I-SMF or the
(H-)SMF shall:
\- set the \"Peer NF SET based Reselection\"(PSETR) feature bit in the
SupportedFeatures attribute if it supports the (re)selection of an alternative
peer SMF using the binding indication of the resource/session contexts or
based on the NF profile of the peer SMF;
\- set the \"Deployed Local SMF Set\" (DLSET) feature bit in the
SupportedFeatures attribute if the PDU session resource is not bound
exclusively to the specific V/I-SMF or (H-)SMF NF service instance, i.e. if
there is at least one alternative SMF service instance (in the same or a
different SMF instance) that can take it over if the current serving SMF
service instance becomes no longer operational (e.g. fails).
NOTE 1: A SMF can set the DLSET flag to \"1\" if it indicates in its NF
Profile that it supports the capability to persist its resources in shared
storage inside the NF Instance, i.e. if another SMF service instance with the
SMF instance can take over the resource context even when NF (service) set is
not deployed locally.
In the service request or response message towards the (new) AMF, the V/I-SMF
shall set the \"DLSET\" feature bit if the PDU session resource can be taken
over by an alternative V-SMF Service Instance. The V/I-SMF shall set the
\"anchorSmfPsetrSupportInd\" attribute to \"true\" in the Update SM Context
Response message towards the new AMF if the (H-)SMF supports the \"PSETR\"
feature.
NOTE 2: The AMF needs to know if the V/I-SMF supports the DLSET feature and if
the (H-)SMF supports the PSETR to take proper restoration actions when there
is a V/I-SMF failure. See clause 6.8.2. The AMF can alternatively learn
whether the (H-)SMF supports the PSETR feature when doing the SMF
discovery/selection during the PDU Session Establishment procedure.
NOTE 3: The V/I-SMF indicates more generally all the features it supports to
the AMF in the service request/response, including also setting the \"PSETR\"
feature bit if it is able to reselect an alternative (H-)SMF when it detects
the peer (H-)SMF has failed, but the AMF is not required to use this
indication.
The requirements specified in subsequent clauses shall also be applied for
N16a reference point by replacing the V-SMF with I-SMF, and H-SMF with SMF.
### 6.8.2 V-SMF failure
When the H-SMF detects the failure of the V-SMF, it shall retrieve all PDU
sessions associated with the failed V-SMF and perform the following procedure
for those PDU sessions:
\- if the H-SMF supports the PSETR feature:
\- if the V-SMF supports the DLSET feature, the H-SMF shall keep the PDU
session and should reselect an alternative V-SMF service instance, e.g. when
it needs to send any request message to the V-SMF;
\- if the V-SMF doesn\'t support the DLSET feature, the H-SMF shall delete the
affected PDU sessions locally.
\- if the H-SMF does not support the PSETR feature:
\- the H-SMF shall delete the affected PDU sessions.
When the AMF detects the failure of the V-SMF, it shall retrieve all PDU
sessions associated with the failed V-SMF and perform the following procedure
for those PDU sessions:
\- if the H-SMF supports the PSETR feature and if the V-SMF supports the DLSET
feature, the AMF shall keep the PDU session and should reselect an alternative
V-SMF service instance, e.g. when it needs to send any request message to the
V-SMF.
\- if the H-SMF doesn\'t support the PSETR feature while the V-SMF supports
the DLSET feature, the AMF shall keep the PDU sessions, and may reselect an
alternative V-SMF service instance to request the selected alternative V-SMF
to delete the PDU session towards the UE and the UPF. The V-SMF may request
the UE to reactivate the PDU session.
\- for any other cases, the AMF may release the affected PDU session(s)
locally and/or notify the UE about the release of the PDU session.
### 6.8.3 H-SMF failure
When the V-SMF detects the failure of the H-SMF, it shall retrieve all PDU
sessions associated with the failed H-SMF and perform the following procedure
for those PDU sessions:
\- if the V-SMF does not support the PSETR feature, the V-SMF may release the
affected PDU sessions towards the AMF and UE, and may request the UE to
reactivate the PDU session;
\- if the V-SMF supports the PSETR feature:
\- if the H-SMF supports the DLSET feature, the V-SMF shall keep the PDU
session and may reselect an alternative H-SMF service instance, e.g. when it
needs to send any request message to the H-SMF;
\- if the H-SMF doesn\'t support the DLSET feature, the V-SMF may release the
PDU session towards the AMF and UE, and the V-SMF may request UE to reactivate
the PDU session.
# 7 Restoration Procedures related to Public Warning System (PWS)
## 7.1 General
This clause specifies the procedures supported in the 5G System to handle
failures affecting Public Warning System (PWS). The stage 2 architecture and
procedures for PWS are specified in 3GPP TS 23.041 [8].
## 7.2 PWS operation failure in NG-RAN
The NG-RAN shall report that on-going PWS operation for one or more cells of
the NG-RAN has failed by sending a PWS Failure Indication as specified in 3GPP
TS 23.041 [8].
## 7.3 PWS operation restart in NG-RAN
After a NG-RAN (i.e. gNB or ng-eNB) has restarted, it shall delete all its
warning message data. If the warning message service is operational in one or
more cell(s) of the NG-RAN, the NG-RAN shall send a PWS Restart Indication
message, which shall include the identity of the NG-RAN, the identity of the
restarted cell(s), and the TAI(s) and Emergency Area Id(s) with which the
restarted cell(s) are configured, to request the CBC to re-load its warning
message data if applicable.
The NG-RAN should send the PWS Restart Indication message via two AMFs of the
AMF Region, if possible, to ensure that the CBC receives the message even if
one AMF cannot propagate it to the CBC (e.g. due to a path failure between the
AMF and the CBC).
If the AMF interfaces with multiple CBCs, the AMF shall forward the PWS
Restart Indication to all CBCs.
Upon receipt of a PWS Restart Indication message, the CBC shall consider that
the warning message service is restarted in the reported cell(s), i.e. the
service is operational and no warning messages are being broadcast in the
cell(s). The CBC shall then re-send the warning message data (with the same
message identifier and serial number) to the NG-RAN for these cells, if any.
When doing so, the CBC:
\- shall provide the identity of the NG-RAN received in the PWS Restart
Indication when sending the Write-Replace-Warning-Request message(s) to the
AMF, to enable the AMF to forward the message(s) only to the NG-RAN involved
in the restart. The identity of the NG-RAN shall be included in:
\- the Write-Replace-Warning-Request message(s) sent to the PWS-IWF over the
SBc interface; or
\- the globalRanNodeList IE of the NonUeN2MessageTransfer request message(s)
sent to the AMF over the N50 interface (see clauses 5.2.2.4.1.3 and 6.1.6.2.9
of 3GPP TS 29.518 [6]) to request the transfer of the Write-Replace-Warning-
Request message(s).
\- should set the warning area list to the identities of the cell(s) to be
reloaded which are relevant to the warning message data being reloaded; and
\- may update the number of broadcasts requested, if necessary.
The CBC shall consider a PWS Restart Indication message received shortly after
a preceding one for the same cell identity as a duplicate restart indication
for that cell which it shall ignore.
NOTE: The broadcast of warning messages can be configured in the network per
individual cell, TAI and/or Emergency Area Id. The CBC can use the list of
cell(s), the TAI(s) and Emergency Area Id(s) received in the PWS Restart
Indication to derive the list of warning messages to be broadcast in the
respective cell(s), TAI(s) and Emergency Area Id(s).
Likewise, in other scenarios where the NG-RAN may need to reload its warning
message data (e.g. when an individual cell is restarted), the NG-RAN shall
send a PWS Restart Indication message (including the identity of the NG-RAN,
the identity of the restarted cell(s), and the TAI(s) and Emergency Area Id(s)
with which the restarted cell(s) are configured) to the CBC to request the CBC
to re-load its warning message data if applicable. The NG-RAN, AMF and CBC
shall then proceed as specified above for a NG-RAN restart.
#
# Foreword
This Technical Report has been produced by the 3rd Generation Partnership
Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# 1 Scope
The objective of this Technical Report is to study enhancements of 5GS
architecture that has been defined in Rel-15 about the topology of SMF and
UPF, and:
1\. investigate mechanisms to enable the 3GPP system to support deployments
where a SMF is not able / allowed to control UPF(s) throughout the same PLMN.
2\. Study whether it is needed to enhance the capability of 5GS architecture
for a UPF to be controlled by multiple SMF\'s (and many UPF\'s to be
controlled by many SMFs) and, if yes, define such enhancements.
For these objectives, use cases will be defined.
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or non‑specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
[1] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[2] 3GPP TS 23.501: \"System Architecture for the 5G System; Stage 2\".
[3] 3GPP TS 23.502: \"Procedures for the 5G system, Stage 2\".
[4] 3GPP TS 23.503: \"Policy and Charging Control Framework for the 5G System;
Stage 2\".
[5] 3GPP TS 29.244: \"Interface between the Control Plane and the User Plane
nodes\".
[6] 3GPP TS 29.510: \"5G System; Network function repository services; Stage
3\".
[7] IETF RFC 4861: \"Neighbor Discovery for IP version 6 (IPv6)\".
[8] 3GPP TR 23.716: \"Study on the Wireless and Wireline Convergence for the
5G system architecture\".
# 3 Definitions, symbols and abbreviations
## 3.1 Definitions
For the purposes of the present document, the terms and definitions given in
TR 21.905 [1], TS 23.501 [2] and the following apply. A term defined in the
present document takes precedence over the definition of the same term, if
any, in TR 21.905 [1].
**AMF Service Area:** An area within which a UE can be served by the same AMF.
It contains one or more TA(s).
**Anchor SMF (A-SMF):** the SMF serving the PDU Session when a single SMF is
used as defined for non-roaming and LBO scenarios in Rel-15. A PDU Session
always involves an A-SMF. An A-SMF is never changed for a PDU Session.
**Intermediate SMF (I-SMF):** the SMF that controls UPF(s) that the A-SMF
cannot control. An I-SMF is inserted, changed or removed as needed. An I-SMF
is used only in specific deployments.
**SMF Service Area:** The collection of the UPF Service Areas (as defined in
TS 23.501 [2]) of all UPFs which can be controlled by one SMF. It contains one
or more TA(s).
## 3.2 Abbreviations
For the purposes of the present document, the abbreviations given in TR 21.905
[1], TS 23.501 [2] and the following apply. An abbreviation defined in the
present document takes precedence over the definition of the same
abbreviation, if any, in TR 21.905 [1].
A-SMF Anchor SMF
KI Key Issue
L-SMF Local SMF
L-UPF Local UPF
I-SMF Intermediate SMF
I-UPF Intermediate UPF
# 4 Architecture Requirements, Assumptions and principles
## 4.1 Architectural requirements
Void.
## 4.2 Architectural assumptions and Principles
1\. The SMF Service areas and the AMF Service Areas are not required to be
identical, i.e. contain the same TA list. However, it shall be possible that
the SMF service area partially overlaps with the AMF Service Area.
2\. Allocation and release of CN Tunnel Info is performed when a new PDU
Session is established or released. This functionality is supported either by
SMF or UPF, if it supports this functionality. It shall be possible that each
NF can support the CN Tunnel Info allocation and release function same as
Rel-15.
3\. If an A-UPF which is managed by the A-SMF and if it has a N3 interface
used by the PDU session, then there is no need to have an I-SMF for the PDU
Session. 3GPP specifications assume that the SMF instance can act as I-SMF or
A-SMF depending on its role for a PDU Session.
# 5 Use cases and Key Issues
## 5.1 Use Cases
### 5.1.1 Use Case #1: deployments where a SMF is not able / allowed to
control UPF(s) throughout the whole PLMN
In large countries the network may be divided into \"regions\" that each are
locally (\"regionally\") managed and where it is required that UPF deployed in
a \"region\" are only \"controlled\" (via N4) by SMF(s) in the same
\"region\". This is called a \"regional control\" of UPF.
The SMF may be not able to control UPFs throughout the whole PLMN. When the UE
moves to a new area, there will be no UPF under the SMF control can connect
the target NG-RAN.
Figure 5.1.1-1: Use case 1: Mobility across 2 regions within a PLMN
### 5.1.2 Use Case #2: inter PLMN mobility
Figure 5.1.2-1: Use case 2: inter PLMN mobility
### 5.1.3 Use Case #3: Third party (corporate)
For some DNN(s) the SMF controlling the PSA is dedicated to a Third party
(corporate) for some DNN(s) where for such DNN(s):
\- The dedicated SMF controls UPF deployed within the corporate premises (e.g.
UPF that serve UE(s) using a non 3GPP access to reach the 5GC).
\- The UPF(s) that serve UE using 5G-AN not operated by the Third party are
operated by the MNO and should be controlled by another SMF (of the MNO).
Editor\'s note: Whether the SMF that controls the PDU Session and the PDU
Session Anchor (PSA) is under control of the Third party is FFS.
Figure 5.1.3-1: Use case 3: Corporate case
## 5.2 Key Issues
### 5.2.1 Key Issue #1: IP address preservation and Control of UPFs in use
cases #1,2,3
(IP type) PDU sessions in SSC mode 1 need IP address preservation even though
the UE moves between regions or between different 5G-AN corresponding to
different domains. Hence, after UE mobility, while the (I-)UPF connected to
the 5G-AN serving the UE is now in a different region / administrative domain,
the PSA needs to remain in its initial location and controlled by an SMF in
the same region or administrative domain. **Thus, the SMF controlling the PSA
needs to remain despite the UE mobility.**
The KI is to investigate mechanisms to enable the 3GPP system to support
deployments where for a PDU Session each UPF is only controlled by a single
SMF and the SMF that controls the main PSA cannot control all UPF serving the
PDU Session. Depending on the use case, the mechanisms studied may be based on
solutions to objective 1 and/or objective 2.
The solutions shall take into account and/or define:
\- UE\'s should not be aware of the split of SMF & UPF in different regional /
administrative areas.
\- The solutions shall define SMF area and their Granularity (TAI?, Others?).
\- Impact of the UE mobility within 5GS (mobility between different SMF areas)
but also mobility with EPS, e.g. the case where an UE moves from 5GS, to EPS
and then back to 5GS but in a different region / administrative area:
\- Especially the solutions shall describe how to detect mobility between
different SMF areas.
\- If in a solution (within HPLMN or within VPLMN), a PDU Session may be
simultaneously controlled by multiple SMF, the solution shall describe:
\- Which NF is responsible for SMF selection or reselection, and how is it
enforced.
\- How to take into account slicing.
\- Is there any impact to NRF- Are dedicated NRF needed or assumed?
\- How to insert an UPF supporting UL-CL/BP (IPv6 multi-homing) which is not
controlled by the SMF that controls the main PSA of the PDU Session. The UL-
CL/BP to be inserted may be at the same or different regional / administrative
areas.
NOTE: Mobility aspects are described in Key Issue #4.
\- How to ensure proper data collection to support charging.
\- Home Routed roaming deployments where the VPLMN may support regional
control of UPF:
\- Is the H-SMF aware / involved when multiple SMF are used (possibly not
simultaneously) in the VPLMN?
\- Impacts to Rel‑15 procedures, including MM and SM procedure, e.g. Mobility
procedures and PDU Session Establishment / Modification / Release procedures,
the support of LADN, the support of the different SSC modes, the activation /
deactivation of the UP of the PDU Session (e.g. because the UE moves between
CM-IDLE and CM-CONNECTED).
\- Potentials relationship with the different SSC modes and with AF influence
on traffic routing (TS 23.501 [2], clause 5.6.7).
\- Any impacts to UPF selection.
\- Potential security impacts.
### 5.2.2 Key Issue #2: IP Address and IP Address Prefix Allocation for
Complex SMF/UPF Topologies
Some of the capabilities of 5G imply that UPF functions will be required to be
greatly de-centralized (e.g. Mobile Edge Computing enablers) and in these
cases the number of UPF\'s will \"exponentially\" increase, further
complicating management. Also, as address allocation is in response to UE
demand, which is not evenly distributed, areas of high demand may exhaust IP
Address / Prefixes allocation in one function while low demand elsewhere in
the network may leave unused IP Addresses / Prefixes in other functions --
this is especially exacerbated when small, highly distributed functions are
used.
As virtualization brings a lot of flexibility for deploying (scale in/out) NF
(e.g. SMF) instances due to (signalling) traffic variation, there may be a big
and varying number of SMF instances using the same UPF as PSA (PDU Session
Anchor) and thus needing IP addresses / Prefixes pointing to this UPF.
Solutions to this key issue will investigate alternatives to the basic SMF
allocation methods, described in the existing specifications, to address
networks that have complex relationships between SMFs and UPFs.
Solutions to this key should describe the following:
\- Allocation of IP addresses / Prefixes to UE PDU Session (of type IPv4 and
IPv6) for topologies where multiple SMF control the same UPF or UPFs.
\- Co-ordination of IP addresses / Prefixes such that the same IP address /
Prefix is not mistakenly allocated to 2 different PDU sessions of different
UEs.
\- Impacts to the solution when SMF and UPF resources grow, and/or contract,
due to load or other dynamic events (e.g. Scale In/Scale Out, Scale Up/Scale
Down.
\- Evaluation of these solutions should include comparison to the existing SMF
allocation methods (i.e. IP Address pools, DHCP, or RADIUS).
\- UE\'s should not be aware or impacted by the allocation method.
\- If possible how are network deployments able to mix the allocation methods
for different DNN or 5GC slices including following cases:
\- Support for deployments where the IP address / Prefix allocation is to be
done by the DN.
\- The same UPF acting as PSA may serve different DNN / DNAI with different
(possibly overlapping) IPv4 address spaces.
\- Suitability for supporting massive scale deployments of UPF\'s located near
(R)AN resource (e.g. MEC).
\- How to effectively summarize routes in the network.
\- How to support Policies received by the SMF from the PCF that relate with
IP address / Prefix allocation.
### 5.2.3 Key Issue #3: UPF resource management impact when UPF shared by
multiple SMFs
According to TS 23.501 [2], a CN Tunnel Info is the Core Network address of
the N3/N9 tunnel corresponding to the PDU Session. It comprises the TEID and
the IP address which is used by the UPF for the PDU Session.
Allocation, modification and release of the CN Tunnel Info is performed when a
new PDU Session is established, existing UPF is reallocated during the PDU
session or existing PDU session is released. This functionality is supported
either by SMF or UPF, based on operator\'s configuration on the SMF. If this
functionality is supported by the SMFs and the UPF is controlled by multiple
SMFs, the following should be considered:
\- Study impact of resource management of UPF shared by multiple SMFs during
UPF relocation and UPF recovery when UPF is shared by multiple SMFs.
### 5.2.4 Key issues #4: Intermediate SMF Insert/Relocation due to UE Mobility
The issues related to SMF and UPF Insert/Relocation due to UE Mobility
includes:
\- How the network determines the serving SMF cannot serve the new UE
location.
\- If in a solution (within HPLMN or within VPLMN), a PDU Session may be
simultaneously controlled by multiple SMFs, the solution shall describe:
\- Which NF is responsible for SMF selection or reselection.
\- How to relocate the intermediate SMF which control the UPF terminated the
N3 interface, if reallocation is needed.
\- Which SMF selects the additional UPF (the UPF to be inserted) when there is
more than one SMF?
\- Impact of the UE mobility within 5GS (mobility between different SMF areas)
but also mobility with EPS, e.g. the case where an UE moves from 5GS, to EPS
and then back to 5GS but in a different region / administrative area.
\- Which SMF(s) (if there is more than one) support(s) the interfaces with the
AMF, with the UDM, with the PCF, with charging, the Event exposure, etc. and
which of these SMF is to be considered for EPS interworking.
\- If there is an interface between SMF(s) (if there is more than one), the
nature of the information exchanged on this interface.
### 5.2.5 Key Issue 5: Handling AF influence on traffic routing
This key issue addresses the handling of AF request to influence on traffic
routing.
The solutions shall consider and/or define:
\- How AF related policy handling takes place in the current/target region?
\- On AF request to the PCF, how PCF policies are handled in the network?
e.g.:
\- Whether the policy related to the AF Request is processed by anchor SMF
and/or intermediate SMF and how the two SMFs coordinate insertion and
configuration of UPF(s) (e.g. with UL CL rules).
### 5.2.6 Key Issue #: Latency to setup the user plane
One goal of the study is to support deployments where a single SMF is not able
to control the UPFs throughout the PLMN. A PDU Session may need to have two
UPFs; one acting as a PSA and a second one (I-UPF) acting as a ULCL or
branching function. If one SMF is not able to control both UPFs in the PDU
Session, a second SMF for the PDU Session needs to be introduced.
In Rel-15, when the UE has moved outside of the Service Area of the old UPF,
the I-UPF may need to be inserted, relocated, or removed. The outcome of the
Rel-16 study may be that in this case also the SMF controlling this I-UPF may
need to be inserted, relocated or removed. In Rel-15, the Registration Area is
not composed based on the UPF Service Area(s), therefore the I-UPF may need to
be relocated during the Service Request procedure. This causes delay to the UL
data and especially to the DL data, since the DL data is buffered in the old
UPF and the data needs to be retrieved from there to the new target UPF.
This delay to setup the user plane when the UE returns from Idle may be
critical e.g. for LLC and IMS voice services. Rel-16 can be expected to cause
additional delay if the SMF controlling the I-UPF need to be relocated during
the Service Request procedure.
This key issue will define solutions:
\- How to identify the delay-sensitive PDU Sessions and how the network
authorizes the use of this feature.
\- How to avoid the increase of delay to setup the user plane if and when the
UE moves outside of the SMF Service Area while in Idle mode.
Furthermore, while the actual performance evaluation of each solution is
expected be described under the respective solution, this key issue will
provide criteria how to evaluate the latency improvement to setup the user
plane compared to Rel-15 when the UE moves outside of the UPF Service Area
while in Idle mode.
# 6 Solutions
## 6.1 Solution #1: Mobility between service areas
### 6.1.1 Overview
In this solution the SMF Service Area of an SMF is assumed to constitute of
the union of the UPF Service Areas of all UPFs that can be controlled by that
SMF.
This solution applies to Key Issue 1 and 4 and describes how a UE can move in
the network between two SMF service areas where the SMF in service area 1 is
not connected via N4 to the UPF(s) in service area 2. The service area can for
example be an administrative area either within one PLMN, or in different
PLMNs.
### 6.1.2 Description of the solution
#### 6.1.2.1 Overview
In this solution, there are two SMFs introduced and used within a PLMN. The
following terminology is used:
\- **Anchor SMF (A-SMF)** is the SMF serving the PDU Session when a single SMF
is used as defined for non-roaming and LBO scenarios in Rel-15. The A-SMF is
thus the SMF that controls the PDU Session Anchor UPF(s) that were allocated
before the I-SMF is inserted. This SMF has the PCC and UDM interfaces,
performs UE IP address allocation, etc.
\- **Intermediate SMF (I-SMF)** is the SMF that controls a UPF not controlled
by A-SMF and has the N3 interface. This is an intermediate UPF between RAN and
the PDU Session Anchor UPF. An I-SMF is inserted, relocated or removed as
needed.
#### 6.1.2.2 Non-roaming and LBO network architecture
In the proposed solution, the I-SMF is included \"between\" the AMF and the
A-SMF when the UE is in a location where the A-SMF cannot control UPFs serving
that location. The I-SMF is only inserted when needed. When no I-SMF is
allocated for the PDU Session, the PDU Session is served by a single SMF (the
A-SMF) as described in the non-roaming architecture in TS 23.501 [2]. The
interface between AMF and I-SMF is the existing N11. This means that the AMF
communicates with the I-SMF when an I-SMF is present in the network. Figure
6.1.2-1 shows the non-roaming reference architecture when an I-SMF has been
inserted.
Figure 6.1.2-1: Non-Roaming system architecture in reference point
representation
Functionality of I-SMF includes:
\- Session management (e.g. support of Nsmf_PDUSession_CreateSMContext,
Nsmf_PDUSession_UpdateSMContext, Nsmf_PDUSession_ReleaseSMContext service
operations).
\- N11 termination, incl. termination of SM parts of NAS messages and N2.
\- UPF selection and control.
\- Handling of buffering and downlink data notifications in case N3 connection
is inactive.
The A-SMF supports interfaces to PCF, UDM and charging systems, UE IP address
management, etc.
#### 6.1.2.3 Home-routed roaming architecture
In the proposed solution, inter-PLMN mobility is supported, i.e. mobility
between HPLMN and a VPLMN as well as mobility between two VPLMNs for home-
routed PDU Sessions.
The network architecture for these cases re-use the non-roaming and home-
routed architectures defined in TS 23.501 [2], clause 4.2.8.2.
In case of mobility within a VPLMN to an area where V-SMF cannot control a UPF
serving the UE location, the V-SMF is reallocated.
Editor\'s note: In case of mobility within VPLMN to an area where V-SMF cannot
control a UPF serving the UE location, it is FFS whether an I-SMF can be
inserted in VPLMN.
Editor\'s note: Slicing aspects due to inter-PLMN mobility are FFS.
#### 6.1.2.4 Network architecture and relation to use cases
In use case #1 in clause 5.1.1, an intermediate SMF is inserted between the
AMF and anchor SMF, in a similar way as a v-SMF is used between AMF and H-SMF.
The I-SMF controls the intermediate UPF(s), while the A-SMF controls the
anchor UPF. The I-SMF is optional, and it is added in the path only when it is
needed (when the UE is in an area where the A-SMF cannot control the UPF). The
I-SMF can be added, changed or removed during the lifetime of the PDU session
depending on UE mobility. An example scenario is shown in the figure below,
showing mobility from region 1 where the PDU Session was established with a
single SMF to region 2 where an I-SMF in the new (serving) region is
allocated. In the figure it is assumed that AMF is relocated when moving
across the border between regions. The SMF and UPF (PSA) in Region 1 is
maintained for the PDU Session.
Figure 6.1.2.4-1: Insertion of I-SMF in case of use case #1
In use case #2 in clause 5.1.1, a V-SMF is allocated in the serving PLMN. The
V-SMF controls the UPF(s) in the VPLMN while the H-SMF controls the anchor
UPF, as specified for home-routed roaming cases. An example scenario is shown
in the figure below, showing mobility from PLMN A where the PDU Session was
established with a single SMF to PLMN B where a V-SMF in the new (serving)
PLMN is allocated. In the figure it is assumed that AMF is relocated when
moving across the PLMNs. The SMF and UPF (PSA) in HPLMN is maintained for the
PDU Session.
Figure 6.1.2.4-2: Insertion of I-SMF in case of use case #1
Editor\'s note: Further clarification and details on how SMF areas relate to
regions (use case #1) and PLMN (use case #2) are FFS.
#### 6.1.2.5 Procedure impacts
##### 6.1.2.5.1 General
The following non-roaming procedures need enhancements to support
insertion/relocation/removal of I-SMF:
\- Mobility Registration.
\- UE-initiated Service Request.
\- NW-triggered SR.
\- Xn based inter NG-RAN handover with insertion of intermediate UPF.
\- Xn based inter NG-RAN handover with re-allocation of intermediate UPF.
\- Inter NG-RAN node N2 based handover.
In addition, the following non-roaming procedure needs enhancements to support
insertion of I-SMF:
\- PDU Session Establishment.
##### 6.1.2.5.2 Mobility Registration with insertion, removal and change of
I-SMF
This procedure shows the difference to the mobility registration procedure in
TS 23.501 [2], clause 4.2.2.2, when a new I-SMF has to be inserted, an
existing I-SMF is replaced with a different I-SMF or an existing I-SMF is
removed.
Editor\'s note: Impact to other procedures are FFS.
Editor\'s note: Interactions with PCF are FFS and depends on conclusions to
key issue #5.
Figure 6.1.2.5.2-1: Mobility registration with insertion of I-SMF
These steps are the same as steps 1-13 in TS 23.502 [3], clause 4.2.2.2.
2\. This step is the same as step 4 in TS 23.502 [3], clause 4.2.2.2
3\. If there is an existing (old) I-SMF, and PDU Session status received from
the UE indicates that a PDU Session is released at the UE, the AMF invokes the
Nsmf_PDUSession_ReleaseSMContext service operation towards the I-SMF.
Otherwise, if the AMF has changed, the old AMF requests SM context from that
I-SMF. If there is no existing I-SMF, the AMF requests SM context from the SMF
(i.e. A-SMF). If the AMF is not changed and the AMF determines that the old
I-SMF needs to be removed/changed, the AMF requests SM context from the old
I-SMF.
NOTE: If AMF is changed, the old AMF does not know if the old I-SMF needs to
be removed/changed. This means that step 3 may be performed even if I-SMF does
not need to change. However, it is assumed that the most common case is that
I-SMF need to change if the AMF needs to change and this is thus a rare case.
Editor\'s note: It is FFS whether e.g. UE location shall be provided from new
AMF to old AMF, to allow old AMF to determine if old I-SMF can continue to
serve the UE.
Editor\'s note: It is FFS whether the AMF request context only for PDU
Sessions if the \"List Of PDU Sessions To Be Activated\" is included in the
Registration Request, or for all established PDU Sessions.
4\. This step is the same as step 5 in TS 23.502 [3], clause 4.2.2.2, with the
addition that an SM container containing SM context is included.
5\. This step is the same as steps 6-16 in TS 23.502 [3], clause 4.2.2.2
6\. The AMF determines whether the existing I-SMF (if any) can be re-used or
whether an I-SMF has to be inserted, changed or removed. In case I-SMF has to
be inserted or existing I-SMF is changed, AMF selects an I-SMF.
7\. The AMF sends an Nsmf_PDUSession_CreateSMContext Request to the new I-SMF.
The AMF includes the PDU Session ID, SM container, received in step 4 as well
as the identity of the SMF (A-SMF) serving the PDU Session. The AMF maintains
the A-SMF ID as part of the UE context.
8\. The I-SMF selects a UPF.
9\. The I-SMF requests establishment of the N4 session.
10\. The I-SMF sends an Nsmf_PDUSession_Update Request to the A-SMF. The I-SMF
includes the DL tunnel information for the N9 tunnel.
11\. The I-SMF sends a N4 session modification to the UPF (I-UPF) with the
updated tunnel information.
12\. The A-SMF sends Nsmf_PDUSession_Update Response to I-SMF including the UL
tunnel information for the N9 tunnel.
13\. The A-SMF sends a N4 session modification to the UPF (A-UPF) with the
updated tunnel information.
14\. The I-SMF sends a Nsmf_PDUSession_CreateSMContext Response to the AMF.
If the activation of UP resources was requested in step 7, the I-SMF initiates
the procedure described in clause 4.2.3.2, steps from step 5 onwards, to
complete the User Plane connection activation without sending MM NAS Service
Accept from the AMF to (R)AN described in step 12 of clause 4.2.3.2. Even if
an I-SMF is inserted between AMF and A-SMF, the AMF stores the SMF (A-SMF)
identity information as part of the SM context for the PDU Session.
In case of I-SMF change, the flow continues at step 15 below.
Case: I-SMF removal:
15\. The AMF sends Nsmf_PDUSession_UpdateSMContext to A-SMF to indicate to
A-SMF that it is serving the UE and that no I-SMF is to be used.
16\. The A-SMF sends a N4 session modification to the UPF (A-UPF) with
information indicating that A-UPF shall start to buffer DL packets.
17\. The A-SMF sends a Nsmf_PDUSession_UpdateSMContext Reply to AMF.
If the activation of UP resources was requested in step 15, the A-SMF
initiates the procedure described in clause 4.2.3.2, steps from step 5
onwards, to complete the User Plane connection activation without sending MM
NAS Service Accept from the AMF to (R)AN described in step 12 of clause
4.2.3.2.
Case: I-SMF removal or I-SMF change:
18\. The AMF sends a Nsmf_PDUSession_ReleaseSMContext to the old I-SMF,
indicating that it shall release all resources related to the PDU Session. The
I-SMF shall not send a PDU Session Release towards A-SMF.
19\. The old I-SMF releases the N4 session towards the old I-UPF.
20\. These steps are the same as steps 19-23 in clause 4.2.2.2.
##### 6.1.2.5.3 Inter NG-RAN node N2 based handover with I-SMF Change
###### 6.1.2.5.3.1 General
When the UE do the connected state mobility from one area to another area, the
possible scenario related I-SMF change can be listed as following:
\- from source I-SMF service area to target I-SMF service area, i.e. I-SMF
reallocation; or
\- from A-SMF service area to target I-SMF service area, i.e. I-SMF insertion;
or
\- from source I-SMF service area to A-SMF service area, i.e. I-SMF removal.
###### 6.1.2.5.3.2 Preparation phase
The N2 handover preparation procedure with I-SMF and I-UPF change are depicted
in figure 6.1.2.5.3.2-1.
Editor\'s note: The procedure shows the case of I-SMF change, i.e. allocating
a new I-SMF and removing an old I-SMF. The cases for only insertion of I-SMF
and only remove of I-SMF are FFS.
Figure 6.1.2.5.3.2-1: Inter NG-RAN node N2 Handover with I-SMF and I-UPF
change, preparation phase
1\. S-RAN to S-AMF: Handover Required (Target ID, Source to Target transparent
container, _SM N2 info list,_ PDU Session IDs, intra system handover
indication).
_Target ID includes the selected PLMN ID._
_Source to Target transparent container_ includes NG-RAN information created
by S-RAN to be used by T-RAN and is transparent to 5GC. It also contains for
each PDU session the corresponding User Plane Security Enforcement
information.
All PDU Sessions handled by S-RAN (i.e. all existing PDU Sessions with active
UP connections) shall be included in the Handover Required message, indicating
which of those PDU Session(s) are requested by S-RAN to handover. The SM N2
info also includes Direct Forwarding Path Availability _and_ may include which
QoS Flows are subject to data forwarding if direct data forwarding is not
available.
Direct Forwarding Path Availability indicates whether direct forwarding is
available from the S-RAN to the T-RAN. This indication from S-RAN can be based
on e.g. the presence of IP connectivity and security association(s) between
the S-RAN and the T-RAN.
2\. T-AMF Selection: _When the S-AMF cannot serve the UE anymore, the S-AMF
selects_ the _T-AMF_ as described in clause 6.3.5 on \"AMF Selection
Function\" in TS 23.501 [2].
_If there is no existing I-SMF/V-SMF, step 2.5a-2.5b are skipped._
2.5a. The S-AMF may send Nsmf_PDUSession_SMContextInfo Request to source I-SMF
(either existing I-SMF or V-SMF, if it exists) to retrieve \"CN SM context\"
for all the PDU sessions for the UE in this SMF.
2.5b. The I-SMF provides the \"CN SM Context\" to the S-AMF in
Nsmf_PDUSession_SMContextInfo Response. The SM Context information includes
QoS, UL CN tunnel of the A-UPF. SM context for each PDU session shall be
included as transparent container.
3\. [Conditional] S-AMF to T-AMF: _Namf_Communication_CreateUEContext Request
(N2 Information (_ Target ID, Source to Target transparent container, _SM N2
information list_ , PDU Session IDs, Service area restriction _),_ UE context
information (SUPI, Allowed NSSAI for each Access Type if available, the list
of PDU Session IDs along with the corresponding SMF information and the
corresponding S-NSSAI(s), PCF ID and DNN, and transparent \"CN SM context\" if
it\'s provided in step 2.5 above _)._
The S-AMF initiates Handover resource allocation procedure by invoking the
Namf_Communication_CreateUEContext service operation towards the T-AMF.
When the S-AMF can still serve the UE, this step and step 12 are not needed.
If Service area restrictions are available in the S-AMF, they may be forwarded
to the T-AMF as described in clause 5.3.4.1.2 in TS 23.501 [2].
If a PCF ID is provided by the S-AMF, the T-AMF contacts the (V-) PCF
identified by the PCF ID. If the PCF identified by the PCF ID cannot be used
(e.g. no response from the PCF) or there is no PCF ID received from the S-AMF,
the T-AMF selects a PCF as described in TS 23.501 [2], clause 6.3.7.1.
> 4.1. The T-AMF determines that a (target) I-SMF has to be inserted and
> selects the (target) I-SMF.
>
> See clause 6.6.2.3 for I-SMF reselection during UE mobility.
>
> 4.2. The T-AMF sends a Nsmf_PDUSession_CreateSMContext Request to the
> (target) I-SMF. The AMF includes the PDU Session ID as well as the identity
> of the SMF (A-SMF) serving the PDU Session. If target AMF has received \"CN
> SM context\" from the source AMF in step 3, the corresponding \"CN SM
> context\" is included.
>
> 5\. The (target) I-SMF selects a (new) I-UPF.
>
> 6\. Target I-SMF to (new) I-UPF: The (target) I-SMF requests establishment
> of the N4 session towards (new) I-UPF. SM context info is provided to UPF if
> (target) I-SMF received it. In case UPF is allocation tunnel info, the UPF
> allocates N3 tunnel and returns the info to (target) I-SMF.
7\. The (target) I-SMF to T-AMF: _Nsmf_PDUSession_CreatSMContext Response (_
PDU Session ID, N2 SM Information, Reason for non-acceptance _)._
If N2 handover for the PDU Session is accepted, the (target) I-SMF includes in
the Nsmf_PDUSession_UpdateSMContext response the N2 SM Information containing
the N3 UP address and the UL CN Tunnel ID of the UPF and the QoS parameters
indicating that the N2 SM Information is for the Target NG-RAN.
If N2 handover for the PDU Session is not accepted as described in step 4, the
SMF does not include an N2 SM Information regarding the PDU Session to avoid
establishment of radio resources at the target NG-RAN. Instead of that, the
SMF provides a reason for non-acceptance. If the SMF is notified that the UE
is only reachable for regulatory prioritized services, the SMF does not
include any N2 SM info regarding the PDU Session for non-regulatory
prioritized services to avoid establishment of radio resources at the target
NG-RAN.
8\. AMF supervises the Nsmf_PDUSession_UpdateSMContext Response messages from
the involved SMFs. The lowest value of the Max delay indications for the PDU
Sessions that are candidates for handover gives the maximum time AMF may wait
for Nsmf_PDUSession_UpdateSMContext Response messages before continuing with
the N2 Handover procedure. At expiry of the maximum wait time or when all
Nsmf_PDUSession_UpdateSMContext Response messages are received, AMF continues
with the N2 Handover procedure (Handover Request message in step 9).
NOTE 1: The delay value for each PDU Session is locally configured in the AMF
and implementation specific.
9\. T-AMF to T-RAN: _Handover Request (_ Source to Target transparent
container, N2 MM Information, N2 SM Information list, Handover Restriction
List, Non-accepted PDU Session List _)._
T-AMF determines T-RAN based on Target ID. T-AMF may allocate a 5G-GUTI valid
for the UE in the AMF and target TAI.
_Source to Target_ transparent container is forwarded as received from S-RAN.
N2 MM Information includes e.g. security information and Handover Restriction
List if available in the T-AMF.
N2 SM Information list includes N2 SM Information received from SMFs for the
T-RAN in the Nsmf_PDUSession_UpdateSMContext Response messages received within
allowed max delay supervised by the T-AMF mentioned in step 8. If the Direct
Forwarding Path Availability indicates direct forwarding is not available and
the SMF knows that there is no indirect data forwarding connectivity between
source and target, the N2 SM Information also includes a \"Data forwarding not
possible\" indication.
Handover Restriction List is sent if available in the Target AMF.
Non-accepted PDU Session List is generated by the AMF and includes following
PDU Session(s) with proper cause value:
\- Non-accepted PDU Session(s) by the SMF(s);
\- Non-accepted PDU Session(s) by the AMF due to no response from the SMF
within maximum wait time; and
\- Non-accepted PDU Session(s) by the AMF due to non-available S-NSSAI in the
T-AMF, which is decided at step 4.
10\. T-RAN to T-AMF: _Handover Request Acknowledge (_ Target to Source
transparent container, N2 SM response list, PDU Sessions failed to be setup
list, T-RAN SM N3 forwarding Information list _)._
_Target to Source transparent container_ includes a UE container with an
access stratum part and a NAS part. The UE container is sent transparently via
T-AMF, S-AMF and S-RAN to the UE.
T-RAN creates PDU Sessions failed to be setup list and reason for failure
(e.g. SMF decision, SMF response too late, or T-RAN decision, S-NSSAI is not
available, unable to fulfil User Plane Security Enforcement) based on Non-
accepted PDU Session List and T-RAN determination. The information is provided
to the S-RAN.
The N2 SM response list includes, per each received N2 SM Information, a PDU
Session ID and an N2 SM response indicating the PDU Session ID and if T-RAN
accepted the N2 Handover request for the PDU Session. This includes also a PDU
Session Modified indication if the T-RAN could only established user plane
resources for the PDU session that do not fulfil the User Plane Security
Enforcement with a value Preferred. For each PDU Session accepted by the T-RAN
for N2 Handover, the N2 SM response includes N3 UP address and Tunnel ID of
T-RAN.
The T-RAN SM N3 forwarding info list includes, per each PDU Session accepted
by the T-RAN and has at least one QoS Flow subject for data forwarding, N3 UP
address and Tunnel ID of T-RAN for receiving forwarded data if necessary.
11a. T-AMF to Target I-SMF: Nsmf_PDUSession_UpdateSMContext _Request (_ PDU
Session ID, N2 SM response, T-RAN SM N3 forwarding Information list _)._
For each N2 SM response received from the T-RAN (included in N2 SM response
list), AMF sends the received N2 SM response to the SMF indicated by the
respective PDU Session ID.
If no new T-UPF is selected, SMF stores the N3 tunnel info of T-RAN from the
N2 SM response if N2 handover is accepted by T-RAN.
11b. [Conditional] Target I-SMF to (new) I-UPF: N4 Session Modification
Request (DL N3 tunnel info of T-RAN, T-RAN SM N3 forwarding Information list,
indication to allocate a DL forwarding tunnel for indirect forwarding)
If the I-SMF selected a T-UPF in step 6, the SMF updates the I-UPF by
providing the T-RAN DL N3 tunnel information and the SM N3 forwarding
information list by sending a N4 Session Modification Request to the T-UPF.
If indirect forwarding applies based on indication from NG-RAN and the UPF is
re-allocated and if the SMF decides to setup the indirect forwarding tunnel on
the same I-UPF, and UP tunnel information is allocated by the UPF, the SMF
also requests in the N4 Session Modification Request message to the I-UPF, to
allocate a \"CN DL forwarding tunnel\" for indirect forwarding used by source
side.
Indirect forwarding may be performed via a UPF which is different from the
I-UPF, in which case the SMF selects a I-UPF for indirect forwarding.
11c. [Conditional] I-UPF to Target I-SMF: N4 Session Modification Response (CN
DL forwarding tunnel Information).
The I-UPF allocates DL Tunnel Info and returns an N4 Session Modification
Response message to the SMF.
The CN DL forwarding info is provided in case UPF allocates CN tunnel
information and includes I-UPF address, I-UPF Tunnel identifiers for
forwarding data.
NOTE 2: \"CN DL forwarding tunnel\" can either be seen as N9 tunnel if it\'s
used by source I-UPF to forward data, or N3 tunnel if it is used by source RAN
to forward data.
11d. Target I-SMF to T-AMF: Nsmf_PDUSession_UpdateSMContext Response (DL
forwarding tunnel information).
The (target) I-SMF sends an Nsmf_PDUSession_UpdateSMContext Response message
per PDU Session to T-AMF.
The DL forwarding tunnel information containing the DL forwarding Tunnel Info
to be sent to the S-AMF by the T-AMF. The SMF includes this information in the
Nsmf_PDUSession_UpdateSMContext response. The DL forwarding Tunnel Info can be
one of the following information:
\- If direct forwarding applies, then the (target) I-SMF includes the T-RAN N3
forwarding information the SMF received in step 11a.
\- If the indirect forwarding tunnel is setup in step 11b, then the (new
target I-SMF includes the CN DL forwarding information from I-UPF.
A timer shall be started at target I-SMF to monitor the indirect forwarding
tunnel.
12\. [Conditional] T-AMF to S-AMF: Namf_Communication_CreateUEContext Response
(N2 information necessary for S-AMF to send Handover Command to S-RAN
including Target to Source transparent container, PDU Sessions failed to be
setup list, N2 SM information, DL forwarding tunnel Information).
AMF supervises the Nsmf_PDUSession_UpdateSMContext Response message from the
involved SMFs. At expiry of the maximum wait time or when all
Nsmf_PDUSession_UpdateSMContext Response messages are received, T-AMF sends
the Namf_Communication_CreateUEContext Response to the S-AMF.
The Target to Source transport container is received from the T-RAN. The N2 SM
Information is received from the SMF in step 11d including the data forwarding
tunnel info.
12a. [Conditional] S-AMF to source I-SMF: Nsmf_PDUSession_UpdateSMContext
Request (DL forwarding tunnel info).
If source I-UPF need to allocate indirect forwarding tunnel, the S-AMF invokes
Nsmf_PDUSession_UpdateSMContext Request to provide indirect data forwarding
tunnel info from target side if it\'s provided in step 12.
12b. [Conditional] Source I-SMF to source I-UPF: N4 Session Modification (DL
forwarding tunnel info).
Source I-SMF provides indirect forwarding tunnel info from target side to
source I-UPF. Source I-UPF/Source I-SMF shall also allocate the N3 indirect
forwarding tunnel for source RAN to forward data.
12c. [Conditional] Source I-SMF to S-AMF: Nsmf_PDUSession_UPdateSMContext
Response (N3 forwarding tunnel).
Source I-SMF provide the N3 forwarding tunnel info to S-AMF.
A timer shall be started at source I-SMF to monitor the indirect forwarding
tunnel.
###### 6.1.2.5.3.3 Execution phase
Same as the procedure in clause 6.6.2.4.3.
##### 6.1.2.5.4 UE Triggered Service Request
When a Service Request is received by AMF, the AMF determines whether a new
I-SMF needs to be selected. If an I-SMF does not need to be removed, inserted
or changed, the UE triggered Service Request in clause 4.2.3 of TS 23.502 [3]
can be used without change. If a new I-SMF is selected, the UE triggered
Service Request procedure is shown below.
The following scenarios are supported:
\- from old I-SMF service area to new I-SMF service area, i.e. I-SMF change;
or
\- From A-SMF service area to new I-SMF service area, i.e. I-SMF insertion; or
\- From old I-SMF service area to A-SMF service area, i.e. I-SMF removal.
If the service request is triggered by network and a new I-UPF is selected
(e.g. by a new I-SMF), a forwarding tunnel may need to be established between
the old I-UPF and the new I-UPF to forward buffered data.
Editor\'s note: Interactions with PCF are FFS and depends on conclusions to
key issue #5.
Figure 6.1.2.5.4-1
1-3. These steps are the same as in clause 4.2.3.2 in TS 23.502 [3].
The AMF determines whether I-SMF needs to be removed, inserted or
changed/relocated. The rest of this call flow assumes that I-SMF needs to be
removed, inserted or changed/relocated.
Editor\'s note: It is FFS whether AMF does this for all PDU Sessions or only
for the PDU Sessions where the UP activation has been requested.
4\. If there is an existing (old) I-SMF and the AMF determines that the (old)
I-SMF need to be changed or removed, the AMF sends a Nsmf_PDUSession_Context
Request to the old I-SMF indicating that SM context for an I-SMF is requested.
The old I-SMF replies with a Nsmf_PDUSession_Context Reply including an SM
container with the SM context and an indication whether data forwarding is
needed or not.
Case: I-SMF insertion or I-SMF change:
5\. In case AMF determines that a new I-SMF need to be selected, the AMF
selects the new I-SMF and sends a Nsmf_PDUSession_CreateSMContext Request to
the new I-SMF. The AMF includes the SM container received in step 4. The AMF
maintains the A-SMF ID as part of the UE context.
6\. The new I-SMF selects a UPF (new I-UPF) serving the UE location.
7\. The new I-SMF initiates a N4 Session Establishment to the new I-UPF. In
case tunnel endpoint is allocated by the UPF, the UPF provide tunnel endpoints
to the new I-SMF, otherwise the SMF allocates the tunnel endpoints and
provides them to the UPF.
8\. The new I-SMF sends a Nsmf_PDUSession_CreateSMContext Response to the AMF.
The I-SMF includes N2 SM info (tunnel endpoint information for N3 tunnel) as
well as SM context (forwarding tunnel information).
9\. The new I-SMF sends a Nsmf_PDUSession_Update to the A-SMF and includes
tunnel endpoint information for the DL traffic from A-UPF to new I-UPF. The
A-SMF replies to new I-SMF and includes tunnel endpoint information for UL
traffic from new I-UPF to A-UPF.
10\. The A-SMF provides the DL tunnel information to the UPF.
Case: I-SMF removal:
11\. The AMF sends a Nsmf_PDUSession_UpdateSMContext Request to the A-SMF and
indicates that the I-SMF shall be removed. The AMF also includes the SM
container received in step 4.
12\. In case the UPF allocates tunnel endpoint identifiers, the A-SMF may
request the UPF (PSA) to provide tunnel endpoint for the UL traffic from
(R)AN.
13\. The A-SMF sends a Nsmf_PDUSession_UpdateSMContext Response to the AMF.
The A-SMF includes N2 SM info (tunnel endpoint information for N3 tunnel) as
well as SM context (forwarding tunnel information).
Case: I-SMF removal or I-SMF change: (in order to setup forwarding tunnel from
old I-UPF to either PSA or new I-UPF).
14\. The AMF sends a Nsmf_PDUSession_UpdateSMContext Request to the old I-SMF
containing forwarding tunnel endpoint information for traffic to the PSA UPF
(in case of removal) or the new I-UPF (in case of I-SMF change).
15\. The old I-SMF replies with a Nsmf_PDUSession_UpdateSMContext Response.
16\. The old I-SMF updates the forwarding information in the old I-UPF so that
the buffered data is forwarded to the PSA UPF (in case of removal) or the new
I-UPF (in case of I-SMF change).
17-19. These steps are the same as steps 12-14 in 4.3.2.3 in TS 23.502 [3].
In case a new SMF has been selected (i.e. for I-SMF insertion and I-SMF
change), steps 20-22 are performed. Otherwise call flow continues in step 23.
20\. The AMF sends an Nsmf_PDUSession_UpdateSMContext Request to the new I-SMF
with the N2 SM information for the N3 tunnel.
21\. The new I-SMF updates the new I-UPF with the DL tunnel endpoint
information.
22\. The new I-SMF sends an Nsmf_PDUSession_UpdateSMContext Response to AMF.
In case no I-SMF exist, i.e. I-SMF is to be removed, steps 23-25 are
performed. Otherwise call flow continues in step 26.
23\. The AMF sends an Nsmf_PDUSession_UpdateSMContext Request to the new A-SMF
with the N2 SM information for the N3 tunnel.
24\. The new A-SMF updates the new PSA UPF with the DL tunnel endpoint
information.
25\. The new A-SMF sends an Nsmf_PDUSession_UpdateSMContext Response to AMF.
26\. In case of I-SMF insertion or I-SMF change, the new I-SMF may release the
tunnel endpoint for the forwarding tunnel based on the guard timer.
27\. In case of I-SMF removal, the A-SMF may release the tunnel endpoint for
the forwarding tunnel based on the guard timer.
28\. In case of I-SMF removal or I-SMF change, the old I-SMF releases the old
I-UPF.
##### 6.1.2.5.5 Network Triggered Service Request
The network triggered service request in clause 4.2.3.3 in TS 23.502 [3] can
be reused with the following differences:
If UE is in CM-IDLE state and a new I-SMF is selected by AMF or an I-SMF is
removed, in step 6, the UE triggered service procedure is as described in
clause 6.1.2.5.4, otherwise, the UE triggered service procedure is as in
clause 4.2.3.2 of TS 23.502 [3].
### 6.1.3 Impact of the solution to existing entities
AMF:
\- AMF supports I-SMF selection (insertion, change, removal) function during
all mobility including service request based on SMF service area info received
from NRF (part of Rel-15).
\- Transparently relay SM context container in case of new I-SMF.
\- Transparently relay forwarding tunnel info container in case of indirect
data forwarding.
\- Trigger the resource release toward source I-SMF during mobility in case of
I-SMF change and removal.
\- Handle SMF service area info received from NRF as in Rel-15.
SMF:
\- Support SM context transparent container via AMF.
\- Support data forwarding tunnel during mobility including service request.
\- SMF registers its service area into NRF as in Rel-15.
### 6.1.4 Evaluation of the solution
The whole solution can be evaluated as below:
Architecture:
\- Rel-15 system architecture can be re-used with small adaptions, i.e. home-
routed architecture can be easily used to handle the I-SMF due to
administration area change.
\- Inter-PLMN mobility is also solved by the solution.
\- Can work with either PCC solution 13 or PCC solution 15.
NOTE: Definition of PCC interactions is handled as part of key issue #5.
SMF selection:
\- SMF selection function is still the responsibility of the AMF. Rel‑15
mechanism can be used directly. The only change is that AMF need to apply the
SMF selection logic in some additional procedures compared to Rel-15.
SM context retrieval:
\- Based on similar logic used for interworking between 5GS and EPS in Rel-15.
Forwarding tunnel establishment:
\- Based on the logic used for interworking between 5GS and EPS in Rel-15.
## 6.2 Solution #2: Selection of I-SMF and V-SMF
### 6.2.1 Overview
The solution is an extension of Solution 1, addressing the following two
aspects:
1) Triggering: which entity is determining that an I-SMF is needed; and
2) Selection: which entity selects the I-SMF.
### 6.2.2 Description of the solution
#### 6.2.2.1 Selection of I-SMF/V-SMF:
In this solution it is proposed that the AMF is responsible for I-SMF and
V-SMF selection, in line with SMF selection in Rel-15. In order for the AMF to
select an I-SMF/V-SMF serving a certain location, the AMF provides the UE
location (e.g. TA) in the SMF discovery procedure towards NRF.
The NF profile for the SMF is extended to include also a SMF Service Area (SMF
SA). When the SMF registers its services with the NRF, or when OAM provisions
the NRF, the SMF SA is included. When the AMF queries the NRF for SMF
discovery, the AMF may include an indication that it also wants to receive SMF
SA information together with the SMF ID information (the SMF ID here refers to
information such as SMF IP address, FQDN, SMF Service List etc. that is
delivered in existing NF Discovery service operation). The NRF returns a list
of SMFs supporting the requested location, as well as the corresponding SMF
SAs.
The SMF discovery procedure is done as in Figure 6.2.2-1.
Figure 6.2.2-1: I-SMF discovery during PDU Session establishment or during the
lifetime of a PDU Session
1\. The SMF NF profile, including SMF SA, is registered in NRF. This is done
from SMF or OAM.
2\. AMF determines that SMF selection is needed. This may happen at PDU
Session Establishment, or later during the lifetime of a PDU Session.
3\. AMF may send a Nnrf_NFDiscovery Request (DNN, S-NSSAI, SA indication, UE
location) to NRF in order to discover SMF(s) that supports the S-NSSAI and the
DNN. The SA indication is included if the AMF also wants to receive SMF
Service Area information about each SMF. The request may also contain the UE
location (TA).
4\. NRF returns a list of SMF IDs to AMF, including the SMF SA of each SMF.
5\. During the PDU Session lifetime, when the UE moves out of an SMF Service
Area, the AMF may need to select a new I-SMF. In case the AMF does not have
knowledge about SMFs that can serve the UE location, steps 3-4 are repeated to
discover SMFs serving the UE location.
Editor\'s note: It is FFS whether the explicit \"SA indication\" in step 3 is
needed to request SMF SA information.
Editor\'s note: The amount on information (e.g. size of IE) required to
provide the SMF SA in step 4, e.g. in case the SMF SA contains many TAs, is
FFS.
Another option is that AMF is explicitly configured with the SMF service area
of available SMFs.
#### 6.2.2.2 Determining that an SMF needs to be selected
The AMF determines that an I-SMF/V-SMF is needed based on information received
from NRF as well as local configuration. In order for the AMF to determine
when an I-SMF has to be inserted or relocated, the AMF may know the SMF
Service Area received from NRF as described above. Alternatively, the AMF
queries the NRF whenever the UE appears in a new location (e.g. Tracking Area)
to determine whether the existing SMF can continue to serve the PDU Session
without the need for I-SMF insertion/relocation.
### 6.2.3 Impact of the solution to existing entities
Delivery of the SMF SA as part of the SMF NF profile from NRF to AMF is
already included in Rel-15.
Currently (Rel-15) the full SMF NF profile is delivered to the client and it
is not possible for a client to request a subset of it. The explicit \"SA
indication\" described in step 3 above is thus not part of Rel-15 solution.
Without the explicit \"SA indication\" this solution has no impact to existing
entities.
### 6.2.4 Evaluation of the solution
This solution provides a simple solution allowing the AMF to be explicitly
aware of the SMF SA. It also enables a reduction a signaling frequency between
AMF and NRF since AMF does not need to query the NRF for each new UE location.
This solution is aligned with current Rel-15 where the SMF NF profile already
contains the SMF SA. Whether the explicit \"SA indication\" is needed to
request SMF SA information from NRF can be determined during normative phase,
or by stage 3 as a protocol aspect.
## 6.3 Solution #3: Mobility between SMF service areas
### 6.3.1 Overview
This solution is to address the Key Issue 1 and 4 and based on the
architecture proposed in solution # 1.
### 6.3.2 Description of the solution
#### 6.3.2.1 Network Architecture
This solution adopts the architecture in solution # 1.
#### 6.3.2.2 Procedures
**PDU Session Establishment procedure**
The UE Requested PDU Session Establishment procedures as specified in clause
4.3.2.2 of TS 23.502 [3] are enhanced to support the I-SMF with the following
additions:
11\. SMF to AMF: Namf_Communication_N1N2MessageTransfer.
The SMF service area is sent to the AMF.
**UE triggered Service Request procedure**
The UE Triggered Service Request procedure as specified in clause 4.3.3.2 of
TS 23.502 [3] are enhanced to support the I-SMF. The main enhancements are as
followings: (1) SM contexts are transferred between the A-SMF and I-SMF
directly (step 6); (2) the old N11 association between A-SMF and AMF is
released (step 12).
Figure 6.3.2.3-1: Network Architecture
3\. The AMF determines whether I-SMF selection is performed as described in
clause 6.3.2.2.
5\. The AMF provides the A-SMF ID to the I-SMF.
6\. The I-SMF retrieves the PDU Session contexts (e.g. QoS profiles, UPF
Tunnel info) from the A-SMF.
9\. The I-SMF provides the I-UPF Tunnel info to the A-SMF.
12\. The AMF releases the N11 association of the A-SMF.
Editor\'s note: Other procedures to support I-SMF are FFS.
### 6.3.3 Impact of the solution to existing entities
AMF is enhanced to support I-SMF selection.
SMF is enhanced to support the interaction between SMFs.
### 6.3.4 Evaluation of the solution
Editor\'s note: This clause provides an evaluation of the solution.
## 6.4 Solution #4: I-SMF selection by the AMF
### 6.4.1 Overview
This solution corresponds to architecture and procedures in the solution #3
and proposes that the AMF determines whether I-SMF selection is needed and
selects the I-SMF if needed.
### 6.4.2 Description of the solution
This solution proposes the AMF determines whether an I-SMF is needed and
performs the I-SMF selection. The following alternative options can be
considered:
\- Option 1: The AMF determines an I-SMF is to be inserted based on the
configuration information of SMF service area in the AMF (e.g. via O&M). If
the AMF determines that a UE moves out A-SMF service area, the AMF selects an
I-SMF based on UE location and configured SMF service area.
\- Option 2: In this option, the SMF registers to the NRF with its service
area, and upon receiving the request from the AMF with UE location, the NRF
returns the SMFs that can serve the UE. During the PDU Session Establishment
procedure, a SMF is selected by the AMF by querying the NRF with providing UE
location (the selected SMF is named as A-SMF), and the A-SMF notifies the AMF
about its service area. If the AMF determines that a UE moves out A-SMF
service area, the AMF selects an I-SMF by querying NRF. In the Home routed
roaming case, the SMF in the VPLMN returns its service area to the AMF.
### 6.4.3 Impact of the solution to existing entities
Editor\'s note: This clause describes impacts to existing entities and
interfaces.
### 6.4.4 Evaluation of the solution
Editor\'s note: This clause provides an evaluation of the solution.
## 6.5 Solution #5: I-SMF as only a UPF Controller
### 6.5.1 Overview
This solution is pertaining to the Key Issue 1 and Key Issue 4 where
intermediate SMF (I-SMF) is added along with the existing SMF (referred as
Anchor SMF or A-SMF) when the UE leaves coverage area of the A-SMF and can no
longer serve the UE\'s new location.
### 6.5.2 Description of the solution
This solution supports deployments where the SMF (A-SMF) that controls the PDU
Session Anchor cannot control all UPFs serving the PDU Session.
If the UE moves to a new area which is not served by A-SMF and there is no UPF
under the A-SMF control which can connect to the target NG-RAN, the A-SMF
decides to add an I-SMF. This may happen if the A-SMF is controlled by third
party or the UE roams in to different region / administrative domain so that
A-SMF cannot serve the new area.
Determination of whether I-SMF is essential is based on the coverage area of
the A-SMF. If the UE roams outside of the coverage area of the A-SMF, the
A-SMF is notified by the AMF and at that time, the A-SMF selects an I-SMF. But
the decision whether to add or remove the existing I-SMF will remain up to the
A-SMF.
Figure 6.5.2-1: Network architecture with I-SMF
Figure 6.5.2-1 shows network architecture where connectivity with the AMF
(i.e. N11 interface) is still maintained with the A-SMF. In this case, the
A-SMF remains NAS SM termination point. Similarly, N6 connectivity is also
maintained with the PDU Session Anchor which is controlled by the A-SMF.
New I-SMF is added when the UPF controlled by the A-SMF no longer serves the
UE\'s new location. A new interface Nx is defined between the A-SMF and I-SMF
which may be considered as a variation of N4 interface. In this case, the
I-SMF provides limited functionality of controlling user plane resources while
all interactions with other network functions including AMF, PCF and UDR
continued to be supported by the A-SMF. Buffering is supported by the A-UPF
(UPF connected to the A-SMF.
I-SMF may be removed when the UE moves out of the coverage area of the I-SMF.
In this case, the A-SMF may decide to reallocate the I-SMF with a new I-SMF or
continue with A-SMF depending on the current location of the UE.
### 6.5.3 Network architecture and relation to use cases
The architecture provided in the previous section captures solution to use
case #1 (two regions of a PLMN) and use case #3 (Corporate case). The
architecture may also apply to use-case 2 (inter-PLMN), however in that case
the AMF from PLMN-B has N-11 to A-SMF in PLMN-A which then has Nx interface to
I-SMF again in PLMN-B.
This architecture also addresses the point in key issue 1 on how to insert a
UPF supporting UL-CL/BP (IPv6 multi-homing) which needs a PSA2 in an area not
controlled by the anchor SMF. It also addresses key issue 5 by not changing
which SMF the PCF processes the AF\'s request. Maintaining the A-SMF as the
point of policy update, the I-SMF can be relocated in case there is a more
optimum topology, and this avoids N11 and N7 changes which would introduce
call set up latency.
Figure 6.5.3.1: UL-CL/BP Architecture with DN in I-SMF Area
The A-SMF determines through querying the NRF or through Local DN topology
mapping configuration that the I-SMF can service the UL-CL and IPv6 multi-home
PSA2 UPF. The A-SMF requests over the Nx interface the I-SMF to establish the
UL-CL UPF and BP UPF. In figure 6.5.3.1, these are shown as separate from the
I-UPF, but depending on deployment topology, these could be co-located.
Furthermore, the I-SMF may select the PSA2 UPF from the suggested list from
the A-SMF if the A-SMF has knowledge of the network topology, or the I-SMF
selects the PSA2 UPF using local configuration or querying the NRF. The I- SMF
then allocates a new IPv6 prefix corresponding to PSA2 UPF. The IPv6 prefix is
passed to the from the I-SMF to the A-SMF over Nx interface and if the PCF has
subscribed to the IP allocation/release event, the A-SMF performs the Session
Management Policy Modification procedure as defined in clause 4.16.5 of TS
23.502 [3] to provide the new allocated IPv6 prefix to the PCF over N7.
The I-SMF collects charging information and reports usage over to the Nx
interface to the A-SMF so that a consolidated record can be sent to the CHF in
the same manner as if the I-UPF, UL-CL and PSA2 had been controlled by the
A-SMF.
### 6.5.4 Procedures
#### 6.5.4.1 Handover with I-SMF insertion
The handover procedure where the target NR-RAN is not reachable from the
UPF\'s managed by the A-SMF is illustrated in the call flow below for Xn based
handover. It is assumed that service areas of SMF are full TAIs.
{width="6.6875in" height="4.78125in"}
Figure 6.5.4.1-1: Xn based handover with I-SMF and I-UPF insertion
1-3. As in TS 23.502 [3], clause 4.9.1.2.3.
Traffic is sent to the A-UPF from the NG-RAN until the path switch in step
16.4. Based on the UE location information provided in this step, e.g. the TAI
of the target gNB, the SMF determines whether the existing UPF can continue to
serve the UE.
5-6. The A-SMF performs UPF selection based on clause 6.3.3.3 of TS 23.501 [2]
or I-SMF selection. There could be operator configuration or the SMF could
discover applicable UPF/I-SMF from an NRF discovery procedure if there are no
suitable UPF\'s known to the A-SMF.
If the discovery was for UPF, in addition to the UPF, the NRF also returns the
I-SMF for this UPF, along with capabilities. Otherwise, the NRF returns the
I-SMF serving the region.
7\. The A-SMF selects I-SMF from the inputs from NRF. It provides minimal
information for the I-SMF to make a selection including the Target gNB DL TEID
information and the anchor UPF UL TEID.
The I-SMF selects the I-UPF as per clause 6.3.3.3 of TS 23.501 [2].
8-9. I-SMF to I-UPF: N4 Session Establishment Request (Target NG-RAN address
and N3 DL tunnel identifiers, A-UPF F-TEID).
10\. I-SMF to A-SMF: Nx Response (Target UPF address, Tunnel Identifiers for
DL N9 User Plane).
11-12. SMF to PDU Session Anchor: N4 Session Modification Request/Response.
The SMF sends N4 Session Modification message to the PDU Session Anchor.
The PDU Session Anchor (A-UPF) responds with the N4 Session Modification
Response message after which the requested PDU Sessions are switched. At this
point, PDU Session Anchor starts sending downlink packets to the Target NG-RAN
using the address and tunnel identifiers of the Target NG-RAN via Target UPF
(I-UPF).
13-14. In order to assist the reordering function in the Target NG-RAN, the
PDU Session Anchor (A-UPF) sends one or more \"end marker\" packets for each
N3 tunnel on the old path immediately after switching the path, the source NG-
RAN shall forward the \"end marker\" packets to the target NG-RAN.
15\. A-SMF to AMF: Nsmf_PDUSession_UpdateSMContext Response (CN Tunnel Info).
The A-SMF sends a Nsmf_PDUSession_UpdateSMContext response to the AMF. CN
Tunnel Info includes UL tunnel identifiers and address of the new intermediate
UPF. This is the same as Step 8 in TS 23.502 [3] clause 4.9.1.2.3.
16-17. Same as steps 7-9 defined in TS 23.502 [3] clause 4.9.1.2.3.
#### 6.5.4.2 AN Release
This procedure illustrates how the AN release procedure is enhanced to release
the N3 interface on the I-UPF and either (a) also remove the N9 tunnel between
A-UPF and I-UPF and N4\' interface between A-SMF and I-SMF, or (b) no other
interface. At the end of the release procedure, either (a) the A-UPF buffers
DL data for PDU sessions and performs DDN, or (b) the I-UPF buffers the packet
and performs DDN via the I-SMF to A-SMF to the AMF. The A-SMF decides to
perform either (a) or (b) based on operator specific policy e.g. depending on
serving area of I-SMF and the decision may also be UE specific, e.g. depending
on UE mobility profile.
{width="6.694444444444445in" height="2.8333333333333335in"}
Figure 6.5.4.2-1: AN Release
The procedure is as defined in TS 23.502 [3] clause 4.2.6 with the addition of
steps 9 to 12.
1-6. As specified in TS 23.502 [3], clause 4.2.6 steps 1-5.
7-8. (Only for option (a)) The A-SMF request A-UPF to remove DL tunnel to the
I-SMF. Hence, the A-UPF performs buffering of packets and DNN to the A-SMF for
UE in idle mode. As specified in TS 23.502 [3] clause 4.2.6, except that the
N9 tunnel is being removed instead of N3 tunnel.
9\. The A-SMF sends an Nx Session Modification Request to remove the N3 tunnel
and (a) N9 tunnel and N4\' tunnel at the I-SMF. For case (b) only the N3
tunnel is removed.
10-11. The A-SMF relays the command to the I-UPF.
12\. The I-SMF responds to the A-SMF.
13\. As specified in TS 23.502 [3] clause 4.2.6 step 7.
#### 6.5.4.3 Service Request
This procedure illustrates how the UE would be reconnected during a network
initiated re-activation and a service request.
Figure 6.5.4.3-1: Network requested service request with I-SMF and I-UPF
insertion
When the UE goes idle, for case (a) the N3, N4\' and the N9 tunnels are
removed, or (b) only the N3 tunnel is removed.
1a-4a. As specified in TS 23.502 [3] clause 4.2.3.3 step 1-2c. This occurs
when N9 tunnel is removed to the I-UPF.
1b-4b: As specified in TS 23.502 [3] clause 4.2.3.3 step 1-2c. This occurs
when N9 tunnel is still in place.
5-6. As specified in TS 23.502 [3] clause 4.2.3.3 steps 3a-3b.
7-8. As specified in TS 23.502 [3] clause 4.2.3.3 step 4b.
9-10. As specified in TS 23.502 [3] clause 4.2.3.2 steps 1-2.
11\. As specified in TS 23.502 [3] clause 4.2.3.2 steps 4.
For Option (a), The UPF selection procedure is as specified in clause 6.5.4.1
steps 5-6 which optionally uses the NRF and returns the UPF and the
controlling I-SMF.
12\. For option (a), The A-SMF sends a session establishment request to setup
the N3 tunnel to the NG-RAN and the N9 tunnel to the A-UPF, or for option (b),
the A-SMF sends N4 session modification request to the I-SMF to setup the N3
tunnel.
13-14. The I-SMF relays the command to the I-UPF.
15\. For Option (a), The I-SMF determines the DL F-TEID for the N9 tunnel and
the N3 UL F-TEID and relays this to the A-SMF.
16-17. Option for Option (a), The A-SMF updates the A-UPF with the N9 DL
F-TEID of the tunnels.
18-20. As specified in TS 23.502 [3] clause 4.2.3.2 steps 11-13.
The advantage of the A-SMF handling the DDN and communicating directly with
the AMF is that the following policy can be applied with no changes to the
5GC.
\- If the Paging Policy Differentiation feature is supported by the A-SMF, the
A-SMF determines the Paging Policy Indication based on the DSCP in TOS (IPv4)
/ TC (IPv6) value from the IP header of the received downlink data packet and
identifies the corresponding QFI of the QoS Flow for the DL data packet.
#### 6.5.4.4 Addition of additional PDU Session Anchor and Branching Point or
UL CL
{width="6.072916666666667in" height="4.583333333333333in"}
Figure 6.5.4.4-1: Addition of additional PDU Session Anchor and Branching
Point or UL CL
1\. UE has an established PDU Session with a UPF including the PDU Session
Anchor 1 (PSA1 in Figure 6.5.4.1-1). The PDU Session User Plane involves the
I-UPF associated with I-SMF and the PDU Session Anchor 1 associated with
A-SMF.
2a. At some point the A-SMF decides to establish a new PDU Session Anchor e.g.
due to UE mobility, new flow detection due to a trigger from the PCF.
determines through querying the NRF or through Local DN topology mapping
configuration that the I-SMF can service the UL-CL and IPv6 multi-home PSA2
UPF. The A-SMF requests the I-SMF over the Nx interface to establish the UL-CL
UPF and BP UPF. The A-SMF can include a list of candidate UPF\'s retrieved
from the NRF or from the topology map in the Nx message. The I-SMF selects a
UPF from the list or selects the appropriate PSA2 UPF based on local topology
knowledge and using N4 establish the new PDU Session Anchor 2 (PSA2 in Figure
6.5.4.1-1) of the PDU Session. In case of IPv6 multi-homing PDU Session, the
I-SMF also allocates a new IPv6 prefix corresponding to PSA2,
2b. The IPv6 prefix is passed to the from the I-SMF to the A-SMF over Nx
interface and if the PCF has subscribed to the IP allocation/release event,
the A-SMF performs the Session Management Policy Modification procedure as
defined in clause 4.16.5 of TS 23.502 [3] to provide the new allocated IPv6
prefix to the PCF using Npcf_SMPolicyControl_Update.
3a. Optionally, the I-SMF may query the NRF or an NRF for the SMF serving
area, to obtain a list of suitable UPF\'s. The implications on the
architectural are FFS.
3b. The I-SMF may use information from A-SMF, NRF and/or local topology
mapping to select a UPF and using N4 establish the Branching Point (in case of
IPv6 multi-homing) or a UL CL for the PDU Session. It provides the necessary
uplink forwarding rules towards PSA1 and PSA2 including the PSA1 CN Tunnel
Info and the PSA2 CN Tunnel Info. In addition, the AN Tunnel Info is provided
for downlink forwarding. In case of IPv6 multi-homing, the I-SMF provides the
traffic filters to the A-SMF and the A-SMF then in turn provide traffic
filters for the IPv6 prefixes corresponding to PSA1 and PSA2 indicating what
traffic shall be forwarded towards PSA1 and PSA2 respectively. In case of UL
CL, the A-SMF provides the I-SMF the traffic filters indicating what traffic
shall be forwarded towards PSA1 and PSA2 respectively.
5\. The I-SMF updates PSA2 via N4. It provides the Branching Point or UL CL CN
Tunnel Info for down-link traffic.
NOTE 3: In case the Branching Point or UL CL and the PSA2 are co-located in a
single UPF then step 5 is not needed.
6\. The SMF updates (R)AN via N2 SM information over N11. It provides the new
CN Tunnel Info corresponding to the UPF (Branching Point or UL CL). In case of
UL CL, if there is an existing UPF between the (R)AN and new inserted UL CL,
the SMF updates the existing UPF via N4 instead of updating the (R)AN.
Procedure continues according to TS 23.502 [3].
### 6.5.5 Impact of the solution to existing entities
AMF:
\- No impacts.
NRF:
\- SMF service area information, capabilities and UPF interfaces as defined in
TS 29.510 [6]. Enhancements may be needed in stage 3 to fully address the
scenarios including whether there needs to be an NRF per service area to
simplify the topology information that needs to be known by the NRF.
SMF:
\- The querying of NRF with sufficient information to re-select/insert
appropriate UPF(s).
\- Selection of I-SMF based on local configuration or NRF response.
\- Nx interface support. Nx interface is anticipated to be a super set of N4
functionality and may use an SBA interface.
Editor\'s note: How Nx deviates from N4 functionality is FFS.
PCF:
\- No impacts if same PCF for each SMF serving area is used.
CHF:
\- No impacts. The I-SMF reports usage to the A-SMF so there is no change to
the Nchf interface.
### 6.5.6 Evaluation of the solution
This solution minimizes the impact on other NF\'s when the UE moves to a
region that has UPF\'s that are not connected to or managed by the A-SMF. The
A-SMF remains in control of all session management, selection of the I-SMF and
preserves the functions of the A-SMF so that it does not delegate these to the
I-SMF. This simplifies the I-SMF function and does not re-home the N11
connection to the SMF. As such the NEF, PCF and other NF\'s are not aware of
the UE\'s mobility and the downlink buffering is still performed in the A-SMF
where session policy is installed.
## 6.6 Solution #6: SMF selection and reselection due to different region:
### 6.6.1 Overview
This solution addresses key issue 4.
### 6.6.2 Description of the solution
#### 6.6.2.1 General
In this solution, the architecture is as following Figure:
Figure 6.6.2.1-1: A-SMF and AMF in different region
Editor\'s note: The relation between this solution and solution #1/3: Mobility
between service areas is FFS.
#### 6.6.2.2 SMF selection during PDU Session establishment
When a PDU session is activated, the SMF that controls the PDU session anchor
may be located in an administrative region that is different from the SMF that
controls the UPF connecting to NG AN. In this case, two SMFs needs to be
selected for the PDU session establishment.
The AMF selects the A-SMF that controls the PDU session anchor based on
S-NSSAI and DNN. The AMF, based on the UE location and the selected A-SMF(s),
determines whether an I-SMF that controls an UPF connecting to NG RAN needs to
be selected. If it is needed, the AMF selects the I-SMF based on S-NSSAI and
UE location information.
From the configured or the collected information, the AMF may be aware of the
area served by the SMF in the same region.
The AMF determine whether I-SMF is needed based on the intersection between
the area served by the A-SMF and UE location.
If the A-SMF is not in the same region, the AMF does not have the information
of the area served by the A-SMF, the AMF determine that I-SMF is needed. In
another option, the AMF determine whether A-SMF is located in the same AMF
region or not based on the A-SMF identity which includes region information.
The AMF request NRF to select I-SMF(s) based on S-NSSAI and UE location
information.
If the AMF cannot determine whether an I-SMF needs to be selected or not, the
AMF requests NRF to select I-SMF(s) based on S-NSSAI and UE location
information. And based on the returned I-SMF(s) and A-SMF(s), the AMF
determines whether a collocated SMF that supports both I-SMF and A-SMF can be
selected.
The SMF selection procedure as defined in TS 23.502 [3], clause 4.3.2.2.1,
step 2, is done as in Figure 2.1-2.
Figure 6.6.2.2-1: I-SMF Selection during PDU Session establishment
1\. The area SMF can served is registered in NRF. This is done via SMF or OAM.
2\. AMF receives PDU Session Establishment Request, which includes S-NSSAI,
DNN and the UE location information added by 5G AN.
3\. AMF sends Nnrf_NFDiscovery Request (DNN, S-NSSAI) to NRF in order to
select an A-SMF that supports the S-NSSAI and the DNN.
4\. NRF returns a list of SMF IDs to AMF.
5\. AMF determines whether I-SMF needs to be selected based on area served by
the candidate A-SMF(s).
If there is no candidate A-SMF can serve the UE location or the AMF cannot
decide whether I-SMF is needed, the AMF sends Nnrf_NFDiscovery Request (UE
location info, S-NSSAI) to NRF.
6\. NRF selects I-SMF based on UE location info and S-NSSAI and returns a list
of I-SMF(s) to AMF. The AMF selects one I-SMF from the I-SMF list.
If the AMF cannot decide whether the I-SMF is needed and query NRF at step 5,
the selected I-SMF may be same as the A-SMF.
After the I-SMF has been selected, the UPF which terminated N3 interface is
selected by the I-SMF.
#### 6.6.2.3 I-SMF reselection during UE mobility
During UE mobility the AMF determines whether I-SMF needs to be relocated. The
AMF determines whether to reselect I-SMF based on UE location information and
area of old SMF served, i.e. the SMF which control the UPF terminated the N3
interface. The area SMF served is be configured or collected by the AMF.
According to TS 23.502 [3] clause 4.2.2.2.2, step 18, when the AMF update the
SM context stored at the SMF, the AMF check whether the I-SMF need be
reallocated. Similar is done on the handover procedure. The I-SMF reselection
procedure is in figure 2.2-1.
Figure 6.6.2.3-1: I-SMF Selection due to UE mobility
1\. During mobility procedure, e.g. registration update or handover procedure,
the AMF needs to determine whether I-SMF selection is needed.
2\. If the old SMF, i.e. the SMF which control the UPF terminated the N3
interface, is not in the same region as the AMF (i.e. inter region mobility),
a new I-SMF needs be selected. Otherwise, the AMF determines whether to select
or reallocate I-SMF based on UE location information and information of the
area old SMF served, The AMF decide based on the configured or collected
information of the area served by the SMF.
If AMF determines I-SMF reselection is needed or uncertain whether it is
needed, the AMF query NRF. The AMF provides UE location info and S-NSSAI to
NRF.
3\. NRF returns a list of I-SMF(s) to AMF. The AMF selects one I-SMF from the
I-SMF list. If the AMF cannot decide whether the I-SMF is needed and query NRF
at step 2, the selected I-SMF may be same as the old I-SMF.
After the I-SMF has been selected, the UPF which terminated N3 interface can
be selected by the I-SMF.
#### 6.6.2.4 Inter NG-RAN node N2 based handover with I-SMF Change
##### 6.6.2.4.1 General
After each PDU is established, for each PDU Session the AMF store the SMF
selection context information and the selected I-SMF ID, i.e. DNN/S-NSSAI, PDU
session ID, I-SMF ID, A-SMF ID.
When the UE do the connected state mobility from one area to another area, the
possible scenario related I-SMF change can be listed as following:
\- from source I-SMF service area to target I-SMF service area, i.e. I-SMF
reallocation; or
\- from A-SMF service area to target I-SMF service area, i.e. I-SMF insertion;
or
\- from source I-SMF service area to A-SMF service area, i.e. I-SMF removal.
##### 6.6.2.4.2 Preparation phase
The N2 handover preparation procedure with I-SMF and I-UPF change are depicted
in figure 6.6.2.4.2-1.
Figure 6.6.2.4.2-1: Inter NG-RAN node N2 Handover with I-SMF and I-UPF change,
preparation phase
3\. The target AMF determines and selects a target I-SMF as described in
clause 6.6.2.3.
4\. The target AMF includes the source I-SMF ID in
Nsmf_PDUSession_CreateSMContext Request sent to target I-SMF.
If the UE moves from A-SMF service area to target I-SMF service area (i.e. the
I-SMF insertion), the source I-SMF ID is the A-SMF ID.
5-6. The target I-SMF retrieves SM context from the source I-SMF based on the
I-SMF ID received from AMF. The SM context includes UL A-UPF tunnel
information and the A-SMF ID for the PDU session.
If the UE moves from source I-SMF service area to A-SMF service area (i.e. the
I-SMF removal), i.e. AMF determine the target I-SMF is A-SMF, step 5-6 are
skipped.
The source I-SMF starts a timer to release the resource of source I-SMF and
source I-UPF, which is to be used in step 14 of the Execution Phase.
7\. The target I-SMF selects a new I-UPF and send N4 session establishment
request to the new I-UPF, including UL A-UPF tunnel info.
If the UE moves from source I-SMF service area to A-SMF service area (i.e. the
I-SMF removal), the A-SMF may not select a new I-UPF. If new I-UPF is not
selected, step 7 is skipped.
12\. The target I-SMF provides the indirect forwarding tunnel info received
from Target NG RAN in step 11 to the target I-UPF.
If the UE moves from source I-SMF service area to A-SMF service area (i.e. the
I-SMF removal) and a new I-UPF is not selected, the indirect forwarding tunnel
info is provided to A-UPF in this step.
13\. If the indirect forwarding tunnel needs to be established for the PDU
session, the target I-SMF invokes Nsmf_PDUSession_Update request (indirect
forwarding tunnel info) to the source I-SMF.
If the UE moves from A-SMF service area to target I-SMF service area (i.e. the
I-SMF insertion), the source I-SMF is A-SMF, the target I-SMF invokes
Nsmf_PDUSession_Update request (indirect forwarding tunnel info) to A-SMF, and
A-SMF may select another UPF to establish indirect forwarding tunnel.
If the UE moves from source I-SMF service area to A-SMF service area (i.e. the
I-SMF removal), the target I-SMF is A-SMF, A-SMF invokes
Nsmf_PDUSession_Update request (indirect forwarding tunnel info) to the source
I-SMF.
14\. The source I-SMF provides the indirect forwarding tunnel info to source
I-UPF. If the UE moves from A-SMF service area to target I-SMF service area
(i.e. the I-SMF insertion), the source I-SMF is A-SMF, and A-SMF provides the
indirect forwarding tunnel info to source I-UPF or A-UPF (in case no source
I-UPF).
15\. The source I-SMF (or A-SMF in case of I-SMF insertion) responds to target
I-SMF (or A-SMF in case of I-SMF removal) with the indirect forwarding tunnel
info of the source I-UPF (or A-UPF in case of I-SMF insertion).
The target I-SMF starts an indirect data forwarding timer, which is to be used
to release the resource of indirect data forwarding tunnel.
##### 6.6.2.4.3 Execution phase
Figure 6.6.2.4.3-1: Inter NG-RAN node N2 Handover with I-SMF and I-UPF change,
Execution phase
6\. T-AMF notifies to the S-AMF about the N2 handover notify received from the
T-RAN by invoking the Namf_Communication_N2InfoNotify.
A timer in S-AMF is started to supervise when resources in S-RAN shall be
release.
If the PDU Session(s) is not accepted by the T-AMF (e.g. S-NSSAI associated
with the PDU Session is not available in the T-AMF), S-AMF triggers PDU
Session Release procedure. If the source I-SMF exists, the PDU Session Release
is via source I-SMF.
7\. The T-AMF triggers Nsmf_PDUSession_UpdateSMContext Request (Handover
Complete indication for PDU Session ID) toward the target I-SMF for PDU
sessions that are accepted.
If the UE moves from source I-SMF service area to A-SMF service area (i.e. the
I-SMF removal), the target I-SMF is A-SMF.
8\. The target I-SMF sends N4 Session Modification Request indicating DL AN
Tunnel Info of T-RAN to the Target I-UPF.
If the UE moves from source I-SMF service area to A-SMF service area (i.e. the
I-SMF removal), the target I-SMF is A-SMF, if target I-UPF is selected during
preparation phase, the A-SMF sends DL AN Tunnel Info of T-RAN to the Target
I-UPF. If target I-UPF is not selected during preparation phase, the A-SMF
indicate DL AN Tunnel Info of T-RAN to the A-UPF.
9\. The target I-SMF invokes Nsmf_PDUSession_Update Request (PDU Session ID,
Target I-UPF DL Tunnel Info) toward A-SMF.
If the UE moves from source I-SMF service area to A-SMF service area (i.e. the
I-SMF removal), this step is skipped. 10. The A-SMF sends N4 Session
Modification Request indicating Target I-UPF DL Tunnel Info toward A-UPF.
If the UE moves from source I-SMF service area to A-SMF service area (i.e. the
I-SMF removal) and if target I-UPF is not selected during preparation phase,
this step is skipped.
14\. When the timer set in source I-SMF during preparation phase expires, i.e.
step 5, the source I-SMF sends N4 Session Release toward source I-UPF. If
indirect forwarding tunnel was established, it will be released together. The
source I-SMF removes the UE context information.
15\. When the timer for indirect forwarding tunnel set in target I-SMF
expires, i.e. step 15, the target I-SMF sends N4 Session Modification Request
to target I-UPF, to release the indirect forwarding tunnel.
#### 6.6.2.5 UE Triggered Service Request
After each PDU is established, for each PDU Session the AMF stores the
selected I-SMF ID (if exists), the DNN/S-NSSAI, and PDU session ID.
When service request is received, the AMF determines whether a new I-SMF needs
to be selected, if a new I-SMF is not needed, i.e. without I-SMF relocation,
insertion or removal, the UE triggered Service Request in clause 4.2.3 of TS
23.502 [3] can be used without change. If a new I-SMF is selected, the UE
triggered Service Request procedure is shown in this clause.
The possible scenarios related to I-SMF change in service request are listed
as following:
\- from old I-SMF service area to new I-SMF service area, i.e. I-SMF
reallocation; or
\- from A-SMF service area to new I-SMF service area, i.e. I-SMF insertion; or
\- from old I-SMF service area to A-SMF service area, i.e. I-SMF removal.
If the service request is triggered by network and if the data is not buffered
in PDU Session Anchor UPF, forwarding tunnel may need to be established
between the old I-UPF and the new I-UPF. For I-SMF insertion, when UE was in
A-SMF service area, an old I-UPF different from A-UPF may exist, in this case,
forwarding tunnel may need to be established.
Figure 6.6.2.5-1: UE Triggered Service Request with I-SMF change
2\. The AMF determines and selects a new I-SMF as described in clause 6.6.2.3.
3\. The AMF invokes Nsmf_PDUSession_CreateSMContext Request (old I-SMF ID)
service operation to new I-SMF.
If the UE moves from A-SMF service area to new I-SMF service area (i.e. the
I-SMF insertion), the A-SMF ID is included.
4-5. The new I-SMF retrieves SM context from the old I-SMF based on the I-SMF
ID received from AMF. The SM context includes UL A-UPF tunnel information and
the A-SMF ID for the PDU session. The old I-SMF determines whether forwarding
tunnel needs to be established between old I-UPF and new I-UPF, if the
forwarding tunnel is needed, the old I-SMF includes forwarding indication in
the SM context. The old I-SMF starts a timer to release the resource of old
I-SMF and old I-UPF.
If the UE moves from old I-SMF service area to A-SMF service area (i.e. the
I-SMF removal) the new I-SMF is replaced by A-SMF.
If the UE moves from the A-SMF service area to new I-SMF service area (i.e.
the I-SMF insertion), the old I-SMF is replaced by A-SMF.
NOTE: The context retrieved in step 4 is not exactly the same as the context
in the interworking case.
6\. The new I-SMF selects a new I-UPF and send N4 session establishment
request to the new I-UPF, including UL A-UPF tunnel info. If the forwarding
indication is received for this PDU Session, the N4 session establishment
request includes Data forwarding indication. The Data Forwarding Indication
indicates to the UPF that a tunnel endpoint needs to be reserved for buffered
DL data received from the old I-UPF.
If the UE moves from old I-SMF service area to A-SMF service area (i.e. the
I-SMF removal), the A-SMF may not select a new I-UPF. If new I-UPF is not
selected, step 6 is skipped. In this case, the forwarding tunnel is
established in step 8.
7\. The new I-SMF invokes Nsmf_PDUSession_Update Request (new I-SMF ID, new
I-UPF tunnel Info) service operation to A-SMF.
8\. A-SMF notify the A-UPF to update the DL data path from the old I-UPF to
the new I-UPF.
If the UE moves from old I-SMF service area to A-SMF service area (i.e. the
I-SMF removal), and a new I-UPF is not selected, the A-SMF includes Data
Forwarding Indication in the N4 session modification request. The Data
Forwarding Indication indicates to the A-UPF that a tunnel endpoint needs to
be reserved for buffered DL data received from the old I-UPF.
10\. If the data forwarding tunnel needs to be established for the PDU
session, the new I-SMF invokes Nsmf_PDUSession_Update request (forwarding
tunnel info) to the old I-SMF.
If the UE moves from A-SMF service area to new I-SMF service area (i.e. the
I-SMF insertion), the old I-SMF is replaced by A-SMF, the new I-SMF invokes
Nsmf_PDUSession_Update request (forwarding tunnel info) to A-SMF.
If the UE moves from old I-SMF service area to A-SMF service area (i.e. the
I-SMF removal), the new I-SMF is replaced by A-SMF, A-SMF invokes
Nsmf_PDUSession_Update request (forwarding tunnel info) to the old I-SMF.
11\. The old I-SMF provides the forwarding tunnel info to old I-UPF.
If the UE moves from A-SMF service area to new I-SMF service area (i.e. the
I-SMF insertion), and if an old I-UPF different from A-UPF exists, the old
I-SMF is replaced by A-SMF, i.e. A-SMF provides the forwarding tunnel info to
old I-UPF controlled by A-SMF.
12\. The old I-SMF (or A-SMF in case of I-SMF insertion) responds to new I-SMF
(or A-SMF in case of I-SMF removal). The new I-SMF starts a data forwarding
timer, to be used to release the resource of data forwarding tunnel.
20a. When timer set in step 5 has expired, the old I-SMF triggers the N4
session release. The PDU session in old I-UPF and I-SMF will be released. If
forwarding tunnel is established, the forwarding tunnel is also released.20b.
when timer set in step 12 has expired, the new I-SMF releases the forwarding
tunnel of the PDU session.
#### 6.6.2.6 Network Triggered Service Request
The network triggered service request in clause 4.2.3.3 in TS 23.502 [3] can
be reused with the following difference:
If UE is in CM-IDLE state and a new I-SMF is selected by AMF, in step 6, the
UE triggered service procedure is as in 6.6.2.5, otherwise, the UE triggered
service procedure is as clause 4.2.3.2 of TS 23.502 [3].
#### 6.6.2.7 Registration Procedure
After each PDU is established, for each PDU Session the AMF store the SMF
selection context information and the selected I-SMF ID, i.e. DNN/S-NSSAI, PDU
session ID, I-SMF ID.
When registration request is received, the AMF determines whether a target
I-SMF needs to be selected, the possible scenario related to I-SMF change in
registration request can be listed as following:
\- from source I-SMF service area to target I-SMF service area, i.e. I-SMF
reallocation; or
\- from A-SMF service area to target I-SMF service area, i.e. I-SMF insertion;
or
\- from source I-SMF service area to A-SMF service area, i.e. I-SMF removal.
Figure 6.6.2.7-1: Registration Procedure
2\. The target AMF determines and selects a target I-SMF as described in
clause 6.6.2.3.
Steps 3 - 11 are for I-SMF insertion or I-SMF change:
3\. The target AMF includes the source I-SMF ID in
Nsmf_PDUSession_CreateSMContext Request sent to target I-SMF.
If the UE moves from A-SMF service area to target I-SMF service area (i.e. the
I-SMF insertion), the source I-SMF ID is the A-SMF ID.
4-5. The target I-SMF retrieves SM context from the source I-SMF based on the
I-SMF ID received from AMF. The SM context includes UL A-UPF tunnel
information, QoS parameters for this PDU session, and the A-SMF ID for the PDU
session.
If the UE moves from the A-SMF service area to target I-SMF service area (i.e.
the I-SMF insertion), the source I-SMF is A-SMF.
6-7. The target I-SMF selects a new I-UPF and send N4 session establishment
request to the new I-UPF, including UL A-UPF tunnel info.
8-10. The target I-SMF invokes Nsmf_PDUSession_Update Request (Tunnel info of
target I-UPF) toward the A-SMF. The A-SMF updates A-UPF with Tunnel info of
target I-UPF. In case of I-SMF insertion, and there was an existing I-UPF
controlled by A-SMF, A-SMF releases N4 session in this I-UPF.
11\. The target I-SMF responds the AMF with Nsmf_PDUSession_CreateSMContext
response.
Steps 12 - 14: for I-SMF Removal:
12\. The AMF invokes Nsmf_PDUSession_CreateSMContext Request to A-SMF.
13\. The A-SMF may select a target I-UPF.
If a target I-UPF is selected, the A-SMF establishes N4 session toward the
target I-UPF and updates the A-UPF with the target I-UPF tunnel info.
If a target I-UPF is not selected, the A-SMF updates the A-UPF to remove the
source I-UPF tunnel info.
14\. The A-SMF sends Nsmf_PDUSession_CreateSMContext Response to AMF.
Steps 15-17 are common for I-SMF removal and I-SMF change:
15-17. The AMF invokes Nsmf_PDUSession_ReleaseSMContext Request to source
I-SMF. The I-SMF releases sessions in source I-UPF.
Step 18 is common to all cases:
18\. Step 19-23 in registration procedure as in clause 4.2.2.2 of TS 23.502
[3] is performed.
#### 6.6.2.8 PDU Session Establishment
During PDU Session establishment, the AMF need determine whether I-SMF is
needed or not per clause 6.6.2.2.
In case the I-SMF is not need, the PDU Session establishment procedure is same
as the PDU Session establishment in clause 4.3.2.2.1 of TS 23.502 [3].
In case the I-SMF need be inserted, the PDU Session establishment procedure is
same as the PDU Session establishment in clause 4.3.2.2.2 of TS 23.502 [3],
replacing V-SMF/V-UPF with I-SMF/I-UPF respectively.
#### 6.6.2.9 Xn based handover with I-SMF change
Similar to registration procedure, the following cases are considered:
\- UE moves from source I-SMF service area to target I-SMF service area, i.e.
I-SMF reallocation; or
\- UE moves from A-SMF service area to target I-SMF service area, i.e. I-SMF
insertion; or
\- UE moves from source I-SMF service area to A-SMF service area, i.e. I-SMF
removal.
Figure 6.6.2.9-1: Xn based handover with I-SMF change
2\. The AMF determines and selects a target I-SMF as described in clause
6.6.2.3.
Steps 3 - 11 are for I-SMF insertion or I-SMF change:
3\. The AMF includes the source I-SMF ID in Nsmf_PDUSession_CreateSMContext
Request sent to target I-SMF.
If the UE moves from A-SMF service area to target I-SMF service area (i.e. the
I-SMF insertion), the source I-SMF ID is the A-SMF ID.
4-5. The target I-SMF retrieves SM context from the source I-SMF based on the
I-SMF ID received from AMF. The SM context includes UL A-UPF tunnel
information, QoS parameters for this PDU session, and the A-SMF ID for the PDU
session.
If the UE moves from the A-SMF service area to target I-SMF service area (i.e.
the I-SMF insertion), the source I-SMF is A-SMF.
6-7. The target I-SMF selects a new I-UPF and send N4 session establishment
request to the new I-UPF, including UL A-UPF tunnel info.
8-10. The target I-SMF invokes Nsmf_PDUSession_Update Request (CN Tunnel info
of target I-UPF) toward the A-SMF. The A-SMF updates A-UPF with Tunnel info of
target I-UPF.
The A-UPF sends the End Marker via the source I-UPF toward the source RAN.
Downlink packets are routed via the target I-UPF after this step.
In the case of I-SMF insertion, if there was an existing I-UPF controlled by
A-SMF, A-SMF starts a timer in order to release N4 session in this I-UPF.
11\. The target I-SMF responds the AMF with Nsmf_PDUSession_CreateSMContext
response.
Steps 12-14: for I-SMF Removal:
12\. The AMF invokes Nsmf_PDUSession_CreateSMContext Request to A-SMF.
13\. The A-SMF may select a target I-UPF.
If a target I-UPF is selected, the A-SMF establishes N4 session toward the
target I-UPF and updates the A-UPF with the target I-UPF tunnel info.
If a target I-UPF is not selected, the A-SMF updates the A-UPF with N3 tunnel
info.
The A-UPF sends the End Marker via the source I-UPF toward the source RAN.
Downlink packets are routed via the target I-UPF after this step.
14\. The A-SMF sends Nsmf_PDUSession_CreateSMContext Response to AMF.
Steps 15-17 are common to all cases:
15\. The AMF sends N2 path Switch Request Ack (CN tunnel info) to 5G RAN.
In case of I-SMF change or insertion, the CN tunnel info is the tunnel info of
target I-UPF controlled by target I-SMF.
In case of I-SMF removal, the CN tunnel info is the tunnel info of the target
I-UPF controlled by A-SMF or tunnel info of A-UPF.
16\. The target RAN request source RAN to release resources.
17\. The AMF invokes Nsmf_PDUSession_ReleaseSMContext Request to source I-SMF.
18\. The I-SMF releases sessions in source I-UPF.
In the case of I-SMF insertion, if a source I-UPF has been replaced by target
I-UPF controlled by target I-SMF, when the timer in step 8 has expired, the
A-SMF sends N4 session release to source I-UPF to release resources in source
I-UPF.
20\. Registration procedure is performed when it is needed.
### 6.6.3 Impact of the solution to existing entities
Impacts to AMF:
\- AMF supports I-SMF selection function during PDU session establishment and
during mobility.
\- Trigger the resource release toward source I-SMF during mobility.
Impacts to SMF:
\- SMF supports SM context retrieval from another SMF.
\- Support forwarding tunnel establishment between old I-SMF during service
request and N2 handover.
\- Support the function to determine whether forwarding tunnel is needed
during service request.
\- SMF registers its service area into NRF.
Impacts to NRF:
\- NRF is registered with SMF service area and is able to select SMF based on
SMF service area.
### 6.6.4 Evaluation of the solution
The whole solution can be evaluated as below:
Architecture:
The architecture is similar as the architecture for home routed roaming in
Rel‑15. So, the procedures can reuse existing home routed roaming procedures
with minimize change.
SMF selection:
Both I-SMF selection during PDU session establishment and during UE mobility
has been considered. The AMF take the role of the I-SMF selection. When and
based on which parameter for the I-SMF selection are also considered.
SM context retrieval:
The new I-SMF retrieves SM context from old I-SMF directly. Comparing to
Rel‑15 only a small enhancement to the existing NF is needed. And the SM
context retrieval is always between SMFs, the AMF does not need to be enhanced
for SM context retrieval. This is aligned with the SM and MM split principle
in 5GC.
Forwarding tunnel establishment:
The forwarding tunnel is established between target I-SMF and source I-SMF
directly. The benefits are that:
\- AMF is not involved in this SM related handling, hence, aligned with SM/MM
split principle.
## 6.7 Solution #7: UL-CL/BP Insertion
### 6.7.1 Overview
This solution addresses the following key issue:
\- How to insert an UPF supporting UL-CL/BP (IPv6 multi-homing) which is not
controlled by the SMF that controls the PSA of the PDU Session. The UL-CL/BP
to be inserted may be at the same or different regional / administrative
areas.
### 6.7.2 Description of the solution
#### 6.7.2.1 General
In this solution, the UPF that acts as UL-CL/BP is not controlled by A-SMF.
The UL-CL/BP may be inserted during or after the PDU session establishment,
e.g.:
\- When UE moves to a location that supports to connect a local DN via UL-
CL/BP; Or,
\- When UE starts an application that has local deployment via the UL-CL/BP.
#### 6.7.2.2 UL-CL/BP in a same region as A-SMF
##### 6.7.2.2.1 Overview: UL-CL/BP in the same region as A-SMF
When the UE is within the same administrative domain as the PSA of the PDU
Session, it is possible that some UPF are not controlled by the A-SMF, e.g.
the UPF belonged to the enterprise and exclusively controlled by the SMF also
belonged to the enterprise.
In that case when those UPF is to be selected, e.g. UL-CL/BP insertion, the
Local SMF need be inserted. The architecture is as in Figure 6.7.2.2.1-1:
Figure 6.7.2.2.1-1: UL-CL/BP insertion when UE is in the same region as A-SMF
The local SMF is a network function that controls the UPF deployed close to
the edge, e.g. the UPFs are deployed in an enterprise premise. The local SMF
has the following function:
\- UE IP address management in case of multi-homing (RA can be sent to UE via
local SMF or A-SMF).
\- Selection and control of UP function.
\- Configures traffic steering at UPF to route traffic to proper destination.
\- Charging data collection.
The SMF that controls the PSA of the PDU session (i.e. A-SMF) determines
whether a UL-CL/BP needs to be inserted and determines the DNAI the UL-CL/BP
connects to. The SMF selects the local SMF that controls the UL-CL/BP based on
DNAI and UE location information.
NOTE: It is assumed that Nxy interface is based on the N4 interface. Comparing
to the N4 interface the additional information elements that need be
transferred include, DNAI and UE location information for UL-CL support,
indication of UL-CL or Multi-homing and allocated IP address for BP support.
#### 6.7.2.2.2 Procedures
##### 6.7.2.2.2.1 Insertion of UL-CL/BP when it is in the same region as A-SMF
{#insertion-of-ul-clbp-when-it-is-in-the-same-region-as-a-smf .H6}
The procedure in figure 6.7.2.2.2.1-1 is to insert a UL-CL/BP for a PDU
session when the UE is located in the same region as the SMF that controls the
PSA. It is assumed that local PSA is collocated with UL-CL/BP. The solution
also applies to the case where the local PSA is not collocated with UL-CL/BP.
Figure 6.7.2.2.2.1-1: Procedure to support UL-CL/BP insertion when UE is in
the same region of A-SMF
1\. Before the procedure, a PDU session anchored in A-SMF has been
established. The A-SMF may receive some triggers to insert a UL-CL/BP for the
PDU session. The triggers the A-SMF receives includes:
\- The UE moves to a new location based on the area of interest subscription
(from AMF); or
\- Received trigger from PCF or from PSA that a new application has been
detected (from PCF or PSA).
2\. Based on the trigger, the SMF determines whether to insert UL-CL/BP. If
yes, the SMF determines the DNAI that the UL-CL/BP will connect to.
If the SMF cannot find a UPF that supports the DNAI by itself, the SMF selects
a Local SMF based on the DNAI and UE location information and local
configuration.
3\. The A-SMF sends Nxy message to the Local SMF to request it to insert UL-
CL/BP. The message includes UE location information, an indication of UL-CL or
Multi-homing, AN tunnel information, PSA tunnel information, PDR to be
installed in UL-CL/BP, and the DNAI.
4\. The Local SMF selects UL-CL/BP based on UE location, and optionally DNAI.
5\. A-SMF sends N4 Session establishment request to the UL-CL/BP, including AN
tunnel info, PSA tunnel info and PDR to be installed in UL-CL/BP.
6\. Local SMF send Nxy message Ack to A-SMF, including the local UPF tunnel
info (for both N3 and N9, service area of UL-CL/BP UPF).
The Local SMF return the service area of the UL-CL/BP UPF to the A-SMF. Based
on that information, the A-SMF can subscribe the notification from AMF when
the UE leave this service area.
In the case of Multi-homing, the Local SMF need allocate a local IPv6 prefix
for the PDU Session. The Local SMF also includes local IPv6 prefix in this
message, the A-SMF notifies the UE of the availability of the new IP prefix
via IPV6 Router Advertisement.
7\. A-SMF send N4 session update request to PSA, to update it with local UPF
tunnel info (N9).
8\. A-SMF send SM N2 request to AN via AMF to update AN with the local UPF
tunnel info (N3).
##### 6.7.2.2.2.2 Change of UL-CL/BP in the same region as A-SMF {#change-of-
ul-clbp-in-the-same-region-as-a-smf .H6}
Before this procedure, a UL-CL/BP (collocated with local PSA) controlled by
Local SMF has been inserted. The A-SMF has received information of \"no DNAI
change\" for the applications anchored at local PSA from PCF.
When the UE moves out of the service area of UL-CL/BP UPF, an I-UPF controlled
by A-SMF is inserted. The I-UPF works as UL-CL/BP which routes uplink packets
to PSA or local PSA accordingly.
Comparing to the clause 4.2.2.2.2 of TS 23.502 [3], the impact of the
introduction of local SMF is on the step 18. When the AMF notify the UE
location change to the A-SMF, the A-SMF update the original UL-CL/BP UPF via
local SMF to establish a tunnel between the new I-UPF and the original UL-
CL/BP UPF.
Figure 6.7.2.2.2.2-1 Change of UL-CL/BP in the same region as A-SMF
1\. When UE location changes, the AMF notify the UE location information to
A-SMF per Area of Interest subscription.
2\. The A-SMF determines that UE has moved out of the service area of the
local UL-CL/BP UPF, and the local anchor needs to be kept based on information
provided by AF before. The A-SMF selects an UPF as new UL-CL.
3a. If the new selected UPF is controlled by the A-SMF, the A-SMF sends N4
session establishment to the new I-UPF, which includes the UL CN tunnel info
of the PSA and Local PSA.
3b. If the new selected UPF is not controlled by the A-SMF, the AMF need
insert a local SMF. Steps 2 to 6 of figure 6.7.2.4.1-1 is executed.
4-6. The A-SMF updates the local PSA with the DL CN tunnel info of the new
I-UPF via local SMF.
7\. The A-SMF updates the PSA with the DL CN tunnel info of the new I-UPF.
8\. A-SMF send SM N2 request to 5G AN via AMF to update AN with the new I-UPF
tunnel info (N3), if UP is to be activated.
##### 6.7.2.2.2.3 Release of UL-CL/BP in the same region as A-SMF
Before this procedure, a UL-CL/BP (collocated with local PSA) controlled by
Local SMF has been inserted. The A-SMF has not received information from PCF
\"no DNAI change\" for the applications anchored at local PSA.
The UE moves out the service area of UL-CL/BP UPF, and the local SMF and local
UL-CL/PSA can be released.
Comparing to the clause 4.2.2.2.2 of TS 23.502 [3], the impact of the
introduction of local SMF is on the step 18. When the AMF notify the UE
location change to the A-SMF, the A-SMF release the original UL-CL/BP UPF via
local SMF.
Figure 6.7.2.2.2.3-1 Release of UL-CL/BP in the same region as A-SMF
1\. When UE location changes the AMF notify the UE location information to
A-SMF per Area of Interest subscription.
2\. The A-SMF determines that UE has moved out of the service area of the UL-
CL/BP UPF and the local anchor can be released. No UL-CL/BP UPF can be
selected at the UE new location.
3-5. The A-SMF releases UL-CL and local PSA via Local SMF.
6\. The A-SMF updates the PSA with DL tunnel information of 5G AN.
7\. A-SMF send SM N2 request to 5G AN via AMF to update AN with the new I-UPF
tunnel info (N3) if UP is to be activated.
#### 6.7.2.3 UL-CL/BP in a different region than A-SMF
##### 6.7.2.3.1 UL-CL/BP controlled by I-SMF
##### 6.7.2.3.1.1 overview: UL-CL/BP controlled by I-SMF {#overview-ul-clbp-
controlled-by-i-smf .H6}
For this scenario, the UPF that acts as UL-CL/BP is controlled by I-SMF. The
I-SMF in this solution corresponds to the I-SMF shown in the architectures
described in solutions 6. The UL-CL/BP may be inserted during or after the PDU
session establishment, e.g.:
\- When UE moves to a location that supports to connect a local DN via UL-
CL/BP; Or,
\- When UE starts an application that has local deployment via the UL-CL/BP.
Before the UL-CL/BP insertion, the I-UPF controlled by I-SMF is already
inserted into the PDU Session path. After the UL-CL/BP insertion, the
architecture is as in figure 6.7.2.3.1.1-1.
Figure 6.7.2.3.1.1-1: UL-CL/BP insertion when UL-CL/BP is controlled by I-SMF
In this architecture, the UL-CL/BP and local PSA are controlled by I-SMF. The
I-SMF determines whether the UL-CL/BP needs to be inserted and determines the
DNAI the UL-CL/BP connects to. The I-SMF selects the UL-CL/BP based on DNAI
and UE location information.
NOTE: Nxx interface is assumed to be similar as the Nxz interface defined at
solution #6.
##### 6.7.2.3.1.2 Procedures for Insertion of UL-CL/BP controlled by I-SMF
{#procedures-for-insertion-of-ul-clbp-controlled-by-i-smf .H6}
The procedure in figure 6.7.2.3.2.1-1 is to insert a UL-CL/BP for a PDU
session when the UE is located in service area of I-SMF and UL-CL/BP can be
controlled by the I-SMF.
Figure 6.7.2.3.1.2-1: Procedure to support UL-CL/BP insertion when UE is in
the region of A-SMF
1\. Before the procedure, a PDU session anchored in A-SMF has been
established. An I-UPF controlled by I-SMF has been inserted.
2\. The PCC rule related to AF request is provisioned to I-SMF. Two
alternatives can be used to provision PCC rules to I-SMF as described in
clause 6.13 or 6.15. . Based on Multi-homed IPv6 PDU Session capability in UE
5GSM Core Network Capability, the A-SMF determines which mode is supported for
PDU Session with multiple PDU Session Anchors, i.e. UL Classifier or Multi-
homed PDU Session or both, A-SMF sends the indication on the mode supported to
the I-SMF via Nxx interface.
3\. From PCC rule the I-SMF may determine to insert a UL-CL/BP for the PDU
session based on the received triggers. The triggers include:
> \- The UE moves to a new location based on the area of interest subscription
> (from AMF); or
>
> \- Received trigger from PCF or from I-UPF that a new application has been
> detected (from PCF or I-UPF).
The I-SMF determines whether UL-CL or BP is used to support this local PDU
Session Anchor, and generate rules accordingly.
If UL-CL/BP is to be inserted, the I-SMF determines the DNAI that the UL-CL/BP
will connect to.
The I-SMF selects a UL-CL/BP based on the DNAI and UE location information,
and selects local PSA based on DNAI.
4-5. The I-SMF sends N4 Session Establishment request to UL-CL/BP and local
PSA, to establish the PDU session.
6-8. I-SMF invokes Nsmf_PDUSession_Update to send tunnel info of UL-CL/BP to
A-SMF, and the A-SMF updates the corresponding N4 session in A-UPF.
If the I-SMF does not have direct interface with PCF, the I-SMF provides
information related to UL-CL/BP to A-SMF, e.g. the DNAI selected, the local IP
address in case of BP, etc. the A-SMF may provide such information to PCF.
If the I-SMF has direct interface with PCF, this information can be provided
to PCF directly, no need via A-SMF.
9\. I-SMF send SM N2 request to AN via AMF to update AN with the UL-CL/BP
tunnel info (N3).
10\. I-SMF releases PDU session in I-UPF.
##### 6.7.2.3.2 UL-CL/BP controlled by local SMF in I-SMF service area
##### 6.7.2.3.2.1 Overview: UL-CL/BP controlled by local SMF in I-SMF service
area {#overview-ul-clbp-controlled-by-local-smf-in-i-smf-service-area .H6}
For this scenario, the UE is in service area of I-SMF, but the UPF that acts
as UL-CL/BP is controlled by a local SMF within the service area of I-SMF. The
I-SMF in this solution corresponds to the I-SMF shown in the architectures
described in solutions 6.
The UL-CL/BP may be inserted during or after the PDU session establishment,
e.g.:
\- When UE moves to a location that supports to connect a local DN via UL-
CL/BP; Or,
\- When UE starts an application that has local deployment via the UL-CL/BP.
Before the UL-CL/BP insertion, the I-UPF controlled by I-SMF is already
inserted into the PDU Session path. After the UL-CL/BP insertion, the
architecture is as in figure 6.7.2.3.2.1-1
Figure 6.7.2.3.2.1-1: UL-CL/BP is controlled by local SMF within I-SMF service
area
In this architecture, the UL-CL/BP and local PSA are controlled by local SMF
that is located within I-SMF service area. The I-SMF determines whether the
UL-CL/BP needs to be inserted and determines the DNAI the UL-CL/BP connects
to. If the SMF cannot find a UPF that supports the DNAI by itself, the I-SMF
selects the local SMF based on DNAI and UE location information and local
configuration. Comparing to the N4 interface the additional information
element need be transferred includes, DNAI and UE location information for UL-
CL support, indication of UL-CL or Multi-homing and allocated IP address for
BP support.
NOTE: It is assumed that Nxy interface is based on the N4 interface.
##### 6.7.2.3.2.2 Procedures: Insertion of UL-CL/BP controlled by local SMF
within I-SMF service area {#procedures-insertion-of-ul-clbp-controlled-by-
local-smf-within-i-smf-service-area .H6}
Figure 6.7.2.3.2.2-1: UL-CL/BP insertion when UL-CL/BP is controlled by local
SMF within I-SMF service area
1\. Before the procedure, a PDU session anchored in A-SMF has been
established. An I-UPF controlled by I-SMF has been inserted.
The PCC rule related to AF request is provisioned to I-SMF. Two alternatives
can be used to provision PCC rules to I-SMF as described in clause 6.13 or
clause 6.15. Based on Multi-homed IPv6 PDU Session capability in UE 5GSM Core
Network Capability, the A-SMF determines which mode is supported for PDU
Session with multiple PDU Session Anchors, i.e. UL Classifier or Multi-homed
PDU Session or both, A-SMF sends indication on the mode supported to the I-SMF
via Nxx interface.
3\. Based on the received triggers, the I-SMF keep track the UE and may
determine to insert a UL-CL/BP for the PDU session. The triggers include:
− The UE moves to a new location based on the area of interest subscription
(from AMF); or
− Received trigger from PCF or from I-UPF that a new application has been
detected (from PCF or I-UPF).
The I-SMF determines whether UL-CL or BP is used to support this local PDU
Session Anchor, and generate rules accordingly.
If UL-CL/BP is to be inserted, the I-SMF determines the DNAI that the UL-CL/BP
will connect to.
If the I-SMF cannot find a UPF that supports the DNAI by itself, the I-SMF
selects a Local SMF based on the DNAI and UE location information.
4\. The I-SMF sends Nxy message to the Local SMF to request it to insert UL-
CL/BP. The message includes UE location information, an indication of UL-CL or
Multi-homing, AN tunnel information, PSA tunnel information, PDR to be
installed in UL-CL/BP, and the DNAI.
5\. The Local SMF selects UL-CL/BP and a local PSA based on UE location, and
optionally DNAI.
6\. Local SMF sends N4 Session establishment request to the UL-CL/BP and local
PSA, including AN tunnel info, PSA tunnel info and PDR to be installed in UL-
CL/BP.
NOTE 1: The Policy related information, e.g. PDR, is transparently forwarded
by the local SMF to local UPF.
7\. Local SMF sends Nxy message Ack to I-SMF, including the local UPF tunnel
info (for both N3 and N9, service area of UL-CL/BP UPF).
The Local SMF return the service area of the UL-CL/BP UPF to the I-SMF. Based
on that information, the I-SMF can subscribe the notification from AMF when
the UE leave this service area.
In case of Multi-homing, the Local SMF need allocate a local IPv6 prefix for
the PDU Session. The Local SMF also includes local IPv6 prefix in this
message.
8\. The I-SMF sends Nsmf_PDUSession_Update Request to A-SMF, providing tunnel
info of UL-CL. If the local IP address is allocated, the local IP address is
included in this message.
9\. The A-SMF sends N4 session update to PSA to update the downlink tunnel
info (N9) toward the UL-CL.
10\. The A-SMF sends Nsmf_PDUSession_Update Response to I-SMF.
11\. A-SMF send SM N2 request to AN via AMF to update AN with the local UPF
tunnel info (N3).
12\. The I-SMF sends N4 session release to I-UPF, and releases resources in
I-UPF.
### 6.7.3 Impact of the solution to existing entities
N4 is enhanced to support transferring extra information, e.g. DNAI and UE
location information for UL-CL support, indication of UL-CL or Multi-homing
and allocated IP address for BP support.
SMF is enhanced to differentiate local SMF from UPF, hence to transfer extra
information to local SMF.
A new local SMF is introduced to control the UL-CL/BP.
No impacts to other existing network functions are identified.
### 6.7.4 Evaluation of the solution
This solution supports insert of UL-CL/BP that is not controlled by A-SMF, for
offloading traffic to local data network. The UL-CL/BP is controlled by I-SMF
or by a local SMF dedicated in third party data network.
When the UL-CL/BP is controlled by I-SMF, the operator can offload the traffic
close to the UE location.
When the UL-CL/BP is controlled by the local SMF, it supports hiding the
complexity and topology of the deployed UPF in an enterprise from the
operator. It has minor impacts on N4 interface and on SMF and no impact on
other NFs/interfaces of the existing system.
## 6.8 Solution #8: UE IP address allocation by the UPF
### 6.8.1 Overview
This solution addresses KI #2.
This solution relies on the UPF allocating the IPv4 address / IPV6 prefix to
be used by a PDU Session over N6 (both referred to as \"IP address of the PDU
Session\" in the solution description).
This solution allows an UPF to serve a highly varying number of SMF without
having to partition the N6 addressing space targeting this UPF between these
SMF(s) (the N6 addressing space targeting this UPF refers to the range(s) of
IP address to be allocated for PDU Sessions).
Furthermore, this solution aims at reducing the configuration effort when
deploying a new UPF as only this UPF needs to be configured with its own IP
address range(s) on N6; there may be multiple IP address range(s) on N6 when
the UPF supports multiple network instances (corresponding to multiple
DNN(s)).
Whether this solution applies or whether Rel15 mechanisms are used to allocate
UE IP address(es) for a PDU Session is transparent to other entities than SMF
and UPF (and hence transparent to the UE).
### 6.8.2 Description of the solution
Upon N4 Association Setup Procedure (TS 23.502 [3], clause 4.4.3.1) the SMF
and UPF negotiate the support of this capability/solution. The rest of the
description assumes both SMF and UPF support it.
The SMF, when needing an IP address for a PDU Session, creates a PDR and
provides in the corresponding PDI (refer to TS 29.244 [5]):
\- A source interface referring to the N6 interface.
\- A Network Instance. The Network Instance is determined as in Rel15 with the
potential modification that the SMF may take into account the IP index
received from the PCF to determine the Network Instance.
\- No UE IP address but an indication that an IP address is to be allocated
and the IP version (V4 / V6) for this IP address / Prefix to be allocated.
In its answer the UPF provides the IP address it has allocated to the PDU
Session.
At PDU Session establishment (TS 23.502 [3] Figure 4.3.2.2.1-1), N4 session
creation takes place before Step 9 (SMF initiated SM Policy Association
Creation/Modification procedure).
The removal of the PDI or of the PFCP session induces the release of the
corresponding N6 IP address(es).
The SMF remains responsible of sending the allocated UE IP address in CP
signalling to:
\- The UE via NAS.
\- The PCF as part of SMF initiated SM Policy Association Modification.
\- The CHF, LI, etc.
The UPF stores the relationship between allocated UE IP addresses and N4
Sessions. When a N4 Session is released the corresponding UE IP addresses are
automatically considered by the UPF as released.
In-band UE IP address transfer to the UE (SLAAC, DHCPV4, DHCPV6) remains under
responsibility of the SMF (using existing UPF configuration over N4 of UPF
traffic forwarding between N3/N9 and the SMF); The SMF is responsible of the
DHCP lease timer; N4 specifications need to evolve in order to support SMF
request to release UE IP address to support following case: the lease timer
expires and this is not a condition to release the PDU Session (as for example
other IP addresses are still allocated on the PDU Session as for example for
an IPv4v6 PDU Session);
### 6.8.3 Impacts on existing Functions
\- OAM: no more need to co-ordinate IP address pools between SMF and UPF.
\- SMF and UPF negotiate the support and the need of this feature over N4.
\- UPF: needs to allocate IP address and maintain the list allocated IP
address.
\- N4 specifications need to evolve in order to support SMF request to
allocate/release UE IP address.
## 6.9 Solution #9: One-time IP Address reservation for SMF by UPF
### 6.9.1 General
This is a solution for key issue 2.
Instead of the SMF possessing the IP Address allocation from either, a number
of pre-configured pools or external central allocation entity (DHCP or
RADIUS), the SMF would instead request the UPF to reserve IP addresses on its
behalf, and from these reserved IP addresses the SMF allocates an IP address
to a PDU. The SMF would then request additional IP addresses when it needed to
allocate an IP address to an PDU and it has no IP\'s reserved for a given UPF.
The number of IP addresses reserved would need to be flexible allowing many
addresses to be requested (for frequent services) at a time, or as few as one
(in which case a request would need to proceed any allocation).
These IP addresses are used only once per reservation, once allocated by the
SMF they return (once the session is released) to the un-reserved state and
can be used in subsequent reservations (i.e. the SMF receives a one-time list
of IP addresses).
Different services, dependent on local configuration, could utilize service
specific reserved IP addresses, this would require the UPF to support multiple
IP addresses ranges for reservation.
The IP addresses allocated to the UPF can be from a number of implementation
specific methods including for example:
\- Static pre-configuration.
\- Dynamic network management controls for the PLMN (or slice administrator of
the UPF).
\- Network management level interactions with the DN administration system.
\- IP Transport layer methods (DHCP, Router Advertisement, etc.).
The UPF could also utilize multiple different methods for different services,
although only one method should be used per IP address range.
### 6.9.2 Architecture Aspects
#### 6.9.2.1 UPF
The UPF may support reservation of IP addresses.
If the UPF supports IP address reservation (and is configured to use the
function), the UPF will manage the range (or ranges) of user IP addresses that
route via the UPF and are routed to the UPF by the surrounding IP networks.
When requested by a SMF to reserve a number of IP addresses, the UPF will
respond with a list of the IP addresses reserved (or range of IP addresses
reserved) and manage the reservation status of its user IP addresses
accordingly. The UPF manages the IP reservations status toward each SMF
instance, and when it receives a PDU establishment request ensures that the IP
address assigned is one that has been reserved by the requesting SMF.
Once a UPF has allocated (based on SMF instruction) a user IP address to a PDU
session, and that session has subsequently released, the IP address is no
longer reserved, and could subsequently be reserved again by the same SMF or a
different SMF.
#### 6.9.2.2 SMF
The SPF may support reservation of IP addresses.
If the SMF supports IP address reservation (and is configured to use the
function), the SMF will determine to request IP addresses reservation prior to
IP allocation to a specific PDU; the trigger to request reservation could be
determined by some algorithm (e.g. less than 10% remaining), or in direct
response to a PDU setup when the SMF has insufficient IP reservations. The SMF
will send a reservation request to the UPF to request 1 or more user IP
addresses. Once the SMF receives the list of IP addresses (or IP address
ranges) reserved for it, it can manage these resources, and use them to when
allocating IP addresses when activating PDU sessions towards UE\'s.
Once a SMF has allocated a user IP address to a PDU session, and that session
is subsequently released, the IP address is no longer reserved, and released
back to the UPF; the SMF may however receive the same IP address in response
to a subsequent reservation request.
Based on local configuration (e.g. timer) the SMF may determine that it no
longer needs a previously reserved IP address range, the SMF can therefore use
the procedure in 6.9.2.4 to return the unused reserved IP addresses to the
UPF. Additionally, due to external events, the IP address ranges supported by
a UPF may change (e.g. network management updates) the SMF may receive a
notification from the UPF to revoke the IP Address Reservations for a
particular IP Address Range; in this case the SMF should initiate the De-
Reservation procedure, and also initiate the network initiated PDU session
release procedure for each IP address allocated to a PDU session in the
affected range. The SMF may release a list of individual IP addresses, or may
release an IP address range.
#### 6.9.2.3 User IP Reservation Procedure
Figure 6.9.2.3-1: User IP Reservation Procedure
1\. SMF determines that it requires to reserve more IP addresses for a
specific UPF.
2\. The SMF requests the UPF to reserve 1 or more IP addresses for allocation
by the SMF.
3\. UPF reserves requested IP addresses for the requesting SMF and responds to
the SMF indicating the reserved IP addresses or IP address ranges.
NOTE: Steps 2&3 may occur within the PDU establishment procedure as defined in
TS 23.502 [3], clause 4.3.2.
#### 6.9.2.4 IP De-Reservation Procedure
Figure 6.9.2.4-1: IP De-Reservation Procedure
1a. [Conditional] The SMF determines that the previously reserved range is no
longer required.
1b. [Conditional] The UPF discovers that an external event has affected the IP
address ranges allocated to the UPF and sends a notification to the SMF that
the IP Reservation is no longer valid. This shall trigger the SMF to release
the PDU sessions of any IP address allocated from this range with a temporary
cause code (this will allow the UE to re-establish the PDU sessions if
needed).
2 The SMF sends the IP address release message to the UPF specifying the list
of IP addresses, or the IP address range, it is releasing.
3\. The UPF acknowledges that the IP addresses are no longer allocated to the
SMF.
### 6.9.3 Impacts on existing nodes and functions
New procedure for N4 interface.
Impact to SMF:
\- SMF needs to support IP address reservation and release (and only use it
when configured and only with UPF\'s that support the functionality)
\- SMF may need to support reservation multiple IP address ranges (different
IP addresses for different PDU types or service type).
\- SMF needs to be configured to know how many IP addresses to request for a
given reservation group.
\- SMF needs to support an algorithm that determines when to reserve more IP
addresses for a specific UPF. If SMF has multiple reservation groups, then the
algorithm may be different per group. (these algorithms are implementation
specific)
Impacts to UPF:
\- UPF needs to support IP address reservation and indicate support to SMF.
\- UPF needs to manage the pool of IP addresses that route to it.
\- UPF has to keep track of which IP addresses have been reserved and which
are free for allocation. This may be further complicated if multiple IP
address ranges are supported by a single UPF.
\- UPF needs to manage the exhaustion of IP addresses when too many are
requested by SMFs (e.g. ask for additional addresses from the IP network, or
reject SMF requests)
### 6.9.4 Solution Evaluation
The \"pros\" and \"cons\" of this solution are described below.
Pros:
\- Enables efficient usage of small IP addresses ranges per UPF across many
SMF.
\- Number of IP addresses managed by each UPF may be asymmetrical (i.e.
different numbers of IP addresses for each UPF to accommodate different
subscriber densities and different mobility patterns).
\- Low overhead for services with infrequent PDU session establishment
patterns.
\- Enables direct (user plane) interaction between DN and UPF for IP address
management and routing.
\- Supports single and multiple IP address reservations by SMF.
\- Supports mixed deployments of UPF\'s and SMF\'s with release 15 IP address
allocation and UPF reservation methods.
\- For small SMF deployments, additional IP address ranges can be added to a
SMF dynamically as a service grows or as users move, accommodating independent
UPF and SMF scale-in/out and scale-up/down.
Cons:
\- Complex IP address management at UPF for large or multiple IP address
ranges.
\- Increased UPF complexity to manage leftover IP address reservations in
otherwise clear IP address ranges (e.g. 1 IP left reserved in the middle of a
range of 1000 IP addresses when 999 have returned)
\- High signalling overhead for frequently used services or services that
frequently establish and tear down PDU sessions.
## 6.10 Solution #10: IP address assignment by the SMF via IP Section
allocation
### 6.10.1 Overview
This solution addresses key issue #2.
### 6.10.2 Description of the solution
When a UPF is deployed the associated UE IP addresses space and the
corresponding DNN is registered to the NRF.
Based on the operator\'s configuration, the UPF may provide an initial IP
section, i.e. IP address ranges, which contains small amounts of the UE IP
addresses and may be more than one IP subnet, to the SMF during the node level
N4 association information exchange when UPF is selected by the SMF as PSA. If
the UPF selected by the SMF is the PSA of a PDU session, the SMF allocates IP
address from the initial IP Section provided by UPF to the UE.
Figure 6.10.2-1: Initial IP Section allocated to SMF
1\. When the UPF is deployed, the SMF may send N4 association setup request to
UPF.
2\. The UPF send a N4 association setup response to SMF, in which, an initial
IP Section together with its associated DNN are provided to the SMF in the N4
association setup response message. The SMF stores the initial IP Section and
the associated DNN.
Based on the operator\'s configuration the alternative means for the SMF
obtains the initial UE IP Section for one DNN of one UPF via the NRF, which is
defined in TS 23.502 [3], clause 4.17.6. When the UPF is registered to the
NRF, the UPF provides the UE IP Pool and DNN to the NRF. The SMF invokes the
Nnrf_NFDiscovery _NFStatusSubscribe service of the NRF, the NRF provide the
initial IP Section and DNN to the SMF via Nnrf_NFManagement_NFStatusNotify.
After the initial IP Section got from UPF, the SMF can allocate the IP address
to the UE from that allocated IP section. When the (initial) IP Section of the
UPF for one DNN is close to be exhausted, the SMF request a new section of IP
addresses of the UPF from the NRF.
Figure 6.10.2-2: New IP Section allocated to SMF
1\. The UE sends a PDU session establishment request to SMF. SMF selects the
UPF and allocate UE IP address from the corresponding IP Section of the
selected UPF.
2\. (optional)If the IP Section of the selected UPF is close to be exhausted,
the SMF may request a new amount of IP addresses from the NRF. This step can
be executed in parallel with the PDU Session Establishment procedure.
2a: (optional) The SMF provide the UPF ID and the DNN to the NRF.
2b: (optional) The NRF sends a new allocated IP Section corresponding to the
indicated DNN and the UPF to the SMF. The new allocated IP Section could be IP
address ranges or a list of IP addresses.
NOTE: The new IP Section is used by the SMF for the IP address assignment to
the subsequent UE.
3-4. The SMF sends N4 session establishment request to the UPF with the
allocated UE IP address.
5\. After the PDU session has been established, the SMF sends the PDU session
establishment response to UE.
When a PDU session is released, the SMF may initiate IP Section release. When
the IP address is released successfully, the NRF could reallocate this IP
address to other SMF when receiving the IP Section request message.
Figure 6.10.2-3: IP Section release from SMF
1\. The UE sends PDU Session release request to SMF.
2- 4. The PDU Session is released.
5\. If the allocated IP address from NRF is IP addresses ranges and the UE is
the last one which occupy the IP address of the IP address range, the SMF may
initiate IP Section release.
If the allocated IP address from NRF is a list of IP addresses, the SMF may
initiates IP Section release including the released IP address. The SMF may
aggregate several IP Section release message into one message sent to NRF.
The SMF sends IP Section release request to NRF which contains UPF ID, DNN,
and IP Section or IP address(s) to be released.
6\. The NRF responds to the SMF.
### 6.10.3 The impact of the solution
SMF:
\- (optional)The SMF got the initial IP Section from UPF or NRF.
\- The SMF request a new IP Section to the NRF when the IP resource is
insufficient.
\- When the last UE which occupy the IP address of the IP Section initiates
PDU session delete procedure or when one PDU Session is released, the SMF
request to NRF to recycle this IP section.
NRF:
\- The NRF manages the whole UE\'s IP address pool for one DNN of the UPF and
divides the UE\'s IP address pool into small IP section.
\- When receiving the IP Section request from SMF, the NRF assign one IP
Section or a list of IP address to the SMF.
\- When receiving the IP Section release request from SMF, the NRF recycle
this IP section.
\- (optional)The NRF provides the initial IP Section for one DNN to the SMF
during the SMF Provisioning of available UPFs when using the NRF procedure if
NRF based mechanism is adopted.
UPF:
\- (optional)The UPF provides the initial IP Section for one DNN to the SMF
during the N4 association setup procedure when SMF select UPF directly if UPF
based mechanism is adopted.
### 6.10.4 Evaluation of the solution
The \"pros\" and \"cons\" of this solution are described below.
Pros:
\- Efficient usage of IP resource based on the dynamic service requirements,
which means the IP address applied by the SMF can be done according to the
requirement of service, i.e. the allocated IP address range can be small or
large. For example, if the SMF find the IP address ranged allocated is not
enough, the SMF can do the IP clause request again until it fulfil the service
requirement.
\- Avoid the large IP range of the UPF statically binding with one SMF
instance, which support the independent UPF and SMF scale-in/out and scale-
up/down.
\- Low signalling overhead due to the IP clause reversion is supported by the
SMF. The SMF act as the second layer IP address management, it can avoid that
each individual IP address allocation need done via the NRF. This can avoid
the unnecessary signalling interaction between the SMF and NRF.
\- The IP address resource is managed by the control plane function, which is
beneficial to the UPF restoration (i.e. the IP address map on the UPF could be
restored quickly and accurately by the SMF).
Cons:
\- If the IP clause is allocated per a list of IP address, the IP address
managed by NRF is the disperse IP address of the whole IP resource.
\- Risk for IP address pool fragmentation and inefficient IP address
management when a pool of IP addresses in NRF is subdivided into smaller pools
provided to SMFs. So, the IP address pool need be arranged in a suitable size.
\- In the case the IP addresses are released by IP address range, this IP
address range can only be released until all the UE within this IP address
range release the associated PDU Session. However, since the IP address range
size can be adapted to the network, the drawback is limited.
\- Two types of NFs have to handle IP address pool management; SMF and NRF.
\- In the case of SMF failure NRF need to ensure there is no resource leakage.
## 6.11 Solution #11: IP address assignment by the SMF via external Node
coordination
### 6.11.1 Overview
This solution addresses key issue #2.
### 6.11.2 Description of the solution
The IP address of the UE is either configured in NRF or DHCP server. The SMF
request the NRF or DHCP server to allocate the IP address for a PDU session.
Figure 6.10.2.3-1: IP address allocation via the coordination external NF
1\. When the UPF is selected, the UPF or the NRF notifies SMF with IP pool ID
of the UPF and its corresponding DNN, etc. The IP pool ID is used to uniquely
identify the IP pool of the UPF within one PLMN, e.g. first IP address in the
IP pool or unique Identifier. One UPF may be linked with one or more IP
Pool(s), each of which is associated with a DNN.
2\. The NRF or DHCP Server is configured with the IP pool and its
corresponding Pool ID. In case of NRF, the configuration could be done via OAM
or the UPF registers its IP pool(s) to the NRF. In case of DHCP, the
configuration is done via OAM.
3\. The SMF receives PDU Session Establishment Request (DNN).
4\. SMF selects the UPF based on DNN, UE location info, etc. The SMF
determines the IP Pool ID based on the UPF ID, the DNN of the PDU Session, and
the association information received in step 1.
5\. SMF sends request to NRF or DHCP server for IP allocation, including the
IP Pool ID.
In the case of NRF, the SMF can invoke a service provided by NRF.
In the case of DHCP, SMF sends DHCP message including the IP Pool ID to DHCP
Server. The IP address which can help the DHCP server identify the IP pool is
carried in GIADDR of DHCP message. No change to DHCP protocol is needed.
6\. NRF or DHCP Server returns IP address to SMF.
#### 6.11.3 The impact of the solution
NRF/DHCP Server:
\- The NRF/DHCP server manages the whole UE\'s IP address pool for one DNN of
the UPF.
SMF:
\- SMF provides the IP Pool ID to the NRF/DHCP server when request an IP
address to the UE.
## 6.12 Solution #12: IP address assignment by the SMF via DN-AAA or DHCP
Servers
### 6.12.1 Overview
This solution addresses key issue #2.
### 6.12.2 Description of the solution
The UE IP address pool of each UPF is either configured in DN-AAA or DHCP
server. The SMF request the DN-AAA or DHCP server to allocate the IP address
for a PDU session.
Figure 6.12.2-1: IP address allocation via the coordination external NF
1a-1b. The SMF is configured with information about available UPFs, including
the IP pool ID of the UPF and its corresponding DNN, etc. The IP pool ID is
used to uniquely identify the IP pool of the UPF within one PLMN, e.g. first
IP address in the IP pool or unique Identifier. One UPF may be linked with one
or more IP Pool(s), each of which is associated with a DNN. This step may be
done from OAM. In case NRF is used to provision UPFs, this step is done from
the NRF,
1c. The DN-AAA Server or DHCP Server is configured with the IP pool(s) and
their corresponding Pool ID. This configuration is done via OAM and out the
scope of this TR.
2\. The SMF receives PDU Session Establishment Request (DNN).
3\. SMF selects the UPF based on DNN, UE location info, etc. The SMF
determines the IP Pool ID based on the UPF ID, the DNN of the PDU Session, and
the association information received in step 1.
4\. SMF sends request to DN-AAA server or DHCP server for IP allocation,
including the IP Pool ID.
In the case of DHCP, SMF sends DHCP message including the IP Pool ID to DHCP
Server. The IP address which can help the DHCP server identify the IP pool is
carried in GIADDR of DHCP message. No change to DHCP protocol is needed.
In the case of DN-AAA, SMF sends AAA message including the IP Pool ID to DN-
AAA Server.
5\. DN-AAA Server or DHCP Server returns the UE IP address to SMF.
### 6.12.3 The impact of the solution
DN-AAA/DHCP Server:
\- The DN-AAA/DHCP server manages the whole UE\'s IP address pool for one DNN
of the UPF. This is supported in Rel-15, but in addition to Rel-15 the DN-
AAA/DHCP Server needs to handle the IP Pool ID.
SMF:
\- SMF provides the IP Pool ID to the DN-AAA/DHCP server when request an IP
address to the UE.
### 6.12.4 Evaluation
The \"pros\" and \"cons\" of this solution are described below.
Pros:
\- Aligned with Rel-15 solutions with only minimal additions compared to
Rel-15 (use of Pool ID)
NOTE: It is up to stage 3 to determine whether existing AAA and/or DHCP
protocol information elements exist that can be used for this.
\- No need for new functionality in UPF or NRF.
\- Allows a central repository and management of UE IP addresses per UPF.
\- No risk of IP pool fragmentation since the full IP pool per UPF can be
managed in one place.
Cons:
\- Operator has to deploy DHCP or AAA server.
\- Each IP address allocation by SMF requires an interaction with DHCP/AAA
server.
## 6.13 Solution #13: Handling AF influence on traffic routing -- PCF aware of
I-SMF insertion
### 6.13.1 Overview
This solution is to address the Key Issue 5 and based on the architecture
proposed in solution#1 and solution#7.
### 6.13.2 Description of the solution
As described in solution#1 and solution#7, there are deployments where the SMF
(A-SMF) that controls the PDU Session Anchor cannot control all UPFs serving
the PDU Session. When a I-UPF is inserted and the A-SMF cannot control it, a
new I-SMF is inserted to control the I-UPF.
As described in the solution#1, #2 or solution#7, when a I-SMF is inserted for
the PDU session in the UE\'s new location, the A-SMF provides the details of
the PCF associated to the PDU session to the I-SMF. Upon receiving the PCF
details, the I-SMF creates for the PDU Session an association for SM policies
with the PCF. providing the PDU session ID, an indication it is an I-SMF, its
capabilities e.g. its service area, and supported DNAI(s). The PCF maintains
the I-SMF and A-SMF details of the PDU session i.e. when an I-SMF is used the
PCF manages 2 associations for SM policies for that PDU Session. When a PCF
received AF request for traffic routing, the PCF will determine whether the
PCC rules are to be handled by the A-SMF or I-SMF, depending on the service
area reported by the A-SMF or the I-SMF, alternately the A-SMF or the I-SMF
may report SMF ID and then the mapping SMF ID to service area is configured in
the PCF. Upon PCF determination, the PCF forwards the respective PCC rules to
the respective SMF (e.g. directly to the I-SMF for those PCC Rules that
request traffic steering to a DNAI in the service area of the I-SMF) instead
of routing all rules via A-SMF as in solution#15. Note that those PCC Rules
that contains no traffic steering information or contain traffic steering
information to a DNAI in the service area of the A-SMF are provided to the
A-SMF for enforcement.
NOTE: DNAIs served by an I-SMF is not overlapped with an A-SMF and each DNAI
is identified by a unique value in the PLMN.
For usage reporting to the CHF,
\- Alt#1 (no CHF interface for I-SMF): the I-SMF forwards the network resource
usage of a CK to the A-SMF, where A-SMF aggregates with the reporting for the
same CK from the UPF it directly controls and send the aggregated usage
reporting information to the charging function CHF. This is solution #15,
where there is no interface from SMF to PCF or CHF.
\- Alt#2 (I-SMF has a CHF interface): I-SMF gets the quota information from
the charging system CHF and the I-SMF sends resource usage directly for a CK
to the CHF, and the co-ordination will take place in the charging system. This
alternative assumes that when an I-SMF is used, the CHF manages 2 associations
for charging of that PDU Session; The association between the CHF and the
I-SMF may be deleted without the PDU Session to be deleted.
For usage reporting to the PCF the PCF provisions the usage threshold for a MK
included in a PCC rule at the time the PCC Rule is provisioned to the SMF. If
the PCC Rule is provisioned to the I-SMF, for traffic steering, then the PCF
provides a usage threshold as well to the I-SMF. In addition, for the MK for
the PDU session the PCF provisions the MK for the PDU session to the A-SMF and
then in order to determine the accumulate usage for the PDU session the PCF
aggregates the usage reported for the MK for the PDU session and the MK for
the PCC Rules that are steered to a DNAI in the I-SMF.
Figure 6.13.1: I-SMF having interface with the PCF for handling directly AF
PCC rules.
NOTE: Figure 6.13.1, shows two SM Policy Associations from PCF, the SM Policy
association with the I-SMF is updated with PCC Rules for those services that
require traffic steering to a DNAI under the service area of the I-SMF,
otherwise, the PCF only updates the SM Policy Association to the A-SMF as
described in TS 23.503 [4].
### 6.13.3 Procedures
#### 6.13.3.1 AF policy processing - PCF aware of I-SMF insertion
Below changes are required for both:
\- Up on I-SMF selection and insert, I-SMF creates an association for SM
policies with the PCF (V-PCF in local breakout) and provides the PDU session
ID, an indication it is an I-SMF, its capabilities e.g. service area, and
supported DNAI(s).
\- PCF forwards AF polices to the I-SMF after receiving a request from the AF
for traffic routing e.g. to specific DNAI which is served by the I-SMF. In
local breakout the V-PCF forwards the AF policies in the service area of the
I-SMF to the I-SMF. The (V-)PCF maintains two SM Policy associations for a PDU
session.
Figure 6.13.3.1: AF policy processing at the I-SMF
Steps 1: Insertion of I-SMF and establishing a Nxx interface between the I-SMF
and A-SMF will the same as solution #1. Only difference in the Nxx
establishment, the A-SMF provides PCF address of the PDU session.
NOTE 2: This PCF address cannot be provided by AMF as the AMF is unaware of
the PCF selected for the PDU Session.
Steps 2: I-SMF issues a Npcf_SMPolicyControl_Create to create an association
with the PCF for the PDU Session. It provides the PDU session ID, an
indication it is an I-SMF, its capability (e.g. service area, supported
DNAI(s)) to the PCF. The PCF acknowledges the creation of the association and
may provide policies that need to be fulfilled by the I-SMF.
Steps 3-5: same as in step1-3 of Figure 4.3.6.2-1, TS 23.502 [3].
Step 6-7: same as in step 4-5 of Figure 4.3.6.2-1, TS 23.502 [3]. Only changes
to the step#4 of Figure 4.3.6.2-1, TS 23.502 [3], the PCF also determines
whether the policy will be processed at the I-SMF or A-SMF, in this solution,
PCF forwards PCC Rules for the AF policies to directly to the I-SMF, the
session AMBR and the remaining PCC Rules for the PDU session to perform
traffic measurements and session AMBR enforcement in the ULCL/BP and then step
9 follows. Alternatively, the session AMBR and rules are transferred from
A-SMF to I-SMF as described in step 8. For other case, PCF performs as
described in solution#15.
Step 8: I-SMF reports to A-SMF that a UL CL/BP is inserted, the A-SMF reports
SM context information that includes the session AMBR for enforcement and the
rules to performs traffic measurements in the ULCL/BP. The same service
operation as proposed in solution#1 to retrieve SM context from A-SMF can be
reused,
Step 9. I-SMF performs action such as insertion of UL-CL or I-UPF, user plane
reconfiguration, based on received policies in the above steps.
#### 6.13.3.2 Notification of User Plane Management Events
The SMF may send a notification to the AF if the AF had subscribed to user
plane management event notifications as described in TS 23.502 [3] clause
4.3.6.2 and in TS 23.501 [2] clause 5.6.7.
Following flow depicts the sequence of events, applicable to scenarios where
PCF forwards received AF request for subscription of user plane management
event notifications, to A-SMF and/or to I-SMF:
NOTE 1: The notifications are sent directly from the A-SMF to the NEF or from
the I-SMF to the NEF.
NOTE 2: Network topology e.g. A-SMF and I-SMF details are not exposed to AF.
Figure 6.13.3.2-1: Notification of user plane management events
Steps 1-2. Same as in TS 23.502 [3] figure 4.3.6.3-1.
Step 3. In case of early notification requested by the AF, I-SMF notifies to
the AF of the target DNAI of the PDU Session by invoking
Nsmf_EventExposure_Notify.
Step 4. Addition, relocation or removal of I-UPF.
Step 5 Same as in TS 23.502 [3] figure 4.3.6.3-1.
Step 6. In case of late notification requested by the AF, I-SMF notifies to
the AF of the target DNAI of the PDU Session by invoking
Nsmf_EventExposure_Notify.
### 6.13.4 Impacts on existing nodes and functions
PCF need to support multiple SMFs to the PDU session and determine where the
policy need to be processed. In local breakout the V-PCF need to support
multiple SMFs for the PDU session.
\- when an I-SMF is used the (V-)PCF manages 2 associations for SM policies
for that PDU Session. The association with the I-SMF is deleted when the UE
moves to a new service area that may be under the A-SMF or under a new I-SMF.
\- need to collect usage information from each SMF.
The SMF (Nxx interface) need to be enhanced for:
\- providing (V-)PCF address for the SM Policy Association from the A-SMF to
the I-SMF.
\- The SMF needs to inform the (V-)PCF on the service area that covers.
\- The I-SMF needs to request updated SM context from the A-SMF when an
ULCL/BP is inserted. The A-SMF reports the session AMBR and the rules for
traffic measurements and bit rate enforcement to the I-SMF.
On charging, the CHF:
\- charging system need to collect resource usage information from all SMFs
i.e. A-SMF and I-SMF(s), which leads the charging system having multiple
interfaces for the same PDU Session.
### 6.13.5 Solution Evaluation
PCC Architecture:
\- Adding I-SMF as new consumer of Npcf SM Policy service.
\- Adding a new reference point between PCF and I-SMF i.e. I-SMF will have a
direct interface with the PCF i.e. the PCF will have two Npcf/N7 interfaces
with two SMFs (I-SMF and A-SMF) for a PDU Session.
\- Npcf interface with I-SMF that may change during the life time of the PDU
Session i.e. when an I-SMF is inserted / changes / removed.
\- PCF installs PCC Rules with traffic steering information to the service
area that serves the DNAI.
CHF services (to be defined by SA5):
\- Similar to PCF services, the existing Nchf services to request quota and
report usage per CK needs to be supported by both the A-SMF and the I-SMF.
When an ULCL/BP is inserted, and traffic measurements for charging are
performed in the ULCL/BP, the I-SMF reports usage directly to the CHF and CHF
will aggregate usage from I-SMF and A-SMF i.e. CHF needs to support credit
management and reporting for multiple SMFs, both I-SMF and A-SMF for a PDU
session.
This solution impacts CHF and PCF as the A-SMF is not hiding the existence of
an I-SMF.
SMF services:
\- the service operation is extended to include the PCF address for the SM
Policy Association.
This solution will:
\- Avoid defining Nxx extensions to N16 for the sake of the transfer offload
policies to I-SMF and for the sake of transferring usage reporting from the
local UPF to the CHF (and such reporting may be signalling intensive).
\- reduce the signalling delay in the processing of AF policy handling, by
avoiding intermediate handling via A-SMF. In addition, the charging system
collects and aggregates the network usage in the Alt#2 proposal, thus charging
system is aware of the network usage in different administration areas (i.e.
I-SMF and A-SMF).
\- Allow the I-SMF creating CDR allowing to monitor usage in the local
administrative domain.
\- This solution maintains the functional split of PCF and SMF and CHF and SMF
as in Rel‑15, that is the PCF maintains the SM Policy Association with the
SMF. The SMF decides where to enforce policies depending on the topology in
its service area as in Rel‑15.
## 6.14 Solution #14: TEID ranges assist CN tunnel Info allocation
### 6.14.1 Overview
This solution addresses key issue #3, especially on how to assure the CN
Tunnel Info allocated to the UE is unique when the allocation functionality is
supported by the SMFs and the UPF is controlled by multiple SMFs.
The principle of this solution is that the whole TEID resource within one UPF
pool is divided to different TEID range for each SMF and UPF pair.
### 6.14.2 Description of the solution
The UPF provides the User Plane IP Resource Information IE to the SMF, which
contains the TEID range that the CP function shall use to allocate GTP-U
F-TEID in the UP function. For one UPF pool, i.e. the UPF instance(s) which
can serve the same DN network, the TEID ranges is allocated per different SMF
instance and UPF instance pair.
The alternative means for the SMF obtains the TEID range of one UPF instance
via the NRF. The SMF query the NRF, the NRF allocates and provides TEID range
of the UPF instance to the SMF. The NRF maintains the TEID range of each UPF
instance and the SMF instance pair.
When the SMF assigns the TEID for the UE, the SMF includes the TEID range
corresponding to the UPF instance in the most significant octet of a TEID.
### 6.14.3 Impact of the solution to existing entities
SMF:
\- The SMF includes the TEID range corresponding to the selected UPF instance
in the most significant octet of a TEID.
UPF:
\- The UPF instance provides corresponding TEID range to the corresponding SMF
instance.
NRF:
\- If the TEID range is managed by the NRF, the NRF need support the TEID
management function.
### 6.14.4 Evaluation of the solution
Editor\'s note: This clause provides an evaluation of the solution.
## 6.15 Solution #15: Handling AF influence on traffic routing
### 6.15.1 Overview
This solution applies to key issue 5: Handling AF influence on traffic
routing.
### 6.15.2 Network Architecture
The proposed solution is based on the network architecture in solution 6.1 of
the preent TR. The proposed solution aims to avoid changes to PCF and so the
proposal does not require the PCF to be aware of any insertion or removal of
an I-SMF(s) i.e. PCF forwards PCC rules corresponding to the AF request to the
anchor SMF irrespective of any I-SMF insertion.
Figure 6.15.2-1: Non-Roaming system architecture in reference point
representation
### 6.15.3 Procedures
#### 6.15.3.1 AF policy processing at the A-SMF without PCF impact
Below changes are required at the A-SMF and to the interface between A-SMF and
I-SMF i.e. on Nxx:
\- I-SMF is inserted e.g. as explained in other solutions in this TR. A-SMF
learns insertion of I-SMF(s) and additional information such as e.g. coverage
area of the I-SMF, region ID or administrative domain ID of the area that SMF
serves.
\- A-SMF forwards to I-SMF any required information that apply to the I-SMF,
based on the PCC rules received by A-SMF from PCF, over the Nxx interface.
Figure 6.15.3.1-1: AF policy processing at the A-SMF without PCF impact
1-5. Same as in TS 23.502 [3], Figure 4.3.6.2-1: Processing AF requests to
influence traffic routing.
6\. Later, an I-SMF is inserted due to mobility, as described in other
solutions of this TR (NOTE: this step is not triggered by step 5). The
information, that indicates the area where the I-SMF serves e.g. I-SMF Service
Area, region ID or administrative domain ID of the area that SMF serves, is
provided to A-SMF in this step.
7\. [Optional] A-SMF invokes Npcf_SMFPolicyControl_Update request to the PCF.
This is based on the Policy Control Request Triggers set by the PCF, e.g. be
due to UE location change.
8\. [Optional] PCF may provide updated PCC rules to the A-SMF.
9\. A-SMF forwards to I-SMF any policy information where the policy would have
to be enforced at the I-SMF, considering any PCC rules received previously
from the PCF. This includes rules for traffic measurement and session AMBR
enforcement in the ULCL/BP and rules to route the UL traffic to the local DNAI
based on the PCC Rules received from the PCF.
10\. I-SMF acknowledges.
11\. Possible I-UPF selection or insertion of UL-CL, user plane
reconfiguration, etc. based on received policies in the above step.
#### 6.15.3.2 Notification of User Plane Management Events
The AF may also provide in its request subscriptions to SMF events. The SMF
may send a notification to the AF if the AF had subscribed to user plane
management event notifications as described in TS 23.502 [3] clause 4.3.6.2
and in TS 23.501 [2] clause 5.6.7
The following flow depicts the sequence of events:
NOTE: A-SMF on receipt of AF request for subscriptions to SMF events forwards
the request to I-SMF.
Figure 6.15.3-1: Notification of user plane management events
1-2: Same as in TS 23.502 [3] figure 4.3.6.3-1.
3\. Addition, relocation, removal of I-UPF.
4\. I-SMF sends user plane management event information to A-SMF.
5\. A-SMF acknowledges in response to step 4.
6\. Same as in TS 23.502 [3] figure 4.3.6.3-1.
### 6.15.4 Impact of the solution to existing entities
Impacts on the A-SMF and I-SMF as follows:
\- Nxx interface between A-SMF and I-SMF needs to be enhanced to provide rules
for steering traffic to the local DNAI and to configure the ULCL/BP for
session AMBR enforcement and traffic measurements. The I-SMF proxies traffic
measurements from ULCL/BP to the A-SMF.
\- A-SMF needs to know the information, e.g. region ID or administrative
domain ID of the area that SMF serves or the Service Area of I-SMF. The A-SMF
needs to provide rules for routing AF traffic to the local DNAI under the
I-SMF service area based on PCC Rules.
\- I-SMF needs to report events that indicate routing to a DNAI and UP
reconfiguration to the A-SMF, instead of to the AF directly.
No impact to PCF or in CHF.
### 6.15.5 Evaluation of the solution
The procedures on AF influence traffic routing and the local traffic offload
require no PCF / CHF change as the A-SMF is hiding the existence of an I-SMF.
This solution re-uses (does not have an impact to) the Npcf/N7 interface
between the PCF and the A-SMF and the Nchf interface between the CHF and the
A-SMF.
This solution requires changes in the A-SMF functionality; i.e. upon the AF
policy request from the PCF, the A-SMF need to determine which policies need
to be implemented in the A-SMF service area and in the I-SMF Service area. In
addition, A-SMF need to collect and aggregate the network usage from I-SMF and
from the UPF it directly manages before provide network usage information to
the CHF.
\- I-SMF needs to provide the Service area along with supported DNAIs to the
A-SMF during Nxx interface establishment.
This solution will:
\- require defining Nxx extensions to N16 for the sake of the transfer offload
policies to I-SMF and for the sake of transferring usage reporting from the
local UPF to the CHF.
\- load Nxx for the transfer of usage reporting from the local UPF to the CHF.
## 6.16 Solution #16: I-UPF insertion and L-SMF/L-UPF selection
### 6.16.1 Overview
This solution addresses the following key issue 5:
\- On AF request to the PCF, how PCF policies are handled in the network?
e.g.:
\- Whether the policy related to the AF Request is processed by anchor SMF
and/or intermediate SMF and how the two SMFs coordinate insertion and
configuration of UPF(s) (e.g. with UL CL rules)?
### 6.16.2 Description of the solution
#### 6.16.2.1 Network Architecture
The solution is an extension of Solution 1 to address the key issue 5.
In this solution, L-UPF that terminates the N6 to Local Date network is
controlled by another L-SMF (Local SMF). The architecture is as in Figure
6.16.2.1-1 for the case when the I-SMF is not inserted and Figure 6.16.2.1-2
for the case when I-SMF is inserted. Other un-related Network Functions are
not shown for simplicity.
Figure 6.16.2.1-1: L-SMF/L-UPF insertion when I-SMF doesn\'t exist
Figure 6.16.2.1-2: L-SMF/L-UPF insertion when I-SMF exists
The local SMF is a network function that controls the local UPF connecting to
local data network. The L-SMF has the following functionalities:
\- Selection and control of L-UPF.
\- Establish the tunnel between I-UPF and L-UPF.
\- Receives QoS policy for the offloading traffic from A/I-SMF.
\- Configure the QoS policy at L-UPF.
\- Configures traffic steering at L-UPF to route traffic to proper
destination.
The L-SMF may have the following functionalities:
\- UE IP address allocation & management (only for IPv6 multi-homing PDU
session)
\- Lawful intercept (for SM events and interface to LI System).
The L-SMF does not have the following functionalities:
\- Session Management e.g. Session Establishment, modify and release,
including tunnel maintain between UPF and AN node.
\- Termination of SM parts of NAS messages.
\- Downlink Data Notification.
\- Initiator of AN specific SM information, sent via AMF over N2 to AN.
\- Determine SSC mode of a session.
\- Roaming functionality:
\- Termination of interfaces towards Policy control functions.
\- Charging data collection and support of charging interfaces.
\- Control and coordination of charging data collection at UPF.
The I-UPF acts as UL-CL or Branching point. An Intermediate SMF(I-SMF) may be
used to control the I-UPF when the I-UPF is outside of the A-SMF Service Area.
Nxx interface is used between I-SMF and A-SMF.
If I-SMF is not inserted, based on PCF input and A-SMF service area, the A-SMF
may decide that there is need to offload some traffics to local Data network
identified by DNAI and if the A-SMF can\'t select a local UPF, the A-SMF then
sends message to AMF to trigger the L-SMF selection. Nxy interface is used
between the A-SMF and L-SMF.
If I-SMF is inserted the I-SMF may be indicated directly by PCF or by A-SMF to
offload some traffics to local Data network. If the I-SMF can\'t select a
local UPF, the I-SMF may sends message to AMF to trigger the L-SMF selection.
Nxy interface is used between the I-SMF and L-SMF.
The AMF selects the L-SMF from the NRF based on the offloading target (e.g.
DNAI).
#### 6.16.2.2 Procedures
The procedure in figure 6.16.2.2-1 is to select L-SMF for a PDU session to
offload some traffic to local data network.
Figure 6.16.2.2-1: Procedure to support L-SMF selection
1\. The UE establishes a PDU Session between UE and A-UPF.
Step 2-7 apply when no I-SMF is inserted.
2\. The A-SMF decides that the target DNAI can\'t be served by all UPFs
controlled by itself, it sends a N11 message to AMF to select a Local SMF.
This N11 message includes the target DNAI, and the PDU Session ID.
3\. The AMF selects L-SMF based on the target DNAI and UE location
information.
4\. The AMF sends Nsmf_PDUSession_UpdateSMContext Request (address of L-SMF)
to A-SMF.
5\. The A-SMF sends Nsmf_PDUSession_UpdateSMContext Response the AMF.
6\. If there is no I-UPF has been selected the A-SMF selects an I-UPF for
ULCL/BP. The A-SMF and L-SMF establish the user plane tunnel between the I-UPF
and L-UPF. The Nxy between A-SMF and L-SMF is assumed to base on N16.
7\. The A-SMF forwards to L-SMF any policy information where the policy would
have to be enforced at the L-SMF/L-UPF.
Step 8-13 apply when I-SMF has been inserted.
8\. If the I-SMF is instructed to offload some traffic and it decides that the
target DNAI can\'t be served by all UPFs controlled by itself, it sends a N11
message to AMF to select a Local SMF. This N11 message includes the target
DNAI, and the PDU Session ID.
9\. The AMF selects L-SMF based on the target DNAI and UE location
information.
10\. The AMF sends Nsmf_PDUSession_UpdateSMContext Request (address of L-SMF)
to I-SMF.
11\. The I-SMF sends Nsmf_PDUSession_UpdateSMContext Response the AMF.
12\. The I-SMF and L-SMF establish the user plane tunnel between the I-UPF and
L-UPF. The Nxy between I-SMF and L-SMF is assumed to base on N16.
13\. The I-SMF forwards to L-SMF any policy information where the policy would
have to be enforced at the L-SMF/L-UPF.
### 6.16.3 Impact of the solution to existing entities
A-SMF:
\- The A-SMF is enhanced to indicate the need of L-SMF selection.
\- The A-SMF is enhanced to establish the user plane, between the A-UPF and
L-UPF.
\- The A-SMF is enhanced to transfer the QoS policy and traffic steering
policy for offloading traffic to L-SMF via Nxy.
I-SMF:
\- The I-SMF is enhanced to indicate the need of L-SMF selection.
\- The I-SMF is enhanced to establish the user plane, between the I-UPF and
L-UPF.
\- The I-SMF is enhanced to transfer the QoS policy and traffic steering
policy for offloading traffic to L-SMF via Nxy.
Editor note: Further enhancements of Nxy between I-SMF and L-SMF are FFS.
AMF:
\- The AMF is enhanced to select the L-SMF.
Editor\'s note: How far does this solution differ from solution 1 is FFS.
### 6.16.4 Evaluation of the solution
This solution establishes the data path to offload the traffic to third party
data network where the L-SMF/L-UPF are dedicated for a Third party (corporate)
as described in use case #3.
The Nxy interface between I-SMF and L-SMF is assumed to base on N16 therefore
it is allowed that the I-SMF/I-UPF is operated by MNO while the L-SMF/L-UPF
can be operated by Third party.
## 6.17 Solution #17: I-SMF insertion during EPS to 5GS handover using N26
### 6.17.1 Overview
This solution addresses key issue#4 with regard to the aspect of interworking
from EPS to 5GS. This solution is based on the same architecture as described
in solution #6 (clause 6.6).
### 6.17.2 Description of the solution
#### 6.17.2.1 I-SMF insertion during EPS to 5GS handover using N26 interface
During EPS to 5GS handover using N26 interface, following enhancements apply,
based on procedures defined in clause 4.11.1.2.2 of TS 23.502 [3].
Preparation phase:
For non-roaming and local breakout roaming, if AMF determines the SMF selected
by MME (as a combo PGW+SMF) cannot serve the UE location, AMF shall insert a
new SMF as I-SMF.
For home routed roaming, AMF selects V-SMF by taking into the consideration of
UE location.
NOTE: I-SMF relocation is not considered for the EPS to 5GS handover scenario,
based on the assumption that I-SMF/I-UPF are deregistered for the UE when UE
moves to 4G.
##### 6.17.2.1.1 Preparation phase
Figure 6.17.2.1.1-1 shows the preparation phase of the Single Registration-
based Interworking from EPS to 5GS procedure.
Figure 6.17.2.1.1-1: EPS to 5GS handover using N26 interface, preparation
phase
This procedure applies to the Non-Roaming (TS 23.501 [2], Figure 4.3.1-1),
Home-routed roaming (TS 23.501 [2], Figure 4.3.2-1) and Local Breakout roaming
Local Breakout (TS 23.501 [2], Figure 4.3.2-2) cases.
\- For non-roaming scenario, V-SMF, v-UPF and v-PCF+v-PCRF are not present.
\- For home-routed roaming scenario, the PGW-C+SMF and UPF+PGW-U are in the
HPLMN. v-PCF+v-PCRF, are not present.
\- For local breakout roaming scenario, V-SMF and v-UPF are not present.
PGW-C+SMF and UPF+PGW-U are in the VPLMN.
\- In local-breakout roaming case, the v-PCF+v-PCRF interacts with the
PGW-C+SMF.
\- I-SMF and I-UPF may present only in non-roaming and LBO roaming scenarios.
NOTE: If not mentioned, the steps are exactly the same as in figure
4.11.1.2.2.2-1 of TS 23.502 [3].
Step 4: AMF retrieves the UE location from MME in step 3 via N26 as defined in
Rel-15.In case of non-roaming and LBO roaming, AMF selects an I-SMF if AMF
determines the A-SMF (combo SMF+PGW-C in the figure) cannot serve the UE
location. AMF invokes the Nsmf_PDUSession_CreateSMContext service operation
(UE PDN Connection Contexts, AMF ID, SMF + PGW-C address, S-NSSAI). The
S-NSSAI is set as the default S-NSSAI value, which is configured in AMF.
In case of home-routed case, AMF selects the V-SMF with the additional
criteria: UE location.
Step 4a: I-SMF selects an I-UPF and allocates the CN tunnel info of I-UPF;
Step 4b: I-SMF invokes the Nsmf_PDUSession_CreateSMContext service operation
(UE PDN Connection Contexts, S-NSSAI, CN tunnel info of the I-UPF). The
S-NSSAI is set as the default S-NSSAI value, which is received from AMF.
##### 6.17.2.1.2 Execution phase
Figure 6.17.2.1.2-1 shows the Single Registration-based Interworking from EPS
to 5GS procedure.
Figure 6.17.2.1.2-1: EPS to 5GS handover using N26 interface, execution phase
Steps descriptions are exactly the same as described in clause 4.11.1.2.2.3 of
TS 23.502 [3], except that V-SMF may be replaced by I-SMF and V-UPF replaced
by I-UPF in non-roaming and LBO roaming scenarios, whenever applicable during
preparation phase.
### 6.17.3 Impact of the solution to existing entities
AMF:
\- Verify whether the combo SMF+PGW-C (considering as A-SMF) can serve the UE
location;
\- Select an I-SMF if the above judgment is negative.
There are no impact to the N26 interface defined in Rel-15.
### 6.17.4 Evaluation of the solution
No enhancement on interface nor functionalities on any NFs have been
identified.
AMF has this functionality for Home Routed roaming case already, so here only
a new trigger is needed to perform it.
NOTE: The flow shown in this solution is to be updated per the conclusion of
slice interworking study.
## 6.18 Solution 18: UL-CL/BP Insertion with UPF that is capable to flexibly
interface any SMF
### 6.18.1 Overview
This solution addresses the following part of key issue #1:
\- How to insert an UPF supporting UL-CL/BP (IPv6 multi-homing) which is not
controlled by the SMF that controls the PSA of the PDU Session. The UL-CL/BP
to be inserted may be at the same or different regional / administrative
areas.
### 6.18.2 Description
#### 6.18.2.1 General
This solution addresses the KI on UL CL/BP insertion, for a use case where SMF
cannot be the sole control plane for a UPF.
The solution proposes that the UPF (UL CL/BP) shall have sufficient self-
independence to enable it to interface and receive rules from multiple SMFs in
a flexible fashion, without having dedicated control of UPF resources in one
or a few specific SMFs. In this way it can be feasible to allow any SMF (in
the same regional / administrative area) to control a UPF (UL CL/BP).
The solution proposes that UE IP address allocation can be managed outside of
SMF. This is discussed as part of objective 2 of the ETSUN study and multiple
solutions have been proposed and captured in the TR, e.g. to enhance UPF to
support UE IP address management or to host UE IP address management in
external servers such as AAA, DHCP or NRF (see solutions #8 -- #12). This
avoids partitioning UPF resources between SMFs.
To ensure further flexibility and decoupling of SMF and UPF, it should be
possible for the SMFs (i.e. the SMF controlling the PSA of the PDU Session and
I-SMF) to easily discover available UPFs and their associated capabilities and
properties, possibly without pre-configured knowledge about the UPFs in each
SMF. Discovery of UPF as well as UPF capabilities via N4, as well as
discovery/provisioning of UPFs in SMF via NRF is already available as part of
Rel-15, but enhancements may be needed. This solution proposes the following
enhancements:
\- The UPF provides the UPF Service Area to the SMF via N4.
Editor\'s note: The list of additional enhancements to SMF/UPF, N4 or to the
discovery/provisioning of UPFs using NRF required for discovery of UP-CL/BP
and use of N4 from any SMF in the same regional / administrative area are FFS
If the UPF (UL CL/BP) is in the same regional / administrative area as the
A-SMF (i.e. SMF serving the initial PSA UPF), then the A-SMF selects the UPF
(UL CL/BP) and has the N4 session with it. The corresponding architecture is
shown in Figure 6.18.2-1 below.
If the UE is not in the same regional / administrative area as the A-SMF, then
it is assumed that solutions such as #1 and #6 are used to insert an I-SMF
between AMF and A-SMF. If the UPF (UL CL/BP) is in the same regional /
administrative area as the I-SMF, then the I-SMF selects the UPF and has the
N4 session with the UPF. The corresponding architecture is shown in Figure
6.18.2-2 below.
Figure 6.18.2-1: System architecture with UL-CL/BP in same region /
administrative domain as SMF serving initial PSA
Figure 6.18.2-2: System architecture with UL-CL/BP in same region /
administrative domain as I-SMF
#### 6.18.2.2 Procedures
Existing procedures are re-used. In case of multiple regional / administrative
areas, solutions 1/6 are used where UPF (UL CL/BP) is controlled from I-SMF
(if UL CL is in region of I-SMF) or A-SMF (if UL CL is in region of A-SMF).
### 6.18.3 Impact of the solution to existing entities
The following impacts are foreseen:
\- To support UE IP address allocation outside of SMF, the solution will have
same impact as solutions defined for objective 2, depending on solution that
gets agreed (to allow UE IP address outside of SMF).
\- Enhancements to N4 to provide the UPF Service Area to SMF.
Editor\'s note: Additional impacts is FFS.
### 6.18.4 Evaluation of the solution
Editor\'s note: This clause provides an evaluation of the solution.
## 6.19 Solution #19: Reduce latency to setup the user plane
### 6.19.1 Overview
This solution addresses the key issue 6 \"latency to setup the user plane\":
\- how to identify the delay-sensitive PDU Sessions and how the network
authorizes the use of this feature.
\- how to avoid the increase of delay to setup the user plane if and when the
UE moves outside of the SMF Service Area while in Idle mode.
The additional delay when the UE returned from IDLE can be categorized into
two cases:
\- Case 1: Additional I-UPF selection if the same SMF can still serve the UE.
This is same as Rel-15.
\- Case 2: Additional I-SMF selection if the serving SMF cannot control the
N3UPF which connect to the UE serving RAN area.
Comparing above two cases if the I-UPF is not changed, the additional SMF does
not need be added or removed. So, if the new I-UPF is not added/removed during
the Service Request procedure, the additional latency can be reduced. The
possible solutions that can solve the key issue includes:
### 6.19.2 Description of the solution
Alternative 1: deployment-based solution.
The UPF that supports the latency sensitive services can be planed properly in
order to avoid the I-SMF/I-UPF change during service request procedure, i.e.
to align the UPF service area same as the AMF service area. Thus, when the UE
does not change the serving AMF, no matter how to allocate TA list to the UE,
the SMF/UPF will not be changed when the mobility procedure is triggered. This
deployment requires that UPF has the same area coverage as the AMF service
area.
The SMF that supports the latency sensitive services can be planed properly in
order to avoid the I-SMF/I-UPF change during service request procedure, e.g.
to align the SMF service area same as the AMF service area. Thus, when the UE
does not change the serving AMF, no matter how to allocate TA list to the UE,
the SMF will not be changed when the mobility procedure is triggered. This
deployment requires that SMF has the same area coverage as the AMF service
area.
Alternative 2: Update the RA based on UPF service area of the PDU sessions
that are latency sensitive.
When the UE is registered, the RA is allocated to the UE as the normal
procedure.
When one PDU Session is to be established, the SMF determines whether the PDU
session is latency sensitive, e.g. based on indication received from UE, PCF,
AF, or based on local policy.
The SMF selects the UPF and gets the UPF service area as the normal procedure.
If the SMF determines a PDU session is latency sensitive, the SMF subscribes
the UE mobility and provides the AMF with the UPF service area information.
The AMF recalculates the RA based on the service area of UPF to assure that
the UE will not change the UPF when the Service Request procedure is
triggered. If the recalculated RA is different than the RA that has been
provided to UE, the AMF triggers UE configuration update procedure to provide
the new RA to UE.
For example, the AMF allocate the Registration Area (TA1, TA2, TA3, TA4, and
TA5) to the UE during the registration procedure. After the UE establish a
latency sensitive PDU Session, the SMF get the PSA-1 service area (TA1, TA2).
The SMF notifies to the AMF of PSA-1 service area information. The AMF
recalculates the RA information, i.e. (TA1, TA2) is the new Registration Area
allocated to the UE. The AMF notify the UE via the UE configuration update
procedure.
During mobility procedure, AMF notifies UE new location information to the
SMF. Per UE new location, the SMF determine whether the N3UPF need be
reallocated. If the N3UPF is to be reallocated, the SMF provides the AMF with
the new UPF service area information. The AMF based on that information
calculates the RA and notifies it to the UE via the UE configuration update
procedure.
### 6.19.3 Impact of the solution to existing entities
Alternative 1: deployment-based solution:
\- No impact on the existing entities but has deployments restriction.
Alternative 2: Update the RA based on UPF service area of the PDU sessions
that are latency sensitive. It is assumed only one PDU Session is associated
with latency sensitive service.
NOTE: If there are more than one PDU Session are associated with latency
sensitive service, the AMF need calculate the joint service area of all
latency sensitive UPF service area.
AMF impact:
\- The AMF need recalculate RA based on UPF service area and triggers UE
configuration update procedure to update RA.
SMF impact:
\- The SMF need determine whether a PDU session is latency sensitive.
\- The SMF sends the AMF of the UPF Service Area information to trigger the
AMF recalculate the RA.
### 6.19.4 Evaluation of the solution
Editor\'s note: This clause provides an evaluation of the solution.
## 6.20 Solution #20: UE IP address allocation by the UPF & UPF dealing with
UP transfer to UE
### 6.20.1 Overview This solution addresses KI #2.
This solution is a variant of solution #8 where in-band UE IP address transfer
to the UE ( DHCPV4, DHCPV6) is delegated to the UPF.
Whether this solution applies or whether Rel15 mechanisms are used to allocate
UE IP address(es) for a PDU Session is transparent to other entities than SMF
and UPF (and hence transparent to the UE).
NOTE: The solution allows signalling reduction when, in the context of some
candidate solution for wireless-wireline convergence, multiple devices can
send IP address allocation requests (e.g. DHCP signalling) within and during
the lifetime of a PDU Session.
### 6.20.2 Description of the solution
In the case of DHCPv4 or of DHCPv6 transfer of UE IP address, in-band UE IP
address transfer to the UE ( DHCPV4, DHCPV6) is delegated to the UPF.
Sending SLAAC related signalling (Router Advertisement) to the UE remains
under responsibility of the SMF.
NOTE 1: This enables the SMF to control SSC mode 3 related procedures such as
in TS 23.502 [3] Figure 4.3.5.3-1: Change of PDU Session Anchor with IPv6
Multi homed PDU Session.
The UPF becomes responsible of the DHCP lease timer; N4 specifications need to
evolve in order to support UPF Notification to SMF when an UE IP address has
been allocated or released (e.g. when the DHCP lease timer has expired).
NOTE 2: This solution reduces relaying of UP traffic (regular DHCP exchange to
re-new the IP lease) over N4 but requires N4 changes to support UPF
Notification to SMF when an UE IP address has been allocated or released. UPF
Notification to SMF when an UE IP address has been allocated or released is
(from SMF perspective) similar to UPF notification related with MAC addresses
of an UE in case of Ethernet PDU Session type (Rel-15).
The following description reuses solution 8 and indicates the specific aspects
of solution 20.
Upon N4 Association Setup Procedure (TS 23.502 [3], clause 4.4.3.1) the SMF
and UPF negotiate the support of this solution. The rest of the description
assumes both SMF and UPF support it.
At PDU Session establishment (TS 23.502 [3] Figure 4.3.2.2.1-1), N4 session
creation takes place before Step 9 (SMF initiated SM Policy Association
Creation/Modification procedure).
The SMF, when needing an IP address for a PDU Session, creates a PDR and
provides in the corresponding PDI (refer to TS 29.244 [5]):
\- A source interface referring to the N6 interface.
\- A Network Instance. The Network Instance is determined as in Rel15 with the
potential modification that the SMF may take into account the IP index
received from the PCF to determine the Network Instance.
\- No UE IP address but an indication that an IP address is to be allocated,
the IP version (V4 / V6) for this IP address / Prefix to be allocated and the
size of the Prefix (to support Prefix Delegation).
In its answer the UPF provides the IP address it has allocated to the PDU
Session.
The SMF may (solution 20) also provide at the N4 Session establishment
following additional indications:
\- An indication that DHCP signalling can be autonomously handled by the UPF.
\- (for the Combo PDU Session type defined in TR 23.716 [8]) the indication
above applies for additional DHCP address requests coming from the UE on the
PDU Session and contains also the maximum number of IP addresses that may be
allocated as part of the PDU Session. When this number has been reached the
UPF is to reject any addition request for an IP address.
\- A subscription to the event corresponding to the allocation / release of an
IP address for the PDU Session. The release (due e.g. to the absence of DHCP
lease renewal) of the last IP address within a PDU Session may be a trigger
for the SMF to decide the release of the PDU Session.
\- A request for the UPF to handle locally NS Neighbor Solicitation (RFC 4861
[7]) traffic.
### 6.20.3 Impacts on existing Functions
\- (as in solution #8):
\- OAM: no more need to co-ordinate IP address pools between SMF and UPF.
\- SMF and UPF negotiate the support and the need of this feature over N4.
\- UPF: needs to allocate IP address and maintain the list allocated IP
address.
\- N4 specifications need to evolve in order to support SMF request to
allocate/release UE IP address.
\- N4 specifications need to evolve in order to support UPF Notification to
SMF when an UE IP address has been allocated or released.
\- N4 specifications need to evolve in order to support the SMF providing
information on the maximum Number of IP addresses that can be allocated as
part of the PDU Session (in the context of NOTE 1 of clause 6.20.1).
### 6.20.4 Evaluation of the solution
The solution allows N4 signalling reduction (and thus SMF/UPF signalling
reduction):
\- For long lasting PDU Sessions when DHCP is used (DHCP leases are protected
by timers). The absence of DHCP renewal may also be an indication that the PDU
Session is no more needed.
\- (in the context of combo PDU session type), multiple devices can send IP
address allocation requests (e.g. DHCP signalling) within and during the
lifetime of a PDU Session.
\- no need to bother SMF with NS traffic.
SLAAC related signalling remains under control of the SMF allowing the SMF to
run SSC mode 3 related algorithms.
## 7 Conclusions
## 7.1 Conclusions for Key issues #1, #4 and #5
### 7.1.1 General
\- The architecture described in clause 6.1.2.2, which is the same as the
architecture described in clause 6.6.2.1, is used as a baseline (shown below).
Figure 7-1: Non-Roaming system architecture in reference point representation,
with no UL-CL/BP
\- For I-SMF selection:
\- The SMF service area is provided to AMF in SMF profile by NRF as part of
SMF discovery procedure.
\- During mobility procedure, AMF determines whether I-SMF re-selection is
needed based on service area of old I-SMF or A-SMF and UE location. AMF
selects new I-SMF by providing UE location and S-NSSAI to NRF.
\- If the AMF does not have I-SMF service area, e.g. during AMF relocation,
the AMF queries NRF to determine whether new I-SMF should be selected.
\- During PDU Session establishment, the AMF selects the A-SMF as described in
clause 6.3.2, TS 23.501 [2]. If the service area of the A-SMF(s) received from
the NRF is not able to serve the UE location, then an AMF selects an I-SMF
which can serve the UE location.
\- For SM context retrieval, the target I-SMF retrieves SM context directly
from source I-SMF or A-SMF.
\- For forwarding tunnel establishment between source I-UPF and target I-UPF,
it is established directly via source and target I-SMF or A-SMF, without
involvement of AMF.
\- For the case where a UL-CL/BP is controlled by I-SMF, solution #15 is used
as a baseline (shown below), i.e. the I-SMF has no interface to PCF or CHF.
\- The Nxx interface allows the A-SMF to provide rules to the I-SMF for
traffic steering, usage reporting, QoS enforcement to support scenarios with
UL-CL/BP controlled by I-SMF. Based on information received via Nxx, the I-SMF
supports selection of UPF(s) acting as UL-CL/BP and PSA.
\- The Nxx interface allows the I-SMF to provide usage reports to A-SMF for
traffic broken out in a UPF controlled by I-SMF.
\- Home-routed roaming scenarios with UL-CL/BP in VPLMN is not supported.
Figure 7-2: Non-Roaming system architecture in reference point representation,
with UL-CL/BP
Solution 17 is concluded as the solution for interworking from EPS to 5GS.
### 7.1.2 Information carried over Nxx
Services on Nxx are based on Nsmf services used on N16.
For scenarios with UL-CL/BP, the A-SMF needs to provide rules with instruction
for how the I-SMF (with related UPFs) should handle user plane traffic. These
rules may apply to traffic routed to/from a UPF controlled by A-SMF as well as
traffic that is broken out at a UPF/N6 controlled by I-SMF.
For an SDF that is routed to/from a UPF controlled by A-SMF,
enforcement/charging may be performed on a UPF controlled by A-SMF and/or a
UPF controlled by I-SMF depending on scenario. If there is a need for
enforcement/charging of the SDF on a UPF controlled by I-SMF, the rules can
contain information to allow a SDF to be identified, forwarded and
enforced/charged in a UPF controlled by I-SMF:
\- Information to identify the traffic, including tunnel endpoint information
as well as QFI, SDF filter, Application ID, Ethernet packet filter, etc.
\- QoS enforcement info (e.g. UL/DL MBR, UL/DL GBR).
\- Usage reporting requirements (e.g. measurement keys, measurement method).
For an SDF that is to be broken out at a UPF controlled by I-SMF, the rules
can contain:
\- Information to identify the traffic, including e.g. SDF filter, Application
ID, Ethernet packet filter, etc.
\- QoS enforcement info (e.g. UL/DL MBR, UL/DL GBR).
\- QoS marking requirements (QFI, RQI).
\- Event reporting requirements (e.g. application detection).
\- Usage reporting requirements (e.g. measurement keys, measurement method).
\- Traffic steering info: DNAI(s), TSP Ids per DNAI, N6 routing information In
addition, the A-SMF may provide PDU Session level information to I-SMF such
as:
\- Session AMBR.
The I-SMF need to provide the following information to A-SMF:
\- List of DNAI(s) supported by the I-SMF (and corresponding UPFs). This
allows the A-SMF to determine what rules for traffic steering that can be
provided to I-SMF.
\- Notification reports. This includes e.g. information related to application
detection in UPF(s) controlled by I-SMF, notification about allocated UE IP
prefixes (for IPv6 MH), etc.
\- Usage reports (volume reports etc). This allows the A-SMF to aggregate and
construct usage reports to PCF and/or to CHF. A-SMF can aggregate information
received from I-SMF over Nxx with usage reports received its UPF(s) over N4.
The exact format of the information carried on Nxx (e.g. format of the rules
provided by A-SMF to I-SMF) is to be determined by stage 3.
NOTE: Whether N4 enhancements are needed is to be determined during normative
phase.
## 7.2 Conclusions for KI #2
It is concluded that solutions #8 and #12 be adopted and the required
normative changes be made to TS 23.501 [2] and TS 23.502 [3].
###### ### Annex A: Summary of Solutions for KI#2
This document describes 6 solutions for Key Issue #2 that enhance the
allocation of an IP address/prefix to a PDU session for complex networks.
These solutions (#8, #9, #10, #11, #12, and #20) are fully described in their
respective clauses.
The table below summarizes some key aspects of these solutions, and is non-
exhaustive:
Table A-1: Summary of Solutions to KI #2
+---------+---------+---------+---------+---------+---------+---------+ | Aspect | S#8 | S#9 | S#10 | S#11 | S#12 | S#20 | +=========+=========+=========+=========+=========+=========+=========+ | Entity | SMF | SMF | SMF | SMF | SMF | SMF | | commun | | | | | | | | icating | (SMF | | | | | (UPF | | with UE | for | | | | | for | | for IP | DHCP) | | | | | DHCP) | | Address | | | | | | | | ass | | | | | | | | ignment | | | | | | | +---------+---------+---------+---------+---------+---------+---------+ | Entity | UPF | UPF | NRF or | NRF or | DHCP or | UPF | | m | | | UPF | DHCP | AAA | | | anaging | | | | Server | Server | | | IP Pool | | | | | | | +---------+---------+---------+---------+---------+---------+---------+ | Sig | N4 | N4 | Nnrf or | Nnrf or | DHCP or | N4 | | nalling | | | N4 | DHCP | Radius | | | I/F | | | | | | | | Between | | | | | | | | Pool | | | | | | | | Manager | | | | | | | | & | | | | | | | | Al | | | | | | | | locator | | | | | | | +---------+---------+---------+---------+---------+---------+---------+ | Fr | Every | Every N | Only | Every | Every | Every | | equency | PDU | PDU | during | PDU | PDU | PDU | | of | Session | S | initial | session | Session | Session | | Inte | | essions | ass | | | | | raction | | where N | ignment | | | | | between | | is | and | | | | | Al | | confi | sub | | | | | locator | | gurable | sequent | | | | | and | | (1 to | growth | | | | | Manager | | many) | or | | | | | | | | cont | | | | | | | | raction | | | | +---------+---------+---------+---------+---------+---------+---------+ | Impacts | None | None | NRF | NRF | DHCP or | None | | beyond | | | r | r | AAA | | | UPF & | | | equired | equired | server | | | SMF | | | to | to | r | | | | | | manage | manage | equired | | | | | | IP pool | IP pool | | | | | | | all | or DHCP | | | | | | | ocation | server | | | +---------+---------+---------+---------+---------+---------+---------+ | Inter | None | None | R | R | E | None | | working | | | equired | equired | xisting | | | with | SMF | SMF | | for NRF | Functi | SMF | | release | co | co | SMF | | onality | co | | 15 | ntinues | ntinues | needs | SMF | | ntinues | | meth | to send | to send | to know | needs | | to send | | odology | UE | UE | to | to know | | UE | | | All | All | re | to | | All | | SMF/UPF | ocation | ocation | ference | re | | ocation | | to | | | NRF | ference | | | | other | | | | NRF | | | | NF | | | | | | | +---------+---------+---------+---------+---------+---------+---------+ | Inter | R | R | None | None | E | R | | working | equired | equired | | | xisting | equired | | with | | | SMF | SMF | Functi | | | release | Neg | Con | co | co | onality | Neg | | 15 | otiated | figured | ntinues | ntinues | | otiated | | meth | during | in SMF | to | to | | during | | odology | N4 | if UPF | a | a | | N4 | | | asso | can | llocate | llocate | | asso | | Impacts | ciation | a | IP | IP | | ciation | | between | | llocate | address | address | | | | SMF & | | (i.e. | | | | | | UPF | | absence | | | | | | | | of IP | | | | | | | | pool | | | | | | | | info) | | | | | +---------+---------+---------+---------+---------+---------+---------+
Table A-1 provides an overview of each solution, this information is intended
for quick review and should not be used as the basis for decision.
#
# Foreword
This Technical Specification has been produced by the 3rd Generation
Partnership Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# 1 Scope
The present document specifies non-3GPP access network discovery and selection
procedures, the access authorization procedure used for accessing untrusted
non-3GPP access networks.
The present document also specifies the security association management
procedures used for establishing IKEv2 and IPsec security associations between
the UE and the N3IWF and the procedures for transporting messages between the
UE and the N3IWF over the non-3GPP access networks.
The present document is applicable to the UE and the network. In this
technical specification the network refers to the 3GPP 5GCN and the untrusted
non-3GPP access network.
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or non‑specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
[1] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[2] 3GPP TS 23.501: \"System Architecture for the 5G System; Stage 2\".
[3] 3GPP TS 23.502: \"Procedures for the 5G System; Stage 2\".
[4] 3GPP TS 24.501: \"Access-Stratum (NAS) protocol for 5G System (5GS); Stage
3\".
[4A] 3GPP TS 24.301: \"Non-Access-Stratum (NAS) protocol for Evolved Packet
System (EPS); Stage 3\".
[5] 3GPP TS 33.501: \"Security architecture and procedures for 5G System\".
[6] IETF RFC 7296: \"Internet Key Exchange Protocol Version 2 (IKEv2)\".
[7] 3GPP TS 24.302: \"Access to the 3GPP Evolved Packet Core (EPC) via
non-3GPP access networks; Stage 3\".
[8] 3GPP TS 23.003: \"Numbering, addressing and identification\".
[9] IETF RFC 3748: \"Extensible Authentication Protocol (EAP)\".
[10] 3GPP TS 33.402: \"3GPP System Architecture Evolution (SAE); Security
aspects of non-3GPP accesses.\"
[11] IETF RFC 4303: \"IP Encapsulating Security Payload (ESP)\".
[12] IETF RFC 4301: \"Security Architecture for the Internet Protocol\".
[13] 3GPP TS 23.122: \"Non-Access-Stratum (NAS) functions related to Mobile
Station (MS) in idle mode\".
[14] IETF RFC 2784: \"Generic Routing Encapsulation (GRE)\".
[15] IETF RFC 2890: \"Key and Sequence Number Extensions to GRE\".
[16] 3GPP TS 23.503: \"Policy and Charging Control Framework for the 5G
System\".
[17] 3GPP TS 24.526: \"User Equipment (UE) policies for 5G System (5GS); Stage
3\".
[18] 3GPP TS 23.402: \"Architecture enhancements for non-3GPP accesses\".
[19] IEEE Std 802.11-2012: \"IEEE Standard for Information technology \-
Telecommunications and information exchange between systems - Local and
metropolitan area networks - Specific requirements - Part 11: Wireless LAN
Medium Access Control (MAC) and Physical Layer (PHY) Specifications\".
[20] Wi-Fi Alliance: \"Hotspot 2.0 (Release 2) Technical Specification,
version 1.0.0\", 2014-08-08.
[21] ITU-T Recommendation E.212: \"The international identification plan for
public networks and subscriptions\", 2016-09-23.
[22] 3GPP TS 24.007: \"Mobile radio interface signalling layer 3; General
aspects\".
[23] IETF RFC 4555: \"IKEv2 Mobility and Multihoming Protocol (MOBIKE)\".
[24] IETF RFC 791: \"INTERNET PROTOCOL\".
[25] IETF RFC 8200: \"Internet Protocol, Version 6 (IPv6) Specification\".
[26] IETF RFC 2474: \"Definition of the Differentiated Services Field (DS
Field) in the IPv4 and IPv6 Headers\".
[27] IETF RFC 793: \"Transmission Control Protocol\".
[28] 3GPP TS 24.008: \"Mobile radio interface Layer 3 specification; Core
network protocols; Stage 3\".
[29] 3GPP TS 38.413: \"NG Application Protocol (NGAP)\".
# 3 Definitions, symbols and abbreviations
## 3.1 Definitions
For the purposes of the present document, the terms and definitions given in
3GPP TR 21.905 [1] and the following apply. A term defined in the present
document takes precedence over the definition of the same term, if any, in
3GPP TR 21.905 [1].
**MTU:** Maximum transmission unit (MTU) is the largest PDU size which can be
transmitted and received by a network entity in one single IP packet without
any need for IP fragmentation.
**NWu:** In this specification, NWu is the reference point between the UE and
the N3IWF for establishing secure tunnel(s) between the UE and the N3IWF so
that control-plane and user-plane exchanged between the UE and the 5G core
network is transferred securely over untrusted non-3GPP access.
For the purposes of the present document, the following terms and definitions
given in 3GPP TS 23.501 [2] apply:
**5G Access Network**
**5G Core Network**
**5G QoS flow**
**5G QoS identifier**
**5G System**
**PDU Session**
For the purposes of the present document, the following terms and definitions
given in 3GPP TS 23.003 [8] apply:
**NAI**
For the purposes of the present document, the following terms and definitions
given in 3GPP TS 33.501 [5] apply:
**SUPI**
**SUCI**
## 3.2 Abbreviations
For the purposes of the present document, the abbreviations given in 3GPP TR
21.905 [1] and the following apply. An abbreviation defined in the present
document takes precedence over the definition of the same abbreviation, if
any, in 3GPP TR 21.905 [1].
5GCN 5G Core Network
5GS 5G System
5G-AN 5G Access Network
5QI 5G QoS Identifier
AMF Access and Mobility Management Function
ANDS Access Network Discovery and Selection
ANDSP Access Network Discovery and Selection Policy
AUSF Authentication Server Function
CP Control Plane
DL Downlink
DNS Domain Name System
DSCP Differentiated Services Code Point
ePDG Evolved Packet Data Gateway
ESP Encapsulating Security Payload
FQDN Fully Qualified Domain Name
H-PCF A PCF in the HPLMN
IP Internet Protocol
IPsec Internet Protocol Security
N3AN Non-3GPP Access Network
N3IWF Non-3GPP InterWorking Function
NAI Network Access Identifier
NAS Non Access Stratum
PCF Policy control Function
PDU Protocol Data Unit
QFI QoS Flow Identifier
RQI Reflective QoS Indicator
SA Security Association
SPI Security Parameters Index
SUPI Subscription Permanent Identifier
SUCI Subscription Concealed Identifier
TCP Transmission Control Protocol
UL Uplink
UP User Plane
UPF User Plane Function
V-PCF A PCF in the VPLMN
WLANSP WLAN Selection Policy
# 4 General
## 4.1 Overview
The 5G core network supports the connectivity of the UE via non-3GPP access
networks. In this release of specification, only untrusted non-3GPP access is
supported.
## 4.2 Untrusted access
**For an untrusted non-3GPP access network, the communication between the UE
and the 5GCN is not trusted to be secure.**
**For an untrusted non-3GPP access network** , to secure communication between
the UE and the 5GCN, a UE establishes secure connection to the 5G core network
over untrusted non-3GPP access via the N3IWF. The UE performs registration to
the 5G core network during the IKEv2 SA establishment procedure as specified
in 3GPP TS 24.501 [4] and IETF RFC 7296 [6]. After the registration, the UE
supports NAS signalling with 5GCN using the N1 reference point as specified in
3GPP TS 24.501 [4]. The N3IWF interfaces the 5GCN CP function via the N2
interface to the AMF and the 5GCN UP functions via N3 interface to the UPF as
described in 3GPP TS 23.501 [2].
## 4.3 Identities
### 4.3.1 User identities
When the UE accesses the 5GCN over non-3GPP access networks, the same
permanent identities for 3GPP access are used to identify the subscriber for
non-3GPP access authentication, authorization and accounting services.
The Subscription Permanent Identifier (SUPI) is defined in 3GPP TS 33.501 [5].
The SUPI can contain either an IMSI or a network specific identifier as
specified in 3GPP TS 23.501 [2]. A SUPI containing an IMSI is defined in 3GPP
TS 23.003 [8]. A SUPI containing a network specific identifier always takes
the form of a NAI as defined in 3GPP TS 23.003 [8].
The Subscription Concealed Identifier (SUCI) is a privacy preserving
identifier containing the concealed SUPI as specified in 3GPP TS 33.501 [5].
SUCI is calculated from SUPI. When the SUPI contains an IMSI, the
corresponding SUCI is derived as specified in 3GPP TS 23.003 [8]. When the
SUPI contains a network specific identifier, the corresponding SUCI in NAI
format is derived as specified in 3GPP TS 23.003 [8].
User identification in non-3GPP accesses can require additional identities
that are out of the scope of 3GPP.
### 4.3.2 FQDN for N3IWF Selection
An N3IWF FQDN is either provisioned by the home operator or constructed by the
UE in either the Operator Identifier FQDN format or the Tracking Area Identity
FQDN format as specified in 3GPP TS 23.003 [8],
The N3IWF FQDN is used as input to the DNS mechanism for N3IWF selection.
## 4.4 Quality of service support
### 4.4.1 General
When the UE accesses the 3GPP 5G System (5GS) via non-3GPP access networks,
the same QoS flow based 5G QoS model and principles are followed as described
in 3GPP TS 23.501 [2]. For PDU sessions that were established over non-3GPP
access, the QoS flow remains to be the finest granularity of QoS
differentiation in the PDU Session.
### 4.4.2 QoS differentiation in untrusted non-3GPP access
#### 4.4.2.1 General
For untrusted non-3GPP access, the N3IWF is the access network node that
provides QoS signalling to support QoS differentiation and mapping of QoS
flows to non-3GPP access resources.
#### 4.4.2.2 QoS signalling
A QoS flow is controlled by the SMF and can be preconfigured, or established
via the UE requested PDU Session establishment via untrusted non-3GPP access
procedure, the UE or network requested PDU session modification via untrusted
non-3GPP access procedure. (see 3GPP TS 23.502 [3]),
During PDU session establishment, based on local policies, pre-configuration
and the QoS profiles received, the N3IWF determines the number of IPsec child
SAs to establish and the QoS profiles associated with each IPsec child SA. The
N3IWF then initiates IPsec SA creation procedure to establish Child SAs
associating to the QoS flows of the PDU session.
#### 4.4.2.3 QoS differentiation in user plane
For uplink, the UE associates an uplink user data packet with a QFI as
specified in 3GPP TS 24.501 [4]. The UE shall then encapsulate the uplink user
data packet and the QFI associated with the uplink user data packet in the GRE
header and select IPsec child SA based on PDU session and QFI associated with
the uplink user data packet as specified in subclause 8.3.
For downlink, the UPF maps the user data packet to a QoS flow. The N3IWF shall
determine the IPsec child SA to use for sending of the downlink user data
packet over NWu based on mapping of the QoS flow to the IPsec child SA based
on QFI of the QoS flow of the user data packet and the identity of the PDU
Session of the user data packet.
#### 4.4.2.4 Reflective QoS
Reflective QoS is also supported when the UE accesses the 5GCN via untrusted
non-3GPP access network as specified in 3GPP TS 23.502 [3]. If the N3IWF
receives a downlink user packet associated with Reflective QoS Indicator
(RQI), the N3IWF shall set the RQI in the GRE header when the N3IWF
encapsulates the downlink user data packet into a GRE encapsulated user data
packet as specified in subclause 8.3.
#### 4.4.2.5 QoS enforcement
If the UE is provided with maximum flow bit rate (MFBR) for UL for a QFI as
specified in 3GPP TS 24.501 [4], the UE should send user data packets
associated with the QFI with a bitrate lower than or equal to the maximum flow
bit rate (MFBR) for UL.
# 5 Network discovery and selection
## 5.1 General
The following aspects are included when selecting a 5GC network and routing
traffic via the 5GC network:
a) access network discovery procedures as defined in subclause 5.2;
b) access network selection procedures as defined in subclause 5.3; and
c) access network reselection procedures as defined in subclause 5.4.
## 5.2 Access network discovery procedure
### 5.2.1 General
If PLMN selection specified in 3GPP TS 23.122 [13] is applicable (e.g., at
switch-on, recovery from lack of 3GPP coverage, or user selection of
applicable 3GPP access technology), the PLMN selection to select the highest
priority PLMN according to these specifications is performed before any access
network discovery.
In the access network discovery procedure, the UE can get ANDSP information on
available access networks in its vicinity and can use this information when
determining the presence of operator preferred access networks. Determination
of the presence of access networks requires using radio access specific
procedures, which are not further described here.
### 5.2.2 Discovering availability of WLAN access networks
The UE may obtain WLAN Selection Policy (WLANSP) rules information by pre-
configuration or by downloading the policy information from the PCF as
specified in 3GPP TS 23.503 [16]. The policy contains the UE access network
discovery and selection related policy information to help the UE in
discovering and selecting a WLAN access network (see 3GPP TS 24.526 [17]).
The UE may receive multiple valid WLANSP rules. When the UE is in the home
PLMN, the UE uses the valid WLANSP rules from the home PLMN to select an
available WLAN. When the UE is roaming and the UE has valid rules from both
HPLMN and VPLMN, the UE gives priority to the valid WLANSP rules from the
VPLMN. A WLANSP rule is valid if it meets the validity conditions included in
the WLANSP rule (if provided).
The UE may apply the techniques specific to the WLAN access technologies to
discover available WLAN access networks. Such techniques will not be further
described here.
In addition, the UE may obtain information on operator preferred WLAN access
networks via ANDSP.
## 5.3 Access network selection procedure
### 5.3.1 General
In this release of the specification, only selection of WLAN access network is
supported. The ANDSP policy contains WLANSP rules for the UE to select a WLAN
access network. Rules for selecting other types of non-3GPP access networks
are not specified.
### 5.3.2 WLAN selection procedure
#### 5.3.2.1 General
The purpose of the WLAN selection procedure is to create a prioritized list of
selected WLAN(s).
The UE shall perform WLAN selection based on the user preferences and WLANSP
rules. The UE may be provisioned with WLANSP rules from multiple PLMNs. User
preferences take precedence over the WLANSP rules.
The user preferences are used to select between the automatic WLAN selection
procedure or the manual WLAN selection procedure:
\- if user preferences are present, the UE shall determine the prioritized
list of selected WLAN(s) using the manual mode WLAN selection procedure (see
subclause 5.3.2.2); and
\- if user preferences are not present or if there is no user-preferred WLAN
access network available, the UE shall determine the prioritized list of
selected WLAN(s) using the automatic mode WLAN selection procedure (see
subclause 5.3.2.3).
#### 5.3.2.2 Manual mode WLAN selection
The UE creates a prioritized list of available WLAN(s). The creation of the
prioritized list is implementation specific.
#### 5.3.2.3 Automatic mode WLAN selection
The UE shall first determine valid WLANSP rules for WLAN selection:
a) if the UE is not roaming over 3GPP access, the UE shall use the valid
WLANSP rules from the HPLMN;
b) if the UE is roaming over 3GPP access, the UE may have valid WLANSP rules
from both the VPLMN and the HPLMN. WLANSP rules from the HPLMN will have lower
priority from the WLANSP rules from the VPLMN.
The UE shall then determine the selected WLAN(s) according to the following
steps:
a) use the procedures specified in the IEEE 802.11-2012 [19] to discover the
available WLANs. The UE may perform ANQP procedures as specified in the IEEE
802.11-2012 [19] or the Hotspot 2.0 [20] to discover the attributes and
capabilities of available WLANs. If the UE supports ANQP procedures, the UE
may send an ANQP request for lists of service providers (i.e. ANQP-elements
\"Domain Name\", see IEEE 802.11-2012 [19]) and PLMN identities (i.e. ANQP-
element \"3GPP Cellular Network\", see 3GPP TS 24.302 [7]); and
b) if the UE has performed ANQP procedures to discover the attributes and
capabilities of available WLANs, compare the attributes and capabilities of
the available WLANs with the group of selection criteria of the valid WLANSP
rules and construct a prioritized list of available WLANs that fulfill the
selection criteria.
1) when there are multiple valid WLANSP rules the UE evaluates the valid
WLANSP rules in priority order. The UE evaluates first if an available WLAN
access meets the selection criteria of the highest priority valid WLANSP rule.
The UE then evaluates if an available WLAN access meets the selection criteria
of the next priority valid WLANSP rule;
NOTE 1: Each WLANSP rule can include one or more groups of selection criteria
in priority order. If there are multiple highest priority groups of selection
criteria in the valid WLANSP rule, it is up to the UE implementation which one
to use.
2) if the Home network ind bit is not set to \"1\" in the group of selection
criteria (see 3GPP TS 24.526 [17]), the WLAN(s) that match the group of
selection criteria with the highest priority are considered as the most
preferred WLANs, the WLAN(s) that match the group of selection criteria with
the second highest priority are considered as the second most preferred WLANs;
and
3) if the Home network ind bit is set to \"1\" in the group of selection
criteria (see 3GPP TS 24.526 [17]), then the UE shall create a list of
available WLANs and shall apply the group of selection criteria to all the
WLANs in this list. A WLAN is included in this list, if
i) the other selection criteria in the active WLANSP rule are met; and
ii) the UE received a lists of service providers (i.e. ANQP-elements \"Domain
Name\") and PLMN identities (i.e. ANQP-element \"3GPP Cellular Network\"),
and:
I) if the list with PLMNs that can be selected form the WLAN (see 3GPP TS
24.302 [7]) includes:
A) the HPLMN derived from its IMSI; or
B) a PLMN matching an entry in the UE\'s list of equivalent PLMNs; or
II) if the domain name list (see IEEE 802.11-2012 [19]) includes:
A) the home domain name derived from its IMSI; or
B) the domain name derived from its list of equivalent PLMNs; and
NOTE 2: If the Home network ind bit is set to \"1\" in a group of selection
criteria then this group of selection criteria is not expected to include the
preferred roaming partner list and the preferred SSID list.
NOTE 3: In this release of the specification, the ANQP-element \"3GPP Cellular
Network\" with the PLMN List with S2a Connectivity IE is not considered by the
UE.
4) The priority of a WLAN in the available WLANs list is set to the WLAN
priority defined in the preferredSSIDlist of the matching group of selection
criteria. There may be one or more selected WLANs in the list.
## 5.4 Access network reselection procedure
### 5.4.1 General
The access network reselection procedure can be triggered based on the user\'s
request or the operator\'s policy. Such operator policy for supporting network
reselection can be provided by the ANDSP or can be pre-provisioned in the UE.
The access network reselection procedure can also be triggered by the UE
during periodical re-evaluation of ANDSP policies (see subclause 6.4.2), or if
the \'active\' rule becomes invalid (conditions no longer fulfilled), or other
manufacturer specific trigger.
NOTE: How frequently the UE performs the discovery and reselection procedure
is UE implementation specific.
### 5.4.2 WLAN reselection procedure
For WLAN access network reselection, the UE configured with a WLANSP rule
shall use the access network selection procedure as specified in subclause
5.3.2. The UE first uses WLAN Selection Policy (WLANSP) to determine the
active WLANSP rule. The UE selects the highest priority and valid WLANSP rule
as the active WLANSP rule.
The access network reselection procedure can be in automatic mode or manual
mode. The manual mode reselection shall follow the behaviour described in
subclause 5.3.2.3 and the automatic mode reselection shall follow the
behaviour described in subclause 5.3.2.4.
# 6 UE - 5GC network protocols
## 6.1 General
In this release of the specification, this subclause has been intentionally
left blank.
## 6.2 Untrusted Accesses
In this release of specification, only untrusted non-3GPP access is supported.
## 6.3 Authentication and authorization for accessing 5GS via an untrusted
non-3GPP access network
### 6.3.1 General
In order to register to the 5G core network (5GCN) via untrusted non-3GPP IP
access, the UE first needs to be configured with a local IP address from the
untrusted non-3GPP access network (N3AN).
Once the UE is configured with a local IP address, the UE shall select the
Non-3GPP InterWorking Function (N3IWF) as described in subclause 7.2 and shall
initiate the IKEv2 SA establishment procedure as described in subclause 7.3.
During the IKEv2 SA establishment procedure, authentication and authorization
for access to 5GCN is performed.
## 6.4 Handling of ANDSP Information
### 6.4.1 General
The Access Network Discovery & Selection policy (ANDSP) is used to control UE
behavior related to access network discovery and selection over non-3GPP
access network.
ANDSP consists of:
\- WLAN Selection Policy (WLANSP); and
\- Non-3GPP access network (N3AN) node configuration information.
The UE uses the WLANSP for selecting the WLAN access network.
NOTE: In this release of the specification, ANDSP contains configuration for
selecting a WLAN access network. Configuration for selecting other types of
non-3GPP access networks is not specified.
The UE uses the Non-3GPP access network (N3AN) node configuration information
for selecting a N3AN node (i.e. N3IWF or ePDG).
When roaming, the UE can receive ANDSP including WLANSP from H-PCF or V-PCF or
both. The ANDSP including N3AN node configuration information is provided by
H-PCF only. The UE shall ignore the N3AN node configuration information in the
ANDSP if the ANDSP is provided by V-PCF.
The structure and the content of ANDSP are defined in 3GPP TS 24.526 [17].
### 6.4.2 UE procedures
#### 6.4.2.1 General
When ANDSP is modified based on information received from network as specified
in 3GPP TS 24.501 [4] Annex D, the UE shall re-evalaute the ANDSP.
The received ANDSP information shall not impact the PLMN selection and
reselection procedures specified in 3GPP TS 23.122 [13].
The UE shall periodically re-evaluate ANDSP. The value of the periodic re-
evaluation timer is implementation dependant. The additional trigger for
(re‑)evaluating ANDSP is when the active WLANSP rule becomes invalid
(conditions no longer fulfilled), or other manufacturer specific trigger.
#### 6.4.2.2 Use of WLAN selection information
During automatic mode WLAN selection, the UE shall use the WLAN selection
policy (WLANSP) provided by PCF to determine the selected WLAN as described in
subclause 5.3:
#### 6.4.2.3 Use of N3AN node configuration information
If the UE accesses 5GCN via the non-3GPP access, the UE shall use the N3AN
node configuration information to select an N3AN node as described in
subclause 7.2, to be used for establishing IKEv2 security association as
described in subclause 7.3.
### 6.4.3 ANDSP information from the network
ANDSP information is provided by the network to the UE using the UE policy
delivery procedure described in Annex D of 3GPP TS 24.501 [4].
# 7 Security association management procedures
## 7.1 General
The purpose of the security association management procedures is to define the
procedures for establishment or disconnection of end-to-end security
association between the UE and the N3IWF via an IKEv2 protocol exchange
specified in IETF RFC 7296 [6]. The IKE SA and child signalling IPsec SA
establishment procedure is always initiated by the UE, whereas the child user
plane IPsec SA creation procedures shall be initiated by the N3IWF as
specified in 3GPP **TS 23.502 [3]**.
The UE selects an N3IWF according to the procedure in subclause 7.2. Once the
N3IWF has been selected, the security associations are established and managed
according to the procedures in subclause 7.3 to subclause 7.7.
If a non-3GPP access network does not support transport of IP fragments, the
maximum size of an IKEv2 message including the IP header is equal to the path
MTU between the UE and N3IWF.
EXAMPLE: If a non-3GPP access network is an IPv6 only network which does not
support transport of IP fragments and the path MTU between the UE and the
N3IWF is 1280 octets then the maximum size of an IKEv2 message including IP
header is 1280 octets.
## 7.2 N3AN node selection procedure
### 7.2.1 General
The UE performs N3AN node selection procedure based on the N3AN node
configuration information provisioned to the UE by the HPLMN and based on the
UE\'s knowledge of the country the UE is located in and the PLMN the UE is
registered to via 3GPP access.
### 7.2.2 N3AN node configuration information
The N3AN node configuration information is provisioned to the UE either by
H-PCF or via implementation specific means. The UE shall apply the N3AN node
configuration information provisioned via implementation specific means only
if the N3AN node configuration information provisioned by the H-PCF is not
present in the UE.
The N3AN node configuration information shall consist of the following:
\- N3AN node selection information;
\- optionally, home N3IWF identifier configuration; and
\- optionally, home ePDG identifier configuration.
The N3AN node selection information consists of N3AN node selection
information entries. Each N3AN node selection information entry contains a
PLMN ID and information for the PLMN ID. The N3AN node selection information
contains at least an N3AN node selection information entry with information
for the HPLMN and an N3AN node selection information entry for \"any_PLMN\".
The N3AN node configuration information provisioned by H-PCF is as specified
in 3GPP TS 24.501 [4] annex D and 3GPP TS 24.526 [17].
The UE shall support the implementation of standard DNS mechanisms in order to
retrieve the IP address(es) of the N3IWF or ePDG. The input to the DNS query
is an N3IWF FQDN or ePDG FQDN as specified in 3GPP TS 23.003 [8].
### 7.2.3 Determination of the country the UE is located in
If the UE cannot determine whether it is located in the home country or in a
visited country, as required by the N3AN node selection procedure, the UE
shall stop the N3AN node selection. Once the UE determines the country the UE
is located in, the UE shall proceed with N3AN node selection as specified in
subclause 7.2.4.
NOTE: It is out of scope of the present specification to define how the UE
determines whether it is located in the home country or in a visited country
or in a location that does not belong to any country. When the UE is in
coverage of a 3GPP RAT, it can, for example, use the information derived from
the available PLMN(s). In this case, the UE can match the MCC of the PLMN to
which a cell belongs, broadcast on the BCCH of the 3GPP access, against the
UE\'s IMSI to determine if they belong to the same country, as defined in 3GPP
TS 23.122 [13]. If the UE is not in coverage of a 3GPP RAT, the UE can use
other techniques, including user-provided location.
### 7.2.4 N3AN node selection
#### 7.2.4.1 General
When the UE supports connectivity with N3IWF but does not support connectivity
with ePDG, the UE shall perform the procedure in subclause 7.2.4.3 for
selecting an N3IWF.
When the UE supports connectivity with N3IWF and ePDG, the UE shall perform
the procedure in subclause 7.2.4.4 for selecting either an N3IWF or an ePDG.
#### 7.2.4.2 Determine if the visited country mandates the selection of N3IWF
in this country
In order to determine if the visited country mandates the selection of N3IWF
in this country, the UE shall perform the DNS NAPTR query using Visited
Country FQDN as specified in 3GPP TS 23.003 [8] via the non-3GPP access
network.
If the result of this query is:
\- a set of one or more records containing the service instance names of the
form \"_n3iwf.5gc.mnc\ .mcc\.pub.3gppnetwork.org_\", the UE shall
determine that the visited country mandates the selection of the N3IWF in this
country; and
NOTE: The (\, \) pair in each record represents PLMN Id (see 3GPP TS
23.003 [8]) in the visited country which can be used for N3IWF selection in
subclause 7.2.4.3 and subclause 7.2.4.4.
\- no records containing the service instance names of the form
\"_n3iwf.5gc.mnc\ .mcc\.pub.3gppnetwork.org_\", the UE shall
determine that the visited country does not mandate the selection of the N3IWF
in this country.
#### 7.2.4.3 UE procedure when the UE only supports connectivity with N3IWF
If the UE only supports connectivity with N3IWF and does not support
connectivity with ePDG, the UE shall ignore the following ePDG related
configuration parameters if available in the N3AN node configuration
information when selecting an N3IWF:
\- the home ePDG identifier configuration; and
\- the preference parameter in each N3AN node selection information entry in
the N3AN node selection information.
The UE shall proceed as follows:
a) if the UE is located in its home country:
1) if the N3AN node configuration information is provisioned:
i) if the home N3IWF identifier configuration is provisioned in the N3AN node
configuration information and contains an IP address, the UE shall use the IP
address of the home N3IWF identifier configuration as the IP address of the
N3IWF;
ii) if the home N3IWF identifier configuration is provisioned in the N3AN node
configuration information and does not contain an IP address, the UE shall use
the FQDN of the home N3IWF identifier configuration as the N3IWF FQDN; and
iii) if the home N3IWF identifier configuration is not provisioned in the N3AN
node configuration information, the UE shall construct an N3IWF FQDN based on
the FQDN format of the HPLMN\'s N3AN node selection information entry in the
N3AN node selection information using the PLMN ID of the HPLMN stored on the
USIM as specified in 3GPP TS 23.003 [8]; and
2) if the N3AN node configuration information is not provisioned on the UE,
the UE shall construct the N3IWF FQDN based on the Operator Identifier FQDN
format using the PLMN ID of the HPLMN stored on the USIM;
and for the above cases constructing or using an N3IWF FQDN, the UE shall use
the DNS server function to resolve the N3IWF FQDN to the IP address(es) of the
N3IWF(s). The UE shall select as the IP address of the N3IWF a resolved IP
address of an N3IWF with the same IP version as its local IP address; and
b) if the UE is not located in its home country:
1) if the N3AN node configuration information is provisioned and the UE is
registered to a VPLMN via 3GPP access:
i) if an N3AN node selection information entry for the VPLMN is available in
the N3AN node selection information of the N3AN node configuration
information, the UE shall construct an N3IWF FQDN based on FQDN format of the
VPLMN\'s N3AN node selection information entry in the N3AN node selection
information using the PLMN ID of the VPLMN as specified in 3GPP TS 23.003 [8];
and
ii) if an N3AN node selection information entry for the VPLMN is not available
in the N3AN node selection information of the N3AN node configuration
information, the UE shall construct an N3IWF FQDN based on the FQDN format of
the \'Any_PLMN\' N3AN node selection information entry in the N3AN node
selection information using the PLMN ID of the VPLMN as specified in 3GPP TS
23.003 [8];
and for the above cases, the UE shall use the DNS server function to resolve
the constructed N3IWF FQDN to the IP address(es) of the N3IWF(s). The UE shall
select as the IP address of the N3IWF a resolved IP address of an N3IWF with
the same IP version as its local IP address; and
2) if one of the following is true:
\- the UE is not registered to a PLMN via 3GPP access and the UE uses WLAN; or
\- the N3AN node configuration information is not provisioned;
the UE shall perform a DNS query (see 3GPP TS 23.003 [8]) as specified in
subclause 7.2.4.2 to determine if the visited country mandates the selection
of N3IWF in this country and:
i) if selection of N3IWF in visited country is mandatory:
A) if the UE is registered to a VPLMN via 3GPP access and the PLMN ID of VPLMN
is included in one of the returned DNS records, the UE shall construct an
N3IWF FQDN based on the Operator Identifier FQDN format using the PLMN ID of
the VPLMN in 3GPP access as described in 3GPP TS 23.003 [8]; and
B) if the UE is not registered to a PLMN via 3GPP access or the UE is
registered to a VPLMN via 3GPP access and the PLMN ID of VPLMN is not included
in any of the returned DNS records:
\- if the N3AN node configuration information is provisioned, the UE shall
select a PLMN included in the DNS response that has highest PLMN priority (see
3GPP TS 24.526 [17]) in the N3AN node selection information of the N3AN node
configuration information and the UE shall construct an N3IWF FQDN based on
the FQDN format of the selected PLMN\'s N3AN node selection information entry
in the N3AN node selection information using the PLMN ID of the selected PLMN
as specified in 3GPP TS 23.003 [8]; and
\- if the N3AN node configuration information is not provisioned or the N3AN
node selection information of the N3AN node configuration information does not
contain any of the PLMNs in the DNS response, selection of a PLMN of the
visited country is UE implementation specific. If the UE does not select a
PLMN, the UE shall terminate the N3AN node selection procedure. If the UE
selects a PLMN, the UE shall construct an N3IWF FQDN based on the Operator
Identifier FQDN format using the PLMN ID of the selected PLMN as described in
3GPP TS 23.003 [8];
and for the above cases, the UE shall use the DNS server function to resolve
the constructed N3IWF FQDN to the IP address(es) of the N3IWF(s). The UE shall
select as the IP address of the N3IWF a resolved IP address of an N3IWF with
the same IP version as its local IP address;
ii) if the DNS response contains no records, the UE shall further determine if
the visited country mandates the selection of ePDG in the visited country
using the procedure specified in subclause 7.2.1.4 of 3GPP TS 24.302 [7].
If the UE determines that the visited country mandates the selection of ePDG
in the visited country, the UE shall assume that the selection of N3IWF in the
visited country is mandatory and shall terminate the N3AN node selection
procedure.
\- If the UE determines that the visited country does not mandate the
selection of ePDG in the visited country, the UE shall assume that the
selection of N3IWF in the visited country is not mandatory, then the UE shall
proceed as below:
A) if the N3AN node configuration information is provisioned and the N3AN node
selection information of the N3AN node configuration information contains one
or more PLMNs in the visited country, the UE shall select a PLMN that has
highest PLMN priority (see 3GPP TS 24.526 [17]) in the N3AN node selection
information and the UE shall construct an N3IWF FQDN based on the FQDN format
of the selected PLMN\'s N3AN node selection information entry in the N3AN node
selection information as specified in 3GPP TS 23.003 [8] using the PLMN ID of
the selected PLMN; and
B) if the N3AN node configuration information is not provisioned or the N3AN
node configuration information is provisioned and the N3AN node selection
information of the N3AN node configuration information contains no PLMNs in
the visited country:
\- if the home N3IWF identifier configuration is provisioned in the N3AN node
configuration information (see 3GPP TS 24.526 [17]) and contains an IP
address, the UE shall use the IP address of the home N3IWF identifier
configuration as the IP address of the N3IWF;
\- if the home N3IWF identifier configuration is provisioned in the N3AN node
configuration information (see 3GPP TS 24.526 [17]) and does not contain an IP
address, the UE shall use the FQDN of the home N3IWF identifier configuration
as the N3IWF FQDN; and
\- if the home N3IWF identifier configuration is not provisioned in the N3AN
node configuration information, the UE shall construct an N3IWF FQDN based on
the Operator Identifier FQDN format using the PLMN ID of the HPLMN as
described in 3GPP TS 23.003 [8];
and for the above cases constructing or using an N3IWF FQDN, the UE shall use
the DNS server function to resolve the N3IWF FQDN to the IP address(es) of the
N3IWF(s). The UE shall select as the IP address of the N3IWF a resolved IP
address of an N3IWF with the same IP version as its local IP address; and
iii) if no DNS response is received, the UE shall terminate the N3AN node
selection procedure.
Following bullet a) and b) above, once the UE selected the IP address of the
N3IWF, the UE shall initiate the IKEv2 SA establishment procedure as specified
in subclause 7.3.
If the IKEv2 SA establishment procedure towards an N3IWF in the HPLMN fails
due to no response to an IKE_SA_INIT request message, and the selection of
N3IWF in the HPLMN is performed using home N3IWF identifier configuration and
there are more pre-configured N3IWFs in the HPLMN, the UE shall repeat the
tunnel establishment attempt using the next FQDN or IP address(es) of the
N3IWF in the HPLMN.
If the IKEv2 SA establishment procedure towards to any of the received IP
addresses of the selected N3IWF fails due to no response to an IKE_SA_INIT
request message, then the UE shall repeat the N3IWF selection as described in
this subclause, excluding the N3IWFs for which the UE did not receive a
response to the IKE_SA_INIT request message.
NOTE: The time the UE waits before reattempting access to another N3IWF or to
an N3IWF that it previously did not receive a response to an IKE_SA_INIT
request message, is implementation specific.
#### 7.2.4.4 UE procedure when the UE supports connectivity with N3IWF and
ePDG
##### 7.2.4.4.1 General
If the UE can support connectivity with N3IWF and with ePDG, the UE shall:
\- if the N3AN node selection is required for an IMS service, follow steps
specified in subclause 7.2.4.4.2 for N3AN node selection; and
\- if the N3AN node selection is required for a non-IMS service, follow steps
specified in subclause 7.2.4.4.3 for N3AN node selection.
NOTE: How the UE determines node selection is required for an IMS service or
for a non-IMS service is implementation-specific.
##### 7.2.4.4.2 N3AN node selection for IMS service
If the N3AN node selection is required for an IMS service, the UE shall use
the preference parameter in the N3AN node selection information entries of the
N3AN node selection information to determine whether selection of N3IWF or
ePDG is preferred in a given PLMN.
The UE shall proceed as follows:
a) if the UE is located in its home country:
1) if the N3AN node configuration information is provisioned:
i) if the preference parameter in the HPLMN\'s N3AN node selection information
entry of the N3AN node selection information indicates that N3IWF is
preferred:
A) if the home N3IWF identifier configuration is provisioned in the N3AN node
configuration information and contains an IP address, the UE shall use the IP
address of the home N3IWF identifier configuration as the IP address of the
N3IWF;
B) if the home N3IWF identifier configuration is provisioned in the N3AN node
configuration information and does not contain an IP address, the UE shall use
the FQDN of the home N3IWF identifier configuration as the N3IWF FQDN; and
C) if the home N3IWF identifier configuration is not provisioned in the N3AN
node configuration information, the UE shall construct an N3IWF FQDN based on
the FQDN format of the HPLMN\'s N3AN node selection information entry in the
N3AN node selection information using the PLMN ID of the HPLMN stored on the
USIM as specified in clause 28 of 3GPP TS 23.003 [8]; and
ii) if the preference parameter in the HPLMN\'s N3AN node selection
information entry of the N3AN node selection information indicates that ePDG
is preferred:
A) if the home ePDG identifier configuration is provisioned in the N3AN node
configuration information and contains an IP address, the UE shall use the IP
address of the home ePDG identifier configuration as the IP address of the
ePDG;
B) if the home ePDG identifier configuration is provisioned in the N3AN node
configuration information and does not contains an IP address, the UE shall
use the FQDN of the home ePDG identifier configuration as the ePDG FQDN; and
C) if the home ePDG identifier configuration is not provisioned in the N3AN
node configuration information, the UE shall construct an ePDG FQDN based on
the FQDN format of HPLMN\'s N3AN node selection information entry in the N3AN
node selection information using the PLMN ID of the HPLMN stored on the USIM
as specified in clause 19 of 3GPP TS 23.003 [8]; and
2) if the N3AN node configuration information is not provisioned on the UE,
the UE shall construct the N3IWF FQDN based on the Operator Identifier FQDN
format using the PLMN ID of the HPLMN stored on the USIM;
and for the above cases constructing or using an N3IWF FQDN or ePDG FQDN, the
UE shall use the DNS server function to resolve the N3IWF FQDN or ePDG FQDN to
the IP address(es) of the N3IWF(s) or ePDG(s). The UE shall select as the IP
address of the N3IWF or of the ePDG a resolved IP address of an N3IWF or an
ePDG with the same IP version as its local IP address; and
b) if the UE is not located in its home country:
1) if the N3AN node configuration information is provisioned and the UE is
registered to a VPLMN via 3GPP access:
i) if an N3AN node selection information entry for the VPLMN is available in
the N3AN node selection information of the N3AN node configuration
information:
A) if the preference parameter in the VPLMN\'s N3AN node selection information
entry of the N3AN node configuration information indicates that N3IWF is
preferred, the UE shall construct an N3IWF FQDN based on the FQDN format of
the VPLMN\'s N3AN node selection information entry in the N3AN node selection
information using the PLMN ID of the VPLMN as specified in clause 28 of 3GPP
TS 23.003 [8]; and
B) if the preference parameter in the VPLMN\'s N3AN node selection information
entry of the N3AN node configuration information indicates that ePDG is
preferred, the UE shall construct an ePDG FQDN based on the FQDN format of the
VPLMN\'s N3AN node selection information entry in the N3AN node selection
information using the PLMN ID of the VPLMN as specified in clause 19 of 3GPP
TS 23.003 [8]; and
ii) if an N3AN node selection information entry for the VPLMN is not available
in the N3AN node selection information of the N3AN node configuration
information:
A) if the preference parameter in the \'Any_PLMN\' N3AN node selection
information entry of the N3AN node configuration information indicates that
N3IWF is preferred, the UE shall construct an N3IWF FQDN based on the FQDN
format of the \'Any_PLMN\' N3AN node selection information entry in the N3AN
node selection information using the PLMN ID of the VPLMN as specified in
clause 28 of 3GPP TS 23.003 [8]; and
B) if the preference parameter in the \'Any_PLMN\' N3AN node selection
information entry of the N3AN node configuration information indicates that
ePDG is preferred, the UE shall construct an ePDG FQDN based on the FQDN
format of the \'Any_PLMN\' N3AN node selection information entry in the N3AN
node selection information using the PLMN ID of the VPLMN as specified in
clause 19 of 3GPP TS 23.003 [8];
and for above case, the UE shall use the DNS server function to resolve the
constructed N3IWF FQDN or ePDG FQDN to the IP address(es) of the N3IWF(s) or
ePDG(s). The UE shall select as the IP address of the N3IWF or the ePDG a
resolved IP address of an N3IWF or ePDG with the same IP version as its local
IP address; and
2) if one of the following is true:
\- the UE is not registered to a PLMN via 3GPP access and the UE uses WLAN; or
\- the N3AN node configuration information is not provisioned;
the UE shall perform a DNS query (see 3GPP TS 23.003 [8]) as specified in
subclause 7.2.4.2 to determine if the visited country mandates the selection
of N3IWF in this country and:
i) if selection of N3IWF in the visited country is mandatory:
A) if the UE is registered to a VPLMN via 3GPP access and the PLMN ID of VPLMN
is included in one of the returned DNS records, the UE shall construct an
N3IWF FQDN based on the Operator Identifier FQDN format using the PLMN ID of
the VPLMN as described in clause 28 of 3GPP TS 23.003 [8]; and
B) if the UE is not registered to a PLMN via 3GPP access or the UE is
registered to a VPLMN via 3GPP access and the PLMN ID of VPLMN is not included
in any of the returned DNS records:
\- if the N3AN node configuration information is provisioned, the UE shall
select an a PLMN included in the DNS response that has highest PLMN priority
(see 3GPP TS 24.526 [17]) in the N3AN node selection information of the N3AN
node configuration information and the UE shall construct an N3IWF FQDN based
on the FQDN format of the selected PLMN\'s N3AN node selection information
entry in the N3AN node selection information using the PLMN ID of the selected
PLMN as specified in clause 28 of 3GPP TS 23.003 [8]; and
\- if the N3AN node configuration information is not provisioned or the N3AN
node selection information of the N3AN node configuration information does not
contain any of the PLMNs in the DNS response, selection of the PLMN is UE
implementation specific. The UE shall construct an N3IWF FQDN based on the
Operator Identifier FQDN format using the PLMN ID of the selected PLMN as
described in clause 28 of 3GPP TS 23.003 [8];
and for the above cases, the UE shall use the DNS server function to resolve
the constructed N3IWF FQDN to the IP address(es) of the N3IWF(s). The UE shall
select as the IP address of the N3IWF a resolved IP address of an N3IWF with
the same IP version as its local IP address;
ii) if the DNS response contains no records, the UE shall further determine if
the visited country mandates the selection of ePDG in the visited country
using the procedure specified in subclause 7.2.1.4 of 3GPP TS 24.302 [7].
If the UE determines that the visited country mandates the selection of ePDG
in the visited country, the UE shall assume that the selection of N3IWF in the
visited country is mandatory and shall continue the ePDG selection procedure
in the visited country, specified in subclause 7.2.1.3 of 3GPP TS 24.302 [7].
If the UE determines that the visited country does not mandate the selection
of ePDG in the visited country, the UE shall assume that the selection of
N3IWF in the visited country is not mandatory and the UE shall proceed as
below:
A) if the N3AN node configuration information is provisioned and the N3AN node
selection information of the N3AN node configuration information contains one
or more PLMNs in the visited country, the UE shall select a PLMN that has
highest PLMN priority (see 3GPP TS 24.526 [17]) in the N3AN node selection
information and the UE shall construct an N3IWF FQDN based on the FQDN format
of the selected PLMN\'s N3AN node selection information entry in the N3AN node
selection information using the PLMN ID of the selected PLMN as specified in
clause 28 of 3GPP TS 23.003 [8]; and
B) if the N3AN node configuration information is not provisioned or the N3AN
node configuration information is provisioned and the N3AN node selection
information of the N3AN node configuration information contains no PLMN in the
visited country:
\- if the home N3IWF identifier configuration is provisioned in the N3AN node
configuration information (see 3GPP TS 24.526 [17]) and contains an IP
address, the UE shall use the IP address of the home N3IWF identifier
configuration as the IP address of the N3IWF;
\- if the home N3IWF identifier configuration is provisioned in the N3AN node
configuration information (see 3GPP TS 24.526 [17]) and does not contains an
IP address, the UE shall use the FQDN of the home N3IWF identifier
configuration as N3IWF FQDN; and
\- if the home N3IWF identifier configuration is not provisioned in the N3AN
node configuration information, the UE shall construct an N3IWF FQDN based on
the Operator Identifier FQDN format using the PLMN ID of the HPLMN as
described in clause 28 of 3GPP TS 23.003 [8];
and for the above cases constructing or using an N3IWF FQDN, the UE shall use
the DNS server function to resolve the N3IWF FQDN to the IP address(es) of the
N3IWF(s). The UE shall select as the IP address of the N3IWF a resolved IP
address of an N3IWF with the same IP version as its local IP address; and
iii) if no DNS response is received, the UE shall terminate the N3AN node
selection procedure.
Following bullet a) and b) above, once the UE selected the IP address of the
N3IWF or the ePDG:
a) if the IP address of N3IWF is selected, the UE shall:
i) initiate the IKEv2 SA establishment procedure as specified in subclause
7.3;
ii) if the IKEv2 SA establishment procedure towards an N3IWF in the HPLMN
fails due to no response to an IKE_SA_INIT request message or the UE is
informed during registration over non-3GPP access that the IMS voice over PS
session is not supported over non-3GPP access, and the selection of N3IWF in
the HPLMN is performed using home N3IWF identifier configuration and there are
more pre-configured N3IWFs in the HPLMN, repeat the tunnel establishment
attempt using the next FQDN or IP address(es) of the N3IWF in the HPLMN;
iii) if the IKEv2 SA establishment procedure towards any of the received IP
addresses of the selected N3IWF fails due to no response to an IKE_SA_INIT
request message or the UE is informed during registration over non-3GPP access
that the IMS voice over PS session is not supported over non-3GPP access,
attempt to select an ePDG in the same PLMN as specified in 3GPP TS 24.302 [7]
instead; and
iv) if the UE fails to connect to either N3IWF or ePDG in the same PLMN,
repeat the N3AN node selection as described in this subclause, excluding the
N3IWFs for which the UE did not receive a response to the IKE_SA_INIT request
message;
NOTE 1: The time the UE waits before reattempting access to another N3IWF or
to an N3IWF that it previously did not receive a response to an IKE_SA_INIT
request message, is implementation specific.
b) if the IP address of ePDG is selected, the UE shall:
i) initiate tunnel establishment as specified in 3GPP TS 24.302 [7];
ii) if tunnel establishment as specified in 3GPP TS 24.302 [7] towards an ePDG
in the HPLMN fails due to no response to an IKE_SA_INIT request message, and
the selection of ePDG in the HPLMN is performed using home ePDG identifier
configuration and there are more pre-configured ePDG in the HPLMN, repeat the
tunnel establishment attempt using the next FQDN or IP address(es) of the ePDG
in the HPLMN;
iii) if tunnel establishment as specified in 3GPP TS 24.302 [7] towards any of
the received IP addresses of the selected ePDG fails due to no response to an
IKE_SA_INIT request message, attempt to select an N3IWF in the same PLMN
instead; and
iv) if the UE fails to connect to either ePDG or N3IWF in the same PLMN,
repeat the N3AN node selection as described in this subclause, excluding the
ePDGs for which the UE did not receive a response to the IKE_SA_INIT request
message.
NOTE 2: The time the UE waits before reattempting access to another ePDG or to
an ePDG that it previously did not receive a response to an IKE_SA_INIT
request message, is implementation specific.
##### 7.2.4.4.3 N3AN node selection for Non-IMS service
If the N3AN node selection is required for a non-IMS service, the UE shall
ignore the preference parameter in the N3AN node selection information entries
of the N3AN node selection information.
The UE shall proceed as follows:
a) if the UE is located in its home country:
1) if the N3AN node configuration information is provisioned:
i) if the home N3IWF identifier configuration is provisioned in the N3AN node
configuration information and contains an IP address, the UE shall use the IP
address of the home N3IWF identifier configuration as the IP address of the
N3IWF;
ii) if the home N3IWF identifier configuration is provisioned in the N3AN node
configuration information and does not contain an IP address, the UE shall use
the FQDN of the home N3IWF identifier configuration as the N3IWF FQDN; and
iii) if the home N3IWF identifier configuration is not provisioned in the N3AN
node configuration information, the UE shall construct an N3IWF FQDN based on
the FQDN format of the HPLMN\'s N3AN node selection information entry in the
N3AN node selection information using the PLMN ID of the HPLMN stored on the
USIM as specified in clause 28 of 3GPP TS 23.003 [8]; and
2) if the N3AN node configuration information is not provisioned, the UE shall
construct the N3IWF FQDN based on the Operator Identifier FQDN format using
the PLMN ID of the HPLMN stored on the USIM;
and for the above cases constructing or using an N3IWF FQDN, the UE shall use
the DNS server function to resolve the N3IWF FQDN to the IP address(es) of the
N3IWF(s) or ePDG(s). The UE shall select as the IP address of the N3IWF a
resolved IP address of an N3IWF with the same IP version as its local IP
address; and
b) if the UE is not located in its home country:
1) if the N3AN node configuration information is provisioned and the UE is
registered to a VPLMN via 3GPP access:
i) if an N3AN node selection information entry for the VPLMN is available in
the N3AN node selection information of the N3AN node configuration
information, the UE shall construct an N3IWF FQDN based on the FQDN format of
the VPLMN\'s N3AN node selection information entry in the N3AN node selection
information using the PLMN ID of the VPLMN as specified in clause 28 of 3GPP
TS 23.003 [8]; and
ii) if an N3AN node selection information entry for the VPLMN is not available
in the N3AN node selection information of the N3AN node configuration
information, the UE shall construct an N3IWF FQDN based on the FQDN format of
the \'Any_PLMN\' N3AN node selection information entry in the N3AN node
selection information using the PLMN ID of the VPLMN as specified in clause 28
of 3GPP TS 23.003 [8]; and
and for above case, the UE shall use the DNS server function to resolve the
constructed N3IWF FQDN to the IP address(es) of the N3IWF(s). The UE shall
select as the IP address of the N3IWF a resolved IP address of an N3IWF with
the same IP version as its local IP address; and
2) if one of the following is true:
\- the UE is not registered to a PLMN via 3GPP access and the UE uses WLAN; or
\- the N3AN node configuration information is not provisioned;
the UE shall perform a DNS query (see 3GPP TS 23.003 [8]) as specified in
subclause 7.2.4.2 to determine if the visited country mandates the selection
of N3IWF in this country, and:
i) if selection of N3IWF in the visited country is mandatory:
A) if the UE is registered to a VPLMN via 3GPP access and the PLMN ID of VPLMN
is included in one of the returned DNS records, the UE shall construct an
N3IWF FQDN based on the Operator Identifier FQDN format using the PLMN ID of
the VPLMN as described in clause 28 of 3GPP TS 23.003 [8]; and
B) if the UE is not registered to a PLMN via 3GPP access or the UE is
registered to a VPLMN via 3GPP access and the PLMN ID of VPLMN is not included
in any of the returned DNS records:
\- if the N3AN node configuration information is provisioned, the UE shall
select an a PLMN included in the DNS response that has highest PLMN priority
(see 3GPP TS 24.526 [17]) in the N3AN node selection information of the N3AN
node configuration information and the UE shall construct an N3IWF FQDN based
on the FQDN format of the selected PLMN\'s N3AN node selection information
entry in the N3AN node selection information using the PLMN ID of the selected
PLMN as specified in clause 28 of 3GPP TS 23.003 [8]; and
\- if the N3AN node configuration information is not provisioned or the N3AN
node selection information of the N3AN node configuration information does not
contain any of the PLMNs in the DNS response, selection of the PLMN is UE
implementation specific. The UE shall construct an N3IWF FQDN based on the
Operator Identifier FQDN format using the PLMN ID of the selected PLMN as
described in clause 28 of 3GPP TS 23.003 [8];
and for the above cases, the UE shall use the DNS server function to resolve
the constructed N3IWF FQDN to the IP address(es) of the N3IWF(s). The UE shall
select as the IP address of the N3IWF a resolved IP address of an N3IWF with
the same IP version as its local IP address;
ii) if the DNS response contains no records, the UE shall further determine if
the visited country mandates the selection of ePDG in the visited country
using the procedure specified in subclause 7.2.1.4 of 3GPP TS 24.302 [7].
determines that the visited country mandates the selection of ePDG in the
visited country, the UE shall assume that the selection of N3IWF in the
visited country is mandatory and shall continue the ePDG selection procedure
in the visited country, specified in subclause 7.2.1.3 of 3GPP TS 24.302 [7].
If the UE determines that the visited country does not mandate the selection
of ePDG in the visited country, the UE shall assume that the selection of
N3IWF in the visited country is not mandatory and the UE shall proceed as
follows:
A) if the N3AN node configuration information is provisioned and the N3AN node
selection information of the N3AN node configuration information contains one
or more PLMNs in the visited country, the UE shall select a PLMN that has
highest PLMN priority (see 3GPP TS 24.526 [17]) in the N3AN node selection
information and the UE shall construct an N3IWF FQDN based on the FQDN format
of the selected PLMN\'s N3AN node selection information entry in the N3AN node
selection information using the PLMN ID of the selected PLMN as specified in
clause 28 of 3GPP TS 23.003 [8]; and
B) if the N3AN node configuration information is not provisioned or the N3AN
node configuration information is provisioned and the N3AN node selection
information of the N3AN node configuration information contains no PLMN in the
visited country:
\- if the home N3IWF identifier configuration is provisioned in the N3AN node
configuration information (see 3GPP TS 24.526 [17]) and contains an IP
address, the UE shall use the IP address of the home N3IWF identifier
configuration as the IP address of the N3IWF;
\- if the home N3IWF identifier configuration is provisioned in the N3AN node
configuration information (see 3GPP TS 24.526 [17]) and does not contains an
IP address, the UE shall use the FQDN of the home N3IWF identifier
configuration as N3IWF FQDN; and
\- if the home N3IWF identifier configuration is not provisioned in the N3AN
node configuration information, the UE shall construct an N3IWF FQDN based on
the Operator Identifier FQDN format using the PLMN ID of the HPLMN as
described in clause 28 of 3GPP TS 23.003 [8];
and for the above cases constructing or using an N3IWF FQDN, the UE shall use
the DNS server function to resolve the N3IWF FQDN to the IP address(es) of the
N3IWF(s). The UE shall select as the IP address of the N3IWF a resolved IP
address of an N3IWF with the same IP version as its local IP address; and
iii) if no DNS response is received, the UE shall terminate the N3AN node
selection procedure.
Following bullet a) and b) above, once the UE selected the IP address of the
N3IWF:
a) if the IP address of N3IWF is selected, the UE shall:
1) initiate the IKEv2 SA establishment procedure as specified in subclause
7.3;
2) if the IKEv2 SA establishment procedure towards an N3IWF in the HPLMN fails
due to no response to an IKE_SA_INIT request message, and the selection of
N3IWF in the HPLMN is performed using home N3IWF identifier configuration and
there are more pre-configured N3IWFs in the HPLMN, repeat the tunnel
establishment attempt using the next FQDN or IP address(es) of the N3IWF in
the HPLMN;
3) if the IKEv2 SA establishment procedure towards any of the IP addresses of
the N3IWF of the selected PLMN fails due to no response to an IKE_SA_INIT
request message, repeat the N3AN node selection as described in this subclause
with N3IWF of another PLMN; and
4) if the IKEv2 SA establishment procedure towards any of the received IP
addresses of the N3IWF of any fails due to no response to an IKE_SA_INIT
request message, attempt to select an ePDG as specified in 3GPP TS 24.302 [7]
and use tunnel establishment as specified in 3GPP TS 24.302 [7];
NOTE 1: The time the UE waits before reattempting access to another N3IWF or
to an N3IWF that it previously did not receive a response to an IKE_SA_INIT
request message, is implementation specific.
b) if the IP address of ePDG is selected, the UE shall:
i) initiate tunnel establishment as specified in 3GPP TS 24.302 [7];
ii) if tunnel establishment as specified in 3GPP TS 24.302 [7] towards an ePDG
in the HPLMN fails due to no response to an IKE_SA_INIT request message, and
the selection of ePDG in the HPLMN is performed using home ePDG identifier
configuration and there are more pre-configured ePDG in the HPLMN, repeat the
tunnel establishment attempt using the next FQDN or IP address(es) of the ePDG
in the HPLMN;
iii) if tunnel establishment as specified in 3GPP TS 24.302 [7] towards any of
the received IP addresses of the selected ePDG fails due to no response to an
IKE_SA_INIT request message, attempt to select an N3IWF in the same PLMN
instead; and
iv) if the UE fails to connect to either ePDG or N3IWF in the same PLMN,
repeat the N3AN node selection as described in this subclause, excluding the
ePDGs for which the UE did not receive a response to the IKE_SA_INIT request
message.
NOTE 2: The time the UE waits before reattempting access to another ePDG or to
an ePDG that it previously did not receive a response to an IKE_SA_INIT
request message, is implementation specific.
## 7.3 IKE SA establishment procedure
### 7.3.1 General
The purpose of this procedure is to establish a secure connection between the
UE and the N3IWF, which is used to securely exchange NAS signalling messages
between the UE and the AMF, via the N3IWF. The UE establishes a secure
connection by establishing an IKE SA and first child SA to the N3IWF. The IKE
SA and first child SA, called signalling IPsec SA, are created between the UE
and the N3IWF after the IKE_SA_INIT exchange and after the IKE_AUTH exchange
(see IETF RFC 7296 [6]). The signalling IPsec established is used to transfer
NAS signalling traffic. Additional child SAs (user plane IPsec SAs) can be
established between the UE and the N3IWF to transfer user-plane traffic (see
subclause 7.5).
Upon completion of the N3IWF selection procedure (subclause 7.2) the UE
initiates an IKE_SA_INIT exchange as specified in IETF RFC 7296 [6] (see step
2 in the registration procedure for untrusted non-3GPP access in 3GPP TS
23.502 [3]). Upon reception of the IKE_SA_INIT exchange the UE shall inform
the upper layers that the access stratum is established.
Upon establishment of the access stratum connection, the UE initiates IKE_AUTH
exchange (see IETF RFC 7296 [6]) with EAP-5G encapsulation, as specified in
subclause 7.3.2.
The UE encapsulates the initial NAS message and the AN parameters using the
EAP-5G procedure as described in subclause 7.3.3. The signalling IPsec SA is
established after completion of the EAP-5G procedure and IKE_AUTH exchange.
### 7.3.2 IKE SA and signalling IPsec SA establishment procedure
#### 7.3.2.1 IKE SA and signalling IPsec SA establishment initiation
The UE proceeds with the establishment of IKE SA and signalling IPsec SA with
the selected N3IWF by initiating an IKE_SA_INIT exchange according to IETF RFC
7296 [6].
The UE shall initiate an IKE_AUTH exchange as specified in IETF RFC 7296 [6]
to establish an IKE SA and first child SA (signalling IPsec SA). The UE shall
indicate the intention to use EAP by not including the AUTH payload in the
initial IKE_AUTH request message as specified in IETF RFC 7296 [6].
NOTE: The IKE_AUTH exchange is sent after the IKE_SA_INIT exchange. The UE has
already established the IKE_SA_INIT exchange after N3IWF selection has been
completed.
Upon reception of the IKE_AUTH request message without AUTH payload, the N3IWF
shall respond with an IKE_AUTH response message with an indication to start an
EAP-5G session that will be used to convey the initial NAS messages. The
EAP-5G procedure is described in subclause 7.3.3.
#### 7.3.2.2 IKE SA and signalling IPsec SA establishment accepted by the
network
If IKE SA and signalling IPsec SA establishment is accepted by the network,
the UE receives from the N3IWF an IKE_AUTH response message containing an EAP-
Success message (as shown in figure 7.3.2-1), which completes the EAP-5G
session. No further EAP-5G packets are exchanged.
The UE completes the IKE SA and signalling IPsec SA (first child SA)
establishment procedure by initiating an IKE_AUTH exchange including an AUTH
payload computed based on the N3IWF key as described in 3GPP TS 33.501 [5]. In
the IKE_AUTH request message the UE additionally includes:
\- the UE shall include the INTERNAL_IP4_ADDRESS attribute, the
INTERNAL_IP6_ADDRESS attribute, or both, indicating the type of IP address to
be used for the IP tunnels, in the CFG_REQUEST configuration payload. The
INTERNAL_IP4_ADDRESS attribute shall contain no value and the length field
shall be set to 0. The INTERNAL_IP6_ADDRESS attribute shall contain no value
and the length field shall be set to 0; and
\- if the UE supports IETF RFC 4555 [23], the UE may include the
MOBIKE_SUPPORTED notify payload as specified in IETF RFC 4555 [23].
The N3IWF shall include in the IKE_AUTH response message containing the AUTH
payload:
\- a single CFG_REPLY Configuration Payload including the INTERNAL_IP4_ADDRESS
attribute with an IPv4 address assigned to the UE, the INTERNAL_IP6_ADDRESS
attribute with an IPv6 address assigned to the UE, or both;
\- the NAS_IP4_ADDRESS notify payload with an N3IWF IPv4 address assigned to
transport of NAS messages, if the initial IKE_AUTH request message contained a
CFG_REQUEST configuration payload with the INTERNAL_IP4_ADDRESS attribute and
NAS messages are to be transmitted using IPv4 based inner IP tunnel;
\- the NAS_IP6_ADDRESS notify payload with an N3IWF IPv6 address assigned to
transport of NAS messages if the initial IKE_AUTH request message contained a
CFG_REQUEST configuration payload with the INTERNAL_IP6_ADDRESS attribute and
NAS messages are to be transmitted using IPv6 based inner IP tunnel;
\- the NAS_TCP_PORT notify payload with an N3IWF TCP port number assigned to
transport of NAS messages; and
\- the MOBIKE_SUPPORTED notify payload as specified in IETF RFC 4555 [23], if
the initial IKE_AUTH request message contained a MOBIKE_SUPPORTED
configuration payload with the INTERNAL_IP4_ADDRESS attribute.
The UE may support the TIMEOUT_PERIOD_FOR_LIVENESS_CHECK attribute as
specified in 3GPP TS 24.302 [7] subclause 8.2.4.2. If the UE supports the
TIMEOUT_PERIOD_FOR_LIVENESS_CHECK attribute, the UE shall include the
TIMEOUT_PERIOD_FOR_LIVENESS_CHECK attribute indicating support of receiving
timeout period for liveness check in the CFG_REQUEST configuration payload
within the IKE_AUTH request message.
The N3IWF may include the TIMEOUT_PERIOD_FOR_LIVENESS_CHECK attribute as
specified in 3GPP TS 24.302 [7] subclause 8.2.4.2 indicating the timeout
period for liveness check in the CFG_REPLY configuration payload of the
IKE_AUTH response message containing the AUTH payload. Presence of the
TIMEOUT_PERIOD_FOR_LIVENESS_CHECK attribute in the IKE_AUTH request can be
used as input for decision on whether to include the
TIMEOUT_PERIOD_FOR_LIVENESS_CHECK attribute in the IKE_AUTH response message
containing the AUTH payload.
If the TIMEOUT_PERIOD_FOR_LIVENESS_CHECK attribute as specified in 3GPP TS
24.302 [7] subclause 8.2.4.2 indicating the timeout period for the liveness
check is included in the CFG_REPLY configuration payload within the IKE_AUTH
response message containing the AUTH payload or the UE has a pre-configured or
configured timeout period, the UE shall perform the liveness check procedure
as described in subclause 7.8.
NOTE: The timeout period for liveness check is pre-configured in the UE in
implementation specific way.
This completes the establishment of the IKE SA and signalling IPsec SA between
the UE and the N3IWF. The UE and the N3IWF shall send further NAS messages
within the signalling IPsec SA (first child SA) (see example in figure
7.3.2.2-1).
An example of an IKE SA and first child SA establishment procedure is shown in
figure 7.3.2.2-1.
{width="5.2625in" height="5.857638888888889in"}
Figure 7.3.2.2-1: IKE SA and first child SA establishment procedure for UE
registration over non-3GPP access
#### 7.3.2.3 IKE SA and signalling IPsec SA establishment not accepted by the
network
If IKE SA and signalling IPsec SA establishment is not accepted by the
network, the UE receives from the N3IWF an IKE_AUTH response message including
a Notify payload with an error type.
Upon receiving the IKE_AUTH response message with a Notify payload with an
error type other than a CONGESTION Notify payload, the UE shall pass the error
indication to the upper layer along with the encapsulated NAS messages, if
any, within EAP/5G-NAS packet.
After the N3IWF receives from the UE an IKE_AUTH request message, if the N3IWF
does not accept the IKE SA and signalling IPsec SA establishment due to:
a) the AMF congestion as indicated in the OVERLOAD START message; or
b) the requested NSSAI included in the IKE_AUTH request message, only
including one or more S-NSSAIs indicated in the OVERLOAD START message;
where the OVERLOAD START message is specified in 3GPP TS 38.413 [29], the
N3IWF shall construct an IKE_AUTH response message including a CONGESTION
Notify payload as defined in subclause 9.2.4.2 and a N3GPP_BACKOFF_TIMER
Notify payload as defined in subclause 9.3.1.7. The N3IWF shall send the
IKE_AUTH response message to the UE.
Upon reception of the IKE_AUTH response message including:
a) a CONGESTION Notify payload as defined in subclause 9.2.4.2; and
b) a N3GPP_BACKOFF_TIMER Notify payload as defined in subclause 9.3.1.7; and
after the UE authenticates the network or the N3IWF as specified in 3GPP TS
33.501 [5], the UE shall discard all states associated with the IKE SA and any
child SAs that were negotiated using that IKE SA as specified in IETF RFC 7296
[6]. In addition, the UE shall inform the upper layers that the access stratum
connection has been released, and:
a) if the back-off timer value in N3GPP_BACKOFF_TIMER Notify payload indicates
neither zero nor deactivated, the UE shall start the Tw3 timer with the value
provided and the UE shall not retry the IKE SA and signalling IPsec SA
establishment procedure to the same N3IWF until:
\- timer Tw3 expires;
\- the UE is switched off; or
\- the UICC containing the USIM is removed;
b) if the back-off timer value in N3GPP_BACKOFF_TIMER Notify payload indicates
that this timer is deactivated, the UE shall not retry the IKE SA and
signalling IPsec SA establishment procedure to the same N3IWF until:
\- the UE is switched off; or
\- the UICC containing the USIM is removed; and
c) if the back-off timer value in N3GPP_BACKOFF_TIMER Notify payload indicates
zero, the UE may retry the IKE SA and signalling IPsec SA establishment
procedure to an N3IWF from the same PLMN.
Upon receiving the IKE_AUTH response message with a Notify payload with an
error type, if the EAP-5G session establishment has already been started, the
UE shall perform a local termination of the EAP-5G session.
### 7.3.3 EAP-5G session over non-3GPP access
#### 7.3.3.1 General
A vendor-specific EAP method (EAP-5G) is used to encapsulate NAS messages
between the UE and the N3IWF. The EAP-5G packets utilize the \"Expanded\" EAP
type and the existing 3GPP Vendor-Id registered with IANA under the SMI
Private Enterprise Code registry (i.e. 10415). The EAP-5G method is utilized
only for encapsulating NAS messages (not for authentication).
The UE and the N3IWF exchange EAP-5G messages within IKE_AUTH request and
IKE_AUTH response messages. The N3IWF on reception of an IKE_AUTH request with
no AUTH payload shall start an EAP-5G session by sending an EAP-
Request/5G-Start message.
The UE acknowledges start of the EAP-5G session by sending an EAP-
Response/5G-NAS message which shall include:
a) a NAS-PDU field that contains a NAS message, for example, a REGISTRATION
REQUEST message; and
b) an AN-parameters field that contains access network parameters, such as
GUAMI, selected PLMN ID, S-NSSAI, establishment cause, etc. (see 3GPP TS
23.502 [3]).
The N3IWF, on reception of NAS messages from the AMF, shall include the NAS
message within an EAP-Request/5G-NAS message. The EAP-Request/5G-NAS message
shall include:
a) a NAS-PDU field that contains a NAS message.
Further NAS messages between the UE and the AMF, via the N3IWF, shall be
inserted in NAS-PDU field of an EAP-Response/5G-NAS (UE to N3IWF direction)
and EAP-Request/5G-NAS (N3IWF to UE direction) message.
#### 7.3.3.2 EAP-5G session completion initiated by the network
Upon completion of successful authentication and on reception of the N3IWF key
from the AMF, the N3IWF shall complete the EAP-5G session by sending an EAP-
Success message.
On reception of the EAP-Success message from the N3IWF, the UE proceeds to
establish an IKE SA and signalling IPsec SA as described in subclause 7.3.2.
An example of an EAP-5G session after successful authentication is shown in
figure 7.3.3-1.
Figure 7.3.3.2-1: EAP-5G session for successful UE registration over non-3GPP
access
#### 7.3.3.3 EAP-5G session completion initiated by the UE
Upon receiving indication from the upper layer that no 5G-NAS messages need to
be transmitted between the UE and N3IWF, the UE shall terminate the EAP-5G
session by sending an EAP-Response/5G-Stop message to the N3IWF.
On reception of EAP-Response/5G-Stop message, the N3IWF shall complete the
EAP-5G session by sending an EAP-Failure message.
On reception of the EAP-Failure message from the N3IWF, the UE shall delete
any context related to IKE SA without requiring an explicit INFORMATIONAL
exchange carrying a Delete payload as specified in IETF RFC 7296 [6].
Figure 7.3.3.3-1 shows the EAP-5G session completion after registration
reject.
Figure 7.3.3.3-1: EAP-5G session when the UE\'s registration over non-3GPP
access is rejected
### 7.3.4 Abnormal cases in the UE
Apart from the cases specified in IETF RFC 7296 [6], no abnormal cases have
been identified.
### 7.3.5 Abnormal cases in the N3IWF
Apart from the cases specified in IETF RFC 7296 [6], no abnormal cases have
been identified.
## 7.4 IKEv2 SA deletion procedure
### 7.4.1 General
The purpose of the IKE SA deletion procedure via untrusted non-3GPP access is
to close the IKE SA between the UE and the N3IWF. In addition, deleting the
IKE SA implicitly closes any remaining signalling IPsec child SAs and user
plane IPsec child SAs associated with IKE SA.
This procedure shall be initiated either by the N3IWF or by the UE.
The N3IWF initiates this procedure in the following cases:
a) N1 NAS signalling connection release;
b) N3IWF-initiated IKE SA rekeying procedure failure;
c) N3IWF-initiated IKE SA rekeying procedure completion
d) upon receipt of an INITIAL_CONTACT notification as specified in IETF RFC
7296 [6]; and
e) upon detecting an error in a response packet as specified in IETF RFC 7296
[6].
The UE initiates this procedure in the following cases:
a) UE-initiated IKE SA rekeying procedure failure;
b) UE-initiated IKE SA rekeying procedure completion;
c) upon receipt of an INITIAL_CONTACT notification as specified in IETF RFC
7296 [6]; and
d) upon detecting an error in a response packet as specified in IETF RFC 7296
[6].
### 7.4.2 IKE SA deletion procedure initiated by the N3IWF
#### 7.4.2.1 IKE SA deletion initiation
The N3IWF shall initiate the IKE SA deletion procedure by sending an
INFORMATIONAL request message including a Delete payload to the UE as
specified in IETF RFC 7296 [6].
The Delete payload shall be defined with the Protocol ID set to \"1\" and no
SPIs included in the Security Parameter Index field in the Delete payload.
This indicates that the IKE security association and all IPsec ESP security
associations that were negotiated within it between the N3IWF and the UE shall
be deleted.
#### 7.4.2.2 IKE SA deletion accepted by the UE
Upon reception of the INFORMATIONAL request message from the N3IWF for
deletion of the IKE SA, if the UE accepts the IKE SA deletion request, the UE
shall send an empty INFORMATIONAL response message to the N3IWF as specified
in IETF RFC 7296 [6].
After sending the empty INFORMATIONAL response message, the UE shall close IKE
SA and delete all IPsec child SAs associated with the IKE SA. In addition, the
UE shall inform the upper layers that the access stratum connection has been
released.
Upon receiving the empty INFORMATIONAL response message, the N3IWF shall close
IKE SA and delete all IPsec child SAs associated with the IKE SA. In addition,
the N3IWF shall inform the AMF that the access stratum connection has been
released.
#### 7.4.2.3 Abnormal cases in the N3IWF
If the N3IWF does not receive any empty INFORMATIONAL response message from
the UE, the N3IWF shall discard all states associated with the IKE SA and any
child SAs that were negotiated using that IKE SA. In addition, the N3IWF shall
inform the AMF that the access stratum connection has been released.
### 7.4.3 IKE SA deletion procedure initiated by the UE
#### 7.4.3.1 IKE SA deletion initiation
The UE shall initiate the IKE SA deletion procedure by sending an
INFORMATIONAL request message including a Delete payload to the N3IWF as
specified in IETF RFC 7296 [6].
The Delete payload shall be defined with the Protocol ID set to \"1\" and no
SPIs included in the Security Parameter Index field in the Delete payload.
This indicates that the IKE security association and all IPsec ESP security
associations that were negotiated within it between the N3IWF and the UE shall
be deleted.
#### 7.4.3.2 IKE SA deletion accepted by the N3IWF
Upon reception of the INFORMATIONAL request message from the UE for deletion
of the IKE SA, if the N3IWF accepts the IKE SA deletion request, the N3IWF
shall send an empty INFORMATIONAL response message to the UE as specified in
IETF RFC 7296 [6].
After sending the empty INFORMATIONAL response message, the N3IWF shall close
the IKE SA and delete all IPsec child SAs associated with the IKE SA. In
addition, the N3IWF shall inform the AMF that the access stratum connection
has been released.
Upon receiving the empty INFORMATIONAL response message, the UE shall close
the IKE SA and delete all IPsec child SAs associated with the IKE SA. In
addition, the UE shall inform the upper layers that the access stratum
connection has been released.
#### 7.4.3.3 Abnormal cases in the UE
If the UE does not receive any empty INFORMATIONAL response message from the
N3IWF, the UE shall discard all states associated with the IKE SA and any
child SAs that were negotiated using that IKE SA. In addition, the UE shall
inform the upper layers that the access stratum connection has been released.
## 7.5 User plane IPsec SA creation procedure
### 7.5.1 General
The purpose of the user plane IPsec SA creation procedure is to establish a
Child SA associating to the QoS flows of the PDU session. This procedure shall
be initiated by the N3IWF.
One user plane IPsec SA can be associated with one or more QoS flows of the
PDU session. During PDU session establishment or PDU session modification via
untrusted non-3GPP access, the N3IWF shall determine the number of user plane
IPsec child SAs to establish and the QoS profiles associated with each Child
SA based on local policies, configuration and the QoS profiles received from
the network.
### 7.5.2 Child SA creation procedure initiation
The N3IWF shall initiate the Child SA creation procedure by sending a
CREATE_CHILD_SA request message to the UE as specified in IETF RFC 7296 [6].
The CREATE_CHILD_SA request message shall include:
a) a UP_IP4_ADDRESS notify payload or a UP_IP6_ADDRESS notify payload; and
b) 5G_QOS_INFO Notify payload as specified in subclause 9.3.1.1, which
contains:
1) PDU session ID;
2) zero or more QFIs;
3) optionally a DSCP value; and
4) optionally an indication of whether the child SA is the default child SA.
For a given PDU session ID, there can be only up to one child SA which is the
default child SA.
The IKE Create_Child_SA request also contains the SA payload for the requested
Child SA.
### 7.5.3 Child SA creation procedure accepted by the UE
If the UE accepts the CREATE_CHILD_SA request message with a 5G_QOS_INFO
Notify payload:
a) the UE shall send a CREATE_CHILD_SA response message as specified in IETF
RFC 7296 [6]; and
b) the UE shall associate the created child SA with the PDU session ID, the
zero or more QFIs (if indicated), the DSCP value (if indicated) and the
indication of whether the child SA is the default child SA (if indicated) in
the 5G_QOS_INFO Notify payload.
Any IKEv2 Notify payload indicating an error shall not be included in the
CREATE_CHILD_SA response message.
### 7.5.4 Child SA creation procedure not accepted by the UE
If a user plane IPsec SA establishment for a PDU session is not accepted by
the UE, the UE shall send a CREATE_CHILD_SA response message to the N3IWF with
a Notify payload with error type.
Upon receiving the CREATE_CHILD_SA response message with a Notify payload of
error type:
\- if PDU session establishment over non-3GPP access requires single user
plane SA IPsec SA creation, the N3IWF shall stop user plane SA IPsec SA
creation procedure and indicate the failure for PDU session establishment over
non-3GPP access.
\- if PDU session establishment over non-3GPP access requires multiple user
plane SA IPsec SA creation, the N3IWF may choose to continue user plane SA
IPsec SA creation procedure for other user plane IPsec SAs, or stop user plane
SA IPsec SA creation procedure and indicate the failure for PDU session
establishment over non-3GPP access.
If the CREATE_CHILD_SA request message contains a USE_TRANSPORT_MODE
notification, the UE shall decline the request by not including
USE_TRANSPORT_MODE notification as specified in IETF RFC 7296 [6].
### 7.5.5 Abnormal cases in the UE
Apart from the cases specified in IETF RFC 7296 [6], no abnormal cases have
been identified.
### 7.5.6 Abnormal cases in the N3IWF
Apart from the cases specified in IETF RFC 7296 [6], no abnormal cases have
been identified.
## 7.6 IPsec SA modification procedure
### 7.6.1 General
The user plane IPsec child SA modification procedure is to update a child SA
associating to the QoS flows of the PDU session. The procedure may be
initiated by the N3IWF. The IPsec child SA modification may be accepted or
rejected by the UE.
### 7.6.2 N3IWF procedure for IPsec child SA modification
The N3IWF shall perform the IPsec child SA modification by sending an
INFORMATIONAL request message as specified in IETF RFC 7296 [6] to the UE with
an 5G_QOS_INFO Notify payload indicating modified content associated with the
IPsec child SA.
### 7.6.3 UE procedure for IPsec child SA modification
Upon receipt of an INFORMATIONAL request message containing an 5G_QOS_INFO
Notify payload:
a) if the content of the 5G_QOS_INFO Notify payload is accepted by the UE, the
UE shall:
i) send an empty INFORMATIONAL response message to the N3IWF to acknowledge
the reception of the INFORMATIONAL request message; and
ii) update locally the IPsec child SA according to the content of the
INFORMATIONAL request message; or
b) if the content of the 5G_QOS_INFO Notify payload is not accepted by the UE,
the UE shall:
i) send the reason for rejecting the IPsec SA modification in the content of
an INFORMATIONAL response message; and
ii) not update locally the IPsec child SA according to the content of the
INFORMATIONAL request message.
## 7.7 IPSec SA deletion procedure
### 7.7.1 General
The purpose of the child SA deletion procedure for PDU session release is to
delete all the child SAs associated with the PDU session. This procedure shall
be initiated either by the N3IWF or by the UE.
The N3IWF initiates this procedure in the following cases:
a) upon PDU session release;
b) N3IWF-initiated IPsec SA rekeying procedure failure;
c) N3IWF-initiated IPsec SA rekeying procedure completion
d) upon detecting an error in a response packet as specified in IETF RFC 7296
[6].
The UE initiates this procedure in the following cases:
a) UE-initiated IPsec SA rekeying procedure failure;
b) UE-initiated IPsec SA rekeying procedure completion;
c) upon detecting an error in a response packet as specified in IETF RFC 7296
[6].
### 7.7.2 N3IWF-initated child SA deletion procedure
#### 7.7.2.1 N3IWF-initiated child SA deletion procedure initiation
The N3IWF shall initiate the child SA deletion procedure by sending an
INFORMATIONAL request message including a Delete payload to the UE as
specified in IETF RFC 7296 [6]. The Delete payload shall include:
a) the Protocol ID set to \"3\" for ESP; and
b) all the N3IWF\'s ESP Security Parameter Index(es) associated to the
released PDU session.
#### 7.7.2.2 N3IWF-initiated child SA deletion procedure accepted by the UE
If the UE accepts the INFORMATIONAL request message for deletion of the child
SAs, the UE shall send the INFORMATIONAL response message to the N3IWF
including the Delete payload received in the corresponding INFORMATIONAL
request message as specified in IETF RFC 7296 [6].
Any IKEv2 Notify payload indicating an error shall not be included in the
INFORMATIONAL response message.
#### 7.7.2.3 Abnormal cases in the N3IWF
If the N3IWF does not receive any INFORMATIONAL response message including a
Delete payload from the UE, the N3IWF shall discard all states associated with
the IKE SA and any child SAs that were negotiated using that IKE SA. In
addition, the N3IWF shall inform the AMF that the access stratum connection
has been released.
### 7.7.3 UE-initiated child SA deletion procedure
#### 7.7.3.1 UE-initiated child SA deletion procedure initiation
The UE shall initiate the child SA deletion procedure by sending an
INFORMATIONAL request message including a Delete payload to the N3IWF as
specified in IETF RFC 7296 [6]. The Delete payload shall include:
a) the Protocol ID set to \"3\" for ESP; and
b) all the UE\'s ESP Security Parameter Index(es) associated to the released
PDU session.
#### 7.7.3.2 UE-initiated child SA deletion procedure accepted by the N3IWF
If the N3IWF accepts the INFORMATIONAL request message for deletion of the
child SAs, the N3IWF shall send the INFORMATIONAL response message to the UE
including the Delete payload received in the corresponding INFORMATIONAL
request message as specified in IETF RFC 7296 [6].
Any IKEv2 Notify payload indicating an error shall not be included in the
INFORMATIONAL response message.
#### 7.7.3.3 Abnormal cases in the UE
If the UE does not receive any INFORMATIONAL response message including a
Delete payload from the N3IWF, the UE shall discard all states associated with
the IKE SA and any child SAs that were negotiated using that IKE SA. In
addition, the UE shall inform the upper layers that the access stratum
connection has been released.
### 7.7.4 Abnormal cases in the UE
Apart from the cases specified in IETF RFC 7296 [6] and subclause 7.7.3.3, no
abnormal cases have been identified.
### 7.7.5 Abnormal cases in the N3IWF
Apart from the cases specified in IETF RFC 7296 [6] and subclause 7.7.2.3, no
abnormal cases have been identified.
## 7.8 UE-initiated liveness check procedure
### 7.8.1 General
The UE-initiated liveness check procedure enables the UE to detect whether the
N3IWF is alive.
### 7.8.2 UE-initiated liveness check procedure initiation
If the UE supports the TIMEOUT_PERIOD_FOR_LIVENESS_CHECK attribute as
specified in 3GPP TS 24.302 [7] subclause 8.2.4.2 and the
TIMEOUT_PERIOD_FOR_LIVENESS_CHECK attribute as specified in 3GPP TS 24.302 [7]
subclause 8.2.4.2 was included in the CFG_REPLY configuration payload within
the IKE_AUTH response message received in subclause 7.3 the UE shall set the
timeout period for the liveness check to the value of the
TIMEOUT_PERIOD_FOR_LIVENESS_CHECK attribute.
If the UE does not support the TIMEOUT_PERIOD_FOR_LIVENESS_CHECK attribute as
specified in 3GPP TS 24.302 [7] subclause 8.2.4.2 or the
TIMEOUT_PERIOD_FOR_LIVENESS_CHECK attribute as specified in 3GPP TS 24.302 [7]
subclause 8.2.4.2 was not included in the CFG_REPLY configuration payload
within the IKE_AUTH response message received in subclause 7.3, then the UE
shall use the pre-configured value of the timeout period for liveness check.
NOTE: The timeout period is pre-configured in the UE in implementation-
specific way.
If the UE has not received any cryptographically protected IKEv2 or IPSec
message for the duration of the timeout period for liveness check, the UE
shall send an INFORMATIONAL request with no payloads as per IETF RFC 7296 [6].
### 7.8.3 UE-initiated liveness check procedure completion
The N3IWF shall handle the INFORMATIONAL request with no payloads as per IETF
RFC 7296 [6] and shall send an INFORMATIONAL response.
If an INFORMATIONAL response is received, the UE shall consider the UE-
initiated liveness check procedure as successfully completed.
### 7.8.4 Abnormal cases
If an INFORMATIONAL response is not received, the UE shall deem the IKEv2
security association to have failed.
The UE shall discard all states associated with the IKE SA and any child SAs
that were negotiated using that IKE SA as specified in IETF RFC 7296 [6]. In
addition, the UE shall inform the upper layers that the access stratum
connection has been released.
## 7.9 Network-initiated liveness check procedure
### 7.9.1 General
The network-initiated liveness check procedure enables the N3IWF to detect
whether the UE is alive.
### 7.9.2 Network-initiated liveness check procedure initiation
If the N3IWF has not received any cryptographically protected IKEv2 or IPSec
message for the duration of the timeout period for liveness check selected
according to the local policy, the N3IWF shall send an INFORMATIONAL request
with no payloads IETF RFC 7296 [6].
### 7.9.3 Network-initiated liveness check procedure completion
The UE shall handle the INFORMATIONAL request with no payloads as per IETF RFC
7296 [6] and shall send an INFORMATIONAL response.
If an INFORMATIONAL response is received, the N3IWF shall consider the
liveness check procedure as successfully completed.
### 7.9.4 Abnormal cases
If an INFORMATIONAL response is not received, the N3IWF shall deem the IKEv2
security association to have failed.
The N3IWF shall discard all states associated with the IKE SA and any child
SAs that were negotiated using that IKE SA as specified in IETF RFC 7296 [6].
In addition, the N3IWF shall inform the AMF that the access stratum connection
has been released.
## 7.10 IKE SA rekeying procedure
### 7.10.1 General
The N3IWF and the UE may support the IKE SA rekeying procedure as specified in
IETF RFC 7296 [6]. If the N3IWF and the UE support the IKE SA rekying
procedure, the UE and the N3IWF shall proactively rekey the IKE SA. Upon
rekeying of an IKE SA, the UE and the N3IWF shall maintain the old SA for the
incoming data while establishing the new one. The old SA shall be deleted upon
the completion of the establishement of the new one by both the UE and the
N3IWF. The UE and the N3IWF are separately responsible for enforcing their
time expiration policies to rekey the SA when needed. IETF RFC 7296 [6]
describes how to avoid the simultaneous IPsec SA and IKE SA rekeying.
### 7.10.2 N3IWF-initiated IKE SA rekeying procedure
#### 7.10.2.1 N3IWF-initiated IKE SA rekeying procedure initiation
The N3IWF shall initiate the IKE SA rekeying procedure by sending a
CREATE_CHILD_SA request message with a REKEY_SA Notify payload indicating an
N3IWF\'s SPI.
#### 7.10.2.2 N3IWF-initiated IKE SA rekeying procedure completion
Upon reception of the CREATE_CHILD_SA request message in the IKE SA with a
REKEY_SA Notify payload indicating an N3IWF\'s SPI, if the UE accepts the IKE
SA rekeying request, the UE shall send a CREATE_CHILD_SA response message
without an IKEv2 notify payload indicating an error, shall set the UE\'s SPI
to the SPI created by the CREATE_CHILD_SA request/response pair and shall set
the N3IWF\'s SPI to the N3IWF's SPI created by the CREATE_CHILD_SA
request/response pair.
#### 7.10.2.3 Abnormal cases
If the N3IWF receives a CREATE_CHILD_SA response message with an IKEv2 notify
payload indicating an error from the UE, the N3IWF shall delete the IKE SA and
any associated child SAs as specified in subclause 7.4.
If the N3IWF does not receive any CREATE_CHILD_SA response message from the
UE, the N3IWF shall discard all states associated with the IKE SA and any
child SAs that were negotiated using that IKE SA. In addition, the N3IWF shall
inform the AMF that the access stratum connection has been released.
### 7.10.3 UE-initiated IKE SA rekeying procedure
#### 7.10.3.1 UE-initiated IKE SA rekeying procedure initiation
The UE shall initiate the IKE SA rekeying procedure by sending a
CREATE_CHILD_SA request message with a REKEY_SA Notify payload indicating a
UE\'s SPI.
#### 7.10.3.2 UE-initiated IKE SA rekeying procedure completion
Upon reception of the CREATE_CHILD_SA request message in the IKE SA with a
REKEY_SA Notify payload indicating a UE\'s SPI, if the N3IWF accepts the IKE
SA rekeying request, the N3IWF shall send a CREATE_CHILD_SA response message
without an IKEv2 notify payload indicating an error, shall set the N3IWF\'s
SPI to the SPI created by the CREATE_CHILD_SA request/response pair and shall
set the UE\'s SPI to the UE\'s SPI created by the CREATE_CHILD_SA
request/response pair.
#### 7.10.3.3 Abnormal cases
If the UE receives a CREATE_CHILD_SA response message with an IKEv2 notify
payload indicating an error from the N3IWF, the UE shall delete the IKE SA and
any associated child SAs as specified in subclause 7.4.
If the UE does not receive any CREATE_CHILD_SA response message from the
N3IWF, the UE shall discard all states associated with the IKE SA and any
child SAs that were negotiated using that IKE SA. In addition, the UE shall
inform the upper layers that the access stratum connection has been released.
## 7.11 IPsec SA rekeying procedure
### 7.11.1 General
The N3IWF and the UE may support the IPsec SA rekeying procedure as specified
in IETF RFC 7296 [6]. If the N3IWF and the UE support the IPsec SA rekying
procedure, the UE and the N3IWF shall proactively rekey the IPsec SA. Upon
rekeying of an IPsec SA, the UE and the N3IWF shall maintain the old IP sec
for the incoming data while establishing the new one. The old IPsec shall be
deleted upon the completion of the establishement of the new one by both the
UE and the N3IWF. The UE and the N3IWF are separately responsible for
enforcing their time expiration policies to rekey the IPsec when needed. IETF
RFC 7296 [6] describes how to avoid the simultaneous IPsec SA and IKE SA
rekeying.
### 7.11.2 N3IWF-initiated IPsec SA rekeying procedure
#### 7.11.2.1 N3IWF-initiated IPsec SA rekeying procedure initiation
The N3IWF shall initiate the IPsec SA rekeying procedure by sending a
CREATE_CHILD_SA request message with a REKEY_SA Notify payload including a
Protocol ID set to \"3\" and the N3IWF\'s ESP SPI for the IPsec SA.
#### 7.11.2.2 N3IWF-initiated IPsec SA rekeying procedure completion
Upon reception of the CREATE_CHILD_SA request message with a REKEY_SA Notify
payload including a Protocol ID set to \"3\" and the N3IWF\'s ESP SPI for the
IPsec SA, if the UE accepts the IPsec SA rekeying request, the UE shall send a
CREATE_CHILD_SA response message without an IKEv2 notify payload indicating an
error, shall set the UE\'s ESP SPI to the ESP SPI created by the
CREATE_CHILD_SA request/response pair and shall set the N3IWF\'s ESP SPI to
the N3IWF\'s ESP SPI created by the CREATE_CHILD_SA request/response pair.
#### 7.11.2.3 Abnormal cases
If the N3IWF receives a CREATE_CHILD_SA response message with an IKEv2 notify
payload indicating an error from the UE, the N3IWF shall delete the IPsec SA
as specified in subclause 7.7. Additionally, if the IPsec SA is the signalling
IPsec SA, the N3IWF shall delete the IKE SA as specified in subclause 7.4.
If the N3IWF does not receive any CREATE_CHILD_SA response message from the
UE, the N3IWF shall discard all states associated with the IKE SA and any
child SAs that were negotiated using that IKE SA. In addition, the N3IWF shall
inform the AMF that the access stratum connection has been released.
### 7.11.3 UE-initiated IPsec SA rekeying procedure
#### 7.11.3.1 UE-initiated IPsec SA rekeying procedure initiation
The UE shall initiate the IPsec SA rekeying procedure by sending a
CREATE_CHILD_SA request message with a REKEY_SA Notify payload including a
Protocol ID set to \"3\" and the UE\'s ESP SPI for the IPsec SA.
#### 7.11.3.2 UE-initiated IPsec SA rekeying procedure completion
Upon reception of the CREATE_CHILD_SA request message with a REKEY_SA Notify
payload including a Protocol ID set to \"3\" and the UE\'s ESP SPI for the
IPsec SA, if the N3IWF accepts the IPsec SA rekeying request, the N3IWF shall
send a CREATE_CHILD_SA response message without an IKEv2 notify payload
indicating an error, shall set the N3IWF\'s ESP SPI to the ESP SPI created by
the CREATE_CHILD_SA request/response pair and shall set the UE\'s ESP SPI to
the UE\'s ESP SPI created by the CREATE_CHILD_SA request/response pair.
#### 7.11.3.3 Abnormal cases
If the UE receives a CREATE_CHILD_SA response message with an IKEv2 notify
payload indicating an error from the N3IWF, the UE shall delete the IPsec SA
as specified in subclause 7.7. Additionally, if the IPsec SA is the signalling
IPsec SA, the UE shall delete the IKE SA as specified in subclause 7.4.
If the UE does not receive any CREATE_CHILD_SA response message from the
N3IWF, the UE shall discard all states associated with the IKE SA and any
child SAs that were negotiated using that IKE SA. In addition, the UE shall
inform the upper layers that the access stratum connection has been released.
# 8 Message transport procedures
## 8.1 General
The sub-clause provides general overview of message encapsulation procedures
for non-3GPP access.
## 8.2 Transport of NAS messages over control plane
### 8.2.1 General
After the completion of IKE SA and establishment of signalling IPsec SA as
specified in subclause 7.3, the UE establishes with the N3IWF a TCP connection
for transport of NAS messages over the inner IP layer and the signalling IPsec
SA via an untrusted non-3GPP access network as specified in subclause 8.2.3.
Once the TCP connection for transport of NAS messages is established, the UE
performs NAS procedures over the TCP connection for transport of NAS messages.
All uplink and downlink NAS mobility management messages and NAS session
management messages are relayed between the UE and the AMF via N3IWF using the
TCP connection for transport of NAS messages as specified in subclause 8.2.4.
When the TCP connection for transport of NAS messages is no longer needed, the
UE or the N3IWF release the TCP connection as specified in subclause 8.2.5.
### 8.2.2 TCP packet encapsulation
NOTE 1: This subclause is used for encapsulating of TCP packets when
establishing TCP connection as described in subclause 8.2.3, when transporting
NAS messages over TCP connection as described in subclause 8.2.4, and when
releasing TCP connection as described in subclause 8.2.5.
If a TCP packet is transported between the UE and the N3IWF, and:
a) if the IKE_AUTH response message contained the INTERNAL_IP4_ADDRESS
attribute and the NAS_IP4_ADDRESS notify payload in subclause 7.3.2, an inner
IPv4 datagram shall be constructed where:
1) the TCP packet shall be encapsulated in the inner IPv4 datagram with IPv4
header where:
A) if the UE constructs the inner IPv4 datagram:
\- the source address field shall be set to the IPv4 address in the
INTERNAL_IP4_ADDRESS attribute;
\- the destination address field shall be set to the IPv4 address in the
NAS_IP4_ADDRESS notify payload; and
\- the destination port number shall be set to the NAS_TCP_PORT notify
payload;
B) if the N3IWF constructs the inner IPv4 datagram:
\- the source address field shall be set to the IPv4 address in the
NAS_IP4_ADDRESS notify payload;
\- the source port number shall be set to the NAS_TCP_PORT notify payload;
\- the destination address field shall be set to the IPv4 address in the
INTERNAL_IP4_ADDRESS attribute; and
\- the destination port number shall be set to the UE\'s TCP port number; and
NOTE 2: Since the UE always initiates the NAS message exchange with the N3IWF,
the N3IWF receives the UE\'s TCP port number in the TCP SYN packet exchange
and uses it when sending NAS messages towards the UE.
C) the protocol field shall be set to 06H;
2) the inner IPv4 datagram shall be protected employing the ESP protocol in
tunnel mode as specified in IETF RFC 4303 [11] where:
A) the SPI field in the ESP packet shall be set to the SPI of the signalling
IPsec SA; and
B) the next header field in the ESP packet shall be set to 04H; and
3) the IP packet encapsulating the ESP protected inner IPv4 datagram shall be
sent to the peer for the SPI of the signalling IPsec SA; or
b) if the IKE_AUTH response message contained the INTERNAL_IP6_ADDRESS
attribute and the NAS_IP6_ADDRESS notify payload in subclause 7.3.2, an inner
IPv6 datagram shall be constructed where:
1) the TCP packet shall be encapsulated in the inner IPv6 datagram with IPv6
header where:
A) if the UE constructs the inner IPv6 datagram:
\- the source address field shall be set to the IPv6 address in the
INTERNAL_IP6_ADDRESS attribute;
> \- the source port number shall be set to the UE\'s TCP port number;
\- the destination address field shall be set to the IPv6 address in the
NAS_IP6_ADDRESS notify payload; and
\- the destination port number shall be set to the NAS_TCP_PORT notify
payload;
B) if the N3IWF constructs the inner IPv6 datagram:
\- the source address field shall be set to the IPv6 address in the
NAS_IP6_ADDRESS notify payload;
> \- the source port number shall be set to the NAS_TCP_PORT notify payload;
\- the destination address field shall be set to the IPv6 address in the
INTERNAL_IP6_ADDRESS attribute; and
\- the destination port number shall be set to the UE\'s TCP port number; and
NOTE 3: Since the UE always initiates the NAS message exchange with the N3IWF,
the N3IWF receives the UE\'s TCP port number in the TCP SYN packet exchange
and uses it when sending NAS messages towards the UE.
C) the next header field shall be set to 06H;
2) the inner IPv6 datagram shall be protected employing the ESP protocol in
tunnel mode as specified in IETF RFC 4303 [11] where:
A) the SPI field in the ESP packet shall be set to the SPI of the signalling
IPsec SA; and
B) the next header field in the ESP packet shall be set to 29H, and
3) the IP packet encapsulating the ESP protected inner IPv6 datagram shall be
sent to the peer for the SPI of the signalling IPsec SA.
If the UE receives an IKE_AUTH response message containing both
NAS_IP4_ADDRESS and NAS_IP6_ADDRESS notify payload, the UE:
a) shall select and use either NAS_IP4_ADDRESS or NAS_IP6_ADDRESS;
b) shall not switch between NAS_IP4_ADDRESS and NAS_IP6_ADDRESS for TCP packet
transport during the lifetime of the IKE SA; and
c) shall not switch between NAS_IP4_ADDRESS and NAS_IP6_ADDRESS when rekeying
any child SA or IKE SA.
The ESP packet format is shown in figure 8.2.2-1 and figure 8.2.2-2:
* * *
Bits  
8 7 6 5 4 3 2 1 Octets Security Parameters Index (SPI) 1-4  
Sequence Number 5-8  
Payload data (inner IP packet containing TCP packet) 9-m  
Padding (m+1) - n  
Padding length n+1  
Next header n+2  
Integrity Check Value (ICV) (n+2) - x
* * *
Figure 8.2.2-1: ESP packet format for TCP packet establishing or releasing TCP
connection
* * *
Bits  
8 7 6 5 4 3 2 1 Octets Security Parameters Index (SPI) 1-4  
Sequence Number 5-8  
Payload data (inner IP packet containing TCP packet encapsulating NAS message
or partial NAS message) 9-m  
Padding (m+1) - n  
Padding length n+1  
Next header n+2  
Integrity Check Value (ICV) (n+2) - x
* * *
Figure 8.2.2-2: ESP packet format for TCP packet encapsulating NAS message or
partial NAS message
### 8.2.3 Establishment of TCP connection for transport of NAS messages
For transport of NAS messages, the UE shall initiate establishment of a TCP
connection as defined in IETF RFC793 [27]. The UE and the N3IWF shall
construct and transport TCP packets according to subclause 8.2.2.
### 8.2.4 Transport of NAS messages over TCP connection
In order to transport a NAS message over the non-3GPP access between the UE
and the N3IWF:
a) the NAS message shall be framed in a NAS message envelope as defined in
subclause 9.4;
b) the NAS message envelope shall be transported as a payload of one or more
TCP packets using the TCP connection; and
c) the UE and the N3IWF shall transport the one or more TCP packets
encapsulating the NAS message envelope according to subclause 8.2.2.
### 8.2.5 Release of TCP connection for transport of NAS messages
In order to release the TCP connection for transport of NAS messages, the UE
or the N3IWF shall initiate release of the TCP connection as defined in IETF
RFC 793 [27]. The UE and the N3IWF shall construct and transport TCP packets
according to subclause 8.2.2.
## 8.3 Transport of messages over user plane
### 8.3.1 General
After the completion of PDU Session establishment via untrusted non-3GPP
access, user plane IPsec SAs are established as specified in subclause 7.5.
The UE is able to send and receive GRE encapsulated user data packets over
non-3GPP access network via N3IWF. GRE encapsulation of user plane data
packets is described in subclause 8.3.2.
For an uplink user data packet associated with a PDU session ID and a QFI:
a) if there is a user plane IPsec SA:
1) associated with a PDU session ID matching the PDU session ID associated
with the uplink user data packet; and
2) associated with a QFI matching the QFI associated with the uplink user data
packet;
the UE shall select that user plane IPsec SA;
b) otherwise, the UE shall select the user plane IPsec SA:
1) associated with a PDU session ID matching the PDU session ID associated
with the uplink user data packet; and
2) associated with the indication that the child SA is the default child SA.
### 8.3.2 Generic routing encapsulation (GRE)
If a user data packet message is transmitted over non-3GPP access between the
UE and the N3IWF, the user data packet message shall be encapsulated as an GRE
user data packet with a GRE header as specified in subclause 9.3.3. In the GRE
encapsulated user data packet:
\- the protocol type field is set to zero;
\- the payload packet field is set to the user data packet;
\- the QFI field of the key field of the GRE header field is set to the QFI
associated with the user data packet;
\- if the N3IWF needs to send RQI for a downlink user data packet, the RQI
field of the key field of the GRE header is set to \"RQI is indicated\" as
defined in table 9.3.3-3; and
\- if the N3IWF does not need to send RQI for a downlink user data packet or
the UE sends an uplink user data packet, the RQI field of the key field of the
GRE header is set to \"RQI is not indicated\" as defined in table 9.3.3-3;
and:
a) if the IKE_AUTH response message contained the INTERNAL_IP4_ADDRESS
attribute in subclause 7.3.2 and the CREATE_CHILD_SA request message creating
the user plane IPsec SA contained the UP_IP4_ADDRESS notify payload in
subclause 7.5.4, an inner IPv4 datagram shall be constructed where:
1) the GRE user data packet shall be encapsulated as the payload of the inner
IPv4 datagram with IPv4 header where:
A) if the UE constructs the inner IPv4 datagram, the source address field
shall be set to the IPv4 address in the INTERNAL_IP4_ADDRESS attribute and the
destination address field shall be set to the IPv4 address in the
UP_IP4_ADDRESS notify payload;
B) if the N3IWF constructs the inner IPv4 datagram, the source address field
shall be set to the IPv4 address in the UP_IP4_ADDRESS notify payload and the
destination address field shall be set to the IPv4 address in the
INTERNAL_IP4_ADDRESS attribute; and
C) the protocol field shall be set to 2FH;
2) the inner IPv4 datagram shall be protected employing the ESP protocol in
tunnel mode as specified in IETF RFC 4303 [11] where:
A) the SPI field in the ESP packet shall be set to the SPI of the user plane
IPsec SA; and
B) the next header field in the ESP packet shall be set to 04H,
and the inner IPv4 datagram encapsulating the GRE encapsulated user data can
be fragmented as described in IETF RFC 791 [24] before being protected by ESP
protocol;
3) if the DSCP field is associated with the user plane IPsec SA, the DSCP
field as specified in IETF RFC 2474 [26] of the IP packet encapsulating the
ESP protected inner IPv4 datagram shall be set to the value of the DSCP field
included in the 5G_QOS_INFO Notify payload; and
4) the IP packet encapsulating the ESP protected inner IPv4 datagram shall be
sent to the peer for the SPI of the user plane IPsec SA; or
b) if the IKE_AUTH response message contained the INTERNAL_IP6_ADDRESS
attribute in subclause 7.3.2 and the CREATE_CHILD_SA request message creating
the user plane IPsec SA contained the UP_IP6_ADDRESS notify payload in
subclause 7.5.4, an inner IPv6 datagram shall be contrcuted where:
1) the GRE user data packet shall be encapsulated as the payload of the inner
IPv6 datagram with IPv6 header where:
A) if the UE constructs the inner IPv6 datagram, the source address field
shall be set to the IPv6 address in the INTERNAL_IP6_ADDRESS attribute and the
destination address field shall be set to the IPv6 address in the
UP_IP6_ADDRESS notify payload;
B) if the N3IWF constructs the inner IPv6 datagram, the source address field
shall be set to the IPv6 address in the UP_IP6_ADDRESS notify payload and the
destination address field shall be set to the IPv6 address in the
INTERNAL_IP6_ADDRESS attribute; and
C) the next header field shall be set to 2FH;
2) the inner IPv6 datagram shall be protected employing the ESP protocol in
tunnel mode as specified in IETF RFC 4303 [11] where:
A) the SPI field in the ESP packet shall be set to the SPI of the user plane
IPsec SA; and
B) the next header field in the ESP packet shall be set to 29H;
and the inner IPv6 datagram encapsulating the GRE encapsulated user data can
be fragmented as described in IETF RFC 8200 [25] before being protected by ESP
protocol; and
3) if the DSCP field is associated with the user plane IPsec SA, the DSCP
field as specified in IETF RFC 2474 [26] of the IP packet encapsulating the
ESP protected inner IPv6 datagram shall be set to the value of the DSCP field
included in the 5G_QOS_INFO Notify payload; and
4) theIP packet encapsulating the ESP protected inner IPv6 datagram shall be
sent to the peer for the SPI of the user plane IPsec SA.
If a user data packet message is transmitted over non-3GPP access between the
UE and the N3IWF, the user data packet message shall be encapsulated in the
payload of an inner IP datagram which is further encapsulated by ESP protocol
in tunnel mode as specified in IETF RFC 4303 [11]. In order to avoid any IP
fragmentation by the sending entity over the non-3GPP access network, the
maximum inner IP datagram length shall be set by the sending entity such that
the length of the resulting outer IP datagram does not exceed the MTU of the
non-3GPP access network. If the length of the user data packet message exceeds
the payload size corresponding to the maximum inner IP datagram length and IP
fragmentation is needed:
\- the inner IP IPv4 datagram or inner IP IPv6 datagram shall be fragmented;
and
\- the IP packet encapsulating the ESP protected inner IPv4 datagram and the
IP packet encapsulating the ESP protected inner IPv6 datagram shall not be
fragmented.
# 9 Parameters and coding
## 9.1 General
In this release of the specification, this subclause has been intentionally
left blank.
## 9.2 3GPP specific coding information
### 9.2.1 GUAMI
The purpose of the GUAMI information element is to provide the globally unique
AMF ID.
The GUAMI information element is coded as shown in figures 9.2.1.1 and table
9.2.1.1.
The GUAMI is a type 3 information element with a length of 7 octets.
* * *
8 7 6 5 4 3 2 1  
GUAMI IEI octet 1  
MCC digit 2 MCC digit 1 octet 2  
MNC digit 3 MCC digit 3 octet 3  
MNC digit 2 MNC digit 1 octet 4  
AMF region ID octet 5  
AMF set ID octet 6  
AMF set ID (continued) AMF pointer octet 7
* * *
Figure 9.2.1.1: GUAMI information element
Table 9.2.1.1: GUAMI information element
+----------------------------------------------------------------------+ | MCC, Mobile country code (octet 2, octet 3 bits 1 to 4) | | | | The MCC field is coded as in ITU-T Recommendation E.212 [21], | | Annex A. | +----------------------------------------------------------------------+ | MNC, Mobile network code (octet 4, octet 3 bits 5 to 8). | | | | The coding of this field is the responsibility of each | | administration but BCD coding shall be used. The MNC shall consist | | of 2 or 3 digits. If a network operator decides to use only two | | digits in the MNC, bits 5 to 8 of octet 3 shall be coded as | | \"1111\". | +----------------------------------------------------------------------+
### 9.2.2 Establishment cause for non-3GPP access
The purpose of the Establishment cause for non-3GPP access information element
is to provide the establishment cause for non-3GPP access.
The Establishment cause for non-3GPP access information element is coded as
shown in figures 9.2.2.1 and table 9.2.2.1.
The Establishment cause for non-3GPP access is a type 3 information element
with length of 2 octets.
+---------+---------+-------+-------+-------+---------+---+---+---+ | 8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | | +---------+---------+-------+-------+-------+---------+---+---+---+ | Establ | octet 1 | | | | | | | | | ishment | | | | | | | | | | cause | | | | | | | | | | for | | | | | | | | | | n | | | | | | | | | | on-3GPP | | | | | | | | | | access | | | | | | | | | | IEI | | | | | | | | | +---------+---------+-------+-------+-------+---------+---+---+---+ | 0 | 0 | 0 | 0 | N3AEC | octet 2 | | | | | | | | | | | | | | | Spare | Spare | Spare | Spare | | | | | | +---------+---------+-------+-------+-------+---------+---+---+---+
Figure 9.2.2.1: Establishment cause for non-3GPP access information element
Table 9.2.2.1: Establishment cause for non-3GPP access information element
+----------------------------------------------------------------------+ | Establishment cause for non-3GPP access (N3AEC) (octet 2 bits 1 to | | 4) | | | | Bits | | | | 4 3 2 1 | | | | 0 0 0 0 emergency | | | | 0 0 0 1 highPriorityAccess | | | | 0 0 1 1 mo-Signalling | | | | 0 1 0 0 mo-Data | | | | 1 0 0 0 mps-PriorityAccess | | | | 1 0 0 1 mcs-PriorityAccess | | | | All other values are spare values. The receiving entity shall treat | | a spare value as 0100, \"MO data\". | +----------------------------------------------------------------------+
### 9.2.3 PLMN ID
The purpose of the PLMN ID information element is to indicate the PLMN
identity of the selected PLMN.
The PLMN ID is a type 4 information element with a length of 5 octets.
The PLMN ID information element is coded as shown in figure 9.2.3.1 and table
9.2.3.1.
* * *
8 7 6 5 4 3 2 1  
PLMN ID IEI octet 1  
Length of PLMN ID contents octet 2  
MCC digit 2 MCC digit 1 octet 3  
MNC digit 3 MCC digit 3 octet 4  
MNC digit 2 MNC digit 1 octet 5
* * *
Figure 9.2.3.1: PLMN ID information element
Table 9.2.3.1: PLMN ID information element
+----------------------------------------------------------------------+ | MCC, Mobile country code (octet 3, octet 4 bits 1 to 4) | | | | The MCC field is coded as in ITU-T Recommendation E.212 [42], | | Annex A | | | | MNC, Mobile network code (octet 5, octet 4 bits 5 to 8). | | | | The coding of this field is the responsibility of each | | administration but BCD coding shall be used. The MNC shall consist | | of 2 or 3 digits. If a network operator decides to use only two | | digits in the MNC, bits 5 to 8 of octet 4 shall be coded as | | \"1111\". Mobile equipment shall accept MNC coded in such a way. | +----------------------------------------------------------------------+
### 9.2.4 IKEv2 Notify Message Type value
#### 9.2.4.1 General
The IKEv2 Notify Message Type is specified in IETF RFC 7296 [6].
The Notify Message Type with a value (in decimal) in the range 0 - 16383 are
intended for reporting errors, where:
\- value range between 0 and 8191 is defined in IETF RFC 7296 [6];
\- value range between 8192 and 16383 is reserved for private error usage;
The Notify Message Type with a value (in decimal) in the range 16384 - 65535
are intended for reporting status, where:
\- value range between 16384 and 40959 is defined in IETF RFC 7296 [6];
\- value range between 40960 and 65535 is reserved for private status usage.;
#### 9.2.4.2 Private Notify Message - Error Types
The Private Notify Message Error Types defined in table 9.2.4.2-1 are error
notifications which indicates an error while negotiating an IKEv2 SA or IPsec
SA. Refer to table 9.2.4.2-1 for more details on what each error type means.
Table 9.2.4.2-1: Private Error Types
* * *
Notify Message Value\ Descriptions (in decimal)
CONGESTION 15500 This error type is used to indicate that the requested
service was rejected because of congestion in the network.
* * *
In the present specification, only the private notify message error type
values between 15500 and 15599 shall be allocated to a Notify payload.
The private notify message error type values:
\- between 9950 and 9999;
\- between 10950 and 10999;
\- between 11950 and 11999;
\- between 12950 and 12999;
\- between 13950 and 13999; and
\- between 14950 and 14999;
shall not be allocated to a Notify payload defined in the present
specification.
#### 9.2.4.3 Private Notify Message - Status Types
The Private Notify Message Status Types defined in table 9.2.4.3-1 are used to
indicate status notifications or additional information in a Notify payload
which may be added to an IKEv2 message or IKE_AUTH request or IKE_AUTH
response message according to the procedures described in the present
document. Refer to table 9.2.4.3‑1 for more details on what each status type
means.
Table 9.2.4.3-1: Private Status Types
* * *
Notify Message Value\ Descriptions (in decimal)
5G_QOS_INFO 55501 This status when present indicates 5G_QOS_INFO Notify
payload encoded according to subclause 9.3.1.1
NAS_IP4_ADDRESS 55502 This status when present indicates NAS_IP4_ADDRESS
Notify payload encoded according to subclause 9.3.1.2.
NAS_IP6_ADDRESS 55503 This status when present indicates NAS_IP6_ADDRESS
Notify payload encoded according to subclause 9.3.1.3.
UP_IP4_ADDRESS 55504 This status when present indicates UP_IP4_ADDRESS Notify
payload encoded according to subclause 9.3.1.4.
UP_IP6_ADDRESS 55505 This status when present indicates UP_IP6_ADDRESS Notify
payload encoded according to subclause 9.3.1.5.
NAS_TCP_PORT 55506 This status when present indicates NAS_TCP_PORT Notify
payload encoded according to subclause 9.3.1.6.
N3GPP_BACKOFF_TIMER 55507 This status when present indicates
N3GPP_BACKOFF_TIMER Notify payload encoded according to subclause 9.3.1.7.
* * *
In the present specification, only the private notify message error type
values between 55500 and 55599 shall be allocated to a Notify payload.
The private notify message status type values:
\- between 49950 and 49999;
\- between 50950 and 50999;
\- between 51950 and 51999;
\- between 52950 and 52999;
\- between 53950 and 53999; and
\- between 54950 and 54999;
shall not be allocated to a Notify payload defined in the present
specification.
## 9.3 IETF RFC coding information
### 9.3.1 IKEv2 Notify payloads
#### 9.3.1.1 5G_QOS_INFO Notify payload
The 5G_QOS_INFO payload is used to indicate the PDU session identity, zero or
more QFIs, optionally a DSCP value associated with the child SA and an
indication of whether the child SA is the default child SA.
The 5G_QOS_INFO payload is coded according to figure 9.3.1.1-1 and table
9.3.1.1-1.
+----------------------+-------+-------+-------+-------+-------+------+-------+--------+ | Bits | | | | | | | | | +----------------------+-------+-------+-------+-------+-------+------+-------+--------+ | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 | Octets | +----------------------+-------+-------+-------+-------+-------+------+-------+--------+ | Protocol ID | 1 | | | | | | | | +----------------------+-------+-------+-------+-------+-------+------+-------+--------+ | SPI Size | 2 | | | | | | | | +----------------------+-------+-------+-------+-------+-------+------+-------+--------+ | Notify Message Type | 3 - 4 | | | | | | | | +----------------------+-------+-------+-------+-------+-------+------+-------+--------+ | Length | 5 | | | | | | | | +----------------------+-------+-------+-------+-------+-------+------+-------+--------+ | PDU Session Identity | 6 | | | | | | | | +----------------------+-------+-------+-------+-------+-------+------+-------+--------+ | Number of QFIs | 7 | | | | | | | | +----------------------+-------+-------+-------+-------+-------+------+-------+--------+ | QFI List | 8 - x | | | | | | | | +----------------------+-------+-------+-------+-------+-------+------+-------+--------+ | 0 | 0 | 0 | 0 | 0 | 0 | DCSI | DSCPI | x+1 | | | | | | | | | | | | Spare | Spare | Spare | Spare | Spare | Spare | | | | +----------------------+-------+-------+-------+-------+-------+------+-------+--------+ | DSCP | x+2* | | | | | | | | +----------------------+-------+-------+-------+-------+-------+------+-------+--------+
Figure 9.3.1.1-1: 5G_QOS_INFO Notify payload format
Table 9.3.1.1-1: 5G_QOS_INFO Notify payload value
+----------------------------------------------------------------------+ | Octet 1 is defined in IETF RFC 7296 [6] | +----------------------------------------------------------------------+ | Octet 2 is SPI Size field. It is set to 0 and there is no Security | | Parameter Index field. | +----------------------------------------------------------------------+ | Octet 3 and Octet 4 is the Notify Message Type field. The Notify | | Message Type field is set to value 55501 to indicate the | | 5G_QOS_INFO. | +----------------------------------------------------------------------+ | Octet 5 is the Length field. This field indicates the length in | | octets of the 5G_QOS_INFO Value field. | +----------------------------------------------------------------------+ | Octet 6 is PDU Session Identity field. This field indicates the PDU | | session associated with the child SA for user plane. | | | | Octet 7 is Number of QFIs field. This field indicates the number of | | QFIs in the QFI list. | | | | Octets 8 to octet x is QFI List field. This field indicates those | | QoS flows associated with the child SA. Every QFI is coded as the | | QFI field in the QoS rule defined in 3GPP TS 24.501 [4]. | | | | Octet x+1, bit 0 is the DSCP included field (DSCPI). | | | | 0 DSCP field is not included. | | | | 1 DSCP field is included. | | | | Octet x+1, bit 1 is the indication of whether the child SA is the | | default child SA (DCSI). | | | | 0 the child SA is not the default child SA. | | | | 1 the child SA is the default child SA. | | | | Octet x+2 is the DSCP field. If included, this field indicates the | | DSCP marking for all IP packets sent over this child SA. | +----------------------------------------------------------------------+
#### 9.3.1.2 NAS_IP4_ADDRESS Notify payload
The NAS_IP4_ADDRESS payload is used to indicate the inner IPv4 address of the
N3IWF for NAS message transport.
The NAS_IP4_ADDRESS payload is coded according to figure 9.3.1.2-1 and table
9.3.1.2-1.
* * *
Bits  
7 6 5 4 3 2 1 0 Octets Protocol ID 1  
SPI Size 2  
Notify Message Type 3 - 4  
IPv4 address 5 - 8
* * *
Figure 9.3.1.2-1: NAS_IP4_ADDRESS Notify payload format
Table 9.3.1.2-1: NAS_IP4_ADDRESS Notify payload value
* * *
Octet 1 is defined in IETF RFC 7296 [6] Octet 2 is SPI Size field. It is set
to 0 and there is no Security Parameter Index field. Octet 3 and Octet 4 is
the Notify Message Type field. The Notify Message Type field is set to value
55502 to indicate the NAS_IP4_ADDRESS. Octet 5 to octet 8 is the IPv4 address
field. The IPv4 address field contains the inner IPv4 address of the N3IWF for
NAS message transport.
* * *
#### 9.3.1.3 NAS_IP6_ADDRESS Notify payload
The NAS_IP6_ADDRESS payload is used to indicate the inner IPv6 address of the
N3IWF for NAS message transport.
The NAS_IP6_ADDRESS payload is coded according to figure 9.3.1.3-1 and table
9.3.1.3-1.
* * *
Bits  
7 6 5 4 3 2 1 0 Octets Protocol ID 1  
SPI Size 2  
Notify Message Type 3 - 4  
IPv6 address 5 - 20
* * *
Figure 9.3.1.3-1: NAS_IP6_ADDRESS Notify payload format
Table 9.3.1.3-1: NAS_IP6_ADDRESS Notify payload value
* * *
Octet 1 is defined in IETF RFC 7296 [6] Octet 2 is SPI Size field. It is set
to 0 and there is no Security Parameter Index field. Octet 3 and Octet 4 is
the Notify Message Type field. The Notify Message Type field is set to value
55503 to indicate the NAS_IP6_ADDRESS. Octet 5 to octet 20 is the IPv6 address
field. The IPv6 address field contains the inner IPv6 address of the N3IWF for
NAS message transport.
* * *
#### 9.3.1.4 UP_IP4_ADDRESS Notify payload
The UP_IP4_ADDRESS payload is used to indicate the inner IPv4 address of the
N3IWF for GRE user data packet transport.
The UP_IP4_ADDRESS payload is coded according to figure 9.3.1.4-1 and table
9.3.1.4-1.
* * *
Bits  
7 6 5 4 3 2 1 0 Octets Protocol ID 1  
SPI Size 2  
Notify Message Type 3 - 4  
IPv4 address 5 - 8
* * *
Figure 9.3.1.4-1: UP_IP4_ADDRESS Notify payload format
Table 9.3.1.4-1: UP_IP4_ADDRESS Notify payload value
* * *
Octet 1 is defined in IETF RFC 7296 [6] Octet 2 is SPI Size field. It is set
to 0 and there is no Security Parameter Index field. Octet 3 and Octet 4 is
the Notify Message Type field. The Notify Message Type field is set to value
55504 to indicate the UP_IP4_ADDRESS. Octet 5 to octet 8 is the IPv4 address
field. The IPv4 address field contains the inner IPv4 address of the N3IWF for
GRE user data packet transport.
* * *
#### 9.3.1.5 UP_IP6_ADDRESS Notify payload
The UP_IP6_ADDRESS payload is used to indicate the inner IPv6 address of the
N3IWF for GRE user data packet transport.
The UP_IP6_ADDRESS payload is coded according to figure 9.3.1.5-1 and table
9.3.1.5-1.
* * *
Bits  
7 6 5 4 3 2 1 0 Octets Protocol ID 1  
SPI Size 2  
Notify Message Type 3 - 4  
IPv4 address 5 - 20
* * *
Figure 9.3.1.5-1: UP_IP6_ADDRESS Notify payload format
Table 9.3.1.5-1: UP_IP6_ADDRESS Notify payload value
* * *
Octet 1 is defined in IETF RFC 7296 [6] Octet 2 is SPI Size field. It is set
to 0 and there is no Security Parameter Index field. Octet 3 and Octet 4 is
the Notify Message Type field. The Notify Message Type field is set to value
55505 to indicate the UP_IP6_ADDRESS. Octet 5 to octet 20 is the IPv6 address
field. The IPv4 address field contains the inner IPv6 address of the N3IWF for
GRE user data packet transport.
* * *
#### 9.3.1.6 NAS_TCP_PORT Notify payload
The NAS_TCP_PORT payload is used to indicate the port number for the
connection of the inner TCP transport protocol for the NAS message transport.
The NAS_TCP_PORT payload is coded according to figure 9.3.1.6-1 and table
9.3.1.6-1.
* * *
Bits  
7 6 5 4 3 2 1 0 Octets Protocol ID 1  
SPI Size 2  
Notify Message Type 3 -- 4  
Port Number 5 - 6
* * *
Figure 9.3.1.6-1: NAS_TCP_PORT Notify payload format
Table 9.3.1.6-1: NAS_TCP_PORT Notify payload value
* * *
Octet 1 is defined in IETF RFC 7296 [6] Octet 2 is SPI Size field. It is set
to 0 and there is no Security Parameter Index field. Octet 3 and Octet 4 is
the Notify Message Type field. The Notify Message Type field is set to value
55506 to indicate the NAS_TCP_PORT. Octet 5 and octet 6 are the Port Number
field which contains the port number of the connection for the inner TCP
transport protocol for the NAS message transport.
* * *
#### 9.3.1.7 N3GPP_BACKOFF_TIMER Notify payload
The N3GPP_BACKOFF_TIMER Notify payload is used to indicate the value of the
back-off timer.
The N3GPP_BACKOFF_TIMER Notify payload is coded according to figure 9.3.1.7-1
and table 9.3.1.7-1.
+-----------------------+-------+---+-----+-----+-----+-----+-----+----------+ | > Bits | | | | | | | | | +-----------------------+-------+---+-----+-----+-----+-----+-----+----------+ | 7 | 6 | 5 | > 4 | > 3 | > 2 | > 1 | > 0 | > Octets | +-----------------------+-------+---+-----+-----+-----+-----+-----+----------+ | > Protocol ID | > 1 | | | | | | | | +-----------------------+-------+---+-----+-----+-----+-----+-----+----------+ | > SPI Size | > 2 | | | | | | | | +-----------------------+-------+---+-----+-----+-----+-----+-----+----------+ | > Notify Message Type | > 3-4 | | | | | | | | +-----------------------+-------+---+-----+-----+-----+-----+-----+----------+ | > Backoff Timer Value | > 5 | | | | | | | | +-----------------------+-------+---+-----+-----+-----+-----+-----+----------+
Figure 9.3.1.7-1: N3GPP_BACKOFF_TIMER Notify payload format
Table 9.3.1.7-1: N3GPP_BACKOFF_TIMER Notify payload value
* * *
Octet 1 is defined in IETF RFC 7296 [6] Octet 2 is SPI Size field. It is set
to 0 and there is no Security Parameter Index field. Octet 3 and Octet 4 is
the Notify Message Type field. The Notify Message Type field is set to value
55507 to indicate the N3GPP_BACKOFF_TIMER. Octet 5 is the Backoff Timer Value
field. This field indicates the value of the back-off timer. It is coded as
the value part (as specified in 3GPP TS 24.007 [22] for type 4 IE) of the GPRS
timer 3 information element defined in 3GPP TS 24.008 [28] subclause 10.5.7.4a
(NOTE). NOTE: The GPRS Timer 3 IEI field and the length of GPRS Timer 3
contents field of the GPRS timer 3 information element are not included in the
value of the back-off timer.
* * *
### 9.3.2 EAP-5G method
#### 9.3.2.1 General
The messages of EAP-5G method are EAP requests and EAP responses as specified
in IETF RFC 3748 [9] subclause 4.1 and use coding of the expanded method type
as described in IETF RFC 3748 [9] subclause 5.7.
The sending entity shall set the value of a spare bit to zero. The receiving
entity shall ignore the value of a spare bit.
#### 9.3.2.2 Message format
##### 9.3.2.2.1 EAP-Request/5G-Start message
EAP-Request/5G-Start message is coded as specified in figure 9.3.2.2.1-1 and
table 9.3.2.2.1-1.
* * *
Bits  
7 6 5 4 3 2 1 0 Octets Code 1  
Identifier 2  
Length 3 - 4  
Type 5  
Vendor-Id 6 - 8  
Vendor-Type 9 - 12  
Message-Id 13  
Spare 14  
Extensions 15 - m
* * *
Figure 9.3.2.2.1-1: EAP-Request/5G-Start message
Table 9.3.2.2.1-1: EAP-Request/5G-Start message
* * *
Code field is set to 1 (decimal) as specified in IETF RFC 3748 [9] subclause
4.1 and indicates request. Identifier field is set as specified in IETF RFC
3748 [9] subclause 4.1. Length field is set as specified in IETF RFC 3748 [9]
subclause 4.1 and indicates the length of the EAP-Request/5G-Start message in
octets. Type field is set to 254 (decimal) as specified in IETF RFC 3748 [9]
subclause 5.7 and indicates the expanded type. Vendor-Id field is set to the
3GPP Vendor-Id of 10415 (decimal) registered with IANA under the SMI Private
Enterprise Code registry. Vendor-Type field is set to EAP-5G method identifier
of 3 (decimal) as specified in 3GPP TS 33.402 [10] annex C. Message-Id field
is set to 5G-Start-Id of 1 (decimal). Spare field consists of spare bits.
Extensions field is an optional field and consists of spare bits.
* * *
##### 9.3.2.2.2 EAP-Response/5G-NAS message
EAP-Response/5G-NAS message is coded as specified in figure 9.3.2.2.2-1 and
table 9.3.2.2.2-1.
* * *
Bits  
7 6 5 4 3 2 1 0 Octets Code 1  
Identifier 2  
Length 3 - 4  
Type 5  
Vendor-Id 6 - 8  
Vendor-Type 9 - 12  
Message-Id 13  
Spare 14  
AN-parameter length 15-16  
AN-parameter 17 - 17+x  
NAS-PDU length 18+x - 19+x  
NAS-PDU 20+x - n+x  
Extensions n+x+1 - z+x
* * *
Figure 9.3.2.2.2-1: EAP-Response/5G-NAS message
Table 9.3.2.2.2-1: EAP-Response/5G-NAS message
* * *
Code field is set to 2 (decimal) as specified in IETF RFC 3748 [9] subclause
4.1 and indicates response. Identifier field is set as specified in IETF RFC
3748 [9] subclause 4.1. Length field is set as specified in IETF RFC 3748 [9]
subclause 4.1 and indicates the length of the EAP-Response/5G-NAS message in
octets. Type field is set to 254 (decimal) as specified in IETF RFC 3748 [9]
subclause 5.7 and indicates the expanded type. Vendor-Id field is set to the
3GPP Vendor-Id of 10415 (decimal) registered with IANA under the SMI Private
Enterprise Code registry. Vendor-Type field is set to EAP-5G method identifier
of 3 (decimal) as specified in 3GPP TS 33.402 [10] annex C. Message-Id field
is set to 5G-NAS-Id of 2 (decimal). Spare field consists of spare bits. AN-
parameters length indicate the length of the AN-parameters field in octets AN-
Parameters field is coded according to figure 9.3.2.2.2.2 and table
9.3.2.2.2.2. NAS-PDU length field indicates the length of NAS-PDU field in
octets. NAS-PDU field contains a NAS message from the UE as specified in 3GPP
TS 24.501 [4]. Extensions field is an optional field and consists of spare
bits.
* * *
+----------------+------------+---+---+---+---+---+---+---+ | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 | | +----------------+------------+---+---+---+---+---+---+---+ | AN-parameter 1 | octet 17 | | | | | | | | | | | | | | | | | | | | octet a | | | | | | | | +----------------+------------+---+---+---+---+---+---+---+ | AN-parameter 2 | octet a+1 | | | | | | | | | | | | | | | | | | | | octet b | | | | | | | | +----------------+------------+---+---+---+---+---+---+---+ | ... | octet b+1 | | | | | | | | | | | | | | | | | | | | octet k | | | | | | | | +----------------+------------+---+---+---+---+---+---+---+ | AN-parameter n | octet k+1 | | | | | | | | | | | | | | | | | | | | octet 17+x | | | | | | | | +----------------+------------+---+---+---+---+---+---+---+
Figure 9.3.2.2.2.2: AN-parameters field
Table 9.3.2.2.2.2: AN-parameters field
* * *
Each AN-parameter field is coded according to figure 9.3.2.2.2.1-3 and table
9.3.2.2.2.3.
* * *
+---------------------+-----------+---+---+---+---+---+---+---+ | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 | | +---------------------+-----------+---+---+---+---+---+---+---+ | AN-parameter type | octet a+1 | | | | | | | | +---------------------+-----------+---+---+---+---+---+---+---+ | AN-parameter length | octet a+2 | | | | | | | | +---------------------+-----------+---+---+---+---+---+---+---+ | AN-parameter value | octet a+3 | | | | | | | | | | | | | | | | | | | | octet b | | | | | | | | +---------------------+-----------+---+---+---+---+---+---+---+
Figure 9.3.2.2.2.3: AN-parameter field
Table 9.3.2.2.2.3: AN-parameter field
+----------------------------------------------------------------------+ | The AN-parameter length field indicates the length of the | | AN-parameter value field. | +----------------------------------------------------------------------+ | | +----------------------------------------------------------------------+ | The AN-parameter type field indicates the type of the AN-parameter | | value field. Sending entity shall not set the AN-parameter type | | field to a spare value. Receiving entity shall ignore any | | AN-parameter field with the AN-parameter type field set to a spare | | value. | | | | The following AN-parameter type field values are specified: | | | | - 01H (GUAMI); | | | | - 02H (selected PLMN ID); | | | | - 03H (requested NSSAI); and | | | | - 04H (establishment cause for non-3GPP access). | | | | All other values of the AN-parameter type field are spare. Receiving | | entity shall ignore an AN-parameter field with the AN-parameter type | | field set to a spare value. | | | | When the AN-parameter type field indicates the GUAMI, the | | AN-parameter value field is coded as value part (as specified in | | 3GPP TS 24.007 [22] for type 3 information element) of GUAMI | | information element as specified in subclause 9.2.1. | | | | When the AN-parameter type field indicates the selected PLMN ID, the | | AN-parameter value field is coded according to value part of PLMN ID | | information element as specified in subclause 9.2.3. | | | | When the AN-parameter type field indicates the requested NSSAI, the | | AN-parameter value field is coded according to value part of NSSAI | | information element as specified in subclause 9.10.3.34 of | | 3GPP TS 24.501 [4]. | | | | When the AN-parameter type field indicates the establishment cause | | for non-3GPP access, the AN-parameter field is coded as value part | | (as specified in 3GPP TS 24.007 [22] for type 3 information | | element) of the Establishment cause for non-3GPP access information | | element as specified in subclause 9.2.2. | +----------------------------------------------------------------------+ | | +----------------------------------------------------------------------+
##### 9.3.2.2.3 EAP-Request/5G-NAS message
EAP-Request/5G-NAS message is coded as specified in figure 9.3.2.2.3-1 and
table 9.3.2.2.3-1.
* * *
Bits  
7 6 5 4 3 2 1 0 Octets Code 1  
Identifier 2  
Length 3 - 4  
Type 5  
Vendor-Id 6 - 8  
Vendor-Type 9 - 12  
Message-Id 13  
Spare 14  
NAS-PDU length 15 - 16  
NAS-PDU 17 - n  
Extensions n+1 - z
* * *
Figure 9.3.2.2.3-1: EAP-Request/5G-NAS message
Table 9.3.2.2.3-1: EAP-Request/5G-NAS message
* * *
Code field is set to 1 (decimal) as specified in IETF RFC 3748 [9] subclause
4.1 and indicates request. Identifier field is set as specified in IETF RFC
3748 [9] subclause 4.1. Length field is set as specified in IETF RFC 3748 [9]
subclause 4.1 and indicates the length of the EAP-Request/5G-NAS message in
octets. Type field is set to 254 (decimal) as specified in IETF RFC 3748 [9]
subclause 5.7 and indicates the expanded type. Vendor-Id field is set to the
3GPP Vendor-Id of 10415 (decimal) registered with IANA under the SMI Private
Enterprise Code registry. Vendor-Type field is set to EAP-5G method identifier
of 3 (decimal) as specified in 3GPP TS 33.402 [10] annex C. Message-Id field
is set to 5G-NAS-Id of 2 (decimal). Spare field consists of spare bits. NAS-
PDU length field indicates the length of NAS-PDU field in octets. NAS-PDU
field contains a NAS message from the AMF as specified 3GPP TS 24.501 [4].
Extensions field is an optional field and consists of spare bits.
* * *
##### 9.3.2.2.4 EAP-Request/5G-Stop message
EAP-Request/5G-Stop message is coded as specified in figure 9.3.2.2.4-1 and
table 9.3.2.2.4-1.
* * *
Bits  
7 6 5 4 3 2 1 0 Octets Code 1  
Identifier 2  
Length 3 - 4  
Type 5  
Vendor-Id 6 - 8  
Vendor-Type 9 - 12  
Message-Id 13  
Spare 14  
Extensions 15 - m
* * *
Figure 9.3.2.2.4-1: EAP-Request/5G-Stop message
Table 9.3.2.2.4-1: EAP-Request/5G-Stop message
* * *
Code field is set to 1 (decimal) as specified in IETF RFC 3748 [9] subclause
4.1 and indicates request. Identifier field is set as specified in IETF RFC
3748 [9] subclause 4.1. Length field is set as specified in IETF RFC 3748 [9]
subclause 4.1 and indicates the length of the EAP-Request/5G-Stop message in
octets. Type field is set to 254 (decimal) as specified in IETF RFC 3748 [9]
subclause 5.7 and indicates the expanded type. Vendor-Id field is set to the
3GPP Vendor-Id of 10415 (decimal) registered with IANA under the SMI Private
Enterprise Code registry. Vendor-Type field is set to EAP-5G method identifier
of 3 (decimal) as specified in 3GPP TS 33.402 [10] annex C. Message-Id field
is set to 5G-Stop-Id of 4 (decimal). Spare field consists of spare bits.
Extensions field is an optional field and consists of spare bits.
* * *
### 9.3.3 GRE encapsulated user data packet
GRE encapsulated user data packet is coded according to figure 9.3.3-1 and
table 9.3.3-1.
* * *
Bits  
7 6 5 4 3 2 1 0 Octets GRE header 1 - 8  
Payload packet 9 - x
* * *
Figure 9.3.3-1: GRE encapsulated user data packet
Table 9.3.3-1: GRE encapsulated user data packet
* * *
Octet 1 to octet 8 are the GRE header field defined in IETF RFC 2784 [14] and
IETF RFC 2890 [15]. The GRE header field is coded according to figure 9.3.3-2
and table 9.3.3-2. Octet 8 to octet x are the Payload packet field. The
Payload packet field contains one user data packet.
* * *
* * *
Bits  
7 6 5 4 3 2 1 0 Octets C Reserved0 K S Reserved0 1  
Reserved0 Ver 2  
Protocol type 3 - 4  
Key 5 - 8
* * *
Figure 9.3.3-2: GRE header field
Table 9.3.3-2: GRE header field
* * *
Bit 7 of octet 1 is the C bit defined in IETF RFC 2784 [14]. The C bit is set
to zero. Bits 6, 3, 2, 1 and 0 of octet 1 and bits 7, 6, 5, 4, and 3 of octet
2 are the Reserved0 field defined in IETF RFC 2784 [14] and IETF RFC 2890
[15]. Bit 5 of octet 1 is the K bit defined in IETF RFC 2890 [15]. The K bit
is set to one. Bit 4 of octet 1 is the S bit defined in IETF RFC 2890 [15].
The S bit is set to zero. Bits 2, 1 and 0 of octet 2 is the Ver field defined
in IETF RFC 2784 [14]. Octet 3 and octet 4 are the Protocol Type field defined
in IETF RFC 2784 [14]. The Protocol Type field is set to zero . (see NOTE)
Octet 5 to octet 8 are the Key field defined in IETF RFC 2890 [15]. The Key
field is coded according to figure 9.3.3-3 and table 9.3.3-3. NOTE: The
receiving entity shall ignore value of the Protocol Type field.
* * *
+-------+-------+-------+-------+-------+-------+-------+-------+--------+ | Bits | | | | | | | | | +-------+-------+-------+-------+-------+-------+-------+-------+--------+ | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 | Octets | +-------+-------+-------+-------+-------+-------+-------+-------+--------+ | 0 | 0 | QFI | 5 | | | | | | | | | | | | | | | | | Spare | Spare | | | | | | | | +-------+-------+-------+-------+-------+-------+-------+-------+--------+ | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 6 | | | | | | | | | | | | Spare | Spare | Spare | Spare | Spare | Spare | Spare | Spare | | +-------+-------+-------+-------+-------+-------+-------+-------+--------+ | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 7 | | | | | | | | | | | | Spare | Spare | Spare | Spare | Spare | Spare | Spare | Spare | | +-------+-------+-------+-------+-------+-------+-------+-------+--------+ | RQI | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 8 | | | | | | | | | | | | | Spare | Spare | Spare | Spare | Spare | Spare | Spare | | +-------+-------+-------+-------+-------+-------+-------+-------+--------+
Figure 9.3.3-3: Key field of GRE header
Table 9.3.3-3: Key field of GRE header
* * *
RQI (octet 8, bit 7)  
Bit  
7  
0 RQI is not indicated  
1 RQI is indicated
QFI (octet 5, bits 5 to 0)  
Bits  
5 4 3 2 1 0  
0 0 0 0 0 0 QFI 0 to  
1 1 1 1 1 1 QFI 63
* * *
## 9.4 NAS message envelope
NAS message envelope is used to frame the NAS message prior to its
encapsulation as the TCP payload in the inner IP datagram.
NAS message envelope is encoded according to figure 9.4-1 and table 9.4-1.
* * *
Bits  
7 6 5 4 3 2 1 0 Octets Length 1 - 2  
NAS Message 3 - m
* * *
Figure 9.4-1: NAS message envelope format
Table 9.4-1: NAS message envelope value
* * *
Octet 1 and Octet 2 indicate the Length field. The Length field contains the
length of the NAS message in bytes. Octet 3 to octet m indicate the NAS
Message field. The NAS Message field contains the NAS message which is to be
framed in prior to encapsulation as the TCP payload in the inner IP datagram
of the transmitted IP packet.
* * *
#
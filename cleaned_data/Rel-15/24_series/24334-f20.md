# Foreword
This Technical Specification has been produced by the 3^rd^ Generation
Partnership Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# 1 Scope
The present document specifies the protocols for Proximity-based Services
(ProSe) between:
\- the ProSe-enabled UE and the ProSe Function (over the PC3 interface); and
\- two ProSe-enabled UEs (over the PC5 interface).
The present document defines the associated procedures for ProSe service
authorisation, ProSe direct discovery (using E-UTRA or WLAN technology), EPC-
level ProSe discovery and ProSe direct communication.
The present document also defines the message format, message contents, error
handling and system parameters applied by the protocols for ProSe.
The present document is applicable to:
\- the ProSe-enabled UE; and
\- the ProSe Function.
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or nonâ€‘specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
[1] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[2] 3GPP TS 23.303: \"Proximity-based services (ProSe); Stage 2\".
[3] 3GPP TS 29.344: \"Proximity-services (Prose) Function to Home Subscriber
Server (HSS) aspects; Stage 3\".
[4] 3GPP TS 23.003: \"Numbering, addressing and identification\".
[5] 3GPP TS 29.345: \"Inter-Proximity-services (Prose) Function signalling
aspects; Stage 3\".
[6] 3GPP TS 33.303: \"Proximity-based Services (ProSe); Security aspects\".
[7] W3C REC-xmlschema-2-20041028: \"XML Schema Part 2: Datatypes\".
[8] IETF RFC 4122: \"A Universally Unique IDentifier (UUID) URN Namespace\".
[9] 3GPP TS 24.333: \"Proximity-services (ProSe) Management Objects (MO)\".
[10] IETF RFC 1035: \"DOMAIN NAMES - IMPLEMENTATION AND SPECIFICATION\".
[11] 3GPP TS 24.301: \"Non-Access-Stratum (NAS) protocol for Evolved Packet
System (EPS); Stage 3\".
[12] 3GPP TS 36.331: \"Evolved Universal Terrestrial Radio Access (E-UTRA);
Radio Resource Control (RRC); Protocol specification\".
[13] Wi-Fi Alliance Technical Committee P2P Task Group, \"Wi-Fi Peer-to-Peer
(P2P) Technical Specification\", Version 1.1.
[14] IEEE Std 802.11-2012: \"IEEE Standard for Information technology \-
Telecommunications and information exchange between systems - Local and
metropolitan area networks - Specific requirements - Part 11: Wireless LAN
Medium Access Control (MAC) and Physical Layer (PHY) Specifications\".
[15] IETF RFC 4862: \"IPv6 Stateless Address Autoconfiguration\".
[16] IETF RFC 3927: \"Dynamic Configuration of IPv4 Link-Local Addresses\".
[17] 3GPP TS 31.102: \"Characteristics of the Universal Subscriber Identity
Module (USIM) application\".
[18] IETF RFC 7230: \"Hypertext Transfer Protocol (HTTP/1.1): Message Syntax
and Routing\".
[19] IETF RFC 7231: \"Hypertext Transfer Protocol (HTTP/1.1): Semantics and
Content\".
[20] WAP-168-ServiceLoad-20010731-a: \"Service Loading\".
[21] OMA-WAP-TS-PushOTA-V2_1-20110405-A: \"Push Over the Air\".
[22] OMA-AD-Push-V2_2-20110809-A: \"Push Architecture\".
[23] 3GPP TS 36.304: \"Evolved Universal Terrestrial Radio Access (E-UTRA);
User Equipment (UE) procedures in idle mode\".
[24] 3GPP TS 23.122: \"Non-Access-Stratum (NAS) functions related to Mobile
Station (MS) in idle mode\".
[25] IETF RFC 3023: \"XML Media Types\".
[26] IETF RFC 4288: \"Media Type Specifications and Registration Procedures\".
[27] 3GPP TS 32.277: \"Proximity-based Services (ProSe) charging\".
[28] IETF RFC 1166: \"Internet Numbers\".
[29] IETF RFC 5952: \"A Recommendation for IPv6 Address Text Representation\".
[30] 3GPP TS 24.008: \"Mobile Radio Interface Layer 3 specification; Core
Network Protocols; Stage 3\".
[31] 3GPP TS 29.343: \"Proximity-services (ProSe) function to ProSe
application server aspects (PC2); Stage 3\".
[32] ITU-T Recommendation E.212: \"The international identification plan for
mobile terminals and mobile users\".
[33] IETF RFC 4861: \"Neighbor Discovery for IP version 6 (IPv6)\".
[34] 3GPP TS 23.401: \"General Packet Radio Service (GPRS) enhancements for
Evolved Universal Terrestrial Radio Access Network (E-UTRAN) access\".
[35] 3GPP TS 23.221: \"Architectural requirements\".
[36] IETF RFC 4291: \"IP Version 6 Addressing Architecture\".
[37] 3GPP TS 36.323: \"Packet Data Convergence Protocol (PDCP)
specification\".
[38] 3GPP TS 23.179: \"Functional architecture and information flows to
support mission critical communication services\".
[39] IETF RFC 6507: \"Elliptic Curve-Based Certificateless Signatures for
Identity-Based Encryption (ECCSI)\".
[40] IETF RFC 6508: \"Sakai-Kasahara Key Encryption (SAKKE)\".
[41] 3GPP TS 33.102: \"3G Security; Security architecture\".
[42] 3GPP TS 33.233: \"Generic Authentication Architecture (GAA); Generic
Bootstrapping Architecture (GBA) Push function\".
[43] 3GPP TS 24.007: \"Mobile radio interface signalling layer 3; General
aspects\".
# 3 Definitions, symbols and abbreviations
## 3.1 Definitions
For the purposes of the present document, the terms and definitions given in
3GPP TR 21.905 [1] and the following apply. A term defined in the present
document takes precedence over the definition of the same term, if any, in
3GPP TR 21.905 [1].
**ProSe Function CTF (ADF):** Accounting Data Forwarding (ADF) function block
of the Charging Trigger Function (CTF) in the ProSe Function.
**Usage information report:** usage information related to one collection
period.
**Usage information report list:** one or more usage information report(s) and
associated with a UE identity.
**Not served by E-UTRAN:** the UE is either:
\- outside of E-UTRAN coverage;
\- within E-UTRAN coverage but not camped on any cell;
\- within E-UTRAN coverage but camped on a non-E-UTRAN cell; or
\- camped on an E-UTRAN cell not operating on the carrier frequency
provisioned for ProSe direct service.
**Open ProSe direct discovery:** a type of ProSe direct discovery without
explicit permission from the ProSe-enabled UE being discovered.
**Restricted ProSe direct discovery:** a type of ProSe direct discovery that
only takes place with explicit permission from the ProSe-enabled UE being
discovered.
For the purposes of the present document, the following terms and definitions
given in 3GPP TS 23.303 [2] apply:
**Local PLMN**
**ProSe-enabled UE**
**Geographical area**
**ProSe Query Code**
**ProSe Response Code**
**Discovery Query Filter**
**Discovery Response Filter**
**Restricted ProSe Application User ID**
**ProSe Discovery UE ID**
**Discovery Entry ID**
**ProSe Restricted Code**
**Relay Service Code**
**User Info ID**
**Discovery Group ID**
**ProSe Per-Packet Priority**
**ProSe Layer 2 Group ID**
**ProSe Per-Packet Reliability (PPPR)**
**ProSe UE-to-Network Relay**
**Remote UE**
**Application Layer Group ID**
For the purposes of the present document, the following terms and definitions
given in 3GPP TS 23.003 [4] apply:
**ECGI**
**TMGI**
## 3.2 Abbreviations
For the purposes of the present document, the abbreviations given in 3GPP TR
21.905 [1] and the following apply. An abbreviation defined in the present
document takes precedence over the definition of the same abbreviation, if
any, in 3GPP TR 21.905 [1].
ACE Application-Controlled Extension
ADF Accounting Data Forwarding function block
CTF Charging Trigger Function
DUCK Discovery User Confidentiality Key
DUIK Discovery User Integrity Key
DUSK Discovery User Scrambling Key
ECCSI Elliptic Curve-based Certificateless Signatures for Identity-based
Encryption
ECGI E-UTRAN Cell Global Identification
FQDN Fully Qualified Domain Name
GPI GBA Push Information
MBMS Multimedia Broadcast/Multicast Service
MIC Message Integrity Check
MIME Multi-Purpose Internet Mail Extensions
PDUID ProSe Discovery UE ID
ProSe Proximity-based Services
PRUK ProSe Relay User Key
RPAUID Restricted ProSe Application User ID
SAI Service Area Identifier
SAKKE Sakai-Kasahara Key Encryption
TMGI Temporary Mobile Group Identity
TTL Time To Live
UUID Universally Unique IDentifier
# 4 General
## 4.1 Overview
Proximity-based Services (ProSe) are services that can be provided by the 3GPP
system based on UEs being in proximity to each other. In this release of the
document, the 3GPP system enablers for ProSe include the following functions:
\- ProSe direct discovery (using E-UTRA or WLAN technology);
\- ProSe direct communication;
\- EPC-level ProSe discovery; and
\- EPC support for WLAN direct discovery and communication.
Among the above functions, ProSe direct discovery and EPC-level ProSe
Discovery is applicable for both Public Safety UE and non-Public Safety UE.
ProSe direct communication is applicable for Public Safety UE only.
In this release of the document, the stand-alone procedure for EPC support for
WLAN direct discovery and communication is not supported.
The communication security over the PC3 interface is specified in 3GPP TS
33.303 [6]. The communication security over the PC3ch interface is the same as
communication security over the PC3 interface specified in 3GPP TS 33.303 [6].
# 5 ProSe service authorisation and authorisation update procedure
## 5.1 Service authorisation and authorisation update for ProSe direct
discovery and ProSe direct communication
### 5.1.1 General
The service authorisation for ProSe direct discovery and ProSe direct
communication determines whether the UE is authorised to use ProSe direct
discovery (based on E-UTRA or WLAN technology) and ProSe direct communication,
in a particular PLMN or when not served by E-UTRAN. In this release of the
specification, ProSe direct communication using E-UTRA technology is supported
only for Public Safety ProSe-enabled UE. The service authorisation is either:
1) pre-configured in the UE. The pre-configured service authorisation may be
stored in the ME, or in the USIM as specified in 3GPP TS 31.102 [17], or in
both the ME and the USIM. If both the ME and the USIM contain the same
parameters, the values stored in the USIM shall take precedence. The UE shall
not use the pre-configured service authorisation if the contents of the USIM
indicate that the UE is not authorised to use them (see 3GPP TS 31.102 [17]);
or
2) transferred between the UE and the ProSe Function over the PC3 interface
with the ProSe Direct Services Provisioning Management Object or the ProSe
Public Safety Direct Services Provisioning Management Object as specified in
3GPP TS 24.333 [9].
When using option 2) above, the UE shall request service authorisation to use
ProSe direct discovery or ProSe direct communication or both from the ProSe
Function of the HPLMN. As specified in 3GPP TS 29.345 [5], the ProSe Function
of the HPLMN contacts the ProSe Function of each local PLMN or VPLMN to obtain
the service authorisation, merges it with its own service authorisation and
sends the merged service authorisation to the UE.
NOTE 1: How the Prose Function in the HPLMN merges the authorisation policy is
implementation dependent.
The service authorisation provided by the ProSe Function of the HPLMN for
E-UTRA-based ProSe direct discovery for non-public safety use contains a list
of PLMNs in which the UE is authorised to use ProSe direct discovery. The
service authorisation provided by the ProSe Function of the HPLMN for WLAN-
based ProSe direct discovery for non-public safety use contains a list of
PLMNs whose ProSe Application IDs the UE is authorised to use to perform WLAN-
based ProSe direct discovery.
The service authorisation provided by the ProSe Function of the HPLMN for
ProSe direct discovery for public safety use indicates:
\- the list of PLMNs in which the UE is authorised to use ProSe direct
discovery for public safety use when served by E-UTRAN;
\- whether the UE is authorised to perform ProSe direct discovery for public
safety use when not served by E-UTRAN, and if so, the required radio
parameters to be used for ProSe direct discovery for public safety use when
not served by E-UTRAN;
\- the group member discovery related parameters; and
\- the ProSe UE-to-network relay related parameters.
NOTE 2: The provisioning and use of of radio parameters for ProSe direct
discovery for public safety use as described in this clause does not apply to
WLAN-based ProSe direct discovery.
The service authorisation provided by the ProSe Function of the HPLMN for
ProSe direct communication indicates:
\- whether the UE is authorised to perform ProSe direct communication when not
served by E-UTRAN, and if so, the required radio parameters to be used for
ProSe direct communication when not served by E-UTRAN;
\- the ProSe direct communication policy parameters;
\- the list of PLMNs in which the UE is authorised to use direct communication
when served by E-UTRAN; and
\- the usage information reporting configuration.
Alternatively, the ProSe direct communication policy parameters, the group
member discovery related parameters and certain ProSe UE-to-network relay
related parameters (i.e. items a, c and f in the parameters related to ProSe
UE-to-network relaying in subclause 5.1.3) mentioned above can be provided by
the third party public safety provider application server, using mechanisms
that are out of scope of the present specification. If the UE receives the
same parameters associated with the same Application Layer Group ID from the
third party public safety provider application server as those which had been
previously transferred between the UE and the ProSe Function over the PC3
interface with the ProSe Public Safety Direct Services Provisioning Management
Object, the UE shall use the parameters provided by the third party public
safety provider application server for ProSe direct communication.
The UE discovers the IP address of the ProSe Functions of the HPLMN as
specified in subclause 5.1.2.
Optionally, the operator can configure the UE with configuration parameters
for establishment of the PDN connection for reaching the HPLMN ProSe Function.
If the UE is configured with the configuration parameters for establishment of
the PDN connection for reaching the HPLMN ProSe Function (see 3GPP TS 24.333
[9]):
a) if a PDN connection for reaching the HPLMN ProSe Function is not
established yet, the UE shall establish the PDN connection for reaching the
HPLMN ProSe Function according to the UE configuration and shall send the HTTP
request message via the PDN connection for reaching the HPLMN ProSe Function;
and
b) if a PDN connection for reaching the HPLMN ProSe Function is already
established either due to other ProSe feature or due to other application, the
UE shall send the HTTP request message via the PDN connection for reaching the
HPLMN ProSe Function.
After the UE is authorised to use ProSe direct discovery or ProSe direct
communication or both, the ProSe Function of the HPLMN shall update the
service authorisation:
a) when the ProSe Function of the HPLMN is informed the ProSe related
subscription data is updated at the HSS;
b) when the ProSe Function of the HPLMN decides to revoke the authorisation
for ProSe direct service;
c) when the ProSe Function of the HPLMN is informed the ProSe Function of the
VPLMN or local PLMN decides to revoke the authorisation for ProSe direct
service; or
d) when the ProSe Function of the HPLMN decides to update the ProSe Discovery
UE ID of the UE before the timer T4018 expires.
The ProSe Function of the HPLMN sends the updated authorisation for ProSe
direct service to the UE, e.g. by sending an OMA push message. If the update
of service authorisation is triggered to revoke the authorisation for ProSe
direct service, the updated authorization for ProSe direct service does not
include:
a) the authorization for ProSe direct service (discovery or communication or
both) which is to be revoked; and
b) the PLMN ID of the PLMN in which the service authorisation is to be
revoked.
If the update of service authorisation is triggered to update the ProSe
Discovery UE ID of the UE, the updated authorisation for ProSe direct service
includes the new ProSe Discovery UE ID assigned to the UE and the associated
validity timer T4015. The UE then sends the new ProSe Discovery UE ID to the
ProSe Application Server, using mechanisms that are out of scope of the
present specification.
NOTE 3: The ProSe Function of the HPLMN can send the updated authorisation for
ProSe direct service to the UE immediately or wait for the next time when the
UE communicates with the ProSe Function of the HPLMN based on operator\'s
policy; in the latter case, the UE is allowed to use ProSe direct services
until the next time that it will communicate with the ProSe Function of the
HPLMN.
### 5.1.2 ProSe Function discovery
The IP address of the ProSe function in the HPLMN may be pre-configured in the
UE and in this case, the UE may use the pre-configured IP address.
Alternatively, the FQDN of the ProSe Function in the HPLMN may be self-
constructed by the UE, i.e. derived from the PLMN ID of the HPLMN. The UE may
perform DNS lookup as specified in IETF RFC 1035 [10].
### 5.1.3 Service authorisation from ProSe Function
The UE shall initiate the service authorisation procedure to the ProSe
Function of the HPLMN:
a) when the UE receives a request from upper layer to perform open ProSe
direct discovery announcing or monitoring, restricted ProSe direct discovery
model A announcing or monitoring, restricted ProSe direct discovery model B
discoverer operation or discoveree operation, or direct communication and has
no valid service authorisation;
b) when the UE is performing open ProSe direct discovery announcing or
monitoring, restricted ProSe direct discovery model A announcing or
monitoring, restricted ProSe direct discovery model B discoverer operation or
discoveree operation, or direct communication and changes its registered PLMN
to a PLMN which is not included in the list of PLMNs in which the UE is
authorised to perform the corresponding service, and the request from upper
layer to perform the corresponding service is still in place in the new
registered PLMN;
c) when timer T4005 associated with a valid service authorisation policy
expires and the request from upper layer to perform open ProSe direct
discovery announcing or monitoring, restricted ProSe direct discovery model A
announcing or monitoring, restricted ProSe direct discovery model B discoverer
operation or discoveree operation, or direct communication in the
corresponding PLMN is still in place; or
d) when timer T4015 associated with a ProSe Discovery UE ID expires and the
request from upper layer to perform restricted ProSe direct discovery model A
announcing or monitoring, restricted ProSe direct discovery model B discoverer
operation or discoveree operation is still in place.
NOTE 1: In order to ensure continuity of ProSe direct discovery service or
ProSe direct communication service, the UE can request service authorisation
from the ProSe Function of the HPLMN before the timer T4005 associated with a
service authorisation policy in a PLMN expires or the timer 4015 associated
with a ProSe Discovery UE ID expires.
The UE shall obtain the service authorisation from the ProSe Function of the
HPLMN over the PC3 interface by requesting the ProSe Direct Services
Provisioning Management Object or the ProSe Public Safety Direct Services
Provisioning MO as specified in 3GPP TS 24.333 [9]. The UE waits for an
implementation dependent time for an answer from the ProSe Function. If the
ProSe Function does not respond within that time, the UE may retry the service
authorisation procedure. The number of retries performed by the UE is
implementation dependent. Unless the UE receives a response from the ProSe
function for service authorisation, the UE shall not consider that the request
has been authorised.
The ProSe direct discovery service authorisation from the ProSe Function of
the HPLMN may include:
a) the PLMNs in which the UE is authorised to perform open ProSe direct
discovery monitoring, and for each PLMN a timer T4005 indicating for how long
the monitoring authorisation policy in that PLMN is valid;
b) the PLMNs in which the UE is authorised to perform open ProSe direct
discovery announcing , and for each PLMN, it indicates:
1) a timer T4005 indicating for how long the announcing authorisation policy
in that PLMN is valid; and
2) the authorised announcing range (short/medium/long).
c) void;
d) void;
e) void;
f) void;
g) the PLMNs in which the UE is authorised to perform restricted ProSe direct
discovery model A monitoring, and for each PLMN a timer T4005 indicating for
how long the monitoring authorisation policy in that PLMN is valid;
h) the PLMNs in which the UE is authorised to perform restricted ProSe direct
discovery model A announcing, and for each PLMN, it indicates:
1) a timer T4005 indicating for how long the announcing authorisation policy
in that PLMN is valid; and
2) the authorised announcing range (short/medium/long).
i) the PLMNs in which the UE is authorised to perform restricted ProSe direct
discovery model B discoverer operation, and for each PLMN, it indicates:
1) a timer T4005 indicating for how long the discoverer operation
authorisation policy in that PLMN is valid; and
2) the authorised discoverer operation range (short/medium/long).
j) the PLMNs in which the UE is authorised to perform restricted ProSe direct
discovery model B discoveree operation, and for each PLMN, it indicates:
1) a timer T4005 indicating for how long the discoveree operation
authorisation policy in that PLMN is valid; and
2) the authorised discoveree operation range (short/medium/long).
k) the ProSe Discovery UE ID assigned to the UE for restricted ProSe direct
discovery with an associated timer T4015 indicating for how long this ProSe
Discovery UE ID is valid; and
l) the PLMNs whose ProSe Application IDs the UE is authorised to use to
perform WLAN-based ProSe direct discovery.
The ProSe direct discovery for public safety use service authorisation from
the ProSe Function of the HPLMN may include:
a) the PLMNs in which the UE is authorised to perform ProSe direct discovery
for public safety use announcing, and for each PLMN, it indicates:
1) a timer T4005 indicating for how long the authorisation policy for that
operation is valid; and
2) the authorised announcing range (short/medium/long);
b) whether the UE is authorised to perform ProSe direct discovery for public
safety use announcing when the UE is not served by E-UTRAN;
c) the PLMNs in which the UE is authorised to perform ProSe direct discovery
for public safety use monitoring, and for each PLMN, a timer T4005 indicating
for how long the authorisation policy for that operation is valid;
d) whether the UE is authorised to perform ProSe direct discovery for public
safety use monitoring when the UE is not served by E-UTRAN;
e) the PLMNs in which the UE is authorised to perform ProSe direct discovery
for public safety use discoverer operation, and for each PLMN, it indicates:
1) a timer T4005 indicating for how long the authorisation policy for that
operation is valid; and
2) the authorised discoveree operation range (short/medium/long);
f) whether the UE is authorised to perform ProSe direct discovery for public
safety use discoverer operation when the UE is not served by E-UTRAN;
g) the PLMNs in which the UE is authorised to perform ProSe direct discovery
for public safety use discoveree operation, and for each PLMN, it indicates;
1) a timer T4005 indicating for how long the authorisation policy for that
operation is valid; and
2) the authorised discoverer operation range (short/medium/long);
h) whether the UE is authorised to perform ProSe direct discovery for public
safety use discoveree operation when the UE is not served by E-UTRAN; and
i) the radio parameters to be used for ProSe direct discovery for public
safety use when not served by E-UTRAN and the geographical area(s) in which
the UE is allowed to use these radio parameters.
NOTE 2: The provisioning and use of of radio parameters for ProSe direct
discovery for public safety use as described in this clause does not apply to
WLAN-based ProSe direct discovery.
NOTE 3: The authorised announcing range, authorised discoverer operation range
and authorised discoveree operation range as indicated above and in this
clause do not apply to WLAN-based ProSe direct discovery. When WLAN-based
ProSe direct discovery is used the range is determined by the underlying WLAN
technology.
The ProSe direct discovery for public safety use service authorisation from
the ProSe Function of the HPLMN may include the following parameters related
to ProSe UE-to-network relaying:
a) the User Info ID for the UE-to-network relay discovery;
b) the PLMNs in which the UE is authorised to act as a UE-to-network relay
when the UE is served by E-UTRAN, and for each PLMN:
1) whether the relay needs to report the IMEI/IMEISV of the remote UE(s)
connected to or disconnected from the relay; and
2) a timer T4005 indicating for how long the authorisation policy for that
operation is valid;
c) for each connectivity service provided by a UE-to-network relay:
1) the Relay Service Code identifying the connectivity service;
2) optionally the PDN type to be used for the relayed traffic of the
connectivity service. If the PDN type is not provisioned, the IPv4v6 is used
for the relayed traffic of the connectivity service;
3) optionally the APN to be used for the relayed traffic of the connectivity
service. If the APN is not provisioned, the default APN is used for the
relayed traffic of the connectivity service;
4) the ProSe Relay UE ID; and
5) the address of the ProSe Key Management Function that the UE shall use to
obtain security contents;
d) whether the UE is authorised to act as a remote UE towards a UE-to-network
relay;
e) void;
f) for each connectivity service authorised to be accessed by the remote UE:
1) the Relay Service Code identifying the connectivity service;
2) the IP version(s) to be used for the traffic of the connectivity service;
3) optionally the User Info ID of the UE-to-network relay providing the
connectivity service; and
4) the address of the ProSe Key Management Function that the UE shall use to
obtain security contents; and
g) mapping rules between the QCI of EPS bearer and the ProSe Per-Packet
Priority for downlink unicast traffic relayed over the PC5 interface.
The ProSe direct discovery for public safety use service authorisation from
the ProSe Function of the HPLMN may include the following parameters related
to group member discovery, for each application layer group:
a) the User Info ID for the group member discovery;
b) the Discovery Group ID identifying the discovery group;
c) the Application Layer Group ID identifying an application layer group that
the UE belongs to; and
d) the address of the ProSe Key Management Function that the UE shall use to
obtain security contents.
The one-to-many ProSe direct communication service authorisation from the
ProSe Function of the HPLMN may include:
a) whether the UE is authorised to perform one-to-many ProSe direct
communication when not served by E-UTRAN;
b) the radio parameters to be used for one-to-many ProSe direct communication
when not served by E-UTRAN as defined in 3GPP TS 36.331 [12] and the
geographical area(s) in which the UE is allowed to use these radio parameters;
c) the PLMNs in which the UE is authorised to perform one-to-many ProSe direct
communication when served by E-UTRAN, and for each PLMN a timer T4005
indicating for how long the one-to-many direct communication authorisation
policy in that PLMN is valid; and
d) the one-to-many ProSe Direct communication policy parameters, consisting
of, for each application layer group:
1) the ProSe Layer-2 Group ID;
2) the ProSe Group IP multicast address;
3) whether the UE should use IPv4 or IPv6 for that group;
4) an IPv4 address to be used by the UE as a source address in case IPv4 is
used;
5) the address of the ProSe Key Management Function that the UE shall use to
obtain group-related security contents; and
6) the Application Layer Group ID identifying an application layer group that
the UE belongs to; and
e) the usage information reporting configuration, including:
1) the address of the server to which the UE shall upload the usage
information reports;
2) the collection period;
3) the reporting window;
4) whether or not the UE shall report the Group Parameters in the usage
information;
5) whether or not the UE shall report the time stamps of the first
transmission/reception during the collection period in the usage information;
6) whether or not the UE shall report the amount of data transmitted during
the collection period in the usage information, and whether with location
information;
7) whether or not the UE shall report the amount of data received during the
collection period in the usage information, and whether with location
information;
8) whether or not the UE shall report the time stamps when it went in and out
of E-UTRAN coverage during the collection period in the usage information;
9) whether or not the UE shall report the list of locations of the UE when in
E-UTRAN coverage during the reporting period in the usage information; and
10) whether or not the UE shall report the radio parameters used for ProSe
direct communication (i.e. indicator of which radio resources used and radio
frequency used) during the reporting period in the usage information.
The one-to-one ProSe direct communication service authorisation from the ProSe
Function of the HPLMN may include:
a) whether the UE is authorised to perform one-to-one ProSe direct
communication when not served by E-UTRAN;
b) the radio parameters to be used for one-to-one ProSe direct communication
when not served by E-UTRAN as defined in 3GPP TS 36.331 [12] and the
geographical area(s) in which the UE is allowed to use these radio parameters;
c) the PLMNs in which the UE is authorised to perform one-to-one ProSe direct
communication when served by E-UTRAN, and for each PLMN a timer T4005
indicating for how long the one-to-one direct communication authorisation
policy in that PLMN is valid; and
d) the one-to-one ProSe direct communication policy parameters, consisting of:
\- the ProSe Per-Packet Priority value for PC5 signalling messages; and
\- for each application layer group,
1) the Layer 2 ID used for unicast communication;
2) void;
3) the address of the Key Management Server that the UE shall use to obtain
security contents; and
4) the Application Layer Group ID identifying an application layer group that
the UE belongs to.
NOTE 4: ProSe communication operation is not applicable to local PLMNs.
The ProSe Function of the HPLMN is allowed to take the serving PLMN of the UE
into account when including the authorised PLMNs in the service authorisation
to the UE.
The UE shall start the timer(s) T4005 with the values included in this service
authorisation. The UE shall consider that an authorisation policy is valid in
the associated PLMN until the corresponding the timer T4005 expires or is
stopped.
# 6 ProSe direct discovery
## 6.1 Overview
This clause describes the PC3 Control Protocol procedures between the UE and
the ProSe Function for ProSe direct discovery announcing and monitoring. It
also describes the ProSe Protocol procedures at the UE for ProSe direct
discovery of other ProSe-enabled UEs over the PC5 interface.
### 6.1.1 Transport protocol for PC3 Control Protocol messages for ProSe
direct discovery
The UE and ProSe Function shall use HTTP 1.1 as specified in IETF RFC 7230
[18] and IETF RFC 7231 [19] as the transport protocol for ProSe messages over
the PC3 interface. The ProSe messages described here shall be included in the
body of either an HTTP request message or an HTTP response message. The
following rules apply:
### 6.1.2 Handling of UE-initiated procedures
The following rules apply for UE-initiated procedures:
\- The UE initiates ProSe transactions with an HTTP request message containing
the PC3 request(s);
\- The ProSe Function responds to the requests with an HTTP response message
containing the PC3 response(s) for the PC3 request(s); and
\- HTTP POST methods are used for PC3 direct discovery procedures.
Optionally, the operator can configure the UE with configuration parameters
for establishment of the PDN connection for reaching the HPLMN ProSe Function.
If the UE is configured with the configuration parameter for establishment of
the PDN connection for reaching the HPLMN ProSe Function (see 3GPP TS 24.333
[9]):
a) if a PDN connection for reaching the HPLMN ProSe Function is not
established yet, the UE shall establish the PDN connection for reaching the
HPLMN ProSe Function according to the UE configuration and shall send the HTTP
request message via the PDN connection for reaching the HPLMN ProSe Function;
and
b) if a PDN connection for reaching the HPLMN ProSe Function is already
established (e.g. either due to other ProSe feature or due to other
application), the UE shall send the HTTP request message via the PDN
connection for reaching the HPLMN ProSe Function;
### 6.1.3 Handling of ProSe Function-initiated procedures
#### 6.1.3.1 General
The ProSe Function-initiated messages for ProSe direct discovery over the PC3
interface shall be contained in an HTTP response message. Either HTTP long
polling, or OMA Push, can be used to trigger the HTTP request corresponding to
this HTTP response message. The UE and the ProSe Function shall support OMA
Push for network initiated procedures. Optionally the UE and ProSe Function
should support long polling as well for network initiated procedures.
If the UE supports the HTTP long polling, the UE shall include a Network-
Initiated Transaction Method set to \"HTTP long polling\" in the
DISCOVERY_REQUEST message to the ProSe Function.
Upon receiving a DISCOVERY_REQUEST message containing a Network-Initiated
Transaction Method set to \"HTTP long polling\", if the ProSe Function
supports the HTTP long polling and wants to use the HTTP long polling for
network initiated procedures, the ProSe Function shall include a Network-
Initiated Transaction Method set to \"HTTP long polling\" in the
DISCOVERY_RESPONSE message. Otherwise the ProSe Function shall not include a
Network-Initiated Transaction Method in the DISCOVERY_RESPONSE message.
If the UE receives a DISCOVERY_RESPONSE message including a Network-Initiated
Transaction Method set to \"HTTP long polling\", the UE shall use the HTTP
long polling for network initiated procedures. Otherwise, the UE shall assume
that the ProSe Function uses OMA Push for network initiated procedures.
#### 6.1.3.2 HTTP long polling
The HTTP long polling method involves the following steps:
a) the UE sends an empty HTTP request message as a polling request when it
expects network initiated message(s) over the PC3 interface;
b) the ProSe Function defers its response to the UE\'s request until;
i) one ore more network-initiated PC3 message(s) for the UE are available. The
ProSe Function encloses the message(s) in an HTTP response message and send it
to the UE; or
ii) a particular timeout for HTTP polling has occurred. The ProSe Function
then sends an empty HTTP response message as the polling response to the UE.
c) After receiving the response from the ProSe Function, the UE may keep
polling after some waiting period if:
i) the UE receives an empty polling response; or
ii) the UE receives prose function-initiated message(s) from the ProSe
Function but still expects additional network-initiated message(s).
NOTE: The implementation of the HTTP polling process can be coordinated with
the SUPL (Secure User Plane Location) procedures to synchronize the SUPL
location report procedures and the HTTP polling procedure so as to reduce
unnecessary wait time of polling.
If the UE is trigged to send a PC3 message to the ProSe Function while it has
a pending HTTP polling request, the UE shall open another HTTP connection to
the ProSe Function to send this new request. Alternately the UE may always use
a separate dedicated HTTP connection for polling.
#### 6.1.3.3 OMA Push
The OMA Push method involves the following steps:
a) if one or more network-initiated PC3 message(s) for the UE are available,
the ProSe Function sends a push message containing a particular URL to the UE
via the OMA-Push Architecture as defined in OMA-AD-Push-V2_2-20110809-A [22].
The URL is linked to the PC3 message(s) to be sent to the UE. The ProSe
Function (performing OMA Push Proxy Gateway functionality) generates a Push
Message as specified in OMA-WAP-TS-PushOTA-V2_1-20110405-A [21] with the PDU
set according to WAP-168-ServiceLoad-20010731-a [20]. The URL information
shall be included in the PDU payload;
b) After receiving the push message, the UE retrieves the URL from the payload
of the message and sends an HTTP GET request to the ProSe Function with this
URL; and
c) the ProSe Function sends an HTTP response message containing the PC3
message(s) to the UE.
## 6.2 Procedures
### 6.2.1 Types of ProSe direct discovery procedures
The following PC3 Control Protocol procedures are defined:
\- announce request;
\- monitor request;
\- match report; and
\- network initiated direct discovery update.
In the following descriptions of PC3 Control Protocol procedures, the terms
\"request\" and \"response\" refer to the corresponding PC3 Control Protocol
messages, not to the HTTP request or response. The following procedure
descriptions use a single PC3 Control Protocol message for illustration
purposes.
NOTE: A single HTTP request message can contain multiple PC3 Control Protocol
requests and a single HTTP response message can contain multiple PC3 Control
Protocol responses.
### 6.2.2 Announce request procedure for open ProSe direct discovery
#### 6.2.2.1 General
The purpose of the announce request procedure for open ProSe direct discovery
is for the UE:
\- to obtain one or more ProSe Application Code(s) to be announced over the
PC5 interface, upon a request for announcing from upper layers as defined in
3GPP TS 23.303 [2];
\- to inform the ProSe Function that the UE wants to stop announcing a ProSe
Application Code as defined in 3GPP TS 23.303 [2]; or
\- to upload metadata associated with a ProSe Application ID to the ProSe
Function as defined in 3GPP TS 23.303 [2].
The UE shall be authorised for open ProSe direct discovery announcing in the
registered PLMN or the local PLMN based on the service authorisation procedure
as specified in clause 5, before initiating the announce request procedure.
NOTE: The notion of \"local PLMN\" does not apply for WLAN-based ProSe direct
discovery. The UE can engage in WLAN-based ProSe direct discovery as
announcing UE regardless of the serving PLMN or other PLMNs that provide
E-UTRAN coverage in the UE location.
The UE includes one of the ProSe Application Code(s) obtained as a result of a
successful announce request procedure per PC5_DISCOVERY message and passes the
PC5_DISCOVERY messages to the lower layers for transmission over the PC5
interface.
#### 6.2.2.2 Announce request procedure initiation
Before initiating the announce request procedure for open ProSe direct
discovery, the UE is configured with the data structure of the ProSe
Application IDs appropriate for its HPLMN. This step is performed using
mechanisms out of scope of 3GPP.
If the UE is authorised to perform E-UTRA-based open ProSe direct discovery
announcing in the PLMN operating the radio resources signalled from the
serving PLMN, or if the UE is authorised to perform WLAN-based open ProSe
direct discovery, it shall initiate an announce request procedure:
a) when the UE is triggered by an upper layer application to announce a ProSe
Application ID and the UE has no valid corresponding ProSe Application Code
for that upper layer application;
b) when the validity timer T4000 assigned by the ProSe Function to a ProSe
Application Code has expired and the request from upper layers to announce the
ProSe Application ID corresponding to that ProSe Application Code is still in
place;
c) when the UE selects a new PLMN while announcing a ProSe Application Code
and intends to announce in the new PLMN, and the UE is authorised for open
ProSe direct discovery announcing in the new PLMN;
d) when, while announcing a ProSe Application ID, the UE intends to switch the
announcing PLMN to a different PLMN without performing PLMN selection, and the
UE does not have a valid allocated ProSe Application Code for this new PLMN
yet; or
e) when the UE needs to inform the ProSe Function that the UE wants to stop
announcing a ProSe Application Code; or
f) when the UE needs to update metadata associated with a ProSe Application ID
to the ProSe Function.
When the UE selects a new PLMN while announcing a ProSe Application Code and
the UE is not yet authorised for open ProSe direct discovery announcing in the
new PLMN, the UE shall initiate an announce request procedure only after the
UE is authorised for open ProSe direct discovery announcing in the new PLMN.
NOTE 1: To ensure service continuity if the UE needs to keep announcing a
ProSe Application Code corresponding to the same ProSe Application ID, the UE
can initiate the announce request procedure before the TTL timer T4000
assigned by the ProSe Function for a Prose Application Code expires.
The UE initiates the announce request procedure for open ProSe direct
discovery by sending a DISCOVERY_REQUEST message with:
\- a new transaction ID;
\- the ProSe Application ID set to the ProSe Application ID received from
upper layers;
\- the command set to \"metadata_update\" if the UE has a valid ProSe
Application Code corresponding to the ProSe Application ID and intends to
update metadata associated with the ProSe Application ID to the ProSe
Function, otherwise set to \"announce\";
\- the UE identity set to the UE\'s IMSI;
\- the Application Identity set to the Application Identity of the upper layer
application that requested the announcing;
\- the Discovery Entry ID set to 0 when this is a new request or set to the
Discovery Entry ID received from the ProSe Function if the announce request is
to update a previously sent announce request;
\- the ACE Enabled Indicator set to \"application-controlled extension
enabled\" if application-controlled extension is required by the upper layers
or \"normal\" if application-controlled extension is not used;
\- optionally the Requested Timer set to the length of validity timer
associated with the ProSe Application Code that the UE expects to receive from
the ProSe Function;
\- optionally the Metadata set to the metadata received from upper layers
associated with the ProSe Application ID;
\- optionally in case of E-UTRA-based open ProSe direct discovery the
Announcing PLMN ID set to the PLMN ID of the local PLMN operating the radio
resources that the UE intends to use for announcing this ProSe Application ID;
and
\- optionally the PC5_tech set to the PC5 radio technology that the UE wishes
to use. PC5_tech may include more than one PC5 radio technology.
If open ProSe direct discovery with application-controlled extension is
requested by upper layers, the DISCOVERY_REQUEST message shall also include
the Application Level Container, which contains application-level data
transparent to the 3GPP network, to be used by the ProSe Application Server
e.g. to assign ProSe Application Code Suffix(es).
When the UE initiates the announce request procedure to inform the ProSe
Function that the UE wants to stop announcing a ProSe Application Code before
the associated valid timer expires, the UE shall set the Requested Timer to 0.
NOTE 2: A UE can include one or multiple transactions in one DISCOVERY_REQUEST
message for different ProSe Application IDs, and receive corresponding
\ element or \ element in a
DISCOVERY_RESPONSE message for each respective transaction. In the following
description of the announce request procedure, only one transaction is
included.
Figure 6.2.2.2.1 illustrates the interaction of the UE and the ProSe Function
in the announce request procedure.
Figure 6.2.2.2.1: Announce request procedure
#### 6.2.2.3 Announce request procedure accepted by the ProSe Function
Upon receiving a DISCOVERY_REQUEST message with the command set to
\"announce\", if the Requested Timer is included in the DISCOVERY_REQUEST
message and the Requested Timer is set to 0, the ProSe Function shall check
whether there is an existing UE context containing the discovery entry
identified by the Discovery Entry ID included in the DISCOVERY_REQUEST
message. If the discovery entry exists in the UE context, the ProSe Function
shall inform the ProSe Function in the announcing PLMN to remove the
corresponding discovery entry as specified in 3GPP TS 29.345 [5] when the
announcing PLMN is not the same as that of the PLMN to which the ProSe
Function belongs and remove the discovery entry identified by the Discovery
Entry ID from the UE\'s context. Then the ProSe Function shall send a
DISCOVERY_RESPONSE message containing a \ element with:
\- the transaction ID set to the value of the transaction ID received in the
DISCOVERY_REQUEST message, and
\- the Discovery Entry ID set to the identifier associated with the
corresponding discovery entry.
Upon receiving a DISCOVERY_REQUEST message with the command set to
\"announce\", if the Requested Timer is not included in the DISCOVERY_REQUEST
message or the Requested Timer included in the DISCOVERY_REQUEST message is
not set to 0, the ProSe Function shall perform the following procedure.
The ProSe Function shall check that the application corresponding to the
Application Identity contained in the DISCOVERY_REQUEST message is authorised
for open ProSe direct discovery announcing. If the application is authorised
for open ProSe direct discovery announcing, the ProSe Function may also check
whether the ProSe Application ID contained in the DISCOVERY_REQUEST message is
known. If the ProSe Application ID is known or the ProSe Function skips the
check of the ProSe Application ID, the ProSe Function shall check whether
there is an existing context for the UE associated with the requested ProSe
Application ID.
If there is no associated UE context, the ProSe Function checks with the HSS
whether the UE is authorised for open ProSe direct discovery announcing as
described in 3GPP TS 29.344 [3]. If the check indicates that the UE is
authorised then:
\- the ProSe Function shall check whether the UE is authorised to announce the
ProSe Application ID contained in the DISCOVERY_REQUEST message;
\- if the UE is authorised to announce the ProSe Application ID, the ACE
Enabled Indicator is included and set to \"application-controlled extension
enabled\", the Application Level Container is included in the
DISCOVERY_REQUEST message and the requested application uses application-
controlled extension, the ProSe Function shall check whether the UE is
authorised to use ACE. If the UE is authorised for ACE, the ProSe Function
shall invoke the procedure described in 3GPP TS 29.343 [31] to check whether
the UE is authorised to announce the requested ProSe Application ID with
application-defined suffix(es), and obtain suffix-related information from the
ProSe Application Server. The ProSe Function shall then allocate one ProSe
Application Code Prefix and a value for validity timer T4000 to be used with
the ProSe Application Code Suffix(es) obtained from the ProSe Application
Server for the given ProSe Application ID as specified in 3GPP TS 29.343 [31].
The ProSe Function may take into account the Requested Timer if contained in
the DISCOVERY_REQUEST message;
\- if the UE is authorised to announce the ProSe Application ID, the ACE
Enabled Indicator is included and set to \"normal\" in the DISCOVERY_REQUEST
message and the requested application does not use application-controlled
extension, the ProSe Function shall allocate the corresponding ProSe
Application Code(s) and a value for validity timer T4000. The ProSe Function
may take into account the Requested Timer if contained in the
DISCOVERY_REQUEST message;
\- if the UE is authorised to announce the ProSe Application ID, the ACE
Enabled Indicator is set included and to \"normal\" in the DISCOVERY_REQUEST
message, the Application Level Container is included in the DISCOVERY_REQUEST
and the requested application only uses application-controlled extension, the
ProSe Function shall check whether the UE is authorised to use ACE. If the UE
is authorised for ACE, the ProSe Function shall invoke the procedure described
in 3GPP TS 29.343 [31] to check whether the UE is authorised to announce the
requested ProSe Application ID with application-defined suffix(es), and obtain
suffix-related information from the ProSe Application Server. The ProSe
Function shall then allocate one ProSe Application Code Prefix and a value for
validity timer T4000 to be used with the ProSe Application Code Suffix(es)
obtained from the ProSe Application Server for the given ProSe Application ID
as specified in 3GPP TS 29.343 [31]. The ProSe Function may take into account
the Requested Timer if contained in the DISCOVERY_REQUEST message;
\- if the UE is authorised to announce the ProSe Application ID, the ACE
Enabled Indicator is included and set to \"application-controlled-extension
enabled\" and the Application Level Container is included in the
DISCOVERY_REQUEST message but the requested application does not use
application-controlled extension, the ProSe Function shall allocate the
corresponding ProSe Application Code(s) and a value for validity timer T4000.
The ProSe Function may take into account the Requested Timer if contained in
the DISCOVERY_REQUEST message; and
\- if the UE is authorised to announce the ProSe Application ID and the ACE
Enabled Indicator is not included in the DISCOVERY_REQUEST message, the ProSe
Function shall allocate the corresponding ProSe Application Code(s) and a
value for validity timer T4000. The ProSe Function may take into account the
Requested Timer if contained in the DISCOVERY_REQUEST message.
NOTE 1: A UE implementing a previous release of the protocol will not include
the ACE Enabled Indicator in the DISCOVERY_REQUEST message.
NOTE 2: The ProSe Function can allocate multiple ProSe Application Codes for a
given ProSe Application ID for instance in the case when one or more labels in
the ProSe Application ID Name are wild carded as described in subclause 24.2.2
of 3GPP TS 23.003 [4].
If the requested ProSe Application ID is country-specific or global as
described in subclause 24.2 of 3GPP TS 23.003 [4], the ProSe Function shall
allocate the corresponding ProSe Application Code(s) or ProSe Application Code
Prefix according to subclause 24.3 of 3GPP TS 23.003 [4]. The temporary
identity part of each ProSe Application Code or ProSe Application Code Prefix
is taken from the data structure corresponding to the country-specific or
global ProSe Application ID namespace according to subclause 24.3 of 3GPP TS
23.003 [4]. The ProSe Function shall use the MCC and MNC of the PLMN ID of
this ProSe Function for the PLMN ID part of the ProSe Application Code or
ProSe Application Code Prefix.
After the ProSe Application Code(s) or ProSe Application Code Prefix
allocation, the ProSe Function then associates the ProSe Application Code(s)
or ProSe Application Code Prefix with a new discovery entry identified by a
non-zero value Discovery Entry ID in the new context for the UE that contains
the UE\'s subscription parameters obtained from the HSS, and starts timer
T4001. The HSS also provides to the ProSe Function the PLMN ID of the PLMN in
which the UE is currently registered. For a given set of ProSe Application
Codes or the allocated ProSe Application Code Prefix, timer T4001 shall be
longer than timer T4000. By default, the value of timer T4001 is 4 minutes
greater than the value of timer T4000.
If there is an existing context for the UE that contains the UE\'s
subscription parameters obtained from the HSS, but no discovery entry
identified by the Discovery Entry ID contained in the DISCOVERY_REQUEST
message, the ProSe Function shall behave as if the Discovery Entry ID included
in the DISCOVERY_REQUEST message was set to 0, and the ProSe Function shall
allocate a new non-zero Discovery Entry ID for this entry.
If the Metadata is included in the DISCOVERY_REQUEST message, the ProSe
Function shall allocate the ProSe Application Code or ProSe Application Code
Prefix including a Metadata Index to indicate the current version of the
Metadata, and store the received metadata in the UE context.
Moreover, if the command is set to \"metadata_update\" in the
DISCOVERY_REQUEST message and there is an existing UE context stored in the
ProSe Function, the ProSe Function shall update the metadata in the UE context
by using the received Medadata in the DISCOVERY_REQUEST message, and update
the ProSe Application Code or ProSe Application Code Prefix in the UE context
by changing the Metadata Index portion and keeping the rest unchanged.
After the ProSe Application Code(s) allocation, the ProSe Function then
associates the ProSe Application Code(s) with a new discovery entry identified
by a non-zero value Discovery Entry ID in the UE context, and starts timer
T4001.
If there is an existing context for the UE and a discovery entry identified by
the Discovery Entry ID contained in the DISCOVERY_REQUEST message associated
with the requested ProSe Application ID, the ProSe Function shall either
update the discovery entry with a new validity timer T4000, or allocate new
ProSe Application Code(s) or ProSe Application Code Prefix for the requested
ProSe Application ID with a new validity timer T4000, and restart timer T4001.
The ProSe Function may take into account the Requested Timer if contained in
the DISCOVERY_REQUEST message.
If a new discovery entry was created or an existing discovery entry was
updated and the UE is currently roaming or the Announcing PLMN ID is included
in the DISCOVERY_REQUEST message, the ProSe Function checks with the ProSe
Function of the VPLMN or in case of E-UTRA-based open ProSe direct discovery
the local PLMN identified by the Announcing PLMN ID whether the UE is
authorised for open ProSe direct discovery announcing as described in 3GPP TS
29.345 [5].
If the check indicates that the UE is authorised then the ProSe Function shall
send a DISCOVERY_RESPONSE message containing a \ element
with:
\- the transaction ID set to the value of the transaction ID received in the
DISCOVERY_REQUEST message from the UE;
\- either the ProSe Application Code(s) set to the ProSe Application Code(s)
allocated by the ProSe Function, or the ProSe Application Code ACE parameter
set to include the ProSe-Application Code- Prefix allocated by the ProSe
Function, and one or more ProSe Application Code Suffix Ranges which contain
the suffix(es) for the ProSe Application ID received in the DISCOVERY_REQUEST
message from the UE;
\- Validity Timer T4000 set to the T4000 timer value assigned by the ProSe
Function to the ProSe Application Code(s):
\- if the ACE Enabled Indicator was included by the UE in the
DISCOVERY_REQUEST message, the ACE Enabled Indicator set to:
\- \"application-controlled extension enabled\" if application-controlled
extension is used; or
\- \"normal\" if application-controlled extension is not used;
\- the Discovery Entry ID set to the identifier associated with the
corresponding discovery entry;
\- the Discovery Key set to a value provided by the ProSe Function; and
\- optionally the PC5_tech set to the one or more PC5 radio technologies that
are authorized to be used for the assigned ProSe Application Code(s) or the
assigned ProSe-Application Code- Prefix and the ProSe Application Code Suffix
Ranges.
If timer T4001 expires, the ProSe Function shall remove the discovery entry
identified by the Discovery Entry ID from the UE\'s context.
#### 6.2.2.4 Announce request procedure completion by the UE
Upon receipt of the DISCOVERY_RESPONSE message, if only the transaction ID and
the Discovery Entry ID are contained in the \ element and
the transaction ID and the Discovery Entry ID match the corresponding values
sent by the UE in a DISCOVERY_REQUEST message, the UE shall:
\- stop the validity timer T4000 corresponding to the ProSe Application
Code(s) or ProSe Application Code Prefix in the discovery entry identified by
the Discovery Entry ID;
\- remove the discovery entry identified by the Discovery Entry ID included;
and
\- instruct the lower layers to stop announcing.
Upon receipt of the DISCOVERY_RESPONSE message, if the transaction ID
contained in the \ element matches the value sent by the UE
in a DISCOVERY_REQUEST message with the command set to \"announce\", the UE
shall create a new discovery entry or update an existing discovery entry with
the received ProSe Application Code(s) and the PLMN ID of the intended
announcing PLMN. For this discovery entry, the UE shall stop the validity
timer T4000 if running and start the validity timer T4000 with the received
value. Otherwise the UE shall discard the DISCOVERY_RESPONSE message and shall
not perform the procedures below.
For any one of the received ProSe Application Codes or ProSe Application Code
Prefix in this discovery entry, the UE may perform open ProSe direct discovery
announcing as described below.
The UE requests the parameters from the lower layers for Prose direct
discovery announcing (see 3GPP TS 36.331 [12]). In case of E-UTRA-based open
ProSe direct discovery the UE shall perform direct discovery announcing only
if the lower layers indicate that ProSe direct discovery is supported by the
network. In case of E-UTRA-based open ProSe direct discovery if the UE in EMM-
IDLE mode has to request resources for ProSe direct discovery announcing as
specified in 3GPP TS 36.331 [12], the UE shall perform a service request
procedure or tracking area update procedure as specified in 3GPP TS 24.301
[11]. The UE shall obtain the UTC time for the next discovery transmission
opportunity for ProSe direct discovery from the lower layers.
If a valid UTC time is obtained, the UE shall generate the UTC-based counter
corresponding to this UTC time as specified in subclause 12.2.2.18. If the
resulting UTC-based counter is within Max Offset of the time shown by the
clock used for ProSe by the UE, the UE shall use the UTC-based counter and the
Discovery Key contained in the \ element of the
DISCOVERY_RESPONSE message to compute the MIC field for the PC5_DISCOVERY
message as described in 3GPP TS 33.303 [6].
The UE shall either use the ProSe Application Code received in the
DISCOVERY_RESPONSE message, or select one ProSe Application Code based on the
ProSe Application Code Prefix and ProSe Application Code Suffix Range(s)
received in the DISCOVERY_RESPONSE message as announced ProSe Application
Code, along with the MIC and the four least significant bits of the UTC-based
counter, in order to construct a PC5_DISCOVERY message, according to the
format defined in subclause 11.2.5.
NOTE: The UE can use different codes formed based on different ProSe
Application Code Suffixes to announce, without having to send a new
DISCOVERY_REQUEST message to the ProSe Function, as long as the validity timer
T4000 of the ProSe Application Code Prefix has not expired.
The UE then passes the PC5_DISCOVERY message, along with the PLMN ID of the
intended announcing PLMN, to the lower layers for transmission if:
\- the UE is currently authorised to perform open direct discovery announcing
in the registered PLMN or in case of E-UTRA-based open ProSe direct discovery
the local PLMN operating the radio resources that the UE intends to use;
\- the validity timer T4000 for the corresponding discovery entry allocated
ProSe Application Code or ProSe Application Code Prefix has not expired; and
\- a request from upper layers to announce the ProSe Application ID associated
with both the ProSe Application Code or ProSe Application Code Prefix and the
authorised Application Identity is still in place.
The UE shall ensure that it keeps on passing PC5_DISCOVERY messages to the
lower layers for transmission until the validity timer T4000 of the ProSe
Application Code or ProSe Application Code Prefix expires. How this is
achieved is left up to UE implementation.
During the announcing operation, if one of the above conditions is no longer
met, the UE may instruct the lower layers to stop announcing. When the UE
stops announcing, in case of E-UTRA-based open ProSe direct discovery if the
lower layers indicate that the UE is required to send a discovery indication
to the eNodeB and the UE is in EMM-CONNECTED mode, the UE shall trigger the
corresponding procedure in lower layers as specified in 3GPP TS 36.331 [12].
#### 6.2.2.5 Announce request procedure not accepted by the ProSe Function
If the DISCOVERY_REQUEST message cannot be accepted by the ProSe Function, the
ProSe Function sends a DISCOVERY_RESPONSE message containing a \ element to the UE including an appropriate PC3 Control Protocol cause
value.
If the application corresponding to the Application Identity contained in the
DISCOVERY_REQUEST message is not authorised for open ProSe direct discovery
announcing, the ProSe Function shall send the DISCOVERY_RESPONSE message
containing a \ element with PC3 Control Protocol cause value
#1 \"Invalid application\".
If the ProSe Application ID contained in the DISCOVERY_REQUEST message is
unknown to the ProSe Function, the ProSe Function shall send a
DISCOVERY_RESPONSE message containing a \ element with PC3
Control Protocol cause value #2 \"Unknown ProSe Application ID\".
If the UE is not authorised for open ProSe direct discovery announcing, the
ProSe Function shall send the DISCOVERY_RESPONSE message containing a
\ element with PC3 Control Protocol cause value #3 \"UE
authorisation failure\".
If the UE is not authorised to use the ProSe Application ID contained in the
DISCOVERY_REQUEST message, the ProSe Function shall send the
DISCOVERY_RESPONSE message containing a \ element with PC3
Control Protocol cause value #3 \"UE authorisation failure\".
If the UE requests a country-specific ProSe Application ID for a country that
does not correspond to the country of its HPLMN, and the ProSe Function has
not authorized the UE to announce in that country, the ProSe Function shall
send a DISCOVERY_RESPONSE message containing a \ element with
PC3 Control Protocol cause value #8 \"Scope Violation in Prose Application
ID\".
If the UE requests a country-specific ProSe Application ID for a country that
does not correspond to the country of its HPLMN, and the ProSe Function has no
agreement to access the country-wide ProSe Application ID database of that
country, the ProSe Function shall send a DISCOVERY_RESPONSE message containing
a \ element with PC3 Control Protocol cause value #8 \"Scope
Violation in Prose Application ID\".
If the Discovery Entry ID contained in the DISCOVERY_REQUEST message is
unknown to the ProSe Function and the Requested Timer is set to zero, the
ProSe Function shall send a DISCOVERY_RESPONSE message containing a
\ element with PC3 Control Protocol cause value # 10
\"Unknown or invalid Discovery Entry ID\".
If the UE is not authorised to use ACE, but the DISCOVERY_REQUEST message
contains the ACE Enabled Indicator set to \"application-controlled extension
enabled\", the ProSe Function shall send a DISCOVERY_RESPONSE message
containing a \ element with PC3 Control Protocol cause value
#12 \"UE unauthorised for discovery with Application-Controlled Extension\".
If the DISCOVERY_REQUEST message contains the ACE Enabled Indicator set to
\"application-controlled extension enabled\", but does not contain the
Application Level Container parameter, the ProSe Function shall send a
DISCOVERY_RESPONSE message containing a \ element with PC3
Control Protocol cause value #14 \"Missing Application Level Container\".
If the ProSe Application Server indicates to the ProSe Function that the
Application Level Container in the DISCOVERY REQUEST message contains invalid
information, the ProSe Function shall send a DISCOVERY_RESPONSE message
containing a \ element with PC3 Control Protocol cause value
#15 \"Invalid Data in Application Level Container\".
If the DISCOVERY_REQUEST message contains the ACE Enabled Indicator set to
\"application-controlled extension enabled\", but does not contain the
Application Level Container parameter, the ProSe Function shall send a
DISCOVERY_RESPONSE message containing a \ element with PC3
Control Protocol cause value #14 \"Missing Application Level Container\".
If the DISCOVERY_REQUEST message does not contain the ACE Enabled Indicator
and the requested application only uses application-controlled extension, the
ProSe Function shall send a DISCOVERY_RESPONSE message containing a
\ element with PC3 Control Protocol cause value #1 \"Invalid
Application\".
#### 6.2.2.6 Abnormal cases
##### 6.2.2.6.1 Abnormal cases in the UE
The following abnormal cases can be identified:
a) Indication from the transport layer of transmission failure of
DISCOVERY_REQUEST message (e.g. after TCP retransmission timeout)
The UE shall close the existing secure connection to the ProSe Function,
establish a new secure connection and then restart the announce request
procedure.
b) No response from the ProSe Function after the DISCOVERY_REQUEST message has
been successfully delivered (e.g. TCP ACK has been received for the
DISCOVERY_REQUEST message)
The UE shall retransmit the DISCOVERY_REQUEST message.
NOTE: The timer to trigger retransmission and the maximum number of allowed
retransmissions are UE implementation specific.
c) Indication from upper layers that the request to announce the ProSe
Application ID is no longer in place after sending the DISCOVERY_REQUEST
message, but before the announce request procedure is completed
The UE shall acknowledge the DISCOVERY_RESPONSE message received from the
ProSe Function but discard its contents and then abort the procedure.
d) Change of PLMN
If a PLMN change occurs before the announce request procedure is completed,
the procedure shall be aborted. If the UE is authorized to announce in the new
PLMN, the procedure shall be restarted once the UE is registered on the new
PLMN.
e) Absence of Discovery Entry ID parameter in a DISCOVERY_RESPONSE message
received in response to a DISCOVERY_REQUEST message which contained a
Discovery Entry ID parameter
If the DISCOVERY_REQUEST message:
\- included a Requested Timer which is set to 0; or
\- included an Announcing PLMN ID;
> the UE shall acknowledge the DISCOVERY_RESPONSE message received from the
> ProSe Function but discard its content and then abort the procedure.
##### 6.2.2.6.2 Abnormal cases in the ProSe Function
The following abnormal cases can be identified:
a) Indication from the lower layer of transmission failure of
DISCOVERY_RESPONSE message
After receiving an indication from lower layer that the DISCOVERY_RESPONSE
message has not been successfully acknowledged (e.g. TCP ACK is not received),
the ProSe Function shall abort the procedure, and stop any associated timer(s)
T4001, if running.
### 6.2.2A Announce request procedure for restricted ProSe direct discovery
model A
#### 6.2.2A.1 General
The purpose of the announce request procedure for restricted ProSe direct
discovery model A is for the UE:
\- to obtain a ProSe Restricted Code corresponding to the Restricted ProSe
Application User ID (RPAUID) to be announced over the PC5 interface, upon a
request for announcing from upper layers (e.g., application client) as defined
in 3GPP TS 23.303 [2]; or
\- to inform the ProSe Function that the UE wants to stop announcing a ProSe
Restricted Code as defined in 3GPP TS 23.303 [2].
Before initiating the announce request procedure, the UE shall be authorised
for restricted ProSe direct discovery model A announcing in the registered
PLMN or local PLMN based on the service authorisation procedure as specified
in clause 5.
NOTE: The notion of \"local PLMN\" does not apply for WLAN-based ProSe direct
discovery. The UE can engage in WLAN-based ProSe direct discovery as
announcing UE regardless of the serving PLMN or other PLMNs that provide
E-UTRAN coverage in the UE location.
The UE includes the ProSe Restricted Code obtained as a result of a successful
announce request procedure in a PC5_DISCOVERY message and passes the
PC5_DISCOVERY message to the lower layers for transmission over the PC5
interface.
#### 6.2.2A.2 Announce request procedure initiation
Before initiating the announce request procedure, the user sets the
permissions for the restricted discovery using application layer mechanisms.
The application client in the UE retrieves the PDUID provisioned to the UE as
part of the service authorisation procedure as specified in clause 5 and
obtains an RPAUID associated with the UE\'s PDUID from the ProSe Application
Server. The UE may provide metadata to be associated with the RPAUID, and the
ProSe Application Server stores the metadata. This step is performed using
mechanisms that are out of scope of the present specification.
If the UE is authorised to perform E-UTRA-based restricted ProSe direct
discovery model A announcing in the PLMN operating the radio resources
signalled from the serving PLMN, or if the UE is authorised to perform WLAN-
based retricted ProSe direct discovery model A, it shall initiate an announce
request procedure:
a) when the UE is triggered by an upper layer application to announce an
RPAUID and the UE has no valid corresponding ProSe Restricted Code for that
RPAUID of the upper layer application;
b) when the validity timer T4007 assigned by the ProSe Function to a ProSe
Restricted Code has expired and the request from upper layers to announce the
RPAUID corresponding to that ProSe Restricted Code is still in place;
c) when the UE selects a new PLMN while announcing a ProSe Restricted Code and
intends to announce in the new PLMN, and the UE is authorised for restricted
ProSe direct discovery model A announcing in the new PLMN;
d) when, while announcing a RPAUID, the UE intends to switch the announcing
PLMN to a different PLMN without performing PLMN selection, and the UE does
not have a valid allocated ProSe Restricted Code for this new PLMN yet; or
e) when the UE needs to update a previously sent restricted ProSe direct
discovery model A announcing request.
When the UE selects a new PLMN while announcing a ProSe Restricted Code and
the UE is not yet authorised for restricted ProSe direct discovery model A
announcing in the new PLMN, the UE shall initiate an announce request
procedure only after the UE is authorised for restricted ProSe direct
discovery model A announcing in the new PLMN.
NOTE 1: To ensure service continuity if the UE needs to keep announcing a
ProSe Restricted Code corresponding to the same RPAUID, the UE can initiate
the announce request procedure before the validity timer T4007 assigned by the
ProSe Function for a ProSe Restricted Code expires.
The UE initiates the announce request procedure by sending a DISCOVERY_REQUEST
message with:
\- a new transaction ID not used in any other direct discovery procedures in
PC3 interface;
\- the RPAUID set to the RPAUID received from upper layers;
\- the command set to \"announce\";
\- the UE identity set to the UE\'s IMSI;
\- the Application Identity set to the Application Identity of the upper layer
application that requested the announcing;
\- the Discovery Type set to \"Restricted discovery\";
\- the ACE Enabled Indicator set to \"application-controlled extension
enabled\" if application-controlled extension is required by the upper layers
or \"normal\" if application-controlled extension is not used;
\- the announcing type set to \"on demand\" if on demand announcing is
requested by upper layers and \"normal\" if on demand announcing is not
requested by upper layers;
\- optionally the Requested Timer set to the length of validity timer
associated with the ProSe Restricted Code that the UE expects to receive from
the ProSe Function;
\- the Discovery Entry ID set to a 0 if the announcing request is a new
request, and set to the Discovery Entry ID received from the ProSe Function if
the announcing request is to update a previously sent announcing request;
\- optionally in case of E-UTRA-based restricted ProSe direct discovery model
A the Announcing PLMN ID set to the PLMN ID of the local PLMN operating the
radio resources that the UE intends to use for announcing the RPAUID; and
\- optionally the PC5_tech set to the PC5 radio technology that the UE wishes
to use. PC5_tech may include more than one PC5 radio technology.
If restricted ProSe direct discovery model A with application-controlled
extension is requested by upper layers, the DISCOVERY_REQUEST message shall
also include the Application Level Container, which contains application-level
data transparent to the 3GPP network, to be used by the ProSe Application
Server e.g. to assign ProSe Restricted Code Suffix(es).
When the UE initiates the announce request procedure to inform the ProSe
Function that the UE wants to stop announcing a ProSe Restricted Code before
the associated valid timer expires, the UE shall set the Requested Timer to 0.
NOTE 2: A UE can include one or multiple transactions in one DISCOVERY_REQUEST
message for different RPAUIDs, and receive corresponding \ element or \ element in a
DISCOVERY_RESPONSE message for each respective transaction. In the following
description of the announce request procedure, only one transaction is
included.
Figure 6.2.2A.2.1 illustrates the interaction of the UE and the ProSe Function
in the announce request procedure.
Figure 6.2.2A.2.1: Announce request procedure for restricted ProSe direct
discovery model A
#### 6.2.2A.3 Announce request procedure accepted by the ProSe Function
Upon receiving a DISCOVERY_REQUEST message with the command set to
\"announce\" and the Discovery Type set to \"Restricted discovery\", if the
Requested Timer is included in the DISCOVERY_REQUEST message and the Requested
Timer is set to 0, the ProSe Function shall check whether there is an existing
UE context containing the discovery entry identified by the Discovery Entry ID
included in the DISCOVERY_REQUEST message. If the discovery entry exists in
the UE context, the ProSe Function shall inform the ProSe Function in the
announcing PLMN to remove the corresponding discovery entry as specified in
3GPP TS 29.345 [5] when the announcing PLMN is not the same as that of the
PLMN to which the ProSe Function belongs and remove the discovery entry
identified by the Discovery Entry ID from the UE\'s context. Then the ProSe
Function shall send a DISCOVERY_RESPONSE message containing a \ element with:
\- the transaction ID set to the value of the transaction ID received in the
DISCOVERY_REQUEST message, and
\- the Discovery Entry ID set to the identifier associated with the
corresponding discovery entry.
Upon receiving a DISCOVERY_REQUEST message with the command set to
\"announce\" and the Discovery Type set to \"Restricted discovery\", if the
Requested Timer is not included in the DISCOVERY_REQUEST message or the
Requested Timer included in the DISCOVERY_REQUEST message is not set to 0, the
ProSe Function shall perform the following procedure.
The ProSe Function shall check that the application corresponding to the
Application Identity contained in the DISCOVERY_REQUEST message is authorised
for restricted ProSe direct discovery model A announcing. If the application
is authorised for restricted ProSe direct discovery model A announcing, the
ProSe Function shall check whether there is an existing context for the UE.
If there is no associated UE context, the ProSe Function checks with the HSS
whether the UE is authorised for restricted ProSe direct discovery model A
announcing as described in 3GPP TS 29.344 [3]. If the check indicates that the
UE is authorised, the ProSe Function creates a UE context that contains the
UE\'s subscription parameters obtained from the HSS. The HSS also provides to
the ProSe Function the PLMN ID of the PLMN in which the UE is currently
registered. If the UE context exists, the ProSe Function shall then check
whether the UE is authorised for restricted ProSe direct discovery model A
announcing in the currently registered PLMN or in case of E-UTRA-based
restricted ProSe direct discovery model A the local PLMN identified by the
Announcing PLMN ID included in the DISCOVERY_REQUEST message.
If the UE is authorised and the Discovery Entry ID included in the
DISCOVERY_REQUEST message is set to 0 then:
\- the ProSe Function shall check whether the UE is authorised to announce the
RPAUID contained in the DISCOVERY_REQUEST message. Optionally this can include
checking with the ProSe Application Server as described in 3GPP TS 29.343 [31]
to obtain the binding between the RPAUID and PDUID, and then verifying that
the PDUID belongs to the requesting UE;
\- if the UE is authorised to announce the RPAUID, the ACE Enabled Indicator
is set to \"application-controlled extension enabled\", the Application Level
Container is included in the DISCOVERY_REQUEST message and the requested
application uses application-controlled extension, the ProSe Function shall
check whether the UE is authorized to use ACE. If the UE is authorized for
ACE, the ProSe Function shall invoke the procedure described in 3GPP TS 29.343
[31] to check whether the UE is authorised to announce the requested RPAUID
with application-defined suffix(es), and obtain suffix-related information
from the ProSe Application Server. The ProSe Function shall then allocate a
ProSe Restricted Code Prefix and a value for validity timer T4007 to be used
with the ProSe Restricted Code Suffix(es) obtained from the ProSe Application
Server for the given RPAUID as specified in 3GPP TS 29.343 [31]. The ProSe
Function may take into account the Requested Timer if contained in the
DISCOVERY_REQUEST message when allocating validity timer T4007;
\- if the UE is authorised to announce the RPAUID, the ACE Enabled Indicator
is set to \"normal\" in the DISCOVERY_REQUEST message and the requested
application does not use application-controlled extension, the ProSe Function
shall allocate the corresponding ProSe Restricted Code and a value for
validity timer T4007. The ProSe Function may take into account the Requested
Timer if contained in the DISCOVERY_REQUEST message when allocating validity
timer T4007;
\- if the UE is authorised to announce the RPAUID, the ACE Enabled Indicator
is set to \"normal\" in the DISCOVERY_REQUEST message, the Application Level
Container is included in the DISCOVERY_REQUEST and the requested application
only uses application-controlled extension, the ProSe Function shall check
whether the UE is authorized to use ACE. If the UE is authorized for ACE, the
ProSe Function shall invoke the procedure described in 3GPP TS 29.343 [31] to
check whether the UE is authorised to announce the requested RPAUID with
application-defined suffix(es), and obtain suffix-related information from the
ProSe Application Server. The ProSe Function shall then allocate a ProSe
Restricted Code Prefix and a value for validity timer T4007 to be used with
the ProSe Restricted Code Suffix(es) obtained from the ProSe Application
Server for the given RPAUID as specified in 3GPP TS 29.343 [31] The ProSe
Function may take into account the Requested Timer if contained in the
DISCOVERY_REQUEST message when allocating validity timer T4007.
\- if the UE is authorised to announce the RPAUID, the ACE Enabled Indicator
is set to \"application-controlled-extension enabled\" and the Application
Level Container is included in the DISCOVERY_REQUEST message but the requested
application does not use application-controlled extension, the ProSe Function
shall allocate the corresponding ProSe Restricted Code and a value for
validity timer T4007. The ProSe Function may take into account the Requested
Timer if contained in the DISCOVERY_REQUEST message when allocating validity
timer T4007; and
\- the ProSe Function associates the allocated ProSe Restricted Code or ProSe
Restricted Code Prefix with a new discovery entry in the UE\'s context, and
starts timer T4008. The HSS also provides to the ProSe Function the PLMN ID of
the PLMN in which the UE is currently registered. For a given ProSe Restricted
Code, timer T4008 shall be longer than timer T4007. By default, the value of
timer T4008 is 4 minutes greater than the value of timer T4007.
If the Discovery Entry ID included in the DISCOVERY_REQUEST message is not set
to 0 and if there is an existing discovery entry for this Discovery Entry ID
value in the UE\'s context, the ProSe Function shall either update the
discovery entry with a new validity timer T4007, or allocate a new ProSe
Restricted Code or ProSe Restricted Code Prefix for the requested RPAUID with
a new validity timer T4007, restart timer T4008, and clear any existing on
demand announcing enabled indicator. The ProSe Function may take into account
the Requested Timer if contained in the DISCOVERY_REQUEST message when
allocating validity timer T4007.
If the Discovery Entry ID contained in the DISCOVERY_REQUEST message is not
found in the UE context or there is no UE context in the ProSe Function, the
ProSe Function shall behave as if the Discovery Entry ID included in the
DISCOVERY_REQUEST message was set to 0, and the ProSe Function shall allocate
a new non-zero Discovery Entry ID for this entry.
If the announcing type is set to \"on demand\" in the DISCOVERY_REQUEST
message, the ProSe Function shall check if \"on demand\" announcing is
authorised and enabled based on the Application Identity and the operator\'s
policy. If \"on demand\" announcing is authorised and enabled, and there is no
ongoing monitoring request for this RPAUID, then the ProSe Function shall set
the on demand announcing enabled indicator to 1 for the corresponding
discovery entry in the UE\'s context.
If a new UE context was created or an existing UE context was updated, and the
UE is currently roaming or the Announcing PLMN ID is included in the
DISCOVERY_REQUEST message, and the on demand announcing enabled indicator is
not set to 1 for this discovery entry in the UE\'s context, the ProSe Function
checks with the ProSe function of the VPLMN or in case of E-UTRA-based
restricted ProSe direct discovery model A the local PLMN represented by the
Announcing PLMN ID whether the UE is authorised for restricted ProSe direct
discovery model A announcing as described in 3GPP TS 29.345 [5].
The ProSe Function shall then send a DISCOVERY_RESPONSE message containing a
\ element with:
\- the transaction ID set to the value of the transaction ID received in the
DISCOVERY_REQUEST message from the UE;
\- if the on demand announcing enabled indicator is not set to 1 in the UE\'s
context for this discovery entry, either the ProSe Restricted Code set to the
ProSe Restricted Code or the ProSe Restricted Code Prefix allocated by the
ProSe Function, and optionally one or more ProSe Restricted Code Suffix Ranges
which contain the suffix(es) for the RPAUID received in the DISCOVERY_REQUEST
message;
\- a Validity Timer T4007 set to the T4007 timer value assigned by the ProSe
Function to the ProSe Restricted Code;
\- the ACE Enabled Indicator set to \"application-controlled extension
enabled\" if application-controlled extension is used, or \"normal\" if
application-controlled extension is not used;
\- the Restricted Security set to a value containing the security-related
information for restricted discovery provided by the ProSe Function;
\- the On Demand Announcing Enabled Indicator indicating whether the on demand
announcing is enabled or not for this discovery entry if the Announcing Type
is set to \"on demand\" in the DISCOVERY_REQUEST message;
\- the Discovery Entry ID set to the ID of the discovery entry associated with
this announce request in the UE\'s context; and
\- optionally the PC5_tech set to the one or more PC5 radio technologies that
are authorized to be used for the assigned ProSe Restricted Code or the
assigned ProSe Restricted Code Prefix and the associated ProSe Restricted Code
Suffix Ranges.
If timer T4008 expires, the ProSe Function shall remove the discovery entry
associated with the corresponding RPAUID from the UE\'s context.
#### 6.2.2A.4 Announce request procedure completion by the UE
Upon receipt of the DISCOVERY_RESPONSE message, if only the transaction ID and
the Discovery Entry ID are contained in the \
element and the transaction ID and the Discovery Entry ID match the
corresponding values sent by the UE in a DISCOVERY_REQUEST message, the UE
shall:
\- stop the validity timer T4007 for the discovery entry corresponding to the
Discovery Entry ID received in the DISCOVERY_RESPONSE message;
\- remove the discovery entry identified by the Discovery Entry ID included;
and
\- instruct the lower layers to stop announcing.
Upon receipt of the DISCOVERY_RESPONSE message, if the transaction ID
contained in the \ element matches the value
sent by the UE in a DISCOVERY_REQUEST message with the command set to
\"announce\", the UE shall create a new discovery entry or update an existing
discovery entry with the received ProSe Restricted Code or ProSe Restricted
Code Prefix and the PLMN ID of the intended announcing PLMN. For this
discovery entry, the UE shall stop the validity timer T4007, if running, for
the discovery entry corresponding to the Discovery Entry ID received in the
DISCOVERY_RESPONSE message, and start the validity timer T4007 for this
discovery entry with the received value in the DISCOVERY_RESPONSE message.
Otherwise the UE shall discard the DISCOVERY_RESPONSE message and shall not
perform the procedures below.
If the DISCOVERY_RESPONSE message includes new ProSe Restricted Code or ProSe
Restricted Code Prefix to replace the existing ProSe Restricted Code being
announced, the UE shall notify lower layer to stop announcing the old ProSe
Restricted Code in PC5 interface.
If the DISCOVERY RESPONSE message contains an On Demand Announcing Enabled
Indicator set to 1, the UE shall wait for an Announcing Alert Request message
from the ProSe Function of the HPLMN before starting to perform restricted
ProSe direct discovery model A announcing. Otherwise, the UE may perform
restricted ProSe direct discovery model A announcing as described below.
The UE requests the parameters from the lower layers for restricted Prose
direct discovery model A announcing (see 3GPP TS 36.331 [12]). In case of
E-UTRA-based restricted ProSe direct discovery the UE shall perform restricted
ProSe direct discovery model A announcing only if the lower layers indicate
that ProSe direct discovery is supported by the network. In case of E-UTRA-
based restricted ProSe direct discovery if the UE in EMM-IDLE mode has to
request resources for ProSe direct discovery announcing as specified in 3GPP
TS 36.331 [12], the UE shall perform a service request procedure or tracking
area update procedure as specified in 3GPP TS 24.301 [11]. The UE shall obtain
the UTC time for the next discovery transmission opportunity for ProSe direct
discovery from the lower layers.
If a valid UTC time is obtained, the UE shall generate the UTC-based counter
corresponding to this UTC time as specified in subclause 12.2.2.18. If the
resulting UTC-based counter is within Max Offset of the time shown by the
clock used for ProSe by the UE, the UE shall either use the ProSe Restricted
Code received in the DISCOVERY_RESPONSE message, or select one ProSe
Restricted Code based on the ProSe Restricted Code Prefix and ProSe Restricted
Code Suffix Range(s) received in the DISCOVERY_RESPONSE message as announced
ProSe Restricted Code, along with the eight least significant bits of the UTC-
based counter, in order to construct a PC5_DISCOVERY message, according to the
format defined in subclause 11.2.5.
NOTE: The UE can use different codes formed based on different ProSe
Restricted Code Suffixes to announce, without having to send a new
DISCOVERY_REQUEST message to the ProSe Function, as long as the validity timer
T4007 of the ProSe Restricted Code Prefix has not expired.
The UE shall then apply one or more of the DUIK, DUSK or DUCK with the
associated Encrypted Bitmask, whichever received in the Restricted Code
Security Material parameter of the DISCOVERY_RESPONSE message, along with the
UTC-based counter to the PC5_DISCOVERY message, to e.g. generate a MIC value,
scramble the message contents or provide confidentiality protection, as
specified in 3GPP TS 33.303 [6].
The UE then passes the resulting PC5_DISCOVERY message, along with the PLMN ID
of the intended announcing PLMN, to the lower layers for transmission if:
\- the UE is currently authorised to perform restricted ProSe direct discovery
model A announcing in the registered PLMN or in case of E-UTRA-based
restricted ProSe direct discovery model A the local PLMN operating the radio
resources that the UE intends to use;
\- the validity timer T4007 for the corresponding discovery entry allocated
ProSe Restricted Code or ProSe Restricted Code Prefix has not expired; and
\- a request from upper layers to announce the RPAUID associated with both the
ProSe Restricted Code or ProSe Restricted Code Prefix, and the authorised
Application Identity, is still in place.
The UE shall ensure that it keeps on passing PC5_DISCOVERY messages to the
lower layers for transmission until the validity timer T4007 of the ProSe
Restricted Code or ProSe Restricted Code Prefix expires. How this is achieved
is left up to UE implementation.
During the announcing operation, if one of the above conditions is no longer
met, the UE may instruct the lower layers to stop announcing. When the UE
stops announcing, In case of E-UTRA-based restricted ProSe direct discovery
model A if the lower layers indicate that the UE is required to send a
discovery indication to the eNodeB and the UE is in EMM-CONNECTED mode, the UE
shall trigger the corresponding procedure in lower layers as specified in 3GPP
TS 36.331 [12].
#### 6.2.2A.5 Announce request procedure not accepted by the ProSe Function
If the DISCOVERY_REQUEST message cannot be accepted by the ProSe Function, the
ProSe Function sends a DISCOVERY_RESPONSE message containing a \ element to the UE including an appropriate PC3 Control Protocol cause
value.
If the application corresponding to the Application Identity contained in the
DISCOVERY_REQUEST message is not authorised for ProSe direct discovery
announcing, the ProSe Function shall send the DISCOVERY_RESPONSE message
containing a \ element with PC3 Control Protocol cause value
#1 \"Invalid application\".
If the RPAUID contained in the DISCOVERY_REQUEST message is unknown to the
ProSe Function or ProSe Application Server, the ProSe Function shall send a
DISCOVERY_RESPONSE message containing a \ element with PC3
Control Protocol cause value #9 \"Unknown RPAUID\".
If the RPAUID contained in the DISCOVERY_REQUEST message does not match the
stored RPAUID for the requested Discovery Entry ID, the ProSe Function shall
send a DISCOVERY_RESPONSE message containing a \ element with
PC3 Control Protocol cause value #10 \"Unknown or Invalid Discovery Entry
ID\".
If the UE is not authorised for restricted ProSe direct discovery model A
announcing, the ProSe Function shall send the DISCOVERY_RESPONSE message
containing a \ element with PC3 Control Protocol cause value
#3 \"UE authorisation failure\".
If the UE is not authorised for restricted \"on demand\" restricted ProSe
direct discovery model A announcing, the ProSe Function shall send the
DISCOVERY_RESPONSE message containing a \ element with PC3
Control Protocol cause value #13 \"UE unauthorised for on-demand announcing\".
If the RPAUID contained in the DISCOVERY_REQUEST message is not associated
with the PDUID belonging to the requesting UE, the ProSe Function shall send a
DISCOVERY_RESPONSE message containing a \ element with PC3
Control Protocol cause value #3 \"UE authorisation Failure\".
If the UE is not authorized to use ACE, but the DISCOVERY_REQUEST message
contains the ACE Enabled Indicator set to \"application-controlled extension
enabled\", the ProSe Function shall send a DISCOVERY_RESPONSE message
containing a \ element with PC3 Control Protocol cause value
#12 \"UE unauthorised for discovery with Application-Controlled Extension\".
If the DISCOVERY_REQUEST message contains the ACE Enabled Indicator set to
\"application-controlled extension enabled\", but does not contain the
Application Level Container parameter, the ProSe Function shall send a
DISCOVERY_RESPONSE message containing a \ element with PC3
Control Protocol cause value #14 \"Missing Application Level Container\".
If the ProSe Application Server indicates to the ProSe Function that the
Application Level Container in the DISCOVERY REQUEST message contains invalid
information, the ProSe Function shall send a DISCOVERY_RESPONSE message
containing a \ element with PC3 Control Protocol cause value
#15 \"Invalid Data in Application Level Container\".
If the Discovery Entry ID contained in the DISCOVERY_REQUEST message is
unknown to the ProSe Function and the Requested Timer is set to zero, the
ProSe Function shall send a DISCOVERY_RESPONSE message containing a
\ element with PC3 Control Protocol cause value # 10
\"Unknown or invalid Discovery Entry ID\".
#### 6.2.2A.6 Abnormal cases
##### 6.2.2A.6.1 Abnormal cases in the UE
The following abnormal cases can be identified:
a) Indication from the transport layer of transmission failure of
DISCOVERY_REQUEST message (e.g. after TCP retransmission timeout)
The UE shall close the existing secure connection to the ProSe Function,
establish a new secure connection and then restart the announce request
procedure.
b) No response from the ProSe Function after the DISCOVERY_REQUEST message has
been successfully delivered (e.g., TCP ACK has been received for the
DISCOVERY_REQUEST message)
The UE shall retransmit the DISCOVERY_REQUEST message.
NOTE: The timer to trigger retransmission and the maximum number of allowed
retransmissions are UE implementation specific.
c) Indication from upper layers that the request to announce the RPAUID is no
longer in place after sending the DISCOVERY_REQUEST message, but before the
announce request procedure is completed
The UE shall acknowledge the DISCOVERY_RESPONSE message received from the
ProSe Function but discard its contents and then abort the procedure.
d) Change of PLMN
If a PLMN change occurs before the announce request procedure is completed,
the procedure shall be aborted. If the UE is authorized to announce in the new
PLMN, the procedure shall be restarted once the UE is registered on the new
PLMN.
##### 6.2.2A.6.2 Abnormal cases in the ProSe Function
The following abnormal cases can be identified:
a) Indication from the lower layer of transmission failure of
DISCOVERY_RESPONSE message
After receiving an indication from lower layer that the DISCOVERY_RESPONSE
message has not been successfully acknowledged (e.g. TCP ACK is not received),
the ProSe Function shall abort the procedure, and stop any associated timer(s)
T4008, if running.
### 6.2.2B Discoveree request procedure for restricted ProSe direct discovery
model B
#### 6.2.2B.1 General
The purpose of the discoveree request procedure for restricted ProSe direct
discovery model B is for the UE to obtain Discovery Query Filter(s) to be used
for monitoring a model B query for a Restricted ProSe Application User ID
(RPAUID) over the PC5 interface, and a ProSe Response Code to be announced
over the PC5 interface as a response to a model B query, as defined in 3GPP TS
23.303 [2].
Before initiating the discoveree request procedure, the UE shall be authorised
for restricted ProSe direct discovery model B discoveree operation in the
registered PLMN or the local PLMN based on the service authorisation procedure
as specified in clause 5.
NOTE: The notion of \"local PLMN\" does not apply for WLAN-based ProSe direct
discovery. The UE can engage in WLAN-based ProSe direct discovery as
announcing UE regardless of the serving PLMN or other PLMNs that provide
E-UTRAN coverage in the UE location.
As the result of successful completion of this procedure, the UE obtains one
or more Discovery Query Filters and applies them to the monitoring operation
in PC5 interface. The UE shall also include the ProSe Response Code in a
PC5_DISCOVERY message and passes the message to the lower layers for
transmission over the PC5 interface, when there is a match of the Discovery
Query Filter(s).
#### 6.2.2B.2 Discoveree request procedure initiation
Before initiating the discoveree request procedure, the user sets the
permissions for the restricted discovery using application layer mechanisms.
The application client in the UE retrieves the PDUID provisioned to the UE as
part of the service authorisation procedure as specified in clause 5 and
obtains an RPAUID associated with the UE\'s PDUID from the ProSe Application
Server. The UE may provide metadata to be associated with the RPAUID, and the
ProSe Application Server stores the metadata. This step is performed using
mechanisms that are out of scope of the present specification.
If the UE is authorised to perform E-UTRA-based restricted ProSe direct
discovery model B discoveree operation in the PLMN operating the radio
resources signalled from the serving PLMN, or if the UE is authorised to
perform WLAN-based restricted ProSe direct discovery model B discoveree
operation, it shall initiate a discoveree request procedure:
a) when the UE is triggered by an upper layer application to announce an
RPAUID in Model B and the UE has no valid corresponding ProSe Response Code
and Discovery Query Filter(s) for that RPAUID of the upper layer application;
b) when the validity timer T4011 assigned by the ProSe Function to a ProSe
Response Code and the corresponding Discovery Query Filter(s) has expired and
the request from upper layers to announce the RPAUID corresponding to that
ProSe Response Code is still in place;
c) when the UE selects a new PLMN while announcing or waiting for announcing a
ProSe Response Code and intends to announce in the new PLMN, and the UE is
authorised for restricted ProSe direct discovery model B discoveree operation
in the new PLMN;
d) when, while announcing or waiting for announcing a ProSe Response Code, the
UE intends to switch the announcing PLMN to a different PLMN without
performing PLMN selection, and the UE does not have a valid allocated ProSe
Response Code for this new PLMN yet; or
e) when the UE needs to update a previously sent restricted ProSe direct
discovery model B discoveree request.
When the UE selects a new PLMN while announcing or waiting for announcing a
ProSe Response Code and the UE is not yet authorised for restricted ProSe
direct discovery model B discoveree operation in the new PLMN, the UE shall
initiate a discoveree request procedure only after the UE is authorised for
restricted ProSe direct discovery model B discoveree operation in the new
PLMN.
NOTE 1: To ensure service continuity if the UE needs to keep announcing in
Model B a ProSe Response Code corresponding to the same RPAUID, the UE can
initiate the discoveree request procedure before the validity timer T4011
assigned by the ProSe Function for a ProSe Response Code expires.
The UE initiates the discoveree request procedure by sending a
DISCOVERY_REQUEST message with:
\- a new transaction ID not used in any other direct discovery procedures in
PC3 interface;
\- the RPAUID set to the RPAUID received from upper layers;
\- the command set to \"response\";
\- the UE identity set to the UE\'s IMSI;
\- the Application Identity set to the Application Identity of the upper layer
application that requested the announcing;
\- the Discovery Type set to \"Restricted discovery\";
\- the Discovery Model set to \"Model B\";
\- the Discovery Entry ID set to a 0 if the discoveree request is a new
request, and set to the Discovery Entry ID received from the ProSe Function if
the discoveree request is to update a previously sent discoveree request;
\- optionally in case of E-UTRA-based restricted ProSe direct discovery model
B discoveree operation, the Announcing PLMN ID set to the PLMN ID of the local
PLMN operating the radio resources that the UE intends to use for announcing
the RPAUID; and
\- optionally the PC5_tech set to the PC5 radio technology that the UE wishes
to use. PC5_tech may include more than one PC5 radio technology.
NOTE 2: A UE can include one or multiple transactions in one DISCOVERY_REQUEST
message for different RPAUIDs (e.g., for different applications), and receive
corresponding \ element or \
element in a DISCOVERY_RESPONSE message for each respective transaction. In
the following description of the discoveree request procedure, only one
transaction is included.
Figure 6.2.2B.2.1 illustrates the interaction of the UE and the ProSe Function
in the discoveree request procedure.
Figure 6.2.2B.2.1: Discoveree request procedure for restricted ProSe direct
discovery model B
#### 6.2.2B.3 Discoveree request procedure accepted by the ProSe Function
Upon receiving a DISCOVERY_REQUEST message, the ProSe Function shall check
that the application corresponding to the Application Identity contained in
the DISCOVERY_REQUEST message is authorised for restricted ProSe direct
discovery model B discoveree operation. If the application is authorised for
restricted ProSe direct discovery model B discoveree operation, the ProSe
Function shall check whether there is an existing context for the UE.
If there is no associated UE context, the ProSe Function checks with the HSS
whether the UE is authorised for restricted ProSe direct discovery model B
discoveree operation as described in 3GPP TS 29.344 [3]. If the check
indicates that the UE is authorised, the ProSe Function creates a UE context
that contains the UE\'s subscription parameters obtained from the HSS. The HSS
also provides to the ProSe Function the PLMN ID of the PLMN in which the UE is
currently registered.
If the UE context exists, the ProSe Function shall check whether the UE is
authorized for restricted ProSe direct discovery model B discoveree operation
in the currently registered PLMN or in case of E-UTRA-based restricted ProSe
direct discovery model B discoveree operation the local PLMN identified by the
Announcing PLMN ID included in the DISCOVERY_REQUEST message.
If the UE is authorized and the Discovery Entry ID included in the
DISCOVERY_REQUEST message is set to 0 then:
\- the ProSe Function shall check whether the UE is authorised to announce the
RPAUID contained in the DISCOVERY_REQUEST message. Optionally this can include
checking with the ProSe Application Server as described in 3GPP TS 29.343 [31]
to obtain the binding between the RPAUID and PDUID, and then verifying that
the PDUID belongs to the requesting UE;
\- if the UE is authorised to announce the RPAUID, the ProSe Function shall
allocate the corresponding ProSe Response Code and ProSe Query Code for the
RPAUID. It shall also allocate Discovery Query Filter(s) based on the
allocated ProSe Query Code. Then it shall assign a value for validity timer
T4011, which is associated with the ProSe Response Code, PorSe Query Code and
Discovery Query Filter(s).
\- the ProSe Function associates the allocated ProSe Response Code, ProSe
Query Code, and Discovery Query Filter with a new discovery entry ID in the UE
context, and starts timer T4012. For a given ProSe Response Code, timer T4012
shall be longer than timer T4011. By default, the value of timer T4012 is 4
minutes greater than the value of timer T4011.
If the Discovery Entry ID included in the DISCOVERY_REQUEST message is not set
to 0 and if there is an existing discovery entry for this Discovery Entry ID
value in the UE context, the ProSe Function shall either update the discovery
entry with a new validity timer T4011, or allocate a new ProSe Response Code,
ProSe Query Code and the Discovery Query Filter(s) for the requested RPAUID
with a new validity timer T4011, restart timer T4012.
If the Discovery Entry ID contained in the DISCOVERY_REQUEST message is not
found in the UE context or there is no UE context in the ProSe Function, the
ProSe Function shall behave as if the Discovery Entry ID included in the
DISCOVERY_REQUEST message was set to 0, and the ProSe Function shall allocate
a new non-zero Discovery Entry ID for this entry.
If a new UE context was created or an existing UE context was updated, and the
UE is currently roaming or the Announcing PLMN ID is included in the
DISCOVERY_REQUEST message, the ProSe Function checks with the ProSe function
of the VPLMN or in case of E-UTRA-based restricted ProSe direct discovery
model B discoveree operation the local PLMN identified by the Announcing PLMN
ID whether the UE is authorised for restricted ProSe direct discovery model B
discoveree operation as described in 3GPP TS 29.345 [5].
The ProSe Function shall then send a DISCOVERY_RESPONSE message containing a
\ element with:
\- the transaction ID set to the value of the transaction ID received in the
DISCOVERY_REQUEST message from the UE;
\- the ProSe Response Code set to the ProSe Response Code allocated for the
RPAUID received in the DISCOVERY_REQUEST message;
\- one or more ProSe Query Filters set to the ProSe Query Filter(s) used to
match a query for the RPAUID received in the DISCOVERY_REQUEST message;
\- a Validity Timer T4011 set to the T4011 timer value assigned by the ProSe
Function to the ProSe Response Code and the Discovery Query Filter(s);
\- the Restricted Security set to a value containing the security-related
information for restricted discovery provided by the ProSe Function;
\- the Discovery Entry ID set to the ID of the discovery entry associated with
this discoveree request in the UE context.
\- optionally the PC5_tech set to the one or more PC5 radio technologies that
are authorized to be used for the assigned ProSe Response Code.
If timer T4012 expires, the ProSe Function shall remove the discovery entry
associated with the corresponding RPAUID from the UE\'s context.
#### 6.2.2B.4 Discoveree request procedure completion by the UE
Upon receipt of the DISCOVERY_RESPONSE message, if the transaction ID
contained in the \ element matches the value
sent by the UE in a DISCOVERY_REQUEST message with the command set to
\"response\", the UE shall create a new discovery entry or update an existing
discovery entry with the ProSe Response Code and Discovery Query Filter(s)
received in the DISCOVERY_RESPONSE message and the PLMN ID of the intended
announcing PLMN. For this discovery entry, the UE shall stop the validity
timer T4011 if running and start the validity timer T4011 with the received
value. The UE shall also use the received ProSe Response Code and Discovery
Query Filter(s) to replace the old counterparts if they are currently used.
This may involve notifying the lower layers to stop announcing the old ProSe
Response Code or to stop monitoring with the old Discovery Query Filter(s).
Otherwise the UE shall discard the DISCOVERY_RESPONSE message and shall not
perform the procedures below.
The UE may apply the received Discovery Query Filter(s) to its monitoring
operation. _Using the Discovery Query Filter(s) may result in a match event.
There is match event when, for any of the masks_ i _n a Discovery Query
Filter, the output of a bitwise AND operation between the ProSe Query Code
contained in the_ received _PC5_DISCOVERY message and th_ e mask, _matches the
output of a bitwise AND operation between the_ mask _and the code_ contained
_in the Discovery Query_ F _ilter._
When applying a Discovery Query Filter to a received PC5_DISCOVERY message for
the above-mentioned bitwise AND operation, the UE shall use the DUSK, if
received as part of the filter in the DISCOVERY_RESPONSE message, and the UTC-
based counter generated during the monitoring operation described below, to
unscramble the PC5_DISCOVERY message as described in 3GPP TS 33.303 [6]. Then,
if a DUCK is included as part of the filter, the UE shall use the DUCK and the
UTC-based counter to decrypt the message-specific confidentiality protected
portion identified by the Encrypted Bitmask, as described in 3GPP TS 33.303
[6];
NOTE 1: The UE can look for a match on the unencrypted bits first before
applying DUCK, to minimise the amount of processing performed before finding a
match.
If a DUIK is received as part of the filter, the UE shall use the DUIK and the
UTC-based counter to verify the MIC field in the unscrambled PC5_DISCOVERY
message.
NOTE 2: The UE needs to verify the MIC field because the match report
procedure is not used for checking the MIC of a PC5_DISCOVERY message
containing a ProSe Query Code by the ProSe Function.
The UE may instruct the lower layers to start monitoring with Discovery Query
Filter(s) and prepare announcing the ProSe Response Code if all of the
following conditions are met:
\- the UE is currently authorized to perform restricted ProSe direct discovery
model B discoveree operation in the registered PLMN or in case of E-UTRA-based
restricted ProSe direct discovery model B discoveree operation, the local PLMN
operating the radio resources that the UE intends to use;
\- the UE has obtained the ProSe Response Code and Discovery Query Filter(s)
and the respective validity timer T4011 for the corresponding discovery entry
has not expired; and
\- a request from upper layers to perform discoveree operation for the RPAUID
associated with an authorised Application Identity is still in place.
During the discoveree operation, if one of the above conditions is no longer
met, the UE may instruct the lower layers to stop the discoveree operation.
When the UE stops discoveree operation, if the lower layers indicate that the
UE is required to send a discovery indication to the eNodeB and in case of
E-UTRA-based restricted ProSe direct discovery model B discoveree operation
the UE is in EMM-CONNECTED mode, the UE shall trigger the corresponding
procedure in lower layers as specified in 3GPP TS 36.331 [12].
_Once the match of the Discovery Query Filter(s) occurs, the UE process this
match event and requests the lower layers to announce the corresponding ProSe
Response Code in the PC5 interface as a response, as specified in_ 3GPP TS
36.331 [12]. In case of E-UTRA-based restricted ProSe direct discovery model B
discoveree operation this shall be done only if the lower layers indicate that
ProSe direct discovery is supported by the network. In case of E-UTRA-based
restricted ProSe direct discovery model B discoveree operation if the UE in
EMM-IDLE mode has to request resources for ProSe direct discovery announcing
as specified in 3GPP TS 36.331 [12], the UE shall perform a service request
procedure or tracking area update procedure as specified in 3GPP TS 24.301
[11]. The UE shall obtain the UTC time for the next discovery transmission
opportunity for ProSe direct discovery from the lower layers.
If a valid UTC time is obtained, the UE shall generate the UTC-based counter
corresponding to this UTC time as specified in subclause 12.2.2.18. If the
resulting UTC-based counter is within Max Offset of the time shown by the
clock used for ProSe by the UE, the UE shall use the ProSe Response Code
received in the DISCOVERY_RESPONSE message, along with the eight least
significant bits of the UTC-based counter, in order to construct a
PC5_DISCOVERY message, according to the format defined in subclause 11.2.5.
The UE shall then apply one or more of the DUIK, DUSK or DUCK with the
associated Encrypted Bitmask, whichever received in the Restricted Code
Security Material parameter of the DISCOVERY_RESPONSE message, along with the
UTC-based counter to the PC5_DISCOVERY message, to e.g. generate a MIC value,
scramble the message contents or provide confidentiality protection, as
specified in 3GPP TS 33.303 [6].
The UE then passes the resulting PC5_DISCOVERY message, along with the PLMN ID
of the intended announcing PLMN, to the lower layers for transmission.
For each match event with the Discovery Query Filter(s), the UE shall at least
pass PC5_DISCOVERY message once to the lower layers for transmission. The UE
shall ensure that it keeps on passing PC5_DISCOVERY messages to the lower
layers for transmission as response(s) to the match event(s) of the
corresponding Discovery Query Filter(s) until the validity timer T4011
expires. How this is achieved is left up to UE implementation.
#### 6.2.2B.5 Discoveree request procedure not accepted by the ProSe Function
If the DISCOVERY_REQUEST message cannot be accepted by the ProSe Function, the
ProSe Function sends a DISCOVERY_RESPONSE message containing a \ element to the UE including an appropriate PC3 Control Protocol cause
value.
If the application corresponding to the Application Identity contained in the
DISCOVERY_REQUEST message is not authorised for ProSe direct discovery Model B
discoveree operation, the ProSe Function shall send the DISCOVERY_RESPONSE
message containing a \ element with PC3 Control Protocol
cause value #1 \"Invalid application\".
If the RPAUID contained in the DISCOVERY_REQUEST message is unknown to the
ProSe Function or ProSe Application Server, the ProSe Function shall send a
DISCOVERY_RESPONSE message containing a \ element with PC3
Control Protocol cause value #9 \"Unknown RPAUID\".
If the RPAUID contained in the DISCOVERY_REQUEST message does not match the
stored RPAUID for the requested Discovery Entry ID, the ProSe Function shall
send a DISCOVERY_RESPONSE message containing a \ element with
PC3 Control Protocol cause value #10 \"Unknown or Invalid Discovery Entry
ID\".
If the UE is not authorised for restricted ProSe direct discovery model B
discoveree operation, the ProSe Function shall send the DISCOVERY_RESPONSE
message containing a \ element with PC3 Control Protocol
cause value #3 \"UE authorisation failure\".
If the RPAUID contained in the DISCOVERY_REQUEST message is not associated
with a PDUID belonging to the requesting UE, the ProSe Function shall send a
DISCOVERY_RESPONSE message containing a \ element with PC3
Control Protocol cause value #3 \"UE authorisation Failure\".
#### 6.2.2B.6 Abnormal cases
##### 6.2.2B.6.1 Abnormal cases in the UE
The following abnormal cases can be identified:
a) Indication from the transport layer of transmission failure of
DISCOVERY_REQUEST message (e.g. after TCP retransmission timeout)
The UE shall close the existing secure connection to the ProSe Function,
establish a new secure connection and then restart the discoveree request
procedure.
b) No response from the ProSe Function after the DISCOVERY_REQUEST message has
been successfully delivered (e.g., TCP ACK has been received for the
DISCOVERY_REQUEST message)
The UE shall retransmit the DISCOVERY_REQUEST message.
NOTE: The timer to trigger retransmission and the maximum number of allowed
retransmissions are UE implementation specific.
c) Indication from upper layers that the request to announce the RPAUID in
model B is no longer in place after sending the DISCOVERY_REQUEST message, but
before the discoveree request procedure is completed
The UE shall acknowledge the DISCOVERY_RESPONSE message received from the
ProSe Function but discard its contents and then abort the procedure.
d) Change of PLMN
If a PLMN change occurs before the discoveree request procedure is completed,
the procedure shall be aborted. If the UE is authorized to perform restricted
ProSe direct discovery model B discoveree operation in the new PLMN, the
procedure shall be restarted once the UE is registered on the new PLMN.
##### 6.2.2B.6.2 Abnormal cases in the ProSe Function
The following abnormal cases can be identified:
a) Indication from the lower layer of transmission failure of
DISCOVERY_RESPONSE message
After receiving an indication from lower layer that the DISCOVERY_RESPONSE
message has not been successfully acknowledged (e.g. TCP ACK is not received),
the ProSe Function shall abort the procedure, and stop any associated timer(s)
T4012, if running.
### 6.2.3 Monitor request procedure for open ProSe direct discovery
#### 6.2.3.1 General
The purpose of the monitor request procedure for open ProSe direct discovery
is to allow a UE:
\- to receive and process PC5_DISCOVERY messages upon a request for monitoring
from upper layers as defined in 3GPP TS 23.303 [2]; or
\- to inform the ProSe Function that the UE wants to stop using Discovery
Filters for direct discovery monitoring as defined in 3GPP TS 23.303 [2].
The UE shall only initiate the monitor request procedure if it has been
authorised for open ProSe direct discovery monitoring at least in one PLMN
based on the service authorisation procedure.
As a result of the monitor request procedure completing successfully, the UE
obtains one or more Discovery Filters, along with a TTL (Time-To-Live) timer
T4002 for each Discovery Filter indicating the time during which the filter is
valid.
#### 6.2.3.2 Monitor request procedure Initiation
Before initiating the monitor request procedure, the UE is configured with the
data structure of the ProSe Application IDs it wants to monitor. This step is
performed using mechanisms that are out of scope of 3GPP.
If the UE is authorised to perform open ProSe direct discovery monitoring in
at least one PLMN, it shall initiate a monitor request procedure:
a) when the UE is triggered by an upper layer application to perform open
ProSe direct discovery monitoring corresponding to a ProSe Application ID and
the UE has no valid Discovery Filters corresponding to the requested ProSe
Application ID for that upper layer application;
b) when the TTL timer T4002 assigned by the ProSe Function to a Discovery
Filter has expired and the request from upper layers to monitor that ProSe
Application ID is still in place; or
c) when the UE needs to inform the ProSe Function that the UE wants to stop
using Discovery Filters for direct discovery monitoring.
NOTE 1: To ensure service continuity if the UE needs to keep monitoring the
same Discovery Filter, the UE can initiate the monitor request procedure
before the TTL timer T4002 assigned by the ProSe Function for a Discovery
Filter expires.
The UE initiates the monitor request procedure for open ProSe direct discovery
by sending a DISCOVERY_REQUEST message with:
\- a new transaction ID;
the ProSe Application ID set to the ProSe Application ID received from upper
layers;
\- the command set to \"monitor\"
\- the UE identity set to the UE\'s IMSI;
\- the Application Identity set to the Application Identity of the upper layer
application that requested the monitoring;
\- the ACE Enabled Indicator set to \"application-controlled extension
enabled\" if application-controlled extension is required by the upper layers,
or \"normal\" if application-controlled extension is not used;
\- the Discovery Entry ID set to 0 if this is a new request or set to the
Discovery Entry ID received from the ProSe Function if the monitor request is
to update a previously sent monitor request;
\- optionally, the Requested Timer set to 0 only when the UE wants to stop
using Discovery Filters for direct discovery monitoring; and
\- optionally the PC5_tech set to the PC5 radio technology that the UE wishes
to use for monitoring. PC5_tech may include more than one PC5 radio
technology.
If open ProSe direct discovery with application-controlled extension is
requested by upper layers, the DISCOVERY_REQUEST message shall also include
the Application Level Container, which contains information corresponding to
the ProSe Application Code Suffix, e.g. group or user-specific information.
NOTE 2: A UE can include one or multiple transactions in one DISCOVERY_REQUEST
message for one or more ProSe Application IDs, and receive corresponding
\ element or \ element in the
DISCOVERY_RESPONSE message for each respective transaction. In the following
description of the monitor request procedure, only one transaction is
included.
Figure 6.2.3.2.1 illustrates the interaction between the UE and the ProSe
Function in the monitor request procedure.
Figure 6.2.3.2.1: Monitor request procedure
#### 6.2.3.3 Monitor request procedure accepted by the ProSe Function
Upon receiving a DISCOVERY_REQUEST message with the command set to
\"monitor\", if the Requested Timer is included in the DISCOVERY_REQUEST
message and the Requested Timer is set to 0, the ProSe Function shall check
whether there is an existing UE context containing the discovery entry
identified by the Discovery Entry ID included in the DISCOVERY_REQUEST
message. If the discovery entry exists in the UE context, the ProSe Function
shall remove the discovery entry identified by the Discovery Entry ID from the
UE\'s context. When the associated ProSe Application ID is PLMN-specific and
that PLMN ID indicated by the ProSe Application ID is not the same as that of
the PLMN to which the ProSe Function belongs, the ProSe Function shall inform
the ProSe Function in the PLMN indicated by the ProSe Application ID to remove
the corresponding discovery entry as specified in 3GPP TS 29.345 [5]. Then the
ProSe Function shall send a DISCOVERY_RESPONSE message containing a
\ element with:
\- the transaction ID set to the value of the transaction ID received in the
DISCOVERY_REQUEST message;
\- the Discovery Entry ID set to the value of the Discovery Entry ID received
in the DISCOVERY_REQUEST message; and
\- optionally the PC5_tech set to the value of the PC5_tech if it was received
in the DISCOVERY_REQUEST message.
Upon receiving a DISCOVERY_REQUEST message with the command set to
\"monitor\", if the Requested Timer is not included in the DISCOVERY_REQUEST
message, the ProSe Function shall perform the following procedure.
The ProSe Function shall check that the application corresponding to the
Application Identity contained in the DISCOVERY_REQUEST message is authorised
for open ProSe direct discovery monitoring. If the application is authorised
for open ProSe direct discovery monitoring, the ProSe Function checks whether
there is an existing context for the UE associated with the requested ProSe
Application ID.
If there is no associated UE context, the ProSe Function checks with the HSS
whether the UE is authorised for open ProSe direct discovery monitoring as
described in 3GPP TS 29.344 [3]. The HSS provides to the ProSe Function the
PLMN ID of the PLMN in which the UE is currently registered. If the
subscription check indicates that the UE is authorised, the ProSe Function
creates a new context for the UE and a new discovery entry identified by a
non-zero value Discovery Entry ID which is associated with the requested ProSe
Application ID.
If the ACE Enabled Indicator in the DISCOVERY_REQUEST message is included and
set to \"application-controlled extension enabled\" and the requested
application uses application-controlled extension, the ProSe Function shall
check whether the UE is authorised to use ACE. If the UE is authorised for
ACE, the ProSe Function shall also use the procedure described in 3GPP TS
29.343 [31] to obtain the mask(s) for monitoring the ProSe Application Code
Suffix (es) corresponding to the requested ProSe Application ID.
If the PLMN ID indicated in the ProSe Application ID is PLMN-Specific and that
PLMN ID is not the same as that of the PLMN to which the ProSe Function
belongs, then the ProSe Function executes the procedures defined in 3GPP TS
29.345 [5] to obtain the Discovery Filter(s) for the ProSe Application ID.
Otherwise, the ProSe Function shall allocate one or more Discovery Filters for
the requested ProSe Application ID if it is known to the ProSe Function.and at
least one corresponding valid ProSe Application Code or ProSe Application Code
Prefix is available in the ProSe Function. _Each Discovery Filter consists of
a ProSe Application Code, one or more ProSe Application Masks, and a TTL timer
T4002. If application-controlled extension is used, the allocated Discovey
Filter shall be applicable to match both prefix and suffix portions of the
ProSe Application Code._ If the requested ProSe Application ID is country-
specific or global or PLMN-specific as defined respectively in subclause 24.2
of 3GPP TS 23.003 [4], the ProSe Function shall allocate the Discovery Filter
which contains ProSe Application Code and ProSe Application Mask(s) in the
corresponding scope. If the ProSe Application ID is country-specific or
global, the ProSe Application Mask(s) enclosed in the Discovery Filter hides
the PLMN ID part correspondingly and the temporary identity part is taken from
the data structure corresponding to the global or country-wide ProSe
Application ID namespace, as specified in subclause 24.3 of 3GPP TS 23.003
[4]. If the requested ProSe Application ID is PLMN-specific, the ProSe
Function shall allocate one or more PLMN-specific Discovery Filters. Each of
these Discovery Filters shall contain a PLMN-specific Prose Application Code
and the ProSe Application Mask(s) whose PLMN ID portion shall be set such that
when the mask is applied to the ProSe Application Code, the outcome matches
the full PLMN ID of that specific PLMN. _After the Discovery Filter(s) are
allocated, t_ he ProSe Function then associates the Discovery Filters with the
new discovery entry in the UE context and starts timer T4003 assigned for each
Discovery Filter. For a given Discovery Filter timer T4003 shall be longer
than timer T4002. By default, the value of timer T4003 is 4 minutes greater
than the value of timer T4002.
If there is an existing context for the UE that contains the UE\'s
subscription parameters obtained from the HSS, but no discovery entry
identified by the Discovery Entry ID contained in the DISCOVERY_REQUEST
message, the ProSe Function shall check whether the UE is authorised for ProSe
direct discovery monitoring. If the UE is authorised, the ProSe Function shall
allocate the Discovery Filter as specified above.
After the Discovery Filter is allocated, the ProSe Function then associates
the Discovery Filter with a new discovery entry identified by a non-zero value
Discovery Entry ID in the UE context, and starts timer T4003 assigned for each
Discovery Filter.
Similarly, if there is an existing context and a discovery entry identified by
the Discovery Entry ID contained in the DISCOVERY_REQUEST message for the UE
associated with the requested ProSe Application ID, the ProSe Function updates
the content of Discovery Filter(s), associate the discovery entry with the
updated Discovery Filter(s) and restart timer T4003 for each filter. The
update of a Discovery Filter content includes setting new TTL timer(s) and if
necessary, assigning new ProSe Application Code or ProSe Application Code
Prefix and ProSe Application Mask(s).
Then the ProSe Function shall send a DISCOVERY_RESPONSE message containing a
\ element with:
\- the transaction ID set to the value of the transaction ID received in the
DISCOVERY_REQUEST message from the UE;
\- the Discovery Entry ID set to the identifier associated with the discovery
entry; and
\- if the ACE Enabled Indicator was included by the UE in the
DISCOVERY_REQUEST message, the ACE Enabled Indicator set to:
\- \"application-controlled extension enabled\" if application-controlled
extension is used; or
\- \"normal\" if application-controlled extension is not used;
\- one or more Discovery Filters allocated by the ProSe Function(s) for the
ProSe Application ID received in the DISCOVERY_REQUEST message from the UE;
and
\- optionally the PC5_tech set to the one or more PC5 radio technologies that
may be used for the Discovery Filters allocated by the ProSe Function(s).
If timer T4003 expires, the ProSe Function shall remove the UE\'s association
with the corresponding Discovery Filter. Furthermore, the ProSe Function shall
remove the discovery entry from the UE\'s context if there is no Discovery
Filter corresponding to the ProSe Application ID.
#### 6.2.3.4 Monitor request procedure completion by the UE
Upon receipt of the DISCOVERY_RESPONSE message, if only the transaction ID and
the Discovery Entry ID are contained in the \ element and
the transaction ID and the Discovery Entry ID match the corresponding values
sent by the UE in a DISCOVERY_REQUEST message, the UE shall:
\- stop TTL timer T4002 for each Discovery Filter in the discovery entry
identified by the Discovery Entry ID;
\- remove the discovery entry identified by the Discovery Entry ID; and
\- instruct the lower layers to stop monitoring.
Upon receipt of the DISCOVERY_RESPONSE message, if the transaction ID
contained in the \ element matches the value sent by the UE
in a DISCOVERY_REQUEST message with the command set to \"monitor\", the UE
shall, for each Discovery Filter assigned by the ProSe Function, stop TTL
timer T4002 if running and start TTL timer T4002 with the received value.
Otherwise the UE shall discard the DISCOVERY_RESPONSE message and shall not
perform the procedures below.
The UE may perform open ProSe direct discovery monitoring for discovery
messages received over the PC5 interface as described below.
_For a ProSe Application ID requested by the monitoring UE, the ProSe Function
may have assigned one or more Discovery Filters. If application-controlled
extension is used_ , _th_ e UE may further apply additional filtering on the
part corresponding to the ProSe Application Code Suffix. _The UE should apply
all assigned Discovery Filters to its monitoring operation. Using these
Discovery Filters may result in a match event. In case of a match event, the
UE shall consider that the ProSe Application ID it seeks to monitor has been
discovered. A match event for open ProSe direct discovery is defined as
follows:_
_There is a match event when, for any of the_ ProSe Application Masks _in a
Discovery Filter, the output of a bitwise AND operation between the ProSe
Application Code contained in the_ received _PC5_DISCOVERY message and th_ e
ProSe Application Mask, _matches the output of a bitwise AND operation between
the_ ProSe Application Mask _and the ProSe Application Code_ contained _in the
same Discovery_ F _ilter._
NOTE: A ProSe Application Mask with all bits set to \"1\" is assigned by the
ProSe Function for full matching.
The UE may instruct the lower layers to start monitoring if all of the
following conditions are met:
\- the UE is currently authorized to perform E-UTRA-based open ProSe direct
discovery monitoring in at least one PLMN or the UE is currently authorized to
perform WLAN-based open ProSe direct discovery monitoring;
\- the UE has obtained at least one Discovery Filter and their respective TTL
timer T4002(s) have not expired; and
\- a request from upper layers to monitor for the ProSe Application ID
associated with an authorised Application Identity is still in place.
In case of E-UTRA-based open ProSe direct discovery monitoring, if the UE is
in EMM-CONNECTED mode, the monitoring UE shall also trigger the corresponding
procedure in lower layers as specified in 3GPP TS 36.331 [12].
During the monitoring operation, the UE receives all PC5_DISCOVERY messages
and associated UTC times from the lower layers. The UE shall generate the UTC-
based counter corresponding to the UTC time associated with a PC5_DISCOVERY
message and only process the PC5_DISCOVERY message if the UTC-based counter is
within Max Offset of the time shown by the clock used for ProSe by the UE.
During the monitoring operation, if one of the above conditions is no longer
met, the UE may instruct the lower layers to stop monitoring. When the UE
stops monitoring, in case of E-UTRA-based open ProSe direct discovery
monitoring if the UE is in EMM-CONNECTED mode, the UE shall trigger the
corresponding procedure in lower layers as specified in 3GPP TS 36.331 [12].
#### 6.2.3.5 Monitor request procedure not accepted by the ProSe Function
If the DISCOVERY_REQUEST message is not accepted by the ProSe Function, the
ProSe Function shall send a DISCOVERY_RESPONSE message containing a
\ element to the UE including an appropriate PC3 Control
Protocol cause value.
If the application corresponding to the Application Identity contained in the
DISCOVERY_REQUEST message is not authorised for open ProSe direct discovery
monitoring, the ProSe Function shall send a DISCOVERY_RESPONSE message
containing a \ element with PC3 Control Protocol cause value
#1 \"Invalid application\".
If the ProSe Application ID contained in the DISCOVERY_REQUEST message is
unknown to the ProSe Function, the ProSe Function shall send a
DISCOVERY_RESPONSE message containing a \ element with PC3
Control Protocol cause value #2 \"Unknown ProSe Application ID\".
If the UE is not authorised for open ProSe direct discovery monitoring, the
ProSe Function shall send a DISCOVERY_RESPONSE message containing a
\ element with PC3 Control Protocol cause value #3 \"UE
authorisation failure\".
If the UE requests a country-specific ProSe Application ID for a country that
does not correspond to the country of its HPLMN, and the ProSe Function has
not authorized the UE to monitor in that country, it shall send a
DISCOVERY_RESPONSE message containing a \ element with PC3
Control Protocol cause value #8 \"Scope Violation in Prose Application ID\".
If the UE requests a country-specific ProSe Application ID for a country that
does not correspond to the country of its HPLMN, and the ProSe Function has no
agreement to access the country-specific ProSe Application ID database of that
country, the ProSe Function shall send a DISCOVERY_RESPONSE message containing
a \ element with PC3 Control Protocol cause value #8 \"Scope
Violation in Prose Application ID\".
If the Discovery Entry ID contained in the DISCOVERY_REQUEST message is
unknown to the ProSe Function and the Requested Timer is set to 0, the ProSe
Function shall send a DISCOVERY_RESPONSE message containing a \ element with PC3 Control Protocol cause value #10 \"Unknown or invalid
Discovery Entry ID \".
If the ProSe Function cannot retrieve a valid ProSe Application Code
corresponding to the ProSe Application ID contained in the DISCOVERY_REQUEST
message, the ProSe Function shall send a DISCOVERY_RESPONSE message containing
a \ element with PC3 Control Protocol cause value #17 \"No
Valid ProSe Application Code\".
If the UE is not authorised to use ACE, but the DISCOVERY_REQUEST message
contains the ACE Enabled Indicator set to \"application-controlled extension
enabled\", the ProSe Function shall send a DISCOVERY_RESPONSE message
containing a \ element with PC3 Control Protocol cause value
#12 \"UE unauthorised for discovery with Application-Controlled Extension\".
If the DISCOVERY_REQUEST message does not contain the ACE Enabled Indicator
and the requested application only uses application-controlled extension, the
ProSe Function shall send a DISCOVERY_RESPONSE message containing a
\ element with PC3 Control Protocol cause value #1 \"Invalid
Application\".
#### 6.2.3.6 Abnormal cases
##### 6.2.3.6.1 Abnormal cases in the UE
The following abnormal cases can be identified:
a) Indication from the transport layer of transmission failure of
DISCOVERY_REQUEST message (e.g. after TCP retransmission timeout)
The UE shall close the existing secure connection to the ProSe Function,
establish a new secure connection and then restart the monitor request
procedure.
b) No response from the ProSe Function after the DISCOVERY_REQUEST message has
been successfully delivered (e.g. TCP ACK has been received for the
DISCOVERY_REQUEST message)
The UE shall retransmit the DISCOVERY_REQUEST message.
NOTE: The timer to trigger retransmission and the maximum number of allowed
retransmissions are UE implementation specific.
c) Indication from upper layers that the request to monitor the ProSe
Application ID is no longer in place after sending the DISCOVERY_REQUEST
message, but before the monitor request procedure is completed
The UE shall acknowledge the DISCOVERY_RESPONSE message received from the
ProSe Function but discard its contents and then abort the procedure.
d) Change of PLMN
If a PLMN change occurs before the monitor request procedure is completed, the
procedure shall be aborted. If the UE is authorized to monitor in the new
PLMN, the procedures shall be restarted once the UE is registered on the new
PLMN.
##### 6.2.3.6.2 Abnormal cases in the ProSe Function
The following abnormal cases can be identified:
a) Indication from the lower layer of transmission failure of
DISCOVERY_RESPONSE message
After receiving an indication from lower layer that the DISCOVEY_RESPONSE
message has not been successfully acknowledged, the ProSe Function shall abort
the procedure, and stop any associated timer(s) T4003, if running.
### 6.2.3A Monitor request procedure for restricted ProSe direct discovery
model A
#### 6.2.3A.1 General
The purpose of the monitor request procedure for restricted ProSe direct
discovery model A is:
\- to allow a UE participating in restricted ProSe direct discovery model A to
receive and process PC5_DISCOVERY messages upon a request for monitoring from
upper layers as defined in 3GPP TS 23.303 [2]; or
\- to inform the ProSe Function that the UE wants to stop using Restricted
Discovery Filter(s) for direct discovery monitoring as defined in 3GPP TS
23.303 [2].
The UE shall only initiate the restricted ProSe direct discovery model A
monitor request procedure if it has been authorised for restricted ProSe
direct discovery model A monitoring in at least in one PLMN based on the
service authorisation procedure.
As a result of the monitor request procedure completing successfully, the UE
obtains one or more Restricted Discovery Filters, along with a TTL (Time-To-
Live) timer T4009 for each Restricted Discovery Filter indicating the time
during which the filter is valid.
#### 6.2.3A.2 Monitor request procedure Initiation
Before initiating the monitor request procedure, the user sets the permissions
for the restricted discovery using application layer mechanisms. The
application client in the UE retrieves the PDUID provisioned to the UE as part
of the service authorisation procedure as specified in clause 5, and obtains
an RPAUID associated with the UE\'s PDUID and the target RPAUID(s) to be
monitored from the ProSe Application Server. This step is performed using
mechanisms that are out of scope of the present specification.
If the UE is authorised to perform ProSe direct discovery model A monitoring
in at least one PLMN, it shall initiate a monitor request procedure:
a) when the UE is triggered by an upper layer application to perform
restricted ProSe direct discovery model A monitoring corresponding to at least
one RPAUID, and the UE has no valid Restricted Discovery Filters corresponding
to the requested RPAUID for that upper layer application; or
b) when the TTL timer T4009 assigned by the ProSe Function to a Restricted
Discovery Filter has expired and the request from upper layers to monitor that
RPAUID is still in place; or
NOTE 1: To ensure service continuity if the UE needs to keep monitoring the
same Restricted Discovery Filter, the UE can initiate the monitor request
procedure before the TTL timer T4009 assigned by the ProSe Function for a
Restricted Discovery Filter expires.
c) when the UE needs to update a previously sent restricted ProSe direct
discovery model A monitoring request.
The UE initiates the monitor request procedure by sending a DISCOVERY_REQUEST
message with:
\- a new transaction ID;
\- the RPAUID set to the RPAUID received from upper layers;
\- the command set to \"monitor\";
\- the Discovery Type set to \"Restricted discovery\"
\- the UE identity set to the UE\'s IMSI;
\- the Application Identity set to the Application Identity of the upper layer
application that requested the monitoring;
\- the ACE Enabled Indicator set to \"application-controlled extension
enabled\" if application-controlled extension is required by the upper layers,
or \"normal\" if application-controlled extension is not used;
\- the Application Level Container set to the target RPAUIDs to monitor;
\- the Discovery Entry ID set to 0 if the monitoring request is a new request,
and set to the Discovery Entry ID received from the ProSe Function if the
monitoring request is to update a previously sent monitoring request;
\- optionally, the Requested Timer set to 0 only when the UE wants to stop
using Restricted Discovery Filter(s) for direct discovery monitoring; and
\- optionally the PC5_tech set to the PC5 radio technology that the UE wishes
to use for monitoring. PC5_tech may include more than one PC5 radio
technology.
If restricted direct discovery model A with application-controlled extension
is requested by upper layers, the Application Level Container included in the
DISCOVERY_ REQUEST also contains information corresponding to the ProSe
Restricted Code Suffix, e.g. group or user-specific information.
NOTE 2: A UE can include one or multiple transactions in one DISCOVERY_REQUEST
message for one or more different monitoring targets, and receive
corresponding \ element or \ element in the
DISCOVERY_RESPONSE message for each respective transaction. In the following
description of the monitor request procedure, only one transaction is
included.
Figure 6.2.3A.2.1 illustrates the interaction between the UE and the ProSe
Function in the monitor request procedure.
Figure 6.2.3A.2.1: Monitor request procedure for restricted ProSe direct
discovery model A
#### 6.2.3A.3 Monitor request procedure accepted by the ProSe Function
Upon receiving a DISCOVERY_REQUEST message with the command set to \"monitor\"
and the Discovery Type set to \"Restricted discovery\", if the Requested Timer
is included in the DISCOVERY_REQUEST message and the Requested Timer is set to
0, the ProSe Function shall check whether there is an existing UE context
containing the discovery entry identified by the Discovery Entry ID included
in the DISCOVERY_REQUEST message. If the discovery entry exists in the UE
context, the ProSe Function shall remove the discovery entry identified by the
Discovery Entry ID from the UE\'s context. For each of the PDUIDs
corresponding to the target RPAUIDs contained the Restricted Discovery Filters
in the discovery entry, if the PDUID is PLMN-specific and that PLMN ID
indicated by the PDUID is not the same as that of the PLMN to which the ProSe
Function belongs, the ProSe Function shall inform the ProSe Function in the
PLMN indicated by the PDUID to remove the corresponding discovery entry as
specified in 3GPP TS 29.345 [5]. Then the ProSe Function shall send a
DISCOVERY_RESPONSE message containing a \ element
with:
\- the transaction ID set to the value of the transaction ID received in the
DISCOVERY_REQUEST message;
\- the Discovery Entry ID set to the value of the Discovery Entry ID received
in the DISCOVERY_REQUEST message; and
\- optionally the PC5_tech set to the value of the PC5_tech if it was received
in the DISCOVERY_REQUEST message.
Upon receiving a DISCOVERY_REQUEST message with the command set to \"monitor\"
and the Discovery Type set to \"Restricted discovery\", if the Requested Timer
is not included in the DISCOVERY_REQUEST message, the ProSe Function shall
perform the following procedure.
The ProSe Function shall check that the application corresponding to the
Application Identity contained in the DISCOVERY_REQUEST message is authorised
for ProSe direct discovery model A monitoring. If the application is
authorised for restricted ProSe direct discovery model A monitoring, the ProSe
Function shall check whether there is an existing UE context.
If there is no associated UE context, the ProSe Function checks with the HSS
whether the UE is authorised for restricted ProSe direct discovery model A
monitoring as described in 3GPP TS 29.344 [3]. The HSS provides to the ProSe
Function the PLMN ID of the PLMN in which the UE is currently registered. If
the subscription check indicates that the UE is authorised, the ProSe Function
creates a new UE context containing the UE\'s subscription parameters obtained
from the HSS.
If the Discovery Entry ID included in the DISCOVERY_REQUEST is set to 0 then:
\- the ProSe Function shall use the procedure described in 3GPP TS 29.343 [31]
to pass the Application Level Container included in the DISCOVERY_REQUEST
message to the ProSe Application Server and obtain a list of PDUID(s) , an
Application Level Container and optionally Metadata Indicator(s) corresponding
to the authorised target RPAUID(s) from the ProSe Application Server;
\- if the ACE Enabled Indicator in the DISCOVERY_REQUEST message is set to
\"application-controlled extension enabled\" and the requested application
uses application-controlled extension, the ProSe Function shall check whether
the UE is authorized to use ACE. If the UE is authorized for ACE, the ProSe
Function shall also use the procedure described in 3GPP TS 29.343 [31] to
obtain the mask(s) for monitoring a ProSe Restricted Suffix Pool corresponding
to each of the Target RPAUIDs.
NOTE 1: The ProSe Application Server can reject the request for some of the
target RPAUIDs included in the Application Level Container in the
DISCOVERY_REQUEST message because they are ineligible to be monitored by the
requesting UE. Depending on the operator policy and application layer
permissions, it is possible that only a subset of valid RPAUIDs are authorised
by the ProSe Application Server.
\- for each of the PDUIDs corresponding to an authorised target RPAUID, if the
PLMN ID of the PDUID is not the same as that of the PLMN to which the ProSe
Function belongs, then the ProSe Function executes the procedures defined in
3GPP TS 29.345 [5] to obtain the ProSe Restricted Code or ProSe Restricted
Code Prefix for the target RPAUID and creates Restricted Discovery Filter(s).
Otherwise, for each target RPAUID, the ProSe Function shall allocate one or
more Restricted Discovery Filter(s). If the ACE Enabled Indicator in the
DISCOVERY_REQUEST message _does not match the ACE configuration in the ProSe
Function or ProSe Application Server for this application, the ACE
configuration in the ProSe Function or ProSe Application Server shall be used
to create Restricted Discovery Filter(s). Each Restricted Discovery Filter
consists of a ProSe Restricted Code, one or more masks, a TTL timer T4009,
optionally the_ target RPAUID, optionally a metadata indicator _and optionally
metadata associated with this RPAUID;_
_\- t_ he ProSe Function associates the Restricted Discovery Filters with a
new discovery entry in the UE\'s context; and
\- the ProSe Function starts timer T4010 assigned for each Restricted
Discovery Filter. For a given Restricted Discovery Filter, timer T4010 shall
be longer than timer T4009. By default, the value of timer T4010 is 4 minutes
greater than the value of timer T4009.
NOTE 2: For each target RPAUID, the ProSe Function either allocates one
Restricted Discovery Filter for full-matching the ProSe Restricted Code
assigned to this RPAUID, or allocates one or more Restricted Discovery
Filter(s) for matching the ProSe Restricted Code Prefix and Suffix Pool
assigned to this RPAUID.
If the Discovery Entry ID included in the DISCOVERY_REQUEST message is not set
to 0 and if there is an existing discovery entry for this Discovery Entry ID
in the UE\'s context, the ProSe Function shall check whether the UE is
authorised for restricted ProSe direct discovery model A monitoring. If the UE
is authorised, the ProSe Function shall process the request as above-mentioned
and update this discovery entry with the contents of the Restricted Discovery
Filter(s) associated with this discovery entry and restart timer T4010(s) for
each filter. The update of a Restricted Discovery Filter content includes
setting new TTL timer(s) and if necessary, obtaining new ProSe Restricted Code
and ProSe Restricted Mask(s) via the procedure defined in 3GPP TS 29.345 [5].
If the Discovery Entry ID contained in the DISCOVERY_REQUEST message is not
found in the UE context or there is no UE context in the ProSe Function, the
ProSe Function shall behave as if the Discovery Entry ID included in the
DISCOVERY_REQUEST message was set to 0, and the ProSe Function shall allocate
a new non-zero Discovery Entry ID for this entry.
Then the ProSe Function shall send a DISCOVERY_RESPONSE message containing a
\ element with:
\- the transaction ID set to the value of the transaction ID received in the
DISCOVERY_REQUEST message from the UE;
\- one or more Restricted Discovery Filter(s) allocated by the ProSe
Function(s) for the authorised target RPAUID(s);
\- the ACE Enabled Indicator set to \"application-controlled extension
enabled\" if application-controlled extension is used, or \"normal\" if
application-controlled extension is not used;
\- the Discovery Entry ID set to the ID of the discovery entry associated with
this monitor request;
\- the Application Level Container set to the application-level data received
from the ProSe Application Server; and
\- optionally the PC5_tech set to the one or more PC5 radio technologies that
may be used for the Restricted Discovery Filters allocated by the ProSe
Function(s).
If T4010 expires, the ProSe Function shall remove the corresponding Restricted
Discovery Filter from the discovery entry in the UE\'s context. Furthermore,
if there are no valid Restricted Discovery Filters associated with the
discovery entry (e.g, all Restricted Discovery Filters have expired), the
ProSe Function shall delete the discovery entry from the UE\'s context.
#### 6.2.3A.4 Monitor request procedure completion by the UE
Upon receipt of the DISCOVERY_RESPONSE message, if only the transaction ID and
the Discovery Entry ID are contained in \ element
and the transaction ID and the Discovery Entry ID match the corresponding
values sent by the UE in a DISCOVERY_REQUEST message with the command set to
\"monitor\", the UE shall:
\- stop TTL timer T4009 for each Restricted Discovery Filter in the discovery
entry identified by the Discovery Entry ID;
\- remove the discovery entry identified by the Discovery Entry ID; and
\- instruct the lower layers to stop monitoring.
Upon receipt of the DISCOVERY_RESPONSE message, if the transaction ID
contained in the \ element matches the value sent
by the UE in a DISCOVERY_REQUEST message with the command set to \"monitor\"
and, the UE shall process as follow:
  * If the DISCOVERY_RESPONSE creates a new discovery entry, start the TTL timer T4009 with the received value for each Restricted Discovery Filter information element received in the DISCOVERY_RESPONSE message.
  * If the DISCOVERY_RESPONSE updates an existing discovery entry, the UE shall
\- stop the T4009 timer(s) of any Restricted Discovery Filter in this
discovery entry which are no longer authorized by the ProSe Function, ask
lower layers to stop using those filters in monitoring operation, and remove
the corresponding Restricted Discovery Filter from the discovery entry;
\- restart the T4009 timer(s) for those remain eligible; and
\- start the T4009 timer(s) for any new Restricted Discovery Filter(s)
included in the DISCOVERY_RESPONSE message.
Otherwise the UE shall discard the DISCOVERY_RESPONSE message and shall not
perform the procedures below.
The UE may perform monitoring for discovery messages received over the PC5
interface as described below.
The UE provides the Application Level Container, which contains the authorised
Target RPAUID(s), to the upper layer applications. _For each authorised target
RPAUID , the ProSe Function may have assigned one or more Restricted Discovery
Filters. If application-controlled extension is used_ , _th_ e UE may further
apply additional filtering on the part corresponding to the ProSe Restricted
Code Suffix. _The UE should then apply all Restricted Discovery Filters to its
monitoring operation. Using these Restricted Discovery Filters may result in a
match event. In case of a match event, the UE shall consider that the target
RPAUID it seeks to monitor has been discovered. A match event is defined as
follows:_
_There is match event when, for any of the masks_ i _n a Restricted Discovery
Filter, the output of a bitwise AND operation between the ProSe Restricted
Code contained in the_ received _PC5_DISCOVERY message and th_ e mask,
_matches the output of a bitwise AND operation between the_ mask _and the
code_ contained _in the same Restricted Discovery_ F _ilter._
NOTE: In a Restricted Discovery Filter, a mask with all bits set to \"1\" is
assigned by the ProSe Function for full matching of a ProSe Restricted Code.
When applying a Restricted Discovery Filter to a received PC5_DISCOVERY
message for the above-mentioned bitwise AND operation, the UE shall use the
DUSK, if received as part of the filter in the DISCOVERY_RESPONSE message, and
the UTC-based counter generated during the monitoring operation, to unscramble
the PC5_DISCOVERY message as described in 3GPP TS 33.303 [6]. Then, if a DUCK
is included as part of the filter, the UE shall use the DUCK and the UTC-based
counter to decrypt the message-specific confidentiality protected portion
identified by the Encrypted Bitmask, as described in 3GPP TS 33.303 [6];
NOTE: The UE can look for a match on the unencrypted bits first before
applying DUCK, to minimise the amount of processing performed before finding a
match.
If a DUIK is received as part of the filter, the UE shall use the DUIK and the
UTC-based counter to verify the MIC field in the unscrambled PC5_DISCOVERY
message. If a MIC Check Indicator parameter is included instead, the UE shall
use the match report procedure described in subclause 6.2.4A to trigger
checking of the MIC of the PC5_DISCOVERY message containing the ProSe
Restricted Code by the ProSe Function.
The UE may instruct the lower layers to start monitoring if all of the
following conditions are met:
\- the UE is currently authorized to perform E-UTRA-based restricted ProSe
direct discovery model A monitoring in at least one PLMN or the UE is
currently authorized to perform WLAN-based restricted ProSe direct discovery
model A monitoring;
\- the UE has obtained at least one Restricted Discovery Filter and their
respective TTL timer T4009(s) have not expired; and
\- a request from upper layers to monitor for the RPAUID(s) associated with an
authorised Application Identity is still in place.
In case of E-UTRA-based restricted ProSe direct discovery model A monitoring
if the UE is in EMM-CONNECTED mode, the monitoring UE shall also trigger the
corresponding procedure in lower layers as specified in 3GPP TS 36.331 [12].
During the monitoring operation, the UE receives all PC5_DISCOVERY messages
and associated UTC times from the lower layers. The UE shall generate the UTC-
based counter corresponding to the UTC time associated with a PC5_DISCOVERY
message and only process the PC5_DISCOVERY message if the UTC-based counter is
within Max Offset of the time shown by the clock used for ProSe by the UE.
During the monitoring operation, if one of the above conditions is no longer
met, the UE may instruct the lower layers to stop monitoring. When the UE
stops monitoring, in case of E-UTRA-based restricted ProSe direct discovery
model A monitoring if the UE is in EMM-CONNECTED mode, the UE shall trigger
the corresponding procedure in lower layers as specified in 3GPP TS 36.331
[12].
#### 6.2.3A.5 Monitor request procedure not accepted by the ProSe Function
If the DISCOVERY_REQUEST message is not accepted by the ProSe Function, the
ProSe Function shall send a DISCOVERY_RESPONSE message containing a
\ element to the UE including an appropriate PC3 Control
Protocol cause value.
If the application corresponding to the Application Identity contained in the
DISCOVERY_REQUEST message is not authorised for ProSe direct discovery
monitoring, the ProSe Function shall send a DISCOVERY_RESPONSE message
containing a \ element with PC3 Control Protocol cause value
#1 \"Invalid application\".
If the RPAUID contained in the DISCOVERY_REQUEST message is unknown to the
ProSe Application Server, the ProSe Function shall send a DISCOVERY_RESPONSE
message containing a \ element with PC3 Control Protocol
cause value #9 \"Unknown RPAUID\".
If none of the RPAUID(s) contained in the Application Level Container in the
DISCOVERY_REQUEST message is eligible to be discovered by the requesting
RPAUID, the ProSe Function shall send a DISCOVERY_RESPONSE message containing
a \ element with PC3 Control Protocol cause value #11
\"Invalid Discovery Target\".
If the RPAUID contained in the DISCOVERY_REQUEST message does not match the
stored RPAUID for the requested Discovery Entry ID, the ProSe Function shall
send a DISCOVERY_RESPONSE message containing a \ element with
PC3 Control Protocol cause value #10 \"Unknown or Invalid Discovery Entry
ID\".
If the UE is not authorised for restricted ProSe direct discovery monitoring,
the ProSe Function shall send a DISCOVERY_RESPONSE message containing a
\ element with PC3 Control Protocol cause value #3 \"UE
authorisation failure\".
If the RPAUID contained in the DISCOVERY_REQUEST message is not associated
with a PDUID belonging to the requesting UE, the ProSe Function shall send a
DISCOVERY_RESPONSE message containing a \ element with PC3
Control Protocol cause value #3 \"UE authorisation Failure\".
If the UE is not authorized to use ACE, but the DISCOVERY_REQUEST message
contains the ACE Enabled Indicator set to \"application-controlled extension
enabled\", the ProSe Function shall send a DISCOVERY_RESPONSE message
containing a \ element with PC3 Control Protocol cause value
#12 \"UE unauthorised for discovery with Application-Controlled Extension\".
If the Discovery Entry ID contained in the DISCOVERY_REQUEST message is
unknown to the ProSe Function and the Requested Timer is set to 0, the ProSe
Function shall send a DISCOVERY_RESPONSE message containing a \ element with PC3 Control Protocol cause value #10 \"Unknown or invalid
Discovery Entry ID\".
#### 6.2.3A.6 Abnormal cases
##### 6.2.3A.6.1 Abnormal cases in the UE
The following abnormal cases can be identified:
a) Indication from the transport layer of transmission failure of
DISCOVERY_REQUEST message (e.g. after TCP retransmission timeout)
The UE shall close the existing secure connection to the ProSe Function,
establish a new secure connection and then restart the monitor request
procedure.
b) No response from the ProSe Function after the DISCOVERY_REQUEST message has
been successfully delivered (e.g. TCP ACK has been received for the
DISCOVERY_REQUEST message)
The UE shall retransmit the DISCOVERY_REQUEST message.
NOTE: The timer to trigger retransmission and the maximum number of allowed
retransmissions are UE implementation specific.
c) Indication from upper layers that the request to monitor the targets
contained in Application Level Container is no longer in place after sending
the DISCOVERY_REQUEST message, but before the monitor request procedure is
completed
The UE shall acknowledge the DISCOVERY_RESPONSE message received from the
ProSe Function but discard its contents and then abort the procedure.
d) Change of PLMN
If a PLMN change occurs before the monitor request procedure is completed, the
procedure shall be aborted. If the UE is authorized to monitor in the new
PLMN, the procedures shall be restarted once the UE is registered on the new
PLMN.
##### 6.2.3A.6.2 Abnormal cases in the ProSe Function
The following abnormal cases can be identified:
a) Indication from the lower layer of transmission failure of
DISCOVERY_RESPONSE message
After receiving an indication from lower layer that the DISCOVERY_RESPONSE
message has not been successfully acknowledged, the ProSe Function shall abort
the procedure, and stop any associated timer(s) T4010, if running.
### 6.2.3B Discoverer request procedure for restricted ProSe direct discovery
model B
#### 6.2.3B.1 General
The purpose of the discoverer request procedure for restricted ProSe direct
discovery model B is for the UE to obtain ProSe Query Code(s) and Discovery
Response Filter(s) to be used for sending query and monitoring responses over
the PC5 interface based on the information provided by the upper layer
application, as defined in 3GPP TS 23.303 [2].
Before initiating the discoverer request procedure, the UE shall be authorised
for restricted ProSe direct discovery model B discoverer operation in the
registered PLMN or the local PLMN based on the service authorisation procedure
as specified in clause 5.
NOTE: The notion of \"local PLMN\" does not apply for WLAN-based ProSe direct
discovery. The UE can engage in WLAN-based ProSe direct discovery as
announcing UE regardless of the serving PLMN or other PLMNs that provide
E-UTRAN coverage in the UE location.
As the result of successful completion of this procedure, the UE obtains one
or more ProSe Query Code(s) which can be included in a PC5_DISCOVERY message
and passes the PC5_DISCOVERY message to the lower layers for transmission over
the PC5 interface. The UE also obtains Discovery Response Filter(s) and apply
it to the monitoring operation in PC5 interface to match potential responses
for the sent query request for the target RPAUID.
#### 6.2.3B.2 Discoverer request procedure initiation
Before initiating the discoverer request procedure, the user sets the
permissions for the restricted discovery using application layer mechanisms.
The application client in the UE retrieves the PDUID provisioned to the UE as
part of the service authorisation procedure as specified in clause 5 and
obtains an RPAUID associated with the UE\'s PDUID from the ProSe Application
Server. The UE may also obtain the target RPAUID(s) from the ProSe Application
Server. This step is performed using mechanisms that are out of scope of the
present specification.
If the UE is authorised to perform E-UTRA-based restricted ProSe direct
discovery model B discoverer operation in the PLMN operating the radio
resources signalled from the serving PLMN, or if the UE is authorised to
perform WLAN-based restricted ProSe direct discovery model B discoverer
operation it shall initiate a discoverer request procedure:
a) when the UE is triggered by an upper layer application to perform the query
for one or more target RPAUIDs in Model B and the UE has no valid
corresponding ProSe Query Code and Discovery Response Filter for those target
RPAUIDs of the upper layer application;
b) when the validity timer T4013 assigned by the ProSe Function to a ProSe
Query Codes and the corresponding Discovery Response Filter has expired and
the request from upper layers to announce the RPAUID corresponding to that
ProSe Response Code is still in place;
c) when the UE selects a new PLMN while announcing a ProSe Query Code or
waiting for a ProSe Response Code and intends to announce the ProSe Query Code
in the new PLMN, and the UE is authorised for restricted ProSe direct
discovery model B discoverer operation in the new PLMN;
d) when, while querying for target RPAUID(s), the UE intends to switch the
announcing PLMN to a different PLMN without performing PLMN selection, and the
UE does not have a valid allocated ProSe Query Code for this new PLMN yet; or
e) when the UE needs to update a previously sent restricted ProSe direct
discovery model B discoverer request.
When the UE selects a new PLMN while announcing a ProSe Query Code or waiting
for a ProSe Response Code and the UE is not yet authorised for restricted
ProSe direct discovery model B discoverer operation in the new PLMN, the UE
shall initiate a discoverer request procedure only after the UE is authorised
for restricted ProSe direct discovery model B discoverer operation in the new
PLMN.
NOTE 1: To ensure service continuity if the UE needs to keep announcing in
Model B a ProSe Query Code corresponding to the same RPAUID, the UE can
initiate the discoverer request procedure before the validity timer T4013
assigned by the ProSe Function for a ProSe Query Code expires.
The UE initiates the discoverer request procedure by sending a
DISCOVERY_REQUEST message with:
\- a new transaction ID not used in any other direct discovery procedures in
PC3 interface;
\- the RPAUID set to the RPAUID received from upper layers;
\- the Application Level Container set to contain the application-layer
information, e.g., target RPAUID(s) to discover;
\- the command set to \"query\";
\- the UE identity set to the UE\'s IMSI;
\- the Application Identity set to the Application Identity of the upper layer
application that requested the announcing;
\- the Discovery Type set to \"Restricted discovery\";
\- the Discovery Model set to \"Model B\";
\- the Discovery Entry ID set to a 0 if the discoverer request is a new
request, and set to the Discovery Entry ID received from the ProSe Function if
the discoverer request is to update a previously sent discoverer request;
\- optionally in case of E-UTRA-based restricted ProSe direct discovery model
B discoverer operation the Announcing PLMN ID set to the PLMN ID of the local
PLMN operating the radio resources that the UE intends to use for transmitting
the query for the target RPAUID(s); and
\- optionally the PC5_tech set to the PC5 radio technology that the UE wishes
to use. PC5_tech may include more than one PC5 radio technology.
NOTE 2: A UE can include one or multiple transactions in one DISCOVERY_REQUEST
message for different discovering requests (e.g., for different applications),
and receive corresponding \ element or
\ element in a DISCOVERY_RESPONSE message for each respective
transaction. In the following description of the discoverer request procedure,
only one transaction is included.
Figure 6.2.3B.2.1 illustrates the interaction of the UE and the ProSe Function
in the discoverer request procedure.
Figure 6.2.3B.2.1: Discoverer request procedure for restricted ProSe direct
discovery model B
#### 6.2.3B.3 Discoverer request procedure accepted by the ProSe Function
Upon receiving a DISCOVERY_REQUEST message, the ProSe Function shall check
that the application corresponding to the Application Identity contained in
the DISCOVERY_REQUEST message is authorised for restricted ProSe direct
discovery model B discoverer operation. If the application is authorised for
restricted ProSe direct discovery model B discoverer operation, the ProSe
Function shall check whether there is an existing context for the UE.
If there is no associated UE context, the ProSe Function checks with the HSS
whether the UE is authorised for restricted ProSe direct discovery model B
discoverer operation as described in 3GPP TS 29.344 [3]. If the check
indicates that the UE is authorised, the ProSe Function creates a UE context
that contains the UE\'s subscription parameters obtained from the HSS. The HSS
also provides to the ProSe Function the PLMN ID of the PLMN in which the UE is
currently registered.
If the UE context exists, the ProSe Function shall check whether the UE is
authorized for restricted ProSe direct discovery model B discoveree operation
in the currently registered PLMN or in case of E-UTRA-based restricted ProSe
direct discovery model B discoverer operation the local PLMN identified by the
Announcing PLMN ID included in the DISCOVERY_REQUEST message.
If the UE is authorized and the Discovery Entry ID included in the
DISCOVERY_REQUEST message is set to 0 then:
\- the ProSe Function shall use the procedure described in 3GPP TS 29.343 [31]
to pass the Application Level Container included in the DISCOVERY_REQUEST
message to the ProSe Application Server and obtain a list of PDUID(s)
corresponding to the authorised target RPAUID(s) from the ProSe Application
Server;
\- for each of the PDUIDs corresponding to an authorised target RPAUID:
\- if the PLMN ID of the PDUID is not the same as that of the PLMN to which
the ProSe Function belongs, then the ProSe Function executes the procedures
defined in 3GPP TS 29.345 [5] to obtain the ProSe Query Code, the ProSe
Response Code, the associated validity timer T4012, and _optionally metadata
associated with this_ target RPAUID. Otherwise, the ProSe Function shall
locate the discoveree UE context and retrieve the corresponding ProSe Query
Code and ProSe Response Code and the validity timer T4012, and _optionally
metadata associated with this RPAUID_. Then, the ProSe Function in the HPLMN
builds one or more Discovery Response Filter(s) based on the respective ProSe
Response Code, and associate the Discovery Response Filter(s) and ProSe Query
Code with a new validity timer T4013 based on the remaining value of T4012.
> NOTE 1: If the ProSe Function cannot retrieve the corresponding discoveree
> UE context for a target RPAUID, e.g. the target RPAUID has not yet been
> requested to be discovered by Model B in a discoveree request procedure, or
> the discoveree UE context expires, the ProSe Function can skip the
> processing of this target RPAUID.
NOTE 2: The ProSe Function can choose the value of T4013 to be longer than the
remaining value of T4012, so that the discoverer UE sends a new discoverer
request for renewing the query-related information no earlier than the
discoveree UE renewing its own ProSe Response Code with the ProSe Function.
_\- t_ he ProSe Function associates the ProSe Query Code and corresponding
Discovery Response Filter(s), target RPAUID, and optionally metadata
associated with the target RPAUID with a new discovery entry in the discoverer
UE\'s context; and
\- the ProSe Function starts timer T4014 assigned for each ProSe Query Code
and Discovery Response Filter(s) (of each target RPAUID) under this discovery
entry of the discoverer UE context. For a given ProSe Query Code and the
corresponding Discovery Response Filter(s), timer T4014 shall be longer than
timer T4013. By default, the value of timer T4014 is 4 minutes greater than
the value of timer T4013.
If the Discovery Entry ID included in the DISCOVERY_REQUEST message is not set
to 0 and if there is an existing discovery entry for this Discovery Entry ID
value in the UE\'s context, the ProSe Function shall still process the above
steps, but update the discovery entry instead of creating a new discovery
entry.
If the Discovery Entry ID contained in the DISCOVERY_REQUEST message is not
found in the UE context or there is no UE context in the ProSe Function, the
ProSe Function shall behave as if the Discovery Entry ID included in the
DISCOVERY_REQUEST message was set to 0, and the ProSe Function shall allocate
a new non-zero Discovery Entry ID for this entry.
If a new UE context was created or an existing UE context was updated, the UE
is currently roaming or the Announcing PLMN ID is included in the
DISCOVERY_REQUEST message, the ProSe Function checks with the ProSe Function
of the VPLMN or in case of E-UTRA-based restricted ProSe direct discovery
model B discoverer operation the local PLMN indicated by the Announcing PLMN
ID whether the UE is authorised for restricted ProSe direct discovery model B
discoverer operation as described in 3GPP TS 29.345 [5].
The ProSe Function shall then send a DISCOVERY_RESPONSE message containing a
\ element with:
\- the transaction ID set to the value of the transaction ID received in the
DISCOVERY_REQUEST message from the UE;
\- one or more Subquery Result information elements, each of which includes:
\- a target RPAUID;
\- the ProSe Query Code set to the ProSe Query Code for the target RPAUID;
\- one or more the Discovery Response Filters IE which are set to include the
Discovery Response Filter(s) used to match a potential ProSe Response Code
responding to the ProSe Query Code.;
\- a validity timer T4013 set to the T4013 timer value assigned by the ProSe
Function to the ProSe Query Code and the Discovery Response Filter(s); and
\- optionally, the metadata associated with the target RPAUID;
\- the Restricted Security IE containing the security key(s) needed to be used
with Discovery Response Filter(s) for restricted discovery monitoring;
\- the Discovery Entry ID set to the ID of the discovery entry associated with
this announce request in the UE context; and
\- optionally the PC5_tech set to the one or more PC5 radio technologies that
are authorized to be used for the assigned ProSe Query Code.
If T4014 expires, the ProSe Function shall remove the corresponding ProSe
Query Code and ProSe Response Filter(s) from the discovery entry associated
with the discoverer UE\'s context.
#### 6.2.3B.4 Discoverer request procedure completion by the UE
Upon receipt of the DISCOVERY_RESPONSE message, if the transaction ID
contained in the \ element matches the value
sent by the UE in a DISCOVERY_REQUEST message with the command set to
\"query\" and the Discovery Model set to \"Model B\", the UE shall, process as
follow:
  * If the DISCOVERY_RESPONSE creates a new discovery entry, start the validity timer T4013 with the received value for the ProSe Query Code and the corresponding Discovery Response Filter(s) included for each SubQuery-Result information element received in the DISCOVERY_RESPONSE message and the PLMN ID of the intended announcing PLMN if included in the DISCOVERY_REQUEST message;
  * If the DISCOVERY_RESPONSE updates an existing discovery entry, the UE shall
\- stop the timer T4013 of any ProSe Query Code(s) and Discovery Response
Filter(s) in this discovery entry which are no longer authorized by the ProSe
Function, ask lower layers to stop announcing the ProSe Query Code(s) and
monitoring ProSe Response Filter(s), and remove the ProSe Query Code(s) and
Discovery Response Filter(s) from the existing discovery entry;
\- restart the T4013 timer(s) for those remain eligible;
\- start the T4013 timer(s) for any new ProSe Query Codes and their
corresponding Discovery Response Filter(s); and
\- update the PLMN ID of the intended announcing PLMN for this discovery entry
if included in the DISCOVERY_REQUEST message.
Otherwise the UE shall discard the DISCOVERY_RESPONSE message and shall not
perform the procedures below.
For each ProSe Query Code in this discovery entry, the UE _requests the lower
layers to announce the ProSe Query Code in the PC5 interface, as specified in_
3GPP TS 36.331 [12]. In case of E-UTRA-based restricted ProSe direct discovery
model B discoverer operation this shall be done only if the lower layers
indicate that ProSe direct discovery is supported by the network. In case of
E-UTRA-based restricted ProSe direct discovery model B discoverer operation if
the UE in EMM-IDLE mode has to request resources for ProSe direct discovery
announcing as specified in 3GPP TS 36.331 [12], the UE shall perform a service
request procedure or tracking area update procedure as specified in 3GPP TS
24.301 [11]. The UE shall obtain the UTC time for the next discovery
transmission opportunity for ProSe direct discovery from the lower layers.
If a valid UTC time is obtained, the UE shall generate the UTC-based counter
corresponding to this UTC time as specified in subclause 12.2.2.18. If the
resulting UTC-based counter is within Max Offset of the time shown by the
clock used for ProSe by the UE, the UE shall for each ProSe Query Code in this
discovery entry, use the ProSe Query Code to construct a PC5_DISCOVERY
message, according to the format defined in subclause 11.2.5.
The UE shall then apply one or more of the DUIK, DUSK or DUCK with the
associated Encrypted Bitmask, whichever received in the Restricted Code
Security Material parameter of the DISCOVERY_RESPONSE message, along with the
UTC-based counter to the PC5_DISCOVERY message, to e.g. generate a MIC value,
scramble the message contents or provide confidentiality protection, as
specified in 3GPP TS 33.303 [6].
The UE then passes the resulting PC5_DISCOVERY message, along with the PLMN ID
of the intended announcing PLMN stored for this discovery entry, to the lower
layers for transmission and instruct the lower layers to start monitoring if:
\- the UE is currently authorised to perform restricted ProSe direct discovery
model B discoverer operation in the registered PLMN or in case of E-UTRA-based
restricted ProSe direct discovery model B discoverer operation the local PLMN
operating the radio resources that the UE intends to use;
\- the validity timer T4013 for the ProSe Query Code and corresponding ProSe
Response Filter(s) has not expired; and
\- a request from upper layers to query the target RPAUID in restricted
discovery Model B, associated with both the ProSe Query Code, and the
authorised Application Identity, is still in place.
During the discoverer operation, if one of the above conditions is no longer
met, the UE may instruct the lower layers to stop the discoverer operation.
When the UE stops discoverer operation, in case of E-UTRA-based restricted
ProSe direct discovery model B discoverer operation if the lower layers
indicate that the UE is required to send a discovery indication to the eNodeB
and the UE is in EMM-CONNECTED mode, the UE shall trigger the corresponding
procedure in lower layers as specified in 3GPP TS 36.331 [12].
The UE shall ensure that it keeps on passing PC5_DISCOVERY messages to the
lower layers for transmission until the validity timer T4013 of the ProSe
Query Code expires. How this is achieved is left up to UE implementation.
The UE may apply the received Discovery Response Filter(s) to its monitoring
operation. _Using the Discovery Response Filter may result in a match event
for the target RPAUID the UE is querying for. There is match event when, for
any of the masks_ i _n a Discovery Response Filter, the output of a bitwise
AND operation between the ProSe Response Code contained in the_ received
_PC5_DISCOVERY message and th_ e mask, _matches the output of a bitwise AND
operation between the_ mask _and the code_ contained _in the Discovery
Response_ F _ilter._
When applying a Discovery Response Filter to a received PC5_DISCOVERY message
for the bitwise AND operation, the UE shall use the DUSK, if received as part
of the filter in the DISCOVERY_RESPONSE message, and the UTC-based counter
generated during the monitoring operation, to unscramble the PC5_DISCOVERY
message as described in 3GPP TS 33.303 [6]. Then, if a DUCK is included as
part of the filter, the UE shall use the DUCK and the UTC-based counter to to
decrypt the message-specific confidentiality protected portion identified by
the Encrypted Bitmask, as described in 3GPP TS 33.303 [6];
NOTE: The UE can look for a match on the unencrypted bits first before
applying DUCK, to minimise the amount of processing performed before finding a
match.
If a DUIK is received as part of the filter, the UE shall use the DUIK and the
UTC-based counter to verify the MIC field in the unscrambled PC5_DISCOVERY
message. If a MIC Check Indicator parameter is included instead, the UE shall
use the match report procedure described in subclause 6.2.4B to trigger
checking of the MIC of the PC5_DISCOVERY message containing the ProSe Response
Code by the ProSe Function.
_The UE may notify the upper layer application about the match event of
restricted ProSe direct discovery Model B with the corresponding target RPAUID
and metadata, if the RPAUID and meta-data are included in the Subquery Result
element in_ the DISCOVERY_RESPONSE message.
#### 6.2.3B.5 Discoverer request procedure not accepted by the ProSe Function
If the DISCOVERY_REQUEST message cannot be accepted by the ProSe Function, the
ProSe Function sends a DISCOVERY_RESPONSE message containing a \ element to the UE including an appropriate PC3 Control Protocol cause
value.
If the application corresponding to the Application Identity contained in the
DISCOVERY_REQUEST message is not authorised for restricted ProSe direct
discovery Model B discoverer operation, the ProSe Function shall send the
DISCOVERY_RESPONSE message containing a \ element with PC3
Control Protocol cause value #1 \"Invalid application\".
If the RPAUID contained in the DISCOVERY_REQUEST message is unknown to the
ProSe Function or ProSe Application Server, the ProSe Function shall send a
DISCOVERY_RESPONSE message containing a \ element with PC3
Control Protocol cause value #9 \"Unknown RPAUID\".
If the RPAUID contained in the DISCOVERY_REQUEST message does not match the
stored RPAUID for the requested Discovery Entry ID, the ProSe Function shall
send a DISCOVERY_RESPONSE message containing a \ element with
PC3 Control Protocol cause value #10 \"Unknown or Invalid Discovery Entry
ID\".
If the UE is not authorised for restricted ProSe direct discovery model B
discoverer operation, the ProSe Function shall send the DISCOVERY_RESPONSE
message containing a \ element with PC3 Control Protocol
cause value #3 \"UE authorisation failure\".
If the RPAUID contained in the DISCOVERY_REQUEST message is not associated
with a PDUID belonging to the requesting UE, the ProSe Function shall send a
DISCOVERY_RESPONSE message containing a \ element with PC3
Control Protocol cause value #3 \"UE authorisation Failure\".
If the ProSe Function fails to retrieve any valid target PDUIDs from ProSe
Application Server based on the Application Level Container contained in the
DISCOVERY_REQUEST message, the ProSe Function shall send a DISCOVERY_RESPONSE
message containing a \ element with PC3 Control Protocol
cause value #11 \"Invalid discovery target\".
If the ProSe Function fails to retrieve any valid discoveree UE contexts for
the valid target RPAUIDs contained in the Application Level Container
contained in the DISCOVERY_REQUEST message, the ProSe Function shall send a
DISCOVERY_RESPONSE message containing a \ element with PC3
Control Protocol cause value #11 \"Invalid discovery target\".
#### 6.2.3B.6 Abnormal cases
##### 6.2.3B.6.1 Abnormal cases in the UE
The following abnormal cases can be identified:
a) Indication from the transport layer of transmission failure of
DISCOVERY_REQUEST message (e.g. after TCP retransmission timeout)
The UE shall close the existing secure connection to the ProSe Function,
establish a new secure connection and then restart the discoverer request
procedure.
b) No response from the ProSe Function after the DISCOVERY_REQUEST message has
been successfully delivered (e.g., TCP ACK has been received for the
DISCOVERY_REQUEST message)
The UE shall retransmit the DISCOVERY_REQUEST message.
NOTE: The timer to trigger retransmission and the maximum number of allowed
retransmissions are UE implementation specific.
c) Indication from upper layers that the request to discover the target
RPAUID(s) is no longer in place after sending the DISCOVERY_REQUEST message,
but before the discoverer request procedure is completed
The UE shall acknowledge the DISCOVERY_RESPONSE message received from the
ProSe Function but discard its contents and then abort the procedure.
d) Change of PLMN
If a PLMN change occurs before the discoverer request procedure is completed,
the procedure shall be aborted. If the UE is authorized to perform restricted
ProSe direct discovery discoverer operation Model B in the new PLMN, the
procedure shall be restarted once the UE is registered on the new PLMN.
##### 6.2.3B.6.2 Abnormal cases in the ProSe Function
The following abnormal cases can be identified:
a) Indication from the lower layer of transmission failure of
DISCOVERY_RESPONSE message
After receiving an indication from lower layer that the DISCOVERY_RESPONSE
message has not been successfully acknowledged (e.g. TCP ACK is not received),
the ProSe Function shall abort the procedure, and stop any associated timer(s)
T4014, if running.
### 6.2.4 Match report procedure for open ProSe direct discovery
#### 6.2.4.1 General
The purpose of the Match report procedure for open ProSe direct discovery is
to allow a UE to send a ProSe Application Code that was matched during the
monitoring operation and receive the corresponding ProSe Application ID or the
updated metadata, if there is no such a mapping stored locally or the Metadata
Index in the ProSe Application Code indicates the metadata is updated.
The UE shall only initiate the match report procedure if it has been
authorised for open ProSe direct discovery monitoring in the monitored PLMN
based on the service authorisation procedure.
As a result of the match report procedure completing successfully, the UE
obtains a ProSe Application ID and potentially other information, which the UE
may store locally and pass to the upper layers.
#### 6.2.4.2 Match report procedure initiation
The UE shall meet the following pre-conditions before initiating this
procedure:
\- a request from upper layers to monitor for the ProSe Application ID, which
resulted in the matched ProSe Application Code, is still in place;
\- the lower layers have provided a \"Monitored PLMN ID\" value, and UTC time
information, along with the discovery message containing a ProSe Application
Code; and
\- the TTL timer T4002 associated with the Discovery Filter, which resulted in
a match event of the ProSe Application Code, has not expired.
If the UE is authorised to perform open ProSe direct discovery monitoring in
the monitored PLMN, it should initiate a match report procedure:
a) when there is a match event of one of the ProSe Application Codes received
from the lower layers, and the UE does not have a corresponding ProSe
Application ID already locally stored;
b) when the UE has a locally stored mapping for the ProSe Application Code
that resulted in a match event, but the validity timer T4004 of the ProSe
Application Code has expired;
c) when the UE has a locally stored mapping for the ProSe Application Code
that resulted in a match event, but the match report refresh timer T4006 of
the ProSe Application Code has expired; or
d) when there is a match event of one of the ProSe Application Codes received
from the lower layers, and the UE has a locally stored ProSe Application Code
excluding the Metadata Index portion located by the locally stored Metadata
Index Mask.
The UE initiates the match report procedure for open ProSe direct discovery by
sending a MATCH_REPORT message with a new transaction ID and shall set the
message contents as follows:
\- the UE shall set the ProSe Application Code to the ProSe Application Code
for which there was a match event;
\- the UE shall set the UE identity to the UE\'s IMSI;
\- the UE shall set the UTC-based counter as follows:
\- the UE shall generate two UTC-based counters with:
1) the first counter composed of:
\- the 27 most significant bits of the UTC-based counter set to the 27 most
significant bits of the UTC time provided by the lower layers for the
PC5_DISCOVERY message that contained the ProSe Application Code for which
there was a match event encoded as specified in subclause 12.2.2.18;
\- the 28^th^ most significant bit of the UTC-based counter set to \'0\'; and
\- the 4 least significant bits of the UTC-based counter shall be set to the 4
least significant bits of the UTC-based counter contained in the PC5_DISCOVERY
message that contained the ProSe Application Code for which there was a match
event, as specified in 3GPP TS 33.303 [6]; and
2) the second counter composed of:
\- the 27 most significant bits of the UTC-based counter set to the 27 most
significant bits of the UTC time provided by the lower layers for the
PC5_DISCOVERY message that contained the ProSe Application Code for which
there was a match event encoded as specified in subclause 12.2.2.18;
\- the 28^th^ most significant bit of the UTC-based counter set to \'1\'; and
\- the 4 least significant bits of the UTC-based counter set to the 4 least
significant bits of the UTC-based counter contained in the PC5_DISCOVERY
message that contained the ProSe Application Code for which there was a match
event, as specified in 3GPP TS 33.303 [6]; and
\- then the UE shall select, among the two counters described above, the
counter that is nearest to the UTC time provided by the lower layers for the
PC5_DISCOVERY message that contained the ProSe Application Code for which
there was a match event encoded as specified in subclause 12.2.2.18, and set
the UTC-based counter in the MATCH_REPORT message to that counter;
\- the UE shall set the MIC to the MIC of the PC5_DISCOVERY message that
contained the ProSe Application Code for which there was a match event;
\- the UE shall set the Message Type to the value of Message Type field of the
PC5_DISCOVERY message that contained the ProSe Application Code for which
there was a match event;
\- the UE shall set the Monitored PLMN ID to the PLMN ID of the PLMN where the
PC5_DISCOVERY message was received, as provided by the lower layers;
\- if the UE was roaming when the match event occurred, the UE shall set the
VPLMN ID to the PLMN ID of the PLMN in which the UE was registered when the
match event occurred;
\- the UE shall set the Metadata Flag to indicate whether or not it wishes to
receive metadata information associated with the ProSe Application ID in the
MATCH_REPORT_ACK message from the ProSe Function; and
\- optionally the PC5_tech set to the PC5 radio technology for which there was
a match event. PC5_tech may include more than one PC5 radio technology.
NOTE 1: A UE can include one or multiple transactions in one MATCH_REPORT
message for different ProSe Application Codes, and receive corresponding
\ element or \ element in the MATCH_REPORT_ACK
message for each respective transaction. In the following description of match
report procedure, only one transaction is included.
NOTE 2: The value of the Metadata Flag is determined through an indication
from upper layers in the original request to monitor for a ProSe Application
ID.
Figure 6.2.4.2.1 illustrates the interaction between the UE and the ProSe
Function in the match report procedure.
Figure 6.2.4.2.1: Match report procedure
#### 6.2.4.3 Match report procedure accepted by the ProSe Function
Upon receiving a MATCH_REPORT message, the ProSe Function shall check whether
there is an existing context for the UE identified by its IMSI. If there is no
associated UE context, the ProSe Function checks with the HSS whether the UE
is authorised for open ProSe direct discovery monitoring as described in 3GPP
TS 29.344 [3].
The ProSe Function shall also check the PLMN ID in the ProSe Application Code
received from the UE. If the PLMN ID in the ProSe Application Code is not the
same of that of the PLMN to which the ProSe Function belongs, the ProSe
Function shall execute the procedures defined in 3GPP TS 29.345 [5].
Otherwise, the ProSe Function shall check whether the received ProSe
Application Code is authorised to be transmitted on the monitored PLMN
indicated in the Monitored PLMN ID in the received message.
If the ProSe Application Code is PLMN-specific, the ProSe Function shall
verify if the PLMN ID in the ProSe Application Code is the same as the PLMN of
the ProSe Function. If so, the ProSe Function shall map the ProSe Application
Code to the corresponding ProSe Application ID from the PLMN-specific
database. If the ProSe Application Code is country-specific, as specified in
subclause 24.3 of 3GPP TS 23.003 [4], the ProSe Function shall check whether
the MCC of the PLMN ID part of the ProSe Application Code corresponds to the
country of the ProSe Function. If so, the ProSe Function shall map the ProSe
Application Code to the corresponding ProSe Application ID from the country-
specific database. If the ProSe Application Code is global as specified in
subclause 24.3 of 3GPP TS 23.003 [4], the ProSe Function shall map the ProSe
Application Code to the corresponding ProSe Application ID from the global
database. If the ProSe Application Code contains a ProSe Application Code
Prefix, the ProSe Function maps the ProSe Application Code Prefix to the
corresponding ProSe Application ID.
The ProSe Function shall analyse the ProSe Application Code received from the
UE and determine the validity of the ProSe Application Code.
NOTE: This might require the ProSe Function to execute procedures defined in
3GPP TS 29.345 [5].
The ProSe Function shall check if the MIC value and its corresponding UTC-
based counter are valid, as defined in 3GPP TS 33.303 [6].
If the VPLMN ID is included in the MATCH_REPORT message, the ProSe Function
uses it for charging purposes as specified in 3GPP TS 32.277 [27].
If the outcome of above processing is successful, the ProSe Function shall
send a MATCH_REPORT_ACK message containing a \ element with:
\- the transaction ID set to the value of the transaction ID received in the
MATCH_REPORT message from the UE;
\- the ProSe Application ID set to the ProSe Application ID provided by the
ProSe Function and corresponding to the ProSe Application Code contained in
the MATCH_REPORT message;
\- the Validity Timer T4004 set to indicate for how long this ProSe
Application Code is valid; and
\- the Match Report Refresh Timer T4006 set to indicate for how long the UE
will wait before sending a new Match Report for this ProSe Application Code.
If the UE has set the Metadata Flag to indicate that it wishes to receive
metadata information associated with the ProSe Application ID, the ProSe
Function shall set the Metadata to the metadata information associated with
the ProSe Application Code received in the MATCH_REPORT message and set the
Metadata Index Mask to the Metadata Index Mask allocated by the ProSe Function
for the ProSe Application Code received in the MATCH_REPORT message.
#### 6.2.4.4 Match report procedure completion by the UE
Upon receipt of the MATCH_REPORT_ACK message, if the transaction ID contained
in the \ element matches the value sent by the UE in a MATCH_REPORT
message, the UE shall store the mapping between the ProSe Application Code and
ProSe Application ID locally, start timers T4004 and T4006, and may inform the
upper layers of this match of the ProSe Application ID. If the Metadata Index
Mask is contained in the MATCH_REPORT_ACK message, the UE shall also store the
Metadata Index Mask with the ProSe Application Code and the ProSe Application
ID locally. If there is a locally stored mapping between the ProSe Application
ID and a ProSe Application Code, the UE shall delete the old mapping.
Otherwise the UE shall discard the MATCH_REPORT_ACK message.
Upon receipt of the MATCH_REPORT_ACK message, if the transaction ID contained
in the \ element matches the value sent by the UE in a
MATCH_REPORT message and if the received PC3 Control Protocol cause value is
#5 \"Invalid MIC\", as specified in subclause 6.2.4.5, the UE shall stop timer
T4004 if it is running.
NOTE 1: It is an implementation specific choice whether the UE informs the
upper layers every time a ProSe Application ID triggers a match event, or only
the first time this match occurs.
NOTE 2: The UE can also inform the upper layers if a ProSe Application ID is
no longer matched, because the validity timer T4004 of the corresponding ProSe
Application Code expires.
NOTE 3: The UE can also inform the upper layers if a ProSe Application ID is
no longer matched, because the validity timer T4004 of the corresponding ProSe
Application Code is stopped upon receiving MATCH_REPORT_ACK message with a
\ element with PC3 Control Protocol cause value #5 \"Invalid
MIC\".
#### 6.2.4.5 Match report procedure not accepted by the ProSe Function
If the MATCH_REPORT message is not accepted by the ProSe Function, the ProSe
Function sends a MATCH_REPORT_ACK message with a \ element to
the UE including an appropriate PC3 Control Protocol cause value.
If the ProSe Application Code contained in the MATCH_REPORT message is unknown
by the ProSe Function, the ProSe Function shall send the MATCH_REPORT_ACK
message with a \ element with PC3 Control Protocol cause value
#4 \"Unknown ProSe Application Code\".
If the check of the MIC contained in the MATCH_REPORT message fails, the ProSe
Function shall send the MATCH_REPORT_ACK message with a \
element with PC3 Control Protocol cause value #5 \"Invalid MIC\".
If the check of the UTC-based counter contained in the MATCH_REPORT message
fails, the ProSe Function shall send the MATCH_REPORT_ACK message with a
\ element with PC3 Control Protocol cause value #6 \"Invalid
UTC-based counter\".
If the UE is not authorised for open ProSe direct discovery monitoring in the
monitored PLMN contained in the MATCH_REPORT message, the ProSe Function shall
send the MATCH_REPORT_ACK message with a \ element with PC3
Control Protocol cause value #3 \"UE authorisation failure\".
#### 6.2.4.6 Abnormal cases
##### 6.2.4.6.1 Abnormal cases in the UE
The following abnormal cases can be identified:
a) Indication from the transport layer of transmission failure of MATCH_REPORT
message (e.g. after TCP retransmission timeout)
The UE shall close the existing secure connection to the ProSe Function,
establish a new secure connection and then restart the match report procedure.
b) No response from the ProSe Function after the MATCH_REPORT message has been
successfully delivered (e.g. TCP ACK has been received for the MATCH_REPORT
message)
If the TTL timer T4002 associated with the Discovery Filter which resulted in
a match event has not expired, the UE shall retransmit the MATCH_REPORT
message.
NOTE: The timer to trigger retransmission and the maximum number of allowed
retransmissions are UE implementation specific.
c) Change of PLMN
If a PLMN change occurs before the match report procedure is completed, the
procedure shall be aborted.
### 6.2.4A Match report procedure for restricted ProSe direct discovery model
A
#### 6.2.4A.1 General
The purpose of the match report procedure is to allow a UE to send a ProSe
Restricted Code that was matched during the monitoring operation and receive
the corresponding RPAUID, if there is no such a mapping stored locally.
The UE shall only initiate the match report procedure if it has been
authorised for restricted ProSe direct discovery monitoring model A in the
monitored PLMN based on the service authorisation procedure.
As a result of the match report procedure completing successfully, the UE
obtains a RPAUID and potentially other information, which the UE may store
locally and pass to the upper layers.
#### 6.2.4A.2 Match report procedure initiation
The UE shall meet the following pre-conditions before initiating this
procedure:
\- a request from upper layers to monitor for the target RPAUID, which
resulted in the matched ProSe Restricted Code, is still in place;
\- the lower layers have provided UTC time information, along with the
discovery message containing the ProSe Restricted Code; and
\- the TTL timer T4009 associated with the Restricted Discovery Filter, whose
use resulted in a match event of the ProSe Restricted Code, has not expired.
If the UE is authorised to perform restricted ProSe direct discovery
monitoring model A in the monitored PLMN, it should initiate a match report
procedure:
a) when there is a match event after applying one of the Restricted Discovery
Filter(s) to a ProSe Restricted Code received from the lower layers, and the
UE does not have a corresponding RPAUID already locally stored;
b) when the UE has a locally stored mapping for the ProSe Restricted Code that
resulted in a match event, but the validity timer T4016 of the ProSe
Restricted Code has expired;
c) when the UE has a locally stored mapping for the ProSe Restricted Code that
resulted in a match event, but the match report refresh timer T4017 of the
ProSe Restricted Code has expired;
d) when the UE desires to obtain the metadata associated with the discovered
ProSe Restricted Code; or
e) when the UE has a locally stored mapping for the ProSe Restricted Code that
resulted in a match event, but the UE does not have a running match report
refresh timer T4017 for this ProSe Restricted Code and the UE is directed by
the ProSe Function to perform the required MIC check via the match report
procedure.
NOTE 1: The ProSe Function directs the UE to use the match report procedure to
perform the MIC check by including the MIC Check Indicator parameter in the
DISCOVERY_RESPONSE message.
The UE initiates the match report procedure by sending a MATCH_REPORT message
with a new transaction ID and shall set the message contents as follows:
\- the RPAUID set to the UE\'s RPAUID which has requested the corresponding
monitoring operation that resulted this match event;
\- the ProSe Restricted Code set to the ProSe Restricted Code for which there
was a match event;
\- the UE identity set to the UE\'s IMSI;
\- the Discovery Type set to \"Restricted discovery\";
\- the Application Identity set to the Application Identity of the upper layer
application that triggered the monitoring operation;
\- optionally, the UTC-based counter set as follows if the MIC is checked via
the match report procedure:
\- the UE shall generate two UTC-based counters with:
1) the first counter composed of:
\- the 23 most significant bits of the UTC-based counter set to the 23 most
significant bits of the UTC time provided by the lower layers for the
PC5_DISCOVERY message that contained the ProSe Restricted Code for which there
was a match event encoded as specified in subclause 12.2.2.18;
\- the 24^th^ most significant bit of the UTC-based counter set to \'0\'; and
\- the 8 least significant bits of the UTC-based counter set to the 8 least
significant bits of the UTC-based counter contained in the PC5_DISCOVERY
message that contained the ProSe Restricted Code for which there was a match
event, as specified in 3GPP TS 33.303 [6]; and
2) the second counter composed of:
\- the 23 most significant bits of the UTC-based counter set to the 23 most
significant bits of the UTC time provided by the lower layers for the
PC5_DISCOVERY message that contained the ProSe Restricted Code for which there
was a match event encoded as specified in subclause 12.2.2.18;
\- the 24^th^ most significant bit of the UTC-based counter set to \'1\'; and
\- the 8 least significant bits of the UTC-based counter set to the 8 least
significant bits of the UTC-based counter contained in the PC5_DISCOVERY
message that contained the ProSe Restricted Code for which there was a match
event, as specified in 3GPP TS 33.303 [6]; and
\- then the UE shall select, among the two counters described above, the
counter that is nearest to the UTC time provided by the lower layers for the
PC5_DISCOVERY message that contained the ProSe Restricted Code for which there
was a match event encoded as specified in subclause 12.2.2.18, and set the
UTC-based counter in the MATCH_REPORT message to that counter;
\- optionally, the Message Type set to the value of Message Type field of the
PC5_DISCOVERY message that contained the ProSe Restricted Code for which there
was a match event, if the MIC is checked via the match report procedure;
\- optionally, the MIC set to the MIC of the PC5_DISCOVERY message that
contained the ProSe Restricted Code for which there was a match event if the
MIC is checked via the match report procedure;
\- the Metadata Flag set to indicate whether or not the UE wishes to receive
the latest metadata information associated with the RPAUID in the
MATCH_REPORT_ACK message from the ProSe Function; and
\- optionally the PC5_tech set to the PC5 radio technology for which there was
a match event. PC5_tech may include more than one PC5 radio technology.
NOTE 2: A UE can include one or multiple transactions in one MATCH_REPORT
message for different ProSe Restricted Codes, and receive a corresponding
\ element or \ element in the
MATCH_REPORT_ACK message for each respective transaction. In the following
description of match report procedure, only one transaction is included.
Figure 6.2.4A.2.1 illustrates the interaction between the UE and the ProSe
Function in the match report procedure.
Figure 6.2.4A.2.1: Match report procedure for restricted discovery model A
#### 6.2.4A.3 Match report procedure accepted by the ProSe Function
Upon receiving a MATCH_REPORT message, the ProSe Function shall check whether
there is an existing context for the UE identified by its IMSI.
The ProSe Function shall analyse the ProSe Restricted Code received from the
UE in the MATCH_REPORT message. If the MIC value and its corresponding UTC-
based counter are included, the ProSe Function shall check whether the MIC
value and the UTC-based counter are valid and within the acceptable range
respectively as defined in 3GPP TS 33.303 [6]. The ProSe Function shall then
check in the UE context if the ProSe Restricted Code matches any Restricted
Discovery Filter(s) allocated for the particular application identified by the
Application Identity received in the MATCH_REPORT message. If such a discovery
filter exists, the target RPAUID associated with the filter(s) shall be
identified as the corresponding RPAUID for this code. Optionally, the ProSe
Function may further invoke the procedure defined in 3GPP TS 29.343 [31] to
verify if the target RPAUID is allowed to be discovered by the RPAUID of the
requesting UE that has sent the MATCH_REPORT message, or to retrieve metadata
associated for the target RPAUID if Metadata Flag is set to \"True\" in the
MATCH_REPORT message and the ProSe Function does not have the latest metadata.
If the outcome of the above processing is successful, the ProSe Function shall
send a MATCH_REPORT_ACK message containing a \ element
with the transaction ID set to the value of the transaction ID received in the
MATCH_REPORT message from the UE, the RPAUID set to the target RPAUID
retrieved from the UE context at the ProSe Function which corresponds to the
ProSe Restricted Code contained in the MATCH_REPORT message, and the Validity
Timer T4016 set to indicate for how long this ProSe Restricted Code is valid.
The ProSe Function shall set the Match Report Refresh Timer T4017 to indicate
for how long the UE will wait before sending a new Match Report for this ProSe
Restricted Code if the MIC value and the UTC-based counter are included in the
MATCH_REPORT message. If there exists metadata information associated with
this target RPAUID and the Metadata Flag is set to \"True\" in the
MATCH_REPORT message, the ProSe Function shall set the Metadata to the
associated metadata information.
If the corresponding PDUID of the target RPAUID does not belong to the HPLMN
of the requesting UE, the ProSe Function may optionally invoke the procedure
defined in 3GPP TS 29.345 [5] to inform the ProSe Function of the announcing
UE about the match event.
#### 6.2.4A.4 Match report procedure completion by the UE
Upon receipt of the MATCH_REPORT_ACK message, if the transaction ID contained
in the \ element matches the value sent by the UE in a
MATCH_REPORT message, the UE shall store the mapping between the ProSe
Restricted Code and RPAUID locally, start timers T4016 and T4017, and may
inform the upper layers of this match of the RPAUID. Otherwise the UE shall
discard the MATCH_REPORT_ACK message.
Upon receipt of the MATCH_REPORT_ACK message, if the transaction ID contained
in the \ element matches the value sent by the UE in a
MATCH_REPORT message and if the received PC3 Control Protocol cause value is
#5 \"Invalid MIC\", as specified in subclause 6.2.4A.5, the UE shall stop
timer T4016 if it is running.
NOTE 1: It is an implementation specific choice whether the UE informs the
upper layers every time an RPAUID triggers a match event, or only the first
time this match occurs.
NOTE 2: The UE can also inform the upper layers if an RPAUID is no longer
matched, because the validity timer T4016 of the corresponding ProSe
Restricted Code expires.
NOTE 3: The UE can also inform the upper layers if a ProSe Restricted Code is
no longer matched, because the validity timer T4016 of the corresponding ProSe
Restricted Code is stopped upon receiving MATCH_REPORT_ACK message with a
\ element with PC3 Control Protocol cause value #5 \"Invalid
MIC\".
#### 6.2.4A.5 Match report procedure not accepted by the ProSe Function
If the MATCH_REPORT message is not accepted by the ProSe Function, the ProSe
Function sends a MATCH_REPORT_ACK message with a \ element to
the UE including an appropriate PC3 Control Protocol cause value.
If there is no associated UE context for the IMSI contained in the
MATCH_REPORT message, the ProSe Function shall send the MATCH_REPORT_ACK
message with a \ element with PC3 Control Protocol cause value
#16 \"Invalid Match Event\".
If the ProSe Restricted Code contained in the MATCH_REPORT message does not
match any Restricted Discovery Filter(s) allocated for the requesting UE for
the corresponding application,, the ProSe Function shall send the
MATCH_REPORT_ACK message with a \ element with PC3 Control
Protocol cause value #16 \"Invalid Match Event\".
If the check of the MIC contained in the MATCH_REPORT message fails, the ProSe
Function shall send the MATCH_REPORT_ACK message with a \
element with PC3 Control Protocol cause value #5 \"Invalid MIC\".
If the check of the UTC-based counter contained in the MATCH_REPORT message
fails, the ProSe Function shall send the MATCH_REPORT_ACK message with a
\ element with PC3 Control Protocol cause value #6 \" Invalid
UTC-based counter\".
If the UE is not authorised for restricted ProSe direct discovery monitoring,
the ProSe Function shall send the MATCH_REPORT_ACK message with a \ element with PC3 Control Protocol cause value #3 \"UE authorisation
failure\".
#### 6.2.4A.6 Abnormal cases
##### 6.2.4A.6.1 Abnormal cases in the UE
The following abnormal cases can be identified:
a) Indication from the transport layer of transmission failure of MATCH_REPORT
message (e.g. after TCP retransmission timeout)
The UE shall close the existing secure connection to the ProSe Function,
establish a new secure connection and then restart the match report procedure.
b) No response from the ProSe Function after the MATCH_REPORT message has been
successfully delivered (e.g. TCP ACK has been received for the MATCH_REPORT
message)
If the TTL timer T4009 associated with the Restricted Discovery Filter which
resulted in a match event has not expired, the UE shall retransmit the
MATCH_REPORT message.
NOTE: The timer to trigger retransmission and the maximum number of allowed
retransmissions are UE implementation specific.
### 6.2.4B Match report procedure for restricted ProSe direct discovery model
B
#### 6.2.4B.1 General
The purpose of the Match report procedure is to allow a UE to send a ProSe
Response Code that was matched during the restricted ProSe direct discovery
Model B discoverer operation and receive the corresponding RPAUID, if there is
no such a mapping stored locally.
The UE shall only initiate the match report procedure if it has been
authorised for restricted ProSe direct discovery model B discoverer operation
in the monitored PLMN based on the service authorisation procedure.
As a result of the match report procedure completing successfully, the UE
obtains a RPAUID and potentially other information, which the UE may store
locally and pass to the upper layers.
#### 6.2.4B.2 Match report procedure initiation
The UE shall meet the following pre-conditions before initiating this
procedure:
\- a request from upper layers to discover the target RPAUID with restricted
discovery model B, which resulted in the matched ProSe Response Code, is still
in place;
\- the lower layers have provided UTC time information, along with the
discovery message containing the ProSe Response Code; and
\- the TTL timer T4013 associated with the Discovery Response Filter, whose
use resulted in a match event of the ProSe Response Code, has not expired.
If the UE is authorised to perform restricted ProSe direct discovery model B
discoverer operation in the monitored PLMN, it should initiate a match report
procedure:
a) when there is a match event when applying one of the Discovery Response
Filter(s) to one of the ProSe Response Codes received from the lower layers,
and the UE does not have a corresponding RPAUID already locally stored;
b) when the UE has a locally stored mapping for the ProSe Response Code that
resulted in a match event, but the validity timer T4016 of the ProSe Response
Code has expired;
c) when the UE has a locally stored mapping for the ProSe Response Code that
resulted in a match event, but the match report refresh timer T4017 of the
ProSe Response Code has expired;
d) when the UE desires to obtain the metadata associated with the discovered
ProSe Response Code; or
e) when the UE has a locally stored mapping for the ProSe Response Code that
resulted in a match event, but the UE does not have a running match report
refresh timer T4017 for this ProSe Response Code and the UE is directed by the
ProSe Function to perform the required MIC check via the match report
procedure.
NOTE 1: The ProSe Function directs the UE to use the match report procedure to
perform the MIC check by including the MIC Check Indicator parameter in the
DISCOVERY_RESPONSE message.
The UE initiates the match report procedure by sending a MATCH_REPORT message
with a new transaction ID and shall set the message contents as follows:
\- the RPAUID set to the UE\'s RPAUID which has requested the corresponding
restricted discovery model B discoverer operation that resulted this match
event;
\- the ProSe Response Code set to the ProSe Response Code for which there was
a match event;
\- the UE identity set to the UE\'s IMSI;
\- the Discovery Type set to \"Restricted discovery\";
\- the Application Identity set to the Application Identity of the upper layer
application that triggered the restricted direct discovery Model B discoverer
operation;
\- optionally, the UTC-based counter set as follows if the MIC is checked via
the match report procedure:
\- the UE shall generate two UTC-based counters with:
1) the first counter composed of:
\- the 27 most significant bits of the UTC-based counter set to the 27 most
significant bits of the UTC time provided by the lower layers for the
PC5_DISCOVERY message that contained the ProSe Response Code for which there
was a match event encoded as specified in subclause 12.2.2.18;
\- the 24^th^ most significant bit of the UTC-based counter set to \'0\'; and
\- the 8 least significant bits of the UTC-based counter shall be set to the 8
least significant bits of the UTC-based counter contained in the PC5_DISCOVERY
message that contained the ProSe Response Code for which there was a match
event, as specified in 3GPP TS 33.303 [6]; and
2) the second counter composed of:
\- the 23 most significant bits of the UTC-based counter set to the 23 most
significant bits of the UTC time provided by the lower layers for the
PC5_DISCOVERY message that contained the ProSe Response Code for which there
was a match event encoded as specified in subclause 12.2.2.18;
\- the 24^th^ most significant bit of the UTC-based counter set to \'1\'; and
\- the 8 least significant bits of the UTC-based counter set to the 8 least
significant bits of the UTC-based counter contained in the PC5_DISCOVERY
message that contained the ProSe Response Code for which there was a match
event, as specified in 3GPP TS 33.303 [6]; and
\- then the UE shall select, among the two counters described above, the
counter that is nearest to the UTC time provided by the lower layers for the
PC5_DISCOVERY message that contained the ProSe Response Code for which there
was a match event encoded as specified in subclause 12.2.2.18, and set the
UTC-based counter in the MATCH_REPORT message to that counter;
\- optionally, the Message Type set to the value of Message Type field of the
PC5_DISCOVERY message that contained the ProSe Response Code for which there
was a match event, if the MIC is checked via the match report procedure;
\- optionally, the MIC to the MIC of the PC5_DISCOVERY message that contained
the ProSe Response Code for which there was a match event if the MIC is
checked via the match report procedure;
\- the Metadata Flag set to indicate whether or not the UE wishes to receive
the latest metadata information associated with the RPAUID in the
MATCH_REPORT_ACK message from the ProSe Function; and
\- optionally the PC5_tech set to the PC5 radio technology for which there was
a match event. PC5_tech may include more than one PC5 radio technology.
NOTE 2: A UE can include one or multiple transactions in one MATCH_REPORT
message for different ProSe Response Codes, and receive corresponding
\ element or \ element in the
MATCH_REPORT_ACK message for each respective transaction. In the following
description of match report procedure, only one transaction is included.
Figure 6.2.4B.2.1 illustrates the interaction between the UE and the ProSe
Function in the match report procedure.
Figure 6.2.4A.2.1: Match report procedure for restricted discovery model B
#### 6.2.4B.3 Match report procedure accepted by the ProSe Function
Upon receiving a MATCH_REPORT message, the ProSe Function shall check whether
there is an existing discoverer UE context for the UE identified by its IMSI.
The ProSe Function shall analyse the ProSe Response Code received from the UE
in the MATCH_REPORT message. If the MIC value and its corresponding UTC-based
counter are included, the ProSe Function shall check whether the MIC value and
the UTC-based counter are valid and within the acceptable range respectively,
as defined in 3GPP TS 33.303 [6]. The ProSe Function shall then check in the
UE context if the ProSe Response Code matches any Discovery Response Filter(s)
allocated for the particular application identified by the Application
Identity received in the MATCH_REPORT message. If such a discovery filter
exists, the target RPAUID associated with the filter(s) shall be identified as
the corresponding RPAUID for this code. Optionally, the ProSe Function may
further invoke the procedure defined in 3GPP TS 29.343 [31] to verify if the
target RPAUID is allowed to be discovered by the RPAUID of the requesting UE
that has sent the MATCH_REPORT message, or to retrieve metadata associated for
the target RPAUID if Metadata Flag is set to \"True\" in the MATCH_REPORT
message and the ProSe Function does not have the latest metadata.
If the outcome of the above processing is successful, the ProSe Function shall
send a MATCH_REPORT_ACK message containing a \ element
with the transaction ID set to the value of the transaction ID received in the
MATCH_REPORT message from the UE, the RPAUID set to the target RPAUID
retrieved from the UE context at the ProSe Function which corresponds to the
ProSe Response Code contained in the MATCH_REPORT message, the Validity Timer
T4016 set to indicate for how long this ProSe Response Code is valid. The
ProSe Function shall set the Match Report Refresh Timer T4017 to indicate for
how long the UE will wait before sending a new Match Report for this ProSe
Response Code if the MIC value and the UTC-based counter are included in the
MATCH_REPORT message. If there exists metadata information associated with
this target RPAUID, the ProSe Function shall set the Metadata to the
associated metadata information.
If the corresponding PDUID of the target RPAUID does not belong to the HPLMN
of the requesting UE, the ProSe Function may optionally invoke the procedure
defined in 3GPP TS 29.345 [5] to inform the ProSe Function of the discoveree
UE about the match event.
#### 6.2.4B.4 Match report procedure completion by the UE
Upon receipt of the MATCH_REPORT_ACK message, if the transaction ID contained
in the \ element matches the value sent by the UE in a
MATCH_REPORT message, the UE shall store the mapping between the ProSe
Response Code and the RPAUID locally, start timers T4016 and T4017, and may
inform the upper layers of this match of the RPAUID. Otherwise the UE shall
discard the MATCH_REPORT_ACK message.
Upon receipt of the MATCH_REPORT_ACK message, if the transaction ID contained
in the \ element matches the value sent by the UE in a
MATCH_REPORT message and if the received PC3 Control Protocol cause value is
#5 \"Invalid MIC\", as specified in subclause 6.2.4A.5, the UE shall stop
timer T4016 if it is running.
NOTE 1: It is an implementation specific choice whether the UE informs the
upper layers every time a RPAUID triggers a match event, or only the first
time this match occurs.
NOTE 2: The UE can also inform the upper layers if an RPAUID is no longer
matched, because the validity timer T4016 of the corresponding ProSe Response
Code expires.
NOTE 3: The UE can also inform the upper layers if a ProSe Response Code is no
longer matched, because the validity timer T4016 of the corresponding ProSe
Response Code is stopped upon receiving MATCH_REPORT_ACK message with a
\ element with PC3 Control Protocol cause value #5 \"Invalid
MIC\".
#### 6.2.4B.5 Match report procedure not accepted by the ProSe Function
If the MATCH_REPORT message is not accepted by the ProSe Function, the ProSe
Function sends a MATCH_REPORT_ACK message with a \ element to
the UE including an appropriate PC3 Control Protocol cause value.
If there is no associated UE context for the IMSI contained in the
MATCH_REPORT, the ProSe Function shall send the MATCH_REPORT_ACK message with
a \ element with PC3 Control Protocol cause value #16 \"Invalid
Match Event\".
If the ProSe Response Code contained in the MATCH_REPORT message does not
match any Discovery Response Filter(s) allocated for the requesting UE for the
corresponding application,, the ProSe Function shall send the MATCH_REPORT_ACK
message with a \ element with PC3 Control Protocol cause value
#16 \"Invalid Match Event\".
If the check of the MIC contained in the MATCH_REPORT message fails, the ProSe
Function shall send the MATCH_REPORT_ACK message with a \
element with PC3 Control Protocol cause value #5 \"Invalid MIC\".
If the check of the UTC-based counter contained in the MATCH_REPORT message
fails, the ProSe Function shall send the MATCH_REPORT_ACK message with a
\ element with PC3 Control Protocol cause value #6 \" Invalid
UTC-based counter\".
If the UE is not authorised for restricted ProSe direct discovery model B
discoverer operation, the ProSe Function shall send the MATCH_REPORT_ACK
message with a \ element with PC3 Control Protocol cause value
#3 \"UE authorisation failure\".
#### 6.2.4B.6 Abnormal cases
##### 6.2.4B.6.1 Abnormal cases in the UE
The following abnormal cases can be identified:
a) Indication from the transport layer of transmission failure of MATCH_REPORT
message (e.g. after TCP retransmission timeout)
The UE shall close the existing secure connection to the ProSe Function,
establish a new secure connection and then restart the match report procedure.
b) No response from the ProSe Function after the MATCH_REPORT message has been
successfully delivered (e.g. TCP ACK has been received for the MATCH_REPORT
message)
If the TTL timer T4013 associated with the Discovery Response Filter which
resulted in a match event has not expired, the UE shall retransmit the
MATCH_REPORT message.
NOTE: The timer to trigger retransmission and the maximum number of allowed
retransmissions are UE implementation specific.
### 6.2.5 Direct discovery time synchronisation by the Prose Function
To ensure time synchronisation as specified in 3GPP TS 33.303 [6], the ProSe
Function shall include timing-related information in parameters Current Time
and Max Offset as defined in subclause 12.2.2.23 and subclause 12.2.2.24 in
the DISCOVERY_RESPONSE message. It shall also include Current Time in
MATCH_REPORT_ACK message.
After receiving the Current Time parameter in a DISCOVERY_RESPONSE or
MATCH_REPORT_ACK message, the UE shall set the clock used for ProSe to the
value of Current Time. After receiving the Max Offset parameter in a
DISCOVERY_RESPONSE message, the UE shall store the Max Offset parameter and
overwrite any previous value.
### 6.2.6 Discovery Update
#### 6.2.6.1 General
The discovery update procedure is used to update the discovery filters and/or
allocate a new ProSe Restricted Code as defined in 3GPP TS 23.303 [2].
#### 6.2.6.2 Revocation of Restricted Discovery Filters
##### 6.2.6.2.1 Restricted Discovery filters revocation procedure initiation
The ProSe Function in the HPLMN initiates the restricted discovery filters
revocation procedure by sending the DISCOVERY_UPDATE_REQUEST to the UE with:
\- a new ProSe Function transaction ID not used in any other direct discovery
procedures in PC3 interface;
\- the UE identity set to the UE\'s IMSI;
\- the Discovery Entry ID set to the Discovery Entry ID of the corresponding
Discovery Entry that contains the Restricted Discovery Filter to be revoked;
and
\- Optionally Update Info containing the restricted discovery filters that
replace the existing ones, if the ProSe Function decides to remove only
certain filter(s) and not others.
NOTE: The ProSe Function can include one or multiple transactions in one
DISCOVERY_UPDATE_REQUEST message for different Restricted Discovery Filters,
and receive corresponding \ element or \
element in a DISCOVERY_UPDATE_RESPONSE message for each respective
transaction. In the following description of the network initiated direct
discovery update request procedure, only one transaction is included.
Figure 6.2.6.2.1.1 illustrates the interaction of the UE and the ProSe
Function in the restricted discovery filters revocation procedure.
Figure 6.2.6.2.1.1: Restricted Discovery filters revocation procedure
##### 6.2.6.2.2 Restricted Discovery filters revocation procedure accepted by
the UE
Upon receiving a DISCOVERY_UPDATE_REQUEST message, the UE shall check if the
UE identity contained in the DISCOVERY_UPDATE_REQUEST message is the IMSI of
the UE. If the UE identity is the IMSI of the UE, the UE shall check if the
Discovery Entry ID contained in the DISCOVERY_UPDATE_REQUEST message is valid.
If the Discovery Entry ID is valid, the UE shall proceed with the following
direct discovery update procedure.
The UE shall remove all the Restricted Discovery Filters corresponding to the
Discovery Entry ID if the Update Info is not included in the
DISCOVERY_UPDATE_REQUEST message or shall remove the old Restricted Discovery
Filters and store the Restricted Discovery Filter included in the Update Info
in the DISCOVERY_UPDATE_REQUEST message. Then the UE shall send a
DISCOVERY_UPDATE_RESPONSE message to the ProSe Function with:
\- the ProSe Function transaction ID set to the value of the ProSe Function
transaction ID received in the DISCOVERY_UPDATE_REQUEST message; and
\- Discovery Entry ID set to the value of the Discovery Entry ID received in
the DISCOVERY_UPDATE_REQUEST message.
##### 6.2.6.2.3 Restricted Discovery filters revocation procedure completion
by the ProSe Function
Upon receipt of the DISCOVERY_UPDATE_ RESPONSE message by the ProSe Function,
if the ProSe Function transaction ID contained in the \
element does not match the value sent by the ProSe Function in a
DISCOVERY_UPDATE_REQUEST message, the ProSe Function shall discard the
DISCOVERY_UPDATE_RESPONSE message. Upon receipt of the DISCOVERY_UPDATE_
RESPONSE message by the ProSe Function, if the ProSe Function transaction ID
contained in the \ element matches the value sent by the
ProSe Function in a DISCOVERY_UPDATE_REQUEST message, the restricted discovery
filters revocation procedure is complete.
##### 6.2.6.2.4 Restricted Discovery filters revocation procedure not accepted
by the UE
If the DISCOVERY_UPDATE_REQUEST message cannot be accepted by the UE, the UE
sends a DISCOVERY_UPDATE_RESPONSE message containing a \
element to the ProSe Function including an appropriate PC3 Control Protocol
cause value.
If the UE identity contained in the DISCOVERY_UPDATE_REQUEST message is not
the IMSI of the UE, the UE shall send a DISCOVERY_UPDATE_RESPONSE message
containing a \ element with PC3 Control Protocol cause value
#18 \"Invalid UE Identity\".
If the Discovery Entry ID contained in the DISCOVERY_UPDATE_REQUEST message is
not found in the UE context, the UE shall send a DISCOVERY_UPDATE_RESPONSE
message containing a \ element with PC3 Control Protocol
cause value #10 \"Unknown or Invalid Discovery Entry ID\".
##### 6.2.6.2.5 Abnormal cases
###### 6.2.6.2.5.1 Abnormal cases in the ProSe Function
The following abnormal cases can be identified:
a) Indication from the transport layer of transmission failure of
DISCOVERY_UPDATE_REQUEST message (e.g. after TCP retransmission timeout)
The ProSe Function shall close the existing secure connection to the UE.
b) No response from the UE after the DISCOVERY_UPDATE_REQUEST message has been
successfully delivered (e.g., TCP ACK has been received for the
DISCOVERY_UPDATE_REQUEST message)
The ProSe Function shall retransmit the DISCOVERY_UPDATE_REQUEST message.
NOTE: The timer to trigger retransmission and the maximum number of allowed
retransmissions are ProSe Function implementation specific.
###### 6.2.6.2.5.2 Abnormal cases in the UE
The following abnormal cases can be identified:
a) Indication from the lower layer of transmission failure of
DISCOVERY_UPDATE_RESPONSE message.
After receiving an indication from lower layer that the
DISCOVERY_UPDATE_RESPONSE message has not been successfully acknowledged (e.g.
TCP ACK is not received), the UE shall abort the procedure.
#### 6.2.6.3 Allocation of new ProSe Restricted Code
##### 6.2.6.3.1 New ProSe Restricted Code allocation procedure initiation
The ProSe Function in the HPLMN initiates the ProSe restricted code allocation
procedure by sending the DISCOVERY_UPDATE_REQUEST to the UE with:
\- a new ProSe Function transaction ID not used in any other direct discovery
procedures in PC3 interface;
\- the UE identity set to the UE\'s IMSI;
\- the Discovery Entry ID set to the Discovery Entry ID of the corresponding
Discovery Entry that contains the ProSe Restricted Code to be replaced;
\- Update Info containing the ProSe Restricted Code set to the ProSe
Restricted Code to be replaced and a Validity Timer T4007 set to the T4007
timer value assigned by the ProSe Function to the ProSe Restricted Code.
Figure 6.2.6.3.1.1 illustrates the interaction of the UE and the ProSe
Function in the ProSe restricted code allocation procedure.
NOTE: The ProSe function can include one or multiple transactions in one
DISCOVERY_UPDATE_REQUEST message for different ProSe Restricted Codes, and
receive corresponding \ element or \ element
in a DISCOVERY_UPDATE_RESPONSE message for each respective transaction. In the
following description of the network initiated direct discovery update request
procedure, only one transaction is included.
Figure 6.2.6.3.1.1: New ProSe Restricted Code allocation procedure
##### 6.2.6.3.2 ProSe Restricted Code allocation procedure accepted by the UE
Upon receiving a DISCOVERY_UPDATE_REQUEST message, the UE shall check if the
UE identity contained in the DISCOVERY_UPDATE_REQUEST message is the IMSI of
the UE. If the UE identity is the IMSI of the UE, the UE shall check if the
Discovery Entry ID contained in the DISCOVERY_UPDATE_REQUEST message is valid.
If the Discovery Entry ID is valid, the UE shall proceed with the following
direct discovery update procedure.
The UE shall replace the ProSe Restricted Code corresponding to the Discovery
Entry ID included in the DISCOVERY_UPDATE_REQUEST message. The UE shall stop
the validity timer T4007 if running and start the validity timer T4007 with
the received value. Then the UE shall send a DISCOVERY_UPDATE_RESPONSE message
to the ProSe Function with:
\- the ProSe Function transaction ID set to the value of the ProSe Function
transaction ID received in the DISCOVERY_UPDATE_REQUEST message; and
\- Discovery Entry ID set to the value of the Discovery Entry ID received in
the DISCOVERY_UPDATE_REQUEST message.
##### 6.2.6.3.3 ProSe Restricted Code allocation procedure completion by the
ProSe Function
Upon receipt of the DISCOVERY_UPDATE_ RESPONSE message by the ProSe Function,
if the ProSe Function transaction ID contained in the \
element does not match the value sent by the ProSe Function in a
DISCOVERY_UPDATE_REQUEST message, the ProSe function shall discard the
DISCOVERY_UPDATE_RESPONSE message. Upon receipt of the DISCOVERY_UPDATE_
RESPONSE message by the ProSe Function, if the Prose Function transaction ID
contained in the \ element matches the value sent by the
ProSe Function in a DISCOVERY_UPDATE_REQUEST message, the ProSe Restricted
Code allocation procedure is complete.
##### 6.2.6.3.4 ProSe Restricted Code allocation procedure not accepted by the
UE
If the DISCOVERY_UPDATE_REQUEST message cannot be accepted by the UE, the UE
sends a DISCOVERY_UPDATE_RESPONSE message containing a \
element to the ProSe Function including an appropriate PC3 Control Protocol
cause value.
If the UE identity contained in the DISCOVERY_UPDATE_REQUEST message is not
the IMSI of the UE, the UE shall send a DISCOVERY_UPDATE_RESPONSE message
containing a \ element with PC3 Control Protocol cause value
#18 \"Invalid UE identity\".
If the Discovery Entry ID contained in the DISCOVERY_UPDATE_REQUEST message is
not found in the UE context, the UE shall send a DISCOVERY_UPDATE _RESPONSE
message containing a \ element with PC3 Control Protocol
cause value #10 \"Unknown or Invalid Discovery Entry ID\".
##### 6.2.6.3.5 Abnormal cases
###### 6.2.6.3.5.1 Abnormal cases in the ProSe Function
The following abnormal cases can be identified:
a) Indication from the transport layer of transmission failure of
DISCOVERY_UPDATE_REQUEST message (e.g. after TCP retransmission timeout)
The ProSe Function shall close the existing secure connection to the UE.
b) No response from the UE after the DISCOVERY_UPDATE_REQUEST message has been
successfully delivered (e.g., TCP ACK has been received for the
DISCOVERY_UPDATE_REQUEST message)
The ProSe Function shall retransmit the DISCOVERY_UPDATE_REQUEST message.
NOTE: The timer to trigger retransmission and the maximum number of allowed
retransmissions are ProSe Function implementation specific.
###### 6.2.6.3.5.2 Abnormal cases in the UE
The following abnormal cases can be identified:
a) Indication from the lower layer of transmission failure of
DISCOVERY_UPDATE_RESPONSE message.
After receiving an indication from lower layer that the
DISCOVERY_UPDATE_RESPONSE message has not been successfully acknowledged (e.g.
TCP ACK is not received), the UE shall abort the procedure.
### 6.2.7 Direct discovery update procedure for open discovery
#### 6.2.7.1 General
The direct discovery update procedure is used to update or revoke a previously
allocated ProSe Application Code, or Discovery Filter(s) as specified in 3GPP
TS 23.303 [2].
#### 6.2.7.2 Direct discovery update procedure initiation
When triggered to revoke a previously allocated ProSe Application Code for an
announcing UE or revoke Discovery Filter(s) for a monitoring UE, the ProSe
Function in the HPLMN sends a DISCOVERY_UPDATE_REQUEST message to the UE with:
\- a new ProSe Function transaction ID not used in any other direct discovery
procedures in PC3 interface;
\- the UE identity set to the UE\'s IMSI; and
\- the Discovery Entry ID set to the Discovery Entry ID of the corresponding
Discovery Entry that contains the ProSe Application Code or the Discovery
Filter(s) to be revoked.
When triggered to update a previously allocated ProSe Application Code for an
announcing UE, the ProSe function in the HPLMN shall allocate a new ProSe
Application Code for the ProSe Application ID with a new validity timer T4000,
associate the discovery entry with the new ProSe Application Code and restart
timer T4001.Then the ProSe Function sends a DISCOVERY_UPDATE_REQUEST message
to the UE with:
\- a new ProSe Function transaction ID not used in any other direct discovery
procedures in PC3 interface;
\- the UE identity set to the UE\'s IMSI;
\- the Discovery Entry ID set to the Discovery Entry ID of the corresponding
Discovery Entry that contains the ProSe Application Code to be updated; and
\- the Update Info containing the ProSe Application Code set to the new ProSe
Application Code allocated by the ProSe Function and a Validity Timer T4000
set to the T4000 timer value assigned by the ProSe Function to the new ProSe
Application Code.
When triggered to update Discovery Filter(s) for a monitoring UE, the ProSe
Function in the HPLMN updates the content of Discovery Filter(s), associate
the discovery entry with the updated Discovery Filter(s) and restart timer
T4003 for each filter. The update of Discovery Filter content includes setting
new TTL timer(s) and if necessary, assigning new ProSe Application Code and
ProSe Application Mask(s). Then the ProSe Function sends a
DISCOVERY_UPDATE_REQUEST message to the UE with:
\- a new ProSe Function transaction ID not used in any other direct discovery
procedures in PC3 interface;
\- the UE identity set to the UE\'s IMSI;
\- the Discovery Entry ID set to the Discovery Entry ID of the corresponding
Discovery Entry that contains the Discovery Filter(s) to be updated; and
\- the Update Info containing the Discovery Filter(s) set to the new Discovery
Filter(s) allocated by the ProSe Function.
NOTE 1: The ProSe Function can include one or multiple transactions in one
DISCOVERY_UPDATE_REQUEST message for ProSe App Codes or Discovery Filter(s)
contained in different discovery entries, and receive corresponding \ element or \ element in a
DISCOVERY_UPDATE_RESPONSE message for each respective transaction. In the
following description of direct discovery update request procedure, only one
transaction is included.
Figure 6.2.7.2.1 illustrates the interaction of the UE and the ProSe Function
in the direct discovery update procedure.
Figure 6.2.7.2.1: Direct discovery update procedure for open discovery
NOTE 2: In the figure 6.2.7.2.1, the timers are started only when the
procedure is triggered to update a previously allocated ProSe Application Code
for an announcing UE or update Discovery Filter(s) for a monitoring UE.
#### 6.2.7.3 Direct discovery update procedure accepted by the UE
Upon receiving a DISCOVERY_UPDATE_REQUEST message, the UE shall check if the
UE identity contained in the DISCOVERY_UPDATE_REQUEST message is the IMSI of
the UE. If the UE identity is the IMSI of the UE, the UE shall check if the
Discovery Entry ID contained in the DISCOVERY_UPDATE_REQUEST message is known.
If the Discovery Entry ID is known, the UE shall proceed with the following
direct discovery update procedure.
If the Update Info is not included in the DISCOVERY_UPDATE_REQUEST message,
the UE shall stop running timers corresponding to the discovery entry and
delete the discovery entry corresponding to the Discovery Entry ID contained
in the DISCOVERY_UPDATE_REQUEST message. The UE informs the lower layers to
stop announcing or monitoring corresponding to the Discovery Entry ID
contained in the DISCOVERY_UPDATE_REQUEST message.
If the Update Info is included in the DISCOVERY_UPDATE_REQUEST message, the UE
shall replace the existing ProSe Application Code or the Discovery Filter(s)
with new ProSe Application Code or the Discovery Filter(s) contained in the
Update Info correspondingly. The announcing UE shall stop the timer T4000,
start the validity timer T4000 with the received value for the new ProSe
Application Code and perform open ProSe direct discovery announcing with the
new ProSe Application Code as described in subclause 6.2.2.4. The monitoring
UE shall stop TTL timer T4002, start TTL timer T4002 with the received value
for each new Discovery Filter(s) and perform open ProSe direct discovery
monitoring with each new Discovery Filter(s) as described in subclause
6.2.3.4.
Then the UE shall send a DISCOVERY_UPDATE_RESPONSE message containing a
\ element with:
\- the ProSe Function transaction ID set to the value of the ProSe Function
transaction ID received in the DISCOVERY_UPDATE_REQUEST message; and
\- the Discovery Entry ID set to the value of the Discovery Entry ID received
in the DISCOVERY_UPDATE_REQUEST message.
#### 6.2.7.4 Direct discovery update procedure completed by the ProSe Function
Upon receiving a DISCOVERY_UPDATE_RESPONSE message, if the ProSe Function
transaction ID contained in the \ element does not match the
value sent by the ProSe Function in a DISCOVERY_UPDATE_REQUEST message, the
ProSe Function shall discard the DISCOVERY_UPDATE_RESPONSE message. Otherwise,
the ProSe Function shall perform the following procedure.
When the UE is an announcing UE and the radio resources that the UE intends to
use are operated by a PLMN other than the HPLMN, the ProSe Function shall
execute the procedures defined in 3GPP TS 29.345 [5] to inform the ProSe
Function in VPLMN or local PLMN.
When the UE is a monitoring UE and the ProSe Application ID monitored by the
UE is PLMN-specific and that PLMN ID indicated by the ProSe Application ID is
not the same as that of the PLMN to which the ProSe Function belongs, the
ProSe Function executes the procedures defined in 3GPP TS 29.345 [5] to inform
the ProSe Function in the PLMN indicated by the ProSe Application ID.
For each Discovery Entry ID received in the DISCOVERY_UPDATE_RESPONSE message,
if the procedure is to revoke a previously allocated ProSe Application Code or
Discovery Filter(s), the ProSe Function shall delete the discovery entry
indicated by the Discovery Entry ID from the UE\'s context and release the
associated resources.
#### 6.2.7.5 Direct discovery update procedure not accepted by the UE
If the DISCOVERY_UPDATE_REQUEST message cannot be accepted by the UE, the UE
sends a DISCOVERY_UPDATE_RESPONSE message containing a \
element to the ProSe Function including an appropriate PC3 Control Protocol
cause value.
If the UE identity contained in the DISCOVERY_UPDATE_REQUEST message is not
the IMSI of the UE, the UE shall send a DISCOVERY_UPDATE_RESPONSE message
containing a \ element with PC3 Control Protocol cause value
#18 \"Invalid UE Identity\".
If the Discovery Entry ID contained in the DISCOVERY_UPDATE _REQUEST message
is unknown, the UE shall send the DISCOVERY_UPDATE_RESPONSE message containing
a \ element with PC3 Control Protocol cause value # 10
\"Unknown or Invalid Discovery Entry ID\".
#### 6.2.7.6 Abnormal cases
##### 6.2.7.6.1 Abnormal cases in the ProSe Function
The following abnormal cases can be identified:
a) Indication from the transport layer of transmission failure of
DISCOVERY_UPDATE_REQUEST message (e.g. after TCP retransmission timeout)
The ProSe Function shall close the existing secure connection to the UE.
b) No response from the UE after the DISCOVERY_UPDATE_REQUEST message has been
successfully delivered (e.g., TCP ACK has been received for the
DISCOVERY_UPDATE_REQUEST message)
The ProSe Function shall retransmit the DISCOVERY_UPDATE_REQUEST message.
NOTE: The timer to trigger retransmission and the maximum number of allowed
retransmissions are ProSe Function implementation specific.
##### 6.2.7.6.2 Abnormal cases in the UE
The following abnormal cases can be identified:
a) Indication from the lower layer of transmission failure of
DISCOVERY_UPDATE_RESPONSE message.
After receiving an indication from lower layer that the
DISCOVERY_UPDATE_RESPONSE message has not been successfully acknowledged (e.g.
TCP ACK is not received), the UE shall abort the procedure.
### 6.2.8 Announcing Alert procedure
#### 6.2.8.1 General
The purpose of the Announcing Alert procedure is for the ProSe Function in
HPLMN to send to the announcing UE the ProSe Restricted Code generated in the
announce request procedure for restricted ProSe direct discovery model A as
specified in clause 6.2.2A.
Before initiating the Announcing Alert procedure, the ProSe Function shall
determine whether the announcing UE and the monitoring UE are close enough to
trigger the Announcing Alert procedure.
The announcing UE includes the ProSe Restricted Code in a PC5_DISCOVERY
message and passes the PC5_DISCOVERY message to the lower layers for
transmission over the PC5 interface in the registered PLMN or local PLMN as a
result of a successful Announcing Alert procedure.
#### 6.2.8.2 Announcing Alert procedure initiation
If the UE has initiated an announce request procedure for restricted ProSe
direct discovery model A before as specified in clause 6.2.2A and the On
Demand Announcing Enabled Indicator associated with the RPAUID in the
announcing UE context is set to 1, the ProSe Function shall initiate an
Announcing Alert procedure:
a) when the ProSe Function receives a pair of Target PDUID -Target RPAUID from
the ProSe Application Server as described in 3GPP TS 29.343[31], the Target
RPAUID is the same as the RPAUID stored in the announcing UE context, and
ProSe Function determines the monitoring UE is in the vicinity of the
announcing UE; or
b) when the ProSe Function receives a pair of Target PDUID -Target RPAUID from
other ProSe Functions as described in 3GPP TS 29.345[5], the Target RPAUID is
the same as the RPAUID stored in the announcing UE context and the ProSe
Function determines the monitoring UE is in the vicinity of the announcing UE.
NOTE: How the ProSe Function in the HPLMN determines whether the announcing UE
and the monitoring UE are close enough to trigger the Announcing Alert
procedure is left to the implementation of ProSe Function.
The ProSe Function initiates the Announce Alert procedure by sending an
ANNOUNCING_ALERT_REQUEST message with:
\- a new ProSe Function transaction ID;
\- the UE identity set to the UE\'s IMSI;
\- the RPAUID set to the Target RPAUID received from ProSe Application Server
as specified in 3GPP TS 29.343[31] or from other ProSe Functions as specified
in 3GPP TS 29.345[5];
\- the ProSe Restricted Code set to the ProSe Restricted Code or the ProSe
Restricted Code Prefix, and optionally one or more ProSe Restricted Code
Suffix Ranges which contain the suffix(es) for the RPAUID retrieved from the
announcing UE context; and
\- the Discovery Entry ID set to the identifier associated with the
corresponding discovery entry in the UE\'s context.
Figure 6.2.8.2.1 illustrates the interaction of the ProSe Function and the UE
in the Announce Alert procedure.
Figure 6.2.8.2.1: Announcing Alert procedure
#### 6.2.8.3 Announcing Alert procedure accepted by the UE
Upon receipt of the ANNOUNCING_ALERT_REQUEST message, the UE shall check if
the UE identity contained in the ANNOUNCING_ALERT_REQUEST message is the IMSI
of the UE. If the UE identity is the IMSI of the UE, the UE shall check
whether there is an existing discovery entry identified by the Discovery Entry
ID included in the ANNOUNCING_ALERT_REQUEST message. If the discovery entry
exists in the UE, the UE shall send an ANNOUNCE_ALERT_RESPONSE message to the
ProSe Function with a ProSe Function transaction ID set to the value of the
ProSe Function transaction ID received in the ANNOUNCING_ALERT_REQUEST
message.
Then, the UE may perform restricted ProSe direct discovery model A announcing
as described below.
The UE requests the parameters from the lower layers for restricted Prose
direct discovery model A announcing (see 3GPP TS 36.331 [12]). The UE shall
perform restricted ProSe direct discovery model A announcing only if the lower
layers indicate that ProSe direct discovery is supported by the network. If
the UE in EMM-IDLE mode has to request resources for ProSe direct discovery
announcing as specified in 3GPP TS 36.331 [12], the UE shall perform a service
request procedure or tracking area update procedure as specified in 3GPP TS
24.301 [11]. The UE shall obtain the UTC time for the next discovery
transmission opportunity for ProSe direct discovery from the lower layers.
If a valid UTC time is obtained, the UE shall generate the UTC-based counter
corresponding to this UTC time as specified in subclause 12.2.2.18. If the
resulting UTC-based counter is within Max Offset of the time shown by the
clock used for ProSe by the UE, the UE shall use the UTC-based counter to
compute the MIC field for the PC5_DISCOVERY message as described in 3GPP TS
33.303 [6].
The UE shall either use the ProSe Restricted Code received in the
ANNOUNCING_ALERT_REQUEST message, or select one ProSe Restricted Code based on
the ProSe Restricted Code Prefix and ProSe Restricted Code Suffix Range(s)
received in the ANNOUNCING_ALERT_REQUEST message as announced ProSe Restricted
Code, along with the MIC and the eight least significant bits of the UTC-based
counter, in order to construct a PC5_DISCOVERY message, according to the
format defined in subclause 11.2.5.
NOTE: The UE can use different codes formed based on different ProSe
Restricted Code Suffixes to announce, without having to send a new
DISCOVERY_REQUEST message to the ProSe Function, as long as the validity timer
T4007 of the ProSe Restricted Code Prefix has not expired.
The UE then passes the PC5_DISCOVERY message to the lower layers for
transmission if:
\- the UE is currently authorised to perform restricted ProSe direct discovery
model A announcing in the registered PLMN or the local PLMN operating the
radio resources that the UE intends to use;
\- the validity timer T4007 for the corresponding discovery entry allocated
ProSe Restricted Code or ProSe Restricted Code Prefix has not expired; and
\- a request from upper layers to announce the RPAUID associated with both the
ProSe Restricted Code or ProSe Restricted Code Prefix, and the authorised
Application Identity, is still in place.
The UE shall ensure that it keeps on passing PC5_DISCOVERY messages to the
lower layers for transmission until the validity timer T4007 of the ProSe
Restricted Code or ProSe Restricted Code Prefix expires. How this is achieved
is left up to UE implementation.
During the announcing operation, if one of the above conditions is no longer
met, the UE may instruct the lower layers to stop announcing. When the UE
stops announcing, if the lower layers indicate that the UE is required to send
a discovery indication to the eNodeB and the UE is in EMM-CONNECTED mode, the
UE shall trigger the corresponding procedure in lower layers as specified in
3GPP TS 36.331 [12].
#### 6.2.8.4 Announcing Alert procedure completion by the ProSe Function
Upon receipt of the ANNOUNCE_ALERT_RESPONSE message with a ProSe Function
transaction ID set to the value of the ProSe Function Transaction ID included
in the ANNOUNCING_ALERT_REQUEST message, the ProSe Function will set the
associated On Demand Announcing Enabled Indicator to 0. Then the Announcing
Alert procedure is successfully completed.
#### 6.2.8.4A Announcing Alert procedure not accepted by the UE
If the ANNOUNCING_ALERT_REQUEST message cannot be accepted by the UE, the UE
sends a ANNOUNCING_ALERT_RESPONSE message containing a \
element to the ProSe Function including an appropriate PC3 Control Protocol
cause value.
If the UE identity contained in the ANNOUNCING_ALERT_REQUEST message is not
the IMSI of the UE, the UE shall send a ANNOUNCING_ALERT_RESPONSE message
containing a \ element with PC3 Control Protocol cause value
#18 \"Invalid UE Identity\".
If the Discovery Entry ID contained in the ANNOUNCING_ALERT_REQUEST message is
unknown, the UE shall send the ANNOUNCING_ALERT_RESPONSE message containing a
\ element with PC3 Control Protocol cause value #10\"Unknown
or Invalid Discovery Entry ID\".
#### 6.2.8.5 Abnormal cases
###### 6.2.8.5.1 Abnormal cases in the ProSe Function
The following abnormal cases can be identified:
a) Indication from the transport layer of transmission failure of
ANNOUNCING_ALERT_REQUEST message (e.g. after TCP retransmission timeout)
The ProSe Function shall close the existing secure connection to the UE.
b) No response from the UE after the ANNOUNCING_ALERT_REQUEST message has been
successfully delivered (e.g. TCP ACK has been received for the
ANNOUNCING_ALERT_REQUEST message)
The ProSe Function shall retransmit the ANNOUNCING_ALERT_REQUEST message.
NOTE: The timer to trigger retransmission and the maximum number of allowed
retransmissions are ProSe Function implementation specific.
###### 6.2.8.5.2 Abnormal cases in the UE
The following abnormal cases can be identified:
a) Indication from the lower layer of transmission failure of
ANNOUNCE_ALERT_RESPONSE message.
After receiving an indication from lower layer that the
ANNOUNCE_ALERT_RESPONSE message has not been successfully acknowledged (e.g.
TCP ACK is not received), the UE shall abort the procedure.
# 7 EPC-level ProSe discovery
## 7.1 Overview
This clause describes the PC3 Control Protocol procedures between the UE and
the ProSe Function for EPC-level ProSe discovery.
### 7.1.1 Transport protocol for PC3 Control Protocol messages for EPC-level
ProSe discovery
The UE and the ProSe Function shall use HTTP 1.1 as specified in IETF RFC 7230
[18] and IETF RFC 7231 [19] as the transport protocol for EPC-level ProSe
discovery messages over the PC3 interface. The ProSe messages described here
shall be included in the body of either an HTTP request message or an HTTP
response message.
### 7.1.2 Handling of UE-initiated procedures
The following rules apply for UE-initiated procedures:
\- The UE initiates ProSe transactions with an HTTP request message containing
the PC3 request(s); and
\- The ProSe Function responds to the requests with an HTTP response message
containing the PC3 response(s) for the PC3 request(s).
Optionally, the operator can configure the UE with configuration parameters
for establishment of the PDN connection for reaching the HPLMN ProSe Function.
If the UE is configured with the configuration parameter for establishment of
the PDN connection for reaching the HPLMN ProSe Function (see 3GPP TS 24.333
[9]):
a) if a PDN connection for reaching the HPLMN ProSe Function is not
established yet, the UE shall establish the PDN connection for reaching the
HPLMN ProSe Function according to the UE configuration and shall send the HTTP
request message via the PDN connection for reaching the HPLMN ProSe Function;
and
b) if a PDN connection for reaching the HPLMN ProSe Function is already
established (e.g. either due to other ProSe feature or due to other
application), the UE shall send the HTTP request message via the PDN
connection for reaching the HPLMN ProSe Function;
### 7.1.3 Handling of network-initiated procedures
The network-initiated messages for EPC-level ProSe discovery over the PC3
interface shall be contained in an HTTP response message. Either HTTP long
polling, or OMA Push, can be used to trigger the HTTP request corresponding to
this HTTP response message. The UE and the ProSe Function shall support OMA
Push for network initiated procedures. Optionally the UE and ProSe Function
should support long polling as well for network initiated procedures.
During the UE registration procedure, the UE and the ProSe Function decide
which method to use. If the UE supports long polling method, the UE indicates
that to the ProSe Function in the UE-registration request with a \"Method for
server-initiated transaction\" IE. If the ProSe Function supports long polling
method as well and if it prefers to use the long polling method for network
initiated procedures, then it checks if UE can also support long polling
method via the \"Method for server-initiated transaction\" IE included in the
registration request message and indicates the use of long-polling in the
registration response message. If the ProSe Function supports OMA Push only or
if it chooses to use OMA Push then it ignores the \"Method for server-
initiated transaction\"IE in UE registration request.
#### 7.1.3.1 HTTP long polling
The HTTP long polling method involves the following steps:
a) the UE sends an empty HTTP request message as a polling request when it
expects network initiated message(s) over the PC3 interface;
b) the ProSe Function defers its response to the UE's request until;
i) one ore more network-initiated PC3 message(s) for the UE are available. The
ProSe Function will enclose the message(s) in an HTTP response message and
send it to the UE; or
ii) a particular timeout for HTTP polling has occurred. The ProSe Function
then sends an empty HTTP response message as the polling response to the UE.
c) After receiving the response from the ProSe Function, the UE may keep
polling after some waiting period if:
i) the UE receives an empty polling response; or
ii) the UE receives network-initiated message(s) from the ProSe Function but
still expects additional network-initiated message(s).
NOTE: The implementation of the HTTP polling process can be coordinated with
the SUPL (Secure User Plane Location) procedures to synchronize the SUPL
location report procedures and the HTTP polling procedure so as to reduce
unnecessary wait time of polling.
If the UE is trigged to send a PC3 message to the ProSe Function while it has
a pending HTTP polling request, the UE shall open another HTTP connection to
the ProSe Function to send this new request. Alternately the UE may always use
a separate dedicated HTTP connection for polling.
#### 7.1.3.2 OMA Push
The OMA Push method involves the following steps:
a) if one or more network-initiated PC3 message(s) for the UE are available,
the ProSe Function sends a push message containing a particular URL to the UE
via the OMA-Push Architecture as defined in OMA-AD-Push-V2_2-20110809-A [22].
The URL is linked to the PC3 message(s) to be sent to the UE. The ProSe
Function (performing OMA Push Proxy Gateway functionality) generates a Push
Message as specified in OMA-WAP-TS-PushOTA-V2_1-20110405-A [21] with the PDU
set according to WAP-168-ServiceLoad-20010731-a [20]. The URL information
shall be included in the PDU payload;
b) After receiving the push message, the UE retrieves the URL from the payload
of the message and sends an HTTP GET request to the ProSe Function with this
URL; and
c) the ProSe Function sends an HTTP response message containing the PC3
message(s) to the UE.
## 7.2 Procedures
### 7.2.1 Types of EPC-level ProSe discovery procedures
The following PC3 Control Protocol procedures are defined:
\- UE registration;
\- application registration;
\- proximity request;
\- proximity request validation;
\- proximity alert;
\- UE deregistration; and
\- proximity request cancellation.
EPC support for WLAN direct discovery and communication may be requested as
part of the EPC-level ProSe discovery procedure.
### 7.2.2 UE registration procedure
#### 7.2.2.1 General
The purpose of the UE registration procedure is for the UE to register with
the ProSe Function to obtain EPC-level ProSe discovery services as defined in
3GPP TS 23.303 [2]. The UE registers with the ProSe Function residing in the
HPLMN.
#### 7.2.2.2 UE registration procedure initiation
Based on pre-configuration, if the UE is authorised to perform EPC-level ProSe
discovery in the registered PLMN, it shall initiate the UE registration
procedure when the UE is triggered by upper layers to obtain EPC-level ProSe
discovery services and the UE has no corresponding EPC ProSe User ID.
The UE initiates the UE registration procedure by sending a
UE_REGISTRATION_REQUEST message with the UE identity set to the UE\'s IMSI. If
the UE intends to use EPC support for WLAN direct discovery and communication
and if the UE uses a permanent WLAN link layer identifier, then the UE also
includes the WLAN link layer identifier in the UE_REGISTRATION_REQUEST
message. If the UE supports long polling method for network initiated
procedures then the UE also includes a \"Method for server-initiated
transaction\" parameter indicating to the ProSe Function that it support long
polling method.
Figure 7.2.2.2.1 illustrates the interaction of the UE and the ProSe Function
in the UE registration procedure.
Figure 7.2.2.2.1: UE registration procedure
#### 7.2.2.3 UE registration procedure accepted by the ProSe Function
Upon receiving a UE_REGISTRATION_REQUEST message, the ProSe Function interacts
with the HSS as described in 3GPP TS 29.344 [3] in order to authenticate the
user and check whether the user is authorised to use EPC-level ProSe discovery
services corresponding to the IMSI contained in the UE_REGISTRATION_REQUEST
message in the registered PLMN.
If the ProSe Function contains all the settings related to authentication and
authorisation for the user corresponding to the IMSI contained in the
UE_REGISTRATION_REQUEST message then the ProSe function need not interact with
the HSS and the ProSe Function checks locally if the user is authorised to use
EPC-level ProSe discovery services.
If the UE is authorised to use EPC-level ProSe discovery services, the ProSe
Function generates an EPC ProSe User ID corresponding to the IMSI contained in
the UE_REGISTRATION_REQUEST message and shall send a UE_REGISTRATION_RESPONSE
message containing a \ element to the UE with the EPC ProSe
User ID. The EPC ProSe User ID is a number generated by the ProSe Function
that is unique within the ProSe Function on a per UE basis. The \ element shall also contain a server-initiated method configuration
parameter indicating to the UE which method to use to handle server-initiated
procedures.
#### 7.2.2.4 UE registration procedure completion by the UE
Upon receipt of the UE_REGISTRATION_RESPONSE message containing a \ element the UE stores the EPC ProSe User ID and may start the
application registration procedure. The UE shall use the method configured in
UE_REGISTRATION_RESPONSE message to handle server-initiated procedures.
#### 7.2.2.5 UE registration procedure not accepted by the ProSe Function
If the UE_REGISTRATION_REQUEST message is not accepted by the ProSe Function,
the ProSe Function shall send a UE_REGISTRATION _RESPONSE message containing a
\ element to the UE including an appropriate PC3 EPC Control
Protocol cause value.
If the UE is not authorised for EPC-level ProSe discovery, the ProSe Function
shall send the UE_REGISTRATION_RESPONSE message containing a \ element with PC3 EPC Control Protocol cause value #2 \"UE
authorisation failure\".
### 7.2.3 Application registration procedure
#### 7.2.3.1 General
The purpose of the application registration procedure is for the UE to
activate EPC-level Prose discovery for a specific application as defined in
3GPP TS 23.303 [2]. The UE registers the specific application with the ProSe
Function residing in the HPLMN.
#### 7.2.3.2 Application registration procedure initiation
When the user uses applications on the UE, an Application ID is used to
identify the corresponding application server platform. When the user
registers an application with the application server, the user is designated
an Application Layer User ID. If the application requires EPC-level ProSe
discovery, the UE is configured with the data structure of the Application IDs
and the Application Layer User ID. This step is performed using mechanisms
outside of the scope of 3GPP. The user may have multiple Application Layer
User IDs for an application, but may choose to register only one of these to
activate EPC-level ProSe discovery. The UE shall initiate the application
registration procedure after successfully completing the UE registration
procedure.
If the UE is authorised to perform EPC-level ProSe discovery in the registered
PLMN, it shall initiate the application registration procedure when the UE is
triggered by upper layers to activate EPC-level Prose discovery for a specific
application and the application is not registered.
The UE initiates the application registration procedure by sending an
APPLICATION_REGISTRATION_REQUEST message by including a new transaction ID,
the UE\'s EPC ProSe User ID, the Application ID for the application that is to
be registered and the user\'s Application Layer User ID for the application
that is to be registered.
NOTE: A UE can include one or multiple transactions in one
APPLICATION_REGISTRATION_REQUEST message for different Application IDs, and
receive corresponding \ element or \
element in the APPLICATION_REGISTRATION_RESPONSE message for each respective
transaction. In the following description of the application registration
procedure, only one transaction is included.
Figure 7.2.3.2.1 illustrates the interaction of the UE and the ProSe Function
in the application registration procedure.
Figure 7.2.3.2.1: Application registration procedure
#### 7.2.3.3 Application registration procedure accepted by the ProSe Function
Upon receiving an APPLICATION_REGISTRATION_REQUEST message, the ProSe Function
retrieves the user profile based on the UE\'s EPC ProSe User ID included in
the APPLICATION_REGISTRATION_REQUEST message. The ProSe Function then checks
if the list of authorised applications in the user\'s profile includes the
requested application based on the Application ID in the
APPLICATION_REGISTRATION_REQUEST message.
If the check is successful then the ProSe Function sends a request to the
application server so that the user of this application identified by
Application Layer User ID in the APPLICATION_REGISTRATION_REQUEST message can
use EPC-level ProSe discovery for that application.
If the user is authorised to use EPC-level ProSe discovery for the specified
application, the ProSe Function generates one or more allowed range classes
corresponding to the Application ID contained in the
APPLICATION_REGISTRATION_REQUEST message. The ProSe Function shall send an
APPLICATION_REGISTRATION_RESPONSE message containing a \
element to the UE with transaction ID set to the value of the transaction ID
received in the APPLICATION_REGISTRATION_REQUEST message from the UE and the
set of allowed range classes. The set of allowed range classes for each
Application ID is stored in the ProSe Function.
#### 7.2.3.4 Application registration procedure completion by the UE
Upon receipt of the UE_REGISTRATION_RESPONSE message, if the transaction ID
contained in the \ element matches the value sent by the UE
in an APPLICATION_REGISTRATION_REQUEST message the UE stores the set of
allowed range classes for this Application ID and may start the proximity
request procedure.
#### 7.2.3.5 Application registration procedure not accepted by the ProSe
Function
If the APPLICATION_REGISTRATION_REQUEST message is not accepted by the ProSe
Function, the ProSe Function shall send an APPLICATION_REGISTRATION_RESPONSE
message containing a \ element to the UE including an
appropriate PC3 EPC Control Protocol cause value.
If the application corresponding to the Application ID contained in the
APPLICATION_REGISTRATION_REQUEST message is not authorised for EPC-level ProSe
Discovery in the registered PLMN, the ProSe Function shall send the
APPLICATION_REGISTRATION_RESPONSE message containing a \
element with PC3 EPC Control Protocol cause value #1 \"Invalid Application\".
If the UE is not authorised for EPC-level ProSe Discovery, the ProSe Function
shall send the APPLICATION_REGISTRATION_RESPONSE message containing a
\ element with PC3 EPC Control Protocol cause value #2 \"UE
authorisation failure\".
If the Application Layer User ID contained in the
APPLICATION_REGISTRATION_REQUEST message is unknown to the Application Server,
the ProSe Function shall send the APPLICATION_REGISTRATION_RESPONSE message
containing a \ element with PC3 EPC Control Protocol cause
value #10 \"Invalid Application Layer User ID\".
### 7.2.4 Proximity request procedure
#### 7.2.4.1 General
The purpose of the proximity request procedure is to allow a UE (UE A) to
request to be alerted when it enters in proximity with a targeted UE (UE B) as
defined in 3GPP TS 23.303 [2]. UE A performs the proximity request procedure
with the ProSe Function residing in the HPLMN.
#### 7.2.4.2 Proximity request procedure initiation
Before initiating the proximity request procedure, UE A needs to register the
user\'s Application Layer User ID A with ProSe Function A as described in
subclause 7.2.3. UE A shall initiate the proximity request procedure when
triggered by upper layers to activate EPC-level Prose discovery for a specific
application and for a specific targeted user identified via its Application
Layer User ID B.
UE A initiates the proximity request procedure by sending a PROXIMITY_REQUEST
message to ProSe Function A by including a new transaction ID, UE A\'s EPC
ProSe User ID, the Application ID for the application for which the request is
made, UE A\'s Application Layer User ID (Application Layer User ID A), the
Application Layer User ID of UE B (Application Layer User ID B), a requested
range class value selected from the set of allowed range classes for this
application, UE A\'s Current Location with the best known accuracy and a Time
Window indicating the time interval during which the request is valid.
NOTE: A UE can include one or multiple transactions in one PROXIMITY_REQUEST
message for different Application IDs, and receives corresponding \ element or \ element in the
PROXIMITY_REQUEST_RESPONSE message for each respective transaction. In the
following description of the Proximity Request procedure, only one transaction
is included.
If UE A, subsequent to successful proximity detection with UE B, wishes to
engage in WLAN direct discovery and communication, UE A also includes a WLAN
Indication in the PROXIMITY_REQUEST message.
Figure 7.2.4.2.1 illustrates the interaction of the UE and the ProSe Function
in the proximity request procedure.
Figure 7.2.4.2.1: Proximity request procedure
#### 7.2.4.3 Proximity request procedure accepted by the ProSe Function
Upon receiving a PROXIMITY_REQUEST message from UE A, ProSe Function A
retrieves the user profile based on the UE\'s EPC ProSe User ID included in
the PROXIMITY_REQUEST message. ProSe Function A then checks that UE A has
previously registered the application identified with the Application ID in
the PROXIMITY_REQUEST message and that the requested range class value belongs
to the set of allowed range classes for this application.
If the check is successful then ProSe Function A interacts with the
Application Server to obtain the identifier of ProSe Function B that owns the
user profile of the targeted user, as well as its EPC ProSe User ID (EPC ProSe
User ID B). ProSe Function A then propagates the proximity request to ProSe
Function B on the targeted UE side (the B-side). The Current Location of UE A
included in the PROXIMITY_REQUEST message may be used by ProSe Function B to
determine whether the proximity request is accepted or not.
NOTE: The mechanism used by ProSe Function B to determine acceptance or non-
acceptance of PROXIMITY_REQUEST messages is outside the scope of this
specification.
If the proximity request is accepted by the B-side, ProSe Function A stores
Application Layer User ID A, Application Layer User ID B, EPC ProSe User ID B,
requested range class and Time Window in the UE A\'s context identified with
EPC ProSe User ID A. The WLAN Indication is also stored, if it was included in
the PROXIMITY_REQUEST message. Then ProSe Function A shall initiate location
reporting for UE A and send a PROXIMITY_REQUEST_RESPONSE message containing a
\ element to UE A with transaction ID set to the value of the
transaction ID received in the PROXIMITY_REQUEST message from UE A.
#### 7.2.4.4 Proximity request procedure completion by the UE
Upon receipt of the PROXIMITY_REQUEST_RESPONSE message, if the transaction ID
contained in the \ element matches the value sent by the UE
in a PROXIMITY_REQUEST message, the proximity request procedure is
successfully completed.
#### 7.2.4.5 Proximity request procedure not accepted by the ProSe Function
If the PROXIMITY_REQUEST message is not accepted by the ProSe Function, the
ProSe Function shall send a PROXIMITY_REQUEST_RESPONSE message containing a
\ element to the UE including an appropriate PC3 EPC Control
Protocol cause value.
If the application corresponding to the Application ID contained in the
PROXIMITY_REQUEST message is not authorised for EPC-level ProSe discovery, the
ProSe Function shall send the PROXIMITY_REQUEST_RESPONSE message containing a
\ element with PC3 EPC Control Protocol cause value #1
\"Invalid Application\".
If the application corresponding to the Application ID contained in the
PROXIMITY_REQUEST message has not been registered for EPC-level ProSe
discovery, the ProSe Function shall send the PROXIMITY_REQUEST_RESPONSE
message containing a \ element with PC3 EPC Control Protocol
cause value #4 \"Application not registered\".
If the requested Range Class value is not allowed for this application, the
ProSe Function shall send the PROXIMITY_REQUEST_RESPONSE message containing a
\ element with PC3 EPC Control Protocol cause value #5
\"Range Class not allowed for this application\".
If based on the Current Location the B-side determines that UE A and targeted
UE B are unlikely to enter proximity within the requested Time Window, the
ProSe Function shall send the PROXIMITY_REQUEST_RESPONSE message containing a
\ element with PC3 EPC Control Protocol cause value #6
\"Proximity detection unlikely within requested time window\".
If the ProSe Function determines that the targeted UE has not registered the
application identified with Application ID, the ProSe Function shall send the
PROXIMITY_REQUEST_RESPONSE message containing a \ element
with PC3 EPC Control Protocol cause value #7 \"Targeted user not registered
for this application\".
If the B-side rejects to validate the proximity request, the ProSe Function
shall send the PROXIMITY_REQUEST_RESPONSE message containing a \ element with PC3 EPC Control Protocol cause value #8 \"Proximity
validation rejected by B side\".
### 7.2.5 Proximity alert procedure
#### 7.2.5.1 General
The purpose of the proximity alert procedure is to inform the UE (UE A) that
it has been determined to be in proximity with the targeted UE (UE B) as
defined in 3GPP TS 23.303 [2]. If UE A has indicated in the proximity request
procedure that it wishes to engage in WLAN direct discovery and communication
with UE B, the proximity alert procedure is also used to provide Assistance
Information that expedites the WLAN direct discovery and communication to both
UE A and UE B. The proximity alert procedure is initiated by the ProSe
Function residing in the HPLMN.
#### 7.2.5.2 Proximity alert procedure initiation by the network
When ProSe Function A on the A-side determines that UE A and UE B are in
proximity, it cancels the location reporting for UE A with the SUPL Location
Platform and sends a PROXIMITY_ALERT message to UE A including the Application
ID, Application Layer User ID A and Application Layer User ID B.
UE A may have registered multiple proximity requests for applications with
different Application IDs. In this case the ProSe Function may combine the
multiple alerts for each of the different Application IDs and send a combined
PROXIMITY_ALERT message to the UE.
If UE A\'s context contains a WLAN Indication, the ProSe Function generates
Assistance Information for WLAN direct discovery and communication according
to the underlying WLAN technology, includes the Assistance Information in the
PROXIMITY ALERT message and forwards the alert towards the B-side.
If the context of UE A does not contain WLAN Indication then ProSe Function A
sends a cancellation request towards ProSe Function B.
After transmitting the PROXIMITY_ALERT message to UE A and alerting (or
sending a cancellation request to) the B-side, the ProSe Function deletes the
information related to this specific Proximity Request in UE A\'s context.
NOTE: If UE A has signalled a permanent WLAN Link Layer ID during UE
Registration procedure as described in subclause 7.2.2, the WLAN Link Layer ID
for UE A is retrieved from UE A\'s context; otherwise a random WLAN Link Layer
ID is generated for UE A by the ProSe Function. Similarly, if during the
Proximity Request procedure the ProSe Function has received a permanent WLAN
Link Layer ID for UE B, the WLAN Link Layer ID for UE B is retrieved from UE
A\'s context; otherwise a random WLAN Link Layer ID is generated for UE B by
the ProSe Function.
When ProSe Function B is alerted that UE A and UE B are in proximity, it
cancels the location reporting for UE B and shall send a PROXIMITY_ALERT
message to UE B including the Application ID, Application Layer User ID A and
Application Layer User ID B.
Figure 7.2.5.2.1 illustrates the interaction of the UE and the ProSe Function
in the proximity alert procedure.
Figure 7.2.5.2.1: Proximity alert procedure
#### 7.2.5.3 Proximity alert procedure completion by the UE
Upon receipt of the PROXIMITY_ALERT message the UE shall inform the
application identified via the Application ID in the PROXIMITY_ALERT message
including Application Layer User ID A and Application Layer User ID B. If the
Assistance Information for WLAN direct discovery and communication is included
in the PROXIMITY_ALERT message, the UE uses this information to engage in WLAN
direct discovery and communication with the peer UE.
### 7.2.6 UE deregistration procedure
#### 7.2.6.1 General
The UE deregistration procedure is used to deregister the UE for EPC-level
ProSe discovery services. It can be initiated at any time by the UE or by the
ProSe Function residing in the HPLMN.
#### 7.2.6.2 UE-initiated UE deregistration procedure
##### 7.2.6.2.1 UE-initiated UE deregistration procedure initiation
When the UE decides to deregister for EPC-level ProSe discovery services, it
shall send the UE_DEREGISTRATION_REQUEST message to the ProSe Function
residing in the HPLMN. The message includes the EPC ProSe User ID.
Figure 7.2.6.2.1.1 illustrates the interaction of the UE and the ProSe
Function in the UE-initiated UE deregistration procedure.
Figure 7.2.6.2.1.1: UE-initiated UE deregistration procedure
##### 7.2.6.2.2 UE-initiated UE deregistration procedure accepted by the ProSe
Function
Upon receiving the UE_DEREGISTRATION_REQUEST message, the ProSe Function
retrieves the user profile based on the UE\'s EPC ProSe User ID included in
the UE_DEREGISTRATION_REQUEST message, cancels any ongoing proximity alert
procedures for this UE, clears the UE context and shall send a
UE_DEREGISTRATION_RESPONSE message to the UE.
##### 7.2.6.2.3 UE-initiated UE deregistration procedure completion by the UE
Upon receipt of the UE_DEREGISTRATION_RESPONSE message by the UE, the UE
deregistration procedure is complete.
#### 7.2.6.3 Network-initiated UE deregistration procedure
##### 7.2.6.3.1 Network-initiated UE deregistration procedure initiation
When the ProSe Function residing in the HPLMN decides to deregister the UE for
EPC-level ProSe discovery services, it shall send the
UE_DEREGISTRATION_REQUEST to the UE.
Figure 7.2.6.3.1.1 illustrates the interaction of the UE and the ProSe
Function in the network-initiated UE deregistration procedure.
Figure 7.2.6.3.1.1: Network-initiated UE deregistration procedure
##### 7.2.6.3.2 Network-initiated UE deregistration procedure in the UE
Upon receiving a UE_DEREGISTRATION_REQUEST message, the UE deletes all context
information related to EPC-level ProSe discovery and shall send a
UE_DEREGISTRATION_RESPONSE message to the network.
##### 7.2.6.3.3 Network-initiated UE deregistration procedure completion by
the network
Upon receipt of the UE_DEREGISTRATION_RESPONSE message by the ProSe Function
the UE deregistration procedure is complete.
### 7.2.7 Proximity request cancellation procedure
#### 7.2.7.1 General
The proximity request cancellation procedure is used by the UE or ProSe
Function to cancel an ongoing proximity request that was sent earlier as
defined in 3GPP TS 23.303 [2]. The UE initiates the proximity request
cancellation procedure due to occurrence of certain event (e.g.termination of
the corresponding application). The ProSe Function initiates the proximity
request cancellation procedure (e.g. due to excess of time window).
#### 7.2.7.2 UE initiated proximity request cancellation procedure
##### 7.2.7.2.1 Initiation of UE initiated proximity request cancellation
procedure
The UE initiates the proximity request cancellation procedure by sending a
CANCEL_PROXIMITY_REQUEST message to the ProSe Function including a new
transaction ID, the UE\'s EPC ProSe User ID, the Application ID for the
application for which the cancellation is being made and the targeted user\'s
Application Layer User ID B.
NOTE: A UE can include one or multiple transactions in one
CANCEL_PROXIMITY_REQUEST message for different Application IDs, and receive
corresponding CANCEL_PROXIMITY_RESPONSE message for each respective
transaction. In the following description of the proximity request
cancellation procedure, only one transaction is included.
Figure 7.2.7.2.1.1 illustrates the interaction of the UE and the ProSe
Function in the UE initiated proximity request cancellation procedure.
Figure 7.2.7.2.1.1: UE initiated proximity request cancellation procedure
##### 7.2.7.2.2 UE initiated proximity request cancellation procedure handling
by the ProSe Function
Upon receiving a CANCEL_PROXIMITY_REQUEST message from UE A, ProSe Function A
retrieves the user profile of UE A based on UE A\'s EPC ProSe User ID included
in the CANCEL_PROXIMITY_REQUEST message. ProSe Function A then uses the
Application ID and Application Layer User ID B to identify the ProSe Function
identifier of ProSe Function B which owns the context of the targeted user and
forwards the cancellation request towards ProSe Function B as defined in 3GPP
TS 29.345 [5].
The ProSe Function A shall send a CANCEL_PROXIMITY_RESPONSE message to UE A
with transaction ID set to the value of the transaction ID received in the
CANCEL_PROXIMITY_REQUEST message from UE A. If UE A has no other ongoing
proximity requests then ProSe Function A cancels the location reporting for UE
A.
##### 7.2.7.2.3 UE initiated proximity request cancellation procedure
completion by the UE
Upon receipt of the CANCEL_PROXIMITY_RESPONSE message with transaction ID set
to the value of the transaction ID received in the CANCEL_PROXIMITY_REQUEST
message, the UE A shall abort the proximity request procedure and the UE
initiated proximity request cancellation procedure is complete.
#### 7.2.7.3 ProSe Function initiated proximity request cancellation procedure
##### 7.2.7.3.1 Initiation of ProSe Function initiated proximity request
cancellation procedure
The ProSe Function initiates the proximity request cancellation procedure by
retrieving the user profile of UE A based on UE A\'s EPC ProSe User ID
included in the PROXIMITY_REQUEST message sent by UE A earlier.
The ProSe Function A shall send a CANCEL_PROXIMITY_REQUEST message to UE A
with transaction ID set to the value of the transaction ID received in the
PROXIMITY_REQUEST message from UE A, the UE A\'s EPC ProSe User ID, the
Application ID for the application for which the cancellation is being made
and the targeted user\'s Application Layer User ID B. If UE A has no other
ongoing proximity requests then ProSe Function A cancels the location
reporting for UE A.
NOTE: A ProSe Function can include one or multiple transactions in one
CANCEL_PROXIMITY_REQUEST message for each respective transaction. In the
following description of the proximity request cancellation procedure, only
one transaction is included.
Figure 7.2.7.3.1.1 illustrates the ProSe Function initiated proximity request
cancellation procedure.
Figure 7.2.7.3.1.1: ProSe Function initiated proximity request cancellation
procedure
##### 7.2.7.3.2 ProSe initiated proximity request cancellation procedure
handling by the UE
Upon receiving a CANCEL_PROXIMITY_REQUEST message from ProSe Function A, the
UE A shall abort the proximity request procedure and send a
CANCEL_PROXIMITY_RESPONSE message to ProSe Function A with transaction ID set
to the value of the transaction ID received in the CANCEL_PROXIMITY_REQUEST
message from ProSe Function A.
##### 7.2.7.3.3 ProSe Function initiated proximity request cancellation
procedure completion by the ProSe Function
Upon receipt of the CANCEL_PROXIMITY_RESPONSE message by ProSe Function A, the
ProSe Function initiated proximity request cancellation procedure is complete.
### 7.2.8 Proximity request Validation procedure
#### 7.2.8.1 General
If the targeted UE\'s profile indicates that the proximity requests for the UE
need to be explicitly validated then the network uses the proximity request
validation procedure to request the targeted UE (UE B) to confirm permission
for the proximity requests (e.g. user B may have temporarily disabled the
ProSe functionality on UE B). It is initiated by the ProSe Function residing
in the HPLMN as part of the overall proximity request procedure defined in
3GPP TS 23.303 [2].
#### 7.2.8.2 Initiation of the proximity request validation procedure
Upon reception of a proximity request from UE A, the ProSe Function on the
targeted UE side (B-side) retrieves the stored profile of UE B. If UE B\'s
profile indicates that the proximity requests for UE B need to be explicitly
validated, ProSe Function B shall send the PROXIMITY_REQUEST_VALIDATION
message to UE B including the Application ID of the application for which the
proximity request is being validated.
Figure 7.2.8.2.1 illustrates the interaction of the targeted UE and the ProSe
Function in the proximity request validation procedure.
Figure 7.2.8.2.1: Proximity request validation procedure
#### 7.2.8.3 Proximity request validation procedure in the UE
Upon receiving a PROXIMITY_REQUEST_VALIDATION message, UE B checks whether the
application corresponding to the Application ID included in the message is
ready for accepting a proximity request from other users.
If the application corresponding to the Application ID contained in the
PROXIMITY_REQUEST_VALIDATION message is ready for accepting proximity requests
from other users, the targeted UE shall send the
PROXIMITY_REQUEST_VALIDATION_RESPONSE message to the ProSe Function.
If the application corresponding to the Application ID contained in the
PROXIMITY_REQUEST_VALIDATION message is not ready for accepting proximity
requests from other users, the targeted UE shall send the
PROXIMITY_REQUEST_VALIDATION_RESPONSE message with PC3 EPC Control Protocol
cause value #9 \"Application disabled temporarily\".
#### 7.2.8.4 Proximity request validation procedure completion by the network
Upon receipt of the PROXIMITY_REQUEST_VALIDATION_RESPONSE message containing a
\ element, ProSe Function B initiates location reporting for
UE B and acknowledges the proximity request towards ProSe Function A.
Upon receipt of the PROXIMITY_REQUEST_VALIDATION_RESPONSE message containing a
\ element, ProSe Function B forwards an indication towards
ProSe Function A that the proximity request is rejected.
### 7.2.9 Abnormal cases
#### 7.2.9.1 Abnormal cases in the UE
In case of the messages listed below:
\- UE_REGISTRATION_REQUEST;
\- APPLICATION_REGISTRATION_REQUEST;
\- PROXIMITY_REQUEST;
\- UE_DEREGISTRATION_REQUEST;
\- CANCEL_PROXIMITY_REQUEST; and
\- PROXIMITY_REQUEST_VALIDATION.
the following abnormal cases can be identified.
a) Indication from transport layer of transmission failure of a message (e.g.
after TCP retransmission timeout)
The UE shall close the existing connection to the ProSe Function, establish a
new connection and then restart the appropriate procedure.
b) No response from the ProSe Function after a message has been successfully
delivered (e.g. TCP ACK has not been received)
The UE shall retransmit the message.
#### 7.2.9.2 Abnormal cases in the ProSe Function
In case of the messages listed below:
\- UE_REGISTRATION_RESPONSE;
\- APPLICATION_REGISTRATION_RESPONSE;
\- PROXIMITY_REQUEST_RESPONSE;
\- PROXIMITY_ALERT;
\- UE_DEREGISTRATION_RESPONSE;
\- CANCEL_PROXIMITY_RESPONSE; and
\- PROXIMITY_REQUEST_VALIDATION_RESPONSE.
the following abnormal cases can be identified.
a) Indication from the lower layer of transmission failure of a message
After receiving an indication from lower layer that a message has not been
successfully acknowledged (e.g. TCP ACK is not received), the ProSe Function
shall abort the procedure.
# 8 EPC support for WLAN direct discovery and communication
In this release of the document, the stand-alone procedure for EPC support for
WLAN direct discovery and communication is not supported.
# 9 Handling of unknown, unforeseen, and erroneous protocol data
## 9.1 General
The procedures specified in the present document apply to those PC3 or PC5
messages which pass the checks described in this subclause.
This subclause also specifies procedures for the handling of unknown,
unforeseen, and erroneous protocol data by the receiving entity. These
procedures are called \"error handling procedures\", but in addition to
providing recovery mechanisms for error situations they define a compatibility
mechanism for future extensions of the protocols.
Detailed error handling procedures in the network are implementation dependent
and may vary from PLMN to PLMN. However, when extensions of this protocol are
developed, networks will be assumed to have the error handling that is
indicated in this subclause as mandatory (\"shall\") and that is indicated as
strongly recommended (\"should\").
Also, the error handling of the network is only considered as mandatory or
strongly recommended when certain thresholds for errors are not reached during
a dedicated connection.
## 9.2 Handling of unknown, unforeseen, and erroneous protocol data in
messages sent over the PC5 interface
### 9.2.1 Message too short
When a message is received that is too short to contain a complete message
type parameter, that message shall be ignored.
### 9.2.2 Unknown or unforeseen message type
If the UE receives a PC5_DISCOVERY message with Message Type not defined as in
subclause 12.2.2.10, it shall discard the whole PC5_DISCOVERY message.
If the UE receives a PC5_DISCOVERY message with Message Type indicating a
discovery model or discovery type that is not supported by the UE, it shall
discard the whole PC5_DISCOVERY message.
## 9.3 Handling of unknown, unforeseen, and erroneous protocol data in
messages sent over the PC3 interface
### 9.3.1 Invalid XML
The protocol data over PC3 interface are encapsulated as XML contents, which
may contain one or more PC3 messages. The XML content shall be validated with
the XML schema defined in subclause 11.2.3.
When the UE receives an invalid XML content, it shall discard the whole XML
content. When the ProSe Function receives an invalid XML content, it shall
discard the whole XML document and send an HTTP response message containing a
\"400 Bad Request\" error code to the UE.
### 9.3.2 Unforeseen message type
If the UE receives a PC3 message with a message type corresponding to a ProSe
discovery mechanism that the UE is not authorised to use by the network, the
UE shall discard the message. For example, if a UE not authorised for EPC-
level ProSe discovery receives messages specified for EPC-level ProSe
discovery procedures in subclause 7, the UE shall discard the message.
If the ProSe Function receives a PC3 message whose message type indicates that
this is a ProSe discovery mechanism the sending UE is not authorised to
support, the ProSe Function shall discard the message.
# 10 ProSe direct communication
## 10.1 General
This clause describes the procedures at the UE, and between UEs, for ProSe
direct communication over the PC5 interface.
When served by E-UTRAN, the UE shall be authorised for ProSe direct
communication in the registered PLMN based on the service authorisation
procedure as specified in clause 5, before initiating ProSe direct
communication.
When not served by E-UTRAN, the UE shall be authorised for ProSe direct
communication for \"not served by E-UTRAN\" based on the service authorisation
procedure as specified in subclause 5, before initiating ProSe direct
communication.
## 10.2 One-to-many ProSe direct communication
### 10.2.1 General
One-to-many ProSe direct communication is applicable only to ProSe-enabled
Public Safety UEs. One-to-many ProSe direct communication can only apply when
the UE is:
a) served by E-UTRAN and authorised for ProSe direct communication in the
registered PLMN;
b) not served by E-UTRAN, and authorised for ProSe direct communication for
\"not served by E-UTRAN\"; or
c) in EMM-IDLE mode and in limited service state as specified in 3GPP TS
23.122 [24] and authorised for ProSe direct communication when \"not served by
E-UTRAN\", if the reason for the UE being in limited service state is one of
the following:
i) the UE is unable to find a suitable cell in the selected PLMN as specified
in 3GPP TS 36.304 [23];
ii) the UE received an ATTACH REJECT message or a TRACKING AREA UPDATE REJECT
message or a SERVICE REJECT message with the EMM cause #11 \"PLMN not
allowed\" as specified in 3GPP TS 24.301 [11] or a LOCATION UPDATING REJECT
message or a GPRS ATTACH REJECT message or ROUTING AREA UPDATE REJECT message
or SERVICE REJECT message with cause #11 \"PLMN not allowed\" as specified in
3GPP TS 24.008 [30]; or
iii) the UE received an ATTACH REJECT message or a TRACKING AREA UPDATE REJECT
message or a SERVICE REJECT message with the EMM cause #7 \"EPS services not
allowed\" as specified in 3GPP TS 24.301 [11] or a LOCATION UPDATING REJECT
message or a GPRS ATTACH REJECT message or ROUTING AREA UPDATE REJECT message
or SERVICE REJECT message with cause #7 \"GPRS services not allowed\" as
specified in 3GPP TS 24.008 [30].
Upon receiving a request from upper layers to send or receive data for ProSe
direct communication in a given group, the UE shall initiate the procedure for
ProSe direct communication. For case a, the UE shall perform ProSe direct
communication procedures specified in subclause 10.2.2. For case b and c, the
UE shall perform ProSe direct communication procedures specified in subclause
10.2.3.
If the UE is camped on an E-UTRAN cell not operating on the carrier frequency
provisioned for ProSe direct communication which indicates that ProSe direct
communication is supported by the network, the UE can perform either ProSe
direct communication procedures specified in subclause 10.2.2 or ProSe direct
communication procedures specified in subclause 10.2.3.
The UE shall obtain the ProSe direct communication policy parameters for that
group as specified in subclause 5, except for the eMBMS content to be relayed
by one-to-many ProSe direct communication as specified in subclause 10.2.4.2.
If the ProSe direct communication policy parameters indicate that the UE is
configured to use IPv6 for that group, the UE shall auto-configures a link
local IPv6 Address following procedures defined in RFC 4862 [15]. This address
can only be used as the source IP address for one-to-many ProSe direct
communication.
If the ProSe Direct communication policy parameters group indicate that the UE
is configured to use IPv4 for that group, then the UE shall:
\- use the configured IPv4 address for that group as source address; or
\- if there is no configured IPv4 address for that group, use Dynamic
Configuration of IPv4 Link-Local Addresses as specified in IETF RFC 3927 [16].
### 10.2.2 ProSe direct communication facilitated by serving E-UTRAN
When the UE is served by E-UTRAN and intends to use the ProSe radio resources
(i.e. carrier frequency) provided by an E-UTRAN cell, the UE requests the
parameters from the lower layers for transmitting or receiving ProSe direct
communication (see 3GPP TS 36.331 [12]). When requesting the parameters from
the lower layers for transmitting or receiving ProSe direct communication, the
UE shall indicate to lower layers the ProSe Per-Packet Reliability (PPPR)
value, if received from the upper layers. The UE shall perform direct
communication only if the lower layers indicate that ProSe direct
communication is supported by the network. If the UE in EMM-IDLE mode has to
request resources for ProSe direct communication as specified in 3GPP TS
36.331 [12], the UE shall perform a service request procedure or tracking area
update procedure as specified in 3GPP TS 24.301 [11]. Once the radio resources
for transmitting or receiving ProSe direct communication are provided by
eNodeB as specified in 3GPP TS 36.331 [12], the UE shall start ProSe direct
communication.
### 10.2.3 Procedure for UE to use provisioned radio resources
When the UE is not served by E-UTRAN, the UE shall select the radio parameters
to be used for ProSe direct communication as follows:
\- if the UE can determine itself located in a geographical area, and the UE
is provisioned with radio parameters for the geographical area, the UE shall
select the radio parameters associated with that geographical area; or
\- in all other cases, the UE shall not initiate ProSe direct communication.
NOTE 1: It is out of scope of the present specification to define how the UE
can locate itself in a specific Geographical Area. When the UE is in coverage
of a 3GPP RAT it can for example use information derived from the serving
PLMN. When the UE is not in coverage of a 3GPP RAT it can use other techniques
as determined by local regulations.
Before initiating ProSe direct communication, the UE shall check with lower
layers whether the selected radio parameters can be used in the current
location without causing interference to other cells as specified in 3GPP TS
36.331 [12], and:
\- if the lower layers indicate that the usage would not cause any
interference, the UE shall initiate ProSe direct communication; or
NOTE 2: If the lower layers find that there exists a cell operating the
provisioned radio resources (i.e., carrier frequency), and the cell belongs to
the registered PLMN or a PLMN equivalent to the registered PLMN, and the UE is
authorized for ProSe direct communication in this PLMN, the UE can use the
radio parameters indicated by the cell as specified in 3GPP TS 36.331 [12].
\- else if the lower layers report that one or more PLMNs operate in the
provisioned radio resources (i.e. carrier frequency) then:
a) if the following conditions are met:
1) none of the PLMNs reported by the lower layers is the registered PLMN or
equivalent to the registered PLMN; and
2) at least one of the PLMNs reported by the lower layers is in the list of
authorised PLMNs for ProSe direct communication and provides radio resources
for ProSe direct communication as specified in 3GPP TS 36.331 [12];
then the UE shall:
1) if in EMM-IDLE mode, perform PLMN selection triggered by ProSe direct
communication as specified in 3GPP TS 23.122 [24]; or
2) else if in EMM-CONNECTED mode, either:
i) perform a detach procedure as specified in 3GPP TS 24.301 [11] and then
perform PLMN selection triggered by ProSe direct communication as specified in
3GPP TS 23.122 [24]; or
ii) not initiate ProSe direct communication.
Whether the UE performs i) or ii) above is left up to UE implementation; or
b) else the UE shall not initiate ProSe direct communication.
If the registration to the selected PLMN is successful, the UE shall proceed
with the procedure to initiate ProSe direct communication as specified in
subclause 10.2.2.
If the UE is performing ProSe direct communication using radio parameters
associated with a geographical area and moves out of that geographical area,
the UE shall stop performing ProSe direct communication and then:
\- if the UE is not served by E-UTRAN or the UE intends to use radio resources
for ProSe other than those operated by the serving E-UTRAN cell, the UE shall
select appropriate radio parameters for the new geographical area as specified
above; or
\- if the UE is served by E-UTRAN and intends to use radio resources for ProSe
operated by the serving E-UTRAN cell, the UE shall proceed with the procedure
to initiate ProSe direct communication when served by E-UTRAN.
### 10.2.4 One-to-many ProSe direct communication transmission
#### 10.2.4.1 General
When receiving user data from upper layers to be sent to a given group, the
transmitting UE shall tag each outgoing protocol data unit with the following
information before passing it to the lower layers for transmission:
\- a Layer-3 protocol data unit type (see 3GPP TS 36.323 [37]) set to:
a) IP packet; or
b) Address Resolution Protocol packet;
\- the Source Layer-2 ID set to the ProSe UE ID assigned from the ProSe Key
Management Function or self-assigned by the UE;
\- the Destination Layer-2 ID set to the ProSe Layer-2 Group ID;
\- the ProSe Per-Packet Priority associated with the protocol data unit; and
\- the ProSe Per-Packet Reliability (PPPR), if received from the upper layers.
The UE shall choose from a range of eight possible values to indicate the
required ProSe Per-Packet Priority related to the lower layer handling of this
packet data unit. The ProSe Per-Packet Priority is selected by the application
layer based on criteria that are outside the scope of this specification, and
is independent of the ProSe Layer-2 Group ID, which is used as the Layer 2
destination address for this packet data unit.
#### 10.2.4.2 eMBMS traffic relay
A ProSe UE-to-network relay UE acting as an eMBMS traffic relay shall use one-
to-many ProSe direct communication to broadcast the eMBMS traffic received
from the network only if the following conditions are met:
\- the ProSe UE-to-network relay UE has detected the TMGI value which it has
been requested to monitor during the TMGI monitoring request procedure as
specified in subclause 10.5; and
\- the ProSe UE-to-network relay UE has announced the PC5_DISCOVERY message
for Relay Discovery Additional Information, which includes the detected TMGI
value and the corresponding ProSe Layer 2 Group ID to be used for the one-to-
many communication packets carrying the relayed eMBMS traffic associated with
this TMGI value.
For eMBMS traffic relayed by the ProSe UE-to-network relay UE, the ProSe UE-
to-network relay UE uses the ProSe Per-Packet Priority that is included in
TMGI_MONITORING_REQUEST message to determine the ProSe Per-Packet Priority
value to be applied for the one-to-many communication packets corresponding to
that TMGI when they are relayed over PC5.
NOTE: It is assumed that the remote UE receives the QCI associated with the
TMGI at the application layer along with an associated priority value that the
application layer in the remote UE maps into a ProSe Per-Packet Priority.
For eMBMS traffic relayed by the ProSe UE-to-network relay UE, bearer-level
security mechanisms specified in 3GPP TS 33.303 [6] shall not be applied.
The ProSe UE-to-network relay UE acting as an eMBMS traffic relay shall stop
the one-to-many ProSe direct communication, if any of the following conditions
is met:
\- the TMGI value corresponding to the relayed eMBMS traffic can no longer be
detected by the ProSe UE-to-network relay UE; or
\- There is no longer any remote UE requesting to monitor the TMGI value
corresponding to the relayed eMBMS traffic, i.e., the T4105 timer for this
TMGI (see subclause 10.5) expires.
## 10.3 PC3ch Control Protocol for ProSe direct communication
### 10.3.1 Transport protocol for PC3ch Control Protocol for ProSe direct
communication
The UE and ProSe Function CTF (ADF) shall use HTTP 1.1 as specified in IETF
RFC 7230 [18] and IETF RFC 7231 [19] as the transport protocol for messages
transmitted over the PC3ch interface. The ProSe messages described here shall
be included in the body of either an HTTP request message or an HTTP response
message. The following rules apply:
a) The UE initiates ProSe transactions with an HTTP request message containing
the PC3ch request(s).
b) The ProSe Function CTF (ADF) responds to the requests with an HTTP response
message containing the PC3ch response(s) for the PC3ch request(s); and
c) HTTP POST methods are used for PC3ch procedures.
Optionally, the operator can configure the UE with configuration parameters
for establishment of the PDN connection for reaching the HPLMN ProSe Function.
If the UE is configured with the configuration parameter for establishment of
the PDN connection for reaching the HPLMN ProSe Function (see 3GPP TS 24.333
[9]):
a) if a PDN connection for reaching the HPLMN ProSe Function is not
established yet, the UE shall establish the PDN connection for reaching the
HPLMN ProSe Function according to the UE configuration and shall send the HTTP
request message via the PDN connection for reaching the HPLMN ProSe Function;
and
b) if a PDN connection for reaching the HPLMN ProSe Function is already
established (e.g. either due to other ProSe feature or due to other
application), the UE shall send the HTTP request message via the PDN
connection for reaching the HPLMN ProSe Function;
### 10.3.2 Procedures for PC3ch Control Protocol for ProSe direct
communication
#### 10.3.2.1 Usage information report list sending procedure
##### 10.3.2.1.1 General
The purpose of the usage information report list sending procedure is to
enable a ProSe-enabled Public Safety UE to provide information necessary for
composing of charging events related to the ProSe direct communication as
defined in 3GPP TS 32.277 [27].
The UE shall perform the usage information report list sending procedure with
the Accounting Data Forwarding (ADF) function block of the Charging Trigger
Function (CTF) in the ProSe Function (ProSe Function CTF (ADF)) residing in
the HPLMN.
The UE shall construct the usage information report based on the policy
described in subclause 5.1.3.
##### 10.3.2.1.2 Usage information report list sending procedure initiation
The UE shall perform the usage information report list sending procedure if
the UE is in E-UTRAN coverage and if:
a) the following is true:
1) if a usage information report list sending procedure was already performed
after beginning of ProSe direct communication, the configured collection
period has elapsed since the end of the previous usage information report list
sending procedure;
2) if a usage information report list sending procedure was not performed yet
after beginning of ProSe direct communication, the configured collection
period has elapsed since beginning of ProSe direct communication;
3) the configured reporting window has not elapsed after the configured
collection period elapsed;
4) the UE is in the RRC CONNECTED mode; and
5) the UE has usage information for at least one collection period; or
b) the following is true:
1) if a usage information report list sending procedure was already performed
after beginning of ProSe direct communication, the configured collection
period has elapsed since the end of the previous usage information report list
sending procedure;
2) if a usage information report list sending procedure was not performed yet
after beginning of ProSe direct communication, the configured collection
period has elapsed since beginning of ProSe direct communication;
3) the configured reporting window has elapsed after the configured collection
period elapsed; and
4) the UE has usage information for at least one collection period.
The UE shall initiate the usage information report list sending procedure by
sending a USAGE_INFORMATION_REPORT_LIST message to the ProSe Function CTF
(ADF).
If the UE is configured with the IP address of the ProSe Function CTF (ADF),
the UE shall send the USAGE_INFORMATION_REPORT_LIST message to the configured
IP address of the ProSe Function CTF (ADF). If the UE is not configured with
the IP address of the ProSe Function CTF (ADF), the UE shall send the
USAGE_INFORMATION_REPORT_LIST message to the IP address of the ProSe Function
discovered as described in subclause 5.1.2.
In the USAGE_INFORMATION_REPORT_LIST message, the UE:
a) shall include a new transaction ID;
b) shall include the UE identity set to the UE\'s IMSI;
c) for each collection period:
1) shall include a sequence number of the usage information report;
2) if the UE is configured to report the time stamps when it went in and out
of E-UTRAN coverage during the collection period in the usage information, for
each going in or out of E-UTRAN coverage:
A) shall include information whether the UE was in or out of E-UTRAN coverage;
B) shall include the time stamp of the move; and
C) if the UE was in E-UTRAN coverage and the UE is configured to report the
list of locations of the UE when in E-UTRAN coverage during the collection
period in the usage information, for each camping on a cell or usage of a cell
in the EMM-CONNECTED mode:
i) shall include the E-UTRAN cell global identification of the cell; and
ii) shall include the time stamp of beginning of the camping on the cell or of
beginning of the usage of the cell in the EMM-CONNECTED mode;
3) if the UE is configured to report the group parameters in the usage
information, for each group:
A) shall include the ProSe Layer-2 Group ID;
B) shall include the ProSe Group IP multicast address;
C) if the UE transmitted data during the collection period and the UE is
configured to report the time stamps of the first transmission/reception
during the collection period in the usage information, shall include the time
stamp of the first transmission to the ProSe Group IP multicast address in the
collection period;
D) if the UE received data during the collection period and the UE is
configured to report the time stamps of the first transmission/reception
during the collection period in the usage information, shall include the time
stamp of the first reception from the ProSe Group IP multicast address in the
collection period;
E) shall include an IP address used by the UE as a source address;
F) shall include the ProSe UE ID;
G) for each transmitter in one-to-many ProSe direct communication, shall
include the Source L2 ID and IP address of the transmitter;
H) if the UE is configured to report the amount of data transmitted during the
collection period with location information in the usage information, per each
in or out of E-UTRAN coverage period and per each E-UTRAN cell used when in
E-UTRAN coverage:
i) shall indicate whether the data are sent in or out of E-UTRAN coverage;
ii) if the UE transmitted data in an E-UTRAN cell during an in E-UTRAN
coverage period:
\- shall include the E-UTRAN cell global identification of the E-UTRAN cell;
\- shall include amount of the data transmitted in the E-UTRAN cell;
\- if the UE is configured to report the time stamps of the first
transmission/reception during the collection period in the usage information,
shall include time stamp of the first transmission in the E-UTRAN cell; and
\- if the UE is configured to report the radio parameters used for ProSe
direct communication (i.e. indicator of which radio resources used and radio
frequency used) during the reporting period in the usage information, shall
include the indicator of which radio resources were used;
iii) if the UE transmitted data during out of E-UTRAN coverage period:
\- shall include amount of the data transmitted during the out of E-UTRAN
coverage period; and
\- if the UE is configured to report the time stamps of the first
transmission/reception during the collection period in the usage information,
shall include time stamp of the first transmission during the out of E-UTRAN
coverage period; and
iv) if the UE is configured to report the radio parameters used for ProSe
direct communication (i.e. indicator of which radio resources used and radio
frequency used) during the reporting period in the usage information, shall
include the used radio frequency; and
I) if the UE is configured to report the amount of data transmitted during the
collection period without location information in the usage information, per
each in or out of E-UTRAN coverage period:
i) shall indicate whether the data are sent in or out of E-UTRAN coverage;
ii) if the UE transmitted data during in E-UTRAN coverage period:
\- shall include amount of the data transmitted during the in E-UTRAN coverage
period;
\- if the UE is configured to report the time stamps of the first
transmission/reception during the collection period in the usage information,
shall include time stamp of the first transmission during the in E-UTRAN
coverage period; and
\- if the UE is configured to report the radio parameters used for ProSe
direct communication (i.e. indicator of which radio resources used and radio
frequency used) during the reporting period in the usage information, shall
include the indicator of which radio resources were used;
iii) if the UE transmitted data during out of E-UTRAN coverage period:
\- shall include amount of the data transmitted during the out of E-UTRAN
coverage period; and
\- if the UE is configured to report the time stamps of the first
transmission/reception during the collection period in the usage information,
shall include time stamp of the first transmission during the out of E-UTRAN
coverage period; and
iv) if the UE is configured to report the radio parameters used for ProSe
direct communication (i.e. indicator of which radio resources used and radio
frequency used) during the reporting period in the usage information, shall
include the used radio frequency; and
J) if the UE is configured to report the amount of data received during the
collection period with location information in the usage information, per each
in or out of E-UTRAN coverage period and per each E-UTRAN cell used when in
E-UTRAN coverage:
i) shall indicate whether the data are sent in or out of E-UTRAN coverage;
ii) if the UE received data in an E-UTRAN cell during an in E-UTRAN coverage
period:
\- shall include the E-UTRAN cell global identification of the E-UTRAN cell;
\- shall include amount of the data received in the E-UTRAN cell;
\- if the UE is configured to report the time stamps of the first
transmission/reception during the collection period in the usage information,
shall include time stamp of the first reception in the E-UTRAN cell; and
\- if the UE is configured to report the radio parameters used for ProSe
direct communication (i.e. indicator of which radio resources used and radio
frequency used) during the reporting period in the usage information, shall
include the indicator of which radio resources were used;
iii) if the UE received data during out of E-UTRAN coverage period:
\- shall include amount of the data received during the out of E-UTRAN
coverage period; and
\- if the UE is configured to report the time stamps of the first
transmission/reception during the collection period in the usage information,
shall include time stamp of the first reception during the out of E-UTRAN
coverage period; and
iv) if the UE is configured to report the radio parameters used for ProSe
direct communication (i.e. indicator of which radio resources used and radio
frequency used) during the reporting period in the usage information, shall
include the used radio frequency; and
K) if the UE is configured to report the amount of data received during the
collection period without location information in the usage information, per
each in or out of E-UTRAN coverage period:
i) shall indicate whether the data are sent in or out of E-UTRAN coverage;
ii) if the UE received data during in E-UTRAN coverage period:
\- shall include amount of the data received during the in E-UTRAN coverage
period;
\- if the UE is configured to report the time stamps of the first
transmission/reception during the collection period in the usage information,
shall include time stamp of the first reception during the in E-UTRAN coverage
period; and
\- if the UE is configured to report the radio parameters used for ProSe
direct communication (i.e. indicator of which radio resources used and radio
frequency used) during the reporting period in the usage information, shall
include the indicator of which radio resources were used;
iii) if the UE received data during out of E-UTRAN coverage period:
\- shall include amount of the data received during the out of E-UTRAN
coverage period; and
\- if the UE is configured to report the time stamps of the first
transmission/reception during the collection period in the usage information,
shall include time stamp of the first reception during the out of E-UTRAN
coverage period; and
iv) if the UE is configured to report the radio parameters used for ProSe
direct communication (i.e. indicator of which radio resources used and radio
frequency used) during the reporting period in the usage information, shall
include the used radio frequency; and
4) if configured radio parameters for the ProSe direct communication
applicable in the geographical area of the UE were used during the collection
period, shall include the configured radio parameters for the ProSe direct
communication applicable in the geographical area of the UE; and
d) for each application specific data received from upper layers during the
collection period, shall include the received application specific data.
Figure 10.3.2.1.2.1 illustrates the interaction of the UE and the ProSe
Function CTF (ADF) in the usage information report list sending procedure.
Figure 10.3.2.1.2.1: Usage information report list sending procedure
##### 10.3.2.1.3 Usage information report list sending procedure accepted by
the ProSe Function
Upon receiving a USAGE_INFORMATION_REPORT_LIST message from UE, the ProSe
Function CTF (ADF) triggers one or more charging data requests according to
3GPP TS 32.277 [27].
If the USAGE_INFORMATION_REPORT_LIST message is accepted by the ProSe Function
CTF (ADF), the ProSe Function CTF (ADF) shall send a
USAGE_INFORMATION_REPORT_LIST_RESPONSE message to the UE, containing a
\ element with transaction ID set to the value of the
transaction ID included in the USAGE_INFORMATION_REPORT_LIST message.
##### 10.3.2.1.4 Usage information report list sending procedure successful
completion by the UE
Upon receipt of the USAGE_INFORMATION_REPORT_LIST_RESPONSE message containing
a \ element with transaction ID set to the value of the
transaction ID included in the USAGE_INFORMATION_REPORT_LIST message, the
usage information report list sending procedure is successfully completed.
##### 10.3.2.1.5 Usage information report list sending procedure not accepted
by the ProSe Function
If the USAGE_INFORMATION_REPORT_LIST message is not accepted by the ProSe
Function CTF (ADF), the ProSe Function CTF (ADF) shall send a
USAGE_INFORMATION_REPORT_LIST_RESPONSE message to the UE. In the
USAGE_INFORMATION_REPORT_LIST_RESPONSE message, the ProSe Function CTF (ADF):
1) shall include a \ element with transaction ID set to the
value of the transaction ID included in the USAGE_INFORMATION_REPORT_LIST
message; and
2) shall include appropriate cause value.
##### 10.3.2.1.6 Usage information report list sending procedure unsuccessful
completion by the UE
Upon receipt of the USAGE_INFORMATION_REPORT_LIST_RESPONSE message containing
a \ element with transaction ID set to the value of the
transaction ID included in the USAGE_INFORMATION_REPORT_LIST message, the
usage information report list sending procedure is unsuccessfully completed.
If the USAGE_INFORMATION_REPORT_LIST_RESPONSE message contains the cause value
set to #3 \"Invalid Message Format\", the UE shall not perform the usage
information report list sending procedure until the UE powers off and powers
on again or the USIM is removed.
## 10.4 One-to-one ProSe direct communication
### 10.4.1 Overview
This clause describes the PC5 Signalling Protocol procedures between two
ProSe-enabled UEs for one-to-one ProSe direct communication.The following PC5
Signalling Protocol procedures are defined:
\- direct link setup;
\- direct link keepalive;
\- direct link release; and
\- direct link authentication.
### 10.4.1A Radio resource selection
The UE shall be authorised for one-to-one ProSe direct communication and
obtain the ProSe direct communication policy parameters based on the service
authorisation procedure as specified in clause 5 before initiating or
participating in any PC5 Signalling Protocol procedures for one-to-one ProSe
direct communication.
The UE shall select the radio resources for one-to-one ProSe direct
communication as described for one-to-many ProSe direct communication in
subclauses 10.2.1, 10.2.2 and 10.2.3.
For one-to-one communication between a remote UE and a ProSe UE-to-network
relay UE, if the remote UE receives a lower layers indication that using radio
resources for relay communication is not allowed as specified in 3GPP TS
36.331 [12], the remote UE shall abort any ongoing procedures involving a
relay (i.e., PC5 signalling Protocol procedures and data
transmission/reception) and start an implementation specific timer with value
T. While this timer is running, the remote UE shall not initiate any
procedures involving a relay. If the remote UE receives lower layers
indication that using radio resources for relay communication is allowed as
specified in 3GPP TS 36.331 [12], the remote UE shall stop the implementation
specific timer and can resume any procedures involving a relay. Otherwise,
after the implementation specific timer expires, the remote UE shall release
all direct links used for communication with relay(s) locally.
NOTE: The length of T is UE implementation specific.
### 10.4.2 Direct link setup procedure
#### 10.4.2.1 General
The direct link setup procedure is used to establish a secure direct link
between two ProSe-enabled UEs. The UE sending the request message is called
the \"initiating UE\"and the other UE is called the \"target UE\".
If the direct link setup is for isolated one-to-one ProSe direct
communication, i.e. when none of the two UEs is a ProSe UE-to-network relay,
both UEs are required to have fetched in advance the public key of the KMS
(Key Management Server), and a set of credentials associated with the UE\'s
identity (as defined in IETF RFC 6507 [39] and IETF RFC 6508 [40]), as
specified by 3GPP TS 33.303 [6].
#### 10.4.2.2 Direct link setup procedure initiation by initiating UE
The initiating UE shall meet the following pre-conditions before initiating
this procedure:
\- a request from upper layers to establish a direct link with the target UE
is received and there is no existing link between the initiating UE and that
target UE;
\- the link layer identifier for the initiating UE (i.e., Layer 2 ID used for
unicast communication) is available (e.g.,pre-configured or self-assigned);
\- the link layer identifier for the target UE (i.e., Layer 2 ID used for
unicast communication) is available to the initiating UE (e.g., pre-configured
or obtained via ProSe direct discovery); and
\- the initiating UE is either authorised for ProSe direct communication in
the serving PLMN, or has a valid authorization for ProSe direct communication
when not served by E-UTRAN.
The initiating UE initiates the direct link setup procedure by generating a
DIRECT_COMMUNICATION_REQUEST message with:
\- the User Info set to:
\- the initiating UE's User Info received from upper layers if the target UE
is not a ProSe UE-to-network relay UE;
\- the PRUK ID received from the PKMF if the target UE is a ProSe UE-to-
network relay UE, the initiating UE has received a PRUK from the PKMF for this
relay, and an attempt to connect to this relay has not been rejected due to
the PRUK ID not being recognised;
\- the initiating UE's IMSI if the target UE is a ProSe UE-to-network relay UE
and the initiating UE has not received a PRUK from the PKMF for this relay; or
\- the initiating UE's IMSI if the target UE is a ProSe UE-to-network relay UE
and the initiating UE has received a PRUK from the PKMF for this relay but an
attempt to connect to this relay has been rejected due to the PRUK ID not
being recognised;
\- an IP Address Config IE set to one of the following values:
\- \"DHCPv4 Server\" if only IPv4 address allocation mechanism is supported by
the initiating UE, i.e., acting as a DHCPv4 Server;
\- \"IPv6 Router\" if only IPv6 address allocation mechanism is supported by
the initiating UE, i.e., acting as an IPv6 Router;
\- \"DHCPv4 Server & IPv6 Router\" if both IPv4 and IPv6 address allocation
mechanisms are supported by the initiating UE; or
\- \"address allocation not supported\" if neither IPv4 nor IPv6 address
allocation mechanism is supported by the initiating UE;
\- a Link Local IPv6 Address IE formed locally based on IETF RFC 4862 [15] if
the IP Address Config IE is set to \"address allocation not supported\" and
the link is setup for isolated one-to-one communication;
NOTE 1: the UE can reuse a Link Local IPv6 IP address for multiple isolated
one-to-one communication links.
\- a Maximum Inactivity Period IE to indicate the maximum inactivity period of
the requesting UE over this direct link;
NOTE 2: The value of Maximum Inactivity Period IE can be calculated based on
UE\'s local settings, such as keepalive timer T4102 (see 10.4.3),
retransmission timer T4101 (see 10.4.3), and maximum number of allowed
retransmissions for DIRECT_COMMUNICATION_KEEPALIVE message.
\- a Nonce_1 IE set to the 128-bit nonce value generated by the initiating UE
for the purpose of session key establishment over this direct link;
\- a UE Security Capabilities IE set to indicate the list of algorithms that
the initiating UE supports for the security establishment of this direct link;
\- an MSB of K~D-sess~ ID IE set to the most significant 8 bits of the
K~D-sess~ ID; and
\- Optionally, a K~D~ ID IE set to the known ID of K~D~ which was previously
established if the initiating UE has an existing K~D~ with the target UE.
If the direct link setup is for isolated one-to-one ProSe direct
communication, the DIRECT_COMMUNICATION_REQUEST message shall also include the
following parameters:
\- the Signature IE set to the ECCSI signature calculated with the following
information elements, as specified in 3GPP TS 33.303 [6]:
\- User Info; and
\- Nonce_1.
Else if the link setup for remote UE to ProSe UE-to-network relay ProSe direct
communication, the DIRECT_COMMUNICATION_REQUEST message shall also include the
Relay Service Code IE set to the Relay Service Code of the target relay.
After the DIRECT_COMMUNICATION_REQUEST message is generated, the initiating UE
shall pass this message to the lower layers for transmission along with the
initiating UE\'s Layer 2 ID (for unicast communication) and the target UE\'s
Layer 2 ID (for unicast communication), and start timer T4100. The UE shall
not send a new DIRECT_COMMUNICATION_REQUEST message to the same target UE
while timer T4100 is running.
Figure 10.4.2.2.1: Direct link setup procedure
#### 10.4.2.3 Direct link setup procedure accepted by the target UE
Upon receiving a DIRECT_COMMUNICATION_REQUEST message, the target UE shall
store the pair of Layer 2 IDs (for unicast communication) used in the
transport of this message provided by the lower layers and associate them with
a direct link context.
The target UE then checks the User Info IE included in the
DIRECT_COMMUNICATION_REQUEST message and determines whether this request can
be accepted or not. Then, the target UE examines the IP Address Config IE to
see whether there is at least one common IP address configuration option
supported by both the initiating UE and the target UE. If the above check is
successful, the target UE shall invoke the direct security mode control
procedure as specified in subclause 10.4.5 to establish a security association
between the target UE and the initiating UE. Only after the completion of link
authentication procedure and a successful establishment of the security
association, the target UE shall send a DIRECT_COMMUNICATION_ACCEPT message to
the initiating UE.
The target UE shall include an IP Address Config IE set to one of the
following values:
\- \"DHCPv4 Server\" if only IPv4 address allocation mechanism is supported by
the target UE and the target UE is able to act as DHCP server;
\- \"IPv6 Router\" if only IPv6 address allocation mechanism is supported by
the target UE and the target UE is able to act as IPv6 Router;
\- \"DHCPv4 Server & IPv6 Router\" if both IPv4 and IPv6 address allocation
mechanisms are supported by the target UE; or
\- \"address allocation not supported\" if neither IPv4 nor IPv6 address
allocation is supported by the target UE.
If the IP Address Config IE is set to \"address allocation not supported\" and
the received DIRECT_COMMUNICATION_REQUEST message included a Link Local IPv6
Address IE, the target UE shall include a Link Local IPv6 Address IE set to
the link-local IPv6 address formed locally.
NOTE: the UE can reuse a Link Local IPv6 IP address for multiple isolated one-
to-one communication links.
A ProSe UE-to-network relay UE shall support at least one of the IP address
allocation mechanisms.
If the target UE acts as a ProSe UE-to-network relay UE and PDN connection for
relaying associated with the ProSe relay UE ID is not established yet or
additional PDN connection used for relaying is needed when the ProSe UE-to-
network relay UE sends the DIRECT_COMMUNICATION_ACCEPT message to the remote
UE, the ProSe UE-to-network relay UE shall initiate the UE requested PDN
connectivity procedure by sending the PDN CONNECTIVITY REQUEST message
including the APN which is associated with the ProSe Relay UE ID as specified
in 3GPP TS 24.301 [11].
If the target UE is a ProSe-UE-to-network relay UE, the target UE shall create
an inactivity timer T4108 with the value provided in the Maximum Inactivity
Period IE included in the DIRECT_COMMUNICATION_REQUEST message, and start the
timer T4108 when it has no more messages to send over the link to be
established. Once the timer T4108 is started, if any communication activity
occurs before the timer T4108 expires, the UE shall stop the timer T4108 and
reset it with the initial value, unless a new value is provided in a Maximum
Inactivity Period IE in a DIRECT_COMMUNICATION_KEEPALIVE message.
If the target UE is a ProSe-UE-to-network relay UE, and it has been configured
by the serving PLMN to report the IMEI or IMEISV of the remote UE(s) served by
the relay based on the service authorisation procedure as specified in clause
5, the ProSe UE-to-network relay UE shall initiate a remote UE information
request procedure (as specified in subclause 10.7.2) to request the IMEI or
IMEISV of the remote UE upon successful direct link establishment.
#### 10.4.2.4 Direct link setup procedure completion by the initiating UE
Upon receipt of the DIRECT_COMMUNICATION_ACCEPT message, the initiating UE
shall stop timer T4100. From this time onward the initiating UE shall use the
established link for all one-to-one communication (including additional PC5
Signalling messages) to the target UE.
#### 10.4.2.5 Direct link setup procedure not accepted by the target UE
If the direct link setup request cannot be accepted, the target UE shall send
a DIRECT_COMMUNICATION_REJECT message. The DIRECT_COMMUNICATION_REJECT message
contains a PC5 Signalling Protocol cause value set to one of the following
cause values:
#1 Direct communication to target UE not allowed;
#2 Authentication failure;
#3 Conflict of Layer 2 ID for unicast communication is detected;
#4 Lack of resources for proposed link;
#5 IP version mismatch; or.
#6 Link setup failure due to other errors.
If the target UE is not allowed to accept this request.e.g. based on operator
policy or service authorisation provisioning, the target UE shall send a
DIRECT_COMMUNICATION_REJECT message containing PC5 Signalling Protocol cause
value #1 \"Direct communication to target UE not allowed\".
If verification of the signature parameter included in the
DIRECT_COMMUNICATION_REQUEST message fails at the target UE (see subclause
10.4.5), the target UE shall send a DIRECT_COMMUNICATION_REJECT message
containing PC5 Signalling Protocol cause value #2 \"Authentication failure\".
If the direct link setup fails due to the problems in direct link
authentication procedure (see 10.4.5), the target UE shall send a
DIRECT_COMMUNICATION_REJECT message containing PC5 Signalling Protocol cause
value #2 \"Authentication failure\".
For a received DIRECT_COMMUNICATION_REQUEST message from a Layer 2 ID (for
unicast communication), if the target UE already has an existing link
established to the UE known to use this Layer 2 ID or is currently processing
a DIRECT_COMMUNICATION_REQUEST message from the same Layer 2 ID, but with User
Info different from the User Info IE included in this new incoming message,
the target UE shall send a DIRECT_COMMUNICATION_REJECT message containing PC5
Signalling Protocol cause value #3 \"Conflict of Layer 2 ID for unicast
communication is detected\".
If the direct link setup fails due to the congestion problems or other
temporary lower layer problems causing resource constraints, the target UE
shall send a DIRECT_COMMUNICATION_REJECT message containing PC5 Signalling
Protocol cause value #4 \"Lack of resources for proposed link\".
In case of ProSe UE-to-network relay UE, if the remote UE intends to use the
ProSe UE-to-network relay UE for mission critical communication (e.g. MCPTT),
but the ProSe UE-to-network relay UE does not support IPv6 address allocation
scheme as a router, the target UE (i.e. ProSe UE-to-network relay UE) shall
reject the request with DIRECT_COMMUNICATION_REJECT message containing PC5
Signalling Protocol cause value #5 \"IP version mismatch\".
NOTE 1: To determine if remote UE intends to use the ProSe UE-to-network relay
UE for mission critical communication (e.g. MCPTT), the target UE can examine
the Layer 2 destination address of the transport of
DIRECT_COMMUNICATION_REQUEST message to check whether it matches the ProSe
Relay UE ID which has been associated to mission critical communication (e.g.
MCPTT) or examine the User Info included in the DIRECT_COMMUNICATION_REQUEST
message.
For other reasons that causing the failure of link establishment, the target
UE shall send a DIRECT_COMMUNICATION_REJECT message containing PC5 Signalling
Protocol cause value #6 \"Link setup failure due to other errors\".
Upon receipt of the DIRECT_COMMUNICATION_REJECT message, the initiating UE
shall stop timer T4100 and abort the direct link setup procedure. If the cause
value in the DIRECT_COMMUNICATION_REJECT message is #1 \"Direct communication
to target UE not allowed\" or #4 \"Lack of resources for proposed link\", then
the UE shall not attempt to start direct link setup with the same target UE at
least for a time period T, and if the initiating UE is a remote UE requesting
link setup to a ProSe UE-to-network relay UE, it shall initiate the relay
reselection procedure as specified in subclause 10A.2.13.
NOTE 2: The length of time period T is UE implementation specific and can be
different for the case when the UE receives PC5 Signalling Protocol cause
value #1 \"Direct communication to target UE not allowed\" or when the UE
receives cause value #4 \"Lack of resources for proposed link\".
#### 10.4.2.6 Abnormal cases
##### 10.4.2.6.1 Abnormal cases at the initiating UE
If timer T4100 expires, the initiating UE shall retransmit the
DIRECT_COMMUNICATION_REQUEST message and restart timer T4100. After reaching
the maximum number of allowed retransmissions, the initiating UE shall abort
the direct link setup procedure, may notify the upper layer that the target UE
is unreachable, and if the initiating UE is a remote UE requesting link setup
to a ProSe UE-to-network relay UE, it shall initiate the relay reselection
procedure as specified in subclause 10A.2.4.
NOTE: The maximum number of allowed retransmissions is UE implementation
specific.
If the need to establish a link no longer exists before the procedure is
completed, the initiating UE shall abort the procedure.
##### 10.4.2.6.2 Abnormal cases at the target UE
For a received DIRECT_COMMUNICATION_REQUEST message from a Layer 2 ID (for
unicast communication), if the target UE already has an existing link
established to the UE known to use this Layer 2 ID and the new request
contains an identical User Info as the known user, the UE shall process the
new request. However, the target UE shall only delete the existing link
context after the new link setup procedure succeeds, or the link keepalive
procedure as described in subclause 10.4.3 fails.
If the inactivity timer T4108 expires, if the target UE is a ProSe UE-to-
network relay UE, it shall initiate the direct link release procedure
specified in subclause 10.4.4 with the release reason #3 \"Direct connection
is not available any more\". Otherwise, the target UE may:
A) initiate is own keepalive procedure to check the link; or
B) initiate the direct link release procedure specified in subclause 10.4.4
with the release reason #3 \"Direct connection is not available any more\".
Whether the UE chooses A or B is left to UE implementation.
### 10.4.3 Direct link keepalive procedure
#### 10.4.3.1 General
The direct link keepalive procedure is used to maintain the direct link
between two ProSe-enabled UEs, i.e., check that the link between the two UEs
is still viable. The procedure can be initiated by only one UE or both of the
UEs in the established direct link. If the direct link is used for one-to-one
communication between a remote UE and a ProSe UE-to-network relay UE, only the
remote UE shall initiate the link keepalive procedure.
In this procedure, the UE sending the DIRECT_COMMUNICATION_KEEPALIVE message
is called the \"requesting UE\" and the other UE is called the \"peer UE\".
#### 10.4.3.2 Direct link keepalive procedure initiation by the requesting UE
The requesting UE manages a keepalive timer T4102 and a keepalive counter for
this procedure. The keepalive timer T4102 is used to trigger the periodic
initiation of the procedure. It is started or restarted whenever the UE
receives a PC5 Signalling message or PC5 user plane data from the peer UE over
this link. The keepalive counter is set to an initial value of zero after link
establishment.
The requesting UE may initiate the procedure if:
\- a request from upper layers to check the viability of the direct link is
received; or
\- the keepalive timer T4102 for this link expires.
The requesting UE initiates the procedure by stopping timer T4102 if it is
still running and generating a DIRECT_COMMUNICATION_KEEPALIVE message with a
Keepalive Counter IE that contains the value of the keepalive counter for this
link. Optionally, the initiating UE may include a Maximum Inactivity Period IE
to indicate the maximum inactivity period of the requesting UE over this
direct link. When a remote UE sends DIRECT_COMMUNICATION_KEEPALIVE message to
the ProSe UE-to-network relay UE, this IE shall be included.
After the DIRECT_COMMUNICATION_KEEPALIVE message is generated, the requesting
UE shall pass this message to the lower layers for transmission along with the
requesting UE's Layer 2 ID (for unicast communication) and the peer UE\'s
Layer 2 ID (for unicast communication), and start retransmission timer T4101.
Figure 10.4.3.2.1: Direct link keepalive procedure
#### 10.4.3.3 Direct link keepalive procedure accepted by the peer UE
Upon receiving a DIRECT_COMMUNICATION_KEEPALIVE message, the peer UE shall
respond with a DIRECT_COMMUNICATION_KEEPALIVE_ACK message including the
Keepalive Counter IE set to the same value as that received in the
DIRECT_COMMUNICATION_KEEPALIVE message.
If a Maximum Inactivity Period IE is included in the
DIRECT_COMMUNICATION_KEEPALIVE message, the peer UE shall stop the inactivity
timer T4108 if it is running, and restart the timer T4108 with the value
provided in the IE, If any communication activity occurs in this direct link
before the timer T4108 expires, the UE shall stop the timer T4108 and reset it
with the initial value.
#### 10.4.3.4 Direct link keepalive procedure completed by the requesting UE
Upon receiving a DIRECT_COMMUNICATION_KEEPALIVE_ACK message, the requesting UE
shall stop retransmission timer T4101, start keepalive timer T4102 and
increment the keepalive counter for this link.
#### 10.4.3.5 Abnormal cases
##### 10.4.3.5.1 Abnormal cases at the requesting UE
If retransmission timer T4101 expires, the requesting UE shall initiate the
transmission of the DIRECT_COMMUNICATION_KEEPALIVE message again with the last
used keepalive counter value and restart timer T4101. If no response is
received from the peer UE after reaching the maximum number of allowed
retransmissions, the requesting UE shall abort the link keepalive procedure
and initiate the direct link release procedure (see subclasue 10.4.4) instead,
and if the requesting UE is a remote UE, it shall initiate the relay
reselection procedure as specified in subclause 10A.2.13.
NOTE: The maximum number of allowed retransmissions is UE implementation
specific.
If the need to use this direct link no longer exists before the direct link
keepalive procedure is completed, the requesting UE shall abort the procedure
and start a direct link release procedure (see subcaluse 10.4.4) instead.
##### 10.4.3.5.2 Abnormal cases at the peer UE
If the inactivity timer T4108 expires, if the peer UE is a ProSe UE-to-network
relay UE, it shall initiate the direct link release procedure specified in
10.4.4 with the release reason #3 \"Direct connection is not available any
more\". Otherwise, the peer UE may:
A) initiate is own keepalive procedure to check the link; or
B) initiate the direct link release procedure specified in 10.4.4 with the
release reason #3 \"Direct connection is not available any more\".
Whether the UE chooses A or B is left to UE implementation.
### 10.4.4 Direct link release procedure
#### 10.4.4.1 General
The Direct link release procedure is used to release a secure direct link
between two ProSe-enabled UEs. The link can be released from either end
points. The UE sending the DIRECT_COMMUNICATION_RELEASE message is called the
\"releasing UE\"and the other UE is called the \"peer UE\".
When the direct link between a remote UE and a ProSe UE-to-network relay UE is
released, the ProSe-UE-to-network relay UE shall perform the Remote UE report
procedure as specified in 3GPP TS 24.301 [11].
#### 10.4.4.2 Direct link release procedure initiation by the releasing UE
The releasing UE shall initiate the procedure if:
\- a request from upper layers to release a direct link with the peer UE which
uses a known Layer 2 ID (for unicast communication) is received and there is
an existing link between those two UEs; or
\- the peer UE has been non-responsive, e.g., unable to complete the direct
link keepalive procedure.
The releasing UE initiates the direct link release procedure by generating a
DIRECT_COMMUNICATION_RELEASE message with a Release Reason IE indicating one
of the following cause values:
#1 Direct Communication to peer UE no longer needed;
#2 Direct communication with the peer UE is no longer allowed; or
#3 Direct connection is not available any more.
After the DIRECT_COMMUNICATION_RELEASE message is generated, the releasing UE
shall pass this message to the lower layers for transmission along with the
releasing UE\'s Layer 2 ID (for unicast communication) and the peer UE\'s
Layer 2 ID (for unicast communication). The releasing UE shall release the
direct link locally if the release reason is #3 \"Direct connection is not
available any more\". Otherwise, the releasing UE shall start timer T4103.
Figure 10.4.4.2.1: Direct link release procedure
#### 10.4.4.3 Direct link release procedure accepted by the peer UE
Upon receiving a DIRECT_COMMUNICATION_RELEASE message, the peer UE shall stop
timer T4101, timer T4102, timer T4103 or timer T4108 for this link, if any of
those timers is running, and abort any other ongoing PC5 Signalling Protocol
procedures on this link. The peer UE shall respond with a
DIRECT_COMMUNICATION_RELEASE_ACCEPT message. After the message is sent, the
peer UE shall remove the context of this direct link and no longer send or
receive any messages via this link.
If the cause value in the DIRECT_COMMUNICATION_RELEASE message is \"Direct
communication with the peer UE is no longer allowed\", then the UE shall not
attempt to start direct link setup with the releasing UE at least for the time
period T and if the peer UE is a remote UE requesting link setup to a ProSe
UE-to-network relay UE, it shall initiate the relay reselection procedure as
specified in subclause 10A.2.13.
NOTE: The length of time period T is UE implementation specific.
#### 10.4.4.4 Direct link release procedure completion by the releasing UE
Upon receipt of the DIRECT_COMMUNICATION_RELEASE_ACCEPT message, the releasing
UE shall stop timer T4103. From this time onward the releasing UE shall no
longer send or receive any messages via this link.
#### 10.4.4.5 Abnormal cases
##### 10.4.4.5.1 Abnormal cases at the releasing UE
If retransmission timer T4103 expires, the releasing UE shall initiate the
transmission of the DIRECT_COMMUNICATION_RELEASE message again and restart
timer T4103. If no response is received from the peer UE after reaching the
maximum number of allowed retransmissions, the releasing UE shall release the
direct link locally. From this time onward the releasing UE shall no longer
send or receive any messages via this link.
NOTE: The maximum number of allowed retransmissions is UE implementation
specific.
### 10.4.5 Direct security mode control procedure
#### 10.4.5.1 General
Security association for a direct link between two ProSe-Enabled UEs is
established during the direct link setup procedure or direct link rekeying
procedure with the exchange of message contents related to direct security
mode establishment. After successful completion of the direct security mode
control procedure, the selected security algorithms and keys are used to
integrity protect and cipher all PC5 Signalling messages exchanged between the
UEs; and are also used to cipher all data plane traffic exchanged between the
UEs.
In the rest of this subclause, the UE sending the DIRECT_SECURITY_MODE_COMMAND
message is called the \"commanding UE\"and the other UE is called the \"peer
UE\".
#### 10.4.5.2 Direct security mode control procedure initiation by the
commanding UE
A commanding UE may initiate the direct security mode control procedure in
response to receiving a DIRECT_COMMUNICATION_REQUEST or a
DIRECT_REKEYING_REQUEST message.
If the procedure takes place between a remote UE and a ProSe UE-to-network
relay UE and is triggered by a DIRECT_REKEYING_REQUEST to only refresh
K~D-sess~ but not K~D~, then either the ProSe UE-to-network relay UE or the
remote UE can act as the commanding UE. Otherwise, if both keys are to be
refreshed, the ProSe UE-to-network relay UE shall act as the commanding UE.
To initiate this procedure, the commanding UE shall either identify an
existing K~D~ based on the K~D~ ID included in the
DIRECT_COMMUNICATION_REQUEST or DIRECT_REKEYING_REQUEST message, or derive a
new K~D~ if it either does not share a known K~D~ with the peer UE or wishes
to derive a new K~D~, as specified in 3GPP TS 33.303 [6]. In the latter case,
the commanding UE shall generate the MSB of K~D~ ID to ensure that the
resultant K~D~ ID will be unique in the commanding UE. Then, it shall generate
a LSB of K~D-sess~ ID such that the K~D-sess~ ID formed by combining with the
MSB of K~D-sess~ ID (received in the DIRECT_COMMUNICATION_REQUEST or
DIRECT_REKEYING_REQUEST that triggered the direct security mode procedure) is
unique within the commanding UE.
Following this, the commanding UE shall generate a 128-bit Nonce_2 value. With
K~D~, Nonce_2 and Nonce_1 received in the DIRECT_COMMUNICATION_REQUEST or
DIRECT_REKEYING_REQUEST message, the commanding UE shall derive K~D-\ sess~ as
specified in 3GPP TS 33.303 [6].
Then, the UE shall construct a DIRECT_SECURITY_MODE_COMMAND message with the
following:
\- Nonce_2 IE set to Nonce_2;
\- the LSB of K~D-sess~ ID IE set to indicate the least significant 8-bits of
K~D-sess~ ID;
\- the UE Security Capabilities IE set to the UE Security Capabilities
received in the DIRECT_COMMUNICATION_REQUEST message or
DIRECT_REKEYING_REQUEST; and
\- the Chosen Algorithms IE set to the algorithms to be used for ciphering and
integrity protection.
If the DIRECT_SECURITY_MODE_COMMAND message is used between a remote UE and a
ProSe UE-to-network relay UE and the ProSe UE-to-network relay UE received the
K~D~ Freshness parameter from the PKMF, then the ProSe UE-to-network relay UE
shall include the following additional parameters in the
DIRECT_SECURITY_MODE_COMMAND message to create a new K~D~:
\- the GPI IE containing the GPI payload if it was received from the ProSe Key
Management Function (PKMF);
\- the K~D~ Freshness IE set to the K~D~ Freshness parameter received from the
PKMF; and
\- the MSB of K~D~ ID IE set to the MSB of K~D~ ID of the new K~D.~
If the DIRECT_SECURITY_MODE_COMMAND message is used for isolated one-to-one
ProSe direct communication, then the commanding UE shall include the following
additional parameters in the DIRECT_SECURITY_MODE_COMMAND message in order to
create a new K~D~:
\- the User Info IE set to the User Info received from upper layers;
\- the MSB of K~D~ ID IE set to the MSB of K~D~ ID of the new K~D~; and
\- the Signature IE set to the ECCSI signature value calculated with the
following information elements, as specified in 3GPP TS 33.303 [6]:
\- User Info;
\- Nonce_1; and
> \- the Encrypted Payload IE set to the SAKKE payload generated as specified
> in 3GPP TS 33.303 [6].
The commanding UE shall select the integrity protection and ciphering
algorithms that will be used and include these choices in the Chosen
algorithms IE in the DIRECT SECURITY MODE COMMAND message. The UE shall
include the received UE security capabilities that was present in the
DIRECT_COMMUNICATION_REQUEST or a DIRECT_REKEYING_REQUEST message that
triggered the DIRECT SECURITY MODE COMMAND message.
The commanding UE shall send the DIRECT SECURITY MODE COMMAND message
unciphered, but shall integrity protect the message with the new security
context. After sending the DIRECT_SECURITY_MODE_COMMAND message, the
commanding UE shall start timer T4111 (see figure 10.4.5.2.1).
**Figure 10.4.5.2.1: Direct Security mode control procedure**
#### 10.4.5.3 Direct security mode control procedure accepted by the peer UE
Upon receipt of the DIRECT_SECURITY_MODE_COMMAND message, the peer UE shall
check whether the security mode command can be accepted or not. This is done
by performing the integrity check of the message and by checking that the
received UE security capabilities have not been altered compared to the latest
values that the peer UE sent to the commanding UE in the
DIRECT_COMMUNICATION_REQUEST or DIRECT_REKEYING_REQUEST message.
In order to check the integrity, the peer UE needs to create the security
context as described in 3GPP TS 33.303 [6]. If the MSB of K~D~ ID were
included in the DIRECT_SECURITY_MODE_COMMAND message then the peer UE shall
take one of the following two actions:
\- If performing isolated one-to-one ProSe direct communication, the peer UE
shall first check the signature included in the SIGN IE of the DIRECT SECURITY
MODE COMMAND and then obtain the new K~D~ from the Encrypted Payload IE; or
\- If the peer UE is a remote UE that has received the
DIRECT_SECURITY_MODE_COMMAND message from a ProSe UE-to-network relay UE, it
shall first replace its PRUK ID and PRUK if a GPI IE was included in the
DIRECT_SECURITY_MODE_COMMAND. Finally, the UE shall derive a new K~D~, as
described in 3GPP TS 33.303 [6].
If MSB of K~D~ ID was not included in the DIRECT_SECURITY_MODE_COMMAND, then
the peer UE shall use either the existing K~D~ indicated by the K~D~ ID
included in the DIRECT_COMMUNICATION_REQUEST or the currently used one.
The peer UE shall then derive the K~D-sess~ based on the KD-~sess~ ID in the
same way as the commanding UE. Finally the peer UE shall use the algorithms
indicated in the Chosen Algorithms IE.
If the DIRECT_SECURITY_MODE_COMMAND message can be accepted, the peer UE shall
send a DIRECT_SECURITY_MODE_COMPLETE message ciphered and integrity protected
with the new security context. The DIRECT_SECURITY_MODE_COMPLETE message shall
include the 16 least significant bits of the K~D~ ID if the initiating UE
included the MSB of K~D~ ID in the DIRECT_SECURITY_MODE_COMMAND message.
From this time onward the peer UE shall protect all signalling messages and
user data with the new security context.
#### 10.4.5.4 Direct security mode control procedure completion by the
commanding UE
Upon receipt of the DIRECT_SECURITY_MODE_COMPLETE message, the commanding UE
shall stop timer T4111. If an LSB of K~D~ ID IE was included in the message,
the commanding UE uses this and the MSB of K~D~ ID it previously sent to form
the K~D~ ID of the new K~D~. From this time onwards the commanding UE shall
protect all signalling messages and user data with the new security context.
#### 10.4.5.5 Direct security mode control procedure not accepted by the peer
UE
If the DIRECT_SECURITY_MODE_COMMAND message cannot be accepted, the peer UE
shall send a DIRECT_SECURITY_MODE_REJECT message. The
DIRECT_SECURITY_MODE_REJECT message contains a PC5 Signaling Protocol Cause
Value IE indicating one of the following cause values:
> #7: UE security capabilities mismatch;
>
> #8: Unspecified error; or
>
> #9: Authentication synchronisation error.
If the DIRECT_SECURITY_MODE_COMMAND message cannot be accepted due to a
synchronisation error when processing the authentication vector contained in
the GPI payload sent by the ProSe UE-to-network relay UE to the remote UE,
then the peer UE shall include the RAND and AUTS parameters in the
DIRECT_SECURITY_MODE_ REJECT message.
Upon receipt of the DIRECT_SECURITY_MODE_REJECT message, the commanding UE
shall stop timer T4111. If the PC5 Signaling Protocol Cause Value IE indicates
a synchronisation error and the message contained a RAND and an AUTS, then a
ProSe UE-to-network relay may fetch a fresh K~D~ from the PKMF by sending a
Key Request message including RAND and AUTS as specified in 3GPP TS 33.303
[6]. Otherwise the commanding UE shall abort the ongoing procedure that
triggered the initiation of the direct security mode control procedure, as
specified in subclauses 10.4.2 or 10.4.8.
10.4.5.6 Abnormal cases
##### 10.4.5.6.1 Abnormal cases at the commanding UE
If timer T4111 expires, then
\- if the direct security mode control procedure is triggered by a
DIRECT_COMMUNICATION_REQUEST message, the commanding UE shall discard any
derived keys with Nonce_1 and initiate the transmission of the
DIRECT_COMMUNICATION_REJECT message with the PC5 Signaling Protocol Cause
Value IE set to #10 \"non-responsive peer during the direct security mode
procedure\"; or
\- if the direct security mode control procedure is triggered by a
DIRECT_REKEYING_REQUEST message, the commanding UE shall continue to use old
keys until those keys are no longer valid.
##### 10.4.5.6.2 Abnormal cases at the peer UE
If the DIRECT_SECURITY_MODE_COMMAND message is malformed, the peer UE shall
discard the message.
### 10.4.6 IP Address configuration
#### 10.4.6.1 General
The IP address configuration procedure is performed after the establishment of
the direct link to enable IP connectivity between the UEs at each end of the
direct link.
When the IP address configuration procedure for a remote UE completes, the
ProSe UE-to-network relay UE shall perform the Remote UE report procedure as
specified in 3GPP TS 24.301 [11].
#### 10.4.6.2 Selection of IP version
When neither of the two UEs on the direct link acts as a ProSe UE-to-network
relay, the two UEs shall select the IP version (IPv4 or IPv6) to be used based
on the following rules:
\- if the target UE in the direct link setup procedure (see subclause 10.4.2)
has indicated \"DHCPv4 Server\" in the IP Address Config IE, then the
initiating UE in the direct link setup procedure (see subclause 10.4.2) shall
initiate the IPv4 address configuration with DHCPv4 procedure acting as a DHCP
client;
\- if the target UE in the direct link setup procedure has indicated \"IPv6
Router\" in the IP Address Config IE , then the initiating UE in the direct
link setup procedure shall initiate the IPv6 address configuration with IPv6
stateless address auto-configuration acting as an IPv6 host;
\- if the target UE in the direct link setup procedure has indicated \"DHCPv4
Server & IPv6 Router\" in the IP Address Config IE, then the initiating UE in
the direct link setup procedure shall choose either IP version and initiate
the address configuration procedure, acting as a client or host;
\- if the target UE in the direct link setup procedure has indicated \"address
allocation not supported\" in the IP Address Config IE and the initiating UE
has indicated \"DHCPv4 Server\", \"IPv6 Router\" or \"DHCPv4 Server & IPv6
Router\" in the IP Address Config IE, then the target UE shall:
a) initiate the IPv4 address configuration with DHCPv4 procedure acting as a
DHCP client, if the initiating UE has indicated \"DHCPv4 Server\";
b) initiate the IPv6 address configuration with IPv6 stateless address auto-
configuration acting as an IPv6 host if the initiating UE has indicated \"IPv6
Router\"; and
c) choose either IP version and initiate the corresponding IP address
configuration procedure as a client or host, if if the other UE has indicated
\"DHCPv4 Server & IPv6 Router\"; and
\- if both of the UEs has indicated \"address allocation not supported\" in
the IP Address Config IE, then the UEs shall use IPv6 link-local addresses
formed locally as defined in RFC 4862 [15].
When one of the two UEs on the direct link acts as a ProSe UE-to-network
relay, the two UEs shall select the IP version (IPv4 or IPv6) to be used based
on the following rules
\- if the ProSe UE-to-network relay UE has indicated \"DHCPv4 Server\" in the
IP Address Config IE, the remote UE shall initiate the IPv4 address
configuration with DHCPv4 procedure acting as a DHCP client;
\- if the ProSe UE-to-network relay UE has indicated \"IPv6 Router\" in the IP
Address Config IE, the remote UE shall initiate the IPv6 address configuration
with IPv6 stateless address auto-configuration acting as an IPv6 host; and
\- if the ProSe UE-to-network relay UE has indicated \"DHCPv4 Server & IPv6
Router\" in the IP Address Config IE, the remote UE shall choose the IP
version and initiate the corresponding IP address configuration procedure as a
client or host. Especially, if the remote UE intends to use the ProSe UE-to-
network relay UE for mission critical communication (e.g. MCPTT), the remote
UE shall initiate the IPv6 stateless address auto-configuration acting as an
IPv6 host.
#### 10.4.6.3 IPv4 address configuration with DHCPv4
The IPv4 address configuration with DHCPv4 shall be carried out as follow:
1\. The DHCP client sends a DHCPDISCOVER message;
2\. The DHCP server sends the DHCPOFFER message with the assigned IPv4 address
for the client. The IPv4 address provided shall correspond to a local IPv4
address range configured in the DHCP server;
3\. When the DHCP client receives the lease offer, it sends a DHCPREQUEST
message containing the received IPv4 address.
4\. The DHCP server sends a DHCPACK message to the client UE. This message
includes the lease duration and any other configuration information that the
client might have requested.
5\. On receiving the DHCPACK message, the IPv4 address configuration is
completed.
NOTE: The DHCPv4 client may skip the DHCPv4 Discovery phase, and send DHCPv4
Request message in broadcast as the first message in accordance with the
DHCPv4 renewal process.
If the direct link is setup for one-to-one communication between a remote UE
and a UE-to-network relay UE, after the remote UE releases the IPv4 address
using DHCPv4 or the IPv4 address lease time expires, the ProSe UE-to-network
relay UE shall wait for a relay implementation specific time before allocating
the same IPv4 address to another remote UE.
#### 10.4.6.4 IPv6 address configuration with IPv6 stateless address auto-
configuration
The IPv6 stateless address auto-configuration protocol procedure shall be
carried out as follow:
1\. the UE acting as an IP Host shall send a Router Solicitation message in
order to solicit a Router Advertisement message as specified in IETF RFC 4862
[15].
2\. Upon receiving the Router Solicitation message, the other UE shall send an
IPv6 Router Advertisement message as specified in IETF RFC 4862 [15], acting
as an advertising interface as specified in IETF RFC 4861 [33]. The Router
Advertisement messages shall contain an IPv6 prefix, which is to be combined
with the interface identifier to form the IPv6 address.
3\. The UE which receives the Router advertisement message retrieves the
router\'s address from the Source IP address field of the message, and formed
its own IP address with the prefix and the interface identifier as specified
in IETF RFC 4862 [15].
If the direct link is setup for one-to-one communication between a remote UE
and a UE-to-network relay, the UE-to-network relay shall obtain the IPv6
prefix assigned to the remote UE via prefix delegation function from the
network as defined in 3GPP TS 23.401 [34] before sending the IPv6 prefix to
the remote UE. After the remote UE receives the Router Advertisement message,
it constructs a full IPv6 address via IPv6 Stateless Address auto-
configuration in accordance with IETF RFC 4862 [15]. However, the remote UE
shall not use any identifiers defined in TS 23.003 [4] as the basis for
generating the interface identifier. For privacy, the remote UE may change the
interface identifier used to generate the full IPv6 address, as defined in
3GPP TS 23.221 [35] without involving the network. The remote UE shall use the
auto-configured IPv6 address while sending packets in this implicitly created
PDN connection.
If the direct link is setup for one-to-one communication between a remote UE
and a UE-to-network relay and support for mission critical applications and
policy control for remote UEs is required, the remote UE shall be assigned a
/64 IPv6 Prefix from a shorter IPv6 prefix by the UE-to-network relay.
NOTE: In order to support policy control per remote UE, the assignment of a
/64 IPv6 Prefix from a shorter IPv6 prefix by the UE-to-network relay is used.
The support of the extended TFT filter format including the TFT packet filter
attribute Local Address and Mask, as defined in 3GPP TS 24.008 [30], is needed
in the UE-to-network relay and the network.
### 10.4.7 ProSe Per-Packet Priority for one-to-one ProSe direct communication
#### 10.4.7.1 General
When receiving the user data from upper layers to be sent over a direct link,
the transmitting UE shall associate each outgoing protocol data unit with one
of eight possible values to indicate the required ProSe Per-Packet Priority
related to the lower layer handling of this packet data unit. The ProSe Per-
Packet Priority is selected by the application layer based on criteria that
are outside the scope of this specification, and is independent of the Layer 2
destination address used for this packet data unit.
The UE shall associate any outgoing PC5 signalling message with the single
ProSe Per-Packet Priority value provisioned for PC5signall ing messages.
#### 10.4.7.2 ProSe Per-Packet Priority for ProSe UE-to-network relay
For unicast uplink traffic, the ProSe UE-to-network relay uses the uplink TFTs
to select the uplink EPS bearers for relayed uplink packets independently from
the ProSe Per-Packet Priority applied over PC5 by remote UEs.
For unicast downlink traffic the ProSe UE-to-network relay maps the QCI of the
EPS bearer into a ProSe Per-Packet Priority value to be applied for the
downlink relayed unicast packets over PC5. The mapping rules are provisioned
in the ProSe UE-to-network relay.
NOTE: downlink traffic on EPS bearers associated with the same QCI, but
different ARP values, is assigned the same ProSe Per-Packet Priority over PC5.
### 10.4.8 Direct link rekeying procedure
#### 10.4.8.1 General
This procedure is used to refresh the security context used between two UEs on
an established direct link.
The UE sending the DIRECT_REKEYING_REQUEST message is called the \"initiating
UE\"and the other UE is called the \"target UE\".
This procedure triggers initiation of a direct security mode control procedure
by the target UE. If the ProSe UE-to-network relay UE wants to initiate this
procedure to refresh K~D~, it shall use a DIRECT_REKEYING_TRIGGER message to
trigger the remote UE to initiate this procedure from the other direction.
#### 10.4.8.2 Direct link rekeying procedure initiation
A UE shall initiate the direct link rekeying procedure in any of the following
cases:
a) the session key K~D-sess~ used to protect direct link communication is
going to expire and needs to be refreshed and neither timer T4111 nor T4112
are running; or
b) the UE wants to refresh K~D~ and neither timer T4111 nor T4112 are running.
The initiating UE shall generate a new 128-bit Nonce_1 value and the most
significant 8-bits of the K~D-sess~ ID. The UE shall generate a
DIRECT_REKEYING_REQUEST message with the following:
\- a Nonce_1 IE set to the nonce value provided by the initiating UE for the
purpose of session key establishment over this direct link;
\- a UE Security Capabilities IE set to indicate the list of algorithms that
the initiating UE supports for the security establishment of this direct link;
\- an MSB of K~D-sess~ ID IE set to the most significant 8-bits of the
K~D-sess~ ID;
\- Optionally, an Auth Flag IE set to the value indicating the K~D~ to be
refreshed, if the UE wants to refresh K~D~; and
\- Optionally, a PRUK ID IE if the initiating UE is a remote UE towards a
ProSe UE-to-network relay UE.
A UE initiates the direct link rekeying procedure by sending a
DIRECT_REKEYING_REQUEST message to the target UE and starting timer T4112 (see
figure 10.4.8.2.1).
Figure 10.4.8.2.1: Direct link rekeying procedure
If the initiating UE is a ProSe UE-to-network relay UE, the ProSe UE-to-
network relay UE wishes to refresh K~D~ used on an established link between
the ProSe UE-to-network relay UE and the remote UE, and there is no pending
direct link rekeying procedure initiated by the remote UE, the ProSe UE-to-
network relay UE shall send a DIRECT_REKEYING_TRIGGER message with the format
specified in subclause 11.4.17 to trigger the remote UE to initiate its own
direct link rekeying procedure and start timer T4113, as shown in figure
10.4.8.2.2.
Upon receiving a DIRECT_REKEYING_TRIGGER message, the remote UE shall:
\- if timer T4112 is not running, initiate a direct link rekeying procedure to
refresh K~D~ as described above; and
\- if timer T4112 is running, discard the DIRECT_REKEYING_TRIGGER message.
NOTE: If timer T4112 is running at the remote UE, the ProSe UE-to-network
relay UE will use the direct link rekeying procedure already initiated by the
remote UE to refresh K~D~.
Once the ProSe UE-to-network relay received the DIRECT_REKEYING_REQUEST
message, the T4113 timer shall be stopped.
Figure 10.4.8.2.2: Direct link rekeying procedure triggered by a ProSe UE-to-
network relay UE to refresh K~D~
#### 10.4.8.3 Direct link rekeying procedure accepted by the target UE
If there is no active timer T4112 running, the target UE shall process the
received DIRECT_REKEYING_REQUEST message and initiate a direct security mode
control procedure acting as the commanding UE as described in subclause
10.4.5.2.
If the timer T4112 is running in the target UE, then:
\- if the target UE is a ProSe UE-to-network relay UE, it shall stop timer
T4112 and initiate a direct security mode control procedure acting as the
commanding UE as described in subclause 10.4.5.2; and
\- if the target UE is neither a remote UE nor a ProSe UE-to-network relay UE,
and the Nonce_1 value received in the DIRECT_REKEYING_REQUEST message is
larger than the Nonce_1 value locally generated (and included in the last
DIRECT_REKEYING_REQUEST message sent by the target UE), the target UE shall
stop timer T4112 and initiate a direct security mode control procedure acting
as the commanding UE as described in subclause 10.4.5.2.
When the target UE is a ProSe UE-to-network relay UE, the ProSe UE-to-network
relay UE shall trigger a Key Request procedure to the PKMF (see 3GPP TS 33.303
[6]), before initiating the direct security mode control procedure if one of
the following conditions are met:
\- the Auth Flag IE is included in the DIRECT_REKEYING_REQUEST message; or
\- the Auth Flag IE is not included in the DIRECT_REKEYING_REQUEST message but
the ProSe UE-to-network relay UE wants to refresh K~D~.
Upon completion of the direct security mode control procedure, i.e. upon
receiving a DIRECT_SECURITY_MODE_COMPLETE message, the target UE shall send a
DIRECT_REKEYING_RESPONSE message with the format specified in subclause
11.4.16, to notify the initiating UE of the completion of this direct link
rekeying procedure.
10.4.8.4 Direct link rekeying procedure completion by the initiating UE
Upon the reception of a DIRECT_REKEYING_RESPONSE message, the initiating UE
shall stop timer T4112.
#### 10.4.8.5 Direct link rekeying procedure not accepted by the target UE
A remote UE that receives a DIRECT_REKEYING_REQUEST message shall ignore the
message if timer T4112 is running. Also, if there is no timer T4112 running
but the remote UE wants to refresh K~D~, the UE shall ignore the received
DIRECT_REKEYING_REQUEST message and act as the new initiating UE and initiate
the direct link rekeying procedure to refresh the K~D~ as described in
subclause 10.4.8.2.
Other UEs shall ignore a DIRECT_REKEYING_REQUEST message if timer T4112 is
running and the Nonce_1 value received in the DIRECT_REKEYING_REQUEST message
is not larger than the Nonce_1 value locally generated (and included in the
last DIRECT_REKEYING_REQUEST message sent by the target UE).
10.4.8.6 Abnormal cases
##### 10.4.8.6.1 Abnormal cases at the initiating UE
If timer T4112 expires, the initiating UE shall initiate the transmission of
the DIRECT_REKEYING_REQUEST message again and restart timer T4112. If no
response is received from the target UE after reaching the maximum number of
allowed retransmissions, the initiating UE shall abort the direct link
rekeying procedure and initiate the direct link release procedure (see
subclause 10.4.4). Additionally, if the initiating UE is a remote UE, it shall
initiate the relay reselection procedure as specified in subclause 10A.2.13.
NOTE: The maximum number of allowed retransmissions is UE implementation
specific.
##### 10.4.8.6.2 Abnormal cases at the target UE
If the DIRECT_REKEYING_REQUEST message is malformed, the target UE shall
discard the message.
## 10.5 TMGI monitoring request procedure
### 10.5.1 General
The purpose of the TMGI monitoring request procedure is for the remote UE to
obtain a ProSe Layer 2 Group ID from the ProSe UE-to-network relay UE for
receiving the MBMS content for the corresponding TMGI over PC5 interface or
for the remote UE to inform the ProSe UE-to-network relay UE to forward the
MBMS content for the corresponding TMGI.
The remote UE in this procedure shall be a ProSe-enabled Public Safety UE and
authorised to act as a remote UE towards a ProSe UE-to-network relay UE based
on the service authorisation procedure as specified in clause 5. The ProSe UE-
to-network relay UE in this procedure shall be a ProSe-enabled Public Safety
UE and authorised to act as a ProSe UE-to-network relay UE based on the
service authorisation procedure as specified in clause 5.
### 10.5.2 TMGI monitoring request procedure initiation by the remote UE
Before initiating the TMGI monitoring request procedure, the remote UE has
successfully discovered the ProSe UE-to-network relay UE and obtained the
Layer 2 ID of the ProSe UE-to-network relay UE as described in subclause
10A.2. The remote UE has also obtained TMGI and MBMS SAIs from a group
communication application to receive related MBMS content (e.g. as specified
in 3GPP TS 23.179 [38]).
The remote UE shall initiate a TMGI monitoring request procedure:
a) when the remote UE is triggered by an upper layer application to receive
the MBMS content for a given TMGI and there is no corresponding TMGI
monitoring refresh timer T4104 assigned by the ProSe UE-to-network relay UE;
b) when the TMGI monitoring refresh timer T4104 assigned by the ProSe UE-to-
network relay UE has expired and the request from the upper layer to receive
the MBMS content for a given TMGI is still in place;
c) when the remote UE receives a request from an upper layer application to
change the requested ProSe Per-Packet Priority associated with the TMGI of an
MBMS content that the remote UE is currently receiving; or
d) when the remote UE receives a request from an upper layer application to
change the requested MBMS SAI list associated with the TMGI of an MBMS content
that the remote UE is currently receiving.
The remote UE shall initiate the TMGI monitoring request procedure by sending
a TMGI_MONITORING_REQUEST with:
\- the TMGI set to the TMGI received from the application layer;
\- the MBMS SAI list included the TMGI corresponding MBMS SAIs received from
the application layer; and
\- the Requested ProSe Per-Packet Priority set to the ProSe Per-Packet
Priority value mapped from the priority value associated with the TMGI from
the application layer.
Figure 10.5.2.1: TMGI monitoring request procedure
### 10.5.3 TMGI monitoring request procedure accepted by the ProSe UE-to-
network relay UE
Upon receiving a TMGI_MONITORING_REQUEST, the ProSe UE-to-network relay UE
shall store the TMGI and the MBMS SAIs received in the TMGI_MONITORING_REQUEST
and check whether at least one of the MBMS SAIs is included in the MBMS SAI
list of the serving cell. If there is no MBMS SAI list of the serving cell,
the ProSe UE-to-network relay UE retrieves the MBMS SAI list from the system
information of the serving cell as specified in 3GPP TS 36.331 [12].
If the MBMS SAI check indicates at least one of the MBMS SAIs is included in
the MBMS SAI list of the serving cell, the ProSe UE-to-network relay UE shall
monitor the TMGI received in the TMGI_MONITORING_REQUEST in the MCCH channel
of the serving cell as specified in 3GPP TS 36.331 [12].
If the MBMS SAI check indicates none of the MBMS SAIs is included in the MBMS
SAI list of the serving cell, the ProSe UE-to-network relay UE shall not
monitor the TMGI received in the TMGI_MONITORING_REQUEST in the MCCH channel
of the serving cell as specified in 3GPP TS 36.331 [12].
For the receiving TMGI, the ProSe UE-to-network relay UE shall allocate a
ProSe Layer 2 Group ID which is neither provisioned for one-to-many direct
communication nor used for other TMGI(s). The ProSe UE-to-network relay UE
shall also allocate a value for TMGI monitoring refresh timer T4104 to the
remote UE, and start a timer T4105. For a given TMGI, the timer T4105 shall be
longer than the TMGI monitoring refresh timer T4104.
For the receiving Requested ProSe Per-Packet Priority, the ProSe UE-to-network
relay UE shall associate the ProSe Per-Packet Priority value with the
receiving TMGI. If there is only one ProSe Per-Packet Priority value
associated with the receiving TMGI, the ProSe UE-to-network relay UE shall use
the ProSe Per-Packet Priority value to transmit the relayed MBMS traffic
corresponding to the TMGI over PC5. If there are several different ProSe Per-
Packet Priority values associated with the receiving TMGI, which ProSe Per-
Packet Priority value will be used to transmit the TMGI corresponding MBMS
traffic over PC5 is based on ProSe UE-to-network relay UE implementation.
Then the ProSe UE-to-network relay UE shall send a TMGI_MONITORING_RESPONSE
with:
\- the ProSe Layer2 Group ID set to the allocated ProSe Layer 2 Group ID as
the link layer identifier of the group for transmitting the MBMS content
corresponding to the TMGI received in the TMGI_MONITORING_REQUEST;
\- the TMGI monitoring refresh timer T4104 set to the T4104 timer value
allocated by the ProSe UE-to-network relay UE for the TMGI received in the
TMGI_MONITORING_REQUEST; and
\- the SAI Indicator set to \"true\" if the MBMS SAI check indicates at least
one of the MBMS SAIs is included in the MBMS SAI list of the serving cell, set
to \"false\" if the MBMS SAI check indicates none of the MBMS SAIs is included
in the MBMS SAI list of the serving cell.
NOTE 1: If different ProSe UE-to-network relay UE allocates the same ProSe
Layer 2 Group ID for MBMS content transmitting, the remote UE can use the
Source Layer-2 ID (i.e. ProSe Relay UE ID) to distinguish whether the MBMS
content is the requested MBMS content or not. If the Source Layer-2 ID is
different from the ProSe Relay UE ID of the selected ProSe UE-to-network relay
UE, the remote UE can just discard the MBMS content from this Source Layer-2
ID.
NOTE 2: The applicable action when the remote UE receives a
TMGI_MONITORING_RESPONSE with the SAI Indicator set to \"false\" is up to UE
implementation (e.g. keep the currently selected ProSe UE-to-network relay UE
or reselect another ProSe UE-to-network relay UE).
If timer T4105 expires, the ProSe UE-to-network relay UE shall remove the TMGI
and the MBMS SAIs received in the TMGI_MONITORING_REQUEST.
### 10.5.4 TMGI monitoring request procedure completion by the remote UE
Upon receiving a TMGI_MONITORING_RESPONSE, the UE shall, for the ProSe Layer2
Group ID received in the TMGI_MONITORING_RESPONSE, stop the TMGI monitoring
refresh timer T4104 if running and start the TMGI monitoring refresh timer
T4104 with the received value.
### 10.5.5 Abnormal cases
#### 10.5.5.1 Abnormal cases in the remote UE
The following abnormal cases can be identified:
a) No response from the ProSe UE-to-network relay UE after the
TMGI_MONITORING_REQUEST has been successfully delivered
The remote UE shall retransmit the TMGI_MONITORING_REQUEST.
NOTE: The timer to trigger retransmission and the maximum number of allowed
retransmissions are UE implementation specific.
b) Indication from upper layers that the request to receive the MBMS content
for a given TMGI is no longer in place after sending the
TMGI_MONITORING_REQUEST, but before the TMGI monitoring request procedure is
completed
The remote UE shall discard the TMGI_MONITORING_RESPONSE received from the
ProSe UE-to-network relay UE and then abort the procedure.
## 10.6 Cell ID announcement request procedure
### 10.6.1 General
The purpose of the cell ID announcement request procedure is for the remote UE
to obtain ECGI of the cell serving the ProSe UE-to-network relay.
The remote UE in this procedure shall be a ProSe-enabled Public Safety UE and
is authorised to act as a remote UE towards a ProSe UE-to-network relay UE
based on the service authorisation procedure as specified in clause 5. The
ProSe UE-to-network relay UE in this procedure shall be a ProSe-enabled Public
Safety UE and is authorised to act as a ProSe UE-to-network relay UE based on
the service authorisation procedure as specified in clause 5.
### 10.6.2 Cell ID announcement request procedure initiation by the remote UE
Before initiating the cell ID announcement request procedure, a direct link
has been successfully established between the remote UE and the ProSe UE-to-
network relay UE.
The remote UE shall initiate a cell ID announcement request procedure:
a) when the remote UE is triggered by an upper layer application to report
ECGI of the serving cell to the application server, but cannot receive the
PC5_DISCOVERY message for Relay Discovery Additional Information from the
ProSe UE-to-network relay UE, or the ECGI is not included in the PC5_DISCOVERY
message for Relay Discovery Additional Information from the ProSe UE-to-
network relay UE; or
b) when the ECGI announcement request refresh timer T4106 expires and the
remote UE still needs to obtain ECGI of the cell serving the ProSe UE-to-
network relay.
The remote UE shall generate a CELL_ID_ANNOUNCEMENT_REQUEST message and pass
this message to the lower layers for transmission along with the remote UE\'s
Layer 2 ID (for unicast communication) and the ProSe UE-to-network relay UE\'s
Layer 2 ID (for unicast communication).
Figure 10.6.2.1: Cell ID announcement request procedure
### 10.6.3 Cell ID announcement request procedure accepted by the ProSe UE-to-
network relay UE
Upon receiving a CELL_ID_ANNOUNCEMENT_REQUEST message, the ProSe UE-to-network
relay UE shall allocate an ECGI announcement request refresh timer T4106 to
the remote UE, and start a timer T4107. The timer T4107 shall be longer than
the ECGI announcement request refresh timer T4106.
Then the ProSe UE-to-network relay UE shall respond a
CELL_ID_ANNOUNCEMENT_RESPONSE message with a ECGI announcement request refresh
timer T4106 IE set to the T4106 timer value assigned by the ProSe UE-to-
network relay UE.
### 10.6.4 Cell ID announcement request procedure completion by the remote UE
Upon receiving a CELL_ID_ANNOUNCEMENT_RESPONSE message, the UE shall start the
ECGI announcement request refresh timer T4106 with the received value.
### 10.6.5 Abnormal cases
#### 10.6.5.1 Abnormal cases in the remote UE
If there is no response from the ProSe UE-to-network relay UE after the
CELL_ID_ANNOUNCEMENT_REQUEST message has been successfully delivered, the
remote UE shall retransmit the CELL_ID_ANNOUNCEMENT_REQUEST message.
NOTE: The timer to trigger retransmission and the maximum number of allowed
retransmissions are UE implementation specific.
## 10.7 Remote UE information request procedure
### 10.7.1 General
The purpose of the remote UE information request procedure is for the serving
ProSe UE-to-network relay UE to obtain the information from the remote UE
served by the relay. This procedure can only be initiated by the ProSe UE-to-
network relay UE, over an established link between the remote UE and the ProSe
UE-to-network relay UE.
### 10.7.2 Remote UE information request procedure initiation by the ProSe UE-
to-network relay UE
Before initiating the remote UE information request procedure, a direct link
has been successfully established between the remote UE and the ProSe UE-to-
network relay UE.
The ProSe UE-to-network relay UE shall generate a REMOTE_UE_INFO_REQUEST
message containing the Remote UE Information Type IE set to the requested type
of information as specified in subclause 11.4.18, and pass this message to the
lower layers for transmission along with the remote UE\'s Layer 2 ID for
unicast communication (i.e., ProSe UE ID) and the ProSe UE-to-network relay
UE\'s Layer 2 ID for unicast communication (i.e., ProSe Relay UE ID).
Figure 10.7.2.1: Remote UE information request procedure
### 10.7.3 Remote UE information request accepted by the remote UE
Upon receiving a REMOTE_UE_INFO_REQUEST message, the remote UE shall include
the requested type of information in a REMOTE_UE_INFO_RESPONSE message, as
specified in subclause 11.4.19.
### 10.7.4 Remote UE information request procedure completion by the ProSe UE-
to-network relay UE
Upon receiving a REMOTE_UE_INFO_RESPONSE message, the ProSe UE-to-network
relay UE shall store the information provided by the remote UE temporarily so
that the remote UE identity can be reported to the MME, as specified in 3GPP
TS 24.301 [11].
NOTE: After the ProSe UE-to-network relay UE reports the information of the
remote UE to the MME, the stored remote UE information is deleted.
### 10.7.5 Abnormal cases
#### 10.7.5.1 Abnormal cases in the ProSe UE-to-network relay UE
If there is no response from the remote UE after the REMOTE_UE_INFO_REQUEST
message has been successfully delivered, the ProSe UE-to-network relay UE
shall retransmit the REMOTE_UE_INFO_REQUEST message.
NOTE: The timer to trigger retransmission and the maximum number of allowed
retransmissions are UE implementation specific.
## 10.8 Non-IP data transport procedure
### 10.8.1 General
The purpose of the non-IP data transport procedure is to transport, from the
upper layers of a sending UE to the upper layers of the receiving UE, the
following information over the PC5 interface:
\- non-IP data; and
\- non-IP type.
### 10.8.2 Non-IP data transmission over PC5
Upon a request from upper layers to send a non-IP data of a non-IP type, the
UE shall create a non-IP data PDU, shall set the non-IP payload field of the
non-IP data PDU to the non-IP data provided by upper layers, and shall set the
non-IP type field of the non-IP data PDU to the non-IP type provided by upper
layers, as specified in subclause 11.5. The UE shall then pass the non-IP data
PDU to the lower layers for transmission.
### 10.8.3 Non-IP data reception over PC5
Upon receiving a non-IP data PDU from the lower layers, the UE shall either:
  * check the non-IP type field in the non-IP data PDU and provide the non-IP data in the non-IP payload field of the non-IP data PDU to the corresponding upper layer entity; or
  * provide the upper layers with the non-IP data in the non-IP payload field of the non-IP data PDU and with the non-IP type in the non-IP type field of the non-IP data PDU.
# 10A ProSe direct discovery for public safety use
## 10A.1 Overview
This clause describes the procedures for ProSe direct discovery for public
safety use at a ProSe-enabled public safety UE over the PC5 reference point.
## 10A.2 Procedures
### 10A.2.1 General
The following procedures are defined for the ProSe direct discovery for public
safety use:
\- announcing UE procedure for UE-to-network relay discovery;
\- monitoring UE procedure for UE-to-network relay discovery;
\- discoverer UE procedure for UE-to-network relay discovery;
\- discoveree UE procedure for UE-to-network relay discovery;
\- announcing UE procedure for group member discovery;
\- monitoring UE procedure for group member discovery;
\- discoverer UE procedure for group member discovery;
\- discoveree UE procedure for group member discovery;
\- announcing UE procedure for UE-to-network relay discovery additional
information; and
\- monitoring UE procedure for UE-to-network relay discovery additional
information;
Each ProSe-enabled Public Safety UE needs to obtain the security parameters
from the ProSe Key Management Function before participating in ProSe direct
discovery for public safety use, as specified in 3GPP TS 33.303 [6]. For each
given Relay Service Code in UE-to-network relay discovery or Discovery Group
ID in group member discovery, the ProSe Key Management Function (PKMF) will
provide the following in the security parameters:
\- PSDK (Public Safety Discovery Key) and the associated Expiry Time for this
PSDK;
\- configurations to signal which combination of keys to be used for the
discovery process; and
\- optionally, if DUCK is to be used, an indication of which PC5_DISCOVERY
message fields shall be protected by the DUCK.
After receiving the PSDK from the PKMF for the relay service or discovery
group, the UE shall use it to derive specific DUIK, DUCK and DUSK needed to
protect the ProSe direct discovery messages for the corresponding public
safety use, as specified in 3GPP TS 33.303 [6].
### 10A.2.1A Radio resource selection
The UE shall select the radio resource parameters to be used for ProSe direct
discovery as follows:
\- when the UE is served by E-UTRAN and intends to use the ProSe radio
resources (i.e. carrier frequency) obtained from the serving cell,
1) the UE shall use the radio resource parameters indicated by the serving
cell (same or different from that of the serving cell) as specified in 3GPP TS
36.331 [12], if the corresponding PLMN is authorised for ProSe direct
discovery; and
2) according to the radio resources (i.e. carrier frequency) along with PLMN
ID which the serving cell indicates as allowed for ProSe direct discovery as
defined in 3GPP TS 36.331 [12], if the UE intends to use one of the radio
resources not operated by the serving cell for ProSe direct discovery and the
corresponding PLMN is authorised for ProSe direct discovery, the UE shall
search for a cell with the indicated PLMN operating the indicated radio
resources as defined in 3GPP TS 36.331 [12] and 3GPP TS 36.304 [23], and
obtain the radio resource parameters for ProSe direct discovery from that
cell, without performing PLMN selection; and
\- when the UE is not served by E-UTRAN or when the UE is served by E-UTRAN
and intends to use the provisioned ProSe radio resources (i.e. carrier
frequency):
1) if the UE can determine itself located in a geographical area, and the UE
is provisioned with radio parameters for the geographical area, then the UE
shall search for a cell with any PLMN operating the selected provisioned radio
resources (i.e. carrier frequency) associated with that geographical area,
and:
NOTE: It is out of scope of the present specification to define how the UE can
locate itself in a specific geographical area. When the UE is in coverage of a
3GPP RAT it can for example use information derived from the serving PLMN.
When the UE is not in coverage of a 3GPP RAT it can use other techniques as
determined by local regulations.
i) if the UE finds such a cell belonging to a PLMN in which the UE is
authorised for ProSe direct discovery and the cell provides radio resource
parameters for ProSe direct discovery, then the UE shall use the indicated
radio resource parameters for ProSe direct discovery;
ii) if the UE finds such a cell but not in a PLMN authorised for ProSe direct
discovery, then the UE shall not use the ProSe direct discovery in that
carrier frequency; or
iii) if the UE does not find any such cell in any PLMN, then the UE shall use
the provisioned radio resource parameters; or
2) else the UE shall not initiate ProSe direct discovery.
If the UE is performing ProSe direct discovery using radio resource parameters
associated with a geographical area and moves out of that geographical area,
the UE shall perform ProSe direct discovery using new radio resource
parameters selected for ProSe direct discovery as described in this subclause.
### 10A.2.2 Announcing UE procedure for UE-to-network relay discovery
#### 10A.2.2.1 General
The purpose of the announcing UE procedure for UE-to-network relay discovery
is:
\- to enable a ProSe-enabled public safety UE to announce availability of a
connectivity service provided by a UE-to-network relay of the ProSe-enabled
public safety UE to other ProSe-enabled public safety UEs, upon a request from
upper layers as defined in 3GPP TS 23.303 [2]; or
\- to enable a ProSe-enabled public safety UE to measure the PC5_DISCOVERY
message signal strength between the ProSe-enabled public safety UE and the
ProSe UE-to-network relay UE(s) for relay selection/reselection.
#### 10A.2.2.2 Announcing UE procedure for UE-to-network relay discovery
initiation
The UE is authorised to perform the announcing UE procedure for UE-to-network
relay discovery if:
a) the UE is authorised to act as a UE-to-network relay in the PLMN indicated
by the serving cell as specified in clause 5, and
\- the UE is served by E-UTRAN and the UE is authorised to perform ProSe
direct discovery for public safety use announcing in the PLMN as specified in
clause 5, and the lower layers indicate that discovery operation of a UE-to-
network relay is supported; or
\- the UE is authorised to perform ProSe direct discovery for public safety
use announcing when not served by E-UTRAN as specified in clause 5 and intends
to use the provisioned radio resources for UE-to-network relay discovery; and
b) the UE is configured with the Relay Service Code parameter identifying the
connectivity service to be announced and with the User Info ID for the UE-to-
network relay discovery parameter, as specified in clause 5;
otherwise the UE is not authorised to perform the announcing UE procedure for
UE-to-network relay discovery.
Figure 10A.2.2.2.1 illustrates the interaction of the UEs in the announcing UE
procedure for UE-to-network relay discovery.
Figure 10A.2.2.2.1: Announcing UE procedure for UE-to-network relay discovery
When the UE is triggered by an upper layer application to announce
availability of a connectivity service provided by a UE-to-network relay, if
the UE is authorised to perform the announcing UE procedure for UE-to-network
relay discovery, then the UE:
a) if the UE is served by E-UTRAN, and the UE in EMM-IDLE mode needs to
request resources for sending PC5_DISCOVERY messages for relay discovery for
public safety as specified in 3GPP TS 36.331 [12], shall perform a service
request procedure or tracking area update procedure as specified in 3GPP TS
24.301 [11];
b) shall obtain a valid UTC time for the discovery transmission from the lower
layers and generate the UTC-based counter corresponding to this UTC time as
specified in subclause 12.2.2.18;
c) shall generate a PC5_DISCOVERY message for UE-to-Network Relay Discovery
Announcement according to subclause 11.2.5.1. In the PC5_DISCOVERY message for
UE-to-Network Relay Discovery Announcement, the UE:
1) shall set the ProSe Relay UE ID to a ProSe Relay UE ID used for ProSe
direct communication for the connectivity service to be announced;
2) shall set the Announcer Info parameter to the User Info ID for the UE-to-
network relay discovery parameter, configured in clause 5;
3) shall set the Relay Service Code parameter to the Relay Service Code
parameter identifying the connectivity service to be announced, configured in
clause 5;
4) shall set the UTC-based counter LSB parameter to include the eight least
significant bits of the UTC-based counter; and
5) shall set the Resource Status Indicator bit of the Status Indicator
parameter to indicate whether or not the UE has resources available to provide
a connectivity service for additional ProSe-enabled public safety UEs;
d) shall apply the DUIK, DUSK, or DUCK with the associated Encrypted Bitmask,
along with the UTC-based counter to the PC5_DISCOVERY message for whichever
security mechanism(s) configured to be applied, e.g. integrity protection,
message scrambling or confidentiality protection of one or more above
parameters, as specified in 3GPP TS 33.303 [6]; and
e) shall pass the resulting PC5_DISCOVERY message for UE-to-Network Relay
Discovery Announcement to the lower layers for transmission over the PC5
interface with an indication that the message is for relay discovery for
public safety use.
The UE shall ensure that it keeps on passing the same PC5_DISCOVERY message
and the indication that the message is for relay discovery for public safety
use to the lower layers for transmission until the UE is triggered by an upper
layer application to stop announcing availability of a connectivity service
provided by a UE-to-network relay, or until the UE stops being authorised to
perform the announcing UE procedure for UE-to-network relay discovery. How
this is achieved is left up to UE implementation.
#### 10A.2.2.3 Announcing UE procedure for UE-to-network relay discovery
completion
When the UE is triggered by an upper layer application to stop announcing
availability of a connectivity service provided by a UE-to-network relay, or
when the UE stops being authorised to perform the announcing UE procedure for
UE-to-network relay discovery, the UE shall instruct the lower layers to stop
announcing.
When the UE stops announcing, if the UE is in EMM-CONNECTED mode, the UE shall
trigger the corresponding procedure in lower layers as specified in 3GPP TS
36.331 [12].
### 10A.2.3 Monitoring UE procedure for UE-to-network relay discovery
#### 10A.2.3.1 General
The purpose of the monitoring UE procedure for UE-to-network relay discovery
is:
\- to enable a ProSe-enabled public safety UE to become aware of proximity of
a connectivity service provided by a UE-to-network relay, upon a request from
upper layers as defined in 3GPP TS 23.303 [2]; or
\- to enable a ProSe-enabled public safety UE to perform measurements of
signal strength of PC5_DISCOVERY messages from ProSe UE-to-network relay UE(s)
for relay selection/reselection.
#### 10A.2.3.2 Monitoring UE procedure for UE-to-network relay discovery
initiation
The UE is authorised to perform the monitoring UE procedure for UE-to-network
relay discovery if:
a) the following is true:
1) the UE is not served by E-UTRAN, is authorised to perform ProSe direct
discovery for public safety use monitoring when the UE is not served by
E-UTRAN as specified in clause 5, is authorised to act as a remote UE towards
a UE-to-network relay as specified in clause 5 and is configured with the
radio parameters to be used for ProSe direct discovery for public safety use
when not served by E-UTRAN;
2) the UE is served by E-UTRAN, is authorised to perform ProSe direct
discovery for public safety use monitoring in at least one PLMN as specified
in clause 5, is authorised to act as a remote UE towards a UE-to-network
relay, and the lower layers indicate that discovery operation of a UE-to-
network relay is supported; or
3) the UE is:
\- in EMM-IDLE mode, in limited service state as specified in 3GPP TS 23.122
[24], and the reason for the UE being in limited service state is one of the
following:
i) the UE is unable to find a suitable cell in the selected PLMN as specified
in 3GPP TS 36.304 [23];
ii) the UE received an ATTACH REJECT message or a TRACKING AREA UPDATE REJECT
message or a SERVICE REJECT message with the EMM cause #11 \"PLMN not
allowed\" as specified in 3GPP TS 24.301 [11] or a LOCATION UPDATING REJECT
message or a GPRS ATTACH REJECT message or ROUTING AREA UPDATE REJECT message
or SERVICE REJECT message with cause #11 \"PLMN not allowed\" as specified in
3GPP TS 24.008 [30]; or
iii) the UE received an ATTACH REJECT message or a TRACKING AREA UPDATE REJECT
message or a SERVICE REJECT message with the EMM cause #7 \"EPS services not
allowed\" as specified in 3GPP TS 24.301 [11] or a LOCATION UPDATING REJECT
message or a GPRS ATTACH REJECT message or ROUTING AREA UPDATE REJECT message
or SERVICE REJECT message with cause #7 \"GPRS services not allowed\" as
specified in 3GPP TS 24.008 [30]; and
\- authorised to perform ProSe direct discovery for public safety use
monitoring when the UE is not served by E-UTRAN as specified in clause 5,
authorised to act as a remote UE towards a UE-to-network relay as specified in
clause 5, and:
i) configured with the radio parameters to be used for ProSe direct discovery
for public safety use when not served by E-UTRAN; or
ii) the lower layers indicate that discovery operation of a UE-to-network
relay is supported; and:
NOTE 1: When the lower layers indicate that discovery operation of a UE-to-
network relay is supported, the serving cell broadcasts a common radio
resources pool for public safety discovery reception and the UE can use this
common radio resources pool while in limited service state.
b) the UE is configured with the Relay Service Code parameter identifying the
connectivity service to be monitored and with the IP version(s) to be used for
the traffic of the connectivity service to be monitored, as specified in
clause 5;
otherwise the UE is not authorised to perform the monitoring UE procedure for
UE-to-network relay discovery.
Figure 10A.2.3.2.1 illustrates the interaction of the UEs in the monitoring UE
procedure for UE-to-network relay discovery.
Figure 10A.2.3.2.1: Monitoring UE procedure for UE-to-network relay discovery
When the UE is triggered by an upper layer application to monitor proximity of
a connectivity service provided by a UE-to-network relay; or when the UE has
established a direct link with a ProSe UE-to-network relay UE as specified in
subclause 10.4.2, and if the UE is authorised to perform the monitoring UE
procedure for UE-to-network relay discovery, then the UE shall instruct the
lower layers to start monitoring for PC5_DISCOVERY messages with an indication
that the message is for relay discovery for public safety use.
Upon reception of a PC5_DISCOVERY message for UE-to-Network Relay Discovery
Announcement according to subclause 11.2.5.1, for the target Relay Service
Code of the connectivity service which the UE is authorized to monitor, the UE
shall use the associated DUSK, if configured, and the UTC-based counter
obtained during the monitoring operation to unscramble the PC5_DISCOVERY
message as described in 3GPP TS 33.303 [6]. Then, if a DUCK is configured, the
UE shall use the DUCK and the UTC-based counter to decrypt the configured
message-specific confidentiality-protected portion, as described in 3GPP TS
33.303 [6]. Finally, if a DUIK is configured, the UE shall use the DUIK and
the UTC-based counter to verify the MIC field in the unscrambled PC5_DISCOVERY
message for UE-to-Network Relay Discovery Announcement.
NOTE 2: The use of an erroneous UTC-based counter for processing the received
PC5_DISCOVERY messages at the ProSe-enabled Public Safety UE can cause MIC
check failure after DUIK is used for integrity check, and malformed contents
after DUSK is used for unscrambling or DUCK is used for deciphering. How a
ProSe-enabled Public Safety UE ensures the accuracy of the UTC-based counter
is left to UE implementation.
Then if:
\- the Relay Service Code parameter of the PC5_DISCOVERY message for UE-to-
Network Relay Discovery Announcement is the same as the Relay Service Code
parameter configured as specified in clause 5 for the connectivity service
being monitored; and
\- the User Info ID of the UE-to-network relay is not configured as specified
in clause 5 for the connectivity service being monitored, or the Announcer
Info parameter of the PC5_DISCOVERY message for UE-to-Network Relay Discovery
Announcement is the same as the User Info ID of the UE-to-network relay
configured as specified in clause 5 for the connectivity service being
monitored;
_then the UE shall consider that the_ connectivity service the UE _seeks to
monitor has been discovered. In addition, the UE can measure the signal
strength of the_ PC5_DISCOVERY message for UE-to-Network Relay Discovery
Announcement _for relay selection or reselection._
#### 10A.2.3.3 Monitoring UE procedure for UE-to-network relay discovery
completion
When the UE is triggered by an upper layer application to stop monitoring
proximity of a connectivity service provided by a UE-to-network relay, or when
the UE stops being authorised to perform the monitoring UE procedure for UE-
to-network relay discovery, the UE shall instruct the lower layers to stop
monitoring.
When the UE stops monitoring, if the UE is in EMM-CONNECTED mode, the UE shall
trigger the corresponding procedure in lower layers as specified in 3GPP TS
36.331 [12].
### 10A.2.4 Discoverer UE procedure for UE-to-network relay discovery
#### 10A.2.4.1 General
The purpose of the discoverer UE procedure for UE-to-network relay discovery
is:
\- to enable a ProSe-enabled public safety UE to solicit proximity of a
connectivity service provided by a UE-to-network relay, upon a request from
upper layers as defined in 3GPP TS 23.303 [2]; or
\- to enable a ProSe-enabled public safety UE to measure the PC5_DISCOVERY
message signal strength between the ProSe-enabled public safety UE and the
ProSe UE-to-network relay UE(s) for relay selection/reselection.
#### 10A.2.4.2 Discoverer UE procedure for UE-to-network relay discovery
initiation
The UE is authorised to perform the discoverer UE procedure for UE-to-network
relay discovery if:
a) the following is true:
1) the UE is not served by E-UTRAN, is authorised to perform ProSe direct
discovery for public safety use discoverer operation when the UE is not served
by E-UTRAN as specified in clause 5, is authorised to act as a remote UE
towards a UE-to-network relay as specified in clause 5 and is configured with
the radio parameters to be used for ProSe direct discovery for public safety
use when not served by E-UTRAN;
2) the UE is served by E-UTRAN, is authorised to perform ProSe direct
discovery for public safety use discoverer operation in the PLMN indicated by
the serving cell as specified in clause 5, is authorised to act as a remote UE
towards a UE-to-network relay, and the lower layers indicate that discovery
operation of a UE-to-network relay is supported; or
3) the UE is:
\- in EMM-IDLE mode, in limited service state as specified in 3GPP TS 23.122
[24], and the reason for the UE being in limited service state is one of the
following:
i) the UE is unable to find a suitable cell in the selected PLMN as specified
in 3GPP TS 36.304 [23];
ii) the UE received an ATTACH REJECT message or a TRACKING AREA UPDATE REJECT
message or a SERVICE REJECT message with the EMM cause #11 \"PLMN not
allowed\" as specified in 3GPP TS 24.301 [11] or a LOCATION UPDATING REJECT
message or a GPRS ATTACH REJECT message or ROUTING AREA UPDATE REJECT message
or SERVICE REJECT message with cause #11 \"PLMN not allowed\" as specified in
3GPP TS 24.008 [30]; or
iii) the UE received an ATTACH REJECT message or a TRACKING AREA UPDATE REJECT
message or a SERVICE REJECT message with the EMM cause #7 \"EPS services not
allowed\" as specified in 3GPP TS 24.301 [11] or a LOCATION UPDATING REJECT
message or a GPRS ATTACH REJECT message or ROUTING AREA UPDATE REJECT message
or SERVICE REJECT message with cause #7 \"GPRS services not allowed\" as
specified in 3GPP TS 24.008 [30]; and
\- authorised to perform ProSe direct discovery for public safety use
discoverer operation when the UE is not served by E-UTRAN as specified in
clause 5, authorised to act as a remote UE towards a UE-to-network relay as
specified in clause 5, and:
i) configured with the radio parameters to be used for ProSe direct discovery
for public safety use when not served by E-UTRAN; or
ii) the lower layers indicate that discovery operation of a UE-to-network
relay is supported and that the UE does not need to request resources for
sending PC5_DISCOVERY messages for public safety as specified in 3GPP TS
36.331 [12]; and
NOTE 1: When the lower layers indicate that discovery operation of a UE-to-
network relay is supported and that the UE does not need to request resources
for sending PC5_DISCOVERY messages for public safety as specified in 3GPP TS
36.331 [12], the serving cell broadcasts a common radio resources pool for
public safety discovery transmission and the UE can use this common radio
resources pool while in limited service state.
b) the UE is configured with the Relay Service Code parameter identifying the
connectivity service to be solicited and with the User Info ID for the UE-to-
network relay discovery parameter, as specified in clause 5;
otherwise the UE is not authorised to perform the Discoverer UE procedure for
UE-to-network relay discovery.
Figure 10A.2.4.2.1 illustrates the interaction of the UEs in the Discoverer UE
procedure for UE-to-network relay discovery.
Figure 10A.2.4.2.1: Discoverer UE procedure for UE-to-network relay discovery
For PC5_DISCOVERY message signal strength measurement, the UE manages a
periodic measurement timer T4110, which is used to trigger the periodic
PC5_DISCOVERY message signal strength measurement between the UE and the ProSe
UE-to-network relay UE with which the UE has a link established. It is started
whenever the UE has established a direct link with a ProSe UE-to-network relay
UE as specified in subclause 10.4.2 and restarted whenever the UE receives the
PC5_DISCOVERY message for UE-to-Network Relay Discovery Response from the
ProSe UE-to-network relay UE with which the UE has a link established.
When the UE is triggered by an upper layer application to solicit proximity of
a connectivity service provided by a UE-to-network relay, or when the periodic
measurement timer T4110 expires, and if the UE is authorised to perform the
discoverer UE procedure for UE-to-network relay discovery, then the UE:
a) if the UE is served by E-UTRAN, and the UE in EMM-IDLE mode needs to
request resources for sending PC5_DISCOVERY messages for relay discovery for
public safety as specified in 3GPP TS 36.331 [12], shall perform a service
request procedure or tracking area update procedure as specified in 3GPP TS
24.301 [11];
b) shall obtain a valid UTC time for the discovery transmission from the lower
layers and generate the UTC-based counter corresponding to this UTC time as
specified in subclause 12.2.2.18;
c) shall generate a PC5_DISCOVERY message for UE-to-Network Relay Discovery
Solicitation according to subclause 11.2.5.1. In the PC5_DISCOVERY message for
UE-to-Network Relay Discovery Solicitation, the UE:
1) shall set the Discoverer Info parameter to the User Info ID for the UE-to-
network relay discovery parameter, configured in clause 5;
2) shall set the Relay Service Code parameter to the Relay Service Code
parameter identifying the connectivity service to be solicited, configured in
clause 5;
3) if the PC5_DISCOVERY message for UE-to-Network Relay Discovery Solicitation
is used to trigger the signal strength measurement for the PC5_DISCOVERY
message from a specific ProSe UE-to-network relay UE with which the UE has a
link established, shall set the ProSe Relay UE ID parameter to the ProSe Relay
UE ID of that ProSe UE-to-network relay UE; and
4) shall set the UTC-based counter LSB parameter to include the four least
significant bits of the UTC-based counter;
d) shall apply the DUIK, DUSK, or DUCK with the associated Encrypted Bitmask,
along with the UTC-based counter to the PC5_DISCOVERY message for whichever
security mechanism(s) configured to be applied, e.g. integrity protection,
message scrambling or confidentiality protection of one or more above
parameters, as specified in 3GPP TS 33.303 [6]; and
e) shall pass the resulting PC5_DISCOVERY message for UE-to-Network Relay
Discovery Solicitation to the lower layers for transmission over the PC5
interface with an indication that the message is for relay discovery for
public safety use.
If the PC5_DISCOVERY message for UE-to-Network Relay Discovery Solicitation is
used to solicit proximity of a connectivity service provided by a UE-to-
network relay, the UE shall ensure that it keeps on passing the PC5_DISCOVERY
message for UE-to-Network Relay Discovery Solicitation and the indication that
the message is for relay discovery for public safety use to the lower layers
for transmission until the UE is triggered by an upper layer application to
stop soliciting proximity of a connectivity service provided by a UE-to-
network relay, or until the UE stops being authorised to perform the
discoverer UE procedure for UE-to-network relay discovery. How this is
achieved is left up to UE implementation.
If the PC5_DISCOVERY message for UE-to-Network Relay Discovery Solicitation is
used to trigger the PC5_DISCOVERY message signal strength measurement between
the UE and the ProSe UE-to-network relay UE with which the UE has a link
established, the UE shall start the retransmission timer T4109. If
retransmission timer T4109 expires, the UE shall retransmit the PC5_DISCOVERY
message for UE-to-Network Relay Discovery Solicitation and restart timer
T4109. If no response is received from the ProSe UE-to-network relay UE with
which the UE has a link established after reaching the maximum number of
allowed retransmissions, the UE shall trigger relay reselection procedure.
NOTE 2: The maximum number of allowed retransmissions is UE implementation
specific.
Upon reception of a PC5_DISCOVERY message for UE-to-Network Relay Discovery
Response according to subclause 11.2.5.1, for the target Relay Service Code of
the connectivity service which the UE is authorized to discover, the UE shall
use the associated DUSK, if configured, and the UTC-based counter obtained
during the reception operation to unscramble the PC5_DISCOVERY message as
described in 3GPP TS 33.303 [6]. Then, if a DUCK is configured, the UE shall
use the DUCK and the UTC-based counter to decrypt the configured message-
specific confidentiality-protected portion, as described in 3GPP TS 33.303
[6]. Finally, if a DUIK is configured, the UE shall use the DUIK and the UTC-
based counter to verify the MIC field in the unscrambled PC5_DISCOVERY message
for UE-to-Network Relay Discovery Response.
Then if:
\- the Relay Service Code parameter of the PC5_DISCOVERY message for UE-to-
Network Relay Discovery Response is the same as the Relay Service Code
parameter of the PC5_DISCOVERY message for UE-to-Network Relay Discovery
Solicitation; and
\- the User Info ID of the UE-to-network relay is not configured as specified
in clause 5 for the connectivity service being solicited, or the Discoverer
Info parameter of the PC5_DISCOVERY message for UE-to-Network Relay Discovery
Response is the same as the User Info ID of the UE-to-network relay configured
as specified in clause 5 for the connectivity service being solicited;
then _the UE shall consider that the_ connectivity service the UE _seeks to
discover has been discovered._ _In addition, the UE can measure the signal
strength of the_ PC5_DISCOVERY message for UE-to-Network Relay Discovery
Response _for relay selection or reselection. If_ _the UE has received the_
PC5_DISCOVERY message for UE-to-Network Relay Discovery Response from the
ProSe UE-to-network relay UE with which the UE has a link established, the UE
shall stop the retransmission timer T4109, and start the periodic measurement
timer T4110.
#### 10A.2.4.3 Discoverer UE procedure for UE-to-network relay discovery
completion
When the UE is triggered by an upper layer application to stop soliciting for
proximity of a connectivity service provided by a UE-to-network relay, or when
the UE stops being authorised to perform the Discoverer UE procedure for UE-
to-network relay discovery, the UE shall instruct the lower layers to stop the
discoverer operation.
When the UE stops discoverer operation, if the UE is in EMM-CONNECTED mode,
the UE shall trigger the corresponding procedure in lower layers as specified
in 3GPP TS 36.331 [12].
### 10A.2.5 Discoveree UE procedure for UE-to-network relay discovery
#### 10A.2.5.1 General
The purpose of the discoveree UE procedure for UE-to-network relay discovery
is to enable a ProSe-enabled public safety UE with a UE-to-network relay to
respond to solicitation from other ProSe-enabled public safety UEs on
proximity of a connectivity service provided by the UE-to-network relay, upon
a request from upper layers as defined in 3GPP TS 23.303 [2].
#### 10A.2.5.2 Discoveree UE procedure for UE-to-network relay discovery
initiation
The UE is authorised to perform the discoveree UE procedure for UE-to-network
relay discovery if:
a) the UE is authorised to act as a UE-to-network relay in the PLMN indicated
by the serving cell as specified in clause 5, and
\- the UE is served by E-UTRAN and the UE is authorised to perform ProSe
direct discovery for public safety use discoveree operation in the PLMN as
specified in clause 5, and the lower layers indicate that discovery operation
of a UE-to-network relay is supported; or- the UE is authorised to perform
ProSe direct discovery for public safety use discoveree operation when not
served by E-UTRAN as specified in clause 5 and intends to use the provisioned
radio resources for UE-to-network relay discovery; and
b) the UE is configured with the Relay Service Code parameter identifying the
connectivity service to be responded to and with the User Info ID for the UE-
to-network relay discovery parameter, as specified in clause 5;
otherwise the UE is not authorised to perform the discoveree UE procedure for
UE-to-network relay discovery.
Figure 10A.2.5.2.1 illustrates the interaction of the UEs in the discoveree UE
procedure for UE-to-network relay discovery.
Figure 10A.2.5.2.1: Discoveree UE procedure for UE-to-network relay discovery
When the UE is triggered by an upper layer application to start responding to
solicitation on proximity of a connectivity service provided by the UE-to-
network relay, and if the UE is authorised to perform the discoveree UE
procedure for UE-to-network relay discovery, then the UE:
a) if the UE is served by E-UTRAN, and the UE in EMM-IDLE mode needs to
request resources for sending PC5_DISCOVERY messages for public safety as
specified in 3GPP TS 36.331 [12], shall perform a service request procedure or
tracking area update procedure as specified in 3GPP TS 24.301 [11]; and
b) shall instruct the lower layers to start monitoring for PC5_DISCOVERY
messages with an indication that the message is for relay discovery for public
safety use.
Upon reception of a PC5_DISCOVERY message for UE-to-Network Relay Discovery
Solicitation according to subclause 11.2.5.1, for the Relay Service Code of
the connectivity service which the UE is authorized to respond, the UE shall
use the associated DUSK, if configured, and the UTC-based counter obtained
during the reception operation to unscramble the PC5_DISCOVERY message as
described in 3GPP TS 33.303 [6]. Then, if a DUCK is configured, the UE shall
use the DUCK and the UTC-based counter to decrypt the configured message-
specific confidentiality-protected portion, as described in 3GPP TS 33.303
[6]. Finally, if a DUIK is configured, the UE shall use the DUIK and the UTC-
based counter to verify the MIC field in the unscrambled PC5_DISCOVERY message
for UE-to-Network Relay Discovery Solicitation.
Then, if the Relay Service Code parameter of the PC5_DISCOVERY message for UE-
to-Network Relay Discovery Solicitation is the same as the Relay Service Code
parameter configured as specified in clause 5 for the connectivity service and
either the ProSe Relay UE ID parameter is not included or the included ProSe
Relay UE ID parameter is the same as the ProSe Relay UE ID associated with the
Relay Service Code parameter configured as specified in clause 5, _the UE:_
a) shall obtain a valid UTC time for the discovery transmission from the lower
layers and generate the UTC-based counter corresponding to this UTC time as
specified in subclause 12.2.2.18;
b) shall generate a PC5_DISCOVERY message for UE-to-Network Relay Discovery
Response according to subclause 11.2.5.1. In the PC5_DISCOVERY message for UE-
to-Network Relay Discovery Response, the UE:
1) shall set the ProSe Relay UE ID to a ProSe Relay UE ID used for ProSe
direct communication for the connectivity service;
2) shall set the Discoveree Info parameter to the User Info ID for the UE-to-
network relay discovery parameter, configured in clause 5;
3) shall set the Relay Service Code parameter to the Relay Service Code
parameter of the PC5_DISCOVERY message for UE-to-Network Relay Discovery
Solicitation;
4) shall set the UTC-based counter LSB parameter to include the eight least
significant bits of the UTC-based counter; and
5) shall set the Resource Status Indicator bit of the Status Indicator
parameter to indicate whether or not the UE has resources available to provide
a connectivity service for additional ProSe-enabled public safety UEs;
c) shall apply the DUIK, DUSK, or DUCK with the associated Encrypted Bitmask,
along with the UTC-based counter to the PC5_DISCOVERY message for whichever
security mechanism(s) configured to be applied, e.g. integrity protection,
message scrambling or confidentiality protection of one or more above
parameters, as specified in 3GPP TS 33.303 [6]; and
d) shall pass the resulting PC5_DISCOVERY message for UE-to-Network Relay
Discovery Response with an indication that the message is for relay discovery
for public safety use to the lower layers for transmission over the PC5
interface.
#### 10A.2.5.3 Discoveree UE procedure for UE-to-network relay discovery
completion
When the UE is triggered by an upper layer application to stop responding to
solicitation on proximity of a connectivity service provided by a UE-to-
network relay, or when the UE stops being authorised to perform the discoveree
UE procedure for UE-to-network relay discovery, the UE shall instruct the
lower layers to stop monitoring.
When the UE stops monitoring, if the UE is in EMM-CONNECTED mode, the UE shall
trigger the corresponding procedure in lower layers as specified in 3GPP TS
36.331 [12].
### 10A.2.6 Announcing UE procedure for group member discovery
#### 10A.2.6.1 General
The purpose of the announcing UE procedure for group member discovery is to
enable a ProSe-enabled public safety UE to announce availability in a
discovery group to other ProSe-enabled public safety UEs, upon a request from
upper layers as defined in 3GPP TS 23.303 [2].
#### 10A.2.6.2 Announcing UE procedure for group member discovery initiation
The UE is authorised to perform the announcing UE procedure for group member
discovery if:
a) the following is true:
1) the UE is not served by E-UTRAN, is authorised to perform ProSe direct
discovery for public safety use announcing when the UE is not served by
E-UTRAN as specified in clause 5, and is configured with the radio parameters
to be used for ProSe direct discovery for public safety use when not served by
E-UTRAN;
2) the UE is served by E-UTRAN, and is authorised to perform ProSe direct
discovery for public safety use announcing in the PLMN indicated by the
serving cell as specified in clause 5; or
3) the UE is:
\- in EMM-IDLE mode, in limited service state as specified in 3GPP TS 23.122
[24], and the reason for the UE being in limited service state is one of the
following:
i) the UE is unable to find a suitable cell in the selected PLMN as specified
in 3GPP TS 36.304 [23];
ii) the UE received an ATTACH REJECT message or a TRACKING AREA UPDATE REJECT
message or a SERVICE REJECT message with the EMM cause #11 \"PLMN not
allowed\" as specified in 3GPP TS 24.301 [11] or a LOCATION UPDATING REJECT
message or a GPRS ATTACH REJECT message or ROUTING AREA UPDATE REJECT message
or SERVICE REJECT message with cause #11 \"PLMN not allowed\" as specified in
3GPP TS 24.008 [30]; or
iii) the UE received an ATTACH REJECT message or a TRACKING AREA UPDATE REJECT
message or a SERVICE REJECT message with the EMM cause #7 \"EPS services not
allowed\" as specified in 3GPP TS 24.301 [11] or a LOCATION UPDATING REJECT
message or a GPRS ATTACH REJECT message or ROUTING AREA UPDATE REJECT message
or SERVICE REJECT message with cause #7 \"GPRS services not allowed\" as
specified in 3GPP TS 24.008 [30]; and
\- authorised to perform ProSe direct discovery for public safety use
announcing when the UE is not served by E-UTRAN as specified in clause 5 and:
i) configured with the radio parameters to be used for ProSe direct discovery
for public safety use when not served by E-UTRAN; or
ii) the lower layers indicate that the UE does not need to request resources
for sending PC5_DISCOVERY messages for public safety as specified in 3GPP TS
36.331 [12]; and
NOTE: When the lower layers indicate that the UE does not need to request
resources for sending PC5_DISCOVERY messages for public safety as specified in
3GPP TS 36.331 [12], the serving cell broadcasts a common radio resources pool
for public safety discovery transmission and the UE can use this common radio
resources pool while in limited service state.
b) the UE is configured with the Discovery Group ID parameter identifying the
discovery group to be announced and with the User Info ID for the group member
discovery parameter, as specified in clause 5;
otherwise the UE is not authorised to perform the announcing UE procedure for
group member discovery.
Figure 10A.2.6.2.1 illustrates the interaction of the UEs in the announcing UE
procedure for group member discovery.
Figure 10A.2.6.2.1: Announcing UE procedure for group member discovery
When the UE is triggered by an upper layer application to announce
availability in a discovery group, if the UE is authorised to perform the
announcing UE procedure for group member discovery, then the UE:
a) if the UE is served by E-UTRAN, and the UE in EMM-IDLE mode needs to
request resources for sending PC5_DISCOVERY messages for public safety as
specified in 3GPP TS 36.331 [12], shall perform a service request procedure or
tracking area update procedure as specified in 3GPP TS 24.301 [11];
b) shall obtain a valid UTC time for the discovery transmission from the lower
layers and generate the UTC-based counter corresponding to this UTC time as
specified in subclause 12.2.2.18;
c) shall generate a PC5_DISCOVERY message for Group Member Discovery
Announcement according to subclause 11.2.5.1. In the PC5_DISCOVERY message for
Group Member Discovery Announcement, the UE:
1) shall set the ProSe UE ID to the Layer 2 ID used for unicast communication
configured in clause 5;
2) shall set the Announcer Info parameter to the User Info ID for the group
member discovery parameter, configured in clause 5;
3) shall set the Discovery Group ID parameter to the Discovery Group ID
parameter identifying the discovery group to be announced, configured in
clause 5; and
4) shall set the UTC-based counter LSB parameter to include the eight least
significant bits of the UTC-based counter;
d) shall apply the DUIK, DUSK, or DUCK with the associated Encrypted Bitmask,
along with the UTC-based counter to the PC5_DISCOVERY message for whichever
security mechanism(s) configured to be applied, e.g., integrity protection,
message scrambling or confidentiality protection of one or more above
parameters, as specified in 3GPP TS 33.303 [6]; and
e) shall pass the resulting PC5_DISCOVERY message for Group Member Discovery
Announcement to the lower layers for transmission over the PC5 interface with
an indication that the message is for public safety use.
The UE shall ensure that it keeps on passing the same PC5_DISCOVERY message
and the indication that the message is for public safety use to the lower
layers for transmission until the UE is triggered by an upper layer
application to stop announcing availability in a discovery group, or until the
UE stops being authorised to perform the announcing UE procedure for group
member discovery. How this is achieved is left up to UE implementation.
#### 10A.2.6.3 Announcing UE procedure for group member discovery completion
When the UE is triggered by an upper layer application to stop announcing
availability in a discovery group, or when the UE stops being authorised to
perform the announcing UE procedure for group member discovery, the UE shall
instruct the lower layers to stop announcing.
When the UE stops announcing, if the UE is in EMM-CONNECTED mode, the UE shall
trigger the corresponding procedure in lower layers as specified in 3GPP TS
36.331 [12].
### 10A.2.7 Monitoring UE procedure for group member discovery
#### 10A.2.7.1 General
The purpose of the monitoring UE procedure for group member discovery is to
enable a ProSe-enabled public safety UE to become aware of proximity of other
ProSe-enabled public safety UEs in a discovery group, upon a request from
upper layers as defined in 3GPP TS 23.303 [2].
#### 10A.2.7.2 Monitoring UE procedure for group member discovery initiation
The UE is authorised to perform the monitoring UE procedure for group member
discovery if:
a) the following is true:
1) the UE is not served by E-UTRAN, is authorised to perform ProSe direct
discovery for public safety use monitoring when the UE is not served by
E-UTRAN as specified in clause 5, and is configured with the radio parameters
to be used for ProSe direct discovery for public safety use when not served by
E-UTRAN;
2) the UE is served by E-UTRAN, and is authorised to perform ProSe direct
discovery for public safety use monitoring in at least one PLMN as specified
in clause 5; or
3) the UE is:
\- in EMM-IDLE mode, in limited service state as specified in 3GPP TS 23.122
[24, and the reason for the UE being in limited service state is one of the
following:
i) the UE is unable to find a suitable cell in the selected PLMN as specified
in 3GPP TS 36.304 [23];
ii) the UE received an ATTACH REJECT message or a TRACKING AREA UPDATE REJECT
message or a SERVICE REJECT message with the EMM cause #11 \"PLMN not
allowed\" as specified in 3GPP TS 24.301 [11] or a LOCATION UPDATING REJECT
message or a GPRS ATTACH REJECT message or ROUTING AREA UPDATE REJECT message
or SERVICE REJECT message with cause #11 \"PLMN not allowed\" as specified in
3GPP TS 24.008 [30]; or
iii) the UE received an ATTACH REJECT message or a TRACKING AREA UPDATE REJECT
message or a SERVICE REJECT message with the EMM cause #7 \"EPS services not
allowed\" as specified in 3GPP TS 24.301 [11] or a LOCATION UPDATING REJECT
message or a GPRS ATTACH REJECT message or ROUTING AREA UPDATE REJECT message
or SERVICE REJECT message with cause #7 \"GPRS services not allowed\" as
specified in 3GPP TS 24.008 [30]; and
\- authorised to perform ProSe direct discovery for public safety use
monitoring when the UE is not served by E-UTRAN as specified in clause 5, and:
i) configured with the radio parameters to be used for ProSe direct discovery
for public safety use when not served by E-UTRAN; or
ii) the lower layers indicate that public safety discovery operation is
supported; and:
NOTE 1: When the lower layers indicate that public safety discovery operation
is supported, the serving cell broadcasts a common radio resources pool for
public safety discovery reception and the UE can use this common radio
resources pool while in limited service state.
b) the UE is configured with the Discovery Group ID parameter identifying the
discovery group to be monitored, as specified in clause 5;
otherwise the UE is not authorised to perform the monitoring UE procedure for
group member discovery.
Figure 10A.2.7.2.1 illustrates the interaction of the UEs in the monitoring UE
procedure for group member discovery.
Figure 10A.2.7.2.1: Monitoring UE procedure for group member discovery;
When the UE is triggered by an upper layer application to monitor proximity of
other UEs in a discovery group, and if the UE is authorised to perform the
monitoring UE procedure for group member discovery, then the UE shall instruct
the lower layers to start monitoring for PC5_DISCOVERY messages with an
indication that the message is for public safety use.
Upon reception of a PC5_DISCOVERY message for Group Member Discovery
Announcement according to subclause 11.2.5.1, for the target Discovery Group
ID of the discovery group to be monitored, the UE shall use the associated
DUSK, if configured, and the UTC-based counter obtained during the monitoring
operation to unscramble the PC5_DISCOVERY message as described in 3GPP TS
33.303 [6]. Then, if a DUCK is configured, the UE shall use the DUCK and the
UTC-based counter to decrypt the configured message-specific confidentiality-
protected portion, as described in 3GPP TS 33.303 [6]. Finally, if a DUIK is
configured, the UE shall use the DUIK and UTC-based counter to verify the MIC
field in the unscrambled PC5_DISCOVERY message for Group Member Discovery
Announcement.
NOTE 2: The use of an erroneous UTC-based counter for processing received
PC5_DISCOVERY messages at the ProSe-enabled Public Safety UE can cause MIC
check failure after DUIK is used for integrity check, and malformed contents
after DUSK is used for unscrambling or DUCK is used for deciphering. How a
ProSe-enabled Public Safety UE ensures the accuracy of the UTC-based counter
is left to UE implementation.
Then if the Discovery Group ID parameter of the PC5_DISCOVERY message for
Group Member Discovery Announcement is the same as the configured Discovery
Group ID parameter as specified in clause 5, _the UE shall consider that_
other UE in the discovery group the UE _seeks to monitor has been discovered._
#### 10A.2.7.3 Monitoring UE procedure for group member discovery completion
When the UE is triggered by an upper layer application to stop monitoring
proximity of other UEs in a discovery group, or when the UE stops being
authorised to perform the monitoring UE procedure for group member discovery,
the UE shall instruct the lower layers to stop monitoring.
When the UE stops monitoring, if the UE is in EMM-CONNECTED mode, the UE shall
trigger the corresponding procedure in lower layers as specified in 3GPP TS
36.331 [12].
### 10A.2.8 Discoverer UE procedure for group member discovery
#### 10A.2.8.1 General
The purpose of the discoverer UE procedure for group member discovery is to
enable a ProSe-enabled public safety UE to solicit proximity of other ProSe-
enabled public safety UEs in a discovery group, upon a request from upper
layers as defined in 3GPP TS 23.303 [2].
#### 10A.2.8.2 Discoverer UE procedure for group member discovery initiation
The UE is authorised to perform the discoverer UE procedure for group member
discovery if:
a) the following is true:
1) the UE is not served by E-UTRAN, is authorised to perform ProSe direct
discovery for public safety use discoverer operation when the UE is not served
by E-UTRAN as specified in clause 5, and is configured with the radio
parameters to be used for ProSe direct discovery for public safety use when
not served by E-UTRAN;
2) the UE is served by E-UTRAN, and is authorised to perform ProSe direct
discovery for public safety use discoverer operation in the PLMN indicated by
the serving cell as specified in clause 5; or
3) the UE is:
\- in EMM-IDLE mode, in limited service state as specified in 3GPP TS 23.122
[24, and the reason for the UE being in limited service state is one of the
following:
i) the UE is unable to find a suitable cell in the selected PLMN as specified
in 3GPP TS 36.304 [23];
ii) the UE received an ATTACH REJECT message or a TRACKING AREA UPDATE REJECT
message or a SERVICE REJECT message with the EMM cause #11 \"PLMN not
allowed\" as specified in 3GPP TS 24.301 [11] or a LOCATION UPDATING REJECT
message or a GPRS ATTACH REJECT message or ROUTING AREA UPDATE REJECT message
or SERVICE REJECT message with cause #11 \"PLMN not allowed\" as specified in
3GPP TS 24.008 [30]; or
iii) the UE received an ATTACH REJECT message or a TRACKING AREA UPDATE REJECT
message or a SERVICE REJECT message with the EMM cause #7 \"EPS services not
allowed\" as specified in 3GPP TS 24.301 [11] or a LOCATION UPDATING REJECT
message or a GPRS ATTACH REJECT message or ROUTING AREA UPDATE REJECT message
or SERVICE REJECT message with cause #7 \"GPRS services not allowed\" as
specified in 3GPP TS 24.008 [30]; and
\- authorised to perform ProSe direct discovery for public safety use
discoverer operation when the UE is not served by E-UTRAN as specified in
clause 5, and:
i) configured with the radio parameters to be used for ProSe direct discovery
for public safety use when not served by E-UTRAN; or
ii) the lower layers indicate that the UE does not need to request resources
for sending PC5_DISCOVERY messages for public safety as specified in 3GPP TS
36.331 [12]; and:
NOTE: When the lower layers indicate that the UE does not need to request
resources for sending PC5_DISCOVERY messages for public safety as specified in
3GPP TS 36.331 [12], the serving cell broadcasts a common radio resources pool
for public safety discovery transmission and the UE can use this common radio
resources pool while in limited service state.
b) the UE is configured with the Discovery Group ID parameter identifying the
discovery group to be solicited and with the User Info ID for the group member
discovery parameter, as specified in clause 5;
otherwise the UE is not authorised to perform the discoverer UE procedure for
group member discovery.
Figure 10A.2.8.2.1 illustrates the interaction of the UEs in the discoverer UE
procedure for group member discovery.
Figure 10A.2.8.2.1: Discoverer UE procedure for group member discovery
When the UE is triggered by an upper layer application to solicit proximity of
other UEs in a discovery group, and if the UE is authorised to perform the
discoverer UE procedure for group member discovery, then the UE:
a) if the UE is served by E-UTRAN, and the UE in EMM-IDLE mode needs to
request resources for sending PC5_DISCOVERY messages for public safety as
specified in 3GPP TS 36.331 [12], shall perform a service request procedure or
tracking area update procedure as specified in 3GPP TS 24.301 [11];
b) shall obtain a valid UTC time for the discovery transmission from the lower
layers and generate the UTC-based counter corresponding to this UTC time as
specified in subclause 12.2.2.18;
c) shall generate a PC5_DISCOVERY message for Group Member Discovery
Solicitation according to subclause 11.2.5.1. In the PC5_DISCOVERY message for
Group Member Discovery Solicitation, the UE:
1) shall set the Discoverer Info parameter to the User Info ID for the group
member discovery parameter, configured in clause 5;
2) shall set the Discovery Group ID parameter to the Discovery Group ID
parameter identifying the discovery group to be solicited, configured in
clause 5;
3) shall set either the Target User Info parameter or the Target Group Info
parameter according to the target information provided by the upper layer
application; and
4) shall set the UTC-based counter LSB parameter to include the eight least
significant bits of the UTC-based counter;
d) shall apply the DUIK, DUSK, or DUCK with the associated Encrypted Bitmask,
along with the UTC-based counter to the PC5_DISCOVERY message for whichever
security mechanism(s) configured to be applied, e.g. integrity protection,
message scrambling or confidentiality protection of one or more above
parameters, as specified in 3GPP TS 33.303 [6]; and
e) shall pass the resulting PC5_DISCOVERY message for Group Member Discovery
Solicitation to the lower layers for transmission over the PC5 interface with
an indication that the message is for public safety use.
The UE shall ensure that it keeps on passing the same PC5_DISCOVERY message to
the lower layers for transmission with an indication that the message is for
public safety use until the UE is triggered by an upper layer application to
stop soliciting proximity of other UEs in a discovery group, or until the UE
stops being authorised to perform the discoverer UE procedure for group member
discovery. How this is achieved is left up to UE implementation.
Upon reception of a PC5_DISCOVERY message for Group Member Discovery Response
according to subclause 11.2.5.1, for the target Discovery Group ID of the
discovery group to be discovered, the UE shall use the associated DUSK, if
configured, and the UTC-based counter obtained during the monitoring operation
to unscramble the PC5_DISCOVERY message as described in 3GPP TS 33.303 [6].
Then, if a DUCK is configured, the UE shall use the DUCK and the UTC-based
counter to decrypt the configured message-specific confidentiality-protected
portion, as described in 3GPP TS 33.303 [6]. Finally, if a DUIK is configured,
the UE shall use the DUIK and UTC-based counter to verify the MIC field in the
unscrambled PC5_DISCOVERY message for Group Member Discovery Response.
Then if the Discovery Group ID parameter of the PC5_DISCOVERY message for
Group Member Discovery Response is the same as the Discovery Group ID
parameter of the PC5_DISCOVERY message for Group Member Discovery
Solicitation, _the UE shall consider that_ other UE in the discovery group the
UE _seeks to discover has been discovered._
#### 10A.2.8.3 Discoverer UE procedure for group member discovery completion
When the UE is triggered by an upper layer application to stop soliciting
proximity of other UEs in a discovery group, or when the UE stops being
authorised to perform the discoverer UE procedure for group member discovery,
the UE shall instruct the lower layers to stop discoverer operation.
When the UE stops discoverer operation, if the UE is in EMM-CONNECTED mode,
the UE shall trigger the corresponding procedure in lower layers as specified
in 3GPP TS 36.331 [12].
### 10A.2.9 Discoveree UE procedure for group member discovery
#### 10A.2.9.1 General
The purpose of the discoveree UE procedure for group member discovery is to
enable a ProSe-enabled public safety UE to respond to solicitation from other
ProSe-enabled public safety UEs on proximity in a discovery group, upon a
request from upper layers as defined in 3GPP TS 23.303 [2].
#### 10A.2.9.2 Discoveree UE procedure for group member discovery initiation
The UE is authorised to perform the discoveree UE procedure for group member
discovery if:
a) the following is true:
1) the UE is not served by E-UTRAN, is authorised to perform ProSe direct
discovery for public safety use discoveree operation when the UE is not served
by E-UTRAN as specified in clause 5, and is configured with the radio
parameters to be used for ProSe direct discovery for public safety use when
not served by E-UTRAN;
2) the UE is served by E-UTRAN, and is authorised to perform ProSe direct
discovery for public safety use discoveree operation in the PLMN(s) indicated
by the serving cell as specified in clause 5; or
3) the UE is:
\- in EMM-IDLE mode, in limited service state as specified in 3GPP TS 23.122
[24], and the reason for the UE being in limited service state is one of the
following:
i) the UE is unable to find a suitable cell in the selected PLMN as specified
in 3GPP TS 36.304 [23];
ii) the UE received an ATTACH REJECT message or a TRACKING AREA UPDATE REJECT
message or a SERVICE REJECT message with the EMM cause #11 \"PLMN not
allowed\" as specified in 3GPP TS 24.301 [11] or a LOCATION UPDATING REJECT
message or a GPRS ATTACH REJECT message or ROUTING AREA UPDATE REJECT message
or SERVICE REJECT message with cause #11 \"PLMN not allowed\" as specified in
3GPP TS 24.008 [30]; or
iii) the UE received an ATTACH REJECT message or a TRACKING AREA UPDATE REJECT
message or a SERVICE REJECT message with the EMM cause #7 \"EPS services not
allowed\" as specified in 3GPP TS 24.301 [11] or a LOCATION UPDATING REJECT
message or a GPRS ATTACH REJECT message or ROUTING AREA UPDATE REJECT message
or SERVICE REJECT message with cause #7 \"GPRS services not allowed\" as
specified in 3GPP TS 24.008 [30]; and
\- authorised to perform ProSe direct discovery for public safety use
discoveree operation when the UE is not served by E-UTRAN as specified in
clause 5, and:
i) configured with the radio parameters to be used for ProSe direct discovery
for public safety use when not served by E-UTRAN; or
ii) the lower layers indicate that the UE does not need to request resources
for sending PC5_DISCOVERY messages for public safety as specified in 3GPP TS
36.331 [12]; and
NOTE: When the lower layers indicate that the UE does not need to request
resources for sending PC5_DISCOVERY messages for public safety as specified in
3GPP TS 36.331 [12], the serving cell broadcasts a common radio resources pool
for public safety discovery transmission and the UE can use this common radio
resources pool while in limited service state.
b) the UE is configured with the Discovery Group ID parameter identifying the
discovery group to be responded to and with the User Info ID for the group
member discovery parameter, as specified in clause 5;
otherwise the UE is not authorised to perform the Discoveree UE procedure for
group member discovery.
Figure 10A.2.9.2.1 illustrates the interaction of the UEs in the Discoveree UE
procedure for group member discovery.
Figure 10A.2.9.2.1: Discoveree UE procedure for group member discovery
When the UE is triggered by an upper layer application to start responding to
solicitation on proximity of a UE in a discovery group, and if the UE is
authorised to perform the discoveree UE procedure for group member discovery,
then the UE:
a) if the UE is served by E-UTRAN, and the UE in EMM-IDLE mode needs to
request resources for sending PC5_DISCOVERY messages for public safety as
specified in 3GPP TS 36.331 [12], shall perform a service request procedure or
tracking area update procedure as specified in 3GPP TS 24.301 [11]; and
b) shall instruct the lower layers to start monitoring for PC5_DISCOVERY
messages with an indication that the message is for public safety use.
Upon reception of a PC5_DISCOVERY message for Group Member Discovery
Solicitation according to subclause 11.2.5.1, for the Discovery Group ID of
the discovery group which the UE is configured to respond for, the UE shall
use the associated DUSK, if configured, and the UTC-based counter obtained
during the monitoring operation to unscramble the PC5_DISCOVERY message as
described in 3GPP TS 33.303 [6]. Then, if a DUCK is configured, the UE shall
use the DUCK and the UTC-based counter to decrypt the configured message-
specific confidentiality protected portion, as described in 3GPP TS 33.303
[6]. Finally, if a DUIK is configured, the UE shall use the DUIK and UTC-based
counter to verify the MIC field in the unscrambled PC5_DISCOVERY message for
Group Member Discovery Solicitation.
Then, if:
\- the Discovery Group ID parameter of the received PC5_DISCOVERY message is
the same as a Discovery Group ID parameter configured as specified in clause 5
for the discovery group;
\- the Target User Info parameter is not included in the received
PC5_DISCOVERY message or the Target User Info parameter of the received
PC5_DISCOVERY message is the same as the User Info ID for the group member
discovery parameter specified in clause 5; and
\- the Target Group Info parameter is not included in the received
PC5_DISCOVERY message or the Target Group Info parameter of the received
PC5_DISCOVERY message is the same as the identifier of the targeted group
provided by the upper layer application (e.g. ProSe Layer-2 Group ID of the
ProSe direct communication service authorisation specified in clause 5);
_the UE:_
a) shall obtain a valid UTC time for the discovery transmission from the lower
layers and generate the UTC-based counter corresponding to this UTC time as
specified in subclause 12.2.2.18;
b) shall generate a PC5_DISCOVERY message for Group Member Discovery Response
according to subclause 11.2.5.1. In the PC5_DISCOVERY message for Group Member
Discovery Response, the UE:
1) shall set the ProSe UE ID to the Layer 2 ID used for unicast communication,
configured in clause 5;
2) shall set the Discoveree Info parameter to the User Info ID for the group
member discovery parameter, configured in clause 5;
3) shall set the Discovery Group ID parameter to the Discovery Group ID
parameter of the PC5_DISCOVERY message for Group Member Discovery
Solicitation; and
4) shall set the UTC-based counter LSB parameter to include the eight least
significant bits of the UTC-based counter;
c) shall apply the DUIK, DUSK, or DUCK with the associated Encrypted Bitmask,
along with the UTC-based counter to the PC5_DISCOVERY message for whichever
security mechanism(s) configured to be applied, e.g. integrity protection,
message scrambling or confidentiality protection of one or more above
parameters, as specified in 3GPP TS 33.303 [6]; and
d) shall pass the resulting PC5_DISCOVERY message for Group Member Discovery
Response with an indication that the message is for public safety use to the
lower layers for transmission over the PC5 interface.
#### 10A.2.9.3 Discoveree UE procedure for group member discovery completion
When the UE is triggered by an upper layer application to stop responding to
solicitation on proximity of other UEs in a discovery group, or when the UE
stops being authorised to perform the discoveree UE procedure for group member
discovery, the UE shall instruct the lower layers to stop monitoring.
When the UE stops monitoring, if the UE is in EMM-CONNECTED mode, the UE shall
trigger the corresponding procedure in lower layers as specified in 3GPP TS
36.331 [12].
### 10A.2.10 Announcing UE procedure for Relay Discovery Additional
Information
#### 10A.2.10.1 General
The purpose of the announcing UE procedure for Relay Discovery Additional
Information is to announce to the remote UEs additional information about:
\- the MBMS traffic the ProSe UE-to-network relay is relaying; or
\- the E-UTRAN Cell serving the ProSe UE-to-network relay
as defined in 3GPP TS 23.303 [2].
#### 10A.2.10.2 Announcing procedure for Relay Discovery Additional
Information
The ProSe UE-to-network relay announces the Relay Discovery Additional
Information:
a) if the remote UE requests the ProSe UE-to-network relay to start monitoring
a specific TMGI availability by the PC5-S TMGI Monitoring Request message, and
as a response the ProSe UE-to-network relay acknowledges with the PC5-S TMGI
Monitoring Response message and the TMGI is detected in the serving E-UTRAN
cell, then the ProSe UE-to-network relay includes a pair of the TMGI and its
corresponding ProSe Layer 2 Group ID in the PC5_DISCOVERY message for Relay
Discovery Additional Information until the timer T4105 expires (see the
subclause 10.5); or
b) if the remote UE requests the ProSe UE-to-network relay to announce the
E-UTRAN Cell Global ID (ECGI) of the cell serving the ProSe UE-to-network
relay, and as a response the ProSe UE-to-network relay acknowledges with the
PC5-S Cell ID Announcement Response message, then the ProSe UE-to-network
relay includes the ECGI of the serving cell in the PC5_DISCOVERY message for
Relay Discovery Additional Information until the timer T4107 expires (see the
subclause 10.6).
NOTE 1: ProSe UE-to-network relay announces the Relay Discovery Additional
Information only when it is in E-UTRAN coverage.
Figure 10A.2.10.2.1 illustrates the interaction of the ProSe UE-to-network
relay and the remote UE in the announcing UE procedure for Relay Discovery
Additional Information.
Figure 10A.2.10.2.1: Announcing procedure for Relay Discovery Additional
Information
The ProSe UE-to-network relay UE may start announcing Relay Discovery
Additional Information if:
a) the ProSe UE-to-network relay UE is currently authorised to perform ProSe
direct discovery Model A announcing in the serving PLMN if the UE is served by
E-UTRAN; and
1) TMGI monitoring has been requested and responded to remote UEs, the ProSe
UE-to-network relay UE detects the corresponding TMGI in the serving cell and
the timer T4105 has not expired; or
2) ECGI announcement for the serving cell of the ProSe UE-to-network relay UE
has been requested and responded to remote UEs, the timer T4107 has not
expired.
When the ProSe UE-to-network relay has some additional information to
broadcast (i.e. either a pair of TMGI and its corresponding ProSe Layer 2
Group ID or ECGI), then the ProSe UE-to-network relay:
a) shall request the parameters from the lower layers for ProSe direct
discovery announcing for public safety use (see 3GPP TS 36.331 [12]). The
ProSe UE-to-network relay performs the announcing UE procedure for Relay
Discovery Additional Information only if the lower layers indicate that ProSe
direct discovery is supported by the network. If the ProSe UE-to-network relay
in EMM-IDLE mode needs to request resources for sending PC5_DISCOVERY messages
as specified in 3GPP TS 36.331 [12], the ProSe UE-to-network relay shall
perform a service request procedure or tracking area update procedure as
specified in 3GPP TS 24.301 [11];
b) shall obtain a valid UTC time for the discovery transmission from the lower
layers and generate the UTC-based counter corresponding to this UTC time as
specified in subclause 12.2.2.18;
c) shall generate PC5_DISCOVERY message(s) for Relay Discovery Additional
Information according to subclause 11.2.5.1. In the PC5_DISCOVERY message for
Relay Discovery Additional Information, the ProSe UE-to-network relay shall:
1) include the Relay Service Code and the ProSe Relay UE ID used for ProSe
direct communication which the remote UE used to request for the Relay
Discovery Additional Information;
2) set the Announcer Info parameter to the User Info ID parameter, configured
in subclause 5;
3) set the Relay Discovery Additional Information contents by the additional
information to broadcast; and
4) shall set the UTC-based counter LSB parameter to include the eight least
significant bits of the UTC-based counter;
d) shall apply the DUIK, DUSK, or DUCK with the associated Encrypted Bitmask,
along with the UTC-based counter to the PC5_DISCOVERY message for whichever
security mechanism(s) configured to be applied, e.g. integrity protection,
message scrambling or confidentiality protection of one or more above
parameters, as specified in 3GPP TS 33.303 [6]; and
e) shall pass the resulting PC5_DISCOVERY message for Relay Discovery
Additional Information to the lower layers for transmission over the PC5
interface with an indication that the message is for public safety use.
The ProSe UE-to-network relay shall ensure that it keeps on passing the
PC5_DISCOVERY messages to the lower layers for transmission until the
corresponding timer (i.e. timer T4105 when the additional information is a
pair of TMGI and its corresponding ProSe Layer 2 Group ID and timer T4107 when
the additional information is ECGI) expires.
During the announcing operation, if one of the above conditions is no longer
met, the ProSe UE-to-network relay may instruct the lower layers to stop
announcing. When the ProSe UE-to-network relay stops announcing, if the lower
layers indicate that the ProSe UE-to-network relay is required to send a
discovery indication to the eNodeB and the ProSe UE-to-network relay is in
EMM-CONNECTED mode, the ProSe UE-to-network relay shall trigger the
corresponding procedure in lower layers as specified in 3GPP TS 36.331 [12].
### 10A.2.11 Monitoring UE procedure for Relay Discovery Additional
Information
#### 10A.2.11.1 General
The purpose of the monitoring UE procedure for Relay Discovery Additional
Information is to enable a remote UE to become aware of MBMS traffics the
ProSe UE-to-network relay is relaying or the E-UTRAN Cell serving the ProSe
UE-to-network relay as defined in 3GPP TS 23.303 [2].
#### 10A.2.11.2 Monitoring procedure for Relay Discovery Additional
Information
The remote UE monitors Relay Discovery Additional Information:
a) until the TMGI monitoring refresh timer T4104 expires if the remote UE has
requested the ProSe UE-to-network relay to start monitoring a specific TMGI
availability by the PC5-S TMGI Monitoring Request message and received the
PC5-S TMGI Monitoring Response message from the ProSe UE-to-network relay; or
b) until the ECGI announcement request refresh timer T4106 expires if the
remote UE has requested the ProSe UE-to-network relay to announce the ECGI of
the cell serving the ProSe UE-to-network relay and received the PC5-S Cell ID
Announcement Response message from the ProSe UE-to-network relay.
> The UE may instruct the lower layers to start monitoring with an indication
> that the message is for relay discovery for public safety use if:
a) a request from upper layers to monitor for Relay Discovery Additional
Information is still in place; and either:
1) the UE is currently authorised to perform ProSe direct discovery Model A
monitoring in at least one PLMN if the UE is served by E-UTRAN;
2) the UE is currently authorised to perform ProSe direct discovery Model A
monitoring if the UE is not served by E-UTRAN; or
3) the UE is:
\- in EMM-IDLE mode, in limited service state as specified in 3GPP TS 23.122
[24], and the reason for the UE being in limited service state is one of the
following:
i) the UE is unable to find a suitable cell in the selected PLMN as specified
in 3GPP TS 36.304 [23];
ii) the UE received an ATTACH REJECT message or a TRACKING AREA UPDATE REJECT
message or a SERVICE REJECT message with the EMM cause #11 \"PLMN not
allowed\" as specified in 3GPP TS 24.301 [11] or a LOCATION UPDATING REJECT
message or a GPRS ATTACH REJECT message or ROUTING AREA UPDATE REJECT message
or SERVICE REJECT message with cause #11 \"PLMN not allowed\" as specified in
3GPP TS 24.008 [30]; or
iii) the UE received an ATTACH REJECT message or a TRACKING AREA UPDATE REJECT
message or a SERVICE REJECT message with the EMM cause #7 \"EPS services not
allowed\" as specified in 3GPP TS 24.301 [11] or a LOCATION UPDATING REJECT
message or a GPRS ATTACH REJECT message or ROUTING AREA UPDATE REJECT message
or SERVICE REJECT message with cause #7 \"GPRS services not allowed\" as
specified in 3GPP TS 24.008 [30].
\- authorised to perform ProSe direct discovery Model A monitoring when the UE
is not served by E-UTRAN as specified in clause 5, and:
i) configured with the radio parameters to be used for ProSe direct discovery
for public safety use when not served by E-UTRAN; or
ii) the lower layers indicate that public safety discovery operation is
supported; and
NOTE 1: When the lower layers indicate that public safety discovery operation
is supported, the serving cell broadcasts a common radio resources pool for
public safety discovery reception and the UE can use this common radio
resources pool while in limited service state.
If the UE is in EMM-CONNECTED mode, the monitoring UE shall also trigger the
corresponding procedure in lower layers as specified in 3GPP TS 36.331 [12].
During the monitoring operation, if one of the above conditions is no longer
met, the UE may instruct the lower layers to stop monitoring. When the UE
stops monitoring, if the UE is in EMM-CONNECTED mode, the UE shall trigger the
corresponding procedure in lower layers as specified in 3GPP TS 36.331 [12].
Upon reception of a PC5_DISCOVERY message for Relay Discovery Additional
Information according to subclause 11.2.5.1, for the target Relay Service Code
to be monitored, the UE shall use the associated DUSK, if configured, and the
UTC-based counter obtained during the monitoring operation to unscramble the
PC5_DISCOVERY message as described in 3GPP TS 33.303 [6]. Then, if a DUCK is
configured, the UE shall use the DUCK and the UTC-based counter to decrypt the
configured message-specific confidentiality protected portion, as described in
3GPP TS 33.303 [6]. Finally, if a DUIK is configured, the UE shall use the
DUIK and UTC-based counter to verify the MIC field in the unscrambled
PC5_DISCOVERY message for Relay Discovery Additional Information.
NOTE 2: The use of an erroneous UTC-based counter for processing received
PC5_DISCOVERY messages at the ProSe-enabled Public Safety UE can cause MIC
check failure after DUIK is used for integrity check, and malformed contents
after DUSK is used for unscrambling or DUCK is used for deciphering. How a
ProSe-enabled Public Safety UE ensures the accuracy of the UTC-based counter
is left to UE implementation.
Then, if:
\- the Relay Service Code parameter of the PC5_DISCOVERY message for Relay
Discovery Additional Information is the same as the Relay Service Code
parameter configured as specified in clause 5 for the connectivity service
being monitored; and
\- the ProSe Relay UE ID parameter of the PC5_DISCOVERY message for Relay
Discovery Additional Information is the same as the ProSe Relay UE ID
parameter identifying the relay the remote UE intends to communicate with;
then _the UE shall consider that the_ Relay Discovery Additional Information
it intend _s to monitor has been discovered. In addition, the UE can measure
the signal strength of the_ PC5_DISCOVERY message for Relay Discovery
Additional Information _for relay selection or reselection._
If the remote UE detects Relay Discovery Additional Information matched with
the requested TMGI, then the remote UE starts to receive the MBMS traffic via
the corresponding ProSe Layer-2 Group ID. When the ProSe-enabled public safety
UE receives a PC5_DISCOVERY message for Relay Discovery Additional Information
containing its interested TMGI, the UE may start to receive the MBMS traffic
via the corresponding ProSe Layer-2 Group ID even if it does not have a PC5
link established with the ProSe UE-to-network relay or is not authorized to
use a ProSe UE-to-network relay.
### 10A.2.12 UE-to-network relay selection procedure
#### 10A.2.12.1 General
The purpose of the UE-to-network relay selection procedure is to enable a
remote UE to select a suitable ProSe UE-to-network relay UE to obtain a
connectivity service to EPC.
#### 10A.2.12.2 UE-to-network relay selection procedure initiation
The remote UE shall trigger the UE-to-network relay selection procedure if the
following conditions are met:
\- the UE is authorised to act as a remote UE towards a ProSe UE-to-network
relay UE as specified in clause 5;
\- the UE has obtained a list of ProSe UE-to-network relay UE candidate(s)
fulfilling ProSe layer criteria with the monitoring procedure for UE-to-
network relay discovery as specified in subclause 10A.2.3 or the discoverer
procedure for UE-to-network relay discovery as specified in subclause 10A.2.4;
and
\- the UE has obtained a list of ProSe UE-to-network relay UE candidate(s)
fulfilling lower layers criteria as specified in 3GPP TS 36.331 [12].
#### 10A.2.12.3 UE-to-network relay selection procedure completion
If there exists only one ProSe UE-to-network relay candidate satisfying the
conditions in subclause 10A.2.12.2, then that ProSe UE-to-network relay UE is
selected. If there exist more than one ProSe UE-to-network relay candidate
satisfying the conditions in subclause 10A.2.12.2, any relay candidates not
satisfying the non-radio related ProSe layer criteria shall be discarded, and
out of the remaining relay candidates, the relay candidate with the highest
ranking of the lower layer criteria shall be selected. The UE may take the
value of the Resource Status Indicator bit of the Status Indicator parameter
of the PC5_DISCOVERY message for UE-to-Network Relay Discovery Announcement or
PC5_DISCOVERY message for UE-to-Network Relay Discovery Response into account
when deciding which ProSe UE-to-network relay to select. It is up to the UE
implementation whether the ProSe layer or the lower layers takes the final
selection on which ProSe UE-to-network relay UE to select.
### 10A.2.13 UE-to-network relay reselection procedure
#### 10A.2.13.1 General
The purpose of the UE-to-network relay reselection procedure is to enable a
remote UE to reselect a ProSe UE-to-network relay UE to obtain a connectivity
service to EPC when the serving ProSe UE-to-network relay UE is no longer
suitable.
#### 10A.2.13.2 UE-to-network relay reselection procedure initiation
The remote UE shall trigger the UE-to-network relay reselection procedure if
one of the following conditions is met:
a) the UE has received a lower layers indication that the serving ProSe UE-to-
network relay UE no longer fulfills the lower layers criteria as specified in
3GPP TS 36.331 [12];
b) the parameters related to ProSe UE-to-network relay in the ProSe direct
discovery for public safety use service authorisation (e.g., Relay Service
Code, User Info ID, etc.) have been updated and the serving ProSe UE-to-
network relay UE no longer fulfills the conditions specified in subclause
10A.2.3;
c) the UE has received a DIRECT_COMMUNICATION_REJECT message from the ProSe
UE-to-network relay UE with the cause value \"Direct communication to target
UE not allowed\";
d) the UE has received a DIRECT_COMMUNICATION_RELEASE message from the ProSe
UE-to-network relay UE with the cause value \"Direct communication with the
peer UE is no longer allowed\";
e) the UE has received a DIRECT_COMMUNICATION_RELEASE message from the ProSe
UE-to-network relay UE with the cause value \"Direct connection is not
available any more\";
f) the UE has not received any response from the ProSe UE-to-network relay UE
after M consecutive retransmissions of DIRECT COMMUNICATION SETUP or DIRECT
COMMUNICATION KEEPALIVE messages; or
g) the UE has not received any response from the ProSe UE-to-network relay UE
after M consecutive retransmissions of PC5_DISCOVERY message for UE-to-Network
Relay Discovery Solicitation used to trigger the PC5_DISCOVERY message signal
strength measurement between the UE and the ProSe UE-to-network relay UE with
which the UE has a link established.
NOTE: The value of M is implementation specific and is less than or equal to
the maximum number of retransmissions allowed for PC5 Signalling protocol.
In cases c) and d), the remote UE shall exclude the ProSe UE-to-network relay
UE which sent the message specified in cases c) or d) from the UE-to-network
relay reselection process described below.
To conduct UE-to-network relay reselection process, the UE shall first
initiate one of the following procedures or both depending on UE\'s service
authorisation for ProSe direct discovery for public safety use:
\- monitoring procedure for UE-to-network relay discovery as specified in
subclause 10A.2.3; or
\- discoverer procedure for UE-to-network relay discovery as specified in
subclause 10A.2.4.
After the execution of the above discovery procedure(s), the remote UE
performs the UE-to-network relay selection procedure as specified in subclause
10A.2.3.
# 11 Message functional definitions and contents
## 11.1 Overview
This clause contains the definition and contents of the messages used in the
procedures described in the present document.
## 11.2 ProSe discovery messages
### 11.2.1 General
This subclause defines the XML schema and MIME type related to ProSe direct
discovery messages and EPC-level ProSe discovery messages.
This subclause also defines the format of the PC5_DISCOVERY message
transmitted over the PC5 interface.
### 11.2.2 application/3gpp-prose+xml
The MIME type is used to carry information related to the ProSe discovery
operation. It shall be coded as an XML document containing one of the
following ProSe discovery messages:
\- DISCOVERY_REQUEST;
\- DISCOVERY_RESPONSE;
\- MATCH_REPORT;
\- MATCH_REPORT_ACK;
\- DISCOVERY_UPDATE_REQUEST;
\- DISCOVERY_UPDATE_RESPONSE;
\- ANNOUNCING_ALERT_REQUEST;
\- ANNOUNCING_ALERT_RESPONSE;
\- UE_REGISTRATION_REQUEST;
\- UE_REGISTRATION_RESPONSE;
\- APPLICATION_REGISTRATION_REQUEST;
\- APPLICATION_REGISTRATION_RESPONSE;
\- PROXIMITY_REQUEST;
\- PROXIMITY_REQUEST_RESPONSE;
\- PROXIMITY_ALERT;
\- UE_DEREGISTRATION_REQUEST;
\- UE_DEREGISTRATION_RESPONSE;
\- CANCEL_PROXIMITY_REQUEST;
\- CANCEL_PROXIMITY_RESPONSE;
\- PROXIMITY_REQUEST_VALIDATION; or
\- PROXIMITY_REQUEST_VALIDATION_RESPONSE.
Each of those messages is presented in the XML document as an XML element
named after the corresponding message.
### 11.2.3 XML Schema
Implementations in compliance with the present document shall implement the
XML schema defined below for messages used in ProSe direct discovery
procedures over PC3 interface.
\
\
\
\
Info for ProSe Discovery Control Messages Syntax
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
An entity receiving the XML body ignores any unknown XML element and any
unknown XML attribute.
### 11.2.4 Semantics
#### 11.2.4.1 General
The \ element is the root element of this XML
document and it can be one of the following elements:
\- \;
\- \;
\- \;
\- \;
\- \;
\- \;
\- \;
\- \;
\- \;
\- \;
\- \;
\- \;
\- \;
\- \;
\- \;
\- \;
\- \;
\- \;
\- \
\- \;
\- \;
\- \ element containing other discovery message defined in future
releases; or
\- an element from other namespaces defined in future releases.
#### 11.2.4.2 Semantics of \
The \ element contains one or more of the following
elements:
1) zero, one or more \ element which contains transactions
sent from the UE to the ProSe Function as announcing or monitoring requests
for open ProSe direct discovery. Each \ consists of:
a) a \ element containing the parameter defined in subclause
12.2.2.1;
b) a \ element containing the parameter defined in subclause
12.2.2.2;
c) a \ element containing the parameter defined in subclause
12.2.2.3;
d) a \ element containing the parameter defined in
subclause 12.2.2.4;
e) an \ element containing the parameter defined in
subclause 12.2.2.5;
f) a \ element containing the parameter defined in
subclause 12.2.2.33;
g) an optional \ element containing the parameter defined in
subclause 12.2.2.27;
h) an optional \ element containing the parameter defined in
subclause 12.2.2.21;
i) an optional \ element containing the parameter defined
in subclause 12.2.2.64;
j) zero or one \ element containing the parameter
defined in subclause 12.2.2.38;
k) zero or one \ element containing the parameter defined in
subclause 12.2.2.71;
l) zero or one \ element containing elements defined in future
releases;
m) zero, one or more elements from other namespaces defined in future
releases; and
n) zero, one or more attributes defined in future releases;
2) zero, one, or more \ element which contains
transactions sent from the UE to the ProSe Function as announcing or
monitoring requests for restricted ProSe directed discovery model A or
transactions sent from the UE to the ProSe Function as discoveree or
discoverer requests for restricted ProSe directed discovery model B. Each
\ consists of:
a) a \ element containing the parameter defined in subclause
12.2.2.1;
b) a \ element containing the parameter defined in subclause
12.2.2.2;
c) a \ element containing the parameter defined in subclause
12.2.2.3;
d) a \ element containing the parameter defined in subclause
12.2.2.30;
e) an \ element containing the parameter defined in
subclause 12.2.2.5;
f) a \ element containing the parameter defined in subclause
12.2.2.25;
g) zero or one \ element containing the parameter
defined in subclause 12.2.2.38;
h) an \ element containing the parameter defined in subclause
12.2.2.31;
i) an \ element containing the parameter defined
in subclause 12.2.2.32;
j) zero or one \ element containing the parameter defined in
subclause 12.2.2.41;
k) zero or one \ element containing the parameter defined
in subclause 12.2.2.64;
l) a \ element containing the parameter defined in
subclause 12.2.2.33;
m) an optional \ element containing the parameter defined in
subclause 12.2.2.27;
n) zero or one \ element containing the parameter defined in
subclause 12.2.2.71;
o) zero or one \ element containing elements defined in future
releases;
p) zero, one or more elements from other namespaces defined in future
releases; and
q) zero, one or more attributes defined in future releases;
3) zero or one \ element containing elements defined in future
releases;
4) zero, one or more elements from other namespaces defined in future
releases;
5) an optional \"network-initiated transaction method\" attribute containing
the parameter defined in subclause 12.2.2.63; and
6) zero, one or more attributes defined in future releases.
#### 11.2.4.3 Semantics of \
The \ element contains one or more of the following
elements:
1) a \ element containing the parameter defined in subclause
12.2.2.23;
2) a \ element containing the parameter defined in subclause
12.2.2.24;
3) zero, one or more \ element which contains transactions
sent from the ProSe Function to the UE as a response to an announcing request
if the ProSe Function accepts the request. Each \ consists
of:
a) a \ element containing the parameter defined in subclause
12.2.2.1;
b) zero, one or more \ elements containing the
parameter defined in subclause 12.2.2.6;c) zero or one \ element containing the parameter defined in subclause 12.2.2.70;
d) zero, or one \ element containing the parameter
defined in 12.2.2.7;
e) zero, or, one \ element containing the parameter defined in
subclause 12.2.2.9;
f) a \ element containing the parameter defined in
subclause 12.2.2.33;
g) zero or one \ element containing the parameter
defined in subclause 12.2.2.38;
h) zero or one \ element containing the parameter defined in
subclause 12.2.2.71;
i) zero or one \ element containing elements defined in future
releases;
j) zero, one or more elements from other namespaces defined in future
releases; and
k) zero, one or more attributes defined in future releases;
4) zero, one or more \ element which contains transactions
sent from the ProSe Function to the UE as a response to a monitoring request
if the ProSe Function accepts the request. Each \ consists
of:
a) a \ element containing the parameter defined in subclause
12.2.2.1;
b) zero, one or more \ elements containing the parameter
defined in subclause 12.2.2.12;
c) a \ element containing the parameter defined in
subclause 12.2.2.33;
d) zero or one \ element containing the parameter
defined in subclause 12.2.2.38;
e) zero or one \ element containing elements defined in future
releases;
f) zero, one or more elements from other namespaces defined in future
releases; and
g) zero, one or more attributes defined in future releases;
5) zero, one or more \ element which contains
transactions sent from the ProSe Function to the UE as a response to an
announcing request for restricted ProSe direct discovery model A if the ProSe
Function accepts the request. Each \ consists
of:
a) a \ element containing the parameter defined in subclause
12.2.2.1;
b) zero or one \ element containing the parameter
defined in subclause 12.2.2.34;
c) zero, one or more \ element containing
the parameter defined in subclause 12.2.2.35;
d) zero or one \ element containing the parameter
defined in 12.2.2.39;
e) zero or one \ element containing the parameter
defined in subclause 12.2.2.38;
f) zero or one \ element containing the
parameter defined in subclause 12.2.2.40;
g) an optional \ element containing
the parameter defined in subclause 12.2.2.36;
h) a \ element containing the parameter defined in
subclause 12.2.2.33;
i) zero or one \ element containing the parameter defined in
subclause 12.2.2.71;
j) zero or one \ element containing elements defined in future
releases;
k) zero, one or more elements from other namespaces defined in future
releases; and
l) zero, one or more attributes defined in future releases;
6) zero, one or more \ element which contains
transactions sent from the ProSe Function to the UE as a response to a
monitoring request for restricted ProSe direct discovery model A if the ProSe
Function accepts the request. Each \ consists of:
a) a \ element containing the parameter defined in subclause
12.2.2.1;
b) zero, one or more \ elements containing the
parameter defined in subclause 12.2.2.37;
c) zero or one \ element containing the parameter
defined in subclause 12.2.2.38
d) a \ element containing the parameter defined in
subclause 12.2.2.33;
e) an \ element containing the parameter defined
in subclause 12.2.2.32;
f) zero or one \ element containing the parameter defined in
subclause 12.2.2.71;
g) zero or one \ element containing elements defined in future
releases;
h) zero, one or more elements from other namespaces defined in future
releases; and
i) zero, one or more attributes defined in future releases;
7) zero, one or more \ element which contains
transactions sent from the ProSe Function to the UE as a response to a
discoveree UE\'s request for restricted ProSe direct discovery model B if the
ProSe Function accepts the request. Each \
consists of:
a) a \ element containing the parameter defined in subclause
12.2.2.1;
b) a \ element containing the element defined in
subclause12.2.2.42;
c) one or more \ elements containing the parameter defined in
subclause 12.2.2.43;
d) a \ element containing the parameter defined in
subclause 12.2.2.44;
e) zero or one \ element containing the
parameter defined in subclause 12.2.2.40;
f) a \ element containing the parameter defined in
subclause 12.2.2.33;
g) zero or one \ element containing the parameter defined in
subclause 12.2.2.71;
h) zero or one \ element containing elements defined in future
releases;
i) zero, one or more elements from other namespaces defined in future
releases; and
j) zero, one or more attributes defined in future releases;
8) zero, one or more \ element which contains
transactions sent from the ProSe Function to the UE as a response to a
discoverer UE\'s request for restricted ProSe direct discovery model B if the
ProSe Function accepts the request. Each \
consists of:
a) a \ element containing the parameter defined in subclause
12.2.2.1;
b) one or more \ elements containing the parameter defined in
subclause 12.2.2.45;
c) a \ element containing the parameter defined in
subclause 12.2.2.33;
d) zero or one \ element containing the parameter defined in
subclause 12.2.2.71;
e) zero or one \ element containing elements defined in future
releases;
f) zero, one or more elements from other namespaces defined in future
releases; and
g) zero, one or more attributes defined in future releases;
9) zero, one or more \ element which contains transactions
sent from the ProSe Function to the UE as a response to an announcing or
monitoring requests if the ProSe Function cannot accept the request. Each
\ consists of:
a) a \ element containing the parameter defined in subclause
12.2.2.1;
b) a \ element containing the parameter
defined in subclause 12.2.2.8.
c) zero, one or more elements defined in future releases; and
d) zero, one or more attributes defined in future releases;
10) zero or one \ element containing elements defined in future
releases;
11) zero, one or more elements from other namespaces defined in future
releases;
12) an optional \"network-initiated transaction method\" attribute containing
the parameter defined in subclause 12.2.2.63; and
13) zero, one or more attributes defined in future releases.
#### 11.2.4.4 Semantics of \
The \ element contains one or more of the following element:
1) zero, one or more \ element which contains transactions sent
from the UE to the ProSe Function to report a matching of the direct
discovery. Each \ consists of:
a) a \ element containing the parameter defined in subclause
12.2.2.1;
b) a \ element containing the parameter defined in
subclause 12.2.2.6;
c) a \ element containing the parameter defined in subclause
12.2.2.3;
d) a \ element containing the parameter defined in
subclause 12.2.2.16;
e) an optional \ element containing the parameter defined in
subclause 12.2.2.17;
f) a \ element containing the parameter defined in subclause 12.2.2.11;
g) a \ element containing the parameter defined in
subclause 12.2.2.18;
h) a \ element containing the parameter defined in subclause
12.2.2.20;
i) a \ element containing the parameter defined in subclause
12.2.2.10;
j) zero or one \ element containing the parameter defined in
subclause 12.2.2.71;
k) zero or one \ element containing elements defined in future
releases;
l) zero, one or more elements from other namespaces defined in future
releases; and
m) zero, one or more attributes defined in future releases;
2) zero, one or more \ element which contain transactions
sent from the UE to the ProSe Function to report a matching of the restricted
direct discovery model A or model B. Each \ consists of:
a) a \ element containing the parameter defined in subclause
12.2.2.1;
b) a \ element containing the parameter defined in subclause
subclause 12.2.2.3;
c) a \ element containing the parameter defined in subclause
12.2.2.25
d) an \ element containing the parameter defined in
subclause 12.2.2.5
e) an \ element containing the parameter defined in subclause
12.2.2.30;
f) a \ element containing the ProSe Restricted
Code parameter defined in subclause 12.2.2.34 or ProSe Response Code parameter
defined in subclause 12.2.2.42;
g) an optional \ element containing the parameter defined in subclause
12.2.2.11;
h) an optional \ element containing the parameter defined in
subclause 12.2.2.10;
i) an optional \ element containing the parameter defined
in subclause 12.2.2.18;
j) a \ element containing the parameter defined in subclause
12.2.2.20;
k) zero or one \ element containing the parameter defined in
subclause 12.2.2.71;
l) zero or one \ element containing elements defined in future
releases;
m) zero, one or more elements from other namespaces defined in future
releases; and
n) zero, one or more attributes defined in future releases.
3) zero or one \ element containing elements defined in future
releases;
4) zero, one or more elements from other namespaces defined in future
releases; and
5) zero, one or more attributes defined in future releases.
#### 11.2.4.5 Semantics of \
The \ element contains one or more of the following
elements:
1) a \ element containing the parameter defined in subclause
12.2.2.23;
2) zero, one or more \ element which contains transactions sent
from the ProSe Function to the UE as a response to a match report if the ProSe
Function accepts the report. Each \ consists of:
a) a \ element containing the parameter defined in subclause
12.2.2.1;
b) a \ element containing the parameter defined in
subclause 12.2.2.4;
c) a \ element containing the parameter defined in
subclause 12.2.2.19;
d) an optional \ element containing the parameter defined in
subclause 12.2.2.21;
e) an optional \ element containing the parameter defined
in subclause 12.2.2.62;
f) zero or one \ element containing elements defined in future
releases;
g) zero, one or more elements from other namespaces defined in future
releases;
h) a mandatory \"match-report-refresh-timer-T4006\" attribute containing the
parameter defined in subclause 12.2.2.26; and
i) zero, one or more attributes defined in future releases;
3) zero, one or more \ element which contain
transactions sent from the ProSe Function to the UE as a response to a match
report if the ProSe Function accepts the report. Each \
consists of:
a) a \ element containing the parameter defined in subclause
12.2.2.1;
b) an \ element containing the parameter defined in
subclause 12.2.2.5;
c) an \ element containing the parameter defined in subclause
12.2.2.30;
d) a \ element containing the parameter defined in
subclause 12.2.2.60;
e) an optional \ element containing the parameter defined in
subclause 12.2.2.21;
f) zero or one \ element containing elements defined in future
releases;
g) zero, one or more elements from other namespaces defined in future
releases;
h) an optional \"match-report-refresh-timer-T4017\" attribute containing the
parameter defined in subclause 12.2.2.61; and
> i) zero, one or more attributes defined in future releases;
4) zero, one or more \ element which contains transactions sent
from the ProSe Function to the UE as a response to a match report if the ProSe
Function cannot accept the match report. Each \ consists of:
a) a \ element containing the parameter defined in subclause
12.2.2.1;
b) a \ element containing the parameter
defined in subclause 12.2.2.8;
c) zero, one or more elements defined in future releases; and
d) zero, one or more attributes defined in future releases;
5) zero or one \ element containing elements defined in future
releases;
6) zero, one or more elements from other namespaces defined in future
releases; and
7) zero, one or more attributes defined in future releases.
#### 11.2.4.6 Semantics of \
The \ element contains one or more of the following
elements:
1) One or more \ element which contains transactions sent
from the UE to the ProSe Function to register the UE. Each \ consists of:
a) a \ element containing the parameter defined in subclause
12.3.2.1;
b) a \ element containing the parameter defined in subclause
12.3.2.2;
c) a \ element containing the parameter defined in
subclause 12.3.2.6;
d) a \ element containing the
parameter defined in subclause 12.3.2.14;
e) zero or one \ element containing elements defined in future
releases;
f) zero, one or more elements from other namespaces defined in future
releases; and
g) zero, one or more attributes defined in future releases;
2) zero or one \ element containing elements defined in future
releases;
3) zero, one or more elements from other namespaces defined in future
releases; and
4) zero, one or more attributes defined in future releases.
#### 11.2.4.7 Semantics of \
The \ element contains one or more of the following
elements:
1) zero, one or more \ element which contains transactions
sent from the ProSe Function to the UE as a response to the
UE_REGISTRATION_REQUEST message if the ProSe Function accepts the request.
Each \ consists of:
a) a \ element containing the parameter defined in subclause
12.3.2.1;
b) an \ element containing the parameter defined in
subclause 12.3.2.7;
c) a \ element containing the parameter
defined in subclause 12.3.2.15;
d) zero, one or more elements defined in future releases; and
e) zero, one or more attributes defined in future releases;
2) zero, one or more \ element which contains transactions
sent from the ProSe Function to the UE as a response to the
UE_REGISTRATION_REQUEST message if the ProSe Function cannot accept the
request. Each \ consists of:
a) a \ element containing the parameter defined in subclause
12.3.2.1;
b) a \ element containing the parameter
defined in subclause 12.3.2.5;
c) zero, one or more elements defined in future releases; and
d) zero, one or more attributes defined in future releases;
3) zero or one \ element containing elements defined in future
releases;
4) zero, one or more elements from other namespaces defined in future
releases; and
5) zero, one or more attributes defined in future releases.
#### 11.2.4.8 Semantics of \
The \ element contains one or more of the
following elements:
1) One or more \ element which contains
transactions sent from the UE to the ProSe Function to activate EPC-level
ProSe discovery for a specific application. Each \ consists of:
a) a \ element containing the parameter defined in subclause
12.3.2.1;
b) an \ element containing the parameter defined in
subclause 12.3.2.7.
c) an \ element containing the parameter defined in
subclause 12.3.2.3;
d) an \ element containing the parameter defined in
subclause 12.3.2.4;
e) zero, one or more elements defined in future releases; and
f) zero, one or more attributes defined in future releases;
2) zero or one \ element containing elements defined in future
releases;
3) zero, one or more elements from other namespaces defined in future
releases; and
4) zero, one or more attributes defined in future releases.
#### 11.2.4.9 Semantics of \
The \ element contains one or more of the
following elements:
1) zero, one or more \ element which contains transactions
sent from the ProSe Function to the UE as a response to the
APPLICATION_REGISTRATION_REQUEST message if the ProSe Function accepts the
request. Each \ consists of:
a) a \ element containing the parameter defined in subclause
12.3.2.1;
b) one or more \ element containing the parameter defined
in subclause 12.3.2.8;
c) zero or one \ element containing elements defined in future
releases;
d) zero, one or more elements from other namespaces defined in future
releases; and
e) zero, one or more attributes defined in future releases;
2) zero,one or more \ element which contains transactions
sent from the ProSe Function to the UE as a response to the
APPLICATION_REGISTRATION_REQUEST message if the ProSe Function cannot accept
the request. Each \ consists of:
a) a \ element containing the parameter defined in subclause
12.3.2.1;
b) a \ element containing the parameter
defined in subclause 12.3.2.5;
c) zero, one or more elements defined in future releases; and
d) zero, one or more attributes defined in future releases;
3) zero or one \ element containing elements defined in future
releases;
4) zero, one or more elements from other namespaces defined in future
releases; and
5) zero, one or more attributes defined in future releases.
#### 11.2.4.10 Semantics of \
The \ element contains one or more of the following
elements:
1) One or more \ element which contains transactions sent
from the UE to the ProSe Function to request to be alerted when it enters in
proximity with a targeted UE. Each \ consists of:
a) a \ element containing the parameter defined in subclause
12.3.2.1;
b) an \ element containing the parameter defined in
subclause 12.3.2.7;
c) an \ element containing the parameter defined in
subclause 12.3.2.3;
d) an \ element containing the parameter defined
in subclause 12.3.2.4;
e) an \ element containing the parameter defined
in subclause 12.3.2.4;
f) a \ element containing the parameter defined in
subclause 12.3.2.8;
g) a \ element containing the parameter defined in subclause
12.3.2.11;
h) a \ element containing the parameter defined in subclause
12.3.2.9;
i) an optional \ element containing the parameter defined in
subclause 12.3.2.12;
j) zero or one \ element containing elements defined in future
releases;
k) zero, one or more elements from other namespaces defined in future
releases; and
l) zero, one or more attributes defined in future releases;
2) zero or one \ element containing elements defined in future
releases;
3) zero, one or more elements from other namespaces defined in future
releases; and
4) zero, one or more attributes defined in future releases.
#### 11.2.4.11 Semantics of \
The \ element contains one or more of the
following elements:
1) zero,one or more \ element which contains transactions
sent from the ProSe Function to the UE as a response to the PROXIMITY_REQUEST
message if the ProSe Function accepts the request. Each \
consists of:
a) a \ element containing the parameter defined in subclause
12.3.2.1;
b) zero, one or more elements defined in future releases; and
c) zero, one or more attributes defined in future releases;
2) zero, one or more \ element which contains transactions
sent from the ProSe Function to the UE as a response to the PROXIMITY_REQUEST
message if the ProSe Function cannot accept the request. Each \ consists of:
a) a \ element containing the parameter defined in subclause
12.3.2.1;
> b) a \ element containing the
> parameter defined in subclause 12.3.2.5;
c) zero, one or more elements defined in future releases; and
d) zero, one or more attributes defined in future releases;
3) zero or one \ element containing elements defined in future
releases;
4) zero, one or more elements from other namespaces defined in future
releases; and
5) zero, one or more attributes defined in future releases.
#### 11.2.4.12 Semantics of \
The \ element contains one or more of the following elements:
1) One or more \ element which contains transactions sent
from the ProSe Function to the (UE A) and optionally to targeted (UE B) to
alert them that they have entered in proximity. Each \
consists of:
a) \ element containing the parameter defined in subclause
12.3.2.1;
b) an \ element containing the parameter defined in
subclause 12.3.2.3;
c) an \ element containing the parameter defined
in subclause 12.3.2.4;
d) an \ element containing the parameter defined
in subclause 12.3.2.4;
e) an optional \ element containing the parameter
defined in subclause 12.3.2.13;
f) zero or one \ element containing elements defined in future
releases;
g) zero, one or more elements from other namespaces defined in future
releases; and
h) zero, one or more attributes defined in future releases;
2) zero or one \ element containing elements defined in future
releases;
3) zero, one or more elements from other namespaces defined in future
releases; and
4) zero, one or more attributes defined in future releases.
#### 11.2.4.13 Semantics of \
The \ element contains one or more of the following
elements:
1) One or more \ element which contains transactions
sent either from the UE to the ProSe Function or from the ProSe Function to
the UE to deregister the UE. Each \ consists of:
a) a \ element containing the parameter defined in subclause
12.3.2.1;
b) an \ element containing the parameter defined in
subclause 12.3.2.7;
c) a \ element containing the parameter
defined in subclause 12.3.2.5;
d) zero, one or more elements defined in future releases; and
e) zero, one or more attributes defined in future releases
2) zero or one \ element containing elements defined in future
releases;
3) zero, one or more elements from other namespaces defined in future
releases; and
4) zero, one or more attributes defined in future releases.
#### 11.2.4.14 Semantics of \
The \ element contains one or more of the
following elements:
1) One or more \ element which contains transactions
sent either from the UE to the ProSe Function or from the ProSe Function to
the UE to complete the UE deregistration. Each \
consists of:
a) a \ element containing the parameter defined in subclause
12.3.2.1;
b) zero, one or more elements defined in future releases; and
c) zero, one or more attributes defined in future releases
2) zero or one \ element containing elements defined in future
releases;
3) zero, one or more elements from other namespaces defined in future
releases; and
4) zero, one or more attributes defined in future releases.
#### 11.2.4.15 Semantics of \
The \ element contains one or more of the following
elements:
1) One or more \ element which contains transactions
sent from the UE to the ProSe Function or from the ProSe Function to the UE to
request cancellation of an ongoing proximity request. Each \ consists of:
a) a \ element containing the parameter defined in subclause
12.3.2.1;
b) an \ element containing the parameter defined in
subclause 12.3.2.7;
c) an \ element containing the parameter defined in
subclause 12.3.2.3;
d) an \ element containing the parameter defined
in subclause 12.3.2.4;
e) zero, one or more elements defined in future releases; and
f) zero, one or more attributes defined in future releases;
2) zero or one \ element containing elements defined in future
releases
3) zero, one or more elements from other namespaces defined in future
releases; and
4) zero, one or more attributes defined in future releases.
#### 11.2.4.16 Semantics of \
The \ element contains one or more of the following
elements:
1) One or more \ element which contains
transactions sent from the ProSe Function to the UE or from the UE to the
ProSe Function as a response to CANCEL_PROXIMITY_REQUEST message. Each \ consists of:
a) a \ element containing the parameter defined in subclause
12.3.2.1;
b) zero, one or more elements defined in future releases; and
c) zero, one or more attributes defined in future releases;
2) zero or one \ element containing elements defined in future
releases;
3) zero, one or more elements from other namespaces defined in future
releases; and
4) zero, one or more attributes defined in future releases.
#### 11.2.4.17 Semantics of \
The \ element contains one or more of the
following elements:
1) One or more \ element which contains
transactions sent by the ProSe Function to the targeted UE (UE B) to request
confirmation of permission for proximity request. Each \ consists of:
a) a \ element containing the parameter defined in subclause
12.3.2.1;
b) an \ element containing the parameter defined in
subclause 12.3.2.3;
c) zero, one or more elements defined in future releases; and
d) zero, one or more attributes defined in future releases;
2) zero or one \ element containing elements defined in future
releases;
3) zero, one or more elements from other namespaces defined in future
releases; and
4) zero, one or more attributes defined in future releases.
#### 11.2.4.18 Semantics of \
The \ element contains one or more of
the following elements:
1) zero, one or more \ element which contains transactions
sent from the UE to the ProSe Function as a response to the
PROXIMITY_REQUEST_VALIDATION message if the application in the UE accepts the
request. Each \ consists of:
a) a \ element containing the parameter defined in subclause
12.3.2.1;
b) zero, one or more elements defined in future releases; and
c) zero, one or more attributes defined in future releases;
2) zero, one or more \ element which contains transactions
sent from the UE to the ProSe Function as a response to the
PROXIMITY_REQUEST_VALIDATION message if the application in the UE does not
accept the request. Each \ consists of:
a) a \ element containing the parameter defined in subclause
12.3.2.1;
> b) a \ element containing the
> parameter defined in subclause 12.3.2.5.
c) zero, one or more elements defined in future releases; and
d) zero, one or more attributes defined in future releases;
3) zero or one \ element containing elements defined in future
releases;
4) zero, one or more elements from other namespaces defined in future
releases; and
5) zero, one or more attributes defined in future releases.
#### 11.2.4.19 Semantics of \
The \ element contains one or more of the following
elements:
1) One or more \ element which contains transactions
sent from the ProSe Function to the UE as announcing or monitoring requests.
Each \ consists of:
a) a \ element containing the parameter defined
in subclause 12.2.2.28;
b) a \ element containing the parameter defined in subclause
12.2.2.3;
c) a \ element containing the parameter defined in
subclause 12.2.2.33;
d) an optional \ element containing the parameter defined in
subclause 12.2.2.29;
e) zero or one \ element containing elements defined in future
releases;
f) zero, one or more elements defined in future releases; and
g) zero, one or more attributes defined in future releases;
2) zero or one \ element containing elements defined in future
releases;
3) zero, one or more elements from other namespaces defined in future
releases; and
4) zero, one or more attributes defined in future releases.
#### 11.2.4.20 Semantics of \
The \ element contains one or more of the
following elements:
1) one or more \ element which contains transactions sent
from the UE to the ProSe Function as a response if the UE accepts the request.
Each \ consists of:
a) a \ element containing the parameter defined
in subclause 12.2.2.28;
b) a \ element containing the parameter defined in
subclause 12.2.2.33;
c) zero, one or more elements defined in future releases; and
d) zero, one or more attributes defined in future releases;
2) zero, one or more \ element which contains transactions
sent from the UE to the ProSe Function as a response if the UE cannot accept
the request. Each \ consists of:
a) a \ element containing the parameter defined
in subclause 12.2.2.28;
b) a \ element containing the parameter
defined in subclause 12.2.2.8.
c) zero, one or more elements defined in future releases; and
d) zero, one or more attributes defined in future releases;
3) zero or one \ element containing elements defined in future
releases;
4) zero, one or more elements from other namespaces defined in future
releases; and
5) zero, one or more attributes defined in future releases.
#### 11.2.4.21 Semantics of \
The \ element contains one or more of the following
elements:
1) One or more \ element which contains transactions
sent from the UE to the ProSe Function as announcing or monitoring requests.
Each \ consists of:
a) a \ element containing the parameter defined
in subclause 12.2.2.28;
b) a \ element containing the parameter defined in subclause
12.2.2.3;
c) a \ element containing the parameter defined in subclause
12.2.2.30;
d) a \ element containing the parameter defined in
subclause 12.2.2.33;
e) a \ element containing the parameter defined in
subclause 12.2.2.34;
f) zero, one or more \ element containing
the parameter defined in subclause 12.2.2.35;
g) zero or one \ element containing elements defined in future
releases;
h) zero, one or more elements from other namespaces defined in future
releases; and
i) zero, one or more attributes defined in future releases;
2) zero or one \ element containing elements defined in future
releases;
3) zero, one or more elements from other namespaces defined in future
releases; and
4) zero, one or more attributes defined in future releases.
#### 11.2.4.22 Semantics of \
The \ element contains one or more of the following
elements:
1) One or more \ element which contains
transactions sent from the UE to the ProSe Function as announcing or
monitoring requests. Each \ consists of:
a) a \ element containing the parameter defined
in subclause 12.2.2.28;
b) zero, one or more elements defined in future releases; and
c) zero, one or more attributes defined in future releases;
2) zero, one or more \ element which contains transactions
sent from the UE to the ProSe Function as a response if the UE cannot accept
the request. Each \ consists of:
a) a \ element containing the parameter defined
in subclause 12.2.2.28;
b) a \ element containing the parameter
defined in subclause 12.2.2.8.
c) zero, one or more elements defined in future releases; and
d) zero, one or more attributes defined in future releases;
3) zero or one \ element containing elements defined in future
releases;
4) zero, one or more elements from other namespaces defined in future
releases; and
5) zero, one or more attributes defined in future releases.
### 11.2.5 PC5_DISCOVERY
#### 11.2.5.1 Message definition
This message is sent by the UE over the PC5 interface for open ProSe direct
discovery and restricted ProSe direct discovery. See table 11.2.5.1.1, table
11.2.5.1.1A, table 11.2.5.1.2, table 11.2.5.1.3, table 11.2.5.1.4, table
11.2.5.1.5, table 11.2.5.1.6, table 11.2.5.1.7, table 11.2.5.1.8, table
11.2.5.1.9 and table 11.2.5.1.10.
Table 11.2.5.1.1: PC5_DISCOVERY message content for open ProSe direct
discovery
+-------------------+----------------+----------+---------------+ | Information | Type/Reference | Presence | Length (bits) | | Element | | | | +-------------------+----------------+----------+---------------+ | Message Type | Message Type | M | 8 | | (NOTE) | | | | | | 12.2.2.10 | | | +-------------------+----------------+----------+---------------+ | ProSe Application | Binary | M | 184 | | Code | | | | | | 12.2.2.6 | | | +-------------------+----------------+----------+---------------+ | MIC | Binary | M | 32 | | | | | | | | 12.2.2.11 | | | +-------------------+----------------+----------+---------------+ | UTC-based Counter | Binary | M | 8 | | LSB | | | | | | 12.2.2.22 | | | +-------------------+----------------+----------+---------------+ | NOTE: The | | | | | Discovery Type is | | | | | set to \"Open | | | | | discovery\" and | | | | | the Content Type | | | | | is not set to | | | | | \"appli | | | | | cation-controlled | | | | | extension | | | | | enabled\". | | | | +-------------------+----------------+----------+---------------+
Table 11.2.5.1.1A: PC5_DISCOVERY message content for open ProSe direct
discovery with application-controlled extension
+-------------------+----------------+----------+---------------+ | Information | Type/Reference | Presence | Length (bits) | | Element | | | | +-------------------+----------------+----------+---------------+ | Message Type | Message Type | M | 8 | | (NOTE 1) | | | | | | 12.2.2.10 | | | +-------------------+----------------+----------+---------------+ | ProSe Application | Binary | M | 32-176 | | Code Prefix | | | | | (NOTE 2) | 12.2.2.68 | | | +-------------------+----------------+----------+---------------+ | ProSe Application | Binary | M | 8-152 | | Code Suffix | | | | | (NOTE 2) | 12.2.2.69 | | | +-------------------+----------------+----------+---------------+ | MIC | Binary | M | 32 | | | | | | | | 12.2.2.11 | | | +-------------------+----------------+----------+---------------+ | UTC-based Counter | Binary | M | 8 | | LSB | | | | | | 12.2.2.22 | | | +-------------------+----------------+----------+---------------+ | NOTE 1: The | | | | | Discovery Type is | | | | | set to \"Open | | | | | discovery\" and | | | | | the Content Type | | | | | is set to | | | | | \"appli | | | | | cation-controlled | | | | | extension | | | | | enabled\". | | | | | | | | | | NOTE 2: The sum | | | | | of the lengths of | | | | | the ProSe | | | | | Application Code | | | | | Prefix and the | | | | | ProSe Application | | | | | Code Suffix is | | | | | 184 bits. | | | | +-------------------+----------------+----------+---------------+
Table 11.2.5.1.2: PC5_DISCOVERY message content for restricted ProSe direct
discovery
+-------------------+----------------+----------+---------------+ | Information | Type/Reference | Presence | Length (bits) | | Element | | | | +-------------------+----------------+----------+---------------+ | Message Type | Message Type | M | 8 | | (NOTE) | | | | | | 12.2.2.10 | | | +-------------------+----------------+----------+---------------+ | ProSe Restricted | Binary | M | 184 | | Code | | | | | | 12.2.2.34 | | | +-------------------+----------------+----------+---------------+ | MIC | Binary | M | 32 | | | | | | | | 12.2.2.11 | | | +-------------------+----------------+----------+---------------+ | UTC-based Counter | Binary | M | 8 | | LSB | | | | | | 12.2.2.22 | | | +-------------------+----------------+----------+---------------+ | NOTE: The | | | | | Discovery Type is | | | | | set to | | | | | \"Restricted | | | | | discovery\" and | | | | | the Content Type | | | | | is not set to | | | | | \"appli | | | | | cation-controlled | | | | | extension | | | | | enabled\". | | | | +-------------------+----------------+----------+---------------+
Table 11.2.5.1.3: PC5_DISCOVERY message content for restricted ProSe direct
discovery with application-controlled extension
+-------------------+----------------+----------+---------------+ | Information | Type/Reference | Presence | Length (bits) | | Element | | | | +-------------------+----------------+----------+---------------+ | Message Type | Message Type | M | 8 | | (NOTE) | | | | | | 12.2.2.10 | | | +-------------------+----------------+----------+---------------+ | ProSe Restricted | Binary | M | 64 | | Code Prefix | | | | | | 12.2.2.46 | | | +-------------------+----------------+----------+---------------+ | ProSe Restricted | Binary | M | 120 | | Code Suffix | | | | | | 12.2.2.47 | | | +-------------------+----------------+----------+---------------+ | MIC | Binary | M | 32 | | | | | | | | 12.2.2.11 | | | +-------------------+----------------+----------+---------------+ | UTC-based Counter | Binary | M | 8 | | LSB | | | | | | 12.2.2.22 | | | +-------------------+----------------+----------+---------------+ | NOTE: The | | | | | Discovery Type is | | | | | set to | | | | | \"Restricted | | | | | discovery\", the | | | | | Content Type is | | | | | set to | | | | | \"appli | | | | | cation-controlled | | | | | extension | | | | | enabled\" and the | | | | | Discovery Model | | | | | is set to \"Model | | | | | A\". | | | | +-------------------+----------------+----------+---------------+
Table 11.2.5.1.4: PC5_DISCOVERY message for UE-to-Network Relay Discovery
Announcement
+-------------------+----------------+----------+---------------+ | Information | Type/Reference | Presence | Length (bits) | | Element | | | | +-------------------+----------------+----------+---------------+ | Message Type | Message Type | M | 8 | | (NOTE) | | | | | | 12.2.2.10 | | | +-------------------+----------------+----------+---------------+ | Relay Service | Binary | M | 24 | | Code | | | | | | 12.2.2.51 | | | +-------------------+----------------+----------+---------------+ | Announcer Info | Binary | M | 48 | | | | | | | | 12.2.2.50 | | | +-------------------+----------------+----------+---------------+ | ProSe Relay UE ID | Binary | M | 24 | | | | | | | | 12.2.2.49 | | | +-------------------+----------------+----------+---------------+ | Status Indicator | Binary | M | 8 | | | | | | | | 12.2.2.67 | | | +-------------------+----------------+----------+---------------+ | Spare | Binary | M | 80 | | | | | | | | 12.2.2.56 | | | +-------------------+----------------+----------+---------------+ | MIC | Binary | M | 32 | | | | | | | | 12.2.2.11 | | | +-------------------+----------------+----------+---------------+ | UTC-based Counter | Binary | M | 8 | | LSB | | | | | | 12.2.2.22 | | | +-------------------+----------------+----------+---------------+ | NOTE: The | | | | | Discovery Type is | | | | | set to | | | | | \"Restricted | | | | | discovery\", the | | | | | Content Type is | | | | | set to | | | | | \"UE-to-Network | | | | | Relay Discovery | | | | | Announcement or | | | | | UE-to-Network | | | | | Relay Discovery | | | | | Response\" and | | | | | the Discovery | | | | | Model is set to | | | | | \"Model A\". | | | | +-------------------+----------------+----------+---------------+
Table 11.2.5.1.5: PC5_DISCOVERY message for UE-to-Network Relay Discovery
Solicitation
+-------------------+----------------+----------+---------------+ | Information | Type/Reference | Presence | Length (bits) | | Element | | | | +-------------------+----------------+----------+---------------+ | Message Type | Message Type | M | 8 | | (NOTE 1) | | | | | | 12.2.2.10 | | | +-------------------+----------------+----------+---------------+ | Relay Service | Binary | M | 24 | | Code | | | | | | 12.2.2.51 | | | +-------------------+----------------+----------+---------------+ | Discoverer Info | Binary | M | 48 | | | | | | | | 12.2.2.50 | | | +-------------------+----------------+----------+---------------+ | URDS Composition | Binary | M | 8 | | | | | | | | 12.2.2.66 | | | +-------------------+----------------+----------+---------------+ | ProSe Relay UE ID | Binary | C | 24 | | | | | | | | 12.2.2.49 | (NOTE 2) | | +-------------------+----------------+----------+---------------+ | Spare | Binary | M | 80 or 104 | | | | | | | | 12.2.2.56 | | (NOTE 3) | +-------------------+----------------+----------+---------------+ | MIC | Binary | M | 32 | | | | | | | | 12.2.2.11 | | | +-------------------+----------------+----------+---------------+ | UTC-based Counter | Binary | M | 8 | | LSB | | | | | | 12.2.2.22 | | | +-------------------+----------------+----------+---------------+ | NOTE 1: The | | | | | Discovery Type is | | | | | set to | | | | | \"Restricted | | | | | discovery\", the | | | | | Content Type is | | | | | set to | | | | | \"UE-to-Network | | | | | Relay Discovery | | | | | Solicitation\" | | | | | and the Discovery | | | | | Model is set to | | | | | \"Model B\". | | | | | | | | | | NOTE 2: Presence | | | | | of the ProSe | | | | | Relay UE ID is | | | | | indicated by the | | | | | URDS Composition. | | | | | | | | | | NOTE 3: If the | | | | | ProSe Relay UE ID | | | | | is present, then | | | | | the length of the | | | | | Spare is80 bits. | | | | | If ProSe Relay UE | | | | | ID is not | | | | | included, then | | | | | the length of the | | | | | Spare is 104 | | | | | bits. | | | | +-------------------+----------------+----------+---------------+
Table 11.2.5.1.6: PC5_DISCOVERY message for UE-to-Network Relay Discovery
Response
+-------------------+----------------+----------+---------------+ | Information | Type/Reference | Presence | Length (bits) | | Element | | | | +-------------------+----------------+----------+---------------+ | Message Type | Message Type | M | 8 | | (NOTE) | | | | | | 12.2.2.10 | | | +-------------------+----------------+----------+---------------+ | Relay Service | Binary | M | 24 | | Code | | | | | | 12.2.2.51 | | | +-------------------+----------------+----------+---------------+ | Discoveree Info | Binary | M | 48 | | | | | | | | 12.2.2.50 | | | +-------------------+----------------+----------+---------------+ | ProSe Relay UE ID | Binary | M | 24 | | | | | | | | 12.2.2.49 | | | +-------------------+----------------+----------+---------------+ | Status Indicator | Binary | M | 8 | | | | | | | | 12.2.2.67 | | | +-------------------+----------------+----------+---------------+ | Spare | Binary | M | 80 | | | | | | | | 12.2.2.56 | | | +-------------------+----------------+----------+---------------+ | MIC | Binary | M | 32 | | | | | | | | 12.2.2.11 | | | +-------------------+----------------+----------+---------------+ | UTC-based Counter | Binary | M | 8 | | LSB | | | | | | 12.2.2.22 | | | +-------------------+----------------+----------+---------------+ | NOTE: The | | | | | Discovery Type is | | | | | set to | | | | | \"Restricted | | | | | discovery\", the | | | | | Content Type is | | | | | set to | | | | | \"UE-to-Network | | | | | Relay Discovery | | | | | Announcement or | | | | | UE-to-Network | | | | | Relay Discovery | | | | | Response\" and | | | | | the Discovery | | | | | Model is set to | | | | | \"Model B\". | | | | +-------------------+----------------+----------+---------------+
Table 11.2.5.1.7: PC5_DISCOVERY message for Group Member Discovery
Announcement
+-------------------+----------------+----------+---------------+ | Information | Type/Reference | Presence | Length (bits) | | Element | | | | +-------------------+----------------+----------+---------------+ | Message Type | Message Type | M | 8 | | (NOTE) | | | | | | 12.2.2.10 | | | +-------------------+----------------+----------+---------------+ | Discovery Group | Binary | M | 24 | | ID | | | | | | 12.2.2.54 | | | +-------------------+----------------+----------+---------------+ | Announcer Info | Binary | M | 48 | | | | | | | | 12.2.2.50 | | | +-------------------+----------------+----------+---------------+ | ProSe UE ID | Binary | M | 24 | | | | | | | | 12.2.2.48 | | | +-------------------+----------------+----------+---------------+ | Spare | Binary | M | 88 | | | | | | | | 12.2.2.56 | | | +-------------------+----------------+----------+---------------+ | MIC | Binary | M | 32 | | | | | | | | 12.2.2.11 | | | +-------------------+----------------+----------+---------------+ | UTC-based Counter | Binary | M | 8 | | LSB | | | | | | 12.2.2.22 | | | +-------------------+----------------+----------+---------------+ | NOTE: The | | | | | Discovery Type is | | | | | set to | | | | | \"Restricted | | | | | discovery\", the | | | | | Content Type is | | | | | set to \"Group | | | | | Member Discovery | | | | | Announcement or | | | | | Group Member | | | | | Discovery | | | | | Response\" and | | | | | the Discovery | | | | | Model is set to | | | | | \"Model A\". | | | | +-------------------+----------------+----------+---------------+
Table 11.2.5.1.8: PC5_DISCOVERY message for Group Member Discovery
Solicitation
+------------------+----------------+------------+---------------+ | Information | Type/Reference | Presence | Length (bits) | | Element | | | | +------------------+----------------+------------+---------------+ | Message Type | Message Type | M | 8 | | (NOTE 1) | | | | | | 12.2.2.10 | | | +------------------+----------------+------------+---------------+ | Discovery Group | Binary | M | 24 | | ID | | | | | | 12.2.2.54 | | | +------------------+----------------+------------+---------------+ | Discoverer Info | Binary | M | 48 | | | | | | | | 12.2.2.50 | | | +------------------+----------------+------------+---------------+ | GMDS Composition | Binary | M | 8 | | | | | | | | 12.2.2.55 | | | +------------------+----------------+------------+---------------+ | Target User Info | Binary | C (NOTE 2) | 48 | | | | | | | | 12.2.2.52 | | | +------------------+----------------+------------+---------------+ | Target Group | Binary | C (NOTE 2) | 24 | | Info | | | | | | 12.2.2.53 | | | +------------------+----------------+------------+---------------+ | Spare | Binary | M | 56 or 80 | | | | | | | | 12.2.2.56 | | (NOTE 3) | +------------------+----------------+------------+---------------+ | MIC | Binary | M | 32 | | | | | | | | 12.2.2.11 | | | +------------------+----------------+------------+---------------+ | UTC-based | Binary | M | 8 | | Counter LSB | | | | | | 12.2.2.22 | | | +------------------+----------------+------------+---------------+ | NOTE 1: The | | | | | Discovery Type | | | | | is set to | | | | | \"Restricted | | | | | discovery\", the | | | | | Content Type is | | | | | set to \"Group | | | | | Member Discovery | | | | | Solicitation\" | | | | | and the | | | | | Discovery Model | | | | | is set to | | | | | \"Model B\". | | | | | | | | | | NOTE 2: Presence | | | | | of the Target | | | | | User Info and of | | | | | Target Group | | | | | Info is | | | | | indicated by the | | | | | GMDS | | | | | Composition. | | | | | | | | | | NOTE 3: If the | | | | | Target User Info | | | | | is present, then | | | | | the length of | | | | | the Spare is 56 | | | | | bits. If the | | | | | Target Group | | | | | Info is present, | | | | | then the length | | | | | of the Spare is | | | | | 80 bits. | | | | +------------------+----------------+------------+---------------+
Table 11.2.5.1.9: PC5_DISCOVERY message for Group Member Discovery Response
+-------------------+----------------+----------+---------------+ | Information | Type/Reference | Presence | Length (bits) | | Element | | | | +-------------------+----------------+----------+---------------+ | Message Type | Message Type | M | 8 | | (NOTE) | | | | | | 12.2.2.10 | | | +-------------------+----------------+----------+---------------+ | Discovery Group | Binary | M | 24 | | ID | | | | | | 12.2.2.54 | | | +-------------------+----------------+----------+---------------+ | Discoveree Info | Binary | M | 48 | | | | | | | | 12.2.2.50 | | | +-------------------+----------------+----------+---------------+ | ProSe UE ID | Binary | M | 24 | | | | | | | | 12.2.2.48 | | | +-------------------+----------------+----------+---------------+ | Spare | Binary | M | 88 | | | | | | | | 12.2.2.56 | | | +-------------------+----------------+----------+---------------+ | MIC | Binary | M | 32 | | | | | | | | 12.2.2.11 | | | +-------------------+----------------+----------+---------------+ | UTC-based Counter | Binary | M | 8 | | LSB | | | | | | 12.2.2.22 | | | +-------------------+----------------+----------+---------------+ | NOTE: The | | | | | Discovery Type is | | | | | set to | | | | | \"Restricted | | | | | discovery\", the | | | | | Content Type is | | | | | set to \"Group | | | | | Member Discovery | | | | | Announcement or | | | | | Group Member | | | | | Discovery | | | | | Response\" and | | | | | the Discovery | | | | | Model is set to | | | | | \"Model B\". | | | | +-------------------+----------------+----------+---------------+
Table 11.2.5.1.10: PC5_DISCOVERY message for Relay Discovery Additional
Information
+------------------+----------------+------------+---------------+ | Information | Type/Reference | Presence | Length (bits) | | Element | | | | +------------------+----------------+------------+---------------+ | Message Type | Message Type | M | 8 | | (NOTE 1) | | | | | | 12.2.2.10 | | | +------------------+----------------+------------+---------------+ | Relay Service | Binary | M | 24 | | Code | | | | | | 12.2.2.51 | | | +------------------+----------------+------------+---------------+ | ProSe Relay UE | Binary | M | 24 | | ID | | | | | | 12.2.2.49 | | | +------------------+----------------+------------+---------------+ | Announcer Info | Binary | M | 48 | | | | | | | | 12.2.2.50 | | | +------------------+----------------+------------+---------------+ | RDAI Composition | Binary | M | 8 | | | | | | | | 12.2.2.57 | | | +------------------+----------------+------------+---------------+ | ECGI | Binary | C (NOTE 2) | 56 | | | | | | | | 12.2.2.58 | | | +------------------+----------------+------------+---------------+ | MBMS related | Binary | C (NOTE 2) | 72 | | information | | | | | | 12.2.2.59 | | | +------------------+----------------+------------+---------------+ | Spare | Binary | M | 8 or 24 | | | | | | | | 12.2.2.56 | | (NOTE 3) | +------------------+----------------+------------+---------------+ | MIC | Binary | M | 32 | | | | | | | | 12.2.2.11 | | | +------------------+----------------+------------+---------------+ | UTC-based | Binary | M | 8 | | Counter LSB | | | | | | 12.2.2.22 | | | +------------------+----------------+------------+---------------+ | NOTE 1: The | | | | | Discovery Type | | | | | is set to | | | | | \"Restricted | | | | | discovery\", the | | | | | Content Type is | | | | | set to \"Relay | | | | | discovery | | | | | additional | | | | | information\" | | | | | and the | | | | | Discovery Model | | | | | is set to | | | | | \"Model A\". | | | | | | | | | | NOTE 2: Presence | | | | | of the ECGI and | | | | | MBMS related | | | | | information is | | | | | indicated by the | | | | | RDAI | | | | | Composition. | | | | | | | | | | NOTE 3: If the | | | | | RDAI Composition | | | | | indicates | | | | | inclusion of the | | | | | MBMS related | | | | | information, it | | | | | is 8 bits. If | | | | | the RDAI | | | | | Composition | | | | | indicates | | | | | inclusion of the | | | | | ECGI, it is 24 | | | | | bits. | | | | +------------------+----------------+------------+---------------+
## 11.3 Messages transmitted over the PC3ch interface
### 11.3.1 General
This subclause defines XML schema and MIME type related to messages
transmitted over the PC3ch interface.
### 11.3.2 application/3gpp-prose-pc3ch+xml
The MIME type is used to carry information related to message transmitted over
the PC3ch interface. It shall be coded as an XML document compliant to the XML
schema in subclause 11.3.3 containing one of the following messages:
\- USAGE_INFORMATION_REPORT_LIST; or
\- USAGE_INFORMATION_REPORT_LIST_RESPONSE.
Each of those messages is presented in the XML document as an XML element
named after the corresponding message.
The XML document can contain elements and attributes defined in future
releases of this document. Receiving entity ignores any element not defined by
this version of the specification and any attribute not defined by this
version of the specification.
### 11.3.3 XML Schema
\
\
\
\
Syntax of messages transmitted over the PC3ch interface
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
### 11.3.4 Semantics
#### 11.3.4.1 General
The \ element is the root element of this XML document.
The \ element contains one of the following:
a) \ element;
b) \ element;
c) \ element containing elements defined in future releases; or
d) one or more elements from other namespace defined in future releases.
The \ element contains zero, one or more attributes
defined in future releases.
#### 11.3.4.2 Semantics of \
The \ element contains:
a) a \ element containing the parameter defined in subclause
12.4.2.1;
b) a \ element containing the parameter defined in subclause
12.4.2.2;
c) one or more \ elements;
d) zero, one or more \ element;
e) zero or one \ element containing elements defined in future
releases;
f) zero, one or more elements from other namespaces defined in future
releases; and
g) zero, one or more attributes defined in future releases.
The \ element carries one usage information report.
The \ element contains:
a) mandatory \"sequence-number\" attribute containing the parameter defined in
subclause 12.4.2.3;
b) zero, one or more \ elements;
c) zero, one or more \ element;
d) zero, one or more \ elements;
e) zero or one \ element containing elements defined in future
releases;
f) zero, one or more elements from other namespaces defined in future
releases; and
g) zero, one or more attributes defined in future releases.
The \ element carries information whether the UE was in E-UTRAN
coverage or out of E-UTRAN coverage. The \ element contains:
a) mandatory \"in-coverage\" attribute containing the parameter defined in
subclause 12.4.2.4;
b) optional \"timestamp\" attribute containing the parameter defined in
subclause 12.4.2.8 indicating date and time when the information given in the
element start being valid;
c) if the UE was in E-UTRAN coverage, zero, one or more \ elements;
d) zero or one \ element containing elements defined in future
releases;
e) zero, one or more elements from other namespaces defined in future
releases; and
f) zero, one or more attributes defined in future releases.
The \ element carries information about an E-UTRAN cell where the UE
was camping on or which the UE used in the EMM-CONNECTED mode. The \
element contains:
a) an optional \"ECGI\" attribute containing the parameter defined in
subclause 12.4.2.5;
b) an optional \"timestamp\" attribute containing the parameter defined in
subclause 12.4.2.8 indicating date and time when the information given in the
element start being valid;
c) zero or one \ element containing elements defined in future
releases;
d) zero, one or more elements from other namespaces defined in future
releases; and
e) zero, one or more attributes defined in future releases.
The \ element carries information about the configured
radio parameters for the ProSe direct communication applicable in the
geographical area of the UE. The \ element contains:
a) a mandatory \"params\" attribute containing the parameter defined in
subclause 12.4.2.6;
b) a mandatory \"timestamp\" attribute containing the parameter defined in
subclause 12.4.2.8 indicating date and time when the information given in the
element start being valid;
c) zero or one \ element containing elements defined in future
releases;
d) zero, one or more elements from other namespaces defined in future
releases; and
e) zero, one or more attributes defined in future releases.
The \ element carries information about a ProSe group. The \
element contains:
a) a mandatory \"prose-layer2-group-ID\" attribute containing the parameter
defined in subclause 12.4.2.9;
b) a mandatory \"prose-group-IP-multicast-address\" attribute containing the
parameter defined in subclause 12.4.2.10;
c) an optional \"first-transmission-timestamp\" attribute containing the
parameter defined in subclause 12.4.2.8 indicating date and time of the first
transmission to the ProSe Group IP multicast address in the collection period;
d) an optional \"first-reception-timestamp\" attribute containing the
parameter defined in subclause 12.4.2.8 indicating date and time of the first
reception from the ProSe Group IP multicast address in the collection period;
e) a \ element containing the parameter defined in
subclause 12.4.2.11, of the UE;
f) a \ element containing the parameter defined in subclause
12.4.2.12, of the UE;
g) zero, one or more \ element;
h) zero, one or more \ element;
i) zero, one or more \ element;
j) zero or one \ element containing elements defined in future
releases;
k) zero, one or more elements from other namespaces defined in future
releases; and
l) zero, one or more attributes defined in future releases.
The \ element carries information about a transmitter in a ProSe
group. The \ element contains:
a) a mandatory \"source-IP-address\" attribute containing the parameter
defined in subclause 12.4.2.11, of the transmitter;
b) a mandatory \"prose-UE-id\" attribute containing the parameter defined in
subclause 12.4.2.12, of the transmitter;
c) zero or one \ element containing elements defined in future
releases;
d) zero, one or more elements from other namespaces defined in future
releases; and
e) zero, one or more attributes defined in future releases.
The \ element carries information about a transmission in a
ProSe group. The \ element contains:
a) a mandatory \"in-coverage\" attribute containing the parameter defined in
subclause 12.4.2.4;
b) if the UE was in E-UTRAN coverage when transmitting the data, an optional
\"ECGI\" attribute containing the parameter defined in subclause 12.4.2.5,
indicating E-UTRAN Cell Global Identification of the E-UTRAN cell where the UE
was camping on or which the UE used in the EMM-CONNECTED mode when
transmitting the data;
c) if the UE was in E-UTRAN coverage and the \"ECGI\" attribute is included:
1) a mandatory \"amount\" attribute containing the parameter defined in
subclause 12.4.2.13 indicating the amount of octets transmitted to the ProSe
group:
\- when the UE was camping on a cell identified by the \"ECGI\" attribute when
transmitting the data; or
\- when the UE used in the EMM-CONNECTED mode a cell identified by the
\"ECGI\" attribute when transmitting the data; and
2) an optional \"timestamp\" attribute containing the parameter defined in
subclause 12.4.2.8 indicating date and time of the first transmission in the
E-UTRAN cell;
d) if the UE was in E-UTRAN coverage and the \"ECGI\" attribute is not
included:
1) a mandatory \"amount\" attribute containing the parameter defined in
subclause 12.4.2.13 indicating the amount of octets transmitted to the ProSe
group during the in E-UTRAN coverage period: and
2) an optional \"timestamp\" attribute containing the parameter defined in
subclause 12.4.2.8 indicating date and time of the first transmission during
the in E-UTRAN coverage period;
e) if the UE was out of E-UTRAN coverage:
1) a mandatory \"amount\" attribute containing the parameter defined in
subclause 12.4.2.13 indicating the amount of octets transmitted to the ProSe
group during the out of E-UTRAN coverage period; and
2) an optional \"timestamp\" attribute containing the parameter defined in
subclause 12.4.2.8 indicating date and time of the first transmission during
the out of E-UTRAN coverage period;
f) an optional \"radio-resources-ind\" attribute containing the parameter
defined in subclause 12.4.2.14;
g) an optional \"radio-frequency\" attribute containing the parameter defined
in subclause 12.4.2.15;
i) zero or one \ element containing elements defined in future
releases;
j) zero, one or more elements from other namespaces defined in future
releases; and
k) zero, one or more attributes defined in future releases.
The \ element carries information about a reception in a ProSe
group. The \ element contains:
a) a mandatory \"in-coverage\" attribute containing the parameter defined in
subclause 12.4.2.4 indicating whether the UE was in E-UTRAN coverage when
receiving the data;
b) if the UE was in E-UTRAN coverage when receiving the data, an optional
\"ECGI\" attribute containing the parameter defined in subclause 12.4.2.5
indicating E-UTRAN Cell Global Identification of the E-UTRAN cell where the UE
was camping on or which the UE used in the EMM-CONNECTED mode when receiving
the data;
c) if the UE was in E-UTRAN coverage and the \"ECGI\" attribute is included:
1) a mandatory \"amount\" attribute containing the parameter defined in
subclause 12.4.2.13 indicating the amount of octets received from the ProSe
group:
\- when the UE was camping on a cell identified by the \"ECGI\" attribute when
receiving the data; or
\- when the UE used in the EMM-CONNECTED mode a cell identified by the
\"ECGI\" attribute when receiving the data; and
2) an optional \"timestamp\" attribute containing the parameter defined in
subclause 12.4.2.8 indicating date and time of the first reception in the
E-UTRAN cell;
d) if the UE was in E-UTRAN coverage and the \"ECGI\" attribute is not
included:
1) a mandatory \"amount\" attribute containing the parameter defined in
subclause 12.4.2.13 indicating the amount of octets received from the ProSe
group during the in E-UTRAN coverage period: and
2) an optional \"timestamp\" attribute containing the parameter defined in
subclause 12.4.2.8 indicating date and time of the first reception during the
in E-UTRAN coverage period;
e) if the UE was out of E-UTRAN coverage:
1) a mandatory \"amount\" attribute containing the parameter defined in
subclause 12.4.2.13 indicating the amount of octets received from the ProSe
group during the out of E-UTRAN coverage period; and
2) an optional \"timestamp\" attribute containing the parameter defined in
subclause 12.4.2.8 indicating date and time of the first reception during the
out of E-UTRAN coverage period;
f) an optional \"radio-resources-ind\" attribute containing the parameter
defined in subclause 12.4.2.14;
g) an optional \"radio-frequency\" attribute containing the parameter defined
in subclause 12.4.2.15;
h) zero or one \ element containing elements defined in future
releases;
i) zero, one or more elements from other namespaces defined in future
releases; and
j) zero, one or more attributes defined in future releases.
The \ element contains an application specific data
received from upper layers during the collection period.
#### 11.3.4.3 Semantics of \
The \ element contains:
a) one of \ element and \ element;
b) zero or one \ element containing elements defined in future
releases;
c) zero, one or more elements from other namespaces defined in future
releases; and
d) zero, one or more attributes defined in future releases.
The \ element indicates that a related
USAGE_INFORMATION_REPORT_LIST message was accepted. The \
element contains:
a) \ element containing the parameter defined in subclause
12.4.2.1 indicating the value of the transaction ID of the related
USAGE_INFORMATION_REPORT_LIST message;
b) zero or one \ element containing elements defined in future
releases;
c) zero, one or more elements from other namespaces defined in future
releases; and
d) zero, one or more attributes defined in future releases.
The \ element indicates that a related
USAGE_INFORMATION_REPORT_LIST message was rejected. The \
element contains:
a) \ element containing the parameter defined in subclause
12.4.2.1 indicating the value of the transaction ID of the related
USAGE_INFORMATION_REPORT_LIST message;
b) \ element containing the parameter defined in subclause
12.4.2.7;
c) zero or one \ element containing elements defined in future
releases;
d) zero, one or more elements from other namespaces defined in future
releases; and
e) zero, one or more attributes defined in future releases.
## 11.4 PC5 Signalling messages
### 11.4.1 Overview
This clause defines the structure of the PC5 Signalling messages exchanged
between two ProSe-enabled UEs over the PC5 interface. These are standard L3
messages as defined in 3GPP TS 24.007 [43].
Each definition given in the present clause includes:
> a) a table listing the Information Elements (IE) present in the message and
> the order of their appearance in the message. All IEs that may be repeated
> are explicitly indicated (The V, LV and LV-E formatted IEs, which contain
> the imperative part of the message, occur before the T, TV, TLV and TLV-E
> formatted IEs which contain the non-imperative part of the message, see 3GPP
> TS 24.007 [43]). In a (maximal) sequence of consecutive IEs with half octet
> length, the first IE with half octet length occupies bits 1 to 4 of octet N,
> the second IE bits 5 to 8 of octet N, the third IE bits 1 to 4 of octet N+1
> etc. Such a sequence always has an even number of elements.
For each information element the table indicates:
1\. The Information Element Identifier (IEI), in hexadecimal notation, if the
IE has format T, TV, TLV or TLVâ€‘E. If the IEI has half octet length, it is
specified by a notation representing the IEI as a hexadecimal digit followed
by a \"-\" (example: B-).
NOTE: The same IEI can be used for different information element types in
different messages of the same protocol.
2\. The name of the information element (which is indicative of the semantics
of the element). The name of the information element followed by \"IE\" or
\"information element\" is used as reference to the information element within
a message.
3\. The name of the type of the information element (which indicates the
coding of the value part of the IE), and generally, the referenced subclause
of clause 12 of the present document describing the value part of the
information element.
4\. The presence requirement indication (M, C, or O) for the IE as defined in
3GPP TS 24.007 [43].
5\. The format of the information element (T, V, TV, LV, TLV, LV-E or TLV-E)
as defined in 3GPP TS 24.007 [43].
6\. The length of the information element (or permissible range of lengths),
in octets, in the message, where \"?\" means that the maximum length of the IE
is only constrained by link layer protocol. This indication is non-normative.
b) subclauses specifying, where appropriate, conditions for IEs with presence
requirement C or O in the relevant message which together with other
conditions specified in the present document define when the information
elements shall be included or not, what non-presence of such IEs means, and --
for IEs with presence requirement C -- the static conditions for presence or
non-presence of the IEs or for both cases (see 3GPP TS 24.007 [43]).
### 11.4.2 DIRECT_COMMUNICATION_REQUEST
#### 11.4.2.1 Message definition
This message is sent by a UE to another peer UE to establish a direct link.
See table 11.4.2.1.1.
Message type: DIRECT_COMMUNICATION_REQUEST
Table 11.4.2.1.1: DIRECT_COMMUNICATION_REQUEST message content
+-----+-------------+-------------+----------+--------+--------+ | IEI | Information | Typ | Presence | Format | Length | | | Element | e/Reference | | | | +-----+-------------+-------------+----------+--------+--------+ | | DIRECT_ | PC5-SP | M | V | 1 | | | COMMUNICATI | Message | | | | | | ON_REQUEST | Type | | | | | | message | | | | | | | identity | 12.5.1.1. | | | | +-----+-------------+-------------+----------+--------+--------+ | | Sequence | Sequence | M | V | 2 | | | Number | Number | | | | | | | | | | | | | | 12.5.1.2 | | | | +-----+-------------+-------------+----------+--------+--------+ | | User Info | User Info | M | LV | 3-253 | | | | | | | | | | | 12.5.1.3 | | | | +-----+-------------+-------------+----------+--------+--------+ | | IP Address | IP Address | M | V | 1 | | | Config | Config | | | | | | | | | | | | | | 12.5.1.4 | | | | +-----+-------------+-------------+----------+--------+--------+ | | Maximum | Maximum | M | V | 4 | | | Inactivity | Inactivity | | | | | | Period | Period | | | | | | | | | | | | | | 12.5.1.9 | | | | +-----+-------------+-------------+----------+--------+--------+ | | Nonce_1 | Nonce_1 | M | V | 16 | | | | | | | | | | | 12.5.1.30 | | | | +-----+-------------+-------------+----------+--------+--------+ | | UE Security | UE Security | M | V | 2 | | | C | C | | | | | | apabilities | apabilities | | | | | | | | | | | | | | 12.5.1.22 | | | | +-----+-------------+-------------+----------+--------+--------+ | | MSB of | MSB of | M | V | 1 | | | K~D-sess~ | K~D-sess~ | | | | | | ID | ID | | | | | | | | | | | | | | 12.5.1.25 | | | | +-----+-------------+-------------+----------+--------+--------+ | 17 | K~D~ ID | K~D~ ID | O | TV | 5 | | | | | | | | | | | 12.5.1.30 | | | | +-----+-------------+-------------+----------+--------+--------+ | 25 | Relay | Relay | O | TV | 4 | | | Service | Service | | | | | | Code | Code | | | | | | | | | | | | | | 12.5.1.17 | | | | +-----+-------------+-------------+----------+--------+--------+ | 22 | Signature | Signature | O | TV | 130 | | | | | | | | | | | 12.5.1.33 | | | | +-----+-------------+-------------+----------+--------+--------+ | 3 | Link Local | IPv6 | O | TV | 17 | | | IPv6 | Address | | | | | | Address | | | | | | | | 12.5.1.5 | | | | +-----+-------------+-------------+----------+--------+--------+
### 11.4.3 DIRECT_COMMUNICATION_ACCEPT
#### 11.4.3.1 Message definition
This message is sent by the UE to another peer UE to indicate that the
corresponding direct link setup request has been accepted. See table
11.4.3.1.1.
.Message type: DIRECT_COMMUNICATION_ACCEPT
Table 11.4.3.1.1: DIRECT_COMMUNICATION_ACCEPT message content
+-----+-------------+-------------+----------+--------+--------+ | IEI | Information | Typ | Presence | Format | Length | | | Element | e/Reference | | | | +-----+-------------+-------------+----------+--------+--------+ | | DIRECT\ | PC5-SP | M | V | 1 | | | _COMMUNICAT | Message | | | | | | ION_ACCEPT | Type | | | | | | message | | | | | | | identity | 12.5.1.1. | | | | +-----+-------------+-------------+----------+--------+--------+ | | Sequence | Sequence | M | V | 2 | | | Number | Number | | | | | | | | | | | | | | 12.5.1.2 | | | | +-----+-------------+-------------+----------+--------+--------+ | | IP Address | IP Address | M | V | 1 | | | Config | Config | | | | | | | | | | | | | | 12.5.1.4 | | | | +-----+-------------+-------------+----------+--------+--------+ | 3 | Link Local | Link Local | O | TV | 17 | | | IPv6 | IPv6 | | | | | | Address | Address | | | | | | | | | | | | | | 12.5.1.5 | | | | +-----+-------------+-------------+----------+--------+--------+
#### 11.4.3.2 Link Local IPv6 Address
The UE shall include this IE if the IP Address Config IE is set to \"address
allocation not supported\".
### 11.4.4 DIRECT_COMMUNICATION_REJECT
#### 11.4.4.1 Message definition
This message is sent by the UE to another peer UE to indicate that the
corresponding direct link setup request has been rejected. See table
11.4.4.1.1.
.Message type: DIRECT_COMMUNICATION_REJECT
Table 11.4.4.1.1: DIRECT_COMMUNICATION_REJECT message content
+-----+-------------+-------------+----------+--------+--------+ | IEI | Information | Typ | Presence | Format | Length | | | Element | e/Reference | | | | +-----+-------------+-------------+----------+--------+--------+ | | DIRECT\ | PC5-SP | M | V | 1 | | | _COMMUNICAT | Message | | | | | | ION_REJECT | Type | | | | | | message | | | | | | | identity | 12.5.1.1. | | | | +-----+-------------+-------------+----------+--------+--------+ | | Sequence | Sequence | M | V | 2 | | | Number | Number | | | | | | | | | | | | | | 12.5.1.2 | | | | +-----+-------------+-------------+----------+--------+--------+ | | PC5 | PC5 | M | V | 1 | | | Signalling | Signalling | | | | | | Cause Value | Cause Value | | | | | | | | | | | | | | 12.5.1.7 | | | | +-----+-------------+-------------+----------+--------+--------+
### 11.4.5 DIRECT_COMMUNICATION_KEEPALIVE
#### 11.4.5.1 Message definition
This message is sent by the UE to another peer UE to initiate a direct link
keepalive procedure. See table 11.4.5.1.1.
.Message type: DIRECT_COMMUNICATION_KEEPALIVE
Table 11.4.5.1.1: DIRECT_COMMUNICATION_KEEPALIVE message content
+-----+-------------+-------------+----------+--------+--------+ | IEI | Information | Typ | Presence | Format | Length | | | Element | e/Reference | | | | +-----+-------------+-------------+----------+--------+--------+ | | DIRECT_CO | PC5-SP | M | V | 1 | | | MMUNICATION | Message | | | | | | _KEEPALIVE | Type | | | | | | message | | | | | | | identity | 12.5.1.1 | | | | +-----+-------------+-------------+----------+--------+--------+ | | Sequence | Sequence | M | V | 2 | | | Number | Number | | | | | | | | | | | | | | 12.5.1.2 | | | | +-----+-------------+-------------+----------+--------+--------+ | | Keepalive | Keepalive | M | V | 4 | | | Counter | Counter | | | | | | | | | | | | | | 12.5.1.6 | | | | +-----+-------------+-------------+----------+--------+--------+ | 7 | Maximum | Maximum | O | TV | 5 | | | Inactivity | Inactivity | | | | | | Period | Period | | | | | | | | | | | | | | 12.5.1.9 | | | | +-----+-------------+-------------+----------+--------+--------+
### 11.4.6 DIRECT_COMMUNICATION_KEEPALIVE_ACK
#### 11.4.6.1 Message definition
This message is sent by the UE to another peer UE to acknowledge and respond
to the link keepalive request. See table 11.4.6.1.1.
Message type: DIRECT_COMMUNICATION_KEEPALIVE_ACK
Table 11.4.6.1.1: DIRECT_COMMUNICATION_KEEPALIVE_ACK message content
+-----+-------------+-------------+----------+--------+--------+ | IEI | Information | Typ | Presence | Format | Length | | | Element | e/Reference | | | | +-----+-------------+-------------+----------+--------+--------+ | | DIRE | PC5-SP | M | V | 1 | | | CT_COMMUNI | Message | | | | | | CATION_KEE | Type | | | | | | PALIVE_ACK | | | | | | | message | 12.5.1.1 | | | | | | identity | | | | | +-----+-------------+-------------+----------+--------+--------+ | | Sequence | Sequence | M | V | 2 | | | Number | Number | | | | | | | | | | | | | | 12.5.1.2 | | | | +-----+-------------+-------------+----------+--------+--------+ | | Keepalive | Keepalive | M | V | 4 | | | Counter | Counter | | | | | | | | | | | | | | 12.5.1.6 | | | | +-----+-------------+-------------+----------+--------+--------+
### 11.4.7 DIRECT_COMMUNICATION_RELEASE
#### 11.4.7.1 Message definition
This message is sent by the UE to another peer UE to initiate the direct link
release procedure. See table 11.4.7.1.1.
.Message type: DIRECT_COMMUNICATION_RELEASE
Table 11.4.7.1.1: DIRECT_COMMUNICATION_RELEASE message content
+-----+-------------+-------------+----------+--------+--------+ | IEI | Information | Typ | Presence | Format | Length | | | Element | e/Reference | | | | +-----+-------------+-------------+----------+--------+--------+ | | DIRECT_ | PC5-SP | M | V | 1 | | | COMMUNICATI | Message | | | | | | ON_RELEASE | Type | | | | | | message | | | | | | | identity | 12.5.1.1 | | | | +-----+-------------+-------------+----------+--------+--------+ | | Sequence | Sequence | M | V | 2 | | | Number | Number | | | | | | | | | | | | | | 12.5.1.2 | | | | +-----+-------------+-------------+----------+--------+--------+ | | Release | Release | M | V | 1 | | | Reason | Reason | | | | | | | | | | | | | | 12.5.1.8 | | | | +-----+-------------+-------------+----------+--------+--------+
### 11.4.8 DIRECT_COMMUNICATION_RELEASE_ACCEPT
#### 11.4.8.1 Message definition
This message is sent by the UE to another peer UE to indicate that the link
release request is accepted. See table 11.4.8.1.1.
.Message type: DIRECT_COMMUNICATION_RELEASE_ACCEPT
Table 11.4.8.1.1: DIRECT_COMMUNICATION_RELEASE_ACCEPT message content
+-----+-------------+-------------+----------+--------+--------+ | IEI | Information | Typ | Presence | Format | Length | | | Element | e/Reference | | | | +-----+-------------+-------------+----------+--------+--------+ | | DIREC | PC5-SP | M | V | 1 | | | T_COMMUNIC | Message | | | | | | ATION_RELE | Type | | | | | | ASE_ACCEPT | | | | | | | message | 12.5.1.1 | | | | | | identity | | | | | +-----+-------------+-------------+----------+--------+--------+ | | Sequence | Sequence | M | V | 2 | | | Number | Number | | | | | | | | | | | | | | 12.5.1.2 | | | | +-----+-------------+-------------+----------+--------+--------+
### 11.4.9 TMGI_MONITORING_REQUEST
#### 11.4.9.1 Message definition
This message is sent by the remote UE to ProSe UE-to-network relay UE for TMGI
monitoring request. See table 11.4.9.1.
Table 11.4.9.1.1: TMGI_MONITORING_REQUEST content
+-----+-------------+-------------+----------+--------+--------+ | IEI | Information | Typ | Presence | Format | Length | | | Element | e/Reference | | | | +-----+-------------+-------------+----------+--------+--------+ | | TMG | Message | M | V | 1 | | | I_MONITORI | Type | | | | | | NG_REQUEST | | | | | | | identity | 12.5.1.1 | | | | +-----+-------------+-------------+----------+--------+--------+ | | Sequence | Sequence | M | V | 2 | | | Number | Number | | | | | | | | | | | | | | 12.5.1.2 | | | | +-----+-------------+-------------+----------+--------+--------+ | | TMGI | Binary | M | V | 6 | | | | | | | | | | | 12.5.1.10 | | | | +-----+-------------+-------------+----------+--------+--------+ | | MBMS SAI | Binary | M | LV-E | 6-516 | | | list | | | | | | | | 12.5.1.11 | | | | +-----+-------------+-------------+----------+--------+--------+ | | Requested | Binary | M | V | 1 | | | ProSe | | | | | | | Per-Packet | 12.5.1.16 | | | | | | Priority | | | | | +-----+-------------+-------------+----------+--------+--------+
### 11.4.10 TMGI_MONITORING_RESPONSE
#### 11.4.10.1 Message definition
This message is sent by the ProSe UE-to-network relay UE to the remote UE for
TMGI monitoring response. See table 11.4.10.1.
Table 11.4.10.1.1: TMGI_MONITORING_RESPONSE content
+-----+-------------+-------------+----------+--------+--------+ | IEI | Information | Typ | Presence | Format | Length | | | Element | e/Reference | | | | +-----+-------------+-------------+----------+--------+--------+ | | TMGI | Message | M | V | 1 | | | _MONITORIN | Type | | | | | | G_RESPONSE | | | | | | | identity | 12.5.1.1 | | | | +-----+-------------+-------------+----------+--------+--------+ | | Sequence | Sequence | M | V | 2 | | | Number | Number | | | | | | | | | | | | | | 12.5.1.2 | | | | +-----+-------------+-------------+----------+--------+--------+ | | ProSe | Binary | M | V | 3 | | | Layer2 | | | | | | | Group ID | 12.5.1.12 | | | | +-----+-------------+-------------+----------+--------+--------+ | | TMGI | Binary | M | V | 2 | | | monitoring | | | | | | | refresh | 12.5.1.13 | | | | | | timer T4104 | | | | | +-----+-------------+-------------+----------+--------+--------+ | | SAI | Boolean | M | V | 1 | | | indicator | | | | | | | | 12.5.1.14 | | | | +-----+-------------+-------------+----------+--------+--------+
### 11.4.11 CELL_ID_ANNOUNCEMENT_REQUEST
#### 11.4.11.1 Message definition
This message is sent by the remote UE to ProSe UE-to-network relay UE to
initiate the cell ID announcement request procedure. See table 11.4.11.1.
Table 11.4.11.1.1: CELL_ID_ANNOUNCEMENT_REQUEST content
+-----+-------------+-------------+----------+--------+--------+ | IEI | Information | Typ | Presence | Format | Length | | | Element | e/Reference | | | | +-----+-------------+-------------+----------+--------+--------+ | | CELL_ID\ | Message | M | V | 1 | | | _ANNOUNCEME | Type | | | | | | NT_REQUEST | | | | | | | identity | 12.5.1.1 | | | | +-----+-------------+-------------+----------+--------+--------+ | | Sequence | Sequence | M | V | 2 | | | Number | Number | | | | | | | | | | | | | | 12.5.1.2 | | | | +-----+-------------+-------------+----------+--------+--------+
### 11.4.12 CELL_ID_ANNOUNCEMENT_RESPONSE
#### 11.4.12.1 Message definition
This message is sent by the ProSe UE-to-network relay UE to the remote UE to
acknowledge and respond to the cell ID announcement request. See table
11.4.12.1.
Table 11.4.12.1.1: CELL_ID_ANNOUNCEMENT_RESPONSE content
+-----+-------------+-------------+----------+--------+--------+ | IEI | Information | Typ | Presence | Format | Length | | | Element | e/Reference | | | | +-----+-------------+-------------+----------+--------+--------+ | | CELL_ID_ | Message | M | V | 1 | | | ANNOUNCEMEN | Type | | | | | | T_RESPONSE | | | | | | | identity | 12.5.1.1 | | | | +-----+-------------+-------------+----------+--------+--------+ | | Sequence | Sequence | M | V | 2 | | | Number | Number | | | | | | | | | | | | | | 12.5.1.2 | | | | +-----+-------------+-------------+----------+--------+--------+ | | ECGI | Binary | M | V | 2 | | | a | | | | | | | nnouncement | 12.5.1.15 | | | | | | request | | | | | | | refresh | | | | | | | timer T4106 | | | | | +-----+-------------+-------------+----------+--------+--------+
### 11.4.12A DIRECT_SECURITY_MODE_COMMAND
#### 11.4.12A.1 Message definition
This message is sent by a commanding UE to a peer UE to establish the security
for a direct link. See table 11.4.12A.1.1.
Message type: DIRECT_SECURITY_MODE_COMMAND
Table 11.4.12A.1.1: DIRECT_SECURITY_MODE_COMMAND message content
+-----+-----------+-----------+----------+--------+----------+ | IEI | In | Type/ | Presence | Format | Length | | | formation | Reference | | | | | | Element | | | | | +-----+-----------+-----------+----------+--------+----------+ | | DIRECT\ | PC5-SP | M | V | 1 | | | _SECURITY | Message | | | | | | MODE | Type | | | | | | COMMAND | | | | | | | message | 12.5.1.1. | | | | | | identity | | | | | +-----+-----------+-----------+----------+--------+----------+ | | Sequence | Sequence | M | V | 2 | | | Number | Number | | | | | | | | | | | | | | 12.5.1.2 | | | | +-----+-----------+-----------+----------+--------+----------+ | | UE | UE | M | V | 2 | | | Security | Security | | | | | | Cap | Cap | | | | | | abilities | abilities | | | | | | | | | | | | | | 12.5.1.22 | | | | +-----+-----------+-----------+----------+--------+----------+ | | Nonce 2 | Nonce 2 | M | V | 16 | | | | | | | | | | | 12.5.1.31 | | | | +-----+-----------+-----------+----------+--------+----------+ | | Chosen | Chosen | M | V | 1 | | | A | A | | | | | | lgorithms | lgorithms | | | | | | | | | | | | | | 12.5.1.23 | | | | +-----+-----------+-----------+----------+--------+----------+ | | LSB of | LSB of | M | V | 1 | | | K~D-sess~ | K~D-sess~ | | | | | | ID | | | | | | | | 12.5.1.24 | | | | +-----+-----------+-----------+----------+--------+----------+ | 16 | MSB of | MSB of | O | TV | 3 | | | K~D~ ID | K~D~ ID | | | | | | | | | | | | | | 12.5.1.27 | | | | +-----+-----------+-----------+----------+--------+----------+ | 18 | K~D~ | K~D~ | O | TV | 17 | | | Freshness | Freshness | | | | | | | | | | | | | | 12.5.1.30 | | | | +-----+-----------+-----------+----------+--------+----------+ | 24 | GPI | GPI | O | TLV | Variable | | | | | | | | | | | 12.5.1.18 | | | | +-----+-----------+-----------+----------+--------+----------+ | 1 | User Info | User Info | O | TLV | 3-253 | | | | | | | | | | | 12.5.1.3 | | | | +-----+-----------+-----------+----------+--------+----------+ | 22 | Signature | Signature | O | TV | 130 | | | | | | | | | | | 12.5.1.33 | | | | +-----+-----------+-----------+----------+--------+----------+ | 23 | Encrypted | Encrypted | O | TLV | Variable | | | Payload | Payload | | | | | | | | | | | | | | 12.5.1.34 | | | | +-----+-----------+-----------+----------+--------+----------+
### 11.4.13 DIRECT_SECURITY_MODE_COMPLETE
#### 11.4.13.1 Message definition
This message is sent by a peer UE to a commanding UE to confirm the
establishment of the security for a direct link. See table 11.4.13.1.
Message type: DIRECT_SECURITY_MODE_COMPLETE
Table 11.4.13.1: DIRECT_SECURITY_MODE_COMPLETE message content
+-----+-------------+-------------+----------+--------+--------+ | IEI | Information | Typ | Presence | Format | Length | | | Element | e/Reference | | | | +-----+-------------+-------------+----------+--------+--------+ | | DIREC | PC5-SP | M | V | 1 | | | T_SECURITY | Message | | | | | | MODE | Type | | | | | | COMPLETE | | | | | | | message | 12.5.1.1. | | | | | | identity | | | | | +-----+-------------+-------------+----------+--------+--------+ | | Sequence | Sequence | M | V | 2 | | | Number | Number | | | | | | | | | | | | | | 12.5.1.2 | | | | +-----+-------------+-------------+----------+--------+--------+ | 15 | LSB of K~D~ | LSB of K~D~ | O | TV | 3 | | | ID | ID | | | | | | | | | | | | | | 12.5.1.26 | | | | +-----+-------------+-------------+----------+--------+--------+
### 11.4.14 DIRECT_SECURITY_MODE_REJECT
#### 11.4.14.1 Message definition
This message is sent by a peer UE to a commanding UE to indicate a failure to
establish the security. See table 11.4.14.1.
Message type: DIRECT_SECURITY_MODE_REJECT
Table 11.4.2.14.1: DIRECT_SECURITY_MODE_REJECT message content
+-----+-------------+-------------+----------+--------+--------+ | IEI | Information | Typ | Presence | Format | Length | | | Element | e/Reference | | | | +-----+-------------+-------------+----------+--------+--------+ | | DIREC | PC5-SP | M | V | 1 | | | T_SECURITY | Message | | | | | | MODE REJECT | Type | | | | | | message | | | | | | | identity | 12.5.1.1. | | | | +-----+-------------+-------------+----------+--------+--------+ | | Sequence | Sequence | M | V | 2 | | | Number | Number | | | | | | | | | | | | | | 12.5.1.2 | | | | +-----+-------------+-------------+----------+--------+--------+ | | PC5 | PC5 | M | V | 1 | | | Signalling | Signalling | | | | | | Protocol | Protocol | | | | | | Cause Value | Cause Value | | | | | | | | | | | | | | 12.5.1.7 | | | | +-----+-------------+-------------+----------+--------+--------+ | 10 | RAND | RAND | O | TV | 17 | | | | | | | | | | | 12.5.1.21 | | | | +-----+-------------+-------------+----------+--------+--------+ | 9 | AUTS | AUTS | O | TV | 15 | | | | | | | | | | | 12.5.1.20 | | | | +-----+-------------+-------------+----------+--------+--------+
### 11.4.15 DIRECT_REKEYING_REQUEST
#### 11.4.15.1 Message definition
This message is sent by a UE to the peer UE to refresh the security of an
established direct link. See table 11.4.15.1.
Message type: DIRECT_REKEYING_REQUEST
Table 11.4.15.1: DIRECT_REKEYING_REQUEST message content
+-----+-------------+-------------+----------+--------+--------+ | IEI | Information | Typ | Presence | Format | Length | | | Element | e/Reference | | | | +-----+-------------+-------------+----------+--------+--------+ | | DIR | PC5-SP | M | V | 1 | | | ECT_REKEYI | Message | | | | | | NG_REQUEST | Type | | | | | | message | | | | | | | identity | 12.5.1.1 | | | | +-----+-------------+-------------+----------+--------+--------+ | | Sequence | Sequence | M | V | 2 | | | Number | Number | | | | | | | | | | | | | | 12.5.1.2 | | | | +-----+-------------+-------------+----------+--------+--------+ | | UE Security | UE Security | M | V | 2 | | | C | C | | | | | | apabilities | apabilities | | | | | | | | | | | | | | 12.5.1.22 | | | | +-----+-------------+-------------+----------+--------+--------+ | | Nonce_1 | Nonce_1 | M | V | 16 | | | | | | | | | | | 12.5.1.30 | | | | +-----+-------------+-------------+----------+--------+--------+ | | MSB of | MSB of | M | V | 1 | | | K~D-sess~ | K~D-sess~ | | | | | | ID | | | | | | | | 12.5.1.25 | | | | +-----+-------------+-------------+----------+--------+--------+ | 21 | Auth Flag | Auth Flag | O | TV | 2 | | | | | | | | | | | 12.5.1.32 | | | | +-----+-------------+-------------+----------+--------+--------+ | 8 | PRUK ID | PRUK ID | O | TV | 9 | | | | | | | | | | | 12.5.1.19 | | | | +-----+-------------+-------------+----------+--------+--------+
### 11.4.16 DIRECT_REKEYING_RESPONSE
#### 11.4.16.1 Message definition
This message is sent by a UE to the peer UE to complete refreshing the
security of an established direct link. See table 11.4.16.1.1.
Message type: DIRECT_REKEYING_RESPONSE
Table 11.4.16.1: DIRECT_REKEYING_RESPONSE message content
+-----+-------------+-------------+----------+--------+--------+ | IEI | Information | Typ | Presence | Format | Length | | | Element | e/Reference | | | | +-----+-------------+-------------+----------+--------+--------+ | | DIRE | PC5-SP | M | V | 1 | | | CT_REKEYIN | Message | | | | | | G_RESPONSE | Type | | | | | | message | | | | | | | identity | 12.5.1.1. | | | | +-----+-------------+-------------+----------+--------+--------+ | | Sequence | Sequence | M | V | 2 | | | Number | Number | | | | | | | | | | | | | | 12.5.1.2 | | | | +-----+-------------+-------------+----------+--------+--------+
### 11.4.17 DIRECT_REKEYING_TRIGGER
#### 11.4.17.1 Message definition
This message is sent by a UE to the peer UE to trigger the peer UE to initiate
a direct link rekeying procedure to refresh K~D~. See table 11.4.17.1.1.
Message type: DIRECT_REKEYING_TRIGGER
Table 11.4.17.1: DIRECT_REKEYING_TRIGGER message content
+-----+-------------+-------------+----------+--------+--------+ | IEI | Information | Typ | Presence | Format | Length | | | Element | e/Reference | | | | +-----+-------------+-------------+----------+--------+--------+ | | DIR | PC5-SP | M | V | 1 | | | ECT_REKEYI | Message | | | | | | NG_TRIGGER | Type | | | | | | message | | | | | | | identity | 12.5.1.1 | | | | +-----+-------------+-------------+----------+--------+--------+ | | Sequence | Sequence | M | V | 2 | | | Number | Number | | | | | | | | | | | | | | 12.5.1.2 | | | | +-----+-------------+-------------+----------+--------+--------+
### 11.4.18 REMOTE_UE_INFO_REQUEST
#### 11.4.18.1 Message definition
This message is sent by the ProSe UE-to-network relay UE to the remote UE to
initiate the remote UE information request procedure. See table 11.4.18.1.1.
Table 11.4.18.1.1: REMOTE_UE_INFO_REQUEST content
+-----+-------------+-------------+----------+--------+--------+ | IEI | Information | Typ | Presence | Format | Length | | | Element | e/Reference | | | | +-----+-------------+-------------+----------+--------+--------+ | | REM | Message | M | V | 1 | | | OTE_UE_IN | Type | | | | | | FO_REQUEST | | | | | | | message | 12.5.1.1 | | | | | | identity | | | | | +-----+-------------+-------------+----------+--------+--------+ | | Sequence | Sequence | M | V | 2 | | | Number | Number | | | | | | | | | | | | | | 12.5.1.2 | | | | +-----+-------------+-------------+----------+--------+--------+ | | Remote UE | Remote UE | M | V | 1 | | | Information | Information | | | | | | Type | Type | | | | | | | | | | | | | | 12.5.1.35 | | | | +-----+-------------+-------------+----------+--------+--------+
### 11.4.19 REMOTE_UE_INFO_RESPONSE
#### 11.4.19.1 Message definition
This message is sent by the remote UE to the ProSe UE-to-network relay UE to
respond to the remote UE information request. See table 11.4.19.1.1.
Table 11.4.19.1.1: REMOTE_UE_INFO_RESPONSE content
+-----+-------------+-------------+----------+--------+--------+ | IEI | Information | Typ | Presence | Format | Length | | | Element | e/Reference | | | | +-----+-------------+-------------+----------+--------+--------+ | | REMO | Message | M | V | 1 | | | TE_UE_INF | Type | | | | | | O_RESPONSE | | | | | | | message | 12.5.1.1 | | | | | | identity | | | | | +-----+-------------+-------------+----------+--------+--------+ | | Sequence | Sequence | M | V | 2 | | | Number | Number | | | | | | | | | | | | | | 12.5.1.2 | | | | +-----+-------------+-------------+----------+--------+--------+ | 27 | IMEI | IMEI | O | TV | 10 | | | | | | | | | | | 12.5.1.36 | | | | +-----+-------------+-------------+----------+--------+--------+
### 11.5 Non-IP data PDU format
The non-IP data PDU is coded according to figure 11.5.1 and table 11.5.1.
+------------------+-----+---+-----+-----+-----+-----+-----+----------+ | > Bits | | | | | | | | | +------------------+-----+---+-----+-----+-----+-----+-----+----------+ | 8 | 7 | 6 | > 5 | > 4 | > 3 | > 2 | > 1 | > Octets | +------------------+-----+---+-----+-----+-----+-----+-----+----------+ | > Non-IP type | > 1 | | | | | | | | +------------------+-----+---+-----+-----+-----+-----+-----+----------+ | > Non-IP payload | > 2 | | | | | | | | +------------------+-----+---+-----+-----+-----+-----+-----+----------+ | | | | | | | | | | +------------------+-----+---+-----+-----+-----+-----+-----+----------+ | | | | | | | | | | +------------------+-----+---+-----+-----+-----+-----+-----+----------+ | | > n | | | | | | | | +------------------+-----+---+-----+-----+-----+-----+-----+----------+
Figure 11.5.1: Non-IP data PDU format
Table 11.5.1: Non-IP data PDU values
* * *
Octet 1 contains the non-IP type field which indicates the type of non-IP data
included in the non-IP payload. Octets 2 to n contain the non-IP payload field
containing the non-IP data.
* * *
# 12 General message format and information elements coding
## 12.1 Overview
This clause contains general message format and information elements coding
for the messages used in the procedures described in the present document.
## 12.1A General
The sending entity shall set the value of a spare bit to zero. The receiving
entity shall ignore the value of a spare bit.
The sending entity shall not set the value of a field to a reserved value. The
receiving entity shall discard a message carrying a field with the value set
to a reserved value.
## 12.2 ProSe direct discovery message formats
### 12.2.1 Data types format in XML schema
To exchange structured information over the transport protocol, XML text
format/notation is introduced.
The corresponding XML data types for the data types used in ProSe messages are
provided in table 12.2.1.1.
Table 12.2.1.1: Primitive or derived types for ProSe Parameter Type
* * *
ProSe Parameter Type Type in XML Schema Integer xs:integer String xs:string
Boolean xs:boolean Binary xs:hexBinary Bit string xs:hexBinary Time
xs:dateTime
* * *
For complex data types described in subclause 12.2.2, an XML \"complexType\"
can be used.
Message construction shall be compliant with W3C REC-xmlschema-2-20041028:
\"XML Schema Part 2: Datatypes\" [7]
### 12.2.2 Parameters in ProSe direct discovery messages
#### 12.2.2.1 Transaction ID
This parameter is used to uniquely identify a PC3 Control Protocol for ProSe
direct discovery transaction when it is combined with other PC3 Control
Protocol for ProSe direct discovery transactions in the same transport
message. The UE shall set this parameter to a new number for each outgoing new
discovery request. The transaction ID is an integer in the 0-255 range.
#### 12.2.2.2 Command
This parameter is used to indicate the type of discovery request (announce,
monitor, query, or response) contained in a DISCOVERY_REQUEST message. It is
an integer in the 0-255 range encoded as follows:
0 Reserved
1 announce
2 monitor
3 query
4 response
5 metadata_update
6-255 Unused
#### 12.2.2.3 UE Identity
This parameter is used to indicate the requesting UE\'s identity and is set to
the IMSI. The coding of IMSI is defined in 3GPP TS 23.003 [4].
#### 12.2.2.4 Prose Application ID
This parameter is used to carry an identity used for open ProSe direct
discovery, identifying application related information for the ProSe-enabled
UE. It is coded as specified in 3GPP TS 23.003 [4].
#### 12.2.2.5 Application Identity
This parameter is used to identify the particular application that triggers
the DISCOVERY_REQUEST message. The format of the Application Identity consists
of two parts:
\- OS ID: operating system identifier. The format of the OS ID is a
Universally Unique IDentifier (UUID) as specified in IETF RFC 4122 [8]; and
\- OS App ID: a string containing the OS specific application identifier.
NOTE: Further definition of the format of OS App ID is beyond the scope of
this specification.
#### 12.2.2.6 ProSe Application Code
This parameter is used to contain a ProSe Application Code. The format of the
ProSe Application Code is as follows:
a) if the ProSe Application Code is included in a PC5_DISCOVERY message or in
a MATCH_REPORT message and application-controlled extension is used, the ProSe
Application Code is encoded as a 184 bitstring composed of:
\- the ProSe Application Code Prefix; and
\- the ProSe Application Code Suffix; or
b) in all other cases, the ProSe Application is encoded as a 184 bitstring as
defined in 3GPP TS 23.003 [4].
#### 12.2.2.7 Validity Timer T4000
This parameter is used to carry the value of validity timer T4000 associated
with a ProSe Application Code. It is an integer in the 1-525600 range
representing the timer value in unit of minutes.
#### 12.2.2.8 PC3 Control Protocol cause value
This parameter is used to indicate the particular reason why a
DISCOVERY_REQUEST or MATCH_REPORT message from the UE has been rejected by the
ProSe Function. It is an integer in the 0-255 range encoded as follows:
0 Reserved
1 Invalid Application
2 Unknown ProSe Application ID
3 UE authorisation failure
4 Unknown ProSe Application Code
5 Invalid MIC
6 Invalid UTC-based counter
7 Invalid Message Format
8 Scope violation in ProSe Application ID
9 Unknown RPAUID
10 Unknown or Invalid Discovery Entry ID
11 Invalid Discovery Target
12 UE unauthorised for discovery with Application-Controlled Extension
13 UE unauthorised for on-demand announcing
14 Missing Application Level Container
15 Invalid Data in Application Level Container
16 Invalid Match Event
17 No Valid ProSe Application Code
18 Invalid UE Identity
19-255 Unused
#### 12.2.2.9 DiscoveryKey
This parameter is used to carry a Discovery Key allocated by the ProSe
Function. This key is used by the UE to compute the MIC that is included in
the PC5_DISCOVERY message. The format of Discovery Key is defined in 3GPP TS
33.303 [6].
#### 12.2.2.10 Message Type
This parameter is used to indicate the type of ProSe direct discovery.
This parameter is coded as shown in figure 12.2.2.10.1 and table 12.2.2.10.1.
* * *
8 7 6 5 4 3 2 1  
Discovery type Content Type Discovery model octet 1
* * *
Figure 12.2.2.10.1: Message Type parameter
Table 12.2.2.10.1: Message Type parameter
* * *
Discovery type value (octet 1)  
Bit  
8 7  
0 0 Reserved 0 1 Open discovery 1 0 Restricted discovery 1 1 Reserved
Content type value (octet 1)  
Bit  
**6** **5** **4** **3**  
0 0 0 0 announce/response 0 0 0 1 query 0 0 1 0 application-controlled
extension enabled 0 0 1 1 Reserved 0 1 0 0 UE-to-Network Relay Discovery
Announcement or UE-to-Network Relay Discovery Response 0 1 0 1 UE-to-Network
Relay Discovery Solicitation 0 1 1 0 Group Member Discovery Announcement or
Group Member Discovery Response 0 1 1 1 Group Member Discovery Solicitation 1
0 0 0 Relay discovery additional information 1 0 0 1 Reserved 1 0 1 0 Reserved
1 0 1 1 Reserved 1 1 0 0 Reserved 1 1 0 1 Reserved 1 1 1 0 Reserved 1 1 1 1
Reserved
Discovery model value (octet 1)  
Bit  
2 1  
0 0 Reserved 0 1 Model A 1 0 Model B 1 1 Reserved
* * *
NOTE 1: Content Type \'0000\' (announce/response) is used for model A
announcing and for model B discoveree operation.
NOTE 2: Content Type \'0100\' (UE-to-Network Relay Discovery Announcement or
UE-to-Network Relay Discovery Response) is used for model A announcing and for
model B discoveree operation.
NOTE 3: Content Type \'0110\' (Group Member Discovery Announcement or Group
Member Discovery Response) is used for model A announcing and for model B
discoveree operation.
#### 12.2.2.11 MIC
This parameter is used to carry the MIC (Message Integrity Check) associated
with the ProSe Application Code contained in a PC5_DISCOVERY message.
#### 12.2.2.12 Discovery Filter
The elements in the Discovery Filter parameter are listed below.
\- ProSe Application Code: The ProSe Application Code is used by a monitoring
UE for full or partial matching of PC5_DISCOVERY messages received on the PC5
interface (see subclause 12.2.2.6). Only one code is allowed in a Discovery
Filter;
\- ProSe Application Mask: a bitmask provided by the ProSe Function in order
to allow the monitoring UE to perform a full matching or partial matching of
PC5_DISCOVERY messages received on the PC5 interface. A ProSe Application Mask
with all bits set to \"1\" is used for full matching. One or more ProSe
Application Masks may be included in a Discovery Filter. The length of the
ProSe Application Mask is as same as the length of ProSe Application Code; and
\- TTLTimer T4002: Time-to-live duration for which the associated Discovery
Filter is valid, after which it shall not be used. It is an integer in the
1-525600 range representing the timer value in unit of minutes.
#### 12.2.2.13 Void
#### 12.2.2.14 Void
#### 12.2.2.15 Void
#### 12.2.2.16 Monitored PLMN ID
This parameter is used to indicate the PLMN ID of the PLMN in which the
PC5_DISCOVERY message containing a ProSe Application Code for which there was
a match event was received. It is coded as specified in 3GPP TS 23.003 [4].
#### 12.2.2.17 VPLMN ID
This parameter is used to indicate the PLMN ID of the PLMN in which the
requesting UE is registered. It is coded as specified in 3GPP TS 23.003 [4].
#### 12.2.2.18 UTC-based counter
This parameter is used to indicate the UTC time associated with the discovery
transmission opportunity in which a PC5_DISCOVERY message is sent. It is
expressed in unit of seconds and coded in binary format as the 32 least
significant bits of the Coordinated Universal Time as defined in 3GPP TS
36.331 [12].
#### 12.2.2.19 Validity Timer T4004
This parameter is used to carry the value of Validity Timer T4004 associated
with a ProSe Application Code for which there was a match event. It is an
integer in the 1-525600 range representing the timer value in unit of minutes.
#### 12.2.2.20 Metadata Flag
This parameter is used to indicate whether the UE wishes to receive the latest
metadata information associated with the ProSe Application ID or RPAUID in the
MATCH_REPORT_ACK from the ProSe Function. It is a Boolean value coded as
follows:
> False the UE does not wish to receive the latest metadata information
> associated with the ProSe Application ID or RPAUID in the MATCH_REPORT_ACK
> from the ProSe Function
>
> True the UE wishes to receive the latest metadata information associated
> with the ProSe Application ID or RPAUID in the MATCH_REPORT_ACK message from
> the ProSe Function
#### 12.2.2.21 Metadata
This parameter is used to carry the metadata that is associated with the ProSe
Application ID contained in the MATCH_REPORT_ACK message. The purpose of the
metadata is to carry additional application-layer information associated with
a particular ProSe Application ID. Examples of such information are postal
address, phone number, URL etc. The length and contents of the metadata are
out of scope of 3GPP. The format of the metadata is a UTF8-encoded string.
#### 12.2.2.22 UTC-based Counter LSB
This parameter is used to carry:
\- the four least significant bits of the UTC-based counter associated with
the discovery transmission opportunity used by the UE performing open ProSe
direct discovery announcing; or
\- the eight least significant bits of the UTC-based counter associated with
the discovery transmission opportunity used by the UE performing ProSe direct
discovery announcing for restricted ProSe direct discovery or for ProSe direct
discovery for public safety use.
This parameter is coded as shown in figures 12.2.2.22.1 and 12.2.2.22.2, and
table 12.2.2.22.1.
* * *
8 7 6 5 4 3 2 1  
0 0 0 0 Four LSBs of UTC-based counter octet 1  
Spare
* * *
Figure 12.2.2.22.1: UTC-based Counter LSB parameter for open ProSe direct
discovery
* * *
8 7 6 5 4 3 2 1  
Eight LSBs of UTC-based counter octet 1
* * *
Figure 12.2.2.22. 2: UTC-based Counter LSB parameter for restricted ProSe
direct discovery and for ProSe direct discovery for public safety use
Table 12.2.2.22.1: UTC-based Counter LSB parameter
+----------------------------------------------------------------------+ | UTC-based Counter LSB value (octet 1) | +----------------------------------------------------------------------+ | | +----------------------------------------------------------------------+ | For open ProSe direct discovery: | | | | Bits 1 to 4 of octet 1 are set to the four least significant bits of | | the UTC-based counter encoded as specified in subclause 12.2.2.18. | | | | Bits 5 to 8 of octet 1 are spare and shall be coded as zero. | | | | For restricted ProSe direct discovery and for ProSe direct discovery | | for public safety use: | | | | Bits 1 to 8 of octet 1 are set to the eight least significant bits | | of the UTC-based counter encoded as specified in subclause 12.2.2.18 | +----------------------------------------------------------------------+ | | +----------------------------------------------------------------------+
#### 12.2.2.23 Current Time
This parameter is used to carry the current UTC-based time at the ProSe
Function. The format of this parameter follows the XML data type defined in
table 12.2.1.1 for ProSe parameter type \"Time\".
#### 12.2.2.24 Max Offset
This parameter is used to indicate the maximum time difference between the
time on the UE\'s ProSe clock and the UTC-based counter associated with the
discovery slot in seconds, as specified in 3GPP TS 33.303 [6]. The Max Offset
is an integer in the 1-32 range.
#### 12.2.2.25 Discovery Type
This parameter is used to indicate the type of ProSe direct discovery
contained in the DISCOVERY_REQUEST message or MATCH_REPORT message. It is an
integer in the 0-3 range encoded as follows:
0 Reserved
1 Open discovery
2 Restricted discovery
3 Unused
#### 12.2.2.26 Match Report Refresh Timer T4006
This parameter is used to carry the value of Match Report Refresh Timer T4006
associated with a ProSe Application Code for which there was a match event. It
is an integer in the 1-525600 range representing the timer value in unit of
minutes.
#### 12.2.2.27 Requested Timer
During the announce request procedure for open ProSe direct discovery or
restricted ProSe direct discovery model A, the Requested Timer element is used
to carry the length of validity timer associated with the ProSe Application
Code or the ProSe Restricted Code that the UE expects to receive from the
ProSe Function.When the procedure is to inform the ProSe Function that the UE
wants to stop announcing a ProSe Application Code or a ProSe Restricted Code
before the associated valid timer expires, the Requested Timer shall be set to
0.
During the monitor request procedure for open ProSe direct discovery or
restricted ProSe direct discovery model A, the Requested Timer element is only
used to inform the ProSe Function that the UE wants to stop monitoring using
Discovery Filter(s) or Restricted Discovery Filter(s). The Requested Timer
shall be set to 0.
It is an integer in the 0-525600 range representing the timer value in unit of
minutes.
#### 12.2.2.28 ProSe Function Transaction ID
This parameter is used to uniquely identify a PC3 Control Protocol for ProSe
direct discovery transaction when it is combined with other PC3 Control
Protocol for ProSe direct discovery transactions in the same transport
message. The ProSe Function shall set this parameter to a new number for each
outgoing new request. The ProSe Function transaction ID is an integer in the
0-255 range.
#### 12.2.2.29 Update Info
This parameter is used to carry either:
1) the updated information for an announcing UE in restricted discovery with a
new ProSe Restricted Code to replace the old one in the discovery entry and
the corresponding validity timer. In this case the parameter shall contain the
following:
\- ProSe Restricted Code: See subclause 12.2.2.34; and
\- Validity Timer T4007: See subclause 12.2.2.39.
2) the updated information for a monitoring UE in restricted discovery with a
new set of Restricted Discovery Filters to be used for a given discovery
entry. In this case the parameter shall contain one or more Restricted
Discovery Filters as defined in subclause 12.2.2.37;
3) the updated information for an announcing UE in open discovery with a new
ProSe Application Code to replace the old one in the discovery entry and the
corresponding validity timer. In this case the parameter shall contain:
\- ProSe Application Code: See subclause 12.2.2.6; and
\- Validity Timer T4000: See subclause 12.2.2.7.
4) the updated information for a monitoring UE in open discovery with a new
set of Discovery Filters to be used for a given discovery entry. In this case
the parameter shall contain one or more Discovery Filters defined in subclause
12.2.2.12.
#### 12.2.2.30 RPAUID
This parameter is used to carry the RPAUID (Restricted ProSe Application User
ID), which is an identity used for restricted ProSe direct discovery,
identifying application related information for the ProSe-enabled UE.
#### 12.2.2.31 Announcing Type
This parameter is used to indicate whether the UE requests on demand
announcing in a DISCOVERY_REQUEST message. It is an integer in the 0-255 range
encoded as follows:
0 normal
1 on demand
2-255 Unused
#### 12.2.2.32 Application Level Container
This parameter is used to carry the Application Level Container, which
contains application-level data transparent to the 3GPP network transferred
between the application client in the UE and the ProSe Application Server.
#### 12.2.2.33 Discovery Entry ID
This parameter is used to carry the Discovery Entry ID, which is an identity
allocated by the ProSe Function to refer to a discovery entry in the UE\'s
context as a result of a discovery request, either announcing or monitoring.
It is an integer in the 0-65535 range.
#### 12.2.2.34 ProSe Restricted Code
This parameter is used to contain a ProSe Restricted Code. The format of the
ProSe Restricted Code is as follows:
a) if the ProSe Restricted Code is included in a PC5_DISCOVERY message or in a
MATCH_REPORT message and application-controlled extension is not used, the
ProSe Restricted Code is encoded as a 184 bitstring composed of:
\- the ProSe Restricted Code in the 64 most significant bits; and
\- the remaining 120 bits set to zero;
b) if the ProSe Restricted Code is included in a PC5_DISCOVERY message or in a
MATCH_REPORT message and application-controlled extension is used, the ProSe
Restricted Code is encoded as a 184 bitstring composed of
\- the ProSe Restricted Code Prefix in the 64 most significant bits;
\- the ProSe Restricted Code Suffix; and
\- any remaining unused least significant bits set to zero; or
c) in all other cases, the ProSe Restricted Code is encoded as a 64 bitstring
as defined in 3GPP TS 23.003 [4].
#### 12.2.2.35 ProSe Restricted Code Suffix Range
This parameter is used to carry a range of consecutive ProSe Restricted Code
Suffixes, each of which can be appended by the UE to a ProSe Restricted Code
Prefix (see subclause 12.2.2.34) for restricted ProSe direct discovery with
application-controlled extension. A ProSe Restricted Code Suffix Range
includes a Beginning Suffix Code and optionally an Ending Suffix Code, as
described below:
\- Beginning Suffix Code: The bit-length of this bit string reflects the
length of the suffix portion of the ProSe Restricted Code allocated by the
ProSe Application Server for an RPAUID based on application configuration. The
binary value of this code is the lowest value of the ProSe Restricted Code
Suffix range.
\- Ending Suffix Code: The binary value of this code is the highest value of
the ProSe Restricted Code Suffix range. The length of the Ending Suffix Code
shall be the same as that of the Beginning Suffix Code.
If the ProSe Restricted Code Suffix Range contains only a single ProSe
Restricted Code Suffix, then that suffix is represented by the Beginning
Suffix Code, and the Ending Suffix Code is omitted.
#### 12.2.2.36 On Demand Announcing Enabled Indicator
This parameter is used to carry the on demand announcing enabled indicator,
which is a Boolean value indicating whether on demand announcing is enabled or
not in the ProSe Function.
#### 12.2.2.37 Restricted Discovery Filter
This parameter is used to carry the Discovery Filter(s) used to monitor an
individual target RPAUID in restricted ProSe direct discovery model A. It
contains one or more filter(s), TTL timer T4009, optionally an RPAUID
parameter identifying the target RPAUID, security parameters such as Discovery
User Scrambling Key, Discovery User Integrity Key and Discovery User
Confidentiality Key, optionally a metadata indicator, and optionally the
corresponding metadata. The elements in the Restricted Discovery Filter
parameter are defined as below.
\- Filter: a matching filter used for restricted ProSe direct discovery model
A monitoring. It contains one code and one or more masks. The code is used by
a monitoring UE for full or partial matching of PC5_DISCOVERY messages
received on the PC5 interface with a ProSe Restricted Code (see subclause
12.2.2.34). Only one code is allowed in a filter. The mask is a bitmask
provided by the ProSe Function in order to allow the monitoring UE to perform
a full matching or partial matching of PC5_DISCOVERY messages received on the
PC5 interface. A mask with all bits set to \"1\" is used for full matching.
One or more masks may be included in a filter. The length of the mask is the
same as the length of the code;
\- TTLTimer T4009: Time-to-live duration for which the associated Restricted
Discovery Filter is valid, after which it shall not be used. It is an integer
in the 1-525600 range representing the timer value in unit of minutes;
\- RPAUID: identifier of the target RPAUID to be monitored;
\- DUSK (Discovery User Scrambling Key): an optional key which is allocated by
the ProSe Function and is used by the monitoring UE or discoverer UE for
unscrambling the PC5_DISCOVERY message containing the ProSe Restricted Code in
restricted ProSe direct discovery. The format of the DUSK is defined in 3GPP
TS 33.303 [6];
\- DUIK (Discovery User Integrity Key) or a MIC Check Indicator :DUIK is an
optional key which is allocated by the ProSe Function and is used by the UE to
compute the MIC that is included in the PC5_DISCOVERY message containing the
ProSe Restricted Code in restricted ProSe direct discovery. The format of the
DUIK is defined in 3GPP TS 33.303 [6]. When the DUIK is absent, an optional
MIC Check Indicator parameter may be included to inform a UE receiving
PC5_DISCOVERY messages that the MIC field needs to be checked by sending a
MATCH_REPORT message to the ProSe Function;
\- DUCK material: an optional parameter containing a DUCK (Discovery User
Confidentiality Key) and an Encrypted Bitmask. The DUCK is allocated by the
ProSe Function and is used by the UE to decrypt a portion of the PC5_DISCOVERY
message in restricted ProSe direct discovery. The format of the DUCK is
defined in 3GPP TS 33.303 [6]. The Encrypted Bitmask is a 184-bit bitmask
which uses bit \"1\" to mark the positions of the bits for which the DUCK
encryption is applied;
\- Metadata indicator: It contains the information element defined in
subclause 12.2.2.65; and
\- Metadata: application-layer metadata associated with the monitoring target.
#### 12.2.2.38 ACE Enabled Indicator
This parameter is used to indicate whether application-controlled extension
for open ProSe direct discovery or restricted ProSe direct discovery is
enabled. It is an integer value in the 0-255 range encoded as follows:
  1. Reserved
  2. Normal
2 Application-controlled extension enabled
3-255 Unused
#### 12.2.2.39 Validity Timer T4007
This parameter is used to carry the value of validity timer T4007 associated
with a ProSe Restricted Code or ProSe Restricted Code Prefix. It is an integer
in the 1-525600 range representing the timer value in unit of minutes.
#### 12.2.2.40 Restricted Code Security Material
This parameter is used as a container for the information necessary for
security keys and algorithms protecting the sending or receiving of restricted
ProSe direct discovery messages over the PC5 interface. The elements in the
Restricted Code Security Material parameter are listed below:
DUSK (Discovery User Scrambling Key): an optional key which is allocated by
the ProSe Function and is used by the UE for scrambling or unscrambling the
PC5_DISCOVERY message containing the ProSe Restricted Code in restricted ProSe
direct discovery. The format of the DUSK is defined in 3GPP TS 33.303 [6];
\- DUIK (Discovery User Integrity Key): an optional key which is allocated by
the ProSe Function and is used by the UE to compute the MIC that is included
in the PC5_DISCOVERY message containing the ProSe Restricted Code in
restricted ProSe direct discovery. The format of the DUIK is defined in 3GPP
TS 33.303 [6]; and
\- DUCK (Discovery User Confidentiality Key) and associated Encrypted
Bitmask): DUCK is an optional key which is allocated by the ProSe Function and
is used by the UE to encrypt a portion of the PC5_DISCOVERY message containing
the ProSe Restricted Code in restricted ProSe direct discovery. The format of
the DUCK is defined in 3GPP TS 33.303 [6]. The Encrypted Bitmask is a 184-bit
bitmask which uses bit \"1\" to mark the positions of the bits for which the
DUCK encryption is applied.
#### 12.2.2.41 Discovery Model
This parameter is used to indicate the model of ProSe direct discovery
contained in the DISCOVERY_REQUEST message. It is an integer in the 0-3 range
encoded as follows:
0 Reserved
1 Model A
2 Model B
3 Unused
#### 12.2.2.42 ProSe Response Code
This parameter is used to carry the ProSe Response Code. It is a bit string
coded as specified in 3GPP TS 23.003 [4].
#### 12.2.2.43 Discovery Query Filter
This parameter is used to carry the Discovery Query Filter that is allocated
by the ProSe Function in the HPLMN to the Discoveree UE for restricted Model B
discovery, for a particular RPAUID. The elements in the Discovery Query Filter
parameter are defined as below.
\- Code: The code is used by a Discoveree UE for full or partial matching of
PC5_DISCOVERY messages received on the PC5 interface containing a ProSe Query
Code. Only one code is allowed in a Discovery Query Filter.;
\- Mask: The mask is a bitmask provided by the ProSe Function in order to
allow the Discoveree UE to perform a full matching or partial matching of
PC5_DISCOVERY messages received on the PC5 interface containing the ProSe
Query Code. A mask with all bits set to \"1\" is used for full matching. One
or more masks may be included in a filter. The length of the mask is the same
as the length of the code.
#### 12.2.2.44 Validity Timer T4011
This parameter is used to carry the value of validity timer T4011 associated
with a ProSe Response Code and corresponding Discovery Query Filter(s). It is
an integer in the 1-525600 range representing the timer value in unit of
minutes.
#### 12.2.2.45 Subquery Result
This parameter is used to contain the information allocated by the ProSe
Function related to one particular query target RPAUID which the discoverer UE
intends to query with restricted ProSe direct discovery Model B. It contains
one ProSe Query Code, one or more Discovery Response Filter(s), Validity Timer
T4013, an RPAUID parameter identifying the target RPAUID, Restricted Security
and optionally the corresponding metadata. The elements in the Subquery Result
parameter are defined as below.
\- ProSe Query Code: It is a ProSe Restricted Code allocated by the ProSe
Function to a discoverer UE to solicit the response from a discoveree UE for a
particular target RPAUID.
\- Discovery Response Filter: It contains one code and one or more masks to be
used to matching ProSe Response Code, as described in subclause 6.2.3B.4. The
code is used by a discoverer UE to represent a targeted ProSe Response Code
(see subclause 12.2.2.42). The mask is a bitmask provided by the ProSe
Function in order to allow the discoverer UE to perform a full matching or
partial matching of PC5_DISCOVERY messages received on the PC5 interface
containing the ProSe Response Code. A mask with all bits set to \"1\" is used
for full matching. The length of the mask is the same as the length of the
code.
\- Validity Timer T4013: It represents the validity time associated with a
ProSe Query Code and corresponding Discovery Response Filter(s). It is an
integer in the 1-525600 range representing the timer value in unit of minutes.
\- Restricted Security: It contains the information element defined in
subclause 12.2.2.40.
\- RPAUID: identifier of the target RPAUID to be monitored.
\- Metadata: application-layer metadata associated with the querying target.
#### 12.2.2.46 ProSe Restricted Code Prefix
This parameter is used to contain a ProSe Restricted Code Prefix, whose format
is defined in 3GPP TS 23.003 [4].
#### 12.2.2.47 ProSe Restricted Code Suffix
This parameter is used to contain a ProSe Restricted Code Suffix, whose format
is defined in 3GPP TS 23.003 [4]. If the size of ProSe Restricted Code Suffix
is less than 120 bits, the information element shall be padded with zeros in
the least significant bits.
#### 12.2.2.48 ProSe UE ID
The ProSe UE ID parameter is used to indicate a ProSe UE ID. The value of the
ProSe UE ID parameter is a 24-bit long bit string.
#### 12.2.2.49 ProSe Relay UE ID
The ProSe Relay UE ID parameter is used to indicate a ProSe Relay UE ID. The
value of the ProSe Relay UE ID parameter is a 24-bit long bit string.
#### 12.2.2.50 User Info ID
The User Info ID parameter carries a User Info ID as specified in 3GPP TS
23.303 [2]. The value of the User Info ID parameter is a 48-bit long bit
string. The format of the User Info ID parameter is out of scope of this
specification.
NOTE: Depending on operation, User Info ID is indicated as the Announcer Info
parameter, the Discoverer Info parameter or the Discoveree Info parameter.
#### 12.2.2.51 Relay Service Code
The Relay Service Code parameter identifies a connectivity service the UE-to-
Network relay provides. The value of the Relay Service Code parameter is a
24-bit long bit string. The format of the Relay Service Code parameter is out
of scope of this specification.
#### 12.2.2.52 Target User Info
The Target User Info parameter is used to provide the User Info ID of the
targeted discoveree user. The value of the Target User Info parameter is a
48-bit long bit string.
#### 12.2.2.53 Target Group Info
The Target Group Info parameter is used to provide the identifier of the
targeted group (e.g. ProSe Layer 2 Group ID). The value of the Target Group
Info parameter is 24-bit long bit string.
#### 12.2.2.54 Discovery Group ID
The Discovery Group ID parameter carries an identifier of a discovery group
that the UE belongs to. The value of the Discovery Group ID parameter is a
24-bit long bit string. The format of the Discovery Group ID parameter is out
of scope of this specification.
#### 12.2.2.55 GMDS Composition
This parameter is used to indicate the content of the PC5_DISCOVERY message
for Group Member Discovery Solicitation.
This parameter is coded as shown in figure 12.2.2.55.1 and table 12.2.2.55.1.
* * *
8 7 6 5 4 3 2 1  
TUII TGII Spare octet 1
* * *
Figure 12.2.2.55.1: GMDS Composition parameter
Table 12.2.2.55.1: GMDS Composition parameter
+----------------------------+---+---+---+----------------------------+ | TUII (octet 1) | | | | | +----------------------------+---+---+---+----------------------------+ | Bit | | | | | +----------------------------+---+---+---+----------------------------+ | 8 | | | | | +----------------------------+---+---+---+----------------------------+ | 0 | | | | Target User Info is not | | | | | | included (see NOTE 1) | +----------------------------+---+---+---+----------------------------+ | 1 | | | | Target User Info is | | | | | | included (see NOTE 1) | +----------------------------+---+---+---+----------------------------+ | | | | | | +----------------------------+---+---+---+----------------------------+ | TGII (octet 1) | | | | | +----------------------------+---+---+---+----------------------------+ | Bit | | | | | +----------------------------+---+---+---+----------------------------+ | 7 | | | | | +----------------------------+---+---+---+----------------------------+ | 0 | | | | Target Group Info is not | | | | | | included (see NOTE 1) | +----------------------------+---+---+---+----------------------------+ | 1 | | | | Target Group Info is | | | | | | included (see NOTE 1) | +----------------------------+---+---+---+----------------------------+ | Bits 1 to 6 of octet 1 are | | | | | | spare and shall be coded | | | | | | as zero (see NOTE 2). | | | | | +----------------------------+---+---+---+----------------------------+ | NOTE 1: The TUII and TGII | | | | | | shall not be set to the | | | | | | same value. | | | | | | | | | | | | NOTE 2: Bits 1 to 6 of | | | | | | octet 1 were reserved in | | | | | | earlier versions of the | | | | | | protocol. | | | | | +----------------------------+---+---+---+----------------------------+
#### 12.2.2.56 Spare
This parameter is a string of spare bits. The length of this parameter is
variable and is indicated in a message where this parameter is included.
#### 12.2.2.57 RDAI Composition
This parameter is used to indicate the content of the PC5_DISCOVERY message
for Relay Discovery Additional Information.
This parameter is coded as shown in figure 12.2.2.57.1 and table 12.2.2.57.1.
* * *
8 7 6 5 4 3 2 1  
MBMSRI ECGII Spare octet 1
* * *
Figure 12.2.2.57.1: RDAI Composition IE parameter
Table 12.2.2.57.1: RDAI Composition IE parameter
+----------------------------+---+---+---+----------------------------+ | MBMS related information | | | | | | (octet 1) | | | | | +----------------------------+---+---+---+----------------------------+ | Bit | | | | | +----------------------------+---+---+---+----------------------------+ | 8 | | | | | +----------------------------+---+---+---+----------------------------+ | 0 | | | | MBMS related information | | | | | | is not included | +----------------------------+---+---+---+----------------------------+ | 1 | | | | MBMS related information | | | | | | is included | +----------------------------+---+---+---+----------------------------+ | | | | | | +----------------------------+---+---+---+----------------------------+ | ECGI information (octet 1) | | | | | +----------------------------+---+---+---+----------------------------+ | Bit | | | | | +----------------------------+---+---+---+----------------------------+ | 7 | | | | | +----------------------------+---+---+---+----------------------------+ | 0 | | | | ECGI information is not | | | | | | included | +----------------------------+---+---+---+----------------------------+ | 1 | | | | ECGI information is | | | | | | included | +----------------------------+---+---+---+----------------------------+ | Bits 1 to 6 of octet 1 are | | | | | | spare and shall be coded | | | | | | as zero (see NOTE 2). | | | | | | | | | | | | NOTE 1: Either the ECGI | | | | | | information or the MBMS | | | | | | related information is to | | | | | | be included, but not both. | | | | | +----------------------------+---+---+---+----------------------------+ | NOTE 2: Bits 1 to 6 of | | | | | | octet 1 were reserved in | | | | | | earlier versions of the | | | | | | protocol. | | | | | +----------------------------+---+---+---+----------------------------+
#### 12.2.2.58 ECGI
This parameter is used to indicate the ECGI of the serving cell where the
ProSe UE-to-network relay UE is camping.
The UE-to-network relay ECGI parameter is coded as shown in figure 12.2.2.58
and table 12.2.2.58.
* * *
     8             7             6         5   4   3   2   1   
     MCC digit 2   MCC digit 1   octet 1                       
     MNC digit 3   MCC digit 3   octet 2                       
     MNC digit 2   MNC digit 1   octet 3                       
     ECI digit 2   ECI digit 1   octet 4                       
     ECI digit 4   ECI digit 3   octet 5                       
     ECI digit 6   ECI digit 5   octet 6                       
     Spare         ECI digit 7   octet 7
* * *
Figure 12.2.2.58.1: UE-to-network relay ECGI parameter
Table 12.2.2.58.1: UE-to-network relay ECGI parameter
+----------------------------------------------------------------------+ | MCC, Mobile country code (octet 1, octet 2 bits 1 to 4) | | | | The MCC field is coded as in ITU-T Rec. E.212 [32], Annex A. | | | | MNC, Mobile network code (octet 2 bits 5 to 8, octet 3) | | | | The coding of this field is the responsibility of each | | administration but BCD coding shall be used. If MNC consists of 2 | | digits, Bits 5 to 8 of octet 2 is coded as \"1111\". | | | | ECI, E-UTRAN cell identity (octet 4, octet 5, octet 6, octet 7 bits | | 1 to 4) | | | | The ECI field is coded as in 3GPP TS 23.003 [4]. | | | | Spare(octet 7 bits 5 to 8) | | | | The Spare field is coded as zeros. | +----------------------------------------------------------------------+
#### 12.2.2.59 MBMS related information
This parameter is used to indicate a TMGI and its corresponding ProSe Layer-2
Group ID.
The MBMS related information parameter is coded as shown in figure 12.2.2.59.1
and table 12.2.2.59.1.
| 8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 |   
---|---|---|---|---|---|---|---|---|---  
| TMGI | octet 1 octet 2 octet 3 octet 4 octet 5 octet 6 |  |  |  |  |  |  |   
| ProSe Layer-2 Group ID | octet 7 octet 8 octet 9 |  |  |  |  |  |  |   
Figure 12.2.2.59.1: TMGIs and ProSe Layer-2 Group IDs parameter
Table 12.2.2.59.1: TMGIs and ProSe Layer-2 Group IDs parameter
+----------------------------------------------------------------------+ | TMGI (octets 1 to 6) | | | | The TMGI field is coded exactly same as octet 3 to octet 8 of TMGI | | element in the figure 10.5.154/3GPP TS 24.008 [30] and | | table 10.5.168/3GPP TS 24.008 [30]. | | | | ProSe Layer-2 Group ID (octets 7 to 9) | | | | The ProSe Layer-2 Group ID field contains a ProSe Layer-2 Group ID. | +----------------------------------------------------------------------+
#### 12.2.2.60 Validity Timer T4016
This parameter is used to carry the value of Validity Timer T4016 associated
with a ProSe Restricted Code for which there was a match event. It is an
integer in the 1-525600 range representing the timer value in unit of minutes.
#### 12.2.2.61 Match Report Refresh Timer T4017
This parameter is used to carry the value of Match Report Refresh Timer T4017
associated with a ProSe Restricted Code for which there was a match event. It
is an integer in the 1-525600 range representing the timer value in unit of
minutes.
#### 12.2.2.62 Metadata Index Mask
This parameter is a bitmask provided by the ProSe Function in order to
indicate the portion used for the Metadata Index in the ProSe Application Code
for the monitoring UE. The length of the Metadata Index Mask is as same as the
length of ProSe Application Code.
#### 12.2.2.63 Network-Initiated Transaction Method
This parameter is used to indicate the method enabling transport of PC3
messages for ProSe Function-initiated ProSe direct discovery procedures. It is
an integer in the 0-255 range encoded as follows:
0 Unused
1 HTTP long polling
2-255 Unused
#### 12.2.2.64 Announcing PLMN ID
This parameter is used to indicate the PLMN ID of the PLMN operating the radio
resources which the UE intends to use for transmitting a PC5_DISCOVERY
message. It is coded as specified in 3GPP TS 23.003 [4].
#### 12.2.2.65 Metadata Indicator
This parameter is used to indicate whether there is a metadata associated with
the target RPAUID. It is an integer value in the 0-255 range encoded as
follows:
0 No metadata associated
1 Metadata associated
2-255 Unused
#### 12.2.2.66 URDS Composition
This parameter is used to indicate the content of the PC5_DISCOVERY message
for UE-to-Network Relay Discovery Solicitation.
This parameter is coded as shown in figure 12.2.2.66.1 and table 12.2.2.66.1.
* * *
8 7 6 5 4 3 2 1  
PRUII Spare octet 1
* * *
Figure 12.2.2.66.1: UDRS Composition parameter
Table 12.2.2.66.1: UDRS Composition parameter
* * *
PRUII (octet 1)  
Bit  
8  
0 ProSe Relay UE ID is not included 1 ProSe Relay UE ID is included
Bits 1 to 7 of octet 1 are spare and shall be coded as zero (see NOTE).  
NOTE: Bits 1 to 7 of octet 1 were reserved in earlier versions of the
protocol.
* * *
#### 12.2.2.67 Status Indicator
This parameter is used to indicate the status of ProSe UE-to-network relay.
This parameter is coded as shown in figure 12.2.2.67.1 and table 12.2.2.67.1.
Resource Status Indicator (RSI) is used to indicate whether or not the UE has
resources available to provide a connectivity service for additional ProSe-
enabled public safety UEs.
* * *
8 7 6 5 4 3 2 1  
RSI Spare octet 1
* * *
Figure 12.2.2.67.1: Status Indicator parameter
Table 12.2.2.67.1: Status Indicator parameter
* * *
RSI (octet 1)  
Bit  
8  
0 the UE does not have resources available to provide a connectivity service
for additional ProSe-enabled public safety UEs 1 the UE has resources
available to provide a connectivity service for additional ProSe-enabled
public safety UEs
Bits 1 to 7 of octet 1 are spare and shall be coded as zero (see NOTE).  
NOTE: Bits 1 to 7 of octet 1 were reserved in earlier versions of the
protocol.
* * *
#### 12.2.2.68 ProSe Application Code Prefix
This parameter is used to contain a ProSe Application Code Prefix. Its length
indicates the size in bits of the allocated prefix, which can take any value
that is a multiple of 8 in the 32 to 176 range.
NOTE: The size of the prefix for a given application is determined by the
ProSe Application Server and made known to the ProSe Function by means that
are out of scope of 3GPP.
#### 12.2.2.69 ProSe Application Code Suffix
This parameter is used to contain a ProSe Application Code Suffix. The ProSe
Application Code Suffix is used with a ProSe Application Code Prefix to form a
184-bit ProSe Application Code for open ProSe direct discovery with
application-controlled extension.
#### 12.2.2.70 ProSe Application Code ACE
This parameter is used to carry a set of ProSe Application Code(s) allocated
for a corresponding ProSe Application ID when application-controlled extension
is used. It contains one ProSe Application Code Prefix, and one or more ProSe
Application Code Suffix Range(s). The elements in the ProSe Application Code
ACE parameter are defined as below:
\- ProSe Application Code Prefix: as defined in subclause 12.2.2.68;
\- ProSe Application Code Suffix Range: this parameter is used to carry a
range of consecutive ProSe Application Code Suffixes (see subclause
12.2.2.69). A ProSe Application Code Suffix Range includes a Beginning Suffix
Code and optionally an Ending Suffix Code, as described below:
\- Beginning Suffix Code: The bit-length of this bit string reflects the
length of the suffix portion of the ProSe Application Code allocated by the
ProSe Application Server for a ProSe Application ID based on application
configuration. The binary value of this code is the lowest value of the ProSe
Application Code Suffix range.
\- Ending Suffix Code: The binary value of this code is the highest value of
the ProSe Application Code Suffix range. The length of the Ending Suffix Code
shall be the same as that of the Beginning Suffix Code.
If the ProSe Application Code Suffix Range contains only a single ProSe
Application Code Suffix, then that suffix is represented by the Beginning
Suffix Code, and the Ending Suffix Code is omitted.
#### 12.2.2.71 PC5_tech
This parameter is used to indicate the PC5 radio technology in order to enable
co-ordination between the announcing and monitoring side.
This parameter is coded as shown in figure 12.2.2.71.1 and table 12.2.2.71.1.
* * *
8 7 6 5 4 3 2 1  
Spare WLAN E-UTRA octet 1
* * *
Figure 12.2.2.71.1: PC5_tech parameter
Table 12.2.2.71.1: PC5_tech parameter
* * *
PC5_tech (octet 1)  
Bit  
1  
0 E-UTRA not included 1 E-UTRA is included
Bit  
2  
0 WLAN not included 1 WLAN is included Bits 3 to 8 of octet 1 are spare and
shall be coded as zero.
* * *
## 12.3 EPC-level ProSe discovery message formats
### 12.3.1 Data types format in XML schema
To exchange structured information over the transport protocol, XML text
format/notation is introduced. XML data type definitions and requirements as
specified in subclause 12.2.1 apply.
### 12.3.2 Information elements in EPC-level ProSe discovery messages
#### 12.3.2.1 Transaction ID
This parameter is used to uniquely identify a PC3 Control Protocol for EPC-
level ProSe discovery transaction when it is combined with other PC3 Control
Protocol for EPC-level ProSe discovery transactions in the same transport
message. The UE shall set this parameter to a new number for each outgoing new
discovery request. The transaction ID is an integer in the 0-255 range.
#### 12.3.2.2 UE Identity
This parameter is used to indicate the requesting UE\'s identity and is set to
the IMSI. The coding of IMSI is defined in 3GPP TS 23.003 [4].
#### 12.3.2.3 Application Identity
This parameter is used to identify the particular application that triggers
the APPLICATION_REGISTRATION_REQUEST message. The format of the Application
Identity consists of two parts:
\- OS ID: operating system identifier. The format of the OS ID is a
Universally Unique IDentifier (UUID) as specified in IETF RFC 4122 [8]; and
\- OS App ID: a string containing the OS specific application identifier.
NOTE: Further definition of the format of OS App ID is beyond the scope of
this specification.
#### 12.3.2.4 Application Layer User ID
This parameter is used to carry an Application Layer User ID that identifies
the user in the context of specific application. It is encoded as a bit
string.
#### 12.3.2.5 PC3 EPC Control Protocol cause value
This parameter is used to indicate the particular reason why either the UE or
the ProSe function sends the UE_DEREGISTRATION_REQUEST message or why the
following messages have been rejected by the ProSe Function:
\- UE_REGISTRATION_REQUEST;
\- APPLICATION_REGISTRATION_REQUEST;
\- PROXIMITY_REQUEST; and
\- PROXIMITY_REQUEST_VALIDATION.
It is an integer in the 0-255 range encoded as follows:
0 Reserved
1 Invalid Application
2 UE authorisation failure
3 Invalid Message Format
4 Application not registered
5 Range class not allowed for this application
6 Proximity detection unlikely within requested time window
7 Targeted user not registered for this application
8 Proximity validation rejected by B-side
9 Application disabled temporarily
10 Invalid Application Layer User ID
11-255 Unused
#### 12.3.2.6 WLAN Link Layer ID
This parameter is used to carry WLAN link layer identifier. The value of WLAN
Link Layer ID is coded as a bit string of length 48.
#### 12.3.2.7 EPC ProSe User ID
This parameter is used to carry an EPC ProSe User ID that identifies the UE
registered for EPC-level ProSe Discovery in the context of the ProSe Function.
It is specified in 3GPP TS 23.003 [4].
#### 12.3.2.8 Range Class
This parameter is used to carry one range class used for
APPLICATION_REGISTRATION_RESPONSE or PROXIMITY_REQUEST messages. It is an
integer in the 0-255 range encoded as follows:
0 Reserved
1 0-50 m
2 0-100 m
3 0-200 m
4 0-500 m
5 0-1000 m
6-255 Unused
#### 12.3.2.9 Time Window
This parameter is used to specify a time interval in minutes during which a
proximity request is valid. The Time Window is an integer in the range of 1 --
1440 minutes.
#### 12.3.2.10 Void
#### 12.3.2.11 UE Location
The UE Location is set to the cell identity part of the Evolved Cell Global
Identifier, as described in 3GPP TS 36.331 [12] and obtained from the lower
layers of the UE. The value of UE Location is a bit string coded as specified
in 3GPP TS 36.331 [12].
#### 12.3.2.12 WLAN Indication
This parameter is used to carry an indication of whether the searching UE
wishes to engage in WLAN direct discovery and communication subsequent to
successful proximity detection. It is a Boolean value coded as follows:
False the searching UE does not wish to engage in WLAN direct discovery and
communication subsequent to successful proximity detection
True the searching UE wishes to engage in WLAN direct discovery and
communication subsequent to successful proximity detection
#### 12.3.2.13 Assistance Information
This parameter is used to carry information for expediting WLAN direct
discovery and communication. The content of this parameter depends on the WLAN
technology.
Wi-Fi Peer-to-Peer (P2P) specification [13] defines an architecture and set of
protocols that facilitate direct discovery and communication using the IEEE
802.11 technology [14]. To assist WLAN direct discovery and communication as
required by the Wi-Fi P2P technology, the Assistance Information includes the
following parameters.
\- SSID: The SSID to use for Wi-Fi P2P operation. To be compliant with the Wi-
Fi P2P specification [13] the SSID should be in the form \"DIRECT-ab\" where
a, b are two random characters;
\- WLAN Secret Key: The pre-shared key to be used by UEs to secure their Wi-Fi
P2P communication. This is used by UEs as the Pairwise Master Key (PMK);
\- Group Owner indication: If set, the UE should implement the Group Owner
(GO) functionality specified in the Wi-Fi P2P specification [13]. The UE
implementing this functionality essentially becomes an AP that transmits
Beacons with the P2P Information Element and accepts associations from other
Wi-Fi P2P devices or from legacy Wi-Fi devices (those not implementing the Wi-
Fi P2P functionality). If not set, the UE should behave as a Wi-Fi P2P client
that attempts to discover and associate with a GO;
\- P2P Device Address of self: This is the WLAN Link Layer ID to be used by UE
to advertise itself. A UE implementing the Group Owner and indicates the WLAN
Direct device from which the GO should accept WLAN association requests.
Association requests from all other WLAN devices should be rejected by GO.
\- P2P Device Address of peers: This is the WLAN Link Layer ID to be used by
UE to discover peer UEs. A UE implementing the Group Owner should accept WLAN
association requests only from devices that are in this list;
\- Operation channel: The channel on which Wi-Fi P2P discovery and
communication should take place; and
> \- Validity time: The time period during which the content provided in the
> assistance information is valid.
#### 12.3.2.14 Method for server-initiated transaction
This parameter is used to indicate the capability of the UE to support methods
other than OMA Push (e.g., HTTP long polling method) for server initiated
procedures for EPC-level ProSe discovery. It is an integer in the 0-255 range
encoded as follows:
0 No extra methods available
1 HTTP long polling
2-255 Unused
#### 12.3.2.15 Method for server-initiated transaction configuration
This parameter is used to indicate the preference of a server-initiated method
type to be used by the UE and the ProSe Function for server-initiated
procedures for EPC-level ProSe discovery other than OMA Push (e.g., HTTP long
polling). It is an integer in the 0-255 range encoded as follows:
0 The ProSe Function does not prefer other method
1 HTTP long polling
2-255 Unused
## 12.4 Formats for messages transmitted over the PC3ch interface
### 12.4.1 Data types format in XML schema
To exchange structured information over the transport protocol, XML text
format/notation is introduced.
The corresponding XML data types for the data types used in ProSe PC3ch
messages are provided in table 12.4.1.
Table 12.4.1: Primitive or derived types for ProSe PC3ch Parameter Type
* * *
ProSe Parameter Type Type in XML Schema Integer xs:integer String xs:string
Boolean xs:boolean Binary xs:hexBinary Bit string xs:hexBinary Time
xs:dateTime
* * *
For complex data types described in subclause 12.4.2, an XML \"complexType\"
can be used.
Message construction shall be compliant with W3C REC-xmlschema-2-20041028:
\"XML Schema Part 2: Datatypes\" [7].
### 12.4.2 Parameters in messages transmitted over the PC3ch interface
#### 12.4.2.1 Transaction ID
This parameter is used to uniquely identify a message transmitted over the
PC3ch interface when it is combined with another message transmitted over the
PC3ch interface in the same transport message. The UE shall set this parameter
to a new number for each outgoing new message which includes this information
element and is transmitted over the PC3ch interface. The transaction ID is an
integer in the 0-255 range.
#### 12.4.2.2 UE Identity
This parameter is used to indicate the requesting UE\'s identity and is set to
the IMSI. The coding of IMSI is defined in 3GPP TS 23.003 [4].
#### 12.4.2.3 Sequence number
This parameter is used to indicate sequence number of the usage information
report. The sequence number is an integer in the 0-4294967295 range. The
sequence number is set to 0 on UE power up and is increased by 1 whenever a
new usage information report is created.
#### 12.4.2.4 In coverage
This parameter is used to indicate whether the UE was in E-UTRAN coverage. It
is a Boolean value coded as follows:
True the UE is in E-UTRAN coverage.
False the UE is out of E-UTRAN coverage.
#### 12.4.2.5 ECGI
This parameter is used to indicate E-UTRAN Cell Global Identification of the
E-UTRAN cell where the UE was camping on or which the UE used in the EMM-
CONNECTED mode. The coding of ECGI is defined in 3GPP TS 23.003 [4].
#### 12.4.2.6 ProSe direct communication radio parameters
This parameter is used to indicate the radio parameters used for ProSe direct
communication. Format of the value is according to the SL-Preconfiguration-r12
ASN.1 data type described in 3GPP TS 36.331 [12].
#### 12.4.2.7 Cause value
This parameter is used to indicate the particular reason why the ProSe
function CTF (ADF) rejects USAGE_INFORMATION_REPORT_LIST message. It is an
integer in the 0-255 range encoded as follows:
0 Reserved
2 UE authorisation failure
3 Invalid Message Format
10 Unable to process usage information report list
1, 4-9, 11-255 Unused
#### 12.4.2.8 Timestamp
This parameter is used to indicate time and date. The format of this parameter
follows the XML data type defined in table 12.4.1 for ProSe PC3ch message
parameter type \"Time\".
#### 12.4.2.9 ProSe Layer-2 Group ID
This parameters is used to indicate a ProSe Layer-2 Group ID. The value of
ProSe Layer 2 Group ID is a 24-bit bit-string.
#### 12.4.2.10 Prose Group IP multicast address
This parameters is used to indicate a ProSe Group IP multicast address. If the
IP address is an IPv4 address, its value is coded as a string representing the
dotted-decimal format of the IPv4 address as specified in IETF RFC 1166 [28].
If the IP address is an IPv6 address, its value is coded as a string
representing the canonical text representation format of the IPv6 address as
specified in IETF RFC 5952 [29].
#### 12.4.2.11 IP address of the UE
This parameters is used to indicate an IP address used by the UE as a source
address. If the IP address is an IPv4 address, its value is coded as a string
representing the dotted-decimal format of the IPv4 address as specified in
IETF RFC 1166 [28]. If the IP address is an IPv6 address, its value is coded
as a string representing the canonical text representation format of the IPv6
address as specified in IETF RFC 5952 [29].
#### 12.4.2.12 Prose UE ID
This parameters is used to indicate a ProSe UE ID. The value of ProSe UE ID is
a 24-bit bit-string.
#### 12.4.2.13 Transported data amount
This parameters is used to indicate the amount of transported data in octets.
The value of this parameter is coded as an integer.
#### 12.4.2.14 Radio resources indicator
This parameters is used to indicate whether the operator-provided radio
resources or the configured radio resources were used for ProSe direct
communication.
It is an integer in the 0-255 range encoded as follows:
0 Reserved
1 the operator-provided radio resources
2 the configured radio resources
3-255 Unused
#### 12.4.2.15 Radio frequency
This parameter is used to indicate the radio frequency used for ProSe direct
communication.
Format of the value is according to the ARFCN-ValueEUTRA-r9 ASN.1 data type
described in 3GPP TS 36.331 [12].
## 12.5 PC5 Signalling message formats
### 12.5.1 Information elements in PC5 Signalling messages
#### 12.5.1.1 PC5-SP Message Type
The PC5 SP Message Type IE is a type 3 information element, with the length of
1 octet. It is used to indicate the type of messages used in PC5 Signaling
Protocol.
Table 12.5.1.1.1 defines the value part of the PC5-SP Message Type IE used in
the PC5 Signalling messages.
Table 12.5.1.1.1: PC5-SP message types for PC5 Signalling Protocol
* * *
Bits  
8 7 6 5 4 3 2 1  
0 0 0 0 0 0 0 1 DIRECT_COMMUNICATION_REQUEST 0 0 0 0 0 0 1 0
DIRECT_COMMUNICATION_ACCEPT 0 0 0 0 0 0 1 1 DIRECT_COMMUNICATION_REJECT
0 0 0 0 0 1 0 0 DIRECT_COMMUNICATION_KEEPALIVE 0 0 0 0 0 1 0 1
DIRECT_COMMUNICATION_KEEPALIVE_ACK
0 0 0 0 0 1 1 0 DIRECT_COMMUNICATION_RELEASE 0 0 0 0 0 1 1 1
DIRECT_COMMUNICATION_RELEASE_ACCEPT
0 0 0 0 1 0 0 0 TMGI_MONITORING_REQUEST 0 0 0 0 1 0 0 1
TMGI_MONITORING_RESPONSE
0 0 0 0 1 0 1 0 CELL_ID_ANNOUNCEMENT_REQUEST 0 0 0 0 1 0 1 1
CELL_ID_ANNOUNCEMENT_RESPONSE
0 0 0 0 1 1 0 0 DIRECT_SECURITY_MODE_COMMAND 0 0 0 0 1 1 0 1
DIRECT_SECURITY_MODE_COMPLETE 0 0 0 0 1 1 1 0 DIRECT_SECURITY_MODE_REJECT
0 0 0 0 1 1 1 1 DIRECT_REKEYING_REQUEST 0 0 0 1 0 0 0 0
DIRECT_REKEYING_RESPONSE 0 0 0 1 0 0 0 1 DIRECT_REKEYING_TRIGGER
0 0 0 1 0 0 1 0 REMOTE_UE_INFO_REQUEST 0 0 0 1 0 0 1 1 REMOTE_UE_INFO_RESPONSE
All other values are reserved
* * *
#### 12.5.1.2 Sequence Number
The purpose of the Sequence Number is to uniquely identify a PC5 Signalling
message being sent or received. The sending UE will increment the sequence
number for each outgoing new PC5 Signalling message. The Sequence Number
information element is an integer in the 0-65535 range.
#### 12.5.1.3 User Info
The purpose of the User Info information element is to provide either the User
Info received from upper layers identifying the user which is using this
direct link, the PRUK ID received from the PKMF that the remote UE wants to
use to connect to a relay using this direct link, or the IMSI of the remote UE
using this direct link.
The User Info IE content is a Type 4 information element, with a minimum
length of 3 octets. The IEI of the User Info IE is 1.
The User Info information element is coded as shown in figure 12.5.1.3.1,
figure 12.5.1.3.2 and table 12.5.1.3.1.
+------------------------------+-----------+-------------------+---------+---+---+---+---+---+ | 8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | | +------------------------------+-----------+-------------------+---------+---+---+---+---+---+ | User Info IEI | octet 1 | | | | | | | | +------------------------------+-----------+-------------------+---------+---+---+---+---+---+ | Length of User Info contents | octet 2 | | | | | | | | +------------------------------+-----------+-------------------+---------+---+---+---+---+---+ | User Info | 0 | Type of User info | octet 3 | | | | | | | | | | | | | | | | | | Spare | | | | | | | | +------------------------------+-----------+-------------------+---------+---+---+---+---+---+ | | | | | | | | | | +------------------------------+-----------+-------------------+---------+---+---+---+---+---+ | User Info | octet 4* | | | | | | | | +------------------------------+-----------+-------------------+---------+---+---+---+---+---+
Figure 12.5.1.3.1: User Info information element
+------------+------------+------------+---------+---+---+---+---+---+ | 8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | | +------------+------------+------------+---------+---+---+---+---+---+ | User Info | octet 1 | | | | | | | | | IEI | | | | | | | | | +------------+------------+------------+---------+---+---+---+---+---+ | Length of | octet 2 | | | | | | | | | User Info | | | | | | | | | | contents | | | | | | | | | +------------+------------+------------+---------+---+---+---+---+---+ | User Info | odd/ | Type of | octet 3 | | | | | | | digit 1 | | User info | | | | | | | | | even | | | | | | | | | | | | | | | | | | | | indic | | | | | | | | +------------+------------+------------+---------+---+---+---+---+---+ | User info | User Info | octet 4* | | | | | | | | digit p+1 | digit p | | | | | | | | +------------+------------+------------+---------+---+---+---+---+---+
Figure 12.5.1.3.2: User Info information element for type of User Info
\"IMSI\"
Table 12.5.1.3.1: User Info information element
+-----------------------------+---+---+-----------------------------+ | Type of User Info (octet 3) | | | | | | | | | | Bits | | | | +-----------------------------+---+---+-----------------------------+ | 3 | 2 | 1 | | +-----------------------------+---+---+-----------------------------+ | 0 | 0 | 1 | Upper layers User Info | +-----------------------------+---+---+-----------------------------+ | 0 | 1 | 0 | PRUK ID | +-----------------------------+---+---+-----------------------------+ | 0 | 1 | 1 | IMSI | +-----------------------------+---+---+-----------------------------+ | All other values are | | | | | reserved. | | | | +-----------------------------+---+---+-----------------------------+ | | | | | +-----------------------------+---+---+-----------------------------+ | Odd/even indication (octet | | | | | 3) | | | | | | | | | | Bit | | | | +-----------------------------+---+---+-----------------------------+ | 4 | | | | +-----------------------------+---+---+-----------------------------+ | 0 | | | even number of identity | | | | | digits | +-----------------------------+---+---+-----------------------------+ | 1 | | | odd number of identity | | | | | digits | +-----------------------------+---+---+-----------------------------+ | | | | | +-----------------------------+---+---+-----------------------------+ | Identity digits (octet 3 | | | | | etc) | | | | | | | | | | For the IMSI, this field is | | | | | coded using BCD coding. If | | | | | the number of identity | | | | | digits is even then bits 5 | | | | | to 8 of the last octet | | | | | shall be filled with an end | | | | | mark coded as \"1111\". | | | | | | | | | | For Type of identity | | | | | \"Upper layers User Info\", | | | | | the User Info bits are set | | | | | to a bit string received | | | | | from upper layers. Any | | | | | unused bit in the last | | | | | octet shall be coded as | | | | | '0'. | | | | | | | | | | For Type of identity \"PRUK | | | | | ID\", the User Info bits | | | | | are set to a bit string | | | | | received from the PKMF. Any | | | | | unused bit in the last | | | | | octet shall be coded as | | | | | '0'. | | | | +-----------------------------+---+---+-----------------------------+ | | | | | +-----------------------------+---+---+-----------------------------+
#### 12.5.1.4 IP Address Config
The purpose of the IP Address Config information element is to indicate the
configuration options for IP address used by the UE over this direct link.
The IP Address Config is a type 3 information element. The IEI of the IP
Address Config IE is 2.
The IP Address Config information element is coded as shown in figure
12.5.1.4.1 and table 12.5.1.4.1.
* * *
8 7 6 5 4 3 2 1  
IP Address Config IEI octet 1  
IP address Config Content octet 2
* * *
Figure 12.5.1.4.1: IP Address Config information element
Table12.5.1.4.1: IP Address Config information element
* * *
IP Address Config value (octet 2)  
Bits  
4 3 2 1  
0 0 0 0 DHCPv4 Server 0 0 0 1 IPv6 Router 0 0 1 0 DHCPv4 Server & IPv6 Router
0 0 1 1 address allocation not supported
All other values are reserved.
Bit 5 to 8 of octet 2 are spare and shall be coded as zero.
* * *
#### 12.5.1.5 Link Local IPv6 Address
The Link Local IPv6 Address information element contains a link-local IPv6
address.
The Link Local IPv6 Address is a type 3 information element. The IEI of the
Link Local IPv6 Address IE is 3.
The Link Local IPv6 Address element is coded as shown in figure 12.5.1.5.1 and
table 12.5.1.5.1.
* * *
8 7 6 5 4 3 2 1  
Link Local IPv6 Address IEI octet 1  
Link Local IPv6 address Content octet 2  
octet 17
* * *
Figure 12.5.1.5.1: IP Address Config information element
Table12.5.1.5.1: IPv6 Address information element
+----------------------------------------------------------------------+ | IP address value (octet 2 to 17) | | | | This contains the 128-bit IPv6 address. This IPv6 address is encoded | | as a 128-bit address according to IETF RFC 4291 [36]. | +----------------------------------------------------------------------+
#### 12.5.1.6 Keepalive Counter
The Keepalive Counter information element contains a 32-bit counter used for
the direct link keepalive procedure.
The Keepalive Counter is a type 3 information element with a length of 5
octets. The IEI of the KeepAlive Counter IE is 4.
The Keepalive Counter information element is coded as shown in figure
12.5.1.6.1 and table 12.5.1.6.1.
* * *
8 7 6 5 4 3 2 1  
Keepalive Counter IEI octet 1  
Keepalive Counter Content octet 2  
octet 5
* * *
Figure 12.5.1.6.1: Keepalive Counter information element
Table12.5.1.6.1: Keepalive Counter information element
+---------------------------------------------+ | Keepalive Counter value (octet 2 to 5) | | | | This contains the 32-bit keepalive counter. | +---------------------------------------------+
#### 12.5.1.7 PC5 Signalling Protocol Cause Value
The purpose of the PC5 Signaling Protocol Cause Value information element is
to indicate the error cause values used in the PC5 Signalling Protocol
procedures.
The PC5 Signalling Protocol Cause Value is a type 3 information element, with
a length of 2 octets. The IEI of PC5 Signaling Protocol Cause Value IE is 5.
The PC5 Signalling Protocol Cause Value information element is coded as shown
in figure 12.5.1.7.1 and table 12.5.1.7.1.
* * *
8 7 6 5 4 3 2 1  
PC5 Signalling Protocol Cause Value IEI octet 1  
PC5 Signalling Protocol Cause Value Content octet 2
* * *
Figure 12.5.1.7.1: PC5 Signaling Protocol Cause Value information element
Table12.5.1.7.1: PC5 Signaling Protocol Cause Value information element
* * *
PC5 Signaling Error Cause value (octet 2)  
Bits  
4 3 2 1  
0 0 0 1 Direct communication to target UE not allowed 0 0 1 0 Authentication
failure 0 0 1 1 Conflict of Layer 2 ID for unicast communication is detected 0
1 0 0 Lack of resources for proposed link 0 1 0 1 IP version mismatch 0 1 1 0
Link setup failure due to other errors 0 1 1 1 UE security capabilities
mismatch 1 0 0 0 Unspecified error 1 0 0 1 Authentication synchronisation
error 1 0 1 0 Non-responsive peer during security mode procedure
All other values are reserved.
Bit 5 to 8 of octet 2 are spare and shall be coded as zero.
* * *
#### 12.5.1.8 Release Reason
The purpose of the Release Reason information element is to indicate the
reason why the direct link is to be released.
The Release Reason IE is a type 3 information element, with a length of 2
octets. The IEI of Release Reason IE is 6.
The Release Reason information element is coded as shown in figure 12.5.1.8.1
and table 12.5.1.8.1.
* * *
8 7 6 5 4 3 2 1  
Release Reason IEI octet 1  
Release Reason Content octet 2
* * *
Figure 12.5.1.8.1: Release Reason information element
Table 12.5.1.8.1: Release Reason information element
* * *
Release Reason value (octet 2)  
Bits  
4 3 2 1  
0 0 0 1 Direct communication to the peer UE no longer needed 0 0 1 0 Direct
communication with the peer UE is no longer allowed 0 0 1 1 Direct connection
is not available any more
All other values are reserved.
Bit 5 to 8 of octet 2 are spare and shall be coded as zero.
* * *
#### 12.5.1.9 Maximum Inactivity Period
The purpose of the Maximum Inactivity Period information element is to
indicate the maximum inactivity period of the requesting UE over the direct
link.
The Maximum Inactivity Period IE is a type 3 information element, with a
length of 5 octets. The IEI of Maximum Inactivity Period IE is 7.
The Maximum Inactivity Period information element is coded as shown in figure
12.5.1.9.1 and table 12.5.1.9.1.
* * *
8 7 6 5 4 3 2 1  
Maximum Inactivity Period IEI octet 1  
Maximum Inactivity Period Content octet 2  
octet 5
* * *
Figure 12.5.1.9.1: Maximum Inactivity Period information element
Table12.5.1.9.1: Maximum Inactivity Period information element
+--------------------------------------------------------------+ | Maximum Inactivity Period value (octet 2 to 5) | | | | This contains the 32-bit inactivity period value in seconds. | +--------------------------------------------------------------+
#### 12.5.1.10 TMGI
This parameter is used to identify the Multicast and Broadcast bearer
services. The coding of TMGI is specified in 3GPP TS 24.008 [30].
#### 12.5.1.11 MBMS SAI list
This parameter is used to transfer a list of MBMS Service Area Identities to
the ProSe UE-to-network relay UE. The MBMS SAI list is a type 6 information
element, with a minimum length of 6 octets and a maximum length of 516 octets.
The list can contain a maximum of 256 different MBMS Service Area Identities.
The length of each MBMS SAI is 2 octets. The IEI of MBMS SAI list IE is 28.
* * *
8 7 6 5 4 3 2 1  
MBMS SAI list IEI octet 1  
Length of MBMS SAI list octet 2  
Length of MBMS SAI list (continued) octet 3  
Number of MBMS SAIs octet 4  
MBMS SAI 1 octet 5  
MBMS SAI 1 (continued) octet 6  
MBMS SAI 2 octet 7  
MBMS SAI 2 (continued) octet 8  
...  
MBMS SAI n octet 2n-1  
MBMS SAI n (continued) octet 2n
* * *
Figure 12.5.1.11.1: MBMS SAI list information element
Table 12.5.1.11.1: MBMS SAI list information element value part
+---------------------+---+---+---+---+---+---+---+-------------+ | The value part of | | | | | | | | | | the MBMS SAI list | | | | | | | | | | information element | | | | | | | | | | consists of the | | | | | | | | | | number of MBMS SAIs | | | | | | | | | | and one or more | | | | | | | | | | MBMS SAIs. The | | | | | | | | | | length of MBMS SAI | | | | | | | | | | list is set based | | | | | | | | | | on the \'Number of | | | | | | | | | | MBMS SAIs\'. The | | | | | | | | | | ProSe UE-to-network | | | | | | | | | | relay UE shall | | | | | | | | | | store the complete | | | | | | | | | | list received. | | | | | | | | | | | | | | | | | | | | Number of MBMS SAIs | | | | | | | | | | (octet 1) | | | | | | | | | +---------------------+---+---+---+---+---+---+---+-------------+ | Bits | | | | | | | | | +---------------------+---+---+---+---+---+---+---+-------------+ | | | | | | | | | | +---------------------+---+---+---+---+---+---+---+-------------+ | 8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | | +---------------------+---+---+---+---+---+---+---+-------------+ | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 element | +---------------------+---+---+---+---+---+---+---+-------------+ | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 2 element | +---------------------+---+---+---+---+---+---+---+-------------+ | 0 | 0 | 0 | 0 | 0 | 0 | 1 | 0 | 3 element | +---------------------+---+---+---+---+---+---+---+-------------+ | ... | | | | | | | | | +---------------------+---+---+---+---+---+---+---+-------------+ | 1 | 1 | 1 | 1 | 1 | 1 | 0 | 1 | 254 element | +---------------------+---+---+---+---+---+---+---+-------------+ | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 0 | 255 element | +---------------------+---+---+---+---+---+---+---+-------------+ | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 1 | 256 element | +---------------------+---+---+---+---+---+---+---+-------------+ | | | | | | | | | | +---------------------+---+---+---+---+---+---+---+-------------+ | If the number of | | | | | | | | | | MBMS SAIs = n: | | | | | | | | | | | | | | | | | | | | for i=1, n; | | | | | | | | | | | | | | | | | | | | octet 2i and 2i+1 | | | | | | | | | | contain the MBMS | | | | | | | | | | SAI of the i-th | | | | | | | | | | MBMS SAI belonging | | | | | | | | | | to the MBMS SAI | | | | | | | | | | list | | | | | | | | | | | | | | | | | | | | The coding of MBMS | | | | | | | | | | SAI is specified in | | | | | | | | | | 3G | | | | | | | | | | PP TS 23.003 [4]. | | | | | | | | | +---------------------+---+---+---+---+---+---+---+-------------+ | | | | | | | | | | +---------------------+---+---+---+---+---+---+---+-------------+
#### 12.5.1.12 ProSe Layer2 Group ID
This parameter is a link layer identifier of the group that transmits the MBMS
traffic associated with a TMGI. The coding of ProSe Layer2 Group ID is
specified in 3GPP TS 23.003 [4].
#### 12.5.1.13 TMGI Monitoring Refresh Timer T4104
This parameter is used to carry the value of TMGI monitoring refresh timer
T4104 associated with a TMGI. It is an integer in the 1-1440 range
representing the timer value in unit of minutes.
#### 12.5.1.14 SAI Indicator
This parameter is used to carry the SAI indicator, which is a Boolean value
indicating whether the ProSe UE-to-network relay UE can forward the MBMS
content associated with the received TMGI for the remote UE.
#### 12.5.1.15 ECGI announcement request refresh timer T4106
This parameter is used to carry the value of ECGI announcement request refresh
timer. It is an integer in the 1-1440 range representing the timer value in
unit of minutes.
#### 12.5.1.16 Requested ProSe Per-Packet Priority
This parameter is used for representing a protocol data unit transmission
priority for relaying eMBMS traffic over PC5. It is provided by the remote UE.
It is an integer in the 1-8 range and the lower number means the higher
priority.
The Requested ProSe Per-Packet Priority is a type 3 information element, with
a length of 2 octets. The Requested ProSe Per-Packet Priority information
element is coded as shown in table 12.5.1.16.1. The IEI of the Requested ProSe
Per-Packet Priority IE is 29.
The Requested ProSe Per-Packet Priority information element is coded as shown
in figure 12.5.1.16.1 and table 12.5.1.16.1.
* * *
8 7 6 5 4 3 2 1  
Requested ProSe Per-Packet Priority IEI octet 1  
Requested ProSe Per-Packet Priority value octet 2
* * *
Figure 12.5.1.16.1: Requested ProSe Per-Packet Priority information element
Table 12.5.1.16.1: Requested ProSe Per-Packet Priority information element
* * *
ProSe Per-Packet Priority value (octet 2)  
Bits  
4 3 2 1  
0 0 0 0 Reserved 0 0 0 1 PPPP 1 0 0 1 0 PPPP 2 0 0 1 1 PPPP 3 0 1 0 0 PPPP 4 0
1 0 1 PPPP 5 0 1 1 0 PPPP 6 0 1 1 1 PPPP 7 1 0 0 0 PPPP 8
All other values are reserved.
Bit 5 to 8 of octet 2 are spare and shall be coded as zero.
* * *
#### 12.5.1.17 Relay Service Code
The purpose of the Relay Service Code information element is to indicate the
parameter defined in subclause 12.2.2.51.
The Relay Service Code information element is coded as shown in figure
12.5.1.17.1 and table 12.5.1.17.1.
The Relay Service Code is a type 3 information element with a length of 4
octets. The IEI of the Relay Service Code IE is 25.
* * *
8 7 6 5 4 3 2 1  
Relay Service Code IEI octet 1  
Relay Service Code octet 2  
: octet 4
* * *
**Figure 12.5.1.17.1: Relay Service Code information element**
**Table 12.5.1.17.1: Relay Service Code information element**
+----------------------------------------------+ | Relay Service Code value (octet 2 to 4) | | | | This contains the 24-bit Relay Service Code. | +----------------------------------------------+
#### 12.5.1.18 GPI
The purpose of the GPI information element is to include the GBA Push
Information as defined in 3GPP TS 33.223 [42].
The GPI information element is coded as shown in figure 12.5.1.18.1 and table
12.5.1.18.1.
The GPI is a type 4 information element with a variable length. The IEI of the
GPI IE is 24.
+------------------------+---------+---+---+---+---+---+---+---+ | 8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | | +------------------------+---------+---+---+---+---+---+---+---+ | GPI IEI | octet 1 | | | | | | | | +------------------------+---------+---+---+---+---+---+---+---+ | Length of GPI contents | octet 2 | | | | | | | | +------------------------+---------+---+---+---+---+---+---+---+ | GPI | octet 3 | | | | | | | | | | | | | | | | | | | : | | | | | | | | | +------------------------+---------+---+---+---+---+---+---+---+ | : | octet n | | | | | | | | +------------------------+---------+---+---+---+---+---+---+---+
**Figure 12.5.1.18.1: GPI information element**
**Table 12.5.1.18.1: GPI information element**
+--------------------------------------------------------+ | GPI value (octet 3 to n) | | | | GPI message layout as defined in 3GPP TS 33.223 [42] | +--------------------------------------------------------+
#### 12.5.1.19 PRUK ID
The purpose of the PRUK ID information element is to provide the ProSe UE-to-
network relay with the latest PRUK ID at the remote UE when the remote UE
triggers rekeying.
The PRUK ID information element is coded as shown in figure 12.5.1.19.1 and
table 12.5.1.19.1.
The PRUK ID is a type 3 information element with a length of 9 octets. The IEI
of the PRUK ID IE is 8.
+-------------+---------+---+---+---+---+---+---+---+ | 8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | | +-------------+---------+---+---+---+---+---+---+---+ | PRUK ID IEI | octet 1 | | | | | | | | +-------------+---------+---+---+---+---+---+---+---+ | PRUK ID | octet 2 | | | | | | | | | | | | | | | | | | | : | | | | | | | | | +-------------+---------+---+---+---+---+---+---+---+ | : | octet 9 | | | | | | | | +-------------+---------+---+---+---+---+---+---+---+
**Figure 12.5.1.19.1: PRUK ID information element**
**Table 12.5.1.19.1: PRUK ID information element**
+------------------------------+ | PRUK ID value (octet 2 to 9) | | | | This contains the PRUK ID | +------------------------------+
#### 12.5.1.20 AUTS
The purpose of the AUTS information element is to provide the network with the
necessary information to begin a re-synchronisation as part of the AKA
procedure (see 3GPP TS 33.102 [41]).
The AUTS information element is coded as shown in figure 12.5.1.20.1 and table
12.5.1.20.1.
The AUTS is a type 3 information element with a length of 15 octets. The IEI
of the AUTS IE is 9.
+----------+----------+---+---+---+---+---+---+---+ | 8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | | +----------+----------+---+---+---+---+---+---+---+ | AUTS IEI | octet 1 | | | | | | | | +----------+----------+---+---+---+---+---+---+---+ | AUTS | octet 2 | | | | | | | | | | | | | | | | | | | : | | | | | | | | | +----------+----------+---+---+---+---+---+---+---+ | : | octet 15 | | | | | | | | +----------+----------+---+---+---+---+---+---+---+
**Figure 12.5.1.20.1: AUTS information element**
**Table 12.5.1.20.1: AUTS information element**
+------------------------------------------------+ | AUTS value (octet 2 to 15) | | | | This contains AUTS (see 3GPP TS 33.102 [41]) | +------------------------------------------------+
#### 12.5.1.21 RAND
The purpose of the RAND information element is to provide the mobile station
with a non-predictable challenge for the AKA procedure.
The RAND information element is coded as shown in figure 12.5.1.21.1 and table
12.5.1.21.1.
The RAND is a type 3 information element with a length of 17 octets. The IEI
of the RAND IE is 10.
* * *
8 7 6 5 4 3 2 1  
RAND IEI octet 1  
RAND value octet 2
               octet 17
* * *
**Figure 12.5.1.21.1: RAND information element**
**Table 12.5.1.21.1: RAND information element**
+--------------------------------------+ | RAND value (octet 2, 3,... and 17) | | | | The RAND value consists of 128 bits. | +--------------------------------------+
#### 12.5.1.22 UE Security Capabilities
The UE _Security_ Capabilities information element is used to indicate which
security algorithms are supported by the UE.
The UE _Security_ Capabilities information element is coded as shown in figure
12.5.1.22.1 and table 12.5.1.22.1.
The UE _Security Capabilities_ is a type 3 information element with a length
of 3 octets. The IEI of the UE _Security Capabilities_ IE is 11.
+--------------------------------+---------+------+------+------+------+------+------+---------+ | 8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | | +--------------------------------+---------+------+------+------+------+------+------+---------+ | UE _security capabilities_ IEI | octet 1 | | | | | | | | +--------------------------------+---------+------+------+------+------+------+------+---------+ | EEA0 | 128- | 128- | 128- | EEA4 | EEA5 | EEA6 | EEA7 | octet 2 | | | | | | | | | | | | | EEA1 | EEA2 | EEA3 | | | | | | +--------------------------------+---------+------+------+------+------+------+------+---------+ | EIA0 | 128- | 128- | 128- | EIA4 | EIA5 | EIA6 | EIA7 | octet 3 | | | | | | | | | | | | | EIA1 | EIA2 | EIA3 | | | | | | +--------------------------------+---------+------+------+------+------+------+------+---------+
**Figure 12.5.1.22.1: UE S _ecurity Capabilities_ information element**
**Table 12.5.1.22.1: UE S _ecurity Capabilities_** information element
* * *
EPS encryption algorithms supported (octet 2)
EPS encryption algorithm EEA0 supported (octet 2, bit 8)  
0 EPS encryption algorithm EEA0 not supported 1 EPS encryption algorithm EEA0
supported
EPS encryption algorithm 128-EEA1 supported (octet 2, bit 7)  
0 EPS encryption algorithm 128-EEA1 not supported 1 EPS encryption algorithm
128-EEA1 supported
EPS encryption algorithm 128-EEA2 supported (octet 2, bit 6)  
0 EPS encryption algorithm 128-EEA2 not supported 1 EPS encryption algorithm
128-EEA2 supported
EPS encryption algorithm 128-EEA3 supported (octet 2, bit 5)  
0 EPS encryption algorithm 128-EEA3 not supported 1 EPS encryption algorithm
128-EEA3 supported
EPS encryption algorithm EEA4 supported (octet 2, bit 4)  
0 EPS encryption algorithm EEA4 not supported 1 EPS encryption algorithm EEA4
supported
EPS encryption algorithm EEA5 supported (octet 2, bit 3)  
0 EPS encryption algorithm EEA5 not supported 1 EPS encryption algorithm EEA5
supported
EPS encryption algorithm EEA6 supported (octet 2, bit 2)  
0 EPS encryption algorithm EEA6 not supported 1 EPS encryption algorithm EEA6
supported
EPS encryption algorithm EEA7 supported (octet 1, bit 1)  
0 EPS encryption algorithm EEA7 not supported 1 EPS encryption algorithm EEA7
supported
EPS integrity algorithms supported (octet 3)
EPS integrity algorithm EIA0 supported (octet 3, bit 8)  
0 EPS integrity algorithm EIA0 not supported 1 EPS integrity algorithm EIA0
supported
EPS integrity algorithm 128-EIA1 supported (octet 3, bit 7)  
0 EPS integrity algorithm 128-EIA1 not supported 1 EPS integrity algorithm
128-EIA1 supported
EPS integrity algorithm 128-EIA2 supported (octet 3, bit 6)  
0 EPS integrity algorithm 128-EIA2 not supported 1 EPS integrity algorithm
128-EIA2 supported
EPS integrity algorithm 128-EIA3 supported (octet 3, bit 5)  
0 EPS integrity algorithm 128-EIA3 not supported 1 EPS integrity algorithm
128-EIA3 supported
EPS integrity algorithm EIA4 supported (octet 3, bit 4)  
0 EPS integrity algorithm EIA4 not supported 1 EPS integrity algorithm EIA4
supported
EPS integrity algorithm EIA5 supported (octet 3, bit 3)  
0 EPS integrity algorithm EIA5 not supported 1 EPS integrity algorithm EIA5
supported
EPS integrity algorithm EIA6 supported (octet 3, bit 2)  
0 EPS integrity algorithm EIA6 not supported 1 EPS integrity algorithm EIA6
supported
EPS integrity algorithm EIA7 supported (octet 3, bit 1)  
0 EPS integrity algorithm EIA7 not supported 1 EPS integrity algorithm EIA7
supported
* * *
#### 12.5.1.23 Chosen Algorithms
The purpose of the Chosen Algorithms information element is to indicate the
algorithms to be used for ciphering and integrity protection.
The Chosen Algorithms information element is coded as shown in figure
12.5.1.23.1 and table 12.5.1.23.1.
The Chosen Algorithms is a type 3 information element with a length of 2
octets. The IEI of the Chosen Algorithms IE is 12.
+----------+----------+-------+----------+---------+---+---+---+---+ | 8 | 7 | 6 | 5 | 4 | 3 | 2 | 1 | | +----------+----------+-------+----------+---------+---+---+---+---+ | Chosen | octet 1 | | | | | | | | | Al | | | | | | | | | | gorithms | | | | | | | | | | IEI | | | | | | | | | +----------+----------+-------+----------+---------+---+---+---+---+ | 0 | Type of | 0 | Type of | octet 2 | | | | | | | c | | i | | | | | | | spare | iphering | spare | ntegrity | | | | | | | | a | | pr | | | | | | | | lgorithm | | otection | | | | | | | | | | a | | | | | | | | | | lgorithm | | | | | | +----------+----------+-------+----------+---------+---+---+---+---+
**Figure 12.5.1.23.1: Chosen Algorithms information element**
**Table 12.5.1.23.1: Chosen Algorithms** information element
* * *
Type of integrity protection algorithm (octet 2, bit 1 to 3)  
Bits  
**3** **2** **1**  
0 0 0 EPS integrity algorithm EIA0 (null integrity protection algorithm) 0 0 1
EPS integrity algorithm 128-EIA1 0 1 0 EPS integrity algorithm 128-EIA2 0 1 1
EPS integrity algorithm 128-EIA3 1 0 0 EPS integrity algorithm EIA4 1 0 1 EPS
integrity algorithm EIA5 1 1 0 EPS integrity algorithm EIA6 1 1 1 EPS
integrity algorithm EIA7
Type of ciphering algorithm (octet 2, bit 5 to 7)  
Bits  
**7** **6** **5**  
0 0 0 EPS encryption algorithm EEA0 (null ciphering algorithm) 0 0 1 EPS
encryption algorithm 128-EEA1 0 1 0 EPS encryption algorithm 128-EEA2 0 1 1
EPS encryption algorithm 128-EEA3 1 0 0 EPS encryption algorithm EEA4 1 0 1
EPS encryption algorithm EEA5 1 1 0 EPS encryption algorithm EEA6 1 1 1 EPS
encryption algorithm EEA7
Bit 4 and 8 of octet 2 are spare and shall be coded as zero.
* * *
#### 12.5.1.24 LSB of K~D-sess~ ID
The purpose of the LSB of K~D-sess~ ID information element is to carry the 8
least significant bits of the K~D-sess~ ID.
The LSB of K~D-sess~ ID IE is a type 3 information element, with a length of 2
octets. The IEI of the LSB of K~D-sess~ ID IE is 13.
The LSB of K~D-sess~ ID information element is coded as shown in figure
12.5.1.24.1 and table 12.5.1.24.1.
* * *
8 7 6 5 4 3 2 1  
LSB of K~D-sess~ ID IEI octet 1  
LSB of K~D-sess~ ID Content octet 2
* * *
Figure 12.5.1.24.1: LSB of K~D-sess~ ID information element
Table12.5.1.24.1: LSB of K~D-sess~ ID information element
+-------------------------------------------------------------+ | LSB of K~D-sess~ ID value (octet 2) | | | | This contains the 8 least significant bits of K~D-sess~ ID. | +-------------------------------------------------------------+
#### 12.5.1.25 MSB of K~D-sess~ ID
The purpose of the MSB of K~D-sess~ ID information element is to carry the 8
most significant bits of the K~D-sess~ ID.
The MSB of K~D-sess~ ID IE is a type 3 information element, with a length of 2
octets. The IEI of the MSB of K~D-sess~ ID Request Nonce IE is 14.
The MSB of K~D-sess~ ID information element is coded as shown in figure
12.5.1.25.1 and table 12.5.1.25.1.
* * *
8 7 6 5 4 3 2 1  
MSB of K~D-sess~ ID IEI octet 1  
MSB of K~D-sess~ ID Content octet 2
* * *
Figure 12.5.1.25.1: MSB of K~D-sess~ ID information element
Table12.5.1.25.1: MSB of K~D-sess~ ID information element
+------------------------------------------------------------+ | MSB of K~D-sess~ ID value (octet 2) | | | | This contains the 8 most significant bits of K~D-sess~ ID. | +------------------------------------------------------------+
#### 12.5.1.26 LSB of K~D~ ID
The purpose of the LSD of K~D~ ID information element is to carry the 16 least
significant bits of the K~D~ ID.
The LSB of K~D~ ID IE is a type 3 information element, with a length of 3
octets. The IEI of the LSB of K~D~ ID is 15.
The LSB of K~D~ ID information element is coded as shown in figure 12.5.1.26.1
and table 12.5.1.26.1.
* * *
8 7 6 5 4 3 2 1  
LSD of K~D~ ID IEI octet 1  
LSB of K~D~ ID Content octet 2  
octet 3
* * *
Figure 12.5.1.26.1: LSB of K~D~ ID information element
Table12.5.1.26.1: LSB of K~D~ ID information element
+---------------------------------------------------------+ | LSB of K~D~ ID value (octet 2 to 3) | | | | This contains the 16 least significant bits of K~D~ ID. | +---------------------------------------------------------+
#### 12.5.1.27 MSB of K~D~ ID
The purpose of the MSB of K~D~ ID information element is to carry the 16 most
significant bits of the K~D~ ID.
The MSB of K~D~ ID IE is a type 3 information element, with a length of 3
octets. The IEI of the MSB of K~D~ ID IE is 16.
The MSB of K~D~ ID information element is coded as shown in figure 12.5.1.27.1
and table 12.5.1.27.1.
* * *
8 7 6 5 4 3 2 1  
MSD of K~D~ ID IEI octet 1  
MSB of K~D~ ID Content octet 2  
octet 3
* * *
Figure 12.5.1.27.1: MSB of K~D~ ID information element
Table12.5.1.27.1: MSB of K~D~ ID information element
+--------------------------------------------------------+ | MSB of K~D~ ID value (octet 2 to 3) | | | | This contains the 16 most significant bits of K~D~ ID. | +--------------------------------------------------------+
#### 12.5.1.28 K~D~ ID
The purpose of the K~D~ ID information element is to carry the identity of the
K~D~ held by a UE.
The K~D~ ID IE is a type 3 information element, with a length of 5 octets. The
IEI of the K~D~ ID IE is 17.
The K~D~ ID information element is coded as shown in figure 12.5.1.28.1 and
table 12.5.1.28.1.
* * *
8 7 6 5 4 3 2 1  
K~D~ ID IEI octet 1  
K~D~ ID Content octet 2  
octet 5
* * *
Figure 12.5.1.28.1: K~D~ ID information element
Table12.5.1.28.1: K~D~ ID information element
+------------------------------------------------+ | K~D~ ID value (octet 2 to 5) | | | | This contains the 32-bit identifier of a K~D~. | +------------------------------------------------+
#### 12.5.1.29 K~D~ Freshness
The purpose of the K~D~ Freshness information element is to indicate the nonce
value generated by initiating PKMF to ensure that any calculated K~D~ is
fresh.
The K~D~ Freshness parameter IE is a type 3 information element, with a length
of 17 octets. The IEI of the K~D~ Freshness IE is 18.
The K~D~ Freshness parameter information element is coded as shown in figure
12.5.1.29.1 and table 12.5.1.29.1.
* * *
8 7 6 5 4 3 2 1  
K~D~ Freshness IEI octet 1  
K~D~ Freshness Content octet 2  
octet 17
* * *
Figure 12.5.1.29.1: K~D~ Freshness information element
Table12.5.1.29.1: K~D~ Freshness information element
+----------------------------------------+ | K~D~ Freshness value (octet 2 to 17) | | | | This contains the 128-bit nonce value. | +----------------------------------------+
#### 12.5.1.30 Nonce_1
The purpose of the Nonce_1 information element is to indicate the nonce value
generated by the UE which initiated the direct link setup procedure or direct
link rekeying procedure.
The Nonce_1 IE is a type 3 information element, with a length of 17 octets.
The IEI of the Nonce_1 IE is 19.
The Nonce_1 information element is coded as shown in figure 12.5.1.30.1 and
table 12.5.1.30.1.
* * *
8 7 6 5 4 3 2 1  
Nonce_1 IEI octet 1  
Nonce_1 Content octet 2  
octet 17
* * *
Figure 12.5.1.30.1: Nonce_1 information element
Table12.5.1.30.1: Nonce_1 information element
+----------------------------------------+ | Nonce1 value (octet 2 to 17) | | | | This contains the 128-bit nonce value. | +----------------------------------------+
#### 12.5.1.31 Nonce_2
The purpose of the Nonce_2 information element is to indicate the nonce value
generated by the UE which initiated the direct security mode control
procedure.
The Nonce_2 IE is a type 3 information element, with a length of 17 octets.
The IEI of the Nonce_2 IE is 20.
The Nonce_2 information element is coded as shown in figure 12.5.1.31.1 and
table 12.5.1.31.1.
* * *
8 7 6 5 4 3 2 1  
Nonce_2 IEI octet 1  
Nonce_2 Content octet 2  
octet 17
* * *
Figure 12.5.1.31.1: Nonce_2 information element
Table12.5.1.31.1: Nonce_2 information element
+----------------------------------------+ | Nonce_2 value (octet 2 to 17) | | | | This contains the 128-bit nonce value. | +----------------------------------------+
#### 12.5.1.32 Auth Flag
The purpose of the Auth Flag information element is to indicate that the K~D~
is to be refreshed..
The Auth Flag IE is a type 3 information element, with a length of 2 octets.
The IEI of the Auth Flag IE is 21.
The Auth Flag information element is coded as shown in figure 12.5.1.32.1 and
table 12.5.1.32.1.
* * *
8 7 6 5 4 3 2 1  
Auth Flag IEI octet 1  
Auth Flag Content octet 2
* * *
Figure 12.5.1.32.1: Auth Flag information element
Table12.5.1.32.1: Auth Flag information element
* * *
Auth Flag value (octet 2)  
Bits  
1  
0 Reserved 1 K~D~ is requested to be refreshed
Bit 2 to 8 of octet 2 are spare and shall be coded as zero.
* * *
#### 12.5.1.33 Signature
The purpose of the Signature information element is to indicate the ECCSI
signature calculated based on information exchanged during the direct link
setup.
The Signature IE is a type 3 information element, with a length of 130 octets.
The IEI of the Signature IE is 22.
The Signature information element is coded as shown in figure 12.5.1.33.1 and
table 12.5.1.33.1.
* * *
8 7 6 5 4 3 2 1  
Signature IEI octet 1  
Signature Content octet 2  
octet 130
* * *
Figure 12.5.1.33.1: Signature information element
Table12.5.1.33.1: Signature information element
+----------------------------------------------------------------------+ | Signature value (octet 2 to 130) | | | | This contains the signature with a length of 129 octets. The exact | | content structure is specified in 3GPP TS 33.303 [6]. | +----------------------------------------------------------------------+
#### 12.5.1.34 Encrypted Payload
The purpose of the Encrypted Payload information element is to indicate the
encrypted data encapsulating the shared secret key to be used for the
established link.
The Encrypted Payload IE is a type 4 information element, with a variable
length. The IEI of the Encrypted Payload IE is 23.
The Encrypted Payload information element is coded as shown in figure
12.5.1.34.1 and table 12.5.1.34.1.
* * *
8 7 6 5 4 3 2 1  
Encrypted Payload IEI octet 1  
Length Encrypted Payload octet 2  
Encrypted Payload Content octet 3  
octet n
* * *
Figure 12.5.1.34.1: Encrypted Payload information element
Table12.5.1.34.1: Encrypted Payload information element
+----------------------------------------------------------------------+ | Encrypted Payload value (octet 3 to n) | | | | This contains the encrypted data content with a variable length. The | | exact content structure is specified in 3GPP TS 33.303 [6]. | +----------------------------------------------------------------------+
#### 12.5.1.35 Remote UE Information Type
The purpose of the Remote UE Information Type element is to indicate the type
of information requested regarding the remote UE.
The Remote UE Information Type IE is a type 3 information element, with a
length of 2 bytes. The IEI of the Remote UE Information Type IE is 26.
The Remote UE Information Type information element is coded as shown in figure
12.5.1.35.1 and table 12.5.1.35.1.
* * *
8 7 6 5 4 3 2 1  
Remote UE Information Type IEI octet 1  
Remote UE Information Type Content octet 2
* * *
Figure 12.5.1.35.1: Remote UE Information Type information element
Table 12.5.1.35.1: Remote UE Information Type information element
* * *
Bits  
8 7 6 5 4 3 2 1  
0 0 0 0 0 0 0 1 IMEI 0 0 0 0 0 0 1 0 IMEISV
All other values are reserved
* * *
#### 12.5.1.36 IMEI
The purpose of the IMEI information element is to indicate the IMEI or IMEISV
of a UE.
The IMEI IE is a type 3 information element, with a length of 10 bytes,
depending on the IMEI type. The IEI of the IMEI IE is 27.
The IMEI information element is coded as shown in figure 12.5.1.36.1 and table
12.5.1.36.1.
* * *
8 7 6 5 4 3 2 1
IMEI IEI octet 1
Digit 1 odd/\ IMEI Type octet 2  
even
Digit p+1 Digit p octet 3
...
              octet 10
* * *
Figure 12.5.1.36.1: IMEI information element
Table 12.5.1.36.1: IMEI information element
+-----------------------------+---+---+-----------------------------+ | IMEI Content (octet 2- | | | | | octet 10) | | | | +-----------------------------+---+---+-----------------------------+ | Odd/even indication (octet | | | | | 2) | | | | | | | | | | Bit | | | | +-----------------------------+---+---+-----------------------------+ | 4 | | | | +-----------------------------+---+---+-----------------------------+ | 0 | | | even number of IMEI | | | | | identity digits | +-----------------------------+---+---+-----------------------------+ | 1 | | | odd number of IMEI identity | | | | | digits | +-----------------------------+---+---+-----------------------------+ | | | | | +-----------------------------+---+---+-----------------------------+ | IMEI Type (octet 2) | | | | | | | | | | Bits | | | | +-----------------------------+---+---+-----------------------------+ | 3 | 2 | 1 | | +-----------------------------+---+---+-----------------------------+ | 1 | 0 | 0 | IMEI | +-----------------------------+---+---+-----------------------------+ | 1 | 0 | 1 | IMEISV | +-----------------------------+---+---+-----------------------------+ | All other values are | | | | | reserved. | | | | +-----------------------------+---+---+-----------------------------+ | | | | | +-----------------------------+---+---+-----------------------------+ | IMEI Identity digits (octet | | | | | 2 etc) | | | | +-----------------------------+---+---+-----------------------------+ | For the IMEI, this field is | | | | | coded using BCD coding from | | | | | octet 2 to octet 9. Octet | | | | | 10 shall be filled with | | | | | \"11111111\" and ignored on | | | | | reception. The format of | | | | | the IMEI is described in | | | | | 3GPP TS 23.003 [4]. | | | | +-----------------------------+---+---+-----------------------------+ | | | | | +-----------------------------+---+---+-----------------------------+ | For the IMEISV, this field | | | | | is coded using BCD coding | | | | | from octet 2 to octet 10. | | | | | Bits 5 to 8 of Octet 10 | | | | | shall be filled with an end | | | | | mark coded as \"1111\". The | | | | | format of the IMEISV is | | | | | described in | | | | | 3GPP TS 23.003 [4]. | | | | +-----------------------------+---+---+-----------------------------+ | | | | | +-----------------------------+---+---+-----------------------------+ | | | | | +-----------------------------+---+---+-----------------------------+
# 13 List of system parameters
## 13.1 General
The description of timers in table 13.2.1 and table 13.2.2 should be
considered a brief summary. The complete descriptions of the timers are in the
procedures defined in subclause 5 and subclause 6.
## 13.2 Timers of ProSe direct services procedures
Table 13.2.1: ProSe direct services timers -- UE side
+-------------+-------------+-------------+-------------+-------------+ | TIMER NUM. | TIMER VALUE | CAUSE OF | NORMAL STOP | ON\ | | | | START | | EXPIRY | +-------------+-------------+-------------+-------------+-------------+ | T4000 | NOTE 1 | Upon | Upon | Stop | | | | receiving a | receiving a | announcing | | | | ProSe | new T4000 | the | | | | Application | timer value | associated | | | | Code with | for the | ProSe | | | | an | same ProSe | Application | | | | associated | Application | Code over | | | | T4000 timer | Code or | the PC5 | | | | in a | receiving a | interface | | | | DISCOVER | new Timer | and | | | | Y_RESPONSE | associated | re-initiate | | | | message | with a new | the | | | | whose | ProSe | announce | | | | transaction | Application | request | | | | ID | Code for | procedure | | | | contained | the same | if the | | | | in the | ProSe | request | | | | \ | ID in a | layers to | | | | element | DISCOVER | announce | | | | matches the | Y_RESPONSE | the ProSe | | | | value sent | message. | Application | | | | by the UE | | ID | | | | in a | When the UE | co | | | | DISCOVE | selects a | rresponding | | | | RY_REQUEST | new PLMN. | to the | | | | message | | associated | | | | with the | Upon | ProSe | | | | command set | receiving a | Application | | | | to | \ | place. | | | | as | element in | | | | | described | a | | | | | in | DISC | | | | | subclau | OVERY_UPDA | | | | | se 6.2.2.4. | TE_REQUEST | | | | | | message and | | | | | Upon | the | | | | | receiving a | Discovery | | | | | ProSe | Entry ID in | | | | | Application | the | | | | | Code with | \ | | | | | T4000 timer | element is | | | | | in the | known, as | | | | | Update Info | described | | | | | in the | in | | | | | \ | | | | | | element in | | | | | | a | | | | | | DISC | | | | | | OVERY_UPDA | | | | | | TE_REQUEST | | | | | | message and | | | | | | the | | | | | | Discovery | | | | | | Entry ID in | | | | | | the | | | | | | \ | | | | | | element is | | | | | | known, as | | | | | | described | | | | | | in | | | | | | subclau | | | | | | se 6.2.7.3. | | | +-------------+-------------+-------------+-------------+-------------+ | T4002 | NOTE 2 | Upon | Upon | Stop using | | | | receiving a | receiving a | the | | | | Discovery | new T4002 | associated | | | | Filter with | timer value | Discovery | | | | an | for the | Filter for | | | | associated | same | ProSe | | | | T4002 timer | Discovery | direct | | | | in a | Filter in a | discovery | | | | DISCOVER | DISCOVER | monitoring | | | | Y_RESPONSE | Y_RESPONSE | over the | | | | message | message. | PC5 | | | | whose | | interface | | | | transaction | Upon | and | | | | ID | receiving a | re-initiate | | | | contained | \ | procedure, | | | | e-monitor> | element in | if the | | | | element | a | request | | | | matches the | DISC | from upper | | | | value sent | OVERY_UPDA | layers to | | | | by the UE | TE_REQUEST | monitor the | | | | in a | message and | ProSe | | | | DISCOVE | the | Application | | | | RY_REQUEST | Discovery | ID | | | | message | Entry ID in | co | | | | with the | the | rresponding | | | | command set | \ | Discovery | | | | "monitor\", | element is | Filter is | | | | as | known, as | still in | | | | described | described | place. | | | | in | in | | | | | subclau | subclau | | | | | se 6.2.3.4. | se 6.2.7.3. | | | | | | | | | | | Upon | | | | | | receiving a | | | | | | Discovery | | | | | | Filter in | | | | | | the Update | | | | | | Info in the | | | | | | \ | | | | | | element in | | | | | | a | | | | | | DISC | | | | | | OVERY_UPDA | | | | | | TE_REQUEST | | | | | | message and | | | | | | the | | | | | | Discovery | | | | | | Entry ID in | | | | | | the | | | | | | \ | | | | | | element is | | | | | | known, as | | | | | | described | | | | | | in | | | | | | subclau | | | | | | se 6.2.7.3. | | | +-------------+-------------+-------------+-------------+-------------+ | T4004 | NOTE 3 | Upon | Upon | The UE may | | | | receiving a | receiving a | inform the | | | | T4004 timer | new T4004 | upper | | | | in a | timer value | layers that | | | | MATCH_ | for the | the | | | | REPORT_ACK | same ProSe | co | | | | message | Application | rresponding | | | | whose | Code in a | ProSe | | | | transaction | MATCH_ | Application | | | | ID | REPORT_ACK | ID is no | | | | contained | message. | longer | | | | in the | | matched. | | | | \ | receiving a | | | | | element | MATCH_ | | | | | matches the | REPORT_ACK | | | | | value sent | message | | | | | by the UE | with a | | | | | in a | \ | | | | | TCH_REPORT | element | | | | | message, as | containing | | | | | described | PC3 Control | | | | | in | Protocol | | | | | subclau | cause value | | | | | se 6.2.4.4. | is #5. | | +-------------+-------------+-------------+-------------+-------------+ | T4005 | NOTE 4 | Upon | When the | Stop the | | | | receiving a | service | monitoring, | | | | monitoring, | au | announcing, | | | | announcing, | thorisation | discoveree, | | | | discoveree | for the | discoverer | | | | operation, | co | or | | | | discoverer | rresponding | co | | | | operation | PLMN is | mmunication | | | | or | revoked by | operation | | | | co | the ProSe | in the | | | | mmunication | Function. | co | | | | policy for | | rresponding | | | | a given | Upon | PLMN and | | | | PLMN with | receiving a | re-initiate | | | | an | new T4005 | the service | | | | associated | timer value | au | | | | T4005 value | for the | thorisation | | | | in the | same | procedure | | | | ProSe | operation | if the UE | | | | service | ( | wants to | | | | au | monitoring, | continue | | | | thorisation | announcing, | performing | | | | as | discoveree | announcing, | | | | described | operation, | monitoring, | | | | in | discoverer | discoveree, | | | | subcl | operation | discoverer | | | | ause 5.1.3. | or | or | | | | | com | co | | | | | munication) | mmunication | | | | | in the same | operation | | | | | PLMN. | in that | | | | | | | | | | | | PLMN. | +-------------+-------------+-------------+-------------+-------------+ | T4006 | NOTE 3 | Upon | Upon | The UE | | | | receiving a | receiving a | needs to | | | | T4006 timer | new T4006 | | | | | in a | timer value | send a | | | | MATCH_ | for the | Match | | | | REPORT_ACK | same ProSe | Report on | | | | message | Application | next | | | | whose | Code in a | instance it | | | | transaction | MATCH_ | detects the | | | | ID | REPORT_ACK | co | | | | contained | message. | rresponding | | | | in the | | ProSe | | | | \ | co | Code. | | | | element | rresponding | | | | | matches the | T4004 timer | | | | | value sent | for the | | | | | by the UE | ProSe | | | | | in a | Application | | | | | MA | Code is | | | | | TCH_REPORT | stopped or | | | | | message, as | expires. | | | | | described | | | | | | in | | | | | | subclau | | | | | | se 6.2.4.4. | | | +-------------+-------------+-------------+-------------+-------------+ | T4007 | NOTE 5 | Upon | Upon | Stop | | | | receiving a | receiving a | announcing | | | | ProSe | new T4007 | the | | | | Restricted | timer value | associated | | | | Code or | for the | ProSe | | | | ProSe | same ProSe | Restricted | | | | Restricted | Restricted | Code over | | | | Code Prefix | Code or | the PC5 | | | | with an | ProSe | interface | | | | associated | Restricted | if the | | | | T4007 timer | Code | ProSe | | | | in a | Prefix, or | Restricted | | | | DISCOVER | upon | Code is | | | | Y_RESPONSE | receiving a | already | | | | message | new T4007 | allocated; | | | | whose | timer | and | | | | transaction | associated | re-initiate | | | | ID | with a new | the | | | | contained | ProSe | announce | | | | in the | Restricted | request | | | | \ | Restricted | request | | | | element | Code Prefix | from upper | | | | matches the | for the | layers to | | | | value sent | same RPAUID | announce | | | | by the UE | in a | the RPAUID | | | | in a | DISCOVER | co | | | | DISCOVE | Y_RESPONSE | rresponding | | | | RY_REQUEST | message. | to the | | | | message | | associated | | | | with the | When the UE | ProSe | | | | command set | selects a | Restricted | | | | to | new PLMN. | Code is | | | | \ | | still in | | | | "announce\" | Upon | place. | | | | and the | receiving a | | | | | Discovery | ProSe | | | | | Type set to | Restricted | | | | | \"Restrict | Code with | | | | | d | an | | | | | iscovery\", | associated | | | | | as | T4007 timer | | | | | described | in the | | | | | in | Update Info | | | | | subclaus | in the | | | | | e 6.2.2A.4. | \ | | | | | receiving a | element in | | | | | ProSe | a | | | | | Restricted | DISC | | | | | Code with | OVERY_UPDA | | | | | an | TE_REQUEST | | | | | associated | message and | | | | | T4007 timer | the | | | | | in the | Discovery | | | | | Update Info | Entry ID in | | | | | in the | the | | | | | \ | e-request> | | | | | element in | element is | | | | | a | known, as | | | | | DISC | described | | | | | OVERY_UPDA | in | | | | | TE_REQUEST | subclau | | | | | message and | se 6.2.6.3. | | | | | the | | | | | | Discovery | | | | | | Entry ID in | | | | | | the | | | | | | \ | | | | | | element is | | | | | | known, as | | | | | | described | | | | | | in | | | | | | subclau | | | | | | se 6.2.6.3. | | | +-------------+-------------+-------------+-------------+-------------+ | T4009 | NOTE 6 | Upon | Upon | Stop using | | | | receiving a | receiving | the | | | | Restricted | one or more | associated | | | | Discovery | new T4009 | Restricted | | | | Filter with | timer | Discovery | | | | an | values for | Filter for | | | | associated | the same | restricted | | | | T4009 timer | discovery | ProSe | | | | in a | entry in a | direct | | | | DISCOVER | DISCOVER | discovery | | | | Y_RESPONSE | Y_RESPONSE | monitoring | | | | message | message. | over the | | | | whose | | PC5 | | | | transaction | Upon | interface | | | | ID | receiving a | and | | | | contained | Restricted | re-initiate | | | | in the | Discovery | the monitor | | | | \ | Info in the | if the | | | | element | \ | layers to | | | | by the UE | element in | monitor the | | | | in a | a | co | | | | DISCOVE | DISC | rresponding | | | | RY_REQUEST | OVERY_UPDA | discovery | | | | message | TE_REQUEST | target is | | | | with the | message and | still in | | | | command set | the | place. | | | | to | Discovery | | | | | \"monitor\" | Entry ID in | | | | | and the | the | | | | | Discovery | \ | | | | | d | element is | | | | | iscovery\", | known, as | | | | | as | described | | | | | described | in | | | | | in | subclau | | | | | subclaus | se 6.2.6.2. | | | | | e 6.2.3A.4. | | | | | | | | | | | | Upon | | | | | | receiving a | | | | | | Restricted | | | | | | Discovery | | | | | | Filter in | | | | | | the Update | | | | | | Info in the | | | | | | \ | | | | | | element in | | | | | | a | | | | | | DISC | | | | | | OVERY_UPDA | | | | | | TE_REQUEST | | | | | | message and | | | | | | the | | | | | | Discovery | | | | | | Entry ID in | | | | | | the | | | | | | \ | | | | | | element is | | | | | | known, as | | | | | | described | | | | | | in | | | | | | subclau | | | | | | se 6.2.6.2. | | | +-------------+-------------+-------------+-------------+-------------+ | T4011 | NOTE 7 | Upon | Upon | Stop | | | | receiving a | receiving a | announcing | | | | ProSe | new T4011 | the | | | | Response | timer value | associated | | | | Code and | for the | ProSe | | | | Discovery | same | Response | | | | Query | discovery | Code or | | | | Filters | entry in a | monitoring | | | | with an | DISCOVER | with the | | | | associated | Y_RESPONSE | associated | | | | T4011 timer | message. | Discovery | | | | in a | | Query | | | | DISCOVER | When the UE | Filter(s) | | | | Y_RESPONSE | selects a | over the | | | | message | new PLMN. | PC5 | | | | whose | | interface | | | | transaction | | and | | | | ID | | re-initiate | | | | contained | | the | | | | in the \ element | | request | | | | matches the | | from upper | | | | value sent | | layers to | | | | by the UE | | announce | | | | in a | | the RPAUID | | | | DISCOVE | | in Model B | | | | RY_REQUEST | | is still in | | | | message | | place. | | | | with the | | | | | | command set | | | | | | to | | | | | | \ | | | | | | "response\" | | | | | | and the | | | | | | Discovery | | | | | | Type set to | | | | | | \"Restrict | | | | | | d | | | | | | iscovery\", | | | | | | as | | | | | | described | | | | | | in | | | | | | subclaus | | | | | | e 6.2.2B.4. | | | +-------------+-------------+-------------+-------------+-------------+ | T4013 | NOTE 8 | Upon | Upon | Stop | | | | receiving a | receiving a | announcing | | | | ProSe Query | new T4013 | the | | | | Code and | timer value | associated | | | | Discovery | for the | ProSe Query | | | | Response | same | Code or | | | | Filters | discovery | monitoring | | | | with an | entry in a | with the | | | | associated | DISCOVER | associated | | | | T4013 timer | Y_RESPONSE | Discovery | | | | in a | message. | Response | | | | DISCOVER | | Filter(s) | | | | Y_RESPONSE | | over the | | | | message | | PC5 | | | | whose | | interface | | | | transaction | | and | | | | ID | | re-initiate | | | | contained | | the | | | | in the \ element | | request | | | | matches the | | from upper | | | | value sent | | layers to | | | | by the UE | | query for | | | | in a | | the same | | | | DISCOVE | | targets in | | | | RY_REQUEST | | Model B is | | | | message | | still in | | | | with the | | place. | | | | command set | | | | | | to | | | | | | \"query\" | | | | | | and the | | | | | | Discovery | | | | | | Type set to | | | | | | \"Restrict | | | | | | d | | | | | | iscovery\", | | | | | | as | | | | | | described | | | | | | in | | | | | | subclaus | | | | | | e 6.2.3B.4. | | | +-------------+-------------+-------------+-------------+-------------+ | T4015 | NOTE 4 | Upon | Upon | Stop | | | | receiving a | receiving a | performing | | | | ProSe | new ProSe | ProSe | | | | Discovery | Discovery | restricted | | | | UE ID with | UE ID. | discovery | | | | an | | and | | | | associated | | re-initiate | | | | T4015 value | | the service | | | | in the | | au | | | | ProSe | | thorisation | | | | service | | procedure | | | | au | | if the UE | | | | thorisation | | wants to | | | | as | | continue | | | | described | | performing | | | | in | | ProSe | | | | subcl | | restricted | | | | ause 5.1.3. | | discovery. | +-------------+-------------+-------------+-------------+-------------+ | T4016 | NOTE 13 | Upon | Upon | The UE may | | | | receiving a | receiving a | inform the | | | | T4016 timer | new T4016 | upper | | | | in a | timer value | layers that | | | | MATCH_ | for the | the | | | | REPORT_ACK | same ProSe | co | | | | message | Restricted | rresponding | | | | whose | Code or | RPAUID is | | | | transaction | ProSe | no longer | | | | ID | Response | matched. | | | | contained | Code in a | | | | | in the | MATCH_ | | | | | \ | | | | | | element | Upon | | | | | matches the | receiving a | | | | | value sent | MATCH_ | | | | | by the UE | REPORT_ACK | | | | | in a | message | | | | | MATCH_REP | with a | | | | | ORTmessage, | \ | | | | | described | element | | | | | in | containing | | | | | subclau | PC3 Control | | | | | se 6.2.4A.4 | Protocol | | | | | or | cause value | | | | | 6.2.4B.4. | #5. | | +-------------+-------------+-------------+-------------+-------------+ | T4017 | NOTE 13 | Upon | Upon | The UE | | | | receiving a | receiving a | needs to | | | | T4017 timer | new T4017 | | | | | in a | timer value | send a | | | | MATCH_ | for the | Match | | | | REPORT_ACK | same ProSe | Report on | | | | message | Restricted | next | | | | whose | Code or | instance it | | | | transaction | ProSe | detects the | | | | ID | Response | co | | | | contained | Code in a | rresponding | | | | in the | MATCH_ | ProSe | | | | \ | | ProSe | | | | element | When the | Response | | | | matches the | co | Code. | | | | value sent | rresponding | | | | | by the UE | T4016 timer | | | | | in a | for the | | | | | MATCH_REP | ProSe | | | | | ORTmessage, | Restricted | | | | | as | Code or | | | | | described | ProSe | | | | | in | Response | | | | | subclaus | Code is | | | | | e 6.2.4A.4. | stopped or | | | | | | expires. | | +-------------+-------------+-------------+-------------+-------------+ | T4100 | | Upon | Upon | Ret | | | | sending a | receiving a | ransmission | | | | DIRECT_ | DIRECT\ | of | | | | COMMUNICATI | _COMMUNICAT | DIRECT | | | | ON_REQUEST | ION_ACCEPT | _COMMUNICA | | | | message | or | TION_SETUP | | | | | DIRECT\ | message | | | | | _COMMUNICAT | | | | | | ION_REJECT | | | | | | message | | | | | | from the | | | | | | target UE | | +-------------+-------------+-------------+-------------+-------------+ | T4101 | | DIRECT_CO | Upon | Ret | | | | MMUNICATION | Receiving a | ransmission | | | | _KEEPALIVE | DIRE | of | | | | message | CT_COMMUNI | DIRECT_CO | | | | sent | CATION_KEE | MMUNICATION | | | | | PALIVE_ACK | _KEEPALIVE | | | | | message or | message | | | | | other PC5 | | | | | | Signaling | | | | | | message or | | | | | | user data | | | | | | from the | | | | | | peer UE | | +-------------+-------------+-------------+-------------+-------------+ | T4102 | | Upon | Upon | Send a | | | | Receiving a | receiving | DIRECT_CO | | | | DIRE | an upper | MMUNICATION | | | | CT_COMMUNI | layer | _KEEPALIVE | | | | CATION_KEE | request to | message | | | | PALIVE_ACK | check | | | | | message, or | whether the | | | | | other PC5 | direct link | | | | | Signaling | is alive | | | | | message, or | and sending | | | | | any user | out a | | | | | data from | DIRECT_CO | | | | | the peer UE | MMUNICATION | | | | | | _KEEPALIVE | | | | | | message | | +-------------+-------------+-------------+-------------+-------------+ | T4103 | | Upon | Upon | Stop using | | | | sending a | receiving a | the | | | | DIRECT_ | DIREC | co | | | | COMMUNICATI | T_COMMUNIC | rresponding | | | | ON_RELEASE | ATION_RELE | direct link | | | | message | ASE_ACCEPT | for | | | | | message | one-to-one | | | | | from the | co | | | | | peer UE. | mmunication | +-------------+-------------+-------------+-------------+-------------+ | T4104 | NOTE 9 | Upon | Upon | Re-initiate | | | | receiving a | receiving | the TMGI | | | | ProSe | one or more | monitoring | | | | Layer2 | new T4104 | request | | | | Group ID | timer | procedure, | | | | with an | values for | if the | | | | associated | the same | request | | | | T4104 timer | ProSe | from upper | | | | in a | Layer2 | layers to | | | | TMGI | Group ID in | receive the | | | | _MONITORIN | a | MBMS | | | | G_RESPONSE | TMGI | content for | | | | message, as | _MONITORIN | the given | | | | described | G_RESPONSE | TMGI is | | | | in | message. | still in | | | | subc | | place. | | | | lause 10.5. | | | +-------------+-------------+-------------+-------------+-------------+ | T4105 | NOTE 10 | Upon | Upon | Delete the | | | | assigning a | sending a | associated | | | | ProSe | new | TMGI and | | | | Layer2 | TMGI | MBMS SAI | | | | Group ID | _MONITORIN | list. | | | | with an | G_RESPONSE | | | | | associated | for the | | | | | T4104 value | same TMGI. | | | | | to the | | | | | | remote UE, | | | | | | as | | | | | | described | | | | | | in | | | | | | subc | | | | | | lause 10.5. | | | +-------------+-------------+-------------+-------------+-------------+ | T4106 | NOTE 11 | Upon | Upon | Re-initiate | | | | receiving a | receiving | the cell ID | | | | T4106 value | one or more | a | | | | in a | new T4106 | nnouncement | | | | CELL_ID_ | timer | request | | | | ANNOUNCEMEN | values in a | procedure, | | | | T_RESPONSE | CELL_ID_ | if the | | | | message as | ANNOUNCEMEN | upper layer | | | | described | T_RESPONSE | application | | | | in | message. | still needs | | | | subc | | to obtain | | | | lause 10.6. | | ECGI of the | | | | | | cell | | | | | | serving the | | | | | | ProSe | | | | | | UE | | | | | | -to-network | | | | | | relay. | +-------------+-------------+-------------+-------------+-------------+ | T4107 | NOTE 12 | Upon | Upon | Stop the | | | | sending a | sending a | cell ID | | | | CELL_ID_ | new | a | | | | ANNOUNCEMEN | CELL_ID_ | nnouncement | | | | T_RESPONSE | ANNOUNCEMEN | in the | | | | message as | T_RESPONSE | PC5 | | | | described | message. | _DISCOVERY | | | | in | | message for | | | | subc | | Relay | | | | lause 10.6. | | Discovery | | | | | | Additional | | | | | | I | | | | | | nformation. | +-------------+-------------+-------------+-------------+-------------+ | T4108 | | Upon | Upon | Either | | | | receiving a | sending or | initiate | | | | Maximum | receiving a | the direct | | | | Inactivity | PC5 | link | | | | Period IE | Signaling | keepalive | | | | in | message or | procedure | | | | DIRECT_CO | user data | or direct | | | | MMUNICATION | over the | link | | | | _KEEPALIVE | direct link | release | | | | message; or | | procedure. | | | | when the UE | | | | | | has no more | | | | | | message or | | | | | | user data | | | | | | to send | | | | | | over the | | | | | | direct | | | | | | link. | | | +-------------+-------------+-------------+-------------+-------------+ | T4109 | | Upon | Upon | Ret | | | | sending the | Receiving | ransmission | | | | PC5 | _the_ | the | | | | _DISCOVERY | PC5 | PC5 | | | | message for | _DISCOVERY | _DISCOVERY | | | | UE | message for | message for | | | | -to-Network | UE | UE | | | | Relay | -to-Network | -to-Network | | | | Discovery | Relay | Relay | | | | S | Discovery | Discovery | | | | olicitation | Response | So | | | | used to | from the | licitation, | | | | trigger the | ProSe | | | | | PC5 | UE | | | | | _DISCOVERY | -to-network | | | | | message | relay UE | | | | | signal | with which | | | | | strength | the UE has | | | | | measurement | a link | | | | | between the | e | | | | | UE and the | stablished, | | | | | ProSe | | | | | | UE | | | | | | -to-network | | | | | | relay UE | | | | | | with which | | | | | | the UE has | | | | | | a link | | | | | | e | | | | | | stablished. | | | +-------------+-------------+-------------+-------------+-------------+ | T4110 | | Upon | Upon | Send the | | | | Receiving | releasing | PC5 | | | | _the_ | the direct | _DISCOVERY | | | | PC5 | link with a | message for | | | | _DISCOVERY | ProSe | UE | | | | message for | UE | -to-Network | | | | UE | -to-network | Relay | | | | -to-Network | relay UE. | Discovery | | | | Relay | | S | | | | Discovery | | olicitation | | | | Response | | used to | | | | from the | | trigger the | | | | ProSe | | PC5 | | | | UE | | _DISCOVERY | | | | -to-network | | message | | | | relay UE | | signal | | | | with which | | strength | | | | the UE has | | measurement | | | | a link | | between the | | | | e | | UE and the | | | | stablished, | | ProSe | | | | | | UE | | | | | | -to-network | | | | | | relay UE | | | | | | with which | | | | | | the UE has | | | | | | a link | | | | | | e | | | | | | stablished, | +-------------+-------------+-------------+-------------+-------------+ | T4111 | | Upon | Upon | Sending a | | | | sending a | receiving | DIRECT\ | | | | DIRECT_S | the | _COMMUNICAT | | | | ECURITY_MO | DIRECT_SE | ION_REJECT | | | | DE_COMMAND | CURITY_MOD | if the | | | | message. | E_COMPLETE | security | | | | | or | mode | | | | | DIRECT_ | control | | | | | SECURITY_M | procedure | | | | | ODE_REJECT | is | | | | | message. | triggered | | | | | | by the | | | | | | DIRECT_ | | | | | | COMMUNICATI | | | | | | ON_REQUEST | | | | | | message | | | | | | from the | | | | | | peer UE. | +-------------+-------------+-------------+-------------+-------------+ | T4112 | | Upon | Upon | Ret | | | | sending a | receiving | ransmission | | | | DIR | the | of | | | | ECT_REKEYI | DIRE | DIR | | | | NG_REQUEST | CT_REKEYIN | ECT_REKEYI | | | | message. | G_RESPONSE | NG_REQUEST | | | | | message or | message. | | | | | receiving a | | | | | | DIR | | | | | | ECT_REKEYI | | | | | | NG_REQUEST | | | | | | message | | | | | | from the | | | | | | peer UE and | | | | | | satisfying | | | | | | the | | | | | | conditions | | | | | | specified | | | | | | in | | | | | | subcla | | | | | | use 10.4.8. | | +-------------+-------------+-------------+-------------+-------------+ | T4113 | | Upon | Upon | Ret | | | | sending a | receiving | ransmission | | | | DIR | the | of | | | | ECT_REKEYI | DIR | DIR | | | | NG_TRIGGER | ECT_REKEYI | ECT_REKEYI | | | | message. | NG_REQUEST | NG_TRIGGER | | | | | message | message. | | | | | from the | | | | | | remote UE. | | +-------------+-------------+-------------+-------------+-------------+ | NOTE 1: The | | | | | | value of | | | | | | this timer | | | | | | is provided | | | | | | by the | | | | | | ProSe | | | | | | Function | | | | | | during the | | | | | | announce | | | | | | request and | | | | | | discovery | | | | | | update | | | | | | procedure | | | | | | for open | | | | | | ProSe | | | | | | direct | | | | | | discovery. | | | | | | | | | | | | NOTE 2: The | | | | | | value of | | | | | | this timer | | | | | | is provided | | | | | | by the | | | | | | ProSe | | | | | | Function | | | | | | during the | | | | | | monitor | | | | | | request and | | | | | | discovery | | | | | | update | | | | | | procedure | | | | | | for open | | | | | | ProSe | | | | | | direct | | | | | | discovery. | | | | | | | | | | | | NOTE 3: The | | | | | | value of | | | | | | this timer | | | | | | is provided | | | | | | by the | | | | | | ProSe | | | | | | Function | | | | | | during the | | | | | | match | | | | | | report | | | | | | procedure | | | | | | for open | | | | | | ProSe | | | | | | direct | | | | | | discovery. | | | | | | | | | | | | NOTE 4: The | | | | | | value of | | | | | | this timer | | | | | | is provided | | | | | | by the | | | | | | ProSe | | | | | | Function | | | | | | during | | | | | | service | | | | | | au | | | | | | thorisation | | | | | | procedure. | | | | | | | | | | | | NOTE 5: The | | | | | | value of | | | | | | this timer | | | | | | is provided | | | | | | by the | | | | | | ProSe | | | | | | Function | | | | | | during the | | | | | | announce | | | | | | request and | | | | | | discovery | | | | | | update | | | | | | procedure | | | | | | for | | | | | | restricted | | | | | | ProSe | | | | | | direct | | | | | | discovery | | | | | | model A. | | | | | | | | | | | | NOTE 6: The | | | | | | value of | | | | | | this timer | | | | | | is provided | | | | | | by the | | | | | | ProSe | | | | | | Function | | | | | | during the | | | | | | monitor | | | | | | request and | | | | | | discovery | | | | | | update | | | | | | procedure | | | | | | for | | | | | | restricted | | | | | | ProSe | | | | | | direct | | | | | | discovery | | | | | | model A. | | | | | | | | | | | | NOTE 7: The | | | | | | value of | | | | | | this timer | | | | | | is assigned | | | | | | by the | | | | | | ProSe | | | | | | Function | | | | | | during the | | | | | | discoveree | | | | | | request | | | | | | procedure | | | | | | for | | | | | | restricted | | | | | | ProSe | | | | | | direct | | | | | | discovery | | | | | | model B. | | | | | | | | | | | | NOTE 8: The | | | | | | value of | | | | | | this timer | | | | | | is assigned | | | | | | by the | | | | | | ProSe | | | | | | Function | | | | | | during the | | | | | | discoverer | | | | | | request | | | | | | procedure | | | | | | for | | | | | | restricted | | | | | | ProSe | | | | | | direct | | | | | | discovery | | | | | | model B. | | | | | | | | | | | | NOTE 9: The | | | | | | value of | | | | | | this timer | | | | | | is provided | | | | | | by the | | | | | | ProSe | | | | | | UE | | | | | | -to-network | | | | | | relay UE | | | | | | during the | | | | | | TMGI | | | | | | monitoring | | | | | | request | | | | | | procedure. | | | | | | | | | | | | NOTE 10: | | | | | | The value | | | | | | of this | | | | | | timer is | | | | | | assigned by | | | | | | the ProSe | | | | | | UE | | | | | | -to-network | | | | | | relay UE | | | | | | during the | | | | | | TMGI | | | | | | monitoring | | | | | | request | | | | | | procedure | | | | | | | | | | | | NOTE 11: | | | | | | The value | | | | | | of this | | | | | | timer is | | | | | | provided by | | | | | | the ProSe | | | | | | UE | | | | | | -to-network | | | | | | relay UE | | | | | | during the | | | | | | cell ID | | | | | | a | | | | | | nnouncement | | | | | | request | | | | | | procedure. | | | | | | | | | | | | NOTE 12: | | | | | | The value | | | | | | of this | | | | | | timer is | | | | | | assigned by | | | | | | the ProSe | | | | | | UE | | | | | | -to-network | | | | | | relay UE | | | | | | during the | | | | | | cell ID | | | | | | a | | | | | | nnouncement | | | | | | request | | | | | | procedure. | | | | | | | | | | | | NOTE 13: | | | | | | The value | | | | | | of this | | | | | | timer is | | | | | | provided by | | | | | | the ProSe | | | | | | Function | | | | | | during the | | | | | | match | | | | | | report | | | | | | procedure | | | | | | for | | | | | | restricted | | | | | | ProSe | | | | | | direct | | | | | | discovery | | | | | | model A or | | | | | | match | | | | | | report | | | | | | procedure | | | | | | for | | | | | | restricted | | | | | | ProSe | | | | | | direct | | | | | | discovery | | | | | | model B. | | | | | +-------------+-------------+-------------+-------------+-------------+
Table 13.2.2: ProSe direct services timers -- ProSe Function side
+-------------+-------------+-------------+-------------+-------------+ | TIMER NUM. | TIMER VALUE | CAUSE OF | NORMAL STOP | ON\ | | | | START | | EXPIRY | +-------------+-------------+-------------+-------------+-------------+ | T4001 | NOTE 1 | Upon | Upon | Delete the | | | | assigning a | receiving a | association | | | | ProSe | new | between the | | | | Application | DISCOVE | UE, the | | | | Code with | RY_REQUEST | requested | | | | an | message | ProSe | | | | associated | from the UE | Application | | | | T4000 value | with the | ID and the | | | | to the UE, | command set | co | | | | as | to | rresponding | | | | described | \ | ProSe | | | | in | "announce\" | Application | | | | subcla | for the | Code | | | | use 6.2.2.3 | same ProSe | allocated | | | | and | Application | by the | | | | subclau | ID. | ProSe | | | | se 6.2.7.2. | | Function. | +-------------+-------------+-------------+-------------+-------------+ | T4003 | NOTE 2 | Upon | Upon | Delete the | | | | assigning a | receiving a | association | | | | Discovery | new | between the | | | | Filter with | DISCOVE | UE, the | | | | an | RY_REQUEST | requested | | | | associated | message | ProSe | | | | T4002 value | from the UE | Application | | | | to the UE, | with the | ID and the | | | | as | command set | co | | | | described | to | rresponding | | | | in | \"monitor\" | Discovery | | | | subcla | for the | Filter | | | | use 6.2.3.3 | same ProSe | allocated | | | | and | Application | by the | | | | subclau | ID | ProSe | | | | se 6.2.7.2. | | Function. | +-------------+-------------+-------------+-------------+-------------+ | T4008 | NOTE 3 | Upon | Upon | Delete the | | | | assigning a | receiving a | association | | | | ProSe | new | between the | | | | Restricted | DISCOVE | UE, the | | | | Code or | RY_REQUEST | RPAUID and | | | | ProSe | message | the | | | | Restricted | from the UE | co | | | | Code Prefix | with the | rresponding | | | | with an | command set | ProSe | | | | associated | to | Restricted | | | | T4007 value | \ | Code or | | | | to the UE, | "announce\" | ProSe | | | | as | for the | Restricted | | | | described | same RPAUID | Code Prefix | | | | in | or | allocated | | | | subclau | discovery | by the | | | | se 6.2.2A.3 | entry ID. | ProSe | | | | and | Set to be | Function. | | | | subclau | the same as | | | | | se 6.2.6.3. | the | | | | | | discovery | | | | | | entry in | | | | | | which this | | | | | | timer is | | | | | | running. | | +-------------+-------------+-------------+-------------+-------------+ | T4010 | NOTE 4 | Upon | Upon | Delete the | | | | assigning a | receiving a | association | | | | Restricted | new | between the | | | | Discovery | DISCOVE | UE, the | | | | Filter with | RY_REQUEST | RPAUID and | | | | an | message | the | | | | associated | from the UE | co | | | | T4009 value | with the | rresponding | | | | to the UE, | command set | Restricted | | | | as | to | Discovery | | | | described | \"monitor\" | Filter | | | | in | and | allocated | | | | subclau | discovery | by the | | | | se 6.2.3A.3 | entry ID | ProSe | | | | and | set to be | Function. | | | | subclau | the same as | | | | | se 6.2.6.2. | the | | | | | | discovery | | | | | | entry in | | | | | | which this | | | | | | timer is | | | | | | running. | | +-------------+-------------+-------------+-------------+-------------+ | T4012 | NOTE 5 | Upon | Upon | Delete the | | | | assigning a | receiving a | discovery | | | | ProSe Query | new | entry in | | | | Code, ProSe | DISCOVE | discoveree | | | | Response | RY_REQUEST | UE context | | | | Code and | message | which | | | | Discovery | from the UE | contains | | | | Query | with the | association | | | | Filter(s) | command set | between the | | | | with an | to | UE, the | | | | associated | \ | RPAUID and | | | | T4011 value | "response\" | the | | | | to the UE, | for the | co | | | | as | same RPAUID | rresponding | | | | described | or | ProSe Query | | | | in | discovery | Code, ProSe | | | | subclaus | entry ID. | Response | | | | e 6.2.2B.3. | Set to be | Code, | | | | | the same as | Discovery | | | | | the | Query | | | | | discovery | Filter(s) | | | | | entry in | allocated | | | | | which this | by the | | | | | timer is | ProSe | | | | | running. | Function. | +-------------+-------------+-------------+-------------+-------------+ | T4014 | NOTE 6 | Upon | Upon | Delete the | | | | retrieving | receiving a | discovery | | | | the ProSe | new | entry in | | | | Query Code, | DISCOVE | discoverer | | | | ProSe | RY_REQUEST | UE context | | | | Response | message | which | | | | Code from | from the UE | contains | | | | discoveree | with the | the | | | | UE context | command set | association | | | | and | to | between the | | | | assigning | \"query\" | UE, the | | | | Discovery | and | RPAUID and | | | | Response | discovery | the | | | | Filter(s) | entry ID | co | | | | with an | set to be | rresponding | | | | associated | the same as | Discovery | | | | T4013 value | the | Response | | | | to the UE, | discovery | Filter(s) | | | | as | entry in | allocated | | | | described | which this | by the | | | | in | timer is | ProSe | | | | subclaus | running. | Function. | | | | e 6.2.3B.3. | | | +-------------+-------------+-------------+-------------+-------------+ | T4018 | NOTE 7 | Upon | Upon | Delete the | | | | assigning a | assigning a | UE context | | | | ProSe | new ProSe | related to | | | | Discovery | Discovery | the | | | | UE ID with | UE ID for | restricted | | | | an | the same | discovery. | | | | associated | UE. | | | | | T4015 value | | | | | | in the | | | | | | ProSe | | | | | | service | | | | | | au | | | | | | thorisation | | | | | | as | | | | | | described | | | | | | in | | | | | | subcl | | | | | | ause 5.1.3. | | | +-------------+-------------+-------------+-------------+-------------+ | NOTE 1: The | | | | | | value of | | | | | | this timer | | | | | | is assigned | | | | | | by the | | | | | | ProSe | | | | | | Function | | | | | | during the | | | | | | announce | | | | | | request and | | | | | | discovery | | | | | | update | | | | | | procedure | | | | | | for open | | | | | | ProSe | | | | | | direct | | | | | | discovery. | | | | | | | | | | | | NOTE 2: The | | | | | | value of | | | | | | this timer | | | | | | is assigned | | | | | | by the | | | | | | ProSe | | | | | | Function | | | | | | during the | | | | | | monitor | | | | | | request and | | | | | | discovery | | | | | | update | | | | | | procedure | | | | | | for open | | | | | | ProSe | | | | | | direct | | | | | | discovery. | | | | | | | | | | | | NOTE 3: The | | | | | | value of | | | | | | this timer | | | | | | is assigned | | | | | | by the | | | | | | ProSe | | | | | | Function | | | | | | during the | | | | | | announce | | | | | | request and | | | | | | discovery | | | | | | update | | | | | | procedure | | | | | | for | | | | | | restricted | | | | | | ProSe | | | | | | direct | | | | | | discovery | | | | | | model A. | | | | | | | | | | | | NOTE 4: The | | | | | | value of | | | | | | this timer | | | | | | is assigned | | | | | | by the | | | | | | ProSe | | | | | | Function | | | | | | during the | | | | | | monitor | | | | | | request and | | | | | | discovery | | | | | | update | | | | | | procedure | | | | | | for | | | | | | restricted | | | | | | ProSe | | | | | | direct | | | | | | discovery | | | | | | model A. | | | | | | | | | | | | NOTE 5: The | | | | | | value of | | | | | | this timer | | | | | | is assigned | | | | | | by the | | | | | | ProSe | | | | | | Function | | | | | | during the | | | | | | discoveree | | | | | | request | | | | | | procedure | | | | | | for | | | | | | restricted | | | | | | ProSe | | | | | | direct | | | | | | discovery | | | | | | model B. | | | | | | | | | | | | NOTE 6: The | | | | | | value of | | | | | | this timer | | | | | | is assigned | | | | | | by the | | | | | | ProSe | | | | | | Function | | | | | | during the | | | | | | discoverer | | | | | | request | | | | | | procedure | | | | | | for | | | | | | restricted | | | | | | ProSe | | | | | | direct | | | | | | discovery | | | | | | model B. | | | | | | | | | | | | NOTE 7: The | | | | | | value of | | | | | | this timer | | | | | | is assigned | | | | | | by the | | | | | | ProSe | | | | | | Function | | | | | | during the | | | | | | service | | | | | | au | | | | | | thorisation | | | | | | procedure. | | | | | +-------------+-------------+-------------+-------------+-------------+
NOTE: Multiple timers T4001, T4003, T4008, T4010, T4012 and T4014 can run
simultaneously in the ProSe Function.
###### ## Annex A (informative): IANA registrations
# A.1 IANA registrations for MIME types
## A.1.1 General
RFC 4288 [26], subclause 9, states the process that applies in case of changes
to the registry of media types. Any changes to the format after the
registration with IANA would invoke this procedure.
## A.1.2 application/3gpp-prose-pc3ch+xml
Your Name:
\
Your Email Address:
\
Media Type Name:
Application
Subtype name:
Vendor Tree -- 3gpp-prose-pc3ch+xml
Required parameters:
None
Optional parameters:
\"charset\" the parameter has identical semantics to the charset parameter of
the \"application/xml\" media type as specified in section 9.1 of IETF RFC
7303.
Encoding considerations:
binary.
Security considerations:
Same as general security considerations for application/xml media type as
specified in section 9.1 of IETF RFC 7303 [25]. The information transported in
this media type does not include active or executable content. Mechanisms for
privacy and integrity protection of protocol parameters exist. Those
mechanisms as well as authentication and further security mechanisms are
described in 3GPP TS 33.303.
This media type does not include provisions for directives that institute
actions on a recipient\'s files or other resources.
This media type does not include provisions for directives that institute
actions that, while not directly harmful to the recipient, may result in
disclosure of information that either facilitates a subsequent attack or else
violates a recipient\'s privacy in any way.
This media type does not employ compression.
Interoperability considerations:
The media type allows for interoperability of messages transmitted over the
PC3ch interface, including those related to transport of the usage information
request of proximity services. The messages are sent between user equipment
and mobile network.
Published specification:
3GPP TS 24.334 (http://www.3gpp.org/ftp/Specs/html-info/24334.htm)
Applications which use this media type:
n/a
Fragment identifier considerations:
The handling in section 5 of IETF RFC 7303 applies.
Restrictions on usage:
None
Provisional registration? (standards tree only):
n/a
Additional information:
1\. Deprecated alias names for this type: n/a
2\. Magic number(s): n/a
3\. File extension(s): n/a
4\. Macintosh File Type Code(s): n/a
5\. Object Identifier(s) or OID(s): n/a
Intended usage:
Common.
Other information/general comment:
The media type is intended to be used in proximity service procedures.
Person to contact for further information:
\- Name: \
\- Email: \
\- Author/Change controller:
i) Author: 3GPP CT1 Working Group/3GPP_TSG_CT_WG1\@LIST.ETSI.ORG
ii) Change controller: \/\
## A.1.3 application/3gpp-prose+xml
Your Name:
\
Your Email Address:
\
Media Type Name:
Application
Subtype name:
Vendor Tree -- 3gpp-prose+xml
Required parameters:
None
Optional parameters:
\"charset\" the parameter has identical semantics to the charset parameter of
the \"application/xml\" media type as specified in section 9.1 of IETF RFC
7303.
Encoding considerations:
binary.
Security considerations:
Same as general security considerations for application/xml media type as
specified in section 9.1 of IETF RFC 7303. The information transported in this
media type does not include active or executable content. Mechanisms for
privacy and integrity protection of protocol parameters exist. Those
mechanisms as well as authentication and further security mechanisms are
described in 3GPP TS 33.303.
This media type does not include provisions for directives that institute
actions on a recipient\'s files or other resources.
This media type does not include provisions for directives that institute
actions that, while not directly harmful to the recipient, may result in
disclosure of information that either facilitates a subsequent attack or else
violates a recipient\'s privacy in any way.
This media type does not employ compression.
Interoperability considerations:
The media type allows for interoperability of messages transmitted for ProSe
over the PC3 interface. The messages are sent between user equipment and
mobile network.
Published specification:
3GPP TS 24.334 (http://www.3gpp.org/ftp/Specs/html-info/24334.htm)
Applications which use this media type:
n/a
Fragment identifier considerations:
The handling in section 5 of IETF RFC 7303 applies.
Restrictions on usage:
None
Provisional registration? (standards tree only):
n/a
Additional information:
1\. Deprecated alias names for this type: n/a
2\. Magic number(s): n/a
3\. File extension(s): n/a
4\. Macintosh File Type Code(s): n/a
5\. Object Identifier(s) or OID(s): n/a
Intended usage:
Common.
Other information/general comment:
The media type is intended to be used in proximity service procedures.
Person to contact for further information:
\- Name: \
\- Email: \
\- Author/Change controller:
i) Author: 3GPP CT1 Working Group/3GPP_TSG_CT_WG1\@LIST.ETSI.ORG
ii) Change controller: \/\
#
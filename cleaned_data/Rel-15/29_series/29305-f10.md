# Foreword
This Technical Specification has been produced by the 3^rd^ Generation
Partnership Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# Introduction
The content of this specification is a part of overall solution to meet the
requirement of the interworking between EPS and the legacy system, mainly for
the interfaces between S4-SGSN/MME and HSS/HLR/EIR.
# 1 Scope
The present document is to specify the InterWorking Functions (IWF)
\- between MAP-based Gr, Gf interfaces and Diameter-based S6a, S6d, S13, S13a
interfaces;
\- between the S6a interface with SMS subscription data on the MME side and
the S6a interface without SMS subscription data plus the MAP-based D interface
for SMS subscription on the HSS side;
\- between MAP-based C for SMS interface and Diameter-based S6c interface;
\- between MAP-based E for SMS interface and Diameter-based SGd interface.
The InterWorking Function between the S6a interface with SMS subscription data
and the S6a interface without SMS subscription data plus the MAP-based D
interface for SMS subscription (S6a/S6a+D) is described in Annex A.
The InterWorking Function between MAP-based C for SMS interface and Diameter-
based S6c interface is described in Annex A.3
The InterWorking Function between MAP-based E for SMS interface and Diameter-
based SGd interface is described in Annex A.2
For each IWF scenario, the present document will specify the mapping of
related procedures and the corresponding parameter handling.
The present document will also specify the related mechanisms for the IWF,
e.g. message routing, user data handling. The other mechanism, such as
security, will also be described in this document as a part of the whole
solution.
If there is no specific indication, the SGSN in the specification refers to a
S4-SGSN which supports S4 interface.
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or nonâ€‘specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
[1] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[2] 3GPP TS 33.401: \"3GPP System Architecture Evolution: Security
Architecture\".
[3] 3GPP TS 23.272: \"Circuit Switched (CS) fallback in Evolved Packet System
(EPS); Stage 2\".
[4] 3GPP TS 23.272: \"Circuit Switched (CS) fallback in Evolved Packet System
(EPS); Stage 2\".
[5] 3GPP TS 29.272: \"Evolved Packet System (EPS); Mobility Management Entity
(MME) and Serving GPRS Support Node (SGSN) related interfaces based on
Diameter protocol\".
[6] 3GPP TS 23.204: \"Support of Short Message Service (SMS) over generic 3GPP
Internet Protocol (IP) access; Stage 2\".
[7] 3GPP TS 23.003: \"Numbering, addressing and identification\".
# 3 Definitions, symbols and abbreviations
## 3.1 Definitions
For the purposes of the present document, the terms and definitions given in
TR 21.905 [1] and the following apply. A term defined in the present document
takes precedence over the definition of the same term, if any, in TR 21.905
[1].
**example:** text used to clarify abstract rules by applying them literally.
## 3.2 Symbols
For the purposes of the present document, the following symbols apply:
\ \
## 3.3 Abbreviations
For the purposes of the present document, the abbreviations given in TR 21.905
[1] and the following apply. An abbreviation defined in the present document
takes precedence over the definition of the same abbreviation, if any, in TR
21.905 [1].
EPS Evolved Packet System
IWF Interworking Function
TAU Tracking Area Update
# 4 Introduction (Informative)
## 4.1 General Description
The interworking scenarios in this specification are described based on
interface mapping.
The stage 2 network deployments for each of the interworking scenarios are
also described.
## 4.2 Scenario One: S6a/S6d - Pre Rel8 Gr interworking scenario with one IWF
### 4.2.1 General Description
This interworking scenario is for S6a/S6d interface based on Diameter and Pre
Rel8 Gr interface based on MAP with one IWF in the path.
This IWF scenario can be an inter PLMN use case.
This IWF scenario can be an intra PLMN use case for operator to do the partly
update of their legacy network.
This interworking scenario is described as below:
Figure 4.2.1-1 S6a/S6d - Pre Rel8 Gr interworking scenario with one IWF
The Pre Rel8 HLR shall be upgraded to support Rel-8 EPS security and Pre Rel8
Gr shall be upgraded to support transfer of Rel-8 security parameters..
### 4.2.2 Network Deployments
This IWF scenario will apply the following network deployment situation:
\- Users of a Pre Rel8 UMTS/GPRS network access into a visited EPS with only
E-UTRAN, which is described as below:
{width="5.759027777777778in" height="3.7916666666666665in"}
Figure 4.2.2-1 IWF Scenario one network deployment: visited EPS with E-UTRAN
only, home Pre Rel8 UMTS/GPRS only
The subscription data for Pre Rel8 Gn/Gp SGSN is downloaded to MME. Mapping of
the subscription data is done on MME. Additional security solution is needed
in which the Pre Rel8 HLR can not be changed.
\- Users of a Pre Rel8 UMTS/GPRS network access into a visited EPS with
E-UTRAN and UTRAN/GERAN, which is described as below:
{width="5.770833333333333in" height="3.795138888888889in"}
Figure 4.2.2-2 IWF Scenario one network deployment: visited EPS with E-UTRAN
and UTRAN/GERAN, home Pre Rel8 UMTS/GPRS only
The subscription data for Pre Rel8 Gn/Gp SGSN is downloaded toSGSN. Mapping of
the subscription data is done on SGSN. Security solution is not needed because
the security mechanism in visited and home network is the same.
## 4.3 Scenario Two: S6a/S6d - Rel8 Gr interworking scenario with one IWF
### 4.3.1 General Description
This interworking scenario is for S6a/S6d interface based on Diameter and Rel8
Gr interface based on MAP with one IWF in the path.
This IWF scenario can be an inter PLMN use case.
This IWF scenario can be an intra PLMN use case for operator to do the partly
update of their legacy network.
This interworking scenario is described as below:
Figure 4.3.1-1 S6a/S6d - Rel8 Gr interworking scenario with one IWF
### 4.3.2 Network Deployments
This IWF scenario will apply the following network deployment situation:
\- Users of a Rel8 UMTS/GPRS network access into a visited EPS with only
E-UTRAN, which is described as below:
{width="5.759027777777778in" height="3.7916666666666665in"}
Figure 4.3.2-1 IWF Scenario two network deployment: visited EPS with E-UTRAN
only, home Rel8 UMTS/GPRS only
The subscription data for Rel8 Gn/Gp SGSN is downloaded to MME. Mapping of the
subscription data is done on MME. Additional security solution is needed in
which the Pre Rel8 HLR can be changed.
\- Users of a Rel8 UMTS/GPRS network access into a visited EPS with E-UTRAN
and UTRAN/GERAN, which is described as below:
{width="5.78125in" height="3.8020833333333335in"}
Figure 4.3.2-2 IWF Scenario two network deployment: visited EPS with E-UTRAN
and UTRAN/GERAN, home Rel8 UMTS/GPRS only
The subscription data for Rel8 Gn/Gp SGSN is downloaded to SGSN. Mapping of
the subscription data is done on SGSN. Security solution is not needed because
the security mechanism in visited and home network is the same.
\- Users of a Pre Rel8 UMTS/GPRS/E-UTRAN network access into a visited EPS
with E-UTRAN and UTRAN/GERAN, which is described as below:
{width="6.0in" height="3.5in"}
Figure 4.3.2-3 IWF Scenario two network deployment: visited EPS with E-UTRAN
and UTRAN/GERAN, home EPS with E-UTRAN only and Pre Rel8 UMTS/GPRS
The subscription data for Pre Rel8 Gn/Gp SGSN and the subscription data for
MME is downloaded to SGSN. Mapping of the subscription data is done on SGSN.
Security solution is not needed because the security mechanism in visited and
home network is the same.
## 4.4 Scenario Three: S6a/S6d - S6a/S6d interworking scenario with two IWFs
### 4.4.1 General Description
This interworking scenario is for S6a/S6d interface based on Diameter, S6a/S6d
interface based on Diameter and SS7/MAP based roaming agreement with two IWFs
in the path.
With this interworking scenario, two EPS operators can reuse the SS7 based
roaming agreement.
**This IWF scenario can only be an inter PLMN use case in which the two IWFs
are in the VPLMN and HPLMN separately.**
This interworking scenario is described as below:
Figure 4.4.1-1 S6a/S6d - S6a/S6d interworking scenario with two IWFs
### 4.4.2 Network Deployments
This IWF scenario will apply the following network deployment situation:
\- Users of a Pre Rel8 UMTS/GPRS/EPS for UTRAN/GERAN and E-UTRAN network
access into a visited EPS with only E-UTRAN, which is described as below:
{width="6.0in" height="3.4895833333333335in"}
Figure 4.4.2-1 IWF Scenario three network deployment: visited EPS with E-UTRAN
only, home EPS with E-UTRAN and UTRAN/GERAN and Pre Rel8 UMTS/GPRS
The subscription data for Pre Rel8 Gn/Gp SGSN, subscription data for SGSN and
the subscription data for MME is downloaded to MME. MME picks up the
subscription data for MME and discards the subscription data for Pre Rel8
UMTS/GPRS and the subscription data for SGSN.
\- Users of a Pre Rel8 UMTS/GPRS/EPS for UTRAN/GERAN and E-UTRAN network
access into a visited EPS with E-UTRAN and UTRAN/GERAN, which is described as
below:
{width="6.0in" height="3.4166666666666665in"}
Figure 4.4.2-2 IWF Scenario three network deployment: visited EPS with E-UTRAN
only and UTRAN/GERAN, home EPS with E-UTRAN and UTRAN/GERAN and Pre Rel8
UMTS/GPRS
The subscription data for Pre Rel8 Gn/Gp SGSN, subscription data for SGSN and
the subscription data for MME is downloaded to SGSN or MME. SGSN or MME picks
up the subscription data forSGSN or MME and discards the subscription data for
Pre Rel8 UMTS/GPRS and the subscription data for MME or SGSN.
\- Users of an EPS for UTRAN/GERAN and E-UTRAN network access into a visited
EPS with only E-UTRAN, which is described as below:
{width="6.0in" height="3.4166666666666665in"}
Figure 4.4.2-3 IWF Scenario three network deployment: visited EPS with E-UTRAN
only, home EPS with E-UTRAN and UTRAN/GERAN
The subscription data for SGSN and the subscription data for MME is downloaded
to MME. MME picks up the subscription data for MME and discards the
subscription data for the subscription data for SGSN.
\- Users of an EPS for UTRAN/GERAN and E-UTRAN network access into a visited
EPS with E-UTRAN and UTRAN/GERAN, which is described as below:
{width="6.0in" height="3.4270833333333335in"}
Figure 4.4.2-4 IWF Scenario three network deployment: visited EPS with E-UTRAN
and UTRAN/GERAN, home EPS with E-UTRAN and UTRAN/GERAN
The subscription data for SGSN and the subscription data for MME is downloaded
to SGSN or MME. SGSN or MME picks up the subscription data for SGSN or MME and
discards the subscription data for MME or SGSN.
\- Users of a Pre Rel8 UMTS/GPRS/EPS for E-UTRAN only network access into a
visited EPS with only E-UTRAN, which is described as below:
{width="6.002777777777778in" height="3.3944444444444444in"}
Figure 4.4.2-5 IWF Scenario three network deployment: visited EPS with E-UTRAN
only, home ESP with E-UTRAN only and Pre Rel8 UMTS/GPRS
The subscription data for Pre Rel8 Gn/Gp SGSN and the subscription data for
MME is downloaded to MME. MME picks up the subscription data for MME and
discards the subscription data for Pre Rel8 Gn/Gp SGSN.
NOTE: This IWF scenario can not be used for interworking between two EPS
network with only E-UTRAN in which there in no MAP based roaming agreement to
be reused.
## 4.5 Scenario Four: S13/S13\' - Gf interworking scenario with one IWF
### 4.5.1 General Description
This interworking scenario is for S13/S13\' interface based on Diameter and Gf
interface based on MAP with one IWF in the path.
This IWF scenario can only be an intra PLMN use case for operator to do the
partly update of their legacy network.
This interworking scenario is described as below:
{width="5.875in" height="1.625in"}
Figure 4.5.1-1 S13/S13\' - Gf interworking scenario with one IWF
### 4.5.2 Network Deployments
This IWF scenario will apply the following network deployment situation:
\- ME identity/IMEISV of a user from a Pre Rel8 UMTS/GPRS network can be
checked in a visited EPS with E-UTRAN only, which is described as below:
{width="5.772222222222222in" height="3.7930555555555556in"}
Figure 4.5.2-1 IWF Scenario for network deployment: UE access from EPS with
E-UTRAN only
\- ME identity/IMEISV of a user from a Pre Rel8 UMTS/GPRS network can be
checked in a visited EPS with E-UTRAN and UTRAN/GERAN, which is described as
below:
{width="5.760416666666667in" height="3.7916666666666665in"}
Figure4.5.2-2 IWF Scenario for network deployment: UE access from EPS with
E-UTRAN and UTRAN/GERAN
# 5 General issues
## 5.1 Message Routing Mechanism
The principles for IWF message routing are:
\- For the same user, the messages shall go to and come back through the same
route with the same IWF(s) for the duration of a MAP dialog.
\- To ensure the correct message routing for the interworking scenarios, the
IWFs in the network shall be able to map the SS7 number and the Diameter
identity of the MME/SGSN 1-to-1. This may be achieved by static or dynamic
configuration.
\- To ensure the parallel multiple request messages can get their correct
response messages, the IWFs in the network shall be able to map the MAP
Dialogue Id and the Diameter Session Id 1-to-1.
The overall message routing mechanism for the scenario is described as below:
1\. The MME/SGSN may not be able to identify whether there is an IWF or not on
the route to an HSS. The routing of the first message from the MME/SGSN to the
IWF/HSS is the same as for a normal Diameter message routing. If the MME/SGSN
knows the address/name of the IWF/HSS for a certain user, both the
Destination-Realm and Destination-Host AVPs shall be present in the request.
Otherwise, only the Destination-Realm AVP shall be present and the command
shall be routed to the next Diameter node based on the Diameter routing table
in the client.
> When the MME/SGSN receives an answer message from the IWF/HSS, it should
> store the identity of the IWF/HSS for each IMSI for future reference to be
> able to send messages for the same IMSI.
2\. The IWF shall assign an SS7 number for the Diameter node MME/SGSN and
shall assign a Diameter identity for the SS7 node HSS. This may be achieved by
static configuration or dynamic assignment when the first signalling exchange
occurs between the Diameter/SS7 nodes and the IWF. The IWF shall maintain a
mapping table (address mapping table) for the assignment relationship.
> When a Diameter message reaches the IWF to set up a new Diameter session,
> the IWF(s) shall allocate a MAP Dialogue Id for the Diameter session. The
> IWF(s) shall maintain a mapping table (session mapping table) between the
> MAP Dialogue Id and the Diameter Session Id.
>
> The IWF shall then process messages as described below:
>
> a. When the IWF receives a Diameter message from a Diameter node, it shall
> map the Diameter message to a MAP message. It shall obtain a MAP Dialogue Id
> from the Diameter Session Id in the received message according to the
> session mapping table. The IWF shall obtain the source/destination SS7
> Number from the source/destination Diameter Identity in the received message
> according to the address mapping table.
>
> b. When the IWF receives an SS7 message from an SS7 node, it shall map the
> MAP message to a Diameter message. It shall obtain the Diameter Session Id
> from the MAP Dialogue Id in the received message according to the session
> mapping table. The IWF shall obtain the source/destination Diameter Identity
> from the source/destination SS7 Number in the received message according to
> the address mapping table.
3\. When the HSS/HLR receives the first message from IWF/SGSN, the HSS/HLR
shall record the SS7 number of the source for future message handling.
## 5.2 Void
## 5.3 Security Consideration for IWF
To support the full EPS-AKA security level for the related IWF scenarios, the
Pre Rel8 HLR shall be upgraded so that E-UTRAN authentication vector requests
from nodes serving E-UTRAN can be identified. The detailed mechanism is
described in 3GPP TS 33.401 [2].
# 6 The Interworking Scenarios
## 6.1 One IWF scenario
In this scenario, one IWF is located between MME or SGSN or combined MME/SGSN
and HSS or one IWF is located between MME and EIR, as illustrated in figure
6.1-1:
{width="5.99375in" height="1.8868055555555556in"}
Figure 6.1.-1: One IWF scenarios
The IWF needs not to be aware whether its connection via Gr is to an HSS or to
a second IWF (see Two IWF scenario).
## 6.2 Two IWF scenario
In this scenario, two IWFs are located between MME or SGSN or combined
MME/SGSN and HSS, as illustrated in figure 6.2-1:
Figure 6.2-1: Two IWFs scenario
The IWF1 is located in the VPLMN. IWF2 is located in the HPLMN. The IWF1 needs
not to be aware whether its connection via Gr is to an IWF or to an HSS (see
One IWF scenario).
# 7 The Mapping of the Procedures
## 7.1 Authentication Information Retrieval
### 7.1.1 One IWF Scenario
The mapping of procedures for this scenario is shown in figure 7.1.1-1:
Figure 7.1.1-1: Mapping of Authentication Info Retrieval Procedure for
scenario with one IWF
1\. The IWF receives an AIR message from the MME, SGSN or combined MME/SGSN.
2\. The IWF opens a MAP v3 dialogue towards the HSS by sending
SendAuthenticationInfo.
3\. The HSS may initiate MAP version fallback and/or send partial results. The
IWF performs the version fallback and/or stores the partial results. If EPS-
Vectors are requested for immediate use, version fallback is not applicable;
4\. The HSS closes the MAP dialogue by sending the (final)
SendAuthenticationInfo Ack to the IWF.
5\. The IWF uses the information received from the HSS to construct an AIA
which is sent to the MME, SGSN, or combined MME/SGSN.
### 7.1.2 Two IWFs Scenario
The mapping of procedures for this scenario is shown in figure 7.1.2-1:
Figure 7.1.2-1: Mapping of Authentication Info Retrieval Procedure for
scenario with two IWFs
1\. The IWF1 receives an AIR message from the MME, SGSN or combined MME/SGSN.
2\. The IWF1 opens a MAP v3 dialogue towards IWF2 by sending
SendAuthenticationInfo.
3\. The IWF2 constructs an AIR message and sends it to the HSS.
4\. The IWF2 receives AIA from the HSS.
5\. If segmentation is required, the IWF2 sends partial results to the IWF1
which stores the partial results.
6\. The IWF2 closes the MAP dialogue by sending the (final)
SendAuthenticationInfo Ack to IWF1.
7\. The IWF1 uses the information received from the IWF2 to construct an AIA
which is sent to the MME, SGSN, or combined MME/SGSN.
## 7.2 Update Location
### 7.2.1 One IWF Scenario
The mapping of procedures for this scenario is shown in figure 7.2.1-1:
Figure 7.2.1-1: Mapping of Update Location Procedure for scenario with one IWF
1\. The IWF receives an ULR message from the MME, SGSN or combined MME/SGSN.
2\. The IWF shall open a MAP v3 dialogue towards the HSS by sending
UpdateGprsLocation.
3\. Depending on \"skip subscriber data\" indication received in the ULR
(bullet 1 aboveand hence sent as per bullet 2 in the UpdateGprsLocation), the
HSS may continue the MAP dialogue by sending one or several
InsertSubscriberData messages (in acknowledgement mode or in burst mode) to
the IWF. The IWF then temporarily stores the received data and sends
InsertSubscriberData Ack messages to the HSS.
Note that the HSS may send InsertSubscriberData messages although a \"skip
subscriber data\" indication was present. In this case InsertSubscriberData
messages received from the HSS shall be acknowledged but need not be stored in
the IWF.
When sending InsertSubscriberData Ack messages to the HSS the IWF shall mirror
back any services requested by the HSS (within the InsertSubscriberData
message) but not supported by the MME or SGSN or combined MME/SGSN (as
indicated in 1.ULR). The IWF shall reject a MAP ActivateTraceMode message
received from the HSS by returning ActivateTraceMode Error
(facilityNotSupported).
If the IWF received a MAP ActivateTraceMode message from the HSS, the IWF
needs to store the received trace data. Based upon support of tracing (as
indicated the ULR received in bullet 1 above), the MME/SGSN sends an
ActivateTraceMode Result (positive Ack) or Error FacilityNotSupported
(negative Ack) to the HSS.
4\. The HSS shallclose the MAP dialogue by sending UpdateGprsLocation Ack to
the IWF.
5\. The IWF shal use the information received from the HSS to construct an ULA
which is sent to the MME, SGSN, or combined MME/SGSN.
### 7.2.2 Two IWFs Scenario
The mapping of procedures for this scenario is shown in figure 7.2.2-1:
Figure 7.2.2-1: Mapping of Update Location Procedure for scenario with two
IWFs
1\. The IWF1 receives an ULR message from the MME, SGSN or combined MME/SGSN.
2\. The IWF1 shall open a MAP v3 dialogue towards IWF2 by sending
UpdateGprsLocation.
3\. The IWF2 shall construct a ULR message and shall send it to the HSS.
4\. The IWF2 receives ULA from the HSS.
5\. If subscriber data is included in the ULA(as per bullet 4), the IWF2 shall
send one or several InsertSubscriberData messages (in acknowledgement mode or
in burst mode) to the IWF1. IWF1 then temporarily stores the received data and
sends InsertSubscriberData Ack messages to the IWF2. If trace data is included
in the ULA (bullet 4. above) , the IWF2 sends an ActivateTraceMode message to
the IWF1, which sends an ActivateTraceMode Ack message to the IWF2.
6\. The IWF2 shall close the MAP dialogue by sending UpdateGprsLocation Ack to
IWF1.
7\. The IWF1 shall use the information received from the IWF2 to construct an
ULA which shall be sent to the MME, SGSN, or combined MME/SGSN.
## 7.3 Cancel Location
### 7.3.1 One IWF Scenario
The mapping of procedures for this scenario is shown in figure 7.3.1-1:
Figure 7.3.1-1: Mapping of Cancel Location Procedure for scenario with one IWF
1\. The IWF receives a CancelLocation MAP v3 message from the HSS (the IWF
shall reject CancelLocation messages in version \3; not shown in
figure 7.3.1-1).
2\. The IWF sends CLR to the MME or SGSN or combined MME/SGSN.
3\. The IWF receives CLA.
4\. The IWF closes the MAP dialogue with the HSS by sending CancelLocation
Ack.
### 7.3.2 Two IWFs Scenario
The mapping of procedures for this scenario is shown in figure 7.3.2-1:
Figure 7.3.2-1: Mapping of Cancel Location Procedure for scenario with two
IWFs
1\. The IWF2 receives a CLR message from the HSS.
2\. The IWF2 opens a MAP v3 dialogue towards IWF1 by sending CancelLocation.
3\. The IWF1 constructs a CLR message and sends it to the MME, SGSN, or
combined MME/SGSN.
4\. The IWF1 receives CLA from the MME, SGSN or combined MME/SGSN.
5\. The IWF1 closes the MAP dialogue with the IWF2 by sending CancelLocation
Ack.
6\. The IWF2 sends CLA to the HSS.
## 7.4 Purge
### 7.4.1 One IWF Scenario
The mapping of procedures for this scenario is shown in figure 7.4.1-1:
Figure 7.4.1-1: Mapping of Purge Procedure for scenario with one IWF
1\. The IWF receives a PUR message from the MME, SGSN, or combined MME/SGSN.
2\. The IWF opens a MAP v3 dialogue towards the HSS by sending PurgeMS.
3\. The IWF receives PurgeMS Ack from the HSS.
4\. The IWF sends PUA to the MME, SGSN, or combined MME/SGSN.
### 7.4.2 Two IWFs Scenario
The mapping of procedures for this scenario is shown in figure 7.4.2-1:
Figure 7.4.2-1: Mapping of Purge Procedure for scenario with two IWFs
1\. The IWF1 receives a PUR message from the MME, SGSN, or combined MME/SGSN.
2\. The IWF1 opens a MAP v3 dialogue towards IWF2 by sending PurgeMS.
3\. The IWF2 constructs a PUR message and sends it to the HSS.
4\. The IWF2 receives PUA from the HSS.
5\. The IWF2 closes the MAP dialogue with the IWF1 by sending PurgeMS Ack.
6\. The IWF1 sends PUA to the MME, SGSN, or combined MME/SGSN.
## 7.5 Insert Subscriber Data
### 7.5.1 One IWF Scenario
The mapping of procedures for this scenario is shown in figure 7.5.1-1:
Figure 7.5.1-1: Mapping of Insert Subscriber Data Procedure for scenario with
one IWF
1\. The IWF receives an (stand alone) InsertSubscriberData or
ProvideSubscriberInfo message from the HSS.
2\. The IWF constructs an IDR message and sends it to the MME, SGSN, or
combined MME/SGSN.
3\. The IWF receives IDA from the MME, SGSN, or combined MME/SGSN.
4\. The IWF sends InsertSubscriberData or ProvideSubscriberInfo Ack to the
HSS.
5\. Steps 1 to 4 may be repeated several times for InsertSubscriberData. The
repetition may be in burst mode or in acknowledge mode.
6\. The HSS closes the MAP dialogue.
NOTE: In a mapping procedure, the IWF correlates the MAP Dialogue ID of the
MAP request message and the Diameter Session-ID of the mapped Diameter request
message which is to be used in the subsequent mapping from Diameter Answer
message to corresponding MAP Ack message.
### 7.5.2 Two IWFs Scenario
The mapping of procedures for this scenario is shown in figure 7.5.2-1:
Figure 7.5.2-1: Mapping of Insert Subscriber Data Procedure for scenario with
two IWFs
1\. The IWF2 receives a IDR message from the HSS.
2\. The IWF2 opens a MAP v3 dialogue towards IWF1 by sending
InsertSubscriberData (if the IDR-Flags AVP within the IDR is not present or
the \"UE Reachability Request\" flag was set in the IDR-Flags AVP within the
IDR) or ProvideSubscriberInfo in other cases. If segmentation of the data (on
MAP level) is required the IWF2 temporarily stores the data that could not be
sent in this step.
3\. The IWF1 constructs a IDR message and sends it to the MME, SGSN, or
combined MME/SGSN.
4\. The IWF1 receives IDA from the MME, SGSN, or combined MME/SGSN.
5\. The IWF1 sends InsertSubscriberData or ProvideSubscriberInfo Ack to IWF2.
6\. If segmentation is required for InsertSubscriberData, steps 2 to 5 are be
repeated until all data are sent. Repetition may be in burst mode or in
acknowledge mode.
7\. IWF2 closes the MAP dialogue with IWF1.
8\. IWF2 sends IDA to the HSS.
NOTE: In a mapping procedure, the IWFs correlates the MAP Dialogue ID of the
MAP request message and the Diameter Session-ID of the mapped Diameter request
message which is to be used in the subsequent mapping from Diameter Answer
message to corresponding MAP Ack message or vice versa.
## 7.6 Delete Subscriber Data
### 7.6.1 One IWF Scenario
The mapping of procedures for this scenario is shown in figure 7.6.1-1:
Figure 7.6.1-1: Mapping of Delete Subscriber Data Procedure for scenario with
one IWF
1\. The IWF receives a DeleteSubscriberData MAP v3 message from the HSS (the
IWF shall reject DeleteSubscriberData messages in version \3; not shown in figure 7.6.1-1).
2\. The IWF sends DSR to the MME or SGSN or combined MME/SGSN.
3\. The IWF receives DSA.
4\. The IWF closes the MAP dialogue with the HSS by sending
DeleteSubscriberData Ack.
### 7.6.2 Two IWFs Scenario
The mapping of procedures for this scenario is shown in figure 7.6.2-1:
Figure 7.6.2-1: Mapping of Delete Subscriber Data Procedure for scenario with
two IWFs
1\. The IWF2 receives a DSR message from the HSS.
2\. The IWF2 opens a MAP v3 dialogue towards IWF1 by sending
DeleteSubscriberData.
3\. The IWF1 constructs a DSR message and sends it to the MME, SGSN, or
combined MME/SGSN.
4\. The IWF1 receives DSA from the MME, SGSN or combined MME/SGSN.
5\. The IWF1 closes the MAP dialogue with the IWF2 by sending
DeleteSubscriberData Ack.
6\. The IWF2 sends DSA to the HSS.
## 7.7 Reset
### 7.7.1 One IWF Scenario
The mapping of procedures for this scenario is shown in figure 7.7.1-1:
Figure 7.7.1-1: Mapping of Reset Procedure for scenario with one IWF
1\. The IWF receives a Reset MAP v1 or v2 message from the HSS.
2\. The IWF sends RSR to the MME or SGSN or combined MME/SGSN.
3\. The IWF receives RSA.
### 7.7.2 Two IWFs Scenario
The mapping of procedures for this scenario is shown in figure 7.7.2-1:
Figure 7.7.2-1: Mapping of Reset Procedure for scenario with two IWFs
1\. The IWF2 receives a RSR message from the HSS.
2\. The IWF2 opens a MAP v1 or v2 (vendor option) dialogue towards IWF1 by
sending Reset.
3\. The IWF2 sends RSA to the HSS.
4\. The IWF1 constructs a RSR message and sends it to the MME, SGSN, or
combined MME/SGSN.
5\. The IWF1 receives RSA from the MME, SGSN or combined MME/SGSN.
## 7.8 Notification
### 7.8.1 One IWF Scenario
The mapping of procedures for this scenario is shown in figure 7.8.1-1:
Figure 7.8.1-1: Mapping of Notification Procedure for scenario with one IWF
1\. The IWF receives a NOR message from the MME, SGSN, or combined MME/SGSN.
2\. The IWF sends UpdateGprsLocation or ReadyForSM to the HSS.
3\. The IWF sends NOA to the MME, SGSN, or combined MME/SGSN.
4\. The HSS (if it does not support the \"skip subscriber data\" indication)
may continue the MAP dialogue by sending InsertSubscriberData messages which
are positively acknowledged and discarded by the IWF.
5\. The HSS closes the MAP dialogue by sending UpdateGprsLocation Ack or
ReadyForSM Ack.
### 7.8.2 Two IWFs Scenario
The mapping of procedures for this scenario is shown in figure 7.8.2-1:
Figure 7.8.2-1: Mapping of Notification Procedure for scenario with two IWFs
1\. The IWF1 receives a NOR message from the MME, SGSN, or combined MME/SGSN.
2\. The IWF1 sends UpdateGprsLocation or ReadyForSM to the IWF2.
3\. The IWF1 sends NOA to the MME, SGSN, or combined MME/SGSN.
4\. The IWF2 sends NOR to the HSS.
5\. The IWF2 closes the MAP dialogue with IWF1 by sending UpdateGprsLocation
Ack or ReadyForSM Ack.
6\. The IWF2 receives NOA from the HSS.
## 7.9 IMEI Check
### 7.9.1 One IWF Scenario
The mapping of procedures for this scenario is shown in figure 7.9.1-1:
{width="5.99375in" height="3.995833333333333in"}
Figure 7.9.1-1: Mapping of IMEI Check Procedure with one IWF
1\. The IWF receives an ECR message from the MME/SGSN.
2\. The IWF sends Check IMEI to the EIR.
3\. The IWF receives Check IMEI Ack from the EIR.
4\. The IWF sends ECA to the MME/SGSN.
## 7.10 Trace Activation
### 7.10.1 One IWF Scenario
The mapping of procedures for this scenario is shown in figure 7.10.1-1:
Figure 7.10.1-1: Mapping of Trace Activation Procedure for scenario with one
IWF
1\. The IWF receives an ActivateTraceMode message from the HSS.
2\. The IWF shall construct an IDR message and send it to the MME, SGSN, or
combined MME/SGSN.
3\. The IWF receives IDA from the MME, SGSN, or combined MME/SGSN.
4\. The IWF shall send an ActivateTraceMode Ack to the HSS.
### 7.10.2 Two IWFs Scenario
Figure 7.10.2-1: Mapping of Trace Activation Procedure for scenario with two
IWFs
1\. The IWF2 receives an IDR message from the HSS.
2\. If the IWF2 finds that Trace Data is included in the IDR, it shall open a
MAP v3 dialogue towards IWF1 by sending ActivateTraceMode.
3\. The IWF1 shall construct an IDR message and shall send it to the MME,
SGSN, or combined MME/SGSN.
4\. The IWF1 receives IDA from the MME, SGSN, or combined MME/SGSN.
5\. The IWF1 shall send an ActivateTraceMode Ack to IWF2.
6\. IWF2 shall send an IDA to the HSS.
## 7.11 Trace Deactivation
### 7.11.1 One IWF Scenario
The mapping of procedures for this scenario is shown in figure 7.11.1-1:
Figure 7.11.1-1: Mapping of Trace Deactivation Procedure for scenario with one
IWF
1\. The IWF receives a DeactivateTraceMode message from the HSS.
2\. The IWF shall construct a DSR message and shall send it to the MME, SGSN,
or the combined MME/SGSN.
3\. The IWF receives DSA from the MME, SGSN, or combined MME/SGSN.
4\. The IWF shall send a DeactivateTraceMode Ack to the HSS.
### 7.11.2 Two IWFs Scenario
Figure 7.11.2-1: Mapping of Trace Deactivation Procedure for scenario with two
IWFs
1\. The IWF2 receives a DSR message from the HSS.
2\. If the IWF2 finds that a Trace Data Withdrawal indication is included in
the DSR, it shall open a MAP v3 dialogue towards IWF1 by sending
DeactivateTraceMode.
3\. The IWF1 shall construct a DSR message and shall send it to the MME, SGSN,
or the combined MME/SGSN.
4\. The IWF1 receives DSA from the MME, SGSN, or combined MME/SGSN.
5\. The IWF1 shall send a DeactivateTraceMode Ack to the IWF2.
6\. The IWF2 shall send a DSA to the HSS.
# 8 The Mapping of the Parameters
## 8.1 Mapping of Parameters for the Authentication Info Retrieval Procedure
### 8.1.1 AIR mapping to SendAuthenticationInfoArg (v3)
When the IWF needs to construct a MAP-SendAuthenticationInfo message as a
result of receiving an AIR command (see sections 7.1.1 step 2, and 7.1.2 step
2), the IWF shall open a MAP dialogue in application context version 3 and
populate sub-parameters of SendAuthenticationInfoArg as described below:
**imsi** in SendAuthenticationInfoArg shall be populated with the value of the
User-Name AVP received within AIR.
If AIR contains a Requested-EUTRAN-Authentication-Info AVP but does not
contain a Requested-UTRAN-GERAN-Authentication-Info AVP:
**numberOfRequestedVectors** in SendAuthenticationInfoArg shall be populated
with the value of the Number-Of-Requested-Vectors AVP received within the
Requested-EUTRAN-Authentication-Info AVP received within AIR.
If AIR contains a Requested-UTRAN-GERAN-Authentication-Info AVP but does not
contain a Requested-EUTRAN-Authentication-Info AVP:
**numberOfRequestedVectors** in SendAuthenticationInfoArg shall be populated
with the value of the Number-Of-Requested-Vectors AVP received within the
Requested-UTRAN-GERAN-Authentication-Info AVP received within AIR.
If AIR contains a Requested-EUTRAN-Authentication-Info AVP and a Requested-
UTRAN-GERAN-Authentication-Info AVP, and the Immediate-Response-Preferred AVP
is present within the Requested-EUTRAN-Authentication-Info AVP:
**numberOfRequestedVectors** in SendAuthenticationInfoArg shall be populated
with the value of the Number-Of-Requested-Vectors AVP received within the
Requested-EUTRAN-Authentication-Info AVP received within AIR.
If AIR contains a Requested-EUTRAN-Authentication-Info AVP and a Requested-
UTRAN-GERAN-Authentication-Info AVP, and the Immediate-Response-Preferred AVP
is not present within the Requested-EUTRAN-Authentication-Info AVP:
**numberOfRequestedVectors** in SendAuthenticationInfoArg shall be populated
with the value of the Number-Of-Requested-Vectors AVP received within the
Requested-UTRAN-GERAN-Authentication-Info AVP received within AIR.
**segmentationProhibited** shall be absent in SentAuthenticationInfoArg.
If AIR contains a Requested-EUTRAN-Authentication-Info AVP but does not
contain a Requested-UTRAN-GERAN-Authentication-Info AVP:
**immediateResponsePreferred** in SendAuthenticationInfoArg shall be present
if and only if the Immediate-Response-Preferred AVP is present within the
Requested-EUTRAN-Authentication-Info AVP within AIR.
If AIR contains a Requested-UTRAN-GERAN-Authentication-Info AVP but does not
contain a Requested-EUTRAN-Authentication-Info AVP:
**immediateResponsePreferred** in SendAuthenticationInfoArg shall be present
if and only if the Immediate-Response-Preferred AVP is present within the
Requested-UTRAN-GERAN-Authentication-Info AVP within AIR.
If AIR contains a Requested-EUTRAN-Authentication-Info AVP and a Requested-
UTRAN-GERAN-Authentication-Info AVP:
**immediateResponsePreferred** in SendAuthenticationInfoArg shall be present
if and only if the Immediate-Response-Preferred AVP is present within the
Requested-UTRAN-GERAN-Authentication-Info AVP or within the Requested-EUTRAN-
Authentication-Info AVP within AIR.
**re-synchronisationInfo** in SendAuthenticationInfoArg shall be present if
and only if a Re-synchronization-Info AVP is present wihin the Requested-
EUTRAN-Authentication-Info AVP or within the Requested-UTRAN-GERAN-
Authentication-Info AVP within AIR.
**extensionContainer** in SendAuthenticationInfoArg shall be absent.
**requestingNodeType** in SendAuthenticationInfoArg shall be present and shall
be populated with the value\ \"mme\" if a Requested-EUTRAN-Authentication-Info
AVP and no Requested-UTRAN-GERAN-Authentication-Info AVP was present within
AIR;\ \"sgsn\" if a Requested-UTRAN-GERAN-Authenticatio-Info AVP and no
Requested EUTRAN-Authentication-Info AVP was present within AIR;\ . \"mme-
sgsn\" if both a Requested-EUTRAN-Authentication-Info AVP and a Requested-
UTRAN-GERAN-Authentication-Info AVP were present within AIR .
**requestingPLMN-Id** in SendAuthenticationInfoArg shall be present and shall
be populated with the value received within the Visited-PLMN-ID AVP within
AIR.
**numberOfRequestedAdditional-Vectors** in SendAuthenticationInfoArg shall be
present if and only if both a Requested-EUTRAN-Authentication-Info AVP and a
Requested-UTRAN-GERAN-Authentication-Info AVP are present within AIR. If
present, the parameter shall be populated with the value received in the
Number-Of-Requested-Vectors AVP within the Requested-EUTRAN-Authentication-
Info (if the Immediate-Response-Preferred AVP is absent within Requested-
EUTRAN-Authentication-Info AVP within AIR) or with the value received in the
Number-Of-Requested-Vectors AVP within the Requested-UTRAN-GERAN-
Authentication-Info AVP (otherwise).
**additionalVectorsAreForEPS** shall be present in SendAuthenticationInfoArg
if and only if a Requested-EUTRAN-Authentication-Info AVP and a Requested-
UTRAN-GERAN-Authentication-Info AVP are present within AIR and the Immediate-
Response-Preferred AVP is absent in the Requested-EUTRAN-Authentication-Info
AVP.
### 8.1.2 AIR mapping to SendAuthenticationInfoArg (v2)
When the IWF needs to construct a MAP-SendAuthenticationInfo message in MAP AC
version 2 as a result of MAP version negotiation (see sections 7.1.1 step 3),
the IWF shall open a MAP dialogue in application context version 2 and
populate sub-parameters of SendAuthenticationInfoArg as described below:
**imsi** in SendAuthenticationInfoArg shall be populated with the value of the
User-Name AVP received within AIR.
### 8.1.3 AIR mapping to SendParametersArg (v1)
When the IWF needs to construct a MAP-SendParameters message in MAP AC version
1 as a result of MAP version negotiation (see section 7.1.1 step 3), the IWF
shall open a MAP dialogue in application context version 1 and populate sub-
parameters of SendParametersArg as described below:
**subscriberId** in SendParametersArg shall take the imsi alternative; imsi
shall be populated with the value of the User-Name AVP received within AIR.
**requestedParameterList** in SendParametersArg shall contain one
RequestParameter which contains the value of \"requestAuthenticationSet\".
### 8.1.4 SendAuthenticationInfoRes / Error (v3) mapping to AIA
When the IWF needs to construct an AIA command as a result of receiving a
SendAuthenticationInfo Ack/Error message in MAP version 3 (see sections 7.1.1
step 5, and 7.1.2 step 7), the IWF shall populate AVPs of AIA as described
below:
**Result-Code / Experimental-Result** AVP shall be set to:
\- DIAMETER_SUCCESS if a SendAuthenticationInfoRes parameter was received in a
TCAP ResultLast component;
\- DIAMETER_ERROR_USER_UNKNOWN if an error of unknownSubscriber without a
diagnostic parameter or with a diagnostic parameter of imsiUnknown was
received;
\- DIAMETER_ERROR_UNKNOWN_SUBSCRIPTION if an error unknownSubscriber with a
diagnostic parameter of gprs-eps-SubscriptionUnknown was received;
\- an appropriate DIAMETER base protocol result code otherwise.
**Auth-Session-State** AVP shall be set to the value NO_STATE_MAINTAINED (1).
**Supported-Features** AVP shall be absent.
**Authentication-Info** AVP shall be present if authenticationSetList or eps-
AuthenticationSetList is present in the received SendAuthenticationInfoRes. If
present, the AVP shall contain EPS-Vector AVPs and/or either UTRAN-Vector AVPs
or GERAN-Vector AVPs as mapped from received EPC-AVs and/or either
AuthenticationQuintuplets or AuthenticationTriplets respectively.
### 8.1.5 SendAuthenticationInfoRes / Error (v2) mapping to AIA
When the IWF needs to construct an AIA command as a result of receiving a
SendAuthenticationInfo Ack/Error message in MAP version 2 (see sections 7.1.1
step 5), the IWF shall populate AVPs of AIA as described below:
**Result-Code / Experimental-Result** AVP shall be set to:
\- DIAMETER_SUCCESS if aSendAuthenticationInfoRes parameter was received in a
TCAP ResultLast component;
\- DIAMETER_ERROR_USER_UNKNOWN if an error of unknownSubscriber without a
diagnostic parameter or with a diagnostic parameter of imsiUnknown was
received;
\- DIAMETER_ERROR_UNKNOWN_SUBSCRIPTION if an error unknownSubscriber with a
diagnostic parameter of gprsSubscriptionUnknown was received;
\- an appropriate DIAMETER base protocol result code otherwise.
**Auth-Session-State** AVP shall be set to the value NO_STATE_MAINTAINED (1).
**Supported-Features** AVP shall be absent.
**Authentication-Info** AVP shall be present if authenticationSetList is
present in the received SendAuthenticationInfoRes. If present, the AVP shall
contain GERAN-Vector AVPs as mapped from received AuthenticationTriplets.
### 8.1.6 SendParameterList / Error (v1) mapping to AIA
When the IWF needs to construct an AIA command as a result of receiving a
SendParameters Ack/Error message in MAP version 1 (see sections 7.1.1 step 5),
the IWF shall populate AVPs of AIA as described below:
**Result-Code / Experimental-Result** AVP shall be set to:
DIAMETER_SUCCESS if a SentParameterList parameter was received in a TCAP
ResultLast component;
DIAMETER_ERROR_USER_UNKNOWN if an error of unknownSubscriber was received;
an appropriate DIAMETER base protocol result code otherwise.
**Auth-Session-State** AVP shall be set to the value NO_STATE_MAINTAINED (1).
**Supported-Features** AVP shall be absent.
**Authentication-Info** AVP shall be present if sentParameterList is present
in the received TCAP ResultLast component. If present, the AVP shall contain
GERAN-Vector AVPs as mapped from received AuthenticationTriplets.
### 8.1.7 SendAuthenticationInfoArg (v3) mapping to AIR
When the IWF needs to construct an AIR command as a result of receiving a
SendAuthenticationInfo message in MAP version 3 (see sections 7.1.2 step 3),
the IWF shall populate AVPs of AIR as described below:
**Auth-Session-State** AVP shall be set to the value NO_STATE_MAINTAINED (1).
**User-Name** AVP shall be populated with the value received within the imsi
parameter of SendAuthenticationInfoArg.
**Supported-Features** AVP shall be absent.
**Requested-EUTRAN-Authentication-Info** AVP shall be present if
requestingNodeType parameter within SendAuthenticationInfoArg takes the value
of \"mme\" or \"mme-sgsn\".
**Number-Of-Requested-Vectors** AVP within Requested-EUTRAN-Authentication-
Info AVP (if present) shall be populated with
a) the value received within the numberOfRequestedVectors parameter of
SendAuthenticationInfoArg if requestingNodeType parameter within
SendAuthenticationInfoArg takes the value of \"mme\";
b) the value received within the numberOfRequestedVectors parameter of
SendAuthenticationInfoArg if requestingNodeType parameter within
SendAuthenticationInfoArg takes the value of \"mme-sgsn\" and the
additionalVectorsAreForEPS parameter is absent from SendAuthenticationInfoArg;
c) the value received within the numberOfRequestedAdditional-Vectors parameter
of SendAuthenticationInfoArg if requestingNodeType parameter within
SendAuthenticationInfoArg takes the value of \"mme-sgsn\" and the
additionalVectorsAreForEPS parameter is present within
SendAuthenticationInfoArg.
**Immediate-Response-Preferred** AVP within Requested-EUTRAN-Authentication-
Info AVP (if present) shall be present if:
a) requestingNodeType parameter within SendAuthenticationInfoArg takes the
value of \"mme\" and immediateResponsePreferred parameter is present in
SendAuthenticationInfoArg, or
b) requestingNodeType parameter within SendAuthenticationInfoArg takes the
value of \"mme-sgsn\" and additionalVectorsAreForEPS parameter is absent from
SendAuthenticationInfoArg and immediateResponsePreferred is present within
SendAuthenticationInfoArg.
**Re-synchronization-Info** AVP within Requested-EUTRAN-Authentication-Info
AVP (if present) shall be populated with the value received in the re-
synchronizationInfo parameter within SendAuthenticationInfoArg.
**Requested-UTRAN-GERAN-Authentication-Info** AVP shall be present if
requestingNodeType parameter within SendAuthenticationInfoArg takes the value
of \"sgsn\" or \"mme-sgsn\".
**Number-Of-Requested-Vectors** AVP within Requested-UTRAN-GERAN-
Authentication-Info AVP (if present) shall be populated with:
a) the value received within the numberOfRequestedVectors parameter of
SendAuthenticationInfoArg if requestingNodeType parameter within
SendAuthenticationInfoArg takes the value of \"sgsn\";
b) the value received within the numberOfRequestedVectors parameter of
SendAuthenticationInfoArg if requestingNodeType parameter within
SendAuthenticationInfoArg takes the value of \"mme-sgsn\" and the
additionalVectorsAreForEPS parameter is present within
SendAuthenticationInfoArg;
c) the value received within the numberOfRequestedAdditional-Vectors parameter
of SendAuthenticationInfoArg if requestingNodeType parameter within
SendAuthenticationInfoArg takes the value of \"mme-sgsn\" and the
additionalVectorsAreForEPS parameter is absent from SendAuthenticationInfoArg.
**Immediate-Response-Preferred** AVP within Requested-UTRAN-GERAN-
Authentication-Info AVP (if present) shall be present if
a) requestingNodeType parameter within SendAuthenticationInfoArg takes the
value of \"sgsn\" and immediateResponsePreferred parameter is present in
SendAuthenticationInfoArg, or
b) requestingNodeType parameter within SendAuthenticationInfoArg takes the
value of \"mme-sgsn\" and additionalVectorsAreForEPS parameter is present from
SendAuthenticationInfoArg and immediateResponsePreferred is present within
SendAuthenticationInfoArg.
**Re-synchronization-Info** AVP within Requested-EUTRAN-Authentication-Info
AVP (if present) shall be populated with the value received in the re-
synchronizationInfo parameter within SendAuthenticationInfoArg.
**Visited-PLMN-Id** AVP shall be populated with the value of the
requestingPLMN-Id parameter received within SendAuthenticationInfoArg.
**RequestingNodeType** AVP shall be populated with the value of the
requestingNodeType parameter received within SendAuthenticationInfoArg.
### 8.1.8 AIA mapping to SendAuthenticationInfoRes/Error (v3)
When the IWF needs to construct a MAP SendAuthenticationInfo Ack message (v3)
as a result of receiving an AIA command (see sections 7.1.2 steps 5 and 6),
the IWF shall construct partial result messages (if segmentation is required)
and a final result message or an error message (if the Result-Code AVP within
AIA takes a value different from \"success\"). Sub-parameters of
SendAuthenticationInfoRes shall be populated as described below:
**authenticationSetList** within SendAuthenticationInfoRes shall be present if
UTRAN-Vector AVP or GERAN-Vector AVP is present in Authentication-Info AVP
within AIA. If so the parameter shall be populated with the value received
within the UTRAN-Vector AVP or GERAN-Vector AVP (whichever is present).
**eps-AuthenticationSetList** within SendAuthenticationInfoRes shall be
present if EPS-Vector AVP is present in Authentication-Info AVP within AIA. If
so the parameter shall be populated with the values received within the EPS-
Vector AVP.
An error of **unknownSubscriber** with unknownSubscriberParam containing a
unknownSubscriberDiagnostic of \"imsiUnknown\" shall be sent if the received
AIA command contains an Experimental-Result AVP with a value of \"User
Unknown\".
An error of **unknownSubscriber** with unknownSubscriberParam containing a
unknownSubscriberDiagnostic of \"gprs-epsSubscriptionUnknown\" shall be sent
if the received AIA command contains an Experimental-Result AVP with a value
of \"Unknown EPS Subscription\".
Other values within the Result-Code / Experimental-Result AVP shall be mapped
onto an appropriate MAP error.
## 8.2 Mapping of Parameters for the Update Location Procedure
### 8.2.1 ULR mapping to UpdateGprsLocationArg
When the IWF needs to construct a MAP-UpdateGprsLocation message as a result
of receiving an ULR command (see sections 7.2.1 step 2, and 7.2.2 step 2), the
IWF shall open a MAP dialogue in application context version 3 and populate
sub-parameters of UpdateGprsLocationArg as described below:
**imsi** in UpdateGprsLocationArg shall be populated with the value of the
User-Name AVP received within ULR.
**sgsn-Number** in UpdateGprsLocationArg shall be populated with the value of
the SGSN.Number AVP if present within ULR, otherwise it shall be populated
with a value locally assigned to the IWF and consistent with SS7 routing
principles.
**sgsn-Address** in UpdateGprsLocationArg shall be populated with the IP-
address of the source node sending the ULR command.
**extensionContainer** in UpdateGprsLocationArg shall be absent.
**sgsn-Capability** in UpdateGprsLocationArg shall be populated as follows:
\- solsaSupportIndicator shall be absent;
\- extensionContainer shall be absent;
\- superChargerSupportedInServingNetworkEntity shall be absent;
\- gprsEnhancementSupportIndicator shall be present;
\- supportedCamelPhases shall be absent or shall indicate no support of any
CAMEL phase;
\- supportedLCS-CapabilitySet shall be absent or shall indicate no support of
any LCS capability set;
\- offeredCamel4CSIs shall be absent;
\- smsCallBarringSupportIndicator shall be absent;
\- supportedRAT-TypesIndicator shall be present and populated with the value
received within the RAT-Type AVP in the received ULR;
\- supportedFeatures shall be present if a SupportedFeature AVP was present in
the received ULR which indicated support of odbs and regsubs.
**informPreviousNetworkEntity** in UpdateGprsLocationArg shall be absent;
**ps-LCS-NotSupportedByUE** in UpdateGprsLocationArg shall be absent
**v-gmlc-Address** in UpdateGprsLocationArg shall be absent.
**add-info** in UpdateGprsLocationArg shall be present if a Terminal-
Information AVP was present in the received ULR. If present the parameter
shall be poulated with the received IMEI and software version;
skipSubscriberDataUpdate in add-info shall be absent.
**eps-info** in UpdateGprsLocationArg shall be present.
\- if the S6a/S6d indicator within the ULR-Flags AVP was set, the parameter
shall contain isr-Information with updateLocation indication, and if a Single-
Registration-Indication was present in the received ULR-Flags AVP then the
isr-Information shall also contain a cancelSGSN indication, and if an
InitialAttachIndicator was present in the received ULR-Flags AVP then the isr-
Information shall also contain initialAttachIndicator;
\- if the S6a/S6d indicator within the ULR-Flags was not set, the parameter
shall contain isr-Information with updateLocation indication, and if an
InitialAttachIndicator was present within the ULR-Flags AVP, the parameter
shall contain isr-Information with initialAttachIndicator.
**servingNodeTypeIndicator** in UpdateGprsLocationArg shall be present if the
S6a/S6d-Indicator was present in the ULR-Flags AVP within the received ULR.
**skipSubscriberData Update** in UpdateGprsLocationArg shall be present if a
skip subscriber data indication was receive within the ULR-Flags within ULR.
**usedRAT-Type** in UpdateGprsLocationArg shall be populate with the value
received within the RAT-Type AVP within ULR.
**gprsSubscriptionDataNotNeeded** in UpdateGprsLocationArg shall be present if
bit 3 (GPRS-Subscription-Data-Indicator) was not set in the ULR-Flags AVP
received within ULR.
**nodeTypeIndicator** in UpdateGprsLocationArg shall be present if bit 4
(Node-Type-Indicator) was set in the ULR-Flags AVP received within ULR.
**areaRestricted** in UpdateGprsLocationArg shall be absent.
**ue-reachableIndicator** in UpdateGprsLocationArg shall be absent.
**ue-srvcc-Capability** in UpdateGprsLocationArg shall be present if a UE-
SRVCC-Capability AVP was present in the received ULR. If present the parameter
shall be populated with the received ue-srvcc-Capability.
**mmeNumberforMTSMS** in UpdateGprsLocationArg shall be populated with the
value of the MME-Number-for-MT-SMS AVP if present within ULR.
**sms-Only** in UpdateGprsLocationArg shall be populated with the value of the
SMS-Only AVP if present within ULR.
**smsRegisterRequest** in UpdateGprsLocationArg shall be populated with the
value of the SMS-Register-Request AVP if present within ULR.
**adjacentPLMN-List** in UpdateGprsLocationArg shall be constructed with the
values of the Adjacent-PLMNs grouped AVP, if present within ULR.
### 8.2.2
UpdateGprsLocationRes/Error/InsertSubscriberDataArg/ActivateTraceModeArg
mapping to ULA
When the IWF needs to construct an ULA command as a result of receiving an
UpdateGprsLocation Ack/Error message (see sections 7.2.1 step 5, and 7.2.2
step 7), the IWF shall populate AVPs of ULA as described below:
**Result-Code / Experimental-Result** AVP shall be set to:
\- DIAMETER_SUCCESS if an UpdateGprsLocationRes parameter was received in a
TCAP ResultLast component;
\- DIAMETER_ERROR_USER_UNKNOWN if an error of unknownSubscriber without a
diagnostic parameter or with a diagnostic parameter of imsiUnknown was
received;
\- DIAMETER_ERROR_UNKNOWN_SUBSCRIPTION if an error of unknownSubscriber with a
diagnostic parameter of gprs-eps-SubscriptionUnknown was received;
\- DIAMETER_ERROR_RAT_NOT_ALLOWED if an error of roamingNotAllowed with a
roamingNotAllowedParam containing an additionalRoamingNotAllowedCause of
\"supportedRAT-TypesNotAllowed\" was received;
\- DIAMETER_ERROR_ROAMING_NOT_ALLOWED if an error of roamingNotAllowed without
\"supportedRAT-TypesNotAllowed\" was received;
\- an appropriate DIAMETER base protocol result code otherwise.
**Auth-Session-State** AVP shall be set to the value NO_STATE_MAINTAINED (1).
**Supported-Features** AVP shall be absent.
**ULA-Flags** AVP: Flags shall be set as follows:
\- **SeparationIndication** shall be set to 1 if the sgsn-
mmeSeparationSupported parameter was present within UpdateGprsLocationRes;
otherwise shall be set to 0.
\- **MME Registered for SMS** shall be set to 1 if the mmeRegisteredforSMS
parameter was present within UpdateGprsLocationRes; otherwise shall be set to
0.
**Subscription-Data** AVP shall be present if MAP InsertSubscriberData
messages have been received from the HSS and a \"skip-subscriber-Data\"
indication was not present in the received ULR command or a MAP
ActivateTraceMode message has been received from the HSS. If present the AVP
shall be populated as follows:
**Subscriber status** AVP shall be present if a subscriberStatus parameter was
present in a received SubscriberData parameter within InsertSubscriberDataArg.
If so, values shall be mapped appropriately.
**MSISDN** AVP shall be present if an msisdn parameter was present in a
received SubscriberData parameter within InsertSubscriberDataArg.
**STN-SR** AVP shall be present if an stn-sr parameter was present in a
received EPS-SubscriptionData parameter within InsertSubscriberDataArg.
**Network-Access-Mode** AVP shall be present if a networkAccessMode parameter
was present within InsertSubscriberDataArg.
**Operator-Determined-Barring** AVP shall be present if an odb-GeneralData
parameter was present within an odb-Data parameter within a SubscriberData
parameter within InsertSubscriberDataArg.
**HPLMN-ODB** AVP shall be present if an odb-HPLMN-Data parameter was present
within an odb-Data parameter within a SubscriberData parameter within
InsertSubscriberDataArg.
**Regional-Subscription-Zone-Code** AVPs shall be present if ZoneCodes were
present within an regionalSubscriptionData parameter within a SubscriberData
parameter within InsertSubscriberDataArg.
**Access-Restriction-Data** AVP shall be present if accessRestrictionData or
ext-AccessRestrictionData parameters were present within
InsertSubscriberDataArg, and/or a ho-to-non-3GPP-Access-Not-Allowed parameter
was present in an eps-SubscriptionData parameter within
InsertSubscriberDataArg.
**APN-OI-Replacement** AVP shall be present if an apn-oi-Replacement parameter
was present within an eps-SubscriptionData parameter within
InsertSubscriberDataArg.
**3GPP-Charging-Characteristics** AVP shall be present if a
chargingCharacteristics parameter was present within InsertSubscriberDataArg.
**AMBR** AVP shall be present if an ambr parameter was present within an eps-
SubscriptionData parameter within InsertSubscriberDataArg.
**APN-Configuration-Profile** AVP shall be present if an apn-
ConfigurationProfile parameter was present within an eps-SubscriptionData
parameter within InsertSubscriberDataArg.
**RAT-Frequency-Selection-Priority-ID** AVP shall be present if a rfsp-id
parameter was present within an eps-SubscriptionData parameter within
InsertSubscriberDataArg.
**Adjacent-Access-Restriction-Data** AVP shall be present if
adjacentAccessRestrictionDataList was present within InsertSubscriberDataArg.
\- **IMSI-Group-Id** AVP shall be present if imsi-Group-Id-List was present
within InsertSubscriberDataArg**.**
**\- Trace-Data AVP** shall be present if a MAP ActivateTraceMode message has
been received from the HSS. Sub-AVPs in Trace-Data AVP shall be populated as
follows:
**\- Trace-Reference** AVP shall be present and populated with the values
received within the traceReference and traceReference2 parameters within
ActivateTraceModeArg.
**\- Trace-Depth-List** AVP shall be present if a Trace-DepthList parameter
was present within ActivateTraceModeArg.
**\- Trace-NE-Type-List** AVP shall be present if a TraceNE-TypeList parameter
was present within ActivateTraceModeArg.
**\- Trace-Depth-List** AVP shall be present if a Trace-DepthList parameter
was present within ActivateTraceModeArg.
**\- Trace-Interface-List** AVP shall be present if a TraceInterfaceList
parameter was present within ActivateTraceModeArg.
**\- Trace-Event-List** AVP shall be present if a TraceEventList parameter was
present within ActivateTraceModeArg.
\- **OMC-Id** AVP shall be present if a OMC-Id parameter was present within
ActivateTraceModeArg.
\- **Trace-Collection-Entity** AVP shall be present if a TraceCollectionEntity
parameter was present within ActivateTraceModeArg.
\- **MDT-Configuration** AVP shall be present if a MDT-Configuration parameter
was present within ActivateTraceModeArg.
**GPRS-Subscription-Data** AVP shall be present if a gprsSubscriptionData
parameter was present within InsertSubscriberDataArg.
> **LCS-Info** AVP shall be present if a LCS Information parameter was present
> within InsertSubscriberDataArg.
**CSG-Subscription-Data** AVPs shall be populated with information received
within the csg-SubscriptionDataList parameter within InsertSubscriberDataArg.
**Roaming-Restricted-Due-To-Unsupported-Feature** AVP shall be present and set
to \"Roaming-Restricted-Due-To-Unsupported-Feature (0)\" if the parameter
roamingRestrictedInSgsnDueToUnsupportedFeature was present within
InsertSubscriberDataArg. Otherwise shall be absent.
> **Teleservice-List** AVP shall be present if a Teleservice List parameter
> was present within InsertSubscriberDataArg.
>
> **Call-Barring-Info** AVPs shall be present if call barring SS-code and SS-
> status parameters were present within InsertSubscriberDataArg and the SS-
> Code AVP and SS-Status AVP within the Call-Barring-Info AVPs shall be
> populated with the values of the received call barring SS-code and SS-status
> parameters within InsertSubscriberDataArg.
>
> **MDT-User-Consent** AVP shall be present if a MDT User Consent parameter
> was present within InsertSubscriberDataArg.
**Subscribed-VSRVCC** AVP shall be present if a Subscribed vSRVCC parameter
was present in a received EPS-SubscriptionData parameter within
InsertSubscriberDataArg.
**PS-and-SMS-Only-Service-Provision** AVP shall be present if a psAndSMS-
OnlyServiceProvision parameter was present within InsertSubscriberDataArg.
**SMS-In-SGSN-Allowed** AVP shall be present if an smsInSGSNAllowed parameter
was present within InsertSubscriberDataArg.
### 8.2.3 UpdateGprsLocationArg mapping to ULR
When the IWF needs to construct an ULR command as a result of receiving an
UpdateGprsLocation message without a pdn-gw-update parameter within eps-info
and without an isr-Information parameter within eps-info not indicating
updateLocation or without a skipSubscriberDataUpdate parameter within add-info
(see section 7.2.2 step 3), the IWF shall populate AVPs of ULR as described
below:
**Auth-Session-State** AVP shall be set to the value NO_STATE_MAINTAINED (1).
**User-Name** AVP shall be populated with the value received within the imsi
parameter of UpdateGprsLocationArg.
**Supported-Features** AVP shall be populated with a value mapped from
received parameter supportedFeatures within sgsn-Capability.
**Terminal-Information** AVP shall be present if an add-info parameter was
received within UpdateGprsLocationArg. If present the received value of the
imeisv parameter shall be mapped onto IMEI and (if present) Software Version.
**RAT-Type** AVP shall be populated with the value received within the
usedRAT-Type parameter of UpdateGprsLocationArg
**ULR-Flags** AVP: Flags shall be set as follows:
**Single-Registration-Indication** shall be set to 1 if the ISR-Information
parameter within the EPS-Info parameter within UpdateGprsLocationArg is
present and indicates \"cancelSGSN\"; otherwise shall be set to 0.
\- **S6a/S6d-Indicator** shall be set to 1 if the servingNodeTypeIndicator
parameter was present in UpdateGprsLocationArg; otherwise shall be set to 0.
\- **Skip Subscriber Data** shall be set to 1 if a skipSubscriberData
parameter was present in UpdateGprsLocationArg; otherwise shall be set to 0.
**\- GPRS-Subscription-Data-Indicator** shall be set to 1 if the \"GPRS
Subscription Data not needed Indicator\" was absent from
UpdateGprsLocationArg; otherwise shall be set to 0.
**-** **Node-Type-Indicator** shall be set to 1 if the \"Node-Type Indicator\"
was present in UpdateGprsLocationArg; otherwise shall be set to 0.
**\- Initial-Attach-Indicator** shall be set to 1 if the
initialAttachIndicator parameter within the ISR-Information parameter within
the EPS-Info parameter within UpdateGprsLocationArg is present; otherwise
shall be set to 0.
**Visited-PLMN-Id** AVP shall populated with a value derived from the sgsn-
Number parameter received within UpdateGprsLocationArg.
**SGSN-Number** AVP shall be populated with the value received within the SGSN
Number parameter of UpdateGprsLocationArg.
**UE-SRVCC-Capability** AVP shall be present if a ue-srvcc-Capability
parameter was present in UpdateGprsLocationArg. If present the AVP shall be
populated with the received ue-srvcc-Capability parameter.
**MME-Number-for-MT-SMS** AVP shall be populated with the value received
within the mmeNumberforMTSMS parameter of UpdateGprsLocationArg.
**SMS-Register-Request** AVP shall be populated with the value received within
the smsRegisterRequest parameter of UpdateGprsLocationArg.
**SMS-Only** AVP shall be populated with the value received within the sms-
Only parameter of UpdateGprsLocationArg.
**Adjacent-PLMNs** AVP shall be constructed with the values received within
the adjacentPLMN-List parameter of UpdateGprsLocationArg.
### 8.2.4 ULA mapping to InsertSubscriberDataArg/
ActivateTraceModeArg/UpdateGprsLocationRes/Error
When the IWF needs to construct a MAP InsertSubscriberData messages and/or a
MAP- ActivateTraceMode message and/or a MAP-UpdateGprsLocation Ack message, as
a result of receiving an ULA command (see sections 7.2.2 steps 5 and 6), the
IWF shall populate sub-parameters of InsertSubscriberDataArg,
ActivateTraceModeArg and UpdateGprsLocationRes/Error as described below:
**InsertSubscriberDataArg** :
**imsi** in InsertSubscriberDataArg shall be absent.
**msisdn** in InsertSubscriberDataArg shall be populated with the value
received within the MSISDN AVP within the Subscription-Data AVP within ULA.
**category** in InsertSubscriberDataArg shall be absent.
**subscriberStatus** in InsertSubscriberDataArg shall be populated with the
value received within the Subscriber-Status AVP within the Subscription-Data
AVP within ULA.
**bearerServiceList** in InsertSubscriberDataArg shall be absent.
**teleserviceList** in InsertSubscriberDataArg shall be absent
**provisionedSS** in InsertSubscriberDataArg shall be absent.
**odb-Data** in InsertSubscriberDataArg shall be populated with the value
received within the Operator-Determined-Barring AVP and HPLMN-ODB AVP AVP
within the Subscription-Data AVP within ULA.
**roamingRestrictedDueToUnsupportedFeature** in InsertSubscriberDataArg shall
be absent.
**regionalSubscriptionData** in InsertSubscriberDataArg shall be populated
with the value received within the Regional-Subscription-Zone-Code AVPs within
the Subscription-Data AVP within ULA.
**vbsSubscriptionData** in InsertSubscriberDataArg shall be absent.
**vgcsSubscriptionData** in InsertSubscriberDataArg shall be absent
**vlrCamelsubscriptionInfo** in InsertSubscriberDataArg shall be absent.
**naea-PreferredCI** in InsertSubscriberDataArg shall be absent.
**gprsSubscriptionData** in InsertSubscriberDataArg shall be populated with
GPRS-Subscription Data received within the Subscription-Data AVP within ULA.
**roamingRestrictedInSgsnDueToUnsupportedFeature** in InsertSubscriberDataArg
shall be present if a Roaming-Restricted-Due-To-Unsupported-Feature AVP
Subscription-Data AVP within ULA.
**networkAccessMode** in InsertSubscriberDataArg shall be populated with the
value received within the Network-Access-Mode AVP within the Subscription-Data
AVP within ULA.
**lsaInformation** in InsertSubscriberDataArg shall be absent.
**lmu-Indicator** in InsertSubscriberDataArg shall be absent
**lcsInformation** in InsertSubscriberDataArg shall be absent.
**istAlertTimer** in InsertSubscriberDataArg shall be absent.
**superChargerSupportedInHLR** in InsertSubscriberDataArg shall be absent.
**mc-SS-Info** in InsertSubscriberDataArg shall be absent.
**cs-AllocationRetentionPriority** in InsertSubscriberDataArg shall be absent.
**sgsn-CAMEL-SubscriptionInfo** in InsertSubscriberDataArg shall be absent.
**chargingCharacteristics** in InsertSubscriberDataArg shall be populated with
the value received within the 3GPP-Charging-Characteristics AVP within the
Subscription-Data AVP within ULA.
**accessRestrictionData** and **ext-AccessRestrictionData** in
InsertSubscriberDataArg shall be populated according to the values received
within the Access-Restriction-Data AVP within the Subscription-Data AVP within
ULA.
**ics-Indicator** in InsertSubscriberDataArg shall be absent.
**LCS Information** in InsertSubscriberDataArg shall be populated with the
value received within the LCS-Info AVP within the Subscription-Data AVP within
ULA.
**Teleservice List** in InsertSubscriberDataArg shall be populated with the
value received within the Teleservice-List AVP within the Subscription-Data
AVP within ULA.
> SS-code and SS-status parameters of **Call Barring Information List** in
> InsertSubscriberDataArg shall be populated with the values of SS-Code AVP
> and SS-Status AVP received within the Call-Barring-Info AVPs within the
> Subscription-Data AVP within ULA.
**psAndSMS-OnlyServiceProvision** in InsertSubscriberDataArg shall be
populated with the value received within the Subscription-Data AVP within ULA.
> **smsInSGSNAllowed** in InsertSubscriberDataArg shall be populated with the
> value received within the Subscription-Data AVP within ULA.
>
> **adjacentAccessRestrictionDataList** in InsertSubscriberDataArg shall be
> constructed with the values received within the Adjacent-Access-Restriction-
> Data AVP within the Subscription-Data AVP within ULA.
>
> **imsi-Group-Id-List** in InsertSubscriberDataArg shall be constructed with
> the values received within the IMSI-Group-Id AVP within the Subscription-
> Data AVP within ULA.
Sub-parameters of **eps-SubscriptionData** in InsertSubscriberDataArg shall be
populated as follows:
**apn-oi-Replacement** shall be populated with the value received in the APN-
OI-Replacement AVP within the Subscription-Data AVP within ULA.
**rfsp-id** shall be populated with the value received within the RAT-
Frequency-Selection-Priority-ID AVP within the Subscription-Data AVP within
ULA.
**ambr** shall be populated with the value received within the AMBR AVP within
the Subscription-Data AVP within ULA.
**apn-ConfigurationProfile** shall be populated with the value received within
the APN-Configuration-Profile AVP within the Subscription-Data AVP within ULA.
**stn-sr** shall be populated with the value received within the STN-SR AVP
within the Subscription-Data AVP within ULA.
**csg-SubscriptionDataList** shall be populated with values received within
CSG-Subscription-Data AVPs within the Subscription-Data AVP within ULA.
**ue-ReachabilityRequestIndicator** shall be absent.
**mdtUserConsent** shall be populated with the value received within MDT-User-
Consent AVP within the Subscription-Data AVP within ULA.
**subscribed-vsrvcc** shall be present if the Subscribed-VSRVCC AVP is present
within the Subscription-Data AVP within ULA.
**pcscf-Restoration-Request** shall be absent.
**ActivateTraceModeArg** :
> **imsi** in ActivateTraceModeArg shall be absent.
>
> **TraceReference** shall be populated with the value of Trace-ID part of the
> Trace-Reference AVP received within the Trace-Data AVP within the
> Subscription-Data AVP within ULA.
>
> **TraceType** shall be present with any value.
>
> **TraceReference2** shall be populated with the value of MCC+MNC part of the
> Trace-Reference AVP received within the Trace-Data AVP within the
> Subscription-Data AVP within ULA.
>
> **TraceDepthList** shall be populated with the value received in the Trace-
> Depth-List AVP within the Trace-Data AVP within the Subscription-Data AVP
> within ULA.
>
> **TraceNE-TypeList** shall be populated with the value received in the
> Trace-NE-Type-List AVP within the Trace-Data AVP within the Subscription-
> Data AVP within ULA.
>
> **TraceInterfaceList** shall be populated with the value received in the
> Trace-Interface-List AVP within the Trace-Data AVP within the Subscription-
> Data AVP within ULA.
>
> **TraceEventList** shall be populated with the value received in the Trace-
> Event-List AVP within the Trace-Data AVP within the Subscription-Data AVP
> within ULA.
**Omc-Id** shall be populated with the value received in the OMC-Id AVP within
the Trace-Data AVP within the Subscription-Data AVP within ULA
> **TraceCollectionEntity** shall be populated with the address received
> within the Trace-Collection-Entity AVP within the Subscription-Data AVP
> within ULA.
**UpdateGprsLocationRes:**
**hlr-Number** in UpdateGprsLocationRes shall be populated with a value
locally assigned to the IWF and consistent with SS7 routing principles.
**extensionContainer** in UpdateGprsLocationRes shall be absent.
**add-Capability** in UpdateGprsLocationRes shall be present.
**sgsn-mmeSeparationSupported** in UpdateGprsLocationRes shall be present if
the Separation Indication within the ULA-Flags AVP was set to 1 within ULA.
**MDT-Configuration** shall be populated with the value received within the
MDT-Configuration AVP within the Subscription-Data AVP within ULA.
**mmeRegisteredforSMS** in UpdateGprsLocationRes shall be present if the \"MME
registered for SMS\" flag within the ULA-Flags AVP was set to 1 within ULA.
**UpdateGprsLocation Error:**
An error of **unknownSubscriber** with unknownSubscriberParam containing a
unknownSubscriberDiagnostic of \"imsiUnknown\" shall be sent if the received
ULA command contains an Experimental-Result AVP with a value of \"User
Unknown\".
An error of **unknownSubscriber** with unknownSubscriberParam containing a
unknownSubscriberDiagnostic of \"gprs-epsSubscriptionUnknown\" shall be sent
if the received ULA command contains an Experimental-Result AVP with a value
of \"Unknown EPS Subscription\".
Other values within the Result-Code / Experimental-Result AVP shall be mapped
onto an appropriate MAP error.
## 8.3 Mapping of Parameters for the Cancel Location Procedure
### 8.3.1 CancelLocationArg mapping to CLR
When the IWF needs to construct a CLR command as a result of receiving a MAP-
CancelLocation message (see sections 7.3.1 step 2, and 7.3.2 step 3), the the
IWF shall populate AVPs of CLR as described below:
**Auth-Session-State** AVP shall be set to the value NO_STATE_MAINTAINED (1).
**User-Name** AVP shall be populated with the imsi value received within the
identity parameter of CancelLocationArg.
**Supported-Features** AVP shall be absent.
**CancellationType** AVP shall contain the value MME_UPDATE_PROCEDURE if the
parameter CancellationType within CancelLocationArg was set to updateProcedure
and typeOfUpdate within CancelLocationArg was set to mme-change; the AVP shall
contain the value SGSN_UPDATE_PROCEDURE if the parameter CancellationType
within CancelLocationArg was set to updateProcedure and typeOfUpdate within
CancelLocationArg was set to sgsn-change; the AVP shall contain the value
SUBSCRIPTION_WITHDRAWAL if the parameter CancellationType within
CancelLocationArg was set to subscriptionWithdraw; the AVP shall contain the
value UPDATE_PROCEDURE_IWF if the parameter CancellationType within
CancelLocationArg was set to updateProcedure and typeOfUpdate within
CancelLocationArg was absent; the AVP shall contain the value
INITIAL_ATTACH_PROCEDURE if the parameter CancellationType within
CancelLocationArg was set to InitialAttachProcedure.
**CLR-Flags** AVP: Flags shall be set as follows:
\- **S6a/S6d-Indicator** shall be set to 1 if the TypeOfUpdate parameter was
present in CancelLocationArg and indicates \"mme-change\"; it shall be set to
0 if the TypeOfUpdate parameter was present in CancelLocationArg and indicates
\"sgsn-change\".
\- **Reattach-Required** shall be set to 1 if the reattach-Required parameter
was present in CancelLocationArg.
### 8.3.2 CLA mapping to CancelLocationRes/Error
When the IWF needs to construct MAP-CancelLocation Ack message as a result of
receiving an CLA command (see sections 7.3.1 step 4 and 7.3.2.step 5), the IWF
shall populate sub-parameters of CancelLocationRes/Error as described below:
**CancelLocationRes:**
**extensionContainer** in CancelLocationRes shall be absent.
**CancelLocation Error:**
Values other than SUCCESS within the Result-Code / Experimental-Result AVP
shall be mapped onto an appropriate MAP error.
### 8.3.3 CLR mapping to CancelLocationArg
When the IWF needs to construct a MAP-CancelLocation message as a result of
receiving a CLR command (see sections 7.3.2 step 2), the IWF shall open a MAP
dialogue in application context version 3 and populate sub-parameters of
CancelLocationArg as described below:
**identity** in CancelLocationArg shall be populated with the imsi value of
the User-Name AVP received within CLR.
**cancellationType** in CancelLocationArg shall contain a value of
updateProcedure if the Cancellation-Type AVP received in CLR contains the
value MME_UPDATE_PROCEDURE or SGSN_UPDATE_PROCEDURE. The parameter shall
contain a value of subscriptionWithdraw if the Cancellation-Type AVP received
in CLR contains the value SUBSCRIPTION_WITHDRAWAL. The parameter shall contain
a value of InitialAttachProcedure if the Cancellation-Type AVP received in CLR
contains the value INITIAL_ATTACH_PROCEDURE.
**extensionContainer** in CancelLocationArg shall be absent.
**typeOfUpdate** in CancelLocationArg shall be set to sgsn-change if
SGSN_UPDATE_PROCEDURE was received in the Cancellation-Type AVP within CLR, or
INITIAL_ATTACH_PROCEDURE was received in the Cancellation-Type AVP within CLR
and the S6a/S6d-Indicator flag was cleared in the CLR-Flags AVP within the
received CLR. It shall be set to mme-change if MME_UPDATE_PROCEDURE was
received in Cancellation-Type AVP within CLR, or if INITIAL_ATTACH_PROCEDURE
was received in the Cancellation-Type AVP within CLR and the S6a/S6d-Indicator
flag was set in the CLR-Flags AVP within the received CLR. Otherwise it shall
be absent.
**reattach-Required** in CancelLocationArg shall be present if the Reattach-
Required flag was set in the CLR-Flags AVP received within CLR.
### 8.3.4 CancelLocationRes / Error mapping to CLA
When the IWF needs to construct an CLA command as a result of receiving a
CancelLocation Ack/Error message (see sections 7.3.2 step 6), the IWF shall
populate AVPs of CLA as described below:
**Result-Code / Experimental-Result** AVP shall be set to:
\- DIAMETER_SUCCESS if a CancelLocationRes parameter was received in a TCAP
ResultLast component;
\- an appropriate DIAMETER base protocol result code otherwise.
**Supported-Features** AVP shall be absent.
**Auth-Session-State** AVP shall be set to the value NO_STATE_MAINTAINED (1).
## 8.4 Mapping of Parameters for the Purge Procedure
### 8.4.1 PUR mapping to PurgeMS-Arg
When the IWF needs to construct a MAP-PurgeMS message as a result of receiving
an PUR command (see sections 7.4.1 step 2 and 7.4.2. step 2), the IWF shall
open a MAP dialogue in application context version 3 and populate sub-
parameters of PurgeMS-Arg as described below:
**imsi** in PurgeMS-Arg shall be populated with the imsi value of the User-
Name AVP received within PUR.
**vlr-Number** in PurgeMS-Arg shall be absent.
**sgsn-Number** in PurgeMS-Arg shall be populated with a value locally
assigned to the IWF and consistent with SS7 routing principles.
**extensionContainer** in PurgeMS-Arg shall be absent.
### 8.4.2 PurgeMS-Res / Error mapping to PUA
When the IWF needs to construct an PUA command as a result of receiving a
PurgeMS Ack/Error message (see sections 7.4.1 step 4 and 7.4.2. step 6), the
IWF shall populate AVPs of PUA as described below:
**Result-Code / Experimental-Result** AVP shall be set to:
\- DIAMETER_SUCCESS if a PurgeMS-Res parameter was received in a TCAP
ResultLast component;
\- DIAMETER_ERROR_USER_UNKNOWN if an error of unknownSubscriber without a
diagnostic parameter or with a diagnostic parameter of imsiUnknown or gprs-
eps-SubscriptionUnknown was received;
\- an appropriate DIAMETER base protocol result code otherwise.
**Auth-Session-State** AVP shall be set to the value NO_STATE_MAINTAINED (1).
**PUA-Flags** AVP: Flags shall be set as follows:
\- **Freeze M-TMSI** shall be set to 1 if the freezeM-TMSI parameter was
present within PurgeMS-Res; otherwise shall be set to 0.
\- **Freeze P-TMSI** shall be set to 1 if the freezeP-TMSI parameter was
present within PurgeMS-Res; otherwise shall be set to 0.
### 8.4.3 PurgeMS-Arg mapping to PUR
When the IWF needs to construct a PUR command as a result of receiving a MAP-
PurgeMS message (see section 7.4.2 step 3), the the IWF shall populate AVPs of
PUR as described below:
**Auth-Session-State** AVP shall be set to the value NO_STATE_MAINTAINED (1).
**User-Name** AVP shall be populated with the value received within the imsi
parameter of PurgeMS-Arg.
**Supported-Features** AVP shall be absent.
### 8.4.4 PUA mapping to PurgeMS-Res/Error
When the IWF needs to construct MAP-PurgeMS Ack message as a result of
receiving a PUA command (see section 7.4.2.step 5), the IWF shall populate
sub-parameters of PurgeMS-Res/Error as described below:
**PurgeMS-Res:**
**freezeTMSI** in PurgeMS-Res shall be absent.
**freezeP-TMSI** in PurgeMS-Res shall be present if a Freeze-P-TMSI indication
was received within the PUA-Flags AVP within PUA.
**extensionContainer** in PurgeMS-Res shall be absent.
**freezeM-TMSI** in PurgeMS-Res shall be present if a Freeze-M-TMSI indication
was received within the PUA-Flags AVP within PUA.
**PurgeMS Error:**
An error of **unknownSubscriber** with unknownSubscriberParam containing a
unknownSubscriberDiagnostic of \"imsiUnknown\" shall be sent if the received
AIA command contains an Experimental-Result AVP with a value of \"User
Unknown\".
Values other than SUCCESS within the Result-Code / Experimental-Result AVP
shall be mapped onto an appropriate MAP error.
## 8.5 Mapping of Parameters for the Insert Subscriber Data Procedure
### 8.5.1 InsertSubscriberDataArg mapping to IDR
When the IWF needs to construct an IDR command as a result of receiving a MAP-
InsertSubscriberData message (see sections 7.5.1 step 2, and 7.5.2 step 3),
the IWF shall populate AVPs of IDR as described below:
**Auth-Session-State** AVP shall be set to the value NO_STATE_MAINTAINED (1).
**User-Name** AVP shall be populated with the value received within the imsi
parameter of InsertSubscriberDataArg.
**Supported-Features** AVP shall be absent.
**Subscription-Data** AVP: See chapter 8.2.2.
**IDR-Flags** AVP: Flags shall be set as follows:
UE Reachability Request shall be set to 1 if the ue-
reachabilityRequestIndicator was present within InsertSubscriberDataArg;
othewise shall be set to 0 or the AVP shall be absent.
P-CSCF Restoration Request flag shall be set to 1 if the pcscf-Restoration-
Request parameter was present within InsertSubscriberDataArg; otherwise shall
be set to 0 or the AVP shall be absent.
### 8.5.2 IDA mapping to InsertSubscriberDataRes/Error
When the IWF needs to construct a MAP-InsertSubscriberData Ack message as a
result of receiving an IDA command (see sections 7.5.1 step 4 and 7.5.2.step
5), the IWF shall populate sub-parameters of InsertSubscriberDataRes/Error as
described below:
**InsertSubscriberDataRes:**
**teleserviceList** in InsertSubscriberDataRes shall include all
teleserviceCodes that have been received within InsertSubscriberDataArg.
**bearerServiceList** in InsertSubscriberDataRes shall include all
bearerServiceCodes that have been received within InsertSubscriberDataArg.
**ss-List** in InsertSubscriberDataRes shall include all ssCodes that have
been received within InsertSubscriberDataArg.
**odb-GeneralData** in InsertSubscriberDataRes shall include all odb
categoties that have been requested within the received
InsertSubscriberDataArg but are not supported by the serving node as indicated
within the Supported-Feature AVP within IDA.
**regionalSubscriptionResponse** in InsertSubscriberDataRes\ -shall be set to
regionalSubscNotSupported if regional subscription was requested within the
received InsertSubscriberDataArg but is not supported by the serving node as
indicated within the Supported-Feature AVP within IDA.\ -shall be set to
networkNode-AreaRestricted if regional subscription was requested within the
received InsertSubscriberDataArg but a Network-Node-Area-Restricted indication
has been received within the IDA-Flags AVP within IDA.\ \- otherwise shall be
absent.
**supportedCamelPhases** in InsertSubscriberDataRes shall be absent or shall
indicate that no CAMEL phase is supported.
**extensionContainer** in CancelLocationRes shall be absent.
**offeredCamel4CSIs** in InsertSubscriberDataRes shall be absent.
**supportedFeatures** in InsertSubscriberDataRes shall be populated with the
information received within the Supported-Features AVP within IDA.
**InsertSubscriberData Error** :
Values other than SUCCESS within the Result-Code / Experimental-Result AVP
shall be mapped onto an appropriate MAP error.
### 8.5.3 IDR mapping to InsertSubscriberDataArg/ ActivateTraceModeArg
When the IWF needs to construct a MAP-InsertSubscriberData message or a MAP-
ActivateTraceMode message as a result of receiving an IDR command (see
sections 7.5.2 step 2, and 7.10.2 step 2), the IWF shall open a MAP dialogue
in application context version 3 and populate sub-parameters of
InsertSubscriberDataArg/ActivateTraceModeArg as described below:
**InsertSubscriberDataArg** :
**imsi** in InsertSubscriberDataArg shall be populated with the value received
within the User-Name AVP within IDR.
**msisdn** in InsertSubscriberDataArg shall be populated with the value
received within the MSISDN AVP within the Subscription-Data AVP within IDR.
**category** in InsertSubscriberDataArg shall be absent.
**subscriberStatus** in InsertSubscriberDataArg shall be populated with the
value received within the Subscriber-Status AVP within the Subscription-Data
AVP within IDR.
**bearerServiceList** in InsertSubscriberDataArg shall be absent.
**teleserviceList** in InsertSubscriberDataArg shall be absent
**provisionedSS** in InsertSubscriberDataArg shall be absent.
**odb-Data** in InsertSubscriberDataArg shall be populated with the value
received within the Operator-Determined-Barring AVP and HPLMN-ODB AVP AVP
within the Subscription-Data AVP within IDR.
**roamingRestrictedDueToUnsupportedFeature** in InsertSubscriberDataArg shall
be absent.
**regionalSubscriptionData** in InsertSubscriberDataArg shall be populated
with the value received within the Regional-Subscription-Zone-Code AVPs within
the Subscription-Data AVP within IDR.
**vbsSubscriptionData** in InsertSubscriberDataArg shall be absent.
**vgcsSubscriptionData** in InsertSubscriberDataArg shall be absent
**vlrCamelsubscriptionInfo** in InsertSubscriberDataArg shall be absent.
**naea-PreferredCI** in InsertSubscriberDataArg shall be absent.
**gprsSubscriptionData** in InsertSubscriberDataArg shall bepopulated with
GPRS-Subscription Data received within the Subscription-Data AVP within IDR.
**roamingRestrictedInSgsnDueToUnsupportedFeature** in InsertSubscriberDataArg
shall be present if a Roaming-Restricted-due-To-Unsupported-Feature AVP was
received within the Subscription-Data AVP within IDR.
**networkAccessMode** in InsertSubscriberDataArg shall be populated with the
value received within the Network-Access-Mode AVP within the Subscription-Data
AVP within IDR.
**lsaInformation** in InsertSubscriberDataArg shall be absent.
**lmu-Indicator** in InsertSubscriberDataArg shall be absent
**lcsInformation** in InsertSubscriberDataArg shall be absent.
**istAlertTimer** in InsertSubscriberDataArg shall be absent.
**superChargerSupportedInHLR** in InsertSubscriberDataArg shall be absent.
**mc-SS-Info** in InsertSubscriberDataArg shall be absent.
**cs-AllocationRetentionPriority** in InsertSubscriberDataArg shall be absent.
**sgsn-CAMEL-SubscriptionInfo** in InsertSubscriberDataArg shall be absent.
**chargingCharacteristics** in InsertSubscriberDataArg shall be populated with
the value received within the 3GPP-Charging-Characteristics AVP within the
Subscription-Data AVP within IDR.
**accessRestrictionData** and **ext-AccessRestrictionData** in
InsertSubscriberDataArg shall be populated according to the values received
within the Access-Restriction-Data AVP within the Subscription-Data AVP within
IDR.
**ics-Indicator** in InsertSubscriberDataArg shall be absent.
**LCS Information** in InsertSubscriberDataArg shall be populated with the
value received within the LCS-Info AVP within the Subscription-Data AVP within
ULA.
**Teleservice List** in InsertSubscriberDataArg shall be populated with the
value received within the Teleservice-List AVP within the Subscription-Data
AVP within ULA.
**Call Barring Information List** in InsertSubscriberDataArg shall be
populated with the value received within the Call- Barring-Infor-List AVP
within the Subscription-Data AVP within ULA.
**adjacentAccessRestrictionDataList** in InsertSubscriberDataArg shall be
constructed with the value received within the Adjacent-Access-Restriction-
Data AVP within the Subscription-Data AVP within IDR.
**imsi-Group-Id-List** in InsertSubscriberDataArg shall be constructed with
the values received within the IMSI-Group-Id AVP within the Subscription-Data
AVP within IDR.
\- Sub-parameters of **eps-SubscriptionData** in InsertSubscriberDataArg shall
be populated as follows:
**apn-oi-Replacement** shall be populated with the value received in the APN-
OI-Replacement AVP within the Subscription-Data AVP within IDR.
**rfsp-id** shall be populated with the value received within the RAT-
Frequency-Selection-Priority-ID AVP within the Subscription-Data AVP within
IDR.
**ambr** shall be populated with the value received within the AMBR AVP within
the Subscription-Data AVP within IDR.
**apn-ConfigurationProfile** shall be populated with the value received within
the APN-Configuration-Profile AVP within the Subscription-Data AVP within IDR.
**stn-sr** shall be populated with the value received within the STN-SR AVP
within the Subscription-Data AVP within IDR.
**subscribed-vsrvcc** shall be present if the Subscribed-VSRVCC AVP is present
within the Subscription-Data AVP within IDR.
**csg-SubscriptionDataList** in InsertSubscriberDataArg shall be populated
with information received within the CSG-Subscription-Data AVPs within the
Subscription-Data AVP within IDR.
**ue-ReachabilityRequestIndicator** in the InsertSubscriberDataArg shall be
present if the corresponding information was present within the IDR-Flags AVP
within an IDR; otherwise it shall be absent.
> **psAndSMS-OnlyServiceProvision** in InsertSubscriberDataArg shall be
> populated with the information received within the PS-and-SMS-Only-Service-
> Provision AVP within the Subscription-Data AVP within IDR.
>
> **smsInSGSNAllowed** in InsertSubscriberDataArg shall be populated with the
> information received within the SMS-In-SGSN-Allowed AVP within the
> Subscription-Data AVP within IDR.
>
> **pcscf-Restoration-Request** in the InsertSubscriberDataArg shall be
> present if the corresponding information was present within the IDR-Flags
> AVP within an IDR; otherwise it shall be absent.
**ActivateTraceModeArg** :
**imsi** shall be populated with the value received within the User-Name AVP
within IDR.
**TraceReference** shall be populated with the value of Trace-ID part of the
Trace-Reference AVP received within the Trace-Data AVP within the
Subscription-Data AVP within IDR.
**TraceType** shall be present with any value.
**TraceReference2** shall be populated with the value of MCC+MNC part of the
Trace-Reference AVP received within the Trace-Data AVP within the
Subscription-Data AVP within IDR.
**TraceDepthList** shall be populated with the value received in the Trace-
Depth-List AVP within the Trace-Data AVP within the Subscription-Data AVP
within IDR.
**TraceNE-TypeList** shall be populated with the value received in the Trace-
NE-Type-List AVP within the Trace-Data AVP within the Subscription-Data AVP
within IDR.
**TraceInterfaceList** shall be populated with the value received in the
Trace-Interface-List AVP within the Trace-Data AVP within the Subscription-
Data AVP within IDR.
**TraceEventList** shall be populated with the value received in the Trace-
Event-List AVP within the Trace-Data AVP within the Subscription-Data AVP
within IDR.
**Omc-Id** shall be populated with the value received in the OMC-Id AVP within
the Trace-Data AVP within the Subscription-Data AVP within IDR.
**TraceCollectionEntity** shall be populated with the address received within
the Trace-Collection-Entity AVP within the Subscription-Data AVP within IDR.
### 8.5.4 InsertSubscriberDataRes / Error mapping to IDA
When the IWF needs to construct an IDA command as a result of receiving an
InsertSubscriberData Ack/Error message (see sections 7.5.2 step 8), the IWF
shall populate AVPs of IDA as described below:
**Result-Code / Experimental-Result** AVP shall be set to:
\- DIAMETER_SUCCESS if no InsertSubscriberData error component was received;
\- an appropriate DIAMETER base protocol result code otherwise.
**Auth-Session-State** AVP shall be set to the value NO_STATE_MAINTAINED (1).
**IDA-Flags** AVP**:** Flags shall be set as follows:\ \- **Network-Node-Area-
Restricted** shall be set to 1 if the regionalSubscriptionResponse parameter
within InsertSubscriberDataRes indicated regionalSubscNotSupported; otherwise
shall be set to 0.
**Supported-Features** AVP: Support of features shall be indicated according
to information received within the supportedFeatures parameter within
InsertSubscriberDataRes.
### 8.5.5 ProvideSubscriberInfoArg mapping to IDR
When the IWF needs to construct an IDR command as a result of receiving a MAP-
ProvideSubscriberInfo message (see sections 7.5.1 step 2, and 7.5.2 step 3),
the IWF shall populate AVPs of IDR as described below:
**Auth-Session-State** AVP shall be set to the value NO_STATE_MAINTAINED (1).
**User-Name** AVP shall be populated with the value received within the imsi
parameter of ProvideSubscriberInfoArg.
**Supported-Features** AVP shall be absent.
**Subscription-Data** AVP shall be empty.
**IDR-Flags** AVP: Flags shall be set as follows:
> **UE Reachability Request** shall be set to 0.
>
> **T-ADS Data Request** shall be set to 1 if the t-adsData within the
> RequestedInfo parameter within ProvideSubscriberInfoArg was present;
> otherwise it shall be set to 0 or the AVP shall be absent.
>
> **EPS User State Request** shall be set to 1 if the subscriberState within
> the RequestedInfo parameter was present within ProvideSubscriberInfoArg;
> otherwise it shall be set to 0 or the AVP shall be absent.
>
> **EPS Location Information Request** shall be set to 1 if the
> locationInformation within the RequestedInfo parameter was present within
> ProvideSubscriberInfoArg; otherwise it shall be set to 0 or the AVP shall be
> absent.
>
> **Current Location Request** shall be set to 1 if the currentLocation within
> the RequestedInfo parameter was present within ProvideSubscriberInfoArg;
> otherwise it shall be set to 0.
>
> **Local Time Zone Request** shall be set to 1 if the localTimeZoneRequest
> within the RequestedInfo parameter was present within
> ProvideSubscriberInfoArg; otherwise it shall be set to 0.
>
> **P-CSCF Restoration Request** shall be set to 0.
### 8.5.6 IDA mapping to ProvideSubscriberInfoRes/Error
When the IWF needs to construct a MAP-ProvideSubscriberInfo Ack message as a
result of receiving an IDA command (see sections 7.5.1 step 4 and 7.5.2.step
5), the IWF shall populate sub-parameters of ProvideSubscriberInfoRes/Error as
described below:
P**rovideSubscriberInfoRes:**
Sub-parameters of **SubscriberInfo** in ProvideSubscriberInfoRes shall be
populated as follows:
**imsVoiceOverPS-SessionsIndication** shall be populated with the value
received in the IMS-Voice-Over-PS-Sessions-Supported AVP within IDA.
**lastUE-ActivityTime** shall be populated with the value received in the
Last-UE-Activity-Time AVP within IDA.
**lastRAT-Type** shall be populated with the value received in the RAT-Type
AVP within IDA.
**eps-SubscriberState** shall be populated with the value received in the EPS-
User-State AVP within IDA.
Sub-parameters of **locationInformationEPS** shall be populated with the
values of the corresponding AVPs received in the EPS-Location-Information AVP
within IDA.
**timeZone** shall be populated with the value received in the Time-Zone AVP
within IDA.
**daylightSavingTime** shall be populated with the value received in the
Daylight-Saving-Time AVP within IDA.
**extensionContainer** in ProvideSubscriberInfoRes shall be absent.
P**rovideSubscriberInfo Error** :
Values other than SUCCESS within the Result-Code / Experimental-Result AVP
shall be mapped onto an appropriate MAP error.
### 8.5.7 IDR mapping to ProvideSubscriberInfoArg
When the IWF needs to construct a MAP-ProvideSubscriberInfo message as a
result of receiving an IDR command (see sections 7.5.2 step 2), the IWF shall
open a MAP dialogue in application context version 3 and populate sub-
parameters of ProvideSubscriberInfoArg as described below:
**ProvideSubscriberInfoArg** :
**imsi** in ProvideSubscriberInfoArg shall be populated with the value
received within the User-Name AVP within IDR.
**lmsi** in ProvideSubscriberInfoArg shall be absent.
Sub-parameters of **requestedInfo** in ProvideSubscriberInfoArg shall be
populated as follows:
> **t-adsData** in requestedInfo shall be present if the \"T-ADS Data
> Request\" flag was set in the IDR-Flags AVP within IDR.
>
> **subscriberState** in requestedInfo shall be present if the \"EPS User
> State Request\" flag was set in the IDR-Flags AVP within IDR.
>
> **locationInformation** in requestedInfo shall be present if the \"EPS
> Location Information Request\" flag was set in the IDR-Flags AVP within IDR.
>
> **currentLocation** in requestedInfo shall be present if the \"Current
> Location Request\" flag was set in the IDR-Flags AVP within IDR.
>
> **localTimeZoneRequest** in requestedInfo shall be present if the \"Local
> Time Zone Request\" flag was set in the IDR-Flags AVP within IDR.
**extensionContainer** in ProvideSubscriberInfoArg shall be absent.
**callPriority** in ProvideSubscriberInfoArg shall be absent.
### 8.5.8 ProvideSubscriberInfoRes/Error mapping to IDA
When the IWF needs to construct an IDA command as a result of receiving an
ProvideSubscriberInfo Ack/Error message (see sections 7.5.2 step 8), the IWF
shall populate AVPs of IDA as described below:
**Auth-Session-State** AVP shall be set to the value NO_STATE_MAINTAINED (1).
**Supported-Features** AVP shall be absent.
**Result-Code / Experimental-Result** AVP shall be set to:
\- DIAMETER_SUCCESS if no ProvideSubscriberInfo error component was received;
\- an appropriate DIAMETER base protocol result code otherwise.
**IMS-Voice-Over-PS-Sessions-Supported** AVP shall be populated with the value
received within the imsVoiceOverPS-SessionsIndication parameter within the
SubscriberInfo parameter of ProvideSubscriberInfoRes.
**Last-UE-Activity-Time** AVP shall be populated with the value received
within the lastUE-ActivityTime parameter within the SubscriberInfo parameter
of ProvideSubscriberInfoRes.
**RAT-Type** AVP shall be populated with the value received within the
lastRAT-Type parameter within the SubscriberInfo parameter of
ProvideSubscriberInfoRes.
**EPS-User-State** AVP shall be populated with the value received within the
eps-SubscriberState parameter within the SubscriberInfo parameter of
ProvideSubscriberInfoRes.
AVPs within **EPS-Location-Information** AVP shall be populated with the
values of the corresponding sub-parameters received within the
locationInformationEPS parameter within the SubscriberInfo parameter of
ProvideSubscriberInfoRes.
**IDA-Flags** AVP shall be absent.
AVPs within **Local-Time-Zone** AVP shall be populated as follows:
**\- Time-Zone** AVP shall be populated with the value received within the
timeZone parameter within the SubscriberInfo parameter of
ProvideSubscriberInfoRes.
**\- Daylight-Saving-Time** AVP shall be populated with the value received
within the daylightSavingTime parameter within the SubscriberInfo parameter of
ProvideSubscriberInfoRes.
## 8.6 Mapping of Parameters for the Delete Subscriber Data Procedure
### 8.6.1 DeleteSubscriberDataArg mapping to DSR
When the IWF needs to construct a DSR command as a result of receiving a MAP-
DeleteSubscriberData message (see sections 7.6.1 step 2, and 7.6.2 step 3),
the the IWF shall populate AVPs of DSR as described below:
**Auth-Session-State** AVP shall be set to the value NO_STATE_MAINTAINED (1).
**User-Name** AVP shall be populated with the value received within the imsi
parameter of DeleteSubscriberDataArg.
**Supported-Features** AVP shall be absent.
**DSR-Flags** AVP: Flags shall be set as follows:
\- **RegionalSubscriptionWithdrawal** shall be set to 1 if a
regionalSubscriptionIdentifier parameter was present in
DeleteSubscriberDataArg; otherwise shall be set to 0.
\- **Complete APN Configuration Profile Withdrawal** shall be set to 1 if the
allEPS-Data parameter was present within the EPS-SubscriptionDataWithdraw
parameter within DeleteSubscriberDataArg; otherwise shall be set to 0.
\- **Subscribed Charging Characteristics Withdrawal** shall be set to 1 if the
chargingCharacteristicsWithdraw parameter was present within
DeleteSubscriberDataArg; otherwise shall be set to 0.
\- **PDN Subscription Context Withdrawal** shall be set to 1 if the
contextIdList parameter was present within the EPS-SubscriptionDataWithdraw
parameter within DeleteSubscriberDataArg; otherwise shall be set to 0.
\- **STN-SR** shall be set to 1 if the stn-srWithdraw parameter was present
within DeleteSubscriberDataArg; otherwise shall be set to 0.
\- **GMLC List Withdrawal** shall be set to 1 if the GMLC List Withdraw
parameter was present within DeleteSubscriberDataArg; otherwise shall be set
to 0.
\- **LCS Withdrawal** shall be set to 1 if the SS code list parameter was
present within DeleteSubscriberDataArg; otherwise shall be set to 0.
\- **Complete PDP context list Withdrawal** shall be shall be set to 1 if the
allGPRS-Data parameter was present within the GPRS-SubscriptionDataWithdraw
parameter within DeleteSubscriberDataArg; otherwise shall be set to 0.
\- **PDP context Withdrawal** shall be set to 1 if the contextIdList parameter
was present within the GPRS-SubscriptionDataWithdraw parameter within
DeleteSubscriberDataArg; otherwise shall be set to 0.
\- **Roaming Restricted in due to unsupported feature** shall be set to 1 if
the roamingRestrictedInSgsnDueToUnsupportedFeature parameter was present
within DeleteSubscriberDataArg; otherwise shall be set to 0.
\- **Trace Data Withdrawal** shall be set to 0.
\- **CSG Deleted** shall be set to 1 if the csg-SubscriptionDeleted parameter
was present within DeleteSubscriberDataArg; otherwise shall be set to 0.
**\- APN-OI-Replacement** shall be set to 1 if the apn-oi-replacementWithdraw
parameter was present within DeleteSubscriberDataArg; otherwise shall be set
to 0.
\- **SMS Withdrawal** shall be set to 1 if the SS-Code list parameter was
present within DeleteSubscriberDataArg and the service codes are related to
short message services; otherwise shall be set to 0.
\- **Subscribed VSRVCC Withdrawal** shall be set to 1 if the subscribed-
vsrvccWithdraw parameter was present within DeleteSubscriberDataArg; otherwise
shall be set to 0.
**Context-Identifier** AVPs shall be populated with values received within the
contextIdList parameter within EPS-SubscriptionDataWithdraw or GPRS-
SubscriptionDataWithdraw within DeleteSubscriberDataArg;
### 8.6.2 DSA mapping to DeleteSubscriberDataRes/Error
When the IWF needs to construct a MAP-DeleteSubscriberData Ack message as a
result of receiving a DSA command (see sections 7.6.1 step 4 and 7.6.2.step
5), the IWF shall populate sub-parameters of DeleteSubscriberDataRes/Error as
described below:
**DeleteSubscriberDataRes:**
**regionalSubscriptionResponse** in DeleteSubscriberDataRes shall be set to:
\- regionalSubscNotSupported if a corresponding information was received
within the Supported-Feature AVP within DSA .
\- networkNode-AreaRestricted if a Network-Node-Area-Restricted indication was
received within the DSA-Flags AVP within DSA.
**extensionContainer** in DeleteSubscriberDataRes shall be absent.
**DeleteSubscriberData Error:**
Values other than SUCCESS within the Result-Code / Experimental-Result AVP
shall be mapped onto an appropriate MAP error.
### 8.6.3 DSR mapping to DeleteSubscriberDataArg/ DeactivateTraceModeArg
When the IWF needs to construct a MAP-DeleteSubscriberData message or a MAP-
DeactivateTraceMode message as a result of receiving a DSR command (see
sections 7.6.2 step 2, 7.11.2 step 2), the IWF shall open a MAP dialogue in
application context version 3 and populate sub-parameters of
DeleteSubscriberDataArg/DeactivateTraceModeArg as described below:
**DeleteSubscriberDataArg** :
**imsi** in DeleteSubscriberDataArg shall be populated with the value of the
User-Name AVP received within DSR.
**basicServiceList** in DeleteSubscriberDataArg shall be absent.
**ss-List** in DeleteSubscriberDataArg shall be absent.
**roamingRestrictionDueToUnsupportedFeature** in DeleteSubscriberDataArg shall
be absent.
**regionalSubscriptionIdentifier** in DeleteSubscriberDataArg shall be present
if a Regional-Subscription-Withdrawal indication has been received within the
DSR-Flags AVP within DSR. If present, the value of the ZoneCode is arbitrary.
**vbsGroupIndication** in DeleteSubscriberDataArg shall be absent.
**vgcsGroupIndication** in DeleteSubscriberDataArg shall be absent.
**camelSubscriptionInfoWithdraw** in DeleteSubscriberDataArg shall be absent.
**extensionContainer** in DeleteSubscriberDataArg shall be absent.
**gprsSubscriptionDataWithdraw** in DeleteSubscriberDataArg shall be present
if corresponding information was received within the DSR-Flags AVP and GPRS-
Context-Identifier AVPs within DSR.
**roamingRestrictedInSgsnDueToUnsupportedFeature** in DeleteSubscriberDataArg
shall be present if a corresponding indication has been received within the
DSR-Flags AVP within DSR.
**lsaInformationWithdraw** in DeleteSubscriberDataArg shall be absent.
**gmlc-ListWithdraw** in DeleteSubscriberDataArg shall be absent.
**istInformationWithdraw** in DeleteSubscriberDataArg shall be absent.
**specificCSI-Withdraw** in DeleteSubscriberDataArg shall be absent.
**chargingCharacteristicsWithdraw** in DeleteSubscriberDataArg shall be
present if a Subscribed-Charging-Characteristics-Withdrawl indication was
received within the DSR-Flags AVP within DSR.
**stn-srWithdraw** in DeleteSubscriberDataArg shall be present if a STN-SR
indication was received within the DSR-Flags AVP within DSR.
**epsSubscriptionDataWithdraw** in DeleteSubscriberDataArg shall be present if
a Complete-APN-Configuration-Profil-Withdrawal indication or a PDN-
Subscription-Context-Withdrawl indication was received within the DSR-Flags
AVP. The sub-parameter allEPS-Data shall be present if a Complete-APN-
Configuration-Profile-Withdrawl indication was was received in the DSR-Flags
AVP within DSR. The sub-parameter contextIdList shall be present if a PDN-
Subscription-Context-Withdrawl indication was received within the DSR-Flags
AVP within DSR; if so, the contextIdList shall be populatede with values
received within the Context-Identifier AVPs within DSR.
**GMLC List Withdraw** in DeleteSubscriberDataArg shall be present if a GMLC
List Withdrawal indication was received within the DSR-Flags AVP.
**SS-Code List** in DeleteSubscriberDataArg shall be present if corresponding
information was received within the DSR-Flags AVP and SS-Code AVPs within DSR.
**apn-oi-replacementWithdraw** in DeleteSubscriberDataArg shall be present if
a APN-OI-Replacement indication was received within the DSR-Flags AVP within
DSR.
**csg-SubscriptionDeleted** in DeleteSubscriberDataArg shall be present if a
CSG Deleted indication was received within the DSR-Flags AVP within DSR.
**SS-Code List** in DeleteSubscriberDataArg shall be present if SMS Withdrawal
bit was set within the DSR-Flags AVP and SS-Code AVPs was within DSR.
**subscribed-vsrvccWithdraw** in DeleteSubscriberDataArg shall be present if a
Subscribed VSRVCC Withdrawal indication was received within the DSR-Flags AVP
within DSR.
**DeactivateTraceModeArg** :
> **imsi** in DeactivateTraceModeArg shall be populated with the value
> received within the User-Name AVP within DSR.
>
> **TraceReference** in DeactivateTraceModeArg shall be populated with the
> value of Trace-ID part of the Trace-Reference AVP received within DSR.
>
> **TraceReference2** in DeactivateTraceModeArg shall be populated with the
> value of MCC+MNC part of the Trace-Reference AVP received within DSR.
### 8.6.4 DeleteSubscriberDataRes / Error mapping to DSA
When the IWF needs to construct a DSA command as a result of receiving a
DeleteSubscriberData Ack/Error message (see sections 7.6.2 step 6), the IWF
shall populate AVPs of DSA as described below:
**Result-Code / Experimental-Result** AVP shall be set to:
\- DIAMETER_SUCCESS if a DeleteSubscriberDataRes parameter was received in a
TCAP ResultLast component;
\- an appropriate DIAMETER base protocol result code otherwise.
**Auth-Session-State** AVP shall be set to the value NO_STATE_MAINTAINED (1).
**Supported-Features** AVP shall be present and shall indicate support of
Regional Subscription if a Regional-Subscription-Withdrawal indication was
present within the DSR-Flags AVP within DSR and no regionalSubscNotSupported
indication was received in regionalSubscriptionResponse in
DeleteSubscriberDataRes.
**DSA-Flags** AVP: Flags shall be set as follows:
\- **Network-Node-Area-Restricted** shall be set to 1 if a networkNode-
AreaRestricted indication was received within the regionalSubscriptionResponse
parameter within DeleteSubscriberDataRes; otherwise shall be set to 0.
## 8.7 Mapping of Parameters for the Reset Procedure
### 8.7.1 Reset (v1 or v2) mapping to RSR
When the IWF needs to construct a RSR command as a result of receiving a MAP-
Reset message with AC version 1 or version 2 (see sections 7.7.1 step 2, and
7.7.2 step 4), the the IWF shall populate AVPs of RSR as described below:
**Auth-Session-State** AVP shall be set to the value NO_STATE_MAINTAINED (1).
**User-Id** AVPs shall be populated with the values received within the HLR-Id
parameters within hlr-list within ResetArg.
**Supported-Features** AVP shall be absent.
### 8.7.2 RSR mapping to ResetArg (v1 or v2)
When the IWF needs to construct MAP-Reset message as a result of receiving a
RSR command (see section 7.7.2 step 2), the IWF shall open a MAP dialogue in
version 1 or version 2 according to an implementation option; note that the
IWF shall be prepared to fall back to v1 when v2 is chosen. Sub-parameters of
ResetArg shall be populated as described below:
**networkResource** in ResetArg (only v1) shall be set to hlr.
**hlr-Number** in ResetArg shall be populated with a value locally assigned to
the IWF and consistent with SS7 routing principles.
**hlr-List** in ResetArg shall be populated with values received within User-
Id AVPs within RSR.
## 8.8 Mapping of Parameters for the Notification Procedure
### 8.8.1 NOR mapping to UpdateGprsLocation-Arg
When the IWF needs to construct a MAP-UpdateGprsLocation message as a result
of receiving an NOR command (see sections 7.8.1 step 2 and 7.8.2. step 2), the
IWF shall open a MAP dialogue in application context version 3 and populate
sub-parameters of UpdateGprsLocation-Arg as described below:
**imsi** in UpdateGprsLocationArg shall be populated with the value of the
User-Name AVP received within NOR.
**sgsn-Number** in UpdateGprsLocationArg shall be populated with a value
locally assigned to the IWF and consistent with SS7 routing principles.
**sgsn-Address** in UpdateGprsLocationArg shall be populated with the IP-
address of the source node sending the NOR command.
**extensionContainer** in UpdateGprsLocationArg shall be absent.
**sgsn-Capability** in UpdateGprsLocationArg shall be absent.
**informPreviousNetworkEntity** in UpdateGprsLocationArg shall be absent;
**ps-LCS-NotSupportedByUE** in UpdateGprsLocationArg shall be absent
**v-gmlc-Address** in UpdateGprsLocationArg shall be absent.
**add-info** in UpdateGprsLocationArg shall be present if a Terminal-
Information AVP was present in the received NOR. If present the parameter
shall be populated with the received IMEI and software version, and with a
skipSubscriberDataUpdate indication.
**eps-info** in UpdateGprsLocationArg shall be present and contain a pdn-gw-
update parameter if the received NOR contained a MIP6-Agent-Info AVP. It shall
be present and contain a isr-Information parameter if the received NOR
contained a Single-Registration-Indication indication within the NOR-Flags
AVP.
**servingNodeTypeIndicator** in UpdateGprsLocationArg shall be present only if
the S6a/S6d-Indicator flag within the NOR-Flags AVP received within the NOR is
set to 1; otherwise, it shall be absent.
**skipSubscriberData Update** in UpdateGprsLocationArg shall be present.
**usedRAT-Type** in UpdateGprsLocationArg shall be absent.
**gprsSubscriptionDataNotNeeded** in UpdateGprsLocationArg shall be absent.
**nodeTypeIndicator** in UpdateGprsLocationArg shall be absent.
**areaRestricted** in UpdateGprsLocationArg shall be present if the
corresponding information was received within the NOR-Flags AVP within a NOR;
otherwise it shall be absent.
**ue-reachableIndicator** in UpdateGprsLocationArg shall be present if the
corresponding information was received within the NOR-Flags AVP within a NOR;
otherwise it shall be absent.
**ue-srvcc-Capability** in UpdateGprsLocationArg shall be present if a UE-
SRVCC-Capability AVP was present in the received NOR. If present the parameter
shall be populated with the received ue-srvcc-Capability.
**homogeneousSupportOfIMSVoiceOverPSSessions** in UpdateGprsLocationArg shall
be present if the corresponding information was received within the NOR;
otherwise it shall be absent.
**updateofHomogeneousSupportOfIMSVoiceOverPSSessions** in
UpdateGprsLocationArg shall be present if the corresponding information was
received within the NOR-Flags AVP within a NOR; otherwise it shall be absent.
**removalofMMERegistrationforSMS** in UpdateGprsLocationArg shall be present
if the corresponding information was received within the NOR-Flags AVP within
a NOR; otherwise it shall be absent.
### 8.8.2 UpdateGprsLocation-Arg mapping to NOR
When the IWF needs to construct a NOR command as a result of receiving a MAP-
UpdateGprsLocation message with a pdn-gw-update parameter within eps-info or
with an isr-Information parameter within eps-info not indicating
updateLocation or with a skipSubscriberDataUpdate parameter within add-info or
with ue-srvcc-Capability parameter but without usedRAT-Type parameter (see
section 7.8.2 step 4), the the IWF shall populate AVPs of NOR as described
below:
**Auth-Session-State** AVP shall be set to the value NO_STATE_MAINTAINED (1).
**User-Name** AVP shall be populated with the value received within the imsi
parameter of UpdateGprsLocation-Arg.
**Supported-Features** AVP shall be absent.
**Terminal-Information** AVP shall be present if an add-info parameter was
present inUpdateGprsLocationArg..
**MIP6-Agent-Info** AVP shall be present if pdn-gw-Identity was received
within pdn-gw-update parameter within eps-info within UpdateGprsLocationArg.
**Service-Selection** AVP shall be present if apn was received within pdn-gw-
update parameter within eps-info within UpdateGprsLocationArg.
**NOR-Flags** AVP: Flags shall be set as follows:
\- Single-Registration-Indication shall be set to 1 if a cancelSGSN indication
was received within the ISR-Information within the eps-info within the
UpdateGprsLocationArg; otherwise it shall be set to 0.
\- SGSN area restricted shall be set to 1 if an sgsnAreaRestricted indication
was received within the UpdateGprsLocationArg; otherwise it shall be set to 0.
\- Ready for SM shall be set to 0.
\- UE Reachable shall be set to 1 if a ue-reachableIndicator was received
within the UpdateGprsLocationArg; otherwise it shall be set to 0.
\- S6a/S6d-Indicator shall be set to 1 if a servingNodeTypeIndicator was
received within the UpdateGprsLocationArg; otherwise it shall be set to 0.
\- Homogeneous Support of IMS Voice Over PS Sessions shall be set to 1 if an
updateofHomogeneousSupportOfIMSVoiceOverPSSessions was received within the
UpdateGprsLocationArg; otherwise it shall be set to 0.
\- Removal of MME Registration for SMS shall be set to 1 if a
removalofMMERegistrationforSMS was received within the UpdateGprsLocationArg;
otherwise it shall be set to 0.
**Context-Identifier** AVP shall be present if contextId was received within
pdn-gw-update parameter within eps-info within UpdateGprsLocationArg.
**UE-SRVCC-Capability** AVP shall be present if a ue-srvcc-Capability
parameter was present in UpdateGprsLocationArg. If present the AVP shall be
populated with the received ue-srvcc-Capability parameter.
**Homogeneous-Support-of-IMS-Voice-Over-PS-Sessions** AVP shall be present if
updateofHomogeneousSupportOfIMSVoiceOverPSSessions was present in
UpdateGprsLocationArg; otherwise it shall be absent.
### 8.8.3 NOR mapping to ReadyForSM-Arg
When the IWF needs to construct a MAP-ReadyForSM message as a result of
receiving an NOR command (see sections 7.8.1 step 2 and 7.8.2. step 2), the
IWF shall open a MAP dialogue in application context version 3 and populate
sub-parameters of ReadyForSMArg as described below:
**imsi** in ReadyForSMArg shall be populated with the value of the User-Name
AVP received within NOR.
**alertReason** in ReadyForSMArg shall be populated with the value of the
Alert-Reason AVP received within NOR.
**alertReasonIndicator** in ReadyForSMArg shall be present if the \"Ready for
SM from SGSN\" flag within the NOR-Flags AVP received within NOR is set;
otherwise it shall be absent.
**additionalAlertReasonIndicator** in ReadyForSMArg shall be absent.
**extensionContainer** in ReadyForSMArg shall be absent.
**maximumUeAvailabilityTime** shall be present and populated with the value of
the Max-UE-Availaibility-Time AVP, when received within NOR.
### 8.8.4 ReadyForSM-Arg mapping to NOR
When the IWF needs to construct a NOR command as a result of receiving a MAP-
ReadyForSM message (see section 7.8.2 step 4), the the IWF shall populate AVPs
of NOR as described below:
**User-Name** AVP shall be populated with the value received within the imsi
parameter of ReadyForSMArg.
**Supported-Features** AVP shall be absent.
**Terminal-Information** AVP shall be absent.
**MIP6-Agent-Info** AVP shall be absent.
**Context-Identifier** AVP shall be absent.
**Service-Selection** AVP shall be absent.
**Alert-Reason** AVP shall be present and populated with the value received
within the alertReason parameter of ReadyForSMArg.
**NOR-Flags** AVP: Flags shall be set as follows:
\- Single-Registration-Indication shall be set to 0.
\- SGSN area restricted shall be set to 0.
\- Ready for SM from SGSN shall be set to 1 if alertReasonIndicator is
received within ReadyForSMArg; otherwise it shall be set to 0.
\- Ready for SM from MME shall be set to 1 if alertReasonIndicator is not
received within ReadyForSMArg; otherwise it shall be set to 0.
\- UE Reachable shall be set to 0.
\- Homogeneous Support of IMS Voice Over PS Sessions shall be set to 0.
\- Removal of MME Registration for SMS shall be set to 0.
**Maximum-UE-Availability-Time** AVP shall be present and populated with the
value of the maximumUeAvailabilityTime parameter, when received in the
ReadyForSMArg.
## 8.9 Mapping of Parameters for the IMEI Check Procedure
### 8.9.1 ECR mapping to CheckIMEI-Arg
When the IWF needs to construct a MAP-CheckIMEI message as a result of
receiving an ECR command (see section 7.9.1 step 2), the IWF shall open a MAP
dialogue in application context version 3 and populate sub-parameters of
CheckIMEI-Arg as described below:
**imei** in CheckIMEI-Arg shall be populated with the imei (and software
version) as received within the Terminal-Information AVP within ECR.
**requestedEquipmentInfo** in CheckIMEI-Arg shall indicate equipmentStatus.
**extensionContainer** in CheckIMEI-Arg shall be absent.
### 8.9.2 CheckIMEI-Res / Error mapping to ECA
When the IWF needs to construct an ECA command as a result of receiving a
CheckIMEI Ack/Error message (see section 7.9.1 step 4), the IWF shall populate
AVPs of ECA as described below:
**Result-Code / Experimental-Result** AVP shall be set to:
\- DIAMETER_SUCCESS if a CheckIMEI-Res parameter was received in a TCAP
ResultLast component;
\- DIAMETER_ERROR_UNKNOWN_EQUIPMENT if an error of unknownEquipment was
received;
\- an appropriate DIAMETER base protocol result code otherwise.
**Auth-Session-State** AVP shall be set to the value NO_STATE_MAINTAINED (1).
**Equipment-Status** AVP shall be populated with a value as received within
the equipmentStatus parameter within CheckIMEI-Res.
## 8.10 Mapping of Parameters for the Trace Activate Procedure
## 8.10.1 ActivateTraceMode-Arg mapping to IDR
When the IWF needs to construct an IDR command as a result of receiving a MAP-
ActivateTraceMode message (see sections 7.10.1 step 2), the IWF shall populate
AVPs of the IDR as described below:
**User-Name** AVP shall be populated with the value received within the imsi
parameter of ActivateTraceModeArg.
**Supported-Features** AVP shall be absent.
**Subscription-Data** AVP shall be present and populated as follows:
> **Trace-Data** AVP shall be present and populated as in chapter 8.2.2.
>
> All other sub-AVPs shall be absent.
## 8.10.2 IDA mapping to ActivateTraceMode-Res / Error
When the IWF needs to construct a MAP-ActivateTraceMode Ack message as a
result of receiving an IDA command (see sections 7.10.1 step 4), the IWF shall
populate sub-parameters of ActivateTraceMode Res/Error as described below:
**ActivateTraceModeRes:**
> **traceSupportIndicator** shall be present if an indication of support of
> this feature was received within the Supported-Feature AVP within IDA;
> Otherwise, it shall be absent.
>
> **extensionContainer** shall be absent.
**ActivateTraceMode Error:**
Values other than SUCCESS within the Result-Code / Experimental-Result AVP
shall be mapped onto an appropriate MAP error.
## 8.11 Mapping of Parameters for the Trace Deactivate Procedure
## 8.11.1 DeactivateTraceMode-Arg mapping to DSR
When the IWF needs to construct an DSR command as a result of receiving a MAP-
DeactivateTraceMode message (see sections 7.11.1 step 2), the IWF shall
populate AVPs of DSR as described below:
**User-Name** AVP shall be populated with the value received within the imsi
parameter of DeactivateTraceModeArg.
**Trace-Reference** AVP shall be populated with the values received within the
traceReference and traceReference2 parameters of DeactivateTraceModeArg.
**Supported-Features** AVP shall be absent.
**DSR-Flags** AVP: Trace Data Withdrawal shall be set to 1. All other Flags
shall be set as 0.
**Context-Identifier** AVPs shall be absent.
## 8.11.2 DSA mapping to DeactivateTraceMode-Res / Error
When the IWF needs to construct a MAP-DeactivateTraceMode Ack message as a
result of receiving an DSA command (see sections 7.11.1 step 4), the IWF shall
populate sub-parameters of DeactivateTraceMode Res/Error as described below:
**DeactivateTraceModeRes:**
> **extensionContainer** shall be absent.
**DeactivateTraceMode Error:**
Values other than SUCCESS within the Result-Code / Experimental-Result AVP
shall be mapped onto an appropriate MAP error.
###### ### Annex A: IWFs for the support of SMS capable MMEs or SGSNs
## A.1 General
This Annex describes the various cases of IWFs used for SMS related
interfaces.
## A.2 IWF related to the SGd/Gdd interfaces between MME/SGSN and central SMS
functions
### A.2.1 Introduction
The clause A.2 with its subclauses describes the IWFs used between an
MME/SGSN, supporting the SGd/Gdd interface and Central SMS functions (SMS-
GMSC, SMS-IWMSC, SMS Router) supporting a MAP E interface.
3GPP TS 23.204 [6] has specified the support of SMS for IMS UE to IMS UE
without MSISDN which impacts the IWF description for the IP-SM-GW with SMS
Central functions over SGd/Gdd.
### A.2.2 General considerations
Void
### A.2.3 Interworking scenarios
#### A.2.3.1 One IWF scenario
This interworking scenario, illustrated in figure A.2.3.1-1, is between a
MME/SGSN supporting SGd/Gdd interface based on Diameter and central SMS
functions (SMS-GMSC, SMS-IWMSC, SMS Router) supporting a MAP based E interface
for SMS with one IWF in the path.
This interworking scenario also applies between an IP/SM/GW supporting SGd/Gdd
interface based on Diameter and central SMS functions (SMS-GMSC, SMS-IWMSC)
supporting a MAP based E interface for SMS with one IWF in the path, in
particular for SMS for IMS UE to IMS UE without MSISDN (see 3GPP TS 23.204
[6]).
This IWF scenario can be an inter PLMN use case where the MME/SGSN and the IWF
are in the Visited PLMN.
This IWF scenario can be an intra PLMN use case where the central SMS
functions are supporting MAP based interfaces.
Figure A.2.3.1-1 SGd - E for SMS interworking scenario with one IWF
For MO Forward short messages requests, the IWF shall use the SC address
(E.164 number) received over SGd/Gdd for routing over MAP.
For MT Forward short messages, the IWF shall rely on the E.164 number of the
MME/SGSN used to route the MAP message towards the IWF to locally determine
the Diameter address of the MME/SGSN.
For ALR, the IWF shall use the SC address (E.164 number) received over SGd/Gdd
for routing over MAP.
#### A.2.3.2 Two IWF scenario
This interworking scenario, illustrated in figure A.2.3.2-1 is between a
MME/SGSN supporting a SGd/Gdd interface based on Diameter and central SMS
functions (SMS-GMSC, SMS-IWMSC, SMS Router) supporting a SGd/Gdd interface
based on Diameter with two IWF in the path, a MAP based E interface for SMS
being used between the IWFs.
This interworking scenario, also applies between an IP-SM-GW supporting a
SGd/Gdd interface based on Diameter and central SMS functions (SMS-GMSC)
supporting a SGd/Gdd interface based on Diameter with two IWF in the path, a
MAP based E interface for SMS being used between the IWFs, in particular for
SMS for IMS UE to IMS UE without MSISDN (see 3GPP TS 23.204 [6]).
Figure A.2.3.2-1: Two IWFs scenario
The IWF1 is located in the PLMN of the MME/SGSN or in the PLMN of the IP-SM-
GW. IWF2 is located in the PLMN of the SMS-GMSC or the SMS-IWMSC or the SMS
Router. The SMS Router may be in a PLMN different from the PLMN of the SMS-
GMSC.
The IWF1 needs not to be aware whether its connection via E for SMS interface
is to an IWF or to central SMS functions (see One IWF scenario).
For routing of MO and MT forward short messages and ALR, the IWF1 shall behave
as the IWF of the one IWF scenario.
For MO Forward short messages requests, the IWF2 shall rely on the E.164
number of the SMS-SC used to route the MAP message towards the IWF2 to locally
determine the Diameter address of the SMS-IWMSC.
For MT Forward short messages requests, the IWF2 shall use the E.164 number of
the MME/SGSN/IP-SM-GW received over SGd/Gdd to route the MAP message towards
the IWF1.
For ALR, the IWF2 shall route the message using the SMS-GMSC Diameter Address
received in the Alert Service Centre message.
### A.2.4 The mapping of procedures
#### A.2.4.1 MO Forward Short Message
##### A.2.4.1.1 One IWF Scenario
The mapping of the MO Forward Short Message procedure for this scenario is
shown in figure A.2.4.1.1-1:
Figure A.2.4.1.1-1: Mapping of MO Forward Short Message procedure with one IWF
1\. The IWF receives a OFR message from the MME/SGSN/IP-SM-GW.
2\. The IWF opens a MAP v3 dialogue towards the SMS-IWMSC by sending MO-
ForwardSM.
3\. The IWF receives []{#_Hlk324439376 .anchor}MO-ForwardSM Ack from the SMS-
IWMSC.
4\. The IWF sends OFA to the MME/SGSN/IP-SM-GW.
##### A.2.4.1.2 Two IWFs Scenario
The mapping of the MO Forward Short Message procedure for this scenario is
shown in figure A.2.4.1.2-1:
Figure A.2.4.1.2-1: Mapping of MO Forward Short Message procedure with two
IWFs
1\. The IWF1 receives an OFR message from the MME/SGSN.
2\. The IWF1 opens a MAP v3 dialogue towards IWF2 by sending MO-ForwardSM.
3\. The IWF2 constructs the OFR message and sends it to the SMS-IWMSC.
4\. The IWF2 receives the OFA message from the SMS-IWMSC.
5\. The IWF2 closes the MAP dialogue with the IWF2 by sending MO-ForwardSM
Ack.
6\. The IWF1 sends the OFA message to the MME/SGSN.
#### A.2.4.2 MT Forward Short Message
##### A.2.4.2.1 One IWF Scenario
The mapping of the MT Forward Short Message procedure for this scenario is
shown in figure A.2.4.2.1-1:
Figure A.2.4.2.1-1: Mapping of MT Forward Short Message procedure with one IWF
1\. The IWF receives a MT-ForwardSM MAP v3 message from the SMS-GMSC or from
the SMS Router.
2\. The IWF sends TFR to the MME/SGSN/IP-SM-GW.
3\. The IWF receives TFA.
4\. The IWF closes the MAP dialogue with the SMS-GMSC or the SMS Router by
sending MT-ForwardSM Ack.
##### A.2.4.2.2 Two IWFs Scenario
The mapping of the MT Forward Short Message procedure for this scenario is
shown in figure A.2.4.2.2-1:
Figure A.2.4.2.2-1: Mapping of MT Forward Short Message procedure with two
IWFs
1\. The IWF2 receives a TFR message from the SMS-GMSC or the SMS Router.
2\. The IWF2 opens a MAP v3 dialogue towards IWF1 by sending MT-ForwardSM.
3\. The IWF1 constructs the TFR message and sends it to the MME/SGSN/IP-SM/GW.
4\. The IWF1 receives the TFA message from the MME/SGSN/IP-SM-GW.
5\. The IWF1 closes the MAP dialogue with the IWF1 by sending MT-ForwardSM
Ack.
6\. The IWF2 sends an OFA message to the SMS-GMSC or the SMS Router.
#### A.2.4.3 Alert Service Centre
##### A.2.4.3.1 One IWF Scenario
The mapping of the Alert Service Center procedure for this scenario is shown
in figure A.2.4.3.1-1:
Figure A.2.4.3.1-1: Mapping of Alert Service Centre procedure with one IWF
1\. The IWF receives an ALR message from the MME or SGSN.
2\. The IWF opens a MAP v3 dialogue towards the SMS-GMSC or SMS Router by
sending an alertServiceCentre.
3\. The IWF receives an alertServiceCentre Ack from the SMS-GMSC or SMS
Router.
4\. The IWF sends an ALA message to the MME or SGSN.
##### A.2.4.3.2 Two IWFs Scenario
The mapping of the Alert Service Center procedure for this scenario is shown
in figure A.2.4.x.2-1:
Figure A.2.4.3.2-1: Mapping of Alert Service Centre procedure with two IWFs
1\. The IWF1 receives an ALR message from the MME or SGSN.
2\. The IWF1 opens a MAP v3 dialogue towards the IWF2 by sending an
alertServiceCentre.
3\. The IWF2 sends an ALR message to the SMS-GMSC or SMS Router.
4\. The IWF2 receives an ALA from the SMS-GMSC or SMS Router.
5\. The IWF2 sends an alertServiceCenter Ack to the IWF1.
6\. The IWF1 sends an ALA message to the MME or SGSN.
### A.2.5 The mapping of parameters
#### A.2.5.1 Mapping of Parameters for the MO Forward Short Message procedure
##### A.2.5.1.1 OFR mapping to MO-ForwardSM-Arg
When the IWF needs to construct a MAP MO-ForwardSM message as a result of
receiving an OFR command (see subclause A.2.4.1.1 step 2), the IWF shall open
a MAP dialogue in application context version 3 and populate sub-parameters of
MO-ForwardSM-Arg as described below:
**sm-RP-DA** in MO-ForwardSM-Arg shall be present and populated with the value
received within the SC-Address AVP within OFR.
**sm-RP-OA** in MO-ForwardSM-Arg shall be present and populated with the value
received within the MSISDN AVP within the User-Identifier AVP within OFR.
**sm-RP-UI** in MO-ForwardSM-Arg shall be present and populated with the value
received within the SM-RP-UI AVP within OFR
**extensionContainer** in MO-ForwardSM-Arg shall be present .
**imsi** in MO-ForwardSM-Arg shall be present and populated with the value
received within the User-Name AVP in the User-Identifier AVP within OFR. .
**correlationID** in MO-ForwardSM-Arg shall be present if SMSMI-Correlation-ID
AVP in OFR is present and be populated as follows:
> **hlr-id** parameter shall be populated with the value received within HSS-
> ID AVP within SMSMI-Correlation-ID AVP within OFR.
>
> **sip-uri-A parameter** shall be populated with the value received within
> Originating-SIP-URI AVP within SMSMI-Correlation-ID AVP within OFR.
**sip-uri-B parameter** shall be populated with the value received within
Destination-SIP-URI AVP within SMSMI-Correlation-ID AVP within OFR.
**sm-DeliveryOutcome** in MO-ForwardSM-Arg shall be present if SMSMI-
Correlation-ID AVP in OFR is present and be populated with the value received
in SM-Delivery-Cause within IP-SM-GW-SM-Delivery-Outcome within SM-Delivery-
Outcome within OFR.
##### A.2.5.1.2 MO-ForwardSM-Res / Error mapping to OFA
When the IWF needs to construct an OFA command as a result of receiving a MAP
MO-ForwardSM Ack/Error message (see subclause A.2.4.1.1 step 4), the IWF shall
populate AVPs of OFA as described below:
**Result-Code / Experimental-Result** AVP shall be set to:
\- DIAMETER_SUCCESS if a MO-ForwardSM-Res parameter was received in the TCAP
ResultLast component;
\- DIAMETER_ERROR_FACILITY_NOT_SUPPORTED if an error of facilityNotSupported
was received;
\- DIAMETER_UNABLE_TO_COMPLY if an error of systemFailure was received;
\- DIAMETER_SM_DELIVERY_FAILURE if an error of sm-DeliveryFailure was
received;
\- an appropriate DIAMETER base protocol result code otherwise.
**SM-Delivery- Failure-Cause** AVP: shall be populated as follows:
**SM-Enumerated-Delivery-Failure-Cause** AVP shall be present and populated
with the value received within the SM-EnumeratedDeliveryFailureCause
parameter, when present, within the sm-DeliveryFailureCause of the MO-
ForwardSM message.
> **SM-Diagnostic-Info** AVP shall be populated with the value received within
> the diagnosticInfo parameter, when present, within the sm-
> DeliveryFailureCause within the MO-ForwardSM message.
**SM-RP-UI** AVP shall be populated with the value received within the sm-RP-
UI parameter, when present, of the MT-ForwardSM-Res message.
##### A.2.5.1.3 MO-ForwardSM-Arg mapping to OFR
When the IWF needs to construct a OFR command as a result of receiving a MAP
MO-ForwardSM message (see subclause A.2.4.1.2 step 3), the IWF shall populate
AVPs of OFR as described below:
**User-Name** AVP shall be present and populated with the value received
within the sm-RP-DA parameter of MO-ForwardSM-Arg and translated into an
UTF8String format.
**User Identifier** AVP shall be present and shall be populated as follows:
> **User-Name** AVP shall be present and populated with the value received
> within the imsi parameter of MO-ForwardSM-Arg and translated into an
> UTF8String format.
>
> **MSISDN** AVP shall be populated with the value received within the sm-RP-
> OA parameter of MO-ForwardSM-Arg
**SM-RP-UI** AVP shall be populated with the value received within the sm-RP-
UI parameter of MO-ForwardSM-Arg
**Supported-Features** AVP shall be absent.
##### A.2.5.1.4 OFA mapping to MO-ForwardSM-Res/Error
When the IWF needs to construct MAP MO-ForwardSM Ack message as a result of
receiving a OFA command (see subclause A.2.4.1.2 step 5), the IWF shall
populate sub-parameters of MO-ForwardSM-Res/Error as described below:
**mo-ForwardSM-Res:**
> **sm-RP-UI** in MO-ForwardSM-Res shall be populated with the value received
> within the SM-RP-UI AVP when present.
>
> **extensionContainer** in MO-ForwardSM-Res shall be absent.
**mo-ForwardSM Error:**
Values other than SUCCESS within the Result-Code / Experimental-Result AVP
shall be mapped onto the following MAP errors:
\- An error of systemFailure if a DIAMETER_UNABLE_TO_COMPLY result was
received;
\- An error of **unexpectedDataValue** if a DIAMETER_INVALID_AVP_VALUE result
was received;
\- An error of **facilityNotSupported** if a
DIAMETER_ERROR_FACILITY_NOT_SUPPORTED result was received;
\- An error of sm-DeliveryFailure if a DIAMETER_ERROR_SM_DELIVERY_FAILURE.
**\- sm-DeliveryFailureCause** when a DIAMETER_ERROR_SM_DELIVERY_FAILURE
result was received, shall be populated as follows:
\- **SM-EnumeratedDeliveryFailureCause** shall be populated with the value
received within the SM-Enumerated-Delivery-Failure-Cause AVP within the SM-
DeliveryFailureCause AVP within OFA;
\- **diagnosticInfo** parameter shall be populated with the value received
within the SM-Diagnostic-Info AVP, when present, within the SM-
DeliveryFailureCause AVP within OFA.
#### A.2.5.2 Mapping of Parameters for the MT Forward Short Message Procedure
##### A.2.5.2.1 MT-ForwardSM-Arg mapping to TFR
When the IWF needs to construct a TFR command as a result of receiving a MAP
MT-ForwardSM message (see subclause A.2.4.2.1 step 2), the IWF shall populate
AVPs of TFR as described below:
**User-Name** AVP shall be populated with the value received within the sm-RP-
DA parameter of MT-ForwardSM-Arg.
**SC-Address** AVP shall be populated with the value received within the sm-
RP-OA parameter of MT-ForwardSM-Arg
**SM-RP-UI** AVP shall be populated with the value received within the sm-RP-
UI parameter of MT-ForwardSM-Arg
**SMSMI-Correlation-ID** AVP shall be present if correlationID in MT-
ForwardSM-Arg is present and be populated as follows:
> **Originating-SIP-URI** AVP shall be populated with the value received
> within the sip-uri-A parameter within correlationID of MT-ForwardSM-Arg.
>
> **Destination-SIP-URI** AVP shall be populated with the value received
> within the sip-uri-B parameter within correlationID of MT-ForwardSM-Arg.
**TFR-Flags** AVP: Flags shall be set as follows:
> **More-Messages- To-Send** shall be set to 1 if the moreMessagesToSend
> parameter was present within MT-ForwardSM-Arg; otherwise shall be set to 0
> or the AVP shall be absent.
**Supported-Features** AVP shall be absent.
**SM-Delivery-Timer AVP** shall be present and populated with the value of the
smDeliveryTime, when present within the MT-ForwardSM-Arg.
**SM-Delivery- Start-Time AVP** shall be present and populated with the value
of the smDeliveryStartTime, when present within the MT-ForwardSM-Arg.
**Maximum-Retransmission-Time AVP** shall be present and populated with the
value of the maximumRetransmissionTime parameter, when present within the MT-
ForwardSM-Arg.
**SMS-GMSC Address AVP** shall be present and populated with the value of the
smsGmscAddress parameter, when present within the MT-ForwardSM-Arg.
##### A.2.5.2.2 TFA mapping to MT-ForwardSM-Res/Error
When the IWF needs to construct MAP MT-ForwardSM Ack message as a result of
receiving a TFA command (see subclause A.2.4.2.1 step 4), the IWF shall
populate sub-parameters of MT-ForwardSM-Res/Error as described below:
**mt-ForwardSM-Res:**
> **sm-RP-UI** in MO-ForwardSM-Res shall be populated with the value received
> within the SM-RP-UI AVP when present.
>
> **extensionContainer** in MT-ForwardSM-Res shall be absent.
**mt-ForwardSM Error:**
Values other than SUCCESS within the Result-Code / Experimental-Result AVP
shall be mapped onto the following MAP errors:
\- An error of **systemFailure** error if a DIAMETER_UNABLE_TO_COMPLY result
was received;
\- An error of **dataMissing** if a DIAMETER_MISSING_AVP result was received;
\- An error of **unexpectedDataValue** if a DIAMETER_INVALID_AVP_VALUE result
was received;
\- An error of **facilityNotSupported** if a
DIAMETER_ERROR_FACILITY_NOT_SUPPORTED result was received;
\- An error of **unidentifiedSubscriber** if a DIAMETER_ERROR_USER_UNKNOWN
result was received;
\- An error of **illegalSubscriber** if a DIAMETER_ERROR_ILLEGAL_USER result
was received;
\- An error of **illegalEquipment** if a DIAMETER_ERROR_ILLEGAL_EQUIPMENT
result was received;
\- An error of **subscriberBusyForMT-SMS** if a
DIAMETER_ERROR_USER_BUSY_FOR_MT_SMS result was received;
\- An error of **sm-DeliveryFailure** if a DIAMETER_ERROR_SM_DELIVERY_FAILURE
result was received;
\- An error of a**bsentSubscriberSM** if a DIAMETER_ERROR_ABSENT_USER result
was received.
**\- sm-DeliveryFailureCause,** when a DIAMETER_ERROR_SM_DELIVERY_FAILURE
result was received, shall be populated as follows:
\- **SM-EnumeratedDeliveryFailureCause** shall be populated with the value
received within the SM-Enumerated-Delivery-Failure-Cause AVP within the SM-
DeliveryFailureCause AVP within TFA;
**\- diagnosticInfo** shall be populated with the value received within the
SM-Diagnostic-Info AVP, when present, within the SM-DeliveryFailureCause AVP
within TFA.
**\- absentSubscriberDiagnosticSM,** when a DIAMETER_ERROR_ABSENT_USER result
was received, shall be populated with the value received within the Absent-
Subscriber-Diagnostic-SM AVP, when present, within TFA.
**\- requestedRetransmissionTime** shall be present and populated with the
value received in the Requested-Retransmission-Time AVP, when present, within
TFA.
##### A.2.5.2.3 TFR mapping to MT-ForwardSM-Arg
When the IWF needs to construct a MAP MT-ForwardSM message as a result of
receiving a TFR command (see subclause A.2.4.2.2 step 2), the IWF shall open a
MAP dialogue in application context version 3 and populate sub-parameters of
MT-ForwardSM-Arg as described below:
**sm-RP-DA** in MT-ForwardSM-Arg shall be present and populated with the value
received within the User-Name AVP within TFR.
**sm-RP-OA** in MT-ForwardSM-Arg shall be present and populated with the value
received within the SC-Address AVP within TFR.
**correlationID** in MT-ForwardSM-Arg shall be present if SMSMI-Correlation-ID
AVP in TFR is present and be populated as follows:
> **sip-uri-A parameter** shall be populated with the value received within
> Originating-SIP-URI AVP within SMSMI-Correlation-ID AVP within TFR.
>
> **sip-uri-B parameter** shall be populated with the value received within
> Destination-SIP-URI AVP within SMSMI-Correlation-ID AVP within TFR.
**sm-RP-UI** in MT-ForwardSM-Arg shall be present and populated with value
received within the SM-RP-UI AVP within TFR
**moreMessagesToSend** shall be present if the More-Messages-To-Send flag is
set to 1 within the TFR-Flags AVP within MT-ForwardSM-Arg.
**smDeliveryTime** in MT-ForwardSM-Arg shall be present and populated with the
value within the SM-Delivery-Timer AVP when received within TFR.
**smDeliveryStartTime** in MT-ForwardSM-Arg shall be present and populated
with the value within the SM-Delivery- Start-Time AVP when received within
TFR.
**maximumRetransmissionTime** in MT-ForwardSM-Arg shall be present and
populated with the value of the Maximum-Retransmission-Time AVP when received
within TFR.
**smsGmscAddress** shall be present and populated with the value within the
SMS-GMSC Address AVP, when received within TFR.
NOTE: The value of the MME-Number-For-MT-SMS AVP or of the SGSN-Number AVP is
not conveyed in the MAP MT-ForwardSM message but is used by IWF2 for routing
the MAP MT-ForwardSM message towards IWF1.
##### A.2.5.2.4 MT-ForwardSM-Res / Error mapping to TFA
When the IWF needs to construct a TFA command as a result of receiving a MAP
MT-ForwardSM Ack/Error message (see subclause A.2.4.2.2 step 6), the IWF shall
populate AVPs of TFA as described below:
**Result-Code / Experimental-Result** AVP shall be set to:
\- DIAMETER_SUCCESS if a MT-ForwardSM-Res parameter was received in the TCAP
ResultLast component;
\- DIAMETER_ERROR_USER_UNKNOWN if an error of unidentifiedSubscriber was
received;
\- DIAMETER_ERROR_ABSENT_USER if an error of absentSubscriberSM was received;
\- DIAMETER_ERROR_USER_BUSY_FOR_MT_SMS if an error of subscriberBusyForMT-SMS
was received;
\- DIAMETER_ERROR_ILLEGAL_USER if an error of illegalSubscriber was received;
\- DIAMETER_ERROR_ILLEGAL_EQUIPMENT if an error of illegalEquipment was
received
\- DIAMETER_UNABLE_TO_COMPLY if an error of systemFailure was received
\- DIAMETER_SM_DELIVERY_FAILURE if an error of sm-DeliveryFailure was
received;
\- an appropriate DIAMETER base protocol result code otherwise.
**SM-Delivery-Failure-Cause** AVP, when an error of sm-DeliveryFailure was
received, shall be populated as follows:
\- **SM-Enumerated-Delivery-Failure-Cause** AVP shall be present and populated
with the value received within the SM-EnumeratedDeliveryFailureCause parameter
of the MT-ForwardSM Error message.
\- **SM-Diagnostic-Info** AVP shall be populated with the value received
within the diagnosticInfo parameter, when present, within the sm-
DeliveryFailureCause within the MT-ForwardSM Error message.
**Absent-Subscriber-Diagnostic-SM** AVP, when an error of absentSubscriberSM
was received, shall be populated with the value received within the
absentSubscriberDiagnosticSM parameter of the MT-ForwardSM Error message.
**SM-RP-UI** AVP shall be populated with the value received within the sm-RP-
UI parameter, when present, of the MT-ForwardSM-Res message.
**Requested-Retransmission-Time** AVP shall be present and populated with the
value received within the requestedRetransmissionTime parameter, when present
within the MT-ForwardSM Error message.
#### A.2.5.3 Mapping of Parameters for the Alert Service Centre Procedure
##### A.2.5.x.1 ALR mapping to alertServiceCentre-Arg
When the IWF needs to construct a MAP alertServiceCentre message as a result
of receiving an ALR command, the IWF shall open a MAP dialogue in application
context version 3 and populate sub-parameters of alertServiceCentre-Arg as
described below:
**\- msisdn** shall be populated with the dummy MSISDN value (see clause 3 of
3GPP TS 23.003 [7])
NOTE: No MSISDN AVP is present in this scenario within the User-Identifier AVP
in the ALR message.
**\- imsi** shall be populated with the value received within User-Name AVP
within the User-Identifier AVP within ALR.
**\- serviceCentreAddress** shall be present and populated with the value
received within the SC-Address AVP within ALR.
**\- newSgsnNumber** shall be present and populated with the value received
within the SGSN-Number AVP of the Serving-Node AVP within ALR.
**\- newMmeNumber** shall be present and populated with the value received
within the MME-Number-for-MT-SMS AVP of the Serving-Node AVP within ALR.
**\- newSgsnDiameterAddress** shall be present and populated with the value
received within the SGSN-Name and SGSN-Realm AVPs of the Serving-Node AVP,
when present in ALR.
**\- newMmeDiameterAddress** shall be present and populated with the value
received within the MME-Name and MME-Realm AVPs of the Serving-Node AVP, when
present in ALR.
**\- smsGmscAlertEvent** shall be present and populated with the value
received within the SMS-GMSC-Alert-Event AVP within ALR.
**\- smsGmscDiameterAddress** shall be present and populated with the value
received in the Destination-Host and Destination-Realm in ALR.
##### A.2.5.3.2 alertServiceCentre-Res / Error mapping to ALA
When the IWF needs to construct an ALA command as a result of receiving a MAP
alertServiceCentre Ack/Error message, the IWF shall populate AVPs of ALA as
described below:
**Result-Code / Experimental-Result** AVP shall be set to:
\- DIAMETER_SUCCESS if no error was received in the TCAP ResultLast component;
\- a DIAMETER base protocol result code according to the following table:
Table A.2.5.3.2-1 Mapping from MAP error codes to Diameter error codes
* * *
**MAP error code** **Diameter Result code / Experimental Result**
**systemFailure** **DIAMETER_UNABLE_TO_COMPLY** **dataMissing**
**DIAMETER_MISSING_AVP** **unexpectedDataValue**
**DIAMETER_INVALID_AVP_VALUE**
* * *
**Supported Features** AVP shall be absent.
##### A.2.5.3.3 alertServiceCentre-Arg mapping to ALR
When the IWF needs to construct an ALR command as a result of receiving a MAP
alertServiceCentre message, the IWF shall populate the ALR as described below:
**\- User-Name AVP within User-Identifier AVP** shall be present and populated
with the value received within the imsi parameter of the alertServiceCenter-
Arg.
**\- SC-Address AVP** shall be present and populated with the value received
within the serviceCentreAddress parameter of the alertServiceCenter-Arg.
**\- SGSN-Number AVP of the Serving-Node AVP** shall be present and populated
with the value received within the newSgsnNumber of the alertServiceCenter-
Arg.
**\- MME-Number-for-MT-SMS AVP** shall be present and populated with the value
received within the newMmeNumber of the alertServiceCenter-Arg.
**\- SGSN-Name** and **SGSN-Realm AVPs** **of the Serving-Node AVP** shall be
present and populated with the value received within newSgsnDiameterAddress,
when present in the alertServiceCenter-Arg.
**\- MME-Name** and **MME-Realm AVPs** shall be present and populated with the
value received within newMmeDiameterAddress, when present in the
alertServiceCenter-Arg.
**\- SMS-GMSC-Alert-Event AVP** shall be present and populated with the value
received within the smsGmscAlertEvent of the alertServiceCenter-Arg.
**\- Destination-Host and Destination-Realm AVPs** shall be present and
populated with the value received in the smsGmscDiameterAddress in the
alertServiceCenter-Arg.
##### A.2.5.3.4 ALA mapping to alertServiceCentre-Res
When the IWF needs to construct a MAP alertServiceCentre Ack/Error message as
a result of receiving an ALA command, the IWF shall populate the MAP
alertServiceCenter Ack/Error as described below:
**MAP error code** shall be set as follows:
Table A.2.5.3.4-1 Mapping from Diameter error codes to MAP error codes
* * *
**Diameter Result code / Experimental Result** **MAP error code**
**DIAMETER_UNABLE_TO_COMPLY** **systemFailure** **DIAMETER_MISSING_AVP**
**dataMissing** **DIAMETER_INVALID_AVP_VALUE** **unexpectedDataValue**
* * *
## A.3. IWF related to the S6c interface between HSS and central SMS functions
### A.3.1 Introduction
3GPP TS 23.272 [3] has specified the \"SMS in MME\" architecture option, where
an IWF between the HSS supporting the S6c interface and the central SMS
functions (SMS-GMSC, SMS-IWMSC, SMS Router) supporting the MAP C interface for
SMS is defined. This S6c IWF is described in the following subclauses.
3GPP TS 23.204 [6] has specified the support of SMS for IMS UE to IMS UE
without MSISDN which impacts the IWF description over S6c.
### A.3.2 Interworking scenarios
#### A.3.2.1 IWF scenario
This interworking scenario is illustrated in the two following figures:
\- in figure A.3.2.1-1, an IWF is between a HSS supporting the S6c interface
based on Diameter and central SMS functions (SMS-GMSC, SMS-IWMSC) supporting a
MAP based C interface for SMS. There is no SMS Router.
\- in figure A.3.2.1-2, there is a SMS router used for MT SMS with which the
IWF will interact, taking into account that Diameter requests from the IWF,
according to operator configuration, are sent to the SMS Router either
directly or via the HSS.
This IWF scenario can be an inter PLMN use case where the HSS, the SMS Router,
the IP-SM-GW and the IWF are in the Home PLMN.
In the Home PLMN, when the HSS supports S6c, the SMS Router shall also support
S6c, i.e. there is no IWF between HSS and SMS Router.
This IWF scenario can be an intra PLMN use case.
Figure A.3.2.1-1 S6c - C for SMS interworking scenario with an IWF
Figure A.3.2.1-2 S6c - C for SMS interworking scenario with SMS Router and an
IWF
### A.3.3 General considerations
#### A.3.3.1 Routing considerations
MAP requests issued by the SMS-GMSC are routed to the IWF on the basis of the
SSN and of the MSISDN, then the corresponding Diameter requests are routed on
the basis of the Diameter application identifier and of the MSISDN or of the
IMSI. If a SMS router is deployed, the HSS will forward the Send Routing Info
for SM commands to the SMS router.
In a retry context of SMS for IMS UE to IMS UE without MSISDN (see 3GPP TS
23.204 [6]), the MAP requests issued by the SMS-GMSC or the SMS-SC are routed
to the IWF on the basis of the SSN and of the HSS ID, then the corresponding
Diameter requests are routed on the basis of the Diameter application
identifier and of the HSS ID. In this case, the HSS does not forward the Send
Routing Info for SM commands to the IP-SM-GW.
Diameter requests (i.e when an Alert procedure) issued by the HSS are routed
to the IWF on the basis of the application identifier and of the SC-Address
AVP containing the SMS-SC number. Then the corresponding MAP request is routed
to the SMS-IWMSC on the basis of the SSN and of the SMS-SC number.
### A.3.4 The mapping of procedures
#### A.3.4.1 Send Routing Info for SM
The mapping of the Send Routing Info for SM procedure is shown in figure
A.3.4.1-1:
Figure A.3.4.1-1: Mapping of Send Routing Info for SM procedure
1\. The IWF receives a sendRoutingInfoForSM MAP V3 message from the SMS-GMSC.
2\. The IWF sends SRR to the HSS or SMS Router or IP-SM-GW.
3\. The IWF receives SRA from the HSS or SMS Router or IP-SM-GW.
4\. The IWF sends a sendRoutingInfoForSM Ack message to the SMS-GMSC.
5\. The IWF sends an informServiceCentre message to the SMS-GMSC if the SRA
contains information elements requiring to be delivered with an
informServiceCentre message and closes the MAP dialog
#### A.3.4.2 Alert Service Centre
The mapping of the Alert Service Centre procedure is shown in figure
A.3.4.2-1:
Figure A.3.4.2-1: Mapping of Alert Service Centre procedure
1\. The IWF receives a ALR message from the HSS.
2\. The IWF opens a MAP v3 dialogue towards the SMS-IWMSC by sending
alertServiceCentre.
3\. The IWF receives alertServiceCentre Ack from the SMS-IWMSC.
4\. The IWF sends ALA to the MME, SGSN.
#### A.3.4.3 Report SM Delivery Status
The mapping of the Report SM Delivery Status procedure is shown in figure
A.3.4.3-1:
Figure A.3.4.3-1: Mapping of Report SM Delivery Status procedure
1\. The IWF receives a reportSM-DeliveryStatus MAP V3 message from the SMS-
GMSC or the SMS-SC.
2\. The IWF sends RDR to the HSS.
3\. The IWF receives SRA from the HSS.
4\. The IWF closes the MAP dialogue with the SMS-GMSC by sending a reportSM-
DeliveryStatus Ack to the SMS-GMSC or the SMS-SC.
### A.3.5 The mapping of parameters
#### A.3.5.1 Mapping of Parameters for the Send Routing Info for SM Procedure
##### A.3.5.1.1 RoutingInfoForSM-Arg mapping to SRR
When the IWF needs to construct a SRR command as a result of receiving a MAP
sendRoutingInfoForSM message (see subclause A.3.4.1.1 step 2), the IWF shall
populate AVPs of SRR as described below:
**\- MSISDN AVP** shall be populated with the value received within the msisdn
parameter of RoutingInfoForSM-Arg when available.
**\- User-Name** AVP shall be populated with the value received within the
imsi parameter of RoutingInfoForSM-Arg when available.
**\- SMSMI-Correlation-ID** AVP shall be present if correlationID in
RoutingInfoForSM-Arg is present and be populated as follows:
**\- Destination-SIP-URI** AVP shall be populated with the value received
within the sip-uri-B parameter of RoutingInfoForSM-Arg.
**\- SM-RP-PRI** AVP shall be present and populated with the value received
within the sm-RP-PRI parameter of RoutingInfoForSM-Arg.
**\- SC-Address** AVP shall be present and populated with the value received
within the serviceCentreAddress parameter of RoutingInfoForSM-Arg
**\- SM-RP-MTI** AVP shall be populated with the value received within the sm-
RP-MTI parameter, when present, of RoutingInfoForSM-Arg
**\- SM-RP-SMEA** AVP shall be populated with the value received within the
sm-RP-SMEA parameter, when present, of RoutingInfoForSM-Arg
**\- SRR-Flags** AVP: Flags shall be set as follows:
**\- GPRS-Indicator** shall be set to 1 if the gprsSupportIndicator parameter
was present within RoutingInfoForSM-Arg; otherwise shall be set to 0 or the
AVP shall be absent.
**\- SM-Delivery-Not-Intended** AVP shall be populated with the value received
within the sm-deliveryNotIntended parameter, when present, of
RoutingInfoForSM-Arg
**\- Supported-Features** AVP shall be absent.
##### A.3.5.1.2 SRA mapping to RoutingInfoForSM-Res/Error
When the IWF needs to construct a MAP sendRoutingInfoForSM Ack message as a
result of receiving a SRA command (see subclause A.3.4.1.1 step 5), the IWF
shall populate sub-parameters of RoutingInfoForSM-Res/Error as described
below:
**RoutingInfoForSM-Res:**
**\- imsi** shall be populated with the value received within the User-Name
AVP, when present, within SRA.
\- Sub-parameters of **locationInfoWithLMSI** shall be populated as follows:
**\- networkNode-Number** shall be populated with the value received within
either the MME-Number-for-MT-SMS AVP or the MSC-Number AVP or the SGSN-Number
AVP or the IP-SM-GW-Number AVP, within the Serving-Node when present, within
the SRA.
\- Sub-parameters **diameter-Name** and **diameter-Realm** of
**networkNodeDiameterAddress** shall be populated with the values received
within the MME-Name & MME-Realm AVPs or within the IP-SM-GW-Name & IP-SM-GW-
Realm AVPs within the Serving-Node AVP when present, within the SRA.
**\- lmsi** shall be populated with the value received within the LMSI AVP
when present, within the SRA.
**\- gprsNodeIndicator** shall be set if the received Serving Node AVP
contains a SGSN AVP.
**\- additional-Number** shall be populated with the value received within
either the MME-Number-for-MT-SMS User-Name AVP or the MSC-Number AVP or the
SGSN-Number SGSN AVP, within the Additional-Serving-Node when present, within
the SRA.
\- Sub-parameters **diameter-Name** and **diameter-Realm** of
**additionalNetworkNodeDiameterAddress** shall be populated with the values
received within the MME-Name and MME-Realm AVPs within the Additonal-Serving-
Node AVP when present, within the SRA.
**\- sm-RP-UI** in MO-ForwardSM-Res shall be populated with the value received
within the SM-RP-UI AVP when present.
**\- extensionContainer** in MT-ForwardSM-Res shall be absent.
**Error:**
Values other than SUCCESS within the Result-Code / Experimental-Result AVP
shall be mapped according to the following table:
Table A.3.5.1.2-1 Mapping from Diameter error codes to MAP error codes
* * *
**Diameter Result code / Experimental Result** **MAP error code**
**DIAMETER_UNABLE_TO_COMPLY** **systemFailure** **DIAMETER_MISSING_AVP**
**dataMissing** **DIAMETER_INVALID_AVP_VALUE** **unexpectedDataValue**
**DIAMETER_ERROR_FACILITY_NOT_SUPPORTED** **facilityNotSupported**
**DIAMETER_ERROR_USER_UNKNOWN** **unknownSubscriber**
**DIAMETER_ERROR_SERVICE_NOT_SUBSCRIBED** **teleserviceNotProvisioned**
**DIAMETER_ERROR_SERVICE_BARRED** **callBarred**
**DIAMETER_ERROR_ABSENT_USER** **absentSubscriberSM**
* * *
When the Diameter Result code is DIAMETER_ERROR_ABSENT_USER, one or two absent
user diagnostics (MME-Absent-User-Diagnostic-SM or MSC-Absent-User-Diagnostic-
SM or SGSN-Absent-User-Diagnostic-SM AVPs) may be received. The following
additional mapping shall apply:
\- When only one absent user diagnostic AVP is received, it is mapped to the
absentSubscriberDiagnosticSM parameter.
\- When two absent user diagnostics AVPs are received , the SGSN-Absent-User-
Diagnostic-SM AVP is mapped to the additionalAbsentSubscriberDiagnosticSM
parameter , the other AVP is mapped to the absentSubscriberDiagnosticSM
parameter.
##### A.3.5.1.3 SRA mapping to informServiceCentreArg
When the IWF needs to construct a MAP informServiceCentre message as a result
of receiving a SRA command (see subclause A.3.4.1.1 step 4), the IWF shall
populate sub-parameters of InformServiceCentreArg as described below:
**\- storedMSISDN** shall be populated with the value received within the
MSISDN AVP within the User Identifier AVP, when present, within SRA.
**\- mw-Status** shall be populated with the value received within the MWD-
Status AVP, when present, within SRA.
**\- absentSubscriberDiagnosticSM** shall be populated with the value received
within
\- either the MME-Absent-User-Diagnostic-SM AVP or the MSC-Absent-User-
Diagnostic-SM AVP or the SGSN-Absent-User-Diagnostic-SM AVP, when only one of
them is present, within the SRA.
\- either MME-Absent-User-Diagnostic-SM AVP or the MSC-Absent-User-Diagnostic-
SM AVP, if one of them is present and if SGSN-Absent-User-Diagnostic-SM AVP is
also present.
**\- additionalAbsentSubscriberDiagnosticSM** shall be populated with the
value received within the SGSN-Absent-User-Diagnostic-SM AVP, if it is present
and if either the MME-Absent-User-Diagnostic-SM AVP or the MSC-Absent-User-
Diagnostic-SM AVP is present , within the SRA.
#### A.3.5.2 Mapping of Parameters for the Alert Service Centre Procedure
##### A.3.5.2.1 ALR mapping to alertServiceCentre-Arg
When the IWF needs to construct a MAP alertServiceCentre message as a result
of receiving an ALR command (see subclause A.3.4.2 step 2), the IWF shall open
a MAP dialogue in application context version 3 and populate sub-parameters of
alertServiceCentre-Arg as described below:
**\- msisdn** shall be populated with the value received within MSISDN AVP,
when present, within the User-Identifier AVP within ALR.
**\- imsi** shall be populated with the value received within User-Name AVP,
when present, within the User-Identifier AVP within ALR.
**\- serviceCentreAddress** shall be present and populated with the value
received within the SC-Address AVP within ALR.
**\- correlationId** shall be present if SMSMI-Correlation-ID AVP within ALR
is present and be populated as follows:
> **sip-uri-B parameter** shall be populated with the value received within
> Destination-SIP-URI AVP within SMSMI-Correlation-ID AVP within ALR
##### A.3.5.2.2 alertServiceCentre-Res / Error mapping to ALA
When the IWF needs to construct an ALA command as a result of receiving a MAP
alertServiceCentre Ack/Error message (see subclause A.3.4.2 step 4), the IWF
shall populate AVPs of ASA as described below:
**Result-Code / Experimental-Result** AVP shall be set to:
\- DIAMETER_SUCCESS if a MO-ForwardSM-Res parameter was received in the TCAP
ResultLast component;
\- a DIAMETER base protocol result code according to the following table:
Table A.3.5.2.2-1 Mapping from MAP error codes to Diameter error codes
* * *
**MAP error code** **Diameter Result code / Experimental Result**
**systemFailure** **DIAMETER_UNABLE_TO_COMPLY** **dataMissing**
**DIAMETER_MISSING_AVP** **unexpectedDataValue**
**DIAMETER_INVALID_AVP_VALUE**
* * *
**Supported Features** AVP shall be absent.
#### A.3.5.3 Mapping of Parameters for the Report SM Delivery Status Procedure
##### A.3.5.3.1 ReportSM-DeliveryStatusArg mapping to RDR
When the IWF needs to construct a SRR command as a result of receiving a MAP
reportSM-DeliveryStatus message (see subclause A.3.4.3 step 2), the IWF shall
populate AVPs of SRR as described below:
\- **User-Identifier** AVP shall be present and populated as follows:
\- **MSISDN AVP** shall be populated with the value received, after format
translation, within the msisdn parameter of ReportSM-DeliveryStatusArg.
\- **SMSMI-Correlation-ID** AVP shall be present if correlationID in ReportSM-
DeliveryStatusArg is present and be populated as follows:
\- **Destination-SIP-URI** AVP shall be populated with the value received
within the sip-uri-B parameter of ReportSM-DeliveryStatusArg.
\- **SC-Address** AVP shall be present and populated with the value received
within the serviceCentreAddress parameter of RoutingInfoForSM-Arg
\- **SM-Delivery-Outcome** AVP shall be present and populated as follows:
**SGSN-SM-Delivery-Outcome** AVP shall be populated
\- with the value received in sm-DeliveryOutcome parameter within ReportSM-
DeliveryStatusArg if deliveryOutcomeIndicator flag is present;
\- with the value received in additionalSM-DeliveryOutcome, when present,
within ReportSM-DeliveryStatusArg;
otherwise SGSN-SM-Delivery-Outcome AVP shall be absent.
**MSC-SM-Delivery-Outcome** AVP shall be populated
\- with the value received in sm-DeliveryOutcome parameter within ReportSM-
DeliveryStatusArg if deliveryOutcomeIndicator flag is absent;
otherwise MSC-SM-Delivery-Outcome AVP shall be absent.
**MME-SM-Delivery-Outcome** AVP shall be absent.
NOTE: the MAP-REPORT-SM-DELIVERY-STATUS request does not differentiate the
delivery to a MSC from a delivery to a MME.
**IP-SM-GW-Delivery-Outcome** AVP shall be populated
\- with the value received in sm-DeliveryOutcome parameter within ReportSM-
DeliveryStatusArg if ip-sm-gw-Indicator flag is present;
\- with the value received in ip-sm-gw-sm-deliveryOutcome, when present,
within ReportSM-DeliveryStatusArg;
otherwise IP-SM-GW- Delivery-Outcome AVP shall be absent.
NOTE: The IP-SM-GW- Delivery-Outcome AVP presence can only occur when SMS-GMSC
supports T4 triggering.
**Supported-Features** AVP shall be absent.
##### A.3.5.3.2 RDA mapping to ReportSM-DeliveryStatusRes/Error
When the IWF needs to construct a MAP reportSM-DeliveryStatus Ack message as a
result of receiving a RDA command (see subclause A.3.4. step 4), the IWF shall
populate sub-parameters of reportSM-DeliveryStatusRes/Error as described
below:
**reportSM-DeliveryStatusRes:**
> \- **storedMSISDN** shall be populated with the value, after format
> translation, received within the User-Name AVP, when present, within SRA.
>
> **\- extensionContainer** shall be absent.
**Error:**
Values other than SUCCESS within the Result-Code / Experimental-Result AVP
shall be mapped according to the following table:
Table A.3.5.3.2-1 Mapping from Diameter error codes to MAP error codes
* * *
Diameter Result code / Experimental Result MAP error code
DIAMETER_UNABLE_TO_COMPLY systemFailure DIAMETER_MISSING_AVP dataMissing
DIAMETER_INVALID_AVP_VALUE unexpectedDataValue DIAMETER_ERROR_USER_UNKNOWN
unknownSubscriber DIAMETER_ERROR_MWD_LIST_FULL messageWaitingListFull
* * *
## A.4 IWF related to the S6a/S6a+D interface between MME and HSS
### A.4.1 Introduction
3GPP TS 23.272 [2] has specified the \"SMS in MME\" architecture option, where
an IWF, named S6a/S6a+D IWF, between the S6a interface with SMS subscription
data on the MME side and the S6a interface without SMS subscription data plus
the MAP-based D interface for SMS subscription on the MME side is defined.
This S6a/S6a+D IWF is described in the following subclauses.
### A.Z.2 Interworking scenario
This interworking scenario is illustrated in the figure A.4.2.1-1 where an IWF
is placed between a MME supporting a Diameter based S6a interface with the SMS
in MME feature and a HSS supporting a S6a interface without the SMS feature
and a MAP D interface where the IWF emulates a VLR limited to the support of
SMS teleservice.
This IWF scenario, according to 3GPP TS 23.272 [4], may be used for roaming
cases between the HSS in the home PLMN and the MME in the visited network.
Figure A.4.2-1 S6a/S6a+D for SMS interworking scenario with one IWF
The S6a interface without SMS between the IWF and the HSS may be replaced by a
MAP Gr interface without SMS between a S6a/Gr + D IWF and the HSS as
illustrated in the figure A.4.2-2. The mapping of procedures described in
clause A.4.4 and the mapping of parameters described in clause A.4.5 shall
apply by replacing the commands transferred between the IWF and the HSS over
S6a by the corresponding ones over the Gr interface in compliance with the
clauses 6, 7, 8.
Figure A.4.2-2 S6a/Gr+D for SMS interworking scenario with one IWF
The IWF shall be configured as a MSC-VLR in the HSS over the D interface. Only
the SMS teleservice will be available on the D interface.
### A.4.3 General considerations
#### A.4.3.1 Procedures covered
The MAP procedures on the D interface to be supported by the IWF are:
\- the procedures involved in the support of SMS teleservice:
\- MAP-UPDATE-LOCATION
\- MAP-CANCEL-LOCATION
\- MAP-INSERT-SUBSCRIBER-DATA
\- MAP-DELETE-SUBSCRIBER-DATA
\- MAP-READY-FOR-SM
\- the procedures not linked to the SMS teleservice as such:
\- MAP-PURGE
\- MAP-RESET
Other MAP procedures of the D interface between a VLR and the HSS shall not be
supported by the IWF.
NOTE 1: Some MAP general procedures that are not linked to the SMS service
does not need to be handled over the MAP D interface, as they will be normally
handled with equivalent procedures by the HSS over the S6 interface, e.g. for
MAP-PROVIDE-SUBSCRIBER-INFO, MAP-ACTIVATE/DEACTIVATE-TRACE-MODE or MAP-
RESTORE-DATA.
NOTE 2: It is considered that proper configuration of HSS will avoid the HSS
to attempt to use procedures not supported by the IWF.
The following S6a procedures defined in 3GPP TS 29.272 [5] shall be supported
by the IWF.
\- Update Location
\- Cancel Location
\- Purge UE
\- Insert Subscriber Data
\- Delete Subscriber Data
\- Authentication Information Retrieval
\- Reset
\- Notification
The Authentication Information Retrieval procedure can be simply relayed by
the IWF as having no interaction with a MAP procedure on the D interface.
### A.4.4 The mapping of procedures
#### A.4.4.1 Common aspects
In the S6a, ULR and NOR commands requests received from MME with the SMS in
MME feature bit set , the IWF may remove it in the corresponding command
transferred to the HSS.
In the S6a ULA, NOA commands that the IWF transfers to the MME, the IWF shall
set the SMS in MME feature bit if it was set in the associated ULR or NOR
request.
In the S6a commands IDR, DSR that the IWF transfers to the MME, the IWF shall
set the SMS in MME feature bit if it was set in the previous ULR received from
the MME.
In the S6a, IDA, DSA answers received from MME with the SMS in MME feature bit
set, the IWF may remove it in the corresponding command transferred to the
HSS.
The IWF shall support MAP version V3 and should support fallback to version V1
or V2.
#### A.4.4.2 Update Location
The mapping of the Update Location procedure is shown in figure A.4.4.2-1:
Figure A.4.4.2-1: Mapping of the Update Location procedure
1\. The IWF receives a ULR from the MME with the SMS in MME feature bit set
and a request to be registered for MT-SMS.
2\. The IWF stores the SMS related information (SMS Register Request, SMS only
indication, MME number for MT-SMS), sends the ULR to the HSS where the IWF may
clear the SMS in MME feature bit and remove the information related to SMS.
3\. The HSS answers with a ULA.
4\. If the ULA is successful and has the SMS in MME feature bit cleared and
the received Network Access Mode (NAM) is PS + CS, the IWF sends a MAP
updateLocation to the HSS with the MME Number for MT SMS. Otherwise the IWF
skips to the step 8.
5\. The HSS sends a MAP insertSubscriberData with the CS subscription data of
the user.
6\. If the IWF receives the SMS teleservice in insertSubscriberData and
if the SMS Register Request is \"SMS in MME required\",
or if the SMS Register Request is \"No preference\" and a \"SMS only
indication\" was received in step 2,
or if the SMS Register Request is \"No preference\" and no SMS only
indication\" was received in step 2 and no other CS teleservices than the SMS
teleservice have been received,
then the IWF sends an insertSubscriberDataAck in which the IWF returns the
received CS teleservices other than the SMS teleservice, if any;
otherwise the IWF sends an insertSubscriberDataAck in which the IWF returns
the received CS teleservices including the SMS teleservice.
If the IWF has not received the SMS teleservice in insertSubscriberData, the
IWF sends an insertSubscriberDataAck where the IWF returns the received CS
teleservices
7 The HSS sends a MAP updateLocationAck.
8\. If the ULA received in step 3 is successful and the received Network
Access Mode (NAM) is PS, the IWF sends the received ULA with the SMS in MME
feature bit set and the indication that MME is not registered for SMS.
NOTE: The use of SMS in MME is not possible in this IWF case when the user has
no CS subscription for the SMS teleservice.
If the IWF receives the SMS teleservice in insertSubscriberData and
if the SMS Register Request is \"SMS in MME required\",
or if the SMS Register Request is \"No preference\" and a \"SMS only
indication\" was received in step 2,
or if the SMS Register Request is \"No preference\" and no SMS only
indication\" was received in step 2 and no other CS teleservices than the SMS
teleservice have been received in step 5,
then the IWF sends the ULA received in step 3 in which the IWF sets the SMS in
MME feature bit and indicates that the MME is registered for SMS and includes
the SMS subscription data;
otherwise the IWF sends the ULA received in step 3 in which the IWF sets the
SMS in MME feature bit and indicates that the MME is not registered for SMS
and does not include any SMS subscription data.
NOTE: the MSC registration is not cancelled because it has been indicated that
SMS teleservice is not supported. Further it is assumed that the MME will
perform an SGs association which will initiate a Location Update via a VLR
If the IWF has not received the SMS teleservice in insertSubscriberData, the
IWF sends the ULA received in step 3 in which the IWF indicates that the MME
is not registered for SMS.
If the ULA received in step 4 is unsuccessful, the IWF sends the ULA received
in step 3 unchanged.
If in step 7, the IWF receives an updateLocation answer with a MAP error, the
IWF sends the ULA received in step 3 unchanged with the indication that MME is
not registered for SMS.
#### A.4.4.3 Cancel Location
##### A.4.4.3.1 Cancel Location over S6a
The mapping of the Cancel Location over S6a procedure is shown in figure
A.4.4.3.1-1:
Figure A.4.4.3.1-1: Mapping of the Cancel Location over S6a procedure
1\. The IWF receives a CLR from the HSS.
2\. The IWF send the CLR unchanged to the MME.
3\. The IWF, if it has been registered by the HSS over the MAP D interface
shall send a MAP purgeMS message to the HSS.
4\. the IWF receives a purgeMSAck from the HSS.
5\. the IWF receives a CLA from the MME.
6\. the IWF sends the CLA unchanged to the MME.
The steps 3/4 and the step 5 may occur in parallel.
##### A.4.4.3.2 Cancel Location over MAP D
The mapping of the Cancel Location over MAP D procedure is shown in figure
A.4.4.3.2-1:
Figure A.4.4.3.2-1: Mapping of the Cancel Location over MAP D procedure
1\. The IWF receives a CancelLocation from the HSS
2\. If the MME is registered for SMS, the IWF sends an IDR to the MME with the
indication to remove the MME registration for SMS; otherwise the IWF skips to
the step 4.
3\. The IWF receives an IDA.
4\. The IWF sends a CancelLocation Ack to the HSS.
#### A.4.4.4 Purge
The mapping of the Purge procedure is shown in figure A.4.4.4-1:
Figure A.4.4.4-1: Mapping of the Purge procedure
1\. The IWF receives a PUR message from the MME.
2a. The IWF sends the PUR message unchanged to the HSS.
3a. The IWF receives PUA from the HSS.
2b. The IWF, if it has been registered by the HSS over the MAP D interface,
sends a MAP purgeMS message to the HSS.
3b. The IWF receives a MAP purgeMSAck message from the HSS.
4\. The IWF sends PUA to the MME.
The steps 2a/3a and 2b/3b may occur in parallel.
#### A.4.4.5 Insert Subscriber Data
##### A.4.4.5.1 Insert Subscriber Data over S6a
If the IWF receives an IDR from the HSS, the IWF sends the IDR unchanged to
the MME apart the possible setting of the SMS in MME feature bit as described
in subclause A.4.4.1.
##### A.4.4.5.2 Insert Subscriber Data over MAP D
The mapping of the Insert Subscriber Data over MAP D procedure is shown in
figure A.4.4.5.2-1:
Figure A.4.4.5.2-1: Mapping of the Insert Subscriber Data over MAP D procedure
1\. The IWF receives a (stand alone) MAP InsertSubscriberData message from the
HSS.
2\. If the MAP InsertSubscriberData does not contain any data related to SMS,
the IWF ignores the received data data and skips to the step 4
If the MAP InsertSubscriberData contains data related to SMS, the IWF maps
them into an IDR towards the MME and ignores the other received data data.
3\. The IWF receives IDA from the MME.
4\. The IWF sends InsertSubscriberData Ack to the HSS.
5\. Steps 1 to 4 may be repeated several times for InsertSubscriberData. The
repetition may be in burst mode or in acknowledge mode.
6\. The HSS closes the MAP dialogue.
#### A.4.4.6 Delete Subscriber Data
##### A.4.4.6.1 Delete Subscriber Data over S6a
If the IWF receives a DSR from the HSS, the IWF sends the DSR unchanged to the
MME apart the possible setting of the SMS in MME feature bit as described in
subclause A.4.4.1
##### A.4.4.6.2 Delete Subscriber Data over MAP D
The mapping of the Delete Subscriber Data over MAP D procedure is shown in
figure A.4.4.6.2-1:
Figure A.4.4.6.2-1: Mapping of the Delete Subscriber Data over MAP D procedure
1\. The IWF receives a MAP DeleteSubscriberData message from the HSS.
> 2\. If the MAP DeleteSubscriberData does not contain any data related to
> SMS, the IWF ignores the received data data. The IWF skips to step 4.If the
> MAP DeleteSubscriberData contains data related to SMS, the IWF maps them
> into a DSR towards the MME and ignores the other received data data .
3\. The IWF receives DSA from the MME.
4\. The IWF sends DeleteSubscriberData Ack to the HSS.
5 If the SMS subscription is withdrawn, the IWF sends an IDR to the MME with
the indication to remove the MME registration for SMS. Otherwise the procedure
is terminated.
6\. The IWF receives an IDA from the MME.
7\. The IWF sends a PurgeMS to the HSS.
8\. The IWF receives a Purge MS Ack from the HSS.
#### A.4.4.7 Reset
The mapping of the Reset procedure is shown in figure A.4.4.7-1:
Figure A.4.4.7-1: Mapping of the Reset over S6a procedure
When there is a reset from HSS, the reset shall normally occur on both the S6a
interface and the MAP D interface. The procedure handling may also apply when
only a RSR is received on the S6a interface and no Reset message over the MAPD
interface.
NOTE: It is out of the scope to address the handling of a Reset message
received over the MAP D interface without receiving a RSR over the S6a
interface.
1a. The IWF receives a RSR from the HSS, the IWF stores this information
1.b The IWF should receive a MAP Reset from the HSS.
2\. The IWF sends a RSR unchanged to the MME.
3\. The IWF receives a RSA from the MME.
4\. The IWF sends the RSA unchanged to the HSS.
#### A.4.4.8 Notification
The mapping of the Notification procedure is shown in figure A.4.4.8-1:
Figure A.4.4.8-1: Mapping of the Notification Procedure
1\. The IWF receives a NOR message from the MME.
2a. If the NOR message contains notifications other than the Ready for SM from
MME notification, the IWF sends a NOR message with the Ready for SM flag
cleared, the Alert Reason information element removed and unchanged for the
other notifications to the HSS.
3a. The IWF receives a NOA if a NOR was sent in step 2a.
2b. If the Ready for SM from MME flag is set in the NOR received in step 1,
the IWF sends a MAP ReadyForSM message to the HSS.
3b. The IWF receives a MAP ReadyForSM Ack message, if a MAP ReadyForSM message
was sent in step 2b.
4 If the NOR and/or the MAP ReadyForSM Ack messages received from the HSS are
successful, the IWF sends a successful NOA to the MME.
The steps 2a/3a and 2b/3b may occur in parallel.
If one of the NOA or ReadyForSM answer from the HSS is successful and the
other unsuccessful, the NOA sent to MME should be with an unsuccessful result
mapped from the received error.
### A.4.5 The mapping of parameters
#### A.4.5.1 Unchanged AVPs
Many commands between the MME and the IWF are not specific to SMS and are
transferred over the S6a interface between the IWF and the HSS. Unless
otherwise stated in the following A.4.5 subclauses, the AVPs received by the
IWF in a Diameter command are transferred unchanged in the Diameter command
sent by the IWF.
#### A.4.5.2 Mapping of Parameters for the Update Location procedure
##### A.4.5.2.1 ULR mapping to ULR
When the IWF receives a ULR from the MME with the SMS in MME feature bit set,
the IWF generates a ULR towards the HSS where:
\- the feature bit \"SMS in MME\" shall not be set;
\- the MME-Number-for-MT-SMS AVP, the SMS-Only AVP and the SMS-Register-
Request AVP shall be removed.
##### A.4.5.2.1 ULR mapping to UpdateLocationArg
When the IWF needs to construct a MAP-UpdateLocation message as a result of
receiving an ULR command (see sections A.Z.4.2 step 4), the IWF shall open a
MAP dialogue in application context version 3 and populate sub-parameters of
UpdateLocationArg as described below:
**\- imsi** in UpdateLocationArg shall be populated with the value of the
User-Name AVP received within ULR.
**\- msc-Number** in UpdateLocationArg shall be populated with the value of
the MME-Number-for-MT-SMS AVP within ULR,
**\- vlr-Number** in UpdateLocationArg shall be populated with a value locally
assigned to the IWF and consistent with SS7 routing principles.
**\- mme-DiameterAddress** in UpdateLocationArg shall be present and be
populated as follows
**\- diameter-Name** shall be populated with the value received in the Origin-
Host AVP within ULR;
**\- diameter-Realm** shall be populated with the value received within the
Origin-Realm AVP within ULR.
Other parameters defined for UpdateLocationArg shall be absent.
##### A.4.5.2.2 InsertSubscriberDataArg mapping to ULA
When the IWF needs to construct an ULA command as a result of receiving a
successful ULA and a successful UpdateLocation Ack, the IWF shall behave as
described in subclause A.Z.4.2 step 8 and in particular:
**\- Teleservice-List** AVP shall only contain the TS-Code AVPs related to the
short message teleservice with the values received in the corresponding Ext-
TeleserviceCode parameters in the InsertSubscriberDataArg.
**\- Call-Barring-Info** AVPs shall be present if call barring SS**-** code
and SS-status parameters were present within the Call Barring Information List
parameter within the InsertSubscriberDataArg and the SS-Code AVP and SS-Status
AVP within the Call-Barring-Info AVPs shall be populated with the values of
the received call barring SS-code and SS-status parameters within the Call
Barring Information List parameter within the InsertSubscriberDataArg.
**\- Operator-Determined-Barring** AVP shall be present if an odb-GeneralData
parameter within SubscriberData parameter within InsertSubscriberDataArg was
present with values related to call barring which shall be mapped to the
corresponding flags within Operator-Determined-Barring AVP.
NOTE: ODB values in the ULA received from HSS are transferred unchanged in the
ULA sent to the MME.
##### A.4.5.2.2 Mapping to InsertSubscriberDataRes
When the IWF needs to construct a MAP-InsertSubscriberData Ack message as a
result of receiving an InsertSubscriberDataArg message (see subclause A.Z.4.2,
step 6), the IWF shall populate sub-parameter of InsertSubscriberDataRes as
follows:
**\- ss-List** in InsertSubscriberDataRes shall include the ssCodes that have
been received within InsertSubscriberDataArg and for which the corresponding
flag of the Feature-List AVP is not set in the IDA.
**\- teleserviceList** in InsertSubscriberDataRes shall include all
teleserviceCodes that have been received within InsertSubscriberDataArg except
those related to the short message teleservice.
**\- bearerServiceList** in InsertSubscriberDataRes shall include all
bearerServiceCodes that have been received within InsertSubscriberDataArg.
**\- odb-GeneralData** in InsertSubscriberDataRes shall include all odb
categoties that have been received within InsertSubscriberDataArg and that are
not supported by the MME as indicated within the Supported-Feature AVP within
ULR.
Other sub parameters in InsertSubscriberDataRes shall be absent.
\- For **InsertSubscriberData Error** : Values other than SUCCESS within the
Result-Code / Experimental-Result AVP shall be mapped onto an appropriate MAP
error.
#### A.4.5.3 Mapping of Parameters for the Cancel Location procedure
##### A.4.5.3.1 CLR mapping to PurgeMSArg mapping to
When the IWF needs to construct a MAP-PurgeMS message as a result of receiving
CLR command (see subclause A4.4.3.1 step 3), the IWF shall open a MAP dialogue
in application context version 3 and populate sub-parameters of PurgeMS-Arg as
described below:
**\- imsi** in PurgeMS-Arg shall be populated with the imsi value of the User-
Name AVP received within CLR.
**\- vlr-Number** in PurgeMS-Arg shall be populated with the value given in
the previous Update Location procedure.
**\- sgsn-Number** and **extensionContainer** in PurgeMS-Arg shall be absent.
##### A.4.5.3.2 CancelLocationArg mapping to IDR
When the IWF needs to construct an IDR as a result of receiving a
CancelLocation message (see subclause A.4.4.3.2 step 2), the IWF shall
populate AVPs of DSR as described below:
**IDR-Flags** AVP:
**\- Remove SMS Registration** flag shall be set to 1.
\- Other flags shall be set to 0.
**Subscription-Data** AVP shall be included empty.
##### A.4.5.3.3 IDA mapping to CancelLocationRes/Error
When the IWF needs to construct a MAP-CancelLocation Ack message as a result
of receiving an IDA command (see subclause A.4.4.3.2 step 4), the IWF shall
populate sub-parameters of CancelLocationRes/Error as described below:
**CancelLocationRes** :
\- **extensionContainer** in CancelLocationRes shall be absent.
**CancelLocation Error** :
\- Values other than SUCCESS within the Result-Code / Experimental-Result AVP
shall be mapped onto an appropriate MAP error.
#### A.4.5.4 Mapping of Parameters for the Purge Procedure
##### A.4.5.4.1 PUR mapping to PurgeMS-Arg
When the IWF needs to construct a MAP-PurgeMS message as a result of receiving
a PUR command (see subclause A.4.4.4 step 2b), the IWF shall open a MAP
dialogue in application context version 3 and populate sub-parameters of
PurgeMS-Arg as described below:
**\- imsi** in PurgeMS-Arg shall be populated with the imsi value of the User-
Name AVP received within PUR.
**\- vlr-Number** in PurgeMS-Arg shall be populated with the value given in
the previous Update Location procedure.
**\- sgsn-Number** and **extensionContainer** in PurgeMS-Arg shall be absent.
##### A.4.5.4.2 PurgeMS-Res / Error mapping to PUA
The Result-Code / Experimental-Result AVP and the other AVPs of the PUA sent
by the IWF to the MME, shall be the same as those received in the PUA from the
HSS and are not dependent of the PurgeMS Ack message received over MAP D.
#### A.4.5.5 Mapping of Parameters for the Insert Subscriber Data Procedure
##### A.4.5.5.1 InsertSubscriberDataArg mapping to IDR
When the IWF needs to construct an IDR as a result of receiving a
InsertSubscriberData message, the IWF shall behave as described in subclause
A.Z.4.2 step 8. In particular:
\- **Teleservice-List** AVP, shall be present if short message related Ext-
TeleserviceCode parameters were received and shall contain the TS-Code AVPs
related to the short message teleservice with the values received in the
corresponding Ext-TeleserviceCode parameters.
\- **Call-Barring-Info** AVPs shall be present if call baring SS-code and SS-
status parameters were present within the Call Barring Information List
parameter within the InsertSubscriberDataArg and the SS-Code AVP and SS-Status
AVP within the Call-Barring-Info AVPs shall be populated with the values of
the received call barring SS-code and SS-status parameters within the Call
Barring Information List parameter within the InsertSubscriberDataArg.
##### A.4.5.5.2 IDA mapping to InsertSubscriberDataRes/Error
When the IWF needs to construct a MAP-InsertSubscriberData Ack message as a
result of receiving an IDA command (see subclause A.Z.4.5.2, step 4), the IWF
shall populate sub-parameter of InsertSubscriberDataRes as follows:
**ss-List** in InsertSubscriberDataRes shall include the ssCodes that have
been received within InsertSubscriberDataArg and for which the corresponding
flag of the Feature-List AVP is not set in the IDA.
Other sub parameters in InsertSubscriberDataRes shall be absent.
For **InsertSubscriberData Error** : Values other than SUCCESS within the
Result-Code / Experimental-Result AVP shall be mapped onto an appropriate MAP
error.
#### A.4.5.6 Mapping of Parameters for the Delete Subscriber Data Procedure
##### A.4.5.6.1 DeleteSubscriberDataArg mapping to DSR
When the IWF needs to construct a DSR command as a result of receiving a MAP-
DeleteSubscriberData message (see subclause A.4.4.6.2 step 2), the the IWF
shall populate AVPs of DSR as described below:
**\- User-Name** AVP shall be populated with the value received within the
imsi parameter of DeleteSubscriberDataArg.
**\- Supported-Features** AVP shall be absent.
**\- DSR-Flags** AVP: Flags shall be set as follows:
\- **SMS Withdrawal** shall be set to 1 if the SS-Code list parameter was
present within DeleteSubscriberDataArg and the service codes are related to
short message services; otherwise shall be set to 0.
\- other flags shall be set to 0.
##### A.4.5.6.2 DSA mapping to DeleteSubscriberDataRes/Error
When the IWF needs to construct a MAP-DeleteSubscriberData Ack message as a
result of receiving a DSA command (see subclause A.4.4.6.2 step 4), the IWF
shall populate sub-parameters of DeleteSubscriberDataRes/Error as described
below:
**DeleteSubscriberDataRes** :
\- No sub-parameter shall be present in DeleteSubscriberDataRes.
**DeleteSubscriberData Error** :
Values other than SUCCESS within the Result-Code / Experimental-Result AVP
shall be mapped onto an appropriate MAP error.
#### A.4.5.7 Mapping of Parameters for the Reset Procedure
##### A.4.5.7.1 Reset mapping to RSR
When the IWF needs to construct a RSR command as a result of receiving a RSR
and a MAP Reset message (see subclause A.4.4.7 step 2), the IWF shall send the
RSR received from HSS unchanged and ignore the sub-parameters of the MAP Reset
message.
#### A.4.5.8 Mapping of Parameters for the Notification Procedure
##### A.4.5.8.1 NOR mapping to ReadyForSM-Arg
When the IWF needs to construct a MAP-ReadyForSM message as a result of
receiving a NOR command (see subclause A.Z.4.8 step 2b), the IWF shall open a
MAP dialogue in application context version 3 and populate sub-parameters of
ReadyForSMArg as described below:
**\- imsi** in ReadyForSMArg shall be populated with the value of the User-
Name AVP received within NOR.
**\- alertReason** in ReadyForSMArg shall be populated with the value of the
Alert-Reason AVP received within NOR.
**\- alertReasonIndicator** in ReadyForSMArg shall be absent.
**\- additionalAlertReasonIndicator** in ReadyForSMArg shall be absent.
**\- extensionContainer** in ReadyForSMArg shall be absent.
**\- maximumUeAvailabilityTime** in ReadyForSMArg shall be present and
populated with the value received within the Maximum-UE-Availability-Time AVP,
when present, within NOR .
#
# Foreword
This Technical Specification has been produced by the 3^rd^ Generation
Partnership Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# 1 Scope
The present specification defines the stage 3 interworking procedures for 5G
Network interworking between PLMN and external DN.
The stage 2 requirements and procedures are contained in 3GPP TS 23.501 [2]
and 3GPP TS 23.502 [3].
For interworking between 5G PLMN and external DNs, the present document is
valid for both 3GPP accesses and non-3GPP accesses.
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or nonâ€‘specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
[1] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[2] 3GPP TS 23.501: \"System Architecture for the 5G System; Stage 2\".
[3] 3GPP TS 23.502: \"Procedures for the 5G System; Stage 2\".
[4] 3GPP TS 29.281: \"General Packet Radio System (GPRS) Tunnelling Protocol
User Plane (GTPv1-U)\".
[5] 3GPP TS 29.061: \"Interworking between the Public Land Mobile Network
(PLMN) supporting packet based services and Packet Data Networks (PDN)\".
[6] IETF RFC 3748: \"Extensible Authentication Protocol (EAP)\".
[7] IETF RFC 3579: \"RADIUS (Remote Authentication Dial In User Service)
Support For Extensible Authentication Protocol (EAP)\".
[8] IETF RFC 2865: \"Remote Authentication Dial In User Service (RADIUS)\".
[9] IETF RFC 3162: \"RADIUS and IPv6\".
[10] IETF RFC 4818: \"RADIUS Delegated-IPv6-Prefix Attribute\".
[11] IETF RFC 5216: \"The EAP-TLS Authentication Protocol\".
[12] 3GPP TS 23.228: \"IP Multimedia Subsystem (IMS); Stage 2\".
[13] 3GPP TS 24.229: \"IP Multimedia Call Control Protocol based on SIP and
SDP; Stage 3\".
[14] IETF RFC 2132: \"DHCP Options and BOOTP Vendor Extensions\".
[15] IETF RFC 3361: \"Dynamic Host Configuration Protocol (DHCP-for-IPv4)
Option for Session Initiation Protocol (SIP) Servers\".
[16] IETF RFC 3646: \"DNS Configuration options for Dynamic Host Configuration
Protocol for IPv6 (DHCPv6)\".
[17] IETF RFC 3319: \"Dynamic Host Configuration Protocol (DHCPv6) Options for
Session Initiation Protocol (SIP) Servers\".
[18] IETF RFC 2131: \"Dynamic Host Configuration Protocol\".
[19] IETF RFC 1542: \"Clarification and Extensions for the Bootstrap
Protocol\".
[20] IETF RFC 4039: \"Rapid Commit Option for the Dynamic Host Configuration
Protocol version 4 (DHCPv4)\".
[21] IETF RFC 3315: \"Dynamic Host Configuration Protocol for IPv6 (DHCPv6)\".
[22] IETF RFC 3736: \"Stateless Dynamic Host Configuration Protocol (DHCP)
Service for IPv6\".
[23] IETF RFC 7155: \"Diameter Network Access Server Application\".
[24] IETF RFC 6733: \"Diameter Base Protocol\".
[25] IETF RFC 4072: \"Diameter Extensible Authentication Protocol (EAP)
Application\".
[26] IETF RFC 2866: \"RADIUS Accounting\".
[27] IETF RFC 5176: \"Dynamic Authorization Extensions to Remote
Authentication Dial In User Service (RADIUS)\".
[28] 3GPP TS 23.003: \"Numbering, addressing and identification\".
[29] IETF RFC 1825: \"**Security Architecture for the Internet Protocol** \".
[30] IETF RFC 1826: \"**IP Authentication Header** \".
[31] IETF RFC 1827: \"**IP Encapsulating Security Payload (ESP)** \".
[32] IETF RFC 4291: \"IP Version 6 Addressing Architecture\".
[33] IETF RFC 4861: \"Neighbor Discovery for IP Version 6 (IPv6)\".
[34] IETF RFC 4862: \"IPv6 Stateless Address Autoconfiguration\".
[35] IETF RFC 1027: \"Using ARP to Implement Transparent Subnet Gateways\".
[36] 802.3-2015 - IEEE Standard for Ethernet.
[37] IETF RFC 5281: \"Extensible Authentication Protocol Tunneled Transport
Layer Security Authenticated Protocol Version 0 (EAP-TTLSv0)\".
[38] 3GPP TS 23.380: \"IMS Restoration Procedures\".
[39] 3GPP TS 29.571: \"5G System; Common Data Types for Service Based
Interfaces; Stage 3\".
[40] 3GPP TS 29.502: \"5G System; Session Management Services; Stage 3\".
[41] 3GPP TS 29.229: \"Cx and Dx interfaces based on Diameter protocol;
Protocol details\".
# 3 Definitions and abbreviations
## 3.1 Definitions
For the purposes of the present document, the terms and definitions given in
3GPP TR 21.905 [1] and the following apply. A term defined in the present
document takes precedence over the definition of the same term, if any, in
3GPP TR 21.905 [1].
## 3.2 Abbreviations
For the purposes of the present document, the abbreviations given in 3GPP TR
21.905 [1] and the following apply. An abbreviation defined in the present
document takes precedence over the definition of the same abbreviation, if
any, in 3GPP TR 21.905 [1].
CSMA/CD Carrier Sense Multiple Access/Collision Detection
DHCPv4 Dynamic Host Configuration Protocol version 4
DHCPv6 Dynamic Host Configuration Protocol version 6
DN Data Network
GPSI Generic Public Subscription Identifier
N3IWF Non-3GPP InterWorking Function
PtP Point-to-Point
SFD Start Frame Delimiter
SMF Session Management Function
SSC Session and Service Continuity
UPF User Plane Function
WAN Wide Area Network
# 4 Network Characteristics
## 4.1 Key characteristics of PLMN
The PLMN is fully defined in the 3GPP technical specifications. The 5G Network
related key characteristics are defined in 3GPP TS 23.501 [2].
## 4.2 Key characteristics of IP Networks
The Internet is a conglomeration of networks utilising a common set of
protocols. IP protocols are defined in the relevant IETF RFCs. The networks
topologies may be based on LANs (e.g. Ethernet), Point to Point leased lines,
PSTN, ISDN, X.25 or WANs using switched technology (e.g. SMDS, ATM).
## 4.3 Key characteristics of Ethernet
The Ethernet is a family of computer networking technologies commonly used in
LAN and is often used to refer to all Carrier Sense Multiple Access/Collision
Detection (CSMA/CD) LANs that generally conform to Ethernet Specifications,
including IEEE 802.3 [36]. The key characteristics for Ethernet are defined in
IEEE 802.3 [36].
# 5 Interworking Classifications
## 5.1 Service Interworking
Service interworking is required when the Teleservice at the calling and
called terminals are different. No service interworking is specified in this
specification.
## 5.2 Network Interworking
Network interworking is required whenever a PLMN is involved in communications
with another network to provide end-to-end communications. The PLMN shall
interconnect in a manner consistent with that of a normal Data Network (type
defined by the requirements e.g. IP). Interworking appears exactly like that
of Data Networks.
# 6 Reference Architecture
Figure 6-1 shows the access interfaces for the 5G Network. The 5G Network
includes both the 3GPP access and the non-3GPP access.
Figure 6-1: Reference Architecture for 5G Network Interworking
NOTE: The SMF represents the H-SMF in the home routed scenario.
# 7 Interface to 5G Network services (User Plane)
The user plane for 5G Network services is defined in subclause 8.3 of 3GPP TS
23.501 [2] and 3GPP TS 29.281 [4].
# 8 Interworking with DN (IP)
## 8.1 General
5GS shall support interworking with DNs based on the Internet Protocol (IP).
These interworked networks may be either intranets or the Internet.
## 8.2 DN Interworking Model
### 8.2.1 General
When interworking with the IP networks, the 5GS can operate IPv4 and/or IPv6.
The interworking point is shown in clause 6.
The UPF for interworking with the IP network is the 5GS access point (see
figure 8.2.1-1).
Figure 8.2.1-1: The protocol stacks of UPF for the IP network interworking
Typically, in the IP networks, the interworking with subnetworks is done via
IP routers. The N6 reference point is between the UPF and the external IP
network. From the external IP network\'s point of view, the UPF is seen as a
normal IP router. The L2 and L1 layers are operator specific.
It is out of the scope of the present document to standardise the router
functions and the used protocols in the N6 reference point.
Interworking with user defined ISPs and private/public IP networks is subject
to interconnect agreements between the network operators.
### 8.2.2 Access to DN through 5G Network
#### 8.2.2.1 Transparent access to DN
Figure 8.2.2.1-1: Example of the DN Interworking Model, transparent case
In figure 8.2.2.1-1, an example DN interworking model for transparent access
to the Internet is provided for an UPF in the 5GS and its N6 reference point.
In transparent access to the Internet case:
\- the UE is given an IPv4 address and/or an IPv6 prefix belonging to the
operator addressing space. The IPv4 address and/or IPv6 prefix is assigned
either at subscription in which case it is a static address or at PDU session
establishment in which case it is a dynamic address. This IPv4 address and/or
IPv6 prefix if applicable is used for packet forwarding between the Internet
and the UPF and within the 5GS. With IPv6, Stateless Address Autoconfiguration
shall be used to assign an IPv6 address to the UE. These procedures are as
described in the IPv6 non-transparent access case except that the addresses
belong to the operator addressing space.
\- the UE need not send any authentication request at PDU session
establishment procedure and the SMF/UPF need not take any part in the user
authentication/authorization process.
The transparent case provides at least a basic ISP service. As a consequence
of this it may therefore provide a QoS flow service for a tunnel to a private
Intranet. The user level configuration may be carried out between the UE and
the intranet, the 5GS is transparent to this procedure. The used protocol
stack is depicted in figure 8.2.2.1-2.
Figure 8.2.2.1-2: Transparent access to an Intranet
The communication between the PLMN and the Intranet may be performed over any
network, even an insecure network e.g. the Internet. There is no specific
security protocol between the UPF and the Intranet because security is ensured
on an end to end basis between the UE and the intranet by the \"Intranet
Protocol\".
User authentication and encryption of user data are done within the \"Intranet
Protocol\" if either of them is needed. This \"Intranet Protocol\" may also
carry private (IP) addresses belonging to the address space of the Intranet.
An example of an \"Intranet Protocol\" is IPsec (see IETF RFC 1825 [29]). If
IPsec is used for this purpose, then IPsec authentication header or security
header may be used for user (data) authentication and for the confidentiality
of user data (see IETF RFC 1826 [30] and IETF RFC 1827 [31]). In this case
private IP tunnelling within public IP takes place.
#### 8.2.2.2 IPv4 Non-transparent access to DN
In this case:
\- a static or a dynamic IPv4 address belonging to the Intranet/ISP addressing
space is allocated to a UE at PDU session establishment. The methods of
allocating IP address to the UE are specified in 3GPP TS 23.501 [2]. The
allocated IPv4 address is used for packet forwarding within the UPF and for
packet forwarding on the Intranet/ISP;
\- as a part of the PDU session establishment, the SMF may request user
authentication from an external DN-AAA server (i.e. RADIUS, Diameter)
belonging to the Intranet/ISP;
\- the IPv4 address allocation to the UE may be performed based on the
subscription or a local address pool, which belongs to the Intranet/ISP
addressing space, provisioned in the SMF; or via the address allocation
servers (i.e. DHCPv4, RADIUS DN-AAA, Diameter DN-AAA) belonging to the
Intranet/ISP;
\- if requested by the UE at PDU session establishment, the SMF may retrieve
the Protocol Configuration Options or IPv4 configuration parameters from a
locally provisioned database in SMF and/or from some external server (i.e.
DHCPv4, RADIUS DN-AAA, Diameter DN-AAA) belonging to the Intranet/ISP;
\- the communication between the 5GS and the Intranet/ISP may be performed
over any network, even an insecure network, e.g. the Internet. In case of an
insecure connection between the UPF and the Intranet/ISP, there may be a
specific security protocol in between. This security protocol is defined by
mutual agreement between PLMN operator and Intranet/ISP administrator.
Table 8.2.2.2-1 summarizes the IPv4 address allocation and parameter
configuration use cases between the UE and the SMF that may lead the SMF to
interwork with the external DHCPv4, DN-AAA servers. For detailed description
of the signalling flows between the UE and the SMF, see the references in the
table.
Table 8.2.2.2-1: IPv4 address allocation and parameter configuration use cases
+----------------+----------------+----------------+----------------+ | Signalling use | Signalling use | | | | cases between | cases between | | | | UE and SMF | SMF and | | | | | external | | | | | servers | | | +----------------+----------------+----------------+----------------+ | | Authentication | IPv4 Address | IPv4 parameter | | | via RADIUS or | allocation via | configuration | | | Diameter | DHCPv4 or | via DHCPv4 or | | | DN-AAA server | RADIUS or | RADIUS or | | | (clauses 11 or | Diameter | Diameter | | | 12) | DN-AAA server | DN-AAA server\ | | | | (clauses 10, | (clauses 10, | | | (NOTE 1 NOTE 2 | 11 or 12) | 11 or 12) | | | and NOTE 4) | | | | | | (NOTE 1 and | (NOTE 1 and | | | | NOTE 2) | NOTE 2) | +----------------+----------------+----------------+----------------+ | (1) IPv4 | X | X | X | | address | | | | | allocation and | | | | | parameter | | | | | configuration | | | | | via activation | | | | | of QoS flow | | | | | associated | | | | | with the | | | | | default QoS | | | | | rule | | | | | | | | | | (2) IPv4 | | | | | address | | | | | allocation and | | | | | parameter | | | | | configuration | | | | | via DHCPv4 | | | | | signalling | | | | | from UE | | | | | towards SMF | | | | | (NOTE 3) | | | | +----------------+----------------+----------------+----------------+ | (3) IPv4 | X | X | X | | address | | | | | allocation and | | | | | parameter | | | | | configuration | | | | | in untrusted | | | | | non-3GPP IP | | | | | access | | | | +----------------+----------------+----------------+----------------+ | NOTE 1: When | | | | | the SMF | | | | | interworks | | | | | with AAA | | | | | servers, the | | | | | DNN may be | | | | | configured to | | | | | interwork with | | | | | either | | | | | Diameter | | | | | DN-AAA or | | | | | RADIUS DN-AAA | | | | | server. | | | | | | | | | | NOTE 2: If | | | | | RADIUS DN-AAA | | | | | or Diameter | | | | | DN-AAA server | | | | | is used, the | | | | | a | | | | | uthentication, | | | | | IPv4 address | | | | | allocation and | | | | | parameter | | | | | configuration | | | | | signalling may | | | | | be combined. | | | | | Similarly, if | | | | | DHCPv4 server | | | | | is used for | | | | | IPv4 address | | | | | allocation and | | | | | parameter | | | | | configuration, | | | | | the signalling | | | | | towards the | | | | | DHCPv4 server | | | | | may be | | | | | combined. | | | | | | | | | | NOTE 3: If the | | | | | authentication | | | | | and | | | | | authorization | | | | | procedure | | | | | towards RADIUS | | | | | DN-AAA or | | | | | Diameter | | | | | DN-AAA is | | | | | required, it | | | | | is performed | | | | | by the SMF | | | | | before the | | | | | DHCPv4 | | | | | signalling | | | | | when it | | | | | receives the | | | | | initial access | | | | | request (i.e. | | | | | Nsmf_P | | | | | DUSession_Cre | | | | | ateSMContext). | | | | | | | | | | NOTE 4: The N1 | | | | | mode UE can | | | | | provide | | | | | PAP/CHAP user | | | | | credentials in | | | | | the ePCO IE | | | | | when accessing | | | | | to 5GS on 3GPP | | | | | and non-3GPP | | | | | IP accesses. | | | | | If such | | | | | information is | | | | | provided to | | | | | the SMF, the | | | | | SMF can | | | | | perform user | | | | | authentication | | | | | with the | | | | | DN-AAA server | | | | | based on these | | | | | credentials. | | | | | How to perform | | | | | authentication | | | | | by the SMF and | | | | | the DN-AAA | | | | | server is not | | | | | specified in | | | | | this release. | | | | +----------------+----------------+----------------+----------------+
NOTE: External network operators intending to use PAP/CHAP without proper
underlying protection for authentication are warned about the respective
vulnerabilities of PAP and CHAP protocols from a security point of view. It's
up to the external network operator to perform the risk assessment if PAP/CHAP
is used for authentication.
#### 8.2.2.3 IPv6 Non-transparent access to DN
When using IPv6 Address Autoconfiguration, the process of setting up the
access to an Intranet or ISP involves two signalling phases. The first
signalling phase is done in the control plane and consists of the PDU session
establishment for 5GS 3GPP or non-3GPP based access, followed by a second
signalling phase done in the user plane.
The user plane signalling phase shall be stateless. The stateless procedure,
which involves only the UE and the SMF, is described in subclause 10.2. 3.
For DNNs that are configured for IPv6 address allocation, the SMF shall only
use the Prefix part of the IPv6 address for forwarding of mobile terminated IP
packets. The size of the prefix shall be according to the maximum prefix
length for a global IPv6 address as specified in the IPv6 Addressing
Architecture, see IETF RFC 4291 [32].
The SMF indicates to the UE that Stateless Autoconfiguration shall be
performed by sending Router Advertisements as described in subclause 10.2.3
and according to the principles defined in IETF RFC 4861 [33] and IETF RFC
4862 [34].
For UE supporting IPv6, IPv6 Stateless Address Autoconfiguration is mandatory.
In this case, the SMF provides the UE with an IPv6 Prefix belonging to the
Intranet/ISP addressing space. A dynamic IPv6 address is given using stateless
address autoconfiguration. This IPv6 address is used for packet forwarding
within the UPF and for packet forwarding on the Intranet/ISP.
When an SMF receives an initial access request (i.e.
Nsmf_PDUSession_CreateSMContext) message, the SMF deduces from local
configuration data associated with the DNN:
\- The source of IPv6 Prefixes (SMF internal prefix pool, or external address
allocation server);
\- Any server(s) to be used for address allocation, authentication and/or
protocol configuration options retrieval (e.g. IMS related configuration, see
3GPP TS 24.229 [13]);
\- The protocol, i.e. RADIUS, Diameter or DHCPv6, to be used with the
server(s);
\- The communication and security feature needed to communicate with the
server(s).
As an example, the SMF may use one of the following options:
\- SMF internal Prefix pool for IPv6 prefixes allocation and no
authentication;
\- SMF internal Prefix pool for IPv6 prefixes allocation and RADIUS for
authentication. The RADIUS DN-AAA server responds with either an Access-Accept
or an Access-Reject to the RADIUS client in the SMF;
\- RADIUS for authentication and IPv6 prefix allocation. The RADIUS DN-AAA
server responds with either an Accessâ€‘Accept or an Access-Reject to the RADIUS
client in the SMF.
The SMF includes the IPv6 address composed of a Prefix and an Interface-
Identifier in the initial access response
(Namf_Communication_N1N2MessageTransfer). The Interface-Identifier may have
any value and it does not need to be unique within or across DNNs. It shall
however not conflict with the Interface-Identifier that the SMF has selected
for its own side of the UE-SMF link. The Prefix assigned by the SMF or the
external DN-AAA server shall be globally or site-local unique (see the Note in
subclause 11.3 of this document regarding the usage of site-local addresses).
Table 8.2.2.3-1 summarizes the IPv6 prefix allocation and parameter
configuration use cases between the UE and the SMF that may lead the SMF to
interwork with the external RADIUS DN-AAA, Diameter DN-AAA and DHCPv6 servers.
For detailed description of the signalling flows between the UE and the SMF,
see the references in the table.
Table 8.2.2.3-1: IPv6 prefix allocation and parameter configuration use cases
+----------------+----------------+----------------+----------------+ | Signalling use | Signalling use | | | | cases between | cases between | | | | UE and SMF | SMF and | | | | | external | | | | | servers | | | +----------------+----------------+----------------+----------------+ | | Authentication | IPv6 prefix | IPv6 parameter | | | via RADIUS or | allocation via | configuration | | | Diameter | DHCPv6 or | via DHCPv6 or | | | DN-AAA server | RADIUS or | RADIUS or | | | (clauses 11 or | Diameter | Diameter | | | 12) | DN-AAA server | DN-AAA server\ | | | | (clauses 10, | (clauses 10, | | | (NOTE 1 NOTE 2 | 11 or 12) | 11 or 12) | | | and NOTE 3) | | | | | | (NOTE 1 and | (NOTE 1 and | | | | NOTE 2) | NOTE 2) | +----------------+----------------+----------------+----------------+ | (1) IPv6 | X | X | X | | address | | | | | allocation and | | | | | parameter | | | | | configuration | | | | | | | | | | (2) IPv6 | | | | | parameter | | | | | configuration | | | | | via stateless | | | | | DHCPv6 | | | | +----------------+----------------+----------------+----------------+ | (3) IPv6 | X | X | X | | address | | | | | allocation and | | | | | parameter | | | | | configuration | | | | | in untrusted | | | | | non-3GPP IP | | | | | access | | | | +----------------+----------------+----------------+----------------+ | NOTE 1: When | | | | | the SMF | | | | | interworks | | | | | with DN-AAA | | | | | servers, the | | | | | DNN may be | | | | | configured to | | | | | interwork with | | | | | either | | | | | Diameter | | | | | DN-AAA or | | | | | RADIUS DN-AAA | | | | | server. | | | | | | | | | | NOTE 2: If | | | | | RADIUS DN-AAA | | | | | or Diameter | | | | | DN-AAA server | | | | | is used, the | | | | | a | | | | | uthentication, | | | | | IPv6 prefix | | | | | allocation and | | | | | parameter | | | | | configuration | | | | | signalling may | | | | | be combined. | | | | | Similarly, if | | | | | DHCPv6 server | | | | | is used for | | | | | IPv6 prefix | | | | | allocation and | | | | | parameter | | | | | configuration, | | | | | the signalling | | | | | towards the | | | | | DHCPv6 server | | | | | may be | | | | | combined. | | | | | | | | | | NOTE 3: The N1 | | | | | mode UE can | | | | | provide | | | | | PAP/CHAP user | | | | | credentials in | | | | | the ePCO IE | | | | | when accessing | | | | | to 5GS on 3GPP | | | | | and non-3GPP | | | | | IP accesses. | | | | | If such | | | | | information is | | | | | provided to | | | | | the SMF, the | | | | | SMF can | | | | | perform user | | | | | authentication | | | | | with the | | | | | DN-AAA server | | | | | based on these | | | | | credentials, | | | | | How to perform | | | | | authentication | | | | | by the SMF and | | | | | the DN-AAA | | | | | server is not | | | | | specified in | | | | | this release. | | | | +----------------+----------------+----------------+----------------+
NOTE: External network operators intending to use PAP/CHAP without proper
underlying protection for authentication are warned about the respective
vulnerabilities of PAP and CHAP protocols from a security point of view. It's
up to the external network operator to perform the risk assessment if PAP/CHAP
is used for authentication.
For IPv6 the PDU session establishment phase is followed by an address
autoconfiguration phase. IPv6 prefix is delivered to UE in Router
Advertisement message from the SMF which acts as an access router, in the
process of IPv6 Stateless Address Autoconfiguration as described in subclause
10.2.2. Besides DHCPv6 protocol, the SMF may also use RADIUS or Diameter
protocol for the retrieval of an IPv6 prefix from external DN.
# 9 Interworking with DN (Unstructured)
## 9.1 General
When support of unstructured PDU type data is provided at the N6 interface,
different Point-to-Point (PtP) tunneling techniques may be used. When using
PtP tunneling by UDP/IPv6 encapsulation subclause 9.2 below shall be followed.
Other techniques as described in subclause 9.3 below may be used.
In the following subclauses, the AS is used as an example for the destination
in the external DN.
## 9.2 N6 PtP tunnelling based on UDP/IP
N6 PtP tunnelling based on UDP/IPv6 may be used to deliver unstructured PDU
type data to the AS.
The PtP tunnel is set up by configuration of tunnel parameters in both end of
the tunnel. The following parameters are pre-configured in the UPF per DNN:
\- the UDP destination port number to use when sending unstructured PDU type
data;
\- the UDP port number it wants to receive unstructured PDU type data;
\- the destination IP address to be used for sending unstructured PDU type
data.
The following is pre-configured in the AS:
\- the UDP destination port number to use when sending unstructured PDU type
data;
\- the UDP port number it wants to receive unstructured PDU type data.
NOTE 1: The UPF as well as the AS can use any UDP port numbers not assigned by
IANA. The port numbers used need to be aligned between peers.
IP address allocation procedures for the UE (i.e. PDU session) are performed
by the SMF as described in subclause 6.3.2, but the IPv6 prefix is not
provided to the UE, i.e. Router Advertisements and DHCPv6 are not performed.
The SMF assigns a suffix (i.e. IPv6 Interface Identifier) for the PDU session.
For the N6 PtP tunnel, the IPv6 prefix allocated for the PDU session plus
suffix assigned for the PtP tunnel is used as source address for the uplink
data and as destination address for the downlink data.
During the PDU session establishment, the UPF associates the GTP-U tunnel for
the PDU session with the N6 PtP tunnel.
The UPF acts as a transparent forwarding node between the UE and the AS.
For uplink delivery, if the uplink data is received from the GTP-U tunnel, the
UPF shall forward the received data to the AS over the N6 PtP tunnel
associated with the GTP-U tunnel with the destination address of the AS and
the configured UDP destination port number for unstructured PDU type data.
For downlink delivery, the AS shall send the data using UDP/IP encapsulation
with the IPv6 prefix plus suffix as destination address and the configured UDP
destination port number for unstructured PDU type data.
NOTE 2: The UPF decapsulates the received data (i.e. removes the UDP/IPv6
headers) and forwards the data on the GTP-U tunnel identified by the IPv6
prefix of the UE (i.e. PDU session) for delivery to the UE.
Figure 9.2-1: Protocol configuration for unstructured PDU type data (user
plane) using N6 UDP/IPv6 PtP tunneling
## 9.3 Other N6 tunnelling mechanism
N6 PtP tunnelling mechanisms such as PMIPv6/GRE, L2TP, etc, may be used to
deliver unstructured PDU type data to AS. The general handling of such
delivery mechanisms is as described below.
A PtP tunnel is established by the UPF towards the AS. Depending on the type
of protocol employed on the N6 PtP tunnel, the N6 PtP tunnel setup may be done
at the time of PDU Session establishment or at the time of first MO datagram
being sent by the UE. The UPF selects the AS based on its configuration (e.g.
per DNN, or per PtP tunnel type, etc). However, IP address allocation
procedures for the UE (according to subclause 6.3.2) are not performed by the
SMF.
NOTE: An AS can be dedicated for handling a specific protocol for unstructured
PDU type data.
The UPF acts as a transparent forwarding node between the UE and the AS.
For uplink delivery, the UPF forwards the received data to the AS over the
established N6 PtP tunnel.
For downlink delivery, the AS locates the right N6 PtP tunnel for the UE
(using information such as UE identifiers in the unstructured PDU type
protocol itself, etc) to forward the data. The AS sends the data to UPF over
the established N6 PtP tunnel. The UPF in turn sends the data on the GTP-U
tunnel identified by the associated N6 PtP tunnel for delivery to the UE.
# 10 Interworking with DN (DHCP)
## 10.1 General
In current LAN environments the most commonly used configuration protocol is
DHCP (Dynamic Host Configuration Protocol, RFC 2131 [18]) and DHCPv6 (Dynamic
Host Configuration Protocol for IPv6, IETF RFC 3315 [21]). It provides a
mechanism for passing a large set of configuration parameters to hosts
connected to a TCP/IP network (IP address, sub-net mask, domain name, MTU,
etc.) in an automatic manner. Moreover, DHCP may assign IP addresses to
clients for a finite lease time, allowing for sequential reassignment of
addresses to different users.
The lease time is chosen by the administrator of the DHCP server (in the
external network), and is therefore out of the scope of the present document.
The 3GPP network may obtain IP address via external DHCP server during the PDU
establishment procedure, the SMF acts a DHCP server towards the UE and it acts
as a DHCP client towards the external DHCP server.
In the following cases the PDU session associated with the allocated IPv4
address or IPv6 prefix shall be released:
\- if the DHCP lease expires;
\- if the DHCP renewal is rejected by the DHCP server;
\- if the IP address is changed during the renewal process. Usually when the
lease is renewed, the IP address remains unchanged. However, if for any reason
(e.g. poor configuration of the DHCP server), a different IP address is
allocated during the lease renewal process the associated PDU session shall be
released.
## 10.2 DN interworking Model of SMF for DHCP
### 10.2.1 Introduction
A DHCP client shall be located in the SMF used for interworking with the IP
network as illustrated in figure 10.2.1-1.
Figure 10.2.1-1: The protocol stacks for the N6 reference point for DHCP
The DHCP client function in the SMF shall be used to allocate IPv4 address or
IPv6 prefix to the UE and/or to configure associated parameters via external
DHCP servers. The SMF shall have both DHCPv4 and DHCPv6 client functions.
The procedures where the DHCP client function in the SMF is used are further
described in 3GPP TS 23.501 [2]. The procedures are IPv4 address allocation
and IPv4 parameter configuration via an external DHCPv4 server; IPv6 Prefix
allocation via stateless address autoconfiguration; and IPv6 parameter
configuration via stateless DHCPv6. These procedures are detailed in the
subclauses below.
### 10.2.2 IPv4 Address allocation and IPv4 parameter configuration via DHCPv4
The UE may obtain the IPv4 address and/or its configuration parameters at or
after the initial access signalling (i.e. Nsmf_PDUSession_CreateSMContext) to
the 3GPP network. The request for IPv4 address and/or configuration parameters
from the UE may trigger the SMF acting as a DHCPv4 client to request the IPv4
address and/or configuration parameters from an external DHCPv4 server and
deliver them to the UE. The DHCPv4 functions in the SMF, the UE and the
external DHCPv4 server shall be compliant to IETF RFC 2131 [18], IETF RFC 1542
[19] and IETF RFC 4039 [20].
The following system procedure describes the successful IPv4 address
allocation and parameter configuration signalling flow between the SMF and the
external DHCPv4 server as depicted in figure 10.2.2-1. For a detailed
description of the DHCPv4 messages, refer to IETF RFC 2131 [18], IETF RFC 1542
[19] and IETF RFC 4039 [20].
1) The DHCPv4 client function in the SMF sends a DHCPDISCOVER as an IP limited
broadcast message, i.e. the destination address 255.255.255.255, towards the
external DN. If the SMF has the DHCPv4 server IP addresses configured for the
DNN, the DHCPDISCOVER shall be send as unicast (or even multicast) to the
external DHCPv4 servers.
2) Upon receiving the DHCPDISCOVER request message, the external DHCPv4
servers reply by sending a DHCPOFFER message including an offered IP address.
Several DHCPOFFER messages may be received by the SMF if multiple DHCPv4
servers respond to the DHCPDISCOVER.
3) The DHCPv4 client function in the SMF processes the messages and sends a
DHCPREQUEST towards the selected external DHCPv4 server.
NOTE: If the optimized signalling (Rapid Commit Option) is used as per IETF
RFC 4039 [20], the messages 2-3 can be eliminated.
4) Upon receiving the DHCPREQUEST message, the selected external DHCPv4 server
acknowledges the address allocation by sending a DHCPACK containing the lease
period (T1), the time-out time (T2) and the configuration information
requested in DHCPREQUEST. The SMF stores the allocated IPv4 address, the lease
timers and the configuration parameters. The SMF shall further deliver the
IPv4 address and the configuration parameters to the UE by SM NAS message.
Figure 10.2.2-1: The signalling flow for IPv4 address allocation and parameter
configuration using DHCPv4
Figure 10.2.2-2 is a signalling flow for IPv4 address lease renew by using
DHCPv4 protocol as specified in IETF RFC 2131 [18].
1) The DHCPv4 client function in the SMF sends a unicast DHCPREQUEST towards
the external DHCPv4 server to extend the lease period of the allocated IPv4
address.
2) The external DHCPv4 server replies with a DHCPACK message confirming the
renewed lease and the T1 and T2 timers are restarted.
Figure 10.2.2-2: The signalling flow for IPv4 address lease renew using DHCPv4
### 10.2.3 IPv6 Prefix allocation via IPv6 stateless address autoconfiguration
via DHCPv6
When the IPv6 prefix is allocated from the external DN, the SMF is responsible
to obtain the IPv6 prefix for external DN, allocate and release the IPv6
prefix. The SMF may use DHCPv6 to obtain the IPv6 prefix from the external DN.
In this context, the SMF shall act as a DHCP client as per IETF RFC 3315 [21]
towards the external DHCPv6 server.
The SMF may allocate a second IPv6 prefix for routing traffic via a second UPF
to enable simultaneous access via remote and local networks or to enable SSC
mode 3 (i.e. make-before-break) mobility, as described in subclause 4.3.5.3 of
3GPP TS 23.502 [3].
The following system procedure describes the signalling flows for the IPv6
Stateless Address Autoconfiguration procedures for 5G system. The procedures
are based on the descriptions in 3GPP TS 23.501 [2] and 3GPP TS 23.502 [3].
1\. UE initiates the PDU Session Establishment procedure, indicating IPv6
address is required.
2\. The AMF sends PDU Session Establishment Request in
Nsmf_PDUSession_CreateSMContext to the SMF.
3\. The SMF may retrieve IPv6 prefix using DHCPv6 mechanism. This procedure is
performed when an external DN allocates an IPv6 prefix, the signaling between
the SMF and external DN is exchanged via UPF which is omitted in the figure
10.2.3-1.
4\. The SMF sends PDU Session Establishment Accept included in
Namf_Communication_N1N2MessageTransfer to the AMF. It includes the IPv6
prefix.
5\. The AMF sends PDU Session Establishment Accept message to the UE without
the IPv6 prefix. The UE shall ignore the IPv6 prefix if it receives it in the
message.
6\. The UE may send a Router Solicitation to the SMF via the UPF to solicit a
Router Advertisement message.
7\. The SMF sends a Router Advertisement message to the UE via the UPF,
solicited or unsolicited. It shall include an IPv6 prefix in Prefix
Information option field of the message. The prefix is the same as the one in
the PDU Session Establishment Accept message, if it is provided during the
previous PDU Session Establishment procedure.
8\. At any time after PDU session establishment, the SMF may trigger the
establishment on an alternative route via UPF2 for access to a local data
network or for SSC mode 3 mobility.
9\. Like step 3, the SMF may retrieve a second IPv6 prefix using DHCPv6
mechanism.
10\. The SMF sends a Router Advertisement to the UE via UPF2 to update the UE.
Note that this will occur without a Router Solicitation since the UE is
unaware of the network's decision to form an alternative Route.
11\. Specific to the case of SSC mode 3 mobility, the SMF sends a Router
Advertisement to the UE via UPF1 with zero value in the preferred lifetime
field and a value in the valid lifetime field according to IETF RFC 4862 [34].
The UE shall update the valid lifetime of the old IPv6 prefix to the signalled
value, regardless of the remaining lifetime. The signalled lifetime value
indicates how long the SMF is willing to keep the old IPv6 prefix.
NOTE: Alternative routes can be established repeatedly through additional UPFs
and old routes can be terminated when required by the SMF. More complex
scenarios are not described here for the sake of simplicity.
Figure 10.2.3-1: IPv6 Stateless Address Autoconfiguration
### 10.2.4 IPv6 parameter configuration via stateless DHCPv6
A UE that has obtained an IPv6 address may use stateless DHCP to request other
configuration information such as a list of DNS recursive name servers or SIP
servers.
For 3GPP networks, when an external DHCPv6 server in a DN is used to obtain
the requested parameters, the SMF acts as a DHCPv6 client towards the external
DHCPv6 server while acting a DHCPv6 server towards the UE.
The IPv6 parameter configuration via stateless DHCPv6 function in the UE, the
SMF and the external DHCPv6 Server shall be compliant to IETF RFC 3736 [22].
The following system procedure describes the signalling flows for the IPv6
parameter configuration via stateless DHCPv6 procedures for 5G system. All
messages in the following steps between the UE and the SMF are sent via the
UPF.
1) A Router Advertisement with the O-flag set, is sent from SMF to UE to
indicate to it to retrieve other configuration information.
2) The UE sends an INFORMATION-REQUEST message with the IP destination address
set to the All_DHCP_Relay_Agents_and_Servers multicast address defined in the
DHCPv6 IETF RFC 3315 [21]. The source address shall be the link-local address
of the UE. The DHCP relay agent in the SMF shall forward the message.
3) DHCP servers receiving the forwarded INFORMATION-REQUEST message, reply by
sending a RELAYâ€‘REPLY message, with the \"Relay Message\" option including a
REPLY message with the requested configuration parameters.
The UE chooses one of the possibly several REPLY messages and extracts the
configuration information.
{width="6.173611111111111in" height="2.0194444444444444in"}
Figure 10.2.4-1: DHCPv6 Other configuration signal flow
# 11 Interworking with DN (RADIUS)
## 11.1 RADIUS procedures
### 11.1.1 RADIUS Authentication and Authorization
The SMF also represents the H-SMF in the home routed scenario in this
subclause unless specified otherwise.
RADIUS Authentication and Authorization shall be used according to IETF RFC
2865 [8], IETF RFC 3162 [9] and IETF RFC 4818 [10]. In 5G, multiple
authentication methods using Extensible Authentication Protocol (EAP) may be
used such as EAP-TLS (see IETF RFC 5216 [11]), EAP-TTLS (see IETF RFC 5281
[37]). The SMF shall implement the RADIUS extension to support EAP as
specified in IETF RFC 3579 [7].
The RADIUS client function may reside in an SMF. When the SMF receives an
initial access request (i.e. the SMF receives the
Nsmf_PDUSession_CreateSMContext request with type \"Initial request\" for non-
roaming case or local breakout case, or the H-SMF receives the
Nsmf_PDUSession_Create Request with type \"Initial request\" for home routed
case), the RADIUS client function may send the authentication information to a
DN-AAA server, which is identified during the DNN provisioning.
The DN-AAA server performs authentication and authorization. The response
(when positive) may contain network information, such as an IPv4 address
and/or IPv6 prefix for the user when the SMF is interworking with the DN-AAA
server.
The information delivered during the RADIUS authentication can be used to
automatically correlate the user identity (e.g. SUPI) to the IPv4 address
and/or IPv6 prefix, if applicable, assigned/confirmed by the SMF or the DN-AAA
server respectively. The same procedure applies, in case of sending the
authentication to a \'proxy\' DN-AAA server.
For 5G, RADIUS Authentication is applicable to the initial access request.
When the SMF receives an Access-Accept message from the DN-AAA server it shall
complete the initial access procedure. If Access-Reject or no response is
received, the SMF shall reject the initial access procedure with a suitable
cause code.
When DN-AAA server authorizes the PDU Session Establishment, it may send DN
authorization data for the established PDU Session to the SMF. The DN
authorization data for the established PDU Session may include one or more of
the following:
\- a reference to authorization data for policy and charging control locally
configured in the SMF or PCF;
\- a list of allowed MAC addresses (maximum 16) for the Ethernet PDU Session;
and
\- Session-AMBR for the PDU Session.
SMF policies may require DN authorization without DN authentication. In that
case, when contacting the DN-AAA server for authorization, the SMF shall
provide the GPSI of the UE if available.
The SMF may also use the RADIUS re-authorization procedure for the purpose of
IPv4 address and/or IPv6 prefix allocation to the UE. The use cases that may
lead this procedure are:
\- IPv4 address and/or IPv6 prefix allocation after UPF selection during PDU
session establishment procedure.
\- IPv6 prefix allocation during adding additional PDU Session Anchor
procedure for IPv6 multi-homing.
\- IPv4 address allocation via DHCPv4 procedure after successful PDU session
establishment procedure.
When an IPv4 address and/or IPv6 prefix (including any additional IPv6 prefix
of IPv6 multi-homing) is (re-)allocated or de-allocated (not causing the PDU
session to be released) by using a method not via the DN-AAA server and if the
SMF was required by the DN-AAA server to report such change during
authentication procedure or by local configuration, the SMF shall, if
applicable, use the authentication session that was established before to
inform the DN-AAA server by sending RADIUS Access-Request with the latest list
of IPv4 address and/or IPv6 prefix(es).
When the SMF is notified by the UPF regarding the UE MAC address change (a new
one is detected or a used one is inactive), if the SMF was required by the DN-
AAA server to report such change during authentication procedure or by local
configuration, the SMF shall, if applicable, use the authentication session
that was established before to inform the DN-AAA server by sending RADIUS
Access-Request with the latest list of UE MAC addresses in use.
### 11.1.2 RADIUS Accounting
RADIUS Accounting shall be used according to IETF RFC 2866 [26], IETF RFC 3162
[9] and IETF RFC 4818 [10].
The RADIUS accounting client function may reside in an SMF. The RADIUS
accounting client may send information to a DN-AAA server, which is identified
during the DNN provisioning. The DN-AAA server may store this information and
use it to automatically identify the user. This information can be trusted
because the 3GPP network has authenticated the subscriber (i.e. USIM card and
possibly other authentication methods).
The SMF may use the RADIUS Accounting-Request Start and Stop messages during
QoS flow (e.g. QoS flow associated with the default QoS rule) establishment
and termination procedures, respectively.
The use of Accounting-Request STOP and in addition the Accounting ON and
Accounting OFF messages may be used to ensure that information stored in the
DN-AAA server is synchronised with the SMF information.
If the DN-AAA server is used for IPv4 address and/or IPv6 prefix assignment,
then, upon reception of a RADIUS Accounting-Request STOP message for all QoS
flows associated to a PDU session defined by DNN and SUPI or GPSI, the DN-AAA
server may make the associated IPv4 address and/or IPv6 prefix available for
assignment.
When an IPv4 address and/or IPv6 prefix (including any additional IPv6 prefix
of IPv6 multi-homing) is (re-)allocated or de-allocated (not causing the PDU
session to be released) by using a method not via the DN-AAA server and if the
SMF was required by the DN-AAA server to report such change during
authentication procedure or by local configuration, the SMF shall, if
applicable, use the accounting session that was established before to inform
the DN-AAA server by sending RADIUS Accounting-Request Interim-Update with the
latest list of IPv4 address and/or IPv6 prefix(es).
When the SMF is notified by the UPF regarding the UE MAC address change (a new
one is detected or a used one is inactive), if the SMF was required by the DN-
AAA server to report such change during authentication procedure or by local
configuration, the SMF shall, if applicable, use the accounting session that
was established before to inform the DN-AAA server by sending RADIUS
Accounting-Request Interim-Update with the latest list of UE MAC addresses in
use.
In order to avoid race conditions, the SMF shall include a 3GPP Vendor-
Specific sub-attribute \"Session Stop indicator\" when it sends the
Accounting-Request STOP for the last QoS flow of a PDU session and the PDU
session is terminated (i.e. the IPv4 address and/or IPv6 prefix and any
associated GTP tunnel can be released). The DN-AAA server shall not assume the
PDU session terminated until an Accounting-Request STOP with the Session Stop
indicator is received.
## 11.2 Message flows on N6 interface
### 11.2.1 Authentication, Authorization and Accounting procedures
The SMF also represents the H-SMF in the home routed scenario in this
subclause unless specified otherwise.
When an SMF receives an initial access request (i.e. the SMF receives the
Nsmf_PDUSession_CreateSMContext request with type \"Initial request\" for non-
roaming case or local breakout case, or the H-SMF receives the
Nsmf_PDUSession_Create Request with type \"Initial request\" for home routed
case) message for a given DNN, the SMF may (depending on the configuration for
this DNN) send a RADIUS Access-Request message with EAP extension to an DN-AAA
server. Upon receipt of the Access-Request message, the DN-AAA server shall
respond with an Access-Challenge message. Multi-round authentication using the
Access-Challenge (sent by DN-AAA) and Access-Request messages may be used. The
DN-AAA server finally authenticates and authorizes the user by replying with
an Access Accept message. If the DN-AAA server is also responsible for IPv4
address and/or IPv6 prefix allocation, the DN-AAA server shall return the
allocated IPv4 address and/or IPv6 prefix in the Access-Accept message.
For re-authentication and re-authorization, the SMF shall send a RADIUS
Access-Request message with EAP extension and the DN-AAA shall respond with an
Access-Challenge message. Multi-round authentication using the Access-
Challenge (sent by DN-AAA) and Access-Request messages may be used. The DN-AAA
server finally authenticates and authorizes the user by replying with an
Access Accept message.
The SMF may initiate RADIUS re-authorization procedures for the purpose of
IPv4 address and/or IPv6 prefix allocation (or renew the lease). In this case,
the SMF shall set the Service-Type attribute to \"Authorize Only\" and the
3GPP-Allocate-IP-Type subattribute to the type of IP address to be allocated
in the Access-Request message sent to the DN-AAA server. If the SMF is using
DHCP signalling towards the UE and the DN-AAA server includes the Session-
Timeout attribute in the Access-Accept, the SMF may use the Session-Timeout
value as the DHCP lease time. The SMF shall not set the DHCP lease time value
higher than the Session-Timeout value. The SMF may renew the DHCP lease to the
UE without re-authorization towards the DN-AAA server providing that the new
lease expiry is no later than the Session-Timeout timer expiry. If the SMF
wishes to extend the lease time beyond the current Session-Timeout expiry, it
shall initiate a new AAA re-authorization.
Even if the SMF was not involved in user authentication, it may send a RADIUS
Accounting-Request (START) message to a DN-AAA server. This message may
contain parameters, e.g. the tuple which includes the user ID and IPv4 address
and/or IPv6 prefix, to be used by application servers (e.g. WAP gateway) in
order to identify the user. This message also indicates to the AAA server that
the user session has started. The user session is uniquely identified by the
Acct-Session-Id that is composed of the Charging ID and the SMF IP address.
NOTE: If the accounting session is required by the DN-AAA server to be created
per QoS flow, how to identify the different accounting sessions is
implementation specific. The SMF can include the Acct-Session-Id which is
extended to include the QFI of the QoS flow or the Acct-Session-Id without QFI
extension and with 3GPP-NSAPI combination in the RADIUS Accounting-Request
(START).
If some external applications require RADIUS Accounting-Request (START)
information before they can process user packets, then the selected DNN (SMF)
may be configured in such a way that the UPF is instructed to drop user data
until the Accounting-Response (START) is received from the AAA server. The SMF
may wait for the Accounting-Response (START) before sending the final
authentication response message in Namf_Communication_N1N2MessageTransfer
service operation. The SMF may reject the initial access request if the
Accounting-Response (START) is not received. The authentication and accounting
servers may be separately configured for each DNN.
For IPv4 PDU type, if IPv4 address is allocated via DHCPv4 signalling between
the UE and the DN-AAA after PDU session establishment, the SMF may wait to
send the Accounting-Request (START) message until the UE receives its IPv4
address in a DHCPACK.
When the SMF receives a message indicating a QoS flow or PDU session release
request and providing a RADIUS Accounting-Request (START) message was sent
previously, the SMF shall send a RADIUS Accounting-Request (STOP) message to
the DN-AAA server, which indicates the termination of this particular QoS flow
or PDU session. The SMF shall immediately send the corresponding response
(e.g. Nsmf_PDUSession_UpdateSMContext response) to the AMF, without waiting
for an Accounting-Response (STOP) message from the DN-AAA server.
The DN-AAA server shall deallocate the IPv4 address and/or IPv6 prefix
initially allocated to the subscriber, if there is no session for the
subscriber.
Accounting-Request (ON) and Accounting-Request (OFF) messages may be sent from
the SMF to the DN-AAA server to ensure the correct synchronization of the
session information in the SMF and the DN-AAA server.
The SMF may send an Accounting-Request (ON) message to the DN-AAA server to
indicate that a restart has occurred. The DN-AAA server may then release the
associated resources.
Prior to a scheduled restart, the SMF may send Accounting-Request (OFF)
message to the DN-AAA server. The DN-AAA server may then release the
associated resources.
The following figure 11.2.1-1 is an example message flow to show the procedure
of RADIUS Authentication and Accounting between an SMF and a DN-AAA server:
1\. UE initiates the PDU Session Establishment procedure, including
authentication/authorization information.
2\. The AMF sends Nsmf_PDUSession_CreateSMContext Request including the
authentication/authorization information to the SMF and the SMF responds to
the service operation.
According to the configuration in the SMF, step 6 to step 9 are executed
before step 3 if the SMF needs to send an EAP-Request message to the UE.
In the case of home routed, the AMF sends Nsmf_PDUSession_CreateSMContext
Request including the authentication/authorization information to the V-SMF
and the V-SMF sends Nsmf_PDUSession_Create Request including the
authentication/authorization information to the H-SMF.
3\. If the N4 session has not been established before, the SMF triggers the N4
Session Establishment procedure to the UPF.
> In the case of home routed, the V-SMF triggers the N4 Session Establishment
> procedure to the V-UPF and the H-SMF triggers the N4 Session Establishment
> procedure to the H-UPF.
4\. The SMF sends the Access-Request message to the DN-AAA via the UPF, the
message is forwarded from the SMF to the DN-AAA by the UPF in N4 user plane
message.
> In the case of home routed, the H-SMF sends the Access-Request message to
> the DN-AAA via the H-UPF, the message is forwarded from the H-SMF to the DN-
> AAA by the H-UPF in N4 user plane message.
5-10. The DN-AAA responds with the Access-Challenge message to the SMF via the
UPF, the message is forwarded from the DN-AAA to the SMF by the UPF in N4 user
plane message. The authentication/authorization information is further
transferred to UE via Namf_Communication_N1N2MessageTransfer service and NAS
SM Transport message. UE responds to the received authentication/authorization
data and such information is transferred in NAS SM Transport message and
Nsmf_PDUSession_UpdateSMContext service, then finally sent to the DN-AAA by
the SMF, via the UPF, in the Access-Request message.
> In the case of home routed, the DN-AAA responds with the Access-Challenge
> message to the H-SMF via the H-UPF, the message is forwarded from the DN-AAA
> to the H-SMF by the H-UPF in N4 user plane message. The
> authentication/authorization information is transferred to V-SMF via
> Nsmf_PDUSession_Update service and is further transferred to UE via
> Namf_Communication_N1N2MessageTransfer service and NAS SM Transport message.
> UE responds to the received authentication/authorization data and such
> information is transferred in NAS SM Transport message,
> Nsmf_PDUSession_UpdateSMContext service and Nsmf_PDUSession_Update servic,
> then finally sent to the DN-AAA by the H-SMF, via the H-UPF, in the Access-
> Request message.
NOTE: Step 5 to step 10 can be repeated depending on the
authentication/authorization mechanism used (e.g. EAP-TLS).
11\. The SMF receives the final result of authentication/authorization from
the DN-AAA in the Access-Accept message, via the UPF.
12\. The SMF requests to start accounting by sending the Accounting-Request
(START) message to the DN-AAA via the UPF.
13\. The SMF proceeds with the PDU session establishment procedure and
includes the authentication/authorization information in
Namf_Communication_N1N2MessageTransfer service.
> In the case of home routed, the H-SMF proceeds with the PDU session
> establishment procedure and includes the authentication/authorization
> information is transferred to V-SMF via Nsmf_PDUSession_Update service and
> is further transferred to the AMF via Namf_Communication_N1N2MessageTransfer
> service.
14\. The DN-AAA responds with the Accounting-Response (START) message. The SMF
may wait for the Accounting-Response (START) before sending the
Namf_Communication_N1N2MessageTransfer request in step 13.
> In the case of home routed, the H-SMF may wait for the Accounting-Response
> (START) before sending the Nsmf_PDUSession_Update service in step 13.
15\. The AMF sends the NAS PDU Session Establishment Request with the
authentication/authorization information to the UE.
16\. The UE sends a NAS message Deregistration Request to the AMF.
17\. The AMF sends Nsmf_PDUSession_ReleaseSMContext Request to the SMF and the
SMF responds to the service operation.
In the case of home routed, the AMF sends Nsmf_PDUSession_ReleaseSMContext
Request to the V-SMF and the V-SMF sends the Nsmf_PDUSession_Release Request
to the H-SMF.
18-19. The SMF requests to stop accounting by sending the Accounting-Request
(STOP) message to the DN-AAA via the UPF and the DN-AAA responds with the
Accounting-Response (STOP) message.
Figure 11.2.1-1: RADIUS Authentication and Accounting example (successful
case)
### 11.2.2 Accounting Update
During the life of a QoS flow some information related to this QoS flow may
change. The SMF may send RADIUS Accounting Request Interim-Update to the DN-
AAA server upon occurrence of a chargeable event, e.g. RAT change or QoS
change. Interim updates are also used when the IPv4 address and/or IPv6 prefix
is allocated/released/re-allocated.
When the SMF receives a signalling request (i.e.
Nsmf_PDUSession_UpdateSMContext) that indicates the occurrence of one of these
chargeable events, the SMF may send an Accounting Request Interim-Update to
the DN-AAA server to update the necessary information related to this QoS
flow. It is not necessary for the SMF to wait for the RADIUS
AccountingResponse message from the DN-AAA server before sending the response
for the triggering signalling message (i.e.
Namf_Communication_N1N2MessageTransfer). The SMF may delete the QoS flow if
the AccountingResponse is not received from the DN-AAA server.
The SMF may also send interim updates at the expiry of an operator configured
time limit.
Figure 11.2.2-1 is an example message flow to show the procedure of RADIUS
accounting update, messages between the SMF and DN-AAA are forwarded by the
UPF in N4 user plane message.
Figure 11.2.2-1: RADIUS accounting update
### 11.2.3 DN-AAA initiated QoS flow termination
RADIUS is used as the protocol between the SMF and the DN-AAA server or proxy
for applications (e.g. MMS) to deliver information related to user session.
However some IP applications could need to interwork with the SMF to release
the corresponding resource (e.g. terminate a particular QoS flow). For this
purpose, the DN-AAA server or proxy may send a RADIUS Disconnect-Request to
the SMF. On receipt of the Disconnect-Request from the DN-AAA server, the SMF
shall release the corresponding resources and reply with a Disconnect-ACK. If
the SMF is unable to release the corresponding resources, it shall reply to
the DN-AAA server with a Disconnect-NAK. For more information on RADIUS
Disconnect, see IETF RFC 5176 [27]. If the SMF deletes the corresponding QoS
flow, it is not necessary for the SMF to wait for the response (i.e.
Nsmf_PDUSession_UpdateSMContext) from the AMF before sending the RADIUS
Disconnect-ACK to the DN-AAA server. The DN-AAA shall include the
identification of the QoS flow to be disconnected within the Disconnect-
Request. How to identify the QoS flow to be deleted is implementation
specific.
NOTE: The QoS flow can be identified by the Acct-Session-Id which is extended
to include QFI or by the Acct-Session-Id and 3GPP-NSAPI combination if
provided by the SMF.
The Teardown-Indicator in the RADIUS Disconnect Request message indicates to
the SMF that all QoS flows for this particular user and sharing the same user
session shall be deleted. The QoS flows that belong to the same PDU session
can be are identified by the Acct-Session-Id. The SMF is able to find out all
the related QoS flows sharing the same user session once it has found the
exact QoS flow from the Acct-Session-Id. If a user has the same user IP
address for different sets of QoS flows towards different networks, only the
QoS flows linked to the one identified by the Acct-Session-Id shall be
deleted. If the value of Teardown-Indicator is set to \"0\" or if TI is
missing, and if the Acct-Session-Id and 3GPP-NSAPI if provided identifies the
QoS flow associated with the default QoS rule, the SMF shall tear down all the
QoS flows that share the same user session identified by the Acct-Session-Id.
Figure 11.2.3-1 is an example message flow to show the procedure of DN-AAA
initiated QoS flow termination, messages between the SMF and DN-AAA are
forwarded by the UPF in N4 user plane message.
Figure 11.2.3-1: DN-AAA initiated QoS flow termination with RADIUS
### 11.2.4 DN-AAA initiated re-authorization
Some IP applications could need to interwork with the SMF to update the PDU
session authorization attributes. For this purpose, the DN-AAA server or proxy
may send a RADIUS CoA-Request to the SMF. On receipt of the CoA-Request from
the DN-AAA server, if the service-type value of \"Authorize Only\" is not
included, the SMF shall update the corresponding PDU session authorization
attributes and reply with a CoA-ACK; otherwise it shall follow the procedure
described in IETF RFC 5176 [27]. DN-AAA may also use CoA procedure to revoke
the authorization of a PDU session, or to update the authorization data (e.g.
allowed UE MAC addresses).
If the SMF updates/deletes the corresponding PDU session, it is not necessary
for the SMF to wait for Nsmf_PDUSession_UpdateSMContext from the AMF before
sending the RADIUS CoA-ACK to the DN-AAA server.
Figure 11.2.4-1 is an example message flow to show the procedure of DN-AAA
initiated re-authorization, messages between the SMF and DN-AAA are forwarded
by the UPF in N4 user plane message.
Figure 11.2.4-1: DN-AAA initiated re-authorization with RADIUS
## 11.3 List of RADIUS attributes
### 11.3.1 General
RADIUS attributes as defined in subclause 16.4 of 3GPP TS 29.061 [5] are re-
used in 5G with the following differences:
\- SMF replaces P-GW. GGSN and PPP PDP type related description are not
applicable for 5G.
\- 5G QoS flow replaces IP-CAN bearer and PDU session replaces IP-CAN session.
\- N6 replaces Gi/Sgi and UE replaces MS.
\- DNN replaces APN.
\- Detailed information needed for 5G compared to **3GPP TS 29.061 [5]** is
described below.
Table 11.3-1: Additional information needed for 5G compared to the RADIUS
attributes defined in 3GPP TS 29.061 [5]
+----------+----------+----------+---------+----------+----------+ | Attr # | A | Des | Content | Presence | Ap | | | ttribute | cription | | Req | plicable | | | Name | | | uirement | message | +----------+----------+----------+---------+----------+----------+ | 79 | EAP | This | String | Con | Access- | | | -Message | a | | ditional | Request, | | | | ttribute | | | | | | | enca | | NOTE | Access | | | | psulates | | | -Accept, | | | | EAP | | | | | | | message | | | Access | | | | (as | | | -Reject, | | | | defined | | | | | | | in | | | CoA- | | | | IETF | | | Request, | | | | RFC 374 | | | | | | | 8 [6]) | | | CoA-ACK, | | | | e | | | | | | | xchanged | | | Dis | | | | between | | | connect- | | | | the SMF | | | Request, | | | | and | | | | | | | DN-AAA, | | | Discon | | | | see | | | nect-ACK | | | | IET | | | | | | | F RFC 35 | | | | | | | 79 [7] | | | | | | | for | | | | | | | details. | | | | +----------+----------+----------+---------+----------+----------+ | | | | | M | Access-C | | | | | | andatory | hallenge | +----------+----------+----------+---------+----------+----------+ | 80 | Messa | This | String | Con | Access- | | | ge-Authe | a | | ditional | Request, | | | nticator | ttribute | | | | | | | includes | | NOTE | Access | | | | the | | | -Accept, | | | | message | | | | | | | authen | | | Access | | | | ticator, | | | -Reject, | | | | see | | | | | | | IET | | | CoA- | | | | F RFC 35 | | | Request, | | | | 79 [7] | | | | | | | for | | | CoA-ACK, | | | | details. | | | | | | | | | | CoA-NAK | | | | | | | | | | | | | | Dis | | | | | | | connect- | | | | | | | Request, | | | | | | | | | | | | | | Disconn | | | | | | | ect-ACK, | | | | | | | | | | | | | | Discon | | | | | | | nect-NAK | +----------+----------+----------+---------+----------+----------+ | | | | | M | Access-C | | | | | | andatory | hallenge | +----------+----------+----------+---------+----------+----------+ | NOTE: | | | | | | | Shall be | | | | | | | present | | | | | | | if EAP | | | | | | | is used. | | | | | | +----------+----------+----------+---------+----------+----------+
Table 11.3-2: Different information needed for 5G compared to the RADIUS VSA
defined in subclause 16.4.7 of 3GPP TS 29.061 [5]
* * *
Sub-attr # Sub-attribute Name Differences 1 3GPP-IMSI Re-used. 2 3GPP-
Charging-Id Charging ID for this PDU Session. 3 3GPP-PDP-Type Re-used. For
SMF, this sub-attribute represents PDU session type and only the values \"0\",
\"2\", \"3\", \"5\" and \"6\" are applicable. 4 3GPP-CG-Address Re-used. 5
3GPP-GPRS-Negotiated-QoS-Profile Re-used. For SMF, it uses the format for
Release indicator value \"15\" as defined in 3GPP TS 29.061 [5]. 6 3GPP-SGSN-
Address Re-used. It includes AMF or V-SMF IPv4 address. 7 3GPP-GGSN-Address
Re-used. It includes (home) SMF control plane IPv4 address. 8 3GPP-IMSI-MCC-
MNC Re-used. 9 3GPP-GGSN-MCC-MNC Re-used. MCC and MNC of the network the
(home) SMF belongs to. 10 3GPP-NSAPI Re-used. It identifies QFI with value
range 0-255. 11 3GPP-Session-Stop-Indicator Re-used. 12 3GPP-Selection-Mode
Re-used. SMF maps the selection mode value from the enumeration value of
DnnSelectionMode in 3GPP TS 29.502 [40]. 13 3GPP-Charging-Characteristics Re-
used. 14 3GPP-CG-Ipv6-Address Re-used. 15 3GPP-SGSN-Ipv6-Address Re-used. It
includes AMF or V-SMF IPv6 address. 16 3GPP-GGSN-Ipv6-Address Re-used. It
includes (home) SMF control plane IPv6 address. 17 3GPP-Ipv6-DNS-Servers Re-
used. 18 3GPP-SGSN-MCC-MNC Re-used. MCC and MNC of the network the AMF belongs
to 19 3GPP-Teardown-Indicator Re-used. 20 3GPP-IMEISV Re-used. 21 3GPP-RAT-
Type Re-used. For SMF, it uses the sub-attribute definition for P-GW and only
the values \"3\", \"7\" and \"51\" are applicable. 22 3GPP-User-Location-Info
Re-used. For SMF, only the values \"128\", \"129\", \"130\", \"135\" and
\"136\" of Geographic Location Type are applicable. 23 3GPP-MS-TimeZone Re-
used. 24 3GPP-CAMEL-Charging-Info Not applicable. 25 3GPP-Packet-Filter Re-
used. 26 3GPP-Negotiated-DSCP Re-used. 27 3GPP-Allocate-IP-Type Re-used. 28
External-Identifier Re-used. 29 TWAN-Identifier Not applicable. 30 3GPP-User-
Location-Info-Time Re-used. 31 3GPP-Secondary-RAT-Usage Not applicable. 110
3GPP-Notification Added. 111 3GPP-UE-MAC-Address Added. 112 3GPP-
Authorization-Reference Added. 113 3GPP-Policy-Reference Added. It is not used
in this release. 114 3GPP-Session-AMBR Added. 115 3GPP-NAI Added. 116 3GPP-
Session-AMBR-v2 Added. 117 3GPP-Supported-Features Added. NOTE: 5G specific
RADIUS VSAs are numbered from 110.
* * *
**_110 -- 3GPP_** -**_Notification_**
* * *
                                Bits
Octets 8 7 6 5 4 3 2 1 1 3GPP type = 110  
2 3GPP Length= 3  
3 Spare ACC AUTH
* * *
3GPP Type: 110
Length: 3
Octet 3 is Octet String type.
For bit 1 AUTH,
\- if the value of AUTH is set to \"1\", and there is IPv4 address and/or IPv6
prefix change (not allocated/de-allocated by the DN-AAA itself) and the PDU
session is not terminated, the SMF shall send Access-Request message to the
DN-AAA with GPSI in Calling-Station-Id or External-Identifier attribute and IP
address in:
1) Framed-IP-Address and Framed-Ipv6-Prefix, if both IPv4 address and IPv6
prefix(es) exist for the PDU session; or
2) Framed-IP-Address, if only IPv4 address exists for the PDU session; or
3) Framed-Ipv6-Prefix, if only IPv6 prefix(es) exists for the PDU session.
> For Ethernet PDU session, if there is UE MAC address change, the SMF shall
> send Access-Request message to the DN-AAA with GPSI in Calling-Station-Id or
> External-Identifier attribute and the complete list of used UE MAC addresses
> in the 3GPP-UE-MAC-Address attribute.
\- if the value is set to \"0\", the SMF may notify authentication DN-AAA with
the UE address and GPSI based on local configuration.
For bit 2 ACC,
\- if the value is set to \"1\", and there is IPv4 address and/or IPv6 prefix
change (not allocated/de-allocated by the DN-AAA itself) and the PDU session
is not terminated, the SMF shall send Accounting-Request Interim-Update
message to the DN-AAA with GPSI in Calling-Station-Id or External-Identifier
attribute and IP address in:
1) Framed-IP-Address and Framed-Ipv6-Prefix, if both IPv4 address and IPv6
prefix(es) exist for the PDU session; or
2) Framed-IP-Address, if only IPv4 address exists for the PDU session; or
3) Framed-Ipv6-Prefix, if only IPv6 prefix(es) exists for the PDU session.
> For Ethernet PDU session, if there is UE MAC address change, the SMF shall
> send Accounting-Request Interim-Update message to the DN-AAA with GPSI in
> Calling-Station-Id or External-Identifier attribute and the complete list of
> used UE MAC addresses in the 3GPP-UE-MAC-Address attribute.
\- if the value is set to \"0\", the SMF may notify accounting DN-AAA with the
UE address and GPSI based on local configuration.
**_111 -- 3GPP-UE-MAC-Address_**
* * *
              Bits
Octets 8 7 6 5 4 3 2 1 1 3GPP type = 111  
2 3GPP Length= 8  
3-8 MAC Address (octet string)
* * *
3GPP Type: 111
Length: 8
It is sent from the DN-AAA to authorize UE MAC addresses. Multiple 3GPP-MAC-
Address sub-attributes (maximum 16) may be sent in one RADIUS CoA or Access-
Accept message. The DN-AAA shall always provide the full list of allowed MAC
addresses, and SMF shall replace the existing list with the newly received
one. When omitted, there is no restriction and all UE MAC addresses are
permitted for the Ethernet PDU session.
When sending from the SMF to the DN-AAA, it indicates UE MAC addresses in use.
Multiple 3GPP-MAC-Address sub-attributes may be sent in one RADIUS Access-
Request or Accounting-Request Interim-Update message.
MAC address is Octet String type. The encoding is defined as MacAddr48 in 3GPP
TS 29.571 [39] without dashes as delimiter, encoded as 12-digit hexadecimal
numbers.
**_112 -- 3GPP-Authorization-Reference_**
* * *
              Bits
Octets 8 7 6 5 4 3 2 1 1 3GPP type = 112  
2 3GPP Length= m  
3-m Authorization Data Reference (octet string)
* * *
3GPP Type: 112
Length: m
Authorization Data Reference: Octet String. It is sent from the DN-AAA to
refer to the local authorization data in the SMF or PCF.
**_113 -- 3GPP-Policy-Reference_**
* * *
              Bits
Octets 8 7 6 5 4 3 2 1 1 3GPP type = 113  
2 3GPP Length= m  
3-m Policy Data Reference (octet string)
* * *
3GPP Type: 113
Length: m
Policy Data Reference: Octet String. It is sent from the DN-AAA and used by
the SMF to retrieve the SM or QoS policy data from the PCF. It is not used in
this release.
**_114 -- 3GPP-Session-AMBR_**
* * *
              Bits
Octets 8 7 6 5 4 3 2 1 1 3GPP type = 114  
2 3GPP Length= m  
3-m Session AMBR (octet string)
* * *
3GPP Type: 114
Length: m
Session AMBR: Octet String. It is sent from the DN-AAA to authorize the PDU
Session AMBR in the downlink and uplink direction. The encoding is defined as
BitRate in 3GPP TS 29.571 [39]. Same value is applied to downlink and uplink
via this VSA.
**_115 -- 3GPP-NAI_**
* * *
              Bits
Octets 8 7 6 5 4 3 2 1 1 3GPP type = 115  
2 3GPP Length= m  
3-m NAI (octet string)
* * *
3GPP Type: 115
Length: m
NAI: Octet String. It shall be formatted according to subclause 14.3 of 3GPP
TS 23.003 [28] that describes an NAI.
**_116 -- 3GPP-Session-AMBR-v2_**
* * *
                                                           Bits
Octets 8 7 6 5 4 3 2 1 1 3GPP type = 116  
2 3GPP Length= m  
3 Spare DL UL  
4-5 UL Session-AMBR length (octet string)  
6-m UL Session-AMBR (octet string)  
(m+1)-(m+2) DL Session-AMBR length (octet string)  
(m+3)-n DL Session-AMBR (octet string)
* * *
3GPP Type: 116
Length: m
Octet 3 is Octet String type.
Bit 1 UL and bit 2 DL indicate if the corresponding UL and DL Session-AMBR
shall be present in a respective field or not. If one of these bits is set to
\"0\", the corresponding field shall not be present at all.
UL/DL Session AMBR: Octet String. It is sent from the DN-AAA to authorize the
PDU Session AMBR. The encoding is defined as BitRate in 3GPP TS 29.571 [39].
If the feature eSessionAMBR is supported and if applicable, the DN-AAA shall
send this VSA; otherwise, the DN-AAA shall send the VSA 3GPP-Session-AMBR.
**_117 -- 3GPP-Supported-Features_**
* * *
                                               Bits
Octets 8 7 6 5 4 3 2 1 1 3GPP type = 117  
2 3GPP Length= m  
3-6 Vendor ID (octet string)  
7-10 Feature List ID (octet string)  
11-14 Feature List (octet string)
* * *
3GPP Type: 117
Length: m
This VSA may be present in the Access-Request (initial one) message and either
the Access-Challenge (initial one) or the Access-Accept message. If present,
this VSA informs the destination entity about the features that the origin
entity requires to successfully complete the message exchange. The Vendor ID,
Feature List ID and Feature List are encoded according to 3GPP TS 29.229 [41].
See clause 12.4.1 for more detailed information regarding the general
principle of the feature negotiation with the difference that RADIUS terms
replace Diameter terms. The table 12.4.1-1 defines the features applicable to
the RADIUS N6 interfaces for the feature lists with a Feature-List-ID of 1.
Table 11.3-3 describes the sub-attributes of the 3GPP Vendor-Specific
attribute described above in different RADIUS messages.
Table 11.3-3: List of the 3GPP Vendor-Specific sub-attributes for N6
+----------+----------+----------+----------+----------+----------+ | Sub-attr | Sub-a | Des | Presence | As | Appli | | # | ttribute | cription | Req | sociated | cability | | | Name | | uirement | a | | | | | | | ttribute | | | | | | | | | | | | | | ( | | | | | | | Location | | | | | | | of | | | | | | | S | | | | | | | ub-attr) | | +----------+----------+----------+----------+----------+----------+ | 110 | 3 | It | Optional | Acces | | | | GPP-Noti | includes | | s-Accept | | | | fication | all | | | | | | | notif | | | | | | | ications | | | | | | | that the | | | | | | | DN-AAA | | | | | | | wants to | | | | | | | receive | | | | | | | from the | | | | | | | SMF. | | | | +----------+----------+----------+----------+----------+----------+ | 111 | 3GP | It is | Optional | Access- | | | | P-UE-MAC | sent | | Request, | | | | -Address | from the | | | | | | | DN-AAA | | Access-R | | | | | to | | esponse, | | | | | a | | | | | | | uthorize | | Ac | | | | | UE MAC | | counting | | | | | ad | | -Request | | | | | dresses, | | Interim | | | | | or it | | -Update, | | | | | i | | | | | | | ndicates | | Change- | | | | | UE MAC | | of-Autho | | | | | a | | rization | | | | | ddresses | | | | | | | in use | | | | | | | when | | | | | | | sending | | | | | | | from the | | | | | | | SMF to | | | | | | | the | | | | | | | DN-AAA. | | | | +----------+----------+----------+----------+----------+----------+ | 112 | 3GPP | It is | Optional | Access | | | | -Authori | sent | | -Accept, | | | | zation-R | from the | | | | | | eference | DN-AAA | | Change- | | | | | to refer | | of-Autho | | | | | to the | | rization | | | | | local | | | | | | | autho | | | | | | | rization | | | | | | | data in | | | | | | | the SMF. | | | | +----------+----------+----------+----------+----------+----------+ | 113 | 3GPP- | It is | Optional | Access | | | | Policy-R | sent | | -Accept, | | | | eference | from the | | | | | | | DN-AAA | | Change- | | | | | and used | | of-Autho | | | | | by the | | rization | | | | | SMF to | | | | | | | retrieve | | | | | | | the SM | | | | | | | or QoS | | | | | | | policy | | | | | | | data | | | | | | | from the | | | | | | | PCF. It | | | | | | | is not | | | | | | | used in | | | | | | | this | | | | | | | release. | | | | +----------+----------+----------+----------+----------+----------+ | 114 | 3 | It is | Optional | Access | | | | GPP-Sess | sent | | -Accept, | | | | ion-AMBR | from the | | | | | | | DN-AAA | | Change- | | | | | to | | of-Autho | | | | | a | | rization | | | | | uthorize | | | | | | | the PDU | | | | | | | Session | | | | | | | AMBR in | | | | | | | the | | | | | | | downlink | | | | | | | and | | | | | | | uplink. | | | | +----------+----------+----------+----------+----------+----------+ | 115 | 3GPP-NAI | The | Optional | Access- | | | | | Network | | Request, | | | | | Access | | | | | | | Id | | Ac | | | | | entifier | | counting | | | | | ide | | -Request | | | | | ntifying | | START, | | | | | the UE. | | | | | | | | | Ac | | | | | | | counting | | | | | | | -Request | | | | | | | STOP, | | | | | | | | | | | | | | Ac | | | | | | | counting | | | | | | | -Request | | | | | | | Interi | | | | | | | m-Update | | +----------+----------+----------+----------+----------+----------+ | 116 | 3GPP | It is | Optional | Access | eSes | | | -Session | sent | | -Accept, | sionAMBR | | | -AMBR-v2 | from the | | | | | | | DN-AAA | | Change- | | | | | to | | of-Autho | | | | | a | | rization | | | | | uthorize | | | | | | | the PDU | | | | | | | Session | | | | | | | AMBR, it | | | | | | | includes | | | | | | | separate | | | | | | | session | | | | | | | AMBR for | | | | | | | UL and | | | | | | | DL. | | | | +----------+----------+----------+----------+----------+----------+ | 117 | 3GPP-Su | It | Optional | Access- | | | | pported- | i | | Request, | | | | Features | ndicates | | | | | | | the | | Access | | | | | s | | -Accept, | | | | | upported | | | | | | | features | | A | | | | | as | | ccess-Ch | | | | | s | | allenge, | | | | | pecified | | | | | | | in | | Ac | | | | | clause | | counting | | | | | 12.4.1. | | -Request | | | | | | | START, | | | | | | | | | | | | | | Acc | | | | | | | ounting- | | | | | | | Response | | | | | | | START | | +----------+----------+----------+----------+----------+----------+
RADIUS attributes related to the DN-AAA initiated re-authorization and
authentication challenge are described in the following subclauses.
### 11.3.2 Change-of-Authorization Request (optionally sent from DN-AAA server
to SMF)
Table 11.3.2-1 describes the attributes of the Change-of-Authorization Request
message. Other RADIUS attributes may be used as defined in IETF RFC 5176 [27].
Table 11.3.2-1: The attributes of the Change-of-Authorization Request message
+-------------+-------------+-------------+-------------+-------------+ | Attr # | Attribute | Description | Content | Presence | | | Name | | | Requirement | +-------------+-------------+-------------+-------------+-------------+ | 1 | User-Name | Username | String | Optional | | | | provided by | | | | | | the user | | | | | | (extracted | | | | | | from the | | | | | | PCO field | | | | | | received | | | | | | during PDN | | | | | | connection | | | | | | esta | | | | | | blishment). | | | | | | If no | | | | | | username is | | | | | | available a | | | | | | generic | | | | | | username, | | | | | | c | | | | | | onfigurable | | | | | | on a per | | | | | | DNN basis, | | | | | | shall be | | | | | | present. If | | | | | | the | | | | | | User-Name | | | | | | has been | | | | | | sent in the | | | | | | Ac | | | | | | cess-Accept | | | | | | message, | | | | | | this | | | | | | user-name | | | | | | shall be | | | | | | used in | | | | | | preference | | | | | | to the | | | | | | above | | | +-------------+-------------+-------------+-------------+-------------+ | 6 | S | Indicates | 17 | Optional | | | ervice-Type | the type of | (Authorize | | | | | service for | Only) | | | | | this user. | | | +-------------+-------------+-------------+-------------+-------------+ | 8 | Framed | User IPv4 | Ipv4 | Conditional | | | -IP-Address | address | | NOTE 2 | +-------------+-------------+-------------+-------------+-------------+ | 10 | 3GPP-NSAPI | identifies | UTF-8 | Optional | | | | QFI with | encoded | | | | | value range | character | | | | | 0-255 in | | | | | | this user | | | | | | session. | | | +-------------+-------------+-------------+-------------+-------------+ | 30 | Called | Identifier | DNN (UTF-8 | Optional | | | -Station-Id | for the | encoded | | | | | target | characters) | | | | | network | | | +-------------+-------------+-------------+-------------+-------------+ | 31 | Calling | This | MSISDN in | Optional | | | -Station-Id | attribute | in | | | | | is the | ternational | | | | | identifier | format | | | | | for the UE, | according | | | | | and it | to | | | | | shall be | 3GPP TS 23. | | | | | c | 003 [28], | | | | | onfigurable | UTF-8 | | | | | on a per | encoded | | | | | DNN basis. | decimal | | | | | | character. | | | | | | (NOTE 5) | | +-------------+-------------+-------------+-------------+-------------+ | 96 | Framed-I | User IPv6 | Ipv6 | Conditional | | | nterface-Id | Interface | | | | | | Identifier | | NOTE 1 | | | | | | NOTE 2 | +-------------+-------------+-------------+-------------+-------------+ | 44 | Acct | User | SMF IP | Mandatory | | | -Session-Id | session | address | | | | | identifier. | (IPv4 or | | | | | | IPv6) and | | | | | | Charging-ID | | | | | | c | | | | | | oncatenated | | | | | | in a UTF-8 | | | | | | encoded | | | | | | hexadecimal | | | | | | characters. | | | | | | | | | | | | (NOTE 6) | | +-------------+-------------+-------------+-------------+-------------+ | 79 | EAP-Message | This | String | Conditional | | | | attribute | | | | | | e | | NOTE 3 | | | | ncapsulates | | | | | | EAP message | | | | | | (as defined | | | | | | in | | | | | | IETF RFC | | | | | | 3748 [6]) | | | | | | exchanged | | | | | | between the | | | | | | SMF and | | | | | | DN-AAA, see | | | | | | IETF RFC | | | | | | 3579 [7] | | | | | | for | | | | | | details. | | | +-------------+-------------+-------------+-------------+-------------+ | 80 | Message-Au | This | String | Conditional | | | thenticator | attribute | | | | | | includes | | NOTE 3 | | | | the message | | | | | | aut | | | | | | henticator, | | | | | | see | | | | | | IETF RFC | | | | | | 3579 [7] | | | | | | for | | | | | | details. | | | +-------------+-------------+-------------+-------------+-------------+ | 97 | Framed- | User IPv6 | Ipv6 | Conditional | | | Ipv6-Prefix | prefix | | NOTE 2 | +-------------+-------------+-------------+-------------+-------------+ | 123 | Delegated- | Delegated | Ipv6 | Conditional | | | Ipv6-Prefix | IPv6 prefix | | NOTE 4 | | | | to the | | | | | | user. | | | +-------------+-------------+-------------+-------------+-------------+ | 26/10415 | 3GPP | Sub | See | Optional | | | Vend | -attributes | clause 11.3 | | | | or-Specific | according | | | | | | c | | | | | | lause 11.3, | | | | | | the | | | | | | encoding of | | | | | | this | | | | | | attribute | | | | | | is | | | | | | specified | | | | | | in | | | | | | 3GPP TS 29 | | | | | | .061 [5]. | | | +-------------+-------------+-------------+-------------+-------------+ | NOTE 1: | | | | | | Included if | | | | | | the prefix | | | | | | alone is | | | | | | not unique | | | | | | for the | | | | | | user. This | | | | | | may be the | | | | | | case, for | | | | | | example, if | | | | | | a static | | | | | | IPv6 | | | | | | address is | | | | | | assigned. | | | | | | | | | | | | NOTE 2: If | | | | | | the | | | | | | 3G | | | | | | PP-PDP-Type | | | | | | is IPv4, | | | | | | IPv6 or | | | | | | IPv4v6, | | | | | | either IPv4 | | | | | | or IPv6 | | | | | | add | | | | | | ress/prefix | | | | | | attribute | | | | | | shall be | | | | | | present. | | | | | | The IP | | | | | | protocol | | | | | | version for | | | | | | end-user | | | | | | and network | | | | | | may be | | | | | | different. | | | | | | | | | | | | NOTE 3: | | | | | | Shall be | | | | | | present if | | | | | | EAP is | | | | | | used. | | | | | | | | | | | | NOTE 4: The | | | | | | delegated | | | | | | IPv6 prefix | | | | | | shall be | | | | | | present if | | | | | | the user | | | | | | was | | | | | | delegated | | | | | | an IPv6 | | | | | | prefix from | | | | | | a local | | | | | | pool. | | | | | | | | | | | | NOTE 5: | | | | | | There are | | | | | | no leading | | | | | | characters | | | | | | in front of | | | | | | the country | | | | | | code. | | | | | | | | | | | | NOTE 6: If | | | | | | the | | | | | | accounting | | | | | | session is | | | | | | created per | | | | | | QoS flow, | | | | | | Acct | | | | | | -Session-Id | | | | | | may be | | | | | | extended to | | | | | | include the | | | | | | QFI of the | | | | | | QoS flow. | | | | | +-------------+-------------+-------------+-------------+-------------+
### 11.3.3 Access-Challenge (sent from DN-AAA server to SMF)
Table 11.3.3-1 describes the attributes of the Access-Challenge Request
message. Other RADIUS attributes may be used as defined in IETF RFC 2865 [8].
Table 11.3.3-1: The attributes of the Access-Challenge message
* * *
Attr # Attribute Name Description Content Presence Requirement 27 Session-
Timeout Indicates the timeout value (in seconds) for the user session 32 bit
unsigned Integer Optional 79 EAP-Message This attribute encapsulates EAP
message (as defined in IETF RFC 3748 [6]) exchanged between the SMF and DN-
AAA, see IETF RFC 3579 [7] for details. String Mandatory 80 Message-
Authenticator This attribute includes the message authenticator, see IETF RFC
3579 [7] for details. String Mandatory NOTE: Included if the prefix alone is
not unique for the user. This may be the case, for example, if a static Ipv6
address is assigned.
* * *
# 12 Interworking with DN (Diameter)
## 12.1 Diameter Procedures
### 12.1.1 Diameter Authentication and Authorization
The SMF also represents the H-SMF in the home routed scenario in this
subclause unless specified otherwise.
Diameter Authentication and Authorization shall be used according to IETF RFC
7155 [23]. In 5G, multiple authentication methods using Extensible
Authentication Protocol (EAP) may be used such as EAP-TLS (see IETF RFC 5216
[11]), EAP-TTLS (see IETF RFC 5281 [37]). The SMF shall support Diameter EAP
application as specified in IETF RFC 4072 [25].
The SMF and the DN-AAA shall advertise the support of the Diameter NASREQ and
EAP applications by including the value (1 and 5) of the application
identifier in the Auth-Application-Id AVP (as specified in IETF RFC 4072 [25])
and the value of the 3GPP (10415) in the Vendor-Id AVP of the Capabilities-
Exchange-Request and Capabilities-Exchange-Answer commands as specified in
IETF RFC 6733 [24], i.e. as part of the Vendor-Specific-Application-Id AVP.
The Diameter client function may reside in an SMF. When the SMF receives an
initial access request (i.e. the SMF receives the
Nsmf_PDUSession_CreateSMContext request with type \"Initial request\" for non-
roaming case or local breakout case, or the H-SMF receives the
Nsmf_PDUSession_Create Request with type \"Initial request\" for home routed
case), the Diameter client function may send the authentication information to
a DN-AAA server, which is identified during the DNN provisioning.
The DN-AAA server performs authentication and authorization. The response
(when positive) may contain network information, such as an IPv4 address
and/or IPv6 prefix for the user when the SMF is interworking with the DN-AAA
server.
The information delivered during the Diameter authentication can be used to
automatically correlate the user identity (e.g. SUPI) to the IPv4 address
and/or IPv6 prefix, if applicable, assigned/confirmed by the SMF or the DN-AAA
server respectively. The same procedure applies, in case of sending the
authentication to a \'proxy\' DN-AAA server.
For 5G, Diameter Authentication is applicable to the initial access request.
When the SMF receives a positive response from the DN-AAA server it shall
complete the initial access procedure. If Access-Reject or no response is
received, the SMF shall reject the initial access procedure with a suitable
cause code.
When DN-AAA server authorizes the PDU Session Establishment, it may send DN
authorization data for the established PDU Session to the SMF. The DN
authorization data for the established PDU Session may include one or more of
the following:
\- a reference to authorization data for policy and charging control locally
configured in the SMF or PCF;
\- a list of allowed MAC addresses (maximum 16) for the Ethernet PDU Session;
and
\- Session-AMBR for the PDU Session.
SMF policies may require DN authorization without DN authentication. In that
case, when contacting the DN-AAA server for authorization, the SMF shall
provide the GPSI of the UE if available.
The SMF may also use the Diameter re-authorization procedure for the purpose
of IPv4 address and/or IPv6 prefix allocation to the UE. The use cases that
may lead this procedure are:
\- IPv4 address and/or IPv6 prefix allocation after UPF selection during PDU
session establishment procedure.
\- IPv6 prefix allocation during adding additional PDU Session Anchor
procedure for IPv6 multi-homing.
\- IPv4 address allocation via DHCPv4 procedure after successful PDU session
establishment procedure.
When an IPv4 address and/or IPv6 prefix (including any additional IPv6 prefix
of IPv6 multi-homing) is (re-)allocated or de-allocated (not causing the PDU
session to be released) by using a method not via the DN-AAA server and if the
SMF was required by the DN-AAA server to report such change during
authentication procedure or by local configuration, the SMF shall, if
applicable, use the authentication session that was established before to
inform the DN-AAA server by sending Diameter DER or AAR with the latest list
of IPv4 address and/or IPv6 prefix(es).
When the SMF is notified by the UPF regarding the UE MAC address change (a new
one is detected or a used one is inactive), if the SMF was required by the DN-
AAA server to report such change during authentication procedure or by local
configuration, the SMF shall, if applicable, use the authentication session
that was established before to inform the DN-AAA server by sending Diameter
DER or AAR with the latest list of UE MAC addresses in use.
### 12.1.2 Diameter Accounting
Diameter Accounting shall be used according to IETF RFC 7155 [23].
The SMF and the DN-AAA may advertise the support of the Diameter base
accounting application by including the value (3) of the application
identifier in the Acct-Application-Id AVP and the value of the 3GPP (10415) in
the Vendor-Id AVP of the Capabilities-Exchange-Request and Capabilities-
Exchange-Answer commands as specified in IETF RFC 6733 [24], i.e. as part of
the Vendor-Specific-Application-Id AVP.
The Diameter accounting client function may reside in an SMF. The Diameter
accounting client may send information to a DN-AAA server, which is identified
during the DNN provisioning. The DN-AAA server may store this information and
use it to automatically identify the user. This information can be trusted
because the 3GPP network has authenticated the subscriber (i.e. USIM card and
possibly other authentication methods).
The SMF may use the Diameter Accounting messages during QoS flow (e.g. QoS
flow associated with the default QoS rule) establishment and termination
procedures, respectively.
If the DN-AAA server is used for IPv4 address and/or IPv6 prefix assignment,
then, upon reception of a Diameter Accounting-Request STOP message for all QoS
flows associated to a PDU session defined by DNN and SUPI or GPSI, the DN-AAA
server may make the associated IPv4 address and/or IPv6 prefix available for
assignment.
When an IPv4 address and/or IPv6 prefix (including any additional IPv6 prefix
of IPv6 multi-homing) is (re-)allocated or de-allocated (not causing the PDU
session to be released) by using a method not via the DN-AAA server and if the
SMF was required by the DN-AAA server to report such change during
authentication procedure or by local configuration, the SMF shall, if
applicable, use the accounting session that was established before to inform
the DN-AAA server by sending Diameter Accounting-Request Interim-Update with
the latest list of IPv4 address and/or IPv6 prefix(es).
When the SMF is notified by the UPF regarding the UE MAC address change (a new
one is detected or a used one is inactive), if the SMF was required by the DN-
AAA server to report such change during authentication procedure or by local
configuration, the SMF shall, if applicable, use the accounting session that
was established before to inform the DN-AAA server by sending Diameter
Accounting-Request Interim-Update with the latest list of UE MAC addresses in
use.
## 12.2 Message flows on N6 interface
### 12.2.1 Authentication, Authorization and Accounting procedures
The SMF also represents the H-SMF in the home routed scenario in this
subclause unless specified otherwise.
When an SMF receives an initial access request (i.e. the SMF receives the
Nsmf_PDUSession_CreateSMContext request with type \"Initial request\" for non-
roaming case or local breakout case, or the H-SMF receives the
Nsmf_PDUSession_Create Request with type \"Initial request\" for home routed
case) message for a given DNN, the SMF may (depending on the configuration for
this DNN) send a Diameter DER message to a DN-AAA server. Upon receipt of the
DER message, the DN-AAA server shall respond with an DEA message. Multi-round
authentication using the DEA and DER messages may be used. The DN-AAA server
finally authenticates and authorizes the user by replying with the DEA
message. If the DN-AAA server is also responsible for IPv4 address and/or IPv6
prefix allocation, the DN-AAA server shall return the allocated IPv4 address
and/or IPv6 prefix in the DEA message.
For re-authentication and re-authorization, the SMF shall send a DER message
to the DN-AAA server and the DN-AAA server shall respond with a DEA message.
Multi-round authentication using the DEA and DER messages may be used. The DN-
AAA server finally authenticates and authorizes the user by replying with the
DEA message.
The SMF may initiate Diameter re-authorization procedures for the purpose of
IPv4 address and/or IPv6 prefix allocation (or renew the lease). In this case,
the SMF shall set the Session-Id to the value used in the initial request, the
Auth-Request-Type AVP to \"AUTHORIZE_ONLY\" and the 3GPP-Allocate-IP-Type AVP
to the type of IP address to be allocated in the AA-Request message sent to
the AAA server. If the SMF is using DHCP signalling towards the UE and the DN-
AAA server includes the Session-Timeout attribute in the Access-Accept, the
SMF may use the Session-Timeout value as the DHCP lease time. The SMF shall
not set the DHCPv4 lease time value higher than the Session-Timeout value. The
SMF may renew the DHCP lease to the UE without re-authorization towards the
DN-AAA server providing that the new lease expiry is no later than the
Session-Timeout timer expiry. If the SMF wishes to extend the lease time
beyond the current Session-Timeout expiry, it shall initiate a new AAA re-
authorization.
Even if the SMF was not involved in user authentication, it may send a
Diameter Accounting-Request (START) message to a DN-AAA server. If no Diameter
session is already open for the same PDU session a Diameter session needs to
be activated, otherwise the existing Diameter session is used to send the
Accounting-Request (START). If accounting is used per QoS flow, the QFI will
identify the particular bearer this accounting message refers to. This message
contains parameters, e.g. the tuple which includes the user ID and IPv4
address and/or IPv6 prefix, to be used by application servers (e.g. WAP
gateway) in order to identify the user. This message also indicates to the DN-
AAA server that the user session has started.
If some external applications require Diameter Accounting-Request (START)
information before they can process user packets, then the selected DNN (SMF)
may be configured in such a way that the SMF drops user data until an
Accounting-Answer (START) indicating success is received from the DN-AAA
server. The SMF may wait for the Accounting-Answer (START) before sending the
final authentication response message in
Namf_Communication_N1N2MessageTransfer service operation. The SMF may reject
the initial access request if the Accounting-Answer (START) is not received.
The authentication and accounting servers may be separately configured for
each DNN.
For IPv4 PDU type, if IPv4 address is allocated via DHCPv4 signalling between
the UE and the DN-AAA after PDU session establishment, the SMF may wait to
send the Accounting-Request START message until the UE receives its IPv4
address in a DHCPACK.
When the SMF receives a message indicating a QoS flow or PDU session release
request and providing a Diameter Accounting-Request START message was sent
previously, the SMF shall send a Diameter Accounting-Request (STOP) message to
the DN-AAA server, which indicates the termination of this particular QoS flow
or PDU session. The SMF shall immediately send the corresponding response
(e.g. Nsmf_PDUSession_UpdateSMContext response) to the AMF, without waiting
for an Accounting-Answer (STOP) message from the DN-AAA server.
If the last QoS flow of a PDU session is deactivated, the SMF shall
additionally send an STR message to the DN-AAA server. The DN-AAA server shall
reply with an STA message and shall deallocate the IPv4 address and/or IPv6
prefix initially allocated to the subscriber.
The following figure 12.2.1-1 is an example message flow to show the procedure
of Diameter Authentication and Accounting between an SMF and a DN-AAA server:
1\. UE initiates the PDU Session Establishment procedure, including
authentication/authorization information.
2\. The AMF sends Nsmf_PDUSession_CreateSMContext Request including the
authentication/authorization information to the SMF and the SMF responds to
the service operation.
According to the configuration in the SMF, step 6 to step 9 are executed
before step 3 if the SMF needs to send an EAP-Request message to the UE.
In the case of home routed, the AMF sends Nsmf_PDUSession_CreateSMContext
Request including the authentication/authorization information to the V-SMF
and the V-SMF sends Nsmf_PDUSession_Create Request including the
authentication/authorization information to the H-SMF.
3\. If the N4 session has not been established before, the SMF triggers the N4
Session Establishment procedure to the UPF.
> In the case of home routed, the V-SMF triggers the N4 Session Establishment
> procedure to the V-UPF and the H-SMF triggers the N4 Session Establishment
> procedure to the H-UPF.
4\. The SMF sends the DER message to the DN-AAA via the UPF, the message is
forwarded from the SMF to the DN-AAA by the UPF in N4 user plane message.
> In the case of home routed, the H-SMF sends the Access-Request message to
> the DN-AAA via the H-UPF, the message is forwarded from the H-SMF to the DN-
> AAA by the H-UPF in N4 user plane message.
5-10. The DN-AAA responds with the DEA message to the SMF via the UPF, the
message is forwarded from the DN-AAA to the SMF by the UPF in N4 user plane
message. The authentication/authorization information is further transferred
to UE via Namf_Communication_N1N2MessageTransfer service and NAS SM Transport
message. UE responds to the received authentication/authorization data and
such information is transferred in NAS SM Transport message and
Nsmf_PDUSession_UpdateSMContext service, then finally sent to the DN-AAA by
the SMF, via the UPF, in the DER message.
> In the case of home routed, the DN-AAA responds with the Access-Challenge
> message to the H-SMF via the H-UPF, the message is forwarded from the DN-AAA
> to the H-SMF by the H-UPF in N4 user plane message. The
> authentication/authorization information is transferred to V-SMF via
> Nsmf_PDUSession_Update service and is further transferred to UE via
> Namf_Communication_N1N2MessageTransfer service and NAS SM Transport message.
> UE responds to the received authentication/authorization data and such
> information is transferred in NAS SM Transport message,
> Nsmf_PDUSession_UpdateSMContext service and Nsmf_PDUSession_Update servic,
> then finally sent to the DN-AAA by the H-SMF, via the H-UPF, in the Access-
> Request message.
NOTE: Step 5 to step 10 can be repeated depending on the
authentication/authorization mechanism used (e.g. EAP-TLS).
11\. The SMF receives final result of authentication/authorization from the
DN-AAA in the DEA message, via the UPF.
12\. The SMF requests to start accounting by sending the Accounting-Request
(START) message to the DN-AAA via the UPF.
13\. The SMF proceeds with the PDU session establishment procedure and
includes the authentication/authorization information in
Namf_Communication_N1N2MessageTransfer service.
> In the case of home routed, the H-SMF proceeds with the PDU session
> establishment procedure and includes the authentication/authorization
> information is transferred to V-SMF via Nsmf_PDUSession_Update service and
> is further transferred to the AMF via Namf_Communication_N1N2MessageTransfer
> service.
14\. The DN-AAA responds with the Accounting-Response (START) message. The SMF
may wait for the Accounting-Response (START) before sending the
Namf_Communication_N1N2MessageTransfer request in step 13.
> In the case of home routed, the H-SMF may wait for the Accounting-Response
> (START) before sending the Nsmf_PDUSession_Update service in step 13.
15\. The AMF sends the NAS PDU Session Establishment Request with the
authentication/authorization information to the UE.
16\. The UE sends a NAS message Deregistration Request to the AMF.
17\. The AMF sends Nsmf_PDUSession_ReleaseSMContext Request to the SMF and the
SMF responds to the service operation.
In the case of home routed, the AMF sends Nsmf_PDUSession_ReleaseSMContext
Request to the V-SMF and the V-SMF sends the Nsmf_PDUSession_Release Request
to the H-SMF.
18-19. The SMF requests to stop accounting by sending the Accounting-Request
(STOP) message to the DN-AAA via the UPF and the DN-AAA responds with the
Accounting-Response (STOP) message.
Figure 12.2.1-1: Diameter Authentication and Accounting example (successful
case)
### 12.2.2 Accounting Update
During the life of a QoS flow some information related to this QoS flow may
change. The SMF may send an Accounting Request (Interim) to the DN-AAA server
upon occurrence of a chargeable event, e.g. RAT change or QoS change. Interim
updates are also used when the IPv4 address and/or IPv6 prefix is
allocated/released/re-allocated.
When the SMF receives a signalling request (i.e.
Nsmf_PDUSession_UpdateSMContext) that indicates the occurrence of one of these
chargeable events, the SMF may send an Accounting Request Interim-Update to
the DN-AAA server to update the necessary information related to this QoS
flow. It is not necessary for the SMF to wait for the Diameter Accounting
Answer message from the DN-AAA server before sending the response for the
triggering signalling message (i.e. Namf_Communication_N1N2MessageTransfer).
The SMF may delete the QoS flow if the Accounting Answer is not received from
the DN-AAA server.
The SMF may also send interim updates at the expiry of an operator configured
time limit.
Figure 12.2.2-1 is an example message flow to show the procedure of Diameter
accounting update, messages between the SMF and DN-AAA are forwarded by the
UPF in N4 user plane message.
Figure 12.2.2-1: Diameter accounting update
### 12.2.3 DN-AAA initiated QoS flow termination
Diameter is used as the protocol between the SMF and the DN-AAA server or
proxy for applications (e.g. MMS) to deliver information related to user
session. However some IP applications could need to interwork with the SMF to
release the corresponding resource (e.g. terminate a particular QoS flow). For
this purpose, the DN-AAA server or proxy may send a Diameter ASR along with
the QoS flow Identifier in 3GPP-NSAPI, if available, to identify the
particular QoS flow to be terminated to the SMF. The SMF should react by
deleting the corresponding QoS flow and reply with ASA. If the SMF deletes the
corresponding QoS flow, it is not necessary for the SMF to wait for the
response (i.e. Nsmf_PDUSession_UpdateSMContext) from the AMF before sending
the ASA to the DN-AAA server.
The absence of the QoS flow Identifier in the Diameter ASR message indicates
to the SMF that all QoS flows for this particular user and sharing the same
user session shall be deleted. The QoS flows belonging to the same PDU session
are identified by the Diameter Session-Id. If a user has the same user IP
address for different sets of QoS flows towards different networks, only the
QoS flows linked to the one identified by the Diameter Session-Id shall be
deleted.
Figure 12.2.3-1 is an example message flow to show the procedure of DN-AAA
initiated QoS flow termination, messages between the SMF and DN-AAA are
forwarded by the UPF in N4 user plane message.
Figure 12.2.3-1: DN-AAA initiated QoS flow termination with Diameter
### 12.2.4 DN-AAA initiated re-authorization
Some IP applications could need to interwork with the SMF to update the PDU
session authorization attributes. For this purpose, the DN-AAA server or proxy
may send a Diameter RAR to the SMF. On receipt of the RAR from the DN-AAA
server, the SMF shall update the corresponding PDU session authorization
attributes and reply with RAA. DN-AAA may also use such procedure to revoke
the authorization of a PDU session, or to update the authorization data (e.g.
allowed UE MAC addresses).
If the SMF updates/deletes the corresponding PDU session, it is not necessary
for the SMF to wait for Nsmf_PDUSession_UpdateSMContext from the AMF before
sending the RAA to the DN-AAA server.
Figure 12.2.4-1 is an example message flow to show the procedure of DN-AAA
initiated re-authorization, messages between the SMF and DN-AAA are forwarded
by the UPF in N4 user plane message.
Figure 12.2.4-1: DN-AAA initiated re-authorization with Diameter
## 12.3 N6 specific AVPs
There is no specific AVP defined in the present release.
## 12.4 N6 re-used AVPs
### 12.4.0 General
Table 12.4-1 lists the Diameter AVPs re-used by the N6 reference point from
existing Diameter Applications, reference to the respective specifications and
a short description of the usage within the N6 reference point.
Table 12.4-1: N6 re-used Diameter AVPs
Attribute Name | AVP Code | Section defined | Value Type (NOTE 2) | AVP Flag rules  
(NOTE 1) | May Encr. | Applicability |  |  |   
---|---|---|---|---|---|---|---|---|---  
|  |  |  | Must | May | Should not | Must not |  |   
3GPP-IMSI | 1 | 3GPP TS 29.061 [5] (NOTE 3) | UTF8String | V | P |  | M | Y |   
3GPP-Charging-Id | 2 | 3GPP TS 29.061 [5] (NOTE 3) | OctetString | V | P |  | M | Y |   
3GPP-PDP-Type | 3 | 3GPP TS 29.061 [5] (NOTE 3) | Enumerated | V | P |  | M | Y |   
3GPP-CG-Address | 4 | 3GPP TS 29.061 [5] (NOTE 3) | OctetString | V | P |  | M | Y |   
3GPP-GPRS-Negotiated-QoS-Profile | 5 | 3GPP TS 29.061 [5] (NOTE 3) | UTF8String | V | P |  | M | Y |   
3GPP-SGSN-Address | 6 | 3GPP TS 29.061 [5] (NOTE 3) | OctetString | V | P |  | M | Y |   
3GPP-GGSN-Address | 7 | 3GPP TS 29.061 [5] (NOTE 3) | OctetString | V | P |  | M | Y |   
3GPP-IMSI-MCC-MNC | 8 | 3GPP TS 29.061 [5] (NOTE 3) | UTF8String | V | P |  | M | Y |   
3GPP-GGSN-MCC-MNC | 9 | 3GPP TS 29.061 [5] (NOTE 3) | UTF8String | V | P |  | M | Y |   
3GPP-NSAPI | 10 | 3GPP TS 29.061 [5] (NOTE 3) | OctetString | V | P |  | M | Y |   
3GPP-Selection-Mode | 12 | 3GPP TS 29.061 [5] (NOTE 3) | UTF8String | V | P |  | M | Y |   
3GPP-Charging-Characteristics | 13 | 3GPP TS 29.061 [5] (NOTE 3) | UTF8String | V | P |  | M | Y |   
3GPP-CG-Ipv6-Address | 14 | 3GPP TS 29.061 [5] (NOTE 3) | OctetString | V | P |  | M | Y |   
3GPP-SGSN-Ipv6-Address | 15 | 3GPP TS 29.061 [5] (NOTE 3) | OctetString | V | P |  | M | Y |   
3GPP-GGSN-Ipv6-Address | 16 | 3GPP TS 29.061 [5] (NOTE 3) | OctetString | V | P |  | M | Y |   
3GPP-Ipv6-DNS-Servers | 17 | 3GPP TS 29.061 [5] (NOTE 3) | OctetString | V | P |  | M | Y |   
3GPP-SGSN-MCC-MNC | 18 | 3GPP TS 29.061 [5] (NOTE 3) | UTF8String | V | P |  | M | Y |   
3GPP-IMEISV | 20 | 3GPP TS 29.061 [5] (NOTE 3) | OctetString | V | P |  | M | Y |   
3GPP-RAT-Type | 21 | 3GPP TS 29.061 [5] (NOTE 3) | OctetString | V | P |  | M | Y |   
3GPP-User-Location-Info | 22 | 3GPP TS 29.061 [5] (NOTE 3) | OctetString | V | P |  | M | Y |   
3GPP-MS-TimeZone | 23 | 3GPP TS 29.061 [5] (NOTE 3) | OctetString | V | P |  | M | Y |   
3GPP-Packet-Filter | 25 | 3GPP TS 29.061 [5] (NOTE 3) | OctetString | V | P |  | M | Y |   
3GPP-Negotiated-DSCP | 26 | 3GPP TS 29.061 [5] (NOTE 3) | OctetString | V | P |  | M | Y |   
3GPP-Allocate-IP-Type | 27 | 3GPP TS 29.061 [5] (NOTE 3) | OctetString | V | P |  | M | Y |   
External-Identifier | 28 | 3GPP TS 29.061 [5] (NOTE 3) | OctetString | V | P |  | M | Y |   
3GPP-User-Location-Info-Time | 30 | 3GPP TS 29.061 [5] (NOTE 3) | OctetString | V | P |  | M | Y |   
3GPP-Notification | 110 | 11.3.1 | OctetString | V | P |  | M | Y |   
3GPP-UE-MAC-Address | 111 | 11.3.1 | OctetString | V | P |  | M | Y |   
3GPP-Authorization-Reference | 112 | 11.3.1 | OctetString | V | P |  | M | Y |   
3GPP-Policy-Reference | 113 | 11.3.1 | OctetString | V | P |  | M | Y | NOTE 4  
3GPP-Session-AMBR | 114 | 11.3.1 | OctetString | V | P |  | M | Y |   
3GPP-NAI | 115 | 11.3.1 | OctetString | V | P |  | M | Y |   
3GPP-Session-AMBR-v2 | 116 | 11.3.1 | OctetString | V | P |  | M | Y | eSessionAMBR  
Supported-Features | 628 | 3GPP TS 29.229 [41] | Grouped | V | M |  |  | N |   
NOTE 1: The AVP header bit denoted as 'M', indicates whether support of the AVP is required. The AVP header bit denoted as 'V', indicates whether the optional Vendor-ID field is present in the AVP header. For further details, see IETF RFC 6733 [24]. NOTE 2: The value types are defined in IETF RFC 6733 [24]. NOTE 3: The use of Radius VSA as a Diameter vendor AVP is described in Diameter NASREQ (IETF RFC 7155 [23]) and the P flag may be set. NOTE 4: It is not used in this release. |  |  |  |  |  |  |  |  |   
NOTE 1: Attribute 3GPP-CAMEL-Charging-Info (24), TWAN-Identifier (29) and
3GPP-Secondary-RAT-Usage (31) are not applicable for 5G in the present
specification.
NOTE 2: Table 11.3-2 lists the differences between the RADIUS VSAs used in 5G
and the VSAs defined in subclause 16.4.7 of 3GPP TS 29.061 [5].
### 12.4.1 Use of the Supported-Features AVP on the N6 reference point
The Supported-Features AVP is used during session establishment to inform the
destination host about the required and optional features that the origin host
supports. The client shall, in the first request in a Diameter session
indicate the set of supported features. The server shall, in the first answer
within the Diameter session indicate the set of features that it has in common
with the client and that the server shall support within the same Diameter
session. Any further command messages shall always be compliant with the list
of supported features indicated in the Supported-Features AVPs during session
establishment. Features that are not advertised as supported shall not be used
to construct the command messages for that Diameter session. Unless otherwise
stated, the use of the Supported-Features AVP on the N6 reference point shall
be compliant with the requirements for dynamic discovery of supported features
and associated error handling on the Cx reference point as defined in clause
7.2.1 of 3GPP TS 29.229 [41].
The base functionality for the N6 reference point is the 3GPP Rel-15 standard
and a feature is an extension to that functionality. If the origin host does
not support any features beyond the base functionality, the Supported-Features
AVP may be absent from the N6 commands. As defined in clause 7.1.1 of 3GPP TS
29.229 [41], when extending the application by adding new AVPs for a feature,
the new AVPs shall have the M bit cleared and the AVP shall not be defined
mandatory in the command ABNF.
As defined in 3GPP TS 29.229 [41], the Supported-Features AVP is of type
grouped and contains the Vendor-Id, Feature-List-ID and Feature-List AVPs. On
the N6 reference point, the Supported-Features AVP is used to identify
features that have been defined by 3GPP and hence, for features defined in
this document, the Vendor-Id AVP shall contain the vendor ID of 3GPP (10415).
If there are multiple feature lists defined for the N6 reference point, the
Feature-List-ID AVP shall differentiate those lists from one another.
On receiving an initial request application message, the destination host
shall act as defined in clause 7.2.1 of 3GPP TS 29.229 [41].
Once the SMF and DN-AAA have negotiated the set of supported features during
session establishment, the set of common features shall be used during the
lifetime of the Diameter session.
The table below defines the features applicable to the N6 interfaces for the
feature lists with a Feature-List-ID of 1.
Table 12.4.1-1: Features of Feature-List-ID 1 used in N6
+----------------------+--------------+-----+----------------------+ | Feature bit | Feature | M/O | Description | +----------------------+--------------+-----+----------------------+ | 0 | eSessionAMBR | M | This feature | | | | | indicates the | | | | | support of enhanced | | | | | Session AMBR | | | | | function. If | | | | | supported, the | | | | | DN-AAA authorizes DL | | | | | and/or UL Session | | | | | AMBR separately. | +----------------------+--------------+-----+----------------------+ | Feature bit: The | | | | | order number of the | | | | | bit within the | | | | | Feature-List AVP | | | | | where the least | | | | | significant bit is | | | | | assigned number | | | | | \"0\". | | | | | | | | | | Feature: A short | | | | | name that can be | | | | | used to refer to the | | | | | bit and to the | | | | | feature, e.g. | | | | | \"5GC\". | | | | | | | | | | M/O: Defines if the | | | | | implementation of | | | | | the feature is | | | | | mandatory (\"M\") or | | | | | optional (\"O\") in | | | | | this 3GPP Release. | | | | | | | | | | Description: A clear | | | | | textual description | | | | | of the feature. | | | | +----------------------+--------------+-----+----------------------+
## 12.5 N6 specific Experimental-Result-Code AVP
Diameter Base IETF RFC 6733 [24] defines a number of Result-Code AVP values
that are used to report protocol errors and how those are used. Those
procedures and values apply for the present specification.
Due to the N6 specific AVPs, new application results can occur and the
Experimental-Result AVP is used to transfer the 3GPP-specific result codes.
The Experimental-Result AVP is a grouped AVP containing the Vendor-Id AVP set
to the value of 3GPP\'s vendor identifier (10415) and an Experimental-Result-
Code AVP.
The following N6 specific Experimental-Result-Code value is defined:
DIAMETER_QOS_FLOW_DELETION_INDICATION (2421)
For SMF this is an indication to the server that the requested 5G QoS flow or
PDU session has been deleted.
## 12.6 N6 Diameter messages
### 12.6.1 General
This clause describes the N6 Diameter messages.
The relevant AVPs that are of use for the N6 interface are detailed in this
subclause. Other Diameter AVPs as defined in IETF RFC 4072 [25] and IETF RFC
7155 [23], even if their AVP flag rules are marked with \"M\", are not
required for being compliant with the current specification.
Diameter messages as defined in subclause 16.4 of 3GPP TS 29.061 [5] are re-
used in 5G with the following differences:
\- SMF replaces GGSN/P-GW.
\- 5G QoS flow replaces IP-CAN/EPS bearer and PDU session replaces IP-CAN
session.
\- N6 replaces Gi/Sgi.
NOTE: N6 re-used and specific AVPs are specified in subclause 12.3 and
subclause 12.4.
\- 3GPP-NAI AVP may be included in the AAR and ACR command.
\- Multiple 3GPP-UE-MAC-Address AVPs may be included in the AAR and ACR
command.
\- Acct-Application-Id AVP shall be included in the ACR and ACA command as
specified in IETF RFC 7155 [23].
\- Additional Diameter messages needed for 5G compared to the **3GPP TS 29.061
[5]** are described in the following subclauses.
\- Multiple Supported-Features AVPs may be included in the ACR and ACA
command.
### 12.6.2 DER Command
The DER command, defined in IETF RFC 4072 [25], is indicated by the Command-
Code field set to 268 and the \'R\' bit set in the Command Flags field. It is
sent by the SMF to the DN-AAA server upon reception of an initial access
request (e.g. Nsmf_PDUSession_CreateSMContext) message for a given DNN to
request user authentication and authorization.
The relevant AVPs that are of use for the N6 interface are detailed in the
ABNF description below. Other valid AVPs for this command are not used for N6
purposes and should be ignored by the receiver or processed according to the
relevant specifications.
The bold marked AVPs in the message format indicate new optional AVPs for N6,
or modified existing AVPs.
Message Format:
\ ::= \
\
{ Auth-Application-Id }
{ Origin-Host }
{ Origin-Realm }
{ Destination-Realm }
{ Auth-Request-Type }
[ Destination-Host ]
[ NAS-Port ]
[ NAS-Port-Id ]
[ NAS-Port-Type ]
[ Origin-State-Id ]
[ Port-Limit ]
[ User-Name ]
{ EAP-Payload }
[ EAP-Key-Name ]
[ Service-Type ]
[ Authorization-Lifetime ]
[ Auth-Grace-Period ]
[ Auth-Session-State ]
[ Callback-Number ]
[ Called-Station-Id ]
[ Calling-Station-Id ]
[ Originating-Line-Info ]
[ Connect-Info ]
* [ Framed-Compression ]
[ Framed-Interface-Id ]
[ Framed-IP-Address ]
* [ Framed-Ipv6-Prefix ]
* [ Delegated-Ipv6-Prefix ]
[ Framed-IP-Netmask ]
[ Framed-MTU ]
[ Framed-Protocol ]
* [ Tunneling ]
* [ Proxy-Info ]
* [ Route-Record ]
**[ External-Identifier ]**
**[ 3GPP-IMSI ]**
**[ 3GPP-NAI ]**
* **[ 3GPP-UE-MAC-Address ]**
**[ 3GPP-Charging-ID ]**
**[ 3GPP-PDP-Type ]**
**[ 3GPP-CG-Address ]**
**[ 3GPP-GPRS-Negotiated-QoS-Profile ]**
**[ 3GPP-SGSN-Address ]**
**[ 3GPP-GGSN-Address ]**
**[ 3GPP-IMSI-MCC-MNC ]**
**[ 3GPP-GGSN-MCC-MNC ]**
**[ 3GPP-NSAPI ]**
**[ 3GPP-Selection-Mode ]**
**[ 3GPP-Charging-Characteristics ]**
**[ 3GPP-CG-Ipv6-Address ]**
**[ 3GPP-SGSN-Ipv6-Address ]**
**[ 3GPP-GGSN-Ipv6-Address ]**
**[ 3GPP-SGSN-MCC-MNC ]**
**[ 3GPP-User-Location-Info ]**
**[ 3GPP-RAT-Type ]**
**[ 3GPP-Negotiated-DSCP ]**
**[ 3GPP-Allocate-IP-Type ]**
* **[ Supported-Features ]**
* [ AVP ]
### 12.6.3 DEA Command
The DEA command, defined in IETF RFC 4072 [25], is indicated by the Command-
Code field set to 268 and the \'R\' bit cleared in the Command Flags field. It
is sent by the DN-AAA server to the SMF in response to the DER command.
The relevant AVPs that are of use for the N6 interface are detailed in the
ABNF description below. Other valid AVPs for this command are not used for N6
purposes and should be ignored by the receiver or processed according to the
relevant specifications.
The bold marked AVPs in the message format indicate new optional AVPs for N6,
or modified existing AVPs.
Message Format:
\ ::= \
\
{ Auth-Application-Id }
{ Auth-Request-Type }
{ Result-Code }
{ Origin-Host }
{ Origin-Realm }
[ User-Name ]
[ EAP-Payload ]
[ EAP-Reissued-Payload ]
[ EAP-Master-Session-Key ]
[ EAP-Key-Name ]
[ Multi-Round-Time-Out ]
[ Accounting-EAP-Auth-Method ]
[ Service-Type ]
* [ Class ]
[ Acct-Interim-Interval ]
[ Error-Message ]
[ Error-Reporting-Host ]
[ Failed-AVP ]
[ Idle-Timeout ]
[ Authorization-Lifetime ]
[ Auth-Grace-Period ]
[ Auth-Session-State ]
[ Re-Auth-Request-Type ]
[ Session-Timeout ]
* [ Reply-Message ]
[ Origin-State-Id ]
* [ Filter-Id ]
[ Port-Limit ]
[ Callback-Id ]
[ Callback-Number ]
* [ Framed-Compression ]
[ Framed-Interface-Id ]
[ Framed-IP-Address ]
* [ Framed-Ipv6-Prefix ]
[ Framed-Ipv6-Pool ]
* [ Framed-Ipv6-Route ]
* [ Delegated-Ipv6-Prefix ]
[ Framed-IP-Netmask ]
* [ Framed-Route ]
[ Framed-Pool ]
[ Framed-IPX-Network ]
[ Framed-MTU ]
[ Framed-Protocol ]
[ Framed-Routing ]
* [ NAS-Filter-Rule ]
* [ QoS-Filter-Rule ]
* [ Tunneling ]
* [ Redirect-Host ]
[ Redirect-Host-Usage ]
[ Redirect-Max-Cache-Time ]
* [ Proxy-Info ]
* **[ External-Identifier ]**
**[ 3GPP-Ipv6-DNS-Servers ]**
**[ 3GPP-Notification ]**
0*16 **[ 3GPP-UE-MAC-Address ]**
**[ 3GPP-Authorization-Reference ]**
**[ 3GPP-Policy-Reference ]**
**[ 3GPP-Session-AMBR ]**
**[ 3GPP-Session-AMBR-v2 ]**
* **[ Supported-Features ]**
* [ AVP ]
### 12.6.4 RAR Command
The RAR command, defined in IETF RFC 7155 [23], is indicated by the Command-
Code field set to 258 and the \'R\' bit set in the Command Flags field. It is
sent by the DN-AAA server to the SMF to initiate re-authorization service.
The relevant AVPs that are of use for the N6 interface are detailed in the
ABNF description below. Other valid AVPs for this command are not used for N6
purposes and should be ignored by the receiver or processed according to the
relevant specifications.
The bold marked AVPs in the message format indicate new optional AVPs for N6,
or modified existing AVPs.
Message Format:
\ ::= \
\
{ Origin-Host }
{ Origin-Realm }
{ Destination-Realm }
[ Destination-Host ]
{ Auth-Application-Id }
{ Re-Auth-Request-Type }
[ User-Name ]
[ Origin-State-Id ]
[ NAS-Port ]
[ NAS-Port-Id ]
[ NAS-Port-Type ]
[ Service-Type ]
[ Framed-IP-Address ]
[ Framed-Ipv6-Prefix ]
[ Framed-Interface-Id ]
[ Called-Station-Id ]
[ Calling-Station-Id ]
[ Originating-Line-Info ]
[ Acct-Session-Id ]
* [ Class ]
[ Reply-Message ]
* [ Proxy-Info ]
* [ Route-Record ]
0*16 **[ 3GPP-UE-MAC-Address ]**
**[ 3GPP-Authorization-Reference ]**
**[ 3GPP-Policy-Reference ]**
**[ 3GPP-Session-AMBR ]**
**[ 3GPP-Session-AMBR-v2 ]**
* [ AVP ]
### 12.6.5 RAA Command
The RAA command, defined in IETF RFC 7155 [23], is indicated by the Command-
Code field set to 258 and the \'R\' bit set in the Command Flags field. It is
sent by the SMF to the DN-AAA server in response to the RAR command.
The relevant AVPs that are of use for the N6 interface are detailed in the
ABNF description below. Other valid AVPs for this command are not used for N6
purposes and should be ignored by the receiver or processed according to the
relevant specifications.
Message Format:
\ ::= \
\
{ Result-Code }
{ Origin-Host }
{ Origin-Realm }
[ User-Name ]
[ Origin-State-Id ]
[ Error-Message ]
[ Error-Reporting-Host ]
[ Failed-AVP ]
* [ Redirect-Host ]
[ Redirect-Host-Usage ]
[ Redirect-Max-Cache-Time ]
[ Service-Type ]
[ Idle-Timeout ]
[ Authorization-Lifetime ]
[ Auth-Grace-Period ]
[ Re-Auth-Request-Type ]
* [ Class ]
* [ Reply-Message ]
* [ Proxy-Info ]
* [ AVP ]
# 13 Interworking with IMS
## 13.1 General
Interworking with the IP Multimedia Core Network Subsystem (IMS) puts specific
requirements on the SMF.
The SMF shall use the following mechanisms to support the interworking with
the IMS:
\- the P-CSCF discovery;
\- N7 interface for the policy and charging control of QoS flows for IMS media
flows; and
\- the P-CSCF restoration.
These mechanisms are however not restricted only to the interworking with the
IMS and may be used for other services that could benefit from these
mechanisms.
If the PDU Session is used for IMS (identified by DNN), the SMF shall not
modify the fields Type of Service (IPv4) and Traffic Class (IPv6).
NOTE: The P-CSCF can support paging policy differentiation for different
traffic or service types over NG-RAN by marking the fields Type of Service
(IPv4) and Traffic Class (IPv6) (see subclause L.3.2.4 of 3GPP TS 24.229
[13]).
## 13.2 IMS interworking Model
### 13.2.1 Introduction
The signalling interface between the UE and the P-CSCF is a logical interface,
i.e. it uses 5GC as a QoS flow. The Npcf_SMPolicyControl services, offered via
N7 interface, are used for network communication between the SMF and the PCF.
For a description of the IMS architecture, refer to 3GPP TS 23.228 [12].
### 13.2.2 IMS specific configuration in the SMF
The SMF shall have a list of preconfigured addresses of signalling servers
(the P-CSCF servers). This list shall be provided to the UE at PDU session
establishment. It shall be possible to preconfigure the list of preconfigured
addresses of signalling servers per DNN.
The SMF/UPF may have the locally preconfigured packet filters, and/or the
applicable PCC rules, to be applied on the QoS flow. The packet filters shall
filter up-link and down-link packets, and shall only allow traffic to/from the
signalling servers and to the DNS and the DHCP servers. It shall be possible
to locally preconfigure the packet filters per DNN.
It shall be possible to enable/disable the use of the services offered via N7
interface per DNN.
The SMF shall support IPv4 and/or IPv6 addresses and protocol for IMS
signalling and IMS QoS flows.
The methods for the UE to discover the P-CSCF address(es) may vary depending
on the access technology that the UE is on. The details of the P-CSCF
discovery mechanisms for various accesses are specified in 3GPP TS 23.228 [12]
and 3GPP TS 24.229 [13]. The P-CSCF discovery mechanisms are:
\- a 5GC procedure for the P-CSCF discovery;
\- via DHCP servers i.e. the SMF shall provide the functionality of a DHCP
relay agent; and
\- if the UE has a P-CSCF FQDN locally configured and request the DNS IP
address(es) from the SMF (via 5GC mechanism or DHCP procedures), the SMF shall
be able to provide DNS IP address(es) to the UE.
The SMF shall have similar functional support depending on the P-CSCF
discovery methods supported by the UE on the access technology. For example,
for the UE in 3GPP 5G access network the SMF shall have DHCP server function
towards the UE while acting as a DHCP client towards external DHCP server, if
the SMF is configured to request DNS and/or P-CSCF IP addresses from the
external DHCP servers.
The SMF shall be able to deliver DNS and/or P-CSCF addresses to the UE if
requested by the UE via the 5G network or via DHCP procedures using the
relevant DHCP options for IPv4/IPv6 DNS and SIP servers (see IETF RFC 2132
[14], IETF RFC 3361 [15], IETF RFC 3646 [16] and IETF RFC 3319 [17]).
On DNNs providing IMS services, the information advertised in Router
Advertisements from the SMF to the UEs shall be configured in the same manner
as for other DNNs providing IPv6 services except that the \"Oâ€‘flag\" shall be
set.
The \"O-flag\" shall be set in IPv6 Router Advertisement messages sent by the
SMF for DNNs used for IMS services. This will trigger a DHCP capable UE to
start a DHCPv6 session to retrieve server addresses and other configuration
parameters. The UE which doesn\'t support DHCP shall ignore the \"O-flag\" and
shall request the IMS specific configuration (e.g. the P-CSCF address) via
other discovery methods supported in the UE (i.e. via locally configured
P-CSCF address/FQDN in the UE or via 5G procedure, if applicable).
The SMF shall have configurable policy rules for controlling QoS flows used
for signalling.
### 13.2.3 IMS specific procedures in the SMF
#### 13.2.3.1 Provisioning of Signalling Server Address
At a PDU Session establishment procedure related to the IMS, the SMF shall
support the capability to send the P-CSCF address(es) to the UE. The P-CSCF
address information is sent by the visited SMF if LBO is used. For Home
routed, the P-CSCF address information is sent by the SMF in the HPLMN. The
P-CSCF address(es) shall be sent transparently through the AMF, and in case of
Home Routed also through the SMF in the VPLMN.
NOTE 1: The SMF is located in the VPLMN if LBO is used.
NOTE 2: Other options to provide the P-CSCF address(es) to the UE as defined
in 3GPP TS 23.228 [12] is not excluded.
NOTE 3: A PDU session for IMS is identified by \"APN\" or \"DNN\".
#### 13.2.3.2 Failure of Signalling Server Address
If the SMF detects a failure:
\- upon receiving the N4 session report from the UPF for the monitored P-CSCF
address being used by the UE (as specified in 3GPP TS 23.380 [38], subclause
5.8.3); or
\- upon receiving a P-CSCF restoration indication from the UDM or the PCF,
then the SMF shall act as specified in 3GPP TS 23.380 [38], subclause 5.8.
# 14 Interworking with DN (Ethernet)
When support of Ethernet PDU type data is provided at the N6 interface, the
SMF and UPF may support ARP proxying as specified in IETF RFC 1027 [35] and/or
IPv6 Neighbour Solicitation Proxying as specified in IETF RFC 4861 [33]
functionality. Based on operator configuration, during the PDU session
establishment, the SMF may request the UPF acting as the PDU Session Anchor to
proxy ARP/IPv6 Neighbour Solicitation or to forward the ARP/IPv6 Neighbour
Solicitation traffic from the UPF to the SMF.
Ethernet Preamble, Start Frame Delimiter (SFD) and Frame Check Sequence (FCS)
are not sent over 5GS:
\- For UL traffic the UE strips the Preamble, SFD and FCS from the Ethernet
frame, those fields shall be added by the UPF acting as the PDU Session
Anchor.
\- For DL traffic the UPF acting as the PDU Session Anchor shall strip the
Preamble, SFD and FCS from the Ethernet frame.
IP address is not allocated by the SMF to the UE for this PDU Session. The UPF
shall store the MAC addresses, received from the UE, and associate those with
the appropriate PDU Session.
NOTE 1: The UE can operate in bridge mode with regard to a LAN it is
connecting to the 5GS, thus different MAC addresses can be used as source
address of different frames sent UL over a single PDU Session (and destination
MAC address of different frames sent DL over the same PDU Session)
NOTE 2: Entities on the LAN connected to the 5GS by the UE can have an IP
address allocated by the external DN, but the IP layer is considered as an
application layer which is not part of the Ethernet PDU Session.
NOTE 3: In this Release of the specification, only the UE connected to the 5GS
is authenticated, not the devices behind such UE.
When a PDU Session of Ethernet PDU type is authorized by a DN, the DN-AAA
server may, as part of authorization data, provide the SMF with a list of
allowed MAC addresses (maximum 16) for this PDU Session. When such a list has
been provided for a PDU Session, the SMF sets corresponding filtering rules in
the UPF(s) acting as PDU Session Anchor for the PDU Session and the UPF
discards any UL traffic that does not contain any of these MAC addresses as a
source address.
Figure 14-1: Protocol stacks for Ethernet PDU type data (user plane) for N6
reference point
#
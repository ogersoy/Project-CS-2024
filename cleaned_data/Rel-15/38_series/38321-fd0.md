# Foreword
This Technical Specification has been produced by the 3rd Generation
Partnership Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# 1 Scope
The present document specifies the NR MAC protocol.
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or non‑specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
[1] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[2] 3GPP TS 38.300: \"NR; Overall description; Stage 2\".
[3] 3GPP TS 38.322: \"NR; Radio Link Control (RLC) protocol specification\".
[4] 3GPP TS 38.323: \"NR; Packet Data Convergence Protocol (PDCP) protocol
specification\".
[5] 3GPP TS 38.331: \"NR; Radio Resource Control (RRC); Protocol
specification\".
[6] 3GPP TS 38.213: \"NR; Physical Layer Procedures for control\".
[7] 3GPP TS 38.214: \"NR; Physical Layer Procedures for data\".
[8] 3GPP TS 38.211: \"NR; Physical channels and modulation\".
[9] 3GPP TS 38.212: \"NR; Multiplexing and channel coding\".
[10] Void.
[11] 3GPP TS 38.133: \"NR; Requirements for support of radio resource
management\".
[12] 3GPP TS 36.133: \"Evolved Universal Terrestrial Radio Access (E-UTRA);
Requirements for support of radio resource management\".
[13] 3GPP TS 26.114: \"Technical Specification Group Services and System
Aspects; IP Multimedia Subsystem (IMS); Multimedia Telephony; Media handling
and interaction\".
[14] 3GPP TS 38.101-1: \"NR; User Equipment (UE) radio transmission and
reception; Part 1: Range 1 Standalone\".
[15] 3GPP TS 38.101-2: \"NR; User Equipment (UE) radio transmission and
reception; Part 2: Range 2 Standalone\".
[16] 3GPP TS 38.101-3: \"NR; User Equipment (UE) radio transmission and
reception; Part 3: Range 1 and Range 2 Interworking operation with other
radios\".
[17] 3GPP TS 36.213: \"Evolved Universal Terrestrial Radio Access (E-UTRA);
Physical Layer Procedures\".
# 3 Definitions, symbols and abbreviations
## 3.1 Definitions
For the purposes of the present document, the terms and definitions given in
TR 21.905 [1] and the following apply. A term defined in the present document
takes precedence over the definition of the same term, if any, in TR 21.905
[1].
**HARQ information:** HARQ information for DL-SCH or for UL-SCH transmissions
consists of New Data Indicator (NDI), Transport Block Size (TBS), Redundancy
Version (RV), and HARQ process ID.
**Msg3** : Message transmitted on UL-SCH containing a C-RNTI MAC CE or CCCH
SDU, submitted from upper layer and associated with the UE Contention
Resolution Identity, as part of a Random Access procedure.
**PDCCH occasion** : A time duration (i.e. one or a consecutive number of
symbols) during which the MAC entity is configured to monitor the PDCCH.
**Serving Cell:** A PCell, a PSCell, or an SCell in TS 38.331 [5].
**Special Cell:** For Dual Connectivity operation the term Special Cell refers
to the PCell of the MCG or the PSCell of the SCG depending on if the MAC
entity is associated to the MCG or the SCG, respectively. Otherwise the term
Special Cell refers to the PCell. A Special Cell supports PUCCH transmission
and contention-based Random Access, and is always activated.
**Timing Advance Group:** A group of Serving Cells that is configured by RRC
and that, for the cells with a UL configured, using the same timing reference
cell and the same Timing Advance value. A Timing Advance Group containing the
SpCell of a MAC entity is referred to as Primary Timing Advance Group (PTAG),
whereas the term Secondary Timing Advance Group (STAG) refers to other TAGs.
NOTE: A timer is running once it is started, until it is stopped or until it
expires; otherwise it is not running. A timer can be started if it is not
running or restarted if it is running. A Timer is always started or restarted
from its initial value. The duration of a timer is not updated until it is
stopped or expires (e.g. due to BWP switching). When the MAC entity applies
zero value for a timer, the timer shall be started and immediately expire
unless explicitly stated otherwise.
## 3.2 Abbreviations
For the purposes of the present document, the abbreviations given in TR 21.905
[1] and the following apply. An abbreviation defined in the present document
takes precedence over the definition of the same abbreviation, if any, in TR
21.905 [1].
> BSR Buffer Status Report
>
> BWP Bandwidth Part
>
> CE Control Element
>
> CSI Channel State Information
>
> CSI-IM CSI Interference Measurement
>
> CSI-RS CSI Reference Signal
>
> CS-RNTI Configured Scheduling RNTI
>
> INT-RNTI Interruption RNTI
>
> LCG Logical Channel Group
>
> LCP Logical Channel Prioritization
>
> MCG Master Cell Group
>
> NUL Normal Uplink
>
> NZP CSI-RS Non-Zero Power CSI-RS
>
> PHR Power Headroom Report
>
> PTAG Primary Timing Advance Group
>
> QCL Quasi-colocation
>
> RS Reference Signal
>
> SCG Secondary Cell Group
>
> SFI-RNTI Slot Format Indication RNTI
>
> SI System Information
>
> SpCell Special Cell
>
> SP Semi-Persistent
>
> SP-CSI-RNTI Semi-Persistent CSI RNTI
>
> SPS Semi-Persistent Scheduling
>
> SR Scheduling Request
>
> SS Synchronization Signals
>
> SSB Synchronization Signal Block
>
> STAG Secondary Timing Advance Group
>
> SUL Supplementary Uplink
>
> TAG Timing Advance Group
>
> TCI Transmission Configuration Indicator
>
> TPC-SRS-RNTI Transmit Power Control-Sounding Reference Signal-RNTI
>
> UCI Uplink Control Information
>
> ZP CSI-RS Zero Power CSI-RS
# 4 General
## 4.1 Introduction
The objective of this clause is to describe the MAC architecture and the MAC
entity of the UE from a functional point of view.
## 4.2 MAC architecture
### 4.2.1 General
This clause describes a model of the MAC i.e. it does not specify or restrict
implementations.
RRC is in control of the MAC configuration.
### 4.2.2 MAC Entities
The MAC entity of the UE handles the following transport channels:
\- Broadcast Channel (BCH);
\- Downlink Shared Channel(s) (DL-SCH);
\- Paging Channel (PCH);
\- Uplink Shared Channel(s) (UL-SCH);
\- Random Access Channel(s) (RACH).
When the UE is configured with SCG, two MAC entities are configured to the UE:
one for the MCG and one for the SCG.
The functions of the different MAC entities in the UE operate independently
unless otherwise specified. The timers and parameters used in each MAC entity
are configured independently unless otherwise specified. The Serving Cells,
C-RNTI, radio bearers, logical channels, upper and lower layer entities, LCGs,
and HARQ entities considered by each MAC entity refer to those mapped to that
MAC entity unless otherwise specified.
If the MAC entity is configured with one or more SCells, there are multiple
DL-SCH and there may be multiple UL-SCH as well as multiple RACH per MAC
entity; one DL-SCH, one UL-SCH, and one RACH on the SpCell, one DL-SCH, zero
or one UL-SCH and zero or one RACH for each SCell.
If the MAC entity is not configured with any SCell, there is one DL-SCH, one
UL-SCH, and one RACH per MAC entity.
Figure 4.2.2-1 illustrates one possible structure of the MAC entity when SCG
is not configured.
Figure 4.2.2-1: MAC structure overview
Figure 4.2.2-2 illustrates one possible structure for the MAC entities when
MCG and SCG are configured.
Figure 4.2.2-2: MAC structure overview with two MAC entities
## 4.3 Services
### 4.3.1 Services provided to upper layers
The MAC sublayer provides the following services to upper layers:
\- data transfer;
\- radio resource allocation.
### 4.3.2 Services expected from physical layer
The MAC sublayer expects the following services from the physical layer:
\- data transfer services;
\- signalling of HARQ feedback;
\- signalling of Scheduling Request;
\- measurements (e.g. Channel Quality Indication (CQI)).
## 4.4 Functions
The MAC sublayer supports the following functions:
\- mapping between logical channels and transport channels;
\- multiplexing of MAC SDUs from one or different logical channels onto
transport blocks (TB) to be delivered to the physical layer on transport
channels;
\- demultiplexing of MAC SDUs to one or different logical channels from
transport blocks (TB) delivered from the physical layer on transport channels;
\- scheduling information reporting;
\- error correction through HARQ;
\- logical channel prioritisation.
The relevance of MAC functions for uplink and downlink is indicated in Table
4.4-1.
Table 4.4-1: The link direction association of MAC functions.
MAC function Downlink Uplink
* * *
Mapping between logical channels and transport channels X X Multiplexing X
Demultiplexing X  
Scheduling information reporting X Error correction through HARQ X X Logical
Channel prioritisation X
## 4.5 Channel structure
### 4.5.1 General
The MAC sublayer operates on the channels defined below; transport channels
are SAPs between MAC and Layer 1, logical channels are SAPs between MAC and
RLC.
### 4.5.2 Transport Channels
The MAC sublayer uses the transport channels listed in Table 4.5.2-1 below.
Table 4.5.2-1: Transport channels used by MAC
Transport channel name Acronym Downlink Uplink
* * *
Broadcast Channel BCH X  
Downlink Shared Channel DL-SCH X  
Paging Channel PCH X  
Uplink Shared Channel UL-SCH X Random Access Channel RACH X
### 4.5.3 Logical Channels
The MAC sublayer provides data transfer services on logical channels. To
accommodate different kinds of data transfer services, multiple types of
logical channels are defined i.e. each supporting transfer of a particular
type of information.
Each logical channel type is defined by what type of information is
transferred.
The MAC sublayer provides the control and traffic channels listed in Table
4.5.3-1 below.
Table 4.5.3-1: Logical channels provided by MAC.
Logical channel name Acronym Control channel Traffic channel
* * *
Broadcast Control Channel BCCH X  
Paging Control Channel PCCH X  
Common Control Channel CCCH X  
Dedicated Control Channel DCCH X  
Dedicated Traffic Channel DTCH X
### 4.5.4 Mapping of Transport Channels to Logical Channels
#### 4.5.4.1 General
Both for uplink and downlink, the MAC entity is responsible for mapping
logical channels onto transport channels. This mapping depends on the
multiplexing that is configured by RRC.
#### 4.5.4.2 Uplink mapping
The uplink logical channels can be mapped as described in Table 4.5.4.2-1.
Table 4.5.4.2-1: Uplink channel mapping.
+-------------------+--------+------+ | Transport channel | UL-SCH | RACH | | | | | | Logical channel | | | +===================+========+======+ | CCCH | X | | +-------------------+--------+------+ | DCCH | X | | +-------------------+--------+------+ | DTCH | X | | +-------------------+--------+------+
#### 4.5.4.3 Downlink mapping
The downlink logical channels can be mapped as described in Table 4.5.4.3-1.
Table 4.5.4.3-1: Downlink channel mapping.
+-------------------+-----+-----+--------+ | Transport channel | BCH | PCH | DL-SCH | | | | | | | Logical channel | | | | +===================+=====+=====+========+ | BCCH | X | | X | +-------------------+-----+-----+--------+ | PCCH | | X | | +-------------------+-----+-----+--------+ | CCCH | | | X | +-------------------+-----+-----+--------+ | DCCH | | | X | +-------------------+-----+-----+--------+ | DTCH | | | X | +-------------------+-----+-----+--------+
# 5 MAC procedures
## 5.1 Random Access procedure
### 5.1.1 Random Access procedure initialization
The Random Access procedure described in this clause is initiated by a PDCCH
order, by the MAC entity itself, or by RRC for the events in accordance with
TS 38.300 [2]. There is only one Random Access procedure ongoing at any point
in time in a MAC entity. The Random Access procedure on an SCell shall only be
initiated by a PDCCH order with _ra-PreambleIndex_ different from 0b000000.
NOTE 1: If a new Random Access procedure is triggered while another is already
ongoing in the MAC entity, it is up to UE implementation whether to continue
with the ongoing procedure or start with the new procedure (e.g. for SI
request).
RRC configures the following parameters for the Random Access procedure:
\- _prach-ConfigurationIndex_ : the available set of PRACH occasions for the
transmission of the Random Access Preamble;
\- _preambleReceivedTargetPower_ : initial Random Access Preamble power;
\- _rsrp-ThresholdSSB_ : an RSRP threshold for the selection of the SSB. If
the Random Access procedure is initiated for beam failure recovery, _rsrp-
ThresholdSSB_ used for the selection of the SSB within _candidateBeamRSList_
refers to _rsrp-ThresholdSSB_ in _BeamFailureRecoveryConfig_ IE;
\- _rsrp-ThresholdCSI-RS_ : an RSRP threshold for the selection of CSI-RS. If
the Random Access procedure is initiated for beam failure recovery, _rsrp-
ThresholdCSI-RS_ is equal to _rsrp-ThresholdSSB_ in
_BeamFailureRecoveryConfig_ IE;
\- _rsrp-ThresholdSSB-SUL_ : an RSRP threshold for the selection between the
NUL carrier and the SUL carrier;
\- _candidateBeamRSList_ : a list of reference signals (CSI-RS and/or SSB)
identifying the candidate beams for recovery and the associated Random Access
parameters;
\- _recoverySearchSpaceId_ : the search space identity for monitoring the
response of the beam failure recovery request;
\- _powerRampingStep_ : the power-ramping factor;
\- _powerRampingStepHighPriority_ : the power-ramping factor in case of
prioritized Random Access procedure;
\- _scalingFactorBI_ : a scaling factor for prioritized Random Access
procedure;
\- _ra-PreambleIndex_ : Random Access Preamble;
\- _ra-ssb-OccasionMaskIndex_ : defines PRACH occasion(s) associated with an
SSB in which the MAC entity may transmit a Random Access Preamble (see clause
7.4);
\- _ra-OccasionList_ : defines PRACH occasion(s) associated with a CSI-RS in
which the MAC entity may transmit a Random Access Preamble;
\- _ra-PreambleStartIndex_ : the starting index of Random Access Preamble(s)
for on-demand SI request;
\- _preambleTransMax_ : the maximum number of Random Access Preamble
transmission;
\- _ssb-perRACH-OccasionAndCB-PreamblesPerSSB_ : defines the number of SSBs
mapped to each PRACH occasion and the number of contention-based Random Access
Preambles mapped to each SSB;
\- if _groupBconfigured_ is configured, then Random Access Preambles group B
is configured.
\- Amongst the contention-based Random Access Preambles associated with an SSB
(as defined in TS 38.213 [6]), the first _numberOfRA-PreamblesGroupA_ Random
Access Preambles belong to Random Access Preambles group A. The remaining
Random Access Preambles associated with the SSB belong to Random Access
Preambles group B (if configured).
NOTE 2: If Random Access Preambles group B is supported by the cell Random
Access Preambles group B is included for each SSB.
\- if Random Access Preambles group B is configured:
\- _ra-Msg3SizeGroupA_ : the threshold to determine the groups of Random
Access Preambles;
\- _msg3-DeltaPreamble_ : ∆ _~PREAMBLE_Msg3~_ in TS 38.213 [6];
\- _messagePowerOffsetGroupB_ : the power offset for preamble selection;
\- _numberOfRA-PreamblesGroupA_ : defines the number of Random Access
Preambles in Random Access Preamble group A for each SSB.
\- the set of Random Access Preambles and/or PRACH occasions for SI request,
if any;
\- the set of Random Access Preambles and/or PRACH occasions for beam failure
recovery request, if any;
\- the set of Random Access Preambles and/or PRACH occasions for
reconfiguration with sync, if any;
\- _ra-ResponseWindow_ : the time window to monitor RA response(s) (SpCell
only);
\- _ra-ContentionResolutionTimer_ : the Contention Resolution Timer (SpCell
only).
In addition, the following information for related Serving Cell is assumed to
be available for UEs:
\- if Random Access Preambles group B is configured:
\- if the Serving Cell for the Random Access procedure is configured with
supplementary uplink as specified in TS 38.331 [5], and SUL carrier is
selected for performing Random Access Procedure:
\- P~CMAX,f,c~ of the SUL carrier as specified in TS 38.101-1 [14], TS
38.101-2 [15], and TS 38.101-3 [16].
\- else:
\- P~CMAX,f,c~ of the NUL carrier as specified in TS 38.101-1 [14], TS
38.101-2 [15], and TS 38.101-3 [16].
The following UE variables are used for the Random Access procedure:
\- _PREAMBLE_INDEX_ ;
\- _PREAMBLE_TRANSMISSION_COUNTER_ ;
\- _PREAMBLE_POWER_RAMPING_COUNTER_ ;
\- _PREAMBLE_POWER_RAMPING_STEP_ ;
\- _PREAMBLE_RECEIVED_TARGET_POWER_ ;
\- _PREAMBLE_BACKOFF_ ;
\- _PCMAX_ ;
\- _SCALING_FACTOR_BI_ ;
\- _TEMPORARY_C-RNTI_.
When the Random Access procedure is initiated on a Serving Cell, the MAC
entity shall:
1> flush the Msg3 buffer;
1> set the _PREAMBLE_TRANSMISSION_COUNTER_ to 1;
1> set the _PREAMBLE_POWER_RAMPING_COUNTER_ to 1;
1> set the _PREAMBLE_BACKOFF_ to 0 ms;
1> if the carrier to use for the Random Access procedure is explicitly
signalled:
2> select the signalled carrier for performing Random Access procedure;
2> set the _PCMAX_ to P~CMAX,f,c~ of the signalled carrier.
1> else if the carrier to use for the Random Access procedure is not
explicitly signalled; and
1> if the Serving Cell for the Random Access procedure is configured with
supplementary uplink as specified in TS 38.331 [5]; and
1> if the RSRP of the downlink pathloss reference is less than _rsrp-
ThresholdSSB-SUL_ :
2> select the SUL carrier for performing Random Access procedure;
2> set the _PCMAX_ to P~CMAX,f,c~ of the SUL carrier.
1> else:
2> select the NUL carrier for performing Random Access procedure;
2> set the _PCMAX_ to P~CMAX,f,c~ of the NUL carrier.
1> perform the BWP operation as specified in clause 5.15;
1> set _PREAMBLE_POWER_RAMPING_STEP_ to _powerRampingStep_ ;
1> set _SCALING_FACTOR_BI_ to 1;
1> if the Random Access procedure was initiated for beam failure recovery (as
specified in clause 5.17); and
1> if _beamFailureRecoveryConfig_ is configured for the active UL BWP of the
selected carrier:
2> start the _beamFailureRecoveryTimer_ , if configured;
2> apply the parameters _powerRampingStep_ , _preambleReceivedTargetPower_ ,
and _preambleTransMax_ configured in the _beamFailureRecoveryConfig_ ;
2> if _powerRampingStepHighPriority_ is configured in the
_beamFailureRecoveryConfig_ :
3> set _PREAMBLE_POWER_RAMPING_STEP_ to the _powerRampingStepHighPriority_.
2> else:
3> set _PREAMBLE_POWER_RAMPING_STEP_ to _powerRampingStep_.
2> if _scalingFactorBI_ is configured in the _beamFailureRecoveryConfig_ :
3> set _SCALING_FACTOR_BI_ to the _scalingFactorBI_.
1> else if the Random Access procedure was initiated for handover; and
1> if _rach-ConfigDedicated_ is configured for the selected carrier:
2> if _powerRampingStepHighPriority_ is configured in the _rach-
ConfigDedicated_ :
3> set _PREAMBLE_POWER_RAMPING_STEP_ to the _powerRampingStepHighPriority_.
2> if _scalingFactorBI_ is configured in the _rach-ConfigDedicated_ :
3> set _SCALING_FACTOR_BI_ to the _scalingFactorBI_.
1> perform the Random Access Resource selection procedure (see clause 5.1.2).
### 5.1.2 Random Access Resource selection
The MAC entity shall:
1> if the Random Access procedure was initiated for beam failure recovery (as
specified in clause 5.17); and
1> if the _beamFailureRecoveryTimer_ (in clause 5.17) is either running or not
configured; and
1> if the contention-free Random Access Resources for beam failure recovery
request associated with any of the SSBs and/or CSI-RSs have been explicitly
provided by RRC; and
1> if at least one of the SSBs with SS-RSRP above _rsrp-ThresholdSSB_ amongst
the SSBs in _candidateBeamRSList_ or the CSI-RSs with CSI-RSRP above _rsrp-
ThresholdCSI-RS_ amongst the CSI-RSs in _candidateBeamRSList_ is available:
2> select an SSB with SS-RSRP above _rsrp-ThresholdSSB_ amongst the SSBs in
_candidateBeamRSList_ or a CSI-RS with CSI-RSRP above _rsrp-ThresholdCSI-RS_
amongst the CSI-RSs in _candidateBeamRSList_ ;
2> if CSI-RS is selected, and there is no _ra-PreambleIndex_ associated with
the selected CSI-RS:
3> set the _PREAMBLE_INDEX_ to a _ra-PreambleIndex_ corresponding to the SSB
in _candidateBeamRSList_ which is quasi-colocated with the selected CSI-RS as
specified in TS 38.214 [7].
2> else:
3> set the _PREAMBLE_INDEX_ to a _ra-PreambleIndex_ corresponding to the
selected SSB or CSI-RS from the set of Random Access Preambles for beam
failure recovery request.
1> else if the _ra-PreambleIndex_ has been explicitly provided by PDCCH; and
1> if the _ra-PreambleIndex_ is not 0b000000:
2> set the _PREAMBLE_INDEX_ to the signalled _ra-PreambleIndex_ ;
2> select the SSB signalled by PDCCH.
1> else if the contention-free Random Access Resources associated with SSBs
have been explicitly provided in _rach-ConfigDedicated_ and at least one SSB
with SS-RSRP above _rsrp-ThresholdSSB_ amongst the associated SSBs is
available:
2> select an SSB with SS-RSRP above _rsrp-ThresholdSSB_ amongst the associated
SSBs;
2> set the _PREAMBLE_INDEX_ to a _ra-PreambleIndex_ corresponding to the
selected SSB.
1> else if the contention-free Random Access Resources associated with CSI-RSs
have been explicitly provided in _rach-ConfigDedicated_ and at least one CSI-
RS with CSI-RSRP above _rsrp-ThresholdCSI-RS_ amongst the associated CSI-RSs
is available:
2> select a CSI-RS with CSI-RSRP above _rsrp-ThresholdCSI-RS_ amongst the
associated CSI-RSs;
2> set the _PREAMBLE_INDEX_ to a _ra-PreambleIndex_ corresponding to the
selected CSI-RS.
1> else if the Random Access procedure was initiated for SI request (as
specified in TS 38.331 [5]); and
1> if the Random Access Resources for SI request have been explicitly provided
by RRC:
2> if at least one of the SSBs with SS-RSRP above _rsrp-ThresholdSSB_ is
available:
3> select an SSB with SS-RSRP above _rsrp-ThresholdSSB_.
2> else:
3> select any SSB.
2> select a Random Access Preamble corresponding to the selected SSB, from the
Random Access Preamble(s) determined according to _ra-PreambleStartIndex_ as
specified in TS 38.331 [5];
2> set the _PREAMBLE_INDEX_ to selected Random Access Preamble.
1> else (i.e. for the contention-based Random Access preamble selection):
2> if at least one of the SSBs with SS-RSRP above _rsrp-ThresholdSSB_ is
available:
3> select an SSB with SS-RSRP above _rsrp-ThresholdSSB_.
2> else:
3> select any SSB.
2> if Msg3 has not yet been transmitted:
3> if Random Access Preambles group B is configured:
4> if the potential Msg3 size (UL data available for transmission plus MAC
subheader(s) and, where required, MAC CEs) is greater than _ra-Msg3SizeGroupA_
and the pathloss is less than _PCMAX_ (of the Serving Cell performing the
Random Access Procedure) -- _preambleReceivedTargetPower_ \--
_msg3-DeltaPreamble_ \-- _messagePowerOffsetGroupB_ ; or
4> if the Random Access procedure was initiated for the CCCH logical channel
and the CCCH SDU size plus MAC subheader is greater than _ra-Msg3SizeGroupA_ :
5> select the Random Access Preambles group B.
4> else:
5> select the Random Access Preambles group A.
3> else:
4> select the Random Access Preambles group A.
2> else (i.e. Msg3 is being retransmitted):
3> select the same group of Random Access Preambles as was used for the Random
Access Preamble transmission attempt corresponding to the first transmission
of Msg3.
2> select a Random Access Preamble randomly with equal probability from the
Random Access Preambles associated with the selected SSB and the selected
Random Access Preambles group.
2> set the _PREAMBLE_INDEX_ to the selected Random Access Preamble.
1> if the Random Access procedure was initiated for SI request (as specified
in TS 38.331 [5]); and
1> if _ra-AssociationPeriodIndex_ and _si-RequestPeriod_ are configured:
2> determine the next available PRACH occasion from the PRACH occasions
corresponding to the selected SSB in the association period given by _ra-
AssociationPeriodIndex_ in the _si-RequestPeriod_ permitted by the
restrictions given by the _ra-ssb-OccasionMaskIndex_ if configured (the MAC
entity shall select a PRACH occasion randomly with equal probability amongst
the consecutive PRACH occasions according to clause 8.1 of TS 38.213 [6]
corresponding to the selected SSB).
1> else if an SSB is selected above:
2> determine the next available PRACH occasion from the PRACH occasions
corresponding to the selected SSB permitted by the restrictions given by the
_ra-ssb-OccasionMaskIndex_ if configured or indicated by PDCCH (the MAC entity
shall select a PRACH occasion randomly with equal probability amongst the
consecutive PRACH occasions according to clause 8.1 of TS 38.213 [6],
corresponding to the selected SSB; the MAC entity may take into account the
possible occurrence of measurement gaps when determining the next available
PRACH occasion corresponding to the selected SSB).
1> else if a CSI-RS is selected above:
2> if there is no contention-free Random Access Resource associated with the
selected CSI-RS:
3> determine the next available PRACH occasion from the PRACH occasions,
permitted by the restrictions given by the _ra-ssb-OccasionMaskIndex_ if
configured, corresponding to the SSB in _candidateBeamRSList_ which is quasi-
colocated with the selected CSI-RS as specified in TS 38.214 [7] (the MAC
entity shall select a PRACH occasion randomly with equal probability amongst
the consecutive PRACH occasions according to clause 8.1 of TS 38.213 [6],
corresponding to the SSB which is quasi-colocated with the selected CSI-RS;
the MAC entity may take into account the possible occurrence of measurement
gaps when determining the next available PRACH occasion corresponding to the
SSB which is quasi-colocated with the selected CSI-RS).
2> else:
3> determine the next available PRACH occasion from the PRACH occasions in
_ra-OccasionList_ corresponding to the selected CSI-RS (the MAC entity shall
select a PRACH occasion randomly with equal probability amongst the PRACH
occasions occurring simultaneously but on different subcarriers, corresponding
to the selected CSI-RS; the MAC entity may take into account the possible
occurrence of measurement gaps when determining the next available PRACH
occasion corresponding to the selected CSI-RS).
1> perform the Random Access Preamble transmission procedure (see clause
5.1.3).
NOTE: When the UE determines if there is an SSB with SS-RSRP above _rsrp-
ThresholdSSB_ or a CSI-RS with CSI-RSRP above _rsrp-ThresholdCSI-RS_ , the UE
uses the latest unfiltered L1-RSRP measurement.
### 5.1.3 Random Access Preamble transmission
The MAC entity shall, for each Random Access Preamble:
1> if _PREAMBLE_TRANSMISSION_COUNTER_ is greater than one; and
1> if the notification of suspending power ramping counter has not been
received from lower layers; and
1> if SSB or CSI-RS selected is not changed from the selection in the last
Random Access Preamble transmission:
2> increment _PREAMBLE_POWER_RAMPING_COUNTER_ by 1.
1> select the value of _DELTA_PREAMBLE_ according to clause 7.3;
1> set _PREAMBLE_RECEIVED_TARGET_POWER_ to _preambleReceivedTargetPower_ \+
_DELTA_PREAMBLE_ \+ (_PREAMBLE_POWER_RAMPING_COUNTER_ \-- 1) ×
_PREAMBLE_POWER_RAMPING_STEP_ ;
1> except for contention-free Random Access Preamble for beam failure recovery
request, compute the RA-RNTI associated with the PRACH occasion in which the
Random Access Preamble is transmitted;
1> instruct the physical layer to transmit the Random Access Preamble using
the selected PRACH occasion, corresponding RA-RNTI (if available),
_PREAMBLE_INDEX_ and _PREAMBLE_RECEIVED_TARGET_POWER_.
The RA-RNTI associated with the PRACH occasion in which the Random Access
Preamble is transmitted, is computed as:
RA-RNTI = 1 + s_id + 14 × t_id + 14 × 80 × f_id + 14 × 80 × 8 × ul_carrier_id
where s_id is the index of the first OFDM symbol of the PRACH occasion (0 ≤
s_id \ if the contention-free Random Access Preamble for beam failure recovery
request was transmitted by the MAC entity:
2> start the _ra-ResponseWindow_ configured in _BeamFailureRecoveryConfig_ at
the first PDCCH occasion as specified in TS 38.213 [6] from the end of the
Random Access Preamble transmission;
2> monitor for a PDCCH transmission on the search space indicated by
_recoverySearchSpaceId_ of the SpCell identified by the C-RNTI while _ra-
ResponseWindow_ is running.
1> else:
2> start the _ra-ResponseWindow_ configured in _RACH-ConfigCommon_ at the
first PDCCH occasion as specified in TS 38.213 [6] from the end of the Random
Access Preamble transmission;
2> monitor the PDCCH of the SpCell for Random Access Response(s) identified by
the RA-RNTI while the _ra-ResponseWindow_ is running.
1> if notification of a reception of a PDCCH transmission on the search space
indicated by _recoverySearchSpaceId_ is received from lower layers on the
Serving Cell where the preamble was transmitted; and
1> if PDCCH transmission is addressed to the C-RNTI; and
1> if the contention-free Random Access Preamble for beam failure recovery
request was transmitted by the MAC entity:
2> consider the Random Access procedure successfully completed.
1> else if a downlink assignment has been received on the PDCCH for the RA-
RNTI and the received TB is successfully decoded:
2> if the Random Access Response contains a MAC subPDU with Backoff Indicator:
3> set the _PREAMBLE_BACKOFF_ to value of the BI field of the MAC subPDU using
Table 7.2-1, multiplied with _SCALING_FACTOR_BI_.
2> else:
3> set the _PREAMBLE_BACKOFF_ to 0 ms.
2> if the Random Access Response contains a MAC subPDU with Random Access
Preamble identifier corresponding to the transmitted _PREAMBLE_INDEX_ (see
clause 5.1.3):
3> consider this Random Access Response reception successful.
2> if the Random Access Response reception is considered successful:
3> if the Random Access Response includes a MAC subPDU with RAPID only:
4> consider this Random Access procedure successfully completed;
4> indicate the reception of an acknowledgement for SI request to upper
layers.
3> else:
4> apply the following actions for the Serving Cell where the Random Access
Preamble was transmitted:
5> process the received Timing Advance Command (see clause 5.2);
5> indicate the _preambleReceivedTargetPower_ and the amount of power ramping
applied to the latest Random Access Preamble transmission to lower layers
(i.e. (_PREAMBLE_POWER_RAMPING_COUNTER_ \-- 1) ×
_PREAMBLE_POWER_RAMPING_STEP_);
5> if the Random Access procedure for an SCell is performed on uplink carrier
where _pusch-Config_ is not configured:
6> ignore the received UL grant.
5> else:
6> process the received UL grant value and indicate it to the lower layers.
4> if the Random Access Preamble was not selected by the MAC entity among the
contention-based Random Access Preamble(s):
5> consider the Random Access procedure successfully completed.
4> else:
5> set the _TEMPORARY_C-RNTI_ to the value received in the Random Access
Response;
5> if this is the first successfully received Random Access Response within
this Random Access procedure:
6> if the transmission is not being made for the CCCH logical channel:
> 7> indicate to the Multiplexing and assembly entity to include a C-RNTI MAC
> CE in the subsequent uplink transmission.
6> obtain the MAC PDU to transmit from the Multiplexing and assembly entity
and store it in the Msg3 buffer.
NOTE: If within a Random Access procedure, an uplink grant provided in the
Random Access Response for the same group of contention-based Random Access
Preambles has a different size than the first uplink grant allocated during
that Random Access procedure, the UE behavior is not defined.
1> if _ra-ResponseWindow_ configured in _BeamFailureRecoveryConfig_ expires
and if a PDCCH transmission on the search space indicated by
_recoverySearchSpaceId_ addressed to the C-RNTI has not been received on the
Serving Cell where the preamble was transmitted; or
1> if _ra-ResponseWindow_ configured in _RACH-ConfigCommon_ expires, and if
the Random Access Response containing Random Access Preamble identifiers that
matches the transmitted _PREAMBLE_INDEX_ has not been received:
2> consider the Random Access Response reception not successful;
2> increment _PREAMBLE_TRANSMISSION_COUNTER_ by 1;
2> if _PREAMBLE_TRANSMISSION_COUNTER_ = _preambleTransMax_ \+ 1:
3> if the Random Access Preamble is transmitted on the SpCell:
4> indicate a Random Access problem to upper layers;
4> if this Random Access procedure was triggered for SI request:
5> consider the Random Access procedure unsuccessfully completed.
3> else if the Random Access Preamble is transmitted on an SCell:
4> consider the Random Access procedure unsuccessfully completed.
2> if the Random Access procedure is not completed:
3> select a random backoff time according to a uniform distribution between 0
and the _PREAMBLE_BACKOFF_ ;
3> if the criteria (as defined in clause 5.1.2) to select contention-free
Random Access Resources is met during the backoff time:
4> perform the Random Access Resource selection procedure (see clause 5.1.2);
3> else:
4> perform the Random Access Resource selection procedure (see clause 5.1.2)
after the backoff time.
The MAC entity may stop _ra-ResponseWindow_ (and hence monitoring for Random
Access Response(s)) after successful reception of a Random Access Response
containing Random Access Preamble identifiers that matches the transmitted
_PREAMBLE_INDEX_.
HARQ operation is not applicable to the Random Access Response reception.
### 5.1.5 Contention Resolution
Once Msg3 is transmitted, the MAC entity shall:
1> start the _ra-ContentionResolutionTimer_ and restart the _ra-
ContentionResolutionTimer_ at each HARQ retransmission in the first symbol
after the end of the Msg3 transmission;
1> monitor the PDCCH while the _ra-ContentionResolutionTimer_ is running
regardless of the possible occurrence of a measurement gap;
1> if notification of a reception of a PDCCH transmission of the SpCell is
received from lower layers:
2> if the C-RNTI MAC CE was included in Msg3:
3> if the Random Access procedure was initiated for beam failure recovery (as
specified in clause 5.17) and the PDCCH transmission is addressed to the
C-RNTI; or
3> if the Random Access procedure was initiated by a PDCCH order and the PDCCH
transmission is addressed to the C-RNTI; or
3> if the Random Access procedure was initiated by the MAC sublayer itself or
by the RRC sublayer and the PDCCH transmission is addressed to the C-RNTI and
contains a UL grant for a new transmission:
4> consider this Contention Resolution successful;
4> stop _ra-ContentionResolutionTimer_ ;
4> discard the _TEMPORARY_C-RNTI_ ;
4> consider this Random Access procedure successfully completed.
2> else if the CCCH SDU was included in Msg3 and the PDCCH transmission is
addressed to its _TEMPORARY_C-RNTI_ :
3> if the MAC PDU is successfully decoded:
4> stop _ra-ContentionResolutionTimer_ ;
4> if the MAC PDU contains a UE Contention Resolution Identity MAC CE; and
4> if the UE Contention Resolution Identity in the MAC CE matches the CCCH SDU
transmitted in Msg3:
5> consider this Contention Resolution successful and finish the disassembly
and demultiplexing of the MAC PDU;
5> if this Random Access procedure was initiated for SI request:
6> indicate the reception of an acknowledgement for SI request to upper
layers.
5> else:
6> set the C-RNTI to the value of the _TEMPORARY_C-RNTI_ ;
5> discard the _TEMPORARY_C-RNTI_ ;
5> consider this Random Access procedure successfully completed.
4> else:
5> discard the _TEMPORARY_C-RNTI_ ;
5> consider this Contention Resolution not successful and discard the
successfully decoded MAC PDU.
1> if _ra-ContentionResolutionTimer_ expires:
2> discard the _TEMPORARY_C-RNTI_ ;
2> consider the Contention Resolution not successful.
1> if the Contention Resolution is considered not successful:
2> flush the HARQ buffer used for transmission of the MAC PDU in the Msg3
buffer;
2> increment _PREAMBLE_TRANSMISSION_COUNTER_ by 1;
2> if _PREAMBLE_TRANSMISSION_COUNTER_ = _preambleTransMax_ \+ 1:
3> indicate a Random Access problem to upper layers.
3> if this Random Access procedure was triggered for SI request:
4> consider the Random Access procedure unsuccessfully completed.
2> if the Random Access procedure is not completed:
3> select a random backoff time according to a uniform distribution between 0
and the _PREAMBLE_BACKOFF_ ;
3> if the criteria (as defined in clause 5.1.2) to select contention-free
Random Access Resources is met during the backoff time:
4> perform the Random Access Resource selection procedure (see clause 5.1.2);
3> else:
4> perform the Random Access Resource selection procedure (see clause 5.1.2)
after the backoff time.
### 5.1.6 Completion of the Random Access procedure
Upon completion of the Random Access procedure, the MAC entity shall:
1> discard explicitly signalled contention-free Random Access Resources except
contention-free Random Access Resources for beam failure recovery request, if
any;
1> flush the HARQ buffer used for transmission of the MAC PDU in the Msg3
buffer.
## 5.2 Maintenance of Uplink Time Alignment
RRC configures the following parameters for the maintenance of UL time
alignment:
\- _timeAlignmentTimer_ (per TAG) which controls how long the MAC entity
considers the Serving Cells belonging to the associated TAG to be uplink time
aligned.
The MAC entity shall:
1> when a Timing Advance Command MAC CE is received, and if an N~TA~ (as
defined in TS 38.211 [8]) has been maintained with the indicated TAG:
2> apply the Timing Advance Command for the indicated TAG;
2> start or restart the _timeAlignmentTimer_ associated with the indicated
TAG.
1> when a Timing Advance Command is received in a Random Access Response
message for a Serving Cell belonging to a TAG:
2> if the Random Access Preamble was not selected by the MAC entity among the
contention-based Random Access Preamble:
3> apply the Timing Advance Command for this TAG;
3> start or restart the _timeAlignmentTimer_ associated with this TAG.
2> else if the _timeAlignmentTimer_ associated with this TAG is not running:
3> apply the Timing Advance Command for this TAG;
3> start the _timeAlignmentTimer_ associated with this TAG;
3> when the Contention Resolution is considered not successful as described in
clause 5.1.5; or
3> when the Contention Resolution is considered successful for SI request as
described in clause 5.1.5, after transmitting HARQ feedback for MAC PDU
including UE Contention Resolution Identity MAC CE:
4> stop _timeAlignmentTimer_ associated with this TAG.
2> else:
3> ignore the received Timing Advance Command.
1> when a _timeAlignmentTimer_ expires:
2> if the _timeAlignmentTimer_ is associated with the PTAG:
3> flush all HARQ buffers for all Serving Cells;
3> notify RRC to release PUCCH for all Serving Cells, if configured;
3> notify RRC to release SRS for all Serving Cells, if configured;
3> clear any configured downlink assignments and configured uplink grants;
3> clear any PUSCH resource for semi-persistent CSI reporting;
3> consider all running _timeAlignmentTimer_ s as expired;
3> maintain N~TA~ (defined in TS 38.211 [8]) of all TAGs.
2> else if the _timeAlignmentTimer_ is associated with an STAG, then for all
Serving Cells belonging to this TAG:
3> flush all HARQ buffers;
3> notify RRC to release PUCCH, if configured;
3> notify RRC to release SRS, if configured;
3> clear any configured downlink assignments and configured uplink grants;
3> clear any PUSCH resource for semi-persistent CSI reporting;
3> maintain N~TA~ (defined in TS 38.211 [8]) of this TAG.
When the MAC entity stops uplink transmissions for an SCell due to the fact
that the maximum uplink transmission timing difference between TAGs of the MAC
entity or the maximum uplink transmission timing difference between TAGs of
any MAC entity of the UE is exceeded, the MAC entity considers the
_timeAlignmentTimer_ associated with the SCell as expired.
The MAC entity shall not perform any uplink transmission on a Serving Cell
except the Random Access Preamble transmission when the _timeAlignmentTimer_
associated with the TAG to which this Serving Cell belongs is not running.
Furthermore, when the _timeAlignmentTimer_ associated with the PTAG is not
running, the MAC entity shall not perform any uplink transmission on any
Serving Cell except the Random Access Preamble transmission on the SpCell.
## 5.3 DL-SCH data transfer
### 5.3.1 DL Assignment reception
Downlink assignments received on the PDCCH both indicate that there is a
transmission on a DL-SCH for a particular MAC entity and provide the relevant
HARQ information.
When the MAC entity has a C-RNTI, Temporary C-RNTI, or CS-RNTI, the MAC entity
shall for each PDCCH occasion during which it monitors PDCCH and for each
Serving Cell:
1> if a downlink assignment for this PDCCH occasion and this Serving Cell has
been received on the PDCCH for the MAC entity\'s C-RNTI, or Temporary C‑RNTI:
2> if this is the first downlink assignment for this Temporary C-RNTI:
3> consider the NDI to have been toggled.
2> if the downlink assignment is for the MAC entity\'s C-RNTI, and if the
previous downlink assignment indicated to the HARQ entity of the same HARQ
process was either a downlink assignment received for the MAC entity\'s CS-
RNTI or a configured downlink assignment:
3> consider the NDI to have been toggled regardless of the value of the NDI.
2> indicate the presence of a downlink assignment and deliver the associated
HARQ information to the HARQ entity.
1> else if a downlink assignment for this PDCCH occasion has been received for
this Serving Cell on the PDCCH for the MAC entity\'s CS-RNTI:
2> if the NDI in the received HARQ information is 1:
3> consider the NDI for the corresponding HARQ process not to have been
toggled;
3> indicate the presence of a downlink assignment for this Serving Cell and
deliver the associated HARQ information to the HARQ entity.
2> if the NDI in the received HARQ information is 0:
3> if PDCCH contents indicate SPS deactivation:
4> clear the configured downlink assignment for this Serving Cell (if any);
4> if the _timeAlignmentTimer_ , associated with the TAG containing the
Serving Cell on which the HARQ feedback is to be transmitted, is running:
5> indicate a positive acknowledgement for the SPS deactivation to the
physical layer.
3> else if PDCCH content indicates SPS activation:
4> store the downlink assignment for this Serving Cell and the associated HARQ
information as configured downlink assignment;
4> initialise or re-initialise the configured downlink assignment for this
Serving Cell to start in the associated PDSCH duration and to recur according
to rules in clause 5.8.1;
For each Serving Cell and each configured downlink assignment, if configured
and activated, the MAC entity shall:
1> if the PDSCH duration of the configured downlink assignment does not
overlap with the PDSCH duration of a downlink assignment received on the PDCCH
for this Serving Cell:
2> instruct the physical layer to receive, in this PDSCH duration, transport
block on the DL-SCH according to the configured downlink assignment and to
deliver it to the HARQ entity;
2> set the HARQ Process ID to the HARQ Process ID associated with this PDSCH
duration;
2> consider the NDI bit for the corresponding HARQ process to have been
toggled;
2> indicate the presence of a configured downlink assignment and deliver the
stored HARQ information to the HARQ entity.
For configured downlink assignments, the HARQ Process ID associated with the
slot where the DL transmission starts is derived from the following equation:
HARQ Process ID = [floor (CURRENT_slot × 10 / (_numberOfSlotsPerFrame_ ×
_periodicity_))] modulo _nrofHARQ-Processes_
where CURRENT_slot = [(SFN × _numberOfSlotsPerFrame_) + slot number in the
frame] and _numberOfSlotsPerFrame_ refers to the number of consecutive slots
per frame as specified in TS 38.211 [8].
NOTE: CURRENT_slot refers to the slot index of the first transmission occasion
of a bundle of configured downlink assignment.
When the MAC entity needs to read BCCH, the MAC entity may, based on the
scheduling information from RRC:
1> if a downlink assignment for this PDCCH occasion has been received on the
PDCCH for the SI-RNTI;
2> indicate a downlink assignment and redundancy version for the dedicated
broadcast HARQ process to the HARQ entity.
### 5.3.2 HARQ operation
#### 5.3.2.1 HARQ Entity
The MAC entity includes a HARQ entity for each Serving Cell, which maintains a
number of parallel HARQ processes. Each HARQ process is associated with a HARQ
process identifier. The HARQ entity directs HARQ information and associated
TBs received on the DL-SCH to the corresponding HARQ processes (see clause
5.3.2.2).
The number of parallel DL HARQ processes per HARQ entity is specified in TS
38.214 [7]. The dedicated broadcast HARQ process is used for BCCH.
The HARQ process supports one TB when the physical layer is not configured for
downlink spatial multiplexing. The HARQ process supports one or two TBs when
the physical layer is configured for downlink spatial multiplexing.
When the MAC entity is configured with _pdsch-AggregationFactor_ > 1, the
parameter _pdsch-AggregationFactor_ provides the number of transmissions of a
TB within a bundle of the downlink assignment. Bundling operation relies on
the HARQ entity for invoking the same HARQ process for each transmission that
is part of the same bundle. After the initial transmission, _pdsch-
AggregationFactor_ \-- 1 HARQ retransmissions follow within a bundle.
The MAC entity shall:
1> if a downlink assignment has been indicated:
2> allocate the TB(s) received from the physical layer and the associated HARQ
information to the HARQ process indicated by the associated HARQ information.
1> if a downlink assignment has been indicated for the broadcast HARQ process:
2> allocate the received TB to the broadcast HARQ process.
#### 5.3.2.2 HARQ process
When a transmission takes place for the HARQ process, one or two (in case of
downlink spatial multiplexing) TBs and the associated HARQ information are
received from the HARQ entity.
For each received TB and associated HARQ information, the HARQ process shall:
1> if the NDI, when provided, has been toggled compared to the value of the
previous received transmission corresponding to this TB; or
1> if the HARQ process is equal to the broadcast process, and this is the
first received transmission for the TB according to the system information
schedule indicated by RRC; or
1> if this is the very first received transmission for this TB (i.e. there is
no previous NDI for this TB):
2> consider this transmission to be a new transmission.
1> else:
2> consider this transmission to be a retransmission.
The MAC entity then shall:
1> if this is a new transmission:
2> attempt to decode the received data.
1> else if this is a retransmission:
2> if the data for this TB has not yet been successfully decoded:
3> instruct the physical layer to combine the received data with the data
currently in the soft buffer for this TB and attempt to decode the combined
data.
1> if the data which the MAC entity attempted to decode was successfully
decoded for this TB; or
1> if the data for this TB was successfully decoded before:
2> if the HARQ process is equal to the broadcast process:
3> deliver the decoded MAC PDU to upper layers.
2> else if this is the first successful decoding of the data for this TB:
3> deliver the decoded MAC PDU to the disassembly and demultiplexing entity.
1> else:
2> instruct the physical layer to replace the data in the soft buffer for this
TB with the data which the MAC entity attempted to decode.
1> if the HARQ process is associated with a transmission indicated with a
Temporary C-RNTI and the Contention Resolution is not yet successful (see
clause 5.1.5); or
1> if the HARQ process is equal to the broadcast process; or
1> if the _timeAlignmentTimer_ , associated with the TAG containing the
Serving Cell on which the HARQ feedback is to be transmitted, is stopped or
expired:
2> not instruct the physical layer to generate acknowledgement(s) of the data
in this TB.
1> else:
2> instruct the physical layer to generate acknowledgement(s) of the data in
this TB.
The MAC entity shall ignore NDI received in all downlink assignments on PDCCH
for its Temporary C-RNTI when determining if NDI on PDCCH for its C-RNTI has
been toggled compared to the value in the previous transmission.
NOTE: If the MAC entity receives a retransmission with a TB size different
from the last TB size signalled for this TB, the UE behavior is left up to UE
implementation.
### 5.3.3 Disassembly and demultiplexing
The MAC entity shall disassemble and demultiplex a MAC PDU as defined in
clause 6.1.2.
## 5.4 UL-SCH data transfer
### 5.4.1 UL Grant reception
Uplink grant is either received dynamically on the PDCCH, in a Random Access
Response, or configured semi-persistently by RRC. The MAC entity shall have an
uplink grant to transmit on the UL-SCH. To perform the requested
transmissions, the MAC layer receives HARQ information from lower layers.
If the MAC entity has a C-RNTI, a Temporary C-RNTI, or CS-RNTI, the MAC entity
shall for each PDCCH occasion and for each Serving Cell belonging to a TAG
that has a running _timeAlignmentTimer_ and for each grant received for this
PDCCH occasion:
1> if an uplink grant for this Serving Cell has been received on the PDCCH for
the MAC entity\'s C-RNTI or Temporary C-RNTI; or
1> if an uplink grant has been received in a Random Access Response:
2> if the uplink grant is for MAC entity\'s C-RNTI and if the previous uplink
grant delivered to the HARQ entity for the same HARQ process was either an
uplink grant received for the MAC entity\'s CS-RNTI or a configured uplink
grant:
3> consider the NDI to have been toggled for the corresponding HARQ process
regardless of the value of the NDI.
2> if the uplink grant is for MAC entity\'s C-RNTI, and the identified HARQ
process is configured for a configured uplink grant:
3> start or restart the _configuredGrantTimer_ for the corresponding HARQ
process, if configured.
2> deliver the uplink grant and the associated HARQ information to the HARQ
entity.
1> else if an uplink grant for this PDCCH occasion has been received for this
Serving Cell on the PDCCH for the MAC entity\'s CS-RNTI:
2> if the NDI in the received HARQ information is 1:
3> consider the NDI for the corresponding HARQ process not to have been
toggled;
3> start or restart the _configuredGrantTimer_ for the corresponding HARQ
process, if configured;
3> deliver the uplink grant and the associated HARQ information to the HARQ
entity.
2> else if the NDI in the received HARQ information is 0:
3> if PDCCH contents indicate configured grant Type 2 deactivation:
4> trigger configured uplink grant confirmation.
3> else if PDCCH contents indicate configured grant Type 2 activation:
4> trigger configured uplink grant confirmation;
4> store the uplink grant for this Serving Cell and the associated HARQ
information as configured uplink grant;
4> initialise or re-initialise the configured uplink grant for this Serving
Cell to start in the associated PUSCH duration and to recur according to rules
in clause 5.8.2;
4> stop the _configuredGrantTimer_ for the corresponding HARQ process, if
running;
For each Serving Cell and each configured uplink grant, if configured and
activated, the MAC entity shall:
1> if the PUSCH duration of the configured uplink grant does not overlap with
the PUSCH duration of an uplink grant received on the PDCCH or in a Random
Access Response for this Serving Cell:
2> set the HARQ Process ID to the HARQ Process ID associated with this PUSCH
duration;
2> if the _configuredGrantTimer_ for the corresponding HARQ process is not
running:
3> consider the NDI bit for the corresponding HARQ process to have been
toggled;
3> deliver the configured uplink grant and the associated HARQ information to
the HARQ entity.
For configured uplink grants, the HARQ Process ID associated with the first
symbol of a UL transmission is derived from the following equation:
HARQ Process ID = [floor(CURRENT_symbol/_periodicity_)] modulo _nrofHARQ-
Processes_
where CURRENT_symbol = (SFN × _numberOfSlotsPerFrame_ ×
_numberOfSymbolsPerSlot_ \+ slot number in the frame ×
_numberOfSymbolsPerSlot_ \+ symbol number in the slot), and
_numberOfSlotsPerFrame_ and _numberOfSymbolsPerSlot_ refer to the number of
consecutive slots per frame and the number of consecutive symbols per slot,
respectively as specified in TS 38.211 [8].
NOTE 1: CURRENT_symbol refers to the symbol index of the first transmission
occasion of a bundle of configured uplink grant.
NOTE 2: A HARQ process is configured for a configured uplink grant if the
configured uplink grant is activated and the associated HARQ process ID is
less than _nrofHARQ-Processes_.
NOTE 3: If the MAC entity receives both a grant in a Random Access Response
and an overlapping grant for its C-RNTI or CS-RNTI, requiring concurrent
transmissions on the SpCell, the MAC entity may choose to continue with either
the grant for its RA-RNTI or the grant for its C-RNTI or CS-RNTI.
### 5.4.2 HARQ operation
#### 5.4.2.1 HARQ Entity
The MAC entity includes a HARQ entity for each Serving Cell with configured
uplink (including the case when it is configured with _supplementaryUplink_),
which maintains a number of parallel HARQ processes.
The number of parallel UL HARQ processes per HARQ entity is specified in TS
38.214 [7].
Each HARQ process supports one TB.
Each HARQ process is associated with a HARQ process identifier. For UL
transmission with UL grant in RA Response, HARQ process identifier 0 is used.
For dynamic grant, when the MAC entity is configured with _pusch-
AggregationFactor_ > 1, the parameter _pusch-AggregationFactor_ provides the
number of transmissions of a TB within a bundle. If the MAC entity is
configured with _pusch-AggregationFactor_ > 1, and the initial transmission is
performed within a bundle, at most _pusch-AggregationFactor_ \-- 1 HARQ
retransmissions follow within the bundle after the initial transmission. If
the MAC entity is configured with _pusch-AggregationFactor_ > 1, and the
entire bundle is used for HARQ retransmissions (i.e. a bundle of dynamic UL
grants for retransmission), _pusch-AggregationFactor_ HARQ retransmissions are
performed within the bundle.
For configured grant, when the MAC entity is configured with _repK_ > 1, the
parameter _repK_ provides the number of transmissions of a TB within a bundle.
After the initial transmission, HARQ retransmissions follow within a bundle.
For both dynamic grant and configured uplink grant, bundling operation relies
on the HARQ entity for invoking the same HARQ process for each transmission
that is part of the same bundle:
\- Within a bundle, HARQ retransmissions are triggered without waiting for
feedback from previous transmission according to _pusch-AggregationFactor_ for
a dynamic grant and _repK_ for a configured uplink grant, respectively; and
\- Each transmission within a bundle is a separate uplink grant (when the
first uplink grant within a bundle is delivered to the HARQ entity, all the
subsequent uplink grants within the bundle for HARQ retransmissions are
delivered to the HARQ entity).
For each transmission within a bundle of the dynamic grant, the sequence of
redundancy versions is determined according to clause 6.1.2.1 of TS 38.214
[7]. For each transmission within a bundle of the configured uplink grant, the
sequence of redundancy versions is determined according to clause 6.1.2.3 of
TS 38.214 [7].
For each uplink grant, the HARQ entity shall:
1> identify the HARQ process associated with this grant, and for each
identified HARQ process:
2> if the received grant was not addressed to a Temporary C-RNTI on PDCCH, and
the NDI provided in the associated HARQ information has been toggled compared
to the value in the previous transmission of this TB of this HARQ process; or
2> if the uplink grant was received on PDCCH for the C-RNTI and the HARQ
buffer of the identified process is empty; or
2> if the uplink grant was received in a Random Access Response; or
2> if the uplink grant was received on PDCCH for the C-RNTI in _ra-
ResponseWindow_ and this PDCCH successfully completed the Random Access
procedure initiated for beam failure recovery; or
2> if the uplink grant is part of a bundle of the configured uplink grant, and
may be used for initial transmission according to clause 6.1.2.3 of TS 38.214
[7], and if no MAC PDU has been obtained for this bundle:
3> if there is a MAC PDU in the Msg3 buffer and the uplink grant was received
in a Random Access Response; or:
3> if there is a MAC PDU in the Msg3 buffer and the uplink grant was received
on PDCCH for the C-RNTI in _ra-ResponseWindow_ and this PDCCH successfully
completed the Random Access procedure initiated for beam failure recovery:
4> obtain the MAC PDU to transmit from the Msg3 buffer.
4> if the uplink grant size does not match with size of the obtained MAC PDU;
and
4> if the Random Access procedure was successfully completed upon receiving
the uplink grant:
5> indicate to the Multiplexing and assembly entity to include MAC subPDU(s)
carrying MAC SDU from the obtained MAC PDU in the subsequent uplink
transmission;
5> obtain the MAC PDU to transmit from the Multiplexing and assembly entity.
3> else:
4> obtain the MAC PDU to transmit from the Multiplexing and assembly entity,
if any;
3> if a MAC PDU to transmit has been obtained:
4> deliver the MAC PDU and the uplink grant and the HARQ information of the TB
to the identified HARQ process;
4> instruct the identified HARQ process to trigger a new transmission;
4> if the uplink grant is addressed to CS-RNTI; or
4> if the uplink grant is a configured uplink grant; or
4> if the uplink grant is addressed to C-RNTI, and the identified HARQ process
is configured for a configured uplink grant:
5> start or restart the _configuredGrantTimer_ , if configured, for the
corresponding HARQ process when the transmission is performed.
3> else:
4> flush the HARQ buffer of the identified HARQ process.
2> else (i.e. retransmission):
3> if the uplink grant received on PDCCH was addressed to CS-RNTI and if the
HARQ buffer of the identified process is empty; or
3> if the uplink grant is part of a bundle and if no MAC PDU has been obtained
for this bundle; or
3> if the uplink grant is part of a bundle of the configured uplink grant, and
the PUSCH duration of the uplink grant overlaps with a PUSCH duration of
another uplink grant received on the PDCCH or in a Random Access Response for
this Serving Cell:
4> ignore the uplink grant.
3> else:
4> deliver the uplink grant and the HARQ information (redundancy version) of
the TB to the identified HARQ process;
4> instruct the identified HARQ process to trigger a retransmission;
4> if the uplink grant is addressed to CS-RNTI; or
4> if the uplink grant is addressed to C-RNTI, and the identified HARQ process
is configured for a configured uplink grant:
5> start or restart the _configuredGrantTimer_ , if configured, for the
corresponding HARQ process when the transmission is performed.
When determining if NDI has been toggled compared to the value in the previous
transmission the MAC entity shall ignore NDI received in all uplink grants on
PDCCH for its Temporary C-RNTI.
When _configuredGrantTimer_ is started or restarted by a PUSCH transmission,
it shall be started at the beginning of the first symbol of the PUSCH
transmission.
#### 5.4.2.2 HARQ process
Each HARQ process is associated with a HARQ buffer.
New transmissions are performed on the resource and with the MCS indicated on
either PDCCH, Random Access Response, or RRC. Retransmissions are performed on
the resource and, if provided, with the MCS indicated on PDCCH, or on the same
resource and with the same MCS as was used for last made transmission attempt
within a bundle.
If the HARQ entity requests a new transmission for a TB, the HARQ process
shall:
1> store the MAC PDU in the associated HARQ buffer;
1> store the uplink grant received from the HARQ entity;
1> generate a transmission as described below.
If the HARQ entity requests a retransmission for a TB, the HARQ process shall:
1> store the uplink grant received from the HARQ entity;
1> generate a transmission as described below.
To generate a transmission for a TB, the HARQ process shall:
1> if the MAC PDU was obtained from the Msg3 buffer; or
1> if there is no measurement gap at the time of the transmission and, in case
of retransmission, the retransmission does not collide with a transmission for
a MAC PDU obtained from the Msg3 buffer:
2> instruct the physical layer to generate a transmission according to the
stored uplink grant.
### 5.4.3 Multiplexing and assembly
#### 5.4.3.1 Logical Channel Prioritization
##### 5.4.3.1.1 General
The Logical Channel Prioritization (LCP) procedure is applied whenever a new
transmission is performed.
RRC controls the scheduling of uplink data by signalling for each logical
channel per MAC entity:
\- _priority_ where an increasing priority value indicates a lower priority
level;
\- _prioritisedBitRate_ which sets the Prioritized Bit Rate (PBR);
\- _bucketSizeDuration_ which sets the Bucket Size Duration (BSD).
RRC additionally controls the LCP procedure by configuring mapping
restrictions for each logical channel:
\- _allowedSCS-List_ which sets the allowed Subcarrier Spacing(s) for
transmission;
\- _maxPUSCH-Duration_ which sets the maximum PUSCH duration allowed for
transmission;
\- _configuredGrantType1Allowed_ which sets whether a configured grant Type 1
can be used for transmission;
\- _allowedServingCells_ which sets the allowed cell(s) for transmission.
The following UE variable is used for the Logical channel prioritization
procedure:
\- _Bj_ which is maintained for each logical channel _j_.
The MAC entity shall initialize _Bj_ of the logical channel to zero when the
logical channel is established.
For each logical channel _j_ , the MAC entity shall:
1> increment _Bj_ by the product PBR × T before every instance of the LCP
procedure, where T is the time elapsed since _Bj_ was last incremented;
1> if the value of _Bj_ is greater than the bucket size (i.e. PBR × BSD):
2> set _Bj_ to the bucket size.
NOTE: The exact moment(s) when the UE updates _Bj_ between LCP procedures is
up to UE implementation, as long as _Bj_ is up to date at the time when a
grant is processed by LCP.
##### 5.4.3.1.2 Selection of logical channels
The MAC entity shall, when a new transmission is performed:
1> select the logical channels for each UL grant that satisfy all the
following conditions:
2> the set of allowed Subcarrier Spacing index values in _allowedSCS-List_ ,
if configured, includes the Subcarrier Spacing index associated to the UL
grant; and
2> _maxPUSCH-Duration_ , if configured, is larger than or equal to the PUSCH
transmission duration associated to the UL grant; and
2> _configuredGrantType1Allowed_ , if configured, is set to _true_ in case the
UL grant is a Configured Grant Type 1; and
2> _allowedServingCells_ , if configured, includes the Cell information
associated to the UL grant. Does not apply to logical channels associated with
a DRB configured with PDCP duplication within the same MAC entity (i.e. CA
duplication) for which PDCP duplication is deactivated.
NOTE: The Subcarrier Spacing index, PUSCH transmission duration and Cell
information are included in Uplink transmission information received from
lower layers for the corresponding scheduled uplink transmission.
##### 5.4.3.1.3 Allocation of resources
The MAC entity shall, when a new transmission is performed:
1> allocate resources to the logical channels as follows:
2> logical channels selected in clause 5.4.3.1.2 for the UL grant with _Bj_ >
0 are allocated resources in a decreasing priority order. If the PBR of a
logical channel is set to _infinity_ , the MAC entity shall allocate resources
for all the data that is available for transmission on the logical channel
before meeting the PBR of the lower priority logical channel(s);
2> decrement _Bj_ by the total size of MAC SDUs served to logical channel _j_
above;
2> if any resources remain, all the logical channels selected in clause
5.4.3.1.2 are served in a strict decreasing priority order (regardless of the
value of _Bj_) until either the data for that logical channel or the UL grant
is exhausted, whichever comes first. Logical channels configured with equal
priority should be served equally.
NOTE: The value of _Bj_ can be negative.
If the MAC entity is requested to simultaneously transmit multiple MAC PDUs,
or if the MAC entity receives the multiple UL grants within one or more
coinciding PDCCH occasions (i.e. on different Serving Cells), it is up to UE
implementation in which order the grants are processed.
The UE shall also follow the rules below during the scheduling procedures
above:
\- the UE should not segment an RLC SDU (or partially transmitted SDU or
retransmitted RLC PDU) if the whole SDU (or partially transmitted SDU or
retransmitted RLC PDU) fits into the remaining resources of the associated MAC
entity;
\- if the UE segments an RLC SDU from the logical channel, it shall maximize
the size of the segment to fill the grant of the associated MAC entity as much
as possible;
\- the UE should maximise the transmission of data;
\- if the MAC entity is given a UL grant size that is equal to or larger than
8 bytes while having data available and allowed (according to clause 5.4.3.1)
for transmission, the MAC entity shall not transmit only padding BSR and/or
padding.
The MAC entity shall not generate a MAC PDU for the HARQ entity if the
following conditions are satisfied:
\- the MAC entity is configured with _skipUplinkTxDynamic_ with value _true_
and the grant indicated to the HARQ entity was addressed to a C-RNTI, or the
grant indicated to the HARQ entity is a configured uplink grant; and
\- there is no aperiodic CSI requested for this PUSCH transmission as
specified in TS 38.212 [9]; and
\- the MAC PDU includes zero MAC SDUs; and
\- the MAC PDU includes only the periodic BSR and there is no data available
for any LCG, or the MAC PDU includes only the padding BSR.
Logical channels shall be prioritised in accordance with the following order
(highest priority listed first):
\- C-RNTI MAC CE or data from UL-CCCH;
\- Configured Grant Confirmation MAC CE;
\- MAC CE for BSR, with exception of BSR included for padding;
\- Single Entry PHR MAC CE or Multiple Entry PHR MAC CE;
\- data from any Logical Channel, except data from UL-CCCH;
\- MAC CE for Recommended bit rate query;
\- MAC CE for BSR included for padding.
#### 5.4.3.2 Multiplexing of MAC Control Elements and MAC SDUs
The MAC entity shall multiplex MAC CEs and MAC SDUs in a MAC PDU according to
clauses 5.4.3.1 and 6.1.2.
### 5.4.4 Scheduling Request
The Scheduling Request (SR) is used for requesting UL-SCH resources for new
transmission.
The MAC entity may be configured with zero, one, or more SR configurations. An
SR configuration consists of a set of PUCCH resources for SR across different
BWPs and cells. For a logical channel, at most one PUCCH resource for SR is
configured per BWP.
Each SR configuration corresponds to one or more logical channels. Each
logical channel may be mapped to zero or one SR configuration, which is
configured by RRC. The SR configuration of the logical channel that triggered
the BSR (clause 5.4.5) (if such a configuration exists) is considered as
corresponding SR configuration for the triggered SR.
RRC configures the following parameters for the scheduling request procedure:
\- _sr-ProhibitTimer_ (per SR configuration);
\- _sr-TransMax_ (per SR configuration).
The following UE variables are used for the scheduling request procedure:
\- _SR_COUNTER_ (per SR configuration).
If an SR is triggered and there are no other SRs pending corresponding to the
same SR configuration, the MAC entity shall set the _SR_COUNTER_ of the
corresponding SR configuration to 0.
When an SR is triggered, it shall be considered as pending until it is
cancelled. All pending SR(s) triggered prior to the MAC PDU assembly shall be
cancelled and each respective _sr-ProhibitTimer_ shall be stopped when the MAC
PDU is transmitted and this PDU includes a Long or Short BSR MAC CE which
contains buffer status up to (and including) the last event that triggered a
BSR (see clause 5.4.5) prior to the MAC PDU assembly. All pending SR(s) shall
be cancelled and each respective _sr-ProhibitTimer_ shall be stopped when the
UL grant(s) can accommodate all pending data available for transmission.
Only PUCCH resources on a BWP which is active at the time of SR transmission
occasion are considered valid.
As long as at least one SR is pending, the MAC entity shall for each pending
SR:
1> if the MAC entity has no valid PUCCH resource configured for the pending
SR:
2> initiate a Random Access procedure (see clause 5.1) on the SpCell and
cancel the pending SR.
1> else, for the SR configuration corresponding to the pending SR:
2> when the MAC entity has an SR transmission occasion on the valid PUCCH
resource for SR configured; and
2> if _sr-ProhibitTimer_ is not running at the time of the SR transmission
occasion; and
2> if the PUCCH resource for the SR transmission occasion does not overlap
with a measurement gap; and
2> if the PUCCH resource for the SR transmission occasion does not overlap
with a UL-SCH resource:
3> if _SR_COUNTER_ \ increment _SR_COUNTER_ by 1;
4> instruct the physical layer to signal the SR on one valid PUCCH resource
for SR;
4> start the _sr-ProhibitTimer_.
3> else:
4> notify RRC to release PUCCH for all Serving Cells;
4> notify RRC to release SRS for all Serving Cells;
4> clear any configured downlink assignments and uplink grants;
4> clear any PUSCH resources for semi-persistent CSI reporting;
4> initiate a Random Access procedure (see clause 5.1) on the SpCell and
cancel all pending SRs.
NOTE 1: The selection of which valid PUCCH resource for SR to signal SR on
when the MAC entity has more than one overlapping valid PUCCH resource for the
SR transmission occasion is left to UE implementation.
NOTE 2: If more than one individual SR triggers an instruction from the MAC
entity to the PHY layer to signal the SR on the same valid PUCCH resource, the
SR_COUNTER for the relevant SR configuration is incremented only once.
The MAC entity may stop, if any, ongoing Random Access procedure due to a
pending SR which has no valid PUCCH resources configured, which was initiated
by MAC entity prior to the MAC PDU assembly. Such a Random Access procedure
may be stopped when the MAC PDU is transmitted using a UL grant other than a
UL grant provided by Random Access Response, and this PDU includes a BSR MAC
CE which contains buffer status up to (and including) the last event that
triggered a BSR (see clause 5.4.5) prior to the MAC PDU assembly, or when the
UL grant(s) can accommodate all pending data available for transmission.
### 5.4.5 Buffer Status Reporting
The Buffer Status reporting (BSR) procedure is used to provide the serving gNB
with information about UL data volume in the MAC entity.
RRC configures the following parameters to control the BSR:
\- _periodicBSR-Timer_ ;
\- _retxBSR-Timer_ ;
\- _logicalChannelSR-DelayTimerApplied_ ;
\- _logicalChannelSR-DelayTimer_ ;
\- _logicalChannelSR-Mask_ ;
\- _logicalChannelGroup_.
Each logical channel may be allocated to an LCG using the
_logicalChannelGroup_. The maximum number of LCGs is eight.
The MAC entity determines the amount of UL data available for a logical
channel according to the data volume calculation procedure in TSs 38.322 [3]
and 38.323 [4].
A BSR shall be triggered if any of the following events occur:
\- UL data, for a logical channel which belongs to an LCG, becomes available
to the MAC entity; and either
\- this UL data belongs to a logical channel with higher priority than the
priority of any logical channel containing available UL data which belong to
any LCG; or
\- none of the logical channels which belong to an LCG contains any available
UL data.
in which case the BSR is referred below to as \'Regular BSR\';
\- UL resources are allocated and number of padding bits is equal to or larger
than the size of the Buffer Status Report MAC CE plus its subheader, in which
case the BSR is referred below to as \'Padding BSR\';
\- _retxBSR-Timer_ expires, and at least one of the logical channels which
belong to an LCG contains UL data, in which case the BSR is referred below to
as \'Regular BSR\';
\- _periodicBSR-Timer_ expires, in which case the BSR is referred below to as
\'Periodic BSR\'.
NOTE: When Regular BSR triggering events occur for multiple logical channels
simultaneously, each logical channel triggers one separate Regular BSR.
For Regular BSR, the MAC entity shall:
1> if the BSR is triggered for a logical channel for which _logicalChannelSR-
DelayTimerApplied_ with value _true_ is configured by upper layers:
2> start or restart the _logicalChannelSR-DelayTimer_.
1> else:
2> if running, stop the _logicalChannelSR-DelayTimer_.
For Regular and Periodic BSR, the MAC entity shall:
1> if more than one LCG has data available for transmission when the MAC PDU
containing the BSR is to be built:
2> report Long BSR for all LCGs which have data available for transmission.
1> else:
2> report Short BSR.
For Padding BSR, the MAC entity shall:
1> if the number of padding bits is equal to or larger than the size of the
Short BSR plus its subheader but smaller than the size of the Long BSR plus
its subheader:
2> if more than one LCG has data available for transmission when the BSR is to
be built:
3> if the number of padding bits is equal to the size of the Short BSR plus
its subheader:
4> report Short Truncated BSR of the LCG with the highest priority logical
channel with data available for transmission.
3> else:
4> report Long Truncated BSR of the LCG(s) with the logical channels having
data available for transmission following a decreasing order of the highest
priority logical channel (with or without data available for transmission) in
each of these LCG(s), and in case of equal priority, in increasing order of
LCGID.
2> else:
3> report Short BSR.
1> else if the number of padding bits is equal to or larger than the size of
the Long BSR plus its subheader:
2> report Long BSR for all LCGs which have data available for transmission.
For BSR triggered by _retxBSR-Timer_ expiry, the MAC entity considers that the
logical channel that triggered the BSR is the highest priority logical channel
that has data available for transmission at the time the BSR is triggered.
The MAC entity shall:
1> if the Buffer Status reporting procedure determines that at least one BSR
has been triggered and not cancelled:
2> if UL-SCH resources are available for a new transmission and the UL-SCH
resources can accommodate the BSR MAC CE plus its subheader as a result of
logical channel prioritization:
3> instruct the Multiplexing and Assembly procedure to generate the BSR MAC
CE(s);
3> start or restart _periodicBSR-Timer_ except when all the generated BSRs are
long or short Truncated BSRs;
3> start or restart _retxBSR-Timer_.
2> if a Regular BSR has been triggered and _logicalChannelSR-DelayTimer_ is
not running:
3> if there is no UL-SCH resource available for a new transmission; or
3> if the MAC entity is configured with configured uplink grant(s) and the
Regular BSR was triggered for a logical channel for which _logicalChannelSR-
Mask_ is set to _false_ ; or
3> if the UL-SCH resources available for a new transmission do not meet the
LCP mapping restrictions (see clause 5.4.3.1) configured for the logical
channel that triggered the BSR:
4> trigger a Scheduling Request.
NOTE: UL-SCH resources are considered available if the MAC entity has an
active configuration for either type of configured uplink grants, or if the
MAC entity has received a dynamic uplink grant, or if both of these conditions
are met. If the MAC entity has determined at a given point in time that UL-SCH
resources are available, this need not imply that UL-SCH resources are
available for use at that point in time.
A MAC PDU shall contain at most one BSR MAC CE, even when multiple events have
triggered a BSR. The Regular BSR and the Periodic BSR shall have precedence
over the padding BSR.
The MAC entity shall restart _retxBSR-Timer_ upon reception of a grant for
transmission of new data on any UL-SCH.
All triggered BSRs may be cancelled when the UL grant(s) can accommodate all
pending data available for transmission but is not sufficient to additionally
accommodate the BSR MAC CE plus its subheader. All BSRs triggered prior to MAC
PDU assembly shall be cancelled when a MAC PDU is transmitted and this PDU
includes a Long or Short BSR MAC CE which contains buffer status up to (and
including) the last event that triggered a BSR prior to the MAC PDU assembly.
NOTE: MAC PDU assembly can happen at any point in time between uplink grant
reception and actual transmission of the corresponding MAC PDU. BSR and SR can
be triggered after the assembly of a MAC PDU which contains a BSR MAC CE, but
before the transmission of this MAC PDU. In addition, BSR and SR can be
triggered during MAC PDU assembly.
### 5.4.6 Power Headroom Reporting
The Power Headroom reporting procedure is used to provide the serving gNB with
the following information:
\- Type 1 power headroom: the difference between the nominal UE maximum
transmit power and the estimated power for UL-SCH transmission per activated
Serving Cell;
\- Type 2 power headroom: the difference between the nominal UE maximum
transmit power and the estimated power for UL-SCH and PUCCH transmission on
SpCell of the other MAC entity (i.e. E-UTRA MAC entity in EN-DC, NE-DC, and
NGEN-DC cases);
\- Type 3 power headroom: the difference between the nominal UE maximum
transmit power and the estimated power for SRS transmission per activated
Serving Cell.
RRC controls Power Headroom reporting by configuring the following parameters:
\- _phr-PeriodicTimer_ ;
\- _phr-ProhibitTimer_ ;
\- _phr-Tx-PowerFactorChange_ ;
\- _phr-Type2OtherCell_ ;
\- _phr-ModeOtherCG_ ;
\- _multiplePHR_.
A Power Headroom Report (PHR) shall be triggered if any of the following
events occur:
\- _phr-ProhibitTimer_ expires or has expired and the path loss has changed
more than _phr-Tx-PowerFactorChange_ dB for at least one activated Serving
Cell of any MAC entity which is used as a pathloss reference since the last
transmission of a PHR in this MAC entity when the MAC entity has UL resources
for new transmission;
NOTE 1: The path loss variation for one cell assessed above is between the
pathloss measured at present time on the current pathloss reference and the
pathloss measured at the transmission time of the last transmission of PHR on
the pathloss reference in use at that time, irrespective of whether the
pathloss reference has changed in between.
\- _phr-PeriodicTimer_ expires;
\- upon configuration or reconfiguration of the power headroom reporting
functionality by upper layers, which is not used to disable the function;
\- activation of an SCell of any MAC entity with configured uplink;
\- addition of the PSCell (i.e. PSCell is newly added or changed);
\- _phr-ProhibitTimer_ expires or has expired, when the MAC entity has UL
resources for new transmission, and the following is true for any of the
activated Serving Cells of any MAC entity with configured uplink:
\- there are UL resources allocated for transmission or there is a PUCCH
transmission on this cell, and the required power backoff due to power
management (as allowed by P-MPR~c~ as specified in TS 38.101-1 [14], TS
38.101-2 [15], and TS 38.101-3 [16]) for this cell has changed more than _phr-
Tx-PowerFactorChange_ dB since the last transmission of a PHR when the MAC
entity had UL resources allocated for transmission or PUCCH transmission on
this cell.
NOTE 2: The MAC entity should avoid triggering a PHR when the required power
backoff due to power management decreases only temporarily (e.g. for up to a
few tens of milliseconds) and it should avoid reflecting such temporary
decrease in the values of P~CMAX,f,c~/PH when a PHR is triggered by other
triggering conditions.
If the MAC entity has UL resources allocated for a new transmission the MAC
entity shall:
1> if it is the first UL resource allocated for a new transmission since the
last MAC reset:
2> start _phr-PeriodicTimer_.
1> if the Power Headroom reporting procedure determines that at least one PHR
has been triggered and not cancelled; and
1> if the allocated UL resources can accommodate the MAC CE for PHR which the
MAC entity is configured to transmit, plus its subheader, as a result of LCP
as defined in clause 5.4.3.1:
2> if _multiplePHR_ with value _true_ is configured:
3> for each activated Serving Cell with configured uplink associated with any
MAC entity:
4> obtain the value of the Type 1 or Type 3 power headroom for the
corresponding uplink carrier as specified in clause 7.7 of TS 38.213 [6] for
NR Serving Cell and clause 5.1.1.2 of TS 36.213 [17] for E-UTRA Serving Cell;
4> if this MAC entity has UL resources allocated for transmission on this
Serving Cell; or
4> if the other MAC entity, if configured, has UL resources allocated for
transmission on this Serving Cell and _phr-ModeOtherCG_ is set to _real_ by
upper layers:
5> obtain the value for the corresponding P~CMAX,f,c~ field from the physical
layer.
3> if _phr-Type2OtherCell_ with value _true_ is configured:
4> if the other MAC entity is E-UTRA MAC entity:
5> obtain the value of the Type 2 power headroom for the SpCell of the other
MAC entity (i.e. E-UTRA MAC entity);
5> if _phr-ModeOtherCG_ is set to _real_ by upper layers:
6> obtain the value for the corresponding P~CMAX,f,c~ field for the SpCell of
the other MAC entity (i.e. E-UTRA MAC entity) from the physical layer.
3> instruct the Multiplexing and Assembly procedure to generate and transmit
the Multiple Entry PHR MAC CE as defined in clause 6.1.3.9 based on the values
reported by the physical layer.
2> else (i.e. Single Entry PHR format is used):
3> obtain the value of the Type 1 power headroom from the physical layer for
the corresponding uplink carrier of the PCell;
3> obtain the value for the corresponding P~CMAX,f,c~ field from the physical
layer;
3> instruct the Multiplexing and Assembly procedure to generate and transmit
the Single Entry PHR MAC CE as defined in clause 6.1.3.8 based on the values
reported by the physical layer.
2> start or restart _phr-PeriodicTimer_ ;
2> start or restart _phr-ProhibitTimer_ ;
2> cancel all triggered PHR(s).
## 5.5 PCH reception
When the MAC entity needs to receive PCH, the MAC entity shall:
1> if a PCH assignment has been received on the PDCCH for the P-RNTI:
2> attempt to decode the TB on the PCH as indicated by the PDCCH information;
2> if the TB on the PCH has been successfully decoded:
3> deliver the decoded MAC PDU to upper layers.
## 5.6 BCH reception
When the MAC entity needs to receive BCH, the MAC entity shall:
1> receive and attempt to decode the BCH;
1> if a TB on the BCH has been successfully decoded:
2> deliver the decoded MAC PDU to upper layers.
## 5.7 Discontinuous Reception (DRX)
The MAC entity may be configured by RRC with a DRX functionality that controls
the UE\'s PDCCH monitoring activity for the MAC entity\'s C-RNTI, CS-RNTI,
INT-RNTI, SFI-RNTI, SP-CSI-RNTI, TPC-PUCCH-RNTI, TPC-PUSCH-RNTI, and TPC-SRS-
RNTI. When using DRX operation, the MAC entity shall also monitor PDCCH
according to requirements found in other clauses of this specification. When
in RRC_CONNECTED, if DRX is configured, for all the activated Serving Cells,
the MAC entity may monitor the PDCCH discontinuously using the DRX operation
specified in this clause; otherwise the MAC entity shall monitor the PDCCH as
specified in TS 38.213 [6].
RRC controls DRX operation by configuring the following parameters:
\- _drx-onDurationTimer_ : the duration at the beginning of a DRX Cycle;
\- _drx-SlotOffset_ : the delay before starting the _drx-onDurationTimer_ ;
\- _drx-InactivityTimer_ : the duration after the PDCCH occasion in which a
PDCCH indicates a new UL or DL transmission for the MAC entity;
\- _drx-RetransmissionTimerDL_ (per DL HARQ process except for the broadcast
process): the maximum duration until a DL retransmission is received;
\- _drx-RetransmissionTimerUL_ (per UL HARQ process): the maximum duration
until a grant for UL retransmission is received;
\- _drx-LongCycleStartOffset_ : the Long DRX cycle and _drx-StartOffset_ which
defines the subframe where the Long and Short DRX Cycle starts;
\- _drx-ShortCycle_ (optional): the Short DRX cycle;
\- _drx-ShortCycleTimer_ (optional): the duration the UE shall follow the
Short DRX cycle;
\- _drx-HARQ-RTT-TimerDL_ (per DL HARQ process except for the broadcast
process): the minimum duration before a DL assignment for HARQ retransmission
is expected by the MAC entity;
\- _drx-HARQ-RTT-TimerUL_ (per UL HARQ process): the minimum duration before a
UL HARQ retransmission grant is expected by the MAC entity.
When DRX is configured, the Active Time includes the time while:
\- _drx-onDurationTimer_ or _drx-InactivityTimer_ or _drx-
RetransmissionTimerDL_ or _drx-RetransmissionTimerUL_ or _ra-
ContentionResolutionTimer_ (as described in clause 5.1.5) is running; or
\- a Scheduling Request is sent on PUCCH and is pending (as described in
clause 5.4.4); or
\- a PDCCH indicating a new transmission addressed to the C-RNTI of the MAC
entity has not been received after successful reception of a Random Access
Response for the Random Access Preamble not selected by the MAC entity among
the contention-based Random Access Preamble (as described in clause 5.1.4).
When DRX is configured, the MAC entity shall:
1> if a MAC PDU is received in a configured downlink assignment:
2> start the _drx-HARQ-RTT-TimerDL_ for the corresponding HARQ process in the
first symbol after the end of the corresponding transmission carrying the DL
HARQ feedback;
2> stop the _drx-RetransmissionTimerDL_ for the corresponding HARQ process.
1> if a MAC PDU is transmitted in a configured uplink grant:
2> start the _drx-HARQ-RTT-TimerUL_ for the corresponding HARQ process in the
first symbol after the end of the first transmission (within a bundle) of the
corresponding PUSCH transmission;
2> stop the _drx-RetransmissionTimerUL_ for the corresponding HARQ process.
1> if a _drx-HARQ-RTT-TimerDL_ expires:
2> if the data of the corresponding HARQ process was not successfully decoded:
3> start the _drx-RetransmissionTimerDL_ for the corresponding HARQ process in
the first symbol after the expiry of _drx-HARQ-RTT-TimerDL_.
1> if a _drx-HARQ-RTT-TimerUL_ expires:
2> start the _drx-RetransmissionTimerUL_ for the corresponding HARQ process in
the first symbol after the expiry of _drx-HARQ-RTT-TimerUL_.
1> if a DRX Command MAC CE or a Long DRX Command MAC CE is received:
2> stop _drx-onDurationTimer_ ;
2> stop _drx-InactivityTimer_.
1> if _drx-InactivityTimer_ expires or a DRX Command MAC CE is received:
2> if the Short DRX cycle is configured:
3> start or restart _drx-ShortCycleTimer_ in the first symbol after the expiry
of _drx-InactivityTimer_ or in the first symbol after the end of DRX Command
MAC CE reception;
3> use the Short DRX Cycle.
2> else:
3> use the Long DRX cycle.
1> if _drx-ShortCycleTimer_ expires:
2> use the Long DRX cycle.
1> if a Long DRX Command MAC CE is received:
2> stop _drx-ShortCycleTimer_ ;
2> use the Long DRX cycle.
1> if the Short DRX Cycle is used, and [(SFN × 10) + subframe number] modulo
(_drx-ShortCycle_) = (_drx-StartOffset_) modulo (_drx-ShortCycle_); or
1> if the Long DRX Cycle is used, and [(SFN × 10) + subframe number] modulo
(_drx-LongCycle_) = _drx-StartOffset_ :
2> start _drx-onDurationTimer_ after _drx-SlotOffset_ from the beginning of
the subframe.
1> if the MAC entity is in Active Time:
2> monitor the PDCCH as specified in TS 38.213 [6];
2> if the PDCCH indicates a DL transmission:
3> start the _drx-HARQ-RTT-TimerDL_ for the corresponding HARQ process in the
first symbol after the end of the corresponding transmission carrying the DL
HARQ feedback;
3> stop the _drx-RetransmissionTimerDL_ for the corresponding HARQ process.
2> if the PDCCH indicates a UL transmission:
3> start the _drx-HARQ-RTT-TimerUL_ for the corresponding HARQ process in the
first symbol after the end of the first transmission (within a bundle) of the
corresponding PUSCH transmission;
3> stop the _drx-RetransmissionTimerUL_ for the corresponding HARQ process.
2> if the PDCCH indicates a new transmission (DL or UL):
3> start or restart _drx-InactivityTimer_ in the first symbol after the end of
the PDCCH reception.
NOTE 1: A PDCCH indicating activation of SPS or configured grant type 2 is
considered to indicate a new transmission.
1> in current symbol n, if the MAC entity would not be in Active Time
considering grants/assignments/DRX Command MAC CE/Long DRX Command MAC CE
received and Scheduling Request sent until 4 ms prior to symbol n when
evaluating all DRX Active Time conditions as specified in this clause:
2> not transmit periodic SRS and semi-persistent SRS defined in TS 38.214 [7];
2> not report CSI on PUCCH and semi-persistent CSI configured on PUSCH.
1> if CSI masking (_csi-Mask_) is setup by upper layers:
2> in current symbol n, if _drx-onDurationTimer_ would not be running
considering grants/assignments/DRX Command MAC CE/Long DRX Command MAC CE
received until 4 ms prior to symbol n when evaluating all DRX Active Time
conditions as specified in this clause:
3> not report CSI on PUCCH.
NOTE 2: If a UE multiplexes a CSI configured on PUCCH with other overlapping
UCI(s) according to the procedure specified in TS 38.213 [6] clause 9.2.5 and
this CSI multiplexed with other UCI(s) would be reported on a PUCCH resource
either outside DRX Active Time or outside the on-duration period if CSI
masking is setup by upper layers, it is up to UE implementation whether to
report this CSI multiplexed with other UCI(s).
Regardless of whether the MAC entity is monitoring PDCCH or not, the MAC
entity transmits HARQ feedback, aperiodic CSI on PUSCH, and aperiodic SRS
defined in TS 38.214 [7] when such is expected.
The MAC entity needs not to monitor the PDCCH if it is not a complete PDCCH
occasion (e.g. the Active Time starts or ends in the middle of a PDCCH
occasion).
## 5.8 Transmission and reception without dynamic scheduling
### 5.8.1 Downlink
Semi-Persistent Scheduling (SPS) is configured by RRC for a Serving Cell per
BWP. Activation and deactivation of the DL SPS are independent among the
Serving Cells.
For the DL SPS, a DL assignment is provided by PDCCH, and stored or cleared
based on L1 signalling indicating SPS activation or deactivation.
RRC configures the following parameters when SPS is configured:
\- _cs-RNTI_ : CS-RNTI for activation, deactivation, and retransmission;
\- _nrofHARQ-Processes_ : the number of configured HARQ processes for SPS;
\- _periodicity_ : periodicity of configured downlink assignment for SPS.
When SPS is released by upper layers, all the corresponding configurations
shall be released.
After a downlink assignment is configured for SPS, the MAC entity shall
consider sequentially that the N^th^ downlink assignment occurs in the slot
for which:
(_numberOfSlotsPerFrame_ × SFN + slot number in the frame) =\
[(_numberOfSlotsPerFrame_ × SFN~start\ time~ + slot~start\ time~) + N ×
_periodicity_ × _numberOfSlotsPerFrame_ / 10] modulo (1024 ×
_numberOfSlotsPerFrame_)
where SFN~start\ time~ and slot~start\ time~ are the SFN and slot,
respectively, of the first transmission of PDSCH where the configured downlink
assignment was (re-)initialised.
### 5.8.2 Uplink
There are two types of transmission without dynamic grant:
\- configured grant Type 1 where an uplink grant is provided by RRC, and
stored as configured uplink grant;
\- configured grant Type 2 where an uplink grant is provided by PDCCH, and
stored or cleared as configured uplink grant based on L1 signalling indicating
configured uplink grant activation or deactivation.
Type 1 and Type 2 are configured by RRC for a Serving Cell per BWP. Multiple
configurations can be active simultaneously only on different Serving Cells.
For Type 2, activation and deactivation are independent among the Serving
Cells. For the same Serving Cell, the MAC entity is configured with either
Type 1 or Type 2.
RRC configures the following parameters when the configured grant Type 1 is
configured:
\- _cs-RNTI_ : CS-RNTI for retransmission;
\- _periodicity_ : periodicity of the configured grant Type 1;
\- _timeDomainOffset_ : Offset of a resource with respect to SFN = 0 in time
domain;
\- _timeDomainAllocation_ : Allocation of configured uplink grant in time
domain which contains _startSymbolAndLength_ (i.e. _SLIV_ in TS 38.214 [7]);
\- _nrofHARQ-Processes_ : the number of HARQ processes for configured grant.
RRC configures the following parameters when the configured grant Type 2 is
configured:
\- _cs-RNTI_ : CS-RNTI for activation, deactivation, and retransmission;
\- _periodicity_ : periodicity of the configured grant Type 2;
\- _nrofHARQ-Processes_ : the number of HARQ processes for configured grant.
Upon configuration of a configured grant Type 1 for a BWP of a Serving Cell by
upper layers, the MAC entity shall:
1> store the uplink grant provided by upper layers as a configured uplink
grant for the indicated BWP of the Serving Cell;
1> initialise or re-initialise the configured uplink grant to start in the
symbol according to _timeDomainOffset_ and _S_ (derived from _SLIV_ as
specified in TS 38.214 [7]), and to reoccur with _periodicity_.
After an uplink grant is configured for a configured grant Type 1, the MAC
entity shall consider that the uplink grant recurs associated with each symbol
for which:
[(SFN × _numberOfSlotsPerFrame_ × _numberOfSymbolsPerSlot_) + (slot number in
the frame × _numberOfSymbolsPerSlot_) + symbol number in the slot] =\
(_timeDomainOffset_ × _numberOfSymbolsPerSlot_ \+ _S_ \+ N × _periodicity_)
modulo (1024 × _numberOfSlotsPerFrame_ × _numberOfSymbolsPerSlot_), for all N
>= 0.
After an uplink grant is configured for a configured grant Type 2, the MAC
entity shall consider that the uplink grant recurs associated with each symbol
for which:
[(SFN × _numberOfSlotsPerFrame_ × _numberOfSymbolsPerSlot_) + (slot number in
the frame × _numberOfSymbolsPerSlot_) + symbol number in the slot] =\
[(SFN~start\ time~ × _numberOfSlotsPerFrame_ × _numberOfSymbolsPerSlot_ \+
slot~start\ time~ × _numberOfSymbolsPerSlot_ \+ symbol~start\ time~) + N ×
_periodicity_] modulo (1024 × _numberOfSlotsPerFrame_ ×
_numberOfSymbolsPerSlot_), for all N >= 0.
where SFN~start\ time~, slot~start\ time~, and symbol~start\ time~ are the
SFN, slot, and symbol, respectively, of the first transmission opportunity of
PUSCH where the configured uplink grant was (re-)initialised.
When a configured uplink grant is released by upper layers, all the
corresponding configurations shall be released and all corresponding uplink
grants shall be cleared.
The MAC entity shall:
1> if the configured uplink grant confirmation has been triggered and not
cancelled; and
1> if the MAC entity has UL resources allocated for new transmission:
2> instruct the Multiplexing and Assembly procedure to generate a Configured
Grant Confirmation MAC CE as defined in clause 6.1.3.7;
2> cancel the triggered configured uplink grant confirmation.
For a configured grant Type 2, the MAC entity shall clear the configured
uplink grant immediately after first transmission of Configured Grant
Confirmation MAC CE triggered by the configured uplink grant deactivation.
Retransmissions except for repetition of configured uplink grants use uplink
grants addressed to CS-RNTI.
## 5.9 Activation/Deactivation of SCells
If the MAC entity is configured with one or more SCells, the network may
activate and deactivate the configured SCells. Upon configuration of an SCell,
the SCell is deactivated.
The configured SCell(s) is activated and deactivated by:
\- receiving the SCell Activation/Deactivation MAC CE described in clause
6.1.3.10;
\- configuring _sCellDeactivationTimer_ timer per configured SCell (except the
SCell configured with PUCCH, if any): the associated SCell is deactivated upon
its expiry.
The MAC entity shall for each configured SCell:
1> if an SCell Activation/Deactivation MAC CE is received activating the
SCell:
2> activate the SCell according to the timing defined in TS 38.213 [6]; i.e.
apply normal SCell operation including:
3> SRS transmissions on the SCell;
3> CSI reporting for the SCell;
3> PDCCH monitoring on the SCell;
3> PDCCH monitoring for the SCell;
3> PUCCH transmissions on the SCell, if configured.
2> if the SCell was deactivated prior to receiving this SCell
Activation/Deactivation MAC CE:
3> activate the DL BWP and UL BWP indicated by _firstActiveDownlinkBWP-Id_ and
_firstActiveUplinkBWP-Id_ respectively;
2> start or restart the _sCellDeactivationTimer_ associated with the SCell
according to the timing defined in TS 38.213 [6];
2> (re-)initialize any suspended configured uplink grants of configured grant
Type 1 associated with this SCell according to the stored configuration, if
any, and to start in the symbol according to rules in clause 5.8.2;
2> trigger PHR according to clause 5.4.6.
1> else if an SCell Activation/Deactivation MAC CE is received deactivating
the SCell; or
1> if the _sCellDeactivationTimer_ associated with the activated SCell
expires:
2> deactivate the SCell according to the timing defined in TS 38.213 [6];
2> stop the _sCellDeactivationTimer_ associated with the SCell;
2> stop the _bwp-InactivityTimer_ associated with the SCell;
2> deactivate any active BWP associated with the SCell;
2> clear any configured downlink assignment and any configured uplink grant
Type 2 associated with the SCell respectively;
2> clear any PUSCH resource for semi-persistent CSI reporting associated with
the SCell;
2> suspend any configured uplink grant Type 1 associated with the SCell;
2> flush all HARQ buffers associated with the SCell.
1> if PDCCH on the activated SCell indicates an uplink grant or downlink
assignment; or
1> if PDCCH on the Serving Cell scheduling the activated SCell indicates an
uplink grant or a downlink assignment for the activated SCell; or
1> if a MAC PDU is transmitted in a configured uplink grant or received in a
configured downlink assignment:
2> restart the _sCellDeactivationTimer_ associated with the SCell.
1> if the SCell is deactivated:
2> not transmit SRS on the SCell;
2> not report CSI for the SCell;
2> not transmit on UL-SCH on the SCell;
2> not transmit on RACH on the SCell;
2> not monitor the PDCCH on the SCell;
2> not monitor the PDCCH for the SCell;
2> not transmit PUCCH on the SCell.
HARQ feedback for the MAC PDU containing SCell Activation/Deactivation MAC CE
shall not be impacted by PCell, PSCell and PUCCH SCell interruptions due to
SCell activation/deactivation in TS 38.133 [11].
When SCell is deactivated, the ongoing Random Access procedure on the SCell,
if any, is aborted.
## 5.10 Activation/Deactivation of PDCP duplication
If one or more DRBs are configured with PDCP duplication, the network may
activate and deactivate the PDCP duplication for the configured DRB(s).
The PDCP duplication for the configured DRB(s) is activated and deactivated
by:
\- receiving the Duplication Activation/Deactivation MAC CE described in
clause 6.1.3.11;
\- indication by RRC.
The MAC entity shall for each DRB configured with PDCP duplication:
1> if a Duplication Activation/Deactivation MAC CE is received activating the
PDCP duplication of the DRB:
2> indicate the activation of PDCP duplication of the DRB to upper layers.
1> if a Duplication Activation/Deactivation MAC CE is received deactivating
the PDCP duplication of the DRB:
2> indicate the deactivation of PDCP duplication of the DRB to upper layers.
## 5.11 MAC reconfiguration
When a reconfiguration of the MAC entity is requested by upper layers, the MAC
entity shall:
1> initialize the corresponding HARQ entity upon addition of an SCell;
1> remove the corresponding HARQ entity upon removal of an SCell;
1> apply the new value for timers when the timer is (re)started;
1> apply the new maximum parameter value when counters are initialized;
1> apply immediately the configurations received from upper layers for other
parameters.
## 5.12 MAC Reset
If a reset of the MAC entity is requested by upper layers, the MAC entity
shall:
1> initialize _Bj_ for each logical channel to zero;
1> stop (if running) all timers;
1> consider all _timeAlignmentTimers_ as expired and perform the corresponding
actions in clause 5.2;
1> set the NDIs for all uplink HARQ processes to the value 0;
1> stop, if any, ongoing Random Access procedure;
1> discard explicitly signalled _contention-free Random Access Resources_ , if
any;
1> flush Msg3 buffer;
1> cancel, if any, triggered Scheduling Request procedure;
1> cancel, if any, triggered Buffer Status Reporting procedure;
1> cancel, if any, triggered Power Headroom Reporting procedure;
1> cancel, if any, triggered Recommended bit rate query procedure;
1> cancel, if any, triggered Configured uplink grant confirmation;
1> flush the soft buffers for all DL HARQ processes;
1> for each DL HARQ process, consider the next received transmission for a TB
as the very first transmission;
1> release, if any, Temporary C-RNTI;
1> reset _BFI_COUNTER_.
## 5.13 Handling of unknown, unforeseen and erroneous protocol data
When a MAC entity receives a MAC PDU for the MAC entity\'s C-RNTI or CS-RNTI,
or by the configured downlink assignment, containing a Reserved LCID value, or
an LCID value the MAC Entity does not support, the MAC entity shall at least:
1> discard the received subPDU and any remaining subPDUs in the MAC PDU.
When a MAC entity receives a MAC PDU for the MAC entity\'s C-RNTI or CS-RNTI,
or by the configured downlink assignment, containing an LCID value which is
not configured, the MAC entity shall at least:
1> discard the received subPDU.
## 5.14 Handling of measurement gaps
During a measurement gap, the MAC entity shall, on the Serving Cell(s) in the
corresponding frequency range of the measurement gap configured by
_measGapConfig_ as specified in TS 38.331 [5]:
1> not perform the transmission of HARQ feedback, SR, and CSI;
1> not report SRS;
1> not transmit on UL-SCH except for Msg3 as specified in clause 5.4.2.2;
1> if the _ra-ResponseWindow_ or the _ra-ContentionResolutionTimer_ is
running:
2> monitor the PDCCH as specified in clauses 5.1.4 and 5.1.5.
1> else:
2> not monitor the PDCCH;
2> not receive on DL-SCH.
## 5.15 Bandwidth Part (BWP) operation
In addition to clause 12 of TS 38.213 [6], this clause specifies requirements
on BWP operation.
A Serving Cell may be configured with one or multiple BWPs, and the maximum
number of BWP per Serving Cell is specified in TS 38.213 [6].
The BWP switching for a Serving Cell is used to activate an inactive BWP and
deactivate an active BWP at a time. The BWP switching is controlled by the
PDCCH indicating a downlink assignment or an uplink grant, by the _bwp-
InactivityTimer_ , by RRC signalling, or by the MAC entity itself upon
initiation of Random Access procedure. Upon RRC (re-)configuration of
_firstActiveDownlinkBWP-Id_ and/or _firstActiveUplinkBWP-Id_ for SpCell or
activation of an SCell, the DL BWP and/or UL BWP indicated by
_firstActiveDownlinkBWP-Id_ and/or _firstActiveUplinkBWP-Id_ respectively (as
specified in TS 38.331 [5]) is active without receiving PDCCH indicating a
downlink assignment or an uplink grant. The active BWP for a Serving Cell is
indicated by either RRC or PDCCH (as specified in TS 38.213 [6]). For unpaired
spectrum, a DL BWP is paired with a UL BWP, and BWP switching is common for
both UL and DL.
For each activated Serving Cell configured with a BWP, the MAC entity shall:
1> if a BWP is activated:
2> transmit on UL-SCH on the BWP;
2> transmit on RACH on the BWP, if PRACH occasions are configured;
2> monitor the PDCCH on the BWP;
2> transmit PUCCH on the BWP, if configured;
2> report CSI for the BWP;
2> transmit SRS on the BWP, if configured;
2> receive DL-SCH on the BWP;
2> (re-)initialize any suspended configured uplink grants of configured grant
Type 1 on the active BWP according to the stored configuration, if any, and to
start in the symbol according to rules in clause 5.8.2.
1> if a BWP is deactivated:
2> not transmit on UL-SCH on the BWP;
2> not transmit on RACH on the BWP;
2> not monitor the PDCCH on the BWP;
2> not transmit PUCCH on the BWP;
2> not report CSI for the BWP;
2> not transmit SRS on the BWP;
2> not receive DL-SCH on the BWP;
2> clear any configured downlink assignment and configured uplink grant of
configured grant Type 2 on the BWP;
2> suspend any configured uplink grant of configured grant Type 1 on the
inactive BWP.
Upon initiation of the Random Access procedure on a Serving Cell, after the
selection of carrier for performing Random Access procedure as specified in
clause 5.1.1, the MAC entity shall for the selected carrier of this Serving
Cell:
1> if PRACH occasions are not configured for the active UL BWP:
2> switch the active UL BWP to BWP indicated by _initialUplinkBWP_ ;
2> if the Serving Cell is an SpCell:
3> switch the active DL BWP to BWP indicated by _initialDownlinkBWP_.
1> else:
2> if the Serving Cell is an SpCell:
3> if the active DL BWP does not have the same _bwp-Id_ as the active UL BWP:
4> switch the active DL BWP to the DL BWP with the same _bwp-Id_ as the active
UL BWP.
1> stop the _bwp-InactivityTimer_ associated with the active DL BWP of this
Serving Cell, if running.
1> if the Serving Cell is SCell:
2> stop the _bwp-InactivityTimer_ associated with the active DL BWP of SpCell,
if running.
1> perform the Random Access procedure on the active DL BWP of SpCell and
active UL BWP of this Serving Cell.
If the MAC entity receives a PDCCH for BWP switching of a Serving Cell, the
MAC entity shall:
1> if there is no ongoing Random Access procedure associated with this Serving
Cell; or
1> if the ongoing Random Access procedure associated with this Serving Cell is
successfully completed upon reception of this PDCCH addressed to C-RNTI (as
specified in clauses 5.1.4 and 5.1.5):
2> perform BWP switching to a BWP indicated by the PDCCH.
If the MAC entity receives a PDCCH for BWP switching for a Serving Cell while
a Random Access procedure associated with that Serving Cell is ongoing in the
MAC entity, it is up to UE implementation whether to switch BWP or ignore the
PDCCH for BWP switching, except for the PDCCH reception for BWP switching
addressed to the C-RNTI for successful Random Access procedure completion (as
specified in clauses 5.1.4 and 5.1.5) in which case the UE shall perform BWP
switching to a BWP indicated by the PDCCH. Upon reception of the PDCCH for BWP
switching other than successful contention resolution, if the MAC entity
decides to perform BWP switching, the MAC entity shall stop the ongoing Random
Access procedure and initiate a Random Access procedure after performing the
BWP switching; if the MAC decides to ignore the PDCCH for BWP switching, the
MAC entity shall continue with the ongoing Random Access procedure on the
Serving Cell.
Upon reception of RRC (re-)configuration for BWP switching for a Serving Cell
while a Random Access procedure associated with that Serving Cell is ongoing
in the MAC entity, the MAC entity shall stop the ongoing Random Access
procedure and initiate a Random Access procedure after performing the BWP
switching.
The MAC entity shall for each activated Serving Cell configured with _bwp-
InactivityTimer_ :
1> if the _defaultDownlinkBWP-Id_ is configured, and the active DL BWP is not
the BWP indicated by the _defaultDownlinkBWP-Id_ ; or
1> if the _defaultDownlinkBWP-Id_ is not configured, and the active DL BWP is
not the _initialDownlinkBWP_ :
2> if a PDCCH addressed to C-RNTI or CS-RNTI indicating downlink assignment or
uplink grant is received on the active BWP; or
2> if a PDCCH addressed to C-RNTI or CS-RNTI indicating downlink assignment or
uplink grant is received for the active BWP; or
2> if a MAC PDU is transmitted in a configured uplink grant or received in a
configured downlink assignment:
3> if there is no ongoing Random Access procedure associated with this Serving
Cell; or
3> if the ongoing Random Access procedure associated with this Serving Cell is
successfully completed upon reception of this PDCCH addressed to C-RNTI (as
specified in clauses 5.1.4 and 5.1.5):
4> start or restart the _bwp-InactivityTimer_ associated with the active DL
BWP.
2> if the _bwp-InactivityTimer_ associated with the active DL BWP expires:
3> if the _defaultDownlinkBWP-Id_ is configured:
4> perform BWP switching to a BWP indicated by the _defaultDownlinkBWP-Id_.
3> else:
4> perform BWP switching to the _initialDownlinkBWP_.
NOTE: If a Random Access procedure is initiated on an SCell, both this SCell
and the SpCell are associated with this Random Access procedure.
1> if a PDCCH for BWP switching is received, and the MAC entity switches the
active DL BWP:
2> if the _defaultDownlinkBWP-Id_ is configured, and the MAC entity switches
to the DL BWP which is not indicated by the _defaultDownlinkBWP-Id_ ; or
2> if the _defaultDownlinkBWP-Id_ is not configured, and the MAC entity
switches to the DL BWP which is not the _initialDownlinkBWP_ :
3> start or restart the _bwp-InactivityTimer_ associated with the active DL
BWP.
## 5.16 SUL operation
The Supplementary UL (SUL) carrier can be configured as a complement to the
normal UL (NUL) carrier. Switching between the NUL carrier and the SUL carrier
means that the UL transmissions move from one carrier to the other carrier,
which is done by:
\- an indication in DCI;
\- the Random Access procedure as specified in clause 5.1.1.
If the MAC entity receives a UL grant indicating an SUL switch while a Random
Access procedure is ongoing, the MAC entity shall ignore the UL grant.
The Serving Cell configured with _supplementaryUplink_ belongs to a single
TAG.
## 5.17 Beam Failure Detection and Recovery procedure
The MAC entity may be configured by RRC with a beam failure recovery procedure
which is used for indicating to the serving gNB of a new SSB or CSI-RS when
beam failure is detected on the serving SSB(s)/CSI-RS(s). Beam failure is
detected by counting beam failure instance indication from the lower layers to
the MAC entity. If _beamFailureRecoveryConfig_ is reconfigured by upper layers
during an ongoing Random Access procedure for beam failure recovery, the MAC
entity shall stop the ongoing Random Access procedure and initiate a Random
Access procedure using the new configuration.
RRC configures the following parameters in the _BeamFailureRecoveryConfig_ and
the _RadioLinkMonitoringConfig_ for the Beam Failure Detection and Recovery
procedure:
\- _beamFailureInstanceMaxCount_ for the beam failure detection;
\- _beamFailureDetectionTimer_ for the beam failure detection;
\- _beamFailureRecoveryTimer_ for the beam failure recovery procedure;
\- _rsrp-ThresholdSSB_ : an RSRP threshold for the beam failure recovery;
\- _powerRampingStep_ : _powerRampingStep_ for the beam failure recovery;
\- _powerRampingStepHighPriority_ : _powerRampingStepHighPriority_ for the
beam failure recovery;
\- _preambleReceivedTargetPower_ : _preambleReceivedTargetPower_ for the beam
failure recovery;
\- _preambleTransMax_ : _preambleTransMax_ for the beam failure recovery;
\- _scalingFactorBI_ : _scalingFactorBI_ for the beam failure recovery;
\- _ssb-perRACH-Occasion_ : _ssb-perRACH-Occasion_ for the beam failure
recovery;
\- _ra-ResponseWindow_ : the time window to monitor response(s) for the beam
failure recovery using contention-free Random Access Preamble;
\- _prach-ConfigurationIndex_ : _prach-ConfigurationIndex_ for the beam
failure recovery;
\- _ra-ssb-OccasionMaskIndex_ : _ra-ssb-OccasionMaskIndex_ for the beam
failure recovery;
\- _ra-OccasionList_ : _ra-OccasionList_ for the beam failure recovery.
The following UE variables are used for the beam failure detection procedure:
\- _BFI_COUNTER_ : counter for beam failure instance indication which is
initially set to 0.
The MAC entity shall:
1> if beam failure instance indication has been received from lower layers:
2> start or restart the _beamFailureDetectionTimer_ ;
2> increment _BFI_COUNTER_ by 1;
2> if _BFI_COUNTER_ >= _beamFailureInstanceMaxCount_ :
3> initiate a Random Access procedure (see clause 5.1) on the SpCell.
1> if the _beamFailureDetectionTimer_ expires; or
1> if _beamFailureDetectionTimer_ , _beamFailureInstanceMaxCount_ , or any of
the reference signals used for beam failure detection is reconfigured by upper
layers:
2> set _BFI_COUNTER_ to 0.
1> if the Random Access procedure is successfully completed (see clause 5.1):
2> set _BFI_COUNTER_ to 0;
2> stop the _beamFailureRecoveryTimer_ , if configured;
2> consider the Beam Failure Recovery procedure successfully completed.
## 5.18 Handling of MAC CEs
### 5.18.1 General
This clause specifies the requirements upon reception of the following MAC
CEs:
\- SP CSI-RS/CSI-IM Resource Set Activation/Deactivation MAC CE;
\- Aperiodic CSI Trigger State Subselection MAC CE;
\- TCI States Activation/Deactivation for UE-specific PDSCH MAC CE;
\- TCI State Indication for UE-specific PDCCH MAC CE;
\- SP CSI reporting on PUCCH Activation/Deactivation MAC CE;
\- SP SRS Activation/Deactivation MAC CE;
\- PUCCH spatial relation Activation/Deactivation MAC CE;
\- SP ZP CSI-RS Resource Set Activation/Deactivation MAC CE;
\- Recommended Bit Rate MAC CE.
### 5.18.2 Activation/Deactivation of Semi-persistent CSI-RS/CSI-IM resource
set
The network may activate and deactivate the configured Semi-persistent CSI-
RS/CSI-IM resource sets of a Serving Cell by sending the SP CSI-RS/CSI-IM
Resource Set Activation/Deactivation MAC CE described in clause 6.1.3.12. The
configured Semi-persistent CSI-RS/CSI-IM resource sets are initially
deactivated upon (re-)configuration by upper layers and after reconfiguration
with sync.
The MAC entity shall:
1> if the MAC entity receives an SP CSI-RS/CSI-IM Resource Set
Activation/Deactivation MAC CE on a Serving Cell:
2> indicate to lower layers the information regarding the SP CSI-RS/CSI-IM
Resource Set Activation/Deactivation MAC CE.
### 5.18.3 Aperiodic CSI Trigger State Subselection
The network may select among the configured aperiodic CSI trigger states of a
Serving Cell by sending the Aperiodic CSI Trigger State Subselection MAC CE
described in clause 6.1.3.13.
The MAC entity shall:
> 1> if the MAC entity receives an Aperiodic CSI trigger State Subselection
> MAC CE on a Serving Cell:
2> indicate to lower layers the information regarding Aperiodic CSI trigger
State Subselection MAC CE.
### 5.18.4 Activation/Deactivation of UE-specific PDSCH TCI state
The network may activate and deactivate the configured TCI states for PDSCH of
a Serving Cell by sending the TCI States Activation/Deactivation for UE-
specific PDSCH MAC CE described in clause 6.1.3.14. The configured TCI states
for PDSCH are initially deactivated upon (re-)configuration by upper layers
and after reconfiguration with sync.
The MAC entity shall:
1> if the MAC entity receives a TCI States Activation/Deactivation for UE-
specific PDSCH MAC CE on a Serving Cell:
2> indicate to lower layers the information regarding the TCI States
Activation/Deactivation for UE-specific PDSCH MAC CE.
### 5.18.5 Indication of TCI state for UE-specific PDCCH
The network may indicate a TCI state for PDCCH reception for a CORESET of a
Serving Cell by sending the TCI State Indication for UE-specific PDCCH MAC CE
described in clause 6.1.3.15.
The MAC entity shall:
1> if the MAC entity receives a TCI State Indication for UE-specific PDCCH MAC
CE on a Serving Cell:
2> indicate to lower layers the information regarding the TCI State Indication
for UE-specific PDCCH MAC CE.
### 5.18.6 Activation/Deactivation of Semi-persistent CSI reporting on PUCCH
The network may activate and deactivate the configured Semi-persistent CSI
reporting on PUCCH of a Serving Cell by sending the SP CSI reporting on PUCCH
Activation/Deactivation MAC CE described in clause 6.1.3.16. The configured
Semi-persistent CSI reporting on PUCCH is initially deactivated upon
(re-)configuration by upper layers and after reconfiguration with sync.
The MAC entity shall:
1> if the MAC entity receives an SP CSI reporting on PUCCH
Activation/Deactivation MAC CE on a Serving Cell:
2> indicate to lower layers the information regarding the SP CSI reporting on
PUCCH Activation/Deactivation MAC CE.
### 5.18.7 Activation/Deactivation of Semi-persistent SRS
The network may activate and deactivate the configured Semi-persistent SRS
resource sets of a Serving Cell by sending the SP SRS Activation/Deactivation
MAC CE described in clause 6.1.3.17. The configured Semi-persistent SRS
resource sets are initially deactivated upon (re-)configuration by upper
layers and after reconfiguration with sync.
The MAC entity shall:
1> if the MAC entity receives an SP SRS Activation/Deactivation MAC CE on a
Serving Cell:
2> indicate to lower layers the information regarding the SP SRS
Activation/Deactivation MAC CE.
### 5.18.8 Activation/Deactivation of spatial relation of PUCCH resource
The network may activate and deactivate a spatial relation for a PUCCH
resource of a Serving Cell by sending the PUCCH spatial relation
Activation/Deactivation MAC CE described in clause 6.1.3.18. The configured
spatial relation for a PUCCH resource is initially deactivated upon
(re-)configuration by upper layers and after reconfiguration with sync.
The MAC entity shall:
1> if the MAC entity receives a PUCCH spatial relation Activation/Deactivation
MAC CE on a Serving Cell:
2> indicate to lower layers the information regarding the PUCCH spatial
relation Activation/Deactivation MAC CE.
### 5.18.9 Activation/Deactivation of semi-persistent ZP CSI-RS resource set
The network may activate and deactivate the configured Semi-persistent ZP CSI-
RS resource set of a Serving Cell by sending the SP ZP CSI-RS Resource Set
Activation/Deactivation MAC CE described in clause 6.1.3.19. The configured
Semi-persistent ZP CSI-RS resource sets are initially deactivated upon
(re-)configuration by upper layers and after reconfiguration with sync.
The MAC entity shall:
1> if the MAC entity receives an SP ZP CSI-RS Resource Set
Activation/Deactivation MAC CE on a Serving Cell:
2> indicate to lower layers the information regarding the SP ZP CSI-RS
Resource Set Activation/Deactivation MAC CE.
### 5.18.10 Recommended Bit Rate
The recommended bit rate procedure is used to provide the MAC entity with
information about the bit rate which the gNB recommends. The bit rate is the
recommended bit rate of the physical layer. Averaging window of default value
2000 ms will apply as specified in TS 26.114 [13].
The gNB may transmit the Recommended bit rate MAC CE to the MAC entity to
indicate the recommended bit rate for the UE for a specific logical channel
and a specific direction (either uplink or downlink). Upon reception of a
Recommended bit rate MAC CE the MAC entity shall:
\- indicate to upper layers the recommended bit rate for the indicated logical
channel and direction.
The MAC entity may request the gNB to indicate the recommended bit rate for a
specific logical channel and a specific direction. If the MAC entity is
requested by upper layers to query the gNB for the recommended bit rate for a
logical channel and for a direction (i.e. for uplink or downlink), the MAC
entity shall:
1> if a Recommended bit rate query for this logical channel and this direction
has not been triggered:
2> trigger a Recommended bit rate query for this logical channel, direction,
and desired bit rate.
If the MAC entity has UL resources allocated for new transmission the MAC
entity shall:
1> for each Recommended bit rate query that the Recommended Bit Rate procedure
determines has been triggered and not cancelled:
2> if _bitRateQueryProhibitTimer_ for the logical channel and the direction of
this Recommended bit rate query is configured, and it is not running; and
2> if the MAC entity has UL resources allocated for new transmission and the
allocated UL resources can accommodate a Recommended bit rate MAC CE plus its
subheader as a result of LCP as defined in clause 5.4.3.1:
3> instruct the Multiplexing and Assembly procedure to generate the
Recommended bit rate MAC CE for the logical channel and the direction of this
Recommended bit rate query;
3> start the _bitRateQueryProhibitTimer_ for the logical channel and the
direction of this Recommended bit rate query;
3> cancel this Recommended bit rate query.
## 5.19 Data inactivity monitoring
The UE may be configured by RRC with a Data inactivity monitoring
functionality, when in RRC_CONNECTED. RRC controls Data inactivity operation
by configuring the timer _dataInactivityTimer_.
When _dataInactivityTimer_ is configured, the UE shall:
1> if any MAC entity receives a MAC SDU for DTCH logical channel, DCCH logical
channel, or CCCH logical channel; or
1> if any MAC entity transmits a MAC SDU for DTCH logical channel, or DCCH
logical channel:
2> start or restart _dataInactivityTimer_.
1> if the _dataInactivityTimer_ expires:
2> indicate the expiry of the _dataInactivityTimer_ to upper layers.
# 6 Protocol Data Units, formats and parameters
## 6.1 Protocol Data Units
### 6.1.1 General
A MAC PDU is a bit string that is byte aligned (i.e. multiple of 8 bits) in
length. In the figures in clause 6, bit strings are represented by tables in
which the most significant bit is the leftmost bit of the first line of the
table, the least significant bit is the rightmost bit on the last line of the
table, and more generally the bit string is to be read from left to right and
then in the reading order of the lines. The bit order of each parameter field
within a MAC PDU is represented with the first and most significant bit in the
leftmost bit and the last and least significant bit in the rightmost bit.
A MAC SDU is a bit string that is byte aligned (i.e. multiple of 8 bits) in
length. A MAC SDU is included into a MAC PDU from the first bit onward.
A MAC CE is a bit string that is byte aligned (i.e. multiple of 8 bits) in
length.
A MAC subheader is a bit string that is byte aligned (i.e. multiple of 8 bits)
in length. Each MAC subheader is placed immediately in front of the
corresponding MAC SDU, MAC CE, or padding.
The MAC entity shall ignore the value of the Reserved bits in downlink MAC
PDUs.
### 6.1.2 MAC PDU (DL-SCH and UL-SCH except transparent MAC and Random Access
Response)
A MAC PDU consists of one or more MAC subPDUs. Each MAC subPDU consists of one
of the following:
\- A MAC subheader only (including padding);
\- A MAC subheader and a MAC SDU;
\- A MAC subheader and a MAC CE;
\- A MAC subheader and padding.
The MAC SDUs are of variable sizes.
Each MAC subheader corresponds to either a MAC SDU, a MAC CE, or padding.
A MAC subheader except for fixed sized MAC CE, padding, and a MAC SDU
containing UL CCCH consists of the four header fields R/F/LCID/L. A MAC
subheader for fixed sized MAC CE, padding, and a MAC SDU containing UL CCCH
consists of the two header fields R/LCID.
Figure 6.1.2-1: R/F/LCID/L MAC subheader with 8-bit L field
Figure 6.1.2-2: R/F/LCID/L MAC subheader with 16-bit L field
Figure 6.1.2-3: R/LCID MAC subheader
MAC CEs are placed together. DL MAC subPDU(s) with MAC CE(s) is placed before
any MAC subPDU with MAC SDU and MAC subPDU with padding as depicted in Figure
6.1.2-4. UL MAC subPDU(s) with MAC CE(s) is placed after all the MAC subPDU(s)
with MAC SDU and before the MAC subPDU with padding in the MAC PDU as depicted
in Figure 6.1.2-5. The size of padding can be zero.
Figure 6.1.2-4: Example of a DL MAC PDU
Figure 6.1.2-5: Example of a UL MAC PDU
A maximum of one MAC PDU can be transmitted per TB per MAC entity.
### 6.1.3 MAC Control Elements (CEs)
#### 6.1.3.1 Buffer Status Report MAC CEs
Buffer Status Report (BSR) MAC CEs consist of either:
\- Short BSR format (fixed size); or
\- Long BSR format (variable size); or
\- Short Truncated BSR format (fixed size); or
\- Long Truncated BSR format (variable size).
The BSR formats are identified by MAC subheaders with LCIDs as specified in
Table 6.2.1-2.
The fields in the BSR MAC CE are defined as follows:
\- LCG ID: The Logical Channel Group ID field identifies the group of logical
channel(s) whose buffer status is being reported. The length of the field is 3
bits;
\- LCG~i~: For the Long BSR format, this field indicates the presence of the
Buffer Size field for the logical channel group i. The LCG~i~ field set to 1
indicates that the Buffer Size field for the logical channel group i is
reported. The LCG~i~ field set to 0 indicates that the Buffer Size field for
the logical channel group i is not reported. For the Long Truncated BSR
format, this field indicates whether logical channel group i has data
available. The LCG~i~ field set to 1 indicates that logical channel group i
has data available. The LCG~i~ field set to 0 indicates that logical channel
group i does not have data available;
\- Buffer Size: The Buffer Size field identifies the total amount of data
available according to the data volume calculation procedure in TSs 38.322 [3]
and 38.323 [4] across all logical channels of a logical channel group after
the MAC PDU has been built (i.e. after the logical channel prioritization
procedure, which may result the value of the Buffer Size field to zero). The
amount of data is indicated in number of bytes. The size of the RLC headers
and MAC subheaders are not considered in the buffer size computation. The
length of this field for the Short BSR format and the Short Truncated BSR
format is 5 bits. The length of this field for the Long BSR format and the
Long Truncated BSR format is 8 bits. The values for the 5-bit and 8-bit Buffer
Size fields are shown in Tables 6.1.3.1-1 and 6.1.3.1-2, respectively. For the
Long BSR format and the Long Truncated BSR format, the Buffer Size fields are
included in ascending order based on the LCG~i~. For the Long Truncated BSR
format the number of Buffer Size fields included is maximised, while not
exceeding the number of padding bits.
NOTE: The number of the Buffer Size fields in the Long BSR and Long Truncated
BSR format can be zero.
Figure 6.1.3.1-1: Short BSR and Short Truncated BSR MAC CE
Figure 6.1.3.1-2: Long BSR and Long Truncated BSR MAC CE
Table 6.1.3.1-1: Buffer size levels (in bytes) for 5-bit Buffer Size field
Index BS value Index BS value Index BS value Index BS value
* * *
0 0 8 ≤ 102 16 ≤ 1446 24 ≤ 20516 1 ≤ 10 9 ≤ 142 17 ≤ 2014 25 ≤ 28581 2 ≤ 14 10
≤ 198 18 ≤ 2806 26 ≤ 39818 3 ≤ 20 11 ≤ 276 19 ≤ 3909 27 ≤ 55474 4 ≤ 28 12 ≤
384 20 ≤ 5446 28 ≤ 77284 5 ≤ 38 13 ≤ 535 21 ≤ 7587 29 ≤ 107669 6 ≤ 53 14 ≤ 745
22 ≤ 10570 30 ≤ 150000 7 ≤ 74 15 ≤ 1038 23 ≤ 14726 31 > 150000
Table 6.1.3.1-2: Buffer size levels (in bytes) for 8-bit Buffer Size field
Index BS value Index BS value Index BS value Index BS value
* * *
0 0 64 ≤ 560 128 ≤ 31342 192 ≤ 1754595 1 ≤ 10 65 ≤ 597 129 ≤ 33376 193 ≤
1868488 2 ≤ 11 66 ≤ 635 130 ≤ 35543 194 ≤ 1989774 3 ≤ 12 67 ≤ 677 131 ≤ 37850
195 ≤ 2118933 4 ≤ 13 68 ≤ 720 132 ≤ 40307 196 ≤ 2256475 5 ≤ 14 69 ≤ 767 133 ≤
42923 197 ≤ 2402946 6 ≤ 15 70 ≤ 817 134 ≤ 45709 198 ≤ 2558924 7 ≤ 16 71 ≤ 870
135 ≤ 48676 199 ≤ 2725027 8 ≤ 17 72 ≤ 926 136 ≤ 51836 200 ≤ 2901912 9 ≤ 18 73
≤ 987 137 ≤ 55200 201 ≤ 3090279 10 ≤ 19 74 ≤ 1051 138 ≤ 58784 202 ≤ 3290873 11
≤ 20 75 ≤ 1119 139 ≤ 62599 203 ≤ 3504487 12 ≤ 22 76 ≤ 1191 140 ≤ 66663 204 ≤
3731968 13 ≤ 23 77 ≤ 1269 141 ≤ 70990 205 ≤ 3974215 14 ≤ 25 78 ≤ 1351 142 ≤
75598 206 ≤ 4232186 15 ≤ 26 79 ≤ 1439 143 ≤ 80505 207 ≤ 4506902 16 ≤ 28 80 ≤
1532 144 ≤ 85730 208 ≤ 4799451 17 ≤ 30 81 ≤ 1631 145 ≤ 91295 209 ≤ 5110989 18
≤ 32 82 ≤ 1737 146 ≤ 97221 210 ≤ 5442750 19 ≤ 34 83 ≤ 1850 147 ≤ 103532 211 ≤
5796046 20 ≤ 36 84 ≤ 1970 148 ≤ 110252 212 ≤ 6172275 21 ≤ 38 85 ≤ 2098 149 ≤
117409 213 ≤ 6572925 22 ≤ 40 86 ≤ 2234 150 ≤ 125030 214 ≤ 6999582 23 ≤ 43 87 ≤
2379 151 ≤ 133146 215 ≤ 7453933 24 ≤ 46 88 ≤ 2533 152 ≤ 141789 216 ≤ 7937777
25 ≤ 49 89 ≤ 2698 153 ≤ 150992 217 ≤ 8453028 26 ≤ 52 90 ≤ 2873 154 ≤ 160793
218 ≤ 9001725 27 ≤ 55 91 ≤ 3059 155 ≤ 171231 219 ≤ 9586039 28 ≤ 59 92 ≤ 3258
156 ≤ 182345 220 ≤ 10208280 29 ≤ 62 93 ≤ 3469 157 ≤ 194182 221 ≤ 10870913 30 ≤
66 94 ≤ 3694 158 ≤ 206786 222 ≤ 11576557 31 ≤ 71 95 ≤ 3934 159 ≤ 220209 223 ≤
12328006 32 ≤ 75 96 ≤ 4189 160 ≤ 234503 224 ≤ 13128233 33 ≤ 80 97 ≤ 4461 161 ≤
249725 225 ≤ 13980403 34 ≤ 85 98 ≤ 4751 162 ≤ 265935 226 ≤ 14887889 35 ≤ 91 99
≤ 5059 163 ≤ 283197 227 ≤ 15854280 36 ≤ 97 100 ≤ 5387 164 ≤ 301579 228 ≤
16883401 37 ≤ 103 101 ≤ 5737 165 ≤ 321155 229 ≤ 17979324 38 ≤ 110 102 ≤ 6109
166 ≤ 342002 230 ≤ 19146385 39 ≤ 117 103 ≤ 6506 167 ≤ 364202 231 ≤ 20389201 40
≤ 124 104 ≤ 6928 168 ≤ 387842 232 ≤ 21712690 41 ≤ 132 105 ≤ 7378 169 ≤ 413018
233 ≤ 23122088 42 ≤ 141 106 ≤ 7857 170 ≤ 439827 234 ≤ 24622972 43 ≤ 150 107 ≤
8367 171 ≤ 468377 235 ≤ 26221280 44 ≤ 160 108 ≤ 8910 172 ≤ 498780 236 ≤
27923336 45 ≤ 170 109 ≤ 9488 173 ≤ 531156 237 ≤ 29735875 46 ≤ 181 110 ≤ 10104
174 ≤ 565634 238 ≤ 31666069 47 ≤ 193 111 ≤ 10760 175 ≤ 602350 239 ≤ 33721553
48 ≤ 205 112 ≤ 11458 176 ≤ 641449 240 ≤ 35910462 49 ≤ 218 113 ≤ 12202 177 ≤
683087 241 ≤ 38241455 50 ≤ 233 114 ≤ 12994 178 ≤ 727427 242 ≤ 40723756 51 ≤
248 115 ≤ 13838 179 ≤ 774645 243 ≤ 43367187 52 ≤ 264 116 ≤ 14736 180 ≤ 824928
244 ≤ 46182206 53 ≤ 281 117 ≤ 15692 181 ≤ 878475 245 ≤ 49179951 54 ≤ 299 118 ≤
16711 182 ≤ 935498 246 ≤ 52372284 55 ≤ 318 119 ≤ 17795 183 ≤ 996222 247 ≤
55771835 56 ≤ 339 120 ≤ 18951 184 ≤ 1060888 248 ≤ 59392055 57 ≤ 361 121 ≤
20181 185 ≤ 1129752 249 ≤ 63247269 58 ≤ 384 122 ≤ 21491 186 ≤ 1203085 250 ≤
67352729 59 ≤ 409 123 ≤ 22885 187 ≤ 1281179 251 ≤ 71724679 60 ≤ 436 124 ≤
24371 188 ≤ 1364342 252 ≤ 76380419 61 ≤ 464 125 ≤ 25953 189 ≤ 1452903 253 ≤
81338368 62 ≤ 494 126 ≤ 27638 190 ≤ 1547213 254 > 81338368 63 ≤ 526 127 ≤
29431 191 ≤ 1647644 255 Reserved
#### 6.1.3.2 C-RNTI MAC CE
The C-RNTI MAC CE is identified by MAC subheader with LCID as specified in
Table 6.2.1-2.
It has a fixed size and consists of a single field defined as follows (Figure
6.1.3.2-1):
\- C-RNTI: This field contains the C-RNTI of the MAC entity. The length of the
field is 16 bits.
Figure 6.1.3.2-1: C-RNTI MAC CE
#### 6.1.3.3 UE Contention Resolution Identity MAC CE
The UE Contention Resolution Identity MAC CE is identified by MAC subheader
with LCID as specified in Table 6.2.1-1.
It has a fixed 48-bit size and consists of a single field defined as follows
(Figure 6.1.3.3-1):
\- UE Contention Resolution Identity: This field contains the UL CCCH SDU. If
the UL CCCH SDU is longer than 48 bits, this field contains the first 48 bits
of the UL CCCH SDU.
Figure 6.1.3.3-1: UE Contention Resolution Identity MAC CE
#### 6.1.3.4 Timing Advance Command MAC CE
The Timing Advance Command MAC CE is identified by MAC subheader with LCID as
specified in Table 6.2.1-1.
It has a fixed size and consists of a single octet defined as follows (Figure
6.1.3.4-1):
\- TAG Identity (TAG ID): This field indicates the TAG Identity of the
addressed TAG. The TAG containing the SpCell has the TAG Identity 0. The
length of the field is 2 bits;
\- Timing Advance Command: This field indicates the index value _T~A~_ (0, 1,
2... 63) used to control the amount of timing adjustment that MAC entity has
to apply (as specified in TS 38.213 [6]). The length of the field is 6 bits.
Figure 6.1.3.4-1: Timing Advance Command MAC CE
#### 6.1.3.5 DRX Command MAC CE
The DRX Command MAC CE is identified by a MAC subheader with LCID as specified
in Table 6.2.1-1.
It has a fixed size of zero bits.
#### 6.1.3.6 Long DRX Command MAC CE
The Long DRX Command MAC CE is identified by a MAC subheader with LCID as
specified in Table 6.2.1-1.
It has a fixed size of zero bits.
#### 6.1.3.7 Configured Grant Confirmation MAC CE
The Configured Grant Confirmation MAC CE is identified by a MAC subheader with
LCID as specified in Table 6.2.1-2.
It has a fixed size of zero bits.
#### 6.1.3.8 Single Entry PHR MAC CE
The Single Entry PHR MAC CE is identified by a MAC subheader with LCID as
specified in Table 6.2.1-2.
It has a fixed size and consists of two octets defined as follows (figure
6.1.3.8-1):
\- R: Reserved bit, set to 0;
\- Power Headroom (PH): This field indicates the power headroom level. The
length of the field is 6 bits. The reported PH and the corresponding power
headroom levels are shown in Table 6.1.3.8-1 below (the corresponding measured
values in dB are specified in TS 38.133 [11]);
\- P~CMAX,f,c~: This field indicates the P~CMAX,f,c~ (as specified in TS
38.213 [6]) used for calculation of the preceding PH field. The reported
P~CMAX,f,c~ and the corresponding nominal UE transmit power levels are shown
in Table 6.1.3.8-2 (the corresponding measured values in dBm are specified in
TS 38.133 [11]).
Figure 6.1.3.8-1: Single Entry PHR MAC CE
Table 6.1.3.8-1: Power Headroom levels for PHR
* * *
PH Power Headroom Level 0 POWER_HEADROOM_0 1 POWER_HEADROOM_1 2
POWER_HEADROOM_2 3 POWER_HEADROOM_3 ... ... 60 POWER_HEADROOM_60 61
POWER_HEADROOM_61 62 POWER_HEADROOM_62 63 POWER_HEADROOM_63
* * *
Table 6.1.3.8-2: Nominal UE transmit power level for PHR
+-------------+---------------------------------+ | P~CMAX,f,c~ | Nominal UE transmit power level | +-------------+---------------------------------+ | 0 | > PCMAX_C_00 | +-------------+---------------------------------+ | 1 | > PCMAX_C_01 | +-------------+---------------------------------+ | 2 | > PCMAX_C_02 | +-------------+---------------------------------+ | ... | ... | +-------------+---------------------------------+ | 61 | > PCMAX_C_61 | +-------------+---------------------------------+ | 62 | > PCMAX_C_62 | +-------------+---------------------------------+ | 63 | > PCMAX_C_63 | +-------------+---------------------------------+
#### 6.1.3.9 Multiple Entry PHR MAC CE
The Multiple Entry PHR MAC CE is identified by a MAC subheader with LCID as
specified in Table 6.2.1-2.
It has a variable size, and includes the bitmap, a Type 2 PH field and an
octet containing the associated P~CMAX,f,c~ field (if reported) for SpCell of
the other MAC entity, a Type 1 PH field and an octet containing the associated
P~CMAX,f,c~ field (if reported) for the PCell. It further includes, in
ascending order based on the _ServCellIndex_ , one or multiple of Type X PH
fields and octets containing the associated P~CMAX,f,c~ fields (if reported)
for Serving Cells other than PCell indicated in the bitmap. X is either 1 or 3
according to TS 38.213 [6] and TS 36.213 [17].
The presence of Type 2 PH field for SpCell of the other MAC entity is
configured by _phr-Type2OtherCell_ with value _true_.
A single octet bitmap is used for indicating the presence of PH per Serving
Cell when the highest _ServCellIndex_ of Serving Cell with configured uplink
is less than 8, otherwise four octets are used.
The MAC entity determines whether PH value for an activated Serving Cell is
based on real transmission or a reference format by considering the configured
grant(s) and downlink control information which has been received until and
including the PDCCH occasion in which the first UL grant for a new
transmission that can accommodate the MAC CE for PHR as a result of LCP as
defined in clause 5.4.3.1 is received since a PHR has been triggered if the
PHR MAC CE is reported on an uplink grant received on the PDCCH or until the
first uplink symbol of PUSCH transmission minus PUSCH preparation time as
defined in clause 7.7 of TS 38.213 [6] if the PHR MAC CE is reported on a
configured grant.
For a band combination in which the UE does not support dynamic power sharing,
the UE may omit the octets containing Power Headroom field and P~CMAX,f,c~
field for Serving Cells in the other MAC entity except for the PCell in the
other MAC entity and the reported values of Power Headroom and P~CMAX,f,c~ for
the PCell are up to UE implementation.
The PHR MAC CEs are defined as follows:
\- C~i~: This field indicates the presence of a PH field for the Serving Cell
with _ServCellIndex_ i as specified in TS 38.331 [5]. The C~i~ field set to 1
indicates that a PH field for the Serving Cell with _ServCellIndex_ i is
reported. The C~i~ field set to 0 indicates that a PH field for the Serving
Cell with _ServCellIndex_ i is not reported;
\- R: Reserved bit, set to 0;
\- V: This field indicates if the PH value is based on a real transmission or
a reference format. For Type 1 PH, the V field set to 0 indicates real
transmission on PUSCH and the V field set to 1 indicates that a PUSCH
reference format is used. For Type 2 PH, the V field set to 0 indicates real
transmission on PUCCH and the V field set to 1 indicates that a PUCCH
reference format is used. For Type 3 PH, the V field set to 0 indicates real
transmission on SRS and the V field set to 1 indicates that an SRS reference
format is used. Furthermore, for Type 1, Type 2, and Type 3 PH, the V field
set to 0 indicates the presence of the octet containing the associated
P~CMAX,f,c~ field, and the V field set to 1 indicates that the octet
containing the associated P~CMAX,f,c~ field is omitted;
\- Power Headroom (PH): This field indicates the power headroom level. The
length of the field is 6 bits. The reported PH and the corresponding power
headroom levels are shown in Table 6.1.3.8-1 (the corresponding measured
values in dB for the NR Serving Cell are specified in TS 38.133 [11] while the
corresponding measured values in dB for the E-UTRA Serving Cell are specified
in TS 36.133 [12]);
\- P: This field indicates whether the MAC entity applies power backoff due to
power management (as allowed by P-MPR~c~ as specified in TS 38.101-1 [14], TS
38.101-2 [15], and TS 38.101-3 [16]). The MAC entity shall set the P field to
1 if the corresponding P~CMAX,f,c~ field would have had a different value if
no power backoff due to power management had been applied;
\- P~CMAX,f,c~: If present, this field indicates the P~CMAX,f,c~ (as specified
in TS 38.213 [6]) for the NR Serving Cell and the P~CMAX,c~ or P̃~CMAX,c~ (as
specified in TS 36.213 [17]) for the E-UTRA Serving Cell used for calculation
of the preceding PH field. The reported P~CMAX,f,c~ and the corresponding
nominal UE transmit power levels are shown in Table 6.1.3.8-2 (the
corresponding measured values in dBm for the NR Serving Cell are specified in
TS 38.133 [11] while the corresponding measured values in dBm for the E-UTRA
Serving Cell are specified in TS 36.133 [12]).
Figure 6.1.3.9-1: Multiple Entry PHR MAC CE with the highest _ServCellIndex_
of Serving Cell with configured uplink is less than 8
Figure 6.1.3.9-2: Multiple Entry PHR MAC CE with the highest ServCellIndex of
Serving Cell with configured uplink is equal to or higher than 8
#### 6.1.3.10 SCell Activation/Deactivation MAC CEs
The SCell Activation/Deactivation MAC CE of one octet is identified by a MAC
subheader with LCID as specified in Table 6.2.1-1. It has a fixed size and
consists of a single octet containing seven C-fields and one R-field. The
SCell Activation/Deactivation MAC CE with one octet is defined as follows
(Figure 6.1.3.10-1).
The SCell Activation/Deactivation MAC CE of four octets is identified by a MAC
subheader with LCID as specified in Table 6.2.1-1. It has a fixed size and
consists of four octets containing 31 C-fields and one R-field. The SCell
Activation/Deactivation MAC CE of four octets is defined as follows (Figure
6.1.3.10-2).
\- C~i~: If there is an SCell configured for the MAC entity with _SCellIndex_
i as specified in TS 38.331 [5], this field indicates the
activation/deactivation status of the SCell with _SCellIndex_ i, else the MAC
entity shall ignore the C~i~ field. The C~i~ field is set to 1 to indicate
that the SCell with _SCellIndex_ i shall be activated. The C~i~ field is set
to 0 to indicate that the SCell with _SCellIndex_ i shall be deactivated;
\- R: Reserved bit, set to 0.
Figure 6.1.3.10-1: SCell Activation/Deactivation MAC CE of one octet
Figure 6.1.3.10-2: SCell Activation/Deactivation MAC CE of four octets
#### 6.1.3.11 Duplication Activation/Deactivation MAC CE
The Duplication Activation/Deactivation MAC CE of one octet is identified by a
MAC subheader with LCID as specified in Table 6.2.1-1. It has a fixed size and
consists of a single octet containing eight D-fields. The Duplication
Activation/Deactivation MAC CE is defined, for a MAC entity, as follows
(Figure 6.1.3.11-1).
\- D~i~: This field indicates the activation/deactivation status of the PDCP
duplication of DRB i where i is the ascending order of the DRB ID among the
DRBs configured with PDCP duplication and with RLC entity(ies) associated with
this MAC entity. The D~i~ field is set to 1 to indicate that the PDCP
duplication of DRB i shall be activated. The D~i~ field is set to 0 to
indicate that the PDCP duplication of DRB i shall be deactivated.
Figure 6.1.3.11-1: Duplication Activation/Deactivation MAC CE
#### 6.1.3.12 SP CSI-RS/CSI-IM Resource Set Activation/Deactivation MAC CE
The SP CSI-RS/CSI-IM Resource Set Activation/Deactivation MAC CE is identified
by a MAC subheader with LCID as specified in Table 6.2.1-1. It has a variable
size and consists of the following fields:
\- A/D: This field indicates whether to activate or deactivate indicated SP
CSI-RS and CSI-IM resource set(s). The field is set to 1 to indicate
activation, otherwise it indicates deactivation;
\- Serving Cell ID: This field indicates the identity of the Serving Cell for
which the MAC CE applies. The length of the field is 5 bits;
\- BWP ID: This field indicates a DL BWP for which the MAC CE applies as the
codepoint of the DCI _bandwidth part indicator_ field as specified in TS
38.212 [9]. The length of the BWP ID field is 2 bits;
\- SP CSI-RS resource set ID: This field contains an index of _NZP-CSI-RS-
ResourceSet_ containing Semi Persistent NZP CSI-RS resources, as specified in
TS 38.331 [5], indicating the Semi Persistent NZP CSI-RS resource set, which
shall be activated or deactivated. The length of the field is 6 bits;
\- IM: This field indicates the presence of the octet containing SP CSI-IM
resource set ID field. If the IM field is set to 1, the octet containing SP
CSI-IM resource set ID field is present. If IM field is set to 0, the octet
containing SP CSI-IM resource set ID field is not present;
\- SP CSI-IM resource set ID: This field contains an index of _CSI-IM-
ResourceSet_ containing Semi Persistent CSI-IM resources, as specified in TS
38.331 [5], indicating the Semi Persistent CSI-IM resource set, which shall be
activated or deactivated. The length of the field is 6 bits;
\- TCI State ID~i~: This field contains _TCI-StateId_ , as specified in TS
38.331 [5], of a TCI State, which is used as QCL source for the resource
within the Semi Persistent NZP CSI-RS resource set indicated by SP CSI-RS
resource set ID field. TCI State ID~0~ indicates TCI State for the first
resource within the set, TCI State ID~1~ for the second one and so on. The
length of the field is 7 bits. If the A/D field is set to 0, the octets
containing TCI State ID field(s) are not present;
\- R: Reserved bit, set to 0.
Figure 6.1.3.12-1: SP CSI-RS/CSI-IM Resource Set Activation/Deactivation MAC
CE
#### 6.1.3.13 Aperiodic CSI Trigger State Subselection MAC CE
The Aperiodic CSI Trigger State Subselection MAC CE is identified by a MAC
subheader with LCID as specified in Table 6.2.1-1. It has a variable size
consisting of following fields:
\- Serving Cell ID: This field indicates the identity of the Serving Cell for
which the MAC CE applies. The length of the field is 5 bits;
\- BWP ID: This field indicates a DL BWP for which the MAC CE applies as the
codepoint of the DCI _bandwidth part indicator_ field as specified in TS
38.212 [9]. The length of the BWP ID field is 2 bits;
\- T~i~: This field indicates the selection status of the Aperiodic Trigger
States configured within _CSI-aperiodicTriggerStateList_ , as specified in TS
38.331 [5]. T~0~ refers to the first trigger state within the list, T~1~ to
the second one and so on. If the list does not contain entry with index i, MAC
entity shall ignore the T~i~ field. The T~i~ field is set to 1 to indicate
that the Aperiodic Trigger State i shall be mapped to the codepoint of the DCI
_CSI request_ field, as specified in TS 38.214 [7]. The codepoint to which the
Aperiodic Trigger State is mapped is determined by its ordinal position among
all the Aperiodic Trigger States with T~i~ field set to 1, i.e. the first
Aperiodic Trigger State with T~i~ field set to 1 shall be mapped to the
codepoint value 1, second Aperiodic Trigger State with T~i~ field set to 1
shall be mapped to the codepoint value 2 and so on. The maximum number of
mapped Aperiodic Trigger States is 63;
\- R: Reserved bit, set to 0.
Figure 6.1.3.13-1: Aperiodic CSI Trigger State Subselection MAC CE
#### 6.1.3.14 TCI States Activation/Deactivation for UE-specific PDSCH MAC CE
The TCI States Activation/Deactivation for UE-specific PDSCH MAC CE is
identified by a MAC subheader with LCID as specified in Table 6.2.1-1. It has
a variable size consisting of following fields:
\- Serving Cell ID: This field indicates the identity of the Serving Cell for
which the MAC CE applies. The length of the field is 5 bits;
\- BWP ID: This field indicates a DL BWP for which the MAC CE applies as the
codepoint of the DCI _bandwidth part indicator_ field as specified in TS
38.212 [9]. The length of the BWP ID field is 2 bits;
\- T~i~: If there is a TCI state with _TCI-StateId_ i as specified in TS
38.331 [5], this field indicates the activation/deactivation status of the TCI
state with _TCI-StateId_ i, otherwise MAC entity shall ignore the T~i~ field.
The T~i~ field is set to 1 to indicate that the TCI state with _TCI-StateId_ i
shall be activated and mapped to the codepoint of the DCI _Transmission
Configuration Indication_ field, as specified in TS 38.214 [7]. The T~i~ field
is set to 0 to indicate that the TCI state with _TCI-StateId_ i shall be
deactivated and is not mapped to the codepoint of the DCI _Transmission
Configuration Indication_ field. The codepoint to which the TCI State is
mapped is determined by its ordinal position among all the TCI States with
T~i~ field set to 1, i.e. the first TCI State with T~i~ field set to 1 shall
be mapped to the codepoint value 0, second TCI State with T~i~ field set to 1
shall be mapped to the codepoint value 1 and so on. The maximum number of
activated TCI states is 8;
\- R: Reserved bit, set to 0.
Figure 6.1.3.14-1: TCI States Activation/Deactivation for UE-specific PDSCH
MAC CE
#### 6.1.3.15 TCI State Indication for UE-specific PDCCH MAC CE
The TCI State Indication for UE-specific PDCCH MAC CE is identified by a MAC
subheader with LCID as specified in Table 6.2.1-1. It has a fixed size of 16
bits with following fields:
\- Serving Cell ID: This field indicates the identity of the Serving Cell for
which the MAC CE applies. The length of the field is 5 bits;
\- CORESET ID: This field indicates a Control Resource Set identified with
_ControlResourceSetId_ as specified in TS 38.331 [5], for which the TCI State
is being indicated. In case the value of the field is 0, the field refers to
the Control Resource Set configured by _controlResourceSetZero_ as specified
in TS 38.331 [5]. The length of the field is 4 bits;
\- TCI State ID: This field indicates the TCI state identified by _TCI-
StateId_ as specified in TS 38.331 [5] applicable to the Control Resource Set
identified by CORESET ID field. If the field of CORESET ID is set to 0, this
field indicates a _TCI-StateId_ for a TCI state of the first 64 TCI-states
configured by _tci-StatesToAddModList_ and _tci-StatesToReleaseList_ in the
_PDSCH-Config_ in the active BWP. If the field of CORESET ID is set to the
other value than 0, this field indicates a _TCI-StateId_ configured by _tci-
StatesPDCCH-ToAddList_ and _tci-StatesPDCCH-ToReleaseList_ in the
_controlResourceSet_ identified by the indicated CORESET ID. The length of the
field is 7 bits.
Figure 6.1.3.15-1: TCI State Indication for UE-specific PDCCH MAC CE
#### 6.1.3.16 SP CSI reporting on PUCCH Activation/Deactivation MAC CE
The SP CSI reporting on PUCCH Activation/Deactivation MAC CE is identified by
a MAC subheader with LCID as specified in Table 6.2.1-1. It has a fixed size
of 16 bits with following fields:
\- Serving Cell ID: This field indicates the identity of the Serving Cell for
which the MAC CE applies. The length of the field is 5 bits;
\- BWP ID: This field indicates a UL BWP for which the MAC CE applies as the
codepoint of the DCI _bandwidth part indicator_ field as specified in TS
38.212 [9]. The length of the BWP ID field is 2 bits;
\- S~i~: This field indicates the activation/deactivation status of the Semi-
Persistent CSI report configuration within _csi-ReportConfigToAddModList_ , as
specified in TS 38.331 [5]. S~0~ refers to the report configuration which
includes PUCCH resources for SP CSI reporting in the indicated BWP and has the
lowest _CSI-ReportConfigId_ within the list with type set to
_semiPersistentOnPUCCH_ , S~1~ to the report configuration which includes
PUCCH resources for SP CSI reporting in the indicated BWP and has the second
lowest _CSI-ReportConfigId_ and so on. If the number of report configurations
within the list with type set to _semiPersistentOnPUCCH_ in the indicated BWP
is less than i + 1, MAC entity shall ignore the S~i~ field. The S~i~ field is
set to 1 to indicate that the corresponding Semi-Persistent CSI report
configuration shall be activated. The S~i~ field is set to 0 to indicate that
the corresponding Semi-Persistent CSI report configuration i shall be
deactivated;
\- R: Reserved bit, set to 0.
Figure 6.1.3.16-1: SP CSI reporting on PUCCH Activation/Deactivation MAC CE
#### 6.1.3.17 SP SRS Activation/Deactivation MAC CE
The SP SRS Activation/Deactivation MAC CE is identified by a MAC subheader
with LCID as specified in Table 6.2.1-1. It has a variable size with following
fields:
\- A/D: This field indicates whether to activate or deactivate indicated SP
SRS resource set. The field is set to 1 to indicate activation, otherwise it
indicates deactivation;
\- SRS Resource Set\'s Cell ID: This field indicates the identity of the
Serving Cell, which contains activated/deactivated SP SRS Resource Set. If the
C field is set to 0, this field also indicates the identity of the Serving
Cell which contains all resources indicated by the Resource ID~i~ fields. The
length of the field is 5 bits;
\- SRS Resource Set\'s BWP ID: This field indicates a UL BWP as the codepoint
of the DCI _bandwidth part indicator_ field as specified in TS 38.212 [9],
which contains activated/deactivated SP SRS Resource Set. If the C field is
set to 0, this field also indicates the identity of the BWP which contains all
resources indicated by the Resource ID~i~ fields. The length of the field is 2
bits;
\- C: This field indicates whether the octets containing Resource Serving Cell
ID field(s) and Resource BWP ID field(s) are present. If this field is set to
1, the octets containing Resource Serving Cell ID field(s) and Resource BWP ID
field(s) are present, otherwise they are not present;
\- SUL: This field indicates whether the MAC CE applies to the NUL carrier or
SUL carrier configuration. This field is set to 1 to indicate that it applies
to the SUL carrier configuration, and it is set to 0 to indicate that it
applies to the NUL carrier configuration;
\- SP SRS Resource Set ID: This field indicates the SP SRS Resource Set ID
identified by _SRS-ResourceSetId_ as specified in TS 38.331 [5], which is to
be activated or deactivated. The length of the field is 4 bits;
\- F~i~: This field indicates the type of a resource used as a spatial
relationship for SRS resource within SP SRS Resource Set indicated with SP SRS
Resource Set ID field. F~0~ refers to the first SRS resource within the
resource set, F~1~ to the second one and so on. The field is set to 1 to
indicate NZP CSI-RS resource index is used, and it is set to 0 to indicate
either SSB index or SRS resource index is used. The length of the field is 1
bit. This field is only present if MAC CE is used for activation, i.e. the A/D
field is set to 1;
\- Resource ID~i~: This field contains an identifier of the resource used for
spatial relationship derivation for SRS resource i. Resource ID~0~ refers to
the first SRS resource within the resource set, Resource ID~1~ to the second
one and so on. If F~i~ is set to 0, and the first bit of this field is set to
1, the remainder of this field contains _SSB-Index_ as specified in TS 38.331
[5]. If F~i~ is set to 0, and the first bit of this field is set to 0, the
remainder of this field contains _SRS-ResourceId_ as specified in TS 38.331
[5]. The length of the field is 7 bits. This field is only present if MAC CE
is used for activation, i.e. the A/D field is set to 1;
\- Resource Serving Cell ID~i~: This field indicates the identity of the
Serving Cell on which the resource used for spatial relationship derivation
for SRS resource i is located. The length of the field is 5 bits;
\- Resource BWP ID~i~: This field indicates a UL BWP as the codepoint of the
DCI _bandwidth part indicator_ field as specified in TS 38.212 [9], on which
the resource used for spatial relationship derivation for SRS resource i is
located. The length of the field is 2 bits;
\- R: Reserved bit, set to 0.
Figure 6.1.3.17-1: SP SRS Activation/Deactivation MAC CE
#### 6.1.3.18 PUCCH spatial relation Activation/Deactivation MAC CE
The PUCCH spatial relation Activation/Deactivation MAC CE is identified by a
MAC subheader with LCID as specified in Table 6.2.1-1. It has a fixed size of
24 bits with following fields:
\- Serving Cell ID: This field indicates the identity of the Serving Cell for
which the MAC CE applies. The length of the field is 5 bits;
\- BWP ID: This field indicates a UL BWP for which the MAC CE applies as the
codepoint of the DCI _bandwidth part indicator_ field as specified in TS
38.212 [9]. The length of the BWP ID field is 2 bits;
\- PUCCH Resource ID: This field contains an identifier of the PUCCH resource
ID identified by _PUCCH-ResourceId_ as specified in TS 38.331 [5]. The length
of the field is 7 bits;
\- S~i~: If there is a PUCCH Spatial Relation Info with _PUCCH-
SpatialRelationInfoId_ as specified in TS 38.331 [5], configured for the
uplink bandwidth part indicated by BWP ID field, S~i~ indicates the activation
status of PUCCH Spatial Relation Info with _PUCCH-SpatialRelationInfoId_ equal
to i + 1, otherwise MAC entity shall ignore this field. The S~i~ field is set
to 1 to indicate PUCCH Spatial Relation Info with _PUCCH-
SpatialRelationInfoId_ equal to i + 1 shall be activated. The S~i~ field is
set to 0 to indicate PUCCH Spatial Relation Info with _PUCCH-
SpatialRelationInfoId_ equal to i + 1 shall be deactivated. Only a single
PUCCH Spatial Relation Info can be active for a PUCCH Resource at a time;
\- R: Reserved bit, set to 0.
Figure 6.1.3.18-1: PUCCH spatial relation Activation/Deactivation MAC CE
#### 6.1.3.19 SP ZP CSI-RS Resource Set Activation/Deactivation MAC CE
The SP ZP CSI-RS Resource Set Activation/Deactivation MAC CE is identified by
a MAC subheader with LCID as specified in Table 6.2.1-1. It has a fixed size
of 16 bits with following fields:
\- A/D: This field indicates whether to activate or deactivate indicated SP ZP
CSI-RS resource set. The field is set to 1 to indicate activation, otherwise
it indicates deactivation;
\- Serving Cell ID: This field indicates the identity of the Serving Cell for
which the MAC CE applies. The length of the field is 5 bits;
\- BWP ID: This field indicates a DL BWP for which the MAC CE applies as the
codepoint value of the DCI _bandwidth part indicator_ field as specified in TS
38.212 [9]. The length of the BWP ID field is 2 bits;
\- SP ZP CSI-RS resource set ID: This field contains an index of _sp-ZP-CSI-
RS-ResourceSetsToAddModList_ , as specified in TS 38.331 [5], indicating the
Semi Persistent ZP CSI-RS resource set, which shall be activated or
deactivated. The length of the field is 4 bits;
\- R: Reserved bit, set to 0.
Figure 6.1.3.19-1: SP ZP CSI-RS Resource Set Activation/Deactivation MAC CE
#### 6.1.3.20 Recommended bit rate MAC CE
The Recommended bit rate MAC CE is identified by a MAC subheader with LCID as
specified in Tables 6.2.1-1 and 6.2.1-2 for bit rate recommendation message
from the gNB to the UE and bit rate recommendation query message from the UE
to the gNB, respectively. It has a fixed size and consists of two octets
defined as follows (Figure 6.1.3.20-1):
\- LCID: This field indicates the identity of the logical channel for which
the recommended bit rate or the recommended bit rate query is applicable. The
length of the field is 6 bits;
\- Uplink/Downlink (UL/DL): This field indicates whether the recommended bit
rate or the recommended bit rate query applies to uplink or downlink. The
length of the field is 1 bit. The UL/DL field set to 0 indicates downlink. The
UL/DL field set to 1 indicates uplink;
\- Bit Rate: This field indicates an index to Table 6.1.3.20-1. The length of
the field is 6 bits. For bit rate recommendation the value indicates the
recommended bit rate. For bit rate recommendation query the value indicates
the desired bit rate;
\- R: reserved bit, set to 0.
Figure 6.1.3.20-1: Recommended bit rate MAC CE
Table 6.1.3.20-1: Values (kbit/s) for Bit Rate field
Index NR Recommended Bit Rate value [kbit/s] Index NR Recommended Bit Rate
value [kbit/s]
* * *
0 Note 1 32 700 1 0 33 800 2 9 34 900 3 11 35 1000 4 13 36 1100 5 17 37 1200 6
21 38 1300 7 25 39 1400 8 29 40 1500 9 32 41 1750 10 36 42 2000 11 40 43 2250
12 48 44 2500 13 56 45 2750 14 72 46 3000 15 88 47 3500 16 104 48 4000 17 120
49 4500 18 140 50 5000 19 160 51 5500 20 180 52 6000 21 200 53 6500 22 220 54
7000 23 240 55 7500 24 260 56 8000 25 280 57 Reserved 26 300 58 Reserved 27
350 59 Reserved 28 400 60 Reserved 29 450 61 Reserved 30 500 62 Reserved 31
600 63 Reserved Note 1: For bit rate recommendation message this index is used
for indicating that no new recommendation on bit rate is given.
### 6.1.4 MAC PDU (transparent MAC)
A MAC PDU consists solely of a MAC SDU whose size is aligned to a TB; as
described in Figure 6.1.4-1. This MAC PDU is used for transmissions on PCH,
BCH, and DL-SCH including BCCH.
Figure 6.1.4-1: Example of MAC PDU (transparent MAC)
### 6.1.5 MAC PDU (Random Access Response)
A MAC PDU consists of one or more MAC subPDUs and optionally padding. Each MAC
subPDU consists one of the following:
\- a MAC subheader with Backoff Indicator only;
\- a MAC subheader with RAPID only (i.e. acknowledgment for SI request);
\- a MAC subheader with RAPID and MAC RAR.
A MAC subheader with Backoff Indicator consists of five header fields
E/T/R/R/BI as described in Figure 6.1.5-1. A MAC subPDU with Backoff Indicator
only is placed at the beginning of the MAC PDU, if included. \'MAC subPDU(s)
with RAPID only\' and \'MAC subPDU(s) with RAPID and MAC RAR\' can be placed
anywhere between MAC subPDU with Backoff Indicator only (if any) and padding
(if any).
A MAC subheader with RAPID consists of three header fields E/T/RAPID as
described in Figure 6.1.5-2.
Padding is placed at the end of the MAC PDU if present. Presence and length of
padding is implicit based on TB size, size of MAC subPDU(s).
Figure 6.1.5-1: E/T/R/R/BI MAC subheader
Figure 6.1.5-2: E/T/RAPID MAC subheader
Figure 6.1.5-3: Example of MAC PDU consisting of MAC RARs
## 6.2 Formats and parameters
### 6.2.1 MAC subheader for DL-SCH and UL-SCH
The MAC subheader consists of the following fields:
\- LCID: The Logical Channel ID field identifies the logical channel instance
of the corresponding MAC SDU or the type of the corresponding MAC CE or
padding as described in Tables 6.2.1-1 and 6.2.1-2 for the DL-SCH and UL-SCH
respectively. There is one LCID field per MAC subheader. The size of the LCID
field is 6 bits;
\- L: The Length field indicates the length of the corresponding MAC SDU or
variable-sized MAC CE in bytes. There is one L field per MAC subheader except
for subheaders corresponding to fixed-sized MAC CEs, padding, and MAC SDUs
containing UL CCCH. The size of the L field is indicated by the F field;
\- F: The Format field indicates the size of the Length field. There is one F
field per MAC subheader except for subheaders corresponding to fixed-sized MAC
CEs, padding, and MAC SDUs containing UL CCCH. The size of the F field is 1
bit. The value 0 indicates 8 bits of the Length field. The value 1 indicates
16 bits of the Length field;
\- R: Reserved bit, set to 0.
The MAC subheader is octet aligned.
Table 6.2.1-1 Values of LCID for DL-SCH
Index LCID values
* * *
0 CCCH 1--32 Identity of the logical channel 33-46 Reserved 47 Recommended bit
rate 48 SP ZP CSI-RS Resource Set Activation/Deactivation 49 PUCCH spatial
relation Activation/Deactivation 50 SP SRS Activation/Deactivation 51 SP CSI
reporting on PUCCH Activation/Deactivation 52 TCI State Indication for UE-
specific PDCCH 53 TCI States Activation/Deactivation for UE-specific PDSCH 54
Aperiodic CSI Trigger State Subselection 55 SP CSI-RS/CSI-IM Resource Set
Activation/Deactivation 56 Duplication Activation/Deactivation 57 SCell
Activation/Deactivation (four octets) 58 SCell Activation/Deactivation (one
octet) 59 Long DRX Command 60 DRX Command 61 Timing Advance Command 62 UE
Contention Resolution Identity 63 Padding
Table 6.2.1-2 Values of LCID for UL-SCH
Index LCID values
* * *
0 CCCH of size 64 bits (referred to as \"CCCH1\" in TS 38.331 [5]) 1--32
Identity of the logical channel 33--51 Reserved 52 CCCH of size 48 bits
(referred to as \"CCCH\" in TS 38.331 [5]) 53 Recommended bit rate query 54
Multiple Entry PHR (four octets C~i~) 55 Configured Grant Confirmation 56
Multiple Entry PHR (one octet C~i~) 57 Single Entry PHR 58 C-RNTI 59 Short
Truncated BSR 60 Long Truncated BSR 61 Short BSR 62 Long BSR 63 Padding
### 6.2.2 MAC subheader for Random Access Response
The MAC subheader consists of the following fields:
\- E: The Extension field is a flag indicating if the MAC subPDU including
this MAC subheader is the last MAC subPDU or not in the MAC PDU. The E field
is set to 1 to indicate at least another MAC subPDU follows. The E field is
set to 0 to indicate that the MAC subPDU including this MAC subheader is the
last MAC subPDU in the MAC PDU;
\- T: The Type field is a flag indicating whether the MAC subheader contains a
Random Access Preamble ID or a Backoff Indicator. The T field is set to 0 to
indicate the presence of a Backoff Indicator field in the subheader (BI). The
T field is set to 1 to indicate the presence of a Random Access Preamble ID
field in the subheader (RAPID);
\- R: Reserved bit, set to 0;
\- BI: The Backoff Indicator field identifies the overload condition in the
cell. The size of the BI field is 4 bits;
\- RAPID: The Random Access Preamble IDentifier field identifies the
transmitted Random Access Preamble (see clause 5.1.3). The size of the RAPID
field is 6 bits. If the RAPID in the MAC subheader of a MAC subPDU corresponds
to one of the Random Access Preambles configured for SI request, MAC RAR is
not included in the MAC subPDU.
The MAC subheader is octet aligned.
### 6.2.3 MAC payload for Random Access Response
The MAC RAR is of fixed size as depicted in Figure 6.2.3-1, and consists of
the following fields:
\- R: Reserved bit, set to 0;
\- Timing Advance Command: The Timing Advance Command field indicates the
index value _T~A~_ used to control the amount of timing adjustment that the
MAC entity has to apply in TS 38.213 [6]. The size of the Timing Advance
Command field is 12 bits;
\- UL Grant: The Uplink Grant field indicates the resources to be used on the
uplink in TS 38.213 [6]. The size of the UL Grant field is 27 bits;
\- Temporary C-RNTI: The Temporary C-RNTI field indicates the temporary
identity that is used by the MAC entity during Random Access. The size of the
Temporary C-RNTI field is 16 bits.
The MAC RAR is octet aligned.
Figure 6.2.3-1: MAC RAR
# 7 Variables and constants
## 7.1 RNTI values
RNTI values are presented in Table 7.1-1.
Table 7.1-1: RNTI values.
Value (hexa-decimal) RNTI
* * *
0000 N/A 0001--FFEF RA-RNTI, Temporary C-RNTI, C-RNTI, MCS-C-RNTI, CS-RNTI,
TPC-PUCCH-RNTI, TPC-PUSCH-RNTI, TPC-SRS-RNTI, INT-RNTI, SFI-RNTI, and SP-CSI-
RNTI FFF0--FFFD Reserved FFFE P-RNTI FFFF SI-RNTI
Table 7.1-2: RNTI usage.
* * *
RNTI Usage Transport Channel Logical Channel
* * *
P-RNTI Paging and System Information change notification PCH PCCH
SI-RNTI Broadcast of System Information DL-SCH BCCH
RA-RNTI Random Access Response DL-SCH N/A
Temporary C-RNTI Contention Resolution\ DL-SCH CCCH, DCCH (when no valid
C-RNTI is available)
Temporary C-RNTI Msg3 transmission UL-SCH CCCH, DCCH, DTCH
C-RNTI, MCS-C-RNTI Dynamically scheduled unicast transmission UL-SCH DCCH,
DTCH
C-RNTI Dynamically scheduled unicast transmission DL-SCH CCCH, DCCH, DTCH
MCS-C-RNTI Dynamically scheduled unicast transmission DL-SCH DCCH, DTCH
C-RNTI Triggering of PDCCH ordered random access N/A N/A
CS-RNTI Configured scheduled unicast transmission\ DL-SCH, UL-SCH DCCH, DTCH
(activation, reactivation and retransmission)
CS-RNTI Configured scheduled unicast transmission\ N/A N/A (deactivation)
TPC-PUCCH-RNTI PUCCH power control N/A N/A
TPC-PUSCH-RNTI PUSCH power control N/A N/A
TPC-SRS-RNTI SRS trigger and power control N/A N/A
INT-RNTI Indication pre-emption in DL N/A N/A
SFI-RNTI Slot Format Indication on the given cell N/A N/A
SP-CSI-RNTI Activation of Semi-persistent CSI reporting on PUSCH N/A N/A
NOTE: The usage of MCS-C-RNTI is equivalent to that of C-RNTI in MAC
procedures (except for the C-RNTI MAC CE).
* * *
## 7.2 Backoff Parameter values
Backoff Parameter values are presented in Table 7.2-1.
Table 7.2-1: Backoff Parameter values.
Index Backoff Parameter value (ms)
* * *
0 5 1 10 2 20 3 30 4 40 5 60 6 80 7 120 8 160 9 240 10 320 11 480 12 960 13
1920 14 Reserved 15 Reserved
## 7.3 DELTA_PREAMBLE values
The DELTA_PREAMBLE preamble format based power offset values are presented in
Tables 7.3-1 and 7.3-2.
Table 7.3-1: DELTA_PREAMBLE values for long preamble formats.
+----------+------------------------+ | Preamble | DELTA_PREAMBLE values | | | | | Format | | +==========+========================+ | 0 | 0 dB | +----------+------------------------+ | 1 | -3 dB | +----------+------------------------+ | 2 | -6 dB | +----------+------------------------+ | 3 | 0 dB | +----------+------------------------+
Table 7.3-2: DELTA_PREAMBLE values for short preamble formats.
+----------+-----------------------------+ | Preamble | DELTA_PREAMBLE values (dB) | | | | | Format | | +==========+=============================+ | A1 | 8 + 3 × _μ_ | +----------+-----------------------------+ | A2 | 5 + 3 × _μ_ | +----------+-----------------------------+ | A3 | 3 + 3 × _μ_ | +----------+-----------------------------+ | B1 | 8 + 3 × _μ_ | +----------+-----------------------------+ | B2 | 5 + 3 × _μ_ | +----------+-----------------------------+ | B3 | 3 + 3 × _μ_ | +----------+-----------------------------+ | B4 | 3 × _μ_ | +----------+-----------------------------+ | C0 | 11 + 3 × _μ_ | +----------+-----------------------------+ | C2 | 5 + 3 × _μ_ | +----------+-----------------------------+
where _μ_ is the sub-carrier spacing configuration determined by
_msg1-SubcarrierSpacing_ and Table 4.2-1 in TS 38.211 [8], and the preamble
formats are given by _prach-ConfigurationIndex_ and Tables 6.3.3.2-2 and
6.3.3.2-3 in TS 38.211 [8].
## 7.4 PRACH Mask Index values
Table 7.4-1: PRACH Mask Index values
PRACH Mask Index Allowed PRACH occasion(s) of SSB
* * *
0 All 1 PRACH occasion index 1 2 PRACH occasion index 2 3 PRACH occasion index
3 4 PRACH occasion index 4 5 PRACH occasion index 5 6 PRACH occasion index 6 7
PRACH occasion index 7 8 PRACH occasion index 8 9 Every even PRACH occasion 10
Every odd PRACH occasion 11 Reserved 12 Reserved 13 Reserved 14 Reserved 15
Reserved
#
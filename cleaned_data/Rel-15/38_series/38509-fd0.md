# Foreword
This Technical Specification has been produced by the 3rd Generation
Partnership Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# 1 Scope
The present document defines for User Equipment (UE) those special functions
and their activation/deactivation methods that are required in the UE for
conformance testing purposes when the UE is connected to the 5G System (5GS)
via its radio interface(s).
The document also describes the operation of these special functions when the
5GS capable UEs are connected via a non-5GS system e.g. E-UTRA FDD or TDD
system.
Depending on the 5GS system\'s architecture some relevant for the UE for
conformance testing special functions may be defined in TS 36.509 [6].
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
References are either specific (identified by date of publication, edition
number, version number, etc.) or non‑specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_ unless the context in which the
reference is made suggests a different Release is relevant (information on the
applicable release in a particular context can be found in e.g. test case
title, description or applicability, message description or content).
[1] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[2] 3GPP TS 38.508-1: \"5GS; User Equipment (UE) conformance specification;
Part 1: Common test environment \".
[3] 3GPP TS 38.523-1: \"5GS; User Equipment (UE) conformance specification;
Part 1: Protocol \".
[4] 3GPP TS 38.523-3: \"5GS; User Equipment (UE) conformance specification;
Part 3: Protocol Test Suites \"
[5] 3GPP TS 38.522: \"NR; User Equipment (UE) conformance specification;
Applicability of RF and RRM test cases\".
[6] 3GPP TS 36.509: \"Evolved Universal Terrestrial Radio Access (E-UTRA) and
Evolved Packet Core (EPC); Special conformance testing functions for User
Equipment (UE)\".
[7] 3GPP TS 24.007: \"Mobile radio interface signalling layer 3; General
Aspects\".
[8] 3GPP TS 34.109: \"Terminal logical test interface; Special conformance
testing functions\".
[9] 3GPP TS 44.014: \"Individual equipment type requirements and interworking;
Special conformance testing functions\".
[10] 3GPP TS 36.331: \"Evolved Universal Terrestrial Radio Access (EUTRA)
Radio Resource Control (RRC) Protocol Specification\".
[11] 3GPP TS 38.331: \"NR Radio Resource Control (RRC) protocol
specification\".
[12] 3GPP TS 38.521-1: \"NR; User Equipment (UE) conformance specification;
Radio transmission and reception; Part 1: Range 1 Standalone\".
[13] 3GPP TS 38.521-2: \"NR; User Equipment (UE) conformance specification;
Radio transmission and reception; Part 2: Range 2 Standalone\".
[14] 3GPP TS 38.521-3: \"NR; User Equipment (UE) conformance specification;
Radio transmission and reception; Part 3: Range 1 and Range 2 Interworking
operation with other radios\".
[15] 3GPP TS 38.521-4: \"NR; User Equipment conformance specification; Radio
transmission and reception; Part 4: Performance\".
[16] 3GPP TS 38.533: NR; \"User Equipment (UE) conformance specification;
Radio resource management\".
[17] 3GPP TS 24.301: \"Non-Access-Stratum (NAS) protocol for Evolved Packet
System (EPS); Stage 3\".
[18] 3GPP TS 36.323: \"Evolved Universal Terrestrial Radio Access (E-UTRA);
Packet Data Convergence Protocol (PDCP) specification\".
[19] 3GPP TS 38.323: \"NR; Packet Data Convergence Protocol (PDCP)
specification\".
[20] 3GPP TS 38.306: \"NR; User Equipment (UE) radio access capabilities\".
[21] 3GPP TS 24.501: \"Non-Access-Stratum (NAS) protocol for 5G System (5GS);
Stage 3\".
[22] 3GPP TS 38.215: \"NR; Physical Layer Measurements\".
# 3 Definitions, symbols and abbreviations
## 3.1 Definitions
For the purposes of the present document, the terms and definitions given in
3GPP TR 21.905 [1] and the following apply. A term defined in the present
document takes precedence over the definition of the same term, if any, in
3GPP TR 21.905 [1].
**Frequency Range 2 (FR2):** The frequency ranges in which NR can operate
being in the range of 24250 MHz - 52600 MHz.
**Logical Test Interface:** interface which provides the logical service to
interwork and to communicate between UE and System Simulator during the test
of a UE
**SS (System Simulator):** test system (or equipment) that drives the test
process with UE, like 5G System simulator
**TMC (Test Mode Control):** UE protocol entity used by the SS to control the
UE specific testing functions
NOTE: In other Special conformance testing functions for User Equipment (UE)
3GPP specifications e.g. 36.509 [6], the term Test Control (TC) is used for
describing the same UE entity. The different names do not preclude the
implementation of a single entity to handle all the functionality in a UE
supporting different 3GPP technologies.
**UE (User Equipment):** user equipment as defined in [1] that is under test
## 3.2 Symbols
No specific symbols apply for the purposes of the present document.
## 3.3 Abbreviations
For the purposes of the present document, the abbreviations given in 3GPP TR
21.905 [1] and the following apply. An abbreviation defined in the present
document takes precedence over the definition of the same abbreviation, if
any, in 3GPP TR 21.905 [1].
EMMI Electrical Man Machine Interface
FFS For further Study
FR2 Frequency Range 2
LB Loop Back
MTC Main Test Component
NSSAI Network Slice Selection Assistance Information
SS System Simulator
TMC Test Mode Control
# 4 UE special conformance test functions overview
## 4.1 Requirements for UE support of test functions
The UE special conformance test functions are required for the support of 5GS
conformance testing. They form a part of the core requirements and thus have a
direct impact on the design of the UE. The use of the word \"mandatory\" in
the present specification shall be understood as a particular requirement
being mandatory for performing UE conformance testing.
NOTE: While the importance of conformance testing should not be
underestimated, and hence is highly recommended, the implementation of
facilitation of it is left to the Device implementation.
## 4.2 UE special conformance test functions concept
The present specification defines the UE special conformance test functions
including any relevant procedure and the Test Mode Control (TMC) message
contents used for information exchange.
The conformance test methods applied in RF/RRM Conformance Test Specification
TS 38.521-1 [12], TS 38.521-2 [13], TS 38.521-3 [14], TS 38.521-4 [15] and TS
38.533 [16], and, the conformance test models used in Protocol Conformance
Test Specifications TS 38.523-1 [3] and TS 38.523-3 [4], as well as, common
test environment definition and Generic procedures specified in TS 38.508-1
[2] utilise the UE special conformance test functions. Default TMC messages
and information element contents utilised in all before mentioned test
specifications are specified in TS 38.508-1 [2].
The UE special conformance test functions vary depending on the conformance
testing functionality they are designed to support. The following broader
groups of UE special conformance test functions can be identified:
\- **Test Loop Functions** : Functions which require a loop to be established
between the UE and the System Simulator (SS) to allow e.g. DL data packets
sent by the SS to be looped back UL by the UE
\- **General Test Functions** : Commands send by the SS e.g. to trigger a
certain UE behaviour which may be a behaviour determined by 3GPP core spec
requirements or such needed to facilitate conformance testing and not being
part of any 3GPP core spec requirements, or, to provide to the UE information
needed for the conformance testing.
NOTE 1: An example for behaviour needed to facilitate conformance testing and
not representing behaviour determined by 3GPP core spec requirements is
counting and reporting the number of received data packets thereby providing
means to the SS to verify 3GPP core spec requirements.
The utilisation of any UE special conformance test functions shall be
considered as putting the UE in a test mode. The duration of the test mode
depends on the UE special conformance test function and in most of the cases
will be delimited by an activation and a deactivation command. However, in the
case of general test functions used e.g. only to provide information relevant
for the conformance testing the test mode can be considered as entered as soon
as the information is received and exited as soon as the information has been
acted upon.
As a common rule the UE special conformance test functions provide access to
isolated functions of the UE via the radio interface without introducing new
physical interfaces just for the reason of conformance testing. However, in
certain cases the usage of AT Commands may be required which will require an
external interface e.g. EMMI.
NOTE 2: It should be emphasised that the UE test functions only describe the
functional behaviour of the UE with respect to its external interfaces;
physical implementation of the UE test function is completely left open to the
manufacturer.
Depending on the conformance testing functionality they are designed to
support, the UE special conformance test functions may comprise:
\- A single DL message (e.g. a test function intended to provide to the UE
information needed for the conformance testing)
\- A Request/Acknowledgement type of 2 messages exchange, an DL message
followed by a UL message, (e.g. a test function intended to request the UE to
execute an action which requires acknowledgment that request was received and
acted upon)
Furthermore, depending on the conformance test scenarios
\- An UE special conformance test function can be used in isolation.
NOTE 3: An example for this is the provision to the UE of location information
which can then be used by the UE throughout its \"normal\" i.e. not test mode
functions dependant behaviour.
\- Two, or more, UE special conformance test functions may need to be executed
in a particular sequence before the target UE behaviour can be assumed.
NOTE 4: An example for this are the Activate UE test mode and Close UE test
loop functions. The former needs to be executed first, at a particular moment
of time, in order a specific type of test bearer terminated in a particular UE
protocol layer to be established. Followed by the latter, executed at
different point of time, which will instruct the UE to start looping back the
received packets.
\- Two, or more, UE special conformance test functions may be executed
simultaneously with no particular relation one to another allowing for
different test mode functionality to take place at the same time.
NOTE 5: An example for this are the UE Beamlock test function and the test
functions needed for test loop mode operation (see NOTE 4). The former may
need to be active throughout the entire tests with the latter being active in
parts of the test as appropriate. Both being active independently.
For the specification of UE special conformance test functions the present
specification may refer to other specifications. In the case when text on the
same matter exists in the present specification and in the referred
specification, the text in the present specification takes precedence.
# 5 UE special conformance test functions operation
## 5.1 General
For consistency with legacy terminology, the present specification uses the
terms \'Activate UE test mode\' and \'Deactivate UE test mode\' for denoting
the activation and the deactivation of 5GS test mode bearers procedures
respectively. Consequently, \'Activate UE test mode\' should not be understood
as setting the UE in test mode in general rather, as setting the UE in a mode
(i.e. establishing a special type of test bearers) which other special UE
conformance testing functions require for proper operation. As this has been
mentioned elsewhere in the present specification, not all special UE
conformance testing functions require such a setting.
Similarly, the present specification may use the term \'UE test loop mode X
operation\", where X is a chose letter, for denoting operation which does not
represent true looping back of data being received rather, it represents what
can be called as a \"pseudo loop\" i.e. providing back information about the
received data e.g. the number of the received packets.
## 5.2 Activation and deactivation of 5GS test mode bearers (UE test mode
procedures)
### 5.2.1 General
The SS performs, where applicable, activation and deactivation of the
conformance test functions in the UE by sending Security Protected NAS Layer 3
messages.
The UE test mode procedures are intended for setting the UE into a test mode
where the SS can set up test bearers terminated at a particular point in the
5GS protocol stack as specified in the functional block diagram of each UE
test loop mode of operation. The following test bearers are defined in the
present specification:
\- data radio bearers (UE test loop mode A),
\- EPS bearers or 5GS QoS flows (UE test loop mode B).
### 5.2.2 Activate UE test mode
Same as TS 36.509 [6], subclause 5.3.2 with the following exceptions:
\- where E-UTRA is mentioned the same applies for NR;
the NB-IoT mode is out of the scope of the present specification;
where different UE test loop modes are mentioned only those applicable to 5GS
should be taken into account (see subclause 5.3.4 for the applicable 5GS UE
test loop modes).
### 5.2.3 Deactivate UE test mode
Same as TS 36.509 [6], subclause 5.3.3 with the following exceptions
\- where E-UTRA is mentioned the same applies for NR;
\- the NB-IoT mode is out of the scope of the present specification;
\- where different UE test loop modes are mentioned only those applicable to
5GS should be taken into account (see subclause 5.3.4 for the applicable 5GS
UE test loop modes).
Apart from sending the appropriate deactivation command to the UE the
functions shall be deactivated by:
switching off the UE; or
by removing the USIM.
## 5.3 Test loop functions
### 5.3.1 General
Before a loop functionality can be exercised, the test loop needs to be
closed; this is to be understood as the UE being instructed to start looping
back received data packets. When looping back received data packets is not any
longer required the loop should be re-opened; opening of a loop does not
change the type of bearer being established by the UE test mode activation
function (subclause 5.2.2).
To limit the number of special test functions, the concept of closing and
opening a loop is also used as instruction to the UE to initiate/terminate
other actions. An example of this is counting the received packets and
reporting the number of received packets back to the SS; in the context of
this utilisation closing a loop is to be understood as the UE being instructed
to start counting the packets, whereas opening a loop should be understood as
stop counting the packets. Other utilisation of the closing/opening a \"test
loop\" test functionality can be specified if appropriate.
The UE test loop functions for 5GS are intended for:
\- NR receiver and transmitter testing to disable application data transfer in
downlink and uplink during SS UE measurements.
\- NR layer 2 (MAC, RLC, PDCP, SDAP) and data radio bearer testing to generate
data transfer in downlink and uplink.
\- 5GC and NR layer 3 testing to verify data transfer continuation over RRC
and 5GC procedures.
\- 5GC NAS user-plane testing to verify uplink QoS flow descriptions handling.
### 5.3.2 Close UE test loop
Same as TS 36.509 [6], subclause 5.4.2 with the following exceptions:
\- where E-UTRA is mentioned the same applies for NR;
\- the NB-IoT mode is out of the scope of the present specification
\- where different UE test loop modes are mentioned only those applicable to
5GS should be taken into account (see subclause 5.3.4 for the applicable 5GS
UE test loop modes).
\- where EPS bearers are mentioned the same applies for 5GS QoS flows; and
\- UE supported minimum buffer size for MR-DC and NR shall match the required
total layer 2 buffer size as specified in TS 38.306 [20], clause 4.1.4.
### 5.3.3 Open UE test loop
Same as TS 36.509 [6], subclause 5.4.5 with the exceptions:
\- where E-UTRA is mentioned the same applies for NR;
\- the NB-IoT mode is out of the scope of the present specification;
\- where different UE test loop modes are mentioned only those applicable to
5GS should be taken into account (see subclause 5.3.4 for the applicable 5GS
UE test loop modes).
### 5.3.4 UE functionality when test loop is closed
#### 5.3.4.1 UE test loop mode A operation
UE test loop mode A provides loopback of PDCP SDUs for bi-directional data
radio bearers while UE is operating in NR. The downlink PDCP SDUs received by
the UE on each bi-directional data radio bearer are returned on the same radio
bearer regardless of the PDCP SDU contents and of the QoS flow descriptions of
the associated QoS Flow as specified in TS 24.501 [21].
Figures 5.3.4.1-1 and 5.3.4.1-2 show functional block diagrams of UE test loop
function for the TMC entity and UE test loop mode A for the case when EN-DC or
NGEN-DC with a MCG bearer and a SCG bearer is configured and for the case EN-
DC or NGEN-DC with a MCG and a split bearer is configured.
Figures 5.3.4.1-3 shows functional block diagrams of UE test loop function for
the TMC entity and UE test loop mode A for the case when standalone NR is
configured.
Figures 5.3.4.1-4 and 5.3.4.1-5 show functional block diagrams of UE test loop
function for the TMC entity and UE test loop mode A for the case when NE-DC
with a MCG bearer and a SCG bearer is configured and for the case NE-DC with a
MCG and a split bearer is configured.
NOTE 1: The number and the order of RB LB Entities in the functional block
diagrams are provided for illustration only. No specific order or numbering is
precluded.
Figure 5.3.4.1-1: Model for Test Mode Control and UE Test Loop Mode A on UE
side when EN-DC or NGEN-DC with MCG bearer and SCG bearer is configured
Figure 5.3.4.1-2: Model for Test Mode Control and UE Test Loop Mode A on UE
side when EN-DC or NGEN-DC with MCG and split bearer configured
Figure 5.3.4.1-3: Model for Test Mode Control and UE Test Loop Mode A on UE
side when standalone NR is configured
Figure 5.3.4.1-4: Model for Test Mode Control and UE Test Loop Mode A on UE
side when NE-DC with MCG and SCG bearers configured
Figure 5.3.4.1-5: Model for Test Mode Control and UE Test Loop Mode A on UE
side when NE-DC with MCG and split bearers configured
UE test loop mode A is mandatory to all 5GS UEs.
Prior to closing the UE test loop mode A, thereby requesting the UE to start
looping back the received data packets, at least one 5GS test mode bi-
directional data radio bearer shall have been established between SS and UE.
This implies that before the procedure for establishing the bi-directional
data radio bearer takes place the SS needs to activate the UE test mode as
specified in subclause 5.2.2.
The 5GS UE test loop mode A operation is the same as the one described in TS
36.509 [6], subclause 5.4.3 with the exception where E-UTRA is mentioned the
same applies for NR, and, the understanding that the NB-IoT mode is out of the
scope of the present specification.
#### 5.3.4.2 UE test loop mode B operation
##### 5.3.4.2.1 General
UE test loop mode B is mandatory to all 5GS UEs supporting one or more PDU
session establishments.
##### 5.3.4.2.2 UE test loop mode B operation for EN-DC and NGEN-DC
UE test loop mode B provides loopback of PDCP SDUs for bi-directional EPS
bearers while UE is operated in NR or E-UTRA modes. When operating in NR or
E-UTRA, the downlink PDCP SDUs or SNDCP PDUs received by the UE on all bi-
directional data radio bearers are returned by the UE on the data radio bearer
associated with an QoS Flow with a QoS flow descriptions matching the
TCP/UDP/IP protocol information within the PDCP SDU or SNDCP SDU as specified
in TS 24.501 [21].
NOTE 1: When multiple PDN connections are established (or multiple Primary PDP
Contexts are active), it is assumed that different IP addresses are allocated
to the UE by the SS on each PDN.
Figures 5.3.4.2.2-1 and 5.3.4.2.2-2 show functional block diagrams of UE test
loop function for the TMC entity and UE test loop mode B for the case when EN-
DC or NGEN-DC with a MCG bearer and a SCG bearer is configured and for the
case EN-DC or NGEN-DC with a MCG and a split bearer is configured.
NOTE 2: The number and the order of RB LB Entities in the UE Test Loop
Function in the functional block diagrams are provided for illustration only.
No specific order or numbering is precluded.
Figure 5.3.4.2.2-1: Model for Test Mode Control and UE Test Loop Mode B on UE
side when EN-DC or NGEN-DC with MCG bearer and SCG bearer is configured
Figure 5.3.4.2.2-2: Model for Test Mode Control and UE Test Loop Mode B on UE
side when EN-DC or NGEN-DC with MCG and split bearer configured
##### 5.3.4.2.3 UE test loop mode B operation for Standalone NR
UE test loop mode B provides loopback of SDAP SDUs for bi-directional QoS
Flows while UE is operated in standalone NR mode. Prior to closing the UE test
loop mode B, thereby requesting the UE to start looping back the received data
packets, at least one 5GS test mode bi-directional QoS Flow shall have been
established between SS and UE. This implies that before the procedure for
establishing the bi-directional QoS Flows takes place the SS needs to activate
the UE test mode as specified in subclause 5.2.2
The downlink SDAP SDUs or IP PDU\'s received by the UE on all bi-directional
QoS Flows are returned by the UE without any modification of the IP header to
the UL QoS flow descriptions handling SAP for transmission in uplink.
NOTE 1: When multiple PDU sessions are established, it is assumed that
different IP addresses are allocated to the UE by the SS on each PDU session.
Figure 5.3.4.2.3-1 shows functional block diagrams of UE test loop function
for the TMC entity and UE test loop mode B for the case when standalone NR is
configured.
NOTE 2: The number and the order of QoS Flow LB Entities in the UE Test Loop
Function in the functional block diagrams are provided for illustration only.
No specific order or numbering is precluded.
The 5GS UE test loop mode B operation is the same as the one described in TS
36.509 [6], subclause 5.4.4 with the exception where E-UTRA is mentioned the
same applies for NR, and, where PDCP SDU is mentioned the same applies for
SDAP SDU.
Figure 5.3.4.2.3-1: Model for Test Mode Control and UE Test Loop Mode B on UE
side when standalone NR is configured
##### 5.3.4.2.4 UE test loop mode B operation for NE-DC
UE test loop mode B provides loopback of SDAP SDUs for bi-directional QoS
Flows while UE is operated in NR or E-UTRA modes. Prior to closing the UE test
loop mode B, thereby requesting the UE to start looping back the received data
packets, at least one 5GS test mode bi-directional QoS Flow shall have been
established between SS and UE. This implies that before the procedure for
establishing the bi-directional QoS Flows takes place the SS needs to activate
the UE test mode as specified in subclause 5.2.2
The downlink SDAP SDUs or IP PDU\'s received by the UE on all bi-directional
QoS Flows are returned by the UE without any modification of the IP header to
the UL QoS flow descriptions handling SAP for transmission in uplink.
NOTE 1: When multiple PDU sessions are established, it is assumed that
different IP addresses are allocated to the UE by the SS on each PDU session.
Figure 5.3.4.2.4-1 and 5.3.4.2.4-2 show functional block diagrams of UE test
loop function for the TMC entity and UE test loop mode B for the case when NE-
DC with a MCG and a SCG bearer is configured and for the case NE-DC with a MCG
and a split bearer is configured.
NOTE 2: The number and the order of QoS Flow LB Entities in the UE Test Loop
Function in the functional block diagrams are provided for illustration only.
No specific order or numbering is precluded.
Figure 5.3.4.2.4-1: Model for Test Mode Control and UE Test Loop Mode B on UE
side when NE-DC with MCG bearer and SCG bearers configured
Figure 5.3.4.2.4-2: Model for Test Mode Control and UE Test Loop Mode B on UE
side when NE-DC with MCG bearer and split bearers configured
## 5.4 UE Beamlock test Function (UBF)
### 5.4.1 General
The UE Beamlock test function is intended for making the UE to lock the UE
antenna pattern once it has formed a beam towards the base station (SS)
direction following the cell identification procedure in preparation for
subsequent test procedures. Activating the UBF shall lock the antenna pattern
of all active intra-band component carriers and all MIMO layers affected by
the test function.
The Beamlock test function is mandatory for applicable UEs operating in
Frequency Range 2 (FR2).
The SS uses the UE Beamlock test mode activation procedure to command the UE
to lock the UE antenna pattern. The Beamlock activation procedure can apply to
UE transmitter and UE receiver beams either simultaneously or independently.
Figure 5.4.1-1: UE Beamlock test mode activation procedure
The SS uses the UE Beamlock test mode deactivation procedure to command the UE
to re-tracking the beam towards the base station direction. The Beamlock
deactivation procedure can apply to UE transmitter and UE receiver beams
either simultaneously or independently.
Figure 5.4.1-2: UE Beamlock test mode deactivation procedure
### 5.4.2 Activate Beamlock procedure
#### 5.4.2.1 Initiation
The SS requests the UE to activate beamlock by transmitting an ACTIVATE
BEAMLOCK message.
#### 5.4.2.2 Reception of ACTIVATE BEAMLOCK message by UE
When UE receives ACTIVATE BEAMLOCK message then the UE shall:
1> if the UE is operating in FR2 AND is in RRC_CONNECTED state:
2> if UE Beamlock test Function = 01
3> Lock the UE antenna pattern with Tx only
> 2> else if UE Beamlock test Function = 10
>
> 3> Lock the UE antenna pattern with Rx only
>
> 2> else if UE Beamlock test Function = 11
3> Lock the UE antenna pattern with both TxRx
2> Transmit ACTIVATE BEAMLOCK COMPLETE message
1> else:
2> the UE behaviour is unspecified.
### 5.4.3 Deactivate Beamlock procedure
#### 5.4.3.1 Initiation
The SS requests the UE to deactivate beamlock by transmitting a DEACTIVATE
BEAMLOCK message. The SS should do this when the UE is in RRC_CONNECTED state.
#### 5.4.3.2 Reception of DEACTIVATE BEAMLOCK message by UE
When UE receives DEACTIVATE BEAMLOCK message then the UE shall:
1> if the UE is operating in FR2 AND is in RRC_CONNECTED state AND the UE
Beamlock test function is active:
2> unlock the UE antenna pattern and transmit DEACTIVATE BEAMLOCK COMPLETE
message;
1> else:
2> the UE behaviour is unspecified.
#### 5.4.3.3 Release of antenna beamlock by UE
When the UE leaves the RRC_CONNECTED state, the UE shall:
1> if the UE is operating in FR2 AND the UE Beamlock test Function is active
2> unlock the UE antenna pattern;
## 5.5 UE SS-RSRPB per receiver branch reporting
### 5.5.1 General
In 38.215 [22], section 5.1.18 defines SS-RSRPB as below, with its
applicability only to FR2 and in RRC_CONNECTED Mode.
+--------------------+------------------------------------------------+ | **Definition** | SS reference signal received power per branch | | | (SS-RSRPB) is defined as the linear average | | | over the power contributions (in [W]) of the | | | resource elements that carry secondary | | | synchronization signals (SS). The measurement | | | time resource(s) for SS-RSRPB are confined | | | within SS/PBCH Block Measurement Time | | | Configuration (SMTC) window duration. | | | | | | For SS-RSRPB determination demodulation | | | reference signals for physical broadcast | | | channel (PBCH) and, if indicated by higher | | | layers, CSI reference signals in addition to | | | secondary synchronization signals may be used. | | | SS-RSRPB using demodulation reference signal | | | for PBCH or CSI reference signal shall be | | | measured by linear averaging over the power | | | contributions of the resource elements that | | | carry corresponding reference signals taking | | | into account power scaling for the reference | | | signals as defined in 3GPP TS 38.213 [5]. | | | | | | SS-RSRPB shall be measured only among the | | | reference signals corresponding to SS/PBCH | | | blocks with the same SS/PBCH block index and | | | the same physical-layer cell identity. | | | | | | If higher-layers indicate certain SS/PBCH | | | blocks for performing SS-RSRPB measurements, | | | then SS-RSRPB is measured only from the | | | indicated set of SS/PBCH block(s). | | | | | | For frequency range 1, SS-RSRPB is not | | | defined. For frequency range 2, SS-RSRPB shall | | | be measured for each receiver branch based on | | | the combined signal from antenna elements | | | corresponding to the receiver branch. | +--------------------+------------------------------------------------+ | **Applicable for** | RRC_CONNECTED intra-frequency | +--------------------+------------------------------------------------+
The SS uses the SS-RSRPB reporting procedure to command the UE to report SS-
RSRP per UE receiver branch. The report from the UE shall be a vector of
values, where the number of the reported values equals the number of receiver
branches on the UE.
Figure 5.5.1-1: UE SS-RSRPB reporting procedure
### 5.5.2 Initiation
The SS requests the UE to start reporting SS-RSRP per receiver branch by
transmitting a SS-RSRPB REPORT REQUEST message. And the UE responds back
reporting SS-RSRP per receiver branch via SS-RSRPB REPORT RESPONSE.
### 5.5.3 Reception of SS-RSRPB REPORT REQUEST message by UE
When the UE receives SS-RSRPB REPORT REQUEST message then the UE shall:
1> if the UE is operating in FR2 AND in RRC_CONNECTED state:
2> if quantityConfigRS-Index is configured to UE by RRC Signalling
3> use the L3 filter coefficient given by quantityConfigRS-Index.
2> else
3> use default L3 filter coefficient of fc4.
2> if the MeasObjectId signalled by the IE SS-RSRPB Measurement Config and
ReportConfigNR with reportType set to periodical which is associated to this
MeasObjectNR are configured to the UE by RRC Signalling
3> Reply with the SS-RSRPB REPORT RESPONSE using the Measurement configuration
as in the Measurement Object identified in the SS-RSRPB Measurement Config and
reportInterval, reportAmount as in the associated ReportConfigNR
3> Report the SS-RSRPB measurement for the best SSB-ID of the serving PCI
configured in the MeasObject
3> FFS to have multiple cells and/or SSB-ID
2> else if the MeasObjectId signalled by the IE SS-RSRPB Measurement Config is
configured to the UE by RRC signalling but no ReportConfigNR with reportType
set to periodical is associated to this MeasObjectNR:
3> Reply with the SS-RSRPB REPORT RESPONSE using the Measurement configuration
as in the Measurement Object identified in the SS-RSRPB Measurement Config and
default reportInterval of 640ms, and default reportAmount of r16
3> Report the SS-RSRPB measurement for the serving PCI and best SSB-ID
configured in the MeasObject
3> FFS to have multiple cells and/or SSB-ID
2> else the UE behaviour is unspecified.
1> else:
2> the UE behaviour is unspecified.
The SS-RSRPB Report Request & SS-RSRPB Report Response Message Octets are
defined below in Section 6.5.
## 5.6 UE Positioning test mode procedures
### 5.6.1 Reset UE Positioning Stored Information
#### 5.6.1.1 General
Same as TS 36.509 [6], subclause 5.5.1.1.
#### 5.6.1.2 Initiation
Same as TS 36.509 [6], subclause 5.5.1.2.
#### 5.6.1.3 Reception of RESET UE POSITIONING STORED INFORMATION message by
UE
Same as TS 36.509 [6], subclause 5.5.1.3 with the following exception:
\- where OTDOA is mentioned this applies to OTDOA using LTE cells.
### 5.6.2 Update UE Location Information
Figure 5.6.2-1: Update UE Location Information procedure
#### 5.6.2.1 General
Same as TS 36.509 [6], subclause 5.5.2.1.
#### 5.6.2.2 Initiation
Same as TS 36.509 [6], subclause 5.5.2.2.
### 5.6.3 UTC time reset
FFS
## 5.7 NSSAI delete test function
### 5.7.1 General
The SS use the NSSAI delete test procedure to delete different type of NSSAI
information in the UE, see Figure 5.7.1-1. The different types of NSSAI
information that can be deleted in a NSSAI DELETE REQUEST message are Default
configured NSSAI, Configured NSSAI or Allowed NSSAI information, see clause
6.7. The NSSAI delete test procedure is limited to delete one type of NSSAI
information. To delete more than one type of NSSAI information the SS needs to
repeat the procedure for each type of NSSAI information.
Figure 5.7.1-1: NSSAI delete test procedure
5.7.2 Initiation
The SS requests the UE to delete NSSAI information by transmitting a NSSAI
DELETE REQUEST message and the UE confirms the deletion of the requested NSSAI
information by responding with a NSSAI DELETE RESPONSE message.
5.7.3 Reception of NSSAI DELETE REQUEST message by UE
When UE receives NSSAI DELETE REQUEST message then the UE shall:
1> if the UE is operating in RRC_CONNECTED state:
2> if Delete NSSAI type = 00:
3> Delete the default configured NSSAI stored at the UE if any.
> 2> else if Delete NSSAI type = 01:
3> if Octets 3,4 and 5 all set to \"00000000\":
4> Delete configured NSSAI for all PLMNs stored at the UE if any.
3> else if at least one of octets 3,4 or 5 \<> \"00000000\":
4> Delete configured NSSAI for the PLMN indicated by octet 3,4 and 5 stored at
the UE if any.
2> else if Delete NSSAI type = 10:
3> if Octets 3,4 and 5 all set to \"00000000\":
4> if Access type =00:
5> Delete allowed NSSAI associated with 3GPP access for all PLMNs stored at
the UE if any.
4> else if Access type =01:
5> Delete allowed NSSAI associated with non-3GPP access for all PLMNs stored
at the UE if any.
4> else if Access type =10:
5> Delete allowed NSSAI associated with both 3GPP and non-3GPP access for all
PLMNs stored at the UE if any.
4> else
5> The UE behaviour is unspecified.
3> else if At least one of octets 3,4 or 5 \<> \"00000000\":
4> if Access type =00:
5> Delete allowed NSSAI associated with 3GPP access for the PLMN indicated by
octet 3,4 and 5 stored at the UE if any.
4> else if Access type =01:
5> Delete allowed NSSAI associated with non-3GPP access for the PLMN indicated
by octet 3,4 and 5 stored at the UE if any.
4> else if Access type =10:
5> Delete allowed NSSAI associated with both 3GPP and non-3GPP access for the
PLMN indicated by octet 3,4 and 5 stored at the UE if any.
4> else
5> The UE behaviour is unspecified.
2> else
3> The UE behaviour is unspecified.
2> Transmit NSSAI DELETE RESPONSE message.
1> else:
2> the UE behaviour is unspecified.
# 6 Test Mode Control message definitions
## 6.1 General
Clause 6 describes only TMC protocol messages.
When UE under test is operated in EN-DC or NGEN-DC the TMC messages are sent
using the E-UTRA RRC _DLInformationTransfer_ and _ULInformationTransfer_
procedures, see TS 36.331 [10], subclauses 5.6.1 and 5.6.2.
When UE under test is operated in NR or NE-DC the TMC messages are sent using
the NR RRC _DLInformationTransfer_ and _ULInformationTransfer_ procedures, see
TS 38.331 [11], subclauses 5.7.1 and 5.7.2.
NOTE 1: A message received with skip indicator different from 0 will be
ignored.
NOTE 2: For general definition of Layer 3 message format see TS 24.007 [7],
clause 11.
NOTE 3: 5GS use the same protocol discriminator value (\"1111\") as E-UTRA,
UTRA and GSM/GPRS as specified in TS 24.007 [7], subclause 11.2.3.1.1. 5GS
test control messages the message type value series 1010xxxx is reserved,
where x represents 0 or 1. The message type values 0000xxxx to 1001xxxx are
reserved to E-UTRA, UTRA and GSM/GPRS as specified in TS 36.509 [6], TS 34.109
[8] and TS 44.014 [9]. For 5GS test control messages that are common with
E-UTRA control messages in TS 36.509 [6] the 5GS test control messages use the
same message type values as used for the E-UTRA test control messages in TS
36.509 [6].
All the TMC messages are integrity protected and ciphered according to TS
24.301 [17] subclause 4.4 or TS 24.501 [21] subclause 4.4 depending on whether
the TMC message is sent via EPS or 5GC.
## 6.2 Test mode messages
### 6.2.1 ACTIVATE TEST MODE
Same as TS 36.509 [6], subclause 6.5.
### 6.2.2 ACTIVATE TEST MODE COMPLETE
Same as TS 36.509 [6], subclause 6.6.
### 6.2.3 DEACTIVATE TEST MODE
Same as TS 36.509 [6], subclause 6.7.
### 6.2.4 DEACTIVATE TEST MODE COMPLETE
Same as TS 36.509 [6], subclause 6.8.
## 6.3 Test loop messages
### 6.3.1 CLOSE UE TEST LOOP
Same as TS 36.509 [6], subclause 6.1 with the following exception:
\- The supported test modes for 5GS are limited to those specified in
subclause 5.3.4.
\- LB Setup DRB#k IE is:
8 7 6 5 4 3 2 1 bit no.
* * *
Z15 Z14 Z13 Z12 Z11 Z10 Z9 Z8 octet 1 Z7 Z6 Z5 Z4 Z3 Z2 Z1 Z0 octet 2 Reserved
Q5 Q4 Q3 Q2 Q1 Q0 octet 3
Z15..Z0 = Uplink PDCP SDU size in bits 0.. 12160 (binary coded, Z15 is most
significant bit and Z0 least significant bit). See Note 1.\ Q5 = 0 for E-UTRA
Data Radio Bearers and Q5 = 1 for NR Data Radio Bearers
Q4..Q0 = 0..31 representing DRB-Identity -1, where DRB-Identity identifies the
data radio bearer in accordance to TS 36.331 [10] for E-UTRA Data Radio
Bearers and TS 38.331 [11] for NR Data Radio Bearers [11] (binary coded, Q4 is
most significant bit and Q0 least significant bit).
NOTE 1: The UL PDCP SDU size is limited to 12160 bits (1520 octets).
NOTE 2: A \"LB Setup DRB IE\" is only needed for a DRB if UL PDCP SDU scaling
is needed. If there is no \"LB Setup DRB IE\" associated with a DRB in the
CLOSE UE TEST LOOP message, then the same size of the PDCP SDU received in
downlink is returned in uplink.
NOTE 3: The UL PDCP SDU size shall be byte aligned (i.e. multiple of 8 bits)
according to TS 36.323 [18] clause 6.2.1 for E-UTRA Data Radio Bearers and TS
38.323 [19] clause 6.2.1 for NR Data Radio Bearers.
### 6.3.2 CLOSE UE TEST LOOP COMPLETE
Same as TS 36.509 [6], subclause 6.2.
### 6.3.3 OPEN UE TEST LOOP
Same as TS 36.509 [6], subclause 6.3.
### 6.3.4 OPEN UE TEST LOOP COMPLETE
Same as TS 36.509 [6], subclause 6.4.
### 6.3.5 Void
### 6.3.6 Void
## 6.4 Beamlock messages
### 6.4.1 ACTIVATE BEAMLOCK
This message is only sent in the direction SS to UE.
* * *
Information Element Reference Presence Format Length Protocol discriminator TS
24.007 [5], sub clause 11.2.3.1.1 M V ½ Skip indicator TS 24.007 [5], sub
clause 11.2.3.1.2 M V ½ Message type M V 1 UE Beamlock test Function M V 1
* * *
where message type is:
* * *
8 7 6 5 4 3 2 1 bit no. 1 0 1 0 0 0 0 0 octet 1
* * *
where UE Beamlock test Function is:
8 7 6 5 4 3 2 1 bit no.
* * *
                          X1   X2   octet 1
where X1,X2 = 01 for activate beamlock of Tx only, 10 for activate beamlock of
Rx only and 11 for activate beamlock of both TxRx.
_NOTE:_ X1,X2 = 00 is not used
### 6.4.2 ACTIVATE BEAMLOCK COMPLETE
This message is only sent in the direction UE to SS.
* * *
Information Element Reference Presence Format Length Protocol discriminator TS
24.007 [5], sub clause 11.2.3.1.1 M V ½ Skip indicator TS 24.007 [5], sub
clause 11.2.3.1.2 M V ½ Message type M V 1
* * *
where message type is:
* * *
8 7 6 5 4 3 2 1 bit no. 1 0 1 0 0 0 0 1 octet 1
* * *
### 6.4.3 DEACTIVATE BEAMLOCK
This message is only sent in the direction SS to UE.
* * *
Information Element Reference Presence Format Length Protocol discriminator TS
24.007 [5], sub clause 11.2.3.1.1 M V ½ Skip indicator TS 24.007 [5], sub
clause 11.2.3.1.2 M V ½ Message type M V 1
* * *
where message type is:
* * *
8 7 6 5 4 3 2 1 bit no. 1 0 1 0 0 0 1 0 octet 1
* * *
### 6.4.4 DEACTIVATE BEAMLOCK COMPLETE
This message is only sent in the direction UE to SS.
* * *
Information Element Reference Presence Format Length Protocol discriminator TS
24.007 [5], sub clause 11.2.3.1.1 M V ½ Skip indicator TS 24.007 [5], sub
clause 11.2.3.1.2 M V ½ Message type M V 1
* * *
where message type is:
* * *
8 7 6 5 4 3 2 1 bit no. 1 0 1 0 0 0 1 1 octet 1
* * *
## 6.5 UE SS-RSRP per receiver branch reporting messages
### 6.5.1 SS-RSRPB REPORT REQUEST
This message is only sent in the direction SS to UE.
* * *
Information Element Reference Presence Format Length Protocol discriminator TS
24.007 [5], subclause 11.2.3.1.1 M V ½ Skip indicator TS 24.007 [5], sub
clause 11.2.3.1.2 M V ½ Message type M V 1 SS-RSRPB Measurement Config M V 1
* * *
where message type is:
* * *
8 7 6 5 4 3 2 1 bit no. 1 0 1 0 0 1 0 0 octet 1
* * *
where SS-RSRPB Measurement Config is:
* * *
8 7 6 5 4 3 2 1 bit no. X8 X7 X6 X5 X4 X3 X2 X1 octet 1
* * *
This maps to the MeasObjectId as configured by the RRC Reconfig Message.
### 6.5.2 SS-RSRPB REPORT RESPONSE
This message is only sent in the direction UE to SS representing the measured
SS-RSRPB. The reporting range of SS-RSRPB (0 to 126) maps to the RSRP values
in dBm as per Table 10.1.6.1-1 in TS 38.133. To report SS-RSRPB (0 to 126) per
measured SSB, UE shall send 3 Octets, the First Octet reporting the Measured
SSB ID (values 0 to 63 representing 6 bits X1 to X6 of Octet 1), Second Octet
reporting SS-RSRPB for Branch#0 and third Octet reporting SS-RSRPB for
Branch#1.
* * *
Information Element Reference Presence Format Length Protocol discriminator TS
24.007 [5], subclause 11.2.3.1.1 M V ½ Skip indicator TS 24.007 [5], sub
clause 11.2.3.1.2 M V ½ Message type M V 1 SS-RSRPB report response param M V
3
* * *
where message type is:
* * *
8 7 6 5 4 3 2 1 bit no. 1 0 1 0 0 1 0 1 octet 1
* * *
where SS-RSRPB report response param is:
* * *
8 7 6 5 4 3 2 1 bit no. Reserved X6 X5 X4 X3 X2 X1 octet 1  
16 15 14 13 12 11 10 9 bit no. X16 X15 X14 X13 X12 X11 X10 X9 octet 2 24 23 22
21 20 19 18 17 bit no. X24 X23 X22 X21 X20 X19 X18 X17 octet 3
* * *
where X1 to X24 spanning over three octets shall have the following
definition:
Definition 8 7 6 5 4 3 2 1 bit no.
* * *
SSB ID Reserved X6 X5 X4 X3 X2 X1 octet 1  
RSRPB Branch #0 0 X15 X14 X13 X12 X11 X10 X9 octet 2 RSRPB Branch #1 0 X23 X22
X21 X20 X19 X18 X17 octet 3
## 6.6 UE Positioning messages
### 6.6.1 RESET UE POSITIONING STORED INFORMATION
Same as TS 36.509 [6], subclause 6.9 with the following exception:
\- where OTDOA is mentioned this applies to OTDOA using LTE cells.
### 6.6.2 UPDATE UE LOCATION INFORMATION
Same as TS 36.509 [6], subclause 6.12.
## 6.7 NSSAI delete messages
### 6.7.1 NSSAI DELETE REQUEST
This message is only sent in the direction SS to UE.
Information Element Reference Presence Format Length
* * *
Protocol discriminator TS 24.007 [5], sub clause 11.2.3.1.1 M V ½ Skip
indicator TS 24.007 [5], sub clause 11.2.3.1.2 M V ½ Message type M V 1 Delete
NSSAI type M V 1 Configured NSSAI CV- ConfNSSAI V 3 Allowed NSSAI CV-
AllowedNSSAI V 4
* * *
Condition Explanation CV- ConfNSSAI This IE is mandatory present if the IE
\"Delete NSSAI type\" is set to Delete Configured NSSAI. Else it shall be
absent. CV- AllowedNSSAI This IE is mandatory present if the IE \"Delete NSSAI
type\" is set to Delete Allowed NSSAI. Else it shall be absent.
* * *
where message type is:
8 7 6 5 4 3 2 1 bit no.
* * *
1 0 1 0 0 1 1 0 octet 1
where Delete NSSAI type is:
8 7 6 5 4 3 2 1 bit no.
* * *
Reserved E1 E0 octet 2
E1=0 and E0=0; Delete default configured NSSAI.
E1=0 and E0=1; Delete Configured NSSAI.
E1=1 and E0=0: Delete Allowed NSSAI.
where Configured NSSAI type
E1=1 and E0=1: Reserved.
8 7 6 5 4 3 2 1 bit no.
* * *
MCC digit 2 MCC digit 1 octet 3  
MNC digit 3 MCC digit 3 octet 4  
MNC digit 2 MNC digit 1 octet 5
Octets 3,4 and 5 all set to \"00000000\": Delete configured NSSAI for all
configured PLMNs.
At least one of octets 3,4 or 5 \<> \"00000000\": Delete configured NSSAI for
the PLMN indicated by octet 3.4 and 5,
\- where octets 3 and 4 (bits 1 to 4) is MCC, Mobile country code. The MCC is
BCD coding. The MCC field is coded as in ITU-T Rec. E212 [39], annex A; and
\- where octet 4 (bits 5 to 8) and octet 5 is MNC, Mobile network code. The
MNC is BCD coding. The MNC shall consist of 2 or 3 digits. If only two digits
are used in the MNC then shall MNC digit 3 be set to \"1111\".
where Allowed NSSAI:
8 7 6 5 4 3 2 1 bit no.
* * *
MCC digit 2 MCC digit 1 octet 3  
MNC digit 3 MCC digit 3 octet 4  
MNC digit 2 MNC digit 1 octet 5  
Reserved A1 A0 octet 6
Octets 3,4 and 5 all set to \"00000000\": Delete NSSAI for all allowed PLMNs.
At least one of octets 3,4 or 5 \<> \"00000000\": Delete allowed NSSAI for the
PLMN indicated by octet 3.4 and 5,
\- where octets 3 and 4 (bits 1 to 4): MCC, Mobile country code. The MCC is
BCD Coding. The MCC field is coded as in ITU-T Rec. E212 [39], annex A; and
\- where octet 4 (bits 5 to 8) and octet 5 is MNC, Mobile network code. The
MNC is BCD coding. The MNC shall consist of 2 or 3 digits. If only two digits
are used in the MNC then shall MNC digit 3 be coded as \"1111\"; and
\- where octet 6 is
8 7 6 5 4 3 2 1 bit no.
* * *
Reserved A1 A0 octet 6
> where A0 and A1 define the access type:
**A1** **A0** **Value**
* * *
0 0 3GPP access 0 1 Non-3GPP access 1 0 3GPP access and non-3GPP access 1 1
reserved
### 6.7.2 NSSAI DELETE RESPONSE
This message is only sent in the direction UE to SS.
Information Element Reference Presence Format Length
* * *
Protocol discriminator TS 24.007 [5], sub clause 11.2.3.1.1 M V ½ Skip
indicator TS 24.007 [5], sub clause 11.2.3.1.2 M V ½ Message type M V 1
where message type is:
8 7 6 5 4 3 2 1 bit no.
* * *
1 0 1 0 0 1 1 1 octet 1
# 7 Variables, constants and timers
## 7.1 State variables
Same as [9] TS 36.509, subclause 7.1.
## 7.2 Constants
Same as [9] TS 36.509, subclause 7.2.
## 7.3 Timers
Same as [9] TS 36.509, subclause 7.3.
## 7.4 Configurable parameters
Same as [9] TS 36.509, subclause 7.4.
# 8 Electrical Man Machine Interface (EMMI)
The EMMI is used for automation of conformance testing. The commands used on
the EMMI by the System Simulator, shall be limited to those specified in TS
38.523-3 [3]. An illustration is given in figure 8-1 as an example.
At the System Simulator side, the logical EMMI using mandatory AT commands
shall interface with the Main Test Component (MTC) of TTCN test cases which
hosts the Upper Tester. The physical EMMI interface towards the UE may be for
example a standard USB interface. Other interfaces of proprietary or
standardized type shall not be precluded.
At the UE side an adapter needs to be provided by the UE manufacturer for
converting the commands into the UE manufacturer specific interface and
format.
The use of EMMI is optional for the UE.
Figure 8-1: An example of EMMI and its use for automation of signalling
testing
#
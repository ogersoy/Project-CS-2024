# Foreword
This Technical Specification has been produced by the 3rd Generation
Partnership Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# 1 Scope
The present document defines the Stage 2 procedures and Network Function
Services for the 5G system architecture which is described in the TS 23.501
[2] and for the policy and charging control framework which is described in TS
23.503 [20].
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or nonâ€‘specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
[1] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[2] 3GPP TS 23.501: \" System Architecture for the 5G System; Stage 2\".
[3] IETF RFC 7296: _\"_ Internet Key Exchange Protocol Version 2 (IKEv2)_\"._
[4] IETF RFC 5998: _\"_ An Extension for EAP-Only Authentication in IKEv2
_\"._
[5] IETF RFC 4282: \"The Network Access Identifier\".
[6] IETF RFC 4861: \"Neighbor Discovery for IP version 6 (IPv6)\".
[7] 3GPP TS 23.040: \"Technical realization of the Short Message Service
(SMS)\".
[8] IETF RFC 4862: \"IPv6 Stateless Address Autoconfiguration\".
[9] 3GPP TS 38.300: \"NR and NG-RAN Overall Description; Stage 2\".
[10] 3GPP TS 38.413: \"NG-RAN; NG Application Protocol (NGAP)\".
[11] 3GPP TS 23.335:\" User Data Convergence (UDC); Technical realization and
information flows; Stage 2\".
[12] 3GPP TS 38.331: \"NR; Radio Resource Control (RRC); Protocol
Specification\".
[13] 3GPP TS 23.401: \"General Packet Radio Service (GPRS) enhancements for
Evolved Universal Terrestrial Radio Access Network (E-UTRAN) access\".
[14] 3GPP TS 23.221: \"Architectural requirements \".
[15] 3GPP TS 33.501: \"Security Architecture and Procedures for 5G System\".
[16] 3GPP TS 36.331: \"Evolved Universal Terrestrial Radio Access (E-UTRA);
Radio Resource Control (RRC); Protocol specification\".
[17] 3GPP TS 29.500: \"5G System; Technical Realization of Service Based
Architecture; Stage 3\".
[18] 3GPP TS 29.518: \"5G System; Access and Mobility Management Services;
Stage 3\".
[19] 3GPP TS 29.519: \"5G System; Usage of the Unified Data Repository service
for Policy Control Data and Structured Data; Stage 3\".
[20] 3GPP TS 23.503: \"Policy and Charging Control Framework for the 5G System
\".
[21] IETF RFC 4191: \"Default Router Preferences and More-Specific Routes\".
[22] 3GPP TS 23.122: \"Non-Access-Stratum (NAS) functions related to Mobile
Station in idle mode\".
[23] 3GPP TS 23.682: \"Architecture enhancements to facilitate communications
with packet data networks and applications\".
[24] 3GPP TS 23.203: \"Policy and charging control architecture\".
[25] 3GPP TS 24.501: \"Non-Access-Stratum (NAS) protocol for 5G System (5GS);
Stage 3\".
[26] 3GPP TS 23.402: \"Architecture enhancements for non-3GPP accesses\".
[27] OMA-TS-ULP-V2_0_3: \"UserPlane Location Protocol\".
[28] 3GPP TS 23.167: \"IP Multimedia Subsystem (IMS) emergency sessions\".
[29] 3GPP TS 23.271: \"Functional stage 2 description of Location Services
(LCS)\".
[30] 3GPP TS 36.355: \"LTE Positioning Protocol (LPP)\".
[31] 3GPP TS 38.455: \"NR Positioning Protocol A (NRPPa)\".
[32] 3GPP TS 29.507: \"Access and Mobility Policy Control Service; Stage 3\".
[33] 3GPP TS 23.003: \"Numbering, Addressing and Identification\".
[34] 3GPP TS 32.240: \"Charging management; Charging architecture and
principles\".
[35] 3GPP TS 23.251: \"Network sharing; Architecture and functional
description\".
[36] 3GPP TS 29.502: \"5G System; Session Management Services; Stage 3\".
[37] 3GPP TS 29.510: \"5G System; Network function repository services; Stage
3\".
[38] 3GPP TS 23.380: \"IMS Restoration Procedures\".
[39] 3GPP TS 32.421: \"Telecommunication management; Subscriber and equipment
trace; Trace concepts and requirements\".
[40] IETF RFC 4555: \"IKEv2 Mobility and Multihoming Protocol (MOBIKE)\".
[41] 3GPP TS 24.502: \"Access to the 3GPP 5G Core Network (5GCN) via Non-3GPP
Access Networks (N3AN); Stage 3\".
[42] 3GPP TS 32.290:\" Services, operations and procedures of charging using
Service Based Interface (SBI)\".
[43] 3GPP TS 36.304: \"Evolved Universal Terrestrial Radio Access (E-UTRA);
User Equipment (UE) procedures in idle mode\".
[44] 3GPP TS 38.304: \"NR; User Equipment (UE) procedures in idle mode\".
[45] 3GPP TS 32.255: \"5G system; 5G data connectivity domain charging; Stage
2\".
[46] 3GPP TS 36.300: \"Evolved Universal Terrestrial Radio Access (E-UTRA) and
Evolved Universal Terrestrial Radio Access Network (E-UTRAN); Overall
description; Stage 2\".
[47] 3GPP TS 29.513: \"5G System; Policy and Charging Control signalling flows
and QoS parameter mapping; Stage 3\".
[48] 3GPP TS 29.512: \"5G System; Session Management Policy Control Service;
Stage 3\".
[49] 3GPP TS 29.525: \"5G System; UE Policy Control Service; Stage 3\".
[50] 3GPP TS 23.272: \"Circuit Switched (CS) fallback in Evolved Packet System
(EPS); Stage 2\".
[51] 3GPP TS 29.561: \"5G System; Interworking between 5G Network and external
Data Networks; Stage 3\".
# 3 Definitions, symbols and abbreviations
## 3.1 Definitions
For the purposes of the present document, the terms and definitions given in
TR 21.905 [1], TS 23.501 [2] and TS 23.503 [20] apply. A term defined in TS
23.501 [2] or TS 23.503 [20] takes precedence over the definition of the same
term, if any, in any other specifications.
## 3.2 Abbreviations
For the purposes of the present document, the abbreviations given in TR 21.905
[1], TS 23.501 [2] and TS 23.503 [20] apply. An abbreviation defined in TS
23.501 [2] or TS 23.503 [20] takes precedence over the definition of the same
abbreviation, if any, in any other specifications.
# 4 System procedures
## 4.1 General
The clause 4 describes the procedures and Network Function services for the
5GS by end-to-end information flows and these information flows make use of NF
service operations, defined in clause 5, for the communication within the 5GC
Control Plane.
## 4.2 Connection, Registration and Mobility Management procedures
### 4.2.1 General
The Connection Management is used to establish and release the Control Plane
signalling connection between the UE and the AMF. The Registration Management
is used to register or deregister a UE/user with the 5GS and establish the
user context in the 5GS. The Mobility Management functions are used to keep
track of the current location of a UE. The procedures in clause 4.2 provides
Connection, Registration and Mobility Management functionality.
### 4.2.2 Registration Management procedures
#### 4.2.2.1 General
The Registration and Deregistration procedures in clause 4.2.2 provides the
required functionality to register or deregister a UE/user with the 5GS.
Additional functionality to support Registration Management for non-3GPP
access is defined in clause 4.12. Additional functionality to support
Registration Management for specific services such as SMS over NAS is defined
in clause 4.13.
#### 4.2.2.2 Registration procedures
##### 4.2.2.2.1 General
A UE needs to register with the network to get authorized to receive services,
to enable mobility tracking and to enable reachability. The UE initiates the
Registration procedure using one of the following Registration types:
\- Initial Registration to the 5GS;
\- Mobility Registration Update upon changing to a new Tracking Area (TA)
outside the UE\'s Registration Area in both CM-CONNECTED and CM-IDLE state, or
when the UE needs to update its capabilities or protocol parameters that are
negotiated in Registration procedure with or without changing to a new TA; or
when the UE intends to retrieve LADN Information; or
\- Periodic Registration Update (due to a predefined time period of
inactivity); or
\- Emergency Registration.
The General Registration call flow in clause 4.2.2.2.2 applies on all these
Registration procedures, but the periodic registration need not include all
parameters that are used in other registration cases.
The following are the cleartext IEs, as defined in TS 24.501 [25] that can be
sent by the UE in the Registration Request message if the UE has no NAS
security context:
\- Registration type
\- SUCI or 5G-GUTI or PEI
\- Security parameters
\- additional GUTI
\- 4G Tracking Area Update
\- the indication that the UE is moving from EPS.
Aspects related to dual registration in 3GPP and non-3GPP access are described
in clause 4.12. The general Registration call flow in clause 4.2.2.2.2 is also
used for the case of registration in 3GPP access when the UE is already
registered in a non-3GPP access and vice versa. Registration in 3GPP access
when the UE is already registered in a non-3GPP access scenario may require an
AMF change, as further detailed in clause 4.12.8.
The general Registration call flow in clause 4.2.2.2.2 is also used by UEs in
limited service state (see TS 23.122 [22]) registering for emergency services
only (referred to as Emergency Registration), see clause 5.16.4 of TS 23.501
[2].
During the initial registration the PEI is obtained from the UE. If the PEI is
needed (e.g. for EIR check), the AMF shall retrieve the PEI when it
establishes the NAS security context with a Security Mode Command during
initial registration. The AMF operator may check the PEI with an EIR. If the
PEI was retrieved by the AMF (either from the UE or another AMF), AMF shall
provide it to the UDM using Nudm_UECM_Registration in order to ensure that the
UDM always has the latest PEI available e.g. for reporting event Change of
SUPI-PEI association. The AMF passes the PEI (IMEISV) to the UDM, to the SMF
and the PCF. The UDM may store this data in UDR by Nudr_SDM_Update.
NOTE 1: The use of NSI ID in the 5GC is optional and depends on the deployment
choices of the operator.
During the registration the Home Network can provide Steering of Roaming
information to the UE via the AMF (i.e. a list of preferred PLMN/access
technology combinations or HPLMN indication that \'no change of the \"Operator
Controlled PLMN Selector with Access Technology\" list stored in the UE is
needed). The Home Network can include an indication for the UE to send an
acknowledgement of the reception of this information. Details regarding the
handling of Steering of Roaming information including how this information is
managed between the AMF and the UE are defined in TS 23.122 [22].
##### 4.2.2.2.2 General Registration
Figure 4.2.2.2.2-1: Registration procedure
1\. UE to (R)AN: AN message (AN parameters, Registration Request (Registration
type, SUCI or 5G-GUTI or PEI, last visited TAI (if available), Security
parameters, Requested NSSAI, [Mapping Of Requested NSSAI], Default Configured
NSSAI Indication, UE Radio Capability Update, UE MM Core Network Capability,
PDU Session status, List Of PDU Sessions To Be Activated, Follow-on request,
MICO mode preference, Requested DRX parameters, [LADN DNN(s) or Indicator Of
Requesting LADN Information], [NAS message container]) and UE Policy Container
(the list of PSIs, indication of UE support for ANDSP and the operating system
identifier)).
NOTE 1: The UE Policy Container and its usage is defined in TS 23.503 [20].
In the case of NG-RAN, the AN parameters include e.g. 5G-S-TMSI or GUAMI, the
Selected PLMN ID and Requested NSSAI, the AN parameters also include
Establishment cause. The Establishment cause provides the reason for
requesting the establishment of an RRC connection. Whether and how the UE
includes the Requested NSSAI as part of the AN parameters is dependent on the
value of the Access Stratum Connection Establishment NSSAI Inclusion Mode
parameter, as specified in clause 5.15.9 of TS 23.501 [2].
The Registration type indicates if the UE wants to perform an Initial
Registration (i.e. the UE is in RM-DEREGISTERED state), a Mobility
Registration Update (i.e. the UE is in RM-REGISTERED state and initiates a
Registration procedure due to mobility or due to the UE needs to update its
capabilities or protocol parameters, or to request a change of the set of
network slices it is allowed to use), a Periodic Registration Update (i.e. the
UE is in RM-REGISTERED state and initiates a Registration procedure due to the
Periodic Registration Update timer expiry, see clause 4.2.2.2.1) or an
Emergency Registration (i.e. the UE is in limited service state).
When the UE is performing an Initial Registration the UE shall indicate its UE
identity in the Registration Request message as follows, listed in decreasing
order of preference:
\- a native 5G-GUTI assigned by the which the UE is attempting to register, if
available;
\- a native 5G-GUTI assigned by an equivalent PLMN to the PLMN to which the UE
is attempting to register, if available;
\- a native 5G-GUTI assigned by any other PLMN, if available.
NOTE 2: This can also be a 5G-GUTIs assigned via another access type.
\- Otherwise, the UE shall include its SUCI in the Registration Request as
defined in TS 33.501 [15].
The NAS message container shall be included if the UE is sending a
Registration Request message as an Initial NAS message and the UE has a valid
5G NAS security context and the UE needs to send non-cleartext IEs, see clause
4.4.6 in TS 24.501 [25]. If the UE does not need to send non-cleartext IEs,
the UE shall send a Registration Request message without including the NAS
message container.
If the UE does not have a valid 5G NAS security context, the UE shall send the
Registration Request message without including the NAS message container. The
UE shall include the entire Registration Request message (i.e. containing
cleartext IEs and non-cleartext IEs) in the NAS message container that is sent
as part of the Security Mode Complete message in step 9b.
When the UE is performing an Initial Registration (i.e. the UE is in RM-
DEREGISTERED state) with a native 5G-GUTI then the UE shall indicate the
related GUAMI information in the AN parameters. When the UE is performing an
Initial Registration with its SUCI, the UE shall not indicate any GUAMI
information in the AN parameters.
For an Emergency Registration, the SUCI shall be included if the UE does not
have a valid 5G-GUTI available; the PEI shall be included when the UE has no
SUPI and no valid 5G-GUTI. In other cases, the 5G-GUTI is included and it
indicates the last serving AMF.
The UE may provide the UE\'s usage setting based on its configuration as
defined in clause 5.16.3.7 of TS 23.501 [2]. The UE provides Requested NSSAI
as described in clause 5.15.5.2.1 of TS 23.501 [2] and in the case of Initial
Registration or Mobility Registration Update, the UE includes the Mapping Of
Requested NSSAI (if available), which is the mapping of each S-NSSAI of the
Requested NSSAI to the HPLMN S-NSSAIs, to ensure that the network is able to
verify whether the S-NSSAI(s) in the Requested NSSAI are permitted based on
the Subscribed S-NSSAIs.
The UE includes the Default Configured NSSAI Indication if the UE is using a
Default Configured NSSAI, as defined in TS 23.501 [2].
In the case of Mobility Registration Update, the UE includes in the List Of
PDU Sessions To Be Activated the PDU Sessions for which there are pending
uplink data. When the UE includes the List Of PDU Sessions To Be Activated,
the UE shall indicate PDU Sessions only associated with the access the
Registration Request is related to. As defined in TS 24.501 [25] the UE shall
include always-on PDU Sessions which are accepted by the network in the List
Of PDU Sessions To Be Activated even if there are no pending uplink data for
those PDU Sessions.
NOTE 3: A PDU Session corresponding to a LADN is not included in the List Of
PDU Sessions To Be Activated when the UE is outside the area of availability
of the LADN.
The UE MM Core Network Capability is provided by the UE and handled by AMF as
defined in clause 5.4.4a of TS 23.501 [2]. The UE includes in the UE MM Core
Network Capability an indication if it supports Request Type flag \"handover\"
for PDN connectivity request during the attach procedure as defined in clause
5.17.2.3.1 of TS 23.501 [2].
The UE may provide either the LADN DNN(s) or an Indication Of Requesting LADN
Information as described in clause 5.6.5 of TS 23.501 [2].
If available, the last visited TAI shall be included in order to help the AMF
produce Registration Area for the UE.
The Security parameters are used for Authentication and integrity protection,
see TS 33.501 [15]. Requested NSSAI indicates the Network Slice Selection
Assistance Information (as defined in clause 5.15 of TS 23.501 [2]). The PDU
Session status indicates the previously established PDU Sessions in the UE.
When the UE is connected to the two AMFs belonging to different PLMN via 3GPP
access and non-3GPP access then the PDU Session status indicates the
established PDU Session of the current PLMN in the UE.
The Follow-on request is included when the UE has pending uplink signalling
and the UE doesn\'t include List Of PDU Sessions To Be Activated, or the
Registration type indicates the UE wants to perform an Emergency Registration.
In Initial Registration and Mobility Registration Update, UE provides the UE
Requested DRX parameters, as defined in clause 5.4.5 of TS 23.501 [2].
The UE provides UE Radio Capability Update indication as described in TS
23.501 [2].
2\. If a 5G-S-TMSI or GUAMI is not included or the 5G-S-TMSI or GUAMI does not
indicate a valid AMF the (R)AN, based on (R)AT and Requested NSSAI, if
available, selects an AMF
The (R)AN selects an AMF as described in clause 6.3.5 of TS 23.501 [2]. If UE
is in CM-CONNECTED state, the (R)AN can forward the Registration Request
message to the AMF based on the N2 connection of the UE.
If the (R)AN cannot select an appropriate AMF, it forwards the Registration
Request to an AMF which has been configured, in (R)AN, to perform AMF
selection.
3\. (R)AN to new AMF: N2 message (N2 parameters, Registration Request (as
described in step 1) and UE Policy Container.
When NG-RAN is used, the N2 parameters include the Selected PLMN ID, Location
Information and Cell Identity related to the cell in which the UE is camping,
UE Context Request which indicates that a UE context including security
information needs to be setup at the NG-RAN.
When NG-RAN is used, the N2 parameters also include the Establishment cause.
Mapping Of Requested NSSAI is provided only if available.
If the Registration type indicated by the UE is Periodic Registration Update,
then steps 4 to 19 may be omitted.
When the Establishment cause is associated with priority services (e.g. MPS,
MCS), the AMF includes a Message Priority header to indicate priority
information. Other NFs relay the priority information by including the Message
Priority header in service-based interfaces, as specified in TS 29.500 [17].
4\. [Conditional] new AMF to old AMF: Namf_Communication_UEContextTransfer
(complete Registration Request) or new AMF to UDSF: Nudsf_Unstructured Data
Management_Query().
(With UDSF Deployment): If the UE\'s 5G-GUTI was included in the Registration
Request and the serving AMF has changed since last Registration procedure, new
AMF and old AMF are in the same AMF Set and UDSF is deployed, the new AMF
retrieves the stored UE\'s SUPI and UE context directly from the UDSF using
Nudsf_UnstructuredDataManagement_Query service operation or they can share
stored UE context via implementation specific means if UDSF is not deployed.
This includes also event subscription information by each NF consumer for the
given UE. In this case, the new AMF uses integrity protected complete
Registration request NAS message to perform and verify integrity protection.
(Without UDSF Deployment): If the UE\'s 5G-GUTI was included in the
Registration Request and the serving AMF has changed since last Registration
procedure, the new AMF may invoke the Namf_Communication_UEContextTransfer
service operation on the old AMF including the complete Registration Request
NAS message, which may be integrity protected, as well as the Access Type, to
request the UE\'s SUPI and UE Context. See clause 5.2.2.2.2 for details of
this service operation. In this case, the old AMF uses either 5G-GUTI and the
integrity protected complete Registration request NAS message, or the SUPI and
an indication that the UE is validated from the new AMF, to verify integrity
protection if the context transfer service operation invocation corresponds to
the UE requested. The old AMF also transfers the event subscriptions
information by each NF consumer, for the UE, to the new AMF.
If the old AMF has PDU Sessions for another access type (different from the
Access Type indicated in this step) and if the old AMF determines that there
is no possibility for relocating the N2 interface to the new AMF, the old AMF
returns UE\'s SUPI and indicates that the Registration Request has been
validated for integrity protection, but does not include the rest of the UE
context.
NOTE 4: The new AMF sets the indication that the UE is validated according to
step 9a, if the new AMF has performed successful UE authentication after
previous integrity check failure in the old AMF.
NOTE 5: The NF consumers does not need to subscribe for the events once again
with the new AMF after the UE is successfully registered with the new AMF.
If the new AMF has already received UE contexts from the old AMF during
handover procedure, then step 4,5 and 10 shall be skipped.
For an Emergency Registration, if the UE identifies itself with a 5G-GUTI that
is not known to the AMF, steps 4 and 5 are skipped and the AMF immediately
requests the SUPI from the UE. If the UE identifies itself with PEI, the SUPI
request shall be skipped. Allowing Emergency Registration without a user
identity is dependent on local regulations.
5\. [Conditional] old AMF to new AMF: Response to
Namf_Communication_UEContextTransfer (SUPI, UE Context in AMF (as per Table
5.2.2.2.2-1)) or UDSF to new AMF: Nudsf_Unstructured Data Management_Query().
The old AMF may start an implementation specific (guard) timer for the UE
context.
If the UDSF was queried in step 4, the UDSF responds to the new AMF for the
Nudsf_Unstructured Data Management_Query invocation with the related contexts
including established PDU Sessions, the old AMF includes SMF information DNN,
S-NSSAI(s) and PDU Session ID, active NGAP UE-TNLA bindings to N3IWF, the old
AMF includes information about the NGAP UE-TNLA bindings. If the Old AMF was
queried in step 4, Old AMF responds to the new AMF for the
Namf_Communication_UEContextTransfer invocation by including the UE\'s SUPI
and UE Context.
If old AMF holds information about established PDU Session(s) and it is not an
Initial Registration, the old AMF includes SMF information, DNN(s), S-NSSAI(s)
and PDU Session ID(s).
If old AMF holds UE context established via N3IWF, the old AMF includes the CM
state for UE connected via N3IWF. If the UE is in CM-CONNECTED state via
N3IWF, the old AMF includes information about the NGAP UE-TNLA bindings.
If old AMF fails the integrity check of the Registration Request NAS message,
the old AMF shall indicate the integrity check failure.
If old AMF holds information about AM Policy Association and the information
about UE Policy Association (i.e. the Policy Control Request Trigger for
updating UE Policy as defined in TS 23.503 [20]), the old AMF includes the
information about the AM Policy Association, the UE Policy Association and PCF
ID. In the roaming case, V-PCF ID and H-PCF ID are included.
NOTE 6: When new AMF uses UDSF for context retrieval, interactions between old
AMF, new AMF and UDSF due to UE signalling on old AMF at the same time is
implementation issue.
6\. [Conditional] new AMF to UE: Identity Request ().
If the SUCI is not provided by the UE nor retrieved from the old AMF the
Identity Request procedure is initiated by AMF sending an Identity Request
message to the UE requesting the SUCI.
7\. [Conditional] UE to new AMF: Identity Response ().
The UE responds with an Identity Response message including the SUCI. The UE
derives the SUCI by using the provisioned public key of the HPLMN, as
specified in TS 33.501 [15].
8\. The AMF may decide to initiate UE authentication by invoking an AUSF. In
that case, the AMF selects an AUSF based on SUPI or SUCI, as described in
clause 6.3.4 of TS 23.501 [2].
If the AMF is configured to support Emergency Registration for unauthenticated
SUPIs and the UE indicated Registration type Emergency Registration, the AMF
skips the authentication or the AMF accepts that the authentication may fail
and continues the Registration procedure.
9a. If authentication is required, the AMF requests it from the AUSF; if
Tracing Requirements about the UE are available at the AMF, the AMF provides
Tracing Requirements in its request to AUSF. Upon request from the AMF, the
AUSF shall execute authentication of the UE. The authentication is performed
as described in TS 33.501 [15]. The AUSF selects a UDM as described in clause
6.3.8 of TS 23.501 [2] and gets the authentication data from UDM.
Once the UE has been authenticated the AUSF provides relevant security related
information to the AMF. If the AMF provided a SUCI to AUSF, the AUSF shall
return the SUPI to AMF only after the authentication is successful.
After successful authentication in new AMF, which is triggered by the
integrity check failure in old AMF at step 5, the new AMF invokes step 4 above
again and indicates that the UE is validated (i.e. through the reason
parameter as specified in clause 5.2.2.2.2).
9b If NAS security context does not exist, the NAS security initiation is
performed as described in TS 33.501 [15]. If the UE had no NAS security
context in step 1, the UE includes the full Registration Request message as
defined in TS 24.501 [25].
The AMF decides if the Registration Request needs to be rerouted as described
in clause 4.2.2.2.3, where the initial AMF refers to the AMF.
9c. The AMF initiates NGAP procedure to provide the 5G-AN with security
context as specified in TS 38.413 [10] if the 5G-AN had requested for UE
Context. Also, if the AMF does not support N26 for EPS interworking and it
received UE MM Core Network Capability including an indication that it
supports Request Type flag \"handover\" for PDN connectivity request during
the attach procedure as defined in clause 5.17.2.3.1 of TS 23.501 [2], AMF
provides an indication \"Redirection for EPS fallback for voice is possible\"
towards 5G-AN as specified in TS 38.413 [10]. In addition, if Tracing
Requirements about the UE are available at the AMF, the AMF provides the 5G-AN
with Tracing Requirements in the NGAP procedure.
9d. The 5G-AN stores the security context and acknowledges to the AMF. The
5G-AN uses the security context to protect the messages exchanged with the UE
as described in TS 33.501 [15].
10\. [Conditional] new AMF to old AMF:
Namf_Communication_RegistrationCompleteNotify ().
If the AMF has changed the new AMF notifies the old AMF that the registration
of the UE in the new AMF is completed by invoking the
Namf_Communication_RegistrationCompleteNotify service operation.
If the authentication/security procedure fails, then the Registration shall be
rejected and the new AMF invokes the
Namf_Communication_RegistrationCompleteNotify service operation with a reject
indication reason code towards the old AMF. The old AMF continues as if the UE
context transfer service operation was never received.
If one or more of the S-NSSAIs used in the old Registration Area cannot be
served in the target Registration Area, the new AMF determines which PDU
Session cannot be supported in the new Registration Area. The new AMF invokes
the Namf_Communication_RegistrationCompleteNotify service operation including
the rejected PDU Session ID and a reject cause (e.g. the S-NSSAI becomes no
longer available) towards the old AMF. Then the new AMF modifies the PDU
Session Status correspondingly. The old AMF informs the corresponding SMF(s)
to locally release the UE\'s SM context by invoking the
Nsmf_PDUSession_ReleaseSMContext service operation.
See clause 5.2.2.2.3 for details of
Namf_Communication_RegistrationCompleteNotify service operation.
If new AMF received in the UE context transfer in step 2 the information about
the AM Policy Association and the UE Policy Association and decides, based on
local policies, not to use the PCF(s) identified by the PCF ID(s) for the AM
Policy Association and the UE Policy Association, then it will inform the old
AMF that the AM Policy Association and the UE Policy Association in the UE
context is not used any longer and then the PCF selection is performed in step
15.
11\. [Conditional] new AMF to UE: Identity Request/Response (PEI).
If the PEI was not provided by the UE nor retrieved from the old AMF the
Identity Request procedure is initiated by AMF sending an Identity Request
message to the UE to retrieve the PEI. The PEI shall be transferred encrypted
unless the UE performs Emergency Registration and cannot be authenticated.
For an Emergency Registration, the UE may have included the PEI in the
Registration Request. If so, the PEI retrieval is skipped.
12\. Optionally the new AMF initiates ME identity check by invoking the
N5g-eir_EquipmentIdentityCheck_Get service operation (see clause 5.2.4.2.2).
The PEI check is performed as described in clause 4.7.
For an Emergency Registration, if the PEI is blocked, operator policies
determine whether the Emergency Registration procedure continues or is
stopped.
13\. If step 14 is to be performed, the new AMF, based on the SUPI, selects a
UDM, then UDM may select a UDR instance. See clause 6.3.9 of TS 23.501 [2].
The AMF selects a UDM as described in clause 6.3.8 of TS 23.501 [2].
14a-c. If the AMF has changed since the last Registration procedure, or if the
UE provides a SUPI which doesn\'t refer to a valid context in the AMF, or if
the UE registers to the same AMF it has already registered to a non-3GPP
access (i.e. the UE is registered over a non-3GPP access and initiates this
Registration procedure to add a 3GPP access), the new AMF registers with the
UDM using Nudm_UECM_Registration for the access to be registered (and
subscribes to be notified when the UDM deregisters this AMF).
The AMF provides the \"Homogenous Support of IMS Voice over PS Sessions\"
indication (see clause 5.16.3.3 of TS 23.501 [2]) to the UDM. The \"Homogenous
Support of IMS Voice over PS Sessions\" indication shall not be included
unless the AMF has completed its evaluation of the support of \"IMS Voice over
PS Session\" as specified in clause 5.16.3.2 of TS 23.501 [2].
NOTE 7: At this step, the AMF may not have all the information needed to
determine the setting of the IMS Voice over PS Session Supported indication
for this UE (see clause 5.16.3.2 of TS 23.501 [2]). Hence the AMF can send the
\"Homogenous Support of IMS Voice over PS Sessions\" later on in this
procedure.
If the AMF does not have subscription data for the UE, the AMF retrieves the
Access and Mobility Subscription data, SMF Selection Subscription data and UE
context in SMF data using Nudm_SDM_Get. This requires that UDM may retrieve
this information from UDR by Nudr_DM_Query. After a successful response is
received, the AMF subscribes to be notified using Nudm_SDM_Subscribe when the
data requested is modified, UDM may subscribe to UDR by Nudr_DM_Subscribe. The
GPSI is provided to the AMF in the Access and Mobility Subscription data from
the UDM if the GPSI is available in the UE subscription data. The UDM may
provide indication that the subscription data for network slicing is updated
for the UE. If the UE is subscribed to MPS in the serving PLMN, \"MPS
priority\" is included in the Access and Mobility Subscription data provided
to the AMF. If the UE is subscribed to MCX in the serving PLMN, \"MCX
priority\" is included in the Access and Mobility Subscription data provided
to the AMF.
The new AMF provides the Access Type it serves for the UE to the UDM and the
Access Type is set to \"3GPP access\". The UDM stores the associated Access
Type together with the serving AMF and does not remove the AMF identity
associated to the other Access Type if any. The UDM may store in UDR
information provided at the AMF registration by Nudr_DM_Update.
If the UE was registered in the old AMF for an access and the old and the new
AMFs are in the same PLMN, the new AMF sends a separate/independent
Nudm_UECM_Registration to update UDM with Access Type set to access used in
the old AMF, after the old AMF relocation is successfully completed.
The new AMF creates an UE context for the UE after getting the Access and
Mobility Subscription data from the UDM. The Access and Mobility Subscription
data includes whether the UE is allowed to include NSSAI in the 3GPP access
RRC Connection Establishment in clear text.
For an Emergency Registration in which the UE was not successfully
authenticated, the AMF shall not register with the UDM.
For an Emergency Registration, the AMF shall not check for access
restrictions, regional restrictions or subscription restrictions. For an
Emergency Registration, the AMF shall ignore any unsuccessful registration
response from UDM and continue with the Registration procedure.
14d. When the UDM stores the associated Access Type (e.g. 3GPP) together with
the serving AMF as indicated in step 14a, it will cause the UDM to initiate a
Nudm_UECM_DeregistrationNotification (see clause 5.2.3.2.2) to the old AMF
corresponding to the same (e.g. 3GPP) access, if one exists. If the timer
started in step 5 is not running, the old AMF may remove the UE context.
Otherwise, the AMF may remove UE context when the timer expires. If the
serving NF removal reason indicated by the UDM is Initial Registration, then,
as described in clause 4.2.2.3.2, the old AMF invokes the
Nsmf_PDUSession_ReleaseSMContext (SUPI, PDU Session ID) service operation
towards all the associated SMF(s) of the UE to notify that the UE is
deregistered from old AMF. The SMF(s) shall release the PDU Session on getting
this notification.
If the old AMF has established an AM Policy Association and a UE Policy
Association with the PCF(s) and the old AMF did not transfer the PCF ID(s) to
the new AMF (e.g. new AMF is in different PLMN), the old AMF performs an AMF-
initiated Policy Association Termination procedure, as defined in clause
4.16.3.2 and performs an AMF-initiated UE Policy Association Termination
procedure, as defined in clause 4.16.13.1. In addition, if the old AMF
transferred the PCF ID(s) in the UE context but the new AMF informed in step
10 that the AM Policy Association information and UE Policy Association
information in the UE context will not be used then the old AMF performs an
AMF-initiated Policy Association Termination procedure, as defined in clause
4.16.3.2 and performs an AMF-initiated UE Policy Association Termination
procedure, as defined in clause 4.16.13.1.
If the old AMF has an N2 connection for that UE (e.g. because the UE was in
RRC Inactive state but has now moved to E-UTRAN or moved to an area not served
by the old AMF), the old AMF shall perform AN Release (see clause 4.2.6) with
a cause value that indicates that the UE has already locally released the NG-
RAN\'s RRC Connection.
14e. [Conditional] If old AMF does not have UE context for another access type
(i.e. non-3GPP access), the Old AMF unsubscribes with the UDM for subscription
data using Nudm_SDM_unsubscribe.
15\. If the AMF decides to initiate PCF communication, the AMF acts as
follows.
If the new AMF decides to use the (V-)PCF identified by the (V-)PCF ID
included in UE context from the old AMF in step 5, the AMF contacts the
(V-)PCF identified by the (V-)PCF ID to obtain policy. If the AMF decides to
perform PCF discovery and selection and the AMF selects a (V)-PCF and may
select an H-PCF (for roaming scenario) as described in clause 6.3.7.1 of TS
23.501 [2] and according to the V-NRF to H-NRF interaction described in clause
4.3.2.2.3.3.
16\. [Optional] new AMF performs an AM Policy Association
Establishment/Modification. For an Emergency Registration, this step is
skipped.
If the new AMF selects a new (V-)PCF in step 15, the new AMF performs AM
Policy Association Establishment with the selected (V-)PCF as defined in
clause 4.16.1.2.
If the (V-)PCF identified by the (V-)PCF ID included in UE context from the
old AMF is used, the new AMF performs AM Policy Association Modification with
the (V-)PCF as defined in clause 4.16.2.1.2.
If the AMF notifies the Mobility Restrictions (e.g. UE location) to the PCF
for adjustment, or if the PCF updates the Mobility Restrictions itself due to
some conditions (e.g. application in use, time and date), the PCF shall
provide the updated Mobility Restrictions to the AMF. If the subscription
information includes Tracing Requirements, the AMF provides the PCF with
Tracing Requirements.
17\. [Conditional] AMF to SMF: Nsmf_PDUSession_UpdateSMContext ().
For an Emergency Registered UE (see TS 23.501 [2]), this step is applied when
the Registration Type is Mobility Registration Update.
The AMF invokes the Nsmf_PDUSession_UpdateSMContext (see clause 5.2.8.2.6) in
the following scenario(s):
\- If the List Of PDU Sessions To Be Activated is included in the Registration
Request in step 1, the AMF sends Nsmf_PDUSession_UpdateSMContext Request to
SMF(s) associated with the PDU Session(s) in order to activate User Plane
connections of these PDU Session(s). Steps from step 5 onwards described in
clause 4.2.3.2 are executed to complete the User Plane connection activation
without sending the RRC Inactive Assistance Information and without sending MM
NAS Service Accept from the AMF to (R)AN described in step 12 of clause
4.2.3.2.
When the serving AMF has changed, the new serving AMF notifies the SMF for
each PDU Session that it has taken over the responsibility of the signalling
path towards the UE: the new serving AMF invokes the
Nsmf_PDUSession_UpdateSMContext service operation using SMF information
received from the old AMF at step 5. It also indicates whether the PDU Session
is to be re-activated.
NOTE 8: If the UE moves into a different PLMN, the AMF in the serving PLMN can
not insert, change or remove the V-SMF(s) even for Home Routed PDU session(s).
During inter-PLMN change, if the same SMF is used, session continuity can be
supported depending on operator policies.
Steps from step 5 onwards described in clause 4.2.3.2 are executed. In the
case that the intermediate UPF insertion, removal, or change is performed for
the PDU Session(s) not included in \"PDU Session(s) to be re-activated\", the
procedure is performed without N11 and N2 interactions to update the N3 user
plane between (R)AN and 5GC.
The AMF invokes the Nsmf_PDUSession_ReleaseSMContext service operation towards
the SMF in the following scenario:
\- If any PDU Session status indicates that it is released at the UE, or a
change of the set of network slices for a UE where a network slice instance is
no longer available (as described in clause 5.15.5.2.2 of TS 23.501 [2]), the
AMF invokes the Nsmf_PDUSession_ReleaseSMContext service operation towards the
SMF in order to release any network resources related to the PDU Session.
If the serving AMF is changed, the new AMF shall wait until step 18 is
finished with all the SMFs associated with the UE. Otherwise, steps 19 to 22
can continue in parallel to this step.
18\. [Conditional] If the new AMF and the old AMF/N3IWF are in the same PLMN,
New AMF to N3IWF: N2 AMF Mobility Request ().
If the AMF has changed and the old AMF has indicated that the UE is in CM-
CONNECTED state via N3IWF and if the new AMF and the old AMF/N3IWF are in the
same PLMN, the new AMF creates an NGAP UE association towards the N3IWF to
which the UE is connected. This automatically releases the existing NGAP UE
association between the old AMF and the N3IWF
19\. N3IWF to new AMF: N2 AMF Mobility Response ().
19a. [Conditional] After the new AMF receives the response message from the
N3IWF in step 19, the new AMF registers with the UDM using
Nudm_UECM_Registration as step 14c, but with the Access Type set to \"non-3GPP
access\". The UDM stores the associated Access Type together with the serving
AMF and does not remove the AMF identity associated to the other Access Type
if any. The UDM may store in UDR information provided at the AMF registration
by Nudr_DM_Update.
19b. [Conditional] When the UDM stores the associated Access Type (i.e.
non-3GPP) together with the serving AMF as indicated in step 19a, it will
cause the UDM to initiate a Nudm_UECM_DeregistrationNotification (see clause
5.2.3.2.2) to the old AMF corresponding to the same (i.e. non-3GPP) access.
The old AMF removes the UE context for non-3GPP access.
19c. The Old AMF unsubscribes with the UDM for subscription data using
Nudm_SDM_unsubscribe.
20a. Void.
21\. New AMF to UE: Registration Accept (5G-GUTI, Registration Area, Mobility
restrictions, PDU Session status, Allowed NSSAI, [Mapping Of Allowed NSSAI],
[Configured NSSAI for the Serving PLMN], [Mapping Of Configured NSSAI],
[rejected S-NSSAIs], Periodic Registration Update timer, LADN Information and
accepted MICO mode, IMS Voice over PS session supported Indication, Emergency
Service Support indicator, Accepted DRX parameters, Network support of
Interworking without N26, Access Stratum Connection Establishment NSSAI
Inclusion Mode, Network Slicing Subscription Change Indication, Operator-
defined access category definitions, [List of equivalent PLMNs]). The Allowed
NSSAI for the Access Type for the UE is included in the N2 message carrying
the Registration Accept message.
The AMF sends a Registration Accept message to the UE indicating that the
Registration Request has been accepted. 5G-GUTI is included if the AMF
allocates a new 5G-GUTI. If the UE is already in RM-REGISTERED state via
another access in the same PLMN, the UE shall use the 5G-GUTI received in the
Registration Accept for both registrations. If no 5G-GUTI is included in the
Registration Accept, then the UE uses the 5G-GUTI assigned for the existing
registration also for the new registration. If the AMF allocates a new
Registration area, it shall send the Registration area to the UE via
Registration Accept message. If there is no Registration area included in the
Registration Accept message, the UE shall consider the old Registration Area
as valid. Mobility Restrictions is included if mobility restrictions applies
for the UE and Registration Type is not Emergency Registration. The AMF
indicates the established PDU Sessions to the UE in the PDU Session status.
The UE removes locally any internal resources related to PDU Sessions that are
not marked as established in the received PDU Session status. If the AMF
invokes the Nsmf_PDUSession_UpdateSMContext procedure for UP activation of PDU
Session(s) in step 18 and receives rejection from the SMF, then the AMF
indicates to the UE the PDU Session ID and the cause why the User Plane
resources were not activated. When the UE is connected to the two AMFs
belonging to different PLMN via 3GPP access and non-3GPP access then the UE
removes locally any internal resources related to the PDU Session of the
current PLMN that are not marked as established in received PDU Session
status. If the PDU Session status information was in the Registration Request,
the AMF shall indicate the PDU Session status to the UE.
The Allowed NSSAI provided in the Registration Accept is valid in the
Registration Area and it applies for all the PLMNs which have their Tracking
Areas included in the Registration Area. The Mapping Of Allowed NSSAI is the
mapping of each S-NSSAI of the Allowed NSSAI to the HPLMN S-NSSAIs. The
Mapping Of Configured NSSAI is the mapping of each S-NSSAI of the Configured
NSSAI for the Serving PLMN to the HPLMN S-NSSAIs.
The AMF shall include in the Registration Accept message the LADN Information
for the list of LADNs, described in clause 5.6.5 of TS 23.501 [2], that are
available within the Registration area determined by the AMF for the UE. If
the UE included MICO mode in the request, then AMF responds whether MICO mode
should be used. The AMF may include Operator-defined access category
definitions to let the UE determinine the applicable Operator-specific access
category definitions as described in TS 24.501 [25].
In the case of registration over 3GPP access, the AMF sets the IMS Voice over
PS session supported Indication as described in clause 5.16.3.2 of TS 23.501
[2]. In order to set the IMS Voice over PS session supported Indication the
AMF may need to perform the UE Capability Match Request procedure in clause
4.2.8a to check the compatibility of the UE and NG-RAN radio capabilities
related to IMS Voice over PS. If the AMF hasn\'t received Voice Support Match
Indicator from the NG-RAN on time then, based on implementation, AMF may set
IMS Voice over PS session supported Indication and update it at a later stage.
In the case of registration over non-3GPP access, the AMF sets the IMS Voice
over PS session supported Indication as described in clause 5.16.3.2a of TS
23.501 [2].
The Emergency Service Support indicator informs the UE that emergency services
are supported, i.e. the UE is allowed to request PDU Session for emergency
services. If the AMF received \"MPS priority\" from the UDM as part of Access
and Mobility Subscription data, based on operator policy, \"MPS priority\" is
included in the Registration Accept message to the UE to inform the UE whether
configuration of Access Identity 1 is valid within the selected PLMN, as
specified in TS 24.501 [25]. If the AMF received \"MCX priority\" from the UDM
as part of Access and Mobility Subscription data, based on operator policy and
UE subscription to MCX Services, \"MCX priority\" is included in the
Registration Accept message to the UE to inform the UE whether configuration
of Access Identity 2 is valid within the selected PLMN, as specified in TS
24.501 [25]. The Accepted DRX parameters are defined in clause 5.4.5 of TS
23.501 [2]. The AMF sets the Interworking without N26 parameter as described
in clause 5.17.2.3.1 of TS 23.501 [2].
If the UDM intends to indicate the UE that subscription has changed, the
Network Slicing Subscription Change Indication is included. If the AMF
includes Network Slicing Subscription Change Indication, then the UE shall
locally erase all the network slicing configuration for all PLMNs and, if
applicable, update the configuration for the current PLMN based on any
received information.
The Access Stratum Connection Establishment NSSAI Inclusion Mode, as specified
in clause 5.15.9 of TS 23.501 [2], is included to instruct the UE on what
NSSAI, if any, to include in the Access Stratum connection establishment. The
AMF can set the value to modes of operation a,b,c defined in clause 5.15.9 of
TS 23.501 [2] in the 3GPP Access only if the Inclusion of NSSAI in RRC
Connection Establishment Allowed indicates that it is allowed to do so.
The AMF may provide a List of equivalent PLMNs which is handled as specified
in TS 24.501 [25].
21b. [Optional] The new AMF performs a UE Policy Association Establishment as
defined in clause 4.16.11. For an Emergency Registration, this step is
skipped.
The new AMF sends a Npcf_UEPolicyControl Create Request to PCF. PCF sends a
Npcf_UEPolicyControl Create Response to the new AMF.
PCF triggers UE Configuration Update Procedure as defined in clause 4.2.4.3.
22\. [Conditional] UE to new AMF: Registration Complete ().
The UE sends a Registration Complete message to the AMF when it has
successfully updated itself after receiving any of the [Configured NSSAI for
the Serving PLMN], [Mapping Of Configured NSSAI] and a Network Slicing
Subscription Change Indication in step 21.
The UE sends a Registration Complete message to the AMF to acknowledge if a
new 5G-GUTI was assigned.
If new 5G-GUTI was assigned, then the UE passes the new 5G-GUTI to its 3GPP
access\' lower layer when a lower layer (either 3GPP access or non-3GPP
access) indicates to the UE\'s RM layer that the Registration Complete message
has been successfully transferred across the radio interface.
NOTE 9: The above is needed because the NG-RAN may use the RRC Inactive state
and a part of the 5G-GUTI is used to calculate the Paging Frame (see TS 38.304
[44] and TS 36.304 [43]). It is assumed that the Registration Complete is
reliably delivered to the AMF after the 5G-AN has acknowledged its receipt to
the UE.
When the List Of PDU Sessions To Be Activated is not included in the
Registration Request and the Registration procedure was not initiated in CM-
CONNECTED state, the AMF releases the signalling connection with UE, according
to clause 4.2.6.
When the Follow-on request is included in the Registration Request, the AMF
should not release the signalling connection after the completion of the
Registration procedure.
If the AMF is aware that some signalling is pending in the AMF or between the
UE and the 5GC, the AMF should not release the signalling connection
immediately after the completion of the Registration procedure.
23a. For Registration over 3GPP Access, if the AMF does not release the
signalling connection, the AMF sends the RRC Inactive Assistance Information
to the NG-RAN.
For Registration over non-3GPP Access, if the UE is also in CM-CONNECTED state
on 3GPP access, the AMF sends the RRC Inactive Assistance Information to the
NG-RAN.
23\. [Conditional] AMF to UDM: If the Access and Mobility Subscription data
provided by UDM to AMF in 14b includes Steering of Roaming information with an
indication that the UDM requests an acknowledgement of the reception of this
information from the UE, the AMF provides the UE acknowledgement to UDM using
Nudm_SDM_Info. For more details regarding the handling of Steering of Roaming
information refer to TS 23.122 [22].
The AMF also uses the Nudm_SDM_Info service operation to provide an
acknowledgment to UDM that the UE received the Network Slicing Subscription
Change Indication (see step 21 and step 22) and acted upon it.
24\. [Conditional] AMF to UDM: After step 14a and in parallel to any of the
preceding steps, the AMF shall send a \"Homogeneous Support of IMS Voice over
PS Sessions\" indication to the UDM using Nudm_UECM_Update:
\- If the AMF has evaluated the support of IMS Voice over PS Sessions, see
clause 5.16.3.2 of TS 23.501 [2] and
\- If the AMF determines that it needs to update the Homogeneous Support of
IMS Voice over PS Sessions, see clause 5.16.3.3 of TS 23.501 [2].
The mobility related event notifications towards the NF consumers are
triggered at the end of this procedure for cases as described in clause
4.15.4.
##### 4.2.2.2.3 Registration with AMF re-allocation
When an AMF receives a Registration request, the AMF may need to reroute the
Registration request to another AMF, e.g. when the initial AMF is not the
appropriate AMF to serve the UE. The Registration with AMF re-allocation
procedure, described in figure 4.2.2.2.3-1, is used to reroute the NAS message
of the UE to the target AMF during a Registration procedure.
Figure 4.2.2.2.3-1: Registration with AMF re-allocation procedure
The initial AMF and the target AMF register their capability at the NRF.
1\. Steps 1 and 2 of figure 4.2.2.2.2-1 have occurred and the (R)AN sends the
Registration request message within an Initial UE message to the initial AMF.
2\. If the AMF needs the SUPI and/or UE\'s subscription information to decide
whether to reroute the Registration Request or if the Registration Request was
not sent integrity protected or integrity protection is indicated as failed,
then AMF performs steps 4 to 9b of figure 4.2.2.2.2-1.
3a. [Conditional] If the initial AMF needs UE\'s subscription information to
decide whether to reroute the Registration Request and UE\'s slice selection
subscription information was not provided by old AMF, the AMF selects a UDM as
described in clause 6.3.8 of TS 23.501 [2].
3b. Initial AMF to UDM: Nudm_SDM_Get (SUPI, Slice Selection Subscription
data).
The initial AMF request UE\'s Slice Selection Subscription data from UDM by
invoking the Nudm_SDM_Get (see clause 5.2.3.3.1) service operation. UDM may
get this information from UDR by Nudr_DM_Query(SUPI, Subscribed S-NSSAIs).
3c. UDM to initial AMF: Response to Nudm_SDM_Get. The AMF gets the Slice
Selection Subscription data including Subscribed S-NSSAIs. The UDM may provide
indication that the subscription data for network slicing is updated for the
UE.
UDM responds with slice selection data to initial AMF.
4a. [Conditional] Initial AMF to NSSF: Nnssf_NSSelection_Get (Requested NSSAI,
[Mapping Of Requested NSSAI], Subscribed S-NSSAI(s) with the default S-NSSAI
indication, TAI, Allowed NSSAI for the other access type (if any), [Mapping of
Allowed NSSAI], PLMN ID of the SUPI).
If there is a need for slice selection, (see clause 5.15.5.2.1 of TS 23.501
[2]), e.g. the initial AMF cannot serve all the S-NSSAI(s) from the Requested
NSSAI permitted by the subscription information, the initial AMF invokes the
Nnssf_NSSelection_Get service operation from the NSSF by including Requested
NSSAI, optionally Mapping Of Requested NSSAI, Subscribed S-NSSAIs with the
default S-NSSAI indication, Allowed NSSAI for the other access type (if any),
Mapping of Allowed NSSAI, PLMN ID of the SUPI and the TAI of the UE.
4b. [Conditional] NSSF to Initial AMF: Response to Nnssf_NSSelection_Get (AMF
Set or list of AMF addresses, Allowed NSSAI for the first access type,
[Mapping Of Allowed NSSAI], [Allowed NSSAI for the second access type],
[Mapping of Allowed NSSAI], [NSI ID(s)], [NRF(s)], [List of rejected
(S-NSSAI(s), cause value(s))], [Configured NSSAI for the Serving PLMN],
[Mapping Of Configured NSSAI]).
The NSSF performs the steps specified in point (B) in clause 5.15.5.2.1 of TS
23.501 [2]. The NSSF returns to initial AMF the Allowed NSSAI for the first
access type, optionally the Mapping Of Allowed NSSAI, the Allowed NSSAI for
the second access type (if any), optionally the Mapping of Allowed NSSAI and
the target AMF Set or, based on configuration, the list of candidate AMF(s).
The NSSF may return NSI ID(s) associated to the Network Slice instance(s)
corresponding to certain S-NSSAI(s). The NSSF may return the NRF(s) to be used
to select NFs/services within the selected Network Slice instance(s). It may
return also information regarding rejection causes for S-NSSAI(s) not included
in the Allowed NSSAI. The NSSF may return Configured NSSAI for the Serving
PLMN and possibly the associated mapping of the Configured NSSAI.
NOTE 1: The NRF(s) returned by the NSSF, if any, belong to any level of NRF
(see clause 6.2.6 of TS 23.501 [2]) according to the deployment decision of
the operator.
5\. [Conditional] Initial AMF to old AMF:
Namf_Communication_RegistrationCompleteNotify (failure cause ).
The initial AMF decides to reroute the NAS message to another AMF. The initial
AMF sends a reject indication to the old AMF telling that the UE Registration
procedure did not fully complete at the initial AMF. The old AMF continues as
if the Namf_Communication_UEContextTransfer had never been received.
6a. [Conditional] Initial AMF to NRF: Nnrf_NFDiscovery_Request (NF type, AMF
Set).
If the initial AMF does not locally store the target AMF address and if the
initial AMF intends to use direct reroute to target AMF or the reroute via
(NG-R)AN message needs to include AMF address, then the initial AMF invokes
the Nnrf_NFDiscovery_Request service operation from the NRF to find a proper
target AMF which has required NF capabilities to serve the UE. The NF type is
set to AMF. The AMF Set is included in the Nnrf_NFDiscovery_Request.
6b. [Conditional] NRF to AMF: Response to Nnrf_NFDiscovery_Request (list of
(AMF pointer, AMF address, plus additional selection rules and NF
capabilities)).
The NRF replies with the list of potential target AMF(s). The NRF may also
provide the details of the services offered by the candidate AMF(s) along with
the notification end-point for each type of notification service that the
selected AMF had registered with the NRF, if available. As an alternative, it
provides a list of potential target AMFs and their capabilities and
optionally, additional selection rules. Based on the information about
registered NFs and required capabilities, a target AMF is selected by the
initial AMF.
If the security association has been established between the UE and initial
AMF, to avoid a registration failure, the initial AMF shall forward the NAS
message to the target AMF by executing step 7(A).
NOTE 2: The security context in the initial AMF is not transferred to the
target AMF if initial AMF forward the NAS message to the target AMF via (R)AN.
In this case the UE rejects the NAS message sent from target AMF as the
security context in the UE and target AMF are not synchronized.
NOTE 3: Network slice isolation cannot be completely maintained if the AMF
reallocation is executed by step 7(A).
If the initial AMF is not part of the target AMF set and is not able to get a
list of candidate AMF(s) by querying the NRF with the target AMF set (e.g. the
NRF locally pre-configured on AMF does not provide the requested information,
the query to the appropriate NRF provided by the NSSF is not successful, or
the initial AMF has knowledge that the initial AMF is not authorized as
serving AMF etc.) then the initial AMF shall forward the NAS message to the
target AMF via (R)AN executing step 7(B) unless the security association has
been established between the UE and initial AMF; the Allowed NSSAI and the AMF
Set are included to enable the (R)AN to select the target AMF as described in
clause 6.3.5 of TS 23.501 [2].
7(A). If the initial AMF, based on local policy and subscription information,
decides to forward the NAS message to the target AMF directly, the initial AMF
invokes the Namf_Communication_N1MessageNotify to the target AMF, carrying the
rerouted NAS message. The Namf_Communication_N1MessageNotify service operation
includes the information enabling (R)AN to identify the N2 terminating point
and the full Registration Request message and the UE\'s SUPI and MM Context if
available. If the initial AMF has obtained the information from the NSSF as
described at step 4b, that information except the AMF Set or list of AMF
addresses is included. The target AMF then updates the (R)AN with a new
updated N2 termination point for the UE in the first message from target AMF
to RAN in step 8.
7(B). If the initial AMF, based on local policy and subscription information,
decides to forward the NAS message to the target AMF via (R)AN unless the
target AMF(s) are returned from the NSSF and identified by a list of candidate
AMF(s), the initial AMF sends a Reroute NAS message to the (R)AN (step 7a).
The Reroute NAS message includes the information about the target AMF and the
full Registration Request message. If the initial AMF has obtained the
information as described at step 4b, that information is included. The (R)AN
sends the Initial UE message to the target AMF (step 7b) indicating reroute
due to slicing including the information from step 4b that the NSSF provided.
8\. After receiving the Registration Request message transmitted at step 7(A)a
or step 7(B)b, if no UE context is received from the initial AMF, the target
AMF, based on rerouting due to slicing, continues with the Registration
procedure from step 4 until 22 of figure 4.2.2.2.2-1 (with the target AMF
corresponding to the new AMF). If the UE context is received from the initial
AMF, the target AMF continues with the Registration procedure from step 8 or
step 9b (depending on whether it decides to re-authenticate the UE) or step 9c
(if new NAS security context shall be applied) until step 22 of figure
4.2.2.2.2-1, skipping step 10. If the initial AMF decides to forward the NAS
message to the target AMF (step 7(A), the first message from the target AMF to
RAN (either Initial Context Setup Request, or Downlink NAS Transport) contain
the AMF name of the initial AMF.
#### 4.2.2.3 Deregistration procedures
##### 4.2.2.3.1 General
The Deregistration procedure allows:
\- the UE to inform the network that it does not want to access the 5GS any
longer and
\- the network to inform the UE that it does not have access to the 5GS any
longer.
The Deregistration request by the UE and Deregistration request by the network
include whether the Deregistration applies to the 3GPP access, to the non-3GPP
access, or to both. When the UE is registered to both accesses in the same
PLMN, the Deregistration message can be sent over any access regardless of the
access the Deregistration is applied to.
##### 4.2.2.3.2 UE-initiated Deregistration
The UE uses this procedure to deregister from the registered PLMN as shown in
Figure 4.2.2.3.2-1.
Figure 4.2.2.3.2-1: UE-initiated Deregistration
1\. The UE sends NAS message Deregistration Request (5G-GUTI, Deregistration
type (e.g. Switch off), Access Type) to the AMF.
Access type indicates whether the Deregistration procedure applies to the 3GPP
access, to the non-3GPP access, or to both if the 3GPP access and non-3GPP
access of the UE are served by the same AMF (refer to TS 23.501 [2]). The AMF
shall invoke the Deregistration procedure for the target access indicated by
the UE.
2\. [Conditional] AMF to SMF: Nsmf_PDUSession_ReleaseSMContext (SUPI, PDU
Session ID).
If the UE has no established PDU Session over the target access indicated in
step 1, then steps 2 to 5 are not executed. All PDU Sessions over the target
access(es), which belong to the UE are released by the AMF sending
Nsmf_PDUSession_ReleaseSMContext Request (SUPI, PDU Session ID) message to the
SMF for each PDU Session.
3\. [Conditional] The SMF releases all resources e.g. the IP address /
Prefix(es) that were allocated to the PDU Session and releases the
corresponding User Plane resources:
3a. [Conditional] The SMF sends N4 Session Release Request (N4 Session ID)
message to the UPF(s) of the PDU Session. The UPF(s) shall drop any remaining
packets of the PDU Session and release all tunnel resource and contexts
associated with the N4 Session.
3b. [Conditional] The UPF(s) acknowledges the N4 Session Release Request by
the transmission of an N4 Session Release Response (N4 Session ID) message to
the SMF.
4\. [Conditional] The SMF responds with Nsmf_PDUSession_ReleaseSMContext
Response message.
5a. [Conditional] If dynamic PCC applied to this session the SMF performs an
SM Policy Association Termination procedure as defined in clause 4.16.6.
5b-c. [Conditional] If it is the last PDU Session the SMF is handling for the
UE for the associated (DNN, S-NSSAI), the SMF unsubscribes from Session
Management Subscription data changes notification with the UDM by means of the
Nudm_SDM_Unsubscribe service operation. The SMF invokes the
Nudm_UECM_Deregistration service operation so that the UDM removes the
association it had stored between the SMF identity and the associated DNN and
PDU Session Id.
6\. [Conditional] If there is any association with the PCF for this UE and the
UE is no more registered over any access, the AMF performs a AMF-initiated AM
Policy Association Termination procedure as defined in clause 4.16.3.2 delete
the association with the PCF.
6a. [Conditional] If there is any association with the PCF for this UE and the
UE is no more registered over any access, the AMF performs a AMF-initiated UE
Policy Association Termination procedure as defined in clause 4.16.13.1 delete
the association with the PCF.
7\. [Conditional] The AMF sends NAS message Deregistration Accept to UE
depending on the Deregistration type i.e. if Deregistration type is switch-
off, AMF does not send Deregistration Accept message.
8\. [Conditional] AMF to AN: N2 UE Context Release Request (Cause)
If the target access for Deregistration procedure is 3GPP access or both 3GPP
access and non-3GPP access and there is N2 signalling connection to NG-RAN,
the AMF sends N2 UE Release command to NG-RAN with Cause set to Deregistration
to release N2 signalling connection. The details of this step are covered by
steps 2 to 4 in the AN Release procedure, as described in clause 4.2.6.
If the target access for Deregistration procedure is non-3GPP access or both
3GPP access and non-3GPP access and there is N2 signalling connection to the
N3IWF, the AMF sends N2 UE Release command to N3IWF with Cause set to
Deregistration to release N2 signalling connection. The details of this step
are covered by steps 2 to 5 in the \"Deregistration procedure for untrusted
non-3gpp access\", as described in clause 4.12.3.
##### 4.2.2.3.3 Network-initiated Deregistration
The procedure depicted in Figure 4.2.2.3.3-1 shows Network-initiated
Deregistration procedure. The AMF can initiate this procedure for either
explicit (e.g. by O&M intervention) or implicit (e.g. expiring of Implicit
Deregistration timer). The UDM can trigger this procedure for operator-
determined purposes to request the removal of a subscriber\'s RM context and
PDU Session(s) of the UE.
Figure 4.2.2.3.3-1: Network-initiated Deregistration
1\. [Conditional] If the UDM wants to request the immediate deletion of a
subscriber\'s RM contexts and PDU Sessions, the UDM shall send a
Nudm_UECM_DeregistrationNotification (SUPI, Access Type, Removal Reason)
message with Removal Reason set to Subscription Withdrawn to the registered
AMF. The Access Type may indicate 3GPP Access, non-3GPP Access or both.
2\. If the AMF receives Nudm_UECM_DeregistrationNotification in Step 1 with
Removal Reason as Subscription Withdrawn, the AMF executes Deregistration
procedure over the access(es) the Access Type indicates.
The AMF-initiated Deregistration procedure is either explicit (e.g. by O&M
intervention) or implicit. The AMF does not send the Deregistration Request
message to the UE for Implicit Deregistration. If the UE is in CM-CONNECTED
state, the AMF may explicitly deregister the UE by sending a Deregistration
Request message (Deregistration type, Access Type) to the UE. The
Deregistration type may be set to Re-registration in which case the UE should
re-register at the end of the Deregistration procedure. Access Type indicates
whether Deregistration procedure applies to the 3GPP access or non-3GPP
access, or both. If the Deregistration Request message is sent over 3GPP
access and the UE is in CM-IDLE state in 3GPP access, the AMF pages the UE.
If the UE has established PDU Session associated with emergency service, the
AMF shall not initiate Deregistration procedure. In this case, the AMF
performs network requested PDU Session Release for any PDU session associated
with non-emergency service as described in clause 4.3.4.
3\. [Conditional] If the Deregistration procedure is triggered by UDM (Step
1), the AMF acknowledges the Nudm_UECM_DeRegistrationNotification to the UDM.
The AMF also unsubscribes with the UDM using Nudm_SDM_Unsubscribe service
operation.
4\. [Conditional] If the UE has any established PDU Session over the target
access for deregistration indicated in step 2, then step 2 \~ step 5 of UE-
initiated Deregistration procedure in clause 4.2.2.3.2 is performed.
5\. [Conditional] As in step 6 of Figure 4.2.2.3.2-1.
5a. [Conditional] As in step 6a of Figure 4.2.2.3.2-1.
6\. [Conditional] If the UE receives the Deregistration Request message from
the AMF in step 2, the UE sends a Deregistration Accept message to the AMF any
time after step 2. The NG-RAN forwards this NAS message to the AMF along with
the TAI+ Cell identity of the cell which the UE is using.
7\. [Conditional] AMF to AN: N2 UE Context Release Request (Cause): as in step
8 of Figure 4.2.2.3.2.
### 4.2.3 Service Request procedures
#### 4.2.3.1 General
The Service Request procedure is used by a UE in CMâ€‘IDLE state or the 5GC to
request the establishment of a secure connection to an AMF. The Service
Request procedure is also used both when the UE is in CM-IDLE and in CM-
CONNECTED to activate a User Plane connection for an established PDU Session.
The UE shall not initiate a Service Request procedure if there is an ongoing
Service Request procedure.
#### 4.2.3.2 UE Triggered Service Request
The UE in CMâ€‘IDLE state initiates the Service Request procedure in order to
send uplink signalling messages, user data, or as a response to a network
paging request. After receiving the Service Request message, the AMF may
perform authentication. After the establishment of the signalling connection
to an AMF, the UE or network may send signalling messages, e.g. PDU Session
establishment from UE to the SMF, via the AMF.
The Service Request procedure is used by a UE in CM-CONNECTED to request
activation of a User Plane connection for PDU Sessions and to respond to a NAS
Notification message from the AMF. When a User Plane connection for a PDU
Session is activated, the AS layer in the UE indicates it to the NAS layer.
For any Service Request, the AMF responds with a Service Accept message to
synchronize PDU Session status between UE and network, if necessary. The AMF
responds with a Service Reject message to UE, if the Service Request cannot be
accepted by network. The Service Reject message may include an indication or
cause code requesting the UE to perform Registration procedure.
For this procedure, the impacted SMF and UPF, if any, are all under control of
the PLMN serving the UE, e.g. in Home Routed roaming case the SMF and UPF in
HPLMN are not involved.
For Service Request due to user data, network may take further actions if User
Plane connection activation is not successful.
The procedure in this clause 4.2.3.2 is applicable to the scenarios with or
without intermediate UPF and with or without intermediate UPF reselection.
If the UE initiates Service Request procedures via non-3GPP Access, functions
defined in the clause 4.12.4.1 are applied.
Figure 4.2.3.2-1: UE Triggered Service Request procedure
1\. UE to (R)AN: AN message (AN parameters, Service Request (List Of PDU
Sessions To Be Activated, List Of Allowed PDU Sessions, security parameters,
PDU Session status, 5G-S-TMSI, [NAS message container], Exempt Indication)).
The NAS message container shall be included if the UE is sending a Service
Request message as an Initial NAS message and the UE needs to send non-
cleartext IEs, see clause 4.4.6 in TS 24.501 [25].
The List Of PDU Sessions To Be Activated is provided by UE when the UE wants
to re-activate the PDU Session(s). The List Of Allowed PDU Sessions is
provided by the UE when the Service Request is a response of a Paging or a NAS
Notification for a PDU Session associated with non-3GPP access and identifies
the PDU Sessions that can be transferred to 3GPP access.
In the case of NG-RAN:
\- The AN parameters include 5G-S-TMSI, Selected PLMN ID and Establishment
cause. The Establishment cause provides the reason for requesting the
establishment of an RRC connection.
\- The UE sends Service Request message towards the AMF encapsulated in an RRC
message to the NG-RAN. The RRC message(s) that can be used to carry the 5G-S-
TMSI and this NAS message are described in TS 38.331 [12] and TS 36.331 [16].
If the Service Request is triggered by the UE for user data, the UE
identifies, using the List Of PDU Sessions To Be Activated, the PDU Session(s)
for which the UP connections are to be activated in Service Request message.
When the UE includes the List Of PDU Sessions To Be Activated, the UE shall
indicate PDU Sessions only associated with the access the Service Request is
related to. If the Service Request is triggered by the UE for signalling only,
the UE doesn\'t identify any List Of PDU Sessions To Be Activated. If this
procedure is triggered for paging response and the UE has at the same time
some user data to be transferred, the UE identifies the PDU Session(s) whose
UP connections are to be activated in Service Request message, by the List Of
PDU Sessions To Be Activated. Otherwise the UE does not identify any PDU
Session(s) in the Service Request message for paging response. As defined in
TS 24.501 [25] the UE shall include always-on PDU Sessions which are accepted
by the network in the List Of PDU Sessions To Be Activated even if there are
no pending uplink data for those PDU Sessions or when the Service Request is
triggered for signalling only or when the Service Request is triggered for
paging response.
If the Service Request over 3GPP access is triggered in response to the paging
or NAS Notification indicating non-3GPP access, the Service Request message
shall identify the list of PDU Sessions associated with the non-3GPP access
that can be re-activated over 3GPP in the List Of Allowed PDU Sessions, as
described in clause 4.2.3.3 (step 6) of this specification and in clause 5.6.8
of TS 23.501 [2].
If the Service Request is triggered to report PS Data Off status change and
the UE is in Non-Allowed Area, the UE shall send Service Request message with
an indication that the message is exempted from restriction (e.g. Non-Allowed
Area). In this case, if the UE is in Non-Allowed Area, the UE shall not
include the List Of PDU Sessions To Be Activated and as a result the always-on
PDU Session is not re-activated during the Service Request procedure.
The PDU Session status indicates the PDU Sessions available in the UE.
The UE shall not trigger a Service Request procedure for a PDU Session
corresponding to a LADN when the UE is outside the area of availability of the
LADN.
NOTE 1: A PDU Session corresponding to a LADN is not included in the List Of
PDU Sessions To Be Activated when the UE is outside the area of availability
of the LADN.
For UE in CM-CONNECTED state, only the List Of PDU Sessions To Be Activated
and List Of Allowed PDU Sessions need to be included in the Service Request.
2\. (R)AN to AMF: N2 Message (N2 parameters, Service Request).
Details of this step are described in TS 38.413 [10]. If the AMF can\'t handle
the Service Request it will reject it.
When NG-RAN is used, the N2 parameters include the 5G-S-TMSI, Selected PLMN
ID, Location information and Establishment cause, UE Context Request.
If the UE is in CM-IDLE state, the NG-RAN obtains the 5G-S-TMSI in RRC
procedure. NG-RAN selects the AMF according to 5G-S-TMSI. The Location
Information relates to the cell in which the UE is camping.
Based on the PDU Session status, the AMF may initiate PDU Session Release
procedure in the network for the PDU Sessions whose PDU Session ID(s) were
indicated by the UE as not available.
When the Establishment cause is associated with priority services (e.g. MPS,
MCS), the AMF includes a Message Priority header to indicate priority
information. Other NFs relay the priority information by including the Message
Priority header in service-based interfaces, as specified in TS 29.500 [17].
3a) AMF to (R)AN: N2 Request (security context, Mobility Restriction List,
list of recommended cells / TAs / NG-RAN node identifiers).
If the 5G-AN had requested for UE Context or there is a requirement for AMF to
provide this e.g. the AMF needs to initiate fallback procedure as in clause
4.13.4.2 for Emergency services, AMF initiates NGAP procedure as specified in
TS 38.413 [10]. For UE in CM-IDLE state, 5G-AN stores the Security Context in
the UE AN context. Mobility Restriction List is described in clause 5.3.4.1 of
TS 23.501 [2] \"Mobility Restrictions\".
The 5G-AN uses the Security Context to protect the messages exchanged with the
UE as described in TS 33.501 [15].
If the NG-RAN node had provided the list of recommended cells / TAs / NG-RAN
node identifiers during the AN Release procedure (see clause 4.2.6), the AMF
shall include it in the N2 Request. The RAN may use this information to
allocate the RAN Notification Area when the RAN decides to enable RRC Inactive
state for the UE.
3\. If the Service Request was not sent integrity protected or integrity
protection verification failed, the AMF shall reject the Service Request as
stated in TS 24.501 [25].
If the UE in CM-IDLE state triggered the Service Request to establish a
signalling connection only, after successful establishment of the signalling
connection the UE and the network can exchange NAS signalling and steps 4 to
11 and 15 to 22 are skipped.
If the UE triggered the Service Request with an indication that the message is
exempted from restriction (e.g. Non-Allowed Area), the AMF should accept the
Service Request. In this case, if the UE is in Non-Allowed Area, the AMF
rejects user plane setup request from the SMF except for emergency services.
If the procedure was triggered in response to paging or NAS notification
indicating non-3GPP access and the AMF received N1 SM Container only from the
SMF in step 3a of clause 4.2.3.3, the AMF sends the NAS signalling including
the N1 SM Container to the UE in step 7 of clause 4.2.3.3 without updating the
access associated to the PDU Session.
4\. [Conditional] AMF to SMF: Nsmf_PDUSession_UpdateSMContext Request (PDU
Session ID(s), Operation Type, UE location information, Access Type, RAT Type,
UE presence in LADN service area, Indication of Access Type can be changed).
The Nsmf_PDUSession_UpdateSMContext Request is invoked:
\- If the UE identifies List Of PDU Sessions To Be Activated in the Service
Request message;
\- This procedure is triggered by the SMF but the PDU Session(s) identified by
the UE correlates to other PDU Session ID(s) than the one triggering the
procedure; or
\- If this procedure is triggered by the SMF in response to paging or NAS
notification indicating 3GPP access or if this step onwards is invoked
following step 4a of clause 4.2.3.3, but the current UE location is outside
the \"Area of validity for the N2 SM information\" provided by the SMF in step
3a of clause 4.2.3.3 or the \"Area of validity for the N2 SM information\" was
not provided by the SMF in step 3a of clause 4.2.3.3, the AMF shall not send
the N2 information provided by the SMF in step 3a of clause 4.2.3.3.
Otherwise, if the current UE location is in the \"Area of validity for the N2
SM information\", steps 4 to 11 are skipped; or
\- If this procedure is triggered by SMF in response to paging or NAS
notification indicating non-3GPP access and the AMF received N2 SM Information
only, or both N1 SM Container and N2 SM Information in step 3a of clause
4.2.3.3.
If the DNN corresponds to an LADN then the \"UE presence in LADN service
area\" indicates if the UE is IN or OUT of the LADN service area. If the AMF
does not provide the \"UE presence in LADN service area\" indication and the
SMF determines that the DNN corresponds to a LADN, then the SMF considers that
the UE is OUT of the LADN service area.
The AMF determines the PDU Session(s) for which the UP connection(s) shall be
activated and sends an Nsmf_PDUSession_UpdateSMContext Request to SMF(s)
associated with the PDU Session(s) with Operation Type set to \"UP activate\"
to indicate establishment of User Plane resources for the PDU Session(s). The
AMF determines Access Type and RAT Type based on the Global RAN Node ID
associated with the N2 interface.
If the procedure was triggered in response to paging or NAS Notification
indicating non-3GPP access, the AMF received N2 SM Information in step 3a of
clause 4.2.3.3 and the PDU Session for which the UE was paged or notified is
not in the List Of Allowed PDU Sessions provided by the UE, the AMF notifies
the SMF that the UE is not reachable. For other PDU Sessions in the List Of
Allowed PDU Sessions the Service Request Procedure succeeds without re-
activating the User Plane of any PDU Sessions, unless they have also been
included by the UE in the List Of PDU Sessions To Be Activated.
If the procedure was triggered in response to paging or NAS notification
indicating non-3GPP access and the PDU Session for which the UE was paged or
notified is in the List Of Allowed PDU Sessions provided by the UE and the AMF
received N2 SM Information only or N1 SM Container and N2 SM Information from
the SMF in step 3a of clause 4.2.3.3, the AMF notifies the SMF that the access
type of the PDU session can be changed. The AMF discards any already received
N1 SM Container and N2 SM Information. In Home Routed roaming case, the V-SMF
triggers Nsmf_PDUSession_Update service operation towards the H-SMF to notify
the access type of the PDU Session can be changed and the procedure continues
as specified in clause 4.3.3.3 from step 1a to step 10.
The AMF may receive a Service Request to establish another NAS signalling
connection via a NG-RAN while it has maintained an old NAS signalling
connection for UE still via NG-RAN. In this case, AMF shall trigger the AN
release procedure toward the old NG-RAN to release the old NAS signalling
connection as defined in clause 4.2.6 with following logic:
\- For the PDU Sessions indicated in the List Of PDU Sessions To Be Activated,
the AMF requests the SMF to activate the PDU Session(s) immediately by
performing this step 4.
\- For the PDU Sessions indicated in the \"List of PDU Session ID(s) with
active N3 user plane\" but not in the List Of PDU Sessions To Be Activated,
the AMF requests the SMF to deactivate the PDU Session(s).
5a. [Conditional] SMF to PCF: If the AMF notified the SMF that the access type
of the PDU session can be changed in step 4 and if PCC is deployed, the SMF
perform an SMF initiated SM Policy Association Modification procedure as
defined in clause 4.16.5.1 if Policy Control Request Trigger condition(s) have
been met (i.e. change of Access Type). The PCF may provide updated PCC
Rule(s).
5b. If the PDU Session ID corresponds to a LADN and the SMF determines that
the UE is outside the area of availability of the LADN based on the \"UE
presence in LADN service area\" from the AMF, the SMF decides to (based on
local policies) either:
\- keep the PDU Session, but reject the activation of User Plane connection
for the PDU Session and inform the AMF about it. If the procedure has been
triggered by a Network Triggered Service Request as described in clause
4.3.2.3, the SMF may notify the UPF that originated the Data Notification to
discard downlink data for the PDU Sessions and/or to not provide further Data
Notification messages; or
\- to release the PDU Session: the SMF releases the PDU Session and informs
the AMF that the PDU Session is released.
In any case of the two cases above the SMF answers to the AMF (step10) with an
appropriate reject cause and the User Plane Activation of PDU Session is
stopped.
Otherwise, based on the location info received from the AMF, the SMF checks
the UPF Selection Criteria according to clause 6.3.3 of TS 23.501 [2] and
determines to perform one of the following:
\- accepts the activation of UP connection and continue using the current
UPF(s);
\- accepts the activation of UP connection and selects a new intermediate UPF
(or add/remove an intermediate UPF), if the UE has moved out of the service
area of the UPF that was previously connecting to the AN, while maintaining
the UPF(s) acting as PDU Session Anchor. The steps to perform I-UPF
addition/change/removal are described as conditional steps in the following of
the current procedure; or
NOTE 2: If the old and/or new I-UPF implements an UL CL or BP functionality
and a PDU Session Anchor for connectivity to the local access to the Data
Network as described in clause 5.6.4.2 of TS 23.501 [2], the signalling
described in the current clause is intended as the signalling to add, remove
or change the PDU Session Anchor and must be complemented by the signalling to
add, release or change the UL CL or BP as described respectively in clauses
4.3.5.4, 4.3.5.5 and 4.3.5.7.
\- rejects the activation of UP connection of a PDU Session of SSC mode 2 and
trigger re-establishment of the PDU Session after Service Request procedure to
perform the allocation of a new UPF to act as PDU Session Anchor, e.g. the UE
has moved out of the service area of the anchor UPF which is connecting to NG-
RAN.
In the case that the SMF fails to find suitable I-UPF, the SMF decides to
(based on local policies) either:
\- trigger re-establishment of PDU Session. After Service Request procedure,
SMF sends N1 SM message to the UE via the AMF by invoking
Namf_Communication_N1N2MessageTransfer containing the cause indicating PDU
Session re-establishment is required for the UE; or
\- keep the PDU Session, but reject the activation request of User Plane
connection for the PDU Session and inform the AMF about it; or
\- release the PDU Session after Service Request procedure.
6a. [Conditional] SMF to UPF (PSA): N4 Session Modification Request.
Depending on the network deployment, the CN Tunnel Info of UPF (PSA) allocated
for N3 or N9 interface may be changed during the Service Request procedure,
e.g. UPF connected to different IP domains. If the different CN Tunnel Info
need be used and the CN tunnel info is allocated by the UPF, the SMF sends N4
Session Modification Request message to UPF (PSA). If the CN Tunnel Info is
allocated by the SMF, the SMF may provide updated CN tunnel info and UL Packet
detection rules in step 7 instead.
6b. [Conditional] UPF (PSA) to SMF: N4 Session Modification Response.
The UPF (PSA) sends an N4 Session Establishment Response message to the SMF.
If the UPF (PSA) allocates CN Tunnel Info of UPF (PSA), it provides CN Tunnel
Info to the SMF. The UPF (PSA) associate the CN Tunnel Info with UL Packet
detection rules provided by the SMF.
6c. [Conditional] SMF to new UPF (intermediate): N4 Session Establishment
Request.
If the SMF selects a new UPF to act as intermediate UPF for the PDU Session,
or if the SMF selects to insert an intermediate UPF for a PDU Session which
did not have an intermediate UPF, an N4 Session Establishment Request message
is sent to the new UPF, providing Packet detection, Data forwarding,
enforcement and reporting rules to be installed on the intermediate UPF. The
CN Tunnel Info (on N9) of PSA, i.e. which is used to establish the N9 tunnel,
for this PDU Session is also provided to the intermediate UPF.
If the Service Request is triggered by the network and a new UPF is selected
by the SMF to replace the old (intermediate) UPF and if UPF allocates UP
tunnel endpoint information, the SMF may also include a request for the UPF to
allocate a second tunnel endpoint for buffered DL data from the old I-UPF.
6d. New UPF (intermediate) to SMF: N4 Session Establishment Response.
The new intermediate UPF sends an N4 Session Establishment Response message to
the SMF. If the UPF allocates CN Tunnel Info, it provides DL CN Tunnel as
requested by SMF in step 6a. The SMF starts a timer, to be used in step 22a to
release the resource in old intermediate UPF if there is one.
7a. [Conditional] SMF to UPF (PSA): N4 Session Modification Request.
If the SMF selects a new UPF to act as intermediate UPF for the PDU Session,
the SMF sends N4 Session Modification Request message to PDU Session Anchor
UPF, providing DL Tunnel Info from new intermediate UPF. The SMF may also
provide updated UL CN Tunnel Information. If the new intermediate UPF was
added for the PDU Session, the UPF (PSA) begins to send the DL data to the new
I-UPF as indicated in the DL Tunnel Info.
If the Service Request is triggered by the network and the SMF removes the old
I-UPF but does not replace it with a new I-UPF and if UPF allocates UP tunnel
endpoint information, the SMF may also include a request for the UPF to
allocate a second tunnel endpoint for buffered DL data from the old I-UPF. In
this case, the UPF (PSA) begins to buffer the DL data it may receive at the
same time from the N6 interface.
7b. The UPF (PSA) sends N4 Session Modification Response message to SMF.
If requested by SMF, the UPF (PSA) sends CN DL tunnel info for the old
(intermediate) UPF to the SMF. The SMF starts a timer, to be used in step 22a
to release the resource in old intermediate UPF if there is one.
If the UPF that connects to RAN is the UPF (PSA) and if the SMF finds that the
PDU Session is activated when receiving the Nsmf_PDUSession_UpdateSMContext
Request in step 4 with Operation Type set to \"UP activate\" to indicate
establishment of User Plane resources for the PDU Session(s), it deletes the
AN Tunnel Info and initiates an N4 Session Modification procedure to remove
Tunnel Info of AN in the UPF.
8a. [Conditional] SMF to old UPF (intermediate): N4 Session Modification
Request (New UPF address, New UPF DL Tunnel ID)
If the service request is triggered by the network and the SMF removes the old
(intermediate) UPF, the SMF sends the N4 Session Modification Request message
to the old (intermediate) UPF, providing the DL Tunnel Info for the buffered
DL data. If the SMF allocated new I-UPF, the DL Tunnel Info is from the new
(intermediate) UPF acting as N3 terminating point. If the SMF did not allocate
a new I-UPF, the DL Tunnel Info is from the new UPF (PSA) acting as N3
terminating point. The SMF starts a timer to monitor the forwarding tunnel as
step 6b or 7b.
If the SMF find the PDU Session is activated when receiving the
Nsmf_PDUSession_UpdateSMContext Request in step 4 with Operation Type set to
\"UP activate\" to indicate establishment of User Plane resources for the PDU
Session(s), it deletes the AN Tunnel Info and initiates an N4 Session
Modification procedure to remove Tunnel Info of AN in the UPF.
8b. old UPF (intermediate) to SMF: N4 Session Modification Response
The old (intermediate) UPF sends N4 Session Modification Response message to
SMF.
9\. [Conditional] old UPF (intermediate) to new UPF (intermediate): buffered
downlink data forwarding
If the I-UPF is changed and forwarding tunnel was established to the new
I-UPF, the old (intermediate) UPF forwards its buffered data to the new
(intermediate) UPF acting as N3 terminating point.
10\. [Conditional] old UPF (intermediate) to UPF (PSA): buffered downlink data
forwarding
If the old I-UPF is removed and no new I-UPF is assigned for the PDU Session
and forwarding tunnel was established to the UPF (PSA), the old (intermediate)
UPF forwards its buffered data to the UPF (PSA) acting as N3 Terminating
Point.
11\. [Conditional] SMF to AMF: Nsmf_PDUSession_UpdateSMContext Response (N2 SM
information (PDU Session ID, QFI(s), QoS profile(s), CN N3 Tunnel Info,
S-NSSAI, User Plane Security Enforcement, UE Integrity Protection Maximum Data
Rate), N1 SM Container, Cause) to the AMF. If the UPF that connects to RAN is
the UPF (PSA), the CN N3 Tunnel Info is the UL Tunnel Info of the UPF (PSA).
If the UPF that connects to RAN is the new intermediate UPF, the CN N3 Tunnel
Info is the UL Tunnel Info of the intermediate UPF.
The SMF shall send N1 SM Container and/or N2 SM Information to the AMF when
applicable. (e.g. when the SMF was notified from the AMF that the access type
of the PDU Session can be changed in step 4).
For a PDU Session that the SMF has determined to accept the activation of UP
connection in step 5a or 5b, the SMF generates only N2 SM information and
sends Nsmf_PDUSession_UpdateSMContext Response to the AMF to establish the
User Plane(s). The N2 SM information contains information that the AMF shall
provide to the NG-RAN. If the SMF decided to change the PSA UPF for the SSC
mode 3 PDU Session, the SMF triggers the change of SSC mode 3 PDU Session
anchor as an independent procedure described in clause 4.3.5.2 or clause
4.3.5.3 after accepting the activation of UP of the PDU Session.
The SMF can reject the activation of UP of the PDU Session by including a
cause in the Nsmf_PDUSession_UpdateSMContext Response. Following are some of
the cases:
\- If the PDU Session corresponds to a LADN and the UE is outside the area of
availability of the LADN as described in step 5b;
\- If the AMF notified the SMF that the UE is reachable only for regulatory
prioritized service and the PDU Session to be activated is not for a
regulatory prioritized service; or
\- If the SMF decided to change the PSA UPF for the requested PDU Session as
described in step 5b. In this case, after sending
Nsmf_PDUSession_UpdateSMContext Response, the SMF triggers another procedure
to instruct UE to re-establish the PDU Session as described in clause 4.3.5.1
for SSC mode 2.
\- If the SMF received negative response in Step 6b due to UPF resource
unavailability.
If the PDU Session has been assigned any EPS bearer ID, the SMF also includes
the mapping between EPS bearer ID(s) and QFI(s) into the N2 SM information to
be sent to the NG-RAN.
The User Plane Security Enforcement information is determined by the SMF upon
PDU session establishment as described in clause 5.10.3 of TS 23.501 [2]. If
the User Plane Security Enforcement information indicates that Integrity
Protection is \"Preferred\" or \"Required\", the SMF also includes the UE
Integrity Protection Maximum Data Rate.
12\. AMF to (R)AN: N2 Request (N2 SM information received from SMF, security
context, Mobility Restriction List, Subscribed UE-AMBR, MM NAS Service Accept,
list of recommended cells / TAs / NG-RAN node identifiers, UE Radio
Capability, Core Network Assistance Information, Tracing Requirements). The
Allowed NSSAI for the Access Type for the UE is included in the N2 message. If
the subscription information includes Tracing Requirements, the AMF includes
Tracing Requirements in the N2 Request.
If the UE triggered the Service Request while in CM-CONNECTED state, only N2
SM information received from SMF and MM NAS Service Accept are included in the
N2 Request.
If the Service Request procedure is triggered by the Network (as described in
clause 4.2.3.3) while the UE is in CM-CONNECTED state, only N2 SM information
received from SMF is included in the N2 Request.
If the Service Request procedure is triggered by the Network (as described in
clause 4.2.3.3) while the UE is in CM-IDLE state, only N2 SM information
received from SMF and MM NAS Service Accept is included in the N2 Request.
For a UE that was in CM-IDLE state when the Service Request was triggered, the
NG-RAN stores the Security Context. If the Service Request is not triggered by
UE for a signalling connection only, RAN also stores QoS Information for the
QoS Flows of the PDU Sessions that are activated and N3 Tunnel IDs in the UE
RAN context and Mobility Restriction List (as described in clause 5.3.4.1 of
TS 23.501 [2]).
MM NAS Service Accept includes PDU Session status in AMF. Any local PDU
Session Release during the Session Request procedure is indicated to the UE
via the Session Status. PDU Session Reactivation Result is provided in Service
Accept for the PDU sessions in the List Of PDU Sessions To Be Activated and
the PDU Session in the List of Allowed PDU Sessions which has caused paging or
NAS notification. If the PDU Session Reactivation Result of a PDU Session is
failure, the cause of the failure is also provided.
If there are multiple PDU Sessions that involves multiple SMFs, AMF does not
need to wait for responses from all SMFs in step 11 before it send N2 SM
information to the RAN. However, the AMF shall wait for all responses from the
SMFs before it sends MM NAS Service Accept message to the UE.
AMF shall include at least one N2 SM information from SMF if this step is
triggered for PDU Session User Plane activation. AMF may send additional N2 SM
information from SMFs in separate N2 message(s) (e.g. N2 tunnel setup
request), if there is any. Alternatively, if multiple SMFs are involved, the
AMF may send one N2 Request message to (R)AN after all the
Nsmf_PDUSession_UpdateSMContext Response service operations from all the SMFs
associated with the UE are received.
If the NG-RAN node had provided the list of recommended cells / TAs / NG-RAN
node identifiers during the AN Release procedure (see clause 4.2.6), the AMF
shall include it in the N2 Request. The NG-RAN may use this information to
allocate the RAN Notification Area when the NG-RAN decides to enable RRC
Inactive state for the UE.
The AMF includes the UE\'s \"RRC Inactive Assistance Information\" as defined
in clause 5.3.3.2.5 of TS 23.501 [2].
The AMF shall include the UE Radio Capability information, if available, to
the NG-RAN node as described in TS 23.501 [2].
The AMF may include the Core Network Assistance Information which includes
Core Network assisted RAN parameters tuning and Core Network assisted RAN
paging information as defined in TS 23.501 [2].
13\. (R)AN to UE: The NG-RAN performs RRC Connection Reconfiguration with the
UE depending on the QoS Information for all the QoS Flows of the PDU Sessions
whose UP connections are activated and Data Radio Bearers. For a UE that was
in CM-IDLE state, if the Service Request is not triggered by UE for a
signalling connection only, the User Plane security is established at this
step, which is described in detail in TS 38.331 [12] and TS 36.331 [16]. For a
UE that was in CM-IDLE state, if the Service Request is triggered by UE for a
signalling connection only, AS security context may be established in this
step, which is described in detail in TS 38.331 [12] and TS 36.331 [16].
If the N2 Request includes a NAS message, the NG-RAN forwards the NAS message
to the UE. The UE locally deletes context of PDU Sessions that are not
available in 5GC.
NOTE 3: The reception of the Service Accept message does not imply the
successful activation of the User Plane radio resources.
NOTE 4: If not all the requested User Plane AN resources are successfully
activated, TS 38.413 [10] will define how to handle this.
After the User Plane radio resources are setup, the uplink data from the UE
can now be forwarded to NG-RAN. The NG-RAN sends the uplink data to the UPF
address and Tunnel ID provided in the step 11.
14\. [Conditional] (R)AN to AMF: N2 Request Ack (List of PDU Sessions To Be
Established with N2 SM information (AN Tunnel Info, List of accepted QoS Flows
for the PDU Sessions whose UP connections are activated, List of rejected QoS
Flows for the PDU Sessions whose UP connections are activated), List of PDU
Sessions that failed to be established with the failure cause given in the N2
SM information element).
The message may include N2 SM information(s), e.g. AN Tunnel Info. NG-RAN may
respond N2 SM information with separate N2 message (e.g. N2 tunnel setup
response) if AMF sends separate N2 message in step 11.
If multiple N2 SM information are included in the N2 Request message in step
12, the N2 Request Ack includes multiple N2 SM information and information to
enable the AMF to associate the responses to relevant SMF.
15\. [Conditional] AMF to SMF: Nsmf_PDUSession_UpdateSMContext Request (N2 SM
information, RAT Type, Access Type) per PDU Session to the SMF. The AMF
determines Access Type and RAT Type based on the Global RAN Node ID associated
with the N2 interface.
If the AMF received N2 SM information (one or multiple) in step 14, then the
AMF shall forward the N2 SM information to the relevant SMF per PDU Session
ID. If the UE Time Zone has changed compared to the last reported UE Time Zone
then the AMF shall include the UE Time Zone IE in this message.
If the PDU Session is moved from the non-3GPP access to 3GPP access (i.e. N3
tunnel for the PDU Session is established successfully), the SMF and AMF
update associated access of the PDU Session. The UE updates associated access
of the PDU Session when the user plane resource for the PDU Session is
successfully established.
Procedure for unpausing a charging pause initiated earlier is specified in
clause 4.4.4.
If a PDU Session is rejected by the serving NG-RAN with an indication that the
PDU Session was rejected because User Plane Security Enforcement is not
supported in the serving NG-RAN and the User Plane Enforcement Policy
indicates \"Required\" as described in clause 5.10.3 of TS 23.501 [2], the SMF
shall trigger the release of this PDU Session. In all other cases of PDU
Session rejection, the SMF can decide whether to release the PDU Session or to
deactivate the UP connection of this PDU Session.
If some of the QoS Flows of a PDU Session are not accepted by the serving NG-
RAN, the SMF shall initiate the PDU Session Modification procedure to remove
the non-accepted QoS Flows from the PDU Session after this procedure is
completed.
16\. [Optional] SMF to PCF: If dynamic PCC is deployed, SMF may initiate
notification about new location information to the PCF (if subscribed) by
performing an SMF initiated SM Policy Modification procedure as defined in
clause 4.16.5.1. The PCF may provide updated policies.
17a. [Conditional] SMF to new intermediate UPF: N4 Session Modification
Request (AN Tunnel Info and List of accepted QFI(s)).
If the SMF selected a new UPF to act as intermediate UPF for the PDU Session
in step 5b, the SMF initiates a N4 Session Modification procedure to the new
I-UPF and provides AN Tunnel Info. The Downlink Data from the new I-UPF can
now be forwarded to NG-RAN and UE.
17b. [Conditional] UPF to SMF: N4 Session Modification Response.
18a. [Conditional] SMF to UPF (PSA): N4 Session Modification Request (AN
Tunnel Info, List of rejected QoS Flows).
If a User Plane is to be setup or modified and after the modification there is
no I-UPF, the SMF initiates a N4 Session Modification procedure to UPF (PSA)
and provides AN Tunnel Info. The Downlink Data from the UPF (PSA) can now be
forwarded to NG-RAN and UE.
For QoS Flows in the List of rejected QoS Flows, the SMF shall instruct the
UPF to remove the rules (e.g. Packet Detection Rules etc.) which are
associated with the QoS Flows.
18b. [Conditional] UPF to SMF: N4 Session Modification Response.
19\. [Conditional] SMF to AMF: Nsmf_PDUSession_UpdateSMContext Response.
20a. [Conditional] SMF to new UPF (intermediate): N4 Session Modification
Request.
If forwarding tunnel has been established to the new I-UPF and if the timer
SMF set for forwarding tunnel at step 8a has expired, SMF sends N4 Session
modification request to new (intermediate) UPF acting as N3 terminating point
to release the forwarding tunnel.
20b. [Conditional] new UPF (intermediate) to SMF: N4 Session modification
response.
New (intermediate) UPF acting as N3 terminating point sends N4 Session
Modification response to SMF.
21a. [Conditional] SMF to UPF (PSA): N4 Session Modification Request.
If forwarding tunnel has been established to the UPF (PSA) and if the timer
SMF set for forwarding tunnel at step 7b has expired, SMF sends N4 Session
modification request to UPF (PSA) acting as N3 Terminating Point to release
the forwarding tunnel.
21b. [Conditional] UPF (PSA) to SMF: N4 Session Modification Response.
UPF (PSA) acting as N3 Terminating Point sends N4 Session Modification
Response to SMF.
22a. [Conditional] SMF to old UPF: N4 Session Modification Request or N4
Session Release Request.
If the SMF decided to continue using the old UPF in step 5b, the SMF sends an
N4 Session Modification Request, providing AN Tunnel Info.
If the SMF decided to select a new UPF to act as intermediate UPF in step 5b
and the old UPF is not PSA UPF, the SMF initiates resource release, after
timer in step 6b or 7b expires, by sending an N4 Session Release Request
(Release Cause) to the old intermediate UPF.
22b. Old intermediate UPF to SMF: N4 Session Modification Response or N4
Session Release Response.
The old UPF acknowledges with an N4 Session Modification Response or N4
Session Release Response message to confirm the modification or release of
resources.
For the mobility related events described in clause 4.15.4, the AMF invokes
the Namf_EventExposure_Notify service operation after step 4.
Upon reception of the Namf_EventExposure_Notify with an indication that the UE
is reachable, if the SMF has pending DL data the SMF invokes the
Namf_Communication_N1N2MessageTransfer service operation to the AMF to
establish the User Plane(s) for the PDU Sessions, otherwise the SMF resumes
sending DL data notifications to the AMF in the case of DL data.
Upon reception of the Namf_EventExposure_Notify with an indication that UE is
reachable only for regulatory prioritized service, the SMF deactivates the PDU
Session if the service of the PDU Session is not regulatory prioritized. For
home routed roaming case, the V-SMF triggers the deactivation of the PDU
Session, in addition, the H-SMF refrains from sending downlink signalling if
the signalling is not related to regulatory prioritized service upon receiving
the notification.
#### 4.2.3.3 Network Triggered Service Request
This procedure is used when the network needs to signal (e.g. N1 signalling to
UE, Mobile-terminated SMS, User Plane connection activation for PDU Session(s)
to deliver mobile terminating user data) with a UE. When the procedure is
triggered by SMSF, PCF, LMF, GMLC, NEF or UDM, the SMF in the following figure
should be replaced by the respective NF. If the UE is in CMâ€‘IDLE state or CM-
CONNECTED state in 3GPP access, the network initiates a Network Triggered
Service Request procedure. If the UE is in CM-IDLE state and asynchronous type
communication is not activated, the network sends a Paging Request to
(R)AN/UE. The Paging Request triggers the UE Triggered Service Request
procedure in the UE. If asynchronous type communication is activated, the
network stores the received message and forward the message to the (R)AN
and/or the UE (i.e. synchronizes the context with the (R)AN and/or the UE)
when the UE enters CM-CONNECTED state.
If the UE is in CM-IDLE state in non-3GPP access and if the UE is
simultaneously registered over 3GPP and non-3GPP accesses in a PLMN, the
network shall initiate a Network Triggered Service Request procedure over 3GPP
access.
If the UE is in CM-IDLE state in 3GPP access and in CM-CONNECTED state in
non-3GPP access and if the UE is simultaneously registered over 3GPP and
non-3GPP accesses in the same PLMN, the network may initiate a Network
Triggered Service Request procedure for 3GPP access via non-3GPP access.
For this procedure, the impacted SMF and UPF are all under control of the PLMN
serving the UE, e.g. in Home Routed roaming case the SMF and UPF in HPLMN are
not involved.
The procedure below covers the following non-exhaustive list of use-cases for
3GPP access (detailed conditions of when the steps apply are stated in the
procedure below):
\- The SMF needs to setup N3 tunnel to deliver downlink packet to the UE for a
PDU Session and the UE is in CM-IDLE state: Step 3a contains an N2 message and
Step 4b (paging) is performed.
\- The SMF needs to setup N3 tunnel to deliver downlink packet to the UE for a
PDU Session and the UE is in CM-CONNECTED state: Step 3a contains an N2
message and Step 4a (UP reactivation) is performed.
\- NF (e.g. SMF, SMSF, PCF or LMF) needs to send an N1 message to the UE,
using the Namf_Communication_N1N2MessageTransfer service operation and the UE
is in CM-IDLE state: Step 3a contains an N1 message, Step 3b contains cause
\"Attempting to reach UE\" and Step 4b (paging) occurs.
\- The LMF triggers AMF, using the Namf_Communication_N1N2MessageTransfer
service operation, to setup a NAS connection with the UE and the UE is in CM-
IDLE state: Step 3b contains cause \"Attempting to reach UE\" and step 4b
(paging) occurs.
\- The GMLC triggers AMF, using the Namf_Location_ProvideLocation service
operation, to setup a NAS connection with the UE and the UE is in CM-IDLE
state: Step 4b (paging) occurs.
\- The PCF needs to send a message to the UE, using the
Npcf_AMPolicyControl_Create Response service operation, or the
Npcf_AMPolicyControl_UpdateNotify service operation and the UE is in CM-IDLE
state: Step 3a contains a message and step 4b (paging) occurs.
\- NF (e.g. SMSF) triggers AMF, using the Namf_MT_EnableUEReachability service
operation, to setup a NAS connection with the UE and the UE is in CM-IDLE
state: The trigger is specific to the procedure and Step 4b (paging) occurs.
Figure 4.2.3.3-1: Network Triggered Service Request
1\. When a UPF receives downlink data for a PDU Session and there is no AN
Tunnel Info stored in UPF for the PDU Session, based on the instruction from
the SMF (as described in clause 5.8.3 of TS 23.501 [2]), the UPF may buffer
the downlink data (steps 2a and 2b), or forward the downlink data to the SMF
(step 2c).
2a. UPF to SMF: Data Notification (N4 Session ID, Information to identify the
QoS Flow for the DL data packet, DSCP).
\- On arrival of the first downlink data packet for any QoS Flow, the UPF
shall send Data Notification message to the SMF, if the SMF has not previously
notified the UPF to not send the Data Notification to the SMF (in which case
the next steps are skipped).
\- If the UPF receives downlink data packets for another QoS Flow in the same
PDU Session, the UPF shall send another Data Notification message to the SMF.
\- If the Paging Policy Differentiation feature (as specified in clause 5.4.3
of TS 23.501 [2]) is supported by the UPF and if the PDU Session type is IP,
the UPF shall also include the DSCP in TOS (IPv4) / TC (IPv6) value from the
IP header of the downlink data packet and the information to identify the QoS
Flow for the DL data packet.
2b. SMF to UPF: Data Notification Ack.
2c. The UPF forwards the downlink data packets towards the SMF if the SMF
instructed the UPF to do so (i.e. the SMF will buffer the data packets).
\- If the Paging Policy Differentiation feature is supported by the SMF and if
the PDU Session type is IP, the SMF determines the Paging Policy Indicator
based on the DSCP in TOS (IPv4) / TC (IPv6) value from the IP header of the
received downlink data packet and identifies the corresponding QoS Flow from
the QFI of the received DL data packet.
3a. [Conditional] SMF to AMF: Namf_Communication_N1N2MessageTransfer (SUPI,
PDU Session ID, N1 SM container (SM message), N2 SM information (QFI(s), QoS
profile(s), CN N3 Tunnel Info, S-NSSAI), Area of validity for N2 SM
information, ARP, Paging Policy Indicator, 5QI, N1N2TransferFailure
Notification Target Address), or NF to AMF:
Namf_Communication_N1N2MessageTransfer (SUPI, N1 message).
The SMF shall not include both N1 SM Container and N2 SM Information in
Namf_Communication_N1N2MessageTransfer unless the N1 SM Container is related
to the N2 SM Information.
If this step is triggered by a notification from UPF, upon reception of a Data
Notification message, for a PDU Session corresponding to a LADN, the SMF takes
actions as specified in clause 5.6.5 of TS 23.501 [2]. The SMF may notify the
UPF that originated the Data Notification to discard downlink data for the PDU
Sessions and/or to not provide further Data Notification messages.
Otherwise, the SMF determines whether to contact the AMF. The SMF does not
contact the AMF:
\- if the SMF had previously been notified that the UE is unreachable; or
\- if the UE is reachable only for regulatory prioritized service and the PDU
Session is not for regulatory prioritized service.
The SMF determines the AMF and invokes the
Namf_Communication_N1N2MessageTransfer to the AMF including the PDU Session ID
of the PDU Session. If this step is triggered by a notification from the UPF
in step 2a, the SMF determines the PDU Session ID based on the N4 Session ID
received in step 2a.
If the SMF, while waiting for the User Plane Connection to be activated,
receives any additional Data Notification message or, in the case that the SMF
buffers the data packets, additional data packets for a QoS Flow associated
with a higher priority (i.e. ARP priority level) than the priority indicated
to the AMF in the previous Namf_Communication_N1N2MessageTransfer, or the SMF
derive a different Paging Policy Indicator according to the additional Data
Notification or the DSCP of the data packet, the SMF invokes a new
Namf_Communication_N1N2MessageTransfer indicating the higher priority or
different Paging Policy Indicator to the AMF.
If the SMF, while waiting for the User Plane to be activated, receives a
message from a new AMF other than the one to which the SMF invoked
theNamf_Communication_N1N2MessageTransfer, the SMF re-invokes the
Namf_Communication_N1N2MessageTransfer towards the new AMF.
When supporting Paging Policy Differentiation, the SMF determines the Paging
Policy Indicator related to the downlink data that has been received from the
UPF or triggered the Data Notification message, based on the DSCP as described
in clause 5.4.3 of TS 23.501 [2] and indicates the Paging Policy Indicator in
the Namf_Communication_N1N2MessageTransfer.
NOTE 1: AMF may receive request message(s) from other network functions which
leads to signalling towards UE/RAN, e.g. Network-initiated Deregistration, SMF
initiated PDU Session Modification. If the UE is in CM-CONNECTED state and the
AMF only delivers N1 message towards UE, the flow continues in step 6 below.
The N2 SM information is optional and is not provided e.g. if the SMF only
wants to send an N1 message such as PDU Session Modification Command with only
updating the UE with a PCO.
3b. [conditional] The AMF responds to the SMF.
If the UE is in CM-IDLE state at the AMF and the AMF is able to page the UE
the AMF sends a Namf_Communication_N1N2MessageTransfer response to the SMF
immediately with a cause \"Attempting to reach UE\" which indicates to the SMF
that the N2 SM information provided in step 3a, may be ignored by the AMF once
the UE is reachable and the SMF may be asked to provide the N2 SM information
again.
While waiting for the UE to respond to a previous paging request, if the AMF
receives an Namf_Communication_N1N2MessageTransfer Request message with the
same or a lower priority than the previous message triggering the paging, or
if the AMF has determined not to trigger additional paging requests for this
UE based on local policy, the AMF rejects the
Namf_Communication_N1N2MessageTransfer Request message.
If the UE is in CM-CONNECTED state at the AMF then the AMF sends a
Namf_Communication_N1N2MessageTransfer response to the SMF immediately with a
cause \"N1/N2 transfer success\".
If the UE is in CM-IDLE state and the AMF determines that the UE is not
reachable for paging, the AMF shall send an
Namf_Communication_N1N2MessageTransfer response to the NF from which AMF
received the request message in step 3a, or the AMF performs asynchronous type
communication and stores the UE context based on the received message. If
asynchronous type communication is invoked, the AMF initiates communication
with the UE and (R)AN when the UE is reachable e.g. when the UE enters CM-
CONNECTED state.
If the AMF has determined the UE is unreachable for the SMF (e.g. due to the
UE in MICO mode or the UE is only registered over non-3GPP access and its
state is CM-IDLE), then the AMF rejects the request from the SMF. The AMF may
include in the reject message an indication that the SMF need not trigger the
Namf_Communication_N1N2MessageTransfer Request to the AMF, if the SMF has not
subscribed to the event of the UE reachability. The AMF stores an indication
that the SMF has been informed that the UE is unreachable.
If the UE is not in MICO mode and the AMF detects the UE is in a Non-Allowed
Area unless the request from the SMF is for regulatory prioritized service,
the AMF rejects the request from the SMF and notifies the SMF that the UE is
reachable only for regulatory prioritized service. The AMF stores an
indication that the SMF has been informed that the UE is reachable only for
regulatory prioritized service.
If the Registration procedure with AMF change is in progress when the old AMF
receives the Namf_Communication_N1N2MessageTransfer, the old AMF may reject
the request with an indication that the Namf_Communication_N1N2MessageTransfer
has been temporarily rejected.
Upon reception of an Namf_Communication_N1N2MessageTransfer response with an
indication that its request has been temporarily rejected, the SMF shall start
a locally configured guard timer and wait for any message to come from an AMF.
Upon reception of a message from an AMF, the SMF shall re-invoke the
Namf_Communication_N1N2MessageTransfer (with N2 SM info and/or N1 SM info) to
the AMF from which it received the message. Otherwise the SMF takes the step
3c at expiry of the guard timer. If the SMF decides that the control plane
buffering applies, the SMF shall request UPF to start forwarding the downlink
data PDU towards the SMF.
3c. [Conditional] SMF responds to the UPF.
SMF may notify the UPF about the User Plane setup failure.
If the SMF receives an indication from the AMF that the UE is unreachable or
reachable only for regulatory prioritized service, the SMF may, based on
network policies, either:
\- indicate to the UPF to stop sending Data Notifications;
\- indicate to the UPF to stop buffering DL data and discard the buffered
data;
\- indicate to the UPF to stop sending Data Notifications and stop buffering
DL data and discard the buffered data; or
\- refrains from sending further Namf_Communication_N1N2MessageTransfer
message for DL data to the AMF while the UE is unreachable.
Then the SMF subscribes to the AMF for UE reachability event notifications.
Based on operator policies, the SMF applies the pause of charging procedure as
specified in clause 4.4.4.
If the SMF receives an indication from the AMF that the
Namf_Communication_N1N2MessageTransfer message requested from an SMF has been
temporarily rejected, the SMF may, based on network policies, indicate to the
UPF to apply temporary buffering.
4a. [Conditional] If the UE is in CM-CONNECTED state in the access associated
with the PDU Session ID received from the SMF in step 3a, the steps 4 to 22 in
UE Triggered Service Request procedure (see clause 4.2.3.2) are performed for
this PDU Session (i.e. establish the radio resources and, in the case that the
User Plane is to be activated, to establish the N3 tunnel) without sending a
Paging message to the (R)AN node and the UE. In step 12 of clause 4.2.3.2, the
AMF does not send the NAS Service Accept message to the UE. The rest of this
procedure is omitted.
4b. [Conditional] If the UE is in CM-IDLE state in 3GPP access and the PDU
Session ID received from the SMF in step 3a has been associated with 3GPP
access and based on local policy the AMF decides to notify the UE through 3GPP
access even when UE is in CM-CONNECTED state for non-3GPP access, the AMF may
send a Paging message to NG-RAN node(s) via 3GPP access.
If the UE is simultaneously registered over 3GPP and non-3GPP accesses in the
same PLMN, the UE is in CM-IDLE state in both 3GPP access and non-3GPP access
and the PDU Session ID in step 3a is associated with non-3GPP access, the AMF
sends a Paging message with associated access \"non-3GPP\" to NG-RAN node(s)
via 3GPP access.
If the UE is in RM-REGISTERED state and CM-IDLE and reachable in 3GPP access,
the AMF sends a Paging message (NAS ID for paging, Registration Area list,
Paging DRX length, Paging Priority, access associated to the PDU Session) to
(R)AN node(s) belonging to the Registration Area(s) in which the UE is
registered, then the NG-RAN node pages the UE, including the access associated
to the PDU Session in the paging message if received from the AMF, see TS
38.331 [12].
NOTE 2: The usage of the Access associated with a PDU Session when paging an
UE is defined in clause 5.6.8 of TS 23.501 [2].
Different paging strategies may be configured in the AMF for different
combinations of DNN, Paging Policy Indicator (if supported), ARP and 5QI.
For RRC-inactive state, the paging strategies may be configured in the (R)AN
for different combinations of Paging Policy Indicator, ARP and 5QI.
Paging Priority is included only:
\- if the AMF receives an Namf_Communication_N1N2MessageTransfer message with
an ARP value associated with priority services (e.g. MPS, MCS), as configured
by the operator.
\- One Paging Priority level can be used for multiple ARP values. The mapping
of ARP values to Paging Priority level (or levels) is configured by operator
policy in the AMF and in NG-RAN.
The (R)AN may prioritise the paging of UEs according to the Paging Priority.
If the AMF, while waiting for a UE response to the Paging Request message sent
without Paging Priority, receives an Namf_Communication_N1N2MessageTransfer
message, which indicates an ARP value associated with priority services (e.g.
MPS, MCS), as configured by the operator, the AMF shall send another paging
message with the suitable Paging Priority. For subsequent received
Namf_Communication_N1N2MessageTransfer messages with the same or higher
priority, the AMF may determine whether to send the Paging message with
suitable Paging Priority based on local policy.
Paging strategies may include:
\- paging retransmission scheme (e.g. how frequently the paging is repeated or
with what time interval);
\- determining whether to send the Paging message to the (R)AN nodes during
certain AMF high load conditions;
\- whether to apply sub-area based paging (e.g. first page in the last known
cell-id or TA and retransmission in all registered TAs).
NOTE 3: Setting of Paging Priority in the Paging message is independent from
any paging strategy.
The AMF and the (R)AN may support further paging optimisations in order to
reduce the signalling load and the network resources used to successfully page
a UE by one or several of the following means:
\- by the AMF implementing specific paging strategies (e.g. the N2 Paging
message is sent to the (R)AN nodes that served the UE last);
\- by the AMF considering Information On Recommended Cells And NG-RAN nodes
provided by the (R)AN at transition to CM-IDLE state. The AMF takes the (R)AN
nodes related part of this information into account to determine the (R)AN
nodes to be paged and provides the information on recommended cells within the
N2 Paging message to each of these (R)AN nodes;
\- by the (R)AN considering the Paging Attempt Count Information provided by
the AMF at paging.
If the UE Radio Capability for Paging Information is available in the AMF, the
AMF adds the UE Radio Capability for Paging Information in the N2 Paging
message to the (R)AN nodes.
If the Information On Recommended Cells And (R)AN nodes For Paging is
available in the AMF, the AMF shall take that information into account to
determine the (R)AN nodes for paging and, when paging a (R)AN node, the AMF
may transparently convey the information on recommended cells to the (R)AN
node.
The AMF may include in the N2 Paging message(s) the paging attempt count
information. The paging attempt count information shall be the same for all
(R)AN nodes selected by the AMF for paging.
4c. [Conditional] If the UE is simultaneously registered over 3GPP and
non-3GPP accesses in the same PLMN and the UE is in CM-CONNECTED state in 3GPP
access and the PDU Session ID in step 3a is associated with non-3GPP access,
the AMF sends a NAS Notification message containing the non-3GPP Access Type
to the UE over 3GPP access and sets a Notification timer. Step 5 is omitted.
If the UE is simultaneously registered over 3GPP and non-3GPP accesses in the
same PLMN and the UE is in CM-CONNECTED state for non-3GPP access and in CM-
IDLE for 3GPP access and if the PDU Session ID in step 3a is associated with
3GPP access and based on local policy the AMF decides to notify the UE through
non-3GPP access, the AMF may send a NAS Notification message containing the
3GPP Access Type to the UE over non-3GPP access and sets a Notification timer.
5\. [Conditional] AMF to SMF: Namf_Communication_N1N2Transfer Failure
Notification.
The AMF supervises the paging procedure with a timer. If the AMF receives no
response from the UE to the Paging Request message, the AMF may apply further
paging according to any applicable paging strategy described in step 4b.
The AMF notifies the SMF by sending Namf_Communications_N1N2MessageTransfer
Failure Notification to the Notification Target Address provided by the SMF in
step 3a if the UE does not respond to paging, unless the AMF is aware of an
ongoing MM procedure that prevents the UE from responding, i.e. the AMF
receives an N14 Context Request message indicating that the UE performs
Registration procedure with another AMF.
When a Namf_Communication_N1N2Transfer Failure Notification is received, SMF
informs the UPF (if applicable).
Procedure for pause of charging at SMF is specified in clause 4.4.4.
6\. If the UE is in CM-IDLE state in 3GPP access, upon reception of paging
request for a PDU Session associated to 3GPP access, the UE shall initiate the
UE Triggered Service Request procedure (clause 4.2.3.2). To support the
buffered data forwarding, the SMF instruct the UPF to establish a Data
forwarding tunnel between the old UPF and the new UPF or to the PSA as
described at steps 6a, 7a, 8a of clause 4.2.3.2.
If the UE is in CM-IDLE state in both non-3GPP and 3GPP accesses, upon
reception of paging request for a PDU Session associated to non-3GPP access,
the UE shall initiate the UE Triggered Service Request procedure (clause
4.2.3.2) which shall contain the List Of Allowed PDU Sessions that, according
to UE policies and whether the S-NSSAIs of these PDU Sessions are within the
Allowed NSSAI for 3GPP access, can be re-activated over the 3GPP access. If
there is no PDU Session that can be re-activated over the 3GPP access, the UE
includes an empty List Of Allowed PDU Sessions. If the AMF receives a Service
Request message from the UE via non-3GPP access as described in clause
4.12.4.1 (e.g. because the UE successfully connects to a non-3GPP access), the
AMF stops the paging procedure and processes the received Service Request
procedure. If the AMF receives the Service Request message and the List Of
Allowed PDU Sessions provided by the UE does not include the PDU Session for
which the UE was paged, the AMF notifies the SMF that the UE was reachable but
did not accept to re-activate the PDU Session by invoking
Namf_EventExposure_Notify service as described in step 4 of clause 4.2.3.2.
If the UE is in CM-IDLE state in non-3GPP access and in CM-CONNECTED state in
3GPP access, upon reception of NAS Notification message over 3GPP access
containing the non-3GPP Access Type, the UE shall initiate the UE Triggered
Service Request procedure (clause 4.2.3.2) with the List Of Allowed PDU
Sessions that, according to UE policies and whether the S-NSSAIs of these PDU
Sessions are within the Allowed NSSAI for 3GPP access, can be re-activated
over the 3GPP access. If there is no PDU Session that can be re-activated over
the 3GPP access, the UE include an empty List Of Allowed PDU Sessions. When
the AMF receives the Service Request message and the List of Allowed PDU
Sessions provided by the UE does not include the PDU Session for which the UE
was notified, the AMF notifies the SMF that the UE was reachable but did not
accept to re-activate the PDU Session by invoking Namf_EventExposure_Notify
service. If the AMF receives a Service Request message from the UE via
non-3GPP access as described in clause 4.12.4.1 (e.g. because the UE
successfully connects to a non-3GPP access), the AMF stops the Notification
timer and processes the received Service Request procedure.
If the UE is in CM-IDLE state in 3GPP access and in CM-CONNECTED state in
non-3GPP access, upon reception of NAS Notification message over non-3GPP
access identifying the 3GPP access type, the UE shall initiate the UE
triggered Service Request procedure (clause 4.2.3.2) over the 3GPP access when
3GPP access is available. If the AMF does not receive the Service Request
message before Notification timer expires, the AMF may either page the UE
through 3GPP access or notify the SMF that the UE was not able to re-activate
the PDU Session.
7\. The UPF transmits the buffered downlink data toward UE via (R)AN node
which performed the Service Request procedure.
The network also sends downlink signalling to the UE if the procedure is
triggered due to request from other NFs, as described in step 3a.
### 4.2.4 UE Configuration Update
#### 4.2.4.1 General
UE configuration may be updated by the network at any time using UE
Configuration Update procedure. UE configuration includes:
\- Access and Mobility Management related parameters decided and provided by
the AMF. This includes the Configured NSSAI and its mapping to the Subscribed
S-NSSAIs, the Allowed NSSAI and its mapping to Subscribed S-NSSAIs.
\- UE Policy provided by the PCF.
When AMF wants to change the UE configuration for access and mobility
management related parameters the AMF initiates the procedure defined in
clause 4.2.4.2. When the PCF wants to change or provide new UE Policies in the
UE, the PCF initiates the procedure defined in clause 4.2.4.3.
If the UE Configuration Update procedure requires the UE to initiate a
Registration procedure, the AMF indicates this to the UE explicitly.
#### 4.2.4.2 UE Configuration Update procedure for access and mobility
management related parameters
This procedure is initiated by the AMF when the AMF wants to update access and
mobility management related parameters in the UE configuration.
This procedure is also used to trigger UE to perform, based on network
indication, either Mobility Registration Update procedure while the UE is in
CM-CONNECTED state to modify NAS parameters that require negotiation (e.g.
MICO mode) or Mobility Registration Update procedure after the UE enters CM-
IDLE state (e.g. for changes to Allowed NSSAI that require re-registration).
If a Registration procedure is needed, the AMF provides an indication to the
UE to initiate a Registration procedure.
UE Configuration Update shall be sent over the Access Type (i.e. 3GPP access
or non-3GPP access) the UE Configuration Update is applied to, when
applicable. If the AMF wants to update NAS parameters in the UE which require
UE acknowledgement, then the AMF provides an indication to the UE of whether
the UE shall acknowledge the command or not. The AMF should not request
acknowledgement of the NITZ command. The AMF shall request acknowledgement for
NSSAI information (e.g. Allowed NSSAI), 5G-GUTI, TAI List and Mobility
Restrictions, LADN Information, MICO, Operator-defined access category
definitions and SMS subscription.
Figure 4.2.4.2-1: UE Configuration Update procedure for access and mobility
management related parameters
0\. AMF determines the necessity of UE configuration change due to various
reasons (e.g. UE mobility change, NW policy, reception of Subscriber Data
Update Notification from UDM, change of Network Slice configuration) or that
the UE needs to perform a Registration Procedure. If a UE is in CM-IDLE, the
AMF can wait until the UE is in CM-CONNECTED state or triggers Network
Triggered Service Request (in clause 4.2.3.3).
NOTE 1: It is up to the network implementation whether the AMF can wait until
the UE is in CM-CONNECTED state or trigger the Network Triggered Service
Request.
NOTE 2: The AMF can check whether Network Slice configuration needs to be
updated by using the Nnssf_NSSelection_Get service operation and in such case
the AMF compares the stored information with the output from the NSSF to
decide whether an update of the UE is required.
The AMF may include Mobility Restriction List in N2 message that delivers UE
Configuration Update Command to the UE if the service area restriction for the
UE is updated.
1\. The AMF sends UE Configuration Update Command containing one or more UE
parameters (Configuration Update Indication, 5G-GUTI, TAI List, Allowed NSSAI,
Mapping Of Allowed NSSAI, Configured NSSAI for the Serving PLMN, Mapping Of
Configured NSSAI, rejected S-NSSAIs, NITZ, Mobility Restrictions, LADN
Information, MICO, Operator-defined access category definitions, SMS
Subscribed Indication) to UE. Optionally, the AMF may update the rejected
S-NSSAIs in the UE Configuration Update command.
The AMF includes one or more of 5G-GUTI, TAI List, Allowed NSSAI, Mapping Of
Allowed NSSAI, Configured NSSAI for the Serving PLMN, Mapping Of Configured
NSSAI, rejected S-NSSAIs, NITZ (Network Identity and Time Zone), Mobility
Restrictions parameters, LADN Information, Operator-defined access category
definitions or SMS Subscribed Indication if the AMF wants to update these NAS
parameters without triggering a UE Registration procedure.
The AMF may include in the UE Configuration Update Command also Configuration
Update Indication parameters indicating whether:
\- Network Slicing Subscription Change has occurred;
\- the UE shall acknowledge the command; and
\- whether a Registration procedure is requested.
If the AMF indicates Network Slicing Subscription Change, then the UE shall
locally erase all the network slicing configuration for all PLMNs and, if
applicable, update the configuration for the current PLMN based on any
received information. If the AMF indicates Network Slicing Subscription
Change, the UE shall also be requested to acknowledge in step 2.
2a. If the UE Configuration Update Indication requires acknowledgement of the
UE Configuration Update Command, then the UE shall send a UE Configuration
Update complete message to the AMF. The AMF should request acknowledgement for
all UE Configuration Updates, except when only NITZ is provided. If
Registration procedure is not required, steps 3a, 3b, 3c and step 4 are
skipped. If the Configuration Update Indication is included in the UE
Configuration Update Command message and it requires a Registration procedure,
depending on the other NAS parameters included in the UE Configuration Update
command, the UE shall execute steps 3a or 3b or 3c+4 as applicable.
2b. [Conditional] The AMF also uses the Nudm_SDM_Info service operation to
provide an acknowledgment to UDM that the UE received the Network Slicing
Subscription Change Indication (if this was indicated in step 1) and acted
upon it.
2c. [Conditional] If the AMF has reconfigured the 5G-GUTI over 3GPP access,
the AMF informs the NG-RAN of the new UE Identity Index Value (derived from
the new 5G-GUTI) when the AMF receives the acknowledgement from the UE in step
2a.
[Conditional] If the UE is registered to the same PLMN via both 3GPP and
non-3GPP access and if the AMF has reconfigured the 5G-GUTI over non-3GPP
access and the UE is in CM-CONNECTED state over 3GPP access, then the AMF
informs the NG-RAN of the new UE Identity Index Value (derived from the new
5G-GUTI) when the AMF receives the acknowledgement from the UE in step 2a.
2d [Conditional] If the UE is configured with a new 5G-GUTI in step 2a via
non-3GPP access and the UE is registered to the same PLMN via both 3GPP and
non-3GPP access, then the UE passes the new 5G-GUTI to its 3GPP access\' lower
layers.
If the UE is configured with a new 5G-GUTI in step 2a over the 3GPP access,
the UE passes the new 5G-GUTI to its 3GPP access\' lower layers.
NOTE 3: Steps 2c and 2d are needed because the NG-RAN may use the RRC Inactive
state and a part of the 5G-GUTI is used to calculate the Paging Frame (see TS
38.304 [44] and TS 36.304 [43]). It is assumed that the UE Configuration
Update Complete is reliably delivered to the AMF after the 5G-AN has
acknowledged its receipt to the UE.
3a. If only NAS parameters that can be updated without transition from CM-IDLE
are included, e.g. MICO mode, the UE shall initiate a Registration procedure
immediately after the acknowledgement to re-negotiate the updated NAS
parameter(s) with the network. Steps 3b, 3c and step 4 are skipped.
3b. If a new Allowed NSSAI and/or a new Mapping Of Allowed NSSAI and/or a new
Configured NSSAI provided by the AMF to the UE does not affect the existing
connectivity to slices (i.e. any S-NSSAI(s) the UE is connected to), the AMF
needs not release the NAS signalling connection for the UE after receiving the
acknowledgement in step 2 and immediate registration is not required. The UE
can start immediately using the new Allowed NSSAI and/or the new Mapping Of
Allowed NSSAI. The UE cannot connect to an S-NSSAI included in the new
Configured NSSAI for the Serving PLMN but not included in the new Allowed
NSSAI until the UE performs a Registration procedure and includes a Requested
NSSAI based on the new Configured NSSAI, following the requirements described
in clause 5.15.5.2 of TS 23.501 [2]. Steps 3c and 4 are skipped.
3c. If a new Allowed NSSAI and/or a new Mapping Of Allowed NSSAI and/or a new
Configured NSSAI provided by the AMF to the UE affects ongoing existing
connectivity to Network Slices, then the AMF also includes in the UE
Configuration Update Command message a new Allowed NSSAI with, if available,
the associated Mapping Of Allowed NSSAI.
If the AMF cannot determine the new Allowed NSSAI after the Subscribed
S-NSSAI(s) are updated, then the AMF does not include in the UE Configuration
Update Command message any Allowed NSSAI. The AMF provides an indication that
the UE shall initiate a Registration procedure. After receiving the
acknowledgement in step 2, the AMF shall release the NAS signalling connection
for the UE, unless there is one established PDU Sessions associated with
regulatory prioritized services. If there is one established PDU Session
associated with regulatory prioritized services, the AMF informs SMFs to
release the PDU Session(s) associated with non-regulatory prioritized services
for this UE (see clause 4.3.4).
The AMF shall reject any NAS Message from the UE carrying PDU Session
Establishment Request for a non-emergency PDU Session before the required
Registration procedure has been successfully completed by the UE.
4\. The UE initiates the appropriate Registration procedure (see clauses
4.2.2.2.2 and 4.13.3.1) after the UE enters CM-IDLE state and does not include
the 5G-S-TMSI or GUAMI in Access Stratum signalling. If there is an
established PDU Session associated with emergency service and the UE has
received an indication to perform the Registration procedure, the UE shall
initiate the Registration procedure only after the PDU Session associated with
emergency service is released.
NOTE 4: Receiving UE Configuration Update command without an indication
requesting to perform re-registration, can still trigger Registration
procedure by the UE for other reasons.
#### 4.2.4.3 UE Configuration Update procedure for transparent UE Policy
delivery
This procedure is initiated when the PCF wants to update UE access selection
and PDU Session selection related policy information (i.e. UE policy) in the
UE configuration. In the non-roaming case the V-PCF is not involved and the
role of the H-PCF is performed by the PCF. For the roaming scenarios, the
V-PCF interacts with the AMF and the H-PCF interacts with the V-PCF.
Figure 4.2.4.3-1: UE Configuration Update procedure for transparent UE Policy
delivery
0\. PCF decides to update UE policy procedures based on triggering conditions
such as an initial registration, registration with 5GS when the UE moves from
EPS to 5GS, or need for updating UE policy as follows:
\- For the case of initial registration and registration with 5GS when the UE
moves from EPS to 5GS, the PCF compares the list of PSIs included in the UE
access selection and PDU session selection related policy information in
Npcf_UEPolicyControl_Create request and determines whether UE access selection
and PDU Session selection related policy information have to be updated and be
provided to the UE via the AMF using DL NAS TRANSPORT message; and
\- For the network triggered UE policy update case (e.g. the change of UE
location, the change of Subscribed S-NSSAIs as described in clause 6.1.2.2.2
of TS 23.503 [20]), the PCF checks the latest list of PSIs to decide which UE
access selection and/or PDU Session selection related policies have to be sent
to the UE.
The PCF checks if the size of the resulting UE access selection and PDU
Session selection related policy information exceeds a predefined limit:
\- If the size is under the limit, then UE access selection and PDU Session
selection related policy information are included in a single
Namf_Communication_N1N2MessageTransfer service operation as described below.
\- If the size exceeds the predefined limit, the PCF splits the UE access
selection and PDU Session selection related policy information in smaller,
logically independent UE access selection and PDU Session selection related
policy information ensuring the size of each is under the predefined limit.
Each UE access selection and PDU Session selection related policy information
will be then sent in separated Namf_Communication_N1N2MessageTransfer service
operations as described below.
NOTE 1: NAS messages from AMF to UE do not exceed the maximum size limit
allowed in NG-RAN (PDCP layer), so the predefined size limit in PCF is related
to that limitation.
NOTE 2: The mechanism used to split the UE access selection and PDU Session
selection related policy information is described in TS 29.507 [32].
1\. PCF invokes Namf_Communication_N1N2MessageTransfer service operation
provided by the AMF. The message includes SUPI, UE Policy Container.
2\. If the UE is registered and reachable by AMF in either 3GPP access or
non-3GPP access, AMF shall transfers transparently the UE Policy container to
the UE via the registered and reachable access.
If the UE is registered in both 3GPP and non-3GPP accesses and reachable on
both access and served by the same AMF, the AMF transfers transparently the UE
Policy container to the UE via one of the accesses based on the AMF local
policy.
If the UE is not reachable by AMF over both 3GPP access and non-3GPP access,
the AMF reports to the PCF that the UE Policy container could not be delivered
to the UE using Namf_Communication_N1N2TransferFailureNotification as in the
step 5 in clause 4.2.3.3.
If AMF decides to transfer transparently the UE Policy container to the UE via
3GPP access, e.g. the UE is registered and reachable by AMF in 3GPP access
only, or if the UE is registered and reachable by AMF in both 3GPP and
non-3GPP accesses served by the same AMF and the AMF decides to transfer
transparently the UE Policy container to the UE via 3GPP access based on local
policy and the UE is in CM-IDLE and reachable by AMF in 3GPP access, the AMF
starts the paging procedure by sending a Paging message described in the step
4b of Network Triggered Service Request (in clause 4.2.3.3). Upon reception of
paging request, the UE shall initiate the UE Triggered Service Request
procedure (clause 4.2.3.2).
3\. If the UE is in CM-CONNECTED over 3GPP access or non-3GPP access, the AMF
transfers transparently the UE Policy container (UE access selection and PDU
Session selection related policy information) received from the PCF to the UE.
The UE Policy container includes the list of Policy Sections as described in
TS 23.503 [20].
4\. The UE updates the UE policy provided by the PCF and sends the result to
the AMF.
5\. If the AMF received the UE Policy container and the PCF subscribed to be
notified of the reception of the UE Policy container then the AMF forwards the
response of the UE to the PCF using Namf_N1MessageNotify.
The PCF maintains the latest list of PSIs delivered to the UE and updates the
latest list of PSIs in the UDR by invoking Nudr_DM_Update (SUPI, Policy Data,
Policy Set Entry, updated PSI data) service operation.
### 4.2.5 Reachability procedures
#### 4.2.5.1 General
Elements of this procedure are used for UDM/NF initiated UE Reachability
Notification requests, e.g. for \"SMS over NAS\".
The procedure applies to UEs that are in RRC-Idle, RRC-Inactive and RRC-
Connected states.
There are two procedures necessary for any service related entity that would
need to be notified by the reachability of the UE:
\- UE Reachability Notification Request procedure; and
\- UE Activity Notification procedure.
#### 4.2.5.2 UE Reachability Notification Request procedure
The UE Reachability Notification Request procedure is illustrated in figure
4.2.5.2-1.
Figure 4.2.5.2-1: UE Reachability Notification Request Procedure
1a. [Conditional] When a service-related entity requests the UDM to provide an
indication regarding UE reachability, the UDM checks whether that service-
related entity is authorized to perform this request on this subscriber. The
service-related entity may subscribe in UDM to receive notifications about UE
Reachability or UE Reachability for SMS delivery events as defined in clause
4.15.3.
NOTE 1: This request for UE Reachability Notification is received in UDM using
different interfaces/services depending on the service-related entity. For
example, an SBI capable service-related entity can use the
Nudm_EventExposure_Subscribe service while an SMS-GMSC uses the procedure as
described in TS 23.040 [7].
The UDM may retrieve from the UDR the list of NF IDs for Network Functions
authorized by the HPLMN to request notifications on this UE\'s reachability.
If the entity is not authorized, the UDM may reject the request (e.g. if the
requesting entity is recognized as being a valid entity, but not authorized
for that subscriber) or discard it silently (e.g. if the requesting entity is
not recognized). Appropriate O&M reports are generated.
1b. [Conditional] The UDM stores the identity of the service-related entity.
In the case that the service-related entity is an SMS-GMSC, the UDM stores the
SC address within the MWD list. Otherwise, if the service-related entity is an
SBI capable service-related entity, the UDM stores the address of the SBI
capable service-related entity in the form of a subscription to the
Nudm_EventExposure service.
If the UE Reachability Notification Request is for SMS over NAS and no SMSF is
registered for the target UE, steps 2 to 4 are skipped.
Otherwise the UDM sets the URRP-AMF flag parameter and continues with step 2.
1c. [Conditional] An NF (e.g. SMF) may subscribe event of UE reachability
status change by using the Namf_EventExposure_Subscribe service operation.
Steps 2 to 4 are skipped.
The AMF invokes the Namf_EventExposure_Notify service operation to report the
current reachability state of a UE to the NF if requested by the consumer NF.
2\. [Conditional] If the value of URRP-AMF flag parameter changes from \"not
set\" to \"set\" and an AMF is registered in the UDM for the target UE, the
UDM initiates Namf_EventExposure_Subscribe service operation for UE
reachability for UE reachable for DL traffic towards the AMF. The UDM may
indicate if direct notification to NF shall be used by the AMF. When direct
notification to NF is indicated to the AMF, the URRP-AMF is not set in the UDM
in step 1a for NF initiated requests.
NOTE 2: The UDM can trigger UE Reachability Notification Request procedure
with two different AMFs for a UE which is connected to 5G Core Network over
3GPP access and non-3GPP access simultaneously. Also, for interworking with
EPC, the UDM/HSS can trigger UE Reachability Notification Request procedure
with MME as described in TS 23.401 [13].
3\. The AMF checks that the requesting entity is authorized to perform this
request on this subscriber.
If the AMF has an MM Context for that user, the AMF stores the NF ID in the
URRP-AMF information, associated with URRP-AMF information flag to indicate
the need to report to the UDM or directly to the NF with a UE Activity
Notification (see clause 4.2.5.3).
4\. [Conditional] For UE reachability for UE reachable for DL traffic, if the
UE state in AMF is in CM-CONNECTED state and the Access Type is 3GPP access,
the AMF initiates N2 Notification procedure (see clause 4.8.3) with reporting
type set to Single RRC-Connected state notification.
#### 4.2.5.3 UE Activity Notification procedure
The UE Activity Notification procedure is illustrated in figure 4.2.5.3-1.
Figure 4.2.5.3-1: UE Activity Procedure
0\. Event has been subscribed in the AMF for UE reachability for DL traffic or
for UE reachability status change.
1a. For a UE in CM-IDLE, the AMF receives (N1) NAS signalling implying UE is
reachable for DL traffic, e.g. a Registration Request or Service Request
message from the UE;
1b. For a UE in CM-CONNECTED, if the AMF has initiated the N2 Notification
procedure in Step 4 of clause 4.2.5.2 and the AMF receives a (N2) UE
Notification (see clause 4.8.3) or a (N2) Path Switch Request (see clause
4.9.1.2) implying UE is reachable for DL traffic from the NG-RAN. Otherwise
(i.e. UE is in CM-CONNECTED and AMF has not initiated N2 Notification
procedure), AMF performs step 2; or
1c. The UE\'s reachability state changes from reachable to unreachable, then
AMF performs step 2.
2a. For event subscription of \"UE reachable for DL traffic\" if the AMF has
an MM context for the UE and the URRP-AMF information flag associated with the
subscribing NF is set to report once that the UE is reachable for DL traffic,
the AMF initiates the Namf_EventExposure_Notify service operation (SUPI, UE-
Reachable) message (or Nudm_UECM_Registration service operation when
applicable) to the UDM following step 1a or 1b. The AMF clears the
corresponding URRP-AMF information if applicable for the UE.
2a1. When the UDM receives the Namf_EventExposure_Notify service operation
(SUPI, UE-Reachable) message or Nudm_UECM_Registration service for a UE that
has URRP-AMF information flag set in the UDM, it triggers appropriate
notifications to the service-related entities associated with the URRP-AMF
information flag that have subscribed to the UDM for this notification.
If SMSF is registered, it also triggers appropriate notifications to the
service-related entities associated with the URRP-AMF information flag that
have subscribed to the UDM for UE reachability for SMS delivery notification
(e.g. SMS-GMSC). UDM clears the URRP-AMF information for the UE.
If no SMSF is registered and there are service-related entities subscribed to
the UDM for the UE reachability for SMS delivery notification, the UDM clears
the URRP-AMF information for the UE but does not notify any service-related
entity.
When the UDM receives the Nudm_UECM_Registration request from SMSF for a UE
that has service-related entities subscribed to the UDM for the UE
reachability for SMS delivery notification and no URRP-AMF flag set in the
UDM, the UDM triggers appropriate notifications to the service-related
entities that have subscribed to the UDM for UE reachability for SMS delivery
notification).
NOTE: The UE Reachability Notification is sent by the UDM using different
interfaces/services depending on the service-related entity. For example, an
SBI capable service-related entity can receive the notification using the
Nudm_EventExposure_Notify service operation (if previously subscribed) while
an SMS-SC gets the notification as described in TS 23.040 [7] based on the SC
address stored in the MWD list.
2b. If in step 0 the AMF received Namf_EventExposure_Subscribe_service
operation directly from an NF authorised to receive direct notifications in
the case of UE reachability status change, or the UDM indicated that the
notification needs to be sent directly to the NF in the case of UE
reachability for DL traffic, the AMF initiates the Namf_EventExposure_Notify
service operation (SUPI, UE reachability state) message directly to the NF.
### 4.2.6 AN Release
This procedure is used to release the logical NG-AP signalling connection and
the associated N3 User Plane connections and (R)AN RRC signalling and
resources.
When the NG-AP signalling connection is lost due to (R)AN or AMF failure, the
AN release is performed locally by the AMF or the (R)AN as described in the
procedure flow below without using or relying on any of the signalling shown
between (R)AN and AMF. The AN release causes all UP connections of the UE to
be deactivated.
The initiation of AN release may be due to:
\- (R)AN-initiated with cause e.g. O&M Intervention, Unspecified Failure,
(R)AN (e.g. Radio) Link Failure, User Inactivity, Inter-System Redirection,
request for establishment of QoS Flow for IMS voice, Release due to UE
generated signalling connection release, mobility restriction etc.; or
\- AMF-initiated with cause e.g. Unspecified Failure, etc.
Both (R)AN-initiated and AMF-initiated AN Release procedures are shown in
Figure 4.2.6-1.
For this procedure, the impacted SMF and UPF are all under control of the PLMN
serving the UE, e.g. in Home Routed roaming case the SMF and UPF in HPLMN are
not involved.
Figure 4.2.6-1: AN Release procedure
1\. If there is some confirmed (R)AN conditions (e.g. Radio Link Failure) or
for other (R)AN internal reason, the (R)AN may decide to initiate the UE
context release in the (R)AN. In this case, the (R)AN sends an N2 UE Context
Release Request (Cause, List of PDU Session ID(s) with active N3 user plane)
message to the AMF. Cause indicates the reason for the release (e.g. AN Link
Failure, O&M intervention, unspecified failure, etc.). The List of PDU Session
ID(s) indicates the PDU Sessions served by (R)AN of the UE. This step is
described in clause 8.3.2 of TS 38.413 [10].
2\. AMF to (R)AN: If the AMF receives the N2 UE Context Release Request
message or due to an internal AMF event, including the reception of Service
Request or Registration Request to establish another NAS signalling connection
still via NG-RAN, the AMF sends an N2 UE Context Release Command (Cause) to
the (R)AN. The Cause indicates either the Cause from (R)AN in step 1 or the
Cause due to an AMF event. If the (R)AN is a NG-RAN this step is described in
detail in clause 8.3.3 of TS 38.413 [10]. If the (R)AN is an N3IWF this step
is described in clause 4.12.
If the AMF receives Service Request or Registration Request to establish
another NAS signalling connection still via NG-RAN, after successfully
authenticating the UE, the AMF releases the old NAS signalling connection and
then continues the Service Request or Registration Request procedure.
3\. [Conditional] If the (R)AN connection (e.g. RRC connection or NWu
connection) with the UE is not already released (step 1), either:
a) the (R)AN requests the UE to release the (R)AN connection. Upon receiving
(R)AN connection release confirmation from the UE, the (R)AN deletes the UE\'s
context, or
b) if the Cause in the N2 UE Context Release Command indicates that the UE has
already locally released the RRC connection, the (R)AN locally releases the
RRC connection.
4\. The (R)AN confirms the N2 Release by returning an N2 UE Context Release
Complete (List of PDU Session ID(s) with active N3 user plane, UE Radio
Capability, User Location Information, Age of Location Information) message to
the AMF. The List of PDU Session ID(s) indicates the PDU Sessions served by
(R)AN of the UE. The AMF stores always the latest UE Radio Capability
information received from the NG-RAN node. The N2 signalling connection
between the AMF and the (R)AN for that UE is released. The (R)AN provides the
list of recommended cells / TAs / NG-RAN node identifiers for paging to the
AMF.
If the PLMN has configured secondary RAT usage reporting, the NG-RAN node may
provide RAN usage data Report.
This step shall be performed promptly after step 2, i.e. it shall not be
delayed, for example, in situations where the UE does not acknowledge the RRC
Connection Release.
5\. [Conditional] AMF to SMF: For each of the PDU Sessions in the N2 UE
Context Release Complete, the AMF invokes Nsmf_PDUSession_UpdateSMContext
Request (PDU Session ID, PDU Session Deactivation, Cause, Operation Type, User
Location Information, Age of Location Information, N2 SM Information
(Secondary RAT usage data)). The Cause in step 5 is the same Cause in step 2.
If List of PDU Session ID(s) with active N3 user plane is included in step 1b,
the step 5 to 7 are performed before step 2. The Operation Type is set to \"UP
deactivate\" to indicate deactivation of user plane resources for the PDU
Session.
6a [Conditional] SMF to UPF: N4 Session Modification Request (AN or N3 UPF
Tunnel Info to be removed, Buffering on/off).
The SMF initiates an N4 Session Modification procedure indicating the need to
remove Tunnel Info of AN or UPF terminating N3. Buffering on/off indicates
whether the UPF shall buffer incoming DL PDU or not.
If multiple UPFs are used in the PDU Session and the SMF determines to release
the UPF terminating N3, step 6a is performed towards the UPF (e.g. PSA)
terminating N9 towards the current N3 UPF. The SMF then releases the N4
session towards the N3 UPF (the N4 release is not shown on the call flow).
See clause 4.4 for more details.
If the cause of AN Release is because of User Inactivity, or UE Redirection,
the SMF shall preserve the GBR QoS Flows. Otherwise, the SMF shall trigger the
PDU Session Modification procedure (see clause 4.3.3) for the GBR QoS Flows of
the UE after the AN Release procedure is completed.
6b. [Conditional] UPF to SMF: N4 Session Modification Response acknowledging
the SMF request.
See clause 4.4 for more details.
7\. [Conditional] SMF to AMF: Nsmf_PDUSession_UpdateSMContext Response for
step 5.
Upon completion of the procedure, the AMF considers the N2 and N3 as released
and enters CM-IDLE state.
After completion of the procedure, the AMF reports towards the NF consumers
are triggered for cases in clause 4.15.4.
### 4.2.7 N2 procedures
#### 4.2.7.1 N2 Configuration
At power up, restart and when modifications are applied, the 5G-AN node and
AMF use non-UE related N2 signalling to exchange configuration data. Full
details of this configuration data are specified in TS 38.300 [9], but the
following highlights some aspects.
The AMF supplies the 5G-AN node with information about:
a) the AMF Name and the GUAMI(s) configured on that AMF Name;
b) the set of TNL associations to be established between the NG-RAN node and
the AMF;
c) weight factor associated with each of the TNL association within the AMF;
and
d) weight factor for each AMF Name within the AMF set; and
e) (optional) for each GUAMI(s) configured on that AMF the corresponding
backup AMF Name.
The weight factors are used for load distribution of the initial N2 messages.
The AMF chooses whether or not to use the same TNL association for the initial
N2 message and subsequent messages for that UE. TNL associations configured
with a weight factor set to zero are not permitted for the initial N2 message,
but can be used for subsequent N2 messages.
Deployments that rely solely on 5GC-based load balancing can set the weight
factors associated with TNL associations that are permitted for the initial N2
message to the same value.
#### 4.2.7.2 NGAP UE-TNLA-binding related procedures
##### 4.2.7.2.1 Creating **NGAP UE-TNLA-bindings during Registration and
Service Request**
When a UE connects to the 5GC via a 5G-AN node without a GUAMI or with a GUAMI
not associated with the 5G-AN node, the following steps are performed:
1\. The 5G-AN **node** selects an AMF as defined in clause 6.3.5 of TS 23.501
[2].
2\. The 5G-AN **node** creates an **NGAP UE-TNLA-binding** for the UE by
selecting a TNL association from the available TNL associations permitted for
the initial message e.g. N2 INITIAL UE MESSAGE for the selected AMF, as
defined in clause 5.21.1.3 of TS 23.501 [2] and forwards the UE message to the
AMF via the selected TNL association.
3\. The AMF may decide to use the TNL association selected by the 5G-AN or the
AMF may modify the NGAP UE-TNLA-binding by triangular redirection.
NOTE 1: This process could take place during the Registration procedure (for
Initial Registration, Mobility Registration Update).
4\. The AMF may decide to modify the NGAP UE-TNLA-binding toward other 5G-AN
nodes such as N3IWF. This is done if AMF is changed and old AMF have existing
NGAP UE-TNLA-bindings toward other 5G-AN nodes.
When a UE connects to the 5GC via a 5G-AN node with a 5G-S-TMSI or GUAMI
associated with the AMF usable by the 5G-AN node, the following steps are
performed:
1\. The 5G-AN node creates an **NGAP UE-TNLA-binding** for the UE by selecting
a TNL association from the available TNL associations permitted for the
initial N2 message for the AMF identified by the UE\'s 5G-S-TMSI or GUAMI.
2\. The AMF may decide to use the TNL association selected by the 5G-AN or the
AMF may modify the NGAP UE-TNLA-binding by triangular redirection.
NOTE 2: This process could take place during the Registration procedure or
Service Request procedure.
##### 4.2.7.2.2 Creating NGAP UE-TNLA-bindings during handovers
During an Xn-based inter NG-RAN node handover, the following applies
\- If an NGAP UE-TNLA-binding exists for a UE, the source 5G-AN **node**
supplies the target 5G-AN **node** with the corresponding TNL address of the
AMF for the currently used TNL association.
\- If the target 5G-AN receives the TNL address of the AMF from the source
5G-AN node, the target 5G-AN **node** establishes a TNL association towards
the TNL address received from the source 5G-AN **node** , creates an **NGAP
UE-TNLA-binding to this TNL association and sends the N2 Path Switch Request
via this TNL association.**
\- If the target 5G-AN does not receive the TNL address of the AMF from the
source 5G-AN node, the 5G-AN node creates an **NGAP UE-TNLA-binding** for the
UE by selecting a TNL association from the available TNL associations
permitted for the initial N2 message for the AMF identified by the UE\'s
GUAMI.
\- The AMF may decide to use the TNL association selected by the 5G-AN or the
AMF may modify the NGAP UE-TNLA-binding by triangular redirection.
During an inter NG-RAN node handover without Xn interface (i.e. during an N2
handover) the following applies:
\- If an NGAP UE-TNLA-binding exists for a UE, the source 5G-AN **node** sends
the N2 Handover Required message using the corresponding TNL address of the
AMF.
\- Otherwise the 5G-AN node creates an **NGAP UE-TNLA-binding** for the UE by
selecting a TNL association from the available TNL associations permitted for
the initial N2 message for the AMF identified by the UE\'s GUAMI.
**\- The target AMF selects** a TNL association from the available TNL
associations for the target 5G-AN **node** and sends the N2 Handover Request
message via this TNL association. The target 5G-AN **node** creates an **NGAP
UE-TNLA-binding** for the UE based on the TNL association selected by the
target AMF.
##### 4.2.7.2.3 Re-Creating NGAP UE-TNLA-bindings subsequent to NGAP UE-TNLA-
binding release
**If the AMF has released the NGAP UE-TNLA-binding in the 5G-AN node for a UE
and the 5G-AN node needs to send an N2 message for this UE, the following
applies:**
\- The 5G-AN node checks the GUAMI stored in the UE context and the associated
AMF:
\- If the GUAMI is available, 5G-AN selects the AMF which owns that GUAMI.
\- If GUAMI has been marked as unavailable (i.e. based on AMF unavailable
status indication received from AMF) but one corresponding target AMF has been
indicated, 5G-AN selects that target AMF even if the GUAMI has not been
updated as available by the target AMF.
\- If GUAMI has been marked as unavailable (i.e. based on AMF unavailable
status indication received from AMF) and no corresponding target AMF has been
indicated, the 5G-AN selects an AMF from the AMF Set based on AMF Set ID of
the GUAMI, as defined in clause 6.3.5 of TS 23.501 [2].
\- The 5G-AN node creates an NGAP UE-TNLA-binding for the UE by selecting a
TNL association from the available TNL associations permitted for the initial
N2 message with the selected AMF, as defined in clause 5.21.1.3 of TS 23.501
[2] and sends the N2 message to the AMF via the selected TNL association.
\- The AMF may decide to use the TNL association selected by the 5G-AN or the
AMF may modify the NGAP UE-TNLA-binding by triangular redirection.
**If the NGAP UE-TNLA-binding has been released for a UE and the AMF needs to
send an N2 message for this UE, the following applies:**
**\- The AMF selects** a TNL association from the available TNL associations
for the target 5G-AN **node** and sends the N2 message via this TNL
association. The target 5G-AN **node** creates an **NGAP UE-TNLA-binding** for
the UE based on the TNL association selected by the AMF.
The TNL association chosen by the AMF always takes precedence.
NOTE: This addresses situations where 5G-AN node and AMF select a TNL
association for a UE concurrently.
##### 4.2.7.2.4 **NGAP UE-TNLA-binding update procedure**
At any time the AMF may decide to re-bind the NGAP UE association to a new TNL
association either:
\- by sending a UE-specific NGAP message on a new TNL association (triangular
redirection), or
\- by **sending** a UE-specific NGAP UE-TNLA binding release message to 5G-AN
and the 5G-AN node updates the NGAP UE-TNLA binding with the new TNL
association.
##### 4.2.7.2.5 **NGAP UE-TNLA-binding per UE Release procedure**
At any time the AMF may decide to release the NGAP UE-TNLA binding while
keeping the UE in CM-CONNECTED state while keeping the corresponding N3
interface. The AMF releases the NGAP UE-TNLA binding by sending a UE-specific
NGAP UE-TNLA binding release message on the current TNL association.
If the AMF releases the NGAP UE-TNLA-binding without sending AMF unavailable
status indication, then the AN may immediately trigger creation of a new NGAP-
UE-TNLA-binding with the same AMF for subsequent N2 messages or may leave the
NGAP UE association without NGAP UE-TNLA-binding. In the latter case the new
NGAP UE-TNLA-binding is re-created upon the subsequent AN-initiated or AMF-
initiated UE-specific N2 signalling as specified in clause 4.2.7.2.3.
If the AMF releases the NGAP UE-TNLA-binding after AMF unavailable status
indication, then the AN has to re-create the NGAP-UE-TNLA-binding with a
different AMF. The 5G-AN re-creates N2AP UE-TNLA-binding for subsequent N2
messages for the given UE as specified in clause 4.2.7.2.3.
#### 4.2.7.3 AMF Failure or Planned Maintenance handling procedure
For UE(s) in CM-CONNECTED state:
\- If AMF failure is detected by 5G-AN, all NGAP UE TNLA binding for UEs
served by that AMF are released.
\- If AMF becomes unavailable due to planned maintenance, the AMF notifies the
5G-AN about the unavailable GUAMI(s) and provides optionally a target AMF Name
corresponding to each unavailable GUAMI. The 5G-AN releases all NGAP UE TNLA
binding of the UEs related to the indicated unavailable GUAMI(s) unless the
notification from the AMF includes an indicator that the AMF will rebind or
release the NGAP UE TNLA binding on a per UE-basis. In that case, if 5G-AN
supports, the 5G-AN waits the release until the timer expires so that the AMF
may release or rebind the N2AP UE-TNLA binding on per UE-basis.
\- For the release NGAP TNLA binding, the affected UE is kept in CM-CONNECTED
state and the corresponding N3 interface is also kept.
For UE(s) in CM-IDLE state, when it subsequently returns from CM-IDLE state
and the 5G-AN receives an initial NAS message with a 5G S-TMSI or GUAMI, the
5G-AN uses 5G S-TMSI or GUAMI to select the target AMF, the 5G-AN forwards N2
message.
### 4.2.8 Void
### 4.2.8a UE Capability Match Request procedure
If the AMF requires more information on the UE radio capabilities support to
be able to set the IMS voice over PS Session Supported Indication (see clause
5.16.3 of TS 23.501 [2]), then the AMF may send a UE Radio Capability Match
Request message to the NG-RAN. This procedure is typically used during the
registration procedure or when AMF has not received the Voice Support Match
Indicator (as part of the 5GMM Context).
Figure 4.2.8a-1: UE Capability Match Request
1\. The AMF indicates whether the AMF wants to receive Voice support match
indicator. The AMF may include the UE radio capability information it has
previously received from NG-RAN.
2\. Upon receiving the UE Capability Match Request message, if the NG-RAN has
not already received the UE radio capabilities from the UE or from AMF in step
1, the NG-RAN requests the UE to upload the UE radio capability information.
3\. The UE provides the NG-RAN with its UE radio capabilities sending the RRC
UE Capability Information.
4\. The NG-RAN checks whether the UE radio capabilities are compatible with
the network configuration for ensuring voice service continuity of voice calls
initiated in IMS.
For determining the appropriate UE Radio Capability Match Response, the NG-RAN
is configured by the operator to check whether the UE supports certain
capabilities required for Voice continuity of voice calls using IMS PS. In a
shared network, the NG-RAN keeps a configuration separately per PLMN.
NOTE 1: What checks to perform depends on network configuration, i.e.
following are some examples of UE capabilities to be taken into account:
\- E-UTRAN/NG-RAN Voice over PS capabilities;
\- the Radio capabilities for E-UTRAN/NG-RAN FDD and/or TDD; and/or
\- the support of E-UTRAN/NG-RAN frequency bands.
NOTE 2: The network configuration considered in the decision for the Voice
Support Match Indicator is homogenous within a certain area (e.g. AMF set) in
order to guarantee that the Voice Support Match Indicator from the NG-RAN is
valid within such area.
The NG-RAN provides a Voice Support Match Indicator to the AMF to indicate
whether the UE capabilities and networks configuration are compatible for
ensuring voice service continuity of voice calls initiated in IMS.
The AMF stores the received Voice support match indicator in the 5GMM Context
and uses it as an input for setting the IMS voice over PS Session Supported
Indication.
5\. If NG-RAN requested radio capabilities from UE in step 2 and 3, the NG-RAN
also sends the UE radio capabilities to the AMF. The AMF stores the UE radio
capabilities without interpreting them for further provision to the NG-RAN
according to clause 5.4.4.1 of TS 23.501 [2].
NOTE 3: Steps 4 and 5 could be received by the AMF in any order.
## 4.3 Session Management procedures
### 4.3.1 General
Clause 4.3 defines the Session Management related procedures. It refers to
clause 4.4 for the N4 interactions.
As defined in clause 5.6.3 of TS 23.501 [2], considering the case of Home
Routed PDU Session, the NAS SM information processing by SMF considers
following kind of NAS SM information:
\- Information that both the V-SMF and H-SMF process: indication of the nature
of the NAS SM signalling (e.g. PDU Session Establishment Request), PDU Session
Type, Session-AMBR, UE addressing information (allocated IPv4 address,
interface identifier).
\- Information that is not visible to the V-SMF, only processed by the H-SMF:
SSC mode, Protocol Configuration Options, SM PDU DN Request Container, QoS
Rule(s) and QoS Flow level QoS parameters if any for the QoS Flow(s)
associated with the QoS rule(s).
NOTE 1: \"Information that is not visible to the V-SMF\" refers to information
that the V-SMF is to relay between the UE and the H-SMF (and that it can store
in CDR) but that the V-SMF is not assumed to process otherwise.
The NAS SM information processing split between V-SMF and H-SMF is transparent
to the UE.
Both V-SMF and H-SMF process information interpreted by the AMF as the PDU
Session ID, the DNN, the S-NSSAI (with values for the Serving PLMN and HPLMN
processed by the V-SMF and with a value for the HPLMN processed by the H-SMF).
In the case of Home Routed PDU Session the H-SMF provides also the V-SMF with
the IPv6 Prefix allocated to the PDU Session.
NOTE 2: IPv6 Prefix allocated to the PDU Session is provided to allow the
V-SMF fulfilling regulatory requirements for data storage in the visited
country.
In non-roaming and LBO cases the SMF processes all NAS SM information.
In HR roaming scenarios, in order to support SM features only requiring
support from the H-SMF without impacting the V-SMF, as specified in detail in
TS 29.502 [36]:
\- The V-SMF transfers NAS SM information, which is not visible to the V-SMF,
in a container towards the H-SMF;
\- The V-SMF transfers NAS SM information which it does not comprehend
(unknown IEs or IEs with an unknown value not set to \"reserved\" according to
the release to which the V-SMF complies), in a different container towards the
H-SMF;
\- The H-SMF transfers NAS SM information which the V-SMF does not need to
interpret, in one container towards the V-SMF;
\- The V-SMF appends unknown NAS SM information received in the N16 container
at the end of the NAS SM message it sends to the UE.
### 4.3.2 PDU Session Establishment
#### 4.3.2.1 General
A PDU Session establishment may correspond to:
\- a UE initiated PDU Session Establishment procedure.
\- a UE initiated PDU Session handover between 3GPP and non-3GPP.
\- a UE initiated PDU Session handover from EPS to 5GS.
\- a Network triggered PDU Session Establishment procedure. In this case the
network sends the device trigger message to application(s) on the UE side. The
payload included in Device Trigger Request message contains information on
which application on the UE side is expected to trigger the PDU Session
establishment request. Based on that information, the application(s) on the UE
side trigger the PDU Session Establishment procedure. For more detail refer to
clause 4.13.2.
If the UE is simultaneously registered to a non-3GPP access via a N3IWF
located in a PLMN different from the PLMN of the 3GPP access, the functional
entities in the following procedures are located in the PLMN of the access
used to exchange NAS with the UE for the PDU Session.
#### 4.3.2.2 UE Requested PDU Session Establishment
##### 4.3.2.2.1 Non-roaming and Roaming with Local Breakout
Clause 4.3.2.2.1 specifies PDU Session establishment in the non-roaming and
roaming with local breakout cases. The procedure is used to:
\- Establish a new PDU Session;
\- Handover a PDN Connection in EPS to PDU Session in 5GS without N26
interface;
\- Switching an existing PDU Session between non-3GPP access and 3GPP access.
The specific system behaviour in this case is further defined in clause 4.9.2;
or
\- Request a PDU Session for Emergency services.
In the case of roaming, the AMF determines if a PDU Session is to be
established in LBO or Home Routing. In the case of LBO, the procedure is as in
the case of non-roaming with the difference that the AMF, the SMF, the UPF and
the PCF are located in the visited network. PDU Sessions for Emergency
services are never established in Home Routed mode.
NOTE 1: UE provides both the S-NSSAIs of the Home PLMN and Visited PLMN to the
network as described in clause 5.15.5.3 of TS 23.501 [2].
Figure 4.3.2.2.1-1: UE-requested PDU Session Establishment for non-roaming and
roaming with local breakout
The procedure assumes that the UE has already registered on the AMF thus
unless the UE is Emergency Registered the AMF has already retrieved the user
subscription data from the UDM.
1\. From UE to AMF: NAS Message (S-NSSAI(s), DNN, PDU Session ID, Request
type, Old PDU Session ID, N1 SM container (PDU Session Establishment
Request)).
In order to establish a new PDU Session, the UE generates a new PDU Session
ID.
The UE initiates the UE Requested PDU Session Establishment procedure by the
transmission of a NAS message containing a PDU Session Establishment Request
within the N1 SM container. The PDU Session Establishment Request includes a
PDU session ID, Requested PDU Session Type, a Requested SSC mode, 5GSM
Capability PCO, SM PDU DN Request Container, Number Of Packet Filters, UE
Integrity Protection Maximum Data Rate and optionally Always-on PDU Session
Requested.
The Request Type indicates \"Initial request\" if the PDU Session
Establishment is a request to establish a new PDU Session and indicates
\"Existing PDU Session\" if the request refers to an existing PDU Session
switching between 3GPP access and non-3GPP access or to a PDU Session handover
from an existing PDN connection in EPC. If the request refers to an existing
PDN connection in EPC, the S-NSSAI is set as described in clause 5.15.7.2 of
TS 23.501 [2].
When Emergency service is required and an Emergency PDU Session is not already
established, a UE shall initiate the UE Requested PDU Session Establishment
procedure with a Request Type indicating \"Emergency Request\".
The Request Type indicates \"Emergency Request\" if the PDU Session
Establishment is a request to establish a PDU Session for Emergency services.
The Request Type indicates \"Existing Emergency PDU Session\" if the request
refers to an existing PDU Session for Emergency services switching between
3GPP access and non-3GPP access or to a PDU Session handover from an existing
PDN connection for Emergency services in EPC.
The 5GSM Core Network Capability is provided by the UE and handled by SMF as
defined in clause 5.4.4b of TS 23.501 [2].
The Number Of Packet Filters indicates the number of supported packet filters
for signalled QoS rules for the PDU Session that is being established. The
number of packet filters indicated by the UE is valid for the lifetime of the
PDU Session.
The UE Integrity Protection Maximum Data Rate indicates the maximum data rate
up to which the UE can support UP integrity protection. The UE shall provide
the UE Integrity Protection Data Rate capability independently of the Access
Type over which the UE sends the PDU Session Establishment Request.
The NAS message sent by the UE is encapsulated by the AN in a N2 message
towards the AMF that should include User location information and Access Type
Information.
The PDU Session Establishment Request message may contain SM PDU DN Request
Container containing information for the PDU Session authorization by the
external DN.
The UE includes the S-NSSAI from the Allowed NSSAI of the current access type.
If the Mapping of Allowed NSSAI was provided to the UE, the UE shall provide
both the S-NSSAI of the VPLMN from the Allowed NSSAI and the corresponding
S-NSSAI of the HPLMN from the Mapping Of Allowed NSSAI.
If the procedure is triggered for SSC mode 3 operation, the UE shall also
include the Old PDU Session ID which indicates the PDU Session ID of the on-
going PDU Session to be released, in NAS message. The Old PDU Session ID is an
optional parameter which is included only in this case.
The AMF receives from the AN the NAS SM message (built in step 1) together
with User Location Information (e.g. Cell Id in the case of the NG-RAN).
The UE shall not trigger a PDU Session establishment for a PDU Session
corresponding to a LADN when the UE is outside the area of availability of the
LADN.
If the UE is establishing a PDU session for IMS and the UE is configured to
discover the P-CSCF address during connectivity establishment, the UE shall
include an indicator that it requests a Pâ€‘CSCF IP address(es) within the SM
container.
The PS Data Off status is included in the PCO in the PDU Session Establishment
Request message.
If the UE requests to establish always-on PDU session, the UE includes an
Always-on PDU Session Requested indication in the PDU Session Establishment
Request message.
2\. The AMF determines that the message corresponds to a request for a new PDU
Session based on that Request Type indicates \"initial request\" and that the
PDU Session ID is not used for any existing PDU Session(s) of the UE. If the
NAS message does not contain an S-NSSAI, the AMF determines a default S-NSSAI
of the HPLMN for the requested PDU Session either according to the UE
subscription, if it contains only one default S-NSSAI, or based on operator
policy and, in the case of LBO, an S-NSSAI of the Serving PLMN which matches
the S-NSSAI of the HPLMN. When the NAS Message contains an S-NSSAI of the
Serving PLMN but it does not contain a DNN, the AMF determines the DNN for the
requested PDU Session by selecting the default DNN for this S-NSSAI if the
default DNN is present in the UE\'s Subscription Information (or for the
corresponding S-NSSAI of the HPLMN, in the case of LBO); otherwise the serving
AMF selects a locally configured DNN for this S-NSSAI of the Serving PLMN. If
the AMF cannot select an SMF (e.g. the UE provided DNN is not supported by the
network, or the UE provided DNN is not in the Subscribed DNN List for the
S-NSSAI (or its mapped value for the HPLMN in the case of LBO) and wildcard
DNN is not included in the Subscribed DNN list), the AMF shall reject the NAS
Message containing PDU Session Establishment Request from the UE with an
appropriate cause
The AMF selects an SMF as described in clause 6.3.2 of TS 23.501 [2] and
clause 4.3.2.2.3. If the Request Type indicates \"Initial request\" or the
request is due to handover from EPS or from non-3GPP access serving by a
different AMF, the AMF stores an association of the S-NSSAI(s), the DNN, the
PDU Session ID, the SMF ID as well as the Access Type of the PDU Session.
If the Request Type is \"initial request\" and if the Old PDU Session ID
indicating the existing PDU Session is also contained in the message, the AMF
selects an SMF as described in clause 4.3.5.2 and stores an association of the
new PDU Session ID, the S-NSSAI(s), the selected SMF ID as well as Access Type
of the PDU Session.
If the Request Type indicates \"Existing PDU Session\", the AMF selects the
SMF based on SMF-ID received from UDM. The case where the Request Type
indicates \"Existing PDU Session\" and either the AMF does not recognize the
PDU Session ID or the subscription context that the AMF received from UDM
during the Registration or Subscription Profile Update Notification procedure
does not contain an SMF ID corresponding to the PDU Session ID constitutes an
error case. The AMF updates the Access Type stored for the PDU Session.
If the Request Type indicates \"Existing PDU Session\" referring to an
existing PDU Session moved between 3GPP access and non-3GPP access, then if
the Serving PLMN S-NSSAI of the PDU Session is present in the Allowed NSSAI of
the target access type, the PDU Session Establishment procedure can be
performed in the following cases:
\- the SMF ID corresponding to the PDU Session ID and the AMF belong to the
same PLMN;
\- the SMF ID corresponding to the PDU Session ID belongs to the HPLMN;
Otherwise the AMF shall reject the PDU Session Establishment Request with an
appropriate reject cause.
NOTE 2: The SMF ID includes the PLMN ID that the SMF belongs to.
The AMF shall reject a request coming from an Emergency Registered UE and the
Request Type indicates neither \"Emergency Request\" nor \"Existing Emergency
PDU Session\". When the Request Type indicates \"Emergency Request\", the AMF
is not expecting any S-NSSAI and DNN value provided by the UE and uses locally
configured values instead. The AMF stores the Access Type of the PDU Session.
If the Request Type indicates \"Emergency Request\" or \"Existing Emergency
PDU Session\", the AMF selects the SMF as described in clause 5.16.4 of TS
23.501 [2].
3\. From AMF to SMF: Either Nsmf_PDUSession_CreateSMContext Request (SUPI,
DNN, S-NSSAI(s), PDU Session ID, AMF ID, Request Type, PCF ID, Priority
Access, N1 SM container (PDU Session Establishment Request), User location
information, Access Type, PEI, GPSI, UE presence in LADN service area,
Subscription For PDU Session Status Notification, DNN Selection Mode, Trace
Requirements) or Nsmf_PDUSession_UpdateSMContext Request (SUPI, DNN,
S-NSSAI(s), SM Context ID, AMF ID, Request Type, N1 SM container (PDU Session
Establishment Request), User location information, Access Type, RAT type,
PEI).
If the AMF does not have an association with an SMF for the PDU Session ID
provided by the UE (e.g. when Request Type indicates \"initial request\"), the
AMF invokes the Nsmf_PDUSession_CreateSMContext Request, but if the AMF
already has an association with an SMF for the PDU Session ID provided by the
UE (e.g. when Request Type indicates \"existing PDU Session\"), the AMF
invokes the Nsmf_PDUSession_UpdateSMContext Request.
The AMF sends the S-NSSAI of the Serving PLMN from the Allowed NSSAI to the
SMF. For roaming scenario in local breakout (LBO), the AMF also sends the
corresponding S-NSSAI of the HPLMN from the Mapping Of Allowed NSSAI to the
SMF.
The AMF ID is the UE\'s GUAMI which uniquely identifies the AMF serving the
UE. The AMF forwards the PDU Session ID together with the N1 SM container
containing the PDU Session Establishment Request received from the UE. The
GPSI shall be included if available at AMF.
The AMF determines Access Type and RAT Type based on the Global RAN Node ID
associated with the N2 interface.
The AMF provides the PEI instead of the SUPI when the UE in limited service
state has registered for Emergency services (i.e. Emergency Registered)
without providing a SUPI. The PEI is defined in clause 5.9.3 of TS 23.501 [2].
If the UE in limited service state has registered for Emergency services (i.e.
Emergency Registered) with a SUPI but has not been authenticated the AMF
indicates that the SUPI has not been authenticated. The SMF determines that
the UE has not been authenticated when it does not receive a SUPI for the UE
or when the AMF indicates that the SUPI has not been authenticated.
If the AMF determines that the DNN corresponds to an LADN then the AMF
provides the \"UE presence in LADN service area\" that indicates if the UE is
IN or OUT of the LADN service area.
If the Old PDU Session ID is included in step 1 and if the SMF is not to be
reallocated, the AMF also includes Old PDU Session ID in the
Nsmf_PDUSession_CreateSMContext Request.
DNN Selection Mode is determined by the AMF. It indicates whether an
explicitly subscribed DNN has been provided by the UE in its PDU Session
Establishment Request.
The SMF may use DNN Selection Mode when deciding whether to accept or reject
the UE request.
When the Establishment cause received as part of AN parameters during the
Registration procedure or Service Request procedure is associated with
priority services (e.g. MPS, MCS), the AMF includes a Message Priority header
to indicate priority information. The SMF uses the Message Priority header to
determine if the UE request is subject to exemption from NAS level congestion
control. Other NFs relay the priority information by including the Message
Priority header in service-based interfaces, as specified in TS 29.500 [17].
In the local breakout case, if the SMF (in the VPLMN) is not able to process
some part of the N1 SM information that Home Routed Roaming is required and
the SMF responds to the AMF that it is not the right SMF to handle the N1 SM
message by invoking Nsmf_PDUSession_CreateSMContext Response service
operation. The SMF includes a proper N11 cause code triggering the AMF to
proceed with home routed case. The procedure starts again at step 2 of clause
4.3.2.2.2.
The AMF may include a PCF ID in the Nsmf_PDUSession_CreateSMContext Request.
This PCF ID identifies the H-PCF in the non-roaming case and the V-PCF in the
local breakout roaming case.
The AMF includes Trace Requirements if Trace Requirements have been received
in subscription data.
4\. If Session Management Subscription data for corresponding SUPI, DNN and
S-NSSAI of the HPLMN is not available, then SMF retrieves the Session
Management Subscription data using Nudm_SDM_Get (SUPI, Session Management
Subscription data, DNN, S-NSSAI of the HPLMN) and subscribes to be notified
when this subscription data is modified using Nudm_SDM_Subscribe (SUPI,
Session Management Subscription data, DNN, S-NSSAI of the HPLMN). UDM may get
this information from UDR by Nudr_DM_Query (SUPI, Subscription Data, Session
Management Subscription data, DNN, S-NSSAI of the HPLMN) and may subscribe to
notifications from UDR for the same data by Nudr_DM_subscribe.
The SMF may use DNN Selection Mode when deciding whether to retrieve the
Session Management Subscription data e.g. If the (DNN, S-NSSAI of the HPLMN)
is not explicitly subscribed, the SMF may use local configuration instead of
Session Management Subscription data.
If the Request Type in step 3 indicates \"Existing PDU Session\" or \"Existing
Emergency PDU Session\" the SMF determines that the request is due to
switching between 3GPP access and non-3GPP access or due to handover from EPS.
The SMF identifies the existing PDU Session based on the PDU Session ID. In
such a case, the SMF does not create a new SM context but instead updates the
existing SM context and provides the representation of the updated SM context
to the AMF in the response.
If the Request Type is \"Initial request\" and if the Old PDU Session ID is
included in Nsmf_PDUSession_CreateSMContext Request, the SMF identifies the
existing PDU Session to be released based on the Old PDU Session ID.
Subscription data includes the Allowed PDU Session Type(s), Allowed SSC
mode(s), default 5QI and ARP, subscribed Session-AMBR.
Static IP address/prefix may be included in the subscription data if the UE
has subscribed to it.
The SMF checks the validity of the UE request: it checks
\- Whether the UE request is compliant with the user subscription and with
local policies;
\- (If the DNN corresponds to an LADN), whether the UE is located within the
LADN service area based on the \"UE presence in LADN service area\" indication
from the AMF. If the AMF does not provide the \"UE presence in LADN service
area\" indication and the SMF determines that the DNN corresponds to a LADN,
then the SMF considers that the UE is OUT of the LADN service area
If the UE request is considered as not valid, the SMF decides to not accept to
establish the PDU Session.
5\. From SMF to AMF: Either Nsmf_PDUSession_CreateSMContext Response (Cause,
SM Context ID or N1 SM container (PDU Session Reject (Cause))) or an
Nsmf_PDUSession_UpdateSMContext Response depending on the request received in
step 3.
If the SMF received Nsmf_PDUSession_CreateSMContext Request in step 3 and the
SMF is able to process the PDU Session establishment request, the SMF creates
an SM context and responds to the AMF by providing an SM Context ID.
If the UP Security Policy for the PDU Session is determined to have Integrity
Protection set to \"Required\", the SMF may, based on local configuration,
decide whether to accept or reject the PDU Session request based on the UE
Integrity Protection Maximum Data Rate.
NOTE 3: The SMF can e.g. be configured to reject a PDU Session if the UE
Integrity Protection Maximum Data Rate has a very low value, if the services
provided by the DN would require higher bitrates.
When the SMF decides to not accept to establish a PDU Session, the SMF rejects
the UE request via NAS SM signalling including a relevant SM rejection cause
by responding to the AMF with Nsmf_PDUSession_CreateSMContext Response. The
SMF also indicates to the AMF that the PDU Session ID is to be considered as
released, the SMF proceeds to step 20 and the PDU Session Establishment
procedure is stopped.
6\. Optional Secondary authentication/authorization.
If the Request Type in step 3 indicates \"Existing PDU Session\", the SMF does
not perform secondary authentication/authorization.
If the Request Type received in step 3 indicates \"Emergency Request\" or
\"Existing Emergency PDU Session\", the SMF shall not perform secondary
authentication\authorization.
If the SMF needs to perform secondary authentication/authorization during the
establishment of the PDU Session by a DN-AAA server as described in clause
5.6.6 of TS 23.501 [2], the SMF triggers the PDU Session establishment
authentication/authorization as described in clause 4.3.2.3.
7a. If dynamic PCC is to be used for the PDU Session, the SMF performs PCF
selection as described in clause 6.3.7.1 of TS 23.501 [2]. If the Request Type
indicates \"Existing PDU Session\" or \"Existing Emergency PDU Session\", the
SMF shall use the PCF already selected for the PDU Session.
Otherwise, the SMF may apply local policy.
7b. The SMF may perform an SM Policy Association Establishment procedure as
defined in clause 4.16.4 to establish an SM Policy Association with the PCF
and get the default PCC Rules for the PDU Session. The GPSI shall be included
if available at SMF. If the Request Type in step 3 indicates \"Existing PDU
Session\", the SMF may provide information on the Policy Control Request
Trigger condition(s) that have been met by an SMF initiated SM Policy
Association Modification procedure as defined in clause 4.16.5.1. The PCF may
provide policy information defined in clause 5.2.5.4 (and in TS 23.503 [20])
to SMF.
The PCF, based on the Emergency DNN, sets the ARP of the PCC rules to a value
that is reserved for Emergency services as described in TS 23.503 [20].
NOTE 4: The purpose of step 7 is to receive PCC rules before selecting UPF. If
PCC rules are not needed as input for UPF selection, step 7 can be performed
after step 8.
8\. If the Request Type in step 3 indicates \"Initial request\", the SMF
selects an SSC mode for the PDU Session as described in clause 5.6.9.3 of TS
23.501 [2]. The SMF also selects one or more UPFs as needed as described in
clause 6.3.3 of TS 23.501 [2]. In the case of PDU Session Type IPv4 or IPv6 or
IPv4v6, the SMF allocates an IP address/prefix for the PDU Session as
described in clause 5.8.1 of TS 23.501 [2]. In the case of PDU Session Type
IPv6 or IPv4v6, the SMF also allocates an interface identifier to the UE for
the UE to build its link-local address. For Unstructured PDU Session Type the
SMF may allocate an IPv6 prefix for the PDU Session and N6 point-to-point
tunnelling (based on UDP/IPv6) as described in clause 5.6.10.3 of TS 23.501
[2]. For Ethernet PDU Session Type, neither a MAC nor an IP address is
allocated by the SMF to the UE for this PDU Session.
If the Request Type in Step 3 is \"Existing PDU Session\", the SMF maintains
the same IP address/prefix that has already been allocated to the UE in the
source network.
If the Request Type in step 3 indicates \"Existing PDU Session\" referring to
an existing PDU Session moved between 3GPP access and non-3GPP access the SMF
maintains the SSC mode of the PDU Session, the current PDU Session Anchor and
IP address.
NOTE 5: The SMF may decide to trigger e.g. new intermediate UPF insertion or
allocation of a new UPF as described in step 5 in clause 4.2.3.2.
If the Request Type indicates \"Emergency Request\", the SMF selects the UPF
as described in clause 5.16.4 of TS 23.501 [2] and selects SSC mode 1.
9\. SMF may perform an SMF initiated SM Policy Association Modification
procedure as defined in clause 4.16.5.1 to provide information on the Policy
Control Request Trigger condition(s) that have been met. If Request Type is
\"initial request\" and dynamic PCC is deployed and PDU Session Type is IPv4
or IPv6 or IPv4v6, SMF notifies the PCF (if the Policy Control Request Trigger
condition is met) with the allocated UE IP address/prefix(es).
When PCF is deployed, the SMF shall further report the PS Data Off status to
PCF if the PS Data Off Policy Control Request Trigger is provisioned, the
additional behaviour of SMF and PCF for 3GPP PS Data Off is defined in TS
23.503 [20].
NOTE 6: If an IP address/prefix has been allocated before step 7 (e.g.
subscribed static IP address/prefix in UDM/UDR) or the step 7 is perform after
step 8, the IP address/prefix can be provided to PCF in step 7 and the IP
address/prefix notification in this step can be skipped.
PCF may provide updated policies to the SMF. The PCF may provide policy
information defined in clause 5.2.5.4 (and in TS 23.503 [20]) to SMF.
10\. If Request Type indicates \"initial request\", the SMF initiates an N4
Session Establishment procedure with the selected UPF, otherwise it initiates
an N4 Session Modification procedure with the selected UPF:
10a. The SMF sends an N4 Session Establishment/Modification Request to the UPF
and provides Packet detection, enforcement and reporting rules to be installed
on the UPF for this PDU Session. If CN Tunnel Info is allocated by the SMF,
the CN Tunnel Info is provided to UPF in this step. If the selective User
Plane deactivation is required for this PDU Session, the SMF determines the
Inactivity Timer and provides it to the UPF. The SMF provides Trace
Requirements to the UPF if it has received Trace Requirements.
10b. The UPF acknowledges by sending an N4 Session Establishment/Modification
Response. If CN Tunnel Info is allocated by the UPF, the CN Tunnel Info is
provided to SMF in this step.
If multiple UPFs are selected for the PDU Session, the SMF initiate N4 Session
Establishment/Modification procedure with each UPF of the PDU Session in this
step.
If the Request Type indicates \"Existing PDU Session\" and the SMF creates CN
Tunnel Info, then this step is skipped. Otherwise, this step is performed to
obtain the CN Tunnel Info from the UPF using the N4 Session Modification
Procedure.
11\. SMF to AMF: Namf_Communication_N1N2MessageTransfer (PDU Session ID, N2 SM
information (PDU Session ID, QFI(s), QoS Profile(s), CN Tunnel Info, S-NSSAI
from the Allowed NSSAI, Session-AMBR, PDU Session Type, User Plane Security
Enforcement information, UE Integrity Protection Maximum Data Rate), N1 SM
container (PDU Session Establishment Accept (QoS Rule(s) and QoS Flow level
QoS parameters if needed for the QoS Flow(s) associated with the QoS rule(s),
selected SSC mode, S-NSSAI(s), DNN, allocated IPv4 address, interface
identifier, Session-AMBR, selected PDU Session Type, Reflective QoS Timer (if
available), P-CSCF address(es), [Always-on PDU Session]))). If multiple UPFs
are used for the PDU Session, the CN Tunnel Info contain tunnel information
related with the UPF that terminates N3.
The N2 SM information carries information that the AMF shall forward to the
(R)AN which includes:
\- The CN Tunnel Info corresponds to the Core Network address of the N3 tunnel
corresponding to the PDU Session.
\- One or multiple QoS profiles and the corresponding QFIs can be provided to
the (R)AN. This is further described in clause 5.7 of TS 23.501 [2].
\- The PDU Session ID may be used by AN signalling with the UE to indicate to
the UE the association between (R)AN resources and a PDU Session for the UE.
\- A PDU Session is associated to an S-NSSAI of the HPLMN and, if applicable,
to a S-NSSAI of the VPLMN and a DNN. The S-NSSAI provided to the (R)AN, is the
S-NSSAI with the value for the Serving PLMN (i.e. the HPLMN S-NSSAI or, in LBO
roaming case, the VPLMN S-NSSAI).
\- User Plane Security Enforcement information is determined by the SMF as
described in clause 5.10.3 of TS 23.501 [2],
\- If the User Plane Security Enforcement information indicates that Integrity
Protection is \"Preferred\" or \"Required\", the SMF also includes the UE
Integrity Protection Maximum Data Rate as received in the PDU Session
Establishment Request.
The N1 SM container contains the PDU Session Establishment Accept that the AMF
shall provide to the UE. If the UE requested P-CSCF discovery then the message
shall also include the P-CSCF IP address(es) as determined by the SMF. The PDU
Session Establishment Accept includes S-NSSAI from the Allowed NSSAI. For LBO
roaming scenario, the PDU Session Establishment Accept includes the S-NSSAI
from the Allowed NSSAI for the VPLMN and also it includes the corresponding
S-NSSAI of the HPLMN from the Mapping Of Allowed NSSAI that SMF received in
step 3. If the PDU Session being established was requested to be an always-on
PDU Session, the SMF shall indicate whether the request is accepted by
including an Always-on PDU Session Granted indication in the PDU Session
Establishment Accept message. If the PDU Session being established was not
requested to be an always-on PDU Session but the SMF determines that the PDU
Session needs to be established as an always-on PDU Session, the SMF shall
include an Always-on PDU Session Granted indication in the PDU Session
Establishment Accept message indicating that the PDU session is an always-on
PDU Session.
Multiple QoS Rules, QoS Flow level QoS parameters if needed for the QoS
Flow(s) associated with those QoS rule(s) and QoS Profiles may be included in
the PDU Session Establishment Accept within the N1 SM and in the N2 SM
information.
The Namf_Communication_N1N2MessageTransfer contains the PDU Session ID
allowing the AMF to know which access towards the UE to use.
If the PDU session establishment failed anywhere between step 5 and step 11,
then the Namf_Communication_N1N2MessageTransfer request shall include the N1
SM container with a PDU Session Establishment Reject message (see clause 8.3.3
of TS 24.501 [25]) and shall not include any N2 SM container. The (R)AN sends
the NAS message containing the PDU Session Establishment Reject to the UE. In
this case, steps 12-17 are skipped.
12\. AMF to (R)AN: N2 PDU Session Request (N2 SM information, NAS message (PDU
Session ID, N1 SM container (PDU Session Establishment Accept))).
The AMF sends the NAS message containing PDU Session ID and PDU Session
Establishment Accept targeted to the UE and the N2 SM information received
from the SMF within the N2 PDU Session Request to the (R)AN.
13\. (R)AN to UE: The (R)AN may issue AN specific signalling exchange with the
UE that is related with the information received from SMF. For example, in the
case of a NG-RAN, an RRC Connection Reconfiguration may take place with the UE
establishing the necessary NG-RAN resources related to the QoS Rules for the
PDU Session request received in step 12.
(R)AN also allocates (R)AN N3 Tunnel Info for the PDU Session. In the case of
Dual Connectivity, the Master RAN node may assign some (zero or more) QFIs to
be setup to a Master RAN node and others to the Secondary RAN node. The AN
Tunnel Info includes a tunnel endpoint for each involved (R)AN node and the
QFIs assigned to each tunnel endpoint. A QFI can be assigned to either the
Master RAN node or the Secondary RAN node and not to both.
(R)AN forwards the NAS message (PDU Session ID, N1 SM container (PDU Session
Establishment Accept)) provided in step 12 to the UE. (R)AN shall only provide
the NAS message to the UE if the AN specific signalling exchange with the UE
includes the (R)AN resource additions associated to the received N2 command.
If MICO mode is active and the NAS message Request Type in step 1 indicated
\"Emergency Request\", then the UE and the AMF shall locally deactivate MICO
mode.
14\. (R)AN to AMF: N2 PDU Session Response (PDU Session ID, Cause, N2 SM
information (PDU Session ID, AN Tunnel Info, List of accepted/rejected QFI(s),
User Plane Enforcement Policy Notification)).
The AN Tunnel Info corresponds to the Access Network address of the N3 tunnel
corresponding to the PDU Session.
If the (R)AN rejects QFI(s) the SMF is responsible of updating the QoS rules
and QoS Flow level QoS parameters if needed for the QoS Flow associated with
the QoS rule(s) in the UE accordingly.
The NG-RAN rejects the establishment of UP resources for the PDU Session when
it cannot fulfil User Plane Security Enforcement information with a value of
Required. The NG-RAN notifies the SMF when it cannot fulfil a User Plane
Security Enforcement with a value of Preferred.
15\. AMF to SMF: Nsmf_PDUSession_UpdateSMContext Request (SM Context ID, N2 SM
information, Request Type).
The AMF forwards the N2 SM information received from (R)AN to the SMF.
If the list of rejected QFI(s) is included in N2 SM information, the SMF shall
release the rejected QFI(s) associated QoS profiles.
If the User Plane Enforcement Policy Notification in the N2 SM information
indicates that no user plane resources could be established and the User Plane
Enforcement Policy indicated \"required\" as described in clause 5.10.3 of TS
23.501 [2], the SMF shall reject the PDU session establishment by including a
N1 SM container with a PDU Session Establishment Reject message (see clause
8.3.3 of TS 24.501 [25]) in the Nsmf_PDUSession_UpdateSMContext Response in
step 17. Step 16 is skipped in this case.
16a. The SMF initiates an N4 Session Modification procedure with the UPF. The
SMF provides AN Tunnel Info to the UPF as well as the corresponding forwarding
rules.
NOTE 7: If the PDU Session Establishment Request was due to mobility between
3GPP and non-3GPP access or mobility from EPC, the downlink data path is
switched towards the target access in this step.
16b. The UPF provides an N4 Session Modification Response to the SMF.
If multiple UPFs are used in the PDU Session, the UPF in step 16 refers to the
UPF terminating N3.
After this step, the UPF delivers any down-link packets to the UE that may
have been buffered for this PDU Session.
16c. If Request Type in step 3 indicates neither \"Emergency Request\" nor
\"Existing Emergency PDU Session\" and, if the SMF has not yet registered for
this PDU Session, then the SMF registers with the UDM using
Nudm_UECM_Registration (SUPI, DNN, PDU Session ID, SMF Identity) for a given
PDU Session. As a result, the UDM stores following information: SUPI, SMF
identity and the associated DNN and PDU Session ID. The UDM may further store
this information in UDR by Nudr_DM_Update (SUPI, Subscription Data, UE context
in SMF data).
If the Request Type received in step 3 indicates \"Emergency Request\":
\- For an authenticated non-roaming UE, based on operator configuration (e.g.
related with whether the operator uses a fixed SMF for Emergency calls, etc.),
the SMF may register in the UDM using Nudm_UECM_Registration (SUPI, PDU
Session ID, SMF identity, Indication of Emergency Services) for a given PDU
Session that is applicable for emergency services. As a result, the UDM shall
store the applicable PDU Session for Emergency services.
\- For an unauthenticated UE or a roaming UE, the SMF shall not register in
the UDM for a given PDU Session.
17\. SMF to AMF: Nsmf_PDUSession_UpdateSMContext Response (Cause).
The SMF may subscribe to the UE mobility event notification from the AMF (e.g.
location reporting, UE moving into or out of Area Of Interest), after this
step by invoking Namf_EventExposure_Subscribe service operation as specified
in clause 5.2.2.3.2. For LADN, the SMF subscribes to the UE moving into or out
of LADN service area event _notification by providing the LADN DNN as an
indicator for the Area Of Interest (see clause 5.6.5 and 5.6.11 of TS 23.501
[2])._
After this step, the AMF forwards relevant events subscribed by the SMF.
18\. [Conditional] SMF to AMF: Nsmf_PDUSession_SMContextStatusNotify (Release)
If during the procedure, any time after step 5, the PDU Session establishment
is not successful, the SMF informs the AMF by invoking
Nsmf_PDUSession_SMContextStatusNotify (Release). The SMF also releases any N4
session(s) created, any PDU Session address if allocated (e.g. IP address) and
releases the association with PCF, if any. In this case, step 19 is skipped.
19\. SMF to UE, via UPF: In the case of PDU Session Type IPv6 or IPv4v6, the
SMF generates an IPv6 Router Advertisement and sends it to the UE via N4 and
the UPF.
20\. If the PDU Session establishment failed after step 4, the SMF shall
perform the following:
The SMF unsubscribes to the modifications of Session Management Subscription
data for the corresponding (SUPI, DNN, S-NSSAI of the HPLMN), using
Nudm_SDM_Unsubscribe (SUPI, Session Management Subscription data, DNN, S-NSSAI
of the HPLMN), if the SMF is no more handling a PDU Session of the UE for this
(DNN, S-NSSAI of the HPLMN). The UDM may unsubscribe to the modification
notification from UDR by Nudr_DM_Unsubscribe (SUPI, Subscription Data, Session
Management Subscription data, S-NSSAI of the HPLMN, DNN).
##### 4.3.2.2.2 Home-routed Roaming
This procedure is used in the case of home-routed roaming scenarios.
Figure 4.3.2.2.2-1: UE-requested PDU Session Establishment for home-routed
roaming scenarios
1\. This step is the same as step 1 in clause 4.3.2.2.1.
2\. As in step 2 of clause 4.3.2.2.1 with the addition that the AMF also
selects an SMF in HPLMN using the S-NSSAI with the value defined by the HPLMN,
as described in clause 4.3.2.2.3. The AMF may also receive alternative H-SMFs
from the NRF. The AMF stores the association of the S-NSSAI(s), the DNN, the
PDU Session ID, the SMF ID in VPLMN as well as Access Type of the PDU Session.
In step 3 of clause 4.3.2.2.1, in local breakout roaming case, if V-SMF
responds to AMF indicating that V-SMF is not able to process some part of the
N1 SM information, the AMF proceeds with home routed case from this step and
may select an SMF in the VPLMN different from the V-SMF selected earlier.
3a. As in step 3 of clause 4.3.2.2.1 with the addition that:
\- the AMF also provides the identity of the H-SMF it has selected in step 2
and both the VPLMN S-NSSAI from the Allowed NSSAI and the corresponding
S-NSSAI of the HPLMN, which is in the mapping the VPLMN S-NSSAI from the
Allowed NSSAI. The H-SMF is provided when the PDU Session is home-routed. The
AMF may also provide the identity of alternative H-SMFs, if it has received in
step 2.
\- The V-SMF does not use DNN Selection Mode received from the AMF but relays
this information to the H-SMF.
The AMF may include the H-PCF ID in this step and V-SMF will pass it to the
H-SMF in step 6. This will enable the H-SMF to select the same H-PCF in step
9a.
3b: This step is the same as step 5 of clause 4.3.2.2.1.
4\. The V-SMF selects a UPF in VPLMN as described in clause 6.3.3 of TS 23.501
[2].
5\. The V-SMF initiates an N4 Session Establishment procedure with the
selected V-UPF:
5a. The V-SMF sends an N4 Session Establishment Request to the V-UPF. If CN
Tunnel Info is allocated by the SMF, the CN Tunnel Info is provided to V-UPF
in this step.
5b. The V-UPF acknowledges by sending an N4 Session Establishment Response. If
CN Tunnel Info is allocated by the V-UPF, the CN Tunnel Info is provided to
V-SMF in this step.
6\. V-SMF to H-SMF: Nsmf_PDUSession_Create Request (SUPI, GPSI (if available),
V-SMF SM Context ID, DNN, S-NSSAI with the value defined by the HPLMN, PDU
Session ID, V-SMF ID, V-CN-Tunnel-Info, PDU Session Type, PCO, Number Of
Packet Filters, User location information, Access Type, PCF ID, SM PDU DN
Request Container, DNN Selection Mode, [Always-on PDU Session Requested], AMF
ID). Protocol Configuration Options may contain information that H-SMF may
needs to properly establish the PDU Session (e.g. SSC mode or SM PDU DN
Request Container to be used to authenticate the UE by the DN-AAA as defined
in clause 4.3.2.3). The H-SMF may use DNN Selection Mode when deciding whether
to accept or reject the UE request. If the V-SMF does not receive any response
from the H-SMF due to communication failure on the N16 interface, depending on
operator policy the V-SMF may create the PDU Session to one of the alternative
H-SMF(s) if additional H-SMF information is provided in step 3a, as specified
in detail in TS 29.502 [36].
V-SMF SM Context ID contains the addressing information it has allocated for
service operations related with this PDU Session. The H-SMF stores an
association of the PDU Session and V-SMF Context ID for this PDU Session for
this UE.
If the H-SMF needs to use V-SMF services for this PDU Session (invoking
Nsmf_PDUSession_Update Request) before step 13, at the first invocation of
Nsmf_PDUSession_Update Request the H-SMF provides the V-SMF with the H-SMF SM
Context ID it has allocated for service operations related with this PDU
Session.
7-12b. These steps are the same as steps 4-10 in clause 4.3.2.2.1 with the
following differences:
\- These steps are executed in Home PLMN;
\- The H-SMF does not provides the Inactivity Timer to the H-UPF as described
in step 9a in clause 4.3.2.2.1.
\- Step 5 of clause 4.3.2.2.1 is not executed.
When PCF is deployed, the SMF shall further report the PS Data Off status to
PCF if the PS Data Off event trigger is provisioned, the additional behaviour
of SMF and PCF for 3GPP PS Data Off is defined in TS 23.503 [20].
12c. This step is the same as step 16c in clause 4.3.2.2.1 with the following
difference:
\- The H-SMF registers for the PDU Session with the UDM using
Nudm_UECM_Registration (SUPI, DNN, S-NSSAI with the value defined by the
HPLMN, PDU Session ID).
13\. H-SMF to V-SMF: Nsmf_PDUSession_Create Response (QoS Rule(s), QoS Flow
level QoS parameters if needed for the QoS Flow(s) associated with the QoS
rule(s), PCO including session level information that the V-SMF is not
expected to understand, selected PDU Session Type and SSC mode, H-CN Tunnel
Info, QFI(s), QoS profile(s), Session-AMBR, Reflective QoS Timer (if
available), information needed by V-SMF in the case of EPS interworking such
as the PDN Connection Type, User Plane Policy Enforcement)
If the PDU Session being established was requested to be an always-on PDU
Session, the H-SMF shall indicate to the V-SMF whether the request is accepted
or not via the Always-on PDU Session Granted indication in the response
message to V-SMF. If the PDU Session being established was not requested to be
an always-on PDU Session but the H-SMF determines that the PDU Session needs
to be established as an always-on PDU Session, the H-SMF shall indicate it to
the V-SMF by including Always-on PDU Session Granted indication that the PDU
Session is an always-on PDU Session.
The information that the H-SMF may provide is the same than defined for step
11 of Figure 4.3.2.2.1-1.
The H-CN Tunnel Info contains the tunnel information for uplink traffic
towards H-UPF.
Multiple QoS Rules and QoS Flow level QoS parameters for the QoS Flow(s)
associated with the QoS rule(s) may be included in the Nsmf_PDUSession_Create
Response.
14-18. These steps are the same as steps 11-15 in clause 4.3.2.2.1 with the
following differences:
\- These steps are executed in Visited PLMN;
\- The V-SMF stores an association of the PDU Session and H-SMF ID for this
PDU Session for this UE;
\- If the H-SMF indicates the PDU Session can be established as an always-on
PDU Session, the V-SMF shall further check whether the PDU Session can be
established as an always-on PDU Session based on local policies. The V-SMF
notifies the UE whether the PDU Session is an always-on PDU Session or not via
the Always-on PDU Session Granted indication in the PDU Session Establishment
Accept message.
19a. The V-SMF initiates an N4 Session Modification procedure with the V-UPF.
The V-SMF provides Packet detection, enforcement and reporting rules to be
installed on the V-UPF for this PDU Session, including AN Tunnel Info, H-CN
Tunnel Info and V-CN Tunnel Info.
19b. The V-UPF provides a N4 Session Modification Response to the V-SMF.
After this step, the V-UPF delivers any down-link packets to the UE that may
have been buffered for this PDU Session.
20\. This step is the same as step 17 in clause 4.3.2.2.1 with the following
differences:
\- The SMF is a V-SMF. The H-SMF and V-SMF subscribe to UE reachability event
from AMF.
21\. This step is same as step 18 in clause 4.3.2.2.1. In addition, if during
the procedure, after step 14, the PDU Session establishment is not successful
as specified in step 15 of clause 4.3.2.2.1, the V-SMF triggers the V-SMF
initiated PDU Session release procedure from step 1b-3b as defined in clause
4.3.4.3.
22\. H-SMF to UE, via H-UPF and V-UPF in VPLMN: In the case of PDU Session
Type IPv6 or IPv4v6, the H-SMF generates an IPv6 Router Advertisement and
sends it to the UE via N4 and the H-UPF and V-UPF.
23\. If the V-SMF received in step18 an indication that the (R)AN has rejected
some QFI(s) the V-SMF notifies the H-SMF via a Nsmf_PDUSession_Update Request.
The H-SMF is responsible of updating accordingly the QoS rules and QoS Flow
level QoS parameters if needed for the QoS Flow(s) associated with the QoS
rule(s) in the UE.
24\. This step is the same as step 20 in clause 4.3.2.2.1 with the following
differences:
\- this step is executed in the Home PLMN;
\- the SMF also deregisters for the given PDU Session using
Nudm_UECM_Deregistration (SUPI, DNN, PDU Session ID). The UDM may update
corresponding UE context by Nudr_DM_Update (SUPI, Subscription Data, UE
context in SMF data).
NOTE: The SMF in HPLMN can initiate H-SMF initiated PDU Session release
procedure as defined in clause 4.3.4.3, already after step 13.
##### 4.3.2.2.3 SMF selection
##### 4.3.2.2.3.1 General {#general-10 .H6}
The SMF selection function, as described in clause 6.3.2 of TS 23.501 [2], is
supported by the AMF and is used to allocate an SMF that manages the PDU
Session.
The SMF selection function described in this clause does not apply to the
selection of an SMF for Emergency services. For SMF selection for Emergency
services is described in clause 5.16.4.5 of TS 23.501 [2].
Two main branches of deployment scenarios to consider:
\- Non-roaming and roaming with local breakout, see clause 4.3.2.2.3.2
\- Home routed roaming, see clause 4.3.2.2.3.3
In the case of non-roaming and local breakout, there are two operational
scenarios dependent on the configuration of AMF and the deployment option of
NSSF in the serving PLMN.
In the case of home-routed, there are two main options dependent on the
operators\' choices in terms of involvement of NRF, NSSF and configuration of
AMF. The decision of which option to use is part of the roaming agreements.
NOTE: The use of NSI ID and the use of multiple NRFs in the network are
optional and depend on the deployment choices of the operator.
##### 4.3.2.2.3.2 Non-roaming and roaming with local breakout {#non-roaming-
and-roaming-with-local-breakout-1 .H6}
Figure 4.3.2.2.3.2-1: SMF selection for non-roaming and roaming with local
breakout scenarios
This procedure may be skipped altogether if SMF information is available in
the AMF by other means (e.g. locally configured); otherwise:
\- when the serving AMF is aware of the appropriate NRF to be used to select
NFs/services within the corresponding Network Slice instance based on
configuration or based on the Network Slice selection information received
during Registration, only steps 3 and 4 in the following procedure are
executed as described in Figure 4.3.2.2.3.2-1;
\- when the serving AMF is not aware of the appropriate NRF to be used to
select NFs/services within the corresponding Network Slice instance, all steps
in the following procedure are executed as described in Figure 4.3.2.2.3.2-1.
1\. The AMF invokes the Nnssf_NSSelection_Get service operation from the NSSF
in serving PLMN with the S-NSSAI of the VPLMN from the Allowed NSSAI requested
by the UE, PLMN ID of the SUPI, TAI of the UE and the indication that the
request is within a procedure of PDU Session establishment in either the non-
roaming or roaming with local breakout scenario.
2\. The NSSF in serving PLMN selects the Network Slice instance, determines
and returns the appropriate NRF to be used to select NFs/services within the
selected Network Slice instance and optionally may return a NSI ID
corresponding to the Network Slice instance.
3\. AMF queries the appropriate NRF in serving PLMN by issuing the
Nnrf_NFDiscovery_Request including S-NSSAI of the VPLMN for this PDU Session
from the Allowed NSSAI, PLMN ID of the SUPI, DNN and possibly NSI ID if the
AMF has stored an NSI ID for the S-NSSAI of the VPMN for this PDU Session from
the Allowed NSSAI.
4\. The NRF in serving PLMN provides to the AMF, e.g. FQDN or IP address, of a
set of the discovered SMF instance(s) or Endpoint Address(es) of SMF service
instance(s) in Nnrf_NFDiscovery_Request response message and possibly an NSI
ID for the selected Network Slice instance corresponding to the S-NSSAI for
subsequent NRF queries.
##### 4.3.2.2.3.3 Home routed roaming {#home-routed-roaming-1 .H6}
The selection of the SMF in VPLMN is performed in the same way as for non-
roaming and roaming with local breakout (see clause 4.3.2.2.3.2). The
selection of the SMF in HPLMN is performed by means of one of two main
options. Which of these two options to use is decided based on Service Level
Agreements between the operators.
NOTE 1: The procedures described in this clause are not limited to SMF
selection but can be used to discover and select any NF/NF service in the
HPLMN part of a Network Slice instance.
In the first option, requiring the use of NSSF in both the VPLMN and the
HPLMN, the selection of the SMF in HPLMN is performed by means of the
procedure depicted in Figure 4.3.2.2.3.3-1.
Figure 4.3.2.2.3.3-1: Option 1 for SMF selection for home-routed roaming
scenarios
1\. Based on the operator\'s configuration, if the AMF is not aware of the
appropriate NRF to be used to select NFs/services in the HPLMN, the AMF
invokes the Nnssf_NSSelection_Get service operation from the NSSF in VPLMN
with the VPLMN S-NSSAI from the Allowed NSSAI requested by the UE for this PDU
Session, the HPLMN S-NSSAI that maps to the VPLMN S-NSSAI, PLMN ID of the
SUPI, the TAI of the UE and the indication that the request is within a
procedure of PDU Session establishment in the home-routed roaming scenario.
2\. If slicing configuration information for the S-NSSAI in the HPLMN is not
available (e.g. the NSSF has no cached information), the NSSF of the VPLMN
invokes the Nnssf_NSSelection_Get service operation from NSSF of the HPLMN
according to the PLMN ID of SUPI by including the HPLMN S-NSSAI.
3\. The NSSF in HPLMN may include the NSI ID, if needed, for the Network Slice
instance in HPLMN selected for the corresponding S-NSSAI of the HPLMN in the
Nnssf_NSSelection_Get response. The NSSF in HPLMN also includes the
appropriate hNRF to be used to select NFs/services within HPLMN in the
Nnssf_NSSelection_Get response.
4\. The serving NSSF includes in the Nnssf_NSSelection_Get response all the
information that has been received from the NSSF in HPLMN when responding to
the AMF.
5\. The AMF queries the target vNRF using the Nnrf_NFDiscovery_Request by
including PLMN ID of the SUPI, DNN, HPLMN S-NSSAI and possibly an HPLMN NSI ID
if the AMF has stored an NSI ID for the selected Network Slice instance
corresponding to the HPLMN S-NSSAI.
6\. The NRF in serving PLMN identifies NRF in HPLMN (hNRF) based on the
information provided by the NSSF in the serving PLMN and it invokes the
Nnrf_NFDiscovery_Request service from hNRF according the procedure in Figure
4.17.4-1 to get the expected SMF instance(s) deployed in the HPLMN. As the
vNRF in VPLMN triggers the \"NF Discovery\" on behalf of the AMF, the NRF in
the VPLMN shall not replace the information of the NF, i.e. AMF ID, in the
Nnrf_NFDiscovery_Request message it sends to the hNRF.
7-8. The hNRF provides to the AMF, via vNRF, the information e.g. FQDN or IP
address, of a set of the SMF instance(s) in Nnrf_NFDiscovery_Request response
message and possibly an NSI ID for the selected Network Slice instance
corresponding to the S-NSSAI of the HPLMN for subsequent NRF queries.
When the NSSF is not deployed in HPLMN then the AMF in VPLMN relies on either
the configuration to obtain the NRF in HPLMN or on the option below.
The second option for the selection of the SMF in HPLMN is performed by means
of the procedure depicted in Figure 4.3.2.2.3.3-2.
Figure 4.3.2.2.3.3-2: Option 2 for SMF selection for home-routed roaming
scenarios
1\. Based on the operator\'s configuration, the AMF queries the vNRF with PLMN
ID of the SUPI, PLMN ID of the serving PLMN, DNN, the HPLMN S-NSSAI that maps
to the S-NSSAI from the Allowed NSSAI of the Serving PLMN the UE has
requested, NSI ID (if the AMF has stored an HPLMN NSI ID for the selected
Network Slice instance corresponding to the S-NSSAI of the HPLMN) and DNN.
2\. The vNRF queries, on behalf of the AMF in VPLMN, the hNRF identified by
means of the PLMN ID of the SUPI. The NRF in VPLMN requests \"NF Discovery\"
service from hNRF according the procedure in Figure 4.17.4-1 to get the
expected SMF instance(s) deployed in the HPLMN. As the NRF in the serving PLMN
triggers the \"NF Discovery\" on behalf of the AMF, the NRF in the VPLMN shall
not replace the information of the NF, i.e. AMF ID, in the
Nnrf_NFDiscovery_Request message it sends to the hNRF.
Depending on the available information and based on configuration, the hNRF
may either execute steps in 3(A) or in 3(B).
3(A) The hNRF provides to the AMF, via vNRF, the information e.g. FQDN or IP
address, of a set of the discovered SMF instance(s) and possibly an NSI ID for
the selected HPLMN part of the Network Slice instance corresponding to the
S-NSSAI of the HPLMN for subsequent NRF queries in Nnrf_NFDiscovery_Request
response message(steps 3a and 3b).
3(B) The hNRF queries, on behalf of the AMF, an appropriate local NRF in HPLMN
(e.g. a slice level NRF); this local NRF provides the IP address or the FQDN
of expected SMF instance(s) and possibly an NSI ID for the selected HPLMN part
of the Network Slice instance corresponding to the S-NSSAI of the HPLMN for
subsequent NRF queries (steps 3a and 3b) that the hNRF returns, via vNRF, to
the AMF (steps 3c and 3d).
#### 4.3.2.3 Secondary authorization/authentication by an DN-AAA server during
the PDU Session establishment
The PDU Session establishment authentication/authorization is optionally
triggered by the SMF during a PDU Session establishment and performed
transparently via a UPF or directly with the DN-AAA server without involving
the UPF if the DN-AAA server is located in the 5GC and reachable directly, as
described in clause 5.6.6 of TS 23.501 [2].
In the case of Home Routed Roaming, unless specified otherwise, the SMF in the
information flow defined in this clause is the H-SMF.
Figure 4.3.2.3-1: PDU Session Establishment authentication/authorization by a
DN-AAA server
NOTE 1: Steps 2, 3a, 3f and 4 are not defined in this specification. Steps 3
can be repeated depending on the mechanism used.
NOTE 2: When the SMF directly communicates with the DN-AAA server without
involving the UPF, Step 1 is skipped and Step 2, 3a, 3f, 4 and 6 are executed
without involving the UPF.
0\. The SMF determines that it needs to contact the DN-AAA server. The SMF
identifies the DN-AAA server based on local configuration, or using the DN-
specific identity (TS 33.501 [15]) provided by the UE inside the SM PDU DN
Request Container in the PDU Session Establishment request or inside the EAP
message in the PDU Session Authentication Complete message (TS 24.501 [25]).
NOTE 3: The content of the SM PDU DN Request Container is defined in TS 24.501
[25].
1\. If there is no existing N4 session that can be used to carry DN-related
messages between the SMF and the DN, the SMF selects a UPF and triggers N4
session establishment.
2\. The SMF initiates the authentication procedure with the DN-AAA via the UPF
to authenticate the DN-specific identity provided by the UE as specified in TS
29.561 [51].
When available, the SMF provides the GPSI in the signalling exchanged with the
DN-AAA.
The UPF transparently relays the message received from the SMF to the DN-AAA
server.
3a. The DN-AAA server sends an Authentication/Authorization message towards
the SMF. The message is carried via the UPF.
3b. Transfer of DN Request Container information received from DN-AAA towards
the UE.
In non-roaming and LBO cases, the SMF invokes the
Namf_Communication_N1N2MessageTransfer service operation on the AMF to
transfer the DN Request Container information within N1 SM information sent
towards the UE.
In the case of Home Routed roaming, the H-SMF initiates a
Nsmf_PDUSession_Update service operation to request the V-SMF to transfer DN
Request Container to the UE and the V-SMF invokes the
Namf_Communication_N1N2MessageTransfer service operation on the AMF to
transfer the DN Request Container information within N1 SM information sent
towards the UE. In Nsmf_PDUSession_Update Request, the H-SMF additionally
includes the H-SMF SM Context ID.
3c: The AMF sends the N1 NAS message to the UE
3d-3e. Transfer of DN Request Container information received from UE towards
the DN-AAA.
When the UE responds with a N1 NAS message containing DN Request Container
information, the AMF informs the SMF by invoking the
Nsmf_PDUSession_UpdateSMContext service operation. The SMF issues an
Nsmf_PDUSession_UpdateSMContext response.
In the case of Home Routed roaming, the V-SMF relays the N1 SM information to
the H-SMF using the information of PDU Session received in step 3b via a
Nsmf_PDUSession_Update service operation.
3f: The SMF (In HR case it is the H-SMF) sends the content of the DN Request
Container information (authentication message) to the DN-AAA server via the
UPF.
Step 3 may be repeated until the DN-AAA server confirms the successful
authentication/authorization of the PDU Session.
4\. The DN-AAA server confirms the successful authentication/authorization of
the PDU Session. The DN-AAA server may provide:
\- an SM PDU DN Response Container to the SMF to indicate successful
authentication/authorization;
\- DN Authorization Data as defined in clause 5.6.6 of TS 23.501 [2];
\- a request to get notified with the IP address(es) allocated to the PDU
Session and/or with N6 traffic routing information or MAC address(es) used by
the UE for the PDU Session; and
\- an IP address (or IPV6 Prefix) for the PDU Session.
The N6 traffic routing information is defined in clause 5.6.7 of TS 23.501
[2].
After the successful DN authentication/authorization, a session is kept
between the SMF and the DN-AAA. If the SMF receives a DN Authorization Data,
the SMF uses the DN Authorization Profile Index to apply the policy and
charging control (see clause 5.6.6 of TS 23.501 [2]).
5\. The PDU Session establishment continues and completes. In the step 7b of
the Figure 4.3.2.2.1-1, if the SMF receives the DN Authorization Profile Index
in DN Authorization Data from the DN-AAA, it sends the DN Authorization
Profile Index to retrieve the PDU Session related policy information
(described in clause 6.4 of TS 23.503 [20]) and the PCC rule(s) (described in
clause 6.3 of TS 23.503 [20]) from the PCF. If the SMF receives the DN
authorized Session AMBR in DN Authorization Data from the DN-AAA, it sends the
DN authorized Session AMBR within the Session AMBR to the PCF to retrieve the
authorized Session AMBR (described in clause 6.4 of TS 23.503 [20]).
6\. If requested so in step 4 or if configured so by local policies, the SMF
notifies the DN-AAA with the IP/MAC address(es) and/or with N6 traffic routing
information allocated to the PDU Session together with the GPSI.
Later on the SMF notifies the DN-AAA if the DN-AAA had requested to get
notifications about:
\-- Allocation or release of an IPV6 Prefix for the PDU Session of IP type or
addition or removal of source MAC addresses for the PDU Session of Ethernet
type (e.g. using IPV6 multi-homing as defined in clause 5.6.4.3 of TS 23.501
[2]).
\- Change of N6 traffic routing information.
When later on the PDU Session gets released as described in clause 4.3.4, the
SMF notifies the DN-AAA.
The DN-AAA server may revoke the authorization for a PDU Session or update DN
authorization data for a PDU Session. According to the request from DN-AAA
server, the SMF may release or update the PDU Session.
At any time after the PDU Session establishment, the DN-AAA server or SMF may
initiate Secondary Re-authentication procedure for the PDU Session as
specified in clause 11.1.3 in TS 33.501 [15]. Step 3a to step 3f are performed
to transfer the Secondary Re-authentication message between the UE and the DN-
AAA server. The Secondary Re-authentication procedure may start from step 3a
(DN-AAA initiated Secondary Re-authentication procedure) or step 3b (SMF
initiated Secondary Re-authentication procedure). For the DN-AAA server
initiated Secondary Re-authentication, the message in step 3a shall include
GPSI, if available and the IP/MAC address(es) of the PDU session, for SMF to
identify the corresponding UE and PDU session.
DN-AAA may initiate DN-AAA Re-authorization without performing re-
authentication based on local policy. DN-AAA Re-authorization procedure may
start from step 4.
During Secondary Re-authentication/Re-authorization, if the SMF receives DN
Authorization Profile Index and/or DN authorized Session AMBR, the SMF reports
the received value(s) to the PCF (as described in TS 23.501 [2]) by triggering
the Policy Control Request Trigger as described in TS 23.503 [20].
### 4.3.3 PDU Session Modification
#### 4.3.3.1 General
The procedure is used when one or several of the QoS parameters exchanged
between the UE and the network are modified.
NOTE: The conditions when to use this procedure for QoS change as well as the
QoS parameters exchanged between the UE and the network are defined in clause
5.7 of TS 23.501 [2].
#### 4.3.3.2 UE or network requested PDU Session Modification (non-roaming and
roaming with local breakout)
The UE or network requested PDU Session Modification procedure (non-roaming
and roaming with local breakout scenario) is depicted in figure 4.3.3.2-1.
Figure 4.3.3.2-1: UE or network requested PDU Session Modification (for non-
roaming and roaming with local breakout)
1\. The procedure may be triggered by following events:
1a. (UE initiated modification) The UE initiates the PDU Session Modification
procedure by the transmission of an NAS message (N1 SM container (PDU Session
Modification Request (PDU session ID, Packet Filters, Operation, Requested
QoS, Segregation, 5GSM Core Network Capability, Number Of Packet Filters,
[Always-on PDU Session Requested])), PDU Session ID and UE Integrity
Protection Maximum Data Rate) message. Depending on the Access Type, if the UE
was in CM-IDLE state, this SM-NAS message is preceded by the Service Request
procedure. The NAS message is forwarded by the (R)AN to the AMF with an
indication of User location Information. The AMF invokes
Nsmf_PDUSession_UpdateSMContext (SM Context ID, N1 SM container (PDU Session
Modification Request)).
When the UE requests specific QoS handling for selected SDF(s), the PDU
Session Modification Request includes Packet Filters describing the SDF(s),
the requested Packet Filter Operation (add, modify, delete) on the indicated
Packet Filters, the Requested QoS and optionally a Segregation indication. The
Segregation indication is included when the UE recommends to the network to
bind the applicable SDF(s) on a distinct and dedicated QoS Flow e.g. even if
an existing QoS Flow can support the requested QoS. The network should abide
by the UE request, but is allowed to proceed instead with binding the selected
SDF(s) on an existing QoS Flow.
NOTE 1: Only one QoS Flow is used for traffic segregation. If UE makes
subsequent requests for segregation of additional SDF(s), the additional
SDF(s) are multiplexed on the existing QoS Flow that is used for segregation.
The UE shall not trigger a PDU Session Modification procedure for a PDU
Session corresponding to a LADN when the UE is outside the area of
availability of the LADN.
The PS Data Off status, if changed, shall be included in the PCO in the PDU
Session Modification Request message.
For a PDU Session which was established in the EPS, when the UE moves from EPS
to 5GS _for the first time, the UE_ includes an Always-on PDU Session
Requested indication in the PDU Session Modification Request message if it
wants to change the PDU Session to an always-on PDU Session.
When PCF is deployed, the SMF shall further report the PS Data Off status to
PCF if the PS Data Off event trigger is provisioned, the additional behaviour
of SMF and PCF for 3GPP PS Data Off is defined in TS 23.503 [20].
The 5GSM Core Network Capability is provided by the UE and handled by SMF as
defined in clause 5.4.4b of TS 23.501 [2].
The UE Integrity Protection Maximum Data Rate indicates the maximum data rate
up to which the UE can support UP integrity protection.
The Number Of Packet Filters indicates the number of supported packet filters
for signalled QoS rules as described in clause 5.17.2.2.2 of TS 23.501 [2].
1b. (SMF requested modification) The PCF performs a PCF initiated SM Policy
Association Modification procedure as defined in clause 4.16.5.2 to notify SMF
about the modification of policies. This may e.g.; have been triggered by a
policy decision or upon AF requests, e.g. Application Function influence on
traffic routing as described in step 5 in clause 4.3.6.2.
1c. (SMF requested modification) The UDM updates the subscription data of SMF
by Nudm_SDM_Notification (SUPI, Session Management Subscription Data). The SMF
updates the Session Management Subscription Data and acknowledges the UDM by
returning an Ack with (SUPI).
1d. (SMF requested modification) The SMF may decide to modify PDU Session.
This procedure also may be triggered based on locally configured policy or
triggered from the (R)AN (see clause 4.2.6 and clause 4.9.1). It may also be
triggered if the UP connection is activated (as described in Service Request
procedure) and the SMF has marked that the status of one or more QoS Flows are
deleted in the 5GC but not synchronized with the UE yet.
If the SMF receives one of the triggers in step 1b \~ 1d, the SMF starts SMF
requested PDU Session Modification procedure.
1e. (AN initiated modification) (R)AN shall indicate to the SMF when the AN
resources onto which a QoS Flow is mapped are released irrespective of whether
notification control is configured. (R)AN sends the N2 message (PDU Session
ID, N2 SM information) to the AMF. The N2 SM information includes the QFI,
User location Information and an indication that the QoS Flow is released. The
AMF invokes Nsmf_PDUSession_UpdateSMContext (SM Context ID, N2 SM
information).
(AN initiated notification control) If notification control is configured for
a GBR Flow, (R)AN sends a N2 message (PDU Session ID, N2 SM information) to
SMF when the (R)AN decides the QoS targets of the QoS Flow cannot be fulfilled
or can be fulfilled again, respectively. The N2 SM information includes the
QFI and an indication that the QoS targets for that QoS Flow cannot be
fulfilled or can be fulfilled again, respectively. The AMF invokes
Nsmf_PDUSession_UpdateSMContext (SM Context ID, N2 SM information). If the PCF
has subscribed to the event, SMF reports this event to the PCF for each PCC
Rule for which notification control is set, see step 2. Alternatively, if
dynamic PCC does not apply for this DNN and dependent on locally configured
policy, the SMF may start SMF requested PDU Session Modification procedure,
see step 3b.
2\. The SMF may need to report some subscribed event to the PCF by performing
an SMF initiated SM Policy Association Modification procedure as defined in
clause 4.16.5.1. This step may be skipped if PDU Session Modification
procedure is triggered by step 1b or 1d. If dynamic PCC is not deployed, the
SMF may apply local policy to decide whether to change the QoS profile.
Steps 3 to 7 are not invoked when the PDU Session Modification requires only
action at a UPF (e.g. gating).
3a. For UE or AN initiated modification, the SMF responds to the AMF through
Nsmf_PDUSession_UpdateSMContext (N2 SM information (PDU Session ID, QFI(s),
QoS Profile(s), Session-AMBR), N1 SM container (PDU Session Modification
Command (PDU Session ID, QoS rule(s), QoS rule operation, QoS Flow level QoS
parameters if needed for the QoS Flow(s) associated with the QoS rule(s),
Session-AMBR, [Always-on PDU Session]))). See clause 5.7 of TS 23.501 [2] for
the QoS Profile and QoS rule and QoS Flow level QoS parameters.
If the PDU Session Modification was requested by the UE to modify a PDU
Session to an always-on PDU Session, the SMF shall include an Always-on PDU
Session Granted indication in the PDU Session Modification Command to indicate
whether the PDU Session is to be changed to an always-on PDU Session or not
via the Always-on PDU Session Granted indication in the PDU Session
Modification Command.
The N2 SM information carries information that the AMF shall provide to the
(R)AN. It may include the QoS profiles and the corresponding QFIs to notify
the (R)AN that one or more QoS flows were added, or modified. It may include
only QFI(s) to notify the (R)AN that one or more QoS flows were removed. If
the PDU Session Modification was triggered by the (R)AN Release in step 1e the
N2 SM information carries an acknowledgement of the (R)AN Release. If the PDU
Session Modification was requested by the UE for a PDU Session that has no
established User Plane resources, the N2 SM information provided to the (R)AN
includes information for establishment of User Plane resources.
The N1 SM container carries the PDU Session Modification Command that the AMF
shall provide to the UE. It may include the QoS rules, QoS Flow level QoS
parameters if needed for the QoS Flow(s) associated with the QoS rule(s) and
corresponding QoS rule operation and QoS Flow level QoS parameters operation
to notify the UE that one or more QoS rules were added, removed or modified.
3b. For SMF requested modification, the SMF invokes
Namf_Communication_N1N2MessageTransfer (N2 SM information (PDU Session ID,
QFI(s), QoS Profile(s), Session-AMBR), N1 SM container (PDU Session
Modification Command (PDU Session ID, QoS rule(s), QoS Flow level QoS
parameters if needed for the QoS Flow(s) associated with the QoS rule(s), QoS
rule operation and QoS Flow level QoS parameters operation, Session-AMBR))).
If the UE is in CM-IDLE state and an ATC is activated, the AMF updates and
stores the UE context based on the Namf_Communication_N1N2MessageTransfer and
steps 4, 5, 6 and 7 are skipped. When the UE is reachable e.g. when the UE
enters CM-CONNECTED state, the AMF forwards the N1 message to synchronize the
UE context with the UE.
4\. The AMF may send N2 PDU Session Request (N2 SM information received from
SMF, NAS message (PDU Session ID, N1 SM container (PDU Session Modification
Command))) Message to the (R)AN.
5\. The (R)AN may issue AN specific signalling exchange with the UE that is
related with the information received from SMF. For example, in the case of a
NG-RAN, an RRC Connection Reconfiguration may take place with the UE modifying
the necessary (R)AN resources related to the PDU Session.
6\. The (R)AN may acknowledge N2 PDU Session Request by sending a N2 PDU
Session Ack (N2 SM information (List of accepted/rejected QFI(s), AN Tunnel
Info, PDU Session ID, Secondary RAT usage data), User location Information)
Message to the AMF. In the case of Dual Connectivity, if one or more QFIs were
added to the PDU Session, the Master RAN node may assign one or more of these
QFIs to a NG-RAN node which was not involved in the PDU Session earlier. In
this case the AN Tunnel Info includes a new N3 tunnel endpoint for QFIs
assigned to the new NG-RAN node. Correspondingly, if one or more QFIs were
removed from the PDU Session, a (R)AN node may no longer be involved in the
PDU Session anymore and the corresponding tunnel endpoint is removed from the
AN Tunnel Info. The NG-RAN may reject QFI(s) if it cannot fulfil the User
Plane Security Enforcement information for a corresponding QoS Profile, e.g.
due to the UE Integrity Protection Maximum Data Rate being exceeded.
If the PLMN has configured secondary RAT usage reporting, the NG-RAN node may
provide RAN Usage Data Report.
7\. The AMF forwards the N2 SM information and the User location Information
received from the AN to the SMF via Nsmf_PDUSession_UpdateSMContext service
operation. The SMF replies with a Nsmf_PDUSession_UpdateSMContext Response. N2
SM information may include Secondary RAT Usage Data.
If the (R)AN rejects QFI(s) the SMF is responsible of updating the QoS rules
and QoS Flow level QoS parameters if needed for the QoS Flow(s) associated
with the QoS rule(s) in the UE accordingly.
8\. The SMF may update N4 session of the UPF(s) that are involved by the PDU
Session Modification by sending N4 Session Modification Request message to the
UPF (see NOTE 3).
If new QoS Flow(s) are to be created, the SMF updates the UPF with UL Packet
Detection Rules of the new QoS Flow.
NOTE 2: This allows the UL packets with the QFI of the new QoS Flow to be
transferred.
9\. The UE acknowledges the PDU Session Modification Command by sending a NAS
message (PDU Session ID, N1 SM container (PDU Session Modification Command
Ack)) message.
10\. The (R)AN forwards the NAS message to the AMF.
11\. The AMF forwards the N1 SM container (PDU Session Modification Command
Ack) and User Location Information received from the AN to the SMF via
Nsmf_PDUSession_UpdateSMContext service operation. The SMF replies with a
Nsmf_PDUSession_UpdateSMContext Response.
If the SMF initiated modification is to delete QoS Flows (e.g. triggered by
PCF) which do not include QoS Flow associated with the default QoS rule and
the SMF does not receive response from the UE, the SMF marks that the status
of those QoS Flows is to be synchronized with the UE.
12\. The SMF may update N4 session of the UPF(s) that are involved by the PDU
Session Modification by sending N4 Session Modification Request (N4 Session
ID) message to the UPF. For a PDU Session of Ethernet PDU Session Type, the
SMF may notify the UPF to add or remove Ethernet Packet Filter Set(s) and
forwarding rule(s).
NOTE 3: The UPFs that are impacted in the PDU Session Modification procedure
depends on the modified QoS parameters and on the deployment. For example in
the case of the session AMBR of a PDU Session with an UL CL changes, only the
UL CL is involved. This note also applies to the step 8.
13\. If the SMF interacted with the PCF in step 1b or 2, the SMF notifies the
PCF whether the PCC decision could be enforced or not by performing an SMF
initiated SM Policy Association Modification procedure as defined in clause
4.16.5.1.
SMF notifies any entity that has subscribed to User Location Information
related with PDU Session change.
If step 1b is triggered to perform Application Function influence on traffic
routing by step 5 in clause 4.3.6.2, the SMF may reconfigure the User Plane of
the PDU Session as described in step 6 in clause 4.3.6.2.
#### 4.3.3.3 UE or network requested PDU Session Modification (home-routed
roaming)
The UE or network requested PDU Session Modification procedure (home-routed
roaming scenario) is depicted in figure 4.3.3.3-1.
Figure 4.3.3.3-1: UE or network requested PDU Session Modification (for home-
routed roaming scenario)
1\. The procedure is triggered by one of the following events:
1a. (UE or serving network requested) As in step 1a of clause 4.3.3.2 with the
addition that:
\- The V-SMF checks whether it can accept the request from the UE;
\- The V-SMF invokes an Nsmf_PDUSession_Update Request (SM Context ID, UE
request for PDU Session Modification or the QoS modification request from the
VPLMN, UE location information, Time Zone, the current Access Type, PCO,
[Always-on PDU Session Requested]) service operation to inform the H-SMF to
update the PDU Session. The H-SMF responds to the request immediately. If the
AMF notified the V-SMF that the access type of the PDU session can be changed,
as described in the UE Triggered Service Request procedure in clause 4.2.3.2,
the V-SMF shall also indicate that the access type can be changed.
The PS Data Off status, if changed, shall be included in PCO (Protocol
Configuration Option) in the PDU Session Modification Request message.
When PCF is deployed, the SMF shall further report the PS Data Off status to
PCF if the PS Data Off event trigger is provisioned, the additional behaviour
of SMF and PCF for 3GPP PS Data Off is defined in TS 23.503 [20].
1b. (HPLMN requested) This step is the same as step 1b in clause 4.3.3.2. If
the H-SMF received the indication that the access type of the PDU session can
be changed, the H-SMF shall indicate the target access type to the PCF in the
Access Type information of the Npcf_SMPolicyControl_Update Request.
1c. (HPLMN requested) This step is the same as step 1c in clause 4.3.3.2.
1d. (HPLMN requested) This step is the same as step 1d in clause 4.3.3.2.
1e. As in step 1e of clause 4.3.3.2 with addition that:
\- The AMF invokes Nsmf_PDUSession_UpdateSMContext (SM context ID, N2 SM
information) and sends it to the V-SMF;
\- The V-SMF invokes an Nsmf_PDUSession_Update Request (SM context ID, ULI, AN
type, QoS Flow to be released) service operation to inform the H-SMF to update
the PDU Session. The H-SMF responds to the request immediately.
NOTE 1: SM Context ID between AMF and V-SMF and between V-SMF and H-SMF are
different. SM Context ID has local significance per SMF instance.
2\. This step is the same as steps 2 in clause 4.3.3.2 with the SMF is H-SMF.
3\. (UE or serving network requested or HPLMN requested) The H-SMF invokes the
Nsmf_PDUSession_Update Request (SM Context ID, QoS profiles, Session-AMBR,
information needed to build the SM PDU Session Modification Command message
towards the UE including the QoS rule(s) and QoS Flow level QoS parameters if
needed for the QoS Flow(s) associated with the QoS rule(s) and QoS rule
operation and the QoS Flow level QoS parameters operation) service operation
to the V-SMF.
Based on operator policies, the V-SMF may decide to accept or reject the QoS
information provided by the H-SMF. The V-SMF shall be able to accept a subset
of the QoS flows requested to be created or modified within a single H-SMF
request i.e. V-SMF can accept some QoS flows and reject other QoS flows in
same response to H-SMF.
3a-3b (HPLMN requested) These steps are executed if new QoS Flow(s) are to be
created. The SMF updates the UPF with UL Packet Detection Rules of the new QoS
Flow.
NOTE 2: This allows the UL packets with the QFI of the new QoS Flow to be
transferred.
If an Always-on PDU Session Granted indication was provided by the H-SMF to
indicate that the PDU Session is to be changed to an always-on PDU Session,
the V-SMF decides whether to accept or reject the request from the H-SMF based
on local policies.
4a-4b. These steps are the same as step 3a-3b in clause 4.3.3.2 but controlled
from the V-SMF. The V-SMF uses the information received in step 3 to generate
any N1 and/or N2 signalling to be sent towards the UE and/or the (R)AN.
5-7. These steps are the same as step 4-6 in clause 4.3.3.2.
8\. This step is the same as step 7a in clause 4.3.3.2 with the difference
that the SMF is V-SMF.
9a-9b are the same as step 11a-11b in clause 4.3.3.2 but executed in Visited
PLMN
10\. This step is the same as step 7b in clause 4.3.3.2 with the difference
that the SMF is V-SMF.
11-12. These steps are the same as steps 8-9 in 4.3.3.2.
13-14. These steps are the same as step 10a-10b in clause 4.3.3.2 but executed
in Visited PLMN.
15\. V-SMF responds to the H-SMF with an Nsmf_PDUSession_Update response
carrying the information like PCO provided by the UE in the SM PDU Session
Modification Command Ack message from the UE to the V-SMF, Secondary RAT usage
data. The H-SMF shall modify the PDU Session context.
If the V-SMF has rejected QFI(s) (step3) or the (R)AN has rejected QFI(s) in
step 6 of Figure 4.3.3.2-1, the H-SMF is responsible of later updating the QoS
rules and QoS Flow level QoS parameters if needed for the QoS Flow(s)
associated with the QoS rule(s) in the UE.
16-17. These steps are the same as steps 11-12 in clause 4.3.3.2 with the
difference that the SMF is H-SMF.
### 4.3.4 PDU Session Release
#### 4.3.4.1 General
The PDU Session Release procedure is used to release all the resources
associated with a PDU Session, including:
\- The IP address/Prefixes allocated for an IP-based PDU Session; this may
include the release of multiple Prefixes in the case of Multi-homing (as
defined in TS 23.501 [2]).
\- Any UPF resource (including N3/N9 termination) that was used by the PDU
Session.
\- Any access resource that was used by the PDU Session.
The SMF takes care to notify any entity associated with PDU Session: PCF, DN
(e.g. when DN authorization has taken place at PDU Session establishment),
etc. of a PDU Session Release.
#### 4.3.4.2 UE or network requested PDU Session Release for Non-Roaming and
Roaming with Local Breakout
Figure 4.3.4.2-1 captures both the UE Requested PDU Session Release procedure
and the network requested PDU Session Release procedure. The procedure allows
the UE to request the release of one PDU Session. The procedure also allows
the AMF, the SMF or the PCF to initiate the release of a PDU Session. In the
case of LBO, the procedure is as in the case of non-roaming with the
difference that the AMF, the SMF, the UPF and the PCF are located in the
visited network.
Figure 4.3.4.2-1: UE or network requested PDU Session Release for non-roaming
and roaming with local breakout
1\. The procedure is triggered by one of the following events:
1a. (UE requested) The UE initiates the UE Requested PDU Session Release
procedure by the transmission of an NAS message (N1 SM container (PDU Session
Release Request (PDU session ID)), PDU Session ID) message. The NAS message is
forwarded by the (R)AN to the AMF with an indication of User Location
Information. This message is relayed to the SMF corresponding to the PDU
Session ID via N2 and the AMF. The AMF invokes the
Nsmf_PDUSession_UpdateSMContext service operation and provides the N1 SM
container to the SMF together with User Location Information (ULI) received
from the (R)AN.
NOTE 1: Depending on the Access Type, when the UE is in CM-IDLE state, the UE
can trigger a Service Request procedure before being able to release the PDU
Session.
1b. (PDU Session Release initiated by the PCF) The PCF may invoke an SM Policy
Association Termination procedure as defined in clause 4.16.6 to request the
release of the PDU Session.
1c. The AMF may invoke the Nsmf_PDUSession_ReleaseSMContext service operation
to request the release of the PDU Session in the case of mismatch of PDU
Session status between UE and AMF.
1d. (R)AN may decide to indicate to the SMF that the PDU Session related
resource is released, e.g. when all the QoS Flow(s) of the PDU Session are
released.
NOTE 2: In this case, it\'s up to SMF to decide whether to keep the PDU
Session with user plane connection deactivated or release the PDU Session.
1e. (PDU Session Release initiated by the SMF) The SMF may decide to release a
PDU Session under the following scenarios:
\- Based on a request from the DN (cancelling the UE authorization to access
to the DN);
\- Based on a request from the UDM (subscription change) or from the CHF;
\- If the SMF received an event notification from the AMF that the UE is out
of LADN service area
\- Based on locally configured policy (e.g. the release procedure may be
related with the UPF re-allocation for SSC mode 2 / mode 3); or
\- If the SMF is notified by the (R)AN that the PDU Session resource
establishment has failed during mobility procedure.
If the SMF receives one of the triggers in step 1a, 1b, 1c, or 1e the SMF
starts PDU Session Release procedure.
1f. The AMF may invoke the Nsmf_PDUSession_UpdateSMContext service operation
with a release indication to request the release of the PDU Session where N1
or N2 SM signalling may be needed before releasing the SM context.
2\. The SMF releases the IP address / Prefix(es) that were allocated to the
PDU Session and releases the corresponding User Plane resources:
2a. The SMF sends an N4 Session Release Request (N4 Session ID) message to the
UPF(s) of the PDU Session. The UPF(s) shall drop any remaining packets of the
PDU Session and release all tunnel resource and contexts associated with the
N4 Session.
2b. The UPF(s) acknowledges the N4 Session Release Request by the transmission
of an N4 Session Release Response (N4 Session ID) message to the SMF.
NOTE 3: If there are multiple UPFs associated with the PDU Session (e.g. due
to the insertion of UL CL or Branching Point, the Session Release Request
procedure (steps 2a and 2b) is done for each UPF.
3 If the PDU Session Release is initiated by the PCF and SMF and the SMF has
been notified by the AMF that UE is unreachable, e.g. due to the UE is in MICO
mode or periodical registration failure, the procedure continues in step 11 by
SMF notifying the AMF that the PDU Session is released by invoking the
Nsmf_PDUSession_SMContextStatusNotify. The rest of step 3 and the steps 4-10
are skipped.
If the PDU Session Release procedure was triggered by steps 1a, 1b, 1d or 1e
above, the SMF creates an N1 SM including PDU Session Release Command message
(PDU Session ID, Cause). The Cause may indicate a trigger to establish a new
PDU Session with the same characteristics (e.g. when procedures related with
SSC mode 2 are invoked).
If the User Plane connection of the PDU Session is activated, the message sent
by the SMF to the AMF shall include N2 SM Resource Release request. If the
User Plane connection of the PDU Session is not activated, the message sent by
the SMF to the AMF shall not include N2 SM Resource Release request.
NOTE 4: SSC modes are defined in clause 5.6.9 of TS 23.501 [2].
3a. (If the PDU Session Release is initiated by the UE in step 1a or has been
triggered by (R)AN in step 1d) The SMF responds to the AMF with the
Nsmf_PDUSession_UpdateSMContext response (N2 SM Resource Release request, N1
SM container (PDU Session Release Command)). N2 SM Resource Release request is
included if the PDU Session Release is initiated by the UE and if the UP
connection of the PDU Session is active.
3b. If the PDU Session Release is initiated by the SMF or the PCF, the SMF
invokes the Namf_Communication_N1N2MessageTransfer service operation (N1 SM
container (PDU Session Release Command), skip indicator).
If the UP connection of the PDU Session is active, the SMF shall also include
the N2 Resource Release request (PDU Session ID) in the
Namf_Communication_N1N2MessageTransfer, to release the (R)AN resources
associated with the PDU Session.
The \"skip indicator\" tells the AMF whether it may skip sending the N1 SM
container to the UE (e.g. when the UE is in CM-IDLE state). SMF includes the
\"skip indicator\" in the Namf_Communication_N1N2MessageTransfer except when
the procedure is triggered to change PDU Session Anchor of a PDU Session with
SSC mode 2.
If the UE is in CM-IDLE state and \"skip indicator\" is included in the
Namf_Communication_N1N2MessageTransfer service operation, the AMF acknowledges
the step 3b by sending an Namf_Communication_N1N2MessageTransfer Response
message (\"N1 SM Message Not Transferred\") to SMF and steps 4 to 10 are
skipped.
3c. If the PDU Session Release is initiated by the AMF in step 1c, i.e. the
SMF received the Nsmf_PDUSession_ReleaseSMContext Request from the AMF, the
SMF responds to the AMF with the Nsmf_PDUSession_ReleaseSMContext response.
The AMF and SMF shall remove all contexts (including the PDU Session ID)
associated with the PDU Session which are indicated as released at the UE. AMF
and SMF shall remove any event subscriptions on the AMF by the SMF as well.
The steps 4 to 11 are skipped.
3d. If the PDU Session Release is initiated by the AMF in step 1f, i.e. the
SMF received the Nsmf_PDUSession_UpdateSMContext Request from the AMF with a
release indication to request the release of the PDU Session (e.g. due to a
change of the set of network slices for a UE where a network slice instance is
no longer available as described in clause 5.15.5.2.2 of TS 23.501 [2]), the
SMF responds to the AMF with the Nsmf_PDUSession_UpdateSMContext Response
which shall contain the N1 SM container (PDU Session Release Command) to
release the PDU session at the UE.
If the UP connection of the PDU Session is active, the
Nsmf_PDUSession_UpdateSMContext Response shall also include the N2 Resource
Release request (PDU Session ID) to release the (R)AN resources associated
with the PDU Session.
4\. If the UE is in CM-IDLE state and \"N1 SM delivery can be skipped\" is not
indicated, the AMF initiates the network triggered Service Request procedure
to transmit the NAS message (PDU Session ID, N1 SM container) to the UE and
the steps 6, 7 are skipped.
If the message received from the SMF in step 3 does not include N2 SM Resource
Release request, the AMF transmits the NAS message (PDU Session ID, N1 SM
container) to the UE and the steps 6, 7 are skipped.
If the UE is in CM-CONNECTED state and the received message from the SMF in
step 3 includes N2 SM Resource Release request, the AMF transfers the SM
information received from the SMF in step 4 (N2 SM Resource Release request,
N1 SM container) to the (R)AN.
5\. When the (R)AN has received an N2 SM request to release the AN resources
associated with the PDU Session it issues AN specific signalling exchange(s)
with the UE to release the corresponding AN resources.
In the case of a NG-RAN, the NAS message is sent to the UE in an RRC message
which may take place with the UE releasing the NG-RAN resources related to the
PDU Session. If NG-RAN resources do not need to be released (i.e. the User
Plane of the PDU Session is deactivated), the NAS message is sent to the UE in
an RRC message which does not release the NG-RAN resources related to the PDU
Session.
During this procedure, the (R)AN sends any NAS message (N1 SM container (PDU
Session Release Command)) received from the AMF in step 5.
6\. [Conditional] If the (R)AN had received a N2 SM request to release the AN
resources, the (R)AN acknowledges the N2 SM Resource Release Request by
sending an N2 SM Resource Release Ack (User Location Information, Secondary
RAT usage data) Message to the AMF.
If the PLMN has configured secondary RAT usage reporting, the NG-RAN node may
provide RAN Usage Data Report.
7a. The AMF invokes the Nsmf_PDUSession_UpdateSMContext (N2 SM Resource
Release Ack (Secondary RAT usage data), User Location Information) to the SMF.
7b. The SMF responds to the AMF with an Nsmf_PDUSession_UpdateSMContext
response.
8\. The UE acknowledges the PDU Session Release Command by sending a NAS
message (PDU Session ID, N1 SM container (PDU Session Release Ack)) message
over the (R)AN.
9\. [Conditional] The (R)AN forwards the NAS message from the UE by sending a
N2 NAS uplink transport (NAS message (PDU Session ID, N1 SM container (PDU
Session Release Ack)), User Location Information) to the AMF.
10a. The AMF invokes the Nsmf_PDUSession_UpdateSMContext (N1 SM container (PDU
Session Release Ack, User Location Information) to the SMF.
10b. The SMF responds to the AMF with an Nsmf_PDUSession_UpdateSMContext
response.
Steps 8-10 may happen before steps 6-7.
11\. If steps 3a, 3b or 3d were performed, the SMF waits until it has received
replies to the N1 and N2 information provided in step 3, as needed.
The SMF invokes Nsmf_PDUSession_SMContextStatusNotify to notify AMF that the
SM context for this PDU Session is released. The AMF releases the association
between the SMF ID and the PDU Session ID, DNN, as well as S-NSSAI.
NOTE 5: The UE and the 5GC will get synchronized about the status of the
(released) PDU Session at the next Service Request or Registration procedure.
12\. If Dynamic PCC applied to this session the SMF invokes an SM Policy
Association Termination procedure as defined in clause 4.16.6 to delete the
PDU Session.
SMF notifies any entity that has subscribed to User Location Information
related with PDU Session change.
If it is the last PDU Session the SMF is handling for the UE for the
associated (DNN, S-NSSAI), the SMF unsubscribes from Session Management
Subscription data changes notification with the UDM by means of the
Nudm_SDM_Unsubscribe (SUPI, DNN, S-NSSAI) service operation. The UDM may
unsubscribe the subscription notification from UDR by Nudr_DM_Unsubscribe
(SUPI, Subscription Data, Session Management Subscription data, DNN, S-NSSAI).
The SMF invokes the Nudm_UECM_Deregistration service operation including the
DNN and the PDU Session Id. The UDM removes the association it had stored
between the SMF identity and the associated DNN and PDU Session Id. The UDM
may update this information by Nudr_DM_Update (SUPI, Subscription Data, UE
context in SMF data).
#### 4.3.4.3 UE or network requested PDU Session Release for Home-routed
Roaming
This procedure is used in the case of home-routed roaming scenarios.
Figure 4.3.4.3-1: UE or network requested PDU Session Release for home-routed
roaming
1\. The procedure is triggered by one of the following events:
1a. (UE initiated release) As in step 1a of clause 4.3.4.2 with the addition
that the V-SMF invokes the Nsmf_PDUSession_Update Request (SUPI, PDU Session
ID, information from the SM message from the UE e.g. PCO, \"Trigger PDU
Session Release\" indication, Timezone, User Location Information) service
operation to request the H-SMF to release the PDU Session. The H-SMF responds
to the request immediately.
1b. (Serving network initiated release) The serving network initiates the PDU
Session Release during UE or serving network initiated Deregistration
procedure as specified in clause 4.2.2.3. There is no NAS SM message between
the UE and the V-SMF in this case. The V-SMF initiates the release of the PDU
Session at the H-SMF by invoking the Nsmf_PDUSession_Release request.
1c. (HPLMN initiated release) This step is the same as step 1b in clause
4.3.4.2.
1d. This step is the same as step 1d in clause 4.3.4.2.
1e. (HPLMN initiated release) This step is the same as step 1e in clause
4.3.4.2.
If the SMF receives one of the triggers in step 1a, 1c or 1e, the H-SMF starts
PDU Session Release procedure.
2a-2b. These steps are the same as steps 2a-2b in clause 4.3.4.2. The SMF is
the SMF in HPLMN.
3a. (UE or HPLMN initiated release) The H-SMF prepares the SM Release PDU
Session Command message and initiates the PDU Session Release towards the UE
by invoking the Nsmf_PDUSession_Update Request service operation towards the
V-SMF. The Nsmf_PDUSession_Update Request contains necessary information to
build the SM Release PDU Session Command by the V-SMF towards the UE (for
example a Release Cause or PCO).
3b. (Serving network initiated release) The H-SMF responds to the PDU release
request from the V-SMF with a Nsmf_PDUSession_Release response.
4a-4b. The V-SMF releases the corresponding User Plane resources. This
includes the same procedure in step 2 but controlled from the SMF in VPLMN.
5-13. These steps are the same as steps 3-10 in clause 4.3.4.2.
14\. (UE or HPLMN initiated release) The V-SMF responds to the
Nsmf_PDUSession_Update Request invoked at step 3a and confirms the PDU Session
Release. The Nsmf_PDUSession_Update response may carry information such as PCO
received from the UE in SM PDU Session Release Accept. as well as User
Location Information, Time Zone and Secondary RAT Usage Data.
15\. (UE or HPLMN or Serving network initiated release) The H-SMF releases the
SM policy control association with the PCF by invoking the SM Policy
Association Termination procedure defined in clause 4.16.6. For serving
network initiated PDU Session Release case, this step happens between step 1b
and step 3b.
16\. (UE or HPLMN initiated release) The H-SMF shall remove all contexts
associated with the PDU Session.
16a. The H-SMF requests the V-SMF to release all contexts associated with the
PDU Session by invoking the Nsmf_PDUSession_StatusNotify (Release) operation.
16b. The V-SMF requests the AMF to release all contexts associated with the
PDU Session by invoking the Nsmf_PDUSession_SMContexStatusNotify (Release).
The AMF releases the association between the SMF ID and the PDU Session ID.
### 4.3.5 Session continuity, service continuity and UP path management
#### 4.3.5.1 Change of SSC mode 2 PDU Session Anchor with different PDU
Sessions
The following procedure is triggered by SMF in order to change the PDU Session
Anchor serving a PDU Session of SSC mode 2 for a UE when neither multi-homing
nor UL CL applies to the PDU Session. This procedure releases the existing PDU
Session associated with an old PDU Session Anchor (i.e. UPF1 in figure
4.3.5.1-1) and immediately establishes a new PDU Session with a new PDU
Session Anchor (i.e. UPF2 in figure 4.3.5.1-1) to the same DN.
Figure 4.3.5.1-1: Change of SSC mode 2 PSA for a PDU Session
1\. The SMF determines that the serving UPF needs to be changed due to events
that may benefit from such change.
2\. The PDU Session Release procedure is initiated as described in clause
4.3.4. The SMF sends an N1 SM Information to the UE via the AMF by invoking
Namf_Communication_N1N2MessageTransfer as described in Step 3b of clause
4.3.4.2. The PDU Session Release Command message in N1 SM Information contains
the PDU Session ID and Cause indicating that a PDU Session re-establishment to
the same DN is required.
3\. Upon reception of PDU Session Release Command with Cause indicating that a
PDU Session re-establishment to the same DN is required as sent in step 2, the
UE generates a new PDU Session ID and initiates PDU Session Establishment
procedure as described in clause 4.3.2.2. Then, the AMF selects an SMF as
described in clause 6.4.2 of TS 23.501 [2] and the SMF can select a new UPF
(i.e. UPF2) for the re-established PDU Session of SSC mode 2.
#### 4.3.5.2 Change of SSC mode 3 PDU Session Anchor with multiple PDU
Sessions
The following procedure is triggered by SMF in order to change the PDU Session
Anchor serving a PDU Session of SSC mode 3 for a UE. This procedure releases
the existing PDU Session associated with an old PDU Session Anchor (i.e. UPF1
in figure 4.3.5.2-1) after having established a new PDU Session to the same DN
with a new PDU Session Anchor (i.e. UPF2 in figure 4.3.5.2-1), which is
controlled by the same SMF. The SMF may determine that a new SMF needs to be
reallocated.
Figure 4.3.5.2-1: Change of SSC mode 3 PDU Session Anchor with multiple PDU
Sessions
1\. The SMF determines that the serving UPF or the SMF needs to be changed. If
the \"Indication of application relocation possibility\" attributes in the PCC
rule indicates no DNAI change takes place once selected for this application,
the SMF determines that the SMF can not be changed.
2\. The SMF invokes the Namf_Communication_N1N2MessageTransfer (PDU Session
ID, SMF Reallocation requested indication, N1 SM container (PDU Session
Modification Command (Cause, PCO (PDU Session Address Lifetime value)))) where
PDU Session ID indicates the existing PDU Session to be relocated and Cause
indicates that a PDU Session re-establishment to the same DN is required.
The SMF Reallocation requested indication indicates whether the SMF is
requested to be reallocated.
The PDU Session Address Lifetime value is delivered to the UE upper layers in
PCO and indicates how long the network is willing to maintain the PDU Session.
The SMF starts a PDU Session Release timer corresponding to the PDU Session
Address Lifetime value.
3a. The AMF forwards the NAS message to the UE. The UE can provide the release
timer value to the upper layers if received in the PDU Session Modification
Command.
3b. The UE acknowledges the PDU Session Modification Command.
3c. The AMF forwards the N1 SM container (PDU Session Modification Command
ACK) received from the (R)AN to the SMF1 via Nsmf_PDUSession_UpdateSMContext
service operation.
3d. The SMF1 replies with a Nsmf_PDUSession_UpdateSMContext Response.
4\. If the UE receives PDU Session Modification Command, the UE may decide to
initiate the PDU Session Establishment procedure described in clause 4.3.2.2,
to the same DN with the following differences:
In Step 1 of clause 4.3.2.2.1, according to the SSC mode, UE generates a new
PDU Session ID and initiates the PDU Session Establishment Request using the
new PDU Session ID. The new PDU Session ID is included as PDU Session ID in
the NAS request message and the Old PDU Session ID which indicates the
existing PDU Session to be released is also provided to AMF in the NAS request
message.
In Step 2 of clause 4.3.2.2.1, if SMF reallocation was requested in Step 2 of
this clause, the AMF selects a different SMF. Otherwise, the AMF sends the
Nsmf_PDUSession_CreateSMContext Request to the same SMF serving the Old PDU
Session ID.
In Step 3 of clause 4.3.2.2.1, the AMF include both PDU Session ID and Old PDU
Session ID in Nsmf_PDUSession_CreateSMContext Request. The SMF detects that
the PDU Session establishment request is related to the trigger in step 2
based on the presence of an Old PDU Session ID in the
Nsmf_PDUSession_CreateSMContext Request. The SMF stores the new PDU Session ID
and selects a new PDU Session Anchor (i.e. UPF2) for the new PDU Session.
5\. After the new PDU Session is established the UE starts using the IP
address/prefix associated with the new PDU Session for all new traffic and may
also proactively move existing traffic flow (where possible) from the old PDU
Session to the new PDU Session.
NOTE: The mechanisms used by the UE to proactively move existing traffic flows
from one IP address/prefix to another are outside the scope of 3GPP
specifications.
6\. The old PDU Session is released as described in clause 4.3.4 either by the
UE before the timer provided in step 3 expires (e.g. once the UE has
consolidated all traffic on new PDU Session or if the session is no more
needed) or by the SMF upon expiry of this timer.
#### 4.3.5.3 Change of SSC mode 3 PDU Session Anchor with IPv6 Multi-homed PDU
Session
Clause 4.3.5.3 describes a procedure for service continuity with SSC mode 3
that uses the multi-homed PDU Session described in clause 5.6.4.3 of TS 23.501
[2]. In this case the SMF prepares a new PDU Session Anchor first and then
notifies the UE of the existence of a new IP prefix, as depicted in figure
4.3.5.3-1. This procedure is applicable only to PDU Sessions of IPv6 type.
Figure 4.3.5.3-1: Change of PDU Session Anchor with IPv6 Multi homed PDU
Session
The UE has an established PDU Session with the PDU Session Anchor (i.e. UPF1
in Figure 4.3.5.3-1). The PDU Session\'s User Plane involves at least the
(R)AN and the PDU Session Anchor.
1\. At some point the SMF decides to allocate to the PDU Session the PDU
Session with a new PDU Session Anchor.
2\. The SMF selects a new UPF and using N4 configures the UPF as a new PDU
Session Anchor (i.e. UPF2 in Figure 4.3.5.3-1) of the multi-homed PDU Session.
In the process a new IPv6 prefix (IP\@2) is allocated for the PDU Session. If
the PCF has subscribed to the IP allocation/release event, the SMF performs a
Session Management Policy Modification procedure as defined in clause 4.16.5
to provide the new allocated IPv6 prefix to the PCF. The PCF invokes
Nbsf_Management_Register service operation to register the tuple (IPv6 prefix,
PCF id) for the PDU session identified by (SUPI, DNN, S-NSSAI) in the BSF.
3\. The SMF selects a Branching Point (BP) UPF as described in Clause of 6.3.3
of TS 23.501 [2]. The selection of BP UPF may consider the location of UPF1
and UPF2 to ensure a suitable location of the BP UPF relative to the UPF1 and
the UPF2.
NOTE 1: If BP UPF is co-located with one of PDU Session Anchors, steps between
SMF and BP UPF can be skipped.
4\. The SMF configures via N4 the UPF selected in step 3 (BP UPF in Figure
4.3.5.3-1) as a Branching Point for the multi-homed PDU Session. It provides
the Branching Point with the necessary UL traffic forwarding rules (related
with the prefix of the IPv6 source address of UL traffic). Also, the SMF
provides AN Tunnel Info for N3 tunnel setup and CN Tunnel Info for N9 tunnel
setup to the BP UPF and obtains CN Tunnel Info from the BP UPF.
5-6. The SMF performs N4 Session Modification procedure with PSAs. During this
procedure, the SMF provides CN Tunnel Info received from the BP UPF to set up
an N9 tunnel between BP and PSAs.
7\. The SMF invokes the Namf_Communication_N1N2MessageTransfer service
operation containing N2 SM Information with CN Tunnel Info for the N3 tunnel
setup.
8\. The AMF sends an N2 Request including N2 SM Information received from the
SMF to the (R)AN. The (R)AN acknowledges to the AMF with an N2 Response.
9a. The AMF carries the N2 Response sent by the (R)AN to the SMF by invoking
the Nsmf_PDUSession_UpdateSMContext service operation.
9b. The SMF responds to Nsmf_PDUSession_UpdateSMContext service operation from
the AMF.
10-11. The SMF notifies the UE of the availability of the new IP prefix. This
is performed using an IPv6 Router Advertisement message (RFC 4861 [6]). The
SMF sends a Router Advertisement to the UE via the new PSA with a new prefix
(IP\@2) and sends another Router Advertisement to the UE via the old PSA with
the old prefix (IP\@1) and zero value in the preferred lifetime field and a
value in the valid lifetime field according to RFC 4862 [8]. The UE shall
update the valid lifetime of the old prefix (IP\@1) to the signalled value
regardless of the remaining lifetime. The valid lifetime value indicates the
time how long the SMF is willing to keep the old prefix. The valid lifetime
value may be decided by SMF based on local configuration.
The UE starts using IP\@2 for all new traffic and may also proactively move
existing traffic flow (where possible) from IP\@1 to IP\@2.
NOTE 2: The mechanisms used by the UE to proactively move existing traffic
flows from one IP prefix to another are outside the scope of 3GPP
specifications.
12\. After the timer expires, the SMF releases the UE\'s old IPv6 prefix
(IP\@1). At this point the UE implicitly releases the old IP prefix. The SMF
sends an N4 Session Modification Request to the BP to release UP resource for
N9 tunnel between the BP and old PSA.
13\. The SMF releases the old PDU Session context with the old PDU Session
Anchor (UPF1 in Figure 4.3.5.3-1). If the PCF has subscribed to the IP
allocation/release event, the SMF performs a Session Management Policy
Modification procedure as defined in clause 4.16.5 to notify the PCF of the
IPv6 prefix release. The PCF shall invoke Nbsf_Management_Unregister service
operation to remove the tupe (IPv6prefix, PCF id) for the PDU session
identified by (SUPI, DNN,S-NSSAI) in BSF.
14-18. The SMF may optionally release the Branching Point from the User Plane
path.
#### 4.3.5.4 Addition of additional PDU Session Anchor and Branching Point or
UL CL
Clause 4.3.5.4 describes a procedure to add a PDU Session Anchor and a
Branching Point or UL CL for an established PDU Session.
Figure 4.3.5.4-1: Addition of additional PDU Session Anchor and Branching
Point or UL CL
1\. UE has an established PDU Session with a UPF including the PDU Session
Anchor 1 (PSA1 in Figure 4.3.5.4-1). The PDU Session User Plane involves at
least the (R)AN and the PDU Session Anchor 1.
2\. At some point the SMF decides to establish a new PDU Session Anchor e.g.
due to UE mobility, new flow detection. The SMF selects a UPF and using N4
establish the new PDU Session Anchor 2 (PSA2 in Figure 4.3.5.4-1) of the PDU
Session. In the case of IPv6 multi-homing PDU Session, the SMF also allocates
a new IPv6 prefix corresponding to PSA2 and if the PCF has subscribed to the
IP allocation/release event, the SMF performs the Session Management Policy
Modification procedure as defined in clause 4.16.5 to provide the new
allocated IPv6 prefix to the PCF.
3\. The SMF selects a UPF and using N4 establish the Branching Point (in the
case of IPv6 multi-homing) or a UL CL for the PDU Session. It provides the
necessary uplink forwarding rules towards PSA1 and PSA2 including the PSA1 CN
Tunnel Info and the PSA2 CN Tunnel Info. In addition, the AN Tunnel Info is
provided for downlink forwarding. In the case of IPv6 multi-homing, the SMF
also provides traffic filters for the IPv6 prefixes corresponding to PSA1 and
PSA2 indicating what traffic shall be forwarded towards PSA1 and PSA2
respectively. In the case of UL CL, the SMF provides traffic filters
indicating what traffic shall be forwarded towards PSA1 and PSA2 respectively.
NOTE 1: If the Branching Point or UL CL and the PSA2 are co-located in a
single UPF then steps 2 and 3 can be merged. If a Branching Point is already
allocated, step 3 is skipped.
4\. The SMF updates the PSA1 via N4. It provides the Branching Point or UL CL
CN Tunnel Info for the downlink traffic.
NOTE 2: If the Branching Point or UL CL and the PSA1 are co-located in a
single UPF then steps 3 and 4 can be merged.
5\. The SMF updates PSA2 via N4. It provides the Branching Point or UL CL CN
Tunnel Info for down-link traffic.
NOTE 3: If the Branching Point or UL CL and the PSA2 are co-located in a
single UPF then step 5 is not needed.
6\. The SMF updates (R)AN via N2 SM information over N11. It provides the new
CN Tunnel Info corresponding to the UPF (Branching Point or UL CL). In the
case of UL CL, if there is an existing UPF between the (R)AN and new inserted
UL CL, the SMF updates the existing UPF via N4 instead of updating the (R)AN.
7\. In the case of IPv6 multi-homing, the SMF notifies the UE of the
availability of the new IP prefix @ PSA2. This is performed using an IPv6
Router Advertisement message (RFC 4861 [6]). Also, the SMF sends IPv6 multi-
homed routing rule along with the IPv6 prefix to the UE using an IPv6 Router
Advertisement message (RFC 4191 [21]) as described in clause 5.8.2.2.2 of TS
23.501 [2].
8\. In the case of IPv6 multi-homing, the SMF may re-configure the UE for the
original IP prefix @ PSA1,i.e. SMF sends IPv6 multi-homed routing rule along
with the IPv6 prefix to the UE using an IPv6 Router Advertisement message (RFC
4191 [21]) as described in clause 5.8.2.2.2 of TS 23.501 [2].
#### 4.3.5.5 Removal of additional PDU Session Anchor and Branching Point or
UL CL
Clause 4.3.5.5 describes a procedure to remove a PDU Session Anchor and
(optionally) remove Branching Point or UL CL for an established PDU Session.
Figure 4.3.5.5-1: Removal of additional PDU Session Anchor and Branching Point
or UL CL
1\. UE has an established PDU Session with a UPF including the Branching Point
or UL CL, the PDU Session Anchor 1 (PSA1 in Figure 4.3.5.5-1) and the PDU
Session Anchor 2 (PSA2 in Figure 4.3.5.5-1).
At some point the SMF decides to remove the PDU Session Anchor 1 e.g. due to
UE mobility, flow terminated.
2\. In the case of IPv6 multi-homing, the SMF notifies the UE to stop using
the IPv6 prefix corresponding to PSA1. This is performed by IPv6 Router
Advertisement message (RFC 4861 [6] and RFC 4862 [8]). Also, the SMF sends
IPv6 multi-homed routing rule along with the IPv6 prefix corresponding to PSA2
to the UE as described in clause 5.8.2.2.2 of TS 23.501 [2]. Based on the
information provided in the Router Advertisement, the UE starts using the IPv6
prefix (corresponding to PSA2) for all the traffic.
4\. If the Branching Point or UL CL is to be released, the SMF updates the
(R)AN with the PSA2 CN Tunnel Info. In the case of UL CL, if there is an
existing UPF between the (R)AN and the UL CL to be removed, the SMF updates
the existing UPF via N4 instead of updating the (R)AN.
5\. If the Branching Point or UL CL is to be released, the SMF updates via N4
the PSA2 providing the AN Tunnel Info. In the case of UL CL, if there is an
existing UPF between the (R)AN and the UL CL to be removed, the SMF updates
the PSA2 providing the UPF CN tunnel Info.
6\. The SMF releases via N4 the PSA1. In the case of IPv6 multi-homing, the
SMF also releases the corresponding IPv6 prefix and if the PCF has subscribed
to the IP allocation/release event, the SMF performs the Session Management
Policy Modification procedure as defined in clause 4.16.5 to notify the PCF of
the IPv6 prefix release.
7\. If steps 4 and 5 were executed, the SMF releases the Branching Point / UL
CL.
#### 4.3.5.6 Change of additional PDU Session Anchor for IPv6 multi-homing or
UL CL
The following procedure is triggered by an SMF when the SMF needs to modify
IPv6 multi-homing or UL CL rule (i.e. traffic filter in the Branching Point or
the UL CL) in order to move the some or whole traffic flows of the existing
additional PDU Session Anchor which was established by the IPv6 multi-homing
or the UL CL operations (i.e. PSA1 in figure 4.3.5.6-1) to a new additional
PDU Session Anchor (i.e. PSA2 in figure 4.3.5.6-1) which is established under
the same Branching Point or UL CL for a UE where the UE already has a PDU
Session Anchor which was established before the event of Branching Point or UL
CL insertion (i.e. PSA0 in figure 4.3.5.6-1). This procedure establishes a new
additional PDU Session Anchor (i.e. PSA2) and conditionally releases the
existing additional PDU Session Anchor (i.e. PSA1), while modifying IPv6
multi-homing or UL CL rule in the same Branching Point or UL CL under
controlled by the same SMF.
Figure 4.3.5.6-1: Change of additional PSA for a PDU Session in IPv6 multi-
homing or UL CL case
1\. The SMF decides to change one additional PSA of a PDU Session with IPv6
multi-homing or UL CL, due to events that may benefit from such change or upon
request from an Application Function.
2\. The SMF sends an N4 Session Establishment Request to PSA2 and provides the
tunnel ID of Branching Point or UL CL, Packet detection, enforcement and
reporting rules to be installed on the PSA2 for this PDU Session. If a tunnel
ID is allocated by the SMF, the tunnel ID is provided to PSA2 in this step.
The PSA2 acknowledges by sending an N4 Session Establishment Response. The
tunnel ID of PSA2 is provided to the SMF in this step.
In the case of IPv6 multi-homing PDU Session, the SMF also allocates a new
IPv6 prefix corresponding to PSA2 and if the PCF has subscribed to the IP
allocation/release event, the SMF performs the Session Management Policy
Modification Procedure as defined in clause 4.16.5 to provide the new
allocated IPv6 prefix to the PCF.
3a. The SMF sends an N4 Session Modification Request to the Branching Point or
UL CL to update the UL traffic filter according to new allocated IPv6 prefix
allocated to PSA 2 or the UL CL rules regarding to the traffic flows that the
SMF tries to move from PSA1 to PSA2. The N4 Session Modification Request
message contains the identifications of traffic filter that needs to be
updated and the tunnel ID of PSA2.
NOTE: The identification of a traffic filter can be either the index of the
traffic filter, or a single value of the information field in traffic filter
(e.g. the tunnel ID of next hop), or a combination value of some information
field in the traffic filter (e.g. the tunnel ID of next hop with source port
number).
3b. The Branching Point or the UL CL acknowledges by N4 Session Modification
Response the Branching Point or when the UL CL successfully updates all the
traffic filters that the SMF requests to modify.
4\. In the case of IPv6 multi-homing PDU Session, The SMF notifies the UE of
the availability of the new IP prefix @ PSA2. This is performed using an IPv6
Router Advertisement message (RFC 4861 [6]). Also, the SMF sends IPv6 multi-
homed routing rule along with the IPv6 prefix to the UE using an IPv6 Router
Advertisement message (RFC 4191 [21]) as described in clause 5.8.2.2.2 of TS
23.501 [2].
5\. In the case of IPv6 multi-homing PDU Session, The SMF may re-configure the
UE for the original IP prefix @ PSA0,i.e. SMF sends IPv6 multi-homed routing
rule along with the IPv6 prefix to the UE using an IPv6 Router Advertisement
message (RFC 4191 [21]) as described in clause 5.8.2.2.2 of TS 23.501 [2].
6\. Step 6 occurs only if the Branching Point or UL CL does not have any
traffic filter on the PDU Session which forwards a traffic flow to PSA1.
6a. The SMF sends an N4 Session Release Request with N4 session ID to PSA1.
The PSA1 shall release all tunnel resources and contexts associated with the
N4 session.
6b. PSA1 sends an N4 Session Release Response with N4 session ID to the SMF at
the same moment that PSA1 successfully releases all tunnel resources and
contexts associated with the N4 session.
#### 4.3.5.7 Simultaneous change of Branching Point or UL CL and additional
PSA for a PDU Session
Simultaneous change of UL CL or Branching Point and additional PSA can be
performed after Xn based handover, N2 based handover and Service Request
procedures.
The following procedure is triggered by SMF in order to change the Branching
Point or the UL CL and additional PSA serving a PDU Session for a UE.
Figure 4.3.5.7-1: Simultaneous change of Branching Point or UL CL and
additional PSA for a PDU Session
UE has an established PDU Session with a UPF including the PDU Session Anchor
(Remote UPF). The PDU Session user plane involves at least the Source (R)AN,
Source Branching Point or Source UL CL, local Source UPF (PSA2) and the Remote
UPF (PDU Session Anchor, PSA1), where Source Branching Point or Source UL CL
and PSA2 can be co-located.
1\. At some point SMF decides to change the Branching Point or the UL CL due
to UE mobility.
2\. The SMF selects a local Target UPF (PSA3) and using N4 establishes the
local Target UPF for the PDU Session. In the case of IPv6 multi-homing PDU
Session, the SMF also allocates a new IPv6 prefix corresponding to PSA3 and if
the PCF has subscribed to the IP allocation/release event, the SMF performs
the Session Management Policy Modification procedure as defined in clause
4.16.5 to provide the new allocated IPv6 prefix to the PCF.
3\. The SMF selects a UPF and using N4 establishes the Target Branching Point
or Target UL CL for the PDU Session. SMF provides the necessary uplink
forwarding rules towards the PSA3 and PSA1 including the Tunnel Info for each
UPF. In addition, the AN Tunnel Info to target (R)AN is provided for downlink
forwarding. In the case of UL CL, the SMF provides traffic filters indicating
what traffic shall be forwarded towards PSA3 and PSA1, respectively. In the
case of IPv6 multi-homing, the SMF also provides traffic filters for the IPv6
prefixes corresponding to PSA3 and PSA1 indicating what traffic shall be
forwarded towards PSA3 and PSA1 respectively. Target Branching Point or Target
UL CL provides the CN Tunnel Info for downlink traffic.
NOTE 1: If the Target Branching Point or Target UL CL and the PSA3 are co-
located in a single UPF then steps 2 and 3 can be merged.
4\. The SMF updates the PSA1 via N4. It provides the PDU Session CN Tunnel
Info for the downlink traffic.
5\. The SMF updates the PSA3. It provides the CN Tunnel Info for downlink
traffic.
NOTE 2: If the Target Branching Point or the Target UL CL and the PSA3 are co-
located in a single UPF then step 5 is not needed.
6\. The SMF updates (R)AN via N2 SM information over N11. It provides the new
CN Tunnel Info corresponding to the Target Branching Point or the Target UL
CL. If there is an existing UPF between the Target (R)AN and Target Branching
Point or Target UL CL, the SMF updates the existing UPF via N4 instead of
updating the (R)AN.
7\. In the case of IPv6 multi-homing, the SMF notifies the UE of the
availability of the new IP prefix @ PSA3. This is performed using an IPv6
Router Advertisement message (RFC 4861 [6]). Also, the SMF sends IPv6 multi-
homed routing rule along with the IPv6 prefix to the UE using an IPv6 Router
Advertisement message (RFC 4191 [21]) as described in clause 5.8.2.2.2 of TS
23.501 [2].
8\. In the case of IPv6 multi-homing, the SMF may re-configure the UE for the
original IP prefix @ PSA1, i.e. SMF sends IPv6 multi-homed routing rule along
with the IPv6 prefix to the UE using an IPv6 Router Advertisement message (RFC
4191 [21]) as described in clause 5.8.2.2.2 of TS 23.501 [2].
9\. The SMF releases via N4 the PSA2.
10\. The SMF releases the Source Branching Point or the Source UL CL.
NOTE 3: If the Target Branching Point or Target UL CL and the PSA2 are co-
located in a single UPF then steps 9 and 10 can be merged.
### 4.3.6 Application Function influence on traffic routing
#### 4.3.6.1 General
Clause 4.3.6 describes the procedures between an Application Function and the
SMF to maintain an efficient user plane path for Application Functions that
require it.
As described in clause 5.6.7 of TS 23.501 [2], an Application Function may
send requests to influence SMF routeing decisions for User Plane traffic of
PDU Sessions. The AF requests may influence UPF (re)selection and allow
routeing of user traffic to a local access (identified by a DNAI) to a Data
Network. The AF may also provide in its request subscriptions to SMF events.
The following cases can be distinguished:
\- AF requests targeting an individual UE by a UE address; these requests are
routed (by the AF or by the NEF) to an individual PCF using the BSF. This is
described in clause 4.3.6.4.
NOTE 1: Such requests target an on-going PDU Session. Whether the AF needs to
use the NEF or not is according to local deployment.
\- AF requests described in clause 5.6.7 of TS 23.501 [2] targeting a group of
UE(s), or any UE accessing a combination of DNN and S-NSSAI, or targeting
individual UE by a GPSI as described in table 5.6.7-1. These AF requests may
also affect UE(s) with an established PDU session. For such requests the AF
shall contact the NEF and the NEF stores the AF request information in the
UDR. PCF(s) receive a corresponding notification if they had subscribed to the
creation / modification/ deletion of the AF request information corresponding
to UDR Data Keys / Data Sub-Keys. This is defined in clause 6.3.7.2 of TS
23.501 [2] and further described in clause 4.3.6.2.
NOTE 2: Such requests can target on-going or future PDU Sessions.
If the AF interacts with PCF via the NEF, the NEF performs the following
mappings where needed:
\- Map the AF-Service-Identifier into DNN and S-NSSAI combination, determined
by local configuration.
\- Map the AF-Service-Identifier into a list of DNAI(s) and Routing Profile
ID(s) determined by local configuration.
The NEF can only provide this mapping when the DNAI(s) being used by the
applications are statically defined. When the DNAI(s) where applications are
instantiated may vary dynamically, the AF should provide the target DNAI(s) in
its request together with either Routing Profile ID(s) or with N6 traffic
routing information.
\- Map the GPSI in Target UE Identifier into SUPI, according to information
received from UDM.
\- Map the External Group Identifier in Target UE Identifier into Internal
Group Identifier, according to information received from UDM.
\- Map the geographic zone identifier(s) in Spatial Validity Condition into
areas of validity, determined by local configuration.
#### 4.3.6.2 Processing AF requests to influence traffic routing for Sessions
not identified by an UE address
Figure 4.3.6.2-1: Processing AF requests to influence traffic routing for
Sessions not identified by an an UE address
NOTE 1: The 5GC functions used in this scenario are assumed to all belong to
the same PLMN (HPLMN in non-roaming case or VPLMN in the case of a PDU Session
in LBO mode).
NOTE 2: Nnef_TrafficInfluence_Create or Nnef_TrafficInfluence_Update or
Nnef_TrafficInfluence_Delete service operations invoked from an AF located in
the HPLMN for local breakout and home routed roaming scenarios are not
supported.
1\. To create a new request, the AF invokes an Nnef_TrafficInfluence_Create
service operation. The content of this service operation (AF request) is
defined in clause 5.2.6.7. The request contains also an AF Transaction Id. If
it subscribes to events related with PDU Sessions the AF indicates also where
it desires to receive the corresponding notifications (AF notification
reporting information).
To update or remove an existing request, the AF invokes an
Nnef_TrafficInfluence_Update or Nnef_TrafficInfluence_Delete service operation
providing the corresponding AF Transaction Id.
2\. The AF sends its request to the NEF. If the request is sent directly from
the AF to the PCF, the AF reaches the PCF selected for the existing PDU
Session by configuration or by invoking Nbsf_management_Discovery service.
The NEF ensures the necessary authorization control, including throttling of
AF requests and, as described in clause 4.3.6.1, mapping from the information
provided by the AF into information needed by the 5GC.
3\. (in the case of Nnef_TrafficInfluence_Create or Update): The NEF stores
the AF request information in the UDR (Data Set = Application Data; Data
Subset = AF traffic influence request information, Data Key = AF Transaction
Internal ID, S-NSSAI and DNN and/or Internal Group Identifier or SUPI).
NOTE 3: Both the AF Transaction Internal ID and, S-NSSAI and DNN and/or
Internal Group Identifier or SUPI are regarded as Data Key when the AF request
information are stored into the UDR, see Table 5.2.12.2.1-1.
(in the case of Nnef_TrafficInfluence_delete): The NEF deletes the AF
requirements in the UDR (Data Set = Application Data; Data Subset = AF traffic
influence request information, Data Key = AF Transaction Internal ID).
The NEF responds to the AF.
4\. The PCF(s) that have subscribed to modifications of AF requests (Data Set
= Application Data; Data Subset = AF traffic influence request information,
Data Key = S-NSSAI and DNN and/or Internal Group Identifier or SUPI)
receive(s) a Nudr_DM_Notify notification of data change from the UDR.
5\. The PCF determines if existing PDU Sessions are potentially impacted by
the AF request. For each of these PDU Sessions, the PCF updates the SMF with
corresponding new PCC rule(s) by invoking Npcf_SMPolicyControl_UpdateNotify
service operation as described in steps 5 and 6 in clause 4.16.5.
If the AF request includes a notification reporting request for UP path
change, the PCF includes in the PCC rule(s) the information required for
reporting the event, including the Notification Target Address pointing to the
NEF or AF and the Notification Correlation ID containing the AF Transaction
Internal ID.
6\. When a PCC rule is received from the PCF, the SMF may take appropriate
actions to reconfigure the User plane of the PDU Session such as:
\- Adding, replacing or removing a UPF in the data path to e.g. act as an UL
CL or a Branching Point e.g. as described in clause 4.3.5.
\- Allocate a new Prefix to the UE (when IPv6 multi-Homing applies)
\- Updating the UPF in the target DNAI with new traffic steering rules
Subscribe to notifications from the AMF for an Area Of Interest via
Namf_EventExposure_Subscribe service operation
#### 4.3.6.3 Notification of User Plane Management Events
The SMF may send a notification to the AF if the AF had subscribed to user
plane management event notifications as described in clause 4.3.6.2 and in
clause 5.6.7 of TS 23.501 [2]. The following are the examples of such events:
\- A PDU Session Anchor identified in the AF subscription request has been
established or released.
\- A DNAI has changed.
\- The SMF has received a request for AF notification and the on-going PDU
Session meets the conditions to notify the AF.
The SMF uses notification reporting information received from PCF to issue the
notification either via an NEF (2a, 2b and 4a, 4b) or directly to the AF (2c
and 4c).
The following flow depicts the sequence of events:
Figure 4.3.6.3-1: Notification of user plane management event
1\. A condition for an AF notification has been met as described above. The
SMF sends notification to the NF that is subscribed for SMF notifications.
Further processing of the SMF notification depends on the receiving NF, as
shown in steps 2a and 2c.
2a. If early notification via NEF is requested by the AF, the SMF notifies the
NEF of the target DNAI of the PDU Session by invoking
Nsmf_EventExposure_Notify service operation.
2b. When the NEF receives Nsmf_EventExposure_Notify, the NEF performs
information mapping (e.g. AF Transaction Internal ID provided in Notification
Correlation ID to AF Transaction ID, SUPI to GPSI, etc.) as applicable
according to clause 5.6.7 of TS 23.501 [2] and triggers the appropriate
Nnef_TrafficInfluence_Notify message. In this case, step 2c is not applicable.
2c. If early direct notification is requested by the AF, the SMF notifies the
AF of the target DNAI of the PDU Session by invoking Nsmf_EventExposure_Notify
service operation.
3\. The SMF enforces the change of DNAI or addition, change, or removal of a
UPF. The SMF sends notification to the NF that is subscribed for SMF
notifications. Further processing of the SMF notification depends on the
receiving NF, as shown in steps 4a and 4c.
4a. If late notification via NEF is requested by the AF, the SMF notifies the
NEF of the selected target DNAI of the PDU Session by invoking
Nsmf_EventExposure_Notify service operation.
4b. When the NEF receives Nsmf_EventExposure_Notify, the NEF performs
information mapping (e.g. AF Transaction Internal ID provided in Notification
Correlation ID to AF Transaction ID, SUPI to GPSI, etc.) as applicable
according to clause 5.6.7 of TS 23.501 [2] and triggers the appropriate
Nnef_EventExposure_Notify message. In this case, step 4c is not applicable.
4c. If late direct notification is requested by the AF, the SMF notifies the
AF of the selected target DNAI of the PDU Session by invoking
Nsmf_EventExposure_Notify service operation.
#### 4.3.6.4 Transferring an AF request targeting an individual UE address to
the relevant PCF
Figure 4.3.6.4-1: Handling an AF request targeting an individual UE address to
the relevant PCF
Depending on the AF deployment (see clause 6.2.10 of TS 23.501 [2]), the AF
may send the AF request to PCF directly, in which case step 1 is skipped, or
via the NEF.
1\. [Conditional] If the AF sends the AF request via NEF, the AF sends
Nnef_TrafficInfluenceCreate/Update/Delete Request targeting an individual UE
address to the NEF. This request corresponds to an AF request to influence
traffic routing that targets an individual UE address.
When NEF receives an AF request from AF, the NEF ensures the necessary
authorization control and, as described in clause 4.3.6.1, mapping from the
information provided by the AF into information needed by the 5GC. The NEF
responds to the AF.
2\. [Conditional] AF/NEF consumes Nbsf_Management_Discovery service operation
(providing at least the UE address) to find out the address of the relevant
PCF if the PCF address is not available on the NEF based on local
configuration, otherwise step 1 is skipped.
NOTE: The AF/NEF finds the BSF based on local configuration or using the NRF.
3\. BSF provides the PCF address in the Nbsf_Management_Discovery response to
AF/NEF.
4\. If step 1 was performed, NEF invokes the Npcf_PolicyAuthorization service
to the PCF to transfer the AF request. If an AF sends the AF request directly
to the PCF, AF invokes Npcf_PolicyAuthorization service and the PCF responds
to the AF.
5\. The PCF updates the SMF with corresponding new PCC rule(s) with PCF
initiated SM Policy Association Modification procedure as described in clause
4.16.5.2. When a PCC rule is received from the PCF, the SMF may take
appropriate actions, when applicable, to reconfigure the User plane of the PDU
Session, such as:
\- Adding, replacing or removing UPF(s) in the data path, e.g. to act as UL
CL, Branching Point and/or PDU Session Anchor e.g. as described in clause
4.3.5.
\- Allocate a new Prefix to the UE (when IPv6 multi-Homing applies).
\- Updating the UPF regarding the target DNAI with new traffic steering rules.
\- Subscribe to notifications from the AMF for an Area Of Interest via
Namf_EventExposure_Subscribe service operation.
### 4.3.7 CN-initiated selective deactivation of UP connection of an existing
PDU Session
The following procedure is used to deactivate UP connection (i.e. data radio
bearer and N3 tunnel) for an established PDU Session of a UE in CM-CONNECTED
state.
For an always-on PDU Session, the SMF should not configure the UPF to report
inactivity.
Figure 4.3.7-1: CN-initiated deactivation of UP connection for an established
PDU Session
1\. The SMF determines that the UP connection of the PDU Session can be
deactivated in following cases:
\- During handover procedure, if all the QoS Flows of a PDU Session are
rejected by the target NG-RAN (as described in clause 4.9.1), or if a PDU
Session is failed to setup indicated by the AMF (see step 7 of clause
4.9.1.3.3). SMF proceeds with step 2 and step 3, the steps 5 to 9 are skipped;
\- The UPF detects that the PDU Session has no data transfer for a specified
Inactivity period as described in clause 4.4.2.2;
\- For a LADN PDU Session, the AMF notifies to the SMF that the UE moved out
of the LADN service area; or
\- The AMF notifies to the SMF that the UE moved out of the Allowed Area.
The SMF may decide to release the UPF of N3 terminating point. In that case
the SMF proceeds with step 2 and step 3. Otherwise, if the SMF decides to keep
the UPF of N3 terminating points, the SMF proceeds with step 4.
2\. The SMF may initiate an N4 Session Release procedure to release the
intermediate UPF of N3 terminating point. If there are multiple intermediate
UPFs, this step can be performed for each UPFs to be released. The SMF needs
to initiate N4 Session Modification procedure to the UPF (i.e. N9 terminating
point or PDU Session Anchor) connecting to the released UPF in step 3.
3\. If the intermediate UPF(s) of N3 terminating point is released in step 2,
the SMF initiates an N4 Session Modification procedure towards the UPF (PDU
Session Anchor or another intermediate UPF) connecting to the released UPF,
indicating the need to remove CN Tunnel Info for N9 tunnel of the
corresponding PDU Session. In this case, the UPF connecting to the released
UPF buffers the DL packets for this PDU Session or drops the DL packets for
this PDU session or forwards the DL packets for this PDU session to the SMF,
based on buffering instruction provided by the SMF as described in clause
5.8.3.2 or clause 5.8.3.3 of TS 23.501 [2]. If the PDU Session corresponds to
a LADN and the UE moved out of the LADN service area, the SMF may notify the
UPF connecting to the released UPF to discard downlink data for the PDU
Sessions and/or to not provide further Data Notification messages.
Otherwise, N4 Session Modification procedure occurs toward N3 terminating
point.
4\. If the UPF of N3 terminating point is not released in step 2, the SMF
initiates an N4 Session Modification procedure indicating the need to remove
AN Tunnel Info for N3 tunnel of the corresponding PDU Session. In this case,
the UPF buffers the DL packets for this PDU Session or drops the DL packets
for this PDU session or forwards the DL packets for this PDU session to the
SMF, based on buffering instruction provided by the SMF as described in clause
5.8.3.2 or clause 5.8.3.3 of TS 23.501 [2]. If the PDU Session corresponds to
a LADN and the UE moved out of the LADN service area, the SMF may notify the
UPF to discard downlink data for the PDU Sessions and/or to not provide
further Data Notification messages.
5\. The SMF invokes the Namf_Communication_N1N2MessageTransfer service
operation (PDU Session ID, N2 SM Information (N2 Resource Release Request (PDU
Session ID))) to release the NG-RAN resources associated with the PDU Session.
6\. The AMF sends the N2 PDU Session Resource Release Command including N2 SM
information (N2 Resource Release Request (PDU Session ID)) received from the
SMF via N2 to the NG-RAN.
7\. The NG-RAN may issue NG-RAN specific signalling exchange (e.g. RRC
Connection Reconfiguration) with the UE to release the NG-RAN resources
related to the PDU Session received from the AMF in step 5. When a User Plane
connection for a PDU Session is released, the AS layer in the UE indicates it
to the NAS layer.
8\. The NG-RAN acknowledges the N2 PDU Session Resource Release Command to the
AMF including N2 SM Resource Release Ack (User Location Information, Secondary
RAT Usage Data).
9\. The AMF invokes the Nsmf_PDUSession_UpdateSMContext service operation (N2
SM Information(Secondary RAT Usage Data)) to acknowledge the Namf service
received in step 5.
## 4.4 SMF and UPF interactions
### 4.4.1 N4 session management procedures
#### 4.4.1.1 General
N4 session management procedures are used to control the functionality of the
UPF. The SMF can create, update and remove the N4 session context in the UPF,
which is described in clause 5.8.2 of TS 23.501 [2].
The following N4 session management procedures exist: N4 Session Establishment
procedure, N4 session Modification procedure and N4 session release procedure.
All of them are initiated by the SMF.
#### 4.4.1.2 N4 Session Establishment procedure
The N4 Session Establishment procedure is used to create the initial N4
session context for a PDU Session at the UPF. The SMF assigns a new N4 Session
ID and provides it to the UPF. The N4 Session ID is stored by both entities
and used to identify the N4 session context during their interaction. The SMF
also stores the relation between the N4 Session ID and PDU Session for a UE.
Figure 4.4.1.2-1 N4 Session Establishment procedure
1\. SMF receives the trigger to establish a new PDU Session or change the UPF
for an established PDU Session.
2\. The SMF sends an N4 session establishment request message to the UPF that
contains the structured control information which defines how the UPF needs to
behave.
3\. The UPF responds with an N4 session establishment response message
containing any information that the UPF has to provide to the SMF in response
to the control information received.
4\. The SMF interacts with the network function which triggered this procedure
(e.g. AMF or PCF).
#### 4.4.1.3 N4 Session Modification procedure
The N4 Session Modification procedure is used to update the N4 session context
of an existing PDU Session at the UPF, which is executed between SMF and UPF
whenever PDU Session related parameters have to be modified.
Figure 4.4.1.3-1 N4 Session Modification procedure
1\. SMF receives the trigger to modify the existing PDU Session.
2\. The SMF sends an N4 session modification request message to the UPF that
contains the update for the structured control information which defines how
the UPF needs to behave.
3\. The UPF identifies the N4 session context to be modified by the N4 Session
ID. Then, the UPF updates the parameters of this N4 session context according
to the list of parameters sent by the SMF. The UPF responds with an N4 session
modification response message containing any information that the UPF has to
provide to the SMF in response to the control information received.
4\. The SMF interacts with the network entity which triggered this procedure
(e.g. AMF or PCF).
#### 4.4.1.4 N4 Session Release procedure
The N4 session release procedure is used to remove the N4 session context of
an existing PDU Session at the UPF.
Figure 4.4.1.4-1 N4 Session Release procedure
1\. SMF receives the trigger to remove the N4 session context for the PDU
Session.
2\. The SMF sends an N4 session release request message to the UPF.
3\. The UPF identifies the N4 session context to be removed by the N4 Session
ID and removes the whole session context. The UPF responds with an N4 session
release response message containing any information that the UPF has to
provide to the SMF.
4\. The SMF interacts with the network entity which triggered this procedure
(e.g. AMF or PCF).
### 4.4.2 N4 Reporting Procedures
#### 4.4.2.1 General
The N4 reporting procedure is used by the UPF to report events to the SMF.
#### 4.4.2.2 N4 Session Level Reporting Procedure
This procedure is used by the UPF to report events related to an N4 session
for an individual PDU Session. The triggers for event reporting were
configured on the UPF during N4 Session Establishment/Modification procedures
by the SMF.
Figure 4.4.2.2-1: N4 Session Level Reporting procedure
1\. The UPF detects that an event has to be reported. The reporting triggers
include the following cases:
(1) Usage report.
Usage information shall be collected in the UPF and reported to the SMF as
defined in clause 5.8 and clause 5.12 of TS 23.501 [2].
(2) Start of traffic detection.
When traffic detection is requested by SMF and the start of traffic is
detected for a Packet Detection Rule (PDR) as described in clause 5.8 of TS
23.501 [2], the UPF shall report the start of traffic detection to the SMF and
indicate the corresponding PDR rule ID.
(3) Stop of traffic detection.
When traffic detection is requested by SMF and the end of traffic is detected
for a PDR as described in clause 5.8 of TS 23.501 [2], the UPF shall report
the stop of traffic detection to the SMF and indicate the corresponding PDR
rule ID.
(4) Detection of 1st downlink data for PDU Session with UP Connection
deactivated.
When UPF receives the downlink packet but no N3/N9 tunnel for downlink data
transmission exists and the buffering is performed by the UPF, it shall report
the detection of 1st downlink data to SMF for the purpose of downlink data
notification. The UPF shall also report the DSCP of the packet if the PDU
Session type is IP (to support the Paging Policy Differentiation feature
described in clause 5.4.3 of TS 23.501 [2]).
(5) Detection of PDU Session Inactivity for a specified period.
When an Inactivity Timer for a PDU Session is provided by SMF during N4
Session Establishment/Modification procedure and the UPF detects the PDU
Session has no data transfer for a period specified by the Inactivity Timer,
it shall report PDU Session Inactivity to the SMF.
NOTE 1: As described in clause 4.3.7, an Inactivity Timer to the UPF is not
provided by the SMF for always-on PDU Sessions.
2\. The UPF sends an N4 session report message (N4 Session ID, list of
[Reporting trigger, Measurement information]) to the SMF.
The Reporting trigger parameter contains the name of the event which triggered
the report and the Measurement information parameter contains the actual
information that the SMF requested to be informed about.
3\. The SMF identifies the N4 session context based on the received N4 Session
ID and applies the reported information for the corresponding PDU Session. The
SMF responds with an N4 session report ACK message.
### 4.4.3 N4 Node Level Procedures
#### 4.4.3.1 N4 Association Setup Procedure
The N4 Association Setup procedure is used to setup an N4 association between
the SMF and the UPF, to enable the SMF to use the resources of the UPF
subsequently to establish N4 Sessions. The SMF and UPF may exchange the
supported functionalities on each side during this procedures.
The setup of an N4 association is initiated by the SMF.
The SMF initiates the N4 Association Setup procedure to request to setup an N4
association towards a UPF prior to establishing a first N4 session on this
UPF.
When receiving an N4 Association Setup Request, the UPF shall send an N4
Association Setup Response.
{width="3.90625in" height="1.5833333333333333in"}
Figure 4.4.3.1-1: N4 association setup procedure
#### 4.4.3.2 N4 Association Update Procedure
The N4 Association Update procedure shall be used to modify an existing N4
association between the SMF and the UPF. It may be initiated by the UPF or by
the SMF to update the supported features or available resources of the UP
function.
{width="3.90625in" height="1.5833333333333333in"}
Figure 4.4.3.2-1: SMF initiated N4 association update procedure
{width="3.90625in" height="1.5833333333333333in"}
Figure 4.4.3.2-2: UPF initiated N4 association update procedure
#### 4.4.3.3 N4 Association Release Procedure
The N4 Association Release procedure shall be used to terminate the N4
association between the SMF and the UPF due to e.g. OAM reasons. The N4
Association Release Request may be initiated by the SMF or UPF.
{width="3.90625in" height="1.5833333333333333in"}
Figure 4.4.3.3-1: SMF initiated N4 association release procedure
{width="3.90625in" height="1.5833333333333333in"}
Figure 4.4.3.3-2: UPF initiated N4 association release procedure
#### 4.4.3.4 N4 Report Procedure
The N4 Report procedure shall be used by the UPF to report information to the
SMF which is not related to a specific N4 session, e.g. to report a user plane
path failure affecting all the N4 sessions towards a remote GTP-U peer.
{width="3.90625in" height="1.5833333333333333in"}
Figure 4.4.3.4-1: N4 report procedure
The UPF detects that an event has to be reported and starts the procedure by
sending an N4 Report message (UPF ID, list of [event, status]) to the SMF. The
SMF responds with an N4 report ACK message (SMF ID). The event parameter
contains the name of the event and UPF ID. The status parameter contains the
actual information the control plane function is interested in.
#### 4.4.3.5 N4 PFD management Procedure
This N4 procedure is used by the SMF to provision or remove all PFD(s)
belonging to an Application ID in the UPF. PFD sets belonging to different
Application IDs can be managed with the same PFD management request message.
The N4 PFD management procedure is a node level procedure, i.e. independent of
any PDU Session.
Figure 4.4.3.5-1: PFD management in the UPF
1\. The SMF is triggered to provision or remove the PFD set belonging to an
Application ID in the following cases:
When the caching timer expires and there\'s no active PCC rule that refers to
the corresponding application identifier, the SMF informs the UPF to remove
the PFD(s) identified by the Application ID.
When a PCC rule is provided for an Application ID corresponding to the PFD(s)
that are not already provided to the UPF, the SMF shall provide the PFD(s) to
the UPF (if there are no PFD(s) cached, the SMF retrieves them from the NEF
(PFDF), as described in TS 23.503 [20]).
When any update of the PFD(s) is received from NEF (PFDF) and there are still
active PCC rules in UPF for the Application ID.
2\. The SMF sends a PFD management request to the UPF to provision/remove the
PFD(s) corresponding to the Application ID(s).
3\. The UPF updates the PFD(s) according to the request and acknowledges by
responding with a PFD management response message.
### 4.4.4 SMF Pause of Charging procedure
The SMF Pause of Charging procedure aims for the SMF charging and usage
monitoring data to more accurately reflect the downlink traffic actually sent
to the AN.
The following are example triggers for the SMF to enable the pause of charging
\- Operator specified criteria/threshold (e.g. number/fraction of
packets/bytes dropped at UPF in downlink since last time the N3 tunnel towards
the AN was released). The SMF requests the UPF to notify the SMF whenever the
criteria/threshold is met.
\- Indication of \"Radio Link Failure\" (see clause 4.2.6).
Based on operator policies, if the trigger for the SMF to enable the pause of
charging is met, the SMF shall pause the charging. When the SMF pauses
charging the following applies:
\- Towards the UPF(s) where the Usage Reporting is configured, the SMF shall
modify the Usage Reporting Rules for the PDU Session so that the usage
collection for charging is stopped.
\- The SMF may request the UPF to limit the rate of downlink traffic sent to
the downstream UPF or the AN.
NOTE 1: A consequence of using this procedure is that SMF charging data does
not correspond to the volume that traversed the UPF and it is therefore not
possible to count the downlink packets dropped between the PDU Session Anchor
(PSA) UPF and the downstream UPF.
NOTE 2: In this release of the specification, pause of charging procedure does
not address the issue of packets dropped by the NG-RAN.
In home routed roaming scenarios, based on operator\'s policy, the H-SMF may
indicate to the V-SMF if the feature is to be enabled on a per PDU Session
basis. This is indicated to the V-SMF by a \"PDU Session Charging Pause
Enabled\" Indication in the Nsmf_PDUSession_Create Response during the PDU
Session Establishment procedure. This is an indication to the V-SMF that when
the criteria for pause of SMF charging are met at the VPLMN (as described
further down in this clause) charging at the H-SMF can be paused.
The H-SMF shall stop any charging and usage monitoring actions for the PDU
Session upon receiving a \"Start Pause of Charging\" Indication in a
Nsmf_PDUSession_Update request from the V-SMF. When the H-SMF receives a
Nsmf_PDUSession_Update request for a PDU Session with a \"Stop Pause of
Charging\" Indication, then the H-SMF shall resume charging for the PDU
Session.
Regardless of operator policy/configuration, the downlink user plane packets
received at the (V-)UPF shall trigger Data Notifications as described in
clause 4.2.3.3.
When the (V-)SMF receives a Nsmf_PDUSession_UpdateSMContext request or a
Namf_EventExposure_Notify about UE reachability, the (V-)SMF shall consider
the PDU Session charging as being unpaused if it had been paused previously.
Figure 4.4.4-1: SMF Pause of charging procedure
1\. The UPF receives downlink data packets for a PDU Session that does not
have an N3 tunnel and the UPF sends data notification to the SMF. The packets
are buffered or discarded in the UPF based on operator policy.
2\. Based on operator policy/configuration the SMF triggers the procedure to
pause PDU Session charging. Triggering criteria are based on SMF operator
policy/configuration.
3\. SMF sends a N4 Session Modification Request message to the UPF where the
Usage Reporting is configured, modifying the Usage Reporting Rules for the PDU
Session so that the usage collection for charging is stopped. In home routed
roaming scenarios, the V-SMF sends a Nsmf_PDUSession_Update request to the
H-SMF with a \"Start Pause of Charging\" Indication. The H-SMF then requests
the H-UPF to stop usage collection as mentioned before.
4\. UPF confirms with a N4 Session Modification Response message.
## 4.5 User Profile management procedures
### 4.5.1 Subscriber Data Update Notification to AMF
Whenever the user profile is changed for a user in the UDM/UDR and the changes
affect the user profile in the AMF, the UDM shall notify these changes to the
affected AMF by the means of invoking Nudm_SDM_Notification service operation.
Then the AMF adds or modifies the user profile.
The Nudm_SDM_Notification service operation specified in clause 5.2.3.3 is
used by the UDM to update subscriber data stored in the AMF.
The AMF takes appropriate action according to the changed subscriber data as
follows, e.g.:
\- initiating an AMF initiated Deregistration procedure if the updated
subscription data indicates the UE is not allowed to roam in this network; and
\- updating UE context stored at AN to modify the subscribed UE-AMBR.
\- initiating UE Configuration Update procedure as defined in clause 4.2.4.2.
UDM can also use the Nudm_SDM_Notification service operation to update the
Steering of Roaming information stored in the UE via the AMF (i.e. a list of
preferred PLMN/access technology combinations or HPLMN indication that \'no
change of the \"Operator Controlled PLMN Selector with Access Technology\"
list stored in the UE is needed). UDM can include an indication for the UE to
send an acknowledgement of the reception of this information. The AMF provides
the acknowledgement sent from the UE to UDM using the Nudm_SDM_Info service
operation. For more details regarding the handling of Steering of Roaming
information refer to TS 23.122 [22].
When the subscribed S-NSSAIs change, UDM provides a Network Slicing
Subscription Change Indication to the UE via the AMF. Once the AMF updates the
UE and obtains an acknowledgment from the UE, the AMF informs the UDM that the
UE received the Network Slicing Subscription Change Indication using the
Nudm_SDM_Info service operation.
### 4.5.2 Session Management Subscriber Data Update Notification to SMF
Whenever the session management subscriber data is changed for a user in the
UDM/UDR and if the SMF subscribed for the update of the session management
subscriber data to be notified, the UDM shall notify these changes to the
affected SMF by the means of invoking Nudm_SDM_Notification service operation.
Then the SMF modifies the session management subscriber data in the UE SM
context.
The Nudm_SDM_Notification service operation specified in clause 5.2.3.3 is
used by the UDM to update session management subscriber data stored in the
SMF.
The SMF initiates appropriate action according to the changed subscriber data,
e.g. including:
\- initiating an SMF initiated PDU Session Modification procedure; or
\- initiating an SMF initiated PDU Session Release procedure.
### 4.5.3 Purge of subscriber data in AMF
An AMF may, as an implementation option, purge the subscriber data and MM
context of a UE after the implicit or explicit Deregistration of the UE. In
this case, the AMF shall unsubscribe and deregister from the UDM, where UDM
may further do corresponding operation from UDR, by the means of following
\"Purge of subscriber data in AMF\" procedure.
Figure 4.5.3-1: Purge of Subscriber Data in AMF
1\. After purging the subscriber data and MM context of a deregistered UE, the
AMF unsubscribes to changes to subscription data using Nudm_SDM_Unsubscribe
request operation (see clause 5.2.3.3.4), for the data the AMF has previously
subscribed (see clause 4.2.2.2.2, step 14b). The UDM unsubscribes the AMF from
the data indicated.
The UDM may unsubscribe to changes to subscription data from UDR by using
Nudr_DM_Unsubscribe for the data the UDM has previously subscribed (see clause
4.2.2.2.2, step 14b).
2\. The UDM sends a response back using Nudm_SDM_Unsubscribe response
operation.
3\. The AMF deregisters from UDM using Nudm_UECM_Deregistration request (SUPI,
NF ID, Access Type) operation (see clause 5.2.3.2.3). The UDM may update UE
context in UDR by Nudr_DM_Update (SUPI, Subscription Data, UE context in AMF
data).
4\. The UDM sets the UE Purged flag associated with the Access Type and
acknowledges with a Nudm_UECM_Deregistration response operation.
## 4.6 Security procedures
Security procedures for the 5GS are specified in 33.501 [15].
## 4.7 ME Identity check procedure
The AMF initiates Mobile Equipment Identity Check procedure by invoking the
N5g-eir_MEIdentityCheck_Get service operation as defined in clause 5.2.4.2.2.
## 4.8 RAN-CN interactions
### 4.8.1 Connection Inactive procedure
This procedure may be initiated by the serving NG-RAN node when the UE is in
CM-CONNECTED with RRC Connected state and has received the \"RRC Inactive
Assistance Information\" from the AMF as defined in clause 5.3.3.2.5 of TS
23.501 [2]. NG-RAN initiates the transition to RRC Inactive state as defined
in TS 38.300 [9].
### 4.8.2 Connection Resume procedure
The Connection Resume procedure is used by the UE to perform RRC Inactive to
RRC Connected state transition. Triggers for the UE to initiate this procedure
are defined in clause 5.3.3.2.5 of TS 23.501 [2].
Figure 4.8.2-1: RRC Inactive to RRC Connected state transition
1\. UE to NG-RAN: RRC message (Resume ID).
The UE initiates the transition from RRC Inactive state to RRC Connected
state, see TS 38.300 [9]. The UE provides its Resume ID needed by the NG-RAN
to access the UE\'s stored Context.
2\. [Conditional] NG-RAN performs UE Context Retrieval.
UE Context Retrieval is performed when the UE Context associated with the UE
attempting to resume its connection is not locally available at the accessed
NG-RAN. The UE Context Retrieval procedure via radio access network is
specified in TS 38.300 [9].
3\. [Conditional] N2 Path switch procedure.
If the accessed NG-RAN is able to retrieve the UE Context, the accessed NG-RAN
node initiates N2 Path Switch procedure, i.e. steps 1 to 8 of clause 4.9.1.2.2
and including Xn data forwarding.
If the Connection Resume procedure is a response to RAN paging which is
triggered by 5GC due to an N2 interface procedure, NG-RAN and 5GC handle the
N2 interface procedure as a collision described in clause 4.9.1.2.
The NG-RAN sends UE Notification message to report that UE is in RRC Connected
if an AMF requested N2 Notification (see clause 4.8.3) to NG-RAN.
4\. NG-RAN to UE: RRC message.
The NG-RAN confirms to the UE that the UE has entered RRC Connected state.
NOTE: Steps 3 and 4 can be executed in parallel.
### 4.8.3 N2 Notification procedure
This procedure is used by an AMF to request the NG-RAN to report RRC state
information, when the target UE is in CM-CONNECTED state. When AMF has
requested reporting of subsequent state changes, the need for the NG-RAN to
continue reporting ceases when the UE transitions to CM-IDLE or the AMF sends
a cancel indication. This procedure may be used for services that require RRC
state information (e.g. 5GC MT control and paging assistance, O&M and
collection of statistics), or for subscription to the service by other NFs.
See TS 38.413 [10] for details of the procedure.
Reporting of RRC state transitions can be requested per UE by AMF. Continuous
reporting of all RRC state transitions can be enabled by operator local
configuration.
Figure 4.8.3-1: RRC state transition notification
1\. The AMF sends a UE State Transition Notification Request to the NG-RAN as
described in TS 38.413 [10]. The UE State Transition Notification Request
message shall identify the UE for which notification(s) are requested and may
contain a reporting type. The reporting type either indicates subsequent state
transitions shall be notified at every RRC state transition (i.e. from RRC
Connected state to RRC Inactive state, or from RRC Inactive to RRC Connected
state), or it indicates Single RRC-Connected state notification.
2\. The NG-RAN sends the UE Notification message to report the current RRC
state for the UE (i.e. RRC Inactive state or RRC Connected state). The current
UE location information (i.e. TAI + Cell Identity) is always included when RRC
state information is reported.
2b. When the AMF has requested reporting about subsequent state transitions,
the NG-RAN sends subsequent UE Notification messages to the AMF at every RRC
state transition until the UE transitions to CM-IDLE or NG-RAN receives a
Cancel UE State Notification message from the AMF.
When the AMF has requested reporting for Single RRC-Connected state
notification and UE is in RRC-Connected state, the NG-RAN sends one UE
Notification message but no subsequent messages. If UE is in RRC-Inactive
state, the NG-RAN sends one UE Notification message plus one subsequent UE
Notification message when RRC state transits to RRC-Connected.
3\. The AMF can send a Cancel UE State Notification message to inform the NG-
RAN that it should terminate notifications for a given UE. This message should
only be used when notification(s) about subsequent state transitions was
requested at every RRC state transition.
## 4.9 Handover procedures
### 4.9.1 Handover procedures in 3GPP access
#### 4.9.1.1 General
These procedures are used to hand over a UE from a source NG-RAN node to a
target NG-RAN node using the Xn or N2 reference points. This can be triggered,
for example, due to new radio conditions, load balancing or due to specific
service e.g. in the presence of QoS Flow for voice, the source NG-RAN node
being NR may trigger handover to E-UTRA connected to 5GC.
The RRC Inactive Assistance Information is included in N2 Path Switch Request
Ack message for Xn based handover or Handover Request message for N2 based
handover (see clause 5.3.3.2.5 of TS 23.501 [2]).
#### 4.9.1.2 Xn based inter NG-RAN handover
##### 4.9.1.2.1 General
Clause 4.9.1.2 includes details regarding the Xn based inter NG-RAN handover
with and without UPF re-allocation.
Xn handovers are only supported for intra-AMF mobility.
The handover preparation and execution phases are performed as specified in TS
38.300 [9], in the case of handover to a shared network, source NG-RAN
determines a PLMN to be used in the target network as specified by TS 23.501
[2]. If the serving PLMN changes during Xn-based handover, the source NG-RAN
node shall indicate to the target NG-RAN node (in the Mobility Restriction
List) the selected PLMN ID to be used in the target network.
If the AMF generates the N2 downlink signalling during the ongoing handover
and receives a rejection to a N2 interface procedure (e.g. Location Reporting
Control; DL NAS message transfer; etc.) from the NG-RAN with an indication
that a Xn based handover procedure is in progress, the AMF may reattempt the
same N2 interface procedure either when the handover is complete or the
handover is deemed to have failed, when possible. The failure is known by
expiry of the timer guarding the N2 interface procedure.
Upon reception for an SMF initiated N1 and/or N2 request(s) with an indication
that the request has been temporarily rejected due to handover procedure in
progress, the SMF starts a locally configured guard timer. Any NF (e.g. the
SMF) should hold any signalling messages targeted towards AMF for a given UE
during the handover preparation phase unless it detects that the handover
execution is completed or handover has failed/cancelled. The NF (e.g. the SMF)
may re-attempt, up to a pre-configured number of times, when either it detects
that the handover is completed or has failed using message reception or at
expiry of the guard timer.
##### 4.9.1.2.2 Xn based inter NG-RAN handover without User Plane function re-
allocation
This procedure is used to hand over a UE from a source NG-RAN to target NG-RAN
using Xn when the AMF is unchanged and the SMF decides to keep the existing
UPF. The UPF referred in this clause 4.9.1.2.2 is the UPF which terminates N3
interface in the 5GC. The presence of IP connectivity between the Source UPF
and Target NG-RAN is assumed.
The call flow is shown in figure 4.9.1.2.2-1.
Figure 4.9.1.2.2-1: Xn based inter NG-RAN handover without UPF re-allocation
1a. If the PLMN has configured secondary RAT usage reporting, the source NG-
RAN node during the handover execution phase may provide RAN usage data Report
(N2 SM Information (Secondary RAT usage data), Handover Flag) to the AMF. The
source NG-RAN node shall provide this only when the Target NG-RAN has
confirmed handover over Xn interface. The Handover Flag indicates to the AMF
that it should buffer the N2 SM Information containing the usage data report
before forwarding it.
1b. Target NG-RAN to AMF: N2 Path Switch Request (List of PDU Sessions To Be
Switched with N2 SM Information, List of PDU Sessions that failed to be
established with the failure cause given in the N2 SM information element, UE
Location Information)
The Target NG-RAN sends an N2 Path Switch Request message to an AMF to inform
that the UE has moved to a new target cell and provides a List Of PDU Sessions
To Be Switched. The selected PLMN ID is included in the message. The target
NG-RAN shall include the PDU Session in the PDU Sessions Rejected list:
\- If none of the QoS Flows of a PDU Session are accepted by the Target NG-
RAN; or
\- If the corresponding network slice is not supported in the Target NG-RAN;
or
When the NG-RAN cannot set up user plane resources fulfilling the User Plane
Security Enforcement with a value Required, the NG-RAN rejects the
establishment of user plane resources for the PDU Session.
If the NG-RAN cannot set up user plane resources fulfilling the User Plane
Security Enforcement with a value Preferred, the NG-RAN establishes the user
plane resources for the PDU session and shall include the PDU Session in the
PDU Sessions Modified list.
PDU Sessions Rejected contains an indication of whether the PDU session was
rejected because User Plane Security Enforcement is not supported in the
Target NG-RAN. Depending on the type of target cell, the Target NG-RAN
includes appropriate information in this message.
For the PDU Sessions to be switched to the Target NG-RAN, the N2 Path Switch
Request message shall include the list of accepted QoS Flows.
2\. AMF to SMF: Nsmf_PDUSession_UpdateSMContext Request (N2 SM information
received from T-RAN in step 1b and N2 SM Information from source NG-RAN
(Secondary RAT usage data), UE Location Information, UE presence in LADN
service area). The N2 SM Information here from source NG-RAN is the one
buffered at step 1a when applicable.
The AMF sends N2 SM information by invoking the
Nsmf_PDUSession_UpdateSMContext request service operation for each PDU Session
in the lists of PDU Sessions received in the N2 Path Switch Request.
The Nsmf_PDUSession_UpdateSMContext Request contains either an indication that
the PDU Session Is To Be Switched (together with information on the N3
addressing to use and on the transferred QoS flows) or an indication that the
PDU Session is to be Rejected (together with a rejection cause).
For a PDU Sessions to be switched to the Target NG-RAN, upon receipt of the
Nsmf_PDUSession_UpdateSMContext request, the SMF determines whether the
existing UPF can continue to serve the UE. If the existing UPF cannot continue
to serve the UE, steps 3-11 of clause 4.9.1.2.3 or 4.9.1.2.4 are performed
depending on whether the existing UPF is a PDU Session Anchor. Otherwise, the
following steps 3 to 6 are performed if the existing UPFs can continue to
serve the PDU Session.
In the case that the AMF determines that the PDU Session is related to a LADN,
then the AMF provides the \"UE presence in LADN service area\" to the SMF. If
the AMF does not provide the \"UE presence in LADN service area\" indication
and the SMF determines that the DNN corresponds to a LADN, then the SMF
considers that the UE is OUT of the LADN service area. The SMF takes actions
for the LADN PDU Session as defined in clause 5.6.5 of TS 23.501 [2] based on
the \"UE presence in LADN service area\" indication.
If a PDU Session is rejected by the Target NG-RAN with an indication that the
PDU session was rejected because User Plane Security Enforcement is not
supported in the Target NG-RAN and the User Plane Enforcement Policy indicates
\"Required\" as described in clause 5.10.3 of TS 23.501 [2], the SMF triggers
the release of this PDU Session. In all other cases of PDU Session rejection,
the SMF can decide whether to release the PDU Session or to deactivate the UP
connection of this PDU Session.
If some of the QoS Flows of a PDU Session are not accepted by the Target NG-
RAN, the SMF shall initiate the PDU Session Modification procedure to remove
the non-accepted QoS Flows from the PDU Session(s) after the handover
procedure is completed.
For the PDU Session(s) that do not have active N3 UP connections before
handover procedure, the SMF(s) keep the inactive status after handover
procedure.
If the UE moves into a non-Allowed Area, the AMF also notifies via
Namf_EventExposure_Notify to each NF Consumer (e.g. SMFs of the established
PDU Sessions) which has subscribed for UE reachability event, that the UE is
only reachable for regulatory prioritized services. The SMF then deactivates
the PDU session if this PDU Session is not for emergency service.
3\. SMF to UPF: N4 Session Modification Request (AN Tunnel Info, CN Tunnel
Info)
For PDU Sessions that are modified by the Target NG-RAN, the SMF sends an N4
Session Modification Request message to the UPF. The SMF may notify the UPF
that originated the Data Notification to discard downlink data for the PDU
Sessions and/or to not provide further Data Notification messages.
Depending on the network deployment, the CN Tunnel Info of UPF used for
connection to Target NG-RAN and connection to Source NG-RAN may be different,
e.g. due to Source and Target NG-RAN are in different IP domains. If the CN
Tunnel Info (on N3) of UPF need be re-allocated and CN Tunnel Info is
allocated by the SMF, the SMF provides the CN Tunnel Info (on N3) to the UPF.
4\. UPF to SMF: N4 Session Modification Response (CN Tunnel Info)
For the PDU Sessions that are switched, the UPF returns an N4 Session
Modification Response message to the SMF after requested PDU Sessions are
switched. Tunnel identifiers for UL traffic are included only for PDU Sessions
whose user plane resources are not being released and only if the UPF
allocates CN Tunnel Info and different CN Tunnel Info need be allocated. For
the PDU Sessions that are deactivated, the UPF returns an N4 Session
Modification Response message to the SMF after the N3 (R)AN tunnel information
is released.
5\. In order to assist the reordering function in the Target NG-RAN, the UPF
(as specified in clause 5.8.2.9 of TS 23.501 [2]) sends one or more \"end
marker\" packets for each N3 tunnel on the old path immediately after
switching the path. The UPF starts sending downlink packets to the Target NG-
RAN.
6\. SMF to AMF: Nsmf_PDUSession_UpdateSMContext Response (CN Tunnel Info)
The SMF sends an Nsmf_PDUSession_UpdateSMContext response (CN Tunnel Info) to
the AMF for PDU Sessions which have been switched successfully. The CN Tunnel
Info of UPF send to AMF is used to setup N3 tunnel. The SMF sends an
Nsmf_PDUSession_UpdateSMContext response without including the CN Tunnel Info
to the AMF for the PDU Sessions for which user plane resources are deactivated
or released and then the SMF releases the PDU Session(s) which is to be
released using a separate procedure as defined in clause 4.3.4.
NOTE: Step 6 can occur any time after receipt of N4 Session Modification
Response at the SMF.
7\. AMF to NG-RAN: N2 Path Switch Request Ack (N2 SM Information, Failed PDU
Sessions)
Once the Nsmf_PDUSession_UpdateSMContext response is received from all the
SMFs, the AMF aggregates received CN Tunnel Info and sends this aggregated
information as a part of N2 SM Information along with the Failed PDU Sessions
in N2 Path Switch Request Ack to the Target NG-RAN. If none of the requested
PDU Sessions have been switched successfully, the AMF shall send an N2 Path
Switch Request Failure message to the Target NG-RAN.
8\. By sending a Release Resources message to the Source NG-RAN, the Target
NG-RAN confirms success of the handover. It then triggers the release of
resources with the Source NG-RAN.
9\. [Conditional] The UE may initiate Mobility Registration Update procedure
if one of the triggers of registration procedure applies as described in
clause 4.2.2.2.2. In this case, only steps 1, 2, 3, 17 and 21 in clause
4.2.2.2.2 are performed.
For the mobility related events as described in clause 4.15.4, the AMF invokes
the Namf_EventExposure_Notify service operation.
Upon reception of the Namf_EventExposure_Notify with an indication that UE is
reachable only for regulatory prioritized service, the SMF deactivates the PDU
Session if the service of the PDU Session is not regulatory prioritized. For
home routed roaming case, the V-SMF triggers the deactivation of the PDU
Session, in addition, the H-SMF refrains from sending downlink signalling if
the signalling is not related to regulatory prioritized service upon receiving
the notification.
##### 4.9.1.2.3 Xn based inter NG-RAN handover with insertion of intermediate
UPF
This procedure is used to hand over a UE from a Source NG-RAN to a Target NG-
RAN using Xn when the AMF is unchanged and the SMF decides that insertion of a
new additional intermediate UPF is needed. In the case of using UL CL, the
I-UPF can be regarded as UL CL and additional PSA providing local access to a
DN. In the case of using Branching Point, the I-UPF can be regarded as BP.
It is assumed that the PDU Session for the UE comprises of only one UPF that
acts as a PDU Session Anchor at the time of this Handover procedure for non-
roaming and local breakout roaming scenario. In the case of home routed
roaming scenario, the PDU Session of the UE comprises of at least one UPF in
the VPLMN and one UPF in the HPLMN at the time of this handover procedure. In
this case, additional insertion of an N3 terminating intermediate UPF will not
have impact on the connectivity between the UPF in VPLMN and UPF in HPLMN. The
presence of IP connectivity between the UPF (PDU Session Anchor) and Source
NG-RAN, between the UPF (PDU Session Anchor) and Target NG-RAN and between the
intermediate UPF (I-UPF) and Target NG-RAN, is assumed. (If there is no IP
connectivity between UPF (PDU Session Anchor) and Target NG-RAN, it is assumed
that the N2-based handover procedure in clause 4.9.1.3 shall be used instead).
The call flow is shown in figure 4.9.1.2.3-1.
Figure 4.9.1.2.3-1: Xn based inter NG-RAN handover with insertion of
intermediate UPF
Steps 1-2 are the same as described in clause 4.9.1.2.2.
3a. [Conditional] SMF to UPF (PSA): N4 Session Modification Request.
If the SMF selects a new UPF to act as intermediate UPF for the PDU Session
and the different CN Tunnel Info need be used and CN Tunnel Info is allocated
by the UPF the SMF sends N4 Session Modification Request message to UPF (PSA).
If the CN Tunnel Info is allocated by the SMF, the SMF may provide the CN
tunnel information (for N9) and UL Packet detection rules associate the CN
Tunnel Info (on N9) to the UPF (PSA) in step 5.
3b. [Conditional] UPF (PSA) to SMF: N4 Session Modification Response.
The UPF (PSA) sends an N4 Session Establishment Response message to the SMF.
If the UPF (PSA) allocates CN Tunnel Info (on N9) of UPF (PSA), it provides CN
Tunnel Info (on N9) to the SMF. The UPF (PSA) associate the CN Tunnel Info (on
N9) with UL Packet detection rules provided by the SMF.
4a. SMF to I-UPF: N4 Session Establishment Request (Target NG-RAN Tunnel Info,
CN Tunnel Info of the PDU Session Anchor)
For PDU Sessions to be updated, if the UE has moved out of the service area of
UPF connecting to the serving NG-RAN node, the SMF then selects a I-UPF based
on UPF Selection Criteria according to clause 6.3.3 of TS 23.501 [2]. An N4
Session Establishment Request message is sent to the I-UPF. The CN Tunnel Info
of the PDU Session Anchor, which is used to setup N9 tunnel, is included in
the N4 Session Establishment Request message. If the CN Tunnel Info of the
I-UPF is allocated by the SMF, the SMF also provides the UL and DL CN Tunnel
Info of I-UPF to the I-UPF.
4b. I-UPF to SMF: N4 Session Establishment Response.
The I-UPF sends an N4 Session Establishment Response message to the SMF. If
the CN Tunnel Info of the I-UPF is allocated by the UPF, the UL and DL CN
Tunnel Info of I-UPF is sent to the SMF.
5\. SMF to PDU Session Anchor: N4 Session Modification Request (DL CN Tunnel
Info of the I-UPF, UL CN Tunnel info).
The SMF sends N4 Session Modification message to the PDU Session Anchor. The
SMF may also provide updated UL CN Tunnel Information.
If a different CN Tunnel Info is used on N9 in UPF (PSA), the SMF starts a
timer to release the CN Tunnel for N3. Otherwise the SMF does not need to
start a timer to release the CN Tunnel Info used on N3 in UPF(PSA) (i.e. CN
Tunnel Info is common for both N3 and N9).
6\. PDU Session Anchor to SMF: N4 Session Modification Response.
The PDU Session Anchor responds with the N4 Session Modification Response
message after requested PDU Sessions are switched. At this point, PDU Session
Anchor starts sending downlink packets to the Target NG-RAN via I-UPF.
7\. In order to assist the reordering function in the Target NG-RAN, the PDU
Session Anchor sends one or more \"end marker\" packets for each N3 tunnel on
the old path immediately after switching the path, the source NG-RAN shall
forward the \"end marker\" packets to the target NG-RAN.
8\. SMF to AMF: Nsmf_PDUSession_UpdateSMContext Response (UL CN Tunnel Info of
the I-UPF).
The SMF sends an Nsmf_PDUSession_UpdateSMContext response to the AMF.
Steps 8-11 are same as steps 6-9 defined in clause 4.9.1.2.2.
12\. After the timer set in step 5 expires, the SMF informs the PDU Session
Anchor to remove the CN Tunnel for N3 via N4 Session Modification procedure.
##### 4.9.1.2.4 Xn based inter NG-RAN handover with re-allocation of
intermediate UPF
This procedure is used to hand over a UE from a Source NG-RAN to a Target NG-
RAN using Xn when the AMF is unchanged and the SMF decides that the
intermediate UPF (I-UPF) is to be changed. In the case of using UL CL, the
I-UPF can be regarded as UL CL and additional PSA provides local access to a
DN, the simultaneous change of UL-CL and the additional PSA is described in
clause 4.3.5.7. In the case of using Branching Point, the I-UPF can be
regarded as BP.
It is assumed that the PDU Session for the UE comprises of a UPF that acts as
a PDU Session Anchor and an intermediate UPF at the time of this Handover
procedure for non-roaming and local breakout roaming scenario. In the case of
home routed roaming scenario, the PDU Session of the UE comprises of at least
one UPF in the VPLMN and UPF in the HPLMN which acts as a PDU Session Anchor
at the time of this handover procedure. The Source UPF referred in this clause
4.9.1.2.4 is the UPF which terminates N3 interface in the 5GC and it serves as
the PDU mobility anchor for the given PDU Session. The presence of IP
connectivity between the Source UPF and Source NG-RAN, between the source UPF
and Target NG-RAN and between the Target UPF and Target NG-RAN, is assumed.
(If there is no IP connectivity between source UPF and Target NG-RAN, it is
assumed that the N2-based handover procedure in clause 4.9.1.3 shall be used
instead).
The call flow is shown in figure 4.9.1.2.4-1.
Figure 4.9.1.2.4-1: Xn based inter NG-RAN handover with intermediate UPF re-
allocation
Steps 1-4 are same as steps 1-4 described in clause 4.9.1.2.3 except that the
I-UPF in clause 4.9.1.2.3 is replaced by Target UPF.
5\. [Conditional] The SMF sends N4 Session Modification Request message to the
PDU Session Anchor. The DL CN Tunnel Info of the Target UPF is included in
this message. In the case of home routed roaming, if the N9 terminating V-UPF
is changed, the V-SMF invokes an Nsmf_PDUSession_Update Request service
operation toward the H-SMF.
6\. [Conditional] The SMF associated with the PDU Session Anchor responds with
the N4 Session Modification Response message. In the case of home routed
roaming, the H-SMF responds with the Nsmf_PDUSession_Update Response service
operation toward the V-SMF once H-UPF is updated with the DL Tunnel Info of
the T-UPF. At this point, PDU Session Anchor starts sending downlink packets
to the Target NG-RAN via Target UPF.
Steps 7-11 are same as steps 7-11 described in clause 4.9.1.2.3 except that
the I-UPF in clause 4.9.1.2.3 is replaced by Target UPF.
If the Source UPF acts as a UL CL or BP, the SMF indicates to only one of the
PDU Session Anchors to send the \"end marker\" packets. To ensure the \"end
marker\" is the last user plane packet on the old path, the SMF should modify
the path on other PDU Session Anchors before it indicates the PDU Session
Anchor to send the \"end marker\" packets.
11\. The timer is started in step 4 if the source UPF is not the PSA UPF. When
this timer is expired, the SMF initiates Source UPF Release procedure by
sending an N4 Session Release Request (Release Cause).
12\. The Source UPF acknowledges with an N4 Session Release Response message
to confirm the release of resources.
#### 4.9.1.3 Inter NG-RAN node N2 based handover
##### 4.9.1.3.1 General
Clause 4.9.1.3 includes details regarding the inter NG-RAN node N2 based
handover without Xn interface.
The source NG-RAN decides to initiate an N2-based handover to the target NG-
RAN. This can be triggered, for example, due to new radio conditions or load
balancing, if there is no Xn connectivity to the target NG-RAN, an error
indication from the target NG-RAN after an unsuccessful Xn-based handover
(i.e. no IP connectivity between T-RAN and S-UPF), or based on dynamic
information learnt by the S-RAN.
The availability of a direct forwarding path is determined in the source NG-
RAN and indicated to the SMFs. If IP connectivity is available between the
source and target NG-RAN and security association(s) is in place between them,
a direct forwarding path is available.
If a direct forwarding path is not available, indirect forwarding may be used.
The SMFs use the indication from the source NG-RAN to determine whether to
apply indirect forwarding.
In the case of handover to a shared network, the source NG-RAN determines a
PLMN to be used in the target network as specified by TS 23.501 [2]. The
source NG-RAN shall indicate the selected PLMN ID to be used in the target
network to the AMF as part of the Tracking Area sent in the HO Required
message.
If the AMF generates the N2 downlink signalling during the ongoing handover
and receives a rejection to a N2 interface procedure (e.g. DL NAS message
transfer; Location reporting control; etc.) from the NG-RAN with an indication
that an Inter NG-RAN node handover procedure is in progress, the AMF may
reattempt the same N2 interface procedure either when the handover is complete
or the handover is deemed to have failed if the AMF is still the serving AMF,
when possible. If the Inter NG-RAN node handover changes the serving AMF, the
source AMF shall terminate any other ongoing N2 interface procedures except
the handover procedure.
In order to minimize the number of procedures rejected by NG-RAN, the AMF
should pause non-handover related N2 interface procedures (e.g. DL NAS message
transfer, Location Report Control, etc.) while a handover is ongoing (i.e.
from the time that a Handover Required has been received until either the
Handover procedure has succeeded (Handover Notify) or failed (Handover
Failure)) and continue them once the Handover procedure has completed if the
AMF is still the serving AMF.
If during the handover procedure the AMF detects that the AMF needs be
changed, the AMF shall reject any SMF initiated N2 request received since
handover procedure started and shall include an indication that the request
has been temporarily rejected due to handover procedure in progress.
Upon reception for an SMF initiated N1 and/or N2 request(s) with an indication
either from the NG-RAN (via N2 SM Info) or AMF that the request has been
temporarily rejected due to handover procedure in progress, the SMF starts a
locally configured guard timer. The SMF should hold any signalling messages
targeted towards AMF for a given UE during the handover preparation phase
unless it detects that the handover execution is completed or handover has
failed/cancelled. The SMF may re-attempt, up to a pre-configured number of
times, when either it detects that the handover is completed or has failed
using message reception or at expiry of the guard timer.
In the case of home routed roaming scenario, the SMF in the Inter NG-RAN node
N2 based handover procedure (Figure 4.9.1.3.2-1 and Figure 4.9.1.3.3-1)
interacting with the S-UPF, T-UPF, S-AMF and T-AMF is the V-SMF and the SMF
(Figure 4.9.1.3.3-1) interacting with the UPF (PSA) is the H-SMF.
##### 4.9.1.3.2 Preparation phase
Figure 4.9.1.3.2-1: Inter NG-RAN node N2 based handover, Preparation phase
1\. S-RAN to S-AMF: Handover Required (Target ID, Source to Target transparent
container, _SM N2 info list,_ PDU Session IDs, intra system handover
indication).
_Source to Target transparent container_ includes NG-RAN information created
by S-RAN to be used by T-RAN and is transparent to 5GC. It also contains for
each PDU session the corresponding QoS flows /DRBs information subject to data
forwarding.
All PDU Sessions handled by S-RAN (i.e. all existing PDU Sessions with active
UP connections) shall be included in the Handover Required message, indicating
which of those PDU Session(s) are requested by S-RAN to handover. The SM N2
info includes Direct Forwarding Path Availability if direct data forwarding is
available.
Direct Forwarding Path Availability indicates whether direct forwarding is
available from the S-RAN to the T-RAN. This indication from S-RAN can be based
on e.g. the presence of IP connectivity and security association(s) between
the S-RAN and the T-RAN.
2\. T-AMF Selection: _When the S-AMF can\'t serve the UE anymore, the S-AMF
selects_ the _T-AMF_ as described in clause 6.3.5 on \"AMF Selection
Function\" in TS 23.501 [2].
3\. [Conditional] S-AMF to T-AMF: _Namf_Communication_CreateUEContext Request
(N2 Information (_ Target ID, Source to Target transparent container, _SM N2
information list_ , PDU Session IDs _),_ UE context information (SUPI, Service
area restriction, Allowed NSSAI for each Access Type if available, Tracing
Requirements, the list of PDU Session IDs along with the corresponding SMF
information and the corresponding S-NSSAI(s), PCF ID(s) and DNN _). If the
subscription information includes Tracing Requirements, the old AMF provides
the target AMF with Tracing Requirements._
The S-AMF initiates Handover resource allocation procedure by invoking the
Namf_Communication_CreateUEContext service operation towards the T-AMF.
When the S-AMF can still serve the UE, this step and step 12 are not needed.
If Service area restrictions are available in the S-AMF, they may be forwarded
to the T-AMF as described in clause 5.3.4.1.2 in TS 23.501 [2].
If both Home and Visited PCF ID(s) are provided by the S-AMF, the T-AMF
contacts the (V-) PCF identified by the (V-)PCF ID. If the (V-)PCF identified
by the (V-)PCF ID is not used or there are no PCF ID(s) received from the
S-AMF, the T-AMF may select the PCF(s) as described in clause 6.3.7.1 of TS
23.501 [2] and according to the V-NRF to H-NRF interaction described in clause
4.3.2.2.3.3. The T-AMF informs the S-AMF that the PCF ID is not used, as
defined in step 12 and then the S-AMF terminates the AM Policy Association
with the PCF identified by the PCF ID.
4\. [Conditional] T-AMF to SMF: _Nsmf_PDUSession_UpdateSMContext (_ PDU
Session ID, Target ID, T-AMF ID, N2 SM Information _)._
For each PDU Session indicated by S-RAN, the AMF invokes the
_Nsmf_PDUSession_UpdateSMContext Request_ to the associated SMF. However, if
the S-NSSAI associated with PDU Session is not available in the T-AMF, the
T-AMF does not invoke Nsmf_PDUSession_UpdateSMContext for this PDU Session.
PDU Session ID indicates a PDU Session candidate for N2 Handover. Target ID
corresponds to Target ID provided by S-RAN in step 1. SM N2 Info includes the
Direct Forwarding Path Availability if the direct data forwarding is available
between the S-RAN and the T-RAN and has been inserted by the S-RAN.
If the (T-)AMF detects that the UE moves into a non-allowed area based on
Service area restrictions, the (Tâ€‘)AMF notifies each NF consumer which has
subscribed for UE reachability event (e.g. SMFs corresponding to the list of
PDU Sessions received in UE Context from (S-)AMF via Namf_EventExposure_Notify
that the UE is only reachable for regulatory prioritized services.
5\. [Conditional] Based on the Target ID, SMF checks if N2 Handover for the
indicated PDU Session can be accepted. The SMF checks also the UPF Selection
Criteria according to clause 6.3.3 of TS 23.501 [2]. If UE has moved out of
the service area of the UPF connecting to NG-RAN, SMF selects a new
intermediate UPF.
In the case that the SMF fails to find a suitable I-UPF, the SMF decides to
(based on local policies) either:
\- trigger re-establishment of PDU Session. After handover procedure, SMF
sends N1 message to the UE via the AMF by invoking
Namf_Communication_N1N2MessageTransfer containing the cause indicating PDU
Session re-establishment is required for the UE; or
\- keep the PDU Session, but reject the activation request of User Plane
connection for the PDU Session and inform the AMF about it; or
\- release the PDU Session after handover procedure.
6a. [Conditional] SMF to UPF (PSA): N4 Session Modification Request.
If the SMF selects a new UPF to act as intermediate UPF for the PDU Session
and the different CN Tunnel Info need be used, the SMF sends N4 Session
Modification Request message to UPF (PSA). The SMF provides the CN Tunnel Info
(on N9) if the CN Tunnel Info is allocated by the SMF and UL Packet detection
rules associate the CN Tunnel Info (on N9) to be installed on the UPF (PSA).
6b. [Conditional] UPF (PSA) to SMF: N4 Session Modification Response.
The UPF (PSA) sends an N4 Session Establishment Response message to the SMF.
If the UPF (PSA) allocates CN Tunnel Info (on N9) of UPF (PSA), it provides CN
Tunnel Info (on N9) to the SMF. The UPF (PSA) associate the CN Tunnel Info (on
N9) with UL Packet detection rules provided by the SMF.
6c. [Conditional] SMF to T-UPF (intermediate): N4 Session Establishment
Request.
If the SMF selects a new intermediate UPF, i.e. the target UPF (T-UPF), for
the PDU Session and if CN Tunnel Info is allocated by the T-UPF, an N4 Session
Establishment Request message is sent to the T-UPF, providing Packet
detection, enforcement and reporting rules to be installed on the T-UPF. The
CN Tunnel Info (on N9) of UPF (PSA) for this PDU Session, which is used to
setup N9 tunnel, is also provided to the T-UPF.
6d. T-UPF (intermediate) to SMF: N4 Session Establishment Response.
The T-UPF sends an N4 Session Establishment Response message to the SMF with
DL CN Tunnel Info and UL CN Tunnel Info (i.e. N3 tunnel info). The SMF starts
a timer to release the resource of S-UPF, which is to be used in step 13a of
the Execution Phase.
7\. SMF to T-AMF: _Nsmf_PDUSession_UpdateSMContext Response (_ PDU Session ID,
N2 SM Information, Reason for non-acceptance _)._
If N2 handover for the PDU Session is accepted, the SMF includes in the
Nsmf_PDUSession_UpdateSMContext response the N2 SM Information containing the
N3 UP address, the UL CN Tunnel ID of the UPF, the QoS parameters and the User
Plane Security Enforcement information indicating that the N2 SM Information
is for the Target NG-RAN. If the N2 SM information received at step 4 does not
include the Direct Forwarding Path Availability and the SMF knows that there
is no indirect data forwarding connectivity between source and target, the N2
SM Information includes a Data forwarding not possible indication.
If N2 handover for the PDU Session is not accepted as described in step 5, the
SMF does not include an N2 SM Information regarding the PDU Session to avoid
establishment of radio resources at the target NG-RAN. Instead of that, the
SMF provides a reason for non-acceptance. If the SMF has received notification
from (T-)AMF that the UE is only reachable for regulatory prioritized
services, the SMF does not include any N2 SM info regarding the PDU Session
for non-regulatory prioritized services to avoid establishment of radio
resources at the target NG-RAN. If the SMF receives notification from (T-)AMF
that UE is only reachable for regulatory prioritized service after this step
via Namf_EventExposure_Notify, the SMF deactivates the PDU Session after
handover procedure finish if the PDU Session is not for regulatory prioritized
services.
8\. AMF supervises the Nsmf_PDUSession_UpdateSMContext Response messages from
the involved SMFs. The lowest value of the Max delay indications for the PDU
Sessions that are candidates for handover gives the maximum time AMF may wait
for Nsmf_PDUSession_UpdateSMContext Response messages before continuing with
the N2 Handover procedure. At expiry of the maximum wait time or when all
Nsmf_PDUSession_UpdateSMContext Response messages are received, AMF continues
with the N2 Handover procedure (Handover Request message in step 9).
NOTE: The delay value for each PDU Session is locally configured in the AMF
and implementation specific.
9\. T-AMF to T-RAN: _Handover Request (_ Source to Target transparent
container, N2 MM Information, N2 SM Information list, Tracing Requirements _).
If the subscription information includes Tracing Requirements, the target AMF
provides the target RAN with Tracing Requirements in the Handover Request._
T-AMF determines T-RAN based on Target ID. T-AMF may allocate a 5G-GUTI valid
for the UE in the AMF and target TAI.
_Source to Target_ transparent container is forwarded as received from S-RAN.
N2 MM Information includes e.g. security information and Mobility Restriction
List if available in the T-AMF.
N2 SM Information list includes N2 SM Information received from SMFs for the
T-RAN in the Nsmf_PDUSession_UpdateSMContext Response messages received within
allowed max delay supervised by the T-AMF mentioned in step 8.
Mobility Restriction List is sent in N2 MM Information if available in the
Target AMF.
10\. T-RAN to T-AMF: _Handover Request Acknowledge (_ Target to Source
transparent container, List of PDU Sessions to Hand-over with N2 SM
information, List of PDU Sessions that failed to be established with the
failure cause given in the N2 SM information element _)._
_Target to Source transparent container_ includes a UE container with an
access stratum part and a NAS part. The UE container is sent transparently via
T-AMF, S-AMF and S-RAN to the UE.
T-RAN creates List Of PDU Sessions failed to be setup and reason for failure
(e.g. T-RAN decision, S-NSSAI is not available, unable to fulfil User Plane
Security Enforcement) based on T-RAN determination. The information is
provided to the S-RAN.
The N2 SM information in the List Of PDU Sessions to Hand-over, contains per
each PDU Session ID T-RAN N3 addressing information i.e. N3 UP address and
Tunnel ID of T-RAN for the PDU Session. The N2 SM information may also
include:
\- an Indication whether UP integrity protection is performed or not on the
PDU Session based on User Plane Security Enforcement information received in
N2 SM information in step 9.
\- if the PDU Session has at least one QoS Flow subject for data forwarding,
N3 UP address and Tunnel ID of T-RAN for receiving forwarded data. The T-RAN
provides data forwarding addresses for each data forwarding tunnel which it
decided to setup.
11a. AMF to SMF: Nsmf_PDUSession_UpdateSMContext _Request (_ PDU Session ID,
N2 SM response received from T-RAN in step 10 _)._
For each N2 SM response received from the T-RAN (N2 SM information included in
Handover Request Acknowledge), AMF sends the received N2 SM response to the
SMF indicated by the respective PDU Session ID.
If no new T-UPF is selected, SMF stores the N3 tunnel info of T-RAN from the
N2 SM response if N2 handover is accepted by T-RAN.
The SMF/UPF allocates the N3 UP address and Tunnel IDs for indirect data
forwarding corresponding to the data forwarding tunnel endpoints established
by T-RAN.
If a PDU Session is indicated as a rejected PDU Session by the Target NG-RAN
with an indication that the PDU session was rejected because User Plane
Security Enforcement is not supported in the Target NG-RAN and the User Plane
Enforcement Policy indicates \"Required\" as described in clause 5.10.3 of TS
23.501 [2], the SMF triggers the release of this PDU Session. In all other
cases of PDU Session rejection, the SMF can decide whether to release the PDU
Session or to deactivate the UP connection of this PDU Session.
If some of the QoS Flows of a PDU Session are not accepted by the Target NG-
RAN, the SMF shall initiate the PDU Session Modification procedure to remove
the non-accepted QoS Flows from the PDU Session(s) after the handover
procedure is completed.
11b. [Conditional] SMF to T-UPF: N4 Session Modification Request (T-RAN SM N3
forwarding Information list, indication to allocate DL forwarding tunnel(s)
for indirect forwarding)
If the SMF selected a T-UPF in step 6a, the SMF updates the T-UPF by providing
the T-RAN SM N3 forwarding information list by sending a N4 Session
Modification Request to the T-UPF.
If indirect forwarding applies based on indication from the S-RAN and the UPF
is re-allocated and if the SMF decides to setup the indirect forwarding tunnel
on the same T-UPF, the SMF also requests in the N4 Session Modification
Request message to the T-UPF, to allocate DL forwarding tunnel(s) for indirect
forwarding.
Indirect forwarding may be performed via a UPF which is different from the
T-UPF, in which case the SMF selects a T-UPF for indirect forwarding.
11c. [Conditional] T-UPF to SMF: N4 Session Modification Response (T-UPF SM N3
forwarding Information list).
The T-UPF allocates Tunnel Info and returns an N4 Session Modification
Response message to the SMF.
The T-UPF SM N3 forwarding info list includes T-UPF N3 address, T-UPF N3
Tunnel identifiers for forwarding data
11d. [Conditional] SMF to S-UPF: N4 Session Modification Request (T-RAN SM N3
forwarding Information list or T-UPF SM N3 forwarding Information list,
indication to allocate DL forwarding tunnel(s) for indirect forwarding).
If the UPF is re-allocated, this message includes the T-UPF SM N3 forwarding
info list. If the UPF is not re-allocated, this message includes the T-RAN SM
N3 forwarding info list.
If indirect forwarding applies based on indication from NG-RAN and UPF
allocates tunnel identities, the SMF indicates in the N4 Session Modification
Request message to the S-UPF to allocate DL forwarding tunnel(s) for indirect
forwarding.
Indirect forwarding may be performed via a UPF which is different from the
S-UPF.
11e. [Conditional] S-UPF to SMF: N4 Session Modification Response (S-UPF SM N3
forwarding Information list).
The S-UPF allocates Tunnel Info and returns an N4 Session establishment
Response message to the SMF.
The S-UPF SM N3 forwarding Information list includes S-UPF N3 address, S-UPF
N3 Tunnel identifiers for DL data forwarding.
11f. SMF to T-AMF: Nsmf_PDUSession_UpdateSMContext Response (N2 SM
Information).
The SMF sends an Nsmf_PDUSession_UpdateSMContext Response message per PDU
Session to T-AMF.
The SMF creates an N2 SM information containing the DL forwarding Tunnel Info
to be sent to the S-RAN by the AMF. The SMF includes this information in the
Nsmf_PDUSession_UpdateSMContext response. The DL forwarding Tunnel Info can be
one of the following information:
\- If direct forwarding applies, then the SMF includes the T-RAN N3 forwarding
information the SMF received in step 11a.
\- If the indirect forwarding tunnel is setup in step 11b or 11d, then the SMF
includes the T-UPF or S-UPF DL forwarding information containing the N3 UP
address and the DL Tunnel ID of the UPF.
12\. [Conditional] T-AMF to S-AMF: Namf_Communication_CreateUEContext Response
(N2 information necessary for S-AMF to send Handover Command to S-RAN
including Target to Source transparent container, PDU Sessions failed to be
setup list, N2 SM information (N3 DL forwarding Information, PCF ID)).
AMF supervises the Nsmf_PDUSession_UpdateSMContext Response message from the
involved SMFs. At expiry of the maximum wait time or when all
Nsmf_PDUSession_UpdateSMContext Response messages are received, T-AMF sends
the Namf_Communication_CreateUEContext Response to the S-AMF.
The PDU Sessions failed to be setup list includes the List Of PDU Sessions
failed to be setup received from target RAN in step 10 and the Non-accepted
PDU session List generated by the T-AMF.
Non-accepted PDU Session List includes following PDU Session(s) with proper
cause value:
\- Non-accepted PDU Session(s) by the SMF(s);
\- Non-accepted PDU Session(s) by the AMF due to no response from the SMF
within maximum wait time; and
\- Non-accepted PDU Session(s) by the AMF due to non-available S-NSSAI in the
T-AMF, which is decided at step 4.
The Target to Source transport container is received from the T-RAN. The N2 SM
Information is received from the SMF in step 11f.
##### 4.9.1.3.3 Execution phase
Figure 4.9.1.3.3-1: inter NG-RAN node N2 based handover, execution phase
NOTE 1: Registration of serving AMF with the UDM is not shown in the figure
for brevity.
1\. S-AMF to S-RAN: _Handover Command (_ Target to Source transparent
container, List Of PDU Sessions to be handed-over with N2 SM information
containing information received from T-RAN during the handover preparation
phase, List Of PDU Sessions failed to be setup _)._
Target to Source transparent container is forwarded as received from S-AMF.
The SM forwarding info list includes T-RAN SM N3 forwarding info list for
direct forwarding or S-UPF SM N3 forwarding info list for indirect data
forwarding
S-RAN uses the PDU Sessions failed to be setup list and the indicated reason
for failure to decide whether to proceed with the N2 Handover procedure.
2\. S-RAN to UE: _Handover Command (_ UE container _)._
UE container is a UE part of the Target to Source transparent container which
is sent transparently from T-RAN via AMF to S-RAN and is provided to the UE by
the S-RAN.
2a0. If the PLMN has configured secondary RAT usage reporting and the source
NG-RAN has Secondary RAT usage data to report, the source NG-RAN node may
provide RAN usage data report message (N2 SM Information (Secondary RAT usage
data), Handover Flag) as in clause 4.21 to the AMF. The Handover Flag
indicates to the AMF that it should buffer the N2 SM Information containing
the usage data report before forwarding it.
NOTE 2: This step is not shown in this figure but the secondary RAT usage data
reporting procedure is shown in figure 4.21-1 in clause 4.21.
2a. - 2c. The S-RAN sends the Uplink RAN Status Transfer message to the S-AMF,
as specified in TS 36.300 [46] and TS 38.300 [9]. The S-RAN may omit sending
this message if none of the radio bearers of the UE shall be treated with PDCP
status preservation.
If there is an AMF relocation, the S-AMF sends this information to the T-AMF
via the Namf_Communication_N1N2MessageTransfer service operation and the T-AMF
acknowledges. The S-AMF or, if the AMF is relocated, the T-AMF, sends the
information to the T-RAN via the Downlink RAN Status Transfer message, as
specified in TS 36.300 [46] and TS 38.300 [9].
3\. Uplink packets are sent from T-RAN to T-UPF and UPF (PSA). Downlink
packets are sent from UPF (PSA) to S-RAN via S-UPF. The S-RAN should start
forwarding of downlink data from the S-RAN towards the T-RAN for QoS Flows or
DRBs subject to data forwarding. This may be either direct (step 3a) or
indirect forwarding (step 3b).
4\. UE to T-RAN: _Handover Confirm._
After the UE has successfully synchronized to the target cell, it sends a
Handover Confirm message to the T-RAN. Handover is by this message considered
as successful by the UE.
5\. T-RAN to T-AMF: _Handover Notify._
Handover is by this message considered as successful in T-RAN.
6a. [Conditional] T-AMF to S-AMF: Namf_Communication_N2InfoNotify.
The T-AMF notifies to the S-AMF about the N2 handover notify received from the
T-RAN by invoking the Namf_Communication_N2InfoNotify.
A timer in S-AMF is started to supervise when resources in S-RAN shall be
release.
6b. [Conditional] S-AMF to T-AMF: Namf_Communication_N2InfoNotify ACK (N2 SM
Information (Secondary RAT usage data)).
The S-AMF acknowledges by sending the Namf_Communication_N2InfoNotify ACK to
the T-AMF. The N2 SM Information here is the one buffered at step 2a0 when
applicable.
6c. [Conditional] S-AMF to SMF: Nsmf_PDUSession_ReleaseSMContext Request
(SUPI, PDU Session ID, N2 SM Information (Secondary RAT Usage Data))_._
If the PDU Session(s) is not accepted by the T-AMF (e.g. S-NSSAI associated
with the PDU Session is not available in the T-AMF), S-AMF triggers PDU
Session Release procedure as specified in clause 4.3.4.2 after the S-AMF is
notified for the reception of N2 Handover Notify in step 6a.
7\. T-AMF to SMF: Nsmf_PDUSession_UpdateSMContext Request (Handover Complete
indication for PDU Session ID, UE presence in LADN service area, N2 SM
Information (Secondary RAT usage data))_. The N2 SM Information here is the
one received at step 6b when applicable._
Handover Complete indication is sent per each PDU Session to the corresponding
SMF to indicate the success of the N2 Handover.
When an Nsmf_PDUSession_UpdateSMContext Response message arrived too late
during the handover preparation phase (see step 8 of clause 4.9.1.3.2), or the
PDU Session with SMF involvement is not accepted by T-RAN,
Nsmf_PDUSession_UpdateSMContext Request (SUPI, PDU Session ID, Operation Type)
is sent to the corresponding SMF allowing the SMF to deallocate a possibly
allocated N3 UP address and Tunnel ID of the selected UPF. A PDU Session
handled by that SMF is considered deactivated and handover attempt is
terminated for that PDU Session.
In the case that the AMF determines that the PDU Session is related to a LADN
then the AMF provides the \"UE presence in LADN service area\". If the AMF
does not provide the \"UE presence in LADN service area\" indication and the
SMF determines that the DNN corresponds to a LADN, then the SMF considers that
the UE is OUT of the LADN service area.
The SMF takes actions for the LADN PDU Session as defined in clause 5.6.5 of
TS 23.501 [2] based on the \"UE presence in LADN service area\" indication.
8a. [Conditional] SMF to T-UPF (intermediate): N4 Session Modification
Request.
If new T-UPF is inserted or an existing intermediate S-UPF is re-allocated,
the SMF shall send N4 Session Modification Request indicating DL AN Tunnel
Info of T-RAN to the T-UPF.
8b. [Conditional] T-UPF to SMF: N4 Session Modification Response.
The T-UPF acknowledges by sending N4 Session Modification Response message to
SMF.
9a. [Conditional] SMF to S-UPF (intermediate): N4 Session Modification
Request.
If UPF is not re-allocated, the SMF shall send N4 Session Modification Request
indicating DL AN Tunnel Info of T-RAN to the S-UPF.
9b. [Conditional] S-UPF to SMF: N4 Session Modification Response.
The S-UPF acknowledges by sending N4 Session Modification Response message to
SMF.
10a. [Conditional] SMF to UPF (PSA): N4 Session Modification Request.
For non-roaming or local breakout roaming scenario, the SMF sends N4 Session
Modification Request message to PDU Session Anchor UPF, UPF (PSA), providing
N3 AN Tunnel Info of T-RAN or the DL CN Tunnel Info of T-UPF if a new T-UPF is
inserted or an existing intermediate S-UPF is re-allocated. If the existing
intermediate S-UPF terminating to N9 toward the H-UPF (PDU Session Anchor) is
re-allocated for the home routed roaming scenario, the V-SMF invokes an
Nsmf_PDUSession_Update Request service operation toward the H-SMF.
In the case of the S-UPF acts as a UL CL or BP, the SMF indicates only one of
the PDU Session Anchors to send the \"end marker\" packets. To ensure the
\"end marker\" is the last user plane packet on the old path, the SMF should
modify the path on other PDU Session Anchors before it indicates the PDU
Session Anchor to send the \"end marker\" packets.
If T-UPF is not inserted or an existing intermediate S-UPF is not re-
allocated, step 10a and step 10b are skipped.
10b. [Conditional] UPF (PSA) to SMF: N4 Session Modification Response.
The UPF (PSA) sends N4 Session Modification Response message to SMF. In order
to assist the reordering function in the T-RAN, the UPF (PSA) sends one or
more \"end marker\" packets for each N3 tunnel on the old path immediately
after switching the path, the source NG-RAN shall forward the \"end marker\"
packets to the target NG-RAN. At this point, UPF (PSA) starts sending downlink
packets to the T-RAN, via T-UPF if a new T-UPF is inserted or an existing
intermediate S-UPF is re-allocated. In the case of home routed roaming
scenario, the H-SMF responds with the Nsmf_PDUSession_Update Response service
operation to V-SMF once the H-UPF (PDU Session Anchor) is updated with the UL
Tunnel Info of the T-UPF.
When there are multiple UPFs(PSA), step 10a and step 10b are performed for
each UPFs(PSA).
11\. SMF to T-AMF: Nsmf_PDUSession_UpdateSMContext Response (PDU Session ID).
SMF confirms reception of Handover Complete.
If indirect data forwarding applies, the SMF starts an indirect data
forwarding timer, to be used to release the resource of indirect data
forwarding tunnel.
12\. The UE initiates Mobility Registration Update procedure as described in
clause 4.2.2.2.2.
The target AMF knows that it is a Handover procedure and therefore the target
AMF performs only a subset of the Registration procedure, specifically the
steps 4, 5 and 10 in the Registration procedure for the context transfer
between source AMF and target AMF are skipped.
13a. [Conditional] SMF to S-UPF (intermediate): N4 Session Release Request.
If there is a source intermediate UPF, the SMF initiates resource release,
after timer in step 6 or indirect data forwarding timer expires, by sending an
N4 Session Release Request (Release Cause) to source UPF. This message is also
used to release the indirect data forwarding resource in S-UPF.
13b. S-UPF to SMF: N4 Session Release Response.
The S-UPF acknowledges with an N4 Session Release Response message to confirm
the release of resources.
In the case of indirect data forwarding, the resource of indirect data
forwarding is also released.
14a. AMF to S-RAN: UE Context Release Command ().
After the timer in step 6a expires, the AMF sends UE Context Release Command.
14b. S-RAN to AMF: UE Context Release Complete ().
The source NG-RAN releases its resources related to the UE and responds with a
UE Context Release Complete () message.
15a. [Conditional] SMF to T-UPF: N4 Session Modification Request.
If indirect forwarding applies and UPF is re-allocated, after timer of
indirect data forwarding expires, the SMF sends N4 Session Modification
Request to T-UPF to release the indirect data forwarding resource.
15b. [Conditional] T-UPF to SMF: N4 Session Modification Response.
The T-UPF acknowledges with an N4 Session Modification Response message to
confirm the release of indirect data forwarding resources.
If the AMF is subscribed to Mobility Event by other NFs, the AMF notifies the
event to the corresponding NFs by invoking the Namf_EventExposure_Notify
service operation as described in clause 4.15.4.2.
Upon reception of the Namf_EventExposure_Notify with an indication that UE is
reachable only for regulatory prioritized service, the SMF deactivates the PDU
Session if the service of the PDU Session is not regulatory prioritized. For
home routed roaming case, the V-SMF triggers the deactivation of the PDU
Session, in addition, the H-SMF refrains from sending downlink signalling if
the signalling is not related to regulatory prioritized service upon receiving
the notification.
#### 4.9.1.4 Inter NG-RAN node N2 based handover, Cancel
Prior to sending a Handover Command to the UE, the source NG-RAN node may
attempt cancellation of handover during the handover procedure. The reason for
cancellation may include timer expiration, internal failure within the source
NG-RAN node or UE returned to source cell etc. The handover cancellation is
initiated by sending a Handover Cancel request to the source AMF. This is done
in order to release the resources reserved for the handover in the target
system.
The AMF shall cancel the handover resources as defined in clause 4.11.1.2.3
for case the source RAN is NG-RAN.
### 4.9.2 Handover of a PDU Session procedure between 3GPP and untrusted
non-3GPP access
#### 4.9.2.1 Handover of a PDU Session procedure from untrusted non-3GPP to
3GPP access (non-roaming and roaming with local breakout)
Clause 4.9.2.1 specifies how to hand over a UE from a source Untrusted
non-3GPP access to a target 3GPP access and how a UE can handover a PDU
Session from untrusted non-3GPP access to 3GPP access. It is based on the PDU
Session Establishment procedure for 3GPP access as specified in clause 4.3.2.
Figure 4.9.2.1-1: Handover of a PDU Session procedure from untrusted non-3GPP
access to 3GPP access (non-roaming and roaming with local breakout)
1\. If the UE is not registered via 3GPP access, the UE shall initiate
Registration procedure as defined in clause 4.2.2.2.2.
2\. The UE performs a PDU Session Establishment procedure with the PDU Session
ID of the PDU Session to be moved as specified clause 4.3.2.2.1 (PDU Session
Establishment for Non-roaming and Roaming with Local Breakout).
3\. If the User Plane of the PDU Session is activated in non-3GPP access, the
V-SMF executes the release of resources in non-3GPP access by performing steps
4 to 7 specified in clause 4.12.7, followed by step 7a specified in clause
4.3.4.2 in order to release the resources over the source non-3GPP access.
Because the PDU Session shall not be released, the SMF shall not send the PDU
Session Release Command to the UE. Hence, in steps 4 and 7 of clause 4.12.7 as
well as in step 7a of clause 4.3.4.2, the messages do not include the N1 SM
container but only the N2 Resource Release Request (resp. Ack). Since the PDU
Session is not to be released, the SMF shall not execute step 7b of clause
4.3.4.2 and the SM context between the AMF and the SMF is maintained.
If the User Plane of the PDU Session is deactivated in non-3GPP access, this
step is skipped.
The steps 2 and 3 shall be repeated for all PDU Sessions to be moved from to
untrusted non-3GPP access to 3GPP access.
#### 4.9.2.2 Handover of a PDU Session procedure from 3GPP to untrusted
non-3GPP access (non-roaming and roaming with local breakout)
Clause 4.9.2.2 specifies how to hand over a UE from a source 3GPP access to a
target Untrusted non-3GPP access and how a UE can handover a PDU Session from
3GPP access to untrusted non-3GPP access. It is based on the PDU Session
Establishment procedure for non-3GPP access as specified in clause 4.12.5.
Figure 4.9.2.2-1: Handover of a PDU Session from 3GPP access to untrusted
non-3GPP access (non-roaming and roaming with local breakout)
1\. If the UE is not registered via untrusted non-3GPP access, the UE shall
initiate Registration procedure as defined in clause 4.12.2.
2\. The UE performs PDU Session Establishment procedure with the PDU Session
ID of the PDU Session to be moved as specified in clause 4.12.5.
3 If the User Plane of the PDU Session is activated in 3GPP access, the V-SMF
executes the release of resource in 3GPP by performing step 3b, then steps 4
to 7a specified in clause 4.3.4.2 (UE or network requested PDU Session Release
for Non-Roaming and Roaming with Local Breakout) in order to release the
resources over the source 3GPP access. Because the PDU Session shall not be
released, the SMF shall not send the PDU Session Release Command to the UE.
Hence, in steps 3b, 4, 6 and 7a of clause 4.3.4.2, messages do not include the
N1 SM container but only the N2 Resource Release Request (resp. Ack). Since
the PDU Session is not to be released, the SMF shall not execute step 7b of
clause 4.3.4.2 and the SM context between the AMF and the SMF is maintained.
If the User Plane of the PDU Session is deactivated in 3GPP access, this step
is skipped.
The steps 2 and 3 shall be repeated for all PDU Sessions to be moved from 3GPP
access to untrusted non-3GPP access
#### 4.9.2.3 Handover of a PDU Session procedure from untrusted non-3GPP to
3GPP access (home routed roaming)
##### 4.9.2.3.1 The target AMF is in the PLMN of the N3IWF
Figure 4.9.2.3.1 -1: Handover of a PDU Session procedure from untrusted
non-3GPP access to 3GPP access (home routed roaming)
1\. If the UE is not registered via 3GPP access, the UE shall initiate
Registration procedure as defined in clause 4.2.2.2.2. The NG-RAN selects the
same AMF as the one used via non-3GPP access.
2\. The UE performs a PDU Session Establishment procedure with the PDU Session
ID of the PDU Session to be moved as specified clause 4.3.2.2.2 (PDU Session
Establishment for Home Routed Roaming). The AMF selects the same V-SMF as the
one used via non-3GPP access.
3\. If the User Plane of the PDU Session is activated in non-3GPP access, the
V-SMF executes the release of resource in non-3GPP access by performing steps
4 to 7 specified in clause 4.12.7, followed by step 7 specified in clause
4.3.4.2 in order to release the resources over the source non-3GPP access.
Because the PDU Session shall not be released, the SMF shall not send the PDU
Session Release Command to the UE. Hence, in steps 4 and 7 of clause 4.12.7 as
well as in step 7a of clause 4.3.4.2, the messages do not include the N1 SM
container but only the N2 Resource Release Request (resp. Ack). Since the PDU
Session is not to be released, the SMF shall not execute step 7b of clause
4.3.4.2 and the SM context between the AMF and the SMF is maintained.
If the User Plane of the PDU Session is deactivated in non-3GPP access, this
step is skipped.
The steps 2 and 3 shall be repeated for all PDU Sessions to be moved from to
untrusted non-3GPP access to 3GPP access.
##### 4.9.2.3.2 The target AMF is not in the PLMN of the N3IWF (i.e. N3IWF in
HPLMN)
Figure 4.9.2.3.2-1: Handover of a PDU Session procedure from untrusted
non-3GPP access with N3IWF in the HPLMN to 3GPP access (home routed roaming)
1\. If the UE is not registered via 3GPP access, the UE shall initiate
Registration procedure as defined in clause 4.2.2.2.2. This includes the
retrieval of the SMF-IDs corresponding to each of the PDU Sessions.
2\. The UE performs a PDU Session Establishment procedure with the PDU Session
ID of the PDU Session to be moved as specified clause 4.3.2.2.2 (PDU Session
Establishment for Home Routed Roaming).
3\. The H-SMF executes the release of resources in non-3GPP AN by performing
steps 3-12 specified in clause 4.12.7 with the following exceptions:
\- the H-SMF interfaces the source AMF (in the home PLMN). The H-SMF shall not
send the N1 SM Container (PDU Session Release Command) to the UE;
\- The Npcf_SMPolicyControl_Delete service operation to PCF shall not be
performed.
\- Nsmf_PDUSession_SMContexStatusNotify service operation invoked by the H-SMF
to the source AMF indicates the PDU Session is moved to different access.
The steps 2 and 3 shall be repeated for all PDU Sessions to be moved from to
untrusted non-3GPP access to 3GPP access.
#### 4.9.2.4 Handover of a PDU Session procedure from 3GPP to untrusted
non-3GPP access (home routed roaming)
##### 4.9.2.4.1 The selected N3IWF is in the registered PLMN
Figure 4.9.2.4.1-1: Handover of a PDU Session procedure from 3GPP access to
untrusted non-3GPP access (home routed roaming)
1\. If the UE is not registered via untrusted non-3GPP access, the UE shall
initiate Registration procedure as defined in clause 4.12.2. The N3IWF selects
the same AMF as the one used via 3GPP access.
2\. The UE performs PDU Session Establishment procedure with the PDU Session
ID of the PDU Session to be moved as specified in clause 4.12.5. The AMF
selects the same V-SMF as the one used via 3GPP access.
3 If the User Plane of the PDU Session is activated in 3GPP access, the V-SMF
executes the release of resources in 3GPP access by performing step 5c to 10
specified in clause 4.3.4.3 (UE or network requested PDU Session Release for
Home Routed Roaming) in order to release the resources over the source 3GPP
access. Because the PDU Session shall not be released, the SMF shall not send
the PDU Session Release Command to the UE. Hence, in steps 5c, 6, 8 and 9 of
clause 4.3.4.3, the messages do not include the N1 SM container but only the
N2 Resource Release Request (resp. Ack). Since the PDU Session is not to be
released, the SMF shall not execute step 7b of clause 4.3.4.2 and the SM
context between the AMF and the SMF is maintained.
If the User Plane of the PDU Session is deactivated in 3GPP access, this step
is skipped.
The steps 2 and 3 shall be repeated for all PDU Sessions to be moved from 3GPP
access to untrusted non-3GPP access.
##### 4.9.2.4.2 The UE is roaming and the selected N3IWF is in the home PLMN
Figure 4.9.2.4.2-1: Handover of a PDU Session procedure from 3GPP access to
untrusted non-3GPP access with N3IWF in the HPLMN (home routed roaming)
1\. If the UE is not registered via untrusted non-3GPP access, the UE shall
initiate Registration procedure as defined in clause 4.12.2. This includes the
retrieval of the SMF-IDs corresponding to each of the PDU Sessions.
2\. The UE performs PDU Session Establishment procedure with the PDU Session
ID of the PDU Session to be moved as specified in clause 4.12.5.
3\. The H-SMF executes the release of resources in source V-SMF, V-UPF, V-AMF
and 3GPP AN by performing steps 3a, 5c to 16b specified in clause 4.3.4.3 with
the following exceptions:
\- the H-SMF indicates in the Nsmf_PDUSession_Update Request that the UE shall
not be notified. This shall result in the V-SMF not sending the N1 Container
(PDU Session Release Command) to the UE;
\- Nsmf_PDUSession_StatusNotify service operation invoked by H-SMF to V-SMF
indicates PDU Session is moved to different access;
\- Nsmf_PDUSession_SMContexStatusNotify service operation invoked by the V-SMF
to the AMF indicates the PDU Session is moved to different access;
\- The Npcf_SMPolicyControl_Delete service operation to PCF shall not be
performed.
The steps 2 and 3 shall be repeated for all PDU Sessions to be moved from 3GPP
access to untrusted non-3GPP access.
## 4.10 NG-RAN Location reporting procedures
This procedure is used by an AMF to request the NG-RAN to report where the UE
is currently located when the target UE is in CM-CONNECTED state. The need for
the NG-RAN to continue reporting ceases when the UE transitions to CM-IDLE or
the AMF sends cancel indication to NG-RAN. This procedure may be used for
services that require accurate cell identification (e.g. emergency services,
lawful intercept, charging), or for subscription to the service by other NFs.
When Dual Connectivity is activated, the PSCell information is only reported
if requested by the AMF.
Figure 4.10-1: NG-RAN Location Reporting Procedure
1\. AMF to NG-RAN: Location Reporting Control (Reporting Type, Location
Reporting Level, (Area Of Interest, Request Reference ID)).
The AMF sends a Location Reporting Control message to the NG-RAN. The Location
Reporting Control message shall identify the UE for which reports are
requested and shall include Reporting Type and Location Reporting Level. The
Location Reporting Control message may also include Area Of Interest and
Request Reference ID. Location Reporting Level could be TAI+ Cell Identity.
Reporting Type indicates whether the message is intended to trigger a single
standalone report about the current Cell Identity serving the UE or start the
NG-RAN to report whenever the UE changes cell, or ask the NG-RAN to report
whenever the UE moves out or into the Area Of Interest. If the Reporting Type
indicates to report whenever the UE changes cell and if PSCell reporting is
requested and Dual Connectivity is in use, the Master RAN node shall also
report to the AMF whenever the PSCell changes. If the Reporting Type indicates
to start the NG-RAN to report when UE moves out of or into the Area Of
Interest, the AMF also provides the requested Area Of Interest information in
the Location Reporting Control message. The AMF may include a Request
Reference ID in the Location Report Control message to identify the request of
reporting for an Area Of Interest. If multiple Areas Of Interest are included
in the message, the Request Reference ID identifies each Area of Interest.
NOTE 1: Requesting location whenever the UE changes cell can increase
signalling load on multiple interfaces. Requesting reports for all changes in
PSCell ID can further increase signalling load. Hence it is recommended that
any such reporting is only applied for a limited number of subscribers.
2\. NG-RAN to AMF: Location Report (UE Location, UE Presence in Area Of
Interest, Request Reference ID, Timestamp).
The NG-RAN sends a Location Report message informing the AMF about the
location of the UE which shall be represented as the requested Location
Reporting Level. If PSCell reporting is requested and Dual Connectivity is
activated, then the Master NG-RAN node shall also include the PSCell ID.
When UE is in CM-CONNECTED with RRC Inactive state, if NG-RAN has received
Location Reporting Control message from AMF with the Reporting Type indicating
single stand-alone report, the NG-RAN shall perform NG-RAN paging before
reporting the location to the AMF. The NG-RAN should send the Location Report
promptly and shall not wait to attempt to create a Dual Connectivity
configuration. However, if PSCell reporting is requested and the PSCell ID is
known to the Master RAN node, then it shall be included in the Location
Report.
When UE is in CM-CONNECTED with RRC Inactive state, if NG-RAN has received
Location Reporting Control message from AMF with the Reporting Type indicating
continuous reporting whenever the UE changes cell, the NG-RAN shall send a
Location Report message to the AMF including the UE\'s last known location
with time stamp. If the UE was using Dual Connectivity immediately before
entering CM-CONNECTED with RRC Inactive state and PSCell reporting is
requested, then the Location Report shall also include the PSCell ID.
When UE is in CM-CONNECTED, if NG-RAN has received Location Reporting Control
message from AMF with the Reporting Type of Area Of Interest based reporting,
the NG-RAN shall track the UE presence in Area Of Interest and send a Location
Report message to AMF including the UE Presence in the Area Of Interest (i.e.
IN, OUT, or UNKNOWN) as described in clause D.2 and the UE\'s current location
(including the PSCell ID if PSCell reporting is requested and Dual
Connectivity is activated) when the UE is in RRC Connected state, or, when the
UE is in RRC Inactive state, the UE\'s last known location (including the
PSCell ID if PSCell reporting is requested and the UE was using Dual
Connectivity immediately before entering CM-CONNECTED with RRC Inactive state)
with time stamp if the NG-RAN perceives that the UE presence in the Area Of
Interest is different from the last one reported. When the NG-RAN detects that
the UE has moved out of or into multiple areas of interest, it sends multiple
pairs of UE Presence in the Area Of Interest and the Request Reference ID in
one Location Report message to AMF. If UE transitions from RRC Inactive state
to RRC Connected state, NG-RAN shall check the latest location (including the
PSCell ID if PSCell reporting is requested and Dual Connectivity is activated)
of UE and follow the rules when UE is in RRC Connected.
The AMF stores the latest received PSCell ID with its associated timestamp.
The AMF stores the latest received PSCell ID with its associated timestamp,
when available.
3\. AMF to NG-RAN: Cancel Location Report (Reporting Type, Request Reference
ID).
The AMF can send a Cancel Location Reporting message to inform the NG-RAN that
it should terminate the location reporting for a given UE corresponding to the
Reporting Type or the location reporting for Area Of Interest indicated by
Request Reference ID. This message is needed when the reporting type was
requested for continuously reporting or for the Area Of Interest. The AMF may
include the Request Reference ID which indicates the requested Location
Reporting Control for the Area Of Interest, so that the NG-RAN should
terminate the location reporting for the Area Of Interest.
NOTE 2: Location reporting related information of the source NG-RAN node is
transferred to the target NG-RAN node during Xn handover.
In this Release the location reporting procedure is applicable only to 3GPP
access.
## 4.11 System interworking procedures with EPC
### 4.11.0 General
This clause includes procedures for interworking with EPS based on N26
interface (clause 4.11.1) and also interworking without N26 interface (clause
4.11.2).
### 4.11.0a Impacts to EPS Procedures
#### 4.11.0a.1 General
This clause captures changes to procedures in TS 23.401 [13] that are common
to interworking based on N26 and interworking without N26.
#### 4.11.0a.2 Interaction with PCC
When interworking with 5GS is supported and a \"PGW-C+SMF\" is selected for a
PDN connection, policy interactions between PDN GW and PCRF specified in TS
23.401 [13] are replaced by equivalent interactions between PGW-C+SMF and PCF
as follows:
\- IP-CAN Session Establishment procedure defined in TS 23.203 [24] is
replaced by SM Policy Association Establishment Procedure as described in
clause 4.16.4. The PGW-C+SMF includes the information elements received in
Create Session Request message into the Npcf_SMPolicyControl_Create Service as
follows: the SUPI contains the IMSI, the DNN contains the APN, the PEI
contains the IMEI-SV, the Session AMBR contains the APN-AMBR and the default
QoS information that contains the default EPS bearer QoS, note that QCI values
are mapped into 5QI values. The PGW-C+SMF may receive PCC Rules and PDU
Session Policy Information, 5G QoS information in the PCC Rule and in PDU
Session Policy Information are mapped into EPS QoS information as defined in
clause 4.11.1.1 and Annex C.
\- (PCEF-initiated) IP-CAN Session Modification procedure defined in TS 23.203
[24] is replaced by SM Policy Association Modification procedure as described
in clause 4.16.5.1.
\- The PGW-C+SMF includes the information elements received in Modify Bearer
Request or Modify Bearer Command message into the Npcf_SMPolicyControl_Update
Service with the following modifications, the subscribed Session AMBR includes
the subscribed APN-AMBR and subscribed default QoS information includes the
default EPS bearer QoS, note that QCI values are mapped into 5QI values. The
PGW-C+SMF includes the stored SUPI. The PGW-C+SMF may receive PCC Rules and
PDU Session Policy Information, 5G QoS information in the PCC Rule and in PDU
Session Policy Information are mapped into EPS QoS information as defined in
clause 4.11.1.1 and Annex C.
\- The PGW-C+SMF includes the information elements received in Delete Bearer
Command message into the Npcf_SMPolicyControl_Update Service with the
following modifications, The PGW-C+SMF includes the stored SUPI.
\- (PCRF-initiated) IP-CAN Session Modification procedure defined in TS 23.203
[24] is replaced by SM Policy Association Modification procedure as described
in clause 4.16.5.2. The PGW-C+SMF may receive PCC Rules and PDU Session Policy
Information, 5G QoS information in the PCC Rule and in PDU Session Policy
Information are mapped into EPS QoS information as defined in clause 4.11.1.1
and Annex C.
\- IP-CAN Session Termination procedure defined in TS 23.203 [24] is replaced
by SM Policy Association Termination procedure as described in clause 4.16.6.
The PGW-C+SMF includes the information elements received in Delete Session
Request message by the SMF+PGW-C into the Npcf_SMPolicyControl_Delete Service.
The PGW-C+SMF includes the stored SUPI.
#### 4.11.0a.3 Mobility Restrictions
The UE\'s subscription may include access restriction for NR in 5GS and
restriction for Core Network Type (5GC). If so, the HSS provides these
restrictions to the MME. The MME includes these restrictions in the Handover
Restriction List to the E-UTRAN. The MME and E-UTRAN use these restrictions to
determine if mobility of the UE to 5GS or NR connected to 5GS should be
permitted.
#### 4.11.0a.4 PGW Selection
When the UE requests to establish a non-emergency PDN connection to an APN,
the MME may use the UE\'s support for 5GC NAS indication included in the UE
Network Capability and/or UE\'s subscription from HSS that includes UE\'s
mobility restriction parameters related to 5GS and/or indication of support
for interworking with 5GS for this APN to determine if PGW-C+SMF or a
standalone PGW-C should be selected.
NOTE: If restriction for Core Network Type indicates that the UE can access to
5GC, it implies that the UE has 5G subscription data.
When the UE performs emergency Attach or requests to establish an emergency
PDN connection, the MME determines, based on the UE\'s support for 5GC NAS and
local configuration, if an emergency PGW-C+SMF or a standalone emergency PGW-C
should be selected, which also means that an emergency PGW-C+SMF may need to
be configured in Emergency Configuration Data in the MME.
#### 4.11.0a.5 PDN Connection Establishment
During establishment of non-emergency PDN connection in the EPC, the UE and
the PGW-C+SMF exchange information via PCO as described in clause 5.15.7 of TS
23.501 [2]. If the PGW-C+SMF supports more than one S-NSSAI and the APN is
valid for more than one S-NSSAI, before the PGW-C+SMF provides an S-NSSAI to
the UE, the PGW-C+SMF should check such that the selected S-NSSAI is among the
UE\'s subscribed S-NSSAIs by retrieving the Subscribed S-NSSAI from UDM using
the Nudm_SDM_Get service operation (the PGW-C+SMF discovers and selects a UDM
as described in clause 6.3.8 of TS 23.501 [2]). If the PGW-C+SMF is in a
VPLMN, the PGW-C+SMF uses the Nnssf_NSSelection_Get service operation to
retrieve a mapping of the Subscribed S-NSSAIs to Serving PLMN S-NSSAI values.
During establishment of emergency PDN connection,
\- The PGW-C+SMF is to be derived from the emergency APN or to be statically
configured in the Emergency Configuration Data in MME;
\- 5GC interworking support with N26 or without N26 is determined based on
UE\'s 5G NAS capability and local configuration.
One S-NSSAI is configured for the emergency APN in PGW-C+SMF and such S-NSSAI
is not sent to the UE by the PGW-C+SMF.
### 4.11.1 N26 based Interworking Procedures
#### 4.11.1.1 General
N26 interface is used to provide seamless session continuity for single
registration mode UE.
Interworking between EPS and 5GS is supported with IP address preservation by
assuming SSC mode 1.
When the UE is served by the 5GC, during PDU Session establishment and GBR QoS
Flow establishment, PGW-C+SMF performs EPS QoS mappings, from the 5G QoS
parameters obtained from the PCF and allocates TFT with the PCC rules obtained
from the PCF if PCC is deployed. Otherwise, EPS QoS mappings and TFT
allocation are mapped by the PGW-C+SMF locally. The PGW+SMF ignores 5G QoS
parameters that are not applicable to EPC (e.g. QoS Notification control). If
a TFT is to be allocated for a downlink unidirectional EPS bearer mapped from
a downlink only QoS Flow, the PGW-C+SMF shall allocate a TFT packet filter
that effectively disallows any useful uplink packet as specified in TS 23.401
[13]. EPS Bearer IDs are allocated by the serving AMF requested by the SMF if
the SMF determines that EPS Bearer IDs need to be assigned to the QoS Flows.
For each PDU Session, EPS bearer IDs are allocated to the default EPS bearer
and dedicated bearers. The SMF shall be able to determine the QoS flows that
require EPS Bearer IDs, based on the QoS profile and operator policies.
NOTE 1: Based on operator policies, an SMF can map all non-GBR QoS flows to
default EPS bearer in which case it requests only one EBI for all the non-GBR
QoS flows. Alternatively, an SMF can also map one non-GBR QoS flow to one
dedicated EPS bearer in which case it requests a dedicated EBI for non-GBR QoS
flow that should be mapped to dedicated EPS bearer.
For Ethernet and Unstructured PDU Session Types, only EPS Bearer ID for the
default EPS Bearer is allocated. The EPS Bearer IDs for these EPS bearers are
provided to the PGW-C+SMF by the AMF and are provided to the UE and NG-RAN by
the PGW-C+SMF using N1 SM NAS message and N2 SM message. The UE is also
provided with the mapped QoS parameters. The UE and the PGW-C+SMF store the
association between the QoS Flow and the corresponding EBI and the EPS QoS
parameters. When the QoS Flow is deleted e.g. due to PDU Session status
synchronization or PDU Session Modification, the UE and the PGW-C+SMF delete
any possibly existing EPS QoS parameters associated with the deleted QoS Flow.
In this release, for a PDU Session for a LADN or for Multi-homed IPv6 PDU
Session, the SMF doesn\'t allocate any EBI or mapped QoS parameters.
For PDU Sessions with UP integrity protection of UP Security Enforcement
Information set to Required, the SMF does not allocate any EBI or mapped QoS
parameters.
When the UE is served by the EPC, during PDN connection establishment, the UE
allocates the PDU Session ID and sends it to the PGW-C+SMF via PCO. During PDN
Connection establishment and dedicated bearer establishment, PGW-C+SMF
performs EPS QoS mappings, from the 5G QoS parameters obtained from the PCF
and allocates TFT with the PCC rules obtained from the PCF if PCC is deployed.
Otherwise, EPS QoS mappings and TFT allocation are mapped by the PGW-C+SMF
locally. Other 5G QoS parameters corresponding to the PDN connection, e.g.
Session AMBR and QoS rules and QoS Flow level QoS parameters if needed for the
QoS Flow(s) associated with the QoS rule(s), are sent to UE in PCO. The UE and
the PGW-C+SMF store the association between the EPS Context and the PDU
Session Context to use it in the case of handover from EPS to 5GS. During the
EPS bearer establishment/modification procedure, QoS rules corresponding to
the related EPS bearers are allocated and sent to UE in PCO. The 5G QoS
parameters are stored in the UE and are to be used when the UE is handed over
from EPS to the 5GS. The 5G QoS parameters may be provided to PGW-C+SMF by the
PCF, if PCC is deployed. On mobility from EPS to 5GS, the UE sets the SSC mode
of the mapped PDU Session to SSC mode 1. The UE and the PGW-C+SMF store the
association between the EPS bearer and the corresponding 5G QoS Rules and QoS
Flow level QoS parameters if needed for the QoS Flow(s) associated with the
QoS rule(s). When the EPS bearer is deleted e.g. due to EPS bearer status
synchronization or bearer deactivation, the UE and the PGW-C+SMF delete any
possibly existing 5G QoS Rule(s) and QoS Flow level QoS parameters if any for
the QoS Flow(s) associated with the QoS rule(s) associated with the deleted
EPS bearer.
In the roaming case, if the VPLMN supports interworking with N26, the UE shall
operate in Single Registration mode.
During the 5GS-EPS handover, indirect forwarding may apply for the downlink
data forwarding performed as part of the handover. From its configuration data
the AMF knows whether indirect forwarding applies and it requests to allocate
downlink data forwarding paths on UPFs for indirect forwarding. From its
configuration data the MME knows whether indirect forwarding applies and it
requests to allocate downlink data forwarding paths on Serving GWs for
indirect forwarding. It is configured on AMF and MME whether indirect downlink
data forwarding does not apply, applies always or applies only for inter PLMN
inter RAT handovers.
Direct data forwarding for inter-system handover between 5GS and EPS is not
supported in this Release.
During interworking from EPS to 5GS, as the PGW-C+SMF may have different IP
addresses when being accessed over S5/S8 and N11/N16 respectively, the AMF
shall discover the SMF instance by an NF/NF service discovery procedure using
the FQDN for the S5/S8 interface received from the MME as a query parameter.
This is required for both non-roaming and roaming with local breakout, as well
as for home routed roaming.
NOTE 2: As the AMF is not aware of the S-NSSAI assigned for the PDN
Connection, the NF/NF service discovery used to find the SMF instance can use
PLMN level NRF.
#### 4.11.1.2 Handover procedures
##### 4.11.1.2.1 5GS to EPS handover using N26 interface
Figure 4.11.1.2.1-1 describes the handover procedure from 5GS to EPS when N26
is supported.
In the case of handover to a shared EPS network, the source NG-RAN determines
a PLMN to be used in the target network as specified by TS 23.501 [2]. The
source NG-RAN shall indicate the selected PLMN ID to be used in the target
network to the AMF as part of the TAI sent in the HO Required message.
In the case of handover from a shared NG-RAN, the AMF may provide the MME with
an indication that the 5GS PLMN is a preferred PLMN at later change of the UE
to a 5GS shared networks.
During the handover procedure, as specified in clause 4.9.1.3.1, the source
AMF shall reject any PGW-C+SMF initiated N2 request received since handover
procedure started and shall include an indication that the request has been
temporarily rejected due to handover procedure in progress.
Upon reception of a rejection for an PGW-C+SMF initiated N2 request(s) with an
indication that the request has been temporarily rejected due to handover
procedure in progress, the PGW-C+SMF behaves as specified in TS 23.401 [13].
Figure 4.11.1.2.1-1: 5GS to EPS handover for single-registration mode with N26
interface
The procedure involves a handover to EPC and setup of default EPS bearer and
dedicated bearers for GBR QoS Flows in EPC in steps 1-16 and re-activation, if
required, of dedicated EPS bearers for non-GBR QoS Flows in step 19. This
procedure can be triggered, for example, due to new radio conditions, load
balancing or in the presence of QoS Flow for normal voice or IMS emergency
voice, the source NG-RAN node may trigger handover to EPC.
For Ethernet and Unstructured PDU Session Types, the PDN Type non-IP is used,
when supported, in EPS. The SMF shall thus set the PDN Type of the EPS Bearer
Context to non-IP in these cases. After the handover to EPS, the PDN
Connection will have PDN Type non-IP, but it shall be locally associated in UE
and SMF to PDU Session Type Ethernet or Unstructured respectively.
In the roaming home routed case, the PGW-C+SMF always provides the EPS Bearer
ID and the mapped QoS parameters to UE. The V-SMF caches the EPS Bearer ID and
the mapped QoS parameters obtained from H-SMF for this PDU session. This also
applies in the case that the HPLMN operates the interworking procedure without
N26.
NOTE 1: The IP address preservation cannot be supported, if PGW-C+SMF in the
HPLMN doesn\'t provide the mapped QoS parameters.
1\. NG-RAN decides that the UE should be handed over to the E-UTRAN. If NG-RAN
is configured to perform Inter RAT mobility due to IMS voice fallback
triggered by QoS flow setup and request to setup QoS flow for IMS voice was
received, NG-RAN responds indicating rejection of the QoS flow establishment
because of mobility due to fallback for IMS voice via N2 SM information and
triggers handover to E-UTRAN. The NG-RAN sends a Handover Required (Target eNB
ID, Direct Forwarding Path Availability, Source to Target Transparent
Container, inter system handover indication) message to the AMF. NG-RAN
indicates bearers corresponding to the 5G QoS Flows for data forwarding in
Source to Target Transparent Container.
If the handover is triggered due to Emergency fallback, the NG-RAN may forward
the Emergency indication to the target eNB in the Source to Target Transparent
Container and the target eNB allocates radio bearer resources taking received
indication into account.
2\. The AMF determines from the \'Target eNB Identifier\' IE that the type of
handover is Handover to E-UTRAN. The AMF selects an MME as described in clause
4.3.8.3 of TS 23.401 [13].
In the case of HR roaming, the AMF by using Nsmf_PDUSession_Context Request
requests the V-SMF to provide SM Context that also includes the mapped EPS
Bearer Contexts. The AMF provides the target MME capability to SMF in the
request to allow the V-SMF to determine whether to include EPS Bearer context
for non-IP PDN Type or not. For PDU Sessions with PDU Session Type Ethernet or
Unstructured, the SMF provides SM Context for non-IP PDN Type.
In the case of non-roaming or LBO roaming, the AMF request PGW-C+SMF to
provide SM Context by using Nsmf_PDUSession_ContextRequest. The AMF provides
the target MME capability to PGW-C+SMF in the request to allow the PGW-C+SMF
to determine whether to include EPS Bearer context for non-IP PDN Type or not.
For PDU Sessions with PDU Session Type Ethernet or Unstructured, the SMF
provides SM Context for non-IP PDN Type. The PGW-C+SMF send N4 Session
modification to PGW-U+UPF to establish the CN tunnel for each EPS bearer and
provide EPS Bearer Contexts to AMF, as described in step 8 of clause
4.11.1.4.1. The PGW-U+UPF is ready to receive the uplink packet from E-UTRAN.
This step is performed with all the PGW-C+SMFs corresponding to PDU Sessions
of the UE which are associated with 3GPP access and have EBI(s) allocated to
them.
NOTE 2: The AMF knows the MME capability to support non-IP PDN type or not
through local configuration.
NOTE 3: In home routed roaming scenario, the UE\'s SM EPS Contexts are
obtained from the V-SMF.
3\. The AMF sends a Forward Relocation Request as in Step 2 in clause
5.5.1.2.2 (S1-based handover, normal) in TS 23.401 [13], with the following
modifications and clarifications:
\- Parameter \"Return preferred\" may be included. Return preferred is an
optional indication by the MME of a preferred return of the UE to the 5GS PLMN
at a later access change to a 5GS shared network. An MME may use this
information as specified by TS 23.501 [2].
\- The SGW address and TEID for both the control-plane or EPS bearers in the
message are such that target MME selects a new SGW. The AMF determines, based
on configuration and whether the Direct Forwarding Path Availability is
present or not, if direction forwarding is possible and includes the Direct
Forwarding Flag to inform the target MME whether direct data forwarding is
applicable.
NOTE 4: In this Release, direct data forwarding for inter-system handover
between 5GS and EPS is not supported, so the Direct Forwarding Path
Availability is always not provided by NG-RAN.
The AMF includes the mapped SM EPS UE Contexts for PDU Sessions with and
without active UP connections.
4-5. Step 4 and 4a respectively in clause 5.5.1.2.2 (S1-based handover,
normal) in TS 23.401 [13].
6\. Step 5 (Handover Request) in clause 5.5.1.2.2 (S1-based handover, normal)
in TS 23.401 [13] with the following modification:
\- Handover Request may contain information Handover Restriction List with
information about PLMN IDs as specified by clause 5.2a of TS 23.251 [35] for
eNodeB functions.
\- The target eNB should establish E-RABs indicated by the list of EPS bearer
to be setup provided by the MME, even if they are not included in the source
to target container.
7-9. Step 5a through 7 in clause 5.5.1.2.2 (S1-based handover, normal) in TS
23.401 [13].
10a. If indirect data forwarding applies, the AMF sends the
Nsmf_PDUSession_UpdateSMContext Request (Serving GW Address(es) and Serving GW
DL TEID(s) for data forwarding) to the PGW-C+SMF, for creating indirect data
forwarding tunnel. If multiple PGW-C+SMFs serves the UE, the AMF maps the EPS
bearers for Data forwarding to the PGW-C+SMF address(es) based on the
association between the EPS bearer ID(s) and PDU Session ID(s). In home-routed
roaming case, the AMF requests the V-SMF to create indirect forwarding tunnel.
10b. The PGW-C+SMF may select an intermediate PGW-U+UPF for data forwarding.
The PGW-C+SMF maps the EPS bearers for Data forwarding to the 5G QoS flows
based on the association between the EPS bearer ID(s) and QFI(s) for the QoS
flow(s) in the PGW-C+SMF and then sends the QFIs, Serving GW Address(es) and
TEID(s) for data forwarding to the PGW-U+UPF. If CN Tunnel Info for Data
Forwarding is allocated by the PGW-C+SMF, the CN Tunnel Info for Data
Forwarding is provided to PGW-U+UPF in this step. The PGW-U+UPF acknowledges
by sending a response. If CN Tunnel Info is allocated by the PGW-U+UPF, the CN
Tunnel Info is provided to PGW-C+SMF in this response. In home-routed roaming
case, the V-SMF selects the V-UPF for data forwarding.
10c. The PGW-C+SMF returns an Nsmf_PDUSession_UpdateSMContext Response (Cause,
CN tunnel Info for Data Forwarding, QoS flows for Data Forwarding) for
creating indirect data forwarding. Based on the correlation between QFI(s) and
Serving GW Address(es) and TEID(s) for data forwarding, the PGW-U+UPF maps the
QoS flow(s) into the data forwarding tunnel(s) in EPC.
11\. The AMF sends the Handover Command to the source NG-RAN (Transparent
container (radio aspect parameters that the target eNB has set-up in the
preparation phase), CN tunnel info for data forwarding per PDU Session, QoS
flows for Data Forwarding). The source NG-RAN commands the UE to handover to
the target access network by sending the HO Command. The UE correlates the
ongoing QoS Flows with the indicated EPS Bearer IDs to be setup in the HO
command. The UE locally deletes the PDU Session if the QoS Flow associated
with the default QoS rule in the PDU Session does not have an EPS Bearer ID
assigned. If the QoS Flow associated with the default QoS rule has an EPS
Bearer ID assigned, the UE keeps the PDU Session (PDN connection) and for the
remaining QoS Flow(s) that do not have EPS bearer ID(s) assigned, the UE
locally deletes the QoS rule(s) and the QoS Flow level QoS parameters if any
associated with those QoS Flow(s) and notifies the impacted applications that
the dedicated QoS resource has been released. The UE deletes any UE derived
QoS rules. The EPS Bearer ID that was assigned for the QoS flow of the default
QoS rule in the PDU Session becomes the EPS Bearer ID of the default bearer in
the corresponding PDN connection.
For the QoS Flows indicated in the \"QoS Flows for Data Forwarding\", NG-RAN
initiate data forwarding via to the PGW-U+UPF based on the CN Tunnel Info for
Data Forwarding per PDU Session. Then the PGW-U+UPF maps data received from
the data forwarding tunnel(s) in the 5GS to the data forwarding tunnel(s) in
EPS and sends the data to the target eNodeB via the Serving GW.
12-12c. Step 13 to step 14 from clause 5.5.1.2.2 (S1-based handover, normal)
in TS 23.401 [13] with the following clarification:
\- The AMF request the release of the PDU Session which is associated with
3GPP access, not expected to be transferred to EPC, i.e. no EBI(s) allocated
to them and corresponding to the PGW-C+SMF which is not contacted by AMF for
SM context at step 2.
12d. The AMF acknowledges MME with Relocation Complete Ack message. A timer in
AMF is started to supervise when resource in NG-RAN shall be released.
12e. In the case of home routed roaming, the AMF invokes
Nsmf_PDUSession_ReleaseSMContext Request (Vâ€‘SMF only indication) to the V-SMF.
This service operation requests the V-SMF to remove only the SM context in the
V-SMF, i.e. not release PDU Session context in the PGW-C+SMF.
If indirect forwarding tunnel(s) were previously established, the V-SMF starts
a timer and releases the SM context on expiry of the timer. If no indirect
forwarding tunnel has been established, the V-SMF immediately release the SM
context and its UP resources for this PDU Session in V-UPF locally.
13\. Step 15 from clause 5.5.1.2.2 (S1-based handover, normal) in TS 23.401
[13].
14a. Step 16 (Modify Bearer Request) from clause 5.5.1.2.2 (S1-based handover,
normal) in TS 23.401 [13] with the following clarification:
\- The PGW-C+SMF deletes the PDU Session if the QoS Flow associated with the
default QoS rule in the PDU Session does not have an EPS Bearer ID assigned.
If the QoS Flow associated with the default QoS rule has an EPS Bearer ID
assigned, the PGW-C+SMF keeps the PDU Session (PDN connection) and for the
remaining QoS Flows that do not have EPS bearer ID(s) assigned, the PGW-C+SMF
deletes the PCC rule(s) associated with those QoS Flows and informs the PCF
about the removed PCC rule(s).
NOTE 5: If the QoS flow is deleted, the IP flows of the deleted QoS rules will
continue flowing on the default EPS bearer if it does not have an assigned
TFT. If the default EPS bearer has an assigned TFT, the IP flows of the
deleted QoS Flow may be interrupted until step 19 when dedicated bearer
activation is triggered by a request from the PCF.
The PGW-C+SMF may need to report some subscribed event to the PCF by
performing an SMF initiated SM Policy Association Modification procedure as
defined in clause 4.16.5.
15\. The PGW-C+SMF initiates a N4 Session Modification procedure towards the
UPF+PGW-U to update the User Plane path, i.e. the downlink User Plane for the
indicated PDU Session is switched to E-UTRAN. The PGW-C+SMF releases the
resource of the CN tunnel for PDU Session in UPF+PGW-U.
16\. Step 16a (Modify Bearer Response) from clause 5.5.1.2.2 (S1-based
handover, normal) in TS 23.401 [13]. At this stage the User Plane path is
established for the default bearer and the dedicated EPS bearers between the
UE, target eNodeB, Serving GW and the PGW-U+UPF. The PGW-C+SMF uses the EPS
QoS parameters as assigned for the dedicated EPS bearers during the QoS Flow
establishment. PGW-C+SMF maps all the other IP flows to the default EPS bearer
(see NOTE 4).
If indirect forwarding tunnel(s) were previously established, the PGW-C+SMF
starts a timer, to be used to release the resource for indirect data
forwarding.
17\. Step 17 from clause 5.5.1.2.2 (S1-based handover, normal) in TS 23.401
[13].
18\. The UE initiates a Tracking Area Update procedure as specified in step 11
of clause 5.5.1.2.2 (S1-based handover, normal) in TS 23.401 [13].
This includes the deregistration of the old AMF for 3GPP access from the
HSS+UDM as specified in clause 4.11.1.5.3. Any registration associated with
the non-3GPP access in the old AMF is not removed (i.e. an AMF that was
serving the UE over both 3GPP and non-3GPP accesses does not consider the UE
as deregistered over non 3GPP access and will remain registered and subscribed
to subscription data updates in UDM).
NOTE 6: The behaviour whereby the HSS+UDM cancels location of CN node of the
another type, i.e. AMF, is similar to HSS behaviour for MME and Gn/Gp SGSN
registration (see TS 23.401 [13]). The target AMF that receives the cancel
location from the HSS+UDM is the one associated with 3GPP access.
When the UE decides to deregister over non-3GPP access or the old AMF decides
not to maintain a UE registration for non-3GPP access anymore, the old AMF
then deregisters from UDM by sending a Nudm_UECM_Deregistration service
operation, unsubscribes from Subscription Data updates by sending an
Nudm_SDM_Unsubscribe service operation to UDM and releases all the AMF and AN
resources related to the UE.
19\. If PCC is deployed, the PCF may decide to provide the previously removed
PCC rules to the PGW-C+SMF again thus triggering the PGW-C+SMF to initiate
dedicated bearer activation procedure. This procedure is specified in clause
5.4.1 of TS 23.401 [13] with modification captured in clause 4.11.1.5.4. For
Ethernet PDU Session Type, using non-IP PDN Type in EPS, this step is not
applicable.
20\. Step 21 from clause 5.5.1.2.2 (S1-based handover, normal) in TS 23.401
[13].
21\. In the case of home routed roaming, at the expiry of the timer at V-SMF
started at step 12e, the V-SMF locally releases the SM context and the UP
resource for the PDU Session including the resources used for indirect
forwarding tunnel(s) that were allocated at step 10.
In non-roaming or local breakout roaming, if PGW-C+SMF has started a timer in
step 16, at the expiry of the timer, the PGW-C+SMF sends N4 Session
Modification Request to PGW-U+UPF to release the resources used for the
indirect forwarding tunnel(s) that were allocated at step 10.
When the timer set in step 12d expires, AMF also sends a UE Context Release
Command message to the source NG RAN. The source NG RAN releases its resources
related to the UE and responds with a UE Context Release Complete message.
##### 4.11.1.2.2 EPS to 5GS handover using N26 interface
##### 4.11.1.2.2.1 General {#general-21 .H6}
N26 interface is used to provide seamless session continuity for single
registration mode.
The procedure involves a handover to 5GS and setup of QoS Flows in 5GS.
In the home routed roaming case, the PGW-C+ SMF in the HPLMN always receives
the PDU Session ID from UE and provides PDN Connection associated 5G QoS
parameter(s) and S-NSSAI to the UE. This also applies in the case that the
HPLMN operates the interworking procedure without N26.
In the case of handover to a shared 5GS network, the source E-UTRAN determines
a PLMN to be used in the target network as specified by clause 5.2a of TS
23.251 [35] for eNodeB functions. A supporting MME may provide the AMF via N26
with an indication that source EPS PLMN is a preferred PLMN when that PLMN is
available at later change of the UE to an EPS shared network.
If the PDN Type of a PDN Connection in EPS is non-IP and is locally associated
in UE and SMF to PDU Session Type Ethernet or Unstructured, the PDU Session
Type in 5GS shall be set to Ethernet or Unstructured respectively.
NOTE: The IP address continuity can\'t be supported, if PGW-C+SMF in the HPLMN
doesn\'t provide the mapped QoS parameters.
##### 4.11.1.2.2.2 Preparation phase {#preparation-phase-1 .H6}
Figure 4.11.1.2.2.2-1 shows the preparation phase of the Single Registration-
based Interworking from EPS to 5GS procedure.
Figure 4.11.1.2.2.2-1: EPS to 5GS handover using N26 interface, preparation
phase
This procedure applies to the Non-Roaming (TS 23.501 [2] Figure 4.3.1-1),
Home-routed roaming (TS 23.501 [2] Figure 4.3.2-1) and Local Breakout roaming
Local Breakout (TS 23.501 [2] Figure 4.3.2-2) cases.
\- For non-roaming scenario, V-SMF, v-UPF and v-PCF are not present
\- For home-routed roaming scenario, the PGW-C+SMF and UPF+PGW-U are in the
HPLMN. v-PCF are not present
\- For local breakout roaming scenario, V-SMF and v-UPF are not present.
PGW-C+SMF and UPF+PGW-U are in the VPLMN.
In local-breakout roaming case, the v-PCF interacts wit the PGW-C+SMF.
1 - 2. Step 1 - 2 from clause 5.5.1.2.2 (S1-based handover, normal) in TS
23.401 [13].
3\. Step 3 from clause 5.5.1.2.2 (S1-based handover, normal) in TS 23.401 [13]
with the following modifications:
An additional optional parameter Return preferred. Return preferred is an
optional indication provided by the MME to indicate a preferred return of the
UE to the last used EPS PLMN at a later access change to an EPS shared
network. Based on the Return Preferred indication, the AMF may store the last
used EPS PLMN ID in the UE Context.
The AMF converts the received EPS MM Context into the 5GS MM Context. This
includes converting the EPS security context into a mapped 5G security context
as described in TS 33.501 [15]. The MME UE context includes IMSI, ME Identity,
UE security context, UE Network Capability and EPS Bearer context(s). The MME
EPS Bearer context(s) include for each EPS PDN connection the IP address and
FQDN for the S5/S8 interface of the PGW-C+SMF and APN and for each EPS bearer
the IP address and CN Tunnel Info at the UPF+PGW-U for uplink traffic.
The AMF queries the (PLMN level) NRF in serving PLMN by issuing the
Nnrf_NFDiscovery_Request including the FQDN for the S5/S8 interface of the
PGW-C+SMF and the NRF provides the IP address or FQDN of the N11/N16 interface
of the PGW-C+SMF.
If the AMF cannot retrieve the address of the corresponding SMF for a PDN
connection, it will not move the PDN connection to 5GS.
NOTE 1: If the AMF holds a native 5G security context for the UE, the AMF may
activate this native 5G security context by initiating a NAS SMC upon
completing the handover procedure.
4\. The AMF invokes the Nsmf_PDUSession_CreateSMContext service operation (UE
EPS PDN Connection, AMF ID, dataForwarding Flag, Target ID) on the SMF
identified by the PGW-C+SMF address and indicates HO preparation indication
(to avoid switching the UP path). The AMF ID is the UE\'s GUAMI which uniquely
identifies the AMF serving the UE. This step is performed for each PDN
Connection and the corresponding PGW-C+SMF address/ID in the UE context the
AMF received in step 3. The SMF finds the corresponding PDU Session based on
EPS Bearer Context(s).
Based on configuration and the Direct Forwarding Flag received from the MME,
the AMF determines the applicability of indirect data forwarding and a
dataDirect Forwarding Flag to inform the SMF of the applicability of indirect
data forwarding.
Target ID corresponds to Target ID provided by the MME in step 3.
For home-routed roaming scenario, the AMF selects a default V-SMF per PDU
Session and invokes the Nsmf_PDUSession_CreateSMContext service operation (UE
PDN Connection Contexts, AMF ID, SMF + PGW-C address, S-NSSAI). The S-NSSAI is
the S-NSSAI configured in AMF for interworking, which is associated with
default V-SMF. The default V-SMF put this S-NSSAI in the N2 SM Information
container in step 7.
The V-SMF selects the PGW-C+SMF using the received H-SMF address as received
from the AMF and initates a Nsmf_PDUSession_Create service operation with the
PGW-C+SMF.
5\. If dynamic PCC is deployed, the SMF+ PGW-C (V-SMF via H-SMF for home-
routed scenario) may initiate SMF initiated SM Policy Modification towards the
PCF.
6\. In the case of non-roaming or LBO roaming, the PGW-C+SMF may send N4
Session modification to PGW-U+UPF to establish the CN tunnel for PDU Session.
The PGW-U+UPF is ready to receive the uplink packets from NG-RAN. If the CN
Tunnel info is allocated by the PGW-C+SMF, the PGW-U tunnel info for PDU
session is provided to PGW-U+UPF. If the CN Tunnel info is allocated by
PGW-U+UPF, the PGW-U+UPF sends the PGW-U tunnel info for PDU Session to the
PGW-C+SMF. This step is performed at all PGW-C+SMFs allocated to the UE for
each PDU Session of the UE.
NOTE 2: If the CN Tunnel info is not available in the PGW-U+UPF at this step,
when the UE moves to the target RAT the PGW-U+UPF cannot receive UL data until
the Tunnel Info is provided to the PGW-U+UPF. This causes a short interruption
to the UL data during the handover execution phase.
7\. The PGW-C+SMF (V-SMF in the case of home-routed roaming scenario only)
sends a Nsmf_PDUSession_CreateSMContext Response (PDU Session ID, S-NSSAI,
allocated EBIs, N2 SM Information (PDU Session ID, S-NSSAI, QFI(s), QoS
Profile(s), EPS Bearer Setup List, Mapping between EBI(s) and QFI(s), CN
Tunnel-Info, cause code)) to the AMF.
For home-routed roaming scenario the step 8 need be executed first. The CN
Tunnel-Info provided to the AMF in N2 SM Information is the V-CN Tunnel-Info.
SMF includes mapping between EBI(s) and QFI(s) as part of N2 SM Information
container. If the P-GW-C+SMF (H-SMF in the case of home-routed scenario)
determines that seamless session continuity from EPS to 5GS is not supported
for the PDU Session, then it does not provide SM information for the
corresponding PDU Session but includes the appropriate cause code for
rejecting the PDU Session transfer within the N2 SM Information. If the
dataForwarding Flag indicates indirect forwarding and there is no indirect
data forwarding connectivity between source and target, the SMF shall further
include a \"Data forwarding not possible\" indication in the N2 SM information
container. In home routed roaming case, the S-NSSAI included in N2 SM
Information container is the S-NSSAI received in step 4.
AMF stores an association of the PDU Session ID, S-NSSAI and the SMF ID. The
AMF stores also the allocated EBI(s) associated to the PDU Session ID.
If the PDN Type of a PDN Connection in EPS is non-IP and is locally associated
in SMF to PDU Session Type Ethernet, the PDU Session Type in 5GS shall be set
to Ethernet. If the PDN type of a PDN Connection in EPS is non-IP and is
locally associated in UE and SMF to PDU Session Type Unstructured, the PDU
Session Type in 5GS shall be set to Unstructured.
In the case of PDU Session Type Ethernet, that was using PDN type non-IP in
EPS, the SMF creates QoS rules and QoS Flow level QoS parameters for the QoS
Flow(s) associated with the QoS rule(s) based on the PCC Rules received from
PCF.
8\. For home-routed roaming scenario only: The V-SMF selects a v-UPF and
initiates an N4 Session Establishment procedure with the selected v-UPF. The
V-SMF provides the v-UPF with packet detection, enforcement and reporting
rules to be installed on the UPF for this PDU Session, including H-CN Tunnel
Info. If CN Tunnel Info is allocated by the SMF, the V-CN Tunnel Info is
provided to the v-UPF in this step.
The v-UPF acknowledges by sending an N4 Session Establishment Response
message. If CN Tunnel Info is allocated by the UPF, the V-CN Tunnel info is
provided to the V-SMF in this step.
9\. The AMF sends a Handover Request (Source to Target Transparent Container,
N2 SM Information (PDU Session ID, S-NSSAI, QFI(s), QoS Profile(s), EPS Bearer
Setup List, V-CN Tunnel Info, Mapping between EBI(s) and QFI(s)), Mobility
Restriction List) message to the NG-RAN. The AMF provides NG-RAN with a PLMN
list in the Mobility Restriction List containing at least the serving PLMN,
taking into account the last used EPS PLMN ID and the Return preferred
indication. The Mobility Restriction List contain information about PLMN IDs
as specified by TS 23.501 [2].
NG-RAN can use the source to target transparent container and N2 SM
Information container to determine which QoS flows have been proposed for
forwarding and decide for which of those QoS flows it accepts the data
forwarding or not.
10\. The NG-RAN sends a Handover Request Acknowledge (Target to Source
Transparent Container, List of PDU Sessions to Hand-over with N2 SM response
(PDU Session ID, list of accepted QFI(s), AN Tunnel Info, N3 Tunnel Info for
data forwarding), List of PDU Sessions that failed to be established with the
failure cause given in the N2 SM information element) message to the AMF. The
NG-RAN includes one assigned TEID/TNL address per PDU Session (for which there
is at least one QoS flow for which it has accepted the forwarding) within the
SM Info container. It also includes the list of QoS flows for which it has
accepted the forwarding. According to the mapping between EBI(s) and QFI(s),
if one EPS bearer in EPS is mapped to multiple QoS flows in 5GS, all such QoS
flows need to be accepted to support indirect data forwarding during EPS to
5GS mobility. Otherwise, the NG RAN rejects the indirect data forwarding for
the QoS flows which are mapped to the EPS bearer.
11\. The AMF sends an Nsmf_PDUSession_UpdateSMContext Request (PDU Session ID,
N2 SM response received from NG-RAN in step 10) message to the SMF for
updating N3 tunnel information. In home routed roaming case, the N3 Tunnel
Info for data forwarding is handled by the V-SMF and will not be sent to the
PGW-C+SMF.
12\. PGW-C+SMF (V-SMF in home-routed roaming scenario) performs preparations
for N2 Handover by indicating N3 UP address and Tunnel ID of NG-RAN to the UPF
if N2 Handover is accepted by NG-RAN and by indicating the mapping between the
TEID where the UPF receives data forwarded by the source SGW and the QFI(s)
and N3 Tunnel Info for data forwarding where the UPF is selected to forward
such data (e.g. an intermediate UPF). If the EPS bearer is mapped to multiple
QoS flows and an intermediate UPF is selected for data forwarding, only one
QFI is selected by the PGW-C+SMF from QFIs corresponding to the QoS flows.
In home routed roaming case, the V-SMF sends a V-UPF for data forwarding the
mapping between the TEID where the UPF receives data forwarded by the source
SGW and the QFI and N3 Tunnel Info for data forwarding. If the EPS bearer is
mapped to multiple QoS flows and an intermediate UPF is selected for data
forwarding, only one QFI is selected by the PGW-C+SMF from QFIs corresponding
to the QoS flows.
If N2 Handover is not accepted by NG-RAN, PGW-C+SMF deallocates N3 UP address
and Tunnel ID of the selected UPF.
The EPS Bearer Setup list is a list of EPS bearer Identifiers successfully
handover to 5GC, which is generated based on the list of accepted QFI(s).
If a PDU Session is rejected by the Target NG-RAN with an indication that the
PDU session was rejected because User Plane Security Enforcement is not
supported in the Target NG-RAN and the User Plane Enforcement Policy indicates
\"Required\" as described in clause 5.10.3 of TS 23.501 [2], the SMF triggers
the release of this PDU Session. In all other cases of PDU Session rejection,
the SMF can decide whether to release the PDU Session or to deactivate the UP
connection of this PDU Session.
If some of the QoS Flows of a PDU Session are not accepted by the Target NG-
RAN, the SMF shall initiate the PDU Session Modification procedure to remove
the non-accepted QoS Flows from the PDU Session(s) after the handover
procedure is completed.
13\. PGW-C+SMF (V-SMF in home-routed roaming scenario) to AMF:
Nsmf_PDUSession_UpdateSMContext _Response (_ PDU Session ID, EPS Bearer Setup
List, CN tunnel information for data forwarding _). In home routed roaming
case, the V-SMF provides the CN tunnel information for data forwarding._
This message is sent for each received Nsmf_PDUSession_UpdateSMContext_Request
message.
14\. The AMF sends the message Forward Relocation Response (Cause, Target to
Source Transparent Container, Serving GW change indication, CN Tunnel Info for
data forwarding, EPS Bearer Setup List, AMF Tunnel Endpoint Identifier for
Control Plane, Addresses and TEIDs). The EPS Bearer Setup list is the
combination of EPS Bearer Setup list from different PGW-C+SMF(s).
15\. Step 8 from clause 5.5.1.2.2 (S1-based handover, normal) in TS 23.401
[13].
##### 4.11.1.2.2.3 Execution phase {#execution-phase-1 .H6}
Figure 4.11.1.2.2.3-1 shows the Single Registration-based Interworking from
EPS to 5GS procedure.
Figure 4.11.1.2.2.3-1: EPS to 5GS handover using N26 interface, execution
phase
NOTE: Step 6 P-GW-C+SMF Registration in the UDM is not shown in the figure for
simplicity.
1 - 2. Step 9 - 11 from clause 5.5.1.2.2 (S1-based handover, normal) in TS
23.401 [13]. Different from step 9a of clause 5.5.1.2.2 (S1-based handover,
normal) in TS 23.401 [13], upon reception of Handover Command, the UE will
keep the QoS Flow context for which it did not receive the corresponding radio
resources in the NG-RAN until the QoS Flow is released by the network using
PDU Session Modification procedure in clause 4.3.3. If the QoS Flow with a
default QoS Rule of a PDU Session does not have the corresponding radio
resources in the NG-RAN, UE considers that the user plane of this PDU Session
is deactivated.
3\. Handover Confirm: the UE confirms handover to the NG-RAN.
The UE moves from the E-UTRAN and synchronizes with the target NG-RAN. The UE
may resume the uplink transmission of user plane data only for those QFIs and
Session IDs for which there are radio resources allocated in the NG-RAN.
The E-UTRAN performs indirect data forwarding via the SGW and the v-UPF. The
v-UPF forwards the data packets to the NG-RAN using the N3 Tunnel Info for
data forwarding, adding the QFI information. The target NG-RAN prioritizes the
forwarded packets over the fresh packets for those QoS flows for which it had
accepted data forwarding.
4\. Handover Notify: the NG-RAN notifies to the AMF that the UE is handed over
to the NG-RAN.
5\. Then the AMF knows that the UE has arrived to the target side and informs
the MME by sending a Forward Relocation Complete Notification message.
6\. Step 14 from clause 5.5.1.2.2 (S1-based handover, normal) in TS 23.401
[13].
7\. AMF to SMF +PGW-C (V-SMF in the case of roaming and Home-routed case):
Nsmf_PDUSession_UpdateSMContext Request (Handover Complete indication for PDU
Session ID).
Handover Complete is sent per each PDU Session to the corresponding SMF +PGW-C
to indicate the success of the N2 Handover.
If indirect forwarding is used, a timer in SMF+PGW-C (V-SMF in the case of
roaming and Home-routed case) is started to supervise when resources in UPF
(for indirect data forwarding) shall be released.
8\. The SMF + PGW-C (V-SMF in the case of roaming and Home-routed case)
updates the UPF + PGW-U with the V-CN Tunnel Info, indicating that downlink
User Plane for the indicated PDU Session is switched to NG-RAN and the CN
tunnels for EPS bearers corresponding to the PDU session can be released.
9\. If PCC infrastructure is used, the SMF + PGW-C informs the PCF about the
change of, for example, the RAT type and UE location.
10\. SMF +PGW-C to AMF: Nsmf_PDUSession_UpdateSMContext Response (PDU Session
ID).
SMF +PGW-C confirms reception of Handover Complete.
\- If the SMF has not yet registered for this PDU Session ID, then the SMF
registers with the UDM using Nudm_UECM_Registration (SUPI, DNN, PDU Session
ID) for a given PDU Session as in step 4 of PDU Session Establishment
Procedure in clause 4.3.2.
11\. For home-routed roaming scenario: The V-SMF provides to the v-UPF with
the N3 DL AN Tunnel Info and the N9 UL CN Tunnel Info.
12\. The UE performs the EPS to 5GS Mobility Registration Procedure from step
2 in clause 4.11.1.3.3. The UE includes the UE Policy Container containing the
list of PSIs, indication of UE support for ANDSP and OSId if available. If the
UE holds a native 5G-GUTI it also includes the native 5G-GUTI as an additional
GUTI in the Registration Request. The UE shall select the 5G-GUTI for the
additional GUTI as follows, listed in decreasing order of preference:
\- a native 5G-GUTI assigned by the PLMN to which the UE is attempting to
register, if available;
\- a native 5G-GUTI assigned by an equivalent PLMN to the PLMN to which the UE
is attempting to register, if available;
\- a native 5G-GUTI assigned by any other PLMN, if available.
The additional GUTI enables the AMF to find the UE\'s 5G security context (if
available). The AMF provides NG-RAN with a PLMN list in the Handover
Restriction List containing at least the serving PLMN, taking into account of
the last used EPS PLMN ID and Return preferred indication as part of the
Registration procedure execution and AMF signaling to NG-RAN. The Handover
Restriction List contains a list of PLMN IDs as specified by TS 23.501 [2].
13\. Step 19 from clause 5.5.1.2.2 (S1-based handover, normal) in TS 23.401
[13]. Step 20a - 20b from clause 5.5.1.2.2 (S1-based handover, normal) in TS
23.401 [13], with the following modification:
According to configuration, for the PDN connections which are anchored in a
standalone PGW, the MME initiates PDN connection release procedure as
specified in TS 23.401 [13].
14\. If indirect forwarding was used, then the expiry of the timer started at
step 7 triggers the SMF+PGW-C (V-SMF in the case of roaming and Home-routed
case) to release temporary resources used for indirect forwarding that were
allocated at steps 11 to 13 in clause 4.11.1.2.2.2.
##### 4.11.1.2.3 Handover Cancel
Instead of completing the handover procedure, the source RAN node (NG-RAN,
E-UTRAN) may at any time, during the handover procedure, up to the time when a
handover command message is sent to the UE, cancel the handover. The reason
for cancelling may be e.g. due to a timer expiration or due to other events
within the source RAN node and is initiated by sending a handover cancel
message to the source CN node (AMF or MME).
A handover cancel message shall also be sent by the source RAN node after a
handover command message is sent to the UE for the case where the handover
fails and the UE returns to the old cell or radio contact with the UE is lost.
This is done in order to release the resources reserved for the handover in
the target system.
Figure 4.11.1.2.3-1: Handover Cancel procedure
1\. When the source RAN (NG-RAN, E-UTRAN) decides to cancel the handover to
the target system, the source RAN initiates handover cancel message to the
source CN node (AMF or MME).
2\. After receiving the handover cancel message from the source RAN, if the
source CN node or the target CN node is MME, it sends a \"Relocation Cancel
Request\" message to the target CN node (MME or AMF). If both the source CN
node and target CN node are AMF, the source AMF invokes the
Namf_Communication_ReleaseUEContext Request (SUPI, PDU Session IDs, Relocation
Cancel Indication) toward the target AMF.
3\. The target CN node (MME or AMF) triggers release of resources towards
target RAN node. The target RAN node releases the AN resources allocated for
the handover.
4\. If the target CN node is MME, the MME sends the \"delete session request
(IMSI, Relocation Cancel Indication) to the SGW/SGW-C (see clause 5.5.2.5.2,
TS 23.401 [13]). If the target CN node is AMF, the AMF invokes the
\"Nsmf_PDUSession_UpdateSMContext request (SUPI, Relocation Cancel Indication)
toward the SMF. Based on the Relocation Cancel Indication, the target CN node
deletes the session resources established during handover preparation phase in
SGW(SGW-C and SGW-U)/(SMF and UPF).
4a. [Conditional] The SGW(SGW-C)/SMF releases the corresponding resource in
the SGW-U/(T-UPF and/or S-UPF) if allocated during the handover preparation.
5\. The target CN node (MME or AMF) sends \"Relocation Cancel Response\"
towards the source CN node (AMF or MME).
6\. The source CN node (AMF or MME) responds with handover cancel ACK towards
the source RAN.
7\. If indirect forwarding tunnel is setup during handover preparation phase
then cancellation of handover triggers the source CN node to release the
temporary resources used for indirect forwarding.
8\. If indirect forwarding tunnel is setup during handover preparation phase
then cancellation of handover triggers the target CN node to release the
temporary resources used for indirect forwarding.
#### 4.11.1.3 Idle Mode Mobility procedures
##### 4.11.1.3.1 General
When a UE moves from EPC to 5GC, the UE always performs Registration
procedure.
When a UE moves from 5GC to EPC, the UE performs either Tracking Area Update
or Initial Attach.
The UE performs Tracking Area Update procedure if
\- Both the UE and the EPC support \"attach without PDN connectivity\", or
\- The UE has at least one PDU Session for which Session Continuity is
supported during interworking, i.e. the UE has EPS Bearer ID and mapped EPS
QoS parameters received as described in clause 4.11.1.1.
The UE performs an initial attach procedure if
\- The UE is registered without PDU Session in 5GC or the UE is registered
only with PDU Session for which Session Continuity is not supported during
interworking to EPC and
\- Either the UE or the EPC does not support attach without PDN connectivity.
##### 4.11.1.3.2 5GS to EPS Idle mode mobility using N26 interface
In the case of network sharing the UE selects the target PLMN ID according to
clause 5.18.3 of TS 23.501 [2].
Clause 4.11.1.3.2 covers the case of idle mode mobility from 5GC to EPC. UE
performs Tracking Area Update procedure in E-UTRA/EPS when it moves from NG-
RAN/5GS to E-UTRA/EPS coverage area.
The procedure involves a Tracking Area Update to EPC and setup of default EPS
bearer and dedicated bearers in EPC in steps 1-11 and re-activation, if
required.
Figure 4.11.1.3.2-1: 5GS to EPS Idle mode mobility using N26 interface
The TAU procedure in TS 23.401 [13] is used with the following 5GS
interaction:
1\. Step 1 from clause 5.3.3.1 (Tracking Area Update procedure with Serving GW
change) in TS 23.401 [13].
2\. Step 2 from clause 5.3.3.1 (Tracking Area Update procedure with Serving GW
change) in TS 23.401 [13] with the modification captured in clause 4.11.1.5.3.
3-4. Steps 3-4 from clause 5.3.3.1 (Tracking Area Update procedure with
Serving GW change) in TS 23.401 [13].
5a. The AMF verifies the integrity of the TAU request message and requests the
PGW-C+SMF to provide SM Context by using Nsmf_PDUSession_ContextRequest that
also includes the mapped EPS Bearer Contexts. The AMF provides the target MME
capability to SMF in the request to allow the SMF to determine whether to
include EPS Bearer context for non-IP PDN Type or not. This step is performed
with all the PGW-C+SMFs corresponding to PDU Sessions of the UE which are
associated with 3GPP access and have EBI(s) allocated to them. In this step,
if the AMF correctly validates the UE, then the AMF starts a timer.
NOTE 1: The AMF knows the MME capability to support non-IP PDN type or not
through local configuration.
5b. For Non-roaming or roaming with local breakout scenario, if CN Tunnel Info
is allocated by the PGW-U+UPF, the SMF sends N4 Session Modification Request
to PGW-U+UPF to establish the tunnel for each EPS bearers and PGW-U+UPF
provides the PGW-U Tunnel Info for each EPS bearers to PGW-C+SMF.
NOTE2: In home routed roaming case, the CN Tunnel Info for each EPS bearer has
been prepared by the PGW-C+SMF and provided to the V-SMF as specified in
clause 4.11.1.4.1.
5c. SMF returns mapped EPS bearer contexts, which includes PGW-C control plane
tunnel information of the PDN connection corresponding to the PDU session, EBI
for each EPS bearer, PGW-U tunnel information for each EPS bearer and EPS QoS
parameters for each EPS bearer. For PDU Sessions with PDU Session Type
Ethernet or Unstructured, the SMF provides SM Context for non-IP PDN Type.
If the PGW-C+SMF has marked that the status of one or more QoS Flows are
deleted in the 5GC but not synchronized with the UE yet as per clause 4.3.3.2,
the PGW-C+SMF does not return to the AMF the EPS context(s) if all its
associated QoS Flows are marked as deleted, that is, the PGW-C+SMF returns to
the AMF the EPS bearer contexts mapped from QoS Flows where at least one of
the QoS Flow for the EPS bearer is not marked as deleted.
6\. The AMF responds with a Context Response message carrying mapped MM
context (including mapped security context), Return preferred and SM EPS UE
Context (default and dedicated GBR bearers) to the MME. If the verification of
the integrity protection fails, the AMF returns an appropriate error cause.
Return preferred is an optional indication by the AMF of a preferred return of
the UE to the 5GS PLMN at a later access change to a 5GS shared network. The
AMF may start an implementation specific (guard) timer for the UE context.
7 - 14. Steps 6-12 from clause 5.3.3.1 (Tracking Area Update procedure with
Serving GW change) in TS 23.401 [13] are performed with following addition and
modification:
In the step 10, If the QoS Flow associated with the default QoS rule has an
EPS Bearer ID assigned, the PGW-C+SMF keeps the PDU Session (PDN connection)
and for the remaining QoS Flows that do not have EPS bearer ID(s) assigned,
the PGW-C+SMF deletes the PCC rule(s) associated with those QoS Flows and
informs the PCF about the removed PCC rule(s).
In the step 11, the PGW-C+SMF requests the PGW-U+UPF to establish the tunnel
for each EPS bearer by providing SGW-U Tunnel Info and PGW-U Tunnel Info if
the PGW-U Tunnel Info is allocated by the PGW-C+SMF.
In step 10, the PGW-C+SMF may need to report some subscribed event to the PCF
by performing an SMF initiated SM Policy Association Modification procedure as
defined in clause 4.16.5.
Step 9a from clause 5.3.3.1 (Tracking Area Update procedure with Serving GW
change) in TS 23.401 [13] with the modification captured in clause 4.11.1.5.3
15a. The HSS+UDM invokes Nudm_UECM_DeregistrationNotification to notify the
AMF associated with 3GPP access with reason as 5GS to EPS Mobility. If the
timer started in step 6 is not running, the old AMF removes the UE context.
Otherwise, the AMF may remove UE context when the timer expires. The AMF
request the release of the PDU Session which is associated with 3GPP access,
not expected to be transferred to EPC, i.e. no EBI(s) allocated to them and
corresponding to the PGW-C+SMF which is not contacted by AMF for SM context at
step 5a. The AMF requests the release of the SM context in the V-SMF only, for
Home Routed PDU Session with EBIs allocated. The 5GC may also keep UE context
to allow the use of native security parameters when UE moves back from EPS to
5GS later.
Registration associated with the non-3GPP access in the AMF is not removed
(i.e. an AMF that was serving the UE over both 3GPP and non-3GPP accesses does
not consider the UE as deregistered over non 3GPP access and will remain
registered and subscribed to subscription data updates in UDM).
When the UE decides to deregister over non-3GPP access or the old AMF decides
not to maintain a UE registration for non-3GPP access anymore, the old AMF
then deregisters from UDM by sending a Nudm_UECM_Deregistration service
operation, unsubscribes from Subscription Data updates by sending an
Nudm_SDM_Unsubscribe service operation to UDM and releases all the AMF and AN
resources related to the UE.
16 - 18. Steps 17-21 from clause 5.3.3.1 (Tracking Area Update procedure with
Serving GW change) in TS 23.401 [13] with the following modification:
The MME may provide the eNodeB with a PLMN list in the Handover Restriction
List taking into account the last used 5GS PLMN ID and the Return preferred
indication. The Handover Restriction List contains a list of PLMN IDs as
specified by clause 5.2a of TS 23.251 [35] for eNodeB functions.
The MME may not release the signalling connection with the UE based on the
indication received in the step 1 that the UE is moving from 5GC.
19\. [conditional] Step 19 from clause 4.11.1.2.1 applies.
If some of the QoS Flow(s) for an EPS bearer were marked as deleted, the
PGW-C+SMF may initiate bearer modification as specified in clause 5.4.3 of TS
23.401 [13] to remove the TFT filter(s) corresponding to the Packet Filter
Set(s) in the QoS rules.
##### 4.11.1.3.3 EPS to 5GS Mobility Registration Procedure (Idle and
Connected State) using N26 interface
Figure 4.11.1.3.3-1 describes the mobility registration procedure from EPS to
5GS when N26 is supported for idle and connected states.
Figure 4.11.1.3.3-1: EPS to 5GS mobility for single-registration mode with N26
interface
1\. The Registration procedure is triggered, e.g. the UE moves into NG-RAN
coverage. Step 2 to 9 except step 5, 6 and 8 follow the Registration procedure
in clause 4.2.2 with following enhancement.
2\. The UE sends Registration Request with registration type set to \"Mobility
Registration Update\" including 5G-GUTI mapped from EPS GUTI as the old GUTI,
the native 5G-GUTI (if available) as additional GUTI and indicating that the
UE is moving from EPC. The UE includes the UE Policy Container containing the
list of PSIs, indication of UE support for ANDSP and OSId if available.
When the Registration Request is triggered due to UE mobility from EPS to 5GS,
if the UE has locally deleted the EPS bearer which has allocated 5GS
parameters and the EPS bearer status has not been synchronized with the
network, the UE shall include the EPS bearer status in the Registration
Request.
The Additional GUTI is provided both in Idle state and Connected state, if
available. The Additional 5G-GUTI enables the AMF to retrieve the UE\'s MM
context from the old AMF (if available). The UE includes the S-NSSAIs
associated with the established PDN connections in the Requested NSSAI in RRC
and NAS (as described in clause 5.15.7 of TS 23.501 [2]). In the case of
Configured NSSAI applicable to this PLMN or an Allowed NSSAI are not present
in the UE, the associated HPLMN S-NSSAI(s) shall be provided in the mapping of
Requested NSSAI in the NAS as described in the clause 5.15.5.2.1 TS 23.501
[2].
In the case of idle mode mobility the UE additionally includes a TAU request
message integrity protected using the EPS security context (for further
security verification by the MME) in the Registration Request. If the UE holds
a native 5G-GUTI for this PLMN then the UE also includes the GUAMI part of the
native 5G-GUTI in RRC to enable the NG-RAN to route the Registration Request
to the same AMF (if available) and otherwise the UE provides in RRC signalling
a GUAMI mapped from the EPS GUTI and indicates it as \"Mapped from EPS\".
The UE integrity protects the Registration Request message using a 5G security
context (if available).
3-4. Steps 2-3 of clause 4.2.2.2.2 are performed.
In the case of idle mode mobility, the AMF derives S-NSSAIs values for the
Serving PLMN based on the S-NSSAIs values for the HPLMN, received in NAS
Registration Request, associated with the established PDN connections, the AMF
may send the S-NSSAIs values for the HPLMN to NSSF and NSSF provides
corresponding S-NSSAIs values for VPLMN to AMF.
NOTE 1: In connected mode mobility, the AMF devices S-NSSAIs values during the
handover procedure.
Steps 5 and 8 are not performed when this procedure is part of EPS to 5GS
handover.
5a. [Conditional] This step is only performed for IDLE mode mobility. The
target AMF derives the MME address and 4G GUTI from the old 5G-GUTI and sends
Context Request to MME including EPS GUTI mapped from 5G-GUTI and the TAU
request message according to TS 23.401 [13]. The MME validates the TAU
message.
5b. [Conditional] If step 5a is performed, step 5 from clause 5.3.3.1
(Tracking Area Update procedure with Serving GW change) in TS 23.401 [13] is
performed with the modification captured in clause 4.11.1.5.3.
The AMF converts the received EPS MM Context into the 5GS MM Context. The
received EPS UE context includes IMSI, ME Identity, UE EPS security context,
UE Network Capability and EPS Bearer context(s). The MME EPS Bearer context
includes for each EPS PDN connection the IP address and FQDN for the S5/S8
interface of the PGW-C+SMF and APN.
The AMF queries the NRF in serving PLMN by issuing the
Nnrf_NFDiscovery_Request including the FQDN for the S5/S8 interface of the
PGW-C+SMF and the NRF provides the IP address or FQDN of the N11/N16 interface
of the PGW-C+SMF.
The Context Response may include new information Return Preferred. Return
Preferred is an indication by the MME of a preferred return of the UE to the
last used EPS PLMN at a later access change to an EPS shared network. Based on
the Return Preferred indication, the AMF may store the last used EPS PLMN ID
in UE Context.
If the AMF cannot retrieve the address of the corresponding SMF for a PDN
connection, it will not move the PDN connection to 5GS.
Step 6 is performed only if the target AMF is different from the old AMF and
the old AMF is in the same PLMN as the target AMF.
6a. [Conditional] If the UE includes the 5G-GUTI as Additional GUTI in the
Registration Request message, the target AMF sends message to the old AMF. The
old AMF validates the Registration request message.
The target AMF retrieves UE\'s SUPI and MM Context, event subscription
information by each consumer NF and the list of SM PDU Session ID/associated
SMF ID for the UE using one of the following three options:
\- AMF may invoke the Namf_Communication_UEContextTransfer to the old AMF
identified by the additional 5G-GUTI; or
\- if the old AMF and the target AMF are in the same AMF Set and UDSF is
deployed, AMF may invoke Nudsf_UnstructuredDataManagement_Query service
operation for the UE identified by the additional 5G-GUTI from the UDSF; or
\- if the old AMF and the target AMF are in the same AMF Set, AMF may use
implementation specific means to share UE context.
6b. [Conditional] If step 6a is performed, the response is performed as
described in step 5 in clause 4.2.2.2.2. If a native 5G security context for
3GPP access is available in the AMF (or has been retrieved in step 6a), the
AMF may continue to use this security context. Otherwise, the AMF shall either
derive a mapped security context from the EPS security context obtained from
the MME or initiate an authentication procedure to the UE.
7\. [Conditional] If the target AMF determines to initiate the authentication
procedure to the UE in step 6b (e.g. the target AMF can not obtain the UE MM
context from AMF or other reasons), steps 8-9 of clause 4.2.2.2.2 are
optionally performed.
8\. [Conditional] If step 5b is performed and the target AMF accepts to serve
the UE, the target AMF sends Context Acknowledge (Serving GW change
indication) to MME according to TS 23.401 [13].
9\. Steps 11-12 of clause 4.2.2.2.2 are optionally performed.
10\. Void.
11\. Steps 13-14e of clause 4.2.2.2.2 are performed: This includes that if an
MM context is retrieved from the old AMF in step 6 (i.e. corresponding to an
existing UE registration for non-3GPP access in 5GC), then the target AMF
indicates to the UDM that the target AMF identity to be registered in the UDM
applies to both 3GPP and non-3GPP accesses by sending separate/independent
Nudm_UECM_Registration service operations for \"3GPP Access\" and \"non-3GPP
Access\".
12\. Void.
13\. Void.
14\. Steps 16-20 of clause 4.2.2.2.2 are optionally performed (initiated by
target AMF) with the following addition:
In the home-routed roaming case and connected state mobility, the AMF derives
the corresponding S-NSSAI value for the Serving PLMN based on S-NSSAI value
for the HPLMN received from PGW-C+SMF. If two values (i.e. the S-NSSAI value
configured in AMF for interworking and S-NSSAI value for the Serving PLMN) are
different, the AMF invokes Nsmf_PDU_Session_UpdateSMContext(PDU Session ID,
S-NSSAI value for the Serving PLMN). The V-SMF updates 5G-AN with the new
S-NSSAI of VPLMN by sending a N2 SM message to 5G-AN via AMF.
In the home-routed roaming case and idle state mobility, the AMF selects a
default V-SMF per PDU Session and invokes Nsmf_PDUSession_CreateSMContext
service operation of the V-SMF to create an association with the AMF. It
includes UE EPS PDN Connection, H-SMF ID, S-NSSAI and indicates all the PDU
Session(s) to be re-activated as received in the Registration request message
along with List Of PDU Sessions To Be Activated. The S-NSSAI is the S-NSSAI
configured in AMF for interworking, which is associated with default V-SMF.
The V-SMF creates the association and based on the received SMF ID, the V-SMF
invokes Nsmf_PDUSession_Create request service operation of the H-SMF and
provides the information received from the AMF. The subsequent handling is
performed as follows:
\- The H-SMF finds the corresponding PDU Session based on the PDN Connection
Context in the request. The H-SMF initiates N4 Session modification procedure
to establish the CN tunnel for the PDU Session and for Idle state mobility
registration, release the resource of the CN tunnels for EPS bearers
corresponding to the PDU session as well. If the CN Tunnel info is allocated
by the PGW-C+SMF, the tunnel info for PDU session is provided to PGW-U+UPF. If
the CN Tunnel info is allocated by PGW-U+UPF, the tunnel info for PDU Session
is provided to the PGW-C+SMF. The H-SMF responds V-SMF with the PDU Session ID
corresponding to the PDN Connection Context in the request, the allocated
EBI(s) information, the S-NSSAI of the PDU Session, S-NSSAI of HPLMN and other
PDU session parameters, such as PDU Session Type, Session AMBR in the
Nsmf_PDUSession_Create response.
\- The V-SMF updates its SM contexts and returns a
Nsmf_PDU_Session_CreateSMContextResponse message including the information
received from the H-SMF. The V-SMF also includes the N2 SM Context in the
response message sent to the AMF if the corresponding PDU Session is in the
received List Of PDU Sessions To Be Activated. The V-SMF stores an association
of the PDU Session ID and the H-SMF ID. The AMF stores the V-SMF ID and it
also stores S-NSSAI and the allocated EBI(s) associated to the PDU Session ID.
The AMF derives the S-NSSAI value for the Serving PLMN based on S-NSSAI value
for the HPLMN and sends the S-NSSAI value for the Serving PLMN to V-SMF by
invoking Nsmf_PDUSession_UpdateSMContext service operation. The V-SMF updates
NG RAN with the S-NSSAI value for the Serving PLMN via N2 SM message.
In non-roaming and LBO cases, AMF invokes Nsmf_PDUSession_CreateSMContext
Request (UE EPS PDN Connection) service operation of the PGW-C+SMF and
indicates all the PDU Session(s) to be re-activated as received in the
Registration request message along with List Of PDU Sessions To Be Activated.
This step is performed for each PDN Connection and the corresponding PGW-C+SMF
address/ID in the UE context the AMF received in Step 6.
If the P-GW-C+SMF (H-SMF in the case of home-routed roaming case) determines
that seamless session continuity from EPS to 5GS is not supported for the PDU
Session, then it does not provide SM information for the corresponding PDU
Session but includes the appropriate cause code for rejecting the PDU Session
transfer within the N2 SM Information. The PGW-C+SMF finds the corresponding
PDU Session based on the PDN Connection Context in the request. The PGW-C+SMF
initiates N4 Session modification procedure to establish the CN tunnel for the
PDU Session and for Idle state mobility registration, releases the resource of
the CN tunnels for EPS bearers corresponding to the PDU session as well. If
the PGW-C+SMF has not yet registered for this PDU Session ID, the PGW-C+SMF
registers with the UDM using Nudm_UECM_Registration (SUPI, DNN, PDU Session
ID) for a given PDU Session as in step 4 of PDU Session Establishment
Procedure in clause 4.3.2. If the CN Tunnel info is allocated by the
PGW-C+SMF, the tunnel info for PDU session is provided to PGW-U+UPF. If the CN
Tunnel info is allocated by PGW-U+UPF, the tunnel info for PDU Session is
provided to the PGW-C+SMF. The PGW-C+SMF updates its SM contexts and returns
the AMF a Nsmf_PDUSession_CreateSMContext Response message including the PDU
Session ID corresponding to the PDN Connection Context in the request, the
allocated EBI(s) information, the S-NSSAI of the PDU Session and the N2 SM
Context if the corresponding PDU Session is in the received List Of PDU
Sessions To Be Activated. The AMF stores an association of the PDU Session ID
and the SMF ID, S-NSSAI and the allocated EBI(s) associated to the PDU Session
ID. Based on the allocated EBI(s) information received from all the related
PGW-C+SMF for this UE, an EPS bearer status, which reflects all existing EPS
bearer, is generated by the AMF.
NOTE 2: For Connected State mobility registration, the release of CN tunnels
for EPS bearers and UDM registration for the session corresponding to the PDU
session is performed in the handover execution phase.
If the PDN Type of a PDN Connection in EPS is non-IP and it was originally
established as Ethernet PDU Session when UE was camping in 5GS (known based on
local context information that was set to PDU Session Type Ethernet in UE and
SMF), the PDU Session Type in 5GS shall be set to Ethernet by the SMF and UE.
If the PDN type of a PDN Connection in EPS is non-IP and is locally associated
in UE and SMF to PDU Session Type Unstructured, the PDU Session Type in 5GS
shall be set to Unstructured by the SMF and UE.
If the AMF has received the EPS Bearer Status in the Registration Request from
UE, the AMF shall send the EPS Bearer Status to all corresponding PGW-C+SMFs.
If the PGW-C+SMF receives the EPS Bearer Status from AMF, the PGW-C+SMF shall
check whether the EPS bearer(s) has been deleted by UE but not notified to
network. If yes, the PGW-C+SMF shall release those EPS bearer(s), the
corresponding 5G QoS Rule(s) and the QoS Flow level QoS parameters locally.
15 - 16. HSS+UDM cancels the location of the UE in the MME as defined in steps
13 - 14 from clause 5.3.3.1 (Tracking Area Update procedure with Serving GW
change) in TS 23.401 [13]. Subsequently, the steps 18 - 19 from clause 5.3.3.1
(Tracking Area Update procedure with Serving GW change) in TS 23.401 [13] are
also executed with the following modification:
According to configuration, for the PDN connections which are anchored in a
standalone PGW, the MME initiates PDN connection release procedure as
specified in TS 23.401 [13].
17-18. These steps follow the steps 21 and 22 of Registration procedure in
clause 4.2.2.2.2.
The Registration Accept message shall include the updated 5G-GUTI to be used
by the UE in that PLMN over any access. If the active flag was included in the
Registration request, The AMF may provide NG-RAN with a Mobility Restriction
List taking into account the last used EPS PLMN ID and the Return preferred
indication. The Mobility Restriction List contains a list of PLMN IDs as
specified by TS 23.501 [2]. The Allowed NSSAI in the Registration Accept
message shall contain at least the S-NSSAIs corresponding to the active PDN
Connection(s) and the corresponding mapping to the HPLMN S-NSSAIs.
The AMF shall include the EPS bearer status, which is generated at step 14, in
the Registration Accept message. Based on the received EPS bearer status
information, the UE shall check whether there are QoS Flow(s) existing locally
but no associated EPS bearer(s) in the received EPS bearer status. The UE
shall locally delete the 5G QoS Rule(s) and QoS Flow level QoS parameters of
the QoS Flow(s) if the associated EPS bearer(s) do not exist in the received
EPS bearer status.
#### 4.11.1.4 Procedures for EPS bearer ID allocation
##### 4.11.1.4.1 EPS bearer ID allocation
Following procedures are updated to allocate EPS bearer ID(s) towards EPS
bearer(s) mapped from QoS flow(s) and provide the EPS bearer ID(s) to the NG-
RAN:
\- UE requested PDU Session Establishment (Non-roaming and Roaming with Local
Breakout (clause 4.3.2.2.1) including Request Types \"Initial Request\" and
\"Existing PDU Session\".
\- UE requested PDU Session Establishment (Home-routed Roaming (clause
4.3.2.2.2) including Request Types \"Initial Request\" and \"Existing PDU
Session\".
\- UE or network requested PDU Session Modification (non-roaming and roaming
with local breakout) (clause 4.3.3.2).
\- UE or network requested PDU Session Modification (home-routed roaming)
(clause 4.3.3.3).
\- UE Triggered Service Request (clause 4.2.3.2) to move PDU Session(s) from
untrusted non-3GPP access to 3GPP access
EBI allocation shall apply to PDU Session via 3GPP access supporting EPS
interworking with N26. EBI allocation shall not apply to PDU Session via 3GPP
access supporting EPS interworking without N26 and shall not apply to PDU
Session via non-3GPP access supporting EPS interworking.
Figure 4.11.1.4.1-1: Procedures for EPS bearer ID allocation
1\. Procedure as listed in this step is initiated as specified in the relevant
clauses of this specification. The relevant steps of the procedure as
specified in the figure above are executed.
2\. If the PGW-C+SMF (or H-SMF in the case of home routed case), determines,
based on the indication of EPS interworking support with N26 as defined in
clauses 4.11.5.2, 4.11.5.3 and 4.11.5.4 and operator policies e.g. User Plane
Security Enforcement information, Access Type, that EPS bearer ID(s) needs to
be assigned to the QoS flow(s) in the PDU Session, PGW-C+SMF invokes
Namf_Communication_EBIAssignment Request (PDU Session ID, ARP list) (via V-SMF
Nsmf_PDUSession_Update in the case of home routed case). When V-SMF receives
Nsmf_PDUSession_Update request from H-SMF for EPS bearer ID allocation
request, V-SMF needs to invoke Namf_Communication_EBIAssignment Request (PDU
Session ID, ARP list). If the PGW-C+SMF (or H-SMF in the case of home-routed
roaming) serves multiple PDU sessions for the same DNN but different S-NSSAIs
for a UE, then the SMF shall only request EBIs for PDU sessions served by a
common UPF (PSA). If different UPF (PSA) are serving those PDU sessions, then
the SMF chooses one of the UPF (PSA) for this determination based on operator
policy. When the PDU session is established via non-3GPP access, the PGW-C+SMF
shall not trigger EBI allocation procedure.
Steps 3 to 6 apply only when AMF needs to revoke EBI previously allocated for
an UE in order to serve a new SMF request of EBI for the same UE.
3\. [Conditional] If the AMF has no available EBIs, the AMF may revoke an EBI
that was assigned to QoS flow(s) based on the ARP(s) and S-NSSAI stored during
PDU Session establishment, EBIs information in the UE context and local
policies. If an assigned EBI is to be revoked, the AMF invokes
Nsmf_PDUSession_UpdateSMContext (EBI(s) to be revoked) to request the related
SMF (called \"SMF serving the released resources\") to release the mapped EPS
QoS parameters corresponding to the EBI to be revoked. The AMF stores the
association of the assigned EBI, ARP pair to the corresponding PDU Session ID
and SMF address.
4\. The \"SMF serving the released resources\" that receives the request in
step 3 shall invoke Namf_Communication_N1N2Message Transfer (N2 SM information
(PDU Session ID, EBI(s) to be revoked), N1 SM container (PDU Session
Modification Command (PDU Session ID, EBI(s) to be revoked))) to inform the
(R)AN and the UE to remove the mapped EPS QoS parameters corresponding to the
EBI(s) to be revoked. In home routed roaming scenario, the H-SMF includes
EBI(s) to be revoked to V-SMF to inform V-SMF to remove the mapped EPS bearer
context corresponding to the EBI(s) to be revoked.
NOTE 1: The SMF can also decide to remove the QoS flow if it is not acceptable
to continue the service when no corresponding EPS QoS parameters can be
assigned.
For home routed roaming scenario, the \"SMF serving the released resources\"
sends an N4 Session Modification Request to request the PGW-U+UPF to release
N4 Session corresponding to the revoked EBI(s).
In home routed roaming case, the V-SMF starts a VPLMN initiated QoS
modification for the PDU Session and the Namf_Communication_N1N2Message
Transfer is invoked by the V-SMF based on the corresponding QoS modification
message received from H-SMF.
5\. If the UE is in CM-CONNECTED state, the AMF sends N2 PDU Session Request
(N2 SM information received from SMF, NAS message (PDU Session ID, N1 SM
container (PDU Session Modification Command))) Message to the (R)AN.
If the UE is in CM-IDLE state and an ATC is activated, the AMF updates and
stores the UE context based on the Namf_Communication_N1N2MessageTransfer and
step 5-6 are skipped. When the UE is reachable, e.g. when the UE enters CM-
CONNECTED state, the AMF forwards the N1 message to synchronize the UE context
with the UE.
6\. The rest steps of the procedure are executed as specified in the figure
above.
7 If the AMF successfully assigns EBI(s), it responds with the assigned
EBI(s). Otherwise, it responds with a cause indicating EBI assignment failure.
If a PDU Session from another SMF already exists towards the same DNN, the AMF
either rejects the EBI assignment request, or revokes the EBI(s) from the
existing PDU Session(s) to the same DNN but different SMFs if the AMF makes
the decision based on the operator policy, that the existing PDU Session
cannot support EPS interworking N26.
The AMF stores the DNN and PGW-C+SMF in which the PDU Session(s) support EPS
interworking to UDM in clause 4.11.1.6.
NOTE 2: The above applies only when the S-NSSAI(s) for the PDU Sessions are
different, otherwise the same SMF is selected for PDU Sessions to the same
DNN.
8\. The PGW-C+SMF sends an N4 Session Establishment/Modification Request to
the PGW-U+UPF.
For home routed roaming scenario, if the EBI is assigned successfully, the
PGW-C+SMF prepares the CN Tunnel Info for each EPS bearer. If the CN Tunnel
info is allocated by the PGW-C+SMF, the PGW-U tunnel info for the EPS bearer
may be provided to PGW-U+UPF. If the CN Tunnel info is allocated by PGW-U+UPF,
the PGW-U+UPF sends the PGW-U tunnel info for the EPS bearer to the PGW-C+SMF.
The PGW-U+UPF is ready to receive uplink packets from E-UTRAN.
NOTE 3: In the home routed roaming scenario the PGW-C+SMF prepares the CN
Tunnel Info for each EPS bearer and provide it to V-SMF. Thus when the UE move
to EPC network, the V-SMF does not need interact with the PGW-C+SMF to get the
EPS bearer context(s).
NOTE 4: If the CN Tunnel info is allocated by the PGW-C+SMF and not provided
to PGW-U+UPF at PDU Session establishment, when the UE moves to the target RAT
the PGW-U+UPF cannot receive UL data until the PGW-C+SMF has provided the
Tunnel Info to the PGW-U+UPF in N4 Session Modification. This causes a short
interruption to the UL data during the intersystem handover execution.
9\. If the PGW-C+SMF receives any EBI(s) from the AMF, it adds the received
EBI(s) into the mapped EPS bearer context(s).
In home routed roaming scenario, the PGW-C+SMF generates EPS bearer context
which includes per EPS bearer PGW-U tunnel information. In addition, if the
default EPS bearer is generated for the corresponding PDN Connection of PDU
Session (i.e. during the PDU Session establishment procedure), the PGW-C+SMF
generates the PGW-C tunnel information of the PDN connection and include it in
UE EPS PDN connection.
9a. [Conditional] In non-roaming or LBO scenario, the PGW-C+SMF includes the
mapped EPS bearer context(s) and the corresponding QoS Flow(s) to be sent to
the UE in the N1 SM container. PGW-C+SMF also indicates the mapping between
the QoS Flow(s) and mapped EPS bearer context(s) in the N1 SM container.
PGW-C+SMF also includes the mapping between the received EBI(s) and QFI(s)
into the N2 SM information to be sent to the NG-RAN. The PGW-C+SMF sends the
N1 SM container and N2 SM information to AMF via
Namf_Communication_N1N2MessageTransfer.
9b [Conditional] In home routed roaming scenario, the PGW-C+SMF sends mapped
EPS bearer context(s), the mapping between the received EBI(s) and QFI(s) and
EPS bearer context to V-SMF via Nsmf_PDUSession_Create Response in the case of
PDU Session Establishment, or via Nsmf_PDUSession_Update Request in the case
of PDU Session Modification. The V-SMF stores the EPS bearer context and
generates N1 SM container and N2 SM information and forwards them to AMF via
Namf_Communication_N1N2MessageTransfer.
10\. The N1 SM container and N2 SM information are sent to the UE and NG-RAN
respectively. The relevant steps of the procedure as specified in the figure
above are executed. In the case of UE triggered service request procedure that
results in a session transfer from N3GPP to 3GPP, the SMF initiates network
requested PDU session modification procedure to send the mapped EPS Bearer
Context(s) to the UE and send the mapping of QoS Flow and EBI to the NG-RAN.
##### 4.11.1.4.2 EPS bearer ID transfer
Following procedures are updated to transfer EPS bearer ID(s) allocation
information to target AMF.
\- step 14 in figure 4.11.1.3.3-1 in EPS to 5GS Idle mode mobility with N26
(clause 4.11.1.3.3).
\- step 7 in figure 4.11.1.2.2.2-1 in EPS to 5GS handover using N26 interface
prepare phase (clause 4.11.1.2.2.2).
Figure 4.11.1.4.2-1: Procedures for EPS bearer IDs transfer
1\. The AMF sends an Nsmf_PDUSession_CreateSMContext Request message to the
SMF in above case;
2\. The SMF+PGW-C to AMF: Nsmf_PDUSession_CreateSMContext Response with the
allocated EBI information.
##### 4.11.1.4.3 EPS bearer ID revocation
Following procedures are updated to revoke the EPS bearer ID(s) assigned to
the QoS flow(s):
\- UE or network requested PDU Session Release for Non-roaming and Roaming
with Local Breakout (clause 4.3.4.2).
\- UE or network requested PDU Session Release for Home-routed Roaming (clause
4.3.4.3).
\- UE or network requested PDU Session Modification (non-roaming and roaming
with local breakout) (clause 4.3.3.2).
\- UE or network requested PDU Session Modification (home-routed roaming)
(clause 4.3.3.3).
\- Handover of a PDU Session procedure from 3GPP to untrusted non-3GPP access
(non-roaming and roaming with local breakout) (clause 4.9.2.2)
\- Handover of a PDU Session procedure from 3GPP to untrusted non-3GPP access
(home routed roaming) (clause 4.9.2.4
When the PDU Session is released as described in clauses 4.3.4.2 or 4.3.4.3,
4.9.2.2, or 4.9.2.4 and the SMF invokes Nsmf_PDUSession_StatusNotify to notify
AMF that the SM context for this PDU Session is released, the AMF releases the
association between the SMF ID and the PDU Session ID and releases the EBIs
assigned for this PDU Session. When all the PDU sessions which are allocated
with EBIs are released in the same SMF, the AMF may revoke DNN and PGW-C+SMF
FQDN for S5/S8 interface in the UDM using Nudm_UECM_Update service operation.
NOTE 1: If the PGW-C+SMF in which the PDU sessions support EPS interworking is
changed for the same DNN, the AMF can update the DNN and new PGW-C+SMF FQDN
for S5/S8 interface in the UDM using Nudm_UECM_Update service operation.
When the UE initiates a PDU Session Modification as described in clauses
4.3.3.2 or 4.3.3.3 and the SMF needs to release the assigned EBI from a QoS
flow (e.g. when the QoS flow is released), the SMF can indicate the Released
EBI list in the Nsmf_PDUSession_UpdateSMContext Response to the AMF. The AMF
releases the corresponding EBI allocation for this PDU Session.
When the AMF decides to revoke some EBI(s), e.g. when the AMF receives a new
EBI allocation request but there is no EBI available, the AMF may decide to
revoke EBI(s) for another PDU Session, the AMF initiates a PDU Session
Modification as described in clauses 4.3.3.2 or 4.3.3.3 and includes EBI list
to be revoked in the Nsmf_PDUSession_UpdateSMContext Request. The SMF releases
the indicated EBI(s) for the PDU Session.
When the AMF initiates a PDU Session Modification as described in clauses
4.3.3.2 or 4.3.3.3 to change the status of EPS interworking with N26 to \"not
supported\", the AMF releases the EBIs assigned for this PDU Session and SMF
release the assigned EBIs from the QoS Flows belonging to this PDU Session.
When the SMF initiates a PDU Session Modification as described in clauses
4.3.3.2 or 4.3.3.3 and the SMF needs to release the assigned EBI from a QoS
flow (e.g. when the QoS flow is released), the SMF invokes
Namf_Communication_EBIAssignment and indicates the Released EBI list to the
AMF. The AMF releases the corresponding EBI allocation for this PDU Session.
When the handover of a PDU Session procedure from 3GPP to untrusted non-3GPP
access is performed in clause 4.9.2.2 or clause 4.9.2.4.1, the AMF, the SMF
and the UE releases locally the EBI(s) allocated for this PDU Session.
When the handover of a PDU Session procedure from 3GPP to untrusted non-3GPP
access is performed in clause 4.9.2.4.2, the H-SMF invokes
Nsmf_PDUSession_StatusNotify to notify V-AMF to release the association
between the SMF ID and the PDU Session ID and, as a result, the EBI(s)
assigned for this PDU Session are released. The UE releases locally the EBI(s)
allocated for this PDU Session.
#### 4.11.1.5 Impacts to EPS Procedures
##### 4.11.1.5.1 General
This clause captures changes to procedures in TS 23.401 [13] due to
interworking with 5GS based on N26. The handover procedures between EPS and
5GS captured in clause 4.11.1.2 capture impacts to clause 5.5.1.2.2 of TS
23.401 [13] (S1-based handover, normal).
##### 4.11.1.5.2 E-UTRAN Initial Attach
The E-UTRAN Initial Attach Procedure specified in clause 5.3.2.1 of TS 23.401
[13] is impacted as shown in Figure 4.11.1.5.2-1 when interworking with 5GS
using N26 interface is supported.
Figure 4.11.1.5.2-1: Impacts to E-UTRAN Initial Attach procedure
1\. The UE sends an Attach Request message as specified in TS 23.401 [13] with
the following modifications:
\- If the UE was previously registered in 5GS, the UE provides in Access
Stratum signalling a GUMMEI mapped from the 5G-GUTI and indicates it as a
native GUMMEI and should in addition indicate it as \"Mapped from 5G-GUTI\".
\- If the UE was previously registered in 5GS, the UE provides, in the Attach
Request message, an EPS GUTI mapped from 5G-GUTI sent as old Native GUTI and
indicates that it is moving from 5GC. The UE integrity protects the Attach
Request message using the 5G security context.
\- A UE that supports 5GC NAS procedures shall indicate its support of 5G NAS
as part of its UE Core Network Capability IE.
\- If the UE includes ESM message container for PDN Connection Establishment
and the Request type is \"initial request\", the UE shall allocate a PDU
Session ID and include it in the PCO. The PDU Session ID shall be unique
across all other PDN connections of the UE.
2\. The relevant steps of the procedure as specified in the figure above are
executed with the following modification:
\- The HSS/UDM on receiving Update Location Request from MME, de-register any
old AMF by sending an Nudm_UECM_DeregistrationNotification service operation
to the registered AMF for 3GPP access.
\- Step 7 and step 10 as specified in clause 5.3.2.1 of TS 23.401 [13] (i.e.
IP-CAN Session Termination) is replaced by SM Policy Association Termination
procedure as specified in clause 4.16.6.
\- Step 14 as specified in clause 5.3.2.1 of TS 23.401 [13] (i.e. IP-CAN
Session Establishment/Modification) are replaced by SM Policy Association
Establishment/Modification procedure as specified in clause 4.16.4 and clause
4.16.5.
3\. Step 15 as specified in clause 5.3.2.1 of TS 23.401 [13] with the
following modification:
\- The PGW-C+SMF allocates 5G QoS parameters corresponding to PDN connection,
e.g. Session AMBR, QoS rules and QoS Flow level QoS parameters if needed for
the QoS Flow associated with the QoS rule(s) and then includes them in PCO.
4\. The relevant steps of the procedure as specified in the figure above are
executed.
5\. Step 18 as specified in clause 5.3.2.1 of TS 23.401 [13] with the
following modification:
\- The 5G QoS parameters for the PDU session and for the QoS Flow associated
with the default QoS rule are stored in the UE.
6\. The relevant steps of the procedure as specified in the figure above are
executed.
##### 4.11.1.5.3 Tracking Area Update
The following changes are applied to clause 5.3.3.1 (Tracking area update
procedure with Serving GW change) in TS 23.401 [13]:
\- Step 2: The UE shall in Access Stratum signalling include GUMMEI that is
mapped from 5G-GUTI following the mapping rules specified in TS 23.501 [2] and
the UE indicates it as a native GUMMEI and should in addition indicate it as
\"Mapped from 5G-GUTI\". The UE shall, in the TAU request message, include EPS
GUTI that is mapped from 5G-GUTI following the mapping rules specified in TS
23.501 [2]. The UE indicates that it is moving from 5GC. The UE integrity
protects the TAU request message using the 5G security context.
\- Step 5 and message Context Response may include new information Return
preferred.
Return preferred is an indication by the AMF of a preferred return of the UE
to the last used 5GS PLMN at a later access change to a 5GS shared network.
The MME may store the last used 5GS PLMN ID in UE\'s MM Context.
The MME may provide E-UTRAN with a Handover Restriction List taking into
account the last used 5GS PLMN ID and the Return Preferred indication. The
Handover Restriction List contains a list of PLMN IDs as specified by TS
23.251 [35].
\- Step 9a IPâ€‘CAN Session Modification procedure:
It is replaced by SM Policy Association Modification as specified in clause
4.16.5.
\- Step 13 and HSS use of Cancel Location
The HSS/UDM de-registers any old AMF node by sending an
Nudm_UECM_DeregistrationNotification service operation to the registered AMF
for 3GPP access. The registered AMF for 3GPP access initiates AM Policy
Association Termination procedure as defined in clause 4.16.3.2 and UE Policy
Association Termination procedure as defined in clause 4.16.13.1.
\- Step 17: If the DNN and PGW-C+SMF FQDN for S5/S8 interface association
exist, the HSS/UDM sends APN mapped form DNN and PGW-C+SMF FQDN for S5/S8 to
UE.
\- Step 20 and MME processing of the partial Tracking Area Update (TAU)
procedure.
The MME may use an indication Return preferred from Context Response at step 6
when deciding the PLMN list content.
The MME may provide the eNodeB with a PLMN list. The Handover Restriction List
contains a list of PLMN IDs as specified by TS 23.501 [2].
##### 4.11.1.5.4 Session Management
##### 4.11.1.5.4.1 PDN Connection Request {#pdn-connection-request .H6}
The UE Requested PDN Connectivity Procedure specified in clause 5.10.2 of TS
23.401 [13] is impacted as shown in in Figure 4.11.1.5.4.1-1 when interworking
with 5GS is supported.
Figure 4.11.1.5.4.1-1: Impacts to UE Requested PDN Connectivity Procedure
1\. UE sends a PDN connectivity Request to the MME as specified in step 1 in
clause 5.10.2 of TS 23.401 [13] with the following modification:
\- If the UE is 5G NAS capable and the Request type is \"initial request\",
the UE shall allocate a PDU Session ID and include it in the PCO. The PDU
Session ID shall be unique across all other PDN connections of the UE.
2\. The relevant steps of the procedure as specified in the figure above are
executed. In step 4 of TS 23.401 [13], IP Session Establishment/Modification
procedure is replaced by SM Policy Association Establishment/Modification
procedure as specified in clauses 4.16.4 and 4.16.5.
3\. Step 6 as specified in clause 5.10.2 of TS 23.401 [13] is executed with
the following modification:
\- If the PGW-C+SMF accepts to provide interworking of the PDN connection with
5GC, the PGW-C+SMF shall allocate 5G QoS parameters corresponding to PDN
connection, e.g. Session AMBR, QoS rules and QoS Flow level QoS parameters if
needed for the QoS Flow(s) associated with the QoS rule(s) and then include
them in PCO.
\- If the PGW-C+SMF accepts to provide interworking of the PDN connection with
5GC, the PGW-C+SMF shall determine the S-NSSAI associated with the PDN
connection based on the operator policy and send the S-NSSAI together with the
PLMN ID to the UE in the PCO.
4\. The relevant steps of the procedure as specified in the figure above are
executed.
5\. Step 8 as specified in clause 5.10.2 of TS 23.401 [13] with the following
modification:
\- If 5G QoS parameters are included in the PCO, the UE shall store them. If
5G QoS parameters are not included in the PCO, the UE shall note that session
continuity for this PDN connection on mobility to 5G is not provided by the
network.
\- If the S-NSSAI and the PLMN ID associated with the PDN connection are
included in the PCO, the UE shall store them.
6\. The relevant steps of the procedure as specified in the figure above are
executed.
##### 4.11.1.5.4.2 UE or MME Requested PDN Disconnection {#ue-or-mme-
requested-pdn-disconnection .H6}
The procedure as specified in clause 5.10.3 of TS 23.401 [13] applies with the
following modification:
Step 8. (RRC Connection Reconfiguration): On receiving the NAS Deactivate EPS
Bearer Context Request(LBI) message, if the UE has mapped 5G parameters for
the PDU session, the UE deletes the corresponding mapped 5GS PDU session.
In addition if the PGW-C+SMF has registered to HSS+UDM for this PDN connection
before, the PGW-C+SMF invokes the Nudm_UECM_Deregistration service operation
to notify the UDM to remove the association between the PGW-C+SMF identity and
the associated DNN and PDU Session Id as described in the step 12 of clause
4.3.4.2. If there is no PDN connection for the associated (DNN, S-NSSAI)
handled by the PGW-C+SMF, the PGW-C+SMF unsubscribes from Session Management
Subscription data changes notification with the HSS+UDM by means of the
Nudm_SDM_Unsubscribe (SUPI, DNN, S-NSSAI) service operation as described in
step 12 of clause 4.3.4.2.
##### 4.11.1.5.4.3 Dedicated Bearer Activation, Bearer Modification and Bearer
Deactivation {#dedicated-bearer-activation-bearer-modification-and-bearer-
deactivation .H6}
The procedures specified in clauses 5.4.1 through 5.4.5 of TS 23.401 [13]
apply with the following modifications:
\- PCRF initiated IP-CAN Modification in TS 23.401 [13] is replaced with PCF
initiated SM Policy Association Modification as specified in clause 4.16.5.2.
PCEF initiated IP-CAN Session Modification/Termination TS 23.401 [13] is
replaced with SM Policy Association Modification/Termination as specified in
clauses 4.16.5 and 4.16.6.
\- In the step where the PDN-GW sends a Create Bearer Request, i.e.
\- Step 2 in clause 5.4.1 of TS 23.401 [13] (Dedicated Bearer Activation)
the PCO includes mapped 5GS QoS parameters for the EPS bearer being created.
\- In the step where the PDN-GW sends an Update Bearer Request, i.e.
\- Step 2 in clause 5.4.2.1 of TS 23.401 [13] (PDN GW initiated bearer
modification with bearer QoS update)
\- Step 5 in clause 5.4.2.2 of TS 23.401 [13] (HSS Initiated Subscribed QoS
Modification)
\- Step 2 in clause 5.4.3 of TS 23.401 [13] (PDN GW initiated bearer
modification without bearer QoS update) if TFT or APN-AMBR is being modified
the PCO includes the modification to the mapped 5GS QoS parameters, if
impacted by the modification, corresponding to the EPS bearer being modified.
\- In the step where the UE receives the NAS Session Management message from
the MME which contains the PCO relayed via the MME, i.e.:
\- Step 5 in clause 5.4.1 of TS 23.401 [13] (Dedicated Bearer Activation)
\- Step 5 in clause 5.4.2.1 of TS 23.401 [13] (PDN GW initiated bearer
modification with bearer QoS update)
\- Step 5 in clause 5.4.3 of TS 23.401 [13] (PDN GW initiated bearer
modification without bearer QoS update) if TFT or APN-AMBR is being modified
the UE updates the mapped 5G QoS parameters as included in the PCO from the
PDN-GW.
\- In the step where the UE receives EPS bearer request message, i.e.:
\- Step 5 in clause 5.4.4.1 of TS 23.401 [13] (PDN GW initiated bearer
deactivation).
the UE also deletes the mapped 5GS QoS flow and its associated parameter.
##### 4.11.1.5.5 5GS to EPS handover using N26 interface
In step 3 of clause 4.11.1.2.1, the Forward Relocation Request may include new
information Return Preferred.
Return Preferred is an indication by the AMF of a preferred return of the UE
to the last used 5GS PLMN at a later access change to a 5GS shared network.
The MME may store the last used 5GS PLMN ID in UE\'s MM Context.
The MME may provide E-UTRAN with a Handover Restriction List taking into
account the last used 5GS PLMN ID and the Return Preferred indication. The
Handover Restriction List contains a list of PLMN IDs as specified by TS
23.251 [35].
#### 4.11.1.6 EPS interworking information storing Procedure
Depending on the operator\'s configuration, the AMF serving the 3GPP access
store DNN and PGW-C+SMF FQDN for S5/S8 interface in the UDM using
Nudm_UECM_Update service operation when N26 is deployed.
### 4.11.2 Interworking procedures without N26 interface
#### 4.11.2.1 General
Clause 4.11.2 defines the procedures to support interworking between 5GS and
EPS without any N26 interface between AMF and MME.
During interworking from EPS to 5GS, as the PGW-C+SMF may have different IP
addresses when being accessed over S5/S8 and N11/N16 respectively, the AMF
shall discover the SMF instance by an NF/NF service discovery procedure using
the FQDN for the S5/S8 interface received from the UDM as a query parameter.
This is required for both non-roaming and roaming with local breakout, as well
as for home routed roaming.
NOTE: As the AMF is not aware of the S-NSSAI assigned for the PDN Connection,
the NF/NF service discovery used to find the SMF instance can use PLMN level
NRF.
#### 4.11.2.2 5GS to EPS Mobility
The following procedure is used by UEs in single-registration or dual
registration mode on mobility from 5GS to EPS.
In the case of network sharing the UE selects the target PLMN ID according to
clause 5.18.3 of TS 23.501 [2].
Figure 4.11.2.2-1: Mobility procedure from 5GS to EPS without N26 interface
The UE operating in single-registration mode can start the procedure from Step
1 or Step 5. The UE operating in dual-registration mode starts the procedure
from Step 5.
NOTE 1: The network has indicated the \" Interworking without N26\" to the UE.
To support IP address preservation, the UE in single-registration mode starts
the procedure from Step 5. If the UE in single-registration mode starts the
procedure from Step 1, the IP address preservation is not provided.
0\. UE is registered in 5GS and established PDU sessions. The FQDN for the
S5/S8 interface of the PGW-C+SMF is also stored in the UDM by the PGW-C+SMF
during PDU Session setup in addition to what is specified in clause 4.3.2.2.1
and clause 4.3.2.2.2.
NOTE 2: At 5GS to EPS mobility, the MME use the FQDN for the S5/S8 interface
of the PGW-C+SMF to find the PGW-C+SMF and when UE moves back from EPS to 5GS,
the AMF uses FQDN for the S5/S8 interface of the PGW-C+SMF to find the
PGW-C+SMF.
1\. Step 1 as in clause 5.3.3.1 (Tracking Area Update) in TS 23.401 [13].
2\. Step 2 as in clause 5.3.3.1 (Tracking Area Update) in TS 23.401 [13] with
the following modifications:
The UE shall provide a EPS-GUTI that is mapped from the 5G-GUTI following the
mapping rules specified in TS 23.501 [2]. The UE indicates that it is moving
from 5GC.
3\. Step 3 as in clause 5.3.3.1 (Tracking Area Update) in TS 23.401 [13].
4\. If the MME determined that the old node is an AMF based on UE\'s GUTI
mapped from 5G-GUTI and the MME is configured to support 5GS-EPS interworking
without N26 procedure, the MME sends a TAU Reject to the UE.
5\. Step 1 as in clause 5.3.2.1 (E-UTRAN Initial Attach) in TS 23.401 [13]
with the modifications captured in clause 4.11.2.4.1.
6\. Step 2 as in clause 5.3.2.1 (E-UTRAN Initial Attach) in TS 23.401 [13].
7\. Steps 4-7 as in clause 5.3.2.1 (E-UTRAN Initial Attach) in TS 23.401 [13],
with the modifications captured in clause 4.11.2.4.1.
8\. Step 8 as in clause 5.3.2.1 (E-UTRAN Initial Attach) in TS 23.401 [13],
with the modifications captured in clause 4.11.2.4.1.
9\. Step 11 as in clause 5.3.2.1 (E-UTRAN Initial Attach) in TS 23.401 [13],
with the following modifications:
The subscription profile the MME receives from HSS+UDM includes per DNN/APN at
most one PGW-C+SMF FQDN as described in in clause 5.17.2.1 in TS 23.501 [2].
10\. Steps 12-24 as in clause 5.3.2.1 (E-UTRAN Initial Attach) in TS 23.401
[13], with the modifications as described in clause 4.11.2.4.1.
11\. Step 25 as in clause 5.3.2.1 (E-UTRAN Initial Attach) in TS 23.401 [13].
12\. Step 26 as in clause 5.3.2.1 (E-UTRAN Initial Attach) in TS 23.401 [13].
13\. If the UE has remaining PDU Sessions in 5GS which it wants to transfer to
EPS and maintain the same IP address/prefix, the UE performs the UE requested
PDN Connectivity Procedure as specified in clause 5.10.2 of TS 23.401 [13] and
sets the Request Type to \"handover\" in Step 1 of the procedure with
modification captured in clause 4.11.2.4.2. UE provides an APN and the PDU
Session ID corresponding to the PDU Session it wants to transfer to EPS. The
UE provides the PDU Session ID in PCO as described in clause 4.11.1.1.
UEs in single-registration mode performs this step for each PDU Session
immediately after completing the E-UTRAN Initial Attach procedure. UEs in
dual-registration mode may perform this step any time after the completing of
E-UTRAN Initial Attach procedure. Also, UEs in dual-registration mode may
perform this step only for a subset of PDU Sessions.
The MME determines the PGW-C+SMF address for the Create Session Request based
on the APN received from the UE and the subscription profile received from the
HSS+UDM in Step 9 or when the HSS+UDM notifies the MME for the new PGW-C+SMF
ID in the updated subscription profile.
The PGW-C+SMF uses the PDU Session ID to correlate the transferred PDN
connection with the PDU Session in 5GC.
As a result of the procedure the PGW-U+UPF starts routing DL data packets to
the Serving GW for the default and any dedicated EPS bearers established for
this PDN connection.
14\. For Non-Roaming case and Roaming with Local Breakout, the PGW-C+SMF
initiates release of the PDU Session(s) in 5GS transferred to EPS as specified
in clause 4.3.4.2 with the following clarification:
\- In step 2, the PGW-C+SMF shall not release IP address/prefix(es) allocated
for the PDU Session.
\- If UP connection of the PDU Session is not active, step 3b is not executed,
thus the steps triggered by step 3b are not executed;
\- If UP connection of the PDU Session is active, the SMF invokes the
Namf_Communication_N1N2MessageTransfer service operation in step 3b without
including N1 SM container (PDU Session Release Command);
\- In step 11, Nsmf_PDUSession_SMContexStatusNotify service operation invoked
by the SMF to notify AMF that the SM context for this PDU Session is released
due to handover to EPS.
For Home Routed roaming, the PGW-C+SMF initiates release of the PDU Session(s)
in 5GS transferred to EPS as specified in clause 4.3.4.3 with the following
clarification:
\- In step 3a, the H-SMF invokes the Nsmf_PDUSession_Update service operation
without including N1 SM container (PDU Session Release Command);
\- In step 16a, Nsmf_PDUSession_StatusNotify operation invoked by H-SMF to
notify the V-SMF that the PDU session context is released due to handover to
EPS;
\- In step 16b, Nsmf_PDUSession_SMContexStatusNotify service operation invoked
by the V-SMF to notify AMF that the SM context for this PDU Session is
released due to handover to EPS.
#### 4.11.2.3 EPS to 5GS Mobility
The following procedure is used by UEs in single-registration mode on mobility
from EPS to 5GS.
In the case of network sharing the UE selects the target PLMN ID according to
clause 5.18.3 of TS 23.501 [2].
This procedure is also used by UEs in dual-registration mode to perform
registration in 5GS when the UE is also registered in EPC. The procedure is
the General Registration procedure as captured in clause 4.2.2. Difference
from that procedure are captured below.
The UE has one or more ongoing PDN connections including one or more EPS
bearers. During the PDN connection establishment, the UE allocates the PDU
Session ID and sends it to the PGW-C+SMF via PCO, as described in clause
4.11.1.1.
Figure 4.11.2.3-1: Mobility procedure from EPS to 5GS without N26 interface
0\. The UE is attached in EPC as specified in clause 4.11.2.4.1.
1\. Step 1 in clause 4.2.2.2.2 (General Registration) with the following
clarifications:
The UE indicates that it is moving from EPC. The UE in single registration
mode provides the Registration type set to \"mobility registration update\", a
5G-GUTI mapped from the 4G-GUTI (see clause 5.17.2.2: 5G-GUTI mapped from
4G-GUTI) and a native 5G-GUTI (if available) as an Additional GUTI. The UE
includes the UE Policy Container containing the list of PSIs, indication of UE
support for ANDSP and OSId if available. The UE shall select the 5G-GUTI for
the additional GUTI as follows, listed in decreasing order of preference:
\- a native 5G-GUTI assigned by the PLMN to which the UE is attempting to
register, if available;
\- a native 5G-GUTI assigned by an equivalent PLMN to the PLMN to which the UE
is attempting to register, if available;
\- a native 5G-GUTI assigned by any other PLMN, if available.
The UE in dual registration mode provides the Registration type set to
\"initial registration\" and a native 5G-GUTI or SUCI. In single registration
mode, the UE also includes at least the S-NSSAIs (with values for the Serving
PLMN) associated with the established PDN connections in the Requested NSSAI
in RRC Connection Establishment.
2\. Step 2 as in clause 4.2.2.2.
3\. Step 3 as in clause 4.2.2.2.2 (General Registration), with the following
modifications:
If the Registration type is \"mobility registration update\" and the UE
indicates that it is moving from EPC in Step 1 and the AMF is configured to
support 5GS-EPS interworking procedure without N26 interface, the AMF treats
this registration request as \"initial Registration\" and the AMF skips the
PDU Session status synchronization.
NOTE 1: The UE operating in single registration mode includes the PDU Session
IDs corresponding to the PDN connections to the PDU Session status.
If the UE has provided a 5G-GUTI mapped from 4G-GUTI in Step 1 and the AMF is
configured to support 5GS-EPS interworking procedure without N26 interface,
the AMF does not perform steps 4 and 5 in clause 4.2.2.2 (UE context transfer
from the MME).
4\. Steps 4-13 as in clause 4.2.2.2.2 (General Registration), with the
following modifications:
\- If the UE has included an additional GUTI in the Registration Request, then
the new AMF attempts to retrieve the UE\'s security context from the old AMF
in steps 4 and 5.
\- If the UE\'s security context is not available in the old AMF or if the UE
has not provided an additional GUTI then the AMF retrieves the SUCI from the
UE in steps 6 and 7.
5\. Step 14 as in clause 4.2.2.2.2 (General Registration), with the following
modifications:
If the UE indicates that it is moving from EPC and the Registration type is
set to \"initial registration\" or \"mobility registration update\" in step 1
and AMF is configured to support 5GS-EPS interworking without N26 procedure,
the AMF sends an Nudm_UECM_Registration Request message to the HSS+UDM
indicating that registration of an MME at the HSS+UDM, if any, shall not be
cancelled. The HSS+UDM does not send cancel location to the old MME.
NOTE 2: If the UE does not maintain registration in EPC, upon reachability
time-out, the MME can implicitly detach the UE and release the possible
remaining PDN connections in EPC.
The subscription profile the AMF received from HSS+UDM includes the DNN/APN
and PGW-C+SMF FQDN for S5/S8 interface for each PDN connection established in
EPC. For emergency PDU Session, the AMF receives Emergency Information
containing PGW-C+SMF FQDN from HSS+UDM.
6\. Steps 15-20 as in clause 4.2.2.2.2 (General Registration).
7\. Step 21 as in clause 4.2.2.2.2 (General Registration) with the following
modifications:
The AMF includes an \"Interworking without N26\" indicator to the UE.
If the UE had provided PDU Session Status information in step 1, the AMF sets
the PDU Session Status to not synchronized.
8\. Step 22 as in clause 4.2.2.2.2 (General Registration)
9\. UE requested PDU Session Establishment procedure as in clause 4.3.2.2.1.
If the UE had setup PDN Connections in EPC which it wants to transfer to 5GS
and maintain the same IP address/prefix and the UE received \"Interworking
without N26\" indicator in step 7, the UE performs the UE requested PDU
Session Establishment Procedure as in clause 4.3.2.2 and sets the Request Type
to \"Existing PDU Session\" or \"Existing Emergency PDU Session\" in Step 1 of
the procedure. The UE provides a DNN for non-emergency PDU Session, the PDU
Session ID and S-NSSAI corresponding to the existing PDN connection it wants
to transfer from EPS to 5GS. The S-NSSAI is set as described in clause
5.15.7.2 of TS 23.501 [2].
If the Request Type indicates \"Existing Emergency PDU Session\", the AMF
shall use the Emergency Information received from the HSS+UDM which contains
PGW-C+SMF FQDN for S5/S8 interface for the emergency PDN connection
established in EPS and the AMF shall use the S-NSSAI locally configured in
Emergency Configuration Data.
UEs in single-registration mode performs this step for each PDN connection
immediately after the Step 8. UEs in dual-registration mode may perform this
step any time after Step 8. Also, UEs in dual-registration mode may perform
this step only for a subset of PDU Sessions. The AMF determines the S5/S8
interface of the PGW-C+SMF for the PDU Session based on the DNN received from
the UE and the PGW-C+SMF ID in the subscription profile received from the
HSS+UDM in Step 5 or when the HSS+UDM notifies the AMF for the new PGW-C+SMF
ID in the updated subscription profile. The AMF queries the NRF in serving
PLMN by issuing the Nnrf_NFDiscovery_Request including the FQDN for the S5/S8
interface of the PGW-C+SMF and the NRF provides the IP address or FQDN of the
N11/N16 interface of the PGW-C+SMF. The AMF invokes the
Nsmf_PDUSession_CreateSMContext service with the SMF address provided by the
NRF. The AMF includes the PDU Session ID to the request sent to the PGW-C+SMF.
The PGW-C+SMF uses the PDU Session ID to determine the correct PDU Session.
After Step 16a of Figure 4.3.2.2.1-1 in clause 4.3.2.2.1, user plane is
switched from EPS to 5GS.
As specified clause 4.3.2.2, if the SMF has not yet registered for the PDU
Session ID, then the SMF registers with the UDM using Nudm_UECM_Registration
(SUPI, DNN, PDU Session ID) and if Session Management Subscription data for
corresponding SUPI, DNN and S-NSSAI is not available, then SMF retrieves the
Session Management Subscription data using Nudm_SDM_Get (SUPI, Session
Management Subscription data, DNN, S-NSSAI) and subscribes to be notified when
this subscription data is modified using Nudm_SDM_Subscribe (SUPI, Session
Management Subscription data, DNN, S-NSSAI).
10\. The PGW-C+SMF performs release of the resources in EPC for the PDN
connections(s) transferred to 5GS by performing the PDN GW initiated bearer
deactivation procedure as defined in clause 5.4.4.1 of TS 23.401 [13], except
the steps 4-7.
#### 4.11.2.4 Impacts to EPS Procedures
##### 4.11.2.4.1 E-UTRAN Attach
Impact on clause 5.3.2.1 of TS 23.401 [13] from adding support for the
optional network functionality dual registration mode:
\- Step 1:
The UE constructs the Attach Request message according to the following
principles:
\- If UE operates in single-registration mode, the UE indicates that it is
moving from 5GC and provides a native 4G-GUTI or a 4G-GUTI mapped from 5G GUTI
(indicated as native GUTI), if available, otherwise the IMSI, or
\- If the UE operates in dual-registration mode, the UE indicates that it is
moving from 5GC and provides native 4G-GUTI, or
\- If the UE sent a TAU in Step 2 and it was rejected because the MME could
not derive the UE identity, the UE provides IMSI.
If the UE wants to transfer a PDU Session to EPC as part of the Attach
procedure, it includes a PDN CONNECTIVITY Request message in the Attach
Request and provides a Request type \"Handover\", DNN/APN and PDU Session ID
of the PDU Session (clause 5.3.2.1 of TS 23.401 [13]). The UE provides the PDU
Session ID in PCO as described in clause 4.11.1.1.
If the TAU was rejected in Step 2 the IP address preservation is not provided.
In this case the UE provides IMSI in the Attach Request and does not provide a
Request Type \"Handover\" in the PDN CONNECTIVITY Request if included in the
Attach Request.
The UE provides an EPS bearer ID for all mapped EPS bearers in the EPS bearer
status. For the initial Attach Request the EPS bearer status is empty.
NOTE 1: The UE is aware the network is configured to support 5GS-EPS
interworking without N26 procedure. The UE does not include the EPS bearer IDs
corresponding to the 5G QoS flows to the EPS bearer status.
If the UE supports 5GC NAS procedures (see clause 5.17.2 in TS 23.501 [2]),
then the UE shall indicate its support of 5G NAS in a NAS indicator.
\- Step 3:
If the UE provided a 4G-GUTI mapped from 5G-GUTI and the MME is configured to
support 5GS-EPS interworking without N26 procedure, the MME does not perform
Step 3, Identification Request to old MME/SGSN/AMF in clause 5.3.2.1 in TS
23.401 [13].
NOTE 2: As the 4G-GUTI mapped from 5G-GUTI is unknown identity to the MME, the
MME sends an Identity Request to the UE to request the IMSI. The UE responds
with Identity Response (IMSI).
\- Step 8:
If the UE indicates that it is moving from 5GC (Attach Request) and the MME is
configured to support 5GS-EPS interworking without N26 procedure, the MME
sends an Update Location Request message to the HSS+UDM indicating that
registration of an AMF at the HSS+UDM, if any, shall not be cancelled. The
HSS+UDM does not send Nudm_UECM_DeregistrationNotification to the old AMF.
NOTE 3: If the UE does not maintain registration in 5GC, upon reachability
time-out, the AMF can implicitly detach the UE and release the possible
remaining PDU Sessions in 5GC.
\- Step 11:
The HSS+UDM selects one of the PGW-C+SMF FQDN for one APN based on operator\'s
policy. The HSS+UDM sends selected PGW-C+SMF FQDN along with APN to the MME
for the UE.
\- Step 12:
The MME determines the PGW-C+SMF address for the Create Session Request based
on the APN received from the UE and the subscription profile received from the
HSS+UDM.
\- Step 13:
The PGW-C+SMF uses the PDU Session ID received from the UE in PCO to correlate
the transferred PDN connection with the PDU Session in 5GC.
In this release, if the Handover Indication is present in the Create Session
Request and the PGW-C+SMF detects it corresponds to a PDU Session for a LADN
in 5GC, the PGW-C+SMF rejects the request.
\- Step 14:
IP-CAN Session Modification procedure is replaced by SM Policy Association
Modification Procedure as described in clause 4.16.5.
\- Step 17:
If the UE indicated support for 5GC NAS procedures (see clause 5.11.3) and the
MME supports procedures for interworking with 5GC without N26, the MME may
indicate in the Attach Accept, that interworking without N26 is supported. UE
handling of this indicator is defined in TS 23.501 [2].
\- Step 23a:
As a result of the procedure the PGW-U+UPF starts routing DL data packets to
the Serving GW for the default and any dedicated EPS bearers established for
this PDN connection.
\- Step 25:
Notify Request is sent to HSS/UDM if the network supports the procedures for
5GC interworking without N26 and that the UE is allowed to access 5GC
(condition that is identified based on the subscription data). For emergency
attach, Notify Request is sent to HSS/UDM if the network supports the
procedures for 5GC interworking without N26 and operator policy allows
handover of emergency session to 5GS.
##### 4.11.2.4.2 Session Management
##### 4.11.2.4.2.1 PDN Connection Request {#pdn-connection-request-1 .H6}
Same procedure as specified in clause 4.11.1.5.4.1 is used with the following
clarification:
Step 6. The relevant steps of the procedure as specified in the figure above
are executed with the following modification:
\- Additional condition to trigger Notify Request to HSS in step 15 of Figure
5.10.2-1 in TS 23.401 [13] is that the network supports the procedures for 5GC
interworking without N26 and that the UE is allowed to use 5GS in the
subscription data. If the Request Type of the UE requested connectivity
procedure indicates \"Emergency\", MME triggers Notify Request to HSS if the
network supports the procedures for 5GC interworking without N26 and operator
policy allows handover of emergency session to 5GS.
For an unauthenticated or roaming UE, if the Request Type of the UE requested
connectivity procedure indicates \"Emergency\", the MME shall not send any
Notify Request to an HSS.
##### 4.11.2.4.3 Initial Attach on S2b
Impacts on clause 7.2.1 of TS 23.402 [26] are the following ones:
\- step 2:
\- If the UE supports 5GC NAS procedures (see clause 5.17.2 in TS 23.501 [2]),
the UE shall indicate its support of 5G NAS to the ePDG during IKEv2 message
exchanges. When the UE supports 5G NAS, it shall also provide the PDU Session
ID during IKEv2 message exchanges.
\- UE\'s mobility restriction parameters related to 5GS and/or indication of
support for interworking with 5GS for this APN as defined for MME in clause
4.11.0a.3 apply to the ePDG and are obtained by the ePDG as part of the reply
from the HSS via the 3GPP AAA Server. Together with the 5G NAS support
indicator, it enables the ePDG to determine if a combined PGW-C+SMF or a
standalone PGW should be selected.
\- If the UE supports 5G NAS and the PDN connection is not restricted to
interworking with 5GS by user subscription, the ePDG shall send the 5GS
Interworking Indication and the PDU Session ID to the PGW+SMF in step 3.
### 4.11.3 Handover procedures between EPS and 5GC-N3IWF
#### 4.11.3.1 Handover from EPS to 5GC-N3IWF
Figure 4.11.3.1-1: Handover from EPS to 5GC-N3IWF
0\. Initial status: one or more PDN connections have been established in EPC
between the 5G capable UE and the PGW via E-UTRAN.
1\. The UE initiates Registration procedure on untrusted non-3GPP access via
N3IWF (with 5G-GUTI is available or SUCI if not) per clause 4.12.2.
2\. The UE initiates a UE requested PDU Session Establishment with Existing
PDU Session indication in 5GC via Untrusted non-3GPP Access via N3IWF
according to clause 4.12.5.
If the Request Type indicates \"Existing Emergency PDU Session\", the AMF
shall use the Emergency Information received from the HSS+UDM which contains
PGW-C+SMF FQDN for S5/S8 interface for the emergency PDN connection
established in EPS and the AMF shall use the S-NSSAI locally configured in
Emergency Configuration Data.
The combined PGW+SMF/UPF initiates a PDN GW initiated bearer deactivation as
described in clause 5.4.4.1 of TS 23.401 [13] to release the EPC and E-UTRAN
resources.
#### 4.11.3.2 Handover from 5GC-N3IWF to EPS
Figure 4.11.3.2-1: Handover from 5GC-N3IWF to EPS
0\. Initial status: one or more PDU Sessions have been established in 5GC
between the UE and the SMF/UPF via untrusted non-3GPP access and N3IWF. During
PDU Session setup and in addition to what is specified in clause 4.3.2.2.1 and
clause 4.3.2.2.2, the PGW-C+SMF sends the FQDN related to the S5/S8 interface
to the HSS+UDM which stores it.
1\. For the UE to move PDU session(s) from 5GC/N3IWF to EPC/E-UTRAN, the UE\'s
behaviour is as follows:
\- If the UE is operating in single-registration mode (as described in clause
5.17.2.1 in TS 23.501 [2]) and the UE is registered via 3GPP access to 5GC,
\- the UE behaves as specified in clause 4.11.1 or 4.11.2 and moves its PDU
session from 5GC/N3IWF to EPC/E-UTRAN using the PDN connection establishment
with \"Handover\" indication procedure as described in TS 23.401 [13].
\- otherwise, i.e. either the UE is operating in single registration mode and
is not registered via 3GPP access to 5GC, or the UE is operating in dual
registration mode and
\- if the UE is not attached to EPC/E-UTRAN, the UE initiates Handover Attach
procedure in E-UTRAN as described in TS 23.401 [13] for a non-3GPP to EPS
handover with \"Handover\" indication, except note 17.
\- otherwise (i.e. the UE is attached to EPC/E-UTRAN), the UE initiates the
PDN Connection establishment with \"Handover\" indication procedure as
described in TS 23.401 [13].
2\. The combined PGW+SMF/UPF initiates a network requested PDU Session Release
via untrusted non-3GPP access and N3IWF according to Figure 4.12.7-1 steps 3
to 12 to release the 5GC and N3IWF resources with the following exception:
\- the H-SMF indicates in the Nsmf_PDUSession_Update Request that the UE shall
not be notified. This shall result in the V-SMF not sending the N1 SM
Container (PDU Session Release Command) to the UE.
\- Nsmf_PDUSession_StatusNotify service operation invoked by H-SMF to V-SMF
indicates the PDU Session is moved to a different system;
\- Nsmf_PDUSession_SMContexStatusNotify service operation invoked by the
(V-)SMF indicates the PDU Session is moved to another system.
\- The Npcf_SMPolicyControl_Delete service operation to PCF shall not be
performed.
### 4.11.4 Handover procedures between EPC/ePDG and 5GS
#### 4.11.4.1 Handover from EPC/ePDG to 5GS
Figure 4.11.4.1-1: Handover from EPC/ePDG to 5GS
0\. Initial status: one or more PDU Sessions have been established between the
UE and the EPC/ePDG via untrusted non-3GPP access. The UE has indicated its 5G
NAS capability in order for the ePDG to select a combined PGW+SMF and has
provided the PDU Session ID to the combined PGW/SMF.
1\. For the UE to move its PDU session(s) from EPC/ePDG to 5GC/3GPP access,
the UE\'s behaviour is as follows:
\- If the UE is operating in single-registration mode (as described in clause
5.17.2.1 in TS 23.501 [2]) and the UE is attached to EPC/E-UTRAN:
\- the UE behaves as specified in clause 4.11.1 or clause 4.11.2 and gets
registered to 5GC via 3GPP access.
\- otherwise i.e. either the UE is operating in single registration mode and
is not attached to EPC/E-UTRAN, or the UE is operating in dual registration
mode and
\- if the UE is already registered in 5GS via 3GPP access, the UE skips to
step 2.
\- otherwise (i.e. UE is not registered in 5GS via 3GPP access), the UE
performs Registration procedure of type initial registration in 5GS via 3GPP
access as described in clause 4.2.2.2.
2\. The UE initiates a UE requested PDU Session Establishment via 3GPP Access
according to clause 4.3.2.2 and includes the \"Existing PDU Session\"
indication or \"Existing Emergency PDU Session\" and the PDU Session ID.
If the Request Type indicates \"Existing Emergency PDU Session\", the AMF
shall use the Emergency Information containing PGW-C+SMF FQDN for the S2b
interface it has received from the HSS+UDM. The PGW-C+SMF FQDN was sent by
PGW-C when the Emergency PDN connection was established in EPC via ePDG and
the AMF shall use the S-NSSAI locally configured in Emergency Configuration
Data.
3\. The combined PGW+SMF/UPF initiates a PDN GW initiated Resource Allocation
Deactivation with GTP on S2b as described in clause 7.9.2 of TS 23.402 [26] to
release the EPC and ePDG resources.
#### 4.11.4.2 Handover from 5GS to EPC/ePDG
Figure 4.11.4.2-1: Handover from 5GS to EPC/ePDG
0\. Initial status: one or more PDU Sessions have been established between the
UE and the SMF/UPF via NG-RAN.
1\. The UE connects to an untrusted non-3GPP access and the N3IWF-ePDG
selection process results in selecting an ePDG.
2\. The UE initiates a Handover Attach procedure as described in clause
8.6.2.1 of TS 23.402 [26], except step 11 of referenced figure 8.2.3-1 that
corresponds to the release of resources in source system.
3\. The combined PGW+SMF/UPF initiates a network requested PDU Session Release
via 3GPP access according to Figure 4.3.4.2-1 steps 3b to 7b, step 11 or
Figure 4.3.4.3-1 steps 3a-16b to release the 5GC and NG-RAN resources with the
following exception:
\- For non-roaming or local breakout in clause 4.3.4.2, the SMF does not
include N1 SM Container in Namf_Communication_N1N2MessageTransfer service
operation.
\- For home routing roaming in clause 4.3.4.3, the H-SMF indicates in the
Nsmf_PDUSession_Update Request that the UE shall not be notified. This shall
result in the V-SMF not sending the N1 SM Container (PDU Session Release
Command) to the UE.
\- Nsmf_PDUSession_StatusNotify service operation invoked by H-SMF to V-SMF
and Nsmf_PDUSession_SMContexStatusNotify service operation invoked by the
(V-)SMF to the AMF indicate that the PDU Session is moved to a different
system.
\- The Npcf_SMPolicyControl_Delete service operation to PCF shall not be
performed.
### 4.11.5 Impacts to 5GC Procedures
#### 4.11.5.1 General
This clause captures impacts to 5GC procedures in other clauses of this
specification to support interworking with EPS. These impacts are applicable
to interworking based on N26 and interworking without N26.
#### 4.11.5.2 Registration procedure
The following impacts are applicable to clause 4.2.2.2 (Registration
procedure) when the UE has established PDU Session(s):
In clause 4.3.2.2.1 Non-roaming and Roaming with Local Breakout:
\- Step 17: Additional trigger for Step 17 Nsmf_PDUSession_UpdateSMContext
are:
\- If status of interworking with EPS for a PDU session changes, e.g. due to
change of 5GMM capability (e.g. \"S1 mode supported\"), the UE subscription
data change (e.g. Core Network Type Restriction to EPC), the AMF invokes
Nsmf_PDUSession_UpdateSMContext (EPS Interworking Indication with N26 or
without N26) to SMF. The SMF determines whether the PDU session supports
interworking with EPS need be changed. If it needs to be changed, the SMF
invokes Nudm_UECM_Update service operation to add or remove the PGW-C FQDN for
S5/S8 interface from the UE context in SMF data stored at the UDM.
For interworking with the N26 interface, if status of interworking with EPS
for a PDU session is changed at PGW-C+SMF, the PGW-C+SMF invokes EBI
allocation or revocation as described in clause 4.11.1.4.1 and clause
4.11.1.4.2 respectively.
#### 4.11.5.3 UE Requested PDU Session Establishment procedure
The following impacts are applicable to clause 4.3.2.2 (UE Requested PDU
Session Establishment procedure) to support interworking with EPS:
In clause 4.3.2.2.1 Non-roaming and Roaming with Local Breakout:
\- Step 3: The AMF determines that a PDU Session supports EPS interworking
with N26 or without N26, based on e.g. 5GMM capability (e.g. \"S1 mode
supported\"), UE subscription data (e.g. Core Network Type Restriction to EPS,
EPC interworking support per (S-NSSAI, subscribed DNN)) and network
configuration if EPS interworking with N26 or without N26 is supported. The
AMF then includes in the Nsmf_PDUSession_CreateSMContext an indication whether
the PDU Session supports EPS Interworking with N26 or without N26.
\- For PDU Session with Request Type \"initial emergency request\", the AMF
decides the EPS interworking with N26 or without N26 based on 5GMM capability
and local configuration.
\- For PDU Session with Request Type \"Existing Emergency PDU Session\", the
AMF shall use Emergency Information received from HSS+UDM and the S-NSSAI
locally configured in Emergency Configuration Data.
\- Step 4: If the EPS Interworking indication received from AMF indicates that
the UE supports EPS interworking and the SMF determines (e.g. based on UE
subscription data (e.g. whether EPS interworking is allowed for this DNN and
S-NSSAI)) that the PDU Session supports EPS interworking, the PGW-C+SMF FQDN
for S5/S8 interface is included in the Nudm_UECM_Registration Request.
In clause 4.3.2.2.2 Home-routed Roaming:
\- Step 3a: Same impact as for step 3 for the Non-roaming and Roaming with
Local Breakout case above.
\- Step 6 The V-SMF pass the received EPS interworking indication to the H-SMF
in Nsmf_PDUSession_Create.
\- Step 7: If the EPS interworking indication received from V-SMF indicates
that the PDU Session supports EPS interworking and the SMF determines (e.g.
based on UP integrity protection of UP Security Enforcement Information as
described in clause 4.11.1.1) that the PDU Session supports EPS interworking,
the PGW-C+SMF FQDN for S5/S8 interface is included in the
Nudm_UECM_Registration Request.
For interworking with the N26 interface, if the PDU Session supports
interworking with EPS, the PGW-C+SMF invokes EBI allocation as described in
clause 4.11.1.4.1.
#### 4.11.5.4 UE or Network Requested PDU Session Modification procedure
The following impacts are applicable to clause 4.3.3.2 (UE or network
requested PDU Session Modification (non-roaming and roaming with local
breakout)) to support interworking with EPS:
\- Step 1: In addition to the triggers listed in step 1 of clause 4.3.3.2, the
procedure may be also triggered by the following event:
\- AMF initiated modification: If the support of EPS Interworking for this PDU
Session has changed, e.g. the change of the UE\'s subscription data (e.g. Core
Network Type Restriction to EPS), or change of 5GMM capability (e.g. \"S1 mode
supported\"), the AMF invokes Nsmf_PDUSession_UpdateSMContext update the
status of EPS interworking support in the to SMF.
\- Step 3a: This step also applies to AMF initiated modification. For AMF
initiated modification, the SMF may determines whether the PDU session
supports EPS interworking need be changed. If it need be changed, the SMF
invokes Nudm_UECM_Update service operation to add or remove the PGW-C FQDN for
S5/S8 interface from the UE context in SMF data stored at the UDM,
The following impacts are applicable to clause 4.3.3.3 (UE or network
requested PDU Session Modification (home-routed roaming)) to support
interworking with EPS:
\- Step 1a (AMF to V-SMF): Same impact as for step 1 of clause 4.3.3.2 above.
\- Step 1a (V-SMF to H-SMF): The V-SMF pass the status of EPS interworking
support to the H-SMF.
\- Step 1a (H-SMF to V-SMF): Same impact as for clause 3a of 4.3.3.2 above.
or interworking with the N26 interface, if status of interworking with EPS for
a PDU session is changed at PGW-C+SMF, the PGW-C+SMF invokes EBI allocation or
revocation as described in clause 4.11.1.4.1 and clause 4.11.1.4.2
respectively.
#### 4.11.5.5 Xn based inter NG-RAN handover
The following impacts are applicable to clause 4.9.1.2.1 (General) to support
interworking with EPS:
\- If there is Mapping between EBI(s) and QFI(s) for the UE in the source NG-
RAN, the source NG-RAN sends the Mapping to target NG-RAN during handover.
#### 4.11.5.6 Inter NG-RAN node N2 based handover
The following impacts are applicable to clause 4.9.1.3.2 (Preparation phase)
to support interworking with EPS:
\- Step 7: If the PDU session supports EPS interworking, the N2 SM information
contains the Mapping between EBI(s) and QFI(s).
## 4.12 Procedures for non-3GPP access
### 4.12.1 General
Clause 4.12 defines the procedures to support non-3GPP access by describing
the differences compared to the defined procedures in other clauses.
### 4.12.2 Registration via Untrusted non-3GPP Access
#### 4.12.2.1 General
Clause 4.12.2 specifies how a UE can register to 5GC via an untrusted non-3GPP
access network. It is based on the Registration procedure specified in clause
4.2.2.2.2 and it uses a vendor-specific EAP method called \"EAP-5G\". The
EAP-5G packets utilize the \"Expanded\" EAP type and the existing 3GPP Vendor-
Id registered with IANA under the SMI Private Enterprise Code registry. The
\"EAP-5G\" method is used between the UE and the N3IWF and is utilized only
for encapsulating NAS messages (not for authentication). If the UE needs to be
authenticated, mutual authentication is executed between the UE and AUSF. The
details of the authentication procedure are specified in TS 33.501 [15].
In Registration and subsequent Registration procedures via untrusted non-3GPP
access, the NAS messages are always exchanged between the UE and the AMF. When
possible, the UE can be authenticated by reusing the existing UE security
context in AMF.
#### 4.12.2.2 Registration procedure for untrusted non-3GPP access
The signalling flow in Figure 4.12.2.2-1 does not show all the details of a
registration procedure via untrusted non-3GPP access. It shows primarily the
steps executed between the UE and N3IWF. All the details of a registration
procedure, including interactions with PCF, UDM, etc. are specified in clause
4.2.2.2.2.
Figure 4.12.2.2-1: Registration via untrusted non-3GPP access
1\. The UE connects to an untrusted non-3GPP access network with procedures
outside the scope of 3GPP and it is assigned an IP address. Any non-3GPP
authentication method can be used, e.g. no authentication (in the case of a
free WLAN), EAP with pre-shared key, username/password, etc. When the UE
decides to attach to 5GC network, the UE selects an N3IWF in a 5G PLMN, as
described in clause 6.3.6 of TS 23.501 [2].
2\. The UE proceeds with the establishment of an IPsec Security Association
(SA) with the selected N3IWF by initiating an IKE initial exchange according
to RFC 7296 [3]. After step 2, all subsequent IKE messages are encrypted and
integrity protected by using the IKE SA established in this step.
3\. The UE shall initiate an IKE_AUTH exchange by sending an IKE_AUTH request
message. The AUTH payload is not included in the IKE_AUTH request message,
which indicates that the IKE_AUTH exchange shall use EAP signalling (in this
case EAP-5G signalling). If the UE supports MOBIKE, it shall include a Notify
payload in the IKE_AUTH request, as specified in RFC 4555 [40], indicating
that MOBIKE is supported. In addition, as specified in TS 33.501 [15], if the
UE is provisioned with the N3IWF root certificate, it shall include the
CERTREQ payload within the IKE_AUTH request message to request the N3IWF\'s
certificate.
4\. The N3IWF responds with an IKE_AUTH response message, which includes an
EAP-Request/5G-Start packet. The EAP-Request/5G-Start packet informs the UE to
initiate an EAP-5G session, i.e. to start sending NAS messages encapsulated
within EAP-5G packets. If the N3IWF has received a CERTREQ payload from the
UE, the N3IWF shall include the CERT payload in the IKE_AUTH response message
containing the N3IWF\'s certificate. How the UE uses the N3IWF\'s certificate
is specified in TS 33.501 [15].
5\. The UE shall send an IKE_AUTH request, which includes an EAP-
Response/5G-NAS packet that contains the Access Network parameters (AN
parameters) and a Registration Request message. The AN parameters contain
information that is used by the N3IWF for selecting an AMF in the 5G core
network. This information includes e.g. the GUAMI, the Selected PLMN ID, the
Requested NSSAI and the Establishment cause. The Establishment cause provides
the reason for requesting a signalling connection with 5GC.
NOTE 1: The N3IWF does not send an EAP-Identity request because the UE
includes its identity in the first IKE_AUTH. This is in line with RFC7296,
clause 3.16.
6\. The N3IWF shall select an AMF based on the received AN parameters and
local policy, as specified in clause 6.5.3 of TS 23.501 [2]. The N3IWF shall
then forward the Registration Request received from the UE to the selected AMF
within an N2 message. This message contains N2 parameters that include the
Selected PLMN ID and the Establishment cause.
7\. The selected AMF may decide to request the SUCI by sending a NAS Identity
Request message to UE. This NAS message and all subsequent NAS messages are
sent to UE encapsulated within EAP/5G-NAS packets.
8\. The AMF may decide to authenticate the UE by invoking an AUSF. In this
case, the AMF shall select an AUSF as specified in clause 6.3.4 of TS 23.501
[2] based on SUPI or SUCI.
The AUSF executes the authentication of the UE as specified in TS 33.501 [15].
The AUSF selects a UDM as described in clause 6.3.8 of TS 23.501 [2] and gets
the authentication data from UDM. The authentication packets are encapsulated
within NAS authentication messages and the NAS authentication messages are
encapsulated within EAP/5G-NAS packets. After the successful authentication:
\- In step 8h, the AUSF shall send the anchor key (SEAF key) to AMF which is
used by AMF to derive NAS security keys and a security key for N3IWF (N3IWF
key). The UE also derives the anchor key (SEAF key) and from that key it
derives the NAS security keys and the security key for N3IWF (N3IWF key). The
N3IWF key is used by the UE and N3IWF for establishing the IPsec Security
Association (in step 11).
\- In step 8h, the AUSF shall also include the SUPI, if in step 8a the AMF
provided to AUSF a SUCI.
NOTE 2: EAP-AKA\' or 5G-AKA are allowed for the authentication of UE via
non-3GPP access, as specified in TS 33.501 [15]. Figure 4.12.2.2-1 only shows
authentication flow using EAP-AKA\'.
9a. The AMF shall send a NAS Security Mode Command to UE in order to activate
NAS security. If an EAP-AKA\' authentication was successfully executed in step
8, the AMF shall encapsulate the EAP-Success received from AUSF within the NAS
Security Mode Command message.
9b. The N3IWF shall forward the NAS Security Mode Command message to UE within
an EAP/5G-NAS packet.
9c. The UE completes the EAP-AKA\' authentication (if initiated in step 8),
creates a NAS security context and an N3IWF key and sends the NAS Security
Mode Complete message within an EAP/5G-NAS packet.
9d. The N3IWF relays the NAS Security Mode Complete message to the AMF.
10a. Upon receiving NAS Security Mode Complete, the AMF shall send an NGAP
Initial Context Setup Request message that includes the N3IWF key.
10b. This triggers the N3IWF to send an EAP-Success to UE, which completes the
EAP-5G session. No further EAP-5G packets are exchanged.
11\. The IPsec SA is established between the UE and N3IWF by using the common
N3IWF key that was created in the UE in step 9c and received by the N3IWF in
step 10a. This IPsec SA is referred to as the \"signalling IPsec SA\". After
the establishment of the signalling IPsec SA, the N3IWF notifies the AMF that
the UE context (including AN security) was created by sending a NGAP Initial
Context Setup Response. The signalling IPsec SA shall be configured to operate
in tunnel mode and the N3IWF shall assign to UE an \"inner\" IP address. If
the N3IWF has received an indication that the UE supports MOBIKE (see step 3),
then the N3IWF shall include a Notify payload in the IKE_AUTH response message
sent in step 11a, indicating that MOBIKE shall be supported, as specified in
RFC 4555 [40].
All subsequent NAS messages exchanged between the UE and N3IWF shall be sent
via the signalling IPsec SA and shall be carried over TCP/IP. The UE shall
send NAS messages within TCP/IP packets with source address the \"inner\" IP
address of the UE and destination address the NAS_IP_ADDRESS that is received
in step 11a. The N3IWF shall send NAS messages within TCP/IP packets with
source address the NAS_IP_ADDRESS and destination address the \"inner\" IP
address of the UE. The TCP connection used for reliable NAS transport between
the UE and N3IWF shall be initiated by the UE right after the signalling IPsec
SA is established in step 11a. The UE shall send the TCP connection request to
the NAS_IP_ADDRESS and to the TCP port number specified in TS 24.502 [41].
12\. The AMF sends the NAS Registration Accept message to the N3IWF. The N2
Message includes the Allowed NSSAI for the access type for the UE.
13\. The N3IWF forwards the NAS Registration Accept to UE via the established
signalling IPsec SA. If the NAS Registration Request message is received by
the N3IWF before the IPsec SA is established, the N3IWF shall store it and
forward it to the UE only after the establishment of the signalling IPsec SA.
The AMF provides the Access Type set to \"Non-3GPP access\" to the UDM when it
registers with the UDM.
#### 4.12.2.3 Emergency Registration for untrusted non-3GPP Access
Emergency Registration procedure is used by UEs requiring to perform emergency
services but cannot gain normal services from the network. These UEs are in
limited service state as defined in TS 23.122 [22].
The regular registration procedure described in clause 4.12.2 applies with the
following differences:
\- If the UE has no SUPI and no valid 5G-GUTI, PEI shall be included instead
of its encrypted Permanent User ID (SUCI) in the Access Network parameters.
\- NSSAI shall not be included by the UE. The AMF shall not send the Allowed
S-NSSAIs in the Registration Accept message.
\- If the AMF is not configured to support Emergency Registration, the AMF
shall reject any Registration Request that indicates Registration type
\"Emergency Registration\".
\- If the AMF is configured to support Emergency Registration for
unauthenticated UEs and the UE indicated Registration Type \"Emergency
Registration\", the AMF skips the authentication and security setup or the AMF
accepts that the authentication may fail and continues the Emergency
Registration procedure.
\- If the authentication is performed successfully, the NAS messages will be
protected by the NAS security functions (integrity and ciphering). The AMF
shall derive the N3IWF key, per TS 33.501 [15] and shall provide it to the
N3IWF after the authentication completion using an NGAP Initial Context Setup
Request message as in the regular registration procedure.
\- If the authentication is skipped or authentication fails, the NAS messages
will not be protected by the NAS security functions (integrity and ciphering).
However, the AMF shall create an N3IWF key and shall provide it to the N3IWF
after the authentication completion (whenever authentication has failed or has
been skipped) using an NGAP Initial Context Setup Request message. The N3IWF
shall use it to complete IKE SA establishment and shall acknowledge the AMF by
sending an NGAP Initial Context Setup Response message.
NOTE: Per TS 33.501 [15], the UE and the AMF independently generate the KAMF
(and derived keys) in an implementation defined way and populate the 5G NAS
security context with this KAMF to be used when activating a 5G NAS security
context.\"
\- As in step 14 of figure 4.2.2.2.2-1 for Emergency Registration, if the UE
was not successfully authenticated, the AMF shall not update the UDM. Also for
an Emergency Registration, the AMF shall not check for access restrictions,
regional restrictions or subscription restrictions.
\- Steps 16 and 22b of figure 4.2.2.2.2-1 are not performed since AM and UE
policy for the UE are not required for Emergency Registration.
### 4.12.3 Deregistration procedure for untrusted non-3gpp access
Figure 4.12.3-1: Deregistration procedure for untrusted non-3gpp access
1\. The Deregistration procedure is triggered by one of the events:
1a. For UE-initiated Deregistration as in steps from 1 to 7 of Figures
4.2.2.3.2-1.
1b. For network initiated deregistration as in steps from 1 to 6 of Figure
4.2.2.3.3-1.
If the UE is in CM-CONNECTED state either in 3GPP access, non-3GPP access or
both,
\- the AMF may explicitly deregister the UE by sending a Deregistration
request message ( Deregistration type, access type set to non-3GPP) to the UE
as in step 2 of Figure 4.2.2.3.3-1.
\- the UDM may want to request the deletion of the subscribers RM contexts and
PDU Sessions with the reason for removal set to subscription withdrawn to the
registered AMF as in step 1 of Figure 4.2.2.3.3-1.
2\. AMF to N3IWF: The AMF sends a N2 Context UE Release Command message to the
N3IWF with the cause set to Deregistration to release N2 signalling as defined
in step 4 of clause 4.12.4.2.
3\. N3IWF to UE: The N3IWFsends INFORMATIONAL EXCHANGE (Delete payload)
message to the UE. Delete payload is included to indicate the release of the
IKE SA.
4\. UE to N3IWF: The UE sends an empty INFORMATIONAL EXCHANGE message to
acknowledge the release of the IKE SA as described in RFC 7296 [3]. Non-3GPP
access specific resources are released including the IKEv2 tunnel (and the
associated IPSec resources) and the local UE contexts in N3IWF (N3 tunnel Id).
5\. N3IWF to AMF: The N3IWF acknowledges the N2 UE Context Release Command
message by sending N2 UE Context Release Complete message to the AMF as
defined in step 7 of clause 4.12.4.2.
### 4.12.4 N2 procedures via Untrusted non-3GPP Access
#### 4.12.4.1 Service Request procedures via Untrusted non-3GPP Access
The Service Request procedure via Untrusted non-3GPP Access shall be used by a
UE in CM-IDLE state over non-3GPP access to request the re-establishment of
the NAS signalling connection and the re-establishment of the user plane for
all or some of the PDU Sessions which are associated to non-3GPP access.
The Service Request procedure via Untrusted non-3GPP Access shall be used by a
UE in CM-CONNECTED state over non-3GPP access to request the re-establishment
of the user plane for one or more PDU Sessions which are associated to
non-3GPP access.
When the UE is in CM-IDLE state over non-3GPP access, the Service Request
procedure via Untrusted non-3GPP Access is as described in clause 4.2.3.2 (UE
Triggered Service Request) with the following exceptions:
\- The Service Request procedure is never a response to a Paging, i.e. there
is no Network Triggered Service Request procedure via Untrusted non-3GPP
Access.
\- The (R)AN corresponds to an N3IWF.
\- The UE establishes a \"signalling IPsec SA\" with the N3IWF by using the
procedure specified in clause 4.12.2 for the registration via untrusted
non-3GPP access. In particular, the UE includes the Service Request and the AN
parameters in an EAP-5G packet, which is further encapsulated in an IKE_AUTH
request.
\- The AN parameters include the Selected PLMN ID and Establishment cause. The
Establishment cause provides the reason for requesting a signalling connection
with the 5GC. The UE includes GUAMI information in the AN parameters. The
N3IWF selects the AMF according to GUAMI information.
\- The N2 parameters sent from N3IWF to AMF include the Establishment cause.
\- The user plane between the UE and N3IWF is established not with RRC
signalling but with IKEv2 signalling, as specified in clause 4.12.5 (i.e. by
using an IKEv2 Create_Child_SA exchange). The user plane of each PDU Session
consists of one or more Child SAs.
When the UE is in CM-CONNECTED state over non-3GPP access, the Service Request
procedure via Untrusted non-3GPP Access is as described in clause 4.2.3.2 (UE
Triggered Service Request) with the following exceptions:
\- All NAS signalling exchanged between the UE and network is transferred
within the established \"signalling IPsec SA\".
\- The (R)AN corresponds to an N3IWF.
\- The user plane between the UE and N3IWF is established not with RRC
signalling but with IKEv2 signalling, as specified in clause 4.12.5 (i.e. by
using an IKEv2 Create_Child_SA exchange). The user plane of each PDU Session
consists of one or more Child SAs.
When the UE is in CM-CONNECTED state over non-3GPP access and the network
receives downlink data for a PDU Session over non-3GPP access that has no user
plane, the steps 1-4a in clause 4.2.3.3 (Network Triggered Service Request)
shall be performed with the following exceptions:
\- The (R)AN corresponds to an N3IWF.
\- The user plane between the UE and N3IWF is established (in step 4a) with
IKEv2 signalling, as specified in clause 4.12.5 (i.e. by using an IKEv2
Create_Child_SA exchange). The user plane of each PDU Session consists of one
or more Child SAs.
#### 4.12.4.2 Procedure for the UE context release in the N3IWF
This procedure is used to release the N2 signalling connection and the N3 User
Plane connection. If the procedure is initiated by the AMF the IKEv2 SA for a
UE is being released. The procedure will move the UE from CM-CONNECTED to CM-
IDLE in AMF and all UE related context information is deleted in the N3IWF.
Both N3IWF-initiated and AMF-initiated UE context release in the N3IWF
procedures are shown in Figure 4.12.4.2-1.
Figure 4.12.4.2-1: Procedure for the UE context release in the N3IWF
1\. The UE has already registered in the 5GC and may have established one or
multiple PDU Sessions.
2\. The N3IWF detects that the UE is not reachable.
3\. The N3IWF sends a N2 UE Context Release Request message to the AMF This
step is equivalent to step 1b of Figure 4.2.6-1.
NOTE: AN Release procedure can also be triggered by an AMF internal event and
in that case step 2 and step 3 do not take place.
4\. AMF to N3IWF: If the AMF receives the N2 UE Context Release Request from
N3IWF or if due to an internal AMF event the AMF wants to release N2
signalling, the AMF sends an N2 UE Context Release Command (Cause) to the
N3IWF. The cause indicated is cause from step 3 or a cause due to internal AMF
event. This step is equivalent to step 2 of Figure 4.2.6-1.
5\. If the IKEv2 tunnel has not been released yet, the N3IWF performs the
release of the IPsec tunnel as defined in RFC 7296 [3] indicating to release
the IKE SA and any Child IPSec SA if existing. The N3IWF sends to the UE the
indication of the release reason if received in step 4.
6\. The UE sends an empty INFORMATIONAL Response message to acknowledge the
release of the IKE SA as described in RFC 7296 [3]. The N3IWF deletes the
UE\'s context after receiving the empty INFORMATIONAL Response message.
7\. N3IWF to AMF: The N3IWF confirms the release of the UE-associated
N2-logical connection by returning N2 UE Release Complete (list of PDU Session
ID(s) with active N3 user plane) to the AMF as in step 4 defined in clause
4.2.6. The AMF marks the UE as CM-IDLE state in untrusted non-3GPP access.
8\. For each of the PDU Sessions in the N2 UE Context Release Complete, the
steps 5 to 7 in clause 4.2.6 are performed (PDU Session Update SM Context).
After the AMF receives the Nsmf_PDUSession_UpdateSMContext Response as in step
7 of clause 4.2.6, the AMF considers the N3 connection as released. If list of
PDU Session ID(s) with active N3 user plane is included in step 3, then this
step is performed before step 4.
#### 4.12.4.3 CN-initiated selective deactivation of UP connection of an
existing PDU Session associated with Untrusted non-3GPP Access
The procedure described in clause 4.3.7 (CN-initiated selective deactivation
of UP connection of an existing PDU Session) is used for CN-initiated
selective deactivation of UP connection for an established PDU Session
associated with non-3GPP Access of a UE in CM-CONNECTED state, with the
following exceptions:
\- The NG-RAN corresponds to an N3IWF.
\- The user plane between the UE and N3IWF, i.e. Child SA(s) for the PDU
Session, is released not with RRC signalling but with IKEv2 signalling, as
specified in clause 4.12.7.
### 4.12.5 UE Requested PDU Session Establishment via Untrusted non-3GPP
Access
Clause 4.12.5 specifies how a UE can establish a PDU Session via an untrusted
non-3GPP access network as well as to hand over an existing PDU Session
between 3GPP access and non-3GPP access. The procedure applies in non-roaming,
roaming with LBO as well as in home-routed roaming scenarios.
For non-roaming and LBO scenarios, if the UE is simultaneously registered to a
3GPP access in a PLMN different from the PLMN of the N3IWF, the functional
entities in the following procedures are located in the PLMN of the N3IWF. For
home-routed roaming scenarios, the AMF, V-SMF and associated UPF in VPLMN in
the following procedure is located in the PLMN of the N3IWF.
The procedure below is based on the PDU Session Establishment procedure
specified in clause 4.3.2.2.1 (for non-roaming and roaming with LBO) and the
PDU Session Establishment procedure specified in clause 4.3.2.2.2 (for home-
routed roaming).
Figure 4.12.5-1: PDU Session establishment via untrusted non-3GPP access
1\. The UE shall send a PDU Session Establishment Request message to AMF as
specified in step 1 of clause 4.3.2.2.1. This message shall be sent to N3IWF
via the IPsec SA for NAS signalling (established as specified in clause
4.12.2) and the N3IWF shall transparently forward it to AMF in the 5GC.
2a. In the case of non-roaming or roaming with Local Breakout, steps 2-11
specified in clause 4.3.2.2.1are executed according to the PDU Session
Establishment procedure over 3GPP access. In the case of home-routed roaming,
steps 2-14 specified in clause 4.3.2.2.2 are executed according to the PDU
Session Establishment procedure over 3GPP access.
2b. As described in step 12 of clause 4.3.2.2.1, the AMF shall send a N2 PDU
Session Request message to N3IWF to establish the access resources for this
PDU Session.
3\. Based on its own policies and configuration and based on the QoS profiles
received in the previous step, the N3IWF shall determine the number of IPsec
Child SAs to establish and the QoS profiles associated with each IPsec Child
SA. For example, the N3IWF may decide to establish one IPsec Child SA and
associate all QoS profiles with this IPsec Child SA. In this case, all QoS
Flows of the PDU Session would be transferred over one IPsec Child SA.
4a. The N3IWF shall send to UE an IKE Create_Child_SA request according to the
IKEv2 specification in RFC 7296 [3] to establish the first IPsec Child SA for
the PDU Session. The IKE Create_Child_SA request indicates that the requested
IPsec Child SA shall operate in tunnel mode. This request shall include a
3GPP-specific Notify payload which contains (a) the QFI(s) associated with the
Child SA, (b) the identity of the PDU Session associated with this Child SA,
(c) optionally, a DSCP value associated with the Child SA, (d) optionally a
Default Child SA indication and (e) an UP_IP_ADDRESS. The use of the
UP_IP_ADDRESS is specified in step 8 below.
If a DSCP value is included, then the UE and the N3IWF shall mark all IP
packets sent over this Child SA with this DSCP value. There shall be one and
only one Default Child SA per PDU session. The UE shall send all QoS Flows to
this Child SA for which there is no mapping information to a specific Child
SA. The IKE Create_Child_SA request also contains other information (according
to RFC 7296 [3]) such as the SA payload, the Traffic Selectors (TS) for the
N3IWF and the UE, etc.
4b. If the UE accepts the new IPsec Child SA, the UE shall send an IKE
Create_Child_SA response according to the IKEv2 specification in RFC 7296 [3].
During the IPsec Child SA establishment the UE shall not be assigned an IP
address.
4c-4d. If in step 3 the N3IWF determined to establish multiple IPsec Child SAs
for the PDU Session, then additional IPsec Child SAs shall be established,
each one associated with one or more QFI(s) and with a UP_IP_ADDRESS.
5\. After all IPsec Child SAs are established, the N3IWF shall forward to UE
via the signalling IPsec SA (see clause 4.12.2.2) the PDU Session
Establishment Accept message received in step 2b.
6\. The N3IWF shall send to AMF an N2 PDU Session Request Ack.
7\. In the case of non-roaming or roaming with Local Breakout, all steps
specified in clause 4.3.2.2.1 after step 14 are executed according to the PDU
Session Establishment procedure over 3GPP access. In the case of home-routed
roaming, all steps specified in clause 4.3.2.2.2 after step 18 are executed
according to the PDU Session Establishment procedure over 3GPP access.
8\. On the user-plane:
\- When the UE has to transmit an UL PDU, the UE shall determine the QFI
associated with the UL PDU (by using the QoS rules of the PDU Session), it
shall encapsulate the UL PDU inside a GRE packet and shall forward the GRE
packet to N3IWF via the IPsec Child SA associated with this QFI. The header of
the GRE packet carries the QFI associated with the UL PDU. The UE shall
encapsulate the GRE packet into an IP packet with source address the \"inner\"
IP address of the UE and destination address the UP_IP_ADDRESS associated with
the Child SA.
\- When the N3IWF receives a DL PDU via N3, the N3IWF uses the QFI and the
identity of the PDU Session in order to determine the IPsec Child SA to use
for sending the DL PDU over NWu. The N3IWK encapsulates the DL PDU inside a
GRE packet and copies the QFI in the header of the GRE packet. The N3IWF may
include also in the GRE header a Reflective QoS Indicator (RQI), which shall
be used by the UE to enable reflective QoS. The N3IWF shall encapsulate the
GRE packet into an IP packet with source address the UP_IP_ADDRESS associated
with the Child SA and destination address the \"inner\" IP address of the UE.
### 4.12.6 UE or Network Requested PDU Session Modification via Untrusted
non-3GPP access
The UE or network requested PDU Session Modification procedure via untrusted
non-3GPP access is depicted in figure 4.12.6-1. The procedure applies in non-
roaming, roaming with LBO as well as in home-routed roaming scenarios.
For non-roaming and LBO scenarios, the functional entities in the following
procedures are located in the PLMN of the N3IWF.
The procedure below is based on the PDU Session Modification procedure
specified in clause 4.3.3.2 (for non-roaming and roaming with LBO) and on the
PDU Session Modification procedure specified in clause 4.3.3.3 (for home-
routed roaming).
Figure 4.12.6-1: UE or Network Requested PDU Session Modification via
untrusted non-3GPP access
1\. If the PDU Session Modification procedure is initiated by the UE, the UE
shall send a PDU Session Modification Request message to AMF as specified in
step 1 of clause 4.3.2.2. The message shall be sent to N3IWF via the
established IPsec SA for NAS signalling. The N3IWF shall transparently forward
the PDU Session Modification Request to AMF/SMF.
2\. In the case of non-roaming or LBO, the steps 1a (from AMF) to 1e and steps
2-3 as per the PDU Session Modification procedure in clause 4.3.3.2 are
executed.
In the case of home-routed, the steps 1a (from AMF) to 1d and steps 2-3 as per
the PDU Session Modification procedure in clause 4.3.3.3 are executed.
3\. The AMF sends N2 PDU Session Request (N2 SM information received from SMF,
NAS message) message to theN3IWF. This step is the same as step 4 in clause
4.3.3.2 (for non-roaming and roaming with Local Breakout) and step 5 in clause
4.3.3.3 (for home-routed roaming).
4\. The N3IWF may issue IKEv2 signalling exchange with the UE that is related
with the information received from SMF according to the IKEv2 specification in
RFC 7296 [3]. Based on the N2 SM information received from the SMF, the N3IWF
may perform following:
4a. [Conditional] The N3IWF may decide to create a new Child SA for the new
QoS Flow(s). In this case, the N3IWF establishes a new Child SA by sending an
IKE_CREATE_CHILD_SA request message, which includes the SA, the PDU Session ID
and the QFI(s).
4b. [Conditional] The N3IWF may decide to add or remove QoS Flow(s) to/from an
existing Child SA. In this case, the N3WIF updates the QoS Flow and Child SA
mapping information by sending an INFORMATIONAL request message, which
includes the QFI(s) associated with the Child SA.
4c. [Conditional] The N3IWF may decide to delete an existing Child SA, e.g.
when there is no QoS Flow mapped to this Child SA. In this case, the N3IWF
deletes the existing Child SA by sending INFORMATION request message, which
includes a Delete payload.
NOTE: If the N3IWF has included the Default Child SA indication during the
establishment of one of the Child SAs of the PDU Session, the N3IWF may not
update the mapping between QoS Flows Child SAs.
5\. The N3IWF acknowledges N2 PDU Session Request by sending a N2 PDU Session
Response Message to the AMF to acknowledge the success or failure of the
request.
6\. In the case of non-roaming or LBO, step 7 as per the PDU Session
Modification procedure in clause 4.3.3.2 is executed. In the case of home-
routed, the steps 8-10 as per the PDU Session Modification procedure in clause
4.3.3.3 are executed.
7\. The N3IWF sends the PDU Session Modification Command to UE (if received in
step 3) and receives the response message from UE.
Steps 4a/4c and step 7 may happen consecutively. Steps 7b map happen before
step 4b/4d.
8\. The N3IWF forwards the NAS message to the AMF.
9\. For non-roaming and roaming with LBO, all the steps after step 10 in
clause 4.3.3.2 are executed according to the general PDU Session Modification
procedure. For home-routed roaming, all steps after step 13 in clause 4.3.3.3
are executed according to the general PDU Session Modification procedure.
### 4.12.7 UE or network Requested PDU Session Release via Untrusted non-3GPP
access
Clause 4.12.7 specifies how a UE or network can release a PDU Session via an
untrusted non-3GPP access network. The UE requested PDU Session Release
procedure via Untrusted non-3GPP access applies in non-roaming, roaming with
LBO as well as in home-routed roaming scenarios.
For non-roaming and LBO scenarios, if the UE is simultaneously registered to a
3GPP access in a PLMN different from the PLMN of the N3IWF, the functional
entities in the following procedures are located in the PLMN of the N3IWF. For
home-routed roaming scenarios, the AMF, V-SMF and associated UPF in VPLMN in
the following procedure is located in the PLMN of the N3IWF.
NOTE: If the UE is simultaneously registered to 3GPP access in the same PLMN
as non-3GPP access, when non-3GPP access is not available to the UE (e.g. due
to out of non-3GPP coverage) or UE is in CM-IDLE for non-3GPP access, the UE
may perform the PDU Session Release procedure via 3GPP access as described in
clause 4.3.4.
Figure 4.12.7-1: UE Requested PDU Session Release via Untrusted non-3GPP
access
1\. One or more PDU Sessions are already established for the UE using the
procedure described in clause 4.12.2.
2\. The UE sends a NAS message (N1 SM container (PDU Session Release Request),
PDU Session ID) to the AMF via the N3IWF as defined in clause 4.3.4.
3\. For non-roaming and roaming with LBO, the steps 1a (from AMF) to 4
according to the PDU Session Release procedure defined in clause 4.3.4.2 are
executed. For home-routed roaming, the steps 1a (from AMF) to step 7 according
to the PDU Session Release procedure defined in clause 4.3.4.3 are executed.
4\. This step is the same as step 4 in clause 4.3.4.2 (non-roaming and LBO)
and step 6 in clause 4.3.4.3 (home-routed roaming).
If the message received from the SMF does not include N2 SM Resource Release
request, the AMF sends N2 Downlink NAS transport (N1 SM container (PDU Session
Release Command), PDU Session ID, Cause) message to the N3IWF and steps 5 to 8
are skipped.
5\. Upon receiving AN session release request message from the AMF, the N3IWF
triggers the release of the corresponding Child SA by sending INFORMATIONAL
EXCHANGE (Delete Payload) to the UE. Delete payload is included in the message
listing the SPIs of the Child SAs to be deleted to this PDU Session as
described in RFC 7296 [3].
6\. The UE responds with INFORMATIONAL EXCHANGE (Delete Payload) message.
Delete payload is included for the paired SAs going in the other direction as
described in RFC 7296 [3].
7\. This step is the same as step 6 in 4.3.4.2 (non-roaming and LBO) and step
8 in clause 4.3.4.3 (home-routed roaming).
8\. For non-roaming and roaming with LBO, steps 7 according to the PDU Session
Release procedure defined in clause 4.3.4.2 are executed. For home-routed
roaming, step 9-10 according to the PDU Session Release procedure defined in
clause 4.3.4.3 are executed.
9\. The N3IWF delivers the NAS message (N1 SM container (PDU Session Release
Command), PDU Session ID, Cause) to the UE.
10\. The UE sends a NAS message (N1 SM container (PDU Session Release Ack),
PDU Session ID) to the N3IWF.
11\. This step is the same as step 9 in 4.3.4.2 (non-roaming and LBO) and step
11 in clause 4.3.4.3 (home-routed roaming).
Steps 5 and 9 may happen consecutively. Step 10 may happen before step 6.
12\. For non-roaming and roaming with LBO, all steps after step 10 in the PDU
Session Release procedure defined in clause 4.3.4.2 are executed. In the case
of home-routed roaming, all steps after step 12 in the PDU Session Release
procedure defined in clause 4.3.4.3 are executed.
The network requested PDU Session Release procedure via Untrusted non-3GPP
access is the same as the network requested PDU Session Release Procedure
specified in clause 4.3.4.2 (for Non-Roaming and Roaming with Local Breakout)
with the following differences:
\- The (R)AN corresponds to an N3IWF.
\- In step 5 the N3IWF upon receiving N2 SM request to release the AN
resources associated with the PDU Session from the AMF, the N3IWF triggers the
release of the corresponding Child SA to the UE as specified in step 5 and 6,
in Figure 4.12.7-1.
\- User Location Information is not included in the step 6, 7a, 9, 10a and 12
of the procedure.
### 4.12.8 Mobility from a non-geographically selected AMF to a geographically
selected AMF
This procedure describes the AMF change that takes place when an UE initially
served via non-3GPP access by an AMF selected based on non-geographical
criteria (e.g. because the UE had no 3GPP coverage or because only non-
geographically selectable N3IWF are deployed) gets 3GPP access and is now to
be served by an AMF selected in the same PLMN by the NG-RAN based on
geographical criteria.
Figure 4.12.8-1: Mobility from a non-geographically selected AMF to a
geographically selected AMF
1\. The UE registers over non-3GPP access, as described in clause 4.12.2.
During this procedure:
a An AMF (source AMF) is selected by the N3IWF in step 6a, based on non-
geographical criteria (e.g. because the UE has no 3GPP coverage or because
only non-geographically selectable N3IWF are deployed).
b The UE receives, within the Registration Accept message, a 5G-GUTI
containing a GUAMI of the non-geographically selected AMF. The UE also
receives an Allowed NSSAI and optionally Mapping Of Allowed NSSAI.
2\. The UE may activate PDU Sessions over non-3GPP access, as described in
clause 4.12.5.
3\. The UE gets 3GPP access and issues a Registration Request over 3GPP access
as defined in step 1 of Figure 4.2.2.2.2-1, providing its 5G-GUTI.
If the 5G-GUTI does not indicate an AMF of the same Region ID as that of the
NG-RAN, the NG-RAN selects an AMF Set and an AMF in the AMF Set as described
in clause 6.3.5 of TS 23.501 [2].
Steps 3 to 22 of Figure 4.2.2.2.2-1 take place including following aspects:
\- step 4 of Figure 4.2.2.2.2-1 takes place i.e. the new AMF invokes the
Namf_Communication_UEContextTransfer service operation on the old AMF to
request the UE\'s SUPI and MM Context.
\- in step 5 of Figure 4.2.2.2.2-1, the old AMF includes information about
active NGAP association to N3IWF.
\- in step 18 of Figure 4.2.2.2.2-1, the new AMF modifies the NGAP association
toward N3IWF.
\- in step 21 of Figure 4.2.2.2.2-1, the Registration Accept message shall
include the updated 5G-GUTI that the UE will use to update its 3GPP and
non-3GPP registration contexts.
## 4.13 Specific services
### 4.13.1 General
Clause 4.13 defines the additional procedures or additions to the existing
procedures to support specific services such as SMS over NAS.
### 4.13.2 Application Triggering
#### 4.13.2.1 General
The AF invokes the Nnef_Trigger service to request that the network send an
Application trigger to the UE.
#### 4.13.2.2 The procedure of \"Application Triggering\" Service
Figure 4.13.2.2-1: Device triggering procedure via Nnef
1\. The AF determines the need to trigger the device. If the AF has no contact
details for the NEF, it shall discover and select NEF services.
2\. The AF invokes the Nnef_Trigger_Delivery request service.
3\. The NEF checks that the AF is authorised to send trigger requests and that
the AF has not exceeded its quota or rate of trigger submission over Nnef. If
this check fails, the NEF sends an Nnef_Trigger_Delivery response with a cause
value indicating the reason for the failure condition and the flow stops at
this step. Otherwise, the flow continues with step 4.
4\. The NEF invokes Nudm_SDM_Get (Identifier Translation, GPSI and AF
Identifier) to resolve the GPSI to SUPI when the AF is authorized to trigger
the UE.
NOTE 1: Optionally, mapping from GPSI (External Id) to GPSI (MSISDN) is also
provided for legacy SMS infrastructure not supporting MSISDN-less SMS.
5\. The UDM may invoke the Nudr_DM_Query service to retrieve a list of AF\'s
that are allowed to trigger the UE and determines, based on UDM policy, which
identifier (SUPI or MSISDN) should be used to trigger the UE. The UDM provides
a Nudm_SDM_Get response (SUPI, optionally MSISDN. If the AF is not allowed to
send a trigger message to this UE, or there is no valid subscription
information for this user, the NEF sends an Nnef_Trigger_Delivery response
with a cause value indicating the reason for the failure condition and the
flow stops at this step. Otherwise this flow continues with step 6.
NOTE 2: The presence of an MSISDN in the reply is interpreted as an indication
to the NEF that MSISDN is used (instead of IMSI) to identify the UE when
sending the SMS to the SMS-SC via T4.
6\. The NEF invokes Nudm_UECM_Get (SUPI, SMS) to retrieve the UE SMSF
identities.
7\. The UDM may invoke the Nudr_DM_Query service to retrieve the UE SMSF
identities. The UDM provides a Nudm_UECM_Get response with the corresponding
UE SMSF identities. UDM policy (possibly dependent on the VPLMN ID) may
influence which serving node identities are returned.
NOTE 3: The NEF can cache serving node information for the UE. However, this
can increase the probability of trigger delivery attempt failures when the
cached serving node information is stale.
8\. The NEF selects a suitable SMS-SC based on configured information. The NEF
acts as an MTC-IWF and sends a Submit Trigger (GPSI, SUPI, AF Identifier,
trigger reference number, validity period, priority, SMSF serving node ID(s)
(if available, are obtained from UDM in step 7), SMS Application port ID,
trigger payload, Trigger Indication) message to the SMS-SC.
If the NEF indicates that \"Absent subscriber\" was received from the UDM, the
SMS-SC should not submit the message, but store it directly and send Routing
Information for SM to request the UDM to add the SMS-SC address to the Message
Waiting List.
9\. The SMS-SC sends a Submit Trigger Confirm message to the NEF to confirm
that the submission of the SMS has been accepted by the SMS-SC.
10\. The NEF sends a Nnef_Trigger_Delivery response to the AF to indicate if
the Device Trigger Request has been accepted for delivery to the UE.
11\. The SMS_SC performs MT SMS delivery as defined in clause 4.13.3. The SMS-
SC may provide the routing information that it received in step 6 to SMS-GMSC
to avoid UDM interrogation. The SMS-SC generates the necessary CDR information
and includes the AF Identifier. The SMS Application port ID, which is included
in the SM User Data Header and the Trigger Indication are included in the CDRs
in order to enable differentiated charging. The SMS-SC stores the trigger
payload, without routing information. If the message delivery fails and is
attempted to be delivered again, UDM interrogation will be performed. If the
message delivery fails and the validity period of this trigger message is not
set to zero, the SMS-SC shall send a SM Message Delivery Status Report to
request the UDM to add the SMS-SC address to the Message Waiting list. When
the message delivery is later re-attempted, a new UDM interrogation will be
performed by the SMS-GMSC using SUPI or MSISDN. UDM interrogations using SUPI
shall not be forwarded or relayed to SMS-Router or IP-SM-GWs. The UDM may
include up to four serving node identities (MSC or MME, SGSN, IP-SM-GW, AMF)
in the response to SMS-GMSC.
12\. If the message delivery fails (either directly or when validity period of
the trigger message expires) or when the message delivery succeeds, the SMS-SC
shall send a Message Delivery Report (cause code, trigger reference number, AF
Identifier) to the NEF.
13\. The NEF provides a Nnef_Trigger_DeliveryNotify message to the AF with a
Delivery Report indicating the trigger delivery outcome (e.g. succeeded,
unknown or failed and the reason for the failure). The NEF generates the
necessary CDR information including the GPSI and AF Identifier.
14\. In response to the received device trigger, the UE takes specific actions
and may take into consideration the content of the trigger payload. This
action typically involves initiation of immediate or later communication with
the AF.
### 4.13.3 SMS over NAS procedures
#### 4.13.3.1 Registration procedures for SMS over NAS
Figure 4.13.3.1-1: Registration procedure supporting SMS over NAS
1\. During Registration procedure in 5GS defined in Figure 4.2.2.2.2-1, to
enable SMS over NAS transporting, the UE includes an \"SMS supported\"
indication in Registration Request in step 1-3 indicating the UE\'s capability
for SMS over NAS transport. The \"SMS supported\" indication indicates whether
the UE supports SMS delivery over NAS.
2\. Step 4 to step 14 of the Registration procedure in Figure 4.2.2.2.2-1 are
performed. The AMF may retrieve the SMS Subscription data and UE Context in
SMSF data using Nudm_SDM_Get. This requires that UDM may retrieve this
information from UDR by Nudr_DM_Query. The UDM includes the SMSF information
in the Nudm_SDM_Get response message if the stored SMSF belongs to the same
PLMN of the AMF. After a successful response is received and if SMS service is
allowed, the AMF subscribes to be notified using Nudm_SDM_Subscribe when the
SMS Subscription data is modified and UDM may subscribe to UDR by
Nudr_DM_Subscribe.
The AMF can also receive UE context information containing SMSF Information
from old AMF. When AMF re-allocation happens during the Registration
procedure, the old AMF transfers SMSF Information to the new AMF as part of UE
context in step 5 of Figure 4.2.2.2.2-1.
3\. If the \"SMS supported\" indication is included in the Registration
Request, the AMF checks in the SMS Subscription data that was received in step
2 whether the SMS service is allowed to the UE. If SMS service is allowed and
the UE context received in step 2 includes an available SMSF of the serving
PLMN, the AMF activates this SMSF Address and continues the registration
procedure. If SMS service is allowed but an SMSF of the serving PLMN was not
received in step 2, the AMF discovers and selects an SMSF to serve the UE as
described in clause 6.3.10 of TS 23.501 [2].
4\. Step 15 to step 20 of the Registration procedure in Figure 4.2.2.2.2-1 are
performed.
5\. The AMF invokes Nsmsf_SMService_Activate service operation from the SMSF.
The invocation includes AMF address, Access Type, Trace Requirements, GPSI (if
available) and SUPI. AMF uses the SMSF Information derived from step 3. Trace
Requirements is provided if it has been received by AMF as part of
subscription data.
6\. The SMSF discovers a UDM as described in clause 6.3.8 of TS 23.501 [2].
7a-7b. If the UE context for the current Access Type already exists in the
SMSF, the SMSF shall replace the old AMF address with the new AMF address.
Otherwise, the SMSF considers this a Registration request from a new Access
Type and the SMSF registers with the UDM using Nudm_UECM_Registration with
Access Type. As a result, the UDM stores the following information: SUPI, SMSF
identity, SMSF address, Access Type(s) in UE Context in SMSF data. The UDM may
further store SMSF Information in UDR by Nudr_DM_Update (SUPI, Subscription
Data, UE Context in SMSF data). SMSF retrieves SMS Management Subscription
data (e.g. SMS teleservice, SMS barring list) using Nudm_SDM_Get and this
requires that UDM may get this information from UDR by Nudr_DM_Query (SUPI,
Subscription Data, SMS Management Subscription data). After a successful
response is received, the SMSF subscribes to be notified using
Nudm_SDM_Subscribe when the SMS Management Subscription data is modified and
UDM may subscribe to notifications from UDR by Nudr_DM_Subscribe.
If the Nsmsf_SMService_Activate request contains two Access Types and one of
them is already registered in the SMSF, the SMSF shall replace the old AMF
address with the new AMF address for that Access Type. The SMSF shall then
register the other Access Type with the UDM using Nudm_UECM_Registration
request.
SMSF also creates a UE context to store the SMS subscription information and
the AMF address that is serving this UE.
8\. The SMSF responds back to the AMF with Nsmsf_SMService_Activate service
operation response message. The AMF stores the SMSF Information received as
part of the UE context.
9\. The AMF includes the \"SMS allowed\" indication to the UE in the
Registration Accept message of step 21 of Figure 4.2.2.2.2-1 only after step 8
in which the AMF has received a positive indication from the selected SMSF.
The \"SMS allowed\" indication in the Registration Accept message indicates to
the UE whether the network allows the SMS message delivery over NAS.
#### 4.13.3.2 Deregistration procedures for SMS over NAS
If the UE indicates to AMF that it no longer wants to send and receive SMS
over NAS over any Access Type (e.g. by not including \"SMS supported\"
indication in subsequent Registration Request message) or AMF considers that
UE is deregistered or AMF receives Deregistration Notification from UDM
indicating UE Initial Registration, Subscription Withdrawn or 5GS to EPS
Mobility as specified in clause 5.2.3.2.2. AMF invokes
Nsmsf_SMService_Deactivate (Access Type) service operation to trigger the
release of UE Context for SMS on SMSF for the impacted Access Type(s) based on
local configurations.
The AMF may, if the UE is not registered at other Access Type at the AMF any
more, unsubscribe from SMS Subscription data changes notification with the UDM
by means of the Nudm_SDM_Unsubscribe service operation. The AMF may delete or
deactivate the stored SMSF address in its UE Context.
The SMSF unsubscribes from SMS Management Subscription data changes
notification with the UDM by means of the Nudm_SDM_Unsubscribe service
operation. The UDM may remove the corresponding subscription of data change
notification in UDR by Nudr_DM_Unsubscribe service operation. The SMSF shall
invoke Nudm_UECM_Deregistration (SUPI, NF ID, Access Type) service operation
from UDM to trigger UDM to delete SMSF address of the UE. The UDM may update
UE context in SMSF in UDR by Nudr_DM_Update (SUPI, Subscription Data, SMS
Subscription data, SMSF address). The SMSF also removes the UE Context for
SMS, including AMF address.
#### 4.13.3.3 MO SMS over NAS in CM-IDLE (baseline)
Figure 4.13.3.3-1: MO SMS over NAS
1\. The UE performs domain selection for UE originating SMS as defined in
clause 5.16.3.8 of TS 23.501 [2] if SMS delivery via non 3GPP access is
allowed and possible. If an UE under CM-IDLE state is going to send uplink SMS
message, then UE and network perform the UE Triggered Service Request
procedure firstly as defined in clause 4.2.3.2 to establish a NAS signalling
connection to AMF.
2a. The UE builds the SMS message to be sent as defined in TS 23.040 [7] (i.e.
the SMS message consists of CP-DATA/RP-DATA/TPDU/SMS-SUBMIT parts). The SMS
message is encapsulated in an NAS message with an indication indicating that
the NAS message is for SMS transporting. The UE send the NAS message to the
AMF.
2b. The AMF forwards the SMS message and SUPI to the SMSF serving the UE over
N20 message by invoking Nsmsf_SMService_UplinkSMS service operation. In order
to permit the SMSF to create an accurate charging record, the AMF adds the
IMEISV, the current UE Location Information (ULI) of the UE as defined in
clause 5.6.2 of TS 23.501 [2] and, if the UE has sent the SMS via 3GPP access,
the local time zone.
2c. The SMSF invokes Namf_Communication_N1N2MessageTransfer service operation
to forward SMS ack message to AMF.
2d. The AMF forwards the SMS ack message from the SMSF to the UE using
downlink unit data message.
3-5. The SMSF checks the SMS management subscription data. If SMS delivery is
allowed, the procedure defined in TS 23.040 [7] applies.
6a-6b. The SMSF forwards the submit report to AMF by invoking
Namf_Communication_N1N2MessageTransfer service operation which is forwarded to
UE via Downlink NAS transport. If the SMSF knows the submit report is the last
message to be transferred for UE, the SMSF shall include a last message
indication in the Namf_Communication_N1N2MessageTransfer service operation so
that the AMF knows no more SMS data is to be forwarded to UE.
NOTE: The behaviour of AMF based on the \"last message indication\" is
implementation specific.
If the UE has more than one SMS message to send, the AMF and SMSF forwards SMS
/SMS ack/submit report the same way as described in step 2a-6b.
6c-6d. When no more SMS is to be sent, UE returns a CP-ack as defined in TS
23.040 [7] to SMSF. The AMF forwards the SMS ack message by invoking
Nsmsf_SMService_UplinkSMS service operation to SMSF.
#### 4.13.3.4 Void
#### 4.13.3.5 MO SMS over NAS in CM-CONNECTED
MO SMS in CM-CONNECTED State procedure is specified by reusing the MO SMS in
CM-IDLE State without the UE Triggered Service Request procedure.
#### 4.13.3.6 MT SMS over NAS in CM-IDLE state via 3GPP access
Figure 4.13.3.6-1: MT SMS over NAS in CM_IDLE state via 3GPP access
1-3 MT SMS interaction between SC/SMS-GMSC/UDM follow the current procedure as
defined in TS 23.040 [7]. If there are two AMFs serving the UE, one is for
3GPP access and another is for non-3GPP access, there are two SMSF addresses
stored in UDM/UDR. The UDM shall return both SMSF addresses.
4\. The SMSF checks the SMS management subscription data. If SMS delivery is
allowed, SMSF invokes Namf_MT_EnableUEReachability service operation to AMF.
AMF pages the UE using the procedure defined in clause 4.2.3.4. The UE
responds to the page with Service Request procedure.
If the AMF indicates SMSF that UE is not reachable, the procedure of the
unsuccessful Mobile terminating SMS delivery described in clause 4.13.3.9 is
performed and the following steps are skipped.
If the UE access to the AMF via both 3GPP access and non-3GPP access, the AMF
determines the Access Type to transfer the MT-SMS based on operator local
policy.
5a-5b. SMSF forward the SMS message to be sent as defined in TS 23.040 [7]
(i.e. the SMS message consists of CPâ€‘DATA/RPâ€‘DATA/TPDU/SMSâ€‘DELIVER parts) to
AMF by invoking Namf_Communication_N1N2MessageTransfer service operation. The
AMF transfers the SMS message to the UE.
5c-5d. The UE acknowledges receipt of the SMS message to the SMSF. For uplink
unit data message toward the SMSF, the AMF invokes Nsmsf_SMService_UplinkSMS
service operation to forward the message to SMSF. In order to permit the SMSF
to create an accurate charging record, the AMF also includes IMEISV, the
current UE Location Information (ULI) of the UE as defined in clause 5.6.2 of
TS 23.501 [2] and, if the SMS is delivered to the UE via 3GPP access, the
local time zone.
6a-6b. The UE returns a delivery report as defined in TS 23.040 [7]. The
delivery report is encapsulated in an NAS message and sent to the AMF which is
forwarded to SMSF by invoking Nsmsf_SMService_UplinkSMS service operation.
6c-6d. The SMSF acknowledges receipt of the delivery report to the UE. The
SMSF uses Namf_Communication_N1N2MessageTransfer service operation to send SMS
CP ack message to the AMF. The AMF encapsulates the SMS message via a NAS
message to the UE. If SMSF has more than one SMS to send, the SMSF and the AMF
forwards subsequent SMS /SMS ack/ delivery report the same way as described in
step 4-6c.
If the SMSF knows the SMS CP ack is the last message to be transferred for UE,
the SMSF shall include a last message indication in the
Namf_Communication_N1N2MessageTransfer service operation so that the AMF knows
no more SMS data is to be forwarded to UE.
NOTE: The behaviour of AMF based on the \"last message indication\" is
implementation specific.
7\. In parallel to steps 6c and 6d, the SMSF delivers the delivery report to
SC as defined in TS 23.040 [7].
#### 4.13.3.7 MT SMS over NAS in CM-CONNECTED state via 3GPP access
MT SMS in CM-CONNECTED procedure is specified by reusing the MT SMS in CM-IDLE
state with the following modification:
\- There is no need for the AMF to perform Paging of the UE and can immediate
continue with a message to SMSF via N20 to allow the SMSF to start forward the
MT SMS.
\- If the delivery of the NAS PDU containing the SMS fails e.g. if the UE is
in RRC Inactive and NG-RAN paging was not successful, the NG-RAN initiate the
UE context release in the AN procedure and provide notification of non-
delivery to the AMF. The AMF provides an indication of non-delivery to the
SMSF.
#### 4.13.3.8 MT SMS over NAS via non-3GPP access
MT SMS procedure via non-3GPP access is specified by reusing the MT SMS via
3GPP access in CM-CONNECTED state with the following modification:
\- If the UE access to the network via both 3GPP and non-3GPP accesses and the
AMF determines to deliver MT-SMS via non-3GPP access based on operator policy
in step 4, the NAS messages is transferred via non-3GPP access network.
#### 4.13.3.9 Unsuccessful Mobile terminating SMS delivery attempt
The procedure of Unsuccessful Mobile terminating SMS delivery is defined as
follows:
\- If the UE is registered over both 3GPP access and non-3GPP access in the
same AMF (i.e. the UE is registered in the same PLMN for both access types):
\- if the MT-SMS delivery over one Access Type has failed, the AMF, based on
operator local policy, may re-attempt the MT-SMS delivery over the other
Access Type before indicating failure to SMSF;
\- if the MT-SMS delivery on both Access Types has failed, the AMF shall
inform the SMSF immediately.
\- If the AMF informs the SMSF that it cannot deliver the MT-SMS to the UE,
the SMSF sends a failure report to the first SMS-GMSC (which can be co-located
with IP-SM-GW or SMS Router) as defined in TS 23.040 [7]. If the SMS-GMSC has
more than one entity for SMS transport towards the UE, then upon receiving MT-
SMS failure report, the SMS-GMSC, based on operator local policy, may re-
attempt the MT-SMS delivery via the other entity.
\- After the first SMS-GMSC informs the UDM/HSS that the UE is not able to
receive MT-SMS, the UDM shall set the URRP-AMF flag and store the SC address
in the MWD list as defined in TS 23.040 [7].
\- If the UE is registered in an AMF and the UDM has not subscribed to UE
Reachability Notification in the AMF yet, the UDM immediately initiates a
subscription procedure as specified in clause 4.2.5.2.
\- When the AMF detects UE activities, it notifies UDM with UE Activity
Notification as described in clause 4.2.5.3. If the UE is registered in an
SMSF, the UDM clears its URRP-AMF flag and the UDM/HSS clears the MWD list and
alerts related SMSCs to retry MT-SMS delivery. Otherwise, if the UE is not
registered in an SMSF, the UDM clears its URRP-AMF flag but the UDM/HSS keeps
the MWD list to notify the SC upon subsequent SMSF registration for the UE.
\- When the SMS-GMSC requests routing information from UDM/HSS for a UE not
registered in 5GC, or for a registered UE which has not been yet registered
for SMS service, the UDM/HSS responds to the SMS-GMSC that the UE is absent,
stores the SC address in the MWD list (if not yet stored) and indicates that
to the SC as defined in TS 23.040 [7].
When the UDM receives an Nudm_UECM_Registration Request from an SMSF for a UE
for which the MWD list is stored and no URRP-AMF flag is set, the UDM/HSS
alerts the related SCs to retry the MT-SMS delivery and clears the MWD list.
NOTE: This scenario assumes that the UE is not in 2G/3G/4G coverage.
### 4.13.4 Emergency Services
#### 4.13.4.1 General
If the 5GS supports Emergency Services, the support is indicated to UE via the
Registration Accept message on per-TA-list and per-RAT basis, as described in
TS 23.501 [2].
If the 5GS supports Emergency Services Fallback, the support is indicated to
UE via the Registration Accept message on per-TA-list and per-RAT basis, as
described in TS 23.501 [2].
The UE shall follow the domain selection rules for emergency session attempts
as described in TS 23.167 [28].
If the 5GC has indicated Emergency Services Fallback support for the TA and
RAT where the UE is currently camping and if the UE supports emergency
services fallback, the UE shall initiate the Emergency Services Fallback
procedure described in clause 4.13.4.2.
At QoS Flow establishment request for Emergency Services, the procedure
described in clause 4.13.6.2 Inter RAT Fallback in 5GC for IMS voice or the
procedure described in clause 4.13.6.1 EPS fallback for IMS voice may be
triggered by the network, when configured.
#### 4.13.4.2 Emergency Services Fallback
The call flow in Figure 4.13.4.2-1 describes the procedure for emergency
services fallback.
Figure 4.13.4.2-1: Emergency Services Fallback
1\. UE camps on E-UTRA or NR cell in the 5GS (in either CM_IDLE or
CM_CONNECTED state).
2\. UE has a pending IMS emergency session request (e.g. voice) from the upper
layers.
3\. If the AMF has indicated support for emergency services using fallback via
the Registration Accept message for the current RAT, the UE sends a Service
Request message indicating that it requires emergency services fallback.
4\. 5GC triggers a request for Emergency Services Fallback by executing an NG-
AP procedure in which it indicates to NG-RAN that this is a fallback for
emergency services. The AMF based on the support of Emergency Services in EPC
or 5GC may indicate the target CN for the RAN node to know whether inter-RAT
fallback or inter-system fallback is to be performed. When AMF initiates
Redirection for UE(s) that have been successfully authenticated, AMF includes
the security context in the request to trigger fallback towards NG-RAN.
5\. Based on the target CN indicated in message 4, one of the following
procedures is executed by NG-RAN:
5a. NG-RAN initiates handover (see clause 4.9.1.3) or redirection to a 5GC-
connected E-UTRAN cell, if UE is currently camped on NR.
5b. NG-RAN initiates handover (see clause 4.11.1.2.1) or redirection to
E-UTRAN connected to EPS. NG-RAN uses the security context provided by the AMF
to secure the redirection procedure.
If the redirection procedure is used either in 5a or 5b the target CN is also
conveyed to the UE in order to be able to perform the appropriate NAS
procedures (S1 or N1 Mode). The UE uses the emergency indication in the RRC
message as specified in clause 6.2.2 of TS 36.331 [16] and E-UTRAN provides
the emergency indication to AMF in step 5a and MME in step 5b during Tracking
Area Update. The Tracking Area Update should contain an indication that the UE
has \"user data pending\". For the handover procedure used in step 5b see
clause 4.11.1.2.1, step 1.
In step 5b, if the MME does not support emergency services for that UE, the
MME should act such the emergency call is likely to succeed promptly, e.g. if
the UE successfully completed a combined TA/LA Update with the network, by
using the CSFB procedures specified in TS 23.272 [50].
NOTE: If such a combined TA/LA Update is not successful, or the UE did not
request a combined update, then, as specified in TS 23.167 [28], the UE
autonomously selects a RAT that may (but which might not) support the CS
domain.
6\. After handover to the target cell the UE establishes a PDU Session / PDN
connection for IMS emergency services and performs the IMS procedures for
establishment of an IMS emergency session (e.g. voice) as defined in TS 23.167
[28].
At least for the duration of the emergency voice call, the E-UTRAN connected
to EPC is configured to not trigger any handover to 5GS and the target NG-RAN
is configured to not trigger inter NG-RAN handover back to source NG-RAN.
### 4.13.5 Location Services procedures
#### 4.13.5.1 5GC-NI-LR Procedure
Figure 4.13.5.1-1 shows a Network Induced Location Request (NI-LR) procedure
for a UE in the case where the UE initiates an emergency session using NG-RAN.
The procedure assumes that the serving AMF is aware of the emergency session
initiation -- e.g. due to supporting an Emergency Registration procedure or
assisting in establishing an emergency PDU Session.
Figure 4.13.5.1-1: 5GC Network Induced Location Request (5GC-NI-LR) for a UE
1\. The UE registers to the 5GC for emergency services or requests the
establishment of an emergency PDU Session.
2\. The AMF may select an LMF based on NRF query or configuration in AMF and
invoke the Nlmf_Location_DetermineLocation service operation towards the LMF
to request the current location of the UE. The service operation includes a
LCS Correlation identifier, the serving cell identity and an indication of a
location request from an emergency services client and may include an
indication if UE supports LPP or not, the required QoS and Supported GAD
shapes. If any of the procedures in clause 4.13.5.4 or 4.13.5.5 are used the
service operation includes the AMF identity.
3\. If step 2 occurs, the LMF performs one or more of the positioning
procedures described in clause 4.13.5.4, 4.13.5.5 and 4.13.5.6.
4\. If step 3 occurs, the LMF returns the Nlmf_Location_DetermineLocation
Response towards the AMF to return the current location of the UE. The service
operation includes the LCS Correlation identifier, the location estimate, its
age and accuracy and may include information about the positioning method.
5\. The AMF selects an GMLC based on NRF query or configuration in AMF. The
information regarding the endpoint in the GMLC to deliver the event
notification, is obtained from the NRF as specified in clause 7.1.2 of TS
23.501 [2] or from local configuration in the AMF. AMF invokes the
Namf_Location_EventNotify service operation towards the selected GMLC to
notify the GMLC of an emergency session initiation. The service operation
includes the SUPI or the PEI and the GPSI if available, the identity of the
AMF, an indication of an emergency session and any location obtained in step
3.
6\. The GMLC forwards the location to an external emergency services client or
may wait for a request for the location from the external emergency services
client (not shown in Figure 4.13.5.1-1) before forwarding the location.
7\. The emergency services session and emergency PDU Session are released.
8\. The AMF invokes the Namf_Location_EventNotify service operation towards
the GMLC to notify the GMLC that the emergency session was released to enable
the GMLC and LRF to release any resources associated with the emergency
session.
#### 4.13.5.2 5GC-MT-LR Procedure without UDM Query
Figure 4.13.5.2-1 illustrates a location request for an emergency services
session, where an emergency services client (e.g. a Public Safety Answering
Point) identifies the target UE and the serving LRF using correlation
information that was previously provided to it by the IMS Core. The signalling
used to provide the correlation information to the PSAP is defined in TS
23.167 [28]. The correlation information may be used by the LRF to retrieve
other information previously provided to it by the IMS Core and/or AMF as
described for Figure 4.13.5.1-1. This allows the GMLC associated with the LRF
to request a location from the AMF without needing to query the UDM of the
target UE for the serving AMF address. This scenario therefore supports
location of emergency sessions from roamers and USIM-less and other non-
registered UEs and requires that identifying information for the UE and AMF
have been provided to the GMLC/LRF as described in clause 4.13.5.1 and
4.13.5.7.
Figure 4.13.5.2-1: 5GC-MT-LR Procedure without UDM Query
1\. The external emergency services client (e.g. a PSAP) sends a request to
the LRF for a location for the target UE and includes correlation information
identifying the target UE. The request may include the required QoS, Supported
GAD shapes and client type. The LRF address and the correlation information
would have been previously provided to the external client when the emergency
session from the UE was established.
2\. The LRF/GMLC determines the AMF by associating the correlation information
received from the external client with other information received previously
from the LMF as described in clause 4.13.5.1 and 4.13.5.7. The GMLC invokes
the Namf_Location_ProvidePositioningInfo service operation towards the AMF to
request the current location of the UE. The service operation includes the
SUPI or the PEI and an indication of a location request from an emergency
services client and may include the required QoS and Supported GAD shapes. The
AMF identifies the target UE using the SUPI or in the case of a USIM-less
emergency session, or non-registered USIM emergency session, the PEI.
3\. The AMF selects an LMF based on NRF query or configuration in AMF and
invokes the Nlmf_Location_DetermineLocation service operation towards the LMF
to request the current location of the UE. The service operation includes a
LCS Correlation identifier, the serving cell identity and an indication of a
location request from an emergency services client and may include an
indication if UE supports LPP or not, the required QoS and Supported GAD
shapes. If any of the procedures in clause 4.13.5.4 or 4.13.5.5 are used the
service operation includes the AMF identity.
4\. The LMF performs one or more of the positioning procedures described in
clause 4.13.5.4, 4.13.5.5 and 4.13.5.6.
5\. The LMF returns the Nlmf_Location_DetermineLocation Response towards the
AMF to return the current location of the UE. The service operation includes
the location estimate, its age and accuracy and may include information about
the positioning method.
6\. The AMF returns the Namf_Location_ProvidePositioningInfo Response towards
the GMLC/LRF to return the current location of the UE. The service operation
includes the LCS Correlation identifier, the location estimate, its age and
accuracy and may include information about the positioning method.
7\. The LRF sends the location service response to the external emergency
services client.
#### 4.13.5.3 5GC-MT-LR Procedure
Figure 4.13.5.3-1 illustrates the general network positioning for LCS clients
external to the PLMN. In this scenario, it is assumed that the target UE is
identified using an SUPI or GPSI. This procedure is applicable to a request
from an LCS client for a current location.
Figure 4.13.5.3-1: 5GC-MT-LR Procedure
1\. The external location services client sends a request to the GMLC for a
location for the target UE identified by an GPSI or an SUPI. The request may
include the required QoS, Supported GAD shapes and client type.
2\. The GMLC invokes a Nudm_UECM_Get service operation towards the home UDM of
the target UE to be located with the GPSI or SUPI of this UE
3\. The UDM returns the network addresses of the current serving AMF.
4\. If the UE was identified by GPSI in step 1, the GMLC invokes Nudm_SDM_Get
service operation to resolve the GPSI to SUPI.
5\. The UDM provides a Nudm_SDM_Get response with the SUPI of the UE.
6\. The GMLC invokes the Namf_Location_ProvidePositioningInfo service
operation towards the AMF to request the current location of the UE. The
service operation includes the SUPI and client type and may include the
required QoS and Supported GAD shapes.
7\. If the UE is in CMâ€‘IDLE state, the AMF initiates a network triggered
Service Request procedure as defined in clause 4.2.3.4 to establish a
signalling connection with the UE.
8\. The AMF selects an LMF based on NRF query or configuration in AMF and
invokes the Nlmf_Location_DetermineLocation service operation towards the LMF
to request the current location of the UE. The service operation includes a
LCS Correlation identifier, the serving cell identity and the client type and
may include an indication if UE supports LPP or not, the required QoS and
Supported GAD shapes. If any of the procedures in clause 4.13.5.4 or 4.13.5.5
are used the service operation includes the AMF identity.
9\. The LMF performs one or more of the positioning procedures described in
clause 4.13.5.4, 4.13.5.5 and 4.13.5.6.
10\. The LMF returns the Nlmf_Location_DetermineLocation Response towards the
AMF to return the current location of the UE. The service operation includes
the LCS Correlation identifier, the location estimate, its age and accuracy
and may include information about the positioning method.
11\. The AMF returns the Namf_Location_ProvidePositioningInfo Response towards
the GMLC/LRF to return the current location of the UE. The service operation
includes the location estimate, its age and accuracy and may include
information about the positioning method.
12\. The GMLC sends the location service response to the external location
services client.
#### 4.13.5.4 UE Assisted and UE Based Positioning Procedure
Figure 4.13.5.4-1 shows a positioning procedure used by an LMF to support UE
based positioning, UE assisted positioning and delivery of assistance data.
The procedure is based on use of the LPP protocol defined in TS 36.355 [30]
between the LMF and UE.
Figure 4.13.5.4-1: UE Assisted and UE Based Positioning Procedure
**Precondition:** A LCS Correlation identifier and the AMF identity has been
passed to the LMF by the serving AMF.
1\. The LMF invokes the Namf_Communication_N1N2MessageTransfer service
operation towards the AMF to request the transfer of a Downlink (DL)
Positioning message to the UE. The service operation includes the DL
Positioning message. The Session ID parameter of the
Namf_Communication_N1N2MessageTransfer service operation is set to the LCS
Correlation identifier. The Downlink Positioning message may request location
information from the UE, provide assistance data to the UE or query for the UE
capabilities.
2\. If the UE is in CMâ€‘IDLE state, the AMF initiates a network triggered
Service Request procedure as defined in clause 4.2.3.4 to establish a
signalling connection with the UE.
3\. The AMF forwards the Downlink Positioning message to the UE in a DL NAS
TRANSPORT message. The AMF includes a Routing identifier, in the DL NAS
TRANSPORT message, identifying the LMF.
4\. The UE stores any assistance data provided in the Downlink Positioning
message and performs any positioning measurements and location computation
requested by the Downlink Positioning message.
5\. If the UE has entered CM-IDLE state during step 4, the UE instigates the
UE triggered Service Request as defined in clause 4.2.3.2 in order to
establish a signalling connection with the AMF.
6\. The UE returns any location information obtained in step 4 or returns any
capabilities requested in step 3 to the AMF in an Uplink Positioning message
included in a NAS TRANSPORT message. The UE shall also include the Routing
identifier in the UL NAS TRANSPORT message received in step 3.
7\. The AMF invokes the Namf_Communication_N1MessageNotify service operation
towards the LMF indicated by the routing identifier received in step 6. The
service operation includes the Uplink Positioning message received in step 6
and the LCS Correlation identifier. Steps 6 and 7 may be repeated if the UE
needs to send multiple messages to respond to the request received in Step 3.
Steps 1 to 7 may be repeated to send new assistance data and to request
further location information and further UE capabilities.
#### 4.13.5.5 Network Assisted Positioning Procedure
Figure 4.13.5.5-1 shows a procedure that may be used by an LMF to support
network assisted and network based positioning. The procedure may be based on
an NRPPa protocol in TS 38.455 [31] between the LMF and NG-RAN.
Figure 4.13.5.5-1: Network Assisted Positioning Procedure
**Precondition:** A LCS Correlation identifier and the AMF identity have been
passed to the LMF by the serving AMF.
1\. The LMF invokes the Namf_Communication_N1N2MessageTransfer service
operation towards the AMF to request the transfer of a Network Positioning
message to the serving NG-RAN node (gNB or ng-eNB) for the UE. The service
operation includes the Network Positioning message and the LCS Correlation
identifier. The Network Positioning message may request location information
for the UE from the NG-RAN.
2\. If the UE is in CMâ€‘IDLE state, the AMF initiates a network triggered
Service Request procedure as defined in clause 4.2.3.4, to establish a
signalling connection with the UE.
3\. The AMF forwards the Network Positioning message to the serving NG-RAN
node in an N2 Transport message. The AMF includes a Routing identifier, in the
N2 Transport message, identifying the LMF (e.g. a global address of the LMF).
4\. The serving NG-RAN node obtains any location information for the UE
requested in step 3.
5\. The serving NG-RAN node returns any location information obtained in step
4 to the AMF in a Network Positioning message included in an N2 Transport
message. The serving NG-RAN node shall also include the Routing identifier in
the N2 Transport message received in step 3.
6\. The AMF invokes the Namf_Communication_N2InfoNotify service towards the
LMF indicated by the routing identifier received in step 5. The service
operation includes the Network Positioning message received in step 5 and the
LCS Correlation identifier. Steps 1 to 6 may be repeated to request further
location information and further NG-RAN capabilities.
#### 4.13.5.6 Obtaining Non-UE Associated Network Assistance Data
Figure 4.13.5.6-1 shows a procedure which may be used by an LMF to support
network assisted and network based positioning. This procedure is not
associated with a UE location session. It is used to obtain network assistance
data from a NG-RAN node (e.g. gNB or ng-eNB). The procedure may be based on an
NRPPa protocol in TS 38.455 [31] between the LMF and NG-RAN.
Figure 4.13.5.6-1: Procedure for Obtaining Non-UE Associated Network
Assistance Data
1\. The LMF invokes the Namf_Communication_N1N2MessageTransfer service
operation towards the AMF to request the transfer of a Network Positioning
message to a NG-RAN node (gNB or ng-eNB) in the NG-RAN. The service operation
includes the Network Positioning message and the target NG-RAN node identity.
The Network Positioning message may request position related information from
the NG-RAN.
2\. The AMF forwards the Network Positioning message to the target NG-RAN node
indicated in step 1 in an N2 Transport message. The AMF includes a Routing
identifier, in the N2 Transport message, identifying the LMF.
3\. The target NG-RAN node obtains any position related information requested
in step 2.
4\. The target NG-RAN node returns any position related information obtained
in step 3 to the AMF in a Network Positioning message included in an N2
Transport message. The target NG-RAN node shall also include the Routing
identifier in the N2 Transport message received in step 2.
5\. The AMF invokes the Namf_Communication_N2InfoNotify service operation
towards the LMF indicated by the routing identifier received in step 4. The
service operation includes the Network Positioning message received in step 4
and the UE identifier. Steps 1 to 5 may be repeated to request further
position related information from the NG-RAN.
#### 4.13.5.7 Location continuity for Handover of an Emergency session from
NG-RAN
Figure 4.13.5.7-1 shows support for location continuity for handover of an
emergency session from NG-RAN on the source side to either NG-RAN or another
3GPP RAN on the target side. The procedure applies when control plane location
according to Figures 4.13.5.1-1 and 4.13.5.2-1 is used for location of the UE
on the source side. The procedure is based on the procedures for location
continuity currently defined in clause 9.4.5.4 of TS 23.271 [29].
NOTE: If User Plane (SUPL) Location Protocol [27] is used on the source (NG-
RAN) side, then the current procedure for location continuity in TS 23.271
[29] can be used.
Figure 4.13.5.7-1: Location Continuity for Handover of an Emergency session
from NG-RAN
1\. Following the request for an emergency session, the UE establishes a PDU
Session for emergency services and an IMS emergency session for NG-RAN access,
during which an LRF is assigned in the serving network IMS and a source GMLC
may be chosen. The 5GC-NI-LR procedure of Figure 4.13.5.1-1 is also performed
which provides the source AMF identity to the GMLC and LRF and optionally an
initial location for the UE.
2\. At some later time, the LRF may need the UE location and requests the
source GMLC to invoke the Namf_Location_ProvidePositioningInfo service
operation towards the AMF to request the current location of the UE. The
service operation includes the SUPI or the PEI, the required QoS and an
indication of a location request from an emergency services client.
3\. If step 2 occurs or if support for an NI-LR is required, the source AMF
starts a location session to obtain the location of the UE as described in
clause 4.13.5.2 or clause 4.13.5.1.
4\. The source AMF receives a request to handover the UE to a cell associated
with a different target node which may be another AMF for intra-RAN handover
or a different type of node (e.g. an MME) for inter-RAN handover (e.g. to
E-UTRAN connected to EPC).
5\. The handover procedure is executed as specified in clause 4.9.1.3 for
intra-RAN handover, or as specified in clauses 4.11.1.2.1 and 4.11.2.2 for
inter-RAN handover.
6\. Any location session started in step 3 may terminate normally before step
6. If not, the source AMF shall abort the location session once step 5 is
complete.
7a. If steps 2 and 3 has occurred, the source AMF returns the
Namf_Location_ProvidePositioningInfo Response towards the GMLC to return any
location estimate obtained for the UE. The service operation includes the
target node identity.
7b. If steps 2 and 7a do not occur, the source AMF may invoke the
Namf_Location_EventNotify service operation towards the source GMLC (i.e. the
GMLC used in step 1) to indicate the handover. The service operation includes
the SUPI or the PEI and the GPSI if available, an event type indicating
handover and the identity of the target node.
8a. For inter-RAN handover (e.g. to E-UTRAN connected to EPC) and if control
plane location will be used on the target side, the target node (e.g. MME) may
send a Subscriber Location Report to a GMLC on the target side after
completion of the handover in step 6. The Subscriber Location Report carries
the UE identity (IMSI, MSISDN and/or IMEI), an event type indicating handover
and the identity of the target node. The target node may determine the target
GMLC from configuration information.
8b. For intra-RAN handover and if control plane location will be used on the
target side, the target AMF may invoke the Namf_Location_EventNotify service
operation towards the GMLC to indicate the handover. The service operation
includes the SUPI or the PEI and the GPSI if available, an event type
indicating handover and the identity of the target node.
9\. Reconfiguration of the LRF and the source and target GMLCs may occur in a
manner outside the scope of 3GPP.
10\. If the LRF needs a location estimate for the UE after handover has
occurred and if control plane location is used on the target side, the LRF may
instigate an MT-LR request via the target Node.
### 4.13.6 Support of IMS Voice
#### 4.13.6.1 EPS fallback for IMS voice
Figure 4.13.6.1-1 describes the EPS fallback procedure for IMS voice.
When the UE is served by the 5G System, the UE has one or more ongoing PDU
Sessions each including one or more QoS Flows. The serving PLMN AMF has sent
an indication towards the UE during the Registration procedure that IMS voice
over PS session is supported, see clause 5.16.3.10 in TS 23.501 [2] and the UE
has registered in the IMS. If N26 is not supported, the serving PLMN AMF sends
an indication towards the UE during the Registration procedure that
interworking without N26 is supported, see clause 5.17.2.3.1 in TS 23.501 [2].
Figure 4.13.6.1-1: EPS Fallback for IMS voice
1\. UE camps on NG-RAN in the 5GS and an MO or MT IMS voice session
establishment has been initiated.
2\. Network initiated PDU Session modification to setup QoS flow for voice
reaches the NG-RAN (see N2 PDU Session Request in clause 4.3.3).
3\. NG-RAN is configured to support EPS fallback for IMS voice and decides to
trigger fallback to EPS, taking into account UE capabilities, indication from
AMF that \"Redirection for EPS fallback for voice is possible\" (received as
part of initial context setup as defined in TS 38.413 [10]), network
configuration (e.g. N26 availability configuration) and radio conditions. If
NG-RAN decides not to trigger fallback to EPS, then the procedure stops here
and following steps are not executed.
NG-RAN may initiate measurement report solicitation from the UE including
E-UTRAN as target.
NOTE 1: If AMF has indicated that \"Redirection for EPS fallback for voice is
not possible\", then AN Release via inter-system redirection to EPS is not
performed in step 5.
4\. NG-RAN responds indicating rejection of the PDU Session modification to
setup QoS flow for IMS voice received in step 2 by PDU Session Response
message towards the PGW-C+SMF (or H-SMF+P-GW-C via V-SMF, in the case of
roaming scenario) via AMF with an indication that mobility due to fallback for
IMS voice is ongoing. The PGW-C+SMF maintains the PCC rule(s) associated with
the QoS Flow(s).
5\. NG-RAN initiates either handover (see clause 4.11.1.2.1), or AN Release
via inter-system redirection to EPS (see clause 4.2.6 and clause 4.11.1.3.2),
taking into account UE capabilities. The PGW-C+SMF reports change of the RAT
type if subscribed by PCF as specified in clause 4.11.1.2.1, or clause
4.11.1.3.2.6. When the UE is connected to EPS, either 6a or 6b is executed
6a. In the case of 5GS to EPS handover, see clause 4.11.1.2.1 and in the case
of inter-system redirection to EPS with N26 interface, see clause 4.11.1.3.2.
In either case the UE initiates TAU procedure; or
6b. In the case of inter-system redirection to EPS without N26 interface, see
clause 4.11.2.2. If the UE supports Request Type flag \"handover\" for PDN
connectivity request during the attach procedure as described in clause
5.3.2.1 of TS 23.401 [13] and has received the indication that interworking
without N26 is supported, then the UE initiates Attach with PDN connectivity
request with request type \"handover\".
In inter-system redirection, the UE uses the emergency indication in the RRC
message as specified in clause 6.2.2 of TS 36.331 [16] and E-UTRAN provides
the emergency indication to MME during Tracking Area Update or Attach
procedure. For the handover procedure see clause 4.11.1.2.1, step 1.
7\. After completion of the mobility procedure to EPS or as part of the 5GS to
EPS handover procedure (see clause 4.11.1.2.1), the SMF/PGW re-initiates the
setup of the dedicated bearer for IMS voice, mapping the 5G QoS to EPC QoS
parameters. The PGW-C+SMF behaves as specified in clause 4.9.1.3.1. The
PGW-C+SMF reports about Successful Resource Allocation and Access Network
Information if subscribed by PCF.
8\. The IMS voice session establishment is continued.
At least for the duration of the voice call in EPS the E-UTRAN is configured
to not trigger any handover to 5GS.
#### 4.13.6.2 Inter RAT Fallback in 5GC for IMS voice
Figure 4.13.6.2-1 describes the RAT fallback procedure in 5GC for IMS voice.
When the UE is served by the 5GC, the UE has one or more ongoing PDU Sessions
each including one or more QoS Flows. The serving PLMN AMF has sent an
indication towards the UE during the Registration procedure that IMS voice
over PS session is supported, see clause 5.16.3.10 in TS 23.501 [2] and the UE
has registered in the IMS.
Figure 4.13.6.2-1: RAT Fallback for IMS voice
1\. UE camps on source NG-RAN in the 5GS and an MO or MT IMS voice session
establishment has been initiated.
2\. Network initiated PDU Session modification to setup QoS flow for IMS voice
reaches the source NG-RAN (see N2 PDU Session Request in clause 4.3.3).
3\. If source NG-RAN is configured to support RAT fallback for IMS voice,
source NG-RAN decides to trigger RAT fallback, taking into account on UE
capabilities, network configuration and radio conditions.
Source NG-RAN may initiate measurement report solicitation from the UE
including target NG-RAN.
4\. Source NG-RAN responds indicating rejection of the PDU Session
modification to setup QoS flow for IMS voice received in step 2 by PDU Session
Response message towards the SMF (or V-SMF, in the case of roaming scenario)
via AMF with an indication that mobility due to fallback for IMS voice is
ongoing. The SMF maintains the PCC rule(s) associated with the QoS Flow(s).
5\. Source NG-RAN initiates Xn based Inter NG-RAN handover (see clause
4.9.1.2) or N2 based inter NG-RAN handover (see clause 4.9.1.3), or
redirection to E-UTRA connected to 5GC (see clause 4.2.6). The SMF reports
change of the RAT type if subscribed by PCF.
In intra-system redirection, the UE uses the emergency indication in the RRC
message as specified in clause 6.2.2 of TS 38.331 [12] and E-UTRAN provides
the emergency indication to AMF during 5G Registration procedure.
6\. After completion of the Inter NG-RAN (inter-RAT) handover or redirection
to E-UTRA connected to 5GC, the SMF re-initiates the PDU Session modification
to setup QoS flow for IMS voice. The SMF reports about Successful Resource
Allocation and Access Network Information if subscribed by PCF.
7\. The IMS voice session establishment is continued.
At least for the duration of the IMS voice call the target NG-RAN is
configured to not trigger inter NG-RAN handover back to source NG-RAN.
## 4.14 Support for Dual Connectivity
### 4.14.1 RAN Initiated QoS Flow Mobility
This procedure is used to transfer QoS Flows to and from Secondary RAN Node.
During this procedure, the SMF and UPF are never re-allocated. The UPF
referred in this clause 4.14.1 is the UPF which terminates N3 interface in the
5GC. The presence of IP connectivity between the UPF and the Master RAN node,
as well as between the UPF and the Secondary RAN node is assumed.
If QoS Flows for multiple PDU Sessions need to be transferred to or from
Secondary RAN Node, the procedure shown in the Figure 4.14.1-1 below is
repeated for each PDU Session.
Figure 4.14.1-1: NG-RAN initiated QoS Flow mobility procedure
1\. The Master RAN node sends a N2 QoS Flow mobility Indication (PDU Session
ID, QFI(s), AN Tunnel Info) message to the AMF. AN Tunnel Info includes the
new RAN tunnel endpoint for the QFI(s) for which the AN Tunnel Info shall be
modified.
2\. AMF to SMF: Nsmf_PDUSession_UpdateSMContext reques (N2 QoS Flow mobility
Indication message PDU Session ID).
3\. The SMF sends an N4 Session Modification Request (PDU Session ID(s),
QFI(s), AN Tunnel Info for downlink user plane) message to the UPF.
4\. The UPF returns an N4 Session Modification Response (CN Tunnel Info for
uplink traffic) message to the SMF after requested QFIs are switched.
NOTE: Step 7 can occur any time after receipt of N4 Session Modification
Response at the SMF.
5\. SMF to AMF: Nsmf_PDUSession_UpdateSMContext response (N2 SM information
(CN Tunnel Info for uplink traffic)) for QFIs of the PDU Session which have
been switched successfully. If none of the requested QFIs have been switched
successfully, the SMF shall send an N2 QoS Flow mobility Failure message.
6\. In order to assist the reordering function in the Master RAN node and/or
Secondary RAN node, for each affected N3 tunnel the UPF sends one or more
\"end marker\" packets on the old tunnel immediately after switching the
tunnel for the QFI. The UPF starts sending downlink packets to the Target NG-
RAN.
7\. The AMF relays message 5 to the Master RAN node.
## 4.15 Network Exposure
### 4.15.1 General
The network capability exposure comprises
\- Exposure of network events externally as well as internally towards core
network NFs;
\- Exposure of provisioning capability towards external functions;
\- Exposure of policy and charging capabilities towards external functions;
\- Exposure of core network internal capabilities for analytics.
When subscribing to event reporting the NF consumer(s) provide:
\- One or multiple Event ID(s). An Event ID identifies the type of event being
subscribed to (e.g. PDU Session release, UE mobility out of an Area of
Interest, etc.).
\- Event Filter Information: Provides Event Parameter Types and Event
Parameter Value(s) to be matched against, in order to meet the condition for
notifying the subscribed Event ID e.g. the Event Parameter Type could be
\"Area of interest\" and Event Parameter Value list could be list of TAs; The
Event Filter depends on the Event ID. The Event Filter Information is provided
per Event ID(s) being subscribed to: within a subscription different Event
ID(s) may be associated with different Event Filter Information.
\- Event Reporting Information described in the Table 4.15.1-1 below. Within a
subscription all Event ID(s) are associated with a unique Event Reporting
Information.
\- The target of event reporting: this may indicate a specific UE or PDU
Session, a group of UE(s) or any UE (i.e. all UEs), Within a subscription all
Event ID (s) are associated with the same target of event reporting (possibly
corresponding to multiple UE or multiple PDU Sessions).
\- A Notification Target Address (+ Notification Correlation ID) allowing the
Event Receiving NF to correlate notifications received from the Event provider
with this subscription. A subscription is associated with an unique
Notification Target Address (+ Notification Correlation ID). In the case that
the NF consumer subscribes to the NF producer on behalf of other NF, the NF
consumer includes the Notification Target Address(+Notification Correlation
ID) of other NF for the Event ID which is to be notified to other NF directly
and the Notification Target Address(+Notification Correlation ID) of itself
for the Subscription change related event notification. Each Notification
Target Address(+ Notification Correlation ID) is associated with related (set
of) Event ID(s).
\- An Expiry time represents the time up to which the subscription is desired
to be kept as active. The NF service consumer may suggest an Expiry time and
provide to the NF service producer. Based on the operator\'s policy, the NF
service producer decides whether the subscription can be expired. If the
subscription can be expired, the NF service producer determines the Expiry
time and provide it in the response to the NF service consumer. If the event
subscription is about to expire based on the received Expiry time and the NF
service consumer wants to keep receiving notifications, the NF service
consumer update the subscription with the NF service producer in order to
extend the Expiry time. Once the Expiry time associated with the subscription
is reached, the subscription becomes invalid at the NF service producer. If
the NF service consumer wants to keep receiving notifications, it shall create
a new subscription with the NF service producer.
When the subscription is accepted by the Event provider NF, the consumer NF
receives from the event provider NF an identifier (Subscription Correlation
ID) allowing to further manage (modify, delete) this subscription.
NOTE 1: The Notification Correlation ID is allocated by the consumer NF that
subscribes to event reporting and the Subscription Correlation ID is allocated
by the NF that notifies when the event is met. Both correlation identifiers
can be assigned the same value, although in principle they are supposed to be
different, as they are optimized for finding the subscription related context
within each NF.
The consumer NF may use an operation dedicated to subscription modification to
add or remove Event ID(s) to this subscription or to modify Event Filter
Information.
Events are subscribed by the consumer NF(s) by providing Event Filters. The
contents of the Event Reporting Information along with the presence
requirement of each information element is described in Table 4.15.1-1.
Table 4.15.1-1: Event Reporting Information
Event Reporting Information Parameter Description Presence requirement
* * *
1) Event reporting mode Mode of reporting - e.g. reporting up to a maximum
number of reports, periodic reporting along with periodicity, reporting up to
a maximum duration mandatory 2) Maximum number of reports Maximum number of
reports after which the event subscription ceases to exist (see NOTE 2) 3)
Maximum duration of reporting Maximum duration after which the event
subscription ceases to exist (see NOTE 2) 4) Immediate reporting flag The
Event provider NF notifies the current status of the subscribed event, if
available, immediately to the consumer NF.  
NOTE 2: The requester shall include 2) Maximum number of reports or 3) Maximum
duration of reporting, or both, depending on 1) Event reporting mode.
NOTE 3: Explicit unsubscribe by the NF consumer is still possible.
Maximum number of reports is applicable to the subscription to one UE or a
group of UE(s). When the subscription is applied to a group of UE(s), the
parameter is applied to each individual member UE. The count of number of
report is per UE granularity regardless whether the subscription includes more
than one events.
Maximum duration of reporting is applicable to the subscription to one UE, a
group of UE(s) or any UE. When the subscription is applied to a group of
UE(s), this parameter applies to each group member UE. When the subscription
is applied to any UE, this parameter applies to all the impacted UEs.
If for a given subscription both Maximum Number of reports and Maximum
duration of reporting are included then the subscription is considered to
expire as soon as one of the conditions is met.
Table 4.15.1-1 indicates the presence requirements for the Event Reporting
Information.
Corresponding notifications contain at least the Notification Correlation ID
together with the Event ID and the individual target (e.g. UE or PDU Session
ID) associated with the notification.
If the NF service consumer decides to terminate the event subscription, it
unsubscribes the event subscription by sending unsubscription request to the
event provider NF. After receiving unsubscription request from the NF service
consumer, the event provider NF terminates the event subscription.
The following clauses describe the external exposure of network capabilities
and core network internal event and capability exposure.
When the immediate reporting flag is set, the first corresponding event report
is included in the output message, if corresponding information is available
at the reception of the subscription request of the event.
### 4.15.2 External Exposure of Network Capabilities
The Network Exposure Function (NEF) supports external exposure of capabilities
of network functions. External exposure can be categorized as Monitoring
capability, Provisioning capability and Policy/Charging capability. The
Monitoring capability is for monitoring of specific event for UE in 5GS and
making such monitoring events information available for external exposure via
the NEF. The Provisioning capability is for allowing external party to
provision of information which can be used for the UE in 5GS. The
Policy/Charging capability is for handling QoS and charging policy for the UE
based on the request from external party.
### 4.15.3 Event Exposure using NEF
#### 4.15.3.1 Monitoring Events
The Monitoring Events feature is intended for monitoring of specific events in
3GPP system and making such monitoring events information reported via the
NEF. It is comprised of means that allow NFs in 5GS for configuring the
specific events, the event detection and the event reporting to the requested
party.
To support monitoring features in roaming scenarios, a roaming agreement needs
to be made between the HPLMN and the VPLMN. The set of capabilities required
for monitoring shall be accessible via NEF to NFs in 5GS. Monitoring Events
via the UDM and the AMF enables NEF to configure a given Monitor Event at UDM
or AMF and reporting of the event via UDM and/or AMF. Depending on the
specific monitoring event or information, it is either the AMF or the UDM that
is aware of the monitoring event or information and makes it reported via the
NEF.
The following table illustrates the monitoring events:
Table 4.15.3.1-1: List of event for monitoring capability
+----------------------+----------------------+----------------------+ | Event | Description | Which NF detects the | | | | event | +======================+======================+======================+ | Loss of Connectivity | Network detects that | AMF | | | the UE is no longer | | | | reachable for either | | | | signalling or user | | | | plane communication. | | +----------------------+----------------------+----------------------+ | UE reachability | It indicates when | AMF | | | the UE becomes | | | | reachable for | UDM | | | sending downlink | | | | data to the UE, | | | | which is detected | | | | when the UE | | | | transitions to | | | | CM-CONNECTED state | | | | or when the UE will | | | | become reachable for | | | | paging, e.g. | | | | Periodic | | | | Registration Update | | | | timer. This event | | | | requires the | | | | Reachability Filter | | | | set to UE reachable | | | | for DL traffic\" | | | | (see | | | | clause 5.2.2.3.1-1). | | | | For the usage of | | | | this event, see | | | | clauses 4.2.5.2 and | | | | 4.2.5.3. | | +----------------------+----------------------+----------------------+ | Location Reporting | It indicates either | AMF | | | the Current Location | | | | or the Last Known | | | | Location of a UE. | | | | One-time and | | | | Continuous Location | | | | Reporting are | | | | supported for the | | | | Current Location. | | | | For Continuous | | | | Location Reporting | | | | the serving node(s) | | | | sends a notification | | | | every time it | | | | becomes aware of a | | | | location change, | | | | with the granularity | | | | depending on the | | | | accepted accuracy of | | | | location. (see NOTE | | | | 1) For One-time | | | | Reporting is | | | | supported only for | | | | the Last Known | | | | Location. | | +----------------------+----------------------+----------------------+ | Change of SUPI-PEI | It indicates a | UDM | | association | change of the ME\'s | | | | PEI (IMEI(SV)) that | | | | uses a specific | | | | subscription (SUPI) | | +----------------------+----------------------+----------------------+ | Roaming status | It indicates UE\'s | UDM | | | current roaming | | | | status (the serving | | | | PLMN and/or whether | | | | the UE is in its | | | | HPLMN) and | | | | notification when | | | | that status changes. | | | | (see NOTE 2) | | +----------------------+----------------------+----------------------+ | Communication | It is identified by | AMF | | failure | RAN/NAS release code | | +----------------------+----------------------+----------------------+ | Availability after | It indicates when | AMF | | Downlink Data | there has been some | | | Notification failure | data delivery | | | | failure followed by | | | | the UE becoming | | | | reachable. | | +----------------------+----------------------+----------------------+ | Number of UEs | It indicates the | AMF | | present in a | number of UEs that | | | geographical area | are in the | | | | geographic area | | | | described by the AF. | | | | The AF may ask for | | | | the UEs that the | | | | system knows by its | | | | normal operation to | | | | be within the area | | | | (Last Known | | | | Location) or the AF | | | | may request the | | | | system to also | | | | actively look for | | | | the UEs within the | | | | area (Current | | | | Location). | | +----------------------+----------------------+----------------------+ | UE reachability for | This event is | UDM: reachability | | SMS delivery | detected when an | for SMS | | | SMSF is registered | | | | for a UE. This | | | | enables the UE to | | | | receive an SMS. | | +----------------------+----------------------+----------------------+ | NOTE 1: Location | | | | granularity for | | | | event request, or | | | | event report, or | | | | both could be at | | | | cell level (Cell | | | | ID), TA level or | | | | other formats e.g. | | | | shapes (e.g. | | | | polygons, circles, | | | | etc.) or civic | | | | addresses (e.g. | | | | streets, districts, | | | | etc.) which can be | | | | mapped by NEF. | | | | | | | | NOTE 2: Roaming | | | | status means whether | | | | the UE is in HPLMN | | | | or VPLMN. | | | +----------------------+----------------------+----------------------+
#### 4.15.3.2 Information flows
##### 4.15.3.2.1 AMF service operations information flow
The procedure is used by the NF to subscribe to notifications and to
explicitly cancel a previous subscription. Cancelling is done by sending
Namf_EventExposure_UnSubscribe request identifying Subscription Correlation
ID. The notification steps 3 and 4 are not applicable in cancellation case.
Figure 4.15.3.2.1-1: Namf_EventExposure_Subscribe, Unsubscribe and Notify
operations
1\. A NEF sends a request to subscribe to a (set of) Event ID(s) in AMF in
Namf_EventExposure_Subscribe request. The NEF could be the same NF subscribing
to receive the event notification reports (i.e. Event Receiving NF) or it
could be a different NF. The NEF subscribes to one or several Event(s)
(identified by Event ID) and provides the associated notification endpoint of
the Event Receiving NF. As the NEF itself is not the Event Receiving NF, the
NEF shall additionally provide the notification endpoint of itself besides the
notification endpoint of Event Receiving NF. Each notification endpoint is
associated with the related (set of) Event ID(s). This is to assure the NEF
can receive the notification of subscription change related event (e.g.
Subscription Correlation ID Change).
Event Reporting information defines the type of reporting requested. If the
reporting event subscription is authorized by the AMF, the AMF records the
association of the event trigger and the requester identity.
2\. AMF acknowledges the execution of Namf_EventExposure_Subscribe.
3\. [Conditional - depending on the Event] The AMF detects the monitored event
occurs and sends the event report by means of Namf_EventExposure_Notify
message, to the notification endpoint of the Event Receiving NF.
4\. [Conditional- depending on the Event] The AMF detects the subscription
change related event occurs, e.g. Subscription Correlation ID change due to
AMF reallocation, it sends the event report by means of
Namf_EventExposure_Notify message to the NEF.
##### 4.15.3.2.2 UDM service operations information flow
The procedure is used by the NEF to subscribe to notifications and to
explicitly cancel a previous subscription. Cancelling is done by sending
Nudm_EventExposure_Unsubscribe request identifying the subscription to cancel.
The notification steps 4 and 5 are not applicable in cancellation case.
Figure 4.15.3.2.2-1: Nudm_EventExposure_Subscribe, Unsubscribe and Notify
operations
1\. The NEF subscribes to one or several monitoring events by sending
Nudm_EventExposure_Subscribe request. The NEF subscribes to one or several
Event(s) (identified by Event ID) and provides the associated notification
endpoint of the NEF.
Event Reporting Information defines the type of reporting requested. If the
reporting event subscription is authorized by the UDM, the UDM records the
association of the event trigger and the requester identity.
The subscription may include Maximum number of reports and/or Maximum duration
of reporting IE.
2a. [Conditional] Some events (e.g. loss of connectivity), require that UDM
sends Namf_EventExposure_Subscribe request to the AMF serving that UE. As the
UDM itself is not the Event Receiving NF, the UDM shall additionally provide
the notification endpoint of itself besides the notification endpoint of NEF.
Each notification endpoint is associated with the related (set of) Event
ID(s). This is to assure the UDM can receive the notification of subscription
change related event.
The UDM sends the Namf_EventExposure_Subscribe request to all serving AMF(s)
(if subscription applies to a UE or a group of UE(s)), or to all the AMF(s) in
the same PLMN as UDM (if subscription applies to any UE).
If the subscription applies to a group of UE(s), the UDM shall include the
same notification endpoint of itself, i.e. Notification Target Address (+
Notification Correlation Id), in the subscriptions to all UE\'s serving
AMF(s).
NOTE: The same notification endpoint of UDM is to help the AMF identify
whether the subscription for the requested group event is same or not when a
new group member UE is registered.
2b. [Conditional] AMF acknowledges the execution of
Namf_EventExposure_Subscribe.
3\. UDM acknowledges the execution of Nudm_EventExposure_Subscribe.
If the subscription is applicable to a group of UE(s) and the Maximum number
of reports is included in the Event Report information in step 1, the Number
of UEs within this group is included in the acknowledgement.
4a - 4b. [Conditional - depending on the Event] The UDM detects the monitored
event occurs and sends the event report, by means of Nudm_EventExposure_Notify
message, to the associated notification endpoint of the NEF, along with the
time stamp. NEF may store the information in the UDR along with the time stamp
using either Nudr_DM_Create or Nudr_DM_Update service operation as
appropriate.
4c - 4d. [Conditional - depending on the Event] The AMF detects the monitored
event occurs and sends the event report, by means of Namf_EventExposure_Notify
message, to the associated notification endpoint of the NEF, along with the
time stamp. NEF may store the information in the UDR along with the time stamp
using either Nudr_DM_Create or Nudr_DM_Update service operation as
appropriate.
If the AMF has a maximum number of reports stored for the UE, the AMF shall
decrease its value by one for the reported event.
For both step 4a and step 4c, when the maximum number of reports is reached
and if the subscription is applied to a UE, The NEF unsubscribes the
monitoring event(s) to the UDM and the UDM unsubscribes the monitoring
event(s) to AMF serving that UE.
For both step 4a and step 4c, when the maximum number of reports is reached
for an individual group member UE, the NEF uses the Number of UEs received in
step 3 to determine if reporting for the group is complete. If the NEF
determines that reporting for the group is complete, the NEF unsubscribes the
monitoring event(s) to the UDM and the UDM unsubscribes the monitoring
event(s) to all AMF(s) serving the UEs belonging to that group.
When the Maximum duration of reporting expires in the NEF, the UDM and the
AMF, then each of these nodes shall locally unsubscribe the monitoring event.
5\. [Conditional - depending on the Event] The AMF detects the subscription
change related event occurs, e.g. Subscription Correlation ID change due to
AMF reallocation or addition of new Subscription Correlation ID due to a new
group UE registered, it sends the event report by means of
Namf_EventExposure_Notify message to the associated notification endpoint of
the UDM.
##### 4.15.3.2.3 NEF service operations information flow
The procedure is used by the AF to subscribe to notifications and to
explicitly cancel a previous subscription. Cancelling is done by sending
Nnef_EventExposure_Unsubscribe request identifying the subscription to cancel
with Subscription Correlation ID. The notification steps 6 to 8 are not
applicable in cancellation case.
Figure 4.15.3.2.3-1: Nnef_EventExposure_Subscribe, Unsubscribe and Notify
operations
1\. The AF subscribes to one or several Event(s) (identified by Event ID) and
provides the associated notification endpoint of the AF by sending
Nnef_EventExposure_Subscribe request.
Event Reporting Information defines the type of reporting requested (e.g. one-
time reporting, periodic reporting or event based reporting, for Monitoring
Events). If the reporting event subscription is authorized by the NEF, the NEF
records the association of the event trigger and the requester identity. The
subscription may also include Maximum number of reports and/or Maximum
duration of reporting IE.
2\. [Conditional - depending on authorization in step 1] The NEF subscribes to
received Event(s) (identified by Event ID) and provides the associated
notification endpoint of the NEF to UDM by sending
Nudm_EventExposure_Subscribe request.
If the reporting event subscription is authorized by the UDM, the UDM records
the association of the event trigger and the requester identity. Otherwise,
the UDM continues in step 4 indicating failure.
3a. [Conditional] If the requested event (e.g. monitoring of Loss of
Connectivity) requires AMF assistance, then the UDM sends the
Namf_EventExposure_Subscribe to the AMF serving the requested user. The UDM
sends the Namf_EventExposure_Subscribe request to the all serving AMF(s) (if
subscription applies to a UE or a group of UE(s)), or all the AMF in the same
PLMN as the UDM (if subscription applies to any UE).
As the UDM itself is not the Event Receiving NF, the UDM shall additionally
provide the notification endpoint of itself besides the notification endpoint
of NEF. Each notification endpoint is associated with the related (set of)
Event ID(s). This is to assure the UDM can receive the notification of
subscription change related event.
If the subscription applies to a group of UE(s), the UDM shall include the
same notification endpoint of itself, i.e. Notification Target Address (+
Notification Correlation Id), in the subscriptions to all UE\'s serving
AMF(s).
NOTE: The same notification endpoint of UDM is to help the AMF identify
whether the subscription for the requested group event is same or not when a
new group member UE is registered.
3b. [Conditional] AMF acknowledges the execution of
Namf_EventExposure_Subscribe.
4\. [Conditional] UDM acknowledges the execution of
Nudm_EventExposure_Subscribe.
If the subscription is applicable to a group of UE(s) and the Maximum number
of reports is included in the Event Report information in step 1, the Number
of UEs is included in the acknowledgement.
5\. NEF acknowledges the execution of Nnef_EventExposure_Subscribe to the
requester that initiated the request.
6a - 6b. [Conditional - depending on the Event] The UDM (depending on the
Event) detects the event occurs and sends the event report, by means of
Nudm_EventExposure_Notify message to the associated notification endpoint of
the NEF along with the time stamp. NEF may store the information in the UDR
along with the time stamp using either Nudr_DM_Create or Nudr_DM_Update
service operation as appropriate.
6c - 6d. [Conditional - depending on the Event] The AMF detects the event
occurs and sends the event report, by means of Namf_EventExposure_Notify
message to associated notification endpoint of the NEF along with the time
stamp. NEF may store the information in the UDR along with the time stamp
using either Nudr_DM_Create or Nudr_DM_Update service operation as
appropriate.
If the AMF has a maximum number of reports stored for the UE or the individual
member UE, the AMF shall decrease its value by one for the reported event.
For both step 6a and step 6b, when the maximum number of reports is reached
and if the subscription is applied to a UE, The NEF unsubscribes the
monitoring event(s) to the UDM and the UDM unsubscribes the monitoring
event(s) to AMF serving for that UE.
For both step 6a and step 6b, when the maximum number of reports is reached
for an individual group member UE, the NEF uses the Number of UEs received in
step 4 to determine if reporting for the group is complete. If the NEF
determines that reporting for the group is complete, the NEF unsubscribes the
monitoring event(s) to the UDM and the UDM unsubscribes the monitoring
event(s) to all AMF(s) serving the UEs belonging to that group.
When the Maximum duration of reporting expires in the NEF, the UDM and the
AMF, then each of these nodes shall locally unsubscribe the monitoring event.
7\. [Conditional - depending on the Event in step 6a and 6b] The NEF forwards
to the AF the reporting event received by either Nudm_EventExposure_Notify
and/or Namf_EventExposure_Notify.
8\. [Conditional - depending on the Event] The AMF detects the subscription
change related event occurs, e.g. Subscription Correlation ID change due to
AMF reallocation or addition of new Subscription Correlation ID due to a new
group UE registered, it sends the event report, by means of
Namf_EventExposure_Notify message to the associated notification endpoint of
the UDM.
##### 4.15.3.2.4 Exposure with bulk subscription
Based on operator configuration NEF may perform bulk subscription with the NFs
that provides necessary services. This feature is controlled by local policies
of the NEF that control which events (set of Event ID(s)) and UE(s) are target
of a bulk subscription.
When the NEF performs bulk subscription (subscribes for any UE (i.e. all UEs),
group of UE(s) (e.g. identifying a certain type of UEs such as IoT UEs)), it
subscribes to all the NFs that provide the necessary services (e.g. In a given
PLMN, NEF may subscribe to all AMFs that support reachability notification for
IoT UEs). Upon receiving bulk subscription from the NEF, the NFs store this
information. Whenever the corresponding event(s) occur for the requested UE(s)
as in bulk subscription request, NFs notify the NEF with the requested
information.
The following call flow shows how network exposure can happen for one UE,
groups of UE(s) (e.g. identifying a certain type of UEs such as IoT UEs) or
any UE.
Figure 4.15.3.2.4-1: NF registration/status notification and Exposure with
bulk subscription
1\. NEF registers with the NRF for any newly registered NF along with its NF
services.
2\. When an NF instantiates, it registers itself along with the supported NF
services with the NRF.
3\. NRF acknowledges the registration
4\. NRF notifies the NEF with the newly registered NF along with the supported
NF services.
5\. NEF evaluates the NF and NF services supported against the pre-configured
events within NEF. Based on that, NEF subscribes with the corresponding NF
either for a single UE, group of UE(s) (e.g. identifying a certain type of UEs
such as IoT UEs), any UE. NF acknowledges the subscription with the NEF.
6 - 7. When the event trigger happens, NF notifies the requested information
towards the subscribing NEF along with the time stamp. NEF may store the
information in the UDR along with the time stamp using either Nudr_DM_Create
or Nudr_DM_Update service operation as appropriate.
8\. Application registers with the NEF for a certain event identified by event
filters. If the registration for the event is authorized by the NEF, the NEF
records the association of the event and the requester identity.
9 - 10. When the event trigger happens, NF notifies the requested information
towards the subscribing NEF. NEF may store the information in the UDR using
either Nudr_DM_Create or Nudr_DM_Update service operation as appropriate.
11a-b. NEF reads from UDR with Nudr_DM_Query and notifies the application
along with the time stamp for the corresponding subscribed events.
### 4.15.4 Core Network Internal Event Exposure
#### 4.15.4.1 General
The exposure of events internally within the 3GPP NFs are explained in the
following clauses. Only the event notifications that are independent of the
ongoing system procedure are specified in this clause. For the event
notifications that are part of the system procedure, see the system procedure
descriptions under clause 4.2 to clause 4.14.
#### 4.15.4.2 Exposure of Mobility Events from AMF
The AMF invokes the Namf_EventExposure_Notify to provide mobility related
events to NF consumers that have subscribed for the events by invoking
Namf_EventExposure_Subscribe, in the following scenarios listed below and
after Namf_EventExposure_Subscribe service operation.
\- During Registration procedure, Inter NG-RAN node N2 based handover
procedure, when there is a change of AMF (within the same AMF Set or across
the AMF Set), the new AMF receives all event subscriptions from old AMF or
UDSF. For each event subscription:
if the event subscription only applies to the UE, the new AMF allocates a new
Subscription Correlation ID and notify the NF consumer of the new Subscription
Correlation ID associated with the change of Subscription Correlation ID
event.
if the event subscription applies to a group of UE(s) and there is no
corresponding subscription for this group (identified by the internal group Id
and notification endpoint) at the new AMF, the new AMF shall create
corresponding event subscription, allocate a new Subscription Correlation Id
and send it to the received notification endpoint, i.e. Notification Target
Address (+Notification Correlation Id), associated with the addition of
Subscription Correlation ID event.
\- During Registration procedure, when there is a change of AMF, the new AMF
notifies each NF that has subscribed for UE reachability event about the UE
reachability status.
\- During Registration, Handover, UE Triggered Service Request procedure in
CM-IDLE state, Location Reporting, N2 Notification and AN Release procedures,
the AMF determines the UE presence in Area Of Interest (i.e. IN, OUT or
UNKNOWN status ) as described in Annex D.1 and notifies the NF Consumers of
the UE presence in an Area Of Interest if the NF consumers (e.g. SMF) had
subscribed for this Area Of Interest and if the UE presence in Area Of
Interest is different from the one reported earlier.
\- During Registration and Handover procedure or during Service Area
Restriction update by UDM or PCF, if the UE is moving from an Allowed Area to
a Non-Allowed Area, then the AMF informs all the NF consumers (e.g. SMF), that
have subscribed for UE reachability event, that the UE is reachable only for
regulatory prioritized service. The SMF shall explicitly subscribe UE
reachability unless the established PDU Session is related to regulatory
prioritized service.
\- If the AMF had notified an SMF of the UE being reachable only for
regulatory prioritized service earlier, the AMF informs the NF consumers (e.g.
SMF), that have subscribed for UE reachability event, that the UE is reachable
if the UE enters into Allowed Area.
\- During Registration procedure and Service Request procedure, if the AMF had
notified an SMF earlier of the UE being unreachable and that SMF need not
invoke Namf_Communication_N1N2MessageTransfer to the AMF due to DL data
notifications, the AMF informs the SMF when the UE becomes reachable.
\- During Registration procedure, Handover without Registration procedure and
Service Request procedure, if the NF consumers had subscribed for UE
reachability status, the AMF notifies the UE reachability status changes.
\- During Network Triggered Service Request procedure, if the UE does not
respond to paging, when the AMF considers the UE as unreachable the AMF
notifies the NF consumers that have subscribed for UE reachability event, that
the UE is not reachable.
\- If the UDM had subscribed for UE reachability event notification either to
be reported to the UDM or to an NF consumer directly, then the AMF notifies
the UE reachability event to the UDM or to the NF consumer as specified in
clause 4.2.5.2.
### 4.15.5 Void
### 4.15.6 External Parameter Provisioning
#### 4.15.6.1 General
Provisioning capability allows an external party to provision the expected UE
behavioural information to 5G network functions. The provisioning information
consists of information on expected UE movement and communication
characteristics. Provisioned data can be used by the other NFs.
#### 4.15.6.2 NEF service operations information flow
Figure 4.15.6.2-1: Nnef_ParameterProvision_update request/response operations
0\. NF subscribes to UDM notifications of information updates.
1\. AF provides one or more parameter(s) to be updated in
Nnef_ParameterProvision_Update Request to the NEF.
The GPSI identifies the UE and the Transaction Reference ID identifies the
transaction request between NEF and AF.
2\. If the AF is authorised by the NEF to provision the parameters, the NEF
requests to update and store the provisioned parameters as part of the
subscriber data via Nudm_ParameterProvision_Update Request message, the
message includes the provisioned data and NEF reference ID.
If the requester is not authorised to provision data, then the NEF continues
in step 6 indicating the reason to failure in Nnef_ParameterProvision_Update
Response message.
NOTE 1: For non-roaming case and no authorisation or validation by the UDM
required, the NEF can directly forward the external parameter to the UDR via
Nudr_DM_Update Request message. And in this case, the UDR responds to NEF via
Nudr_DM_Update Response message.
3\. UDM may read from UDR, by means of Nudr_DM_Query, corresponding subscriber
information in order to validate required data updates and authorize these
changes for this subscriber for the corresponding AF.
4\. If the AF is authorised by the UDM to provision the parameters for this
subscriber, the UDM resolves the GPSI to SUPI and requests to update and store
the provisioned parameters as part of the subscriber data via Nudr_DM_Update
Request message, the message includes the provisioned data.
UDR stores the provisioned data as part of the subscription data and responds
with Nudr_DM_Update Response message.
If the requester is not authorised to provision data, then the UDM continues
in step 5 indicating the reason to failure in Nudm_ParameterProvision_Update
Response message and step 7 is not executed.
5\. UDM responds the request with Nudm_ParameterProvision_Update Response. If
the procedure failed, the cause value indicates the reason.
6\. NEF responds the request with Nnef_ParameterProvision_Update Response. If
the procedure failed, the cause value indicates the reason.
7\. [Conditional this step occurs only after successful step 4] UDM notifies
the subscribed Network Function (e.g. AMF) of the updated subscriber data via
Nudm_SDM_Notification Notify message.
NOTE 2: The NEF (in NOTE 1) or the UDM (in step 3) can also update the
corresponding UDR data via Nudr_DM_Create/Delete as appropriate.
#### 4.15.6.3 Expected UE Behaviour parameters
These Expected UE Behaviour parameters characterise the foreseen behaviour of
a UE or a group of UEs. Sets of these parameters may be provided via the NEF
to be stored as part of the subscriber data. Each parameter within the
Expected UE Behaviour shall have an associating validity time. The validity
time indicates when the Expected UE Behaviour parameter expires and shall be
deleted by the related NFs. The validity time may be set to indicate that the
particular Expected UE Behaviour parameter has no expiration time. When the
validity time expires, the related NFs delete their local copy of the
associated Expected UE Behaviour parameter(s). The provision procedure of the
Expected UE Behaviour is realized by external parameter provision procedure
defined in clause 4.15.6.2.
NOTE: It is expected that the format of validity time, to be defined by Stage
3, is defined in a manner which allows NFs to consistently and uniformly
interpret the expiration of the associated Expected UE behaviour parameters.
Table 4.15.6.3-1: Description of Expected UE Behaviour parameters
+---------------------------------+-----------------------------------+ | Expected UE Behaviour parameter | Description | +=================================+===================================+ | Expected UE Moving Trajectory | Identifies the UE\'s expected | | | geographical movement | | | | | | Example: A planned path of | | | movement | +---------------------------------+-----------------------------------+
#### 4.15.6.4 Set a chargeable party at AF session setup
Figure 4.15.6.4-1: Set the chargeable party at AF session set-up
1\. When setting up the connection between the AF and UE, the AF may request
to become the chargeable party for the session to be set up by sending a
Nnef_ChargeableParty_Create request message (AF Identifier, UE address,
Description of the application flows, Sponsor Information, Sponsoring Status,
Background Data Transfer Reference ID) to the NEF, The Sponsoring Status
indicates whether sponsoring is started or stopped, i.e. whether the 3rd party
service provider is the chargeable party or not. The Background Data Transfer
Reference ID parameter identifies a previously negotiated transfer policy for
background data transfer as defined in clause 4.16.7. The NEF assigns a
Transaction Reference ID to the Nnef_ChargeableParty_Create request.
2\. The NEF authorizes the AF request to sponsor the application traffic and
stores the sponsor information together with the AF Identifier and the
Transaction Reference ID. If the authorisation is not granted, step 2 is
skipped and the NEF replies to the AF with a Result value indicating that the
authorisation failed.
NOTE: Based on operator configuration, the NEF may skip this step. In this
case the authorization is performed by the PCF in step 3.
3\. The NEF interacts with the PCF by triggering a
Npcf_PolicyAuthorization_Create request message and provides IP filter
information or Ethernet filter information, sponsored data connectivity
information (as defined in TS 23.203 [24]), Background Data Transfer Reference
ID (if received from the AF) and Sponsoring Status (if received from the AF)
to the PCF.
4\. The PCF determines whether the request is allowed and notifies the NEF if
the request is not authorized. If the request is not authorized, NEF responds
to the AF in step 5 with a Result value indicating that the authorization
failed.
5\. The NEF sends a Nnef_ChargeableParty_Create response message (Transaction
Reference ID, Result) to the AF. Result indicates whether the request is
granted or not.
#### 4.15.6.5 Change the chargeable party during the session
Figure 4.15.6.5-1: Change the chargeable party during the session
1\. For the ongoing AF session, the AF may send a Nnef_ChargeableParty_Update
request message (AF Identifier, Transaction Reference ID, Sponsoring Status,
Background Data Transfer Reference ID) to the NEF. The Sponsoring Status
indicates whether sponsoring is enabled or disabled, i.e. whether the 3rd
party service provider is the chargeable party or not. The Background Data
Transfer Reference ID parameter identifies a previously negotiated transfer
policy for background data transfer as defined in clause 4.16.7. The
Transaction Reference ID provided in the Change chargeable party request
message is set to the Transaction Reference ID that was assigned, by the NEF,
to the a Nnef_ChargeableParty_Create request.
2\. The NEF authorizes the AF request of changing the chargeable party. If the
authorisation is not granted, step 3 is skipped and the NEF replies to the AF
with a Result value indicating that the authorisation failed.
NOTE: Based on operator configuration, the NEF may skip this step. In this
case the authorization is performed by the PCF in step 3.
3\. The NEF interacts with the PCF by triggering a
Npcf_PolicyAuthorization_Update request and provides IP filter information or
Ethernet filter information, sponsored data connectivity information (as
defined in TS 23.203 [24]), Background Data Transfer Reference ID (if received
from the AF) and Sponsoring Status (if received from the AF) to the PCF.
4\. The PCF determines whether the request is allowed and notifies the NEF if
the request is not authorized. If the request is not authorized, NEF responds
to the AF in step 5 with a Result value indicating that the authorization
failed.
5\. The NEF sends a Nnef_ChargeableParty_Update response message (Transaction
Reference ID, Result) to the AF. Result indicates whether the request is
granted or not.
#### 4.15.6.6 Setting up an AF session with required QoS procedure
Figure 4.15.6.6-1: Setting up an AF session with required QoS procedure
1\. When setting up the connection between AF and the UE with required QoS for
the service, the AF sends an Nnef_AFsessionWithQoS_Create request message (UE
address, AF Identifier, Description of the application flows, QoS reference)
to the NEF. Optionally, a period of time or a traffic volume for the requested
QoS can be included in the AF request. The NEF assigns a Transaction Reference
ID to the Nnef_AFsessionWithQoS_Create request.
2\. The NEF authorizes the AF request and may apply policies to control the
overall amount of pre-defined QoS authorized for the AF. If the authorisation
is not granted, steps 3 and 4 are skipped and the NEF replies to the AF with a
Result value indicating that the authorisation failed.
3\. The NEF interacts with the PCF by triggering a
Npcf_PolicyAuthorization_Create request and provides UE address, AF
Identifier, Description of the application flows and the QoS reference
including the optionally received period of time or traffic volume which is
mapped to sponsored data connectivity information (as defined in TS 23.203
[24]).
The PCF derives the required QoS based on the information provided by the NEF
and determines whether this QoS is allowed (according to the PCF configuration
for this AF) and notifies the result to the NEF.
The PCF notifies the NEF whether the transmission resources corresponding to
the QoS request are established or not.
4\. The PCF determines whether the request is allowed and notifies the NEF if
the request is not authorized. If the request is not authorized, NEF responds
to the AF in step 5 with a Result value indicating that the authorization
failed.
5\. The NEF sends a Nnef_AFsessionWithQoS_Create response message (Transaction
Reference ID, Result) to the AF. Result indicates whether the request is
granted or not.
6\. The NEF shall send a Npcf_PolicyAuthorization_Subscribe message to the PCF
to subscribe to notifications of Resource allocation status and may subscribe
to other events described in clause 6.1.3.18 of TS 23.503 [20].
7\. When the event condition is met, the PCF sends
Npcf_PolicyAuthorization_Notify message to the NEF notifying about the event.
8\. The NEF sends Nnef_AFsessionWithQoS_Notify message with the event reported
by the PCF to the AF.
## 4.16 Procedures and flows for Policy Framework
### 4.16.1 AM Policy Association Establishment
#### 4.16.1.1 General
There are three cases considered for AM Policy Association Establishment:
1\. UE initial registration with the network.
2\. The AMF re-allocation with PCF change in handover procedure and
registration procedure.
3\. EPS to 5GS mobility when there is no existing AM Policy Association
between AMF and PCF for this UE.
#### 4.16.1.2 AM Policy Association Establishment with new Selected PCF
Figure 4.16.1.2-1: AM Policy Association Establishment with new Selected PCF
This procedure concerns both roaming and non-roaming scenarios.
In the non-roaming case the role of the V-PCF is performed by the PCF. For the
roaming scenarios, the V-PCF interacts with the AMF.
1\. Based on local policies, the AMF decides to establish AM Policy
Association with the (V-)PCF then steps 2 to 3 are performed under the
conditions described below.
2\. [Conditional] If the AMF has not yet obtained Access and Mobility policy
for the UE or if the Access and Mobility policy in the AMF are no longer
valid, the AMF requests the PCF to apply operator policies for the UE from the
PCF. The AMF sends Npcf_AMPolicyControl_Create to the (V-)PCF to establish an
AM policy control association with the (V-)PCF. The request includes the
following information: SUPI, Internal Group (see clause 5.9.7 of TS 23.501
[2]), subscription notification indication and, if available, Service Area
Restrictions, RFSP index, the Allowed NSSAI, GPSI which are retrieved from the
UDM during the update location procedure and may include Access Type and RAT,
PEI, ULI, UE time zone and Serving Network.
3\. The (V)-PCF responds to the Npcf_AMPolicyControl_Create service operation.
The (V)-PCF provides Access and mobility related policy information (e.g.
Service Area Restrictions) as defined in clause 6.5 of TS 23.503 [20]. In
addition, (V)-PCF can provides Policy Control Request Trigger of AM Policy
Association to AMF.
The AMF is implicitly subscribed in the (V-)PCF to be notified of changes in
the policies.
4\. [Conditional] The AMF deploys the Access and mobility related policy
information which includes storing the Service Area Restrictions and Policy
Control Request Trigger of AM Policy Association, provisioning Service Area
Restrictions to the UE and provisioning the RFSP index and Service Area
Restrictions to the NG-RAN as defined in TS 23.501 [2].
#### 4.16.1.3 Void
### 4.16.2 AM Policy Association Modification
#### 4.16.2.0 General
There are three cases considered for AM Policy Association Modification:
\- Case A: A Policy Control Request Trigger condition is met: the procedure is
initiated by the AMF.
\- Case B: PCF local decision or trigger from other peers of the PCF (i.e.
UDR): the procedure is initiated by the PCF.
\- Case C: AM Policy Association Modification with the old PCF during AMF
relocation: the procedure is initiated by the AMF.
#### 4.16.2.1 AM Policy Association Modification initiated by the AMF
##### 4.16.2.1.1 AM Policy Association Modification initiated by the AMF
without AMF relocation
This procedure is applicable to Case A.
Figure 4.16.2.1.1-1: AM Policy Association Modification initiated by the AMF
This procedure concerns both roaming and non-roaming scenarios.
In the non-roaming case the role of the V-PCF is performed by the PCF. For the
roaming scenarios, the V-PCF interacts with the AMF.
1\. When a Policy Control Request Trigger condition is met the AMF updates AM
Policy Association and provides information on the conditions that have
changed to the PCF by invoking Npcf_AMPolicyControl_Update.
2\. The (V-)PCF stores the information received in step 1 and makes the policy
decision.
3\. The (V-)PCF responds to the AMF of the updated Access and Mobility related
policy control information and the updated Policy Control Request Trigger
parameters.
4\. The AMF deploys the access and mobility control policy, which includes
storing the Service Area Restrictions and Policy Control Request Trigger of AM
Policy Association, provisioning the Service Area Restrictions to the UE and
provisioning the RFSP index and Service Area Restrictions to the NG-RAN as
defined in TS 23.501 [2].
##### 4.16.2.1.2 AM Policy Association Modification with old PCF during AMF
relocation
This procedure is applicable to Case C. In this case, AMF relocation is
performed without PCF change in handover procedure and registration procedure.
Figure 4.16.2.1.2-1: AM Policy Association Modification with the old PCF
during AMF relocation
This procedure concerns both roaming and non-roaming scenarios.
In the non-roaming case the role of the V-PCF is performed by the PCF. For the
roaming scenarios, the V-PCF interacts with the AMF.:
1\. [Conditional] When the old AMF and the new AMF belong to the same PLMN,
the old AMF transfers to the new AMF about the AM Policy Association
information including policy control request trigger(s) and the PCF ID. For
the roaming case, the new AMF receives V-PCF ID.
2\. Based on local policies, the new AMF decides to establish UE Context with
the (V-)PCF and contacts the (Vâ€‘)PCF identified by the PCF ID received in step
1.
3\. The new AMF sends Npcf_AMPolicyControl_Update to the (V-)PCF to update the
AM policy association with the (V-)PCF. The request may include the following
information: policy control request trigger which has been met, Subscribed
Service Area Restrictions (if updated), subscribed RFSP index (if updated)
which are retrieved from the UDM during the update location procedure and may
include access type and RAT, PEI, ULI, UE time zone, service network. The
(V-)PCF updates the stored information provided by the old AMF with the
information provided by the new AMF.
4\. The (V-)PCF may update the policy decision based on the information
provided by the new AMF.
5\. The AMF deploys the access and mobility control policy, which includes
storing the Service Area Restrictions, provisioning Service Area Restrictions
to the UE and provisioning the RFSP index and Service Area Restrictions to the
NG-RAN.
#### 4.16.2.2 AM Policy Association Modification initiated by the PCF
This procedure is applicable to AM Policy Association modification due to Case
B.
Figure 4.16.2.2-1: AM Policy Association Modification initiated by the PCF
This procedure concerns both roaming and non-roaming scenarios.
In the non-roaming case the role of the V-PCF is performed by the PCF. For the
roaming scenarios, the V-PCF interacts with the AMF.
NOTE: The V-PCF stores the access and mobility control policy information
provided to the AMF.
1\. [Conditional] PCF determines locally that the new status of the UE context
requires new policies.
2\. The (V-)PCF makes a policy decision.
3\. The (V-)PCF sends Npcf_UpdateNotify including AM Policy Association ID
associated with the SUPI defined in TS 29.507 [32], Service Area Restrictions
or RFSP index.
4\. The AMF deploys the Access and mobility related policy information, which
includes storing the Service Area Restrictions and Policy Control Request
Trigger of AM Policy Association, provisioning of the Service Area
Restrictions to the UE and provisioning the RFSP index and Service Area
Restrictions to the NG-RAN.
### 4.16.3 AM Policy Association Termination
#### 4.16.3.1 General
The following case is considered for AM Policy Association Termination:
1\. UE Deregistration from the network.
2\. The mobility with change of AMF (e.g. new AMF is in different PLMN or new
AMF in the same PLMN).
3\. [Optional] 5GS to EPS mobility with N26 if the UE is not connected to the
5GC over a non-3GPP access in the same PLMN.
#### 4.16.3.2 AMF-initiated AM Policy Association Termination
Figure 4.16.3.2-1: AMF-initiated AM Policy Association Termination
This procedure concerns both roaming and non-roaming scenarios.
In the non-roaming case the role of the V-PCF is performed by the PCF. For the
roaming scenarios, the V-PCF interacts with the AMF.
1\. The AMF decides to terminate the AM Policy Association during
Deregistration procedure or due to mobility with change of AMF and (V-)PCF in
the registration procedure or handover procedure, then if a AM Policy
Association was established with the (V-)PCF steps 2 to 3 are performed.
2\. The AMF sends the Npcf_AMPolicyControl_Delete service operation including
AM Policy Association ID to the (V-)PCF.
3\. The (V-)PCF removes the policy context for the UE and replies to the AMF
with an Acknowledgement including success or failure.
4\. The AMF removes the AM Policy Association for this UE, including the
Access and Mobility Control Policy related to the UE. The AMF deletes the
subscription to AMF detected events requested for that Policy Association.
#### 4.16.3.3 Void
### 4.16.4 SM Policy Association Establishment
Figure 4.16.4-1: SM Policy Association Establishment
This procedure concerns both roaming and non-roaming scenarios.
In the non-roaming case the V-PCF is not involved. In the local breakout
roaming case, the H-PCF is not involved. In the home routed roaming case, the
V-PCF is not involved and the H-PCF interacts with the H-SMF.
This procedure is used in UE requests a PDU Session Establishment as explained
in clause 4.3.2.2.1, for non-roaming and local breakout roaming. For home-
routed roaming, as explained in clause 4.3.2.2.2.
For local breakout roaming, the interaction with HPLMN (e.g. step 3) is not
used. In local breakout roaming, the V-PCF interacts with the UDR of the
VPLMN.
1\. The SMF determines that the PCC authorization is required and requests to
establish an SM Policy Association with the PCF by invoking
Npcf_SMPolicyControl_Create operation (see clause 5.2.5.4.2). The SMF includes
the following information: SUPI, PDU Session id, PDU Session Type, S-NSSAI,
DNN, GPSI (if available), Access Type, AMF instance identifier and if
available, the IPv4 address and/or IPv6 network prefix, PEI, User Location
Information, UE Time Zone, Serving Network, RAT type, Charging
Characteristics, Session AMBR, default QoS information, Trace Requirements,
Internal Group Identifier (see clause 5.9.7 of TS 23.501 [2]).
The SMF provides Trace Requirements to the PCF when it has received Trace
Requirements and it has selected a different PCF than the one received from
the AMF.
2\. If the PCF does not have the subscriber\'s subscription related
information, it sends a request to the UDR by invoking Nudr_DM_Query (SUPI,
DNN, S-NSSAI, Policy Data, PDU Session policy control data, Accumulated Usage
data) service in order to receive the information related to the PDU Session.
The PCF may request notifications from the UDR on changes in the subscription
information by invoking Nudr_DM_Subscribe (Policy Data, SUPI, DNN, S-NSSAI,
Notification Target Address (+ Notification Correlation Id), Event Reporting
Information (continuous reporting), PDU Session policy control data,
Accumulated Usage data) service.
3\. If the PCF determines that the policy decision depends on the status of
the policy counters available at the CHF and such reporting is not established
for the subscriber, the PCF initiates an Initial Spending Limit Report
Retrieval as defined in clause 4.16.8.2. If policy counter status reporting is
already established for the subscriber and the PCF determines that the status
of additional policy counters are required, the PCF initiates an Intermediate
Spending Limit Report Retrieval as defined in clause 4.16.8.3.
4\. The PCF makes the authorization and the policy decision.
5\. The PCF answers with a Npcf_SMPolicyControl_Create response; in its
response the PCF may provide policy information defined in clause 5.2.5.4 (and
in TS 23.503 [20]). The SMF enforces the decision. The SMF implicitly
subscribes to changes in the policy decisions.
NOTE: After this step the PCF can subscribe to SMF events associated with the
PDU Session.
### 4.16.5 SM Policy Association Modification
#### 4.16.5.0 General
The following SM Policy Association Modification procedures concern both
roaming and non-roaming scenarios.
In the non-roaming case the V-PCF is not involved. In the local breakout
roaming case, the H-PCF is not involved. In the home routed roaming case, the
V-PCF is not involved and the H-PCF interacts with the H-SMF.
The SM Policy Association Modification procedure may be initiated either by
the SMF or by the PCF.
#### 4.16.5.1 SMF initiated SM Policy Association Modification
The SMF may initiate the SM Policy Association Modification procedure if a
Policy Control Request Trigger is met.
Figure 4.16.5.1-1: SMF initiated SM Policy Association Modification
For local breakout roaming, the interaction with HPLMN (e.g. step 2) is not
used. In local breakout roaming, the V-PCF interacts with the UDR of the
VPLMN.
1\. When a Policy Control Request Trigger condition is met the SMF requests to
update (Npcf_SMPolicyControl_Update) the SM Policy Association and provides
information on the conditions that have been met.
2\. When an AF has subscribed to an event that is met due to the report from
the SMF, the PCF reports the event to the AF by invoking the
Npcf_PolicyAuthorization_Notify service operation.
3\. If the PCF determines a change to policy counter status reporting is
required, it may alter the subscribed list of policy counters using the
Initial, Intermediate or Final Spending Limit Report Retrieval procedures as
defined in clause 4.16.8.
4\. The PCF makes a policy decision as described in TS 23.503 [20]. The PCF
may determine that updated or new policy information needs to be sent to the
SMF.
If the SMF reported accumulated usage for the PDU session in step 1 the PCF
deducts the value from the total allowed usage for the subscriber, DNN and
S-NSSAI in the UDR by invoking Nudr_DM_Update (SUPI, DNN, S-NSSAI, Policy
Data, Accumulated Usage data, updated data) service operation.
If the SMF reported accumulated usage for a MK(s) in step 1 the PCF deducts
the value from the total allowed usage for the MK in the UDR by invoking
Nudr_DM_Update (SUPI, DNN, S-NSSAI, Policy Data, Accumulated Usage data,
updated data (including MK(s))) service operation.
5\. The PCF answers with a Npcf_SMPolicyControl_Update response with updated
policy information about the PDU Session determined in step 3.
#### 4.16.5.2 PCF initiated SM Policy Association Modification
The PCF may initiate SM Policy Association Modification procedure based on
local decision or triggered by other peers of the PCF (AF, CHF, UDR).
Figure 4.16.5.2-1: PCF initiated SM Policy Association Modification
This procedure may be triggered by a local decision of the PCF or based on
triggers from other peers of the PCF (AF, CHF, UDR):
For local breakout roaming, the interaction with HPLMN (e.g. step 1b and step
2) is not used. In local breakout roaming, the V-PCF interacts with the UDR of
the VPLMN.
1a. Alternatively, optionally, the AF provides/revokes service information to
the PCF e.g. due to AF session signalling, by invoking
Npcf_PolicyAuthorization_Create Request or Npcf_PolicyAuthorization_Update
Request service operation. The PCF responds to the AF.
1b. Alternatively, optionally, the CHF provides a Spending Limit Report to the
PCF as described in clause 4.16.8. and responds to the CHF.
1c Alternatively, optionally, the UDR notifies the PCF about a policy
subscription change by invoking Nudr_DM_Notify (Notification correlation Id,
Policy Data, SUPI, updated data, \"PDU Session Policy Control Data\" \|
\"Accumulated Usage\"); The PCF responds to the UDR.
1d Alternatively, optionally, some internal event (e.g. timer) occurs at the
PCF.
2\. If the PCF determines a change to policy counter status reporting is
required, it may alter the subscribed list of policy counters using the
Initial, Intermediate or Final Spending Limit Report Retrieval procedures as
defined in clause 4.16.8.
NOTE: The PCF ensures that information received in step 1 and 2 can be used by
later policy decisions.
3\. The PCF makes a policy decision. The PCF may determine that updated or new
policy information need to be sent to the SMF.
If the AF provided a Background Data Transfer Reference ID in step 1a, the PCF
may retrieve it from the UDR by invoking the Nudr_DM_Query (BDT Reference Id,
Policy Data, Background Data Transfer) service.
4\. If the PCF has determined that SMF needs updated policy information in
step 3 the PCF issues a Npcf_SMPolicyControl_UpdateNotify request with
possibly updated policy information about the PDU Session.
5\. The SMF acknowledges the PCF request with a
Npcf_SMPolicyControl_UpdateNotify response.
### 4.16.6 SM Policy Association Termination
Figure 4.16.6-1: SM Policy Association Termination
This procedure concerns both roaming and non-roaming scenarios.
In the non-roaming case the V-PCF is not involved. In the local breakout
roaming case, the H-PCF is not involved. In the home routed roaming case, the
V-PCF is not involved and the H-PCF interacts only with the H-SMF.
The procedure for Session Management Policy Termination may be initiated by:
\- (case A) the PCF.
\- (case B) the SMF.
For local breakout roaming, the interaction with HPLMN (e.g. step 6) is not
used. In local breakout roaming, the V-PCF interacts with the UDR of the
VPLMN.
1\. (Case A) The PCF may invoke the Npcf_SMPolicyControl_UpdateNotify service
operation to request the release of a PDU Session. The SMF acknowledges the
request.
The rest of the procedure corresponds to both Case A &B.
2\. The SMF may invoke the Npcf_SMPolicyControl_Delete service operation to
request the deletion of the SM Policy Association with the PCF. The SMF
provides relevant information to the PCF.
3\. When receiving the request from step2, the PCF finds the PCC Rules that
require an AF to be notified and removes PCC Rules for the PDU Session.
If the SMF reported accumulated usage for the PDU session in step 1 the PCF
deducts the value from the total allowed usage for the subscriber, DNN and
S-NSSAI in the UDR by invoking Nudr_DM_Update (SUPI, DNN, S-NSSAI, Policy
Data, Accumulated Usage data, updated data) service operation.
If the SMF reported accumulated usage for a MK(s) in step 1 the PCF deducts
the value from the total allowed usage for the MK in the UDR by invoking
Nudr_DM_Update (SUPI, DNN, S-NSSAI, Policy Data, Accumulated Usage data,
updated data (including MK(s))) service operation.
4\. The SMF removes all policy information about the PDU Session associated
with the PDU Session.
5\. The PCF notifies the AF as explained in clause 7.3.1 steps 6-7 of TS
23.203 [24].
PCF may invoke Nbsf_Management_Deregister service operation to delete the
binding created in BSF.
6\. The PCF may invoke the procedure defined in clause 4.16.8 to unsubscribe
to policy counter status reporting (If this is the last PDU Session for this
subscriber requiring policy counter status reporting) or to modify the
subscription to policy counter status reporting, (if any remaining existing
PDU Sessions for this subscriber requires policy counter status reporting).
7\. The PCF removes the information related to the terminated PDU Session and
acknowledges to the SMF that the PCF handling of the PDU Session has
terminated. This interaction is the response to the SMF request in step 2.
8\. The PCF may (e.g. if it is the last PDU Session on the (DNN, S-NSSAI)
couple) unsubscribe to the notification of the PDU Session related data
modification from the UDR by invoking Nudr_DM_Unsubscribe (Subscription
Correlation Id) if it had subscribed such notification.
### 4.16.7 Negotiations for future background data transfer
#### 4.16.7.1 General
This procedure enables the negotiation between the NEF and the H-PCF about the
transfer policies for the future background data transfer (as described in
clause 6.1.2.4 in TS 23.503 [20]). The transfer policies consist of a desired
time window for the background data transfer, a reference to a charging rate
for the time window and optionally a maximum aggregated bitrate, as described
in clause 6.1.16 in TS 23.203 [24].
This negotiation is preliminarily conducted (when AF initiates a procedure to
NEF) before the UE\'s PDU Session establishment. At a later time, the AF
invokes the Npcf_PolicyAuthorization_Create service directly with PCF, or via
the NEF, to apply the background data transfer policy for an individual UE.
#### 4.16.7.2 Procedures for future background data transfer
Figure 4.16.7.2-1: Negotiation for future background data transfer
1\. The AF invokes the Nnef_BDTPNegotiation_Create service.
2\. Based on an AF request, the NEF invokes the Npcf_BDTPolicyControl_Create
service with the H-PCF to authorize the creation of the policy regarding the
background data transfer.
NOTE 1: The NEF does not provide any information about the identity of the UEs
potentially involved in the future background data transfer.
NOTE 2: A 3rd party application server is typically not able to provide any
specific network area information and if so, the AF request is for a whole
operator network.
3 The H-PCF may request from the UDR the stored transfer policies for all the
ASPs using Nudr_DM_Query (Policy Data, Background Data Transfer) service
operation.
NOTE 3: If only one PCF is deployed in the PLMN, the transfer policy can be
locally stored and no interaction with UDR is required.
4\. The UDR provides all the stored transfer policies and corresponding
network area information to the H-PCF.
5\. The H-PCF determines, based on information provided by the AF and other
available information one or more transfer policies.
NOTE 4: The maximum aggregated bitrate is not enforced in the network.
6\. The H-PCF send the acknowledge message to the NEF with the acceptable
transfer policies and a Background Data Transfer Reference ID.
7\. The NEF sends a Nnef_BDTPNegotiation_Create response to the AF to provide
one or more background data transfer policies and the Background Data Transfer
Reference ID to the AF. The AF stores the Background Data Transfer Reference
ID for the future interaction with the PCF. If the NEF received only one
background transfer policy from the PCF, steps 8-11 are not executed and the
flow proceeds to step 12. Otherwise, the flow proceeds to step 8.
NOTE 5: If the NEF receives only one transfer policy, the AF is not required
to confirm.
8\. The AF invokes the Nnef_BDTPNegotiation_Update service to provide the NEF
Background Data Transfer Reference ID and with the selected background data
transfer policy.
9\. The NEF invokes the Npcf_BDTPolicyControl_Update service to provide the
H-PCF with the selected background data transfer policy and the associated
Background Data Transfer Reference ID.
10\. The H-PCF sends the acknowledge message to the NEF.
11\. The NEF sends the acknowledge message to the AF.
12\. The H-PCF stores the Background Data Transfer Reference ID together with
the new transfer policy and the corresponding network area information in the
UDR by invoking Nudr_DM_Update (BDT Reference id, Policy Data, Background Data
Transfer, updated data). This step is not executed, when the PCF decides to
locally store the transfer policy.
13\. The UDR sends a response to the H-PCF as its acknowledgement.
### 4.16.8 Procedures on interaction between PCF and CHF
#### 4.16.8.1 General
The PCF may interact with the CHF to make PCC decisions based on spending
limits. In Home Routed roaming and Non-roaming case, the H-PCF will interact
with the CHF in HPLMN.
#### 4.16.8.2 Initial Spending Limit Retrieval
This clause describes the signalling flow for the PCF to retrieve the status
of the policy counters available at the CHF and to subscribe to spending limit
reporting (i.e. to notifications of policy counter status changes) by the CHF.
If the PCF provides the list of policy counter identifier(s), the CHF returns
the policy counter status per policy counter identifier provided by the PCF.
If the PCF does not provide the list of policy counter identifier(s), the CHF
returns the policy counter status of all policy counter(s), which are
available for this subscriber.
The Initial Spending Limit Report Retrieval includes all subscriber
Identifiers associated with the UE available at the PCF.
NOTE: If the CHF returns the status of all available policy counters some of
these might not be relevant for a policy decision (e.g. those used in a policy
decision only when roaming).
Figure 4.16.8.2.1: Initial Spending Limit Report Retrieval
1\. The PCF retrieves subscription information that indicates that policy
decisions depend on the status of policy counter(s) held at the CHF and
optionally the list of policy counter identifier(s).
2\. The PCF sends Nchf_SpendingLimitControl_Subscribe if this is the first
time policy counter status information is requested for the user identified by
a SUPI. It includes: the subscriber ID (e.g. SUPI), the EventId \"policy
counter status change\" and, optionally, the list of policy counter
identifier(s) as Event Filter, the Notification Target Address, Event
Reporting Information (continuous reporting).
The CHF responds to the Nchf_SpendingLimitControl_Subscribe service operation
including the Subscription Correlation Id) and as Event Information provides a
policy counter status and optionally pending policy counter statuses and their
activation times, per required policy counter identifier and stores the PCF\'s
subscription to spending limit reports for these policy counters. If no policy
counter identifier(s) was provided the CHF returns the list of the policy
counter status, optionally including pending policy counter statuses and their
activation times, for all policy counter(s), which are available for this
subscriber and stores the PCF\'s subscription to spending limit reports of all
policy counters provided to the PCF.
#### 4.16.8.3 Intermediate Spending Limit Report Retrieval
This clause describes the signalling flow for the PCF to retrieve the status
of additional policy counters available at the CHF or to unsubscribe from
spending limit reporting. If the PCF provides the list of policy counter
identifier(s), the CHF returns the policy counter status per policy counter
identifier provided by the PCF.
NOTE: If the CHF returns the status of all available policy counters some of
these might not be relevant for a policy decision, (e.g. those used in a
policy decision only when roaming).
Figure 4.16.8.3.1: Intermediate Spending Limit Report Retrieval
1\. The PCF determines that policy decisions depend on the status of
additional policy counter(s) held at the CHF or that notifications of policy
counter status changes for some policy counters are no longer required.
2\. The PCF sends Nchf_SpendingLimitControl_Subscribe to the CHF, including
the Subscription Correlation Id, the EventId \"policy counter status change\"
and an updated list of policy counter identifier(s) as EventFilters, that
overrides the previously stored list of policy counter identifier(s).
The CHF responds to the Nchf_SpendingLimitControl_Subscribe service operation
and provides as Event Information the policy counter status and optionally
pending policy counter statuses and their activation times, per required
policy counter identifier and stores or removes the PCF\'s subscription to
spending limit reporting by comparing the updated list with the existing PCF
subscriptions. If no policy counter identifier(s) was provided, the CHF
returns the policy counter status, optionally including pending policy counter
statuses and their activation times, for all policy counter(s), which are
available for this subscriber and stores the PCF\'s subscription to spending
limit reports of all policy counters provided to the PCF.
#### 4.16.8.4 Final Spending Limit Report Retrieval
This clause describes the signalling flow for the PCF to cancel the
subscriptions to status changes for the policy counters available at the CHF.
Figure 4.16.8.4.1: Final Spending Limit Report Retrieval
1\. The PCF decides that notifications of policy counter status changes are no
longer needed.
2\. The PCF sends Nchf_SpendingLimitControl_Unsubscribe including the
SubscriptionCorrelationId to the CHF to cancel the subscription to
notifications of policy counter status changes from the CHF.
3\. The CHF removes the PCF\'s subscription to spending limit reporting and
responds to the Nchf_SpendingLimitControl_Unsubscribe service operation to the
PCF.
#### 4.16.8.5 Spending Limit Report
This clause describes the signalling flow for the CHF to notify the change of
the status of the subscribed policy counters available at the CHF for that
subscriber. Alternatively, the signalling flow can be used by the CHF to
provide one or more pending statuses for a subscribed policy counter together
with the time they have to be applied.
Figure 4.16.8.5.1: Spending Limit Report
1\. The CHF detects that the status of a policy counter(s) has changed and the
PCF subscribed to notifications of changes in the status of this policy
counter. Alternatively, the CHF may detect that a policy counter status will
change at a future point in time and decides to instruct the PCF to apply one
or more pending statuses for a requested policy counter.
2\. The CHF sends Nchf_SpendingLimitControl_Notify with the SUPI, Notification
Target Address and in the Event Information the policy counter status and
optionally pending policy counter statuses and their activation times, for
each policy counter that has changed and for which the PCF subscribed to
spending limit reporting. Alternatively, the CHF sends one or more pending
statuses for any of the subscribed policy counters together with the time they
have to be applied.
3\. The PCF acknowledges sending Nchf_SpendingLimitControl_Notify response and
takes that information into account as input for a policy decision.
#### 4.16.8.6 CHF report the removal of the subscriber
This clause describes the signalling flow for the CHF to report the removal of
the subscriber.
Figure 4.16.8.6-1: CHF report the removal of the subscriber
1\. The CHF decides that a subscriber is removed.
2\. The CHF sends the Nchf_SpendingLimitControl_Notify Request to H-PCF to
notify the removal of the subscriber. The H-PCF removes the subscription to
notification of policy counter status from CHF.
NOTE: Notification on the removing of a subscriber causes the H-PCF to make
the applicable policy decision and act accordingly.
3\. The H-PCF responds to CHF using Nchf_SpendingLimitControl_Notify to
acknowledge the receiving of the notification.
### 4.16.9 Update of the subscription information in the PCF
Figure-4.16.9-1: Procedure for update of the subscription information in the
PCF
NOTE: The V-PCF is not used for session management related policy decisions in
this procedure.
0\. The PCF performs the subscription to notification to the profile modified
in the UDR by invoking Nudr_DM_Subscribe (Policy Data, SUPI, Notification
Target Address (+ Notification Correlation Id), Event Reporting Information
(continuous reporting), one or several of the following: \"PDU Session Policy
Control data\", \"Accumulated Usage data\" or \"UE context Policy Control
data\") service.
1\. The UDR detects that the related subscription profile has been changed.
2\. If subscribed by the PCF, the UDR notifies the PCF on the changed profile
by invoking Nudr_DM_Notify (Notification Correlation Id, Policy Data, SUPI,
updated data and one or several of the following data subtypes \"PDU Session
Policy Control Data\" or \"Accumulated Usage Data\" or \"UE Context Policy
Control data\") service.
3\. The PCF stores the updated profile.
4\. If the updated subscriber profile requires the status of new policy
counters available at the CHF then an Initial/Intermediate Spending Limit
Report Retrieval is initiated by the PCF as defined in clauses 4.16.8,2 and
4.16.8.3. If the updated subscriber profile implies that no policy counter
status is needed an Intermediate Spending Limit Report Request Retrieval is
initiated by the PCF to unsubscribe or, if this is the last policy counter
status, a Final Spending Limit Report Retrieval is initiated by the PCF as
specified in clause 4.16.8.4.
5\. PCF makes an authorization and policy decision.
6\. The PCF provides new session management related policy decisions to the
SMF, using the Policy related interaction in PDU Session Modification
procedure in clause 4.16.6, new access and mobility related policy information
or new UE access selection and PDU Session selection related policy
information to the AMF using the UE Context Modification procedure in clause
4.16.2.
### 4.16.10 Void
### 4.16.11 UE Policy Association Establishment
This procedure concerns the following scenarios:
1\. UE initial registration with the network.
2\. The AMF relocation with PCF change in handover procedure and registration
procedure.
3\. UE registration with 5GS when the UE moves from EPS to 5GS and there is no
existing UE Policy Association between AMF and PCF for this UE.
Figure 4.16.11-1: UE Policy Association Establishment
This procedure concerns both roaming and non-roaming scenarios.
In the non-roaming case the V-PCF is not involved and the role of the H-PCF is
performed by the PCF. For the roaming scenarios, the V-PCF interacts with the
AMF and the H-PCF interacts with the V-PCF:
1\. The AMF establishes UE Policy Association with the (V-)PCF if a UE Policy
Container is received from the UE. If a UE Policy Container is not received
from the UE, the AMF may establish UE Policy Association with the (V-)PCF
based on AMF local configuration.
NOTE 1: In the roaming scenario, the AMF local configuration can indicate
whether UE Policy delivery is needed based on the roaming agreement with home
PLMN of the UE.
2\. The AMF sends a Npcf_UEPolicyControl Create Request with the following
information: SUPI, may include Access Type and RAT, PEI, ULI, UE time zone,
Serving Network and UE Policy Container (the list of stored PSIs, operating
system identifier, Indication of UE support for ANDSP). In roaming scenario,
based on operator policies, the AMF may provide to the V-PCF the PCF ID of the
selected H-PCF. The V-PCF contacts the H-PCF. In roaming case, steps 3 and 4
are executed, otherwise step 5 follows.
3\. The V-PCF forwards the information received from AMF in step 2 to the
H-PCF. When a UE Policy Container is received at initial registration, the
H-PCF may store the PEI, the OSId or the indication of UE support for ANDSP in
the UDR using Nudr_DM_Create including DataSet \"Policy Data\" and Data Subset
\"UE context policy control data\".
4\. The H-PCF sends a Npcf_UEPolicyControl Create Response to the V-PCF. The
H-PCF may provide the Policy Control Request Trigger parameters in the
Npcf_UEPolicyControl Create Response.
5\. The (V-) PCF sends a Npcf_UEPolicyControl Create Response to the AMF. The
(V-)PCF relays the Policy Control Request Trigger parameters in the
Npcf_UEPolicyControl Create Response.
The (V-)PCF subscribes to notification of N1 message delivery of policy
information to the UE.
6\. The (H-)PCF gets policy subscription related information and the latest
list of PSIs from the UDR using Nudr_DM_Query service operation (SUPI, Policy
Data, UE context policy control data, Policy Set Entry) if either or both are
not available and makes a policy decision. The (H-)PCF may get the PEI, the
OSId or the indication of UE support for ANDSP in the UDR using Nudr_DM_Query
including DataSet \"Policy Data\" and Data Subset \"UE context policy control
data\" if the AMF relocates and the PCF changes. The (H-)PCF may request
notifications from the UDR on changes in the subscription information by
invoking Nudr_DM_Subscribe (Policy Data, SUPI, DNN, S-NSSAI, Notification
Target Address (+ Notification Correlation Id), Event Reporting Information
(continuous reporting), UE context policy control data) service. The (H-)PCF
creates the UE policy container including UE access selection and PDU Session
selection related policy information as defined in clause 6.6 of TS 23.503
[20] and in the case of roaming H-PCF, provides the UE policy container in the
Npcf_UEPolicyControl UpdateNotify Request.
7\. The V-PCF sends a response to H-PCF using Npcf_UEPolicyControl
UpdateNotify Response.
NOTE 2: Step 6 (and 7) can be omitted. Then the (H-)PCF creates the UE policy
container including UE access selection and PDU Session selection polices in
step 2 (in the case of non-roaming) or step 3 (in the case of roaming). This
means that the potential interactions with UDR as in step 6 will have to be
executed in step 2 (non-roaming) or step 3 (roaming).
8\. The (V-)PCF triggers UE Configuration Update Procedure in clause 4.2.4.3
to sends the UE policy container including UE access selection and PDU Session
selection related policy information to the UE. The (V-)PCF checks the size
limit as described in clause 6.1.2.2.2 of TS 23.503 [20].
9\. If the V-PCF received notification of the reception of the UE Policy
container then the V-PCF forwards the notification response of the UE to the
H-PCF using Npcf_UEPolicyControl_Update Request.
10\. The H-PCF sends a response to the V-PCF.
### 4.16.12 UE Policy Association Modification
#### 4.16.12.1 UE Policy Association Modification initiated by the AMF
##### 4.16.12.1.1 UE Policy Association Modification initiated by the AMF
without AMF relocation
This procedure addresses the scenario where a Policy Control Request Trigger
condition is met.
Figure 4.16.12.1.1-1: UE Policy Association Modification initiated by the AMF
This procedure concerns both roaming and non-roaming scenarios.
In the non-roaming case the V-PCF is not involved. In the roaming case, the
AMF interacts with the V-PCF and the H-PCF interacts with the V-PCF.
1\. When a Policy Control Request Trigger condition is met the AMF updates UE
Policy Control Association and provides information on the conditions that
have changed to the PCF. The AMF sends a Npcf_UEPolicyControl Update Request
with the following information: UE Policy Association ID associated with the
SUPI defined in TS 29.525 [49] and the Policy Control Request Trigger met. In
roaming scenario, based on operator policies, the AMF may provide to the V-PCF
the PCF ID of the selected H-PCF. The V-PCF contacts the H-PCF.
In the roaming case, steps 2 and 3 are executed, otherwise step 4 follows.
2\. The V-PCF forwards the information received from AMF in step 1 to the
(H-)PCF.
3\. The H-PCF replies to the V-PCF.
4\. The (V-) PCF sends a Npcf_UEPolicyControl Update Response to the AMF.
5\. The (H-)PCF may create the UE policy container including UE access
selection and PDU Session selection related policy information as defined in
clause 6.6 of TS 23.503 [20]. In the case of roaming the H-PCF may include the
UE policy container in the Npcf_UEPolicyControl UpdateNotify Request.
6\. The (V-)PCF sends a response to H-PCF using Npcf_UEPolicyControl
UpdateNotify Response.
Steps 7, 8 and 9 are the same as steps 8, 9 and 10 of procedure UE Policy
Association Establishment in clause 4.16.11.
##### 4.16.12.1.2 UE Policy Association Modification with old PCF during AMF
relocation
This procedure addresses the scenario where a UE Policy Association
Modification with the old PCF during AMF relocation.
Figure 4.16.2.1.2-1: Policy Association Modification with the old PCF during
AMF relocation
This procedure addresses both roaming and non-roaming scenarios.
In the non-roaming case the V-PCF is not involved. In the roaming case, the
AMF interacts with the V-PCF and the V-PCF interacts with the H-PCF.
1\. [Conditional] When the old AMF and the new AMF belong to the same PLMN,
the old AMF transfers to the new AMF the UE Policy Association information
including policy control request trigger(s) and the PCF ID(s). For the roaming
case, the new AMF receives both V-PCF ID and H-PCF ID.
2\. Based on local policies, the new AMF decides to re-use the UE policy
association for the UE Context with the (V-)PCF and contacts the (V-)PCF
identified by the PCF ID received in step 1.
NOTE: The scenario that only the H-PCF is reused by the new AMF but the V-PCF
is not reused is not considered in this Release.
3\. The new AMF sends Npcf_UEPolicyControl_Update to the (V-)PCF to update the
UE policy association with the (V-)PCF. If a Policy Control Request Trigger
condition is met, the information matching the trigger condition may also be
provided by the new AMF.
In the roaming case, step 4 and 5 are executed, otherwise step 6 follows.
4\. The V-PCF forwards the information received from new AMF in step 3 to the
(H-)PCF.
5\. The H-PCF replies to the V-PCF.
6\. The (V-)PCF updates the stored information provided by the old AMF with
the information provided by the new AMF. The (V-)PCF sends a
Npcf_UEPolicyControl Update Response to the AMF.
7\. The (H-)PCF may create the UE policy container including UE access
selection and PDU Session selection related policy information as defined in
clause 6.6 of TS 23.503 [20]. In the case of roaming the H-PCF may include the
UE policy container in the Npcf_UEPolicyControl UpdateNotify Request.
8\. The V-PCF sends a response to H-PCF using Npcf_UEPolicyControl
UpdateNotify Response.
Steps 9, 10 and 11 are the same as steps 8, 9 and 10 of procedure UE Policy
Association Establishment in clause 4.16.11.
#### 4.16.12.2 UE Policy Association Modification initiated by the PCF
This procedure is used to update UE policy and/or UE policy triggers.
Figure 4.16.12.2-1: UE Policy Association Modification initiated by the PCF
This procedure concerns both roaming and non-roaming scenarios.
In the non-roaming case the V-PCF is not involved and the role of the H-PCF is
performed by the PCF. In the roaming case, the H-PCF provides UE access
selection and PDU Session selection policy decision and provides the policy to
the AMF via V-PCF.
1a and 1b. If (H-)PCF subscribed to notification of subscriberÂ´s policy data
change and a change is detected, the UDR notifies that the subscriberÂ´s policy
data of a UE has been changed.
The UDR notifies the (H-)PCF of the updated policy control subscription
information profile via Nudr_DM_Notify (Notification correlation Id, Policy
Data, either UE context policy control data or Policy Set Entry data, or both,
SUPI), or
the (V-)UDR notifies the (V-)PCF of the updated policy control subscription
information profile via Nudr_DM_Notify (Notification correlation Id, Policy
Data, PolicySetEntry Data. PLMN ID).
1c and 1d. PCF determines locally that UE Access selection and PDU session
selection policy information needs to be sent to the UE.
2a and 2b. The PCF makes the policy decision.
3\. The (H-)PCF may create the UE policy container including UE access
selection and PDU Session selection related policy information as defined in
clause 6.1.2.2.2 of TS 23.503 [20]. In the case of roaming, the H-PCF may send
the UE policy container in the Npcf_UEPolicyControl UpdateNotify Request. The
H-PCF may provide updated policy control triggers for the UE policy
association.
4\. The V-PCF sends a response to H-PCF using Npcf_UEPolicyControl
UpdateNotify Response.
5\. The (V-)PCF provides the Policy Control Request Trigger parameters in the
Npcf_UEPolicyControl UpdateNotify Request to the AMF. In the case of roaming,
the V-PCF may also provide UE Access selection and PDU session selection
related policy information to the UE. The V-PCF may also provide updated
policy control triggers for the UE policy association to the AMF.
6\. The AMF sends a response to (V-)PCF.
Steps 7, 8 and 9 are the same as steps 8, 9 and 10 of procedure UE Policy
Association Establishment in clause 4.16.11.
### 4.16.13 UE Policy Association Termination
#### 4.16.13.1 AMF-initiated UE Policy Association Termination
The following case is considered for UE Policy Association Termination:
1\. UE Deregistration from the network.
2\. The mobility with change of AMF (e.g. new AMF is in different PLMN or new
AMF in the same PLMN).
3\. [Optional] 5GS to EPS mobility with N26 if the UE is not connected to the
5GC over a non-3GPP access in the same PLMN.
Figure 4.16.13.1-1: AMF-initiated UE Policy Association Termination
This procedure concerns both roaming and non-roaming scenarios.
In the non-roaming case, the V-PCF is not involved and the role of the H-PCF
is performed by the PCF. For the roaming scenarios, the V PCF interacts with
the AMF. The V PCF contacts the H-PCF to request removing UE Policy
Association.
1\. The AMF decides to terminate the UE Policy Association.
2\. The AMF sends the Npcf_UEPolicyControl_Delete service operation including
UE Policy Association ID to the (V-)PCF.
3\. The (V-)PCF removes the policy context for the UE and replies to the AMF
with an Acknowledgement including success or failure. The V-PCF may interact
with the H-PCF. The (V-)PCF may unsubscribe to subscriber policy data changes
with UDR by Nudr_DM_Unsubscribe (Subscription Correlation Id). The AMF removes
the UE Policy Context.
Step 4 and Step 5 apply only to the roaming case.
4\. The V-PCF sends the Npcf_UEPolicyControl_Delete service operation
including UE Policy Association ID to the H-PCF.
5\. The H-PCF removes the policy context for the UE and replies to the V-PCF
with an Acknowledgement including success or failure. The H-PCF may
unsubscribe to subscriber policy data changes with UDR by Nudr_DM_Unsubscribe
(Subscription Correlation Id) for subscriber policy changes.
#### 4.16.13.2 PCF-initiated UE Policy Association Termination
Figure 4.16.13.2-1: PCF-initiated UE Policy Association Termination
This procedure concerns both roaming and non-roaming scenarios.
In the non-roaming case, the V-PCF is not involved and the role of the H-PCF
is performed by the PCF. For the roaming scenarios, the H-PCF interacts with
the V-PCF to request removing Policy Association.
The PCF is subscribed to notification of changes in Data Set \"Policy Data\"
for a UE Policy Association ID.
1\. The Policy data is removed, either the Data Set \"Policy Data\" or the
Data Subset \"UE context policy control\".
2\. The UDR sends the Nudr_DM_Notify_Request (Notification correlation Id,
Policy Data, SUPI, UE Context Policy Control data, updated data) including the
SUPI, the Data Set Identifier, the Data Subset Identifier and the Updated Data
including empty \"Policy Data\" or empty \"UE context policy control\".
3\. The PCF sends the Nudr_DM_Notify_Response to confirm reception and the
result to UDR.
4\. The PCF may notify the AMF of the removal of the UE Policy Association via
Npcf_UEPolicyControl_UpdateNotify service operation. Alternatively, the PCF
may decide to maintain the Policy Association if a default profile is applied,
in this case steps 4, 5 and 6 are not executed.
5\. The AMF acknowledges the operation.
6\. Steps 2-5 in clause 4.16.13.1 AMF-initiated UE Policy Association
Termination are performed to remove the UE Policy Association for this UE and
the subscription to Policy Control Request Triggers for that UE Policy
Association.
## 4.17 Network Function Service Framework Procedure
### 4.17.1 NF service Registration
NOTE: The term \"NF service consumer\" in this clause refers to the consumer
of the NRF services and should not be confused with the role of the NF
(consumer or producer).
Figure 4.17.1-1: NF Service Registration procedure
1\. NF service consumer, i. e. an NF instance sends
Nnrf_NFManagement_NFRegister Request message to NRF to inform the NRF of its
NF profile when the NF service consumer becomes operative for the first time.
See clause 5.2.7.2.2 for relevant NF profile parameters
NOTE 1: NF service consumer\'s NF profile is configured by OAM system.
2\. The NRF stores the NF profile of NF service consumer and marks the NF
service consumer available.
NOTE 2: Whether the NF profile sent by NF service consumer to NRF needs to be
integrity protected by the NF service consumer and verified by the NRF is to
be decided by SA3.
3\. The NRF acknowledge NF Registration is accepted via
Nnrf_NFManagement_NFRegister response.
### 4.17.2 NF service update
Figure 4.17.2-1: NF Service Update procedure
1\. NF service consumer i.e. an NF instance sends Nnrf_NFManagement_NFUpdate
Request message (the updated NF profile of NF service consumer) to NRF to
inform the NRF of its updated NF profile (e.g. with updated capacity) when
e.g. triggered after a scaling operation. See clause 5.2.7.2.3 for relevant
input and output parameters.
NOTE: The updated NF profile of NF instance are configured by OAM system.
2\. The NRF updates the NF profile of NF service consumer.
3\. The NRF acknowledge NF Update is accepted via Nnrf_NFManagement_NFUpdate
response.
### 4.17.3 NF service deregistration
Figure 4.17.3-1: NF Service Deregistration procedure
1\. NF service consumer i.e. an NF instance sends
Nnrf_NFManagement_NFDeregister Request message to NRF to inform the NRF of its
unavailability when e.g. it\'s about to gracefully shut down or disconnect
from the network.
2\. The NRF marks the NF service consumer unavailable. NRF may remove the NF
profile of NF service consumer according to NF management policy.
3\. The NRF acknowledge NF Deregistration is accepted via
Nnrf_NFManagement_NFDeregister response.
### 4.17.4 NF/NF service discovery in the same PLMN
Figure 4.17.4-1: NF/NF service discovery in the same PLMN
1\. The NF service consumer intends to discover services available in the
network based on service name and target NF type. The NF service consumer
invokes Nnrf_NFDiscovery_Request (Expected NF service Name, NF Type of the
expected NF instance, NF type of the NF consumer) from an appropriate
configured NRF in the same PLMN. The parameter may include optionally SUPI,
Data Set Identifier(s), External Group ID (for UDM, UDR discovery), UE\'s
Routing Indicator (for UDM and AUSF discovery), S-NSSAI, NSI ID if available
and other service related parameters. In addition, for AMF discovery, the
parameters may include AMF Region ID, AMF Set ID, TAI. The NF service consumer
may indicate a preference for target NF location in the
Nnrf_NFDiscovery_Request. A complete list of parameters is provided in service
definition in clause 5.2.7.3.2.
NOTE 1: The NF service consumer indicates its NF location for preference for
target NF location.
NOTE 2: The use of NSI ID within a PLMN depends on the network deployment.
NOTE 3: The need for other service related parameters depends on the NF type
of the expected NF instance(s) and refer to the clause 6.3 \" Principles for
Network function and Network Function Service discovery and selection\" in TS
23.501 [2]. It is up to NF implementation whether one or multiple NF service
instances are registered in the NRF.
2\. The NRF authorizes the Nnrf_NFDiscovery_Request. Based on the profile of
the expected NF/NF service and the type of the NF service consumer, the NRF
determines whether the NF service consumer is allowed to discover the expected
NF instance(s). If the expected NF instance(s) or NF service instance(s) are
deployed in a certain network slice, NRF authorizes the discovery request
according to the discovery configuration of the Network Slice, e.g. the
expected NF instance(s) are only discoverable by the NF in the same network
slice.
3\. If allowed, the NRF determines a set of NF instance(s) matching the
Nnrf_NFDiscovery_Request and internal policies of the NRF and sends the NF
profile(s) of the determined NF instances. Each NF profile containing at least
the output required parameters (see clause 5.2.7.3.2) to the NF service
consumer via Nnrf_NFDiscovery_Request Response message.
If the target NF is UDR, UDM or AUSF, if SUPI was used as optional input
parameter in the request, the NRF shall provide the corresponding UDR, UDM or
AUSF instance(s) that matches the optional input SUPI. Otherwise, if SUPI is
not provided in the request, the NRF shall return all applicable UDR
instance(s) (e.g. based on the Data Set Id, NF type), UDM instance(s) or AUSF
instance(s) (e.g. based on NF type) and if applicable, the information of the
range of SUPI(s) and/or Data Set Id each UDR instance is supporting.
If the target NF is CHF, if SUPI, GPSI or PLMN ID was used as optional input
parameter in the request, the NRF shall provide the corresponding CHF
instance(s) that matches the optional input SUPI, GPSI or PLMN ID. The NRF
shall provide the primary CHF instance and the secondary CHF instance pair(s)
together. Otherwise, if neither SUPI/PLMN ID nor GPSI is provided in the
request, the NRF shall return all applicable CHF instance(s) and if
applicable, the information of the range of SUPI(s), GPSI(s) or PLMN ID(s).
If the NF service consumer provided a preferred target NF location, the NRF
shall not limit the set of discovered NF instances or NF service instance(s)
to the target NF location, e.g. the NRF may provide NF instance(s) or NF
service instance(s) for which location is not the preferred target NF location
if no NF instance or NF service instance could be found for the preferred
target NF location.
### 4.17.5 NF/NF service discovery across PLMNs
In the case that the NF service consumer intends to discover the NF/NF service
in home PLMN, the NRF in serving PLMN needs to request \"NF Discovery\"
service from NRF in the home PLMN. The procedure is depicted in the figure
below:
Figure 4.17.5-1: NF/NF service discovery across PLMNs
1\. The NF service consumer in the serving PLMN invokes
Nnrf_NFDiscovery_Request (Expected Service Name, NF type of the expected NF,
home PLMN ID, serving PLMN ID, NF type of the NF service consumer) to an
appropriate configured NRF in the serving PLMN. The request may also include
optionally S-NSSAI, NSI ID if available and other service related parameters.
A complete list of parameters is provided in service definition in clause
5.2.7.3.2.
NOTE 1: The use of NSI ID within a PLMN depends on the network deployment.
2\. The NRF in serving PLMN identifies NRF in home PLMN (hNRF) based on the
home PLMN ID and it requests \"NF Discovery\" service from NRF in home PLMN
according the procedure in Figure 4.17.4-1 to get the expected NF profile(s)
of the NF instance(s) deployed in the home PLMN. As the NRF in the serving
PLMN triggers the \"NF Discovery\" on behalf of the NF service consumer, the
NRF in the serving PLMN shall not replace the information of the service
requester NF, i.e. NF consumer ID, in the Discovery Request message it sends
to the hNRF.
The hNRF may further query an appropriate local NRF in the home PLMN based on
the input information received from NRF of the serving PLMN. The FQDN of the
local NRF or Endpoint Address of local NRF\'s NF Discovery service in the home
PLMN may be configured in the hNRF or may need to be discovered based on the
input information.
3\. The NRF in serving PLMN provides same as step 3 in clause 4.17.4 applies.
### 4.17.6 SMF Provisioning of available UPFs using the NRF
#### 4.17.6.1 General
This clause describes the provisioning of available UPFs in SMF using the NRF
as documented in clause 6.3.3 of TS 23.501 [2].
This optional node-level step takes place prior to selecting the UPF for PDU
Sessions and may be followed by N4 Node Level procedures defined in clause
4.4.3 where the UPF and the SMF exchange information such as the support of
optional functionalities and capabilities.
As an option, UPF(s) may register in the NRF. This registration phase uses the
Nnrf_NFManagement_NFRegister operation and hence does not use N4.
For the purpose of SMF provisioning of available UPFs, the SMF uses the
Nnrf_NFDiscovery service to learn about available UPFs.
NOTE 1: The protocol used by UPF to interact with NRF is described in TS
29.510 [37]
UPFs may be associated with UPF Provisioning Information in the NRF. The UPF
Provisioning Information consists of:
\- a list of (S-NSSAI, DNN);
\- UE IPv4 Address Ranges and/or IPv6 Prefix Range(s) per (S-NSSAI, DNN); and
NOTE 2: The above information can be used by the SMF for UPF selection when
static IP address/prefix allocation is required for a UE.
\- a SMF Area Identity the UPF can serve. The SMF Area Identity allows
limiting the SMF provisioning of UPF(s) using NRF to those UPF(s) associated
with a certain SMF Area Identity. This can e.g. be used if an SMF is only
allowed to control UPF(s) configured in NRF as belonging to a certain SMF Area
Identity.
The SMF Area Identity and UE IPv4 Address Ranges and/or IPv6 Prefix Range(s)
are optional in the UPF Provisioning Information.
#### 4.17.6.2 SMF provisioning of UPF instances using NRF
This procedure applies when a SMF wants to get informed about UPFs available
in the network and supporting a list of parameters.
Figure 4.17.6.2-1: SMF provisioning of UPF instances using NRF procedure
The following takes place when an SMF expects to be informed of UPFs available
in the network:
1 The SMF issues a Nnrf_NFManagement_NFStatusSubscribe Service Operation
providing the target UPF Provisioning Information it is interested in.
2 The NRF issues Nnrf_NFManagement_NFStatusNotify with the list of all UPFs
that currently meet the SMF subscription. This notification indicates the
subset of the target UPF Provisioning Information that is supported by each
UPF.
The following takes place when a new UPF instance is deployed:
3 At any time a new UPF instance is deployed.
4 The UPF instance is configured with the NRF identity to contact for
registration and with its UPF Provisioning Information. An UPF is not required
to understand the UPF Provisioning Information beyond usage of this
information to register in step 5.
5 The UPF instance issues an Nnrf_NFManagement_NFRegister Request operation
providing its NF type, the FQDN or IP address of its N4 interface and the UPF
Provisioning Information configured in step 4.
6\. Alternatively (to steps 4 and 5) OAM registers the UPF on the NRF
indicating the same UPF Provisioning Information as provided in step 5. This
configuration mechanism is out of scope of this specification.
7\. Based on the subscription in step 1, the NRF issues
Nnrf_NFManagement_NFStatusNotify to all SMFs with a subscription matching the
UPF Provisioning Information of the new UPF
### 4.17.7 NF/NF service status subscribe/notify in the same PLMN
Figure 4.17.7-1: NF/NF service status subscribe/notify in the same PLMN
1\. The NF service consumer subscribes to be notified of newly
registered/updated/deregistered NF instances along with its NF services. The
NF service consumer invokes Nnrf_NFManagement_NFStatusSubscribe Request from
an appropriate configured NRF in the same PLMN.
2\. The NRF authorizes the Nnrf_NFManagement_NFStatusSubscribe Request. Based
on the profile of the expected NF/NF service and the type of the NF service
consumer, the NRF determines whether the NF service consumer is allowed to
subscribe to the status of the target NF instance(s) or NF service
instance(s).
3\. If allowed, the NRF acknowledges the execution of
Nnrf_NFManagement_NFStatusSubscribe Request.
4\. NRF notifies about newly registered/updated/deregistered NF instances
along with its NF services to the subscribed NF service consumer.
NOTE: The NF service consumer unsubscribes to receive NF status notifications
invoking Nnrf_NFManagement_NFStatusUnSubscribe service operation.
### 4.17.8 NF/NF service status subscribe/notify across PLMNs
In the case that the NF service consumer intends to subscribe to the status of
NF/NF service instance(s) in home PLMN, the NRF in serving PLMN needs to
request \"NF status subscribe\" service from NRF in the home PLMN. The
notification is sent from the NRF in the home PLMN to the NF service consumer
in the serving PLMN without the involvement of the NRF in the serving PLMN.
The procedure is depicted in the figure below:
Figure 4.17.8-1: NF/NF service status subscribe/notify across PLMNs
NOTE 1: The NRF in the home PLMN communicates with the NRF and the NF consumer
in the serving PLMN via the SEPPs in the respective PLMNs. For the sake of
clarity, SEPPs are not depicted in the flow.
1\. The NF service consumer in the serving PLMN invokes
Nnrf_NFManagement_NFStatusSubscribe Request from an appropriate configured NRF
in the serving PLMN.
2\. The NRF in serving PLMN identifies NRF in home PLMN (hNRF) based on the
home PLMN ID and it requests \"NF status subscribe\" service from NRF in home
PLMN. As the NRF in the serving PLMN triggers the \"NF status subscribe\" on
behalf of the NF service consumer, the NRF in the serving PLMN shall not
replace the information of the service requester NF, i.e. NF consumer ID, in
the status subscribe Request message it sends to the hNRF.
3\. The NRF in serving PLMN acknowledges the execution of
Nnrf_NFManagement_NFStatusSubscribe Request to the NF consumer in the serving
PLMN.
4\. NRF in the home PLMN notifies about newly registered/updated/deregistered
NF instances along with its NF services to the subscribed NF service consumer
in the serving PLMN.
NOTE 2: The NF service consumer unsubscribes to receive NF status
notifications invoking Nnrf_NFManagement_NFStatusUnSubscribe service
operation.
## 4.18 Procedures for Management of PFDs
### 4.18.1 General
NOTE: The PFDF service is functionality within the NEF.
### 4.18.2 PFD management via NEF (PFDF)
Figure 4.18.2-1 procedure for PFD management via NEF (PFDF)
1\. The AF invokes the Nnef_PFDManagement_Create/Update/Delete service. The
Allowed Delay is an optional parameter. If the Allowed Delay is included, it
indicates that the list of PFDs in this request should be deployed within the
time interval indicated by the Allowed Delay.
2\. NEF checks whether the Application is authorized to perform this request
based on the operator policies.
3\. The NEF (PFDF) invokes the Nudr_DM_Create/Update/Delete (Application
Identifier, one or more sets of PFDs, Allowed Delay) to the UDR.
4\. The UDR updates the list of PFDs for the Application Identifier.
5\. The UDR sends a Nudr_DM_Create/Update/Delete Response to the NEF (PFDF).
6\. The NEF sends Nnef_PFDManagement_Create/Update/Delete Response to the
Application Function.
### 4.18.3 PFD management in the SMF
#### 4.18.3.1 PFD Retrieval by the SMF
This procedure enables the SMF to retrieve PFDs for an Application Identifier
from the NEF (PFDF) when a PCC rule with this Application Identifier is
provided/activated and PFDs provided by the NEF (PFDF) are not available at
the SMF.
In addition, this procedure enables the SMF to retrieve PFDs from the NEF
(PFDF)when the caching timer for an Application Identifier elapses and a PCC
Rule for this Application Identifier is still active.
The NEF (PFDF) retrieves the PFDs from UDR unless already available in NEF
(PFDF).
The SMF may retrieve PFDs for one or more Application Identifiers in the same
Request. All PFDs related to an Application Identifier are provided in the
response from the UDR to NEF (PFDF).
Figure 4.18.3.1-1 PFD Retrieval by the SMF
1\. SMF invokes the Nnef_PFDManagement_Fetch (Application Identifier (s)) to
the NEF (PFDF).
2\. NEF (PFDF) checks if the PFDs for the Application Identifier (s) are
available in the NEF (PFDF), if available, the NEF (PFDF) skips to step 4\. If
not, the NEF (PFDF) invokes Nudr_DM_Query (Application Identifier (s)) to
retrieve the PFD(s) from UDR.
3\. The UDR provides a Nudr_DM_Query response (Application Identifier(s),
PFD(s)) to the NEF (PFDF).
4\. The NEF (PFDF) replies to the SMF with Nnef_PFDManagement_Fetch
(Application Identifier(s), PFD(s)).
#### 4.18.3.2 Management of PFDs in the SMF
This procedure enables the provisioning, modification or removal of PFDs
associated with an application identifier in the SMF. Either the complete list
of all PFDs of all application identifiers, the complete list of all PFDs of
one or more application identifiers or a subset of PFDs for individual
application identifiers may be managed.
Each PFD of an application identifier is associated with a PFD id if a subset
of the PFD(s) associated with an application identifier can be provisioned,
updated or removed. If always the full set of PFD(s) for an application
identifier is managed in each transaction, PFD ids do not need to be provided.
Figure 4.18.3.2-1 Management of PFDs in the SMF
1\. The NEF (PFDF) invokes Nnef_PFD_Management_Notify (Application Identifier,
PFDs, PFDs operation) to the SMF(s) to which the PFD(s) shall be provided. The
NEF (PFDF) may decide to delay the distribution of PFDs to the SMF(s) for some
time to optimize the signalling load. If the NEF (PFDF) received an Allowed
Delay for a PFD, the NEF (PFDF) shall distribute this PFD within the indicated
time interval.
## 4.19 Network Data Analytics
### 4.19.1 Network data analytics Subscribe/Unsubscribe
This procedure is used by the NF service consumer (e.g. PCF) to
subscribe/unsubscribe at NWDAF to be notified on load level information of a
network slice instance. Periodic notification and notification upon threshold
exceeded can be subscribed. The NF service consumer may make policy decisions
based on the load level information of network slice instance.
Figure 4.19.1-1: Network data analytics Subscribe/unsubscribe
1\. The NF service consumer subscribes to or cancels subscription to load
level information by invoking the Nnwdaf_EventsSubscription_Subscribe/
Nnwdaf_EventsSubscription_Unsubscribe service operation with an identifier of
the network slice instance.
2\. If NF service consumer subscribes to load level information, the NWDAF
notifies the NF service consumer with the load level information by invoking
Nnwdaf_EventsSubscription_Notify service operation.
### 4.19.2 Network data analytics Request
This procedure is used by the NF service consumer (e.g. PCF) to request and
get from NWDAF load level information for a particular Network Slice instance.
The NF service consumer may make policy decision based on load level
information for the network slice instance.
Figure 4.19.2-1: Network data analytics Request
1\. The NF service consumer requests load level information for a particular
network slice instance by invoking Nnwdaf_AnalyticsInfo_Request service
operation with an identifier of the network slice instance.
2\. The NWDAF responds with load level information for the particular network
slice instance.
## 4.20 UE Parameters Update via UDM Control Plane Procedure
### 4.20.1 General
The purpose of the control plane solution for update of UE parameters is to
allow the HPLMN to update the UE with a specific set of parameters, generated
and stored in the UDM, by delivering protected UDM Update Data via NAS
signalling. The HPLMN updates such parameters based on the operator policies.
The UDM Update Data that the UDM delivers to the UE may contain:
\- one or more UE parameters including:
\- the updated Default Configured NSSAI (final consumer of the parameter is
the ME).
\- the updated Routing Indicator Data (final consumer of the parameter is the
USIM).
\- a \"UE acknowledgement requested\" indication.
\- a \"re-registration requested\" indication.
### 4.20.2 UE Parameters Update via UDM Control Plane Procedure
Figure 4.20.2-1: UE Parameters Update via UDM Control Plane Procedure
1\. From UDM to the AMF: The UDM notifies the changes of the information
related to the UE to the affected AMF by the means of invoking
Nudm_SDM_Notification service operation. The Nudm_SDM_Notification service
operation contains the UDM Update Data (e.g. \"Routing Indicator update
data\", \"Default Configured NSSAI update data\") that needs to be delivered
transparently to the UE over NAS within the Access and Mobility Subscription
data. The UDM update data includes:
\- The updated parameters to be delivered to the UE (e.g. the updated Routing
Indicator Data, the Default Configured NSSAI).
\- whether the UE needs to send an ack to the UDM.
\- whether the UE needs to re-register after updating the data.
2\. From AMF to the UE: the AMF sends a DL NAS TRANSPORT message to the served
UE. The AMF includes in the DL NAS TRANSPORT message the transparent container
received from the UDM. The UE verifies based on mechanisms defined in TS
33.501 [15] that the UDM Update Data is provided by HPLMN and:
\- If the security check on the UDM Update Data is successful, as defined in
TS 33.501 [15] the UE either stores the information and uses those parameters
from that point onwards, or forwards the information to the USIM; and
\- If the security check on the UDM Update Data fails, the UE discards the
contents of the UDM Update Data.
3\. The UE to the AMF: If the UE has verified that the UDM Update Data is
provided by HPLMN and the UDM has requested the UE to send an ack to the UDM,
the UE sends an UL NAS TRANSPORT message to the serving AMF with a transparent
container including the UE acknowledgement.
4\. The AMF to the UDM: If the AMF receives an UL NAS TRANSPORT message with a
transparent container carrying a UE acknowledgement from the UE, the AMF sends
a Nudm_SDM_Info request message including the transparent container to the
UDM.
5\. If the UDM has requested the UE to re-register, the UE waits until it goes
back to RRC idle and initiates a Registration procedure as defined in TS
24.501 [25].
### 4.20.3 Void
## 4.21 Secondary RAT Usage Data Reporting Procedure
The procedure in Figure 4.21-1 may be used to report Secondary RAT Usage Data
from NG-RAN node to the AMF. It is executed by the NG-RAN node to report the
Secondary RAT Usage Data information towards AMF which is then reported
towards SMF.
The procedure in Figure 4.21-2 may be used to report the Secondary RAT Usage
Data from AMF towards the SMF. Optionally, it is used to report the Secondary
RAT Usage Data from V-SMF to the H-SMF when the reporting to H-SMF is
activated.
Figure 4.21-1: RAN Secondary RAT Usage Data Reporting procedure
1\. The NG-RAN, if it supports Dual Connectivity with Secondary RAT (using NR
radio or E-UTRA radio) and it is configured to report Secondary RAT Usage Data
for the UE, depending on certain conditions documented in this specification,
it shall send a RAN Usage Data Report message to the AMF including the
Secondary RAT Usage Data for the UE. The NG-RAN node will send only one RAN
Usage Report for a UE when the UE is subject to handover by RAN. The RAN Usage
Data Report includes a Handover Flag to indicate when the message is sent
triggered by a handover.
Figure 4.21-2: SMF Secondary RAT Usage Data Reporting procedure
The NG-RAN, if it supports Dual Connectivity with Secondary RAT (using NR
radio or E-UTRA radio) and it is configured to report Secondary RAT usage data
for the UE, it shall include the Secondary RAT usage data for the UE to the
AMF in certain messages depending on certain conditions documented elsewhere
in this TS.
1\. The AMF forwards the N2 SM Information (Secondary RAT Usage Data) to the
SMF in a Nsmf_PDUSession_UpdateSMContext Request.
2\. The V-SMF sends the Nsmf_PDUSession_Update (Secondary RAT Usage Data)
message to the H-SMF.
3\. The H-SMF acknowledges receiving the Secondary RAT Usage data for the UE.
4\. The V-SMF acknowledges receiving the Secondary RAT Usage data back to the
AMF.
# 5 Network Function Service procedures
## 5.1 Network Function Service framework procedures
### 5.1.1 Network Function Service Discovery
The network function (NF) within the core network may expose its capability as
service via its service based interfaces, which can be re-used by other NFs.
Unless the expected NF information is locally configured on requester NF, e.g.
the expected NF is in the same PLMN, the NF service discovery is implemented
via the NF discovery.
## 5.2 Network Function services
### 5.2.1 General
### 5.2.2 AMF Services
#### 5.2.2.1 General
The following table shows the AMF Services and AMF Service Operations.
Table 5.2.2.1-1: List of AMF Services
+----------------+----------------+----------------+----------------+ | Service Name | Service | Operation | Known | | | Operations | | Consumer(s) | | | | Semantic | | +================+================+================+================+ | Namf\ | UEC | Request/ | Peer AMF | | _Communication | ontextTransfer | Response | | +----------------+----------------+----------------+----------------+ | | C | Request/ | Peer AMF | | | reateUEContext | Response | | +----------------+----------------+----------------+----------------+ | | Re | Request/ | Peer AMF | | | leaseUEContext | Response | | +----------------+----------------+----------------+----------------+ | | Registration | Subscribe / | Peer AMF | | | CompleteNotify | Notify | | +----------------+----------------+----------------+----------------+ | | N | Subscribe / | SMF, SMSF, | | | 1MessageNotify | Notify | PCF, LMF, Peer | | | | | AMF | +----------------+----------------+----------------+----------------+ | | N1Me | | SMF, SMSF, PCF | | | ssageSubscribe | | | +----------------+----------------+----------------+----------------+ | | N1Mess | | SMF, SMSF, PCF | | | ageUnSubscribe | | | +----------------+----------------+----------------+----------------+ | | N1N2M | Request/ | SMF, SMSF, | | | essageTransfer | Response | PCF, LMF | +----------------+----------------+----------------+----------------+ | | N1N | Subscribe / | SMF, SMSF, | | | 2TransferFailu | Notify | PCF, LMF | | | reNotification | | | +----------------+----------------+----------------+----------------+ | | N | Subscribe / | NOTE 1 | | | 2InfoSubscribe | Notify | | +----------------+----------------+----------------+----------------+ | | N2I | | NOTE 1 | | | nfoUnSubscribe | | | +----------------+----------------+----------------+----------------+ | | N2InfoNotify | | AMF, LMF | +----------------+----------------+----------------+----------------+ | | EBIAssignment | Re | SMF | | | | quest/Response | | +----------------+----------------+----------------+----------------+ | | AMFStatusC | Subscribe / | SMF, PCF, NEF, | | | hangeSubscribe | Notify | SMSF, UDM | +----------------+----------------+----------------+----------------+ | | AMFStatusCha | Subscribe / | SMF, PCF, NEF, | | | ngeUnSubscribe | Notify | SMSF, UDM | +----------------+----------------+----------------+----------------+ | | AMFStat | Subscribe / | SMF, PCF, NEF, | | | usChangeNotify | Notify | SMSF, UDM | +----------------+----------------+----------------+----------------+ | Namf\ | Subscribe | Subscribe / | NEF, SMF, UDM | | _EventExposure | | Notify | | +----------------+----------------+----------------+----------------+ | | Unsubscribe | Subscribe / | NEF, SMF, UDM | | | | Notify | | +----------------+----------------+----------------+----------------+ | | Notify | Subscribe / | NEF, SMF, UDM | | | | Notify | | +----------------+----------------+----------------+----------------+ | Namf_MT | Enable | Re | SMSF | | | UEReachability | quest/Response | | +----------------+----------------+----------------+----------------+ | | ProvideDomai | Re | UDM | | | nSelectionInfo | quest/Response | | +----------------+----------------+----------------+----------------+ | Namf_Location | ProvideP | Re | GMLC | | | ositioningInfo | quest/Response | | +----------------+----------------+----------------+----------------+ | | EventNotify | Subscribe / | GMLC | | | | Notify | | +----------------+----------------+----------------+----------------+ | | Provi | Re | UDM | | | deLocationInfo | quest/Response | | +----------------+----------------+----------------+----------------+ | NOTE 1: In | | | | | this Release | | | | | of the | | | | | specification | | | | | no known | | | | | consumer is | | | | | identified to | | | | | use this | | | | | service | | | | | operation. | | | | +----------------+----------------+----------------+----------------+
#### 5.2.2.2 Namf_Communication service
##### 5.2.2.2.1 General
**Service description:** This service enables an NF to communicate with the UE
through N1 NAS messages or with the AN (both UE and non UE specific). The
service operations defined below allow the NF to communicate with the UE and
the AN. The following are the key functionalities of this NF service.
\- Provide service operations for transporting N1 messages to the UE;
\- Allow NFs to subscribe and unsubscribe for notifications of specific N1
messages from the UE;
\- Allow NFs to subscribe and unsubscribe for notifications about specific
information from AN;
\- Provide service operations for initiating N2 messages towards the AN;
\- Security Context Management; and
\- UE information management and transfer (including its security context);
##### 5.2.2.2.2 Namf_Communication_UEContextTransfer service operation
**Service operation name:** Namf_Communication_UEContextTransfer
**Description:** Provides the UE context to the consumer NF.
**Input, Required:** 5G-GUTI or SUPI, Access Type, Reason.
**Input, Optional:** Integrity protected message from the UE that triggers the
context transfer.
**Output, Required:** The UE context of the identified UE or only the SUPI and
an indication that the Registration Request has been validated. The UE context
is detailed in table 5.2.2.2.2-1.
**Output, Optional:** Mobile Equipment Identifier (if available), Allowed
NSSAI, Mapping Of Allowed NSSAI.
See clause 4.2.2.2.2 for example of usage of this service operation. If the
consumer NF sent an integrity protected message from the UE, the AMF uses it
to verify whether this request is permitted to retrieve the UE context of the
UE. If it is permitted, the AMF provides UE context to the consumer NF in the
Namf_Communication_UEContextTransfer response. The following table illustrates
the UE Context:
Table 5.2.2.2.2-1: UE Context in AMF
+----------------------------------+----------------------------------+ | Field | Description | +==================================+==================================+ | SUPI | SUPI (Subscription Permanent | | | Identifier) is the subscriber\'s | | | permanent identity in 5GS. | +----------------------------------+----------------------------------+ | Routing Indicator | UE\'s Routing Indicator that | | | allows together with SUCI/SUPI | | | Home Network Identifier to route | | | network signalling to AUSF and | | | UDM instances capable to serve | | | the subscriber | +----------------------------------+----------------------------------+ | AUSF Group ID | The AUSF Group ID for the given | | | UE. | +----------------------------------+----------------------------------+ | UDM Group ID | The UDM Group ID for the UE. | +----------------------------------+----------------------------------+ | SUPI-unauthenticated-indicator | This indicates whether the SUPI | | | is unauthenticated. | +----------------------------------+----------------------------------+ | GPSI | The GPSI(s) of the UE. The | | | presence is dictated by its | | | storage in the UDM. | +----------------------------------+----------------------------------+ | 5G-GUTI | 5G Globally Unique Temporary | | | Identifier. | +----------------------------------+----------------------------------+ | PEI | Mobile Equipment Identity | +----------------------------------+----------------------------------+ | Internal Group ID-list | List of the subscribed internal | | | group(s) that the UE belongs to. | +----------------------------------+----------------------------------+ | UE Specific DRX Parameters | UE specific DRX parameters. | +----------------------------------+----------------------------------+ | UE MM Network Capability | Indicates the UE MM network | | | capabilities. | +----------------------------------+----------------------------------+ | 5GMM Capability | Includes other UE capabilities | | | related to 5GCN or interworking | | | with EPS. | +----------------------------------+----------------------------------+ | Events Subscription | List of the event subscriptions | | | by other CP NFs. Indicating the | | | events being subscribed as well | | | as any information on how to | | | send the corresponding | | | notifications | +----------------------------------+----------------------------------+ | **For the AM Policy | | | Association:** | | +----------------------------------+----------------------------------+ | AM Policy Information | Information on AM policy | | | provided by PCF. Includes the | | | Policy Control Request Triggers | | | and the Policy Control Request | | | Information. Includes the | | | authorized RFSP and the | | | authorized Service Area | | | Restrictions. | +----------------------------------+----------------------------------+ | PCF ID | The identifier of the PCF for AM | | | Policy. In roaming, the | | | identifier of V-PCF (NOTE 2). | +----------------------------------+----------------------------------+ | **For the UE Policy | | | Association:** | | +----------------------------------+----------------------------------+ | Trigger Information | The Policy Control Request | | | Triggers on UE policy provided | | | by PCF. | +----------------------------------+----------------------------------+ | PCF ID(s) | The identifier of the PCF for UE | | | Policy. In roaming, the | | | identifiers of both V-PCF and | | | H-PCF (NOTE 1) (NOTE 2). | +----------------------------------+----------------------------------+ | Subscribed RFSP Index | An index to specific RRM | | | configuration in the NG-RAN that | | | is received from the UDM. | +----------------------------------+----------------------------------+ | RFSP Index in Use | An index to specific RRM | | | configuration in the NG-RAN that | | | is currently in use. | +----------------------------------+----------------------------------+ | MICO Mode Indication | Indicates the MICO Mode for the | | | UE. | +----------------------------------+----------------------------------+ | Voice Support Match Indicator | An indication whether the UE | | | radio capabilities are | | | compatible with the network | | | configuration. The AMF uses it | | | as an input for setting the IMS | | | voice over PS Session Supported | | | Indication over 3GPP access. | +----------------------------------+----------------------------------+ | Homogenous Support of IMS Voice | Indicates per UE if \"IMS Voice | | over PS Sessions | over PS Sessions\" is | | | homogeneously supported in all | | | TAs in the serving AMF or | | | homogeneously not supported, or, | | | support is | | | non-homogeneous/unknown, see | | | clause 5.16.3.3 of | | | TS 23.501 [2]. | +----------------------------------+----------------------------------+ | UE Radio Capability for Paging | Information used by the NG-RAN | | Information | to enhance the paging towards | | | the UE (see clause 5.4.4.1 of | | | TS 23.501 [2]). | +----------------------------------+----------------------------------+ | Information On Recommended Cells | Information sent by the NG-RAN | | And RAN nodes For Paging | and used by the AMF when paging | | | the UE to help determining the | | | NG-RAN nodes to be paged as well | | | as to provide the information on | | | recommended cells to each of | | | these NG-RAN nodes, in order to | | | optimize the probability of | | | successful paging while | | | minimizing the signalling load | | | on the radio path. | +----------------------------------+----------------------------------+ | UE Radio Capability Information | Information sent by the NG-RAN | | | node and stored in the AMF. The | | | AMF sends this information to | | | the NG-RAN node within the UE | | | context during transition to | | | CM-CONNECTED state. | +----------------------------------+----------------------------------+ | SMSF Identifier | The Identifier of the SMSF | | | serving the UE in RMâ€‘REGISTERED | | | state. | +----------------------------------+----------------------------------+ | SMSF Address | The Address of the SMSF serving | | | the UE in RM-REGISTERED state. | | | (see clause 4.13.3.1). | +----------------------------------+----------------------------------+ | SMS Subscription | Indicates subscription to any | | | SMS delivery service over NAS | | | irrespective of access type. | +----------------------------------+----------------------------------+ | SEAF data | Master security information | | | received from AUSF | +----------------------------------+----------------------------------+ | Last used EPS PLMN ID | The identifier of the last used | | | EPS PLMN | +----------------------------------+----------------------------------+ | **For each access type level | | | context within the UE access and | | | mobility context:** | | +----------------------------------+----------------------------------+ | Access Type | Indicates the access type for | | | this context. | +----------------------------------+----------------------------------+ | RM State | Registration management state. | +----------------------------------+----------------------------------+ | Registration Area | Current Registration Area (a set | | | of tracking areas in TAI List). | +----------------------------------+----------------------------------+ | TAI of last Registration | TAI of the TA in which the last | | | Registration Request was | | | initiated. | +----------------------------------+----------------------------------+ | User Location Information | Information on user location. | +----------------------------------+----------------------------------+ | Mobility Restrictions | Mobility Restrictions restrict | | | mobility handling or service | | | access of a UE. It consists of | | | RAT restriction, Forbidden area, | | | Service area restrictions and | | | Core Network type restriction. | +----------------------------------+----------------------------------+ | Expected UE Behaviour Parameters | Indicates per UE the Expected UE | | for AMF | Behaviour Parameters and their | | | corresponding validity times. | +----------------------------------+----------------------------------+ | Security Information for CP | As defined in TS 33.501 [15]. | +----------------------------------+----------------------------------+ | Security Information for UP | As defined in TS 33.501 [15]. | +----------------------------------+----------------------------------+ | Allowed NSSAI | Allowed NSSAI consisting of one | | | or more S-NSSAIs for serving | | | PLMN in the present Registration | | | Area. | +----------------------------------+----------------------------------+ | Mapping Of Allowed NSSAI | Mapping Of Allowed NSSAI is the | | | mapping of each S-NSSAI of the | | | Allowed NSSAI to the S-NSSAIs of | | | the Subscribed S-NSSAIs. | +----------------------------------+----------------------------------+ | Inclusion of NSSAI in RRC | [Only for 3GPP access] it | | Connection Establishment Allowed | defines whether the UDM has | | by HPLMN | indicated that the UE is allowed | | | to include NSSAI in the RRC | | | connection Establishment in | | | clear text. | +----------------------------------+----------------------------------+ | Access Stratum Connection | Defines what NSSAI, if any, to | | Establishment NSSAI Inclusion | include in the Access Stratum | | Mode | connection establishment as | | | specified in clause 5.15.9 of | | | TS 23.501 [2]. | +----------------------------------+----------------------------------+ | CM state for UE connected via | Identifies the UE CM state | | N3IWF | (CM-IDLE, CM-CONNECTED) for UE | | | connected via N3IWF | +----------------------------------+----------------------------------+ | N2 address information for N3IWF | Identifies the N3IWF to which UE | | | is connected. Exists only if CM | | | state for UE connected via N3IWF | | | is CM-CONNECTED. | +----------------------------------+----------------------------------+ | AMF UE NGAP ID | Identifies the UE association | | | over the NG interface within the | | | AMF as defined in | | | TS 38.413 [10]. This parameter | | | exists only if CM state for the | | | respective Access Type is | | | CM-CONNECTED. | +----------------------------------+----------------------------------+ | (R)AN UE NGAP ID | Identifies the UE association | | | over the NG interface within the | | | NG-(R)AN node as defined in | | | TS 38.413 [10]. This parameter | | | exists only if CM state for the | | | respective Access Type is | | | CM-CONNECTED. | +----------------------------------+----------------------------------+ | Network Slice Instance(s) | The Network Slice Instances | | | selected by 5GC for this UE. | +----------------------------------+----------------------------------+ | URRP-AMF information | UE Reachability Request | | | Parameter contains a list of | | | URRP-AMF flags and associated | | | authorised NF IDs. Each URRP-AMF | | | flag indicates whether direct UE | | | reachability notification has | | | been authorised by the HPLMN | | | towards the associated NF ID or | | | not. | +----------------------------------+----------------------------------+ | **For each PDU Session level | | | context:** | | +----------------------------------+----------------------------------+ | S-NSSAI(s) | The S-NSSAI(s) associated to the | | | PDU Session. | +----------------------------------+----------------------------------+ | DNN | The associated DNN for the PDU | | | Session. | +----------------------------------+----------------------------------+ | Network Slice Instance id | The network Slice Instance | | | information for the PDU Session | +----------------------------------+----------------------------------+ | PDU Session ID | The identifier of the PDU | | | Session. | +----------------------------------+----------------------------------+ | SMF Information | The associated SMF identifier | | | and SMF address for the PDU | | | Session. | +----------------------------------+----------------------------------+ | Access Type | The current access type for this | | | PDU Session. | +----------------------------------+----------------------------------+ | EBI-ARP list | The allocated EBI and associated | | | ARP pairs for this PDU session. | +----------------------------------+----------------------------------+ | 5GSM Core Network Capability | The UEs 5GSM Core Network | | | Capability as defined in | | | clause 5.4.4b of | | | TS 23.501 [2]. | +----------------------------------+----------------------------------+ | NOTE 1: The AMF transfers the | | | PCF ID to the SMF during PDU | | | Session Establishment. The SMF | | | may select the PCF identified by | | | the PCF ID as described in | | | clause 6.3.7.1 of | | | TS 23.501 [2]. In HR roaming | | | case, the AMF transfers the | | | identifier of H-PCF as described | | | in clause 4.3.2.2.2. In LBO | | | roaming case, the AMF transfers | | | the identifier of V-PCF as | | | described in clause 4.3.2.2.1. | | | | | | NOTE 2: The PCF ID in AM Policy | | | Association information and the | | | PCF ID in UE Policy Association | | | Information should be the same | | | in non-roaming case. The V-PCF | | | ID in AM Policy Association | | | information and the V-PCF ID in | | | UE Policy Association | | | Information should be the same | | | in roaming case. | | +----------------------------------+----------------------------------+
##### 5.2.2.2.3 Namf_Communication_RegistrationCompleteNotify service
operation
**Service operation name:** Namf_Communication_RegistrationCompleteNotify
**Description:** This service operation is used by the consumer NF to inform
the AMF that a prior UE context transfer has resulted in the UE successfully
registering with it. The UE context is marked inactive in the AMF.
NOTE 1: This notification corresponds to an implicit subscription.
**Input, Required:** 5G-GUTI, Reason.
**Input, Optional:** PDU Session ID(s) (indicates the PDU Session(s) to be
released), PCF reselected indicator (indicates that new AMF has selected a new
PCF to handle the AM Policy association and/or the UE Policy association).
**Output, Required:** None.
**Output, Optional:** None.
See clause 4.2.2.2.2 step 10 for example usage of this service operation. When
the consumer NF (AMF) receives this notification, it marks the UE context
information as inactive since the UE context has been successfully transferred
to the peer NF and the UE has successfully registered there. The AMF sends a
Namf_Communication_RegistrationCompleteNotify ack to the consumer NF. The
consumer NF (AMF) is notified whether the AM Policy Association Information
and/or the UE Policy Association Information in the UE context will be used or
not (i.e. new AMF may select a different PCF and then create a new AM Policy
Association and/or a new UE Policy Association).
NOTE 2: Whether notification Ack need a separate message or be realized in the
transport layer will be determined in TS 29.518 [18].
##### 5.2.2.2.4 Namf_Communication_N1MessageNotify service operation
**Service operation name:** Namf_Communication_N1MessageNotify
**Description:** AMF notifies the N1 message received from the UE to a
destination CN NF.
**Input, Required:** AMF ID (GUAMI), N1 Message(s)
**Input, Optional:** local time zone, UE\'s current location, AN type AN N2
terminating point, Allowed NSSAI, Mapping Of Allowed NSSAI, SUPI, MM Context.
**Output, Required:** None _._
**Output, Optional:** None _._
The destination NF type to be notified is determined based on one of the
following:
\- The N1 message type is always known to be consumed by one particular NF
type; or
\- An NF had explicitly subscribed for the particular N1 message type to be
notified towards it.
NOTE: Whether notification Ack need a separate message or be realized in the
transport layer will be determined in TS 29.518 [18].
The optional AN N2 terminating point, SUPI, MM Context, Allowed NSSAI and
Mapping Of Allowed NSSAI parameters are included if the service operation is
invoked towards a peer AMF.
##### 5.2.2.2.5 Namf_Communication_N1MessageSubscribe service operation
**Service operation name:** Namf_Communication_N1MessageSubscribe.
**Description:** An NF can subscribe with the AMF to get notified of a
particular N1 message type from the UE.
**Input, Required:** CN NF ID, N1 Message Type
**Input, Optional:** SUPI.
**Output, Required:** None _._
**Output, Optional:** None _._
The consumer NF invokes the Namf_Communication_N1MessageSubscribe service
operation (NF ID, N1 message type to subscribe) on the AMF. The consumer NF
shall provide a SUPI for UE associated N1 message subscriptions. If the
consumer NF is allowed to subscribe for the type of N1 message requested, the
AMF creates a binding for the consumer NF to deliver subsequent
Namf_Communication_N1MessageNotify towards that NF.
NOTE: Whether Subscription Ack need a separate message or be realized in the
transport layer will be determined in TS 29.518 [18].
##### 5.2.2.2.6 Namf_Communication_N1MessageUnSubscribe service operation
**Service operation name:** Namf_Communication_N1MessageUnSubscribe.
**Description:** An NF can unsubscribe with the AMF to stop notifying a
particular N1 message type from the UE.
**Input, Required:** CN NF ID, N1 Message Type
**Input, Optional:** None.
**Output, Required:** None _._
**Output, Optional:** None _._
The consumer NF invokes the Namf_Communication_N1MessageUnSubscribe service
operation (NF ID, N1 message type to subscribe) on the AMF. The AMF deletes
the binding for the consumer NF for the requested N1 message type.
NOTE: Whether Unsubscribe Ack need a separate message or be realized in the
transport layer will be determined in TS 29.518 [18].
##### 5.2.2.2.7 Namf_Communication_N1N2MessageTransfer service operation
**Service operation name:** Namf_Communication_N1N2MessageTransfer.
**Description:** CN NF request to transfer downlink N1 and/or N2 message to
the UE and/or AN through the AMF.
**Input, Required:** CN NF ID, Message type (N1 or N2 or both), Message
Container (s) where at least one of the message containers (N1 or N2) is
required.
**Input, Optional:** last message indication, Session ID, Paging Policy
Indicator, ARP, Area of validity for the N2 SM information, 5QI,
N1N2TransferFailure Notification Target Address, type of N2 SM information,
type of N2 NRPPa information.
Namf_Communication_N1N2MessageTransfer supports the transfer of only one N2
message. N2 SM information and N2 NRPPa information are mutually exclusive.
**Output, Required:** Result indication _._
**Output, Optional:** Redirection information _._
If the UE is in CM-IDLE state, the AMF initiates the network triggered service
request procedure as specified in clause 4.2.3.3 and responds to the consumer
NF with a result indication, \"attempting to reach UE\". Otherwise, the AMF
responds to the consumer NF, with a Namf_Communication_N1N2MessageTransfer
response, providing a result indication of whether the AMF was able to
successfully transfer the N1 and/or the N2 message towards the UE and/or the
AN. A result indication of \"N1/N2 transfer success\" does not mean that N1
message is successfully received by the UE. It only means that the AMF is able
to successfully send the N1 or N2 message towards the AN.
The \"Area of validity for the N2 SM information\", if included is used by the
AMF to determine whether the N2 SM information provided by the consumer NF can
be used towards the AN based on the current location of the UE. If the
location of the UE is outside the \"Area of validity for the N2 SM
information\" indicated, the AMF shall not send the N2 SM information to the
AN.
If the consumer NF knows that a specific downlink N1 message is the last
message to be transferred in this transaction, the consumer NF shall include
the last message indication in the Namf_Communication_N1N2MessageTransfer
service operation so that the AMF knows that the no more downlink N1 message
need to be transferred for this transaction.
The CN NF is implicitly subscribed to be notified of N1N2TransferFailure by
providing the N1N2TransferFailure Notification Target Address. When AMF
detects that the UE failes to response to paging, the AMF invokes the
Namf_Communication_N1N2TransferFailureNotification to provide the failure
notification to the location addressed by N1N2TransferFailure Notification
Target Address.
If the result of the service operation fails, the AMF shall set the
corresponding cause value in the result indication which can be used by the NF
consumer for further action. If the related UE is not served by AMF and the
AMF knows which AMF is serving the UE, the AMF provides redirection
information which can be used by the consumer NF to resend UE related message
to the AMF that serves the UE.
If the consumer NF is a SMF and he request includes N2 SM information, the SMF
indicates the type of N2 SM information. If the consumer NF is a LMF and the
request includes N2 NRPPa information, the LMF indicates the type of N2 NRPPa
information.
NOTE: The actual N2 SM information or N2 NRPPa information is not interpreted
by the AMF.
##### 5.2.2.2.7A Namf_Communication_N1N2TransferFailureNotification service
operation
**Service operation name:**
Namf_Communication_N1N2TransferFailureNotification.
**Description:** The AMF uses this notification to inform the NF service
consumer that initiated an earlier Namf_Communication_N1N2MessageTransfer,
that the AMF failed to deliver the N1 message to the UE as the UE failed to
respond to paging.
**Input, Required:** Cause, N1N2MessageTransfer Notification Target Address.
**Input, Optional:** None.
**Output, Required:** None.
**Output, Optional:** None.
##### 5.2.2.2.8 Namf_Communication_N2InfoSubscribe service operation
**Service operation name:** Namf_Communication_N2InfoSubscribe.
**Description:** An NF invokes this service operation to subscribe for the
delivery of information contained in a specific N2 message type.
**Input, Required:** CN NF ID, N2 information type to be subscribed.
**Input, Optional:** None.
**Output, Required:** None _._
**Output, Optional:** None _._
##### 5.2.2.2.9 Namf_Communication_N2InfoUnsubscribe service operation
**Service operation name:** Namf_Communication_N2InfoUnSubscribe.
**Description:** An NF can invoke this service operation to unsubscribe for
the delivery of information contained in a specific N2 message type.
**Input, Required:** CN NF ID, N2 information type to unsubscribe.
**Input, Optional:** None.
**Output, Required:** None _._
**Output, Optional:** None _._
The consumer NF invokes the Namf_Communication_N2InfoUnSubscribe service
operation (CN NF ID, N2 information type to unsubscribe) on the AMF. The AMF
deletes the binding for the consumer NF to for the requested information to
unsubscribe.
##### 5.2.2.2.10 Namf_Communication_N2InfoNotify service operation
**Service operation name:** Namf_Communication_N2InfoNotify.
**Description:** The AMF uses this service operation to notify a particular N2
message information towards the NFs that have subscribed (implicitly or
explicitly) for the specific information. This service operation is also used
to redirect the N2 message to the AMF that are serving the UE.
**Input, Required:** AMF ID (GUAMI), N2 information.
**Input, Optional:** None.
**Output, Required:** None _._
**Output, Optional:** None _._
##### 5.2.2.2.11 Namf_Communication_CreateUEContext service operation
**Service operation name:** Namf_Communication_CreateUEContext
**Description:** This service operation is used by a source AMF to create the
UE context in a target AMF during handover procedures.
**Input, Required:** 5G-GUTI, UE context of the identified UE. As described in
Table 5.2.2.2.2-1, the UE context may include the SUPI, DRX parameters, AM
policy information, PCF ID, UE network capability, used N1 security context
information, event subscriptions by other consumer NF and the list of SM PDU
Session IDs along with the SMF handling the PDU Session, N2 information
including source to target RAN transparent container, Endpoint information of
S-AMF to receive N2 information notification about handover complete.
**Input, Optional:** allocated EBI information, PCF ID.
**Output, Required:** Cause, N2 information including Target to Source
transparent container, N2 SM information (PDU Sessions failed to be setup list
and the N3 DL forwarding information), handle for the UE context created, PCF
ID.
**Output, Optional:** None.
##### 5.2.2.2.12 Namf_Communication_ReleaseUEContext service operation
**Service operation name:** Namf_Communication_ReleaseUEContext
**Description:** This service operation is used by a source AMF to release the
UE context in a target AMF during handover cancel procedures.
**Input, Required:** Handle of the UE context.
**Input, Optional:** None.
**Output, Required:** Cause.
**Output, Optional:** None.
##### 5.2.2.2.13 Namf_Communication_EBIAssignment service operation
**Service operation name:** Namf_Communication_EBIAssignment.
**Description:** The consumer NF uses this service operation to request a
bunch of EPS Bearer IDs for a PDU Session and optionally indicate to the AMF
the list of EBI(s) to be released.
**Inputs, Required:** SUPI, PDU Session ID, ARP list.
**Input, Optional:** Released EBI list.
**Outputs, Required:** \ pair _._
**Outputs, Optional:** a list of \ pair _._
The consumer NF invokes the Namf_Communication_EBIAssignment service operation
when it determines that one or more EPS Bearer IDs are required for EPS QoS
mapping for a PDU Session. The ARP list indicates the number of the requested
EBIs and the corresponding ARP. The AMF uses the ARP list (including ARP
priority level, the pre-emption capability and the pre-emption vulnerability)
and the S-NSSAI to prioritize the EBI request, AMF can revoke the EBI from an
ongoing lower priority PDU Session, if the maximum number of EBIs have been
reached and a session with a higher priority requests an EBI. The AMF responds
the consumer NF with a cause which indicates whether the assignment is
successful or not. If the assignment is successful, the AMF provides a list of
\ pair to the consumer NF.
If the consumer NF determines that some EBIs are not needed, the consumer NF
indicates the EBI(s) that can be released in the Released EBI list.
##### 5.2.2.2.14 Namf_Communication_AMFStatusChangeSubscribe service operation
**Service operation name:** Namf_Communication_AMFStatusChangeSubscribe
**Description:** This service operation is used by an NF to subscribe for AMF
Status Change notification.
**Input, Required:** GUAMI(s).
**Input, Optional:** None.
**Output, Required:** None.
**Output, Optional:** None.
See clause 5.21.2.2, TS 23.501 [2] for the example usage of this service
operation. The GUAMI(s) is used to identify the AMF.
##### 5.2.2.2.15 Namf_Communication_AMFStatusChangeUnSubscribe service
operation
**Service operation name:** Namf_Communication_AMFStatusChangeUnSubscribe
**Description:** This service operation is used by an NF to unsubscribe for
AMF Status Change notification.
**Input, Required:** GUAMI(s).
**Input, Optional:** None.
**Output, Required:** None.
**Output, Optional:** None.
See clause 5.21.2.2, TS 23.501 [2] for the example usage of this service
operation. The GUAMI(s) is used to identify the AMF.
##### 5.2.2.2.16 Namf_Communication_AMFStatusChangeNotify service operation
**Service operation name:** Namf_Communication_AMFStatusChangeNotify
**Description:** Report AMF Status change (e.g. AMF unavailable) notification
to subscribed NFs.
**Input, Required:** GUAMI(s).
**Input, Optional:** Target AMF(s) Name associated with the indicated GUAMI.
**Output, Required:** None.
**Output, Optional:** None.
See clause 5.21.2.2, TS 23.501 [2] for the example usage of this service
operation. The GUAMI(s) is used to identify the AMF. For network deployment
without UDSF case, the target AMF Name which is to serve the user of the
indicated GUAMI is also included.
#### 5.2.2.3 Namf_EventExposure service
##### 5.2.2.3.1 General
**Service description:** This service enables an NF to subscribe and get
notified about an Event ID.
Following UE access and mobility information event are considered (Event ID is
defined in clause 4.15.1):
\- Location changes (TAI, Cell ID, N3IWF node, UE local IP address and
optionally UDP source port number, Area Of Interest);
\- UE moving in or out of a subscribed \"Area Of Interest\" as described in
clause 5.6.11 in TS 23.501 [2];
\- Time zone changes (UE Time zone);
\- Access Type changes (3GPP access or non-3GPP access);
\- Registration state changes (Registered or Deregistered);
\- Connectivity state changes (IDLE or CONNECTED);
\- UE loss of communication;
\- UE reachability status;
\- UE indication of switching off SMS over NAS service;
\- Subscription Correlation ID change (implicit subscription); and
\- Subscription Correlation ID addition (implicit subscription).
Event Filters are used to specify the conditions to match for notifying the
event (i.e. \"List of Parameter values to match\"). If there are no conditions
to match for a specific Event ID, then the Event Filter is not provided. The
following table provides as an example how the conditions to match for event
reporting can be specified for various Event IDs for AMF exposure.
Table 5.2.2.3.1-1: Example of Event Filters for AMF exposure events
+---------------------+-----------------------------------------------+ | Event ID | Event Filter (List of Parameter Values to | | | Match) | +=====================+===============================================+ | Area of Interest | \ | | | | | | \ | +---------------------+-----------------------------------------------+ | Access Type | \ | +---------------------+-----------------------------------------------+ | Location | \ (to | | | report any TAI change) | +---------------------+-----------------------------------------------+ | Reachability Filter | Applicable to the event UE reachability. | | | Value = UE reachability status change or UE | | | reachable for DL traffic. Absence of this | | | parameter in UE reachability event request is | | | interpreted as \"UE reachability status | | | change\" | +---------------------+-----------------------------------------------+
The following service operations are defined for the Namf_EventExposure
service:
\- Namf_EventExposure_Subscribe.
\- Namf_EventExposure_UnSubscribe.
\- Namf_EventExposure_Notify.
##### 5.2.2.3.2 Namf_EventExposure_Subscribe service operation
**Service operation name:** Namf_EventExposure_Subscribe.
**Description:** The consumer NF uses this service operation to subscribe to
or modify event reporting for one UE, a group of UE(s) or any UE.
**Input, Required:** NF ID, target of the subscription: UE(s) ID (SUPI or
Internal Group Identifier or indication that any UE is targeted), ((set of)
Event ID(s) defined in clause 5.2.2.3.1, Notification Target Address (+
Notification Correlation ID))s, Event Reporting Information defined in Table
4.15.1-1.
**Input, Optional:** (Event Filter (s) associated with each Event ID; Event
Filter (s) are defined in clause 5.2.2.3.1, Subscription Correlation ID (in
the case of modification of the event subscription), Expiry time.
**Output, Required:** When the subscription is accepted: Subscription
Correlation ID (required for management of this subscription), Expiry time
(required if the subscription can be expired based on the operator\'s
policy)_._
**Output, Optional:** First corresponding event report is included, if
available (see clause 4.15.1).
The NF consumer subscribes to the event notification by invoking
Namf_EventExposure to the AMF. The AMF allocates an Subscription Correlation
ID for the subscription and responds to the consumer NF with the Subscription
Correlation ID. UE ID identifies the UE, SUPI and/or GPSI. Event ID (see
clause 4.15.1) identifies the events that the NF consumer is interested in.
The Subscription Correlation ID is unique within the AMF Set.
The ((set of) Event ID(s), Notification Target Address (+ Notification
Correlation ID)) helps the Event Receiving NF to co-relate a notification
against a corresponding event subscription for the indicated Event ID.
In the case that the NF consumer subscribes to the AMF on behalf of other NF,
the NF consumer include the Notification Target Address(+Notification
Correlation ID) of other NF for the Event ID which is to be notified to other
NF directly and the Notification Target Address(+Notification Correlation ID)
of itself for the Subscription Correlation ID change event. Each Notification
Target Address(+ Notification Correlation ID) is associated with the related
(set of) Event ID(s). When the Subscription Correlation ID change due to the
AMF reallocation, the notification is sent to NF consumer which triggers this
subscription.
Event filter may include \"AN type(s)\" as part of the list of parameter
values to match and it indicates to subscribe the event per Access Type.
Event receiving NF ID identifies the NF that shall receive the event
reporting.
When the consumer NF needs to modify an existing subscription previously
created by itself in the AMF, it invokes Namf_EventExposure_Subscribe service
operation which contains the Subscription Correlation ID and the new Event
Filters with Event ID to the AMF.
##### 5.2.2.3.3 Namf_EventExposure_UnSubscribe service operation
**Service operation name:** Namf_EventExposure_UnSubscribe.
**Description:** The NF consumer uses this service operation to unsubscribe
for a specific event for one UE, group of UE(s), any UE.
**Input, Required:** Subscription Correlation ID.
**Input, Optional:** None.
**Output, Required:** Operation execution result indication _._
**Output, Optional:** None _._
The NF consumer unsubscribes the event notification by invoking
Namf_EventExposure_Unsubscribe (Subscription Correlation ID) to the AMF.
##### 5.2.2.3.4 Namf_EventExposure_Notify service operation
**Service operation name** : Namf_EventExposure_Notify.
**Service operation description:** Provides the previously subscribed event
information to the NF Consumer which has subscribed to that event before.
**Input, Required:** AMF ID (GUAMI), Notification Correlation Information,
Event ID, corresponding UE (SUPI and if available GPSI), time stamp.
**Input, Optional:** Event specific parameter list.
**Output, Required:** None _._
**Output, Optional:** None _._
When the AMF detects a UE access and mobility event corresponding to a
Subscription, it invokes Namf_EventExposure_Notify service operation to the NF
consumer(s) which has subscribed to the UE mobility event before. The event is
notified towards the consumers for which the Event filters (which may include
\"AN type(s)\") match. The Notification Target Address (+ Notification
Correlation ID) indicates to the Event Receiving NF the specific event
notification subscription. The event specific parameter indicates the type of
mobility event and related information, e.g. Registration Area Update/new
Registration Area.
The optional event specific parameter list provides the values that matched
for generating the event notification. The parameter values to match are
specified during the event subscription (see clause 5.2.2.3.2). For example if
the event type reported is \"AN change\", the event specific parameter list
contains the value of the new AN.
#### 5.2.2.4 Namf_MT service
##### 5.2.2.4.1 General
**Service description:** It provides a NF the service to request information
related to capabilities that make sure UE is reachable to send MT signalling
or data to a target UE. The following are the key functionalities of this NF
service
\- paging UE if UE is in IDLE state and respond other NF after the UE enters
CM-CONNECTED state.
\- response to the requester NF if UE is in CONNECTED state.
\- providing the terminating domain selection information for IMS voice to the
consumer NF.
##### 5.2.2.4.2 Namf_MT_EnableUEReachability service operation
**Service operation name:** Namf_MT_EnableUEReachability.
**Description:** The consumer NF uses this service operation to request
enabling UE reachability.
**Inputs, Required:** NF ID, UE ID.
**Inputs, Optional:** None.
**Outputs, Required:** Result indication _._
**Outputs, Optional:** Redirection information _._
See clause 4.13.3.6 for details on the usage of this service operation.
The consumer NF does not need to know UE state. The AMF accepts the request
and respond the consumer NF immediately if UE is in CM-CONNECTED state. If the
UE is in CM-IDLE state, the AMF may page the UE and respond to the consumer NF
after the UE enters CM-CONNECTED state.
If the result of the service operation fails, the AMF shall set the
corresponding cause value in the result indication which can be used by the NF
consumer for further action. If the related UE is not served by the AMF and
the AMF knows which AMF is serving the UE, the AMF provides redirection
information which can be used by the NF consumer to resend UE related message
to the AMF that serves the UE.
##### 5.2.2.4.3 Namf_MT_ProvideDomainSelectionInfo
**Service operation name:** Namf_MT_ProvideDomainSelectionInfo.
**Description:** Provides the UE information for terminating domain selection
of IMS voice to the consumer NF.
**Input, Required:** SUPI.
**Input, Optional:** None.
**Output, Required:** Success/Failure indication.
**Output, Optional:** Indication of supporting IMS voice over PS Session or
not, Time stamp of the last radio contact with the UE, Current RAT type.
#### 5.2.2.5 Namf_Location service
##### 5.2.2.5.1 General
**Service description:** This service enables an NF to request location
information for a target UE. The following are the key functionalities of this
NF service.
\- Allow NFs to request the current geodetic and optionally civic location of
a target UE.
\- Allow NFs to be notified of event information related to emergency
sessions.
\- Allow NFs to request Network Provided Location Information (NPLI) and/or
local time zone corresponding to the location of a target UE.
##### 5.2.2.5.2 Namf_Location_ProvidePositioningInfo service operation
**Service operation name:** Namf_Location_ProvidePositioningInfo
**Description:** Provides UE positioning information to the consumer NF.
**Input, Required:** UE Identification (SUPI or PEI), External Client Type.
**Input, Optional:** Location QoS, Supported GAD shapes.
**Output, Required:** Success/Failure indication
**Output, Optional:** Geodetic Location, Civic Location, Position Methods
Used, Failure Cause.
See steps 4 and 9 of clause 4.13.5.3 for example of usage of this service
operation.
##### 5.2.2.5.3 Namf_Location_EventNotify service operation
**Service operation name:** Namf_Location_EventNotify
**Description:** Provides UE location related event information related to
emergency sessions to the consumer NF.
**Input, Required:** Type of location related event (e.g. emergency session
initiation), UE Identification (SUPI or PEI).
**Input, Optional:** GPSI, Geodetic Location, Civic Location, Position methods
used.
**Output, Required:** None.
**Output, Optional:** None**.**
##### 5.2.2.5.4 Namf_Location_ProvideLocationInfo service operation
**Service operation name:** Namf_Location_ProvideLocationInfo
**Description:** Provides Network Provided Location Information (NPLI) of a
target UE to the consumer NF.
**Input, Required:** UE Identification (SUPI).
**Input, Optional:** 5GS Location Information Request, Current Location
Request, RAT type Requested, Local Time Zone Request.
**Output, Required:** Success/Failure indication.
**Output, Optional:** 5GS Location Information (Cell Identity, Tracking Area
Identity, Geographical/Geodetic Information, Current Location Retrieved, Age
of Location Information, Current RAT Type), Local Time Zone, Failure Cause. In
the case of non-3GPP access: a UE local IP address (used to reach the N3IWF)
and optionally UDP or TCP source port number (if NAT is detected).
### 5.2.3 UDM Services
#### 5.2.3.1 General
The following table illustrates the UDM Services.
Table 5.2.3-1: NF services provided by UDM
NF service Service Operations Operation Semantics Example Consumer(s)
* * *
Subscriber Data Get Request/Response AMF, SMF, SMSF, GMLC Management Subscribe
Subscribe/Notify AMF, SMF, SMSF (SDM) Unsubscribe Subscribe/Notify AMF, SMF,
SMSF Notification Subscribe/Notify AMF, SMF, SMSF Info Request/Response AMF UE
Context Registration Request/Response AMF, SMF, SMSF Management
DeregistrationNotification Subscribe/Notify AMF (UECM) Deregistration
Request/Response AMF, SMF, SMSF Get Request/Response NEF, SMSF, GMLC Update
Request/Response AMF, SMF PCscfRestoration Subscribe/Notify AMF, SMF UE Get
Request/Response AUSF Authentication ResultConfirmation Request/Response AUSF
EventExposure Subscribe Subscribe/Notify NEF (NOTE) Unsubscribe NEF (NOTE)
Notify NEF (NOTE) Parameter Provision Update Request/Response NEF NOTE: Other
NFs are allowed to consume the service based on roaming agreement or operator
policy.
#### 5.2.3.2 Nudm_UECM (UECM) service
##### 5.2.3.2.1 Nudm_UECM_Registration service operation
**Service operation name:** Nudm_UECM_Registration
**Description:** Register UE\'s serving NF (if NF Type is AMF, SMSF) or
Session\'s serving NF (if NF Type is SMF) on the UDM. This operation implies
the following:
\- The authorization, if applicable, to register the NF service consumer in
UDM for the UE (e.g. based on UE roaming/RAT restrictions applicable when NF
type is AMF). If this is successful, the NF service consumer is set as a
serving NF for the corresponding UE/Session context.
\- When the consumer is AMF, it is implicitly subscribed to be notified when
it is deregistered in UDM. This notification is done by means of
Nudm_UECM_DeregistrationNotification operation.
\- When the consumer is AMF or SMF, it may optionally use this operation to
subscribe to be notified of the need for P-CSCF Restoration. This notification
is done by means of Nudm_UECM_PCscfRestoration operation. For more information
regarding P-CSCF restoration procedures see TS 23.380 [38].
**Inputs, Required:** NF ID, SUPI, NF Type, Access Type (if NF Type is AMF,
SMSF), PDU Session ID (if NF Type is SMF). If NF Type is SMF: DNN or
Indication of Emergency Services, PGW-C+SMF FQDN for S5/S8 if the PDU Session
supports EPS interworking. If NF type is AMF and Access Type is 3GPP access:
Registration type. If NF type is SMSF: SMSF MAP address and/or Diameter
address.
**Inputs, Optional:** PEI (conditional, condition stated below), P-CSCF
Restoration notification information, GUAMI, backup AMF(s) (if NF Type is
AMF), \"Homogeneous Support of IMS Voice over PS Sessions\" indication (if NF
Type is AMF). Backup AMF(s) sent only once by the AMF to the UDM in its first
interaction with the UDM.
**Outputs, Required:** Result indication _._
**Outputs, Optional:** None.
If the PEI was retrieved by the AMF (either from the UE or another AMF), AMF
shall provide it to the UDM using Nudm_UECM_Registration in order to ensure
that the UDM always has the latest PEI available e.g. for reporting event
Change of SUPI-PEI association.
See step 14a of clause 4.2.2.2.2 for an example usage of this service
operation.
##### 5.2.3.2.2 Nudm_UECM_DeregistrationNotification service operation
**Service operation name:** Nudm_UECM_DeregistrationNotification.
**Description:** UDM notifies the NF consumer which has previously registered
(using Nudm_UECM_Registration operation) has been deregistered in the UDM. As
a result, the consumer is no longer registered in UDM as a serving NF for that
UE.
NOTE: This notification corresponds to an implicit subscription.
**Inputs, Required:** SUPI, Access Type, serving NF deregistration reason.
**Inputs, Optional:** None _._
**Outputs, Required:** None.
**Outputs, Optional:** None.
See step 14d of clause 4.2.2.2.2 for an example usage of this service
operation. The serving NF deregistration reason tells the reason for sending
the deregistration notification to the consumer NF.
The reason for AMF deregistration can be one of the following:
\- UE Initial Registration.
\- UE Registration area change.
\- Subscription Withdrawn.
\- 5GS to EPS Mobility.
##### 5.2.3.2.3 Nudm_UECM_Deregistration service operation
**Service operation name:** Nudm_UECM_Deregistration.
**Description:** The NF consumer requests the UDM to delete the information
related to the NF in the UE context. When the consumer is AMF, this implies
that the subscriptions to be notified when the NF is deregistered in UDM (i.e.
Nudm_UECM_DeregistrationNotification) are also removed.
**Inputs, Required:** SUPI, NF type, Access Type, S-NSSAI (if NF Type is SMF),
DNN (if NF Type is SMF), PDU Session Id (if NF Type is SMF).
\- Access Type is included only when the NF type indicates AMF or SMSF.
**Inputs, Optional:** None.
**Outputs, Required:** Result Indication.
**Outputs, Optional:** None.
##### 5.2.3.2.4 Nudm_UECM_Get service operation
**Service operation name:** Nudm_UECM_Get.
**Description:** The NF consumer requests the UDM to get the NF ID or SMS
address of the NF serving the UE.
**Inputs, Required:** UE ID, NF Type, Access Type.
\- Access Type is included only when the NF type indicates AMF.
**Inputs, Optional:** None.
**Outputs, Required:** NF ID or SMS address of the NF corresponding to the NF
type requested by NF consumer.
**Outputs, Optional:** None.
##### 5.2.3.2.5 Nudm_UECM_Update service operation
**Service operation name:** Nudm_UECM_Update.
**Description:** Consumer updates some UE related information (e.g. UE
capabilities, Intersystem continuity context, PGW-C+SMF FQDN for S5/S8
interface).
**Inputs, Required:** NF ID, SUPI, NF type, UE context information.
**Inputs, Optional:** \"Homogeneous Support of IMS Voice over PS Sessions\"
indication (if NF Type is AMF), PGW-C+SMF FQDN for S5/S8 interface (if NF Type
is SMF).
**Outputs, Required:** Result Indication.
**Outputs, Optional:** None.
##### 5.2.3.2.6 Nudm_UECM_PCscfRestoration service operation
**Service operation name:** Nudm_UECM_PCscfRestoration.
**Description:** UDM notifies the AMF and/or SMF(s) which indicated during
registration in UDM to be notified of the need for P-CSCF Restoration.
**Inputs, Required:** SUPI.
**Inputs, Optional:** None.
**Outputs, Required:** None.
**Outputs, Optional:** None.
#### 5.2.3.3 Nudm_SubscriberDataManagement (SDM) Service
##### 5.2.3.3.1 General
Subscription data types used in the Nudm_SubscriberDataManagement Service are
defined in Table 5.2.3.3.1-1 below.
Table 5.2.3.3.1-1: UE Subscription data types
+----------------------+----------------------+----------------------+ | Subscription data | Field | Description | | type | | | +======================+======================+======================+ | Access and Mobility | GPSI List | List of the GPSI | | Subscription data | | (Generic Public | | (data needed for UE | | Subscription | | | | Identifier) used | | | | _both inside and | | | | outside of the 3GPP | | | | system_ to address a | | | | 3GPP subscription. | +----------------------+----------------------+----------------------+ | Registration and | Internal Group | List of the | | Mobility Management) | ID-list | subscribed internal | | | | group(s) that the UE | | | | belongs to. | +----------------------+----------------------+----------------------+ | | Subscribed-UE-AMBR | The Maximum | | | | Aggregated uplink | | | | and downlink MBRs to | | | | be shared across all | | | | Non-GBR QoS Flows | | | | according to the | | | | subscription of the | | | | user. | +----------------------+----------------------+----------------------+ | | Subscribed S-NSSAIs | The Network Slices | | | | that the UE | | | | subscribes to. In | | | | the roaming case, it | | | | indicates the | | | | subscribed Network | | | | Slices applicable to | | | | the Serving PLMN. | +----------------------+----------------------+----------------------+ | | Default S-NSSAIs | The Subscribed | | | | S-NSSAIs marked as | | | | default S-NSSAI. In | | | | the roaming case, | | | | only those | | | | applicable to the | | | | Serving PLMN. | +----------------------+----------------------+----------------------+ | | UE Usage Type | As defined in | | | | clause 5.15.7.2 of | | | | TS 23.501 [2]. | +----------------------+----------------------+----------------------+ | | RAT restriction | 3GPP Radio Access | | | | Technology(ies) not | | | | allowed the UE to | | | | access. | +----------------------+----------------------+----------------------+ | | Forbidden area | Defines areas in | | | | which the UE is not | | | | permitted to | | | | initiate any | | | | communication with | | | | the network. | +----------------------+----------------------+----------------------+ | | Service Area | Indicates Allowed | | | Restriction | areas in which the | | | | UE is permitted to | | | | initiate | | | | communication with | | | | the network and | | | | Non-allowed areas in | | | | which the UE and the | | | | network are not | | | | allowed to initiate | | | | Service Request or | | | | SM signalling to | | | | obtain user | | | | services. | +----------------------+----------------------+----------------------+ | | Core Network type | Defines whether UE | | | restriction | is allowed to | | | | connect to 5GC | | | | and/or EPC for this | | | | PLMN. | +----------------------+----------------------+----------------------+ | | RFSP Index | An index to specific | | | | RRM configuration in | | | | the NG-RAN. | +----------------------+----------------------+----------------------+ | | Subscribed Periodic | Indicates a | | | Registration Timer | subscribed Periodic | | | | Registration Timer | | | | value. | +----------------------+----------------------+----------------------+ | | MPS priority | Indicates the user | | | | is subscribed to MPS | | | | as indicated in | | | | clause 5.16.5 of | | | | TS 23.501 [2]. | +----------------------+----------------------+----------------------+ | | MCX priority | Indicates the user | | | | is subscribed to MCX | | | | as indicated in | | | | clause 5.16.6 of | | | | TS 23.501 [2]. | +----------------------+----------------------+----------------------+ | | UE behavioural | Information on | | | information / | expected UE movement | | | Communication | and communication | | | patterns | characteristics. See | | | | clause 4.15.6.2 | +----------------------+----------------------+----------------------+ | | Steering of Roaming | List of preferred | | | | PLMN/access | | | | technology | | | | combinations or | | | | HPLMN indication | | | | that no change of | | | | the \"Operator | | | | Controlled PLMN | | | | Selector with Access | | | | Technology\" list | | | | stored in the UE is | | | | needed (see NOTE 3). | | | | | | | | Optionally includes | | | | an indication that | | | | the UDM requests an | | | | acknowledgement of | | | | the reception of | | | | this information | | | | from the UE. | +----------------------+----------------------+----------------------+ | | Network Slicing | When present, | | | Subscription Change | indicates to the | | | Indicator | serving AMF that the | | | | subscription data | | | | for network slicing | | | | changed and the UE | | | | configuration must | | | | be updated. | +----------------------+----------------------+----------------------+ | | Tracing Requirements | Trace requirements | | | | about a UE (e.g. | | | | trace reference, | | | | address of the Trace | | | | Collection Entity, | | | | etc.) is defined in | | | | TS 32.421 [39]. | | | | | | | | This information is | | | | only sent to AMF in | | | | the HPLMN or one of | | | | its equivalent | | | | PLMN(s). | +----------------------+----------------------+----------------------+ | | Inclusion of NSSAI | When present, it is | | | in RRC Connection | used to indicate | | | Establishment | that the UE is | | | Allowed | allowed to include | | | | NSSAI in the RRC | | | | connection | | | | Establishment in | | | | clear text for 3GPP | | | | access. | +----------------------+----------------------+----------------------+ | | Subscribed DNN list | List of the | | | | subscribed DNNs for | | | | the UE (NOTE 1). | | | | Used to determine | | | | the list of LADN | | | | available to the UE | | | | as defined in | | | | clause 5.6.5 of | | | | TS 23.501 [2]. | +----------------------+----------------------+----------------------+ | | UDM Update Data | Includes a set of | | | | parameters (e.g. | | | | updated Default | | | | Configured NSSAI | | | | and/or updated | | | | Routing Indicator) | | | | to be delivered from | | | | UDM to the UE via | | | | NAS signalling as | | | | defined in | | | | clause 4.20 | | | | (NOTE 3). | | | | | | | | Optionally includes | | | | an indication that | | | | the UDM requests an | | | | acknowledgement of | | | | the reception of | | | | this information | | | | from the UE and an | | | | indication for the | | | | UE to re-register. | +----------------------+----------------------+----------------------+ | Slice Selection | Subscribed S-NSSAIs | The Network Slices | | Subscription data | | that the UE | | (data needed for | | subscribes to. In | | Slice Selection as | | roaming case, it | | described in | | indicates the | | clause 4.2.2.2.3 and | | subscribed network | | in clause 4.11.0a.5) | | slices applicable to | | | | the serving PLMN. | +----------------------+----------------------+----------------------+ | UE context in AMF | AMF | Allocated AMF for | | data | | the registered UE. | | | | Include AMF address | | | | and AMF NF Id. | +----------------------+----------------------+----------------------+ | | Access Type | 3GPP or non-3GPP | | | | access through this | | | | AMF | +----------------------+----------------------+----------------------+ | | Homogenous Support | Indicates per UE and | | | of IMS Voice over PS | AMF if \"IMS Voice | | | Sessions for AMF | over PS Sessions\" | | | | is homogeneously | | | | supported in all TAs | | | | in the serving AMF | | | | or homogeneously not | | | | supported, or, | | | | support is | | | | non- | | | | homogeneous/unknown, | | | | see clause 5.16.3.3 | | | | of TS 23.501 [2]. | +----------------------+----------------------+----------------------+ | SMF Selection | SUPI | Key | +----------------------+----------------------+----------------------+ | Subscription data | **SMF Selection | | | (data needed for SMF | Subscription data | | | | contains one or more | | | | S-NSSAI level | | | | subscription data:** | | +----------------------+----------------------+----------------------+ | Selection as | S-NSSAI | Indicates the value | | described | | of the S-NSSAI. | +----------------------+----------------------+----------------------+ | in clause 6.3.2 of | Subscribed DNN list | List of the | | | | subscribed DNNs for | | | | the UE (NOTE 1). | +----------------------+----------------------+----------------------+ | TS 23.501 [2]) | Default DNN | The default DNN if | | | | the UE does not | | | | provide a DNN | | | | (NOTE 2). | +----------------------+----------------------+----------------------+ | | LBO Roaming | Indicates whether | | | Information | LBO roaming is | | | | allowed per DNN, or | | | | per (S-NSSAI, | | | | subscribed DNN) | +----------------------+----------------------+----------------------+ | | Interworking with | Indicates for which | | | EPS indication list | DNN from the | | | | Subscribed DNN list | | | | interworking is | | | | supported. | +----------------------+----------------------+----------------------+ | UE context in SMF | SUPI | Key | +----------------------+----------------------+----------------------+ | data | PDU Session Id(s) | List of PDU Session | | | | Id(s) for the UE | +----------------------+----------------------+----------------------+ | | **For emergency PDU | | | | Session Id:** | | +----------------------+----------------------+----------------------+ | | Emergency | The PGW-C+SMF FQDN | | | Information | for emergency | | | | session used for | | | | interworking with | | | | EPC. | +----------------------+----------------------+----------------------+ | | **For each | | | | non-emergency PDU | | | | Session Id:** | | +----------------------+----------------------+----------------------+ | | DNN | DNN for the PDU | | | | Session. | +----------------------+----------------------+----------------------+ | | SMF | Allocated SMF for | | | | the PDU Session. | | | | Includes SMF IP | | | | Address and SMF NF | | | | Id. | +----------------------+----------------------+----------------------+ | | PGW-C+SMF FQDN | The S5/S8 PGW-C+SMF | | | | FQDN used for | | | | interworking with | | | | EPS (see NOTE 4). | +----------------------+----------------------+----------------------+ | SMS Management | SMS parameters | Indicates SMS | | Subscription data | | parameters | | (data needed by | | subscribed for SMS | | | | service such as SMS | | | | teleservice, SMS | | | | barring list | +----------------------+----------------------+----------------------+ | SMSF for SMSF | Trace Requirements | Trace requirements | | Registration) | | about a UE (e.g. | | | | trace reference, | | | | address of the Trace | | | | Collection Entity, | | | | etc.) is defined in | | | | TS 32.421 [39]. | | | | | | | | This information is | | | | only sent to a SMSF | | | | in HPLMN. | +----------------------+----------------------+----------------------+ | SMS Subscription | SMS Subscription | Indicates | | data | | subscription to any | | | | SMS delivery service | | | | over NAS | | | | irrespective of | | | | access type. | +----------------------+----------------------+----------------------+ | (data needed in AMF) | | | +----------------------+----------------------+----------------------+ | UE Context in SMSF | SMSF Information | Indicates SMSF | | data | | allocated for the | | | | UE, including SMSF | | | | address and SMSF NF | | | | ID. | +----------------------+----------------------+----------------------+ | | Access Type | 3GPP or non-3GPP | | | | access through this | | | | SMSF | +----------------------+----------------------+----------------------+ | Session Management | GPSI List | List of the GPSI | | Subscription data | | (Generic Public | | (data needed for PDU | | Subscription | | | | Identifier) used | | | | _both inside and | | | | outside of the 3GPP | | | | system_ to address a | | | | 3GPP subscription. | +----------------------+----------------------+----------------------+ | Session | Internal Group | List of the | | Establishment) | ID-list | subscribed internal | | | | group(s) that the UE | | | | belongs to. | +----------------------+----------------------+----------------------+ | | Trace Requirements | Trace requirements | | | | about a UE (e.g. | | | | trace reference, | | | | address of the Trace | | | | Collection Entity, | | | | etc...) is defined | | | | in TS 32.421 [39]. | | | | | | | | This information is | | | | only sent to a SMF | | | | in the HPLMN or one | | | | of its equivalent | | | | PLMN(s). | +----------------------+----------------------+----------------------+ | | **Session Management | | | | Subscription data | | | | contains one or more | | | | S-NSSAI level | | | | subscription data:** | | +----------------------+----------------------+----------------------+ | | S-NSSAI | Indicates the value | | | | of the S-NSSAI. | +----------------------+----------------------+----------------------+ | | Subscribed DNN list | List of the | | | | subscribed DNNs for | | | | the S-NSSAI | | | | (NOTE 1). | +----------------------+----------------------+----------------------+ | | **For each DNN in | | | | S-NSSAI level | | | | subscription data:** | | +----------------------+----------------------+----------------------+ | | DNN | DNN for the PDU | | | | Session. | +----------------------+----------------------+----------------------+ | | Allowed PDU Session | Indicates the | | | Types | allowed PDU Session | | | | Types (IPv4, IPv6, | | | | IPv4v6, Ethernet and | | | | Unstructured) for | | | | the DNN, S-NSSAI. | +----------------------+----------------------+----------------------+ | | Default PDU Session | Indicates the | | | Type | default PDU Session | | | | Type for the DNN, | | | | S-NSSAI. | +----------------------+----------------------+----------------------+ | | Allowed SSC modes | Indicates the | | | | allowed SSC modes | | | | for the DNN, | | | | S-NSSAI. | +----------------------+----------------------+----------------------+ | | Default SSC mode | Indicate the default | | | | SSC mode for the | | | | DNN, S-NSSAI. | +----------------------+----------------------+----------------------+ | | Interworking with | Indicates whether | | | EPS indication | interworking with | | | | EPS is supported for | | | | this DNN and | | | | S-NSSAI. | +----------------------+----------------------+----------------------+ | | 5GS Subscribed QoS | The QoS Flow level | | | profile | QoS parameter values | | | | (5QI and ARP) for | | | | the DNN, S-NSSAI | | | | (see clause 5.7.2.7 | | | | of TS 23.501 [2]). | +----------------------+----------------------+----------------------+ | | Charging | It contains Charging | | | Characteristics | Characteristics as | | | | defined in Annex A, | | | | clause A.1 of | | | | TS 32.255 [45]. | | | | This information, | | | | when provided shall | | | | override any | | | | corresponding | | | | predefined | | | | information at the | | | | SMF. | +----------------------+----------------------+----------------------+ | | Sub | The maximum | | | scribed-Session-AMBR | aggregated uplink | | | | and downlink MBRs to | | | | be shared across all | | | | Non-GBR QoS Flows in | | | | each PDU Session, | | | | which are | | | | established for the | | | | DNN, S-NSSAI. | +----------------------+----------------------+----------------------+ | | Static IP | Indicate the static | | | address/prefix | IP address/prefix | | | | for the DNN, | | | | S-NSSAI. | +----------------------+----------------------+----------------------+ | | User Plane Security | Indicates the | | | Policy | security policy for | | | | integrity protection | | | | and encryption for | | | | the user plane. | +----------------------+----------------------+----------------------+ | Identifier | SUPI | Corresponding SUPI | | translation | | for input GPSI | +----------------------+----------------------+----------------------+ | | (Optional) MSISDN | Corresponding GPSI | | | | (MSISDN) for input | | | | GPSI (External | | | | Identifier). This is | | | | optionally provided | | | | for legacy SMS | | | | infrastructure not | | | | supporting | | | | MSISDN-less SMS. The | | | | presence of an | | | | MSISDN should be | | | | interpreted as an | | | | indication to the | | | | NEF that MSISDN | | | | shall be used to | | | | identify the UE when | | | | sending the SMS to | | | | the SMS-SC via T4. | +----------------------+----------------------+----------------------+ | Intersystem | (DNN, PGW FQDN) list | For each DNN, | | continuity Context | | indicates the | | | | PGW-C+SMF which | | | | support interworking | | | | with EPC. | +----------------------+----------------------+----------------------+ | NOTE 1: The | | | | Subscribed DNN list | | | | can include a | | | | wildcard DNN. | | | | | | | | NOTE 2: The default | | | | DNN shall not be a | | | | wildcard DNN. | | | | | | | | NOTE 3: The Steering | | | | of Roaming | | | | information and UDM | | | | Update Data are | | | | protected using the | | | | mechanisms defined | | | | in TS 33.501 [15]. | | | | | | | | NOTE 4: Depending on | | | | the scenario PGW-C | | | | FQDN may be for | | | | S5/S8, or for S2b | | | | (ePDG case). | | | +----------------------+----------------------+----------------------+
Table 5.2.3.3.1-2: Group Subscription data types
Subscription data type Field Description
* * *
Group Identifier translation External Group Identifier Identifies external
group of UEs that the UE belongs to as defined in TS 23.682 [23] (Optional)
Internal Group Identifier Identifies internal group of UEs that the UE belongs
to as defined in TS 23.501 [2] SUPI list Corresponding SUPI list for input
External Group Identifier
At least a mandatory key is required for each Subscription Data Type to
identify the corresponding data. Depending on the use case, for some
Subscription Data Types it is possible to use one or multiple sub keys to
further identify the corresponding data, as defined in Tables 5.2.3.3.1-3 and
5.2.3.3.1-4 below.
Table 5.2.3.3.1-3: UE Subscription data types keys
Subscription Data Types Data Key Data Sub Key
* * *
Access and Mobility Subscription data SUPI - SMF Selection Subscription data
SUPI - UE context in SMF data SUPI S-NSSAI SMS Management Subscription data
SUPI - SMS Subscription data SUPI  
UE Context in SMSF data SUPI  
Session Management Subscription data SUPI S-NSSAI DNN Identifier translation
GPSI - Slice Selection Subscription data SUPI - Intersystem continuity Context
SUPI DNN
Table 5.2.3.3.1-4: Group Subscription data types keys
Subscription Data Types Data Key Data Sub Key
* * *
Group Identifier translation External Group Identifier
##### 5.2.3.3.2 Nudm_SDM_Get service operation
**Service Operation name** : Nudm_SDM_Get
**Description** : Consumer NF gets the subscriber data indicated by the
subscription data type input from UDM. The UDM shall check the requested
consumer is authorized to get the specific subscription data requested. In the
case of NF consumer is SMF, the subscriber data may contain e.g. Allowed PDU
Session Type(s), Allowed SSC mode(s), default 5QI/ARP, Subscribed S-NSSAI(s).
**Inputs, Required:** NF ID, Subscription data type(s), Key for each
Subscription data type(s).
**Inputs, Optional:** Data Sub Key(s).
**Outputs, Required:** The consumer NF gets the requested subscription data.
**Outputs, Optional:** None.
##### 5.2.3.3.3 Nudm_SDM_Notification service operation
**Service or service operation name:** Nudm_SDM_Notification
**Description:** The UDM notifies NF consumer of the updates of UE\'s
Subscriber Data indicated by the \"subscription data Type\" input and
additional UE\'s UDM-related parameters.
**Inputs, Required:** Subscription data type(s), Key for each Subscription
data type(s).
**Inputs, Optional:** None _._
**Outputs, Required:** Result Indication.
The UDM invokes this service operation under the following cases:
\- When the subscriber data is updated at the UDM, the updated subscription
information is notified to the serving NF that has subscribed for the specific
subscription data type to be notified.
\- When the UDM needs to deliver Steering of Roaming information to a UE.
\- When the UDM needs to deliver UDM Update Data to a UE (e.g. a new Routing
Indicator or Default Configured NSSAI to the UE).
If updates subscription information is related to session management the
subscriber data may contain e.g. Allowed PDU Session Type(s), Allowed SSC
mode(s), default 5QI/ARP.
**Outputs, Optional:** Redirection information.
If the NF consumer is AMF and if the result of the service operation fails,
AMF shall set corresponding cause value in result indication which can be used
by the UDM for further action. If the related UE is not served by the AMF and
the AMF knows which AMF is serving the UE, the AMF provides redirection
information which can be used by the UDM to resend UE related message to the
AMF that serves the UE.
##### 5.2.3.3.4 Nudm_SDM_Subscribe service operation
**Service operation name:** Nudm_SDM_Subscribe
**Description:** The NF consumer subscribes for updates to UE\'s Subscriber
Data indicated by the \'subscription data type\' input. The UDM shall check
the requested consumer is authorized to subscribe to requested updates.
**Inputs, Required:** Subscription data type(s), Key for each Subscription
data type(s).
**Inputs, Optional:** Data Sub Key(s).
**Outputs, Required:** None.
**Outputs, Optional:** None.
##### 5.2.3.3.5 Nudm_SDM_Unsubscribe service operation
**Service operation name:** Nudm_SDM_Unsubscribe
**Description:** The NF consumer unsubscribes from updates to UE\'s Subscriber
Data indicated by the \'subscription data type\' input.
**Inputs, Required:** Subscription data type(s), Key for each Subscription
data type(s).
**Inputs, Optional:** If the NF type is SMF: DNN, S-NSSAI.
**Outputs, Required:** None.
**Outputs, Optional:** None.
##### 5.2.3.3.6 Nudm_SDM_Info service operation
**Service Operation name:** Nudm_SDM_Info
**Description:** Consumer NF provides UDM with information about the status of
the subscription data management procedures. This service operation is used
for:
\- providing acknowledgement from the UE to UDM about successful delivery of
Steering of Roaming information via the AMF as defined in TS 23.122 [22].
\- providing acknowledgement from the UE to UDM about successful Network
Slicing Configuration subsequent to delivery of the Network Slicing
Subscription Change Indication via the AMF.
\- providing acknowledgement from the UE to UDM about successful delivery of
UDM Update Data via the AMF as defined in clause 4.20.
**Inputs, Required:** SUPI, Info (e.g. UE acknowledgment of SoR information
from UDM via AMF, UE acknowledgement of successful Network Slicing
Configuration subsequent to delivery of the Network Slicing Subscription
Change Indication via the AMF).
**Inputs, Optional:** None.
**Outputs, Required:** None.
**Outputs, Optional:** None.
#### 5.2.3.4 Nudm_UEAuthentication Service
##### 5.2.3.4.1 General
This service is used by the requester NF to get authentication data and
provide UDM with the result of the authentication procedure success.
##### 5.2.3.4.2 Nudm_UEAuthentication_Get service operation
See TS 33.501 [15].
##### 5.2.3.4.3 Nudm_UEAuthentication_ResultConfirmation service operation
See TS 33.501 [15].
#### 5.2.3.5 Nudm_EventExposure service
##### 5.2.3.5.1 General
See clause 4.15.3.1.
##### 5.2.3.5.2 Nudm_EventExposure_Subscribe service operation
**Service operation name:** Nudm_EventExposure_Subscribe
**Description:** The NF consumer subscribes to receive an event, or if the
subscription is already defined in UDM, then the subscription is updated.
**NF Consumers:** NEF**.**
**Inputs (required):** target of the subscription: UE(s) ID (SUPI or GPSI,
Internal Group Identifier or External Group Identifier, or indication that any
UE is targeted), Event filter containing the Event Id(s) (see clause 4.15.3.1)
and Event Reporting Information defined in Table 4.15.1-1.
**Inputs (optional):** Expiry time.
**Outputs (required):** Operation execution result indication _._ When the
subscription is accepted: Subscription Correlation ID, Expiry time (required
if the subscription can be expired based on the operator\'s policy).
**Outputs (optional):** First corresponding event report is included, if
corresponding information is available (see clause 4.15.1), Number of UE if
the External Group Identifier and Maximum Number of Reports are included in
the inputs.
Number of UEs indicates the number of UEs within the group identified by the
External Group Identifier. The NEF uses this value to determine whether the
monitoring event has been reported for all group member UEs.
##### 5.2.3.5.3 Nudm_EventExposure_Unsubscribe service operation
**Service operation name:** Nudm_EventExposure_Unsubscribe
**Description:** the consumer deletes the subscription of an event if already
defined in UDM.
**Inputs (required):** Subscription Correlation ID.
**Outputs (required):** Operation execution result indication _._
##### 5.2.3.5.4 Nudm_EventExposure_Notify service operation
**Service operation name:** Nudm_EventExposure_Notify
**Description:** UDM reports the event to the consumer that has previously
subscribed.
**Inputs (required):** Event ID, Notification Correlation Information, time
stamp.
**Inputs (optional):** Event specific parameters list.
**Outputs (required):** None _._
#### 5.2.3.6 Nudm_ParameterProvision service
##### 5.2.3.6.1 General
This service is for allowing NEF to provision of information which can be used
for the UE in 5GS.
##### 5.2.3.6.2 Nudm_ParameterProvision_Update service operation
**Service operation name:** Nudm_ParameterProvision_Update.
**Description:** the consumer updates the UE related information (e.g.
Expected UE Behaviour).
**Inputs (required):** GPSI, AF ID, Transaction Reference ID(s).
**Inputs (optional):** Any combination of the Expected UE Behaviour
parameters.
**Outputs (required):** Transaction Reference ID(s), Operation execution
result indication.
**Outputs (optional):** Transaction specific parameters, if available.
### 5.2.4 5G-EIR Services
#### 5.2.4.1 General
The following table illustrates the 5G-EIR Service.
Table 5.2.4-1: NF services provided by 5G-EIR
NF service Service Operations Operation Semantics Example Consumer(s)
* * *
N5g-eir_Equipment Identity Check Get Request/Response AMF
#### 5.2.4.2 N5g-eir_EquipmentIdentityCheck service
##### 5.2.4.2.1 General
Service Description: This service is provided by the 5G-EIR to check the PEI
and check whether the PEI is in the black list or not. The service can be
consumed by AMF. The service operations provided within this service are
depicted as below.
##### 5.2.4.2.2 N5g-eir_EquipmentIdentityCheck_Get service operation
**Service operation name:** N5g-eir_EquipmentIdentityCheck_Get
**Description:** Check the PEI and determine whether the subscriber is allowed
to use the equipment.
**Inputs, Required:** PEI, SUPI.
**Inputs, Optional:** none
**Outputs, Required:** PEI checking result
**Outputs, Optional:** none
### 5.2.5 PCF Services
#### 5.2.5.1 General
The following table illustrates the PCF Services.
Table 5.2.5.1-1: NF services provided by PCF
+----------------+----------------+----------------+----------------+ | Service Name | Service | Operation | Example | | | Operations | | Consumer (s) | | | | Semantics | | +================+================+================+================+ | Npcf_A | Create | Re | AMF | | MPolicyControl | | quest/Response | | +----------------+----------------+----------------+----------------+ | | Update | Re | AMF | | | | quest/Response | | +----------------+----------------+----------------+----------------+ | | UpdateNotify | Su | AMF | | | | bscribe/Notify | | +----------------+----------------+----------------+----------------+ | | Delete | Re | AMF | | | | quest/Response | | +----------------+----------------+----------------+----------------+ | Npcf_Policy | Create | Re | AF, NEF | | Authorization | | quest/Response | | +----------------+----------------+----------------+----------------+ | | Update | Re | AF, NEF | | | | quest/Response | | +----------------+----------------+----------------+----------------+ | | Delete | Re | AF, NEF | | | | quest/Response | | +----------------+----------------+----------------+----------------+ | | Notify | Su | AF, NEF | | | | bscribe/Notify | | +----------------+----------------+----------------+----------------+ | | Subscribe | | AF, NEF | +----------------+----------------+----------------+----------------+ | | Unsubscribe | | AF, NEF | +----------------+----------------+----------------+----------------+ | Npcf_S | Create | Re | SMF | | MPolicyControl | | quest/Response | | +----------------+----------------+----------------+----------------+ | | UpdateNotify | Su | SMF | | | | bscribe/Notify | | +----------------+----------------+----------------+----------------+ | | Update | Re | SMF | | | | quest/Response | | +----------------+----------------+----------------+----------------+ | | Delete | Re | SMF | | | | quest/Response | | +----------------+----------------+----------------+----------------+ | Npcf_BD | Create | Re | NEF | | TPolicyControl | | quest/Response | | +----------------+----------------+----------------+----------------+ | | Update | Re | NEF | | | | quest/Response | | +----------------+----------------+----------------+----------------+ | Npcf_U | Create | Re | AMF, V-PCF | | EPolicyControl | | quest/Response | | +----------------+----------------+----------------+----------------+ | | Update | Re | AMF, V-PCF | | | | quest/Response | | +----------------+----------------+----------------+----------------+ | | UpdateNotify | Su | AMF, V-PCF | | | | bscribe/Notify | | +----------------+----------------+----------------+----------------+ | | Delete | Re | AMF, V-PCF | | | | quest/Response | | +----------------+----------------+----------------+----------------+ | Npcf\ | Subscribe | Su | NEF | | _EventExposure | | bscribe/Notify | | +----------------+----------------+----------------+----------------+ | | * | | | | | _Unsubscribe_ _| | | +----------------+----------------+----------------+----------------+ | |__Notify_ * | | | +----------------+----------------+----------------+----------------+
#### 5.2.5.2 Npcf_AMPolicyControl service
##### 5.2.5.2.1 General
**Service description:** NF Service Consumer, e.g. AMF, can create and manage
a AM Policy Association in the PCF through which the NF Service Consumer
receives AM policy control information for a UE identified by a SUPI.
As part of this service, the PCF may provide the NF Service Consumer, e.g.
AMF, with AM policy information for a SUPI that may contain:
\- Access and mobility related policy information as defined in clause 6.5 of
TS 23.503 [20]. In the case of roaming, this information is provided by V-PCF;
\- Policy Control Request Trigger of AM Policy Association. When such a Policy
Control Request Trigger condition is met the NF Service Consumer, e.g. shall
contact PCF and provide information on the Policy Request Trigger condition
that has been met. In the case of roaming, the V-PCF may subscribe to AMF.
At Npcf_AMPolicyControl_Create, the NF Service Consumer, e.g. AMF requests the
creation of a corresponding \"AM Policy Association\" with the PCF
(Npcf_AMPolicyControl_Create) and provides relevant parameters about the UE
context to the PCF. When the PCF has created the AM Policy Association, the
PCF may provide policy information as defined above.
When a Policy Control Request Trigger condition is met the NF Service
Consumer, e.g. AMF requests the update (Npcf_AMPolicyControl_Update) of the AM
Policy Association by providing information on the condition(s) that have been
met. The PCF may provide updated policy information to the NF Service
Consumer.
The PCF may at any time provide updated policy information
(Npcf_AMPolicyControl_UpdateNotify);
At UE deregistration the NF Service Consumer, e.g. AMF requests the deletion
of the corresponding AM Policy Association.
##### 5.2.5.2.2 Npcf_AMPolicyControl_Create service operation
**Service operation name:** Npcf_AMPolicyControl_Create
**Description:** NF Service Consumer can request the creation of a AM Policy
Association and by providing relevant parameters about the UE context to the
PCF.
**Inputs, Required:** SUPI.
**Inputs, Optional:** Information provided by the AMF as define in 6.2.1.2 of
TS 23.503 [20], such as Access Type, Permanent Equipment Identifier, GPSI,
User Location Information, UE Time Zone, Serving Network, RAT type, List of
subscribed Service Area Restrictions, subscribed RFSP Index, the Allowed
NSSAI, GUAMI, backup AMF(s) (if NF Type is AMF). Backup AMF(s) sent only once
by the AMF to the PCF in its first interaction with the PCF.
**Outputs, Required:** AM Policy Association ID _._
**Outputs, Optional:** The requested Access and mobility related policy
information as defined in Clause 6.5 of TS 23.503 [20] and Policy Control
Request Trigger of AM Policy Association.
See clause 4.2.2.2.2 (step 16) for the detail usage of this service operation
for AMF. In step 16, the AMF requests the PCF to apply operator policies for
the UE.
See clause 4.16.1.2 (steps 2 and 3) for the detail usage of this service
operation for AMF. In step 2, the AMF requests the PCF to apply operator
policies for the UE; in step 3, the PCF acknowledges AMF with requested
policy.
See clause 4.16.1.3 (steps 3 and 4) for the detail usage of this service
operation for AMF. In step 3, the AMF requests the PCF to apply operator
policies for the UE; in step 4, the PCF acknowledges AMF with requested
policy.
##### 5.2.5.2.3 Npcf_AMPolicyControl_UpdateNotify service operation
**Service operation name:** Npcf_AMPolicyControl_UpdateNotify
**Description:** Provides to the NF Service Consumer, e.g. AMF, updated AM
related Policy information for the AM Policy Association as defined in clause
6.5 of TS 23.503 [20].
NOTE: This notification corresponds to an implicit subscription.
**Inputs, Required:** AM Policy Association ID.
**Inputs, Optional:** Access and Mobility related information or indication of
AM Policy Association termination.
**Outputs, Required:** Success or failure.
**Outputs, Optional:** None.
See clause 4.16.2.2 for the usage of this service operation.
##### 5.2.5.2.4 Npcf_AMPolicyControl_Delete service operation
**Service operation name:** Npcf_AMPolicyControl_Delete
**Description:** Provides means for the NF Consumer to delete the AM Policy
Association.
**Inputs, Required:** AM Policy Association ID.
**Inputs, Optional:** None.
**Outputs, Required:** Success or Failure.
**Outputs, Optional:** None.
See clause 4.16.3.2 (step 2 and 3) for the detail usage of this service
operation for AMF. In step 2, the AMF initiates the AM Policy Association
Termination procedure; in step 3 the PCF deletes the AM Policy Association for
this AM Policy Association ID.
##### 5.2.5.2.5 Npcf_AMPolicyControl_Update service operation
**Service operation name:** Npcf_AMPolicyControl_Update.
**Description:** NF Service Consumer, e.g. AMF can request the update of the
AM Policy Association to receive updated Policy information for the UE context
when the policy control request trigger is met or the AMF is relocated due to
the UE mobility and the old PCF is selected.
**Inputs, Required:** AM Policy Association ID.
**Inputs, Optional:** Information on the Policy Control Request Trigger
condition that has been met as defined in clause 6.1.2.5 of TS 23.503 [20],
GUAMI(s) (if NF Type is AMF).
**Outputs, Required:** Success or not.
**Outputs, Optional:** Policy information for the UE context as defined in
clause 5.2.5.2.1.
See clause 4.16.2.1 for the usage of this service operation.
#### 5.2.5.3 Npcf_PolicyAuthorization Service
##### 5.2.5.3.1 General
**Service description:** This service is to authorise an AF request and to
create policies as requested by the authorized AF for the PDU Session to which
the AF session is bound. This service allows the NF consumer to
subscribe/unsubscribe the notification of events, which are defined in clause
6.1.3.18 of TS 23.503 [20].
##### 5.2.5.3.2 Npcf_PolicyAuthorization_Create service operation
**Service operation name:** Npcf_PolicyAuthorization_Create
**Description:** Authorize the request and optionally determines and installs
the policy according to the information provided by the NF Consumer.
**Inputs, Required:** UE (IP or MAC) address, identification of the
application session context.
**Inputs, Optional:** UE identity if available, DNN if available, S-NSSAI if
available, Media type, Media format, bandwidth requirements, sponsored data
connectivity if applicable, flow description, Application identifier or
traffic filtering information, AF Communication Service Identifier, AF Record
Identifier, Flow status, Priority indicator, emergency indicator, Application
service provider, resource allocation outcome, AF Application Event
Identifier, a list of DNAI(s) and corresponding routing profile ID(s) or N6
traffic routing information, AF Transaction Id, Early and/or late
notifications about UP path management events, temporal validity condition and
spatial validity condition as described in clause 5.6.7 in 23.501 [2],
Background Data Transfer Reference ID.
**Outputs, Required:** Success or Failure.
**Outputs, Optional:** The service information that can be accepted by the
PCF.
Authorizes the request from the application and optionally communicates with
Npcf_SMPolicyControl service to determine and install the policy according to
the information provided by the NF Consumer. Creates an application context in
the PCF.
##### 5.2.5.3.3 Npcf_PolicyAuthorization_Update service operation
**Service operation name:** Npcf_PolicyAuthorization_Update
**Description:** Provides updated information to the PCF.
**Inputs, Required:** Identification of the application session context.
**Inputs, Optional:** Media type, Media format, bandwidth requirements,
sponsored data connectivity if applicable, flow description, Application
identifier or traffic filtering information, AF Communication Service
Identifier, AF Record Identifier, Flow status, Priority indicator, Application
service provider, resource allocation outcome, AF Application Event
Identifier, a list of DNAI(s) and corresponding routing profile ID(s) or N6
traffic routing information, AF Transaction Id, Early and/or late
notifications about UP path management events, temporal validity condition and
spatial validity condition as described in clause 5.6.7 in 23.501 [2],
Background Data Transfer Reference ID.
**Outputs, Required:** Success or Failure.
**Outputs, Optional:** The service information that can be accepted by the
PCF.
Provides updated application level information and communicates with
Npcf_SMPolicyControl service to determine and install the policy according to
the information provided by the NF Consumer. Updates an application context in
the PCF.
##### 5.2.5.3.4 Npcf_PolicyAuthorization_Delete service operation
**Service operation name:** Npcf_PolicyAuthorization_Delete
**Description:** Provides means for the NF Consumer to delete the context of
application level session information.
**Inputs, Required:** Identification of the application session context.
**Inputs, Optional:** None.
**Outputs, Required:** None.
**Outputs, Optional:** None.
##### 5.2.5.3.5 Npcf_PolicyAuthorization_Notify service operation
**Service operation name:** Npcf_PolicyAuthorization_Notify
**Description:** provided by the PCF to notify NF consumers of the subscribed
events.
**Inputs, Required:** Event ID, Notification Correlation Information
(information to identify the application session).
The events that can be subscribed are defined in clause 6.1.3.18 of TS 23.503
[20].
**Inputs, Optional:** Event information (defined on a per Event ID basis).
**Outputs, Required:** Operation execution result indication.
**Outputs, Optional:** None
##### 5.2.5.3.6 Npcf_PolicyAuthorization_Subscribe service operation
**Service operation name:** Npcf_PolicyAuthorization_Subscribe
**Description:** provided by the PCF for NF consumers to explicitly subscribe
the notification of events.
**Inputs, Required:** (Set of) Event ID(s) as specified in
Npcf_PolicyAuthorization_Notify service operation, target of PCF event
reporting (defined below), NF ID, Event Reporting Information defined in Table
4.15.1-1 except for the Maximum number of reports and Maximum duration of
reporting, Notification Target Address (+ Notification Correlation ID).
The target of PCF event reporting the subscription for an individual AF
session: An UE IP address (IPv4 address or IPv6 prefix) optionally together
with a (DNN, S-NSSAI) or with a UE ID (SUPI or GPSI).
**Inputs, Optional:** Event Filter, Subscription Correlation ID (in the case
of modification of the event subscription).
**Outputs, Required:** When the subscription is accepted: Subscription
Correlation ID.
**Outputs, Optional:** None _._
##### 5.2.5.3.7 Npcf_PolicyAuthorization_Unsubscribe service operation
**Service operation name:** Npcf_PolicyAuthorization_Unsubscribe
**Description:** Enable NF consumers to explicitly unsubscribe the
notification of PCF events related to Npcf_PolicyAuthorization_Subscribe
operation.
**Inputs, Required:** Subscription Correlation.
**Inputs, Optional:** None.
**Outputs, Required:** Success or Failure.
**Outputs, Optional:** None _._
#### 5.2.5.4 Npcf_SMPolicyControl service
##### 5.2.5.4.1 General
**Service description:** NF Service Consumer, e.g. SMF can create and manage a
SM Policy Association in the PCF through which the NF Service Consumer
receives policy information for a PDU Session.
As part of this service, the PCF may provide the NF Service Consumer, e.g. SMF
with policy information about the PDU Session that may contain:
\- PDU Session related policy information as defined in clause 6.4 of TS
23.503 [20].
\- PCC rule information as defined in clause 6.3 of TS 23.503 [20].
\- Policy Control Request Trigger information i.e. a set of Policy Request
Trigger(s) as defined in clause 6.1.3.5 of TS 23.503 [20]. When a Policy
Control Request Trigger condition is met the NF Service Consumer, e.g. SMF
shall contact the PCF and provide information on the Policy Control Request
Trigger condition that has been met.
At PDU Session establishment the NF Service Consumer, e.g. SMF requests the
creation of a corresponding SM Policy Association with the PCF
(Npcf_SMPolicyControl_Create) and provides relevant parameters about the PDU
Session to the PCF.
\- When the PCF has created the \"SM Policy Association, the PCF may provide
policy information as defined above.
When a Policy Control Request Trigger condition is met the NF Service
Consumer, e.g. SMF requests the update(Npcf_SMPolicyControl_Update) of the SM
Policy Association by providing information on the condition(s) that have been
met. The PCF may provide updated policy information to the NF Service
Consumer.
The PCF may at any time provide updated policy information
(Npcf_SMPolicyControl_UpdateNotify).
At PDU Session release the NF Service Consumer, e.g. SMF requests the deletion
of the corresponding SM Policy Association.
##### 5.2.5.4.2 Npcf_SMPolicyControl_Create service operation
**Service operation name:** Npcf_SMPolicyControl_Create
**Description:** The NF Service Consumer can request the creation of a SM
Policy Association and provide relevant parameters about the PDU Session to
the PCF.
**Inputs, Required:** SUPI (or PEI in the case of emergency PDU Session
without SUPI), PDU Session id, DNN and S-NSSAI.
**Inputs, Optional:** Information provided by the SMF as defined in clause
6.2.1.2 of TS 23.503 [20], such as Access Type, the IPv4 address and/or IPv6
prefix, PEI, GPSI, User Location Information, UE Time Zone, Serving Network,
RAT type, Charging Characteristics information, Session AMBR, subscribed
default QoS information, Trace Requirements and Internal Group Identifier (see
clause 5.9.7 of TS 23.501 [2]), DN Authorization Profile Index.
NOTE: If SMF receives the DN authorized Session AMBR from the DN-AAA at PDU
session establishment, it includes the DN authorized Session AMBR within the
Session-AMBR, instead of the subscribed Session AMBR received from the UDM, in
the request.
**Outputs, Required:** SM Policy Association ID defined in TS 29.512 [48].
**Outputs, Optional:** Policy information for the PDU Session as defined in
clause 5.2.5.4.1.
See clause 4.16.4 for the detail usage of this service operation.
##### 5.2.5.4.3 Npcf_SMPolicyControl_UpdateNotify service operation
**Service operation name:** Npcf_SMPolicyControl_UpdateNotify
**Description:** Provides to the NF Service Consumer, e.g. SMF updated Policy
information for the PDU Session evaluated based on the information previously
provided by the SMF, AF, CHF, UDR and NWDAF, as defined in clause 6.2.1.2 of
TS 23.503 [20],
**Inputs, Required:** SM Policy Association ID.
**Inputs, Optional:** Policy information for the PDU Session as defined in
clause 5.2.5.4.1.
**Outputs, Required:** Success or Failure.
**Outputs, Optional:** None.
See clause 4.16.5.2 for the usage of this service operation.
##### 5.2.5.4.4 Npcf_SMPolicyControl_Delete service operation
**Service operation name:** Npcf_SMPolicyControl_Delete
**Description:** The NF Service Consumer can request the deletion of the SM
Policy Association and of the associated resources.
**Inputs, Required:** SM Policy Association ID.
**Inputs, Optional:** None.
**Outputs, Required:** Success or Failure.
**Outputs, Optional:** None.
See clause 4.16.6 for the usage of this service operation.
##### 5.2.5.4.5 Npcf_SMPolicyControl_Update service operation
**Service operation name:** Npcf_SMPolicyControl_Update
**Description:** The NF Service Consumer can request the update of the SM
Policy Association to receive updated Policy information for the PDU Session.
**Inputs, Required:** SM Policy Association ID.
**Inputs, Optional:** Information on the Policy Control Request Trigger
condition, as defined in clause 6.1.3.5 of TS 23.503 [20], that has been met
such as Access Type, (new or removed) IPv4 address and/or IPv6 network prefix,
User Location Information, UE Time Zone, Serving Network, RAT type, Session
AMBR, or subscribed default QoS information, DN Authorization Profile Index.
**Outputs, Required:** Success or not.
**Outputs, Optional:** Policy information for the PDU Session as defined in
clause 5.2.5.4.1.
See clause 4.16.5.1 for the usage of this service operation.
NOTE: When this service operation is invoked by SMF, race conditions apply,
which are defined in TS 29.513 [47].
#### 5.2.5.5 Npcf_BDTPolicyControl Service
##### 5.2.5.5.1 General
**Service description:** This service provides background data transfer
policy, which includes the following functionalities:
\- Get background data transfer policies based on the request via NEF from AF;
and
\- Update background data transfer based on the selection provided by AF.
##### 5.2.5.5.2 Npcf_BDTPolicyControl_Create service operation
**Service operation name:** Npcf_BDTPolicyControl_Create
**Description:** This service is to create the background data transfer
policy.
**Inputs, Required:** ASP identifier, Volume per UE, Number of UEs, Desired
time windows.
**Inputs, Optional:** Network Area Information.
**Outputs, Required:** one or more background data transfer policies,
Background Data Transfer Reference ID _._
**Outputs, Optional:** None _._
##### 5.2.5.5.3 Npcf_BDTPolicyControl_Update service operation
**Service operation name:** Npcf_BDTPolicyControl_Update
**Description:** This service is to update the background data transfer policy
to the PCF.
**Inputs, Required:** ASP identifier, background data transfer policy,
Background Data Transfer Reference ID.
**Inputs, Optional:** None
**Outputs, Required:** None
**Outputs, Optional:** None _._
#### 5.2.5.6 Npcf_UEPolicyControl Service
##### 5.2.5.6.1 General
**Service description:** NF Service Consumer, e.g. AMF, may create and manage
a UE Policy Association in the PCF through which the NF Service Consumer
receives Policy Control Request Trigger of UE Policy Association.
The association allows (V-)PCF to provide UE access selection and PDU Session
selection related policy information to the UE transparently through the NF
Service Consumer using NAS TRANSPORT message to carry:
\- UE access selection and PDU Session selection related policy information as
defined in clause 6.6 of TS 23.503 [20]. In the case of roaming, the URSP
rules are provided by H-PCF and the ANDSP rules may be provided by V-PCF or
H-PCF or both;
As part of this service, the PCF may provide the NF Service Consumer, e.g.
AMF, with policy information about the UE that may contain:
\- Policy Control Request Trigger of UE Policy Association. When such a Policy
Control Request Trigger condition is met, the NF Service Consumer, e.g. AMF,
shall contact PCF and provide information on the Policy Request Trigger
condition that has been met. In the case of roaming, the V-PCF may subscribe
to AMF or the H-PCF may subscribe to AMF via V-PCF.
At Npcf_UEPolicyControl_Create, the NF Service Consumer, e.g. AMF, requests
the creation of a corresponding \"UE Policy Association\" with the PCF
(Npcf_UEPolicyControl_Create) and provides relevant parameters about the UE
context to the PCF. When the PCF has created the UE Policy Association, the
PCF may provide policy information as defined above.
When a Policy Control Request Trigger condition is met, the NF Service
Consumer, e.g. AMF, requests the update (Npcf_UEPolicyControl_Update) of the
UE Policy Association by providing information on the condition(s) that have
been met. The PCF may provide updated policy information to the NF Service
Consumer.
During the AMF relocation, if the target AMF receives the PCF ID from source
AMF and the target AMF decides to contact with the PCF identified by the PCF
ID based on the local policies, the target AMF requests the update
(Npcf_UEPolicyControl_Update) of the UE Policy Association. If a Policy
Control Request Trigger condition is met, the information matching the trigger
condition may also be provided by the target AMF. The PCF may provide updated
policy information to the target AMF.
The PCF may at any time provide updated policy information
(Npcf_UEPolicyControl_UpdateNotify).
At UE deregistration the NF Service Consumer, e.g. AMF, requests the deletion
of the corresponding UE Policy Association.
##### 5.2.5.6.2 Npcf_UEPolicyControl_Create service operation
**Service operation name:** Npcf_UEPolicyControl_Create
**Description:** NF Service Consumer can request the creation of a UE Policy
Association by providing relevant parameters about the UE context to the PCF.
**Inputs, Required:** Notification endpoint, SUPI.
**Inputs, Optional:** H-PCF ID (if the NF service producer is V-PCF and AMF is
NF service consumer), information provided by the AMF as define in 6.2.1.2 of
TS 23.503 [20], such as Access Type, Permanent Equipment Identifier, GPSI,
User Location Information, UE Time Zone, Serving Network, RAT type, UE access
selection and PDU session selection policy information including the list of
PSIs, OS id and Internal Group (see TS 23.501 [2]
**Outputs, Required:** UE Policy Association ID, Success or Failure.
**Outputs, Optional:** Policy Control Request Trigger of UE Policy
Association. In the case of H-PCF is producer, UE access selection and PDU
Session selection related policy information (see clause 5.2.5.6.1).
##### 5.2.5.6.3 Npcf_UEPolicyControl_UpdateNotify service operation
**Service operation name:** Npcf_UEPolicyControl_UpdateNotify
**Description:** Provides to the NF Service Consumer updated Policy
information for the UE context evaluated based on the information previously
provided by the PCF.
NOTE: This notification corresponds to an implicit subscription.
**Inputs, Required:** Notification endpoint, UE Policy Association ID.
**Inputs, Optional:** Policy Control Request Triggers of UE Policy
Association. In the case of H-PCF is producer, UE Access and PDU session
related information as defined in clause 5.2.5.1.
**Outputs, Required:** Success or failure.
**Outputs, Optional:** None.
##### 5.2.5.6.4 Npcf_UEPolicyControl_Delete service operation
**Service operation name:** Npcf_UEPolicyControl_Delete
**Description:** Provides means for the NF Consumer to delete the UE policy
control association.
**Inputs, Required:** Notification endpoint, UE Policy Association ID.
**Inputs, Optional:** None.
**Outputs, Required:** Success or Failure.
**Outputs, Optional:** None.
##### 5.2.5.6.5 Npcf_UEPolicyControl_Update service operation
**Service operation name:** Npcf_UEPolicyControl_Update
**Description:** NF Service Consumer, e.g. AMF can request the update of the
UE Policy Association to receive updated Policy information for the UE
context.
**Inputs, Required:** UE Policy Association ID.
**Inputs, Optional:** Information on the UE policy related Policy Control
Request Trigger condition that has been met, as defined in Table 6.1.2.5-1 in
TS 23.503 [20].
**Outputs, Required:** Success or Failure
**Outputs, Optional:** Policy Control Request Trigger of UE Policy
Association. In the case of H-PCF is producer, UE access selection and PDU
Session selection related policy information.
#### 5.2.5.7 Npcf_EventExposure service
##### 5.2.5.7.1 General
**Service description:** This service enables an NF to subscribe and get
notified about PCF events for a group of UE(s) or any UE accessing a
combination of (DNN, S-NSSAI).
The events can be subscribed by a NF consumer are described in clause 6.1.3.18
of TS 23.503 [20].
The following service operations are defined for the Npcf_EventExposure
service:
\- Npcf_EventExposure_Subscribe.
\- Npcf_EventExposure_UnSubscribe.
\- Npcf_EventExposure_Notify.
##### 5.2.5.7.2 Npcf_EventExposure_Subscribe service operation
**Service operation name:** Npcf_EventExposure_Subscribe
**Description:** The consumer NF uses this service operation to subscribe to
or modify event reporting for a group of UE(s) or any UE accessing a
combination of (DNN, S-NSSAI).
**NF Consumers:** NEF**.**
**Inputs (required):** NF ID, target of the subscription (Internal Group
Identifier or indication that any UE accessing a combination of (DNN,
S-NSSAI)is targeted, (set of) Event ID(s) defined in clause 5.2.5.7.1,
Notification Target Address (+ Notification Correlation ID) and Event
Reporting Information defined in Table 4.15.1-1.
**Inputs (optional):** Event Filter (s) associated with each Event ID.
**Outputs (required):** Operation execution result indication _._ When the
subscription is accepted: Subscription Correlation ID.
**Outputs (optional):** First corresponding event report is included, if
corresponding information is available (see clause 4.15.1).
The NF consumer subscribes to the event notification by invoking
Npcf_EventExposure to the PCF. The PCF allocates a Subscription Correlation ID
for the subscription and responds to the consumer NF with the Subscription
Correlation ID. Event receiving NF ID identifies the NF that shall receive the
event reporting.
##### 5.2.5.7.3 Npcf_EventExposure_Unsubscribe service operation
**Service operation name:** Npcf_EventExposure_Unsubscribe
**Description:** The NF consumer uses this service operation to unsubscribe
for a specific event for a group of UE(s) or any UE accessing a combination of
(DNN, S-NSSAI).
**Inputs (required):** Subscription Correlation ID.
**Input, Optional:** None.
**Outputs (required):** Operation execution result indication.
**Output, Optional:** None _._
##### 5.2.5.7.4 Npcf_EventExposure_Notify service operation
**Service operation name:** Npcf_EventExposure_Notify
**Description:** This service operation reports the event to the consumer that
has previously subscribed.
**Inputs (required):** Event ID, corresponding UE ID (GPSI), Notification
Correlation Information, time stamp.
**Inputs (optional):** None.
**Outputs (required):** None _._
### 5.2.6 NEF Services
#### 5.2.6.1 General
The following table shows the NEF Services and Service Operations:
Table 5.2.6.1-1: NF Services provided by the NEF
+----------------+----------------+----------------+----------------+ | Service Name | Service | Operation | Example | | | Operations | | Consumer(s) | | | | Semantics | | +================+================+================+================+ | Nnef\ | Subscribe | Su | AF | | _EventExposure | | bscribe/Notify | | +----------------+----------------+----------------+----------------+ | | Unsubscribe | | AF | +----------------+----------------+----------------+----------------+ | | Notify | | AF | +----------------+----------------+----------------+----------------+ | Nnef\ | Fetch | Re | SMF | | _PFDManagement | | quest/Response | | +----------------+----------------+----------------+----------------+ | | Subscribe | Su | SMF | | | | bscribe/Notify | | +----------------+----------------+----------------+----------------+ | | Notify | | SMF | +----------------+----------------+----------------+----------------+ | | Unsubscribe | | SMF | +----------------+----------------+----------------+----------------+ | | Create | Re | AF | | | | quest/Response | | +----------------+----------------+----------------+----------------+ | | Update | Re | AF | | | | quest/Response | | +----------------+----------------+----------------+----------------+ | | Delete | Re | AF | | | | quest/Response | | +----------------+----------------+----------------+----------------+ | Nnef_Para | Update | Re | AF | | meterProvision | | quest/Response | | +----------------+----------------+----------------+----------------+ | Nnef_Trigger | Delivery | Re | AF | | | | quest/Response | | +----------------+----------------+----------------+----------------+ | | DeliveryNotify | Su | AF | | | | bscribe/Notify | | +----------------+----------------+----------------+----------------+ | Nnef_B | Create | Re | AF | | DTPNegotiation | | quest/Response | | +----------------+----------------+----------------+----------------+ | | Update | Re | AF | | | | quest/Response | | +----------------+----------------+----------------+----------------+ | Nnef_Tr | Create | Re | AF | | afficInfluence | | quest/Response | | +----------------+----------------+----------------+----------------+ | | Update | Re | AF | | | | quest/Response | | +----------------+----------------+----------------+----------------+ | | Delete | Re | AF | | | | quest/Response | | +----------------+----------------+----------------+----------------+ | Nnef_C | Create | Re | AF | | hargeableParty | | quest/Response | | +----------------+----------------+----------------+----------------+ | | Update | Re | AF | | | | quest/Response | | +----------------+----------------+----------------+----------------+ | | Notify | Re | AF | | | | quest/Response | | +----------------+----------------+----------------+----------------+ | Nnef_AF | Create | Re | AF | | sessionWithQoS | | quest/Response | | +----------------+----------------+----------------+----------------+ | | Notify | Re | AF | | | | quest/Response | | +----------------+----------------+----------------+----------------+
#### 5.2.6.2 Nnef_EventExposure service
##### 5.2.6.2.1 General
See clause 4.15.3.1.
##### 5.2.6.2.2 Nnef_EventExposure_Subscribe operation
**Service operation name:** Nnef_EventExposure_Subscribe
**Description:** the consumer subscribes to receive an event, or if the event
is already defined in NEF, then the subscription is updated.
**Inputs (required):** (Set of) Event ID(s) as specified in clause 4.15.3.1 or
Npcf_PolicyAuthorization_Notify service operation, target of event reporting
(GPSI or External Group Identifier), Event Reporting Information defined in
Table 4.15.1-1, Notification Target Address (+ Notification Correlation ID).
**Inputs (optional):** Event Filter, Subscription Correlation ID (in the case
of modification of the event subscription), Expiry time.
**Outputs (required):** When the subscription is accepted: Subscription
Correlation ID, Expiry time (required if the subscription can be expired based
on the operator\'s policy)_._
**Outputs (optional):** First corresponding event report is included, if
available (see clause 4.15.1).
##### 5.2.6.2.3 Nnef_EventExposure_Unsubscribe service operation
**Service operation name:** Nnef_EventExposure_Unsubscribe
**Description:** the NF consumer deletes an event if already defined in NEF.
**Inputs (required):** Subscription Correlation ID.
**Outputs (required):** Operation execution result indication _._
##### 5.2.6.2.4 Nnef_EventExposure_Notify service operation
**Service operation name:** Nnef_EventExposure_Notify
**Description:** NEF reports the event to the consumer that has previously
subscribed.
**Inputs (required):** Event ID, Notification Correlation Information, time
stamp.
**Inputs (optional):** Event information (defined on a per Event ID basis).
**Outputs (required):** Operation execution result indication _._
#### 5.2.6.3 Nnef_PFDManagement service
##### 5.2.6.3.1 General
The service provides the capability to create, update or remove PFDs via the
NEF (PFDF). See clause 4.18 for the detailed procedures.
##### 5.2.6.3.2 Nnef_PFDManagement_Fetch service operation
**Service operation name:** Nnef_PFDManagement_Fetch
**Description:** Provides the PFDs for Application Identifier to the NF
Consumer.
**Inputs (required):** Application Identifier(s).
**Inputs (optional):** None.
**Outputs (required):** Application Identifier, PFDs _._
##### 5.2.6.3.3 Nnef_PFDManagement_Subscribe service operation
**Service operation name:** Nnef_PFDManagement_Subscribe
**Description:** provided by the NEF (PFDF) for NF consumers to explicitly
subscribe the notification of changes of PFDs for Application Identifier.
**Inputs (required):** Application Identifier(s).
**Inputs (optional):** None.
**Outputs (required):** None _._
##### 5.2.6.3.4 Nnef_PFDManagement_Notify service operation
**Service operation name:** Nnef_PFDManagement_Notify
**Description:** Provides Update PFDs for Application Identifier to the NF
Consumer.
**Inputs (required):** Application Identifier(s), PFDs.
**Inputs (optional):** None.
**Outputs (required):** None _._
##### 5.2.6.3.5 Nnef_PFDManagement_Unsubscribe service operation
**Service operation name:** Nnef_PFDManagement_Unsubscribe
**Description:** Provides by the NEF (PFDF) for NF Consumer to explicitly
unsubscribe the notification of events.
**Inputs (required):** Application Identifier(s).
**Inputs (optional):** None.
**Outputs (required):** None
##### 5.2.6.3.6 Nnef_PFDManagement_Create service operation
**Service operation name:** Nnef_PFDManagement_Create
**Description:** The consumer requests PFD management to create PFDs.
**Inputs (required):** AF ID, External Application Identifier and one or more
sets of PFDs.
**Inputs (optional):** Allowed Delay.
**Outputs (required):** Transaction Reference ID.
##### 5.2.6.3.7 Nnef_PFDManagement_Update service operation
**Service operation name:** Nnef_PFDManagement_Update
**Description:** The consumer requests PFD management to update PFDs.
**Inputs (required):** Transaction Reference ID, one or more sets of PFDs.
**Inputs (optional):** Allowed Delay.
**Outputs (required):** None.
##### 5.2.6.3.8 Nnef_PFDManagement_Delete service operation
**Service operation name:** Nnef_PFDManagement_Delete
**Description:** The consumer requests PFD management to delete the PFDs.
**Inputs (required):** Transaction Reference ID.
**Inputs (optional):** None.
**Outputs (required):** None.
#### 5.2.6.4 Nnef_ParameterProvision service
##### 5.2.6.4.1 General
This service is for allowing external party to provision of information which
can be used for the UE in 5GS.
##### 5.2.6.4.2 Nnef_ParameterProvision_Update service operation
**Service operation name:** Nnef_ParameterProvision_Update
**Description:** the consumer updates the UE related information (e.g.
Expected UE Behaviour).
**Inputs (required):** GPSI, AF ID, Transaction Reference ID.
**Inputs (optional):** Any combination of the Expected UE Behaviour
parameters.
**Outputs (required):** Operation execution result indication.
**Outputs (optional):** Transaction specific parameters, if available.
#### 5.2.6.5 Nnef_Trigger service
##### 5.2.6.5.1 General
See clause 4.13.2.
##### 5.2.6.5.2 Nnef_Trigger_Delivery service operation
**Service operation name:** Nnef_Trigger_Delivery
**Description:** the consumer requests that a trigger be sent to an
application on a UE and subscribes to be notified about result of the trigger
delivery attempt.
**Inputs (required):** GPSI, AF ID, Trigger Reference Number, Application Port
ID
**Inputs (optional):** Validity Period, Priority, Trigger Payload.
**Outputs (required):** Transaction Reference ID, Cause _._
##### 5.2.6.5.3 Nnef_Trigger_DeliveryNotify service operation
**Service operation name:** Nnef_Trigger_DeliveryNotify
**Description:** NEF reports the status of the trigger delivery to the
consumer (failure or success).
NOTE: This notification corresponds to an implicit subscription by
Nnef_Trigger_Delivery service operation.
**Inputs (required):** Transaction Reference ID, Delivery Report.
**Inputs (optional):** None.
**Outputs (required):** None.
#### 5.2.6.6 Nnef_BDTPNegotiation service
##### 5.2.6.6.1 General
See clause 4.16.7.
##### 5.2.6.6.2 Nnef_BDTPNegotiation_Create service operation
**Service operation name:** Nnef_BDTPNegotiation Create
**Description:** The consumer requests a background data transfer policy.
**Inputs (required):** ASP Identifer, Volume per UE, Number of UEs, Desired
time window.
**Inputs (optional):** Network Area Information.
**Outputs (required):** Background Data Transfer Reference ID, one or more
background data transfer policies.
**Output, Optional:** None.
##### 5.2.6.6.3 Nnef_BDTPNegotiation_Update service operation
**Service operation name:** Nnef_BDTPNegotiation Update
**Description:** the consumer requests the selected background data transfer
policy to be set.
**Inputs (required):** Background Data TransferReference ID, background data
transfer policy.
**Inputs (optional):** None.
**Outputs (required):** None.
**Outputs (optional):** None.
#### 5.2.6.7 Nnef_TrafficInfluence service
##### 5.2.6.7.1 General
**Service description:** This service provides:
\- Request authorization of NF Service Consumer requests.
\- Request parameter mapping from NF Service Consumer requests to 5GC
parameters and vice versa as described in clause 5.6.7 of TS 23.501 [2].
\- NF Service Consumer request routing (forwarding) to actual NF Service
Producer to influence traffic routing decisions as described in clause 5.6.7
of TS 23.501 [2].
##### 5.2.6.7.2 Nnef_TrafficInfluence_Create operation
**Service operation name:** Nnef_TrafficInfluence_Create
**Description:** Authorize the request and forward the request for traffic
influence.
**Inputs (required):** AF Transaction Id.
The AF Transaction Id refers to the request.
**Inputs (optional):** The address (IP or Ethernet) of the UE if available,
GPSI if available, DNN if available, S-NSSAI if available, External Group
Identifier if available, application identifier or traffic filtering
information, AF-Service-Identifier, a list of DNAI(s) and corresponding
routing profile ID(s) or N6 traffic routing information, Indication of
application relocation possibility, Early and/or late notifications about UP
path management events, Temporal validity condition and Spatial validity
condition as described in clause 5.6.7 of TS 23.501 [2].
**Outputs (required):** Operation execution result indication.
**Outputs (optional):** None.
##### 5.2.6.7.3 Nnef_TrafficInfluence_Update operation
**Service operation name:** Nnef_TrafficInfluence_Update
**Description:** Authorize the request and forward the request to update the
traffic influence.
**Inputs (required):** AF Transaction Id.
The AF Transaction Id identifies the NF Service Consumer request to be
updated.
**Inputs (optional):** Same optional information as in
Nnef_TrafficInfluence_Create Input.
**Outputs (required):** Operation execution result indication.
**Outputs (optional):** None.
##### 5.2.6.7.4 Nnef_TrafficInfluence_Delete operation
**Service operation name:** Nnef_TrafficInfluence_Delete
**Description:** Authorize the request and forward the request to delete(s)
request for traffic influence.
**Inputs (required):** AF Transaction Id.
The AF Transaction Id identifies the NF Service Consumer request for traffic
influence to be deleted.
**Inputs (optional):** None.
**Outputs (required):** Operation execution result indication.
**Outputs (optional):** None.
##### 5.2.6.7.5 Nnef_TrafficInfluence_Notify operation
**Service operation name:** Nnef_TrafficInfluence_Notify
**Description:** Forward the notification of UP path management event report
to AF.
**Known NF Service Consumers:** AF.
**Inputs (required):** AF Transaction Id, Event ID.
The AF Transaction Id identifies the AF request for traffic influence that the
event report is related to. The event may be the UP path management event
defined in clause 5.6.7 of TS 23.501 [2].
**Inputs (optional):** Event information (defined on a per Event ID basis).
**Outputs (required):** Operation execution result indication.
**Outputs (optional):** None.
#### 5.2.6.8 Nnef_ChargeableParty service
##### 5.2.6.8.1 General
See clauses 4.15.6.4 and 4.15.6.5.
##### 5.2.6.8.2 Nnef_ChargeableParty_Create service operation
**Service operation name:** Nnef_ChargeableParty Create
**Description:** The consumer requests to become the chargeable party for a
data session for a UE.
**Inputs (required):** AF Identifier, UE address (i.e. IP address or MAC
address), Description of the application flows, Sponsor Information,
Sponsoring Status.
**Inputs (optional):** Time period, traffic volume, Background Data Transfer
Reference ID.
**Outputs (required):** Transaction Reference ID, result.
**Output (optional):** None.
##### 5.2.6.8.3 Nnef_ChargeableParty_Update service operation
**Service operation name:** Nnef_ChargeableParty Update
**Description:** The consumer can change the chargeable party of a data
session for a UE.
**Inputs (required):** AF Identifier, Transaction Reference ID, Sponsoring
Status.
**Inputs (optional):** Time period, traffic volume, Background Data Transfer
Reference ID.
**Outputs (required):** Transaction Reference ID, result.
**Output (optional):** None.
##### 5.2.6.8.4 Nnef_ChargeableParty_Notify service operation
**Service operation name:** Nnef_ChargeableParty Notify
**Description:** NEF reports the bearer level event(s) to the consumer.
**Inputs (required):** Event reports.
**Inputs (optional):** None.
**Outputs (required):** None.
**Output (optional):** None.
#### 5.2.6.9 Nnef_AFsessionWithQoS service
##### 5.2.6.9.1 General
See clause 4.15.6.6.
##### 5.2.6.9.2 Nnef_AFsessionWithQoS_Create service operation
**Service operation name:** Nnef_AFsessionWithQoS Create
**Description:** The consumer requests the network to provide a specific QoS
for an AS session.
**Inputs (required):** AF Identifier, UE address (i.e. IP address or MAC
address), Description of the application flows, QoS Reference.
**Inputs (optional):** time period, traffic volume.
**Outputs (required):** Transaction Reference ID, result.
**Output (optional):** None.
##### 5.2.6.9.3 Nnef_AFsessionWithQoS_Notify service operation
**Service operation name:** Nnef_AFsessionWithQoS Notify
**Description:** NEF reports the QoS Flow level event(s) to the consumer.
**Inputs (required):** Event reports.
**Inputs (optional):** None.
**Outputs (required):** None.
**Output (optional):** None.
### 5.2.7 NRF Services
#### 5.2.7.1 General
The following table shows the NRF Services and Service Operations:
Table 5.2.7.1-1: NF services provided by the NRF
+----------------+----------------+----------------+----------------+ | Service Name | Service | Operation | Example | | | Operations | | Consumer(s) | | | | Semantics | | +================+================+================+================+ | Nnrf | NFRegister | Re | AMF, SMF, UDM, | | _NFManagement | | quest/Response | AUSF, NEF, | | | | | PCF, SMSF, | | | | | NSSF, UPF, | | | | | BSF, CHF | +----------------+----------------+----------------+----------------+ | | NFUpdate | Re | AMF, SMF, UDM, | | | | quest/Response | AUSF, NEF, | | | | | PCF, SMSF, | | | | | NSSF, UPF, | | | | | BSF, CHF | +----------------+----------------+----------------+----------------+ | | NFDeregister | Re | AMF, SMF, UDM, | | | | quest/Response | AUSF, NEF, | | | | | PCF, SMSF, | | | | | NSSF, UPF, | | | | | BSF, CHF | +----------------+----------------+----------------+----------------+ | | NFS | Su | AMF, SMF, PCF, | | | tatusSubscribe | bscribe/Notify | NEF, NSSF, | | | | | SMSF, AUSF, | | | | | CHF, NRF | +----------------+----------------+----------------+----------------+ | | NFStatusNotify | | AMF, SMF, PCF, | | | | | NEF, NSSF, | | | | | SMSF, AUSF, | | | | | CHF | +----------------+----------------+----------------+----------------+ | | NFSta | | AMF, SMF, PCF, | | | tusUnSubscribe | | NEF, NSSF, | | | | | SMSF, AUSF, | | | | | CHF, NRF | +----------------+----------------+----------------+----------------+ | Nnr | Request | Re | AMF, SMF, PCF, | | f_NFDiscovery | | quest/Response | NEF, NSSF, | | | | | SMSF, AUSF, | | | | | CHF, NRF | +----------------+----------------+----------------+----------------+ | Nnr | Get | Re | AMF, SMF, PCF, | | f_AccessToken | | quest/Response | NEF, NSSF, | | | | | SMSF, AUSF, | | | | | UDM | +----------------+----------------+----------------+----------------+
#### 5.2.7.2 Nnrf_NFManagement service
##### 5.2.7.2.1 General
##### 5.2.7.2.2 Nnrf_NFManagement_NFRegister service operation
**Service Operation name:** Nnrf_NFManagement_NFRegister
**Description:** Registers the consumer NF in the NRF by providing the NF
profile of the consumer NF to NRF and NRF marks the consumer NF available.
**Inputs, Required:** NF type, NF instance ID, Names of supported NF services
(if applicable) and PLMN ID e.g. if NF needs to be discovered by other PLMNs.
NOTE 1: for the UPF, the addressing information within the NF profile
corresponds to the N4 interface.
**Inputs, Optional:**
\- If the consumer NF stores Data Set(s) (e.g. UDR): Range(s) of SUPIs,
range(s) of GPSIs, range(s) of external group identifiers, Data Set
Identifier(s). If the consumer is BSF: Range(s) of (UE) IPv4 addresses or
Range(s) of (UE) IPv6 prefixes.
NOTE 2: Range of SUPI(s) is limited in this release to a SUPI type of IMSI as
defined in TS 23.003 [33].
\- If the consumer is UDM, UDR or AUSF, they can include UDM Group ID, UDR
Group ID, AUSF Group ID.
\- For UDM and AUSF, Routing Indicator.
\- If the consumer is AMF, it includes list of GUAMI(s). In addition, AMF may
include list of GUAMI(s) for which it can serve as backup for
failure/maintenance.
\- If the consumer is CHF, it may include Range(s) of SUPIs, Range(s) of
GPSIs, or Range(s) of PLMNs as defined in TS 32.290 [42].
\- For the UPF Management: UPF Provisioning Information as defined in clause
4.17.6.
\- S-NSSAI(s) and the associated NSI ID(s) (if available).
\- DNN(s) if the consumer is PCF or BSF. DNN(s) per S-NSSAI if the consumer is
SMF or UPF.
\- Information about the location of the NF consumer (operator specific
information, e.g. geographical location, data centre).
\- TAI(s).
**Outputs, Required:** Result indication.
**Outputs, Optional:** None.
See clause 5.21.2.1 in TS 23.501 [2], the AMF registers itself to NRF.
##### 5.2.7.2.3 Nnrf_NFManagement_NFUpdate service operation
**Service Operation name:** Nnrf_NFManagement_NFUpdate
**Description:** Provides the updated NF profile of NF consumer to NRF.
**Inputs, Required:** NF instance ID.
**Inputs, Optional:** If replacing the full NF profile, the full NF profile
shall be provided. If updating parts of the NF profile, the NF profile
elements that needs to be updated shall be provided.
**Outputs, Required:** Result indication.
**Outputs, Optional:** None.
See clause 5.21.2.1 in TS 23.501 [2], the AMF adds or updates the associated
GUAMI(s).
##### 5.2.7.2.4 Nnrf_NFManagement_NFDeregister service operation
**Service Operation name:** Nnrf_NFManagement_NFDeregister
**Description:** Inform the unavailability of NF consumer to NRF.
**Inputs, Required:** NF Instance ID, Reason indication.
**Inputs, Optional:** None.
**Outputs, Required:** Result indication.
**Outputs, Optional:** None.
See clause 5.21.2.2 in TS 23.501 [2], the AMF deregister itself from NRF.
##### 5.2.7.2.5 Nnrf_NFManagement_NFStatusSubscribe service operation
**Service Operation name:** Nnrf_NFManagement_NFStatusSubscribe
**Description:** Consumer can subscribe to be notified of the following:
\- Newly registered NF along with its NF services.
\- Updated NF profile.
\- Deregistered NF.
**Inputs, Required:** NF type (if NF status of a specific NF type is to be
monitored), NF instance ID (if NF status of a specific NF instance is to be
monitored), NF service (if NF status for NF which exposes a given NF service
is to be monitored).
**Inputs, Optional:**
\- For the UPF Management defined in clause 4.17.6: UPF Provisioning
Information as defined in that clause.
\- For AMF, Consumer may include list of GUAMI(s).
\- S-NSSAI(s) and the associated NSI ID(s) (if available).
**Outputs, Required:** When the subscription is accepted: Subscription
Correlation ID (required for management of this subscription).
**Outputs, Optional:** None.
NOTE: Alternatively, other means such as OA&M can also be used to subscribe
for NF status.
##### 5.2.7.2.6 Nnrf_NFManagement_NFStatusNotify service operation
**Service Operation name:** Nnrf_NFManagement_NFStatusNotify
**Description:** NRF notifies subscribed consumers of the following:
\- Newly registered NF along with its NF services.
\- Updated NF profile.
\- Deregistered NF.
**Inputs, Required:** NF instance ID, NF Status, NF services (if the
notification is for newly registered NF), new NF profile (if the notification
is for updated NF profile).
**Inputs, Optional:**
\- If the NF stores Data Set(s) (e.g. UDR): Range(s) of SUPIs, range(s) of
GPSIs, range(s) of external group identifiers, Data Set Identifier(s). For
BSF: Range(s) of (UE) IPv4 addresses or Range(s) of (UE) IPv6 prefixes.
NOTE: Range of SUPI(s) is limited in this release to a SUPI type of IMSI as
defined in TS 23.003 [33].
\- If the NF is UDM, UDR or AUSF, they can include UDM Group ID, UDR Group ID,
AUSF Group ID.
\- For UDM and AUSF, Routing Indicator.
\- For the UPF Management defined in clause 4.17.6: UPF Provisioning
Information as defined in that clause.
\- For AMF, list of GUAMI(s) may be included. In addition, it may include list
of GUAMI(s) for which it can serve as backup for failure/maintenance.
\- S-NSSAI(s) and the associated NSI ID(s) (if available).
\- Information about the location of the NF (operator specific information,
e.g. geographical location, data centre).
\- TAI(s).
**Outputs, Required:** None.
**Outputs, Optional:** None.
##### 5.2.7.2.7 Nnrf_NFManagement_NFStatusUnsubscribe service operation
**Service Operation name:** Nnrf_NFManagement_NFStatusUnsubscribe
**Description:** Consumer can unsubscribe from being notified of newly
registered NF along with its NF services.
**Inputs, Required:** Subscription Correlation ID.
**Inputs, Optional:** None.
**Outputs, Required:** Operation execution result indication.
**Outputs, Optional:** None.
NOTE: Alternatively, other means such as OA&M can also be used to unsubscribe
for NF status.
#### 5.2.7.3 Nnrf_NFDiscovery service
##### 5.2.7.3.1 General
**Service description:** This service enables one NF to discover a set of NF
instances with specific NF service or a target NF type. The service also
enables one NF service to discover a specific NF service. The service
operations defined below allow the NF/NF services to communicate with NRF.
##### 5.2.7.3.2 Nnrf_NFDiscovery_Request service operation
**Service operation name:** Nnrf_NFDiscovery_Request
**Description:** provides the IP address or FQDN of the expected NF
instance(s) and, if present in NF profile, the Endpoint Address(es) of NF
service instance(s) to the NF service consumer.
**Inputs, Required:** one or more target NF service Name(s), NF type of the
target NF, NF type of the NF service consumer.
If the NF service consumer intends to discover an NF service producer
providing all the standardized services, it provides a wildcard NF service
name.
**Inputs, Optional:**
\- S-NSSAI and the associated NSI ID (if available), DNN, target NF/NF service
PLMN ID, NRF to be used to select NFs/services within HPLMN, Serving PLMN ID,
the NF service consumer ID, preferred target NF location, TAI.
NOTE 1: For network slicing the NF service consumer ID is a required input.
\- FQDN for the S5/S8 interface of the PGW-C+SMF, to discover the N11/N16
interface of the PGW-C+SMF in the case of EPS to 5GS mobility.
\- If the target NF stores Data Set(s) (e.g. UDR): SUPI, Data Set
Identifier(s). (UE) IPv4 address or (UE) IPv6 Prefix.
NOTE 2: The (UE) IPv4 address or (UE) IPv6 Prefix is provided for BSF
discovery: in that case the NRF looks up for a match within one of the
Range(s) of (UE) IPv4 addresses or Range(s) of (UE) IPv6 prefixes provided by
BSF(s) as part of the invocation of Nnrf_NFManagement_NFRegister operation.
The NRF is not meant to store individual (UE) IPv4 addresses or (UE) IPv6
prefixes.
\- If the target NF is UDM or AUSF, the request may include the UE\'s Routing
Indicator.
\- If the target NF is AMF, the request may include AMF region, AMF Set,
GUAMI.
\- If the target NF is UDR or UDM or AUSF, the request may include UDR Group
ID or UDM Group ID or AUSF Group ID respectively.
NOTE 3: It is assumed that the corresponding NF service consumer is either
configured with the corresponding Group ID or it received it via earlier
Discovery output.
\- If the target NF is UPF, the request may include SMF Area Identity, UE IPv4
Address/IPv6 Prefix.
NOTE 4: The (UE) IPv4 address or (UE) IPv6 Prefix is provided for UPF
discovery: in that case the NRF looks up for a match within one of the
Range(s) of (UE) IPv4 addresses or Range(s) of (UE) IPv6 prefixes provided by
UPF as part of the invocation of Nnrf_NFManagement_NFRegister operation. The
NRF is not meant to store individual (UE) IPv4 addresses or (UE) IPv6
prefixes.
\- If the target NF is CHF, the request may include SUPI or GPSI as specified
in TS 32.290 [42].
**Outputs, Required:** A set of NF instances, containing per NF Instance: NF
type, NF instance ID, FQDN or IP address(es) of the NF instance and, a list of
services instances, where each service instance has a service name, a NF
service instance ID and optionally Endpoint Address(es)
Endpoint Address(es) may be a list of IP addresses or an FQDN for the NF
service instance.
**Outputs, Optional:** Per NF instance, other information in the NF profile
listed in clause 6.2.6 in TS 23.501 [2] related to the NF instance, such as:
\- If the target NF stores Data Set(s) (e.g. UDR): Range(s) of SUPIs, range(s)
of GPSIs, range(s) of external group identifiers, Data Set Identifier(s). If
the target NF is BSF: Range(s) of (UE) IPv4 addresses or Range(s) of (UE) IPv6
prefixes.
NOTE 5: Range of SUPI(s) is limited in this release to a SUPI type of IMSI as
defined in TS 23.003 [33].
\- If the target NF is UDM, UDR or AUSF, they can include UDM Group ID, UDR
Group ID, AUSF Group ID.
\- For UDM and AUSF, Routing Indicator.
\- If the target NF is AMF, it includes list of GUAMI(s). In addition, it may
include list of GUAMI(s) for which it can serve as backup for
failure/maintenance.
\- If the target NF is CHF, it includes primary CHF instance and the secondary
CHF instance pair(s).
\- For the UPF Management: UPF Provisioning Information as defined in clause
4.17.6.
\- S-NSSAI(s) and the associated NSI ID(s) (if available).
\- Information about the location of the target NF (operator specific
information, e.g. geographical location, data centre).
\- TAI(s).
\- PLMN ID
See clause 4.17.4 and 4.17.5 for details on the usage of this service
operation.
#### 5.2.7.4 Nnrf_AccessToken_service
##### 5.2.7.4.1 General
This service provides OAuth2 2.0 Access Tokens for NF to NF authorization as
defined in TS 33.501 [15].
##### 5.2.7.4.2 Nnrf_AccessToken_Get Service Operation
See TS 33.501 [15].
### 5.2.8 SMF Services
#### 5.2.8.1 General
The following table shows the SMF Services and SMF Service Operations.
Table 5.2.8.1-1: NF services provided by the SMF
+----------------+----------------+----------------+----------------+ | Service Name | Service | Operation | Example | | | Operations | | Consumer(s) | | | | Semantics | | +================+================+================+================+ | Ns | Create | Re | V-SMF | | mf_PDUSession | | quest/Response | | +----------------+----------------+----------------+----------------+ | | Update | Re | V-SMF, H-SMF | | | | quest/Response | | +----------------+----------------+----------------+----------------+ | | Release | Re | V-SMF | | | | quest/Response | | +----------------+----------------+----------------+----------------+ | | C | Re | AMF | | | reateSMContext | quest/Response | | +----------------+----------------+----------------+----------------+ | | U | Re | AMF | | | pdateSMContext | quest/Response | | +----------------+----------------+----------------+----------------+ | | Re | Re | AMF | | | leaseSMContext | quest/Response | | +----------------+----------------+----------------+----------------+ | | SMConte | Su | AMF | | | xtStatusNotify | bscribe/Notify | | +----------------+----------------+----------------+----------------+ | | StatusNotify | Su | V-SMF | | | | bscribe/Notify | | +----------------+----------------+----------------+----------------+ | | Context | Re | AMF | | | | quest/Response | | +----------------+----------------+----------------+----------------+ | Nsmf\ | Subscribe | Su | NEF, AMF | | _EventExposure | | bscribe/Notify | | +----------------+----------------+----------------+----------------+ | | Unsubscribe | | NEF, AMF | +----------------+----------------+----------------+----------------+ | | Notify | | NEF, AMF | +----------------+----------------+----------------+----------------+
#### 5.2.8.2 Nsmf_PDUSession Service
##### 5.2.8.2.1 General
**Service description:** This service operates on the PDU Sessions. The
following are the key functionalities of this NF service:
\- (between AMF and SMF) Creation / Deletion / Modification of AMF-SMF
interactions for PDU Sessions;
The resource handled between AMF and SMF via Create / Update / Release SM
context operations corresponds to the AMF-SMF association for a PDU Session;
When the AMF has got no association with an SMF to support a PDU Session, the
AMF creates such association via the Nsmf_PDUSession_CreateSMContext
operation. The context created is identified via the SM Context ID. Otherwise
(e.g. at hand-over between 3GPP and Non 3GPP access) the AMF uses the
Nsmf_PDUSession_UpdateSMContext operation.
NOTE 1: In TS 29.502 [36] SM Context ID is referred to as smContextRef for N11
and pduSessionRef and pduSessionUri for N16.
When the UE is handed-over from an (old) AMF towards another (new) AMF, the
old AMF provides the new AMF with the SMF addressing information corresponding
to the AMF-SMF association related with each PDU Session of that UE. The new
AMF can thus further act upon the association with the SMF via
Nsmf_PDUSession_UpdateSMContext and Nsmf_PDUSession_ReleaseSMContext
operations. This may take place:
\- at inter AMF change due to AMF planned maintenance or due to AMF failure
described in clause 5.21.2 of TS 23.501 [2];
\- at inter AMF mobility in CM-CONNECTED state described in clause 4.9.1.3;
\- at inter AMF mobility in CM-IDLE state described in clause 4.2.2.2.
\- (between V-SMF and H-SMF) Creation / Deletion / Modification of PDU
Sessions;
Even though the V-SMF creates the PDU Session resource onto the H-SMF, each of
the V-SMF and of the H-SMF needs to be able to modify a PDU Session and/or to
ask for PDU Session Release. Thus, at Nsmf_PDUSession_Create, V-SMF informs
the H-SMF about addressing information for its corresponding PDU Session
resource, allowing H-SMF to use later on the Nsmf_PDUSession_Update and
Nsmf_PDUSession_Release and Nsmf_PDUSession_StatusNotify operations.
NOTE 2: The PDU Session resource in V-SMF is created when the AMF requests to
create SM context of this PDU Session
NOTE 3: H-SMF also informs the consumer (V-SMF) about addressing information
about its PDU Session resource, but this is part of normal resource creation
operation in REST and not specific to this service.
##### 5.2.8.2.2 Nsmf_PDUSession_Create service operation
**Service operation name:** Nsmf_PDUSession_Create
**Description:** Create a new PDU Session in the H-SMF or create an
association with an existing PDN connection in the home PGW-C+SMF.
**Input, Required:** SUPI, V-SMF ID, V-SMF SM Context ID, DNN, V-CN Tunnel
Info, addressing information allowing the H-SMF to request the V-SMF to issue
further operations about the PDU Session.
**Input, Optional:** S-NSSAI, PCO, Requested PDU Session Type, 5GSM Core
Network Capability, Requested SSC mode, PDU Session ID, Number Of Packet
Filters, UE location information, subscription get notified of PDU Session
status change, PEI, GPSI, AN type, PCF ID, DNN Selection Mode, UE\'s Routing
Indicator or UDM Group ID for the UE, Always-on PDU Session Requested,
information provided by V-SMF related to charging in home routed scenario (see
TS 32.255 [45]), AMF ID, EPS Bearer Status.
**Output, Required:** Result Indication and if success a SM Context ID and in
addition: QFI(s), QoS Profile(s), Session-AMBR, QoS Rule(s), QoS Flow level
QoS parameters if any for the QoS Flow(s) associated with the QoS rule(s),
H-CN Tunnel Info, Enable pause of charging indication, Selected PDU Session
Type and SSC mode.
**Output, Optional:** PDU Session ID, S-NSSAI, Cause, PCO, UE IP address, IPv6
Prefix allocated to the PDU Session, information needed by V-SMF in the case
of EPS interworking such as the PDN Connection Type, Reflective QoS Timer,
Always-on PDU Session Granted, information provided by H-SMF related to
charging in home routed scenario (see TS 32.255 [45]).
The V-SMF SM Context ID in the Input provides addressing information allocated
by the V-SMF (to be used for service operations towards the V-SMF for this PDU
Session).
See clause 4.3.2.2.2, clause 4.11.1.2.2 and clause 4.11.1.3.3 for details on
the usage of this service operation.
##### 5.2.8.2.3 Nsmf_PDUSession_Update service operation
**Service operation name:** Nsmf_PDUSession_Update
**Description:** Update the established PDU Session.
This service operation is invoked by the V-SMF towards the H-SMF in the case
of UE or serving network requested PDU Session Modification in order for the
V-SMF to transfer the PDU Session Modification request. It can also be invoked
by the V-SMF to indicate to the H-SMF that the access type of the PDU session
can be changed.
This service operation is invoked by the H-SMF towards the V-SMF for both UE
initiated and HPLMN initiated PDU Session Modification and PDU Session Release
cases in order to have the SM PDU Session Modification request or SM PDU
Session Release request sent to the UE. It can also be invoked by the H-SMF
towards the V-SMF to release the 5GC and 5G-AN resources in e.g. handover from
5GC-N3IWF to EPS and from 5GS to EPC/ePDG, wherein the UE is not notified.
This service operation is invoked by the V-SMF and the H-SMF in the case of
PDU Session Establishment authentication/authorization by a DN-AAA server
defined in clause 4.3.2.3: it is used to carry DN Request Container
information between the DN-AAA server and the UE.
**Input, Required:** SM Context ID.
**Input, Optional:** UE location information (ULI), UE Time Zone, AN type,
indication of PDU Session Release, H-SMF SM Context ID (from H-SMF to V-SMF),
QoS Rule and QoS Flow level QoS parameters if any for the QoS Flow associated
with the QoS rule (from H-SMF to V-SMF), N9 Tunnel Info (from V-SMF to H-SMF),
Information requested by UE for e.g. QoS (from V-SMF to H-SMF), 5GSM Core
Network Capability, Information necessary for V-SMF to build SM Message
towards the UE (from H-SMF to V-SMF), Trigger PDU release indication (V-SMF to
H-SMF), Start Pause of Charging indication, Stop Pause of Charging indication,
DN Request Container information, indication that the UE shall not be
notified, EBI Allocation Parameters (ARP list), Secondary RAT usage data,
indication that the access type of the PDU session can be changed (V-SMF to
H-SMF).
**Output, Required:** Result indication, \ pair _._
**Output, Optional:** UE location information, AN Type, SM information from UE
(from V-SMF to H-SMF), list of Rejected QoS Flows (from V-SMF to H-SMF), a
list of \ pair, Secondary RAT Usage Data _._
The H-SMF SM Context ID in the Input provides addressing information allocated
by the H-SMF (to be used for service operations towards the H-SMF for this PDU
Session).
See clause 4.3.3.3 for an example usage of this service operation.
##### 5.2.8.2.4 Nsmf_PDUSession_Release service operation
**Service operation name:** Nsmf_PDUSession_Release
**Description:** It causes the immediate and unconditional deletion of the
resources associated with the PDU Session. This service operation is used by
V-SMF to request the H-SMF to release the resources related to a PDU Session
for the serving network initiated PDU release case (e.g. implicit De-
registration of UE in the serving network).
**Input, Required:** SM Context ID.
**Input, Optional:** Secondary RAT Usage Data.
**Output, Required:** Result Indication _._
**Output, Optional:** None _._
See clause 4.3.4.3 for an example usage of this service operation.
##### 5.2.8.2.5 Nsmf_PDUSession_CreateSMContext service operation
**Service operation name:** Nsmf_PDUSession_CreateSMContext.
**Description:** It creates an AMF-SMF association to support a PDU Session.
**Input, Required:** SUPI or PEI, DNN, AMF ID (AMF Instance ID).
**Input, Optional:** PEI, S-NSSAI(s), PDU Session Id, N1 SM container, UE
location information, UE Time Zone, AN type, H-SMF identifier/address, list of
alternative H-SMF(s) if available, old PDU Session ID (if the AMF also
received an old PDU Session ID from the UE as specified in clause 4.3.5.2),
Subscription For PDU Session Status Notification, indication that the SUPI has
not been authenticated, PCF ID, DNN Selection Mode, UE PDN Connection Context,
GPSI, UE presence in LADN service area, GUAMI, backup AMF(s) (if NF Type is
AMF), Trace Requirements. Backup AMF(s) sent only once by the AMF to the SMF
in its first interaction with the SMF, UE\'s Routing Indicator or UDM Group ID
for the UE, EPS Bearer Status. Target ID (for EPS to 5GS handover).
**Output, Required:** Result Indication and if successful SM Context ID.
**Output, Optional:** Cause, PDU Session ID, N2 SM information, N1 SM
container, S-NSSAI(s).
When the PDU Session is for Emergency services for a UE without USIM, the AMF
provides the PEI and not the SUPI as identifier of the UE. When the PDU
Session is for Emergency services of an unauthenticated UE with an USIM, the
AMF shall provide both the SUPI and the PEI and shall provide an indication
that the SUPI has not been authenticated.
See clause 4.3.2.2.1, clause 4.3.2.2.2, clause 4.11.1.2.2 and clause
4.11.1.3.3 for details on the usage of this service operation.
##### 5.2.8.2.6 Nsmf_PDUSession_UpdateSMContext service operation
**Service operation name:** Nsmf_PDUSession_UpdateSMContext.
**Description:** It allows to update the AMF-SMF association to support a PDU
Session and/or to provide SMF with N1/N2 SM information received from the UE
or from the AN.
**Input, Required:** SM Context ID.
**Input, Optional:** N1 SM container received from the UE, N2 SM information
received from the AN (e.g. N3 addressing information, notification indicating
that the QoS targets cannot be fulfilled for a QFI, Secondary RAT Usage Data),
Operation Type (e.g. UP activate, UP deactivate, UP To Be Switched), Serving
GW Address(es) and Serving GW DL TEID(s) for data forwarding during HO from
5GS to EPS, UE location information, AN type, UE Time Zone, H-SMF
identifier/address, EBI(s) to be revoked, PDU Session(s) to be re-activated,
Direct Forwarding Flag, ARP list, S-NSSAI, Data Forwarding Tunnel
(setup/release), UE presence in LADN service area, Target ID, Target AMF ID,
GUAMI, backup AMF(s) (if NF Type is AMF), Indication of Access Type can be
changed. Backup AMF(s) sent only once by the AMF to the SMF in its first
interaction with the SMF. Release indication and release cause.
**Output, Required:** Result Indication.
**Output, Optional:** PDU Session ID, Cause, released EBI list, allocated EBI
information, N2 SM information (e.g. QFI, UE location information,
notification indication indicating that the QoS targets cannot be fulfilled),
N1 SM container to be transferred to the AN/UE, type of N2 SM information.
See clause 4.3.3.2 and clause 4.3.3.3 for an example usage of this service
operation.
See clause 4.9.1.2.2 for the usage of the \"UP To Be Switched\" Operation
Type.
For the use of the \"EBI(s) to be revoked\" information, see clause
4.11.1.4.1.
For the use of the \"Direct Forwarding Flag\", see clause 4.11.1.2.2.2.
For the use of the \"Indication of Access Type can be changed\", see clause
4.2.3.2.
For the use of \"release indication and release cause\", see clause 4.3.4.2.
If the consumer NF is AMF and the SMF determines that some EBIs are not
needed, the SMF will put the EBIs back in the released EBI list.
If the consumer NF is AMF and Inter-system mobility happens, the SMF sends
allocated EBI information to AMF.
If the ARP of QoS flow is changed, the SMF uses this operation to update EBI-
ARP information in the AMF.
If the AMF does not have PDU Session ID, the PDU Session ID is not required
for Input and is required for Output.
If consumer NF is AMF and SMF includes N2 SM information in the Output, the
SMF indicates type of N2 SM information.
NOTE: The N2 SM information is not interpreted by the AMF.
##### 5.2.8.2.7 Nsmf_PDUSession_ReleaseSMContext service operation
**Service operation name:** Nsmf_PDUSession_ReleaseSMContext
**Description:** It allows to release the AMF-SMF association for a certain
PDU Session because the PDU Session has been released.
**Input, Required:** SM Context ID.
**Input, Optional:** UE location information, AN type, UE Time Zone, N2 SM
Info (Secondary RAT Usage Data).
**Output, Required:** Result Indication.
**Output, Optional:** Cause.
See clause 4.3.4.2 and clause 4.3.4.3 for an example usage of this service.
If the consumer NF is AMF and the PDU Session indicated by the PDU Session ID
had been assigned some EBIs, the AMF locally determines that the corresponding
EBI(s) are released.
##### 5.2.8.2.8 Nsmf_PDUSession_SMContextStatusNotify service operation
**Service operation name:** Nsmf_PDUSession_SMContextStatusNotify
**Description:** This service operation is used by the SMF to notify its
consumers about the status of an SM context related to a PDU Session (e.g. PDU
Session release due to local reasons within the SMF, PDU Session handover to a
different system or access type).
**Input, Required:** Status information.
**Input, Optional:** Cause.
**Output, Required:** Result Indication.
**Output, Optional:** None.
##### 5.2.8.2.9 Nsmf_PDUSession_StatusNotify service operation
**Service operation name:** Nsmf_PDUSession_StatusNotify
**Description:** This service operation is used by the SMF to notify its
consumers about the status of a PDU Session (e.g. PDU Session is released due
to local reasons within the H-SMF, PDU Session handover to a different system
or access type).
**Input, Required:** Status information.
**Input, Optional:** Cause.
**Output, Required:** Result Indication.
**Output, Optional:** None.
##### 5.2.8.2.10 Nsmf_PDUSession_ContextRequest service operation
**Service operation name:** Nsmf_PDUSession_ContextRequest
**Description:** This service operation is used by the NF Consumer to request
for SM Context (e.g. during EPS IWK, HO).
**Input, Required:** SM Context ID.
**Input, Optional:** Target MME Capability, PDU Session ID (include PDU
Session ID when available).
**Output, Required:** SM Context Container.
**Output, Optional:** None.
#### 5.2.8.3 Nsmf_EventExposure Service
##### 5.2.8.3.1 General
**Service description:** This service provides events related to PDU Sessions
towards consumer NF. The service operations exposed by this service allow
other NFs to subscribe and get notified of events happening on PDU Sessions.
The following are the key functionalities of this NF service.
\- Allow consumer NFs to Subscribe and unsubscribe for an Event ID on PDU
Session(s); and
\- Notifying events on the PDU Session to the subscribed NFs.
The following events can be subscribed by a NF consumer (Event ID is defined
in clause 4.15.1):
\- UE IP address / Prefix change: The event notification may contain a new UE
IP address / Prefix or an indication of which UE IP address / Prefix has been
released.
\- PDU Session Release.
\- UP path change: a notification corresponding to this event is sent when the
UE IP address / Prefix and / or DNAI and /or the N6 traffic routing
information has changed.
The event notification may contain following information:
\- the type of notification (\"EARLY\" or \"LATE\").
\- for both the source and target UP path between the UE and the DN, the
corresponding information is provided when it has changed:
\- DNAI.
\- UE IP address / Prefix.
\- N6 traffic routing information.
NOTE 1: UP path change notification, DNAI and N6 traffic routing information
are further described in clause 5.6.7 of TS 23.501 [2].
\- Change of Access Type; The event notification contains the new Access Type
for the PDU Session.
\- PLMN change; The event notification contains the new PLMN Identifier for
the PDU Session.
Event Filters are used to specify the conditions to match for notifying the
events (i.e. \"List of Parameter values to match\"). If there are no
conditions to match for a specific Event ID, then the Event Filter is not
provided. The following table provides as an example how the conditions to
match for event reporting can be specified for various Event IDs for SMF
exposure.
Table 5.2.8.3.1-1: Example of Event Filters for SMF exposure events
Event ID for SMF exposure Event Filter (List of Parameter Values to Match)
* * *
DNAI Change None PDU Session Release
The target of SMF event reporting may correspond to a PDU Session ID, an UE ID
(SUPI) an Internal Group Identifier or an indication that any UE is targeted
(on a specific DNN).
##### 5.2.8.3.2 Nsmf_EventExposure_Notify service operation
**Service operation name:** Nsmf_EventExposure_Notify
**Description:** Report UE PDU Session related event(s) to the NF which has
subscribed to the event report service.
**Input Required:** Event ID, Notification Correlation Information, UE ID
(SUPI and if available GPSI), PDU Session ID, time stamp.
**Input, Optional:** Event specific parameter list as described in clause
5.2.8.3.1.
**Output Required:** Result Indication.
**Output, Optional:** Redirection information _._
When the SMF detects the event subscribed by the NF consumer, the SMF reports
the subscribed event together with the Notification Target Address (+
Notification Correlation ID) to the Event Receiving NF.
The optional event specific parameter list provides the values that matched
for generating the event notification. The parameter values to match are
specified during the event subscription (see clause 5.2.8.3.3).
See clause 4.3.6.3 for details on usage of this service operation toward
Application Function.
If the NF consumer is AMF and the result of the service operation fails, the
AMF shall set corresponding cause value in result indication which can be used
by the SMF for further action. If the related UE is not served by the AMF and
the AMF knows which AMF is serving the UE, the AMF provides redirection
information which can be used by the SMF to resend UE related message to the
AMF that serves the UE.
NOTE: In the case of UP plane path, as described in clause 4.3.6.2, this
notification can be the result of an implicit subscription of the NEF/AF by
the PCF as part of setting PCC rule(s) via the Npcf_SMPolicyControl service
(see clause 5.2.5.4).
##### 5.2.8.3.3 Nsmf_EventExposure_Subscribe service operation
**Service operation name:** Nsmf_EventExposure_Subscribe
**Description:** This service operation is used by an NF to subscribe or
modify a subscription for event notifications on a specified PDU Session or
for all PDU Sessions of one UE, group of UE(s) or any UE.
**Input, Required:** NF ID, target of event as defined in clause 5.2.8.3.1,
(set of) Event ID(s) defined in clause 5.2.8.3.1, Notification Target Address
(+ Notification Correlation ID), Event Reporting Information defined in Table
4.15.1-1 _._
**Input, Optional:** Event Filter(s) associated with each Event ID; Event
Filter(s) are defined in clause 5.2.8.3.1, Subscription Correlation ID (in the
case of modification of the event subscription), Expiry time _._
**Output, Required:** When the subscription is accepted: Subscription
Correlation ID (required for management of this subscription), Expiry time
(required if the subscription can be expired based on the operator\'s
policy)_._
**Output, Optional:** First corresponding event report is included, if
available (see clause 4.15.1)_._
Notification Target Address (+ Notification Correlation ID) is used to
correlate Notifications sent by SMF with this subscription.
##### 5.2.8.3.4 Nsmf_EventExposure_UnSubscribe service operation
**Service operation name:** Nsmf_EventExposure_UnSubscribe
**Description:** This service operation is used by an NF to unsubscribe event
notifications.
**Input, Required:** Subscription Correlation ID _._
**Input, Optional:** None _._
**Output, Required:** None _._
**Output, Optional:** None _._
### 5.2.9 SMSF Services
#### 5.2.9.1 General
The following table illustrates the SMSF Services.
Table 5.2.9.1-1: List of SMSF Services
+------------------+--------------------+------------------+---------------------+ | Service Name | Service Operations | Operation | Example Consumer(s) | | | | | | | | | Semantics | | +==================+====================+==================+=====================+ | Nsmsf_SMService | Activate | Request/Response | AMF | +------------------+--------------------+------------------+---------------------+ | | Deactivate | Request/Response | AMF | +------------------+--------------------+------------------+---------------------+ | | UplinkSMS | Request/Response | AMF | +------------------+--------------------+------------------+---------------------+
#### 5.2.9.2 Nsmsf_SMService service
##### 5.2.9.2.1 General
This service allows AMF to authorize SMS and activate SMS for the served user
on SMSF.
##### 5.2.9.2.2 Nsmsf_SMService_Activate service operation
**Service operation name:** Nsmsf_SMService_Activate
**Description:** Authorize whether the specified UE is allowed to activate SMS
service, or add authorization for SMS over new Access Type.
**Concurrent use:** None.
**Inputs, Required:** SUPI, NF ID.
**Inputs, Optional:** GPSI, Time Zone, one or more Access Type(s), GUAMI,
backup AMF(s) (if NF Type is AMF). Backup AMF(s) sent only once by the AMF to
the SMSF in its first interaction with the SMSF, UE\'s Routing Indicator or
UDM Group ID for the UE.
**Outputs, Required:** SMS service activation result.
**Outputs, Optional:** None.
##### 5.2.9.2.3 Nsmsf_SMService_Deactivate service operation
**Service operation name:** Nsmsf_SMService_Deactivate
**Description:** Remove SMS service authorization from SMSF for a given
service user, or with Access Type included, remove authorization for SMS over
the affected Access Type.
**Concurrent use:** None.
**Inputs, Required:** SUPI.
**Inputs, Optional:** Access Type.
**Outputs, Required:** SMS service deactivation result.
**Outputs, Optional:** None.
##### 5.2.9.2.4 Nsmsf_SMService_UplinkSMS service operation
**Service operation name:** Nsmsf_SMService_UplinkSMS
**Description:** transmit uplink SMS message from consumer NF to SMSF.
**Concurrent use:** None.
**Inputs, Required:** SUPI, SMS payload.
**Inputs, Optional:** GPSI, UE Time Zone, UE Location Information (ULI).
**Outputs, Required:** SMS message transmission result.
**Outputs, Optional:** None.
### 5.2.10 AUSF Services
#### 5.2.10.1 General
The following table illustrates the AUSF Services.
Table 5.2.10.1-1: List of AUSF Services
+----------------+----------------+----------------+----------------+ | Service Name | Service | Operation | Example | | | Operations | | Consumer(s) | | | | Semantics | | +================+================+================+================+ | Nausf_UE | Authenticate | Re | AMF | | Authentication | | quest/Response | | +----------------+----------------+----------------+----------------+ | Nausf\ | Protect | Re | UDM | | _SoRProtection | | quest/Response | | +----------------+----------------+----------------+----------------+
#### 5.2.10.2 Nausf_UEAuthentication service
##### 5.2.10.2.1 General
**Service Description:** the AUSF provides UE authentication service to the
requester NF. For AKA based authentication, this operation can be also used to
recover from synchronization failure situations.
##### 5.2.10.2.2 Nausf_UEAuthentication_Authenticate service operation
See TS 33.501 [15].
##### 5.2.10.2.3 Void
#### 5.2.10.3 Nausf_SoRProtection service
##### 5.2.10.3.1 General
**Service Description:** The AUSF provides the Steering of Roaming information
protection service to the requester NF.
##### 5.2.10.3.2 Nausf_SoRProtection Protect service operation
See TS 33.501 [15].
### 5.2.11 NWDAF Services
#### 5.2.11.1 General
The following table illustrates the NWDAF Services.
Table 5.2.11.1-1: NF services provided by NWDAF
+----------------+----------------+----------------+----------------+ | Service Name | Service | Operation | Example | | | Operations | | Consumer(s) | | | | Semantics | | +================+================+================+================+ | Nnwdaf_Even | Subscribe | Subscribe / | PCF, NSSF | | tsSubscription | | Notify | | +----------------+----------------+----------------+----------------+ | | Unsubscribe | | PCF, NSSF | +----------------+----------------+----------------+----------------+ | | Notify | | PCF, NSSF | +----------------+----------------+----------------+----------------+ | Nnwdaf\ | Request | Request / | PCF, NSSF | | _AnalyticsInfo | | Response | | +----------------+----------------+----------------+----------------+
#### 5.2.11.2 Nnwdaf_EventsSubscription Service
##### 5.2.11.2.1 General
**Service Description** : this service enables the consumer to
subscribe/unsubscribe for load events notification of Network Slice instance.
Periodic notification and notification upon threshold exceeded can be
subscribed.
Following event are considered (Event ID defined in clause 4.15.1)
\- Load level information with following possible event filters:
\- Network Slice Instance.
\- Load Level Threshold value (the NWDAF report when the load level crosses
the threshold provided in the event subscription); if no threshold is provided
in the subscription, the reporting (Notify operation) is assumed to be
periodic.
##### 5.2.11.2.2 Nnwdaf_EventsSubscription_Subscribe service operation
**Service operation name:** Nnwdaf_EventsSubscription_Subscribe
**Description:** Subscribes to NWDAF event with specific parameters.
**Inputs Required:** S-NSSAI, (Set of) Event ID(s) defined in clause
5.2.11.2.1, Notification Target Address (+ Notification Correlation ID), Event
Reporting Information defined in Table 4.15.1-1.
**Inputs, Optional:** Event Filter(s) associated with each Event ID (e.g. Load
Level Threshold value), Subscription Correlation ID (in the case of
modification of the event subscription), NSI ID related to the S-NSSAI.
NOTE: The use of NSI ID within a PLMN depends on the network deployment. If
applicable, it can be provided by the NSSF and not by any other NF.
**Outputs Required:** When the subscription is accepted: Subscription
Correlation ID (required for management of this subscription).
**Outputs, Optional:** None.
Notification Target Address (+ Notification Correlation ID) is used to
correlate Notifications sent by NWDAF with this subscription.
NOTE: How load level of Network Slice instance is calculated is not specified
in 3GPP.
##### 5.2.11.2.3 Nnwdaf_EventsSubscription_Unsubscribe service operation
**Service operation name:** Nnwdaf_EventsSubscription_Unsubscribe
**Description:** unsubscribe to NWDAF event.
**Inputs, Required:** Subscription Correlation ID.
**Inputs, Optional:** None.
**Outputs, Required:** Confirmation of the unsubscription.
**Outputs, Optional:** None.
##### 5.2.11.2.4 Nnwdaf_EventsSubscription_Notify service operation
**Service operation name:** Nnwdaf_EventsSubscription_Notify
**Description:** NWDAF notifies the consumer instance of the event that has
subscribed to the specific NWDAF service. Depending upon type of subscription
this notification is either on a periodic basis or triggered whenever a
threshold is crossed.
**Inputs Required:** Event ID, Notification Target Address (+ Notification
Correlation ID), S-NSSAI, Load level information of Network Slice instance.
**Inputs, Optional:** NSI ID related to the S-NSSAI**.**
NOTE: The use of NSI ID within a PLMN depends on the network deployment. If
applicable, it can be provided by the NSSF and not by any other NF.
**Outputs Required:** None.
**Outputs, Optional:** None.
#### 5.2.11.3 Nnwdaf_Analytics_Info service
##### 5.2.11.3.1 General
**Service description:** this service enables the consumer to request and get
from NWDAF load level information of Network Slice instance(s).
The following events are considered (Event ID defined in clause 4.15.1):
\- Load level information with following possible event filters:
\- Network Slice Instance(s).
Table 5.2.11.3.1-1: Services provided by NWDAF on Request
+----------------------------------+----------------------------------+ | Service Description | Parameters | +==================================+==================================+ | Request for load level | Request: | | information of particular | | | Network Slice instance(s). | Event ID: load level information | | | | | These represent the information | Event Filter: network slice | | that have a meaning only in its | instance(s). | | network. | | | | Response: | | | | | | Requested Analytic data, | | | including load level information | | | of Network Slice instance(s). | +----------------------------------+----------------------------------+
##### 5.2.11.3.2 Nnwdaf_AnalyticsInfo_Request service operation
**Service operation name:** Nnwdaf_AnalyticsInfo_Request
**Description:** the consumer requests NWDAF operator specific analytics.
**Inputs Required:** Event ID defined in clause 5.2.11.3.1, Event Filter(s).
**Inputs, Optional:** None.
**Outputs Required:** Analysis with parameters indicated in Table
5.2.11.3.1-1.
**Outputs, Optional:** None.
### 5.2.12 UDR Services
#### 5.2.12.1 General
The following Data Set Identifiers shall be considered in this release:
Subscription Data, Policy Data, Application data and Data for Exposure. The
corresponding Data Subset Identifiers and Data (Sub)Key(s) are defined in
Table 5.2.12.2.1-1.
The set of Data Set Identifiers shall be extensible to cater for new
identifiers as well as for operator specific identifiers and related data to
be consumed.
The following table illustrates the UDR Services.
Table 5.2.12.1-1: NF services provided by UDR
NF service Service Operations Operation Semantics Example Consumer(s)
* * *
Data Management (DM) Query Request/Response UDM, PCF, NEF Create
Request/Response NEF Delete Request/Response NEF Update Request/Response UDM,
PCF, NEF Subscribe Subscribe/Notify UDM, PCF, NEF Unsubscribe UDM, PCF, NEF
Notify UDM, PCF, NEF
The following table shows the Exposure data that may be stored in the UDR
along with a time stamp using Data Management (DM) Service:
NOTE: When the data in Table 5.2.12.1-2 need to be monitored in real time,
they should be monitored directly at the originating NF (e.g. registration
state changes may be monitored via the Namf_EventExposure service) and not use
the stored information from UDR if it is not the latest. It is expected that
such dynamically changing information (e.g. UE reachability status) is used
for statistical purpose and analytics.
Table 5.2.12.1-2: Exposure data stored in the UDR
Category Information Description Data key Data Sub key
* * *
**Access and mobility information** UE location Gives the Location or the last
known location of a UE (e.g. Tai, Cell Id... both 3GPP and non-3GPP access
location) SUPI or GPSI  
UE time zone Current time zone for the UE SUPI or GPSI  
UE Access type 3GPP access or non-3GPP access SUPI or GPSI  
UE RAT type E-UTRA or NR SUPI or GPSI  
UE registration state Registered or Deregistered SUPI or GPSI  
UE connectivity state IDLE or CONNECTED SUPI or GPSI  
UE reachability status It indicates if the UE is reachable for sending either
SMS or downlink data to the UE, which is detected when the UE transitions to
CM-CONNECTED state or when the UE will become reachable for paging, e.g.
Periodic Registration Update timer SUPI or GPSI  
UE SMS over NAS service status SMS over NAS supported or not in the UE SUPI or
GPSI  
UE Roaming status It indicates UE\'s current roaming status (the serving PLMN
and/or whether the UE is in its HPLMN) SUPI or GPSI  
UE Current PLMN Current PLMN for the UE SUPI or GPSI  
**Session management** UE IP address UE IP address SUPI or GPSI PDU session ID
or DNN **information** PDU session status Active / released SUPI or GPSI PDU
session ID or DNN or UE IP address DNAI DNAI SUPI or GPSI PDU session ID or
DNN or UE IP address N6 traffic routing information N6 traffic routing
information SUPI or GPSI PDU session ID or DNN or UE IP address
#### 5.2.12.2 Nudr_DataManagement (DM) service
##### 5.2.12.2.1 General
The operations defined for Nudr_DM service use following set of parameters
defined in this clause:
\- Data Set Identifier:. uniquely identifies the requested set of data within
the UDR (see clause 4.2.5).
\- Data Subset Identifier: it uniquely identifies the data subset within each
Data Set Identifier. As specified in the procedures in clause 4. e.g.
subscription data can consist of subsets particularised for specific
procedures like mobility, session, etc.
\- Data Keys defined in Table 5.2.12.2.1-1
For Nudr_DM_Subscribe and Nudr_DM_Notify operations:
\- The Target of event reporting is made up of a Data Key and possibly a Data
Sub Key both defined in Table 5.2.12.2.1-1. When a Data Sub Key is defined in
the table but not present in the Nudr_DM_Subscribe this means that all values
of the Data Sub Key are targeted.
\- The Data Set Identifier plus (if present) the (set of) Data Subset
Identifier(s) corresponds to a (set of) Event ID(s) as defined in clause
4.15.1
An NF Service Consumer may include an indicator when it invokes Nudr_DM
Query/Create/Update service operation to subscribe the changes of the data, to
avoid a separate Nudr_DM_Subscribe service operation.
Depending on the use case, it is possible to use a Data Key and/or one or
multiple Data sub keys to further identify the corresponding data, as defined
in Table 5.2.12.2.1-1 below.
Table 5.2.12.2.1-1: Data keys
+----------------+----------------+----------------+----------------+ | Data Set | Data Subset | Data Key | Data Sub Key | +================+================+================+================+ | | Access and | SUPI | - | | | Mobility | | | | | Subscription | | | | | data | | | +----------------+----------------+----------------+----------------+ | | SMF Selection | SUPI | - | | | Subscription | | | | | data | | | +----------------+----------------+----------------+----------------+ | | UE context in | SUPI | PDU Session ID | | | SMF data | | or DNN | +----------------+----------------+----------------+----------------+ | Subscription | SMS Management | SUPI | - | | Data (see | Subscription | | | | cla | data | | | | use 5.2.3.3.1) | | | | +----------------+----------------+----------------+----------------+ | | SMS | SUPI | | | | Subscription | | | | | data | | | +----------------+----------------+----------------+----------------+ | | Session | SUPI | S-NSSAI | | | Management | | | | | Subscription | | | | | data | | | +----------------+----------------+----------------+----------------+ | | | | DNN | +----------------+----------------+----------------+----------------+ | | Slice | SUPI | - | | | Selection | | | | | Subscription | | | | | data | | | +----------------+----------------+----------------+----------------+ | Application | Packet Flow | Application ID | - | | data | Descriptions | | | | | (PFDs) | | | +----------------+----------------+----------------+----------------+ | | AF traffic | AF transaction | | | | influence | internal ID | | | | request | | | | | information | | | +----------------+----------------+----------------+----------------+ | | (See | S-NSSAI and | | | | clause 5.6.7 | DNN | | | | and | accompanied | | | | clause 6.3.7.2 | with Internal | | | | of | Group | | | | TS | Identifier or | | | | 23.501 [2]) | SUPI or \"any | | | | | UE\" | | | | | indication | | +----------------+----------------+----------------+----------------+ | Policy Data | UE context | SUPI | | | | policy control | | | | | data | | | | | | | | | | (See | | | | | clause 6.2.1.3 | | | | | of | | | | | TS | | | | | 23.503 [20]) | | | +----------------+----------------+----------------+----------------+ | | PDU Session | SUPI | S-NSSAI | | | policy control | | | | | data | | | +----------------+----------------+----------------+----------------+ | | (See | | DNN | | | clause 6.2.1.3 | | | | | of | | | | | TS | | | | | 23.503 [20]) | | | +----------------+----------------+----------------+----------------+ | | Policy Set | SUPI (for the | | | | Entry data | UDR in HPLMN) | | | | | | | | | (See | | | | | clause 6.2.1.3 | | | | | of | | | | | TS | | | | | 23.503 [20]) | | | +----------------+----------------+----------------+----------------+ | | | PLMN ID (for | | | | | the UDR in | | | | | VPLMN) | | +----------------+----------------+----------------+----------------+ | | Remaining | SUPI | S-NSSAI | | | allowed Usage | | | | | data | | | +----------------+----------------+----------------+----------------+ | | (See | | DNN | | | clause 6.2.1.3 | | | | | of | | | | | TS | | | | | 23.503 [20]) | | | +----------------+----------------+----------------+----------------+ | | Sponsored data | Sponsor | | | | connectivity | Identity | | | | profiles (See | | | | | clause 6.2.1.6 | | | | | of | | | | | TS | | | | | 23.503 [20]) | | | +----------------+----------------+----------------+----------------+ | | Background | Background | | | | Data Transfer | Data Transfer | | | | data | Reference ID. | | | | | (NOTE 2) | | | | (See | | | | | clause 6.2.1.6 | | | | | of | | | | | TS | | | | | 23.503 [20]) | | | +----------------+----------------+----------------+----------------+ | | | None. (NOTE 1) | | +----------------+----------------+----------------+----------------+ | Exposure Data | Access and | SUPI or GPSI | PDU Session ID | | | Mobility | | or | | | Information | | | +----------------+----------------+----------------+----------------+ | (see | Session | SUPI or GPSI | UE IP address | | cl | Management | | or DNN | | ause 5.2.12.1) | information | | | +----------------+----------------+----------------+----------------+ | NOTE 1: | | | | | Retrieval of | | | | | the stored | | | | | Background | | | | | Data Transfer | | | | | References for | | | | | all ASP | | | | | identifiers in | | | | | the UDR | | | | | requires Data | | | | | Subset but no | | | | | Data Key or | | | | | Data | | | | | Subkey(s). | | | | | | | | | | NOTE 2: Update | | | | | of a | | | | | Background | | | | | Data Transfer | | | | | Reference in | | | | | the UDR | | | | | requires a | | | | | Data key to | | | | | refer to a | | | | | Background | | | | | Data Transfer | | | | | Reference as | | | | | input data. | | | | +----------------+----------------+----------------+----------------+
The content of the UDR storage for (Data Set Id= Application Data, Data Subset
Id = AF traffic influence request information) is specified in clause 5.6.7,
Table 5.6.7-1 of TS 23.501 [2]. This information is written by the NEF and
read by the PCF(s). PCF(s) may also subscribe to changes onto this
information.
##### 5.2.12.2.2 Nudr_DM_Query service operation
**Service operation name:** Nudr_DM_Query
**Description:** NF service consumer requests a set of data from UDR.
**Inputs, Required:** Data Set Identifier.
**Inputs, Optional:** Data Key(s), Data Subset Identifier(s), SUPI, Data Sub
Key(s) (for each Data Subset, see clause 5.2.12.2.1).
The SUPI is used to identify which UE the latest list of stored PSIs belongs
to.
**Outputs, Required:** Requested data.
**Outputs, Optional:** None.
##### 5.2.12.2.3 Nudr_DM_Create service operation
**Service operation name:** Nudr_DM_Create
**Description:** NF service consumer intends to insert a new data record into
the UDR, e.g. a NF service consumer intends to insert a new application data
record into the UDR.
**Inputs, Required:** Data Set Identifier, Data Key(s).
**Inputs, Optional:** Data Subset Identifier(s), Data Sub Key(s) (for each
Data Subset, see clause 5.2.12.2.1).
**Outputs, Required:** Result.
**Outputs, Optional:** None.
##### 5.2.12.2.4 Nudr_DM_Delete service operation
**Service operation name:** Nudr_DM_Delete
**Description:** NF service consumer intends to delete user data stored in the
UDR, e.g. a NF service consumer intends to delete an application data record.
**Inputs, Required:** Data Set Identifier, Data Key(s).
**Inputs, Optional:** Data Subset Identifier(s), Data Sub Key(s) (for each
Data Subset, see clause 5.2.12.2.1).
**Outputs, Required:** Result.
**Outputs, Optional:** None.
##### 5.2.12.2.5 Nudr_DM_Update service operation
**Service operation name:** Nudr_DM_Update
**Description:** NF service consumer intends to update stored data in the UDR.
**Inputs, Required:** Data Set Identifier, Data Key(s), Data.
**Inputs, Optional:** Data Subset Identifier(s), Data Sub Key(s) (for each
Data Subset, see clause 5.2.12.2.1).
**Outputs, Required:** Result.
**Outputs, Optional:** None.
##### 5.2.12.2.6 Nudr_DM_Subscribe service operation
**Service operation name:** Nudr_DM_Subscribe.
**Description:** NF service consumer performs the subscription to notification
to data modified in the UDR. The events can be changes on existing data,
addition of data.
**Inputs, Required:** Data Set Identifier as defined in clause 5.2.12.2.1,
Notification Target Address (+ Notification Correlation ID), Event Reporting
Information defined in Table 4.15.1-1.
**Inputs, Optional:** Target of event reporting as defined in clause
5.2.12.2.1, Data Subset Identifier(s) as defined in clause 5.2.12.2.1,
Subscription Correlation ID (in the case of modification of the event
subscription).
**Outputs, Required:** When the subscription is accepted: Subscription
Correlation ID.
**Outputs, Optional:** None.
##### 5.2.12.2.7 Nudr_DM_Unsubscribe service operation
**Service operation name:** Nudr_DM_Unsubscribe
**Description:** NF service consumer performs the un-subscription to
notification to data modified in the UDR. The events can be changes on
existing data, addition of data.
**Inputs, Required:** Subscription Correlation ID.
**Inputs, Optional:** None.
**Outputs, Required:** Result.
**Outputs, Optional:** None.
##### 5.2.12.2.8 Nudr_DM_Notify service operation
**Service operation name:** Nudr_DM_Notify
**Description:** UDR notifies NF service consumer(s) about modification of
data, when data in the UDR is added, modified or deleted and an NF needs to be
informed about this, due to a previous subscription to notifications procedure
or due to a local configuration policy in the UDR.
**Inputs, Required:** Notification Correlation Information, Data Set
Identifier as defined in clause 5.2.12.2.1, Target of event reporting as
defined in clause 5.2.12.2, Updated Data.
**Inputs, Optional:** Data Subset Identifier as defined in clause 5.2.12.2.1.
**Outputs, Required:** Result.
**Outputs, Optional:** None.
### 5.2.13 BSF Services
#### 5.2.13.1 General
The following table shows the BSF Services and Service Operations:
Table 5.2.13.1-1: NF services provided by the BSF
+------------------+--------------------+------------------+---------------------+ | Service Name | Service Operations | Operation | Example Consumer(s) | | | | | | | | | Semantics | | +==================+====================+==================+=====================+ | Nbsf_management | Register | Request/Response | PCF | +------------------+--------------------+------------------+---------------------+ | | Deregister | Request/Response | PCF | +------------------+--------------------+------------------+---------------------+ | | Discovery | Request/Response | NEF, AF | +------------------+--------------------+------------------+---------------------+
#### 5.2.13.2 Nbsf_Management service
##### 5.2.13.2.1 General
The Nbsf provides the Nbsf Management Register, Nbsf Management Remove and the
Nbsf Management Discovery service operations.
##### 5.2.13.2.2 Nbsf_Management_Register service operation
**Service Operation name:** Nbsf_Management_Register
**Description:** Registers the tuple (UE address(es), SUPI, GPSI, DNN, DN
information (e.g. S-NSSAI), PCF id).
**Inputs, Required:** UE address(es), PCF id
UE address can contain IP address/prefix or Ethernet address as defined in TS
23.501 [2].
**Inputs, Optional:** DNN, SUPI, GPSI, DN information (e.g. S-NSSAI)
**Outputs, Required:** Result indication.
**Outputs, Optional:** None.
##### 5.2.13.2.3 Nbsf_Management_Deregister service operation
**Service Operation name:** Nbsf_Management_Deregister
**Description:** Removes the tuple (UE address(es), SUPI, GPSI, DNN, DN
information (e.g. S-NSSAI), PCF id).
**Inputs, Required:** UE address(es)
UE address can contain IP address/prefix or Ethernet address as defined in TS
23.501 [2].
**Inputs, Optional:** DNN, SUPI, GPSI, DN information (e.g. S-NSSAI)
**Outputs, Required:** Result indication.
**Outputs, Optional:** None.
##### 5.2.13.2.4 Nbsf_Management_Discovery service operation
**Service Operation name:** Nbsf_Management discovery
**Description:** Discovers the PCF selected for the tuple (UE address(es),
SUPI, GPSI, DNN, DN information (e.g. S-NSSAI)).
**Inputs, Required:** UE address (i.e. IP address or MAC address), DNN
[Conditional], DN information (e.g. S-NSSAI) [Conditional]
**Inputs, Optional:** SUPI, GPSI
**Outputs, Required:** PCF id
**Outputs, Optional:** None.
### 5.2.14 UDSF Services
#### 5.2.14.1 General
The following table illustrates the UDSF Services.
Table 5.2.14-1: NF Services provided by UDSF
NF service Service Operations Operation Semantics Example Consumer(s)
* * *
Unstructured Query Request/Response Any NF Data Create Request/Response Any NF
Management Delete Request/Response Any NF Update Request/Response Any NF
NOTE: whether Nudsf is an exception as compared to other service-based
interface due to dynamic data access performance requirement is per stage 3
decision.
#### 5.2.14.2 Nudsf_UnstructuredDataManagement service
##### 5.2.14.2.1 General
##### 5.2.14.2.2 Nudsf_UnstructuredDataManagement_Query service operation
**Service operation name:** Nudsf_UnstructuredDataManagement_Query
**Description:** NF service consumer intends to query data from UDSF.
**Inputs, Required:** Data Identifier.
Data Identifier uniquely identifies the data to be retrieved from the UDSF
**Inputs, Optional:** None.
**Outputs, Required:** Requested data.
**Outputs, Optional:** None.
##### 5.2.14.2.3 Nudsf_UnstructuredDataManagement_Create service operation
**Service operation name:** Nudsf_UnstructuredDataManagement_Create
**Description:** NF service consumer intends to insert a new user data record
into the UDSF, e.g. AMF stores the context for registered UE(s) in the UDSF.
**Inputs, Required:** Data Identifier, Data.
Data Identifier uniquely identifies the data, which is created in the UDSF.
**Inputs, Optional:** None
**Outputs, Required:** Result.
**Outputs, Optional:** None.
##### 5.2.14.2.4 Nudsf_UnstructuredDataManagement_Delete service operation
**Service operation name:** Nudsf_UnstructuredDataManagement_Delete
**Description:** NF service consumer intends to delete user data stored in the
UDSF, e.g. when AMF deletes the context for unregistered UE(s) in the UDSF.
**Inputs, Required:** Data Identifier.
**Inputs, Optional:** None.
Data Identifier uniquely identifies the data to be deleted within the UDSF.
**Outputs, Required:** Result.
**Outputs, Optional:** None.
##### 5.2.14.2.5 Nudsf_UnstructuredDataManagement_Update service operation
**Service operation name:** Nudsf_UnstructuredDataManagement_Update
**Description:** NF service consumer intends to update stored data in the
UDSF.
**Inputs, Required:** Data Identifier, Data.
Data Identifier uniquely identifies the data, which is updated in the UDSF.
**Inputs, Optional:** None.
**Outputs, Required:** Result.
**Outputs, Optional:** None.
### 5.2.15 LMF Services
#### 5.2.15.1 General
The following table shows the LMF Services and LMF Service Operations.
Table 5.2.15.1-1: List of LMF Services
+----------------+--------------------+------------------+---------------------+ | Service Name | Service Operations | Operation | Example Consumer(s) | | | | | | | | | Semantics | | +================+====================+==================+=====================+ | Nlmf_Location | DetermineLocation | Request/Response | AMF | +----------------+--------------------+------------------+---------------------+
#### 5.2.15.2 Nlmf_Location service
##### 5.2.15.2.1 General
**Service description:** This service enables an NF to request location
determination for a target UE. The following are the key functionalities of
this NF service.
\- Allow NFs to request the current geodetic and optionally civic location of
a target UE.
##### 5.2.15.2.2 Nlmf_Location_DetermineLocation service operation
**Service operation name:** Nlmf_Location_DetermineLocation
**Description:** Provides UE location information to the consumer NF.
**Input, Required:** External Client Type, LCS Correlation Identifier.
**Input, Optional:** serving cell identifier if UE is using 3GPP access,
Location QoS, Supported GAD shapes, AMF identity if a UE associated
Namf_Communication service is to be invoked by LMF, indication if UE supports
LPP or not.
**Output, Required:** Success/Failure indication
**Output, Optional:** Geodetic Location, Civic Location, Position Methods Used
(in the case of success indication provided), Failure Cause (in the case of
failure indication provided).
See steps 6 and 8 of clause 4.13.5.3 for example of usage of this service
operation.
### 5.2.16 NSSF Services
#### 5.2.16.1 General
The following table illustrates the NSSF Services.
Table 5.2.16.1-1: NF Services provided by NSSF
+----------------+----------------+----------------+----------------+ | Service Name | Service | Operation | Example | | | Operations | | Consumer(s) | | | | Semantics | | +================+================+================+================+ | Nnss | Get | Re | AMF, NSSF in a | | f_NSSelection | | quest/Response | different PLMN | +----------------+----------------+----------------+----------------+ | Nnssf_NSS | Update | Re | AMF | | AIAvailability | | quest/Response | | +----------------+----------------+----------------+----------------+ | | Subscribe | Su | AMF | | | | bscribe/Notify | | +----------------+----------------+----------------+----------------+ | | Unsubscribe | | AMF | +----------------+----------------+----------------+----------------+ | | Notify | | AMF | +----------------+----------------+----------------+----------------+ | | Delete | Re | AMF | | | | quest/Response | | +----------------+----------------+----------------+----------------+
#### 5.2.16.2 Nnssf_NSSelection service
##### 5.2.16.2.1 Nnssf_NSSelection_Get service operation
**Service operation name:** Nnssf_NSSelection_Get
**Description:** This service operation enables Network Slice selection in
both the Serving PLMN and HPLMN. It also enables the NSSF to provide to the
AMF the Allowed NSSAI and the Configured NSSAI for the Serving PLMN.
It may be invoked during Registration procedure, during PDU Session
Establishment procedure or during UE Configuration Update procedure. When
invoked during Registration procedure it may possibly trigger AMF re-
allocation. When invoked during PDU Session Establishment procedure it may be
invoked in the VPLMN or in the HPLMN. When invoked during UE Configuration
Update procedure it may be invoked in the Serving PLMN.
NOTE 1: The list of events, which trigger invoking of the
Nnssf_NSSelection_Get service operation, is not exhaustive.
**Inputs, Required:** None.
**Inputs, Conditional Required:**
If this service operation is invoked during Registration procedure not
triggered by mobility from EPS to 5GS or UE Configuration Update procedure,
then the following inputs are required:
\- Subscribed S-NSSAI(s) with the indication if marked as default S-NSSAI,
PLMN ID of the SUPI, TAI, NF type of the NF service consumer, Requester ID.
If this service operation is invoked during Registration procedure triggered
by mobility from EPS to 5GS with N26 (as described in clause 4.11.1.3.3), the
following inputs are required:
\- S-NSSAIs for the HPLMN associated with established PDN connection, PLMN ID
of the SUPI, NF type of the NF service consumer, Requester ID.
If this service operation is invoked during PDN Connection Establishment in
the Serving PLMN in EPS by a PGW-C+SMF, the following inputs are required:
\- Subscribed S-NSSAIs for the UE, PLMN ID of the SUPI, NF type of the NF
service consumer, Requester ID.
Else, if this service operation is invoked during PDU Session Establishment
procedure in the Serving PLMN then the following inputs are required:
\- S-NSSAI, non-roaming/LBO roaming/HR roaming indication, PLMN ID of the
SUPI, TAI, NF type of the NF service consumer, Requester ID.
**Inputs, Optional:**
If this service operation is invoked during Registration procedure not
triggered by mobility from EPS to 5GS or UE Configuration Update procedure,
then the following inputs are provided if available:
\- Requested NSSAI, Mapping Of Requested NSSAI, Default Configured NSSAI
Indication, Allowed NSSAI for current Access Type, Allowed NSSAI for the other
Access Type and the corresponding Mapping Of Allowed NSSAIs for current Access
Type and other Access Type.
If this service operation is invoked during PDU Session Establishment
procedure, then the following input is optional:
\- HPLMN S-NSSAI that maps to the S-NSSAI from the Allowed NSSAI of the
Serving PLMN.
**Outputs, Conditional Required:**
If this service operation is invoked during Registration procedure not
triggered by mobility from EPS to 5GS or UE Configuration Update procedure,
then one or more of the following outputs are required:
\- Allowed NSSAI, Configured NSSAI; Target AMF Set or, based on configuration,
the list of candidate AMF(s).
If this service operation is invoked during Registration procedure triggered
by mobility from EPS to 5GS with N26 (as described in clause 4.11.1.3.3), the
following output is required:
\- S-NSSAIs for the HPLMN associated with established PDN connection, Mapping
of S-NSSAIs associated with established PDN connection in the Serving PLMN.
If this service operation is invoked during PDN Connection Establishment in
the Serving PLMN in EPS by a PGW-C+SMF, the following outputs are required:
\- Subscribed S-NSSAIs for the UE, Mapping of S-NSSAIs associated with the
subscribed S-NSSAIs for the UE in the Serving PLMN.
Else, if this service operation is invoked during PDU Session Establishment
procedure then the following outputs are required:
\- The NRF to be used to select NFs/services within the selected Network Slice
instance.
**Outputs, conditional Optional:** If this service operation is invoked during
UE Registration procedure or UE Configuration Update procedure, then one or
more of the following outputs are optional:
\- Mapping Of Allowed NSSAI, Mapping Of Configured NSSAI, NSI ID(s) associated
with the Network Slice instances of the Allowed NSSAI, NRF(s) to be used to
select NFs/services within the selected Network Slice instance(s) and NRF to
be used to determine the list of candidate AMF(s) from the AMF Set, rejected
S-NSSAI with cause of rejection.
Else, if this service operation is invoked during PDU Session Establishment
procedure, then the following output is optional:
\- NSI ID associated with the S-NSSAI provided in the input.
#### 5.2.16.3 Nnssf_NSSAIAvailability service
##### 5.2.16.3.1 General
**Service description:** This service enables to update the AMFs and the NSSF
on the availability of S-NSSAIs on a per TA basis.
##### 5.2.16.3.2 Nnssf_NSSAIAvailability_Update service operation
**Service operation name:** Nnssf_NSSAIAvailability_Update
**Description:** This service operation enables the AMF to update the NSSF
with the S-NSSAIs the AMF supports per TA and get the availability of the
S-NSSAIs per TA for the S-NSSAIs the AMF supports.
**Inputs, Required:** Supported S-NSSAIs per TAI.
The supported S-NSSAIs per TAI, is a list of TAIs and for each TAI the
S-NSSAIs supported by the AMF.
**Inputs, Optional:** None.
**Outputs, Required:** A list of TAIs and, for each TAI, the S-NSSAIs
supported by the AMF and 5G-AN and authorized by the NSSF for the TAI.
**Outputs, Optional:** For each TAI, a list of S-NSSAIs restricted per PLMN
for the TAI _._
##### 5.2.16.3.3 Nnssf_NSSAIAvailability_Notify service operation
**Service operation name:** Nnssf_NSSAIAvailability_Notify
**Description:** This service operation enables the NSSF to update the AMF
with any S-NSSAIs restricted per TA and, if needed, subsequently lift any
restriction per TA.
**Inputs, Required:** SubscriptionId, a list of TAIs and the S-NSSAIs for
which the status is changed (restricted/unrestricted) per each TAI.
**Inputs, Optional:** None.
**Outputs, Required:** None.
**Outputs, Optional:** None _._
##### 5.2.16.3.4 Nnssf_NSSAIAvailability_Subscribe service operation
**Service operation name:** Nnssf_NSSAIAvailability_Subscribe
**Description:** This service operation enables a NF Service Consumer (e.g.
AMF) to subscribe to a notification of any changes in status of the NSSAI
availability information (e.g. S-NSSAIs available per TA and the restricted
S-NSSAI(s) per PLMN in that TA in the serving PLMN of the UE) upon this is
updated by another AMF.
**Inputs, Required:** Callback URI of the NF Service Consumer, list of TAIs
supported by the NF service consumer, event to be subscribed.
**Inputs, Optional:** Expiry time.
**Outputs, Required:** SubscriptionID.
**Outputs, Conditional Required:** Expiry time (if present in the request, may
be included in the response based on operator\'s policy and taking into
account the expiry time present in the request (i.e. should be less than or
equal to that value); if not present in the request, may be included in the
response based on operator\'s policy. Whatever the case, if not included in
the response, this means that the subscription is valid without an expiry
time).
**Outputs, Optional:** A list of TAIs and, for each TAI, the S-NSSAIs
supported by the AMF and 5G-AN and authorized by the NSSF for the TAI and a
list of S-NSSAIs restricted per PLMN for the TAI.
##### 5.2.16.3.5 Nnssf_NSSAIAvailability_Unsubscribe service operation
**Service operation name:** Nnssf_NSSAIAvailability_Unsubscribe
**Description:** This service operation enables a NF Service Consumer (e.g.
AMF) to unsubscribe to a notification of any previously subscribed changes to
the NSSAI availability information.
**Inputs, Required:** SubscriptionId.
**Inputs, Optional:** None.
**Outputs, Required:** None.
**Outputs, Optional:** None.
##### 5.2.16.3.6 Nnssf_NSSAIAvailability_Delete service operation
**Service operation name:** Nnssf_NSSAIAvailability_Delete
**Description:** This service operation enables a NF service consumer (e.g.
AMF) to delete the NSSAI availability information stored for the NF service
consumer in the NSSF.
**Inputs, Required:** NfId.
**Inputs, Optional:** None.
**Outputs, Required:** None.
**Outputs, Optional:** None.
### 5.2.17 CHF Spending Limit Control Service
#### 5.2.17.1 General
The following table illustrates the CHF Services defined in this
specification. The other services of CHF are defined in clause 6.2 of TS
32.290 [42].
Tale 5.2.17.1-1: CHF Services
Service Name Service Operations Operation Semantics Example Consumer(s)
* * *
Nchf_SpendingLimitControl Subscribe Subscribe/Notify PCF Unsubscribe PCF
Notify PCF
#### 5.2.17.2 Nchf_SpendingLimitControl service
##### 5.2.17.2.1 General
**Service description:** This service enables transfer of policy counter
status information relating to subscriber spending limits from CHF to the NF
consumer.
##### 5.2.17.2.2 Nchf_SpendingLimitControl Subscribe service operation
**Service operation name:** Nchf_SpendingLimitControl_Subscribe
**Description:** Subscribe to notification of changes in the status of the
policy counters available at the CHF and retrieval of the status of the policy
counters for which subscription is accepted by CHF.
**Inputs, Required:** SUPI (for the Initial Spending Limit request),
SubscriptionCorrelationId (for the Intermediate Spending Limit report), Event
Id \"policy counter status change\", Event Filter Information \"List of policy
counter identifier (s)\".
**Inputs, Optional:** Notification Correlation Target (required for the
Initial Spending Limit request), Event Filter Information \"List of policy
counter identifier (s)\", Event Reporting Information (continuous reporting).
**Outputs, Required:** Status of the requested subscribed policy counters to
the subscriber in the Event Information.
**Outputs, Optional:** Pending policy counter statuses and their activation
times, for all policy counter(s) available for this subscriber. If list of
policy counter identifier(s) was provided, the CHF returns only the pending
policy counter statuses and their activation times, per required policy
counter identifier in the Event Information, SubscriptionCorrelationId.
##### 5.2.17.2.3 Nchf_SpendingLimitControl Unsubscribe service operation
**Service operation name:** Nchf_SpendingLimitControl_Unsubscribe
**Description:** Cancel the subscription to status changes for all the policy
counters available at the CHF.
**Inputs, Required:** SubscriptionCorrelationId.
**Inputs, Optional:** None.
**Outputs, Required:** Success or Failure.
**Outputs, Optional:** None.
##### 5.2.17.2.4 Nchf_SpendingLimitControl Notify service operation
**Service operation name:** Nchf_SpendingLimitControl_Notify
**Description:** Notify the change of the status of the subscribed policy
counters available at the CHF. Alternatively, it can be used by the CHF to
provide one or more pending statuses for a subscribed policy counter together
with the time they have to be applied. Alternatively, it is also used by the
CHF to notify the removal of a subscriber from the CHF system, so that the NF
consumer can terminate the subscriptions of all the policy counters of the
subscriber.
**Inputs, Required:** Notification Target Address, SUPI.
**Inputs, Optional:** policy counter status as Event Information, Pending
policy counter statuses and their activation times as Event Information.
Subscriber removal from the CHF system as Event Information.
**Outputs, Required:** Success or Failure.
**Outputs, Optional:** None.
###### ## Annex A (informative): Drafting rules and conventions for NF
services
# A.1 General
This informative Annex provides drafting rules and conventions followed in
this technical specification (and TS 23.501 [2]) for the definition of NF
services offered over the service-based interfaces.
# A.2 Naming
## A.2.1 Service naming
Each NF service provided by a service-based interface shall be named and
referred to according to the following nomenclature:
_\- Nnfname_ServiceName_ , where _Nnfname_ is the service-based interface
where the NF service is invoked. See clause 4.2.5 of TS 23.501 [2] for the
list of service-based interfaces in the 5GS Architecture.
Example (illustrative): _Namf_Registration._
## A.2.2 Service operation naming
If a service contains multiple independent operations, each operation shall be
named and referred to according to the following nomenclature:
_\- Nnfname_ServiceName_ServiceOperation[Method]_ , where the _ServiceName_
represents the actual NF service. The _ServiceOperation_ itself defines the
available service functionality which can be addressed by a specific
operation. The _Method(s)_ is/are the action(s), how the ServiceOperation can
be used. It can be created, read, updated or deleted.
Example (illustrative): _Namf_Session_Registration[Create]_ ,
_Namf_Session_Registration[Delete]_
In general, this operation naming structure for the given example is depicted
in a tree-structure diagram:
Figure A.2.2-1: Service Operation Naming and its Methods
# A.3 Representation in an information flow
Invoking a service or service operation within an information flow is
represented using a disaggregated representation (see figure A.3-1).
The disaggregated representations on figure A.3-1 shall be used as follows:
\- The \ represents the actual step number in the information flow e.g.
â€³7.â€³.
\- Representation a) shall be used when the step is required.
\- Representation b) shall be used when the step is optional or conditional.
Figure A.3-1: Disaggregated representation of a NF service or service
operation in information flows
NOTE: Depending on the information flow, the order of NF Producer and NF
Consumer can be reversed.
# A.4 Reference to services and service operations in procedures
Whenever a procedure needs to refer to the service or service operation of a
service-based interface, the naming in clause A.2 shall be used, using italic
font. Unless otherwise obvious in the text, the NF Consumer of the service or
service operation shall be indicated within parenthesis after the service or
service operation name.
\- \> (\)
Example: e.g. _Namf_Registration_RelocationRequest (AMF)_
# A.5 Service and service operation description template
The description of a service or service operation in this specification shall
be done according to the following template.
NOTE: The heading level should follow that of the actual clause where the
service is specified.
**X.x \ >**
**X.x.1 Description**
**Service or service operation name:**
\>.
**Description:** \.
**Known NF Consumers:** \.
**Inputs, Required:** \ _\-- Parameters required from NF
Consumer for successful completion of the service or service operation.
Parameters required for the operation of the underlying protocol shall not be
listed._
**Inputs, Optional:** \ _\-- Additional parameters that
may be provided by NF Consumer for execution of the service or service
operation. Parameters required for the operation of the underlying protocol
shall not be listed._
**Outputs, Required:** \, \>, \ _\-- Parameters provided to
NF Consumer and/or service triggered upon successful completion of the service
and/or other (e.g. procedure triggered). Parameters required for the operation
of the underlying protocol shall not be listed._
**Outputs, Optional:** \ \-- _Additional parameters
provided to NF Consumer upon successful completion of the service or service
operation. Parameters required for the operation of the underlying protocol
shall not be listed._
**X.x.2 Service/service operation information flow**
\.
NOTE: This information flow can require invoking other services. In this case,
the invoked services are represented as described in clause A.3.
# A.6 Design Guidelines for NF services
Clause 7.1.1 of TS 23.501 [2] defines the criteria for defining the NF
services. The following clauses identify the design guidelines that shall be
considered for identifying the NF services.
## A.6.1 Self-Containment
The following design guidelines are used for identifying self-contained NF
services.
\- Each NF service operates on its own set of context(s). A context refers to
a state or a software resource or an internal data storage. The NF service
operations can create, read, update or delete the context(s).
\- Any direct access of a context(s) owned by a NF service is be made by the
service operations of that NF service. Services provided by the same NF can
communicate internally within the NF.
## A.6.2 Reusability
The following design guidelines are used for specifying NF services to be
reusable.
\- NF service operations are specified such that other NF can potentially
invoke them in future, if required.
\- The service operations may be usable in multiple system procedures
specified in clause 4 of this specification.
\- Using clause 4 of the current document, the system procedures in which the
NF service operations can be used are considered and based on that the
parameters for the NF service operations are clearly listed.
NOTE: It is possible that, when mapping an end to end call flow to service
based architecture, one step in the call flow may map to multiple NF service
operation invocations. This specification clearly identifies each NF service
operation invocation in the call flow. Protocol optimization of multiple NF
service operation invocations are left for TS 29.500 [17] consideration.
## A.6.3 Use Independent Management Schemes
The mechanisms for independent management schemes are not in scope of this
specification.
###### ## Annex B (informative): Drafting Rules for Information flows
The following drafting rules are recommended for information flows specified
in this specification in order to ensure that the Control Plane network
functions can be supported with service based interfaces:
1\. Information flows should describe the end to end functionality. NF
services in clause 5 shall only be derived from the information flows in
clause 4.
2\. Information flows should strive to use type of interactions such as
REQUEST/RESPONSE (e.g. location request, location response), SUBSCRIBE/NOTIFY
between Core CP NFs. Any other type of interactions described should have
justifications for its use.
3\. Information flows should also ensure readability thus the semantics of the
REQUEST/RESPONSE should still be maintained (for instance, we need to indicate
PDU Session request, PDU Session response and Subscribe for UE location
reporting/Notify UE location reporting) for readers and developers to
understand the need for a certain transaction.
NOTE: As stated in TS 23.501 [2], service based interface is not supported for
N1, N2, N4. Thus, the rules are not meant for those interfaces.
###### ## Annex C (informative): Generating EPS PDN Connection parameters from
5G PDU Session parameters
This annex specifies how to generate the EPS PDN connection parameters from
the 5G PDU Session parameters in PGW-C+SMF.
When the PGW-C+SMF is requested to set up/modify either a PDN connection or a
PDU session supporting interworking between EPS and 5GS, the PGW-C+SMF
generates the PDN Connection parameters from the PDU session parameters.
When the PGW-C+SMF generates the PDN Connection parameters based on the PDU
Session parameters, the following rules hold:
\- PDN type: the PDN type is set to IPv4, IPv6 or IPv4v6 if the PDU Session
Type is IPv4, IPv6 or IPv4v6, respectively. The PDN type is set to Non-IP for
Ethernet and Unstructured PDU Session Types
\- EPS bearer ID: the EBI is requested from the AMF during the establishment
of a QoS Flow as described in clause 4.11.1.4.1 for PDU Sessions supporting
interworking between EPS and 5GS. The EBI is obtained from MME during the
establishment of an EPS Bearer (that is triggered by an establishment of a QoS
Flow) as defined in TS 23.401 [13] for PDN Connections hosted by PGW-C+SMF.
The association between EBI and QoS Flow is stored by the SMF.
\- APN-AMBR: APN-AMBR is set according to operator policy (e.g. taking the
Session AMBR into account).
\- EPS QoS parameters (including ARP, QCI, GBR and MBR):
If QoS Flow is mapped to one EPS bearer, ARP, GBR and MBR of the EPS Bearer is
set to the ARP, GFBR and MFBR of the corresponding QoS Flow, respectively. For
standardized 5QIs, the QCI is one to one mapped to the 5QI. For non-
standardized 5QIs, the PGW-C+SMF derives the QCI based on the 5QI and operator
policy.
A GBR QoS Flow is mapped 1 to 1 to a GBR dedicated EPS Bearer if an EBI has
been assigned. After mobility to EPS traffic flows corresponding to GBR QoS
Flow for which no EBI has been assigned will continue flowing on the default
EPS bearer if it does not have assigned TFT.
If multiple QoS Flows are mapped to one EPS bearer, the EPS bearer parameters
are set based on operator policy, e.g. EPS bearer QoS parameters are set
according to the highest QoS of all mapped QoS Flows.
After mobility to EPS traffic flows corresponding to Non-GBR QoS Flows for
which no EBI has been assigned will continue flowing on the default EPS Bearer
if it does not have assigned TFT.
###### ## Annex D (normative): UE Presence in Area of Interest
# D.1 Determination of UE presence in Area of Interest by AMF
If RRC Inactive state applies to NG-RAN and the AMF has requested NG-RAN
location reporting for the Area Of Interest and UE is in CM-CONNECTED state,
the AMF determines the UE presence of Area of Interest as the reported value
from the NG-RAN.
If RRC Inactive state applies to NG-RAN and the AMF has requested N2
Notification, the AMF determines the UE presence in Area Of Interest as
follows:
\- IN:
\- if the UE is inside the Area Of Interest service area and if the UE is in
CM-CONNECTED with RRC Connected state; or
NOTE 1: The above is valid e.g. under the condition that Area Of Interest
border coincides with NG-RAN node service area border or RAN Notification
Area.
\- if the UE is inside a Registration Area which is contained within the Area
Of Interest.
\- OUT:
\- if the UE is outside the Area Of Interest in CM-CONNECTED with RRC
Connected state; or
NOTE 2: The above is valid e.g. under the condition that Area Of Interest
border coincides with NG-RAN node service area border or RAN Notification
Area.
\- if UE is inside a Registration Area which does not contain any part of Area
Of Interest.
\- UNKNOWN:
if none of above conditions for IN or OUT is met.
Otherwise, AMF determines the UE presence of Area Of Interest as follows:
\- IN:
\- if the UE is inside the Area Of Interest service area and if the UE is in
CM-CONNECTED state; or
\- if the UE is inside a Registration Area which is contained within the Area
Of Interest.
\- OUT:
\- if the UE is outside the Area Of Interest in CM-CONNECTED; or
\- if UE is inside a Registration Area which does not contain any part of Area
Of Interest.
\- UNKNOWN:
if none of above conditions for IN or OUT is met.
# D.2 Determination of UE presence in Area of Interest by NG-RAN
If the AMF has requested for the Area of Interest, NG-RAN determines the UE
presence of Area Of Interest as follows:
\- IN:
\- if the UE is inside the Area Of Interest and the UE is in RRC Connected
state; or
\- if the UE is inside an RNA which is contained within the Area Of Interest.
\- OUT:
\- if the UE is outside the Area Of Interest in RRC Connected state; or
\- if UE is inside an RNA which does not contain any part of Area Of Interest.
\- UNKNOWN:
\- if none of above conditions for IN or OUT is met.
#
# Foreword
This Technical Specification has been produced by the 3^rd^ Generation
Partnership Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# 1 Scope
The present document contains the service description for the in-band
signalling protocol for the support of Tandem Free Operation of the Half Rate,
Full Rate, Enhanced Full Rate, Adaptive Multi Rate narrowband and Adaptive
Multi Rate Wide-Band speech codec types in GSM and GSM-evolved 3G systems.
# 2 References
The following documents contain provisions, which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or non‑specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
> [1] 3GPP TS 22.053: \"Digital cellular telecommunication system (Phase 2+);
> Tandem Free Operation (TFO); Service Description; Stage 1\".
>
> [2] 3GPP TS 23.053: \"Digital cellular telecommunication system (Phase 2+);
> Tandem Free Operation (TFO); Service Description; Stage 2\".
>
> [3] 3GPP TS 48.060: \"Digital cellular telecommunication system (Phase 2+);
> Inband control of remote transcoders and rate adaptors for full rate traffic
> channels\".
>
> [4] 3GPP TS 48.061: \"Digital cellular telecommunication system (Phase 2+);
> In-band Control of Remote Transcoders and Rate Adaptors for half rate
> traffic channels\".
>
> [5] 3GPP TS 46.010: \"Digital cellular telecommunications system (Phase 2+);
> Full rate speech transcoding\".
>
> [6] 3GPP TS 46.020: \"Digital cellular telecommunications system (Phase 2+);
> Half rate speech transcoding\".
>
> [7] 3GPP TS 46.060: \"Digital cellular telecommunications system (Phase 2+);
> Enhanced Full Rate (EFR) speech transcoding\".
>
> [8] 3GPP TS 26.090: \"Mandatory Speech Codec speech processing functions AMR
> Speech Codec - Transcoding functions\".
>
> [9] 3GPP TS 45.009: \"Digital cellular telecommunications system (Phase 2+);
> Link Adaptation\".
>
> [10] 3GPP TS 48.008: \"Digital cellular telecommunications system (Phase
> 2+); Mobile-services Switching Centre - Base Station System (MSC - BSS)
> interface; Layer 3 specification\".
>
> [11] 3GPP TS 48.054: \"Digital cellular telecommunication system (Phase 2+);
> Base Station Controller - Base Transceiver Station (BSC - BTS) interface;
> Layer 1 structure of physical circuits\".
>
> [12] 3GPP TS 48.058: \"Digital Cellular telecommunications system (Phase
> 2+), \"Base Station Controller - Base Transceiver Station (BSC \- BTS)
> interface; Layer 3 specification\".
>
> [13] ITU-T Recommendation G.711: \"Pulse code modulation (PCM) of voice
> frequencies\".
>
> [14] 3GPP TS 44.018: \"Mobile radio interface layer 3 specification; Radio
> Resource Control Protocol\".
>
> [15] 3GPP TS 23.153: \"Out of Band Transcoder Control; Stage 2\".
>
> [16] 3GPP TS 29.232: \"Media Gateway Controller (MGC) -- Media Gateway (MGW)
> Interface;\ Stage 3\"
>
> [17] 3GPP TS 25.415: \"UTRAN Iu interface User plane protocols\"
>
> [18] 3GPP TS 26.171: AMR-WB Speech Codec; General Description
>
> [19] 3GPP TS 26.190: AMR-WB Speech Codec; Transcoding Functions
# 3 Definitions and abbreviations
## 3.1 Definitions
For the purposes of the present document, the following terms and definitions
apply:
**Transcoder:** device that converts the encoding of information from one
particular scheme to a different one
NOTE 1: A **Speech Transcoder** in a GSM or 3G system converts the speech
encoding usually from G.711 [13] to a format optimised for the transmission
over the Air Interface. The new format relates to a specific **speech Codec.**
**Tandem Free Operation:** call configuration where a transcoder device is
physically present in the signal path, but the transcoding functions are
bypassed
NOTE 2: The transcoding device may perform control and protocol conversion
functions.
**Transcoder Free Operation:** call configuration where no transcoder device
is physically present and hence no control or conversion or other functions
associated with it are activated
**Compressed Speech Samples: s** peech samples coded according to one of the
Speech Codec Types supported by the TFO specification
**PCM Samples: s** peech samples coded according to ITU-T Recommendation G.711
A-Law or μ-Law at 64 kbit/s
**Speech Codec Type:** speech Codec among those supported by this TFO
specification: GSM_FR, GSM_HR, GSM_EFR, FR_AMR, HR_AMR, OHR_AMR, UMTS_AMR,
UMTS_AMR_2, FR_AMR-WB, UMTS_AMR-WB, OFR_AMR-WB, OHR_AMR-WB
**AMR Speech Codec Type:** one of the following Speech Codec Types: FR_AMR,
HR_AMR, UMTS_AMR, UMTS_AMR_2, FR_AMR-WB, UMTS_AMR-WB, OFR_AMR-WB, OHR_AMR-WB
**AMR-NB Speech Codec Type:** one of the following Speech Codec Types: FR_AMR,
HR_AMR, UMTS_AMR, UMTS_AMR_2, OHR_AMR.
**AMR-WB speech Codec Type:** one of the following Speech Codec Types:
UMTS_AMR-WB, FR_AMR-WB, OFR_AMR-WB, OHR_AMR-WB
**Non-AMR Speech Codec Type: o** ne of the following Speech Codec Types:
GSM_FR, GSM_HR, or GSM_EFR
**Speech Codec Configuration: s** et of parameters defining the operational
conditions of a **Speech Codec Type**
EXAMPLE: The Speech Codec Configuration of an AMR Speech Codec Type defines
the ACS, the SCS...
**TRAU Frame** or **TRAU Speech Frame:** refer to a Speech Frame carried over
the Abis/Ater Interface in a GSM network
**TFO Frame** or **TFO Speech Frame:** refer to the Speech Frames exchanged
between the Transcoders when Tandem Free Operation is active
**Abis/Ater:** applies to a GSM network where either the GSM Abis or Ater
interfaces are used, depending on the location of the Transcoder and Rate
Adaptor Units
Other definitions are contained in [1] and [3].
## 3.2 Abbreviations
For the purposes of the present document, the following abbreviations apply:
> ACS Active Codec Set
>
> ACT Active Codec Type
>
> AMR Adaptive Multi-Rate
>
> ATVN AMR-TFO Version Number
>
> BSC Base Station Controller
>
> BSS Base Station Sub-system
>
> BTS Base Transceiver Station
>
> CACS Common Active Codec Set
>
> CSCS Common Supported Codec Set
>
> DACS Distant Active Codec Set
>
> DSCS Distant Supported Codec Set
>
> EFR Enhanced Full Rate
>
> FQI Frame Quality Index
>
> FR Full Rate
>
> HOM Hand-Over-Mode
>
> HR Half Rate
>
> IACS Immediate Active Codec Set
>
> ICM Initial Codec Mode
>
> IPE In Path Equipment
>
> LACS Local Active Codec Set
>
> LSB Least Significant Bit
>
> LSCS Local Supported Codec Set
>
> MACS Maximum number of Codecs Modes in the Active Codec Set
>
> MGw Media Gateway
>
> MS Mobile Station
>
> MSB Most Significant Bit
>
> MSC Mobile Switching Centre
>
> NB Narrow-Band
>
> OACS Optimised Active Codec Set
>
> OD Optimal or Distant Configuration requested
>
> OM Optimisation Mode supported
>
> PCM sample 8-bit value representing the A_Law or μ_Law coded sample of a
> speech or audio signal; sometimes used to indicate the time interval between
> two PCM samples (125μs).
>
> PCM Pulse_Coded_Modulation
>
> PCM_Alaw_Idle PCM sample with value 0x54
>
> PCM_Alaw_Idle PCM sample with value 0x54.
>
> PCM_Alaw_Silence PCM sample with value 0xD5
>
> PCM_Alaw_Silence PCM sample with value 0xD5.
>
> PCM_Idle either PCM_Alaw_Idle, or PCM_μLaw_Idle, dependent on application
>
> PCM_Silence either PCM_Alaw_Silence, or PCM_μLaw_Silence, dependent on
> application
>
> PCM_μLaw_Idle PCM sample with value 0x00
>
> PCM_μLaw_Idle PCM sample with value 0x00.
>
> PCM_μLaw_Silence PCM sample with value 0xFF
>
> PCM_μLaw_Silence PCM sample with value 0xFF.
>
> PDU Packet Data Unit
>
> PLMN Public Land Mobile Network
>
> RAN Radio Access Network
>
> RATSCCH Robust AMR Traffic Synchronised Control Channel
>
> RIF Request Indication Flag
>
> RNC Radio Network Controller
>
> SCR Source Controlled Rate
>
> SCS Supported Codec Set
>
> T_Bits Time Alignment Bits
>
> Tbfh Time delay Bad Frame Handling
>
> TC Transcoder
>
> TCME TFO Circuit Multiplication Equipment
>
> TFO Tandem Free Operation
>
> TFO Tandem Free Operation
>
> TFO_ACK TFO Acknowledgement Message
>
> TFO_DUP TFO (Half) Duplex Mode Message
>
> TFO_DUP TFO (Half) Duplex Mode Message
>
> TFO_FILL TFO Fill Message
>
> TFO_NORMAL TFO Normal Mode Message
>
> TFO_REQ TFO Request Message
>
> TFO_SYL TFO Sync Lost Message
>
> TFO_TRANS TFO Transparent Mode Message
>
> TRAU Transcoder and Rate Adaptor Unit
>
> TrFO Transcoder Free Operation
>
> TSM TFO Setup Mode
>
> Tultfo Time delay UpLink TFO
>
> UE User Equipment
>
> WB WideBand
# 4 General Description
## 4.1 Background Information
Tandem Free Operation (TFO) is intended to avoid the traditional double speech
encoding/decoding in MS to MS (GSM), MS to UE (GSM/3G) or UE to UE (3G) call
configurations. In the following paragraphs the term \"MS\" is used for MS and
UE, the term UE only if a 3G terminal is explicitly addressed.
In a normal MS-MS call configuration the Speech Signal is first encoded in the
originating MS, sent over the Air Interface, converted to A-law or μ-law ITU-T
Recommendation G.711 [13] in the local transcoder, carried over the fixed
network, transcoded again in the distant transcoder, sent over the distant Air
Interface and finally decoded in the terminating MS (see Figure 4.1-1). In
this configuration, the two speech codecs (coder/decoder pairs) are in
\"Tandem Operation\". The key inconvenience of a tandem configuration is the
speech quality degradation introduced by the double transcoding. This
degradation is usually more noticeable when the speech codecs are operating at
low rates.
{width="6.694444444444445in" height="1.2930555555555556in"}
Figure 4.1-1: Typical Speech Codec Tandem Operation
When the originating and terminating connections are using the same speech
codec, it is possible to transmit transparently the speech frames received
from the originating MS to the terminating MS without activating the
transcoding functions in the originating and terminating networks (see figure
4.1-2). In this configuration, \"Tandem Free Operation\" is on-going.
{width="6.694444444444445in" height="1.323611111111111in"}
Figure 4.1-2: Tandem Free Operation of Speech Codec
The key advantages of Tandem Free Operation are:
\- Improvement in speech quality by avoiding the double transcoding in the
network;
\- Possible savings on the inter-PLMN transmission links, which are carrying
compressed speech compatible with a 32 kbit/s or 16 kbit/s or 8 kbit/s sub-
multiplexing scheme, including packet switched transmission;
\- Possible savings in processing power in the network equipment since the
transcoding functions in the Transcoder Units are bypassed;
\- Possible reduction in the end-to-end transmission delay.
The major constraint of Tandem Free Operation is that the inter-PLMN
transmission links must be transparent to the compressed speech frames. This
means that any device located in the transmission path (IPE: in path
equipment) between the originating and the terminating transcoders must be
disabled, switched-off, or made aware of the TFO situation to keep unaltered
any compressed speech frame sent over the transmission path. Examples of such
devices are listed in annex B.
The TFO Protocol defined in the present document provides the following
services:
\- Establishment of a transparent path between transcoders;
\- Provision of an In-band signalling link between transcoders;
\- Exchange of information on the active speech codec type and supported
speech codec types at both ends of the call configuration;
\- Codec Mismatch Resolution;
\- Establishment and Maintenance of Tandem Free Operation when identical codec
types are used at both ends of the call configuration;
\- Fast and seamless fall back to Tandem Operation in case of necessary or
unexpected TFO interruption (i.e. activation of supplementary services);
\- Support for cost efficient transmission.
The present document defines Tandem Free Operation for the different Speech
Codec Types used in GSM and GSM‑evolved 3G systems. This includes the GSM_FR,
GSM_HR, GSM_EFR and FR_AMR, HR_AMR, OHR_AMR, UMTS_AMR, UMTS_AMR_2, FR_AMR-WB,
UMTS_AMR-WB, OFR_AMR-WB, OHR_AMR-WB codec types. However, the procedures used
to establish TFO are considered system independent and could be extended to
call configurations involving other systems like ISDN phones, speech servers,
IP Multimedia or other wireless systems.
For non-AMR Speech Codec Types (i.e. GSM_FR, GSM_EFR and GSM_HR), Tandem Free
Operation is fully compatible with the installed equipment base. The feature
is fully supported by the Transcoder Units. The additional processing
complexity is small compared to the encoding/decoding functions. Other network
elements are not affected and possibly not aware of the establishment of
Tandem Free Operation.
For the support of AMR Tandem Free Operation in GSM, the BTS and possibly the
BSC may be involved in addition to the TRAU.
The resolution of a possible codec mismatch is defined as an optional feature.
A codec mismatch occurs when incompatible speech codecs are used at both ends
of the call configuration at call set-up. The resolution consists in finding
an optimal speech codec on which TFO may be established. For that purpose,
other elements in the Radio Access Network (BSS in GSM or RNC in 3G) might be
involved.
## 4.2 Principle of TFO Operation
### 4.2.1 Principle for TFO Operation for Narrow-Band speech codec types
Tandem Free Operation is activated and controlled by the Transcoder Units
after the completion of the call set-up phase at both ends of an MS-MS, MS-UE,
or UE-UE call configuration. The TFO protocol is fully handled and terminated
in the Transcoder Units. For this reason, the Transcoder Units cannot be
bypassed in Tandem Free Operation. This is the key difference with the feature
called Transcoder Free Operation (TrFO) defined in **3GPP** TS 23.153.
In return, the Transcoder Units continuously monitor the normal Tandem Free
Operation and can terminate TFO as soon as necessary with limited impact on
the speech quality.
Before TFO is activated, the Transcoder Units exchange conventional 64 kbit/s
PCM speech samples coded according to the ITU-T Recommendation G.711 [13]
A-Law or μ-Law. The Transcoders can also exchange TFO messages by stealing the
least significant bit in every 16^th^ speech sample (see annex A for the
specification of the TFO message transmission rule and clauses 6 to 8 for the
description of the TFO procedures and messages content).
If compatible Speech Codec Types and Configurations are used at both ends of
the MS-MS, MS-UE, or UE-UE call configuration, the Transcoders automatically
activate TFO. If incompatible Speech Codec Types and/or Configurations are
used at both ends, then a codec mismatch situation exists. TFO cannot be
activated until the codec mismatch is resolved. This capability is an optional
feature involving other network elements of the Radio Access Network. The
rules for finding a common codec type and solve the codec mismatch are defined
in clauses 11 and 12.
Once TFO is activated, the Transcoder Units exchange TFO Frames carrying
compressed speech and in-band signalling, which structure is derived from the
GSM TRAU Frames defined in the **3GPP** TS 48.060 and 48.061 (see clause 5).
The exchange of TFO messages is still possible while TFO is active. In this
case, the stealing process will result in embedding a message in the
synchronisation pattern of the TFO Frame.
When TFO is activated between two end connections using the GSM_HR speech
codec, the TFO Frames are carried over 8 kbit/s channels mapped onto the least
significant bit (LSB) of the 64 kbit/s PCM speech samples.
When TFO is activated between two end connections using the GSM_FR or GSM_EFR
speech codecs, the TFO Frames are carried over 16 kbit/s channels mapped onto
the two least significant bits of the 64 kbit/s PCM speech samples.
When TFO is activated between two end connections using the AMR speech codec,
the TFO Frames are carried over 8 or 16 kbit/s channels mapped onto the least
or two least significant bits of the 64 kbit/s PCM speech samples. The format
depends on the codec configuration (Optimized Active Codec Set).
To facilitate a seamless TFO interruption, the six or seven MSB of the PCM
speech samples (not compressed) are transmitted to the far end unchanged.
Like GSM TRAU Frames, the TFO Frames have a fixed size (and duration) of:
\- 160 bits (20 ms) for the 8 kbit/s format;
\- 320 bits (20 ms) for the 16 kbit/s format.
Figure 4.2-1 provides a reference model for the functional entities handling
Tandem Free Operation. The TFO Protocol is fully described in clauses 9 (State
Machine) and 10 (Detailed Protocol).
{width="6.6930555555555555in" height="3.1125in"}
Figure 4.2.1-1: Functional Entities Handling Tandem Free Operation
The same TFO protocol and Frame Format is used irrespective of the PLMN types
at both ends of the call configuration. Figure 4.2-2 shows a normal TFO
configuration involving the same or two different GSM networks.
{width="6.6930555555555555in" height="2.171527777777778in"}
Figure 4.2.1-2: TFO Configuration between GSM Networks
Figure 4.2-3 presents a TFO configuration involving two GSM-evolved 3G
Networks. Note that the same protocol and Frame Structure are also used
irrespective of the type of Transmission Network connecting the two 3G
networks (ATM or STM).
{width="6.795833333333333in" height="2.38125in"}
Figure 4.2.1-3: TFO Configuration between 3G Networks
Finally, figure 4.2-4 presents a TFO configuration involving two different
network types (GSM and 3G). Similar configurations could be derived with any
network supporting a TFO protocol compatible with the present document.
{width="6.59375in" height="2.3965277777777776in"}
Figure 4.2.1-4: TFO Configuration between a GSM and a 3G Network
### 4.2.2 Principle for TFO Operation for Wide-Band speech codec types (i.e.
AMR-WB)
In case of AMR-WB the TRAU/TC performs in uplink direction the wideband
decoding and a successive lowpass-filtering, downsampling to 8kHz sampling
rate and PCM (G.711) encoding, before its sends the narrowband version of the
speech signal towards its destination. This downsampled speech signal in PCM
(G.711) representation allows interworking with the narrowband world (PSTN
etc.). If a 64kbit/s channel is used, then a transcoded wideband signal (7 kHz
speech bandwidth and 16kHz sampling rate) would anyway not fit into it. An
efficient way to transport the wideband signal via such a channel is to use
TFO (or TrFO) which delivers the compressed (encoded) speech. The encoded
speech has a bandwidth significantly lower than 64kbit/s. In TFO_State
OPERATION the TRAU/TC sends the AMR-WB TFO Frames within the LSBs of this PCM
signal.
In the other, downlink direction the TRAU/TC performs G.711 decoding,
upsampling to 16 kHz sampling rate, lowpass- filtering and wideband encoding
before it sends the AMR-WB parameters down to the A/Iu interface. In TFO_State
OPERATION the TRAU sends the AMR-WB parameters as received via the TFO Frames
downlink.
A listener on the A/Iu interface will always hear the narrowband version of
the speech conversation, while both ends send and receive the wideband
version.
The basic principle for TFO operation for WB speec codec tpyes is the same as
for narrow-band speech codec types (see section before). The following items
must additionally be considered:
\- A new size of 640 bits for the 32 kbit/s TFO Frames format is needed in
case the highest AMR-WB modes shall be used (the related TRAU format is
defined in 48.060).
\- The scenario in figure 4.2.2-1 shows the situation when AMR-WB TFO has not
yet been established while the call started with a narrowband codec. This is a
likely starting scenario, because it it not desirable to occupy radio
ressources unnecessarily with wide-band signals, until TFO is operational.
\- Figure 4.2.2-2 describes the situation after AMR-WB TFO establishment
\- Because of the higher speech signal bandwidth (up to almost 24 kbit/s for
AMR-WB) up to the four LSBs must be stolen by TFO franes.
\- In case of TFO interruption, the remaining MSBs of the PCM speech samples
(not compressed) might not only be less than for narrowband TFO, the
transcoded bits carry a different kind of signal: The downsampled signal has
narrowband properties (as depicted in figure 4.2.2-3). Because of the
significant difference of the narrowband speech signal\'s impression (possibly
even distorted by the stealing of four LSBs) to the wideband signal\'s
quality, AMR-WB TFO interruptions should be avoided as best as possible.
{width="5.997222222222222in" height="0.9479166666666666in"}
Figure 4.2.2-1: Pre-TFO scenario for AMR-WB (for subsequent codec
optimisation)
{width="5.999305555555556in" height="1.3229166666666667in"}
Figure 4.2.2-2: AMR-WB with TFO Ongoing
{width="5.997916666666667in" height="1.1034722222222222in"}
Figure 4.2.2-3: AMR-WB after TFO interruption
## 4.3 TFO Standard Version Handling
In TFO Specifications before REL-4 no TFO version handling is defined.
In TFO Specifications of REL-4 an \"AMR TFO version number\" is defined in the
Ver (Version number) field of the AMR_ACS and AMR_SCS Extension Blocks (see
clause 7) and the ATVN field in AMR Configuration frames (see Annex C). Only
one REL-4 AMR TFO version is defined: version \"0\".
From REL-5 onwards the \"TFO Version number\" contained in the \"TFO Version\"
extension block (section 7) and in \"Generic Configuration Frames\" (Annex H)
shall reflect the Version and Subversion of the corresponding TS 28.062 (first
and second digit of the TS version number, see foreword). The AMR TFO version
number (Ver, AVTN, as in REL-4) shall be treated as \"undefined\" in case the
TFO Version Number (as in REL-5 and onwards) is indicated in the TFO Messages.
The current TFO Version supports the GSM_FR, GSM_HR, GSM_EFR ,five AMR (Narrow
Band) speech codec types (FR_AMR, HR_AMR, UMTS_AMR, UMTS_AMR_2, OHR_AMR: AMR-
NB family) and four AMR Wide Band speech codec types (FR_AMR-WB, UMTS_AMR-WB,
OFR_AMR-WB, OHR_AMR-WB: AMR-WB family).
The smallest defined TFO Version number is 0.0. It stands for all TFO Versions
before 5.3. All numbers between 0.0 and 5.3 are reserved for future use. If
the Local and Distant version numbers differ, the smallest version number
shall have precedence and shall be applied on both sides. The following
features (table 4.3-1) are optional or mandatory for the different Codec
Types, depending on the applicable version number:
Table 4.3-1: TFO Version Handling
+----------------+----------------+----------------+----------------+ | **Feature→** \ | **TFO |** Immediate\ | **Generic | |** Codec | Version**| Codec Type | Configuration | | Type↓** | | Optimisation**| Frames** | +----------------+----------------+----------------+----------------+ | GSM_FR\ | **Optional.\ |** Mandatory,**| If the TFO | | GSM_HR\ |** The TFO | if\ | Version is | | GSM_EFR | Version | TFO Version is | lower than | | | extension | 5.3 or higher. | 5.3\ | | | block need not | | then Generic | | | to be sent.\ | | Configuration | | | If not | | Frames shall | | | contained in | | [no | | | TFO Messages,\ | | t]{.underline} | | | or is lower | | be used. Only | | | than 5.3,\ | | TFO_REQ_L | | | then Pre-REL-5 | | and | | | handling\ | | (TFO_ACK_L) | | | shall apply | | shall be used. | | | | | | | | | | If the TFO | | | | | Version is 5.3 | | | | | or higher, | | | | | then\ | | | | | Generic | | | | | Configuration | | | | | Frames shall | | | | | be used. | | | | | TFO_REQ_L | | | | | and | | | | | TFO_ACK_L | | | | | shall | | | | | [no | | | | | t]{.underline} | | | | | be used | | | | | embedded into | | | | | TFO Frames. | +----------------+----------------+----------------+----------------+ | FR_AMR\ | **Optional.\ |** Mandatory,**| If the TFO | | HR_AMR\ |** The TFO | if\ | Version is | | UMTS_AMR\ | Version | TFO Version is | lower than | | UMTS_AMR2\ | extension | 5.3 or | 5.3, then | | OHR_AMR | block need not | higher**.** | Generic | | | to be sent.\ | | Confi | | | If not | | gurationFrames | | | contained in | | shall | | | TFO Messages,\ | | [no | | | or is lower | | t]{.underline} | | | than 5.3,\ | | be used. If | | | then Pre-REL-5 | | the TFO | | | handling\ | | Version is 5.3 | | | shall apply | | or higher, | | | | | then\ | | | | | Generic | | | | | Configuration | | | | | Frames shall | | | | | be used. The | | | | | parameter | | | | | field in REL-4 | | | | | AMR | | | | | Configuration | | | | | frames shall | | | | | be treated as | | | | | undefined. | | | | | TFO_REQ_L | | | | | and | | | | | TFO_ACK_L | | | | | shall | | | | | [no | | | | | t]{.underline} | | | | | be used | | | | | embedded into | | | | | TFO Frames. | +----------------+----------------+----------------+----------------+ | FR_AMR-WB\ | **Mandatory.\ |** Mandatory.**| Generic | | UMTS_AMR-WB\ |** The TFO | | Configuration | | OFR_AMR-WB\ | Version | | Frames shall | | OHR_AMR-WB | extension | | be used. | | | block shall | | TFO_REQ_L | | | always be | | and | | | sent. | | TFO_ACK_L | | | | | shall | | | | | [no | | | | | t]{.underline} | | | | | be used | | | | | embedded into | | | | | TFO Frames. | +----------------+----------------+----------------+----------------+
## 4.4 Document Content
In the following, clause 5 defines the structure of the TFO Frames exchanged
between the Transcoder Units. The TFO Frames carry the compressed speech
(payload) and some control bits for the inter-transcoder in-band signalling.
Clause 6 introduces the elementary procedures used for the establishment and
maintenance of Tandem Free Operation. Clause 7 defines the detailed content of
the TFO messages associated with the TFO procedures. The TFO Message Structure
follows the generic format defined in Annex A. Clause 8 defines how the TFO
messages are mapped onto the TFO Frames. Clause 9 defines the TFO State
Machine. Clause 10 contains the detailed TFO protocol. Clause 11 and 12
specify the TFO Decision algorithm and the optional Codec Mismatch Resolution.
Annex B is an informative annex defining the expected behaviour of In-Path
Equipment (IPE) for compatibility with Tandem Free Operation.
Annex C and Annex D define specific TFO processes for GSM and 3G systems.
Annex E contains a reference implementation for the TFO decision algorithm
(C-code) described in clause 11 and 12.
Annex F is an informative Implementer\'s Guide containing recommendations in
the implementation and introduction of AMR TFO.
Annex G provides basic Message Flow sequences for the TFO protocol.
# 5 TFO Frame Structure
## 5.1 General
TFO Frame formats are defined for the following Speech Codec Types:
\- GSM Full Rate (GSM_FR);
\- GSM Half Rate (GSM_HR);
\- GSM Enhanced Full Rate (GSM_EFR);
\- Adaptive Multi Rate Family (FR_AMR, HR_AMR,UMTS_AMR, UMTS_AMR_2, OHR_AMR);
\- WB Adaptive Multi Rate Family (UMTS_AMR-WB, FR_AMR-WB, OFR_AMR-WB, OHR_AMR-
WB)
TFO Frame formats for 8 kbit/s, 16kbit/s and 32 kbit/s sub-multiplexing are
defined in the following clauses.
## 5.2 TFO Frames for 16 kbit/s sub-multiplexing
### 5.2.1 TFO Frames for GSM Full Rate and GSM Enhanced Full Rate
The TFO Frames for GSM_FR and GSM_EFR are derived from the **uplink** TRAU
Frames as defined in the 3GPP TS 48.060. Table 5.2.1-1 defines the coding of
the Control Bits for these TFO Frames.
Table 5.2.1-1: Control Bits in TFO Frames for GSM_FR and GSM_EFR
+-------------+----------------+-------------------------------------+ | Control Bit | Description | Comment | +-------------+----------------+-------------------------------------+ | C1 - C4 | **Frame Type** | copied from uplink TRAU Frames | | | | | | 0.0.0.1 | GSM_FR | All other code words are reserved. | | | | | | 1.1.0.1 | GSM_EFR | | +-------------+----------------+-------------------------------------+ | C5 | **EMBED** | Indicates the presence of an | | | | embedded TFO Message | +-------------+----------------+-------------------------------------+ | C6 - C11 | Spare | (is Time Alignment in TRAU Frame)\ | | | | set to Spare by TRAU | +-------------+----------------+-------------------------------------+ | C12 | **BFI** | Copied from the uplink TRAU Frame | +-------------+----------------+-------------------------------------+ | C13 - C14 | **SID** | Copied from the uplink TRAU Frame | +-------------+----------------+-------------------------------------+ | C15 | **TAF** | Copied from the uplink TRAU Frame | +-------------+----------------+-------------------------------------+ | C16 | Spare | set to Spare by TRAU | +-------------+----------------+-------------------------------------+ | C17 | **DTXd** | Copied from the uplink TRAU Frame | +-------------+----------------+-------------------------------------+ | C18 - C21 | Spare | set to Spare by TRAU | +-------------+----------------+-------------------------------------+
Any spare control bit shall be coded as binary \"1\". They are reserved for
future use and may change.
The **Synchronisation Pattern** is similar to the Synchronisation Pattern in
the 3GPP TS 48.060, with some exceptions depending on the value of the EMBED
Bit:
EMBED equal \"0\": the Synchronisation Pattern is exactly as described in the
3GPP TS 48.060;\ EMBED equal \"1\": the Synchronisation Pattern contains an
embedded TFO Message.
For the coding of the **Data Bits** see 3GPP TS 48.060.
For the coding of the **Time Alignment Bits** (T_Bits, T1.. T4) see 3GPP TS
48.060. The T_Bits normally correspond to the T_Bits received in the up-link
TRAU Frame.
### 5.2.2 TFO Frames for the Adaptive Multi Rate Family
The TFO Frames for any narrow-band AMR Codec Type use always 16 kbit/s sub-
multiplexing on the A-Interface, regardless which sub-multiplexing is used on
the Abis-Interfaces. Two different AMR_TFO Frame formats exist. One, called
AMR_TFO_16k, is based on the TRAU Frame format for 16 kBit/s sub-multiplexing,
as described in 3GPP TS 48.060. The other one, called AMR_TFO_8+8k, is based
on the TRAU Frame format for 8 kbit/s sub-multiplexing, as described in 3GPP
TS 48.061, with an added synchronisation pattern, to improve transmission and
synchronisation quality on the A-Interface.
Optionally the TRAU frame format AMR_TRAU_8+8k may be used on the Abis-
Interface for 16 kBit/s sub-multiplexing, when a TFO connection with HR_AMR on
the distant side is established.
Additionally, a frame format using 16 kbit/s sub-multiplexing is defined for
wide band AMR codec types, called AMR_WB_TFO_16k. It is based on the TRAU
frame format for 16 kBit/s sub-multiplexing, as described in 3GPP TS 48.060.
#### 5.2.2.1 TFO Frame Format AMR_TFO_16k
TFO Frames with format AMR_TFO_16k are derived from the TRAU Frames for
Adaptive Multi Rate as defined in the 3GPP TS 48.060. The AMR_TFO_16k Frame
structure is illustrated in Figure 5.2.2.1-1, using the same notations as in
3GPP TS 48.060. Table 5.2.2-1 defines the coding of the Control Bits for AMR
TFO Frames. Note that additional TFO Configuration Parameters may be carried
by the Data Bits of the TFO Frames, as defined in annex C.
* * *
                                  **Bit number**
**Octet no.** **1** **2** **3** **4** **5** **6** **7** **8** **0** 0 0 0 0 0
0 0 0 **1** 0 0 0 0 0 0 0 0 **2** 1 C1 C2 C3 C4 C5 C6 C7 **3** C8 C9 C10 C11
C12 C13 C14 C15 **4** 1 C16 C17 C18 C19 C20 C21 C22 **5** C23 C24 C25 D1 D2 D3
D4 D5 **6** 1 D6 D7 D8 D9 D10 D11 D12 **7** D13 D14 D15 D16 D17 D18 D19 D20
**8..36**  
**37** D238 D239 D240 D241 D242 D243 D244 D245 **38** 1 D246 D247 D248 D249
D250 D251 D252 **39** D253 D254 D255 D256 T1 T2 T3 T4
* * *
Figure 5.2.2.1-1: Structure of AMR_TFO_16k Frames
Table 5.2.2.1-2: Coding of the Control Bits for AMR_TFO_16k Frames
+-------------+-------------+-------------+-------------+-------------+ | Control | Description | Comment | | | | Bits | | | | | +-------------+-------------+-------------+-------------+-------------+ | | **FR_AMR, | ** |** FR_AMR, | * | | | HR_AMR, | UMTS_AMR**| HR_AMR, | *UMTS_AMR, | | | UM | | OHR_AMR** | UMT | | | TS_AMR_2, | | | S_AMR_2**| | | OHR_AMR** | | | | +-------------+-------------+-------------+-------------+-------------+ | C1 - C4 | ** | The coding | | | | | Frame_Type | is | | | | (0.0.0.1) | / Codec | different | | | | | Type**| from the | | | | 0.0.1.1 | | coding in | | | | | ** | TFO | | | | 0.1.0.0 | (GSM_FR)** | Messages. | | | | | | It is also | | | | 0.1.0.1 | **FR_AMR** | not | | | | | | identical | | | | 0.1.1.0 | **HR_AMR** | to the | | | | | | coding on | | | | (1.0.0.1) | ** | Abis/Ater. | | | | | UMTS_AMR**| The TRAU | | | | (1.0.1.0) | | shall | | | | |** UMT | translate | | | | 1.0.1.1 | S_AMR_2**| the coding | | | | | | between | | | | (1.1.0.0) |**(FR | TRAU and | | | | | _AMR-WB)**| TFO Frames. | | | | (0.0.1.0) | | | | | | |**(UMTS | Codec Types | | | | (1.1.0.1) | _AMR-WB)**| in | | | | | | (brackets) | | | | | * | are not | | | | | *OHR_AMR** | supported | | | | | | by this TFO | | | | | **(OFR | Frame | | | | | _AMR-WB)** | format. | | | | | | They are | | | | | **(OHR | listed to | | | | | _AMR-WB)** | show their | | | | | | coding for | | | | | **( | c | | | | | GSM_EFR)** | onvenience. | | | +-------------+-------------+-------------+-------------+-------------+ | C5 | **EMBED** | Indicates | | | | | | the | | | | 0 | No TFO | presence of | | | | | Message | an embedded | | | | 1 | embedded | TFO | | | | | | Message. | | | | | A TFO | Set by the | | | | | Message is | TRAU. | | | | | embedded | | | | +-------------+-------------+-------------+-------------+-------------+ | C6 -- C8 | Set to | **Codec | In GSM TRAU | Coding as | | | \" | Mode | Frames, | defined in | | | 1.1.1\"(see | Request | these bits | 3GPP TS | | | note)^\ | (CMR)**) | carry part | 48.060 | | | ^ | | of the Time | | | | | | Alignment. | | | | | | They are | | | | | | set to | | | | | | 1.1.1 by | | | | | | the TRAU. | | +-------------+-------------+-------------+-------------+-------------+ | C9 - C11 | **TFO and | In GSM TRAU | | | | | Han | Frames | | | | 0.0.0 | dover_Noti | these bits | | | | | fications** | are part of | | | | 0.0.1 | | the Time | | | | | **TFO_On** | Alignment | | | | 0.1.0 | | field.\ | | | | | ** | These bits | | | | 0.1.1 | TFO_Soon**| are copied | | | | | | from TRAU | | | | 1.0.0 | * | frames to | | | | | *TFO_Off** | TFO Frames | | | | 1.0.1 | | and vice | | | | | **Hando | versa.\ | | | | 1.1.0 | ver_Soon** | TFO_On is | | | | | | the default | | | | 1.1.1 | **Handover\ | value in | | | | | _Complete** | TFO Frames. | | | | | | | | | | | ** | | | | | | undefined**| | | | | | | | | | | | ** | | | | | | undefined** | | | | | | | | | | | | ** | | | | | | undefined**| | | | +-------------+-------------+-------------+-------------+-------------+ | C12 |** RIF | set to 0 | Copied from | | | | (Request or | | the uplink | | | | Indication | | TRAU Frame | | | | Flag)**| | in GSM | | | | | | | | | | | | Generated | | | | | | by the | | | | | | Transcoder | | | | | | in 3G | | | | | | systems for | | | | | | FR_AMR and | | | | | | HR_AMR: | | | | | | The changes | | | | | | of the | | | | | | uplink | | | | | | Codec Mode, | | | | | | as received | | | | | | via the Iu | | | | | | Frames, are | | | | | | monitored. | | | | | | Whenever | | | | | | the Codec | | | | | | Mode | | | | | | changes, | | | | | | the RIF bit | | | | | | is set to | | | | | | \"0\". The | | | | | | next frames | | | | | | are then | | | | | | al | | | | | | ternatingly | | | | | | marked with | | | | | | RIF = | | | | | | \"1\", | | | | | | \"0\", | | | | | | \"1\" and | | | | | | so on. | | +-------------+-------------+-------------+-------------+-------------+ | C13 | Spare (set | C13 is | | | | | to 1) | spare in UL | | | | | | TRAU | | | | | | frames. | | | +-------------+-------------+-------------+-------------+-------------+ | C14 -- C16 |** Con | Coding | | | | | fig_Prot**| defined in | | | | | | Annex C. | | | +-------------+-------------+-------------+-------------+-------------+ | C17 C18 |** Mess No**| Coding | | | | | | defined in | | | | | | Annex C. | | | +-------------+-------------+-------------+-------------+-------------+ | C19 | DTXd (see | Copied from | | | | | note) | uplink TRAU | | | | | | Frame in | | | | | | GSM | | | +-------------+-------------+-------------+-------------+-------------+ | C20 |** TFOE**| Copied from | | | | | | the uplink | | | | 0 | TFO Disable | TRAU Frame | | | | | | in GSM | | | | 1 | TFO Enable | | | | | | | Generated | | | | | | by the | | | | | | Transcoder | | | | | | in 3G | | | | | | systems | | | | | | with the | | | | | | same coding | | | | | | as in the | | | | | | 3GPP TS | | | | | | 48.060 | | | +-------------+-------------+-------------+-------------+-------------+ | C21 -- C22 |** F | Copied from | | | | | rame_Class | the uplink | | | | 1 1 | ification**| TRAU Frame | | | | | | in GSM | | | | 1 0 | \"Spe | | | | | | ech_Good\" | Derived | | | | 0 1 | | from the | | | | | \"Speech\ | Frame | | | | 0 0 | _Degraded\" | Quality | | | | | | Indicator | | | | | \"Sp | and Frame | | | | | eech_Bad\" | Type for 3G | | | | | | systems | | | | | \"N | (see Table | | | | | o_Speech\" | 5.2.2.1-3 | | | | | | below) | | | +-------------+-------------+-------------+-------------+-------------+ | C23 -- C25 |**(see 3GPP | **Codec | Carry CMI | Coding as | | | TS | Mode | or CMR | defined in | | | 48.060)** | Indication | depending | **3GPP** | | | | (CMI)**; | of the |** TS | | | CMI (if RIF | (RIF ==0 is | value of | 48.060**| | | == 0) or\ | always the | RIF, if the | | | | CMR (if RIF | case in | Frame | | | | == 1) or\ | UMTS_AMR) | Cla | | | | 0.0.0 (if | | ssification | | | | Frame_Cla | | bits are | | | | ssification | | different | | | | == 0.0) | | from \"0 | | | | | | 0\" | | | | | | (N | | | | | | o_Speech), | | | | | | and set to | | | | | | \"000\" | | | | | | otherwise. | | | | | | | | | | | | Copied from | | | | | | the uplink | | | | | | TRAU Frame | | | | | | in GSM | | | | | | | | | | | | Derived | | | | | | from the | | | | | | Frame | | | | | | Quality | | | | | | Indicator | | | | | | and Frame | | | | | | Type for 3G | | | | | | systems | | | | | | (see Table | | | | | | 5.2.2.1-3) | | +-------------+-------------+-------------+-------------+-------------+ | T1 - T4 |** Time | In GSM | | | | | Alignment | copied from | | | | | Bits** | the uplink | | | | | | TRAU Frame\ | | | | | | In 3G, | | | | | | generated | | | | | | by the TC | | | | | | (UMTS) | | | | | | based on Iu | | | | | | Frame | | | | | | arrival | | | | | | time(s) | | | +-------------+-------------+-------------+-------------+-------------+
**NOTE 0:** Any spare control bits shall be coded as binary \"1\". They are
reserved for future use and may change.
The CRC1 covering also the control bits C1..C25 shall be recomputed in the
transcoders.
The coding of the **Data Bits** is described in **3GPP** TS 48.060.
In 3G systems, the Frame_Classification Bits must be derived from the Frame
Quality Indicator (FQI) and Frame Type Index as defined in the 3GPP TS 26.101.
Table 5.2.2.1-3 provides the conversion rules between the generic AMR Frames
(as defined in 3GPP TS 26.101) and TFO Frames. In this table, the arrows in
the fourth column indicate the direction for which the conversion applies.
NOTE 1: A one-to-one relationship between Generic AMR Frames and TFO Frames
does not always exist, but the conversion is always possible.
NOTE 2: In the generic AMR Frames (**3GPP** TS 26.101), the differentiation
between SID_FIRST and SID_UPDATE is done in the Data bits (SID Type
Indicator). The Codec Mode Indication (CMI) is carried in 3G systems within
the SID payload.
For the **FR_AMR, HR_AMR, UMTS_AMR_2 and OHR_AMR** Codec Types, bits C23 - C25
shall carry either the Codec Mode Request (CMR) or the Codec Mode Indication
(CMI), depending on the value of RIF, if the Frame_Classification bits are
different from \"0.0\". If the Frame_Classification bits are equal to \"0.0\"
(SID_First and SID_Update Frames), C23 - C25 are set to 0.0.0, and the CMI and
CMR are carried in the data bits D35 - D40.
For 3G systems using the UMTS_AMR_2 Codec Types, the TC shall monitor the
changes of the uplink Codec Mode, as received in the Iu Frames. Every time the
Codec Mode changes in the Iu Frames the TC shall set RIF = \"0\" in the
corresponding TFO Frame. The next TFO Frames are alternatively marked with RIF
= \"1\", \"0\", \"1\" and so on.
NOTE 3: Per definition for UMTS_AMR_2 the UE shall select the phase of
potential Codec Mode changes in uplink once at call set-up and shall not alter
this later on. At call set-up TFO is not active and the TC has enough time to
find the phase of the RIF by the proposed implicit method, before the first
TFO Frame has to be sent.
> Table 5.2.2.1-3: Conversion between Generic AMR Frames and AMR_TFO_16k
> Frames
* * *
Generic AMR Frame AMR_TFO_16k Frame
Frame\ Frame\ TX_TYPE or\ Frame_\ CMI or\ Data bits in\ Equivalent Frame\
Quality\ Type\ RX_TYPE\ Classification\ CMR\ No_Speech\ Type in 3GPP TS
48.060) Indicator Index (see 3GPP TS 26.101) C21 - C22 C23 - C25 frames\  
D32 .. D34
1 0-7 SPEECH_GOOD \ 1 1 0-7 - Speech_Good
1 0-7 SPEECH_GOOD \ 0 1 0-7 - Speech_Bad
1 8 SID_FIRST \ 0 0 0 0 0 SID_First No_Speech
1 15 NO_DATA \ 0 0 0 0 0 SID_Update No_Speech
0 8 SID_BAD \ 0 0 0 0 0 SID_Bad No_Speech
1 15 NO_DATA \ 0 0 0 0 0 No_Data No_Speech
* * *
The **Synchronisation Pattern** is similar to the Synchronisation Pattern in
**3GPP** TS 48.060, with some exceptions related to the value of the EMBED
Bit:
EMBED equal \"0\": the Synchronisation Pattern is exactly as described in the
**3GPP** TS 48.060;\ EMBED equal \"1\": the Synchronisation Pattern contains
an embedded TFO Message.
For the coding of the **Data Bits** see **3GPP** TS 48.060 and Annex C for the
bits reserved for TFO Configuration Parameters.
For the coding of the **Time Alignment Bits** (T_Bits, T1 .. T4) see **3GPP**
TS 48.060 and Annex C. When the TFO Frame is generated by a GSM Network, the
T_Bits normally correspond to the T_Bits received in the up-link TRAU Frame.
#### 5.2.2.2 TFO Frame Format AMR_TFO_8+8k
The AMR_TFO_8+8k Frame formats are derived from the GSM Adaptive Multi-Rate 8
kbit/s TRAU Frame formats defined in **3GPP** TS 48.061. AMR Codec Modes with
rates up to 7,40 kbit/s can be used with these AMR_TFO_8+8k Frame formats. The
AMR_TFO_8+8k is described in an 8 kbit/s frame structure for the second LSB of
the PCM samples and an 8 kbit/s synchronisation pattern for the LSB. The TFO
Frame structures for the second LSB are illustrated in Figures 5.2.2.2-1 to
5.2.2.2-3, using the same notations as in **3GPP** TS 48.061. Figure 5.2.2.2-4
defines the additional Synchronisation pattern for the LSB. Both frames shall
be exactly synchronised on the A-Interface. This additional Synchronisation
Pattern is sometimes modified by embedding of TFO Messages, indicated by the
value of the **EMBED** bit:
EMBED equal \"0\": the Synchronisation Pattern is exactly as described in
Figure 5.2.2.2-4;\ EMBED equal \"1\": the Synchronisation Pattern contains an
embedded TFO Message.
* * *
                 **Bit number**
**Octet no** **1** **2** **3** **4** **5** **6** **7** **8** **1** 0 0 0 0 0 0
0 0 **2** 1 D1 D2 D3 D4 D5 D6 D7 **3** 1 C1 C2 C3 C4 C5 D8 D9 **4** 0 1 D10
D11 D12 D13 D14 D15 **5...19** 1  
**20** 1 D121 D122 D123 D124 D125 D126 T
* * *
Figure 5.2.2.2-1: AMR_TFO_8+8k Frame Structure, second LSB:\ NO_SPEECH frames
and SPEECH frames for Codec Modes 4,75, 5,15 and 5,90 kbit/s
* * *
                 **Bit number**
**Octet no** **1** **2** **3** **4** **5** **6** **7** **8** **1** 0 0 0 0 0 0
0 0 **2** 1 D1 D2 D3 D4 D5 D5 D7 **3** 1 C1 C2 C3 D8 D9 D10 D11 **4...19**  
**20** D130 D D D D D D D137
* * *
Figure 5.2.2.2-2: AMR_TFO_8+8k Frame Structure, second LSB:\ Speech frame for
Codec Mode 6,70 kbit/s
* * *
                 **Bit number**
**Octet no** **1** **2** **3** **4** **5** **6** **7** **8** **1** 0 0 1 D1 D2
D3 D4 D5 **2** 0 D6 D7 D8 D9 D10 D11 D12 **3** 1 C1 C2 C3 D13 D14 D15 D16
**4** 0 D17 D18 D19 D20 D21 D22 D23 **5** D24 D D D D D D D31 **6 ... 19**  
**20** D144 D145 D146 D147 D148 D149 D150 D151
* * *
Figure 5.2.2.2-3: AMR_TFO_8+8k Frame Structure, second LSB:\ Speech frame for
Codec Mode 7,40 kbit/s
* * *
                 **Bit number**
**Octet no** **1** **2** **3** **4** **5** **6** **7** **8** **1** 0 0 0 0 0 0
0 0 **2** 1 EMBED EXTEND  
**3...6** 1 1 **7** 0 1  
**8 ... 19** 1  
**20** 1 1 1
* * *
Figure 5.2.2.2-4: AMR_TFO_8+8k Frame Structure, LSB:\ Additional
Synchronisation Pattern
> EXTEND equal \"0\": The bits not defined in the Synchronisation Pattern
> described in Figure\ 5.2.2.2-4 are \"spare\" (equal 1). In AMR_TFO_8+8k
> frames these undefined bit positions shall leave the original bits of the
> PCM coded speech unaltered.\ In TRAU_8+8k frames these undefined bits shall
> be set to \"1\" (spare).
>
> EXTEND equal \"1\": The bits not defined in the Synchronisation Pattern
> described in Figure\ 5.2.2.2-4 transport other parameters (tbd).
Table 5.2.2.2-1 defines the coding of the Control Bits for AMR TFO Frames.
Note that additional TFO Configuration Parameters may be carried by the Data
Bits of the TFO Frames, as defined in Annex C.
Table 5.2.2.2-1: The coding of the Control Bits (C1 .. C5) for AMR_TFO_8+8k
Frames
+-------------+-----------------+-----------------+-----------------+ | Control Bit | Description | No_Speech | 6,7 + 7,4 | | | | frames and | kbit/s Codec | | | | Speech frames | Mode | | | | for 4,75, 5,15 | | | | | and 5,9 kbit/s | | | | | Codec Modes | | +-------------+-----------------+-----------------+-----------------+ | C1 -- C3 | **see 3GPP TS | - For the low | - For the 6,70 | | | 48.061** | rates frame | and 7,40 kbit/s | | | | types, these | speech frame, | | | | bits jointly | these bits | | | | define the CMI, | jointly provide | | | | CMR and RIF. | the CMR, RIF, | | | | | and the Frame | | | | - For the | Classification. | | | | No_Speech | | | | | frame type, | - Copied from | | | | they define the | the uplink TRAU | | | | RIF. | Frame in GSM. | | | | | | | | | - Copied from | - Derived from | | | | the uplink TRAU | the Frame | | | | Frame in GSM. | Quality | | | | | Indicator and | | | | - Derived from | Frame Type for | | | | the Frame | 3G systems (see | | | | Quality | Table 5.2.2.2-2 | | | | Indicator and | below) | | | | Frame Type for | | | | | 3G systems (see | | | | | Table 5.2.2.2-2 | | | | | below) | | +-------------+-----------------+-----------------+-----------------+ | **C4 - C5** | **Frame_Cl | > \- Copied | The | | | assification**\ | > from the | Frame\ | | 1 1 | (No_Speech and | > uplink TRAU | _Classification | | | low rates modes | > Frame in GSM | is defined by | | 1 0 | only) | > | bits C1-C3 in | | | | > \- Derived | 6,70 and 7,40 | | 0 1 | \ | > from the | kbit/s TFO | | | "Speech_Good\" | > Frame Quality | Frames | | 0 0 | | > Indicator and | | | | \"Spe | > Frame Type | C4..C5 are not | | | ech_Degraded\" | > for 3G | existent for | | | | > systems (see | this codec | | | \"Speech_Bad\" | > Table 5.3.2-2 | modes | | | | > below) | | | | \"No_Speech\" | | | +-------------+-----------------+-----------------+-----------------+
The CRC1 covering also the control bits shall be recomputed in the
transcoders.
The coding of the **Data Bits** is described in **3GPP** TS 48.061 [4].
For 3G systems, Table 5.2.2.2-2 provides the conversion rules between the
generic AMR Frames as defined in 3GPP TS 26.101 and the AMR_TFO_8+8k Frames.
In this table, the arrows in the fourth column indicate the direction for
which the conversion applies. The Transcoder shall autonomously and internally
generate a RIF alternating between the binary \"0\" and \"1\" values (see
Annex D).
> Table 5.2.2.2-2: Conversion between Generic AMR Frames and AMR_TFO_8+8k
> Frames
* * *
Generic AMR Frame TFO Frame for 8 kbit/s submultiplexing
Frame\ Frame\ TX_TYPE or\ Bits\ Bits\ Data bits in\ Equivalent Frame\ Frame
Type Quality\ Type\ RX_TYPE\ C1 .. C3 C4 -- C5 No_Speech\ Type in 3GPP TS
48.061  
Indicator Index (see 3GPP TS 26.101) frames\  
D8 .. D10
1 0-2 SPEECH_GOOD \ as 3GPP TS 48.061 1 1 - Speech_Good 4,75 kbit/s,\ 5,15
kbit/s,\ 5,90 kbit/s\ Modes
1 0-2 SPEECH_GOOD \ as **3GPP** TS 48.061 0 1 - Speech_Bad
1 3-4 SPEECH_GOOD \ as 3GPP TS 48.061 Speech bits - Speech_Good 6,70
kbit/s, 7,40 kbit/s\ Modes
1 3-4 SPEECH_GOOD \ as **3GPP** TS 48.061 Speech bits - Speech_Bad
1 8 SID_FIRST \ as 3GPP TS 48.061 0 0 SID_First No_Speech No Speech
1 15 NO_DATA \ as 3GPP TS 48.061 0 0 SID_Update No_Speech
0 8 SID_BAD \ as 3GPP TS 48.061 0 0 SID_Bad No_Speech
1 15 NO_DATA \ as 3GPP TS 48.061 0 0 No_Data No_Speech
* * *
The **Synchronisation Pattern** in the second LSB of the PCM samples is
identical to the Synchronisation Pattern in **3GPP** TS 48.061. Embedding of
TFO Messages has no influence on this synchronisation pattern.
For the coding of the **Time Alignment Bit** (T Bit) for all modes below 5,9
kbit/s and the No_Seech Frame, see **3GPP** TS 48.061.The T-Bit in a TFO Frame
normally corresponds to the T_Bit received in the up-link TRAU Frame.
#### 5.2.2.3 TFO Frame Format AMR_WB_TFO_16k and AMR_WB_TFO_32k
TFO Frames with format AMR_WB_TFO_16k and AMR_WB_TFO_32k are derived from the
TRAU Frames for Adaptive Multi-Rate Wide Band as defined in the 3GPP TS
48.060. The AMR_WB_TFO_16k Frame structure is illustrated in Table 5.2.2.3-1
below, using the same notations as in 3GPP TS 48.060.
For AMR_WB_TFO_32k Frames the identical frame structure is used twice, once in
the lower 16k main part (identical to the AMR_WB_TFO_16k) and in the upper 16k
extension part (carrying some data bits, but no synchhronisation and no
control bits, see Table 5.2.2.3-2). The unspecified bits in Table 5.2.2.3-2
shall not alter the bits of the PCM samples on the 64 kbit/s A interface.
Table 5.2.2.3-3 defines the coding of the Control Bits for the Frame Type (==
Codec Type) field (C1..C4) in AMR_WB_TFO_16k and AMR_WB_TFO_32k frames. For
the remaining control bits (C5...C25) the definition is as for AMR_TFO_16k
frames for FR_AMR.
Table 5.2.2.3-1: Structure of AMR_WB_TFO_16k Frames\ and the lower 16k main
part of AMR_WB_TFO_32k Frames
* * *
                                  **Bit number**
**Octet no.** **1** **2** **3** **4** **5** **6** **7** **8** **0a** 0 0 0 0 0
0 0 0 **1a** 0 0 0 0 0 0 0 0 **2a** 1 C1 C2 C3 C4 C5 C6 C7 **3a** C8 C9 C10
C11 C12 C13 C14 C15 **4a** 1 C16 C17 C18 C19 C20 C21 C22 **5a** C23 C24 C25 D1
D2 D3 D4 D5 **6a** 1 D6 D7 D8 D9 D10 D11 D12 **7a** D13 D14 D15 D16 D17 D18
D19 D20 **8a..36a**  
**37a** D238 D239 D240 D241 D242 D243 D244 D245 **38a** 1 D246 D247 D248 D249
D250 D251 D252 **39a** D253 D254 D255 D256 T1 T2 T3 T4
* * *
Table 5.2.2.3-2: Structure of the upper 16k extension part in AMR_WB_TFO_32k
Frames
* * *
                                  **Bit number**
**Octet no.** **1** **2** **3** **4** **5** **6** **7** **8** **0b**  
**1b**  
**2b**  
**3b**  
**4b**  
**5b** D1 D2 D3 D4 D5 **6b** D6 D7 D8 D9 D10 D11 D12 **7b** D13 D14 D15 D16
D17 D18 D19 D20 **8b..36b**  
**37b** D238 D239 D240 D241 D242 D243 D244 D245 **38b** 1 D246 D247 D248 D249
D250 D251 D252 **39b** D253 D254 D255 D256
* * *
Table 5.2.2.3-3: Coding of the Frame Type for AMR_WB_TFO_16k Frames\ and
AMR_WB_TFO_32k Frames
+--------------+--------------------------+--------------------------+ | Control Bits | Description | Comment | +--------------+--------------------------+--------------------------+ | **C1 - C4** | **Frame_Type / Codec | The coding is different | | | Type** | from the coding in TFO | | (0.0.0.1) | | Messages. It is also not | | | **(GSM_FR)** | identical to the coding | | (0.0.1.1) | | on Abis/Ater. The TRAU | | | (FR_AMR) | shall translate the | | (0.1.0.0) | | coding between TRAU and | | | (HR_AMR) | TFO Frames.\ | | (0.1.0.1) | | \ | | | (UMTS_AMR) | Note: Codec Types in | | (0.1.1.0) | | (brackets) are not | | | (UMTS_AMR_2) | supported by this TFO | | **1.0.0.1** | | Frame format. They are | | | **FR_AMR-WB** | listed to show their | | **1.0.1.0** | | coding for convenience. | | | **UMTS_AMR-WB** | | | (1.0.1.1) | | Note: By definition | | | (OHR_AMR) | FR_AMR-WB and | | **1.1.0.0** | | OHR_AMR-WB do only use | | | **OFR_AMR-WB** | the AMR_WB_TFO_16k | | **0.0.1.0** | | Frame, because they | | | **OHR_AMR-WB** | never use a Codec Mode | | (1.1.0.1) | | higher than 12.65 | | | **(GSM_EFR)\ | kbit/s. UMTS_AMR-WB and | | | ** | OFR_AMR-WB use the | | | | AMR_WB_TFO_32k Frame | | | | when at least one Codec | | | | Mode is above 12.65 | | | | kbit/s. | +--------------+--------------------------+--------------------------+
NOTE: Any spare control bits shall be coded as binary \"1\". They are reserved
for future use and may change.
The CRC covering also the control bits C1..C25 shall be recomputed in the
transcoder, because some control bits change between TRAU Frames and TFO
Frames, e.g. the coding of the Frame Type.
The coding of the **Data Bits** is described in 3GPP TS 48.060. In
AMR_WB_TFO_32k Frames the data bits in the upper 16k extension part shall be
set as defined in TS 48.060. But in all unused bit positions of this upper
extension part the bits of the PCM samples shall not be altered in order to
minimise the audible effect.
In 3G systems, the Frame_Classification Bits must be derived from the Frame
Quality Indicator (FQI) and Frame Type Index as defined in the 3GPP TS 26.201.
The conversion rules are the same as for the FR_AMR.
NOTE 1: A one-to-one relationship between Generic WB AMR Frames and TFO Frames
does not always exist, but the conversion is always possible.
NOTE 2: In the generic WB AMR Frames (3GPP TS 26.201), the differentiation
between SID_FIRST and SID_UPDATE is done in the Data bits (SID Type
Indicator). The Codec Mode Indication (CMI) is carried in 3G systems within
the SID payload.
3G systems using the UMTS_AMR-WB Codec Type, the TC shall monitor the changes
of the uplink Codec Mode, as received in the Iu Frames. Every time the Codec
Mode changes in the Iu Frames the TC shall set RIF = \"0\" in the
corresponding TFO Frame. The next TFO Frames are alternatively marked with RIF
= \"1\", \"0\", \"1\" and so on.
NOTE 3: Per definition for UMTS_AMR-WB the UE selects the phase of potential
Codec Mode changes in uplink once at call set-up and does not alter this later
on. At call set-up TFO is not active and the TC has enough time to find the
phase of the RIF by the proposed implicit method, before the first TFO Frame
has to be sent.
The **Synchronisation Pattern** is similar to the Synchronisation Pattern in
3GPP TS 48.060, with some exceptions related to the value of the EMBED Bit:
EMBED equal \"0\": the Synchronisation Pattern is exactly as described in the
3GPP TS 48.060;\ EMBED equal \"1\": the Synchronisation Pattern contains an
embedded TFO Message.
For the coding of the **Data Bits** see 3GPP TS 48.060.
For the coding of the **Time Alignment Bits** (T_Bits, T1 .. T4) see 3GPP TS
48.060. When the TFO Frame is generated by a GSM Network, the T_Bits normally
correspond to the T_Bits received in the up-link TRAU Frame.
### 5.2.3 Transmission of the bits of 16 kbit/s TFO Frames
For the purpose of this description the 320 bits of one TFO Frame are arranged
in 40 rows (0..39), with 8 bit each (1..8: one octet) as in **3GPP** TS
48.060.
**The bits of 16 kbit/s** **TFO Frames are transmitted in the following
order:**
Bit m of octet n, shall be transmitted in the **Least** Significant Bit of the
PCM sample k = n*4 + (m+1)/2 for m = (1, 3, 5, 7) and n = (0..39).
Bit m of octet n shall be transmitted in the **second Least** Significant Bit
of the
PCM sample k = n*4 + m/2 for m = (2, 4, 6, 8) and n = (0..39).
PCM sample (k=1) is the first PCM sample of the TFO Frame, which follows the
received uplink TRAU frame with a small delay (Tultfo), as described in clause
8, see figure 8.1.2-1.
### 5.2.3a Transmission of the bits of 32 kbit/s TFO Frames
For the purpose of this description the 640 bits of one TFO Frame are arranged
in 2 x 40 rows (0a..39a, 0b...39b), with 8 bit each (1..8: one octet) as in
3GPP TS 48.060, see also Table 5.2.2.3-1and Table 5.2.2.3-2.
**The bits of 32 kbit/s** **TFO Frames are transmitted in the following
order:**
Bit m of octet n, shall be transmitted in the **Least** Significant Bit of the
PCM sample k = n*4 + (m+1)/2 for m = (1, 3, 5, 7) and n = (0a...39a).
Bit m of octet n shall be transmitted in the **second Least** Significant Bit
of the
PCM sample k = n*4 + m/2 for m = (2, 4, 6, 8) and n = (0a..39a).
Bit m of octet n, shall be transmitted in the **third Least** Significant Bit
of the
PCM sample k = n*4 + (m+1)/2 for m = (1, 3, 5, 7) and n = (0b...39b).
Bit m of octet n shall be transmitted in the **fourth Least** Significant Bit
of the
PCM sample k = n*4 + m/2 for m = (2, 4, 6, 8) and n = (0b..39b).
PCM sample (k=1) is the first PCM sample of the TFO Frame, which follows the
received uplink TRAU frame with a small delay (Tultfo), as described in clause
8, see figure 8.1.2-1.
It is important that the lower main 16k part and the upper 16k extension part
are exactly synchronised as described above, see also clause 8.
### 5.2.4 Transmission of the bits of AMR_TFO_8+8k Frames
For the purpose of this description the 160+160 bits of one AMR_TFO_8+8k frame
are arranged in 20 rows (1..20), with 8 bit each (1..8: one octet) as shown in
Figures 5.2.2.2-1 to 5.2.2.2-4.
The bits of AMR_TFO_8+8k frames are transmitted in the following order:
Bit m of octet n of the **additional synchronisation pattern** described in
Figure 5.2.2.2-4 shall be transmitted in the **Least** Significant Bit of the
PCM sample k = (n-1)*8+m; with m = (1..8) and n = (1..20).
Bit m of octet n of the **No_Speech and Speech frames** as described in
Figures 5.2.2.2-1 to 5.2.2.2-3 shall be transmitted in the **Second Least**
Significant Bit of the
PCM sample k = (n-1)*8+m; with m = (1..8) and n = (1..20).
PCM sample (k=1) is the first PCM sample of the TFO Frame, which follows the
received uplink TRAU frame with a small delay (Tultfo), as described in clause
8, see figure 8.1.2-1.
### 5.2.5 Optional AMR_TRAU_8+8k Frames
For TFO Connections with FR_AMR on the local side and HR_AMR on the distant
side the local side may use the AMR_TRAU_8+8k frame format after TFO has been
established. The AMR_TRAU_8+8k Frame is based on the TRAU Frame formats for
the AMR for 8 kBit/s sub-multiplexing as defined in **3GPP** TS 48.061
(TRAU_8k), with the additional Synchronisation pattern as defined in Figure
5.2.2.2-4. The differences to AMR_TFO_8+8k frames are:
\- the additional synchronisation pattern shall be transmitted in the Second
LSBs of the 16 kbit/s sub-multiplexed channel, while the TRAU_8k frames shall
be transmitted in the LSBs;
\- no embedded TFO Messages shall exist in TRAU_8+8k frames;
\- the EMBED bit shall be set to \"0\";
\- the EXTEND bit shall be set to \"0\";
\- undefined bits in Figure 5.2.2.2-4 shall be set to \"1\" (spare) in
TRAU_8+8k frames.
The potential transition from regular TRAU_16k frames to AMR_TRAU_8+8k frames
shall be triggered by the FR_TRAU with TFO_Soon and Dis_Req (including the
distant Codec Type: HR_AMR) in downlink direction.
If the BTS applies the optional AMR_TRAU_8+8k format, then the BTS shall
respond with the acknowledging TFO_Soon in the first AMR_TRAU_8+8k frame in
uplink. This will result in a small additional delay for the decoded PCM
samples, which the TRAU shall handle by proper concealment techniques. The
delay for TFO Messages and TFO Frames is, however, not increased: since no
format conversion is necessary in the TRAU the delay for AMR_TFO_8+8k frames
is minimised. After TFO has been established the TRAU shall change from
TRAU_16k to AMR_TRAU_8+8k in downlink with the reception of the first
AMR_TFO_8+8k frame.
If the BTS does not apply the AMR_TRAU_8+8k frame format in uplink, the TRAU
shall also not use this in downlink. The TRAU shall perform format conversion
in uplink from TRAU_16k format to AMR_TFO_8+8k format and in downlink from
AMR_TFO_8+8k format to TRAU_16k format. This will cause an additional delay of
TFO Messages and TFO Frames, which shall be handled by inserting the necessary
number of T_Bits. This format conversion causes also an additional delay in
downlink, which the BTS shall handle by proper buffering technique.
## 5.3 TFO Frames for 8 kbit/s sub-multiplexing
### 5.3.1 TFO Frame for the GSM Half Rate
The GSM Half Rate (GSM_HR) TFO Frames are always based on the **uplink** GSM
Half Rate TRAU Frames for **8 kbit/s** submultiplexing scheme, as defined in
the **3GPP** TS 48.061.
If GSM_HR TRAU Frames with 16 kbit/s submultiplexing are used on the Abis/Ater
interface, then the Control and Extended Control Bits for the 8 kbit/s TFO
Frame need to be generated on basis of the received Control Bits from the TRAU
Frame.
The coding of the **Control Bits** (C1 .. C9) is defined by the following
Table 5.3.1-1:
Table 5.3.1-1: Coding of the Control Bits (C1 .. C9) for the GSM_HR
+-------------+-------------+---------------------------------------------------+ | Control Bit | Description | Comment | +-------------+-------------+---------------------------------------------------+ | C1 - C4 | Frame Type | All other code words are reserved. | | | | | | 0.0.0.1 | GSM_HR | | +-------------+-------------+---------------------------------------------------+ | C5 | EMBED | Indicates the presence of an embedded TFO Message | +-------------+-------------+---------------------------------------------------+ | C7 - C8 | spare | | +-------------+-------------+---------------------------------------------------+ | C9 | DTXd | Copied from the uplink TRAU Frame | +-------------+-------------+---------------------------------------------------+
Any spare control bits shall be coded as binary \"1\". They are reserved for
future use and may change.
The **Synchronisation Pattern** is similar to the Synchronisation Pattern in
the **3GPP** TS 48.061, with some exceptions depending on the value of the
EMBED Bit:
EMBED equal \"0\": the Synchronisation Pattern is exactly as described in the
**3GPP** TS 48.061;\ EMBED equal \"1\": the Synchronisation Pattern contains
an embedded TFO Message.
Coding of the **Extended Control Bits (XC1 .. XC6)** :
**XC1** is copied from the uplink TRAU Frame.\ **XC2 .. XC6** : These bits are
normally copied from the 8 kbit/s TRAU Frame.\ All other codes are reserved.
For the coding of the **Data Bits** see **3GPP** TS 48.061.
For the coding of the **Time Alignment Bits** see **3GPP** TS 48.061. The
T_Bits normally correspond to the T_Bits received in the up-link TRAU Frame.
### 5.3.2 Transmission of the bits of 8 kbit/s TFO frames
For the purpose of this description the 160 bits of one frame are arranged in
20 rows (1..20), with 8 bit each (1..8: one octet) as in **3GPP** TS 48.061.
The bits of 8 kbit/s TFO Frames are transmitted in the following order:
Bit m of octet n shall be transmitted in the **Least** Significant Bit of the
PCM sample k = (n-1)*8+m; with m = (1..8) and n = (1..20).
PCM sample (k=1) is the first PCM sample of the TFO frame which follows the
received uplink TRAU frame with a small delay (Tultfo), as described in clause
8, see figure 8.1.2-1.
## 5.4 Void
## 5.5 Determination of the TFO Frame format
The TFO Frame format is depending on the Codec Types at both ends of the TFO
connection.
For the GSM FR and GSM EFR Speech Codec Types, the TFO Frame format shall be
16 kbit/s (see clause 5.2.1).
For the GSM HR Speech Codec Type, the TFO Frame format shall be 8 kbit/s (see
clause 5.3.1).
For any TFO connection with at least one side using the HR_AMR with a
configuration not including the mode 7.95 kBit/s the TFO frame format shall be
AMR_TFO_8+8k (see clause 5.2.2.2).
For all other AMR TFO connections, including HR_AMR with 7.95 kBit/s in the
ACSes on both sides, the TFO Frame format shall be AMR_TFO_16k (see clause
5.2.2.1).
For any AMR-WB TFO connection not supporting codec modes higher than 12,65
kbit/s, the TFO frame format shall be AMR_WB_TFO_16k.
For all other AMR WB TFO connections, the TFO frame format shall be
AMR_WB_TFO_32k.
## 5.6 Codec Types in TFO Frames
The Codec Type in TFO Frames shall always be the Local Used Codec of the
sender of the TFO Frames, exactly as used in TFO Messages.
In cases where compatible, but different Codec Types are used on both sides of
the TFO connection (e.g. in calls involving HR_AMR and FR_AMR) each side shall
use its own Codec Type in its transmitted TFO Frames. Consequently the Codec
Types inside the TFO Frames may be different in both directions of the TFO-
link. The TRAU shall always use the Local Used Codec on Ater/Abis interface
and therefore translate between Codec Types in TFO and TRAU frames if
necessary.
# 6 Elementary Procedures for TFO Operation
This clause provides a simplified overview of the elementary procedures of the
Tandem Free Operation Protocol. The complete, binding specification of the TFO
Protocol is provided in clause 10.
## 6.1 Pre-synchronisation of IPEs
As soon as the local transcoder receives and sends speech samples and TFO is
enabled, it initiates the TFO negotiation by sending **TFO_FILL** messages, in
order to pre-synchronise potential IPEs quickly. The IPEs will then let
further TFO messages pass transparently (see Annex B for guidelines for In-
Path Equipment behaviour).
The distant TC may initiate the same procedure at the same time.
{width="3.1131944444444444in" height="1.0208333333333333in"}
Figure 6.1
If the IPE does not support TFO, i.e. if it is not transparent for the TFO
Messages and TFO Frames, it is perceived by the local transcoder in the same
way as if the distant transcoder does not answer (see clause 6.2).
## 6.2 TFO Negotiation
The transcoder sends **TFO_REQ** messages, indicating its System
Identification (3G, GSM...) and the Speech Codec Type used with its main
characteristics (ACS for AMR). If the distant transcoder supports TFO, it will
answer by a **TFO_ACK** message. The distant transcoder may initiate the same
procedure at the same time.
If the local and distant transcoders use compatible Speech Codec Types (or
compatible configurations of the same Speech Codec Type), see clause 11, they
will go into TFO. Otherwise, a Codec Mismatch Resolution may be initiated, if
supported by the transcoder.
{width="3.1131944444444444in" height="1.9166666666666667in"}
Figure 6.2
In some rare cases, the transcoders might also go into TFO even if both ends
use different Speech Codec Types or different Configurations of the same
Speech Codec Types. Typical examples of this situation occur when both ends
use AMR Speech Codec Types with a substantial subset of identical Codec Modes.
The conditions and rules related to this situation are defined in clause 11.
The distant transcoder may not answer for following reasons (the list is not
exhaustive):
\- The call is connected to PSTN (and then there is no distant transcoder!);
\- The distant transcoder does not support TFO or TFO is disabled there;
\- The path between the transcoders is not transparent.
In these cases, the local transcoder sends several TFO_REQ and returns to
normal mode. However, it continues to monitor if there are TFO messages
inserted in the PCM samples.
## 6.3 Codec Mismatch Resolution
If the optional Codec Mismatch Resolution is supported, the transcoders shall
exchange their full codec capabilities (Supported Codec List, with the full
range of parameters for these codecs) by sending **TFO_REQ_L messages** or
**Con_Req frames**. These are acknowledged by **TFO_ACK_L** messages,
respectively **Con_Ack** frames. The same procedure may be initiated by the
distant transcoder.
The same algorithm is then run at both extremities to determine a Common
Speech Codec Type and its configuration to go into TFO. If no Common Speech
Codec Type exists, the transcoders give up TFO. Any Speech Codec Type or
Configuration listed in the Supported Codec Set is a candidate for TFO
establishment. If a Codec Type configuration is undesirable, e.g. Full Rate
Codec Type when operating on a Half Rate Channel, it should not be listed in
the Supported Codec List.
Once the Common Speech Codec Type/Configuration is defined, each side must
modify its Local Used Speech Codec Type and/or Configuration to the Common
Speech Codec Type, if necessary. This operation may involve other network
elements (BSS/RAN) and is out of the scope of the present document. Once the
Speech Codec Type is set to the Common Speech Codec Type, the transcoder shall
re-initialise the TFO Negotiation as defined in clause 6.2.
{width="3.1569444444444446in" height="1.8743055555555554in"}
Figure 6.3
If the Codec Mismatch Resolution is not supported, the List of Supported Codec
Types shall be restricted to the Local Active Codec Type and its Configuration
(Acitve Speech Codec Mode/s in use).
## 6.4 TFO Establishment
To establish TFO, the transcoders sends a **TFO_TRANS** message to indicate to
the IPEs that TFO frames follow, and begins to send **TFO frames**. The
TFO_TRANS message also defines the bandwidth occupied by the TFO frames (8
kbit/s or 16 kbit/s or 32 kbit/s).
Once both transcoders send and receive TFO frames, encoded with the Common
Speech Codec Type, TFO is established.
{width="3.1131944444444444in" height="1.59375in"}
Figure 6.4
## 6.5 Codec Optimisation
Once TFO is established, the transcoders shall exchange their capabilities
available for Optimisation by sending a TFO_REQ_L message or a Configuration
frame. The TFO_REQ_L message is acknowledged by **TFO_ACK_L** messages, the
Configuration Request by an Configuration Acknowledgement. This may trigger a
Codec Optimisation. The TFO Decision Algorithm will determine, if another
Common Speech Codec Type/Configuration exists with the potential to provide
better speech quality while operating in TFO.
If the Optimisation leads to a new Common Speech Codec Type and/or
Configuration, both ends shall switch to the new Common Speech Codec following
the same procedure as in clause 6.3 Codec Mismatch Resolution.
The Codec Optimisation may temporarily break TFO while the Speech Codec is
switched to the new Optimised Codec Type/Configuration.
{width="3.1458333333333335in" height="1.8847222222222222in"}
Figure 6.5
## 6.6 TFO Termination
TFO may be terminated for the following reasons (the list is not exhaustive):
\- TFO is disabled in one of the transcoders;
\- The call is released;
\- An in-call modification from speech to data is initiated;
\- A handover moves the call to a transcoder that does not support TFO, or
where TFO is disabled;
\- A handover moves the call to a cell where no common codec can be found with
the distant side.
The transcoder which is still in TFO shall stop sending TFO frames, go back to
normal operation and send a **TFO_NORMAL** message to indicate to the IPEs
that TFO has ended.
## 6.7 TFO Fast Establishment after Local Handover
While TFO is established, if the local side is handed over, the distant side
may not detect the loss of synchronisation immediately and continue to send
TFO Frames.
Once the handover is performed, the new local transcoder receives TFO Frames,
while TFO is not yet re-established. If the Speech Codec Types on both sides
match, the local TC sends a **TFO_DUP** message to indicate the situation to
the distant TC. Meanwhile, the distant transcoder may have detected a loss of
synchronisation, which it signals by sending a **TFO_SYL** message. If further
TFO Frames and especially if a TFO_SYL message are received, the new local
transcoder sends TFO Frames and goes into TFO.
{width="4.020833333333333in" height="3.5in"}
Figure 6.6
The same procedure applies if the new local Transcoder operates an AMR Speech
Codec Type and receives acceptable TFO Frames (AMR TFO Frames for one of the
Codec Modes in the ACS) after a local handover. The local Transcoder assumes
that the ACS was not changed during the Handover and sends TFO Frames to the
distant Transcoder. The local and distant Transcoders should then confirm that
they are operating on the same or compatible ACS by exchanging TFO_REQ_L
messages (or Configuration Frames, see example below) and by running the TFO
Decision Algorithm.
{width="4.020833333333333in" height="2.90625in"}
Figure 6.7
# 7 TFO Messages
The TFO Messages, introduced in clause 6, follow the generic IS_Message
principle defined in annex A.
The following definitions are provided for the **_[Sender]{.underline}_**
side:
**[TFO_REQ ():]{.underline}** Identifies the source of the message as a TFO
capable device, using a defined Codec_Type.\ TFO_REQ contains the following
parameters ():
\- the System_Identification of the sender;
\- the specific Local_Signature of the sender;
\- the Local_Used_Codec_Type at sender side;
\- possibly additional attributes for the Local_Used_Codec_Type;
\- possibly additionally the TFO_Version;
\- possibly additionally alternative Codec_Types (short form of Codec_List);
\- possibly additionally a future TFO_Extension.
**[TFO_ACK ():]{.underline}** Is the response to a TFO_REQ Message.\ TFO_ACK
contains the corresponding parameters as TFO_REQ, except for the
Local_Signature replaced by the Reflected_Signature, copied from the received
TFO_REQ Message.
**[TFO_REQ_L ():]{.underline}** Is sent in case of Codec Mismatch or for
sporadic updates of information.\ TFO_REQ_L contains the following parameters
():
\- the System_Identification of the sender;
\- the specific Local_Signature of the sender;
\- the Local_Used_Codec_Type at sender side;
\- the Local_Codec_List of alternative Codec_Types;
\- possibly additional attributes for the used and the alternative Codec_Types
\- possibly additionally the TFO_Version
\- possibly additionally a future TFO_Extension.
**[TFO_ACK_L ():]{.underline}** Is the response to a TFO_REQ_L Message.\
TFO_ACK_L contains the corresponding parameters as TFO_REQ_L, except for the
Local_Signature replaced by the Reflected_Signature, copied from the received
TFO_REQ_L Message.
**[TFO_TRANS ():]{.underline}** Commands possible IPEs to let the TFO Frames
pass transparently within the LSB (8 kbit/s) or the two LSBs (16 kbit/s) or
the four LSBs (32kbit/s). TFO_TRANS contains the following parameter ():
\- the Local_Channel_Type (8 kbit/s or 16 kbit/s or 32 kbit/s).
**[TFO_NORMAL:]{.underline}** Commands possible IPEs to revert to normal
operation.\ TFO_NORMAL has no parameters.
**[TFO_DUP:]{.underline}** Informs the distant partner that TFO Frames are
received, while still transmitting PCM samples.\ TFO_DUP has no parameters.
**[TFO_SYL:]{.underline}** Informs the distant partner (if still possible)
that TFO Frames are no longer received.\ TFO_SYL has no parameters.
**[TFO_FILL:]{.underline}** Message without specific meaning, used to pre-
synchronise IPEs or to bridge over gaps in TFO protocols. TFO_FILL has no
parameters.
## 7.1 Extendibility
A mechanism for future extensions is defined in a way that existing
implementations in the field shall be able to ignore future, for them unknown
Codec_Types and their potential attributes. The existing implementations shall
be able to decode the remainder of the messages (which is known to them)
uncompromised. This mechanism allows to extent:
\- the number of Local_Used_Codec_Types from 15 (short form) up to 255 (long
form) for one System_Identification;
\- the Codec_List;
\- the Codec_Attributes (if needed).
In case of the TFO_REQ or TFO_ACK messages the attributes of the
Local_Used_Codec_Type shall be sent in the codec specific way, without a
preceding Codec_Attribute_Head Extension_Block. Existing equipment, that do
not know a future Codec_Type and therefore do not know if and how many
attribute Extension_Blocks do follow, shall skip these Extension_Blocks, until
they find a TFO Message Header again. Similarly, if future Extension_Blocks to
a known Codec_Type are detected, existing equipment shall skip these
Extension_Blocks, until they find a TFO Message Header again.
In case of the TFO_REQ_L or TFO_ACK_L Messages the simple Codec_List shall be
sent immediately after the SIG_LUC and possible Codec_x Extension_Blocks. Then
the attributes of all alternative Codec_Types shall follow. Each set of codec
attributes shall be preceded by the Codec_Attribute_Head Extension_Block (with
Codec_Type Identifier and Length Indicator) followed by the Codec specific
attributes.
## 7.2 Regular and Embedded TFO Messages
A TFO Message is called **\"regular** \", if it is sent inserted into the PCM
sample stream. A TFO Message is called \"**embedded** \", if it is embedded
into a TFO Frame. The bit stealing scheme, as defined in Annex A, is identical
for regular and embedded TFO Messages. The EMBED bit of the TFO Frames (see
clause 5) indicates if the TFO Frame contains an embedded TFO Message. Due to
the specific construction of the TFO Messages, they replace some of the
synchronisation bits of the TFO Frames. Consequently, the TFO Frame
synchronisation pattern will be affected by the presence of an embedded TFO
Message, without compromising the synchronisation performances. Data and other
control bits of the TFO Frames are not affected by embedded TFO Messages.
## 7.3 Cyclic Redundancy Check
The Extension_Blocks, defined in the following clauses, shall be protected by
three CRC parity bits. These shall be generated as defined in the 3GPP TS
48.060 for the Enhanced Full Rate. For simplicity the present document is
reprinted here:
\"These parity bits are added to the bits of the subset, according to a
degenerate (shortened) cyclic code using the generator polynomial:
g(D) = D^3^ + D + 1
The encoding of the cyclic code is performed in a systematic form which means
that, in GF(2), the polynomial:
d(m)D^n^ + d(m+1)D^n‑1^ + ......+ d(m + n‑3)D^3^ + p(0)D^2^ + p(1)D + p(2)
where p(0), p(1), p(2) are the parity bits, when divided by g(D), yields a
remainder equal to:
1 + D + D^2^
For every CRC, the transmission order is p(0) first followed by p(1) and p(2)
successively.\"
In case of Extension_Blocks, p(0)..p(2) are mapped to bits 16..18.
## 7.4 TFO_REQ Messages
Symbolic Notation:\ TFO_REQ (Sys_Id, LSig, Local_Used_Codec_Type[,
Used_Codec_Attributes] )\ TFO_REQ_L (Sys_Id, LSig, Local_Used_Codec_Type,
Codec_List [, Alternative_Codec_Attributes] )
The TFO_REQ Messages conform to the IS_REQ Message format, defined in the
Annex A, with IS_System_Identification, followed by the SIG_LUC
Extension_Block, optionally the Codec_x Extension_Block, the Codec_List
Extension_Block(s) and the Codec_Attribute Extension_Blocks.
The shortest TFO_REQ takes 140 ms for transmission, see Figure 7.4-1.\ The
shortest TFO_REQ_L takes 180 ms (Figure 7.4-2).
> {width="3.998611111111111in" height="0.8548611111111111in"}
Figure 7.4-1: Construction of the shortest possible TFO_REQ Message
> {width="3.998611111111111in" height="0.8173611111111111in"}
Figure 7.4-2: Construction of the shortest possible TFO_REQ_L Message
{width="6.496527777777778in" height="0.8923611111111112in"}
> Figure 7.4-3: Example of a TFO_REQ Message with a Codec with an index higher
> than 15 and with three Attribute Extension_Blocks (300 ms length)
{width="6.481944444444444in" height="0.8854166666666666in"}
> Figure 7.4-4: Example of a TFO_REQ_L Message with Codec_List and one
> alternative Codec with two Attribute Extension_Blocks (300 ms length)
A TFO_REQ (TFO_ACK) may have an additional TFO_Version Extension_Block that
contains the TFO_Version.Subversion and a Selector. This Selector may indicate
future extensions to TFO_REQ (TFO_ACK), which may require further additional
Extension_Blocks following the TFO_Version, see figure 7.4-5.
Figure 7.4-5: Construction of a TFO_REQ Message with [Sel]{.underline}ector,
TFO_[Ver]{.underline}sion[.S]{.underline}ub[ver]{.underline}sion\ and one
additional Extension_Block
### 7.4.1 Definition of the SIG_LUC Extension_Block
The SIG_LUC Extension_Block consists of 20 bits, as defined in Table 7.4.1-1.
It shall always follow immediately after the SYS_ID Extension_Block. It
differentiates a TFO_REQ from a TFO_REQ_L message and a TFO_ACK from a
TFO_ACK_L message.
The Codec_x Extension_Block shall also be used in TFO_REQ or TFO_REQ_L
messages if the Local_Used_Codec_Type has a CoID higher than 14.
Table 7.4.1-1: SIG_LUC Extension_Block
+--------------+----------------+------------------------------------+ | Bit | Description | Comment | +--------------+----------------+------------------------------------+ | Bit 1 | \"**0** \" | normal IS-Message Sync Bit, | | | | constant. | +--------------+----------------+------------------------------------+ | Bit 2 | **List_Ind** | Indicates, whether the Codec_List | | | | is included in the TFO Message or | | | | not | | | | | | | | **0: S: TFO_REQ** or | | | | **TFO_ACK** : Codec_List is not | | | | included (short) | | | | | | | | **1: L: TFO_REQ_L** or | | | | **TFO_ACK_L** : Codec_List is | | | | included (long) | +--------------+----------------+------------------------------------+ | Bit 3..10 | **Sig** | An 8-bit random number to | | | | facilitate the detection of | | | | circuit loop back conditions and | | | | to identify the message source | +--------------+----------------+------------------------------------+ | Bit 11 | \"**0** \" | normal IS-Message Sync Bit, | | | | constant | +--------------+----------------+------------------------------------+ | Bit 12.. 15: | **Codec_Type\ | Identifies the | | | CoID_s** | Local_Used_Codec_Type, which is | | | | currently used by the sender | | | (short form) | | | | | **0000...1110: reserved for 15 | | | | Codec_Types\ | | | | 1111: Codec_x Extension_Block** | | | | follows immediately | +--------------+----------------+------------------------------------+ | Bit 16..18: | **CRC** | 3 CRC bits protecting Bits 2 to 10 | | | | and 12 to 15 | +--------------+----------------+------------------------------------+ | Bit 19..20: | **EX** | The normal 2 bits for IS_Message | | | | Extension. | | | EX == \"0.0\" | | | | | No other extension block follows | | | EX == \"1.1\" | | | | | An other extension block follows | +--------------+----------------+------------------------------------+
### 7.4.2 Definition of the Codec_x Extension_Block
The Codec_x Extension_Block, if present, always follows the SIG_LUC
Extension_Block. It consists of 20 bits, as defined in Table 7.4.2-1. It shall
follow always immediately after the SIG_LUC Extension_Block, if the Codec_Type
field is set to \"1111\".
Table 7.4.2-1: Codec_x Extension_Block
+--------------+-------------------+---------------------------------+ | Bit | Description | Comment | +--------------+-------------------+---------------------------------+ | Bit 1 | \"**0** \" | normal IS-Message Sync Bit, | | | | constant. | +--------------+-------------------+---------------------------------+ | Bit 2 | **Codec_Sel** | Differentiates the Codec_x | | | | Extension_Block\ | | | | **0: U: Used_Codec_Type** is | | | | defined in Codec_Type_x field | | | | | | | | **1: Reserved** | +--------------+-------------------+---------------------------------+ | Bit 3..10 | **Codec_Type_x\ | Identifies the | | | CoID** | Local_Used_Codec_Type, which | | | | is currently used by the sender | | | (long form) | | | | | **0000.0000 ... 1111.1111 | | | | reserved for 255 Codec_Types\ | | | |** 0000.1111 is undefined and | | | | shall not be used. | +--------------+-------------------+---------------------------------+ | Bit 11 | \"**0** \" | normal IS-Message Sync Bit, | | | | constant | +--------------+-------------------+---------------------------------+ | Bit 12.. 15: | \"1010\" | Reserved for future use, set to | | | | \"1010\" to minimise audible | | | | effects | +--------------+-------------------+---------------------------------+ | Bit 16..18: | **CRC** | 3 CRC bits protecting Bits 2 to | | | | 10 and 12 to 15 | +--------------+-------------------+---------------------------------+ | Bit 19..20: | **EX** | The normal 2 bits for | | | | IS_Message Extension. | | | | | | | | 00: No other extension block | | | | follows | | | | | | | | 11: An other extension block | | | | follows | +--------------+-------------------+---------------------------------+
### 7.4.3 Definition of the Codec_List_Extension_Block
The Codec_List Extension_Block is used in a TFO_REQ_L, TFO_ACK_L messages to
list the supported Codec_Types. It consists of 20 bits, as defined in Table
7.4.3-1. The Codec_List must at least contain the Local_Used_Codec_Type. If a
system supports more than 12 Codec_Types, then other Codec_List
Extension_Blocks (Table 7.4.3-2) may follow.
Table 7.4.3-1: Codec_List Extension Block
+--------------+--------------------+--------------------------------+ | Bit | Description | Comment | +--------------+--------------------+--------------------------------+ | Bit 1 | \"**0** \" | Normal IS-Message Sync Bit, | | | | constant. | +--------------+--------------------+--------------------------------+ | Bit 2..10 | **Codec_List_1** | First part of Codec_List. For | | | | each Codec_Type one bit is | | | | reserved.\ | | | | If the bit is set to \"0\" | | | | then the specific Codec_Type | | | | is not supported;\ | | | | if the bit is set to \"1\" | | | | then the specific Codec_Type | | | | could be used. | +--------------+--------------------+--------------------------------+ | Bit 11 | \"**0** \" | Normal IS-Message Sync Bit, | | | | constant | +--------------+--------------------+--------------------------------+ | Bit 12.. 14: | **Codec_List_2** | Second part of the | | | | Codec_List; All three bits | | | | are reserved for future | | | | Codec_Types (up to | | | | Codec_Type 12) | +--------------+--------------------+--------------------------------+ | Bit 15 | **Codec_List_x** | If set to \"1\" a further | | | | Codec_List Extension_Block | | | | follows;\ | | | | otherwise set to \"0\" | +--------------+--------------------+--------------------------------+ | Bit 16..18: | **CRC** | 3 CRC bits protecting Bits 2 | | | | to 10 and 12 to 15 | +--------------+--------------------+--------------------------------+ | Bit 19..20: | **EX** | The normal 2 bits for | | | | IS_Message Extension: | | | | | | | | 00: No other extension block | | | | follows | | | | | | | | 11: An other extension block | | | | follows | +--------------+--------------------+--------------------------------+
Table 7.4.3-2: Further Codec_List Extension Block(s)
+--------------+---------------------+-------------------------------+ | Bit | Description | Comment | +--------------+---------------------+-------------------------------+ | Bit 1 | \"**0** \" | normal IS-Message Sync Bit, | | | | constant. | +--------------+---------------------+-------------------------------+ | Bit 2..10 | **Codec_List_1x** | First part of Codec_List. | | | | For each Codec_Type one bit | | | | is reserved.\ | | | | If the bit is set to \"0\" | | | | then the specific Codec_Type | | | | is not supported;\ | | | | if the bit is set to \"1\" | | | | then the specific Codec_Type | | | | could be used. | | | | | | | | Bit 2: Codec_Type 13 (+ | | | | x*12; x=1..2..3)\ | | | | Bit 4: Codec_Type 14 (+ | | | | x*12; x=1..2..3)\ | | | | and so on | +--------------+---------------------+-------------------------------+ | Bit 11 | \"**0** \" | normal IS-Message Sync Bit, | | | | constant | +--------------+---------------------+-------------------------------+ | Bit 12.. 14: | **Codec_List_2x** | Second part of the | | | | Codec_List; All three bits | | | | are reserved for future | | | | Codec_Types (up to | | | | Codec_Type 24 (+x*12; | | | | x=1..2..3) | +--------------+---------------------+-------------------------------+ | Bit 15 | **Codec_List_xx** | If set to \"1\" a further | | | | Codec_List Extension_Block | | | | follows;\ | | | | otherwise set to \"0\" | +--------------+---------------------+-------------------------------+ | Bit 16..18: | **CRC** | 3 CRC bits protecting Bits 2 | | | | to 10 and 12 to 15 | +--------------+---------------------+-------------------------------+ | Bit 19..20: | **EX** | The normal 2 bits for | | | | IS_Message Extension: | | | | | | | | 00: No other extension block | | | | follows | | | | | | | | 11: An other extension block | | | | follows | +--------------+---------------------+-------------------------------+
### 7.4.4 Definition of the Codec_Attribute_Head Extension_Block
The Codec_Attribute_Head Extension_Block (Table 7.4.4-1) shall precede the
Codec Attribute Extension_Blocks of a Codec_Type, if this Codec_Type needs
additional attributes. This Codec_Attribute_Head identifies the Codec_Type and
the number of additional Extension_Blocks to follow.
Table 7.4.4-1: Codec_Attribute_Head Extension_Block
+--------------+--------------+--------------------------------------+ | Bit | Description | Comment | +--------------+--------------+--------------------------------------+ | Bit 1 | \"**0** \" | normal IS-Message Sync Bit, | | | | constant. | +--------------+--------------+--------------------------------------+ | Bit 2 | **PAR_Sel** | Differentiates this | | | | Extension_Block\ | | | | **0:** Parameters included in | | | | **PAR** field: Simple | | | | Codec_List_Extension\ | | | | **1:** Length Indicator (**LI**) | | | | included: Parameters follow in | | | | subsequent Extension_Blocks | +--------------+--------------+--------------------------------------+ | Bit 3..10 | **CoID** | This field identifies the | | | | Codec_Type for which the subsequent | | | | attributes are valid. The same | | | | coding as in the Codec_x | | | | Extension_Block is used (long form) | +--------------+--------------+--------------------------------------+ | Bit 11 | \"**0** \" | normal IS-Message Sync Bit, constant | +--------------+--------------+--------------------------------------+ | Bit 12.. 15: | **LI / PAR** | If Par_Sel==1: LI: Length | | | | Indicator:\ | | | | 0000: reserved;\ | | | | 0001: one other Extension_Block | | | | follows, etc.\ | | | | If Par_Sel==0: PAR: Codec specific | | | | definition of these four bits | +--------------+--------------+--------------------------------------+ | Bit 16..18: | **CRC** | 3 CRC bits protecting Bits 2 to 10 | | | | and 12 to 15 | +--------------+--------------+--------------------------------------+ | Bit 19..20: | **EX** | The normal 2 bits for IS_Message | | | | Extension: | | | | | | | | 00: No other extension block follows | | | | | | | | 11: An other extension block follows | +--------------+--------------+--------------------------------------+
NOTE: This Extension_Block shall be used for the codecs introduced in the
future that need attributes. It shall precede the Attribute Extension_Blocks.
This allows earlier versions to skip the blocks they do not understand. It
shall not be used for the GSM_FR, GSM_HR and GSM_EFR Codec_Types.
### 7.4.5 Definition of the TFO_Version Extension_Block
The TFO_Version Extension_Block (Table 7.4.5-1) contains the \"TFO_Version\"
(4 bit), the \"TFO_Subversion\" (4 bit) and a \"Selector\" (5bit). The
TFO_Version Extension Block (and the additional Extension_Blocks indicated by
the Selector, if any, see below) shall always be the last of Extension_Blocks
of a TFO_REQ or TFO_REQ_L (or TFO_ACK or TFO_ACK_L) message. This is necessary
to provide compatibility with older versions, which must be able to skip these
Extension_Blocks without being effected negatively.
The TFO_Version and TFO_Subversion are specified in Annex H. A TFO
implementation of Release 5 or onwards shall send this TFO_Version. If it is
omitted then a TFO_Version lower than 5 shall be assumed by the receiving
side.
The Selector is used to indicate the type of extension and the number of
additional extension blocks (if any). The Selector code \"00000\" indicates
that no further extension is followig.
The Selector code \"10101\" is not allowed to provide improved distinction
against the TFO_Header.
#### 7.4.5.1 Selector for Alternative Codecs
If the Selector is set to \"00001\" then this indicates that alternative codec
types are supported, which are specified in additional Extension_Blocks
following the TFO_Version Extension_Block. This Selector shall not be used in
TFO_REQ_L or TFO_ACK_L messages, since equivalent information would then
already be provided in the Codec_List Extension_Block. It shall only be used
in TFO_REQ or TFO_ACK messages to provide information on alternative codec
types in an early stage of the TFO protocol, i.e., before TFO is established.
For each alternative Codec_Type that is offered during TFO negotiation, one
Codec_Attribute_Head Extension_Block shall be included. If the specified
Codec_Type requires additional attributes then the required number of
Codec_Attribute Extension_Blocks follow after the Codec_Attribute_Head
Extension_Block. The list of alternative Codec_Types is terminated when the EX
bits indicate no further Extension_Blocks (00) and the next TFO Message Header
is following.
Table 7.4.5-1: TFO_Version Extension_Block
+--------------+--------------+--------------------------------------+ | Bit | Description | Comment | +--------------+--------------+--------------------------------------+ | Bit 1 | \"**0** \" | normal IS-Message Sync Bit, | | | | constant. | +--------------+--------------+--------------------------------------+ | Bit 2..6 | **Selector** | Indicates if and which further | | | | extension_blocks are following.\ | | | | Coding for bits 2.3.4.5.6: | | | | | | | | 00000: nothing is following after | | | | this TFO_Version\ | | | | 00001: One (or more) alternative | | | | Codec Type(s) is (are) following, | | | | 10101: reserved (used by the | | | | IS_Header)\ | | | | all other codes: reserved for future | | | | use. | +--------------+--------------+--------------------------------------+ | Bit 7..10 | **Ver** | This field contains the TFO_Version | | | | number as specified in Annex H | +--------------+--------------+--------------------------------------+ | Bit 11 | \"**0** \" | normal IS-Message Sync Bit, constant | +--------------+--------------+--------------------------------------+ | Bit 12.. 15: | **Sver** | This field contains the | | | | TFO_Subversion number as specified | | | | in Annex H | +--------------+--------------+--------------------------------------+ | Bit 16..18: | **CRC** | 3 CRC bits protecting Bits 2 to 10 | | | | and 12 to 15 | +--------------+--------------+--------------------------------------+ | Bit 19..20: | **EX** | The normal 2 bits for IS_Message | | | | Extension: | | | | | | | | 00: No other extension block follows | | | | | | | | 11: An other extension block follows | +--------------+--------------+--------------------------------------+
## 7.5 TFO_ACK Messages
**Symbolic Notation:** \ TFO_ACK (Sys_Id, RSig, Local_Used_Codec_Type [,
Used_Codec_Attributes] )\ TFO_ACK_L (Sys_Id, RSig, Local_Used_Codec_Type,
Codec_List [, Alternative_Codec_Attributes] ).
The TFO_ACK Messages conform to the IS_ACK Message, defined in the Annex A,
with IS_System_Identification, followed by the SIG_LUC Extension_Block, and
optionally the Codec_x Extension_Block, the Codec_List Extension_Block(s) and
the Codec_Attribute Extension_Blocks.
TFO_ACK and TFO_REQ Messages differ only in the ACK / REQ Command block and
the construction of the Signature: Local_Signature in case of TFO_REQ,
Reflected_Signature in case of TFO_ACK. All extension blocks defined for the
TFO_REQ are valid as well for TFO_ACK.
The shortest TFO_ACK takes 140 ms for transmission.\ The shortest TFO_ACK_L
takes 180 ms.
## 7.6 TFO_TRANS Messages
**Symbolic Notation:** TFO_TRANS (Channel_Type).
Two TFO_TRANS Messages are defined in conformity to the IS_TRANS Messages in
Annex A.\ For 8 kbit/s submultiplexing the \"**TFO_TRANS (8k)** \" is used and
is identical to \"IS_TRANS_1_u\".\ For 16 kbit/s submultiplexing the
\"**TFO_TRANS (16k)** \" is used and is identical to \"IS_TRANS_2_u\".
For 32 kbit/s submultiplexing the \"**TFO_TRANS (32k)** \" is used and is
identical to \"IS_TRANS_4_u\".
TFO_TRANS() takes 100 ms for transmission.
In most cases the respective TFO_TRANS Message shall be sent twice: once as a
regular TFO Message, exactly before any series of TFO Frames, and once
embedded into the first TFO Frames, see clause 10.
## 7.7 TFO_NORMAL Message
**Symbolic Notation:** TFO_NORMAL.
The TFO_NORMAL Message is identical to the IS_NORMAL Message defined in the
Annex A.
It shall be sent at least once whenever an established Tandem Free Operation
needs to be terminated in a controlled way.
TFO_NORMAL takes 100 ms for transmission.
## 7.8 TFO_FILL Message
**Symbolic Notation:** TFO_FILL.
The TFO_FILL Message is identical to the IS_FILL Message, defined in the Annex
A.
TFO_FILL may be used to pre-synchronise IPEs. Since IS_FILL is one of the
shortest IS Messages, this is the fastest way to synchronise IPEs, without
IPEs swallowing other protocol elements. By default three TFO_FILL messages
shall be sent at the beginning; this number may be, however, configuration
dependent.
One TFO_FILL takes 60 ms for transmission.
## 7.9 TFO_DUP Message
**Symbolic Notation:** TFO_DUP
The TFO_DUP Message is identical to the IS_DUP Message, defined in Annex A.
TFO_DUP informs the distant TFO Partner, that TFO Frames have been received
unexpected, e.g. during Establishment. This enables a fast re-establishment of
TFO after a **_local_** handover.
TFO_DUP takes 60 ms for transmission.
## 7.10 TFO_SYL Message
**Symbolic Notation:** TFO_SYL
The TFO_SYL Message is identical to the IS_SYL Message, defined in Annex A.
TFO_SYL informs the distant TFO Partner, that tandem free operation has
existed, but suddenly no TFO Frames were received anymore. This enables a fast
re-establishment of TFO after a **_distant_** handover.
TFO_SYL takes 60 ms for transmission.
## 7.11 Specification of the TFO Messages
### 7.11.1 Codec_Types
The Codec_Types are defined according to 3GPP TS 26.103, table 6.3-1.
The short form (CoID_s) exists for all Codec_Types with indices below 15 and
consists of the last four bits (LSBs) of the long form (CoID).
### 7.11.2 Codec_List
The Codec_List is defined according to 3GPP TS 26.103. The mapping into the
Codec_List Extension block shall be as follows: bit 1 of octet 1 shall be
placed into Bit 2 of the Codec_List Extension block, and so on until bit 4 of
octet 2 shall be placed into Bit 14.
If more than 12 Codec Types are contained in the Codec_List, then Bit 15 of
the first Codec_List Extension block shall be set to \"1\" and an further
Codec_List Extension block shall be added for the next 12 Codec Types.
### 7.11.3 Codec_Type Attributes
The Codec_Types GSM Full Rate, GSM Half Rate and GSM Enhanced Full Rate do not
need additional attributes. They are fully defined by the
System_Identification (see Annex A.5) and the Codec_Type.
#### 7.11.3.1 AMR Codec_Type Attributes
The Adaptive Multi-Rate Codec_Types (FR_AMR, HR_AMR, UMTS_AMR, UMTS_AMR_2,
OHR_AMR) and the Adaptive Multi-Rate Wideband Codec_Types (FR_AMR-WB,
UMTS_AMR-WB, OFR_AMR-WB, OHR_AMR-WB) need several attributes within the
TFO_REQ and TFO_ACK as well as in the TFO_REQ_L and TFO_ACK_L Messages. For
Con_Req and Con_Ack frames see Annex C.
There are two major kinds of attributes: the ACS (Active Codec Set) and
potentially the SCS (Supported Codec Set). These attributes are signalled
differently for the AMR Codec_Types and AMR-WB Codec_Types, resulting in a
different construction of TFO messages.
The ACS is related to the Local_Used_Codec_Type and is part of the
Used_Codec_Attributes. One and exactly one ACS_Extension_Block shall be sent
in all cases where the Local_Used_Codec_Type is an AMR Codec_Type. In all
cases where the Local_Used_Codec_Type is an AMR-WB Codec_Type the ACS is
signalled within the AMR-WB specific Attribute_Head Extension_Block. In the
former case, the ACS_Extension_Block carries some more parameters, as defined
in the next clause, the most important one is the \"Full_Sub\" flag,
indicating whether or not the full set or a sub-set of the AMR codec modes is
supported. In TFO_REQ and TFO_ACK Messages the ACS shall follow immediately
after the SIG_LUC_Extension_Block. In TFO_REQ_L and TFO_ACK_L Messages an
Attribute_Head_Extension_Block shall follow after the Local_Codec_List,
indicating the Codec_Type it specifies. In the case of an AMR Codec_Type the
corresponding ACS_Extension_Block is following next. In the case of an AMR-WB
Codec_Type no ACS_Extension_Block is following since the ACS is already
defined within the Attribute_Head.
The SCS shall be sent in TFO_REQ or TFO_ACK only if the ACS_Extension_Block
indicates that the sending side does not support the full set of AMR codec
modes, but a subset (Full_Sub flag). In this case the SCS_Extension_Block
shall follow immediately after the ACS_Extension_Block.
NOTE 1: Hence, the TFO_Protocol can decide immediately after the reception of
TFO_REQ or TFO_ACK whether TFO is possible or not, and can report the distant
TFO parameters to the Control Entity in the Network.
One and only one ACS_Extension_Block is included in TFO_REQ_L and TFO_ACK_L,
if the Local_Used_Codec_Type is an AMR Codec_Type. In addition, one
SCS_Extension_Block is needed for each AMR Codec_Type flagged in the
Local_Codec_List. In that case an Attribute_Head_Extension_Block shall follow
after the Local_Codec_List, indicating the Codec_Type it specifies, followed
by the corresponding SCS_Extension_Block. If multiple AMR_Codec_Types are
flagged, then multiple Attribute_Heads and SCS_Extension_Blocks may be needed.
If the TFO_Version Extention_Block is not included, and if the full set of AMR
Codec Modes is supported, then neither the Attribute_Head nor the
SCS_Extension_Block shall be sent for the alternative Codec_Type(s).\ If,
however, the TFO_Version Extension_Block is included at the end of the
TFO_REQ_L or TFO_ACK_L, then the Attribute_Head and potentially (if PAR_Sel is
set to \"1\") the SCS_Extension_Block shall be sent for each alternative AMR
Codec_Type.
For each AMR-WB Codec_Type flaged in the Local_Codec_List, one Attribute_Head
Extension_Block shall follow after the Local_Codec_List. Since the AMR-WB
specific Attribute_Head fully defines the SCS no further SCS Extension_Block
is following.
The following figures give the examples for the full-set AMR TFO Messages.
Note that an additional TFO_Version Extension_Block shall follow if the TFO
version is equal or greater than 5.
{width="3.998611111111111in" height="0.8173611111111111in"}
> Figure 7.11.3.1-1: Construction of the shortest possible TFO_REQ Message for
> any AMR Codec Type
TFO_ACK follows the same construction. Both have a length of 180ms.
{width="6.481944444444444in" height="0.8854166666666666in"}
> Figure 7.11.3.1-2: Construction of the shortest possible TFO_REQ_L Message
> listing an AMR Codec_Type in the Codec_List
TFO_ACK_L follows the same construction. Both have a length of 260ms.
NOTE 2: In TFO_REQ_L (TFO_ACK_L) at least one Attribute_Head is needed, if the
Local_Used_Codec_Type is an AMR Codec_Type, because otherwise a TFO partner
that does not know the Local_Used_Codec_Type cannot know how many attributes
are needed -- if any. Since these longer messages are used only when mismatch
is identified or in other situations, where protocol speed is not important,
this additional 40ms message length is not important.
For example, assume that the Local_Used_Codec_Type is FR_AMR and the supported
codecs which are flagged in the Codec_List are FR_AMR, HR_AMR, and FR_AMR-WB.
Then, if neither FR_AMR nor HR_AMR support the full set of AMR modes, the
following six Extension_Blocks follow the Codec_List: Atrib_Head(FR_AMR) --
ACS(FR_AMR) -- SCS(FR_AMR) -- Atrib_Head(HR_AMR) -- SCS(HR_AMR) --
Atrib_Head(FR_AMR-WB).
##### 7.11.3.1.1 AMR Active_Codec_Set Attributes
One AMR_ACS Extension_Block shall be added in the TFO_REQ and TFO_ACK messages
after the SIG_LUC Extension_Block if an AMR Codec_Type is used as the
Local_Used_Codec_Type.
Table 7.11.3.1.1-1: AMR_ACS Extension_Block
+-------------+----------------------+--------------------------+ | Bit | Description | Comment | +-------------+----------------------+--------------------------+ | Bit 1 | \"**0** \" | Normal IS-Message Sync | | | | Bit, constant. | +-------------+----------------------+--------------------------+ | Bit 2..9 | **Active Codec Set** | Active Codec Set: For | | | | each Codec_Mode of the | | | **(NB_ACS)** | AMR one bit is reserved. | | | | If the bit is set to | | | | \"0\" then the specific | | | | Codec_Mode is not in | | | | the ACS, otherwise it is | | | | in and may be used by | | | | the adaptation | | | | algorithm.\ | | | | Bit 2: AMR_Mode 12,2 | | | | kbit/s (undefined for | | | | HR_AMR)\ | | | | Bit 3: AMR_Mode 10,2 | | | | kbit/s (undefined for | | | | HR_AMR) | | | | | | | | Bit 4: AMR_Mode 7,95 | | | | kbit/s | | | | | | | | Bit 5: AMR_Mode 7,40 | | | | kbit/s | | | | | | | | Bit 6: AMR_Mode 6,70 | | | | kbit/s | | | | | | | | Bit 7: AMR_Mode 5,90 | | | | kbit/s | | | | | | | | Bit 8: AMR_Mode 5,15 | | | | kbit/s | | | | | | | | Bit 9: AMR_Mode 4,75 | | | | kbit/s | +-------------+----------------------+--------------------------+ | Bit 10 | **Full_Sub\ | 0:** F**ull Set | | | (NB_F/S)** | supported, NB_SCS is | | | | not following | | | | | | | | 1: **S** ubset only | | | | supported, NB_SCS is | | | | following immediately | +-------------+----------------------+--------------------------+ | Bit 11 | \"**0** \" | Normal IS-Message Sync | | | | Bit, constant | +-------------+----------------------+--------------------------+ | Bit 12 | spare | set to \"1\" | +-------------+----------------------+--------------------------+ | Bit 13 | **Optimisation Mode\ | ACS Optimisation Mode | | | (NB_OM)\ | | | | ** | 0 No ACS Change | | | | supported | | | | | | | | 1 ACS change supported | +-------------+----------------------+--------------------------+ | Bit 14 & 15 | **NB_Ver**|** Ver**sion Number of | | | | the AMR-NB TFO Scheme | | | | | | | | Bit 15 is equivalent to | | | | the ATVN in | | | | Configuration Frames, | | | | see Annex C | +-------------+----------------------+--------------------------+ | Bit 16..18 |** CRC**| 3 CRC bits protecting | | | | Bits 2 to 10 and 12 to | | | | 15 | +-------------+----------------------+--------------------------+ | Bit 19..20: |** EX** | The normal 2 bits for | | | | IS_Message Extension: | | | | | | | | 00: No other extension | | | | block follows | | | | | | | | 11: An other extension | | | | block follows (i.e. SCS) | +-------------+----------------------+--------------------------+
##### 7.11.3.1.2 AMR Supported_Codec_Set Attributes
The AMR_SCS Extension_Block contains the information on the AMR Supported
Codec Set. It shall be omitted, if the full set is supported. Table
7.11.3.1.2-1 gives the description of the SCS Extension_Block.
For the Local_Used_Codec_Type the SCS Extension_Block shall follow immediately
after the corresponding ACS Extension_Block. In that case the Full_Sub flag
shall be set within the ACS Extension_Block. For alternative Codec_Types, as
flagged in the Local_Codec_List, the SCS shall follow immediately after the
corresponding Attribute_Head Extension_Block.
NOTE: The VERsion numbers in ACS and SCS Extension_Blocks shall be identical
for one Codec_Type, but may be different for different Codec_Types (e.g.
FR_AMR and HR_AMR).
Table 7.11.3.1.2-1: AMR_SCS Extension_Block
+-------------+------------------------+--------------------------+ | Bit | Description | Comment | +-------------+------------------------+--------------------------+ | Bit 1 | \"**0** \" | Normal IS-Message Sync | | | | Bit, constant. | +-------------+------------------------+--------------------------+ | Bit 2...9 | **Supported Codec Set\ | Supported Codec Set: For | | | (NB_SCS)** | each Codec_Mode of the | | | | AMR one bit is reserved. | | | | If the bit is set to | | | | \"0\" then the specific | | | | Codec_Mode is not | | | | supported; if the bit is | | | | set to \"1\" then the | | | | specific Codec_Mode is | | | | supported and may be | | | | considered for the | | | | optimisation of the | | | | common ACS. | | | | | | | | Bit 2: AMR_Mode 12,2 | | | | kbit/s (undefined in | | | | SCS(H))\ | | | | Bit 3: AMR_Mode 10,2 | | | | kbit/s (undefined in | | | | SCS(H)) | | | | | | | | Bit 4: AMR_Mode 7,95 | | | | kbit/s | | | | | | | | Bit 5: AMR_Mode 7,4 | | | | kbit/s | | | | | | | | Bit 6: AMR_Mode 6,7 | | | | kbit/s | | | | | | | | Bit 7: AMR_Mode 5,9 | | | | kbit/s | | | | | | | | Bit 8: AMR_Mode 5,15 | | | | kbit/s\ | | | | Bit 9: AMR_Mode 4,75 | | | | kbit/s | +-------------+------------------------+--------------------------+ | Bit 10 | **NB_MACS MSB** | See comment for Bit | | | | 12...13 | +-------------+------------------------+--------------------------+ | Bit 11 | \"**0** \" | normal IS-Message Sync | | | | Bit, constant | +-------------+------------------------+--------------------------+ | Bit 12...13 | **NB_MACS LSBs** | The maximally supported | | | | number of Codec_Modes | | | | in this radio leg. | | | | Coding for bits | | | | 10.12.13: | | | | | | | | \"0.0.1\" 1 Mode | | | | | | | | \"0.1.0\" 2 Modes | | | | | | | | \"0.1.1\" 3 Modes | | | | | | | | \"1.0.0\" 4 Modes | | | | | | | | \"1.0.1\" 5 Modes | | | | | | | | \"1.1.0\" 6 Modes | | | | | | | | \"1.1.1\" 7 Modes | | | | | | | | \"0.0.0\" 8 Modes | +-------------+------------------------+--------------------------+ | Bit 14...15 | **NB_Ver** | Version Number of the | | | | AMR TFO Scheme for that | | | | Codec_Type | | | | | | | | Bit 15 is equivalent to | | | | the ATVN in | | | | Configuration Frames, | | | | see Annex C | +-------------+------------------------+--------------------------+ | Bit 16..18 | **CRC** | 3 CRC bits protecting | | | | Bits 2 to 10 and 12 to | | | | 15 | +-------------+------------------------+--------------------------+ | Bit 19 20 | **EX** | The normal 2 bits for | | | | IS_Message Extension: | | | | | | | | 00: No other extension | | | | block follows | | | | | | | | 11: An other extension | | | | block follows | +-------------+------------------------+--------------------------+
##### 7.11.3.1.3 AMR specific Codec_Attribute_Head Extension_Block
The AMR specific Codec_Attribute_Head Extension_Block (Table 7.11.3.1.3-1)
shall precede the Codec Attribute Extension_Blocks of any AMR Codec_Type.
Table 7.11.3.1.3-1: AMR specific Codec_Attribute_Head Extension_Block
+--------------+----------------+------------------------------------+ | Bit | Description | Comment | +--------------+----------------+------------------------------------+ | Bit 1 | \"**0** \" | normal IS-Message Sync Bit, | | | | constant. | +--------------+----------------+------------------------------------+ | Bit 2 | **PAR_Sel** | Differentiates this | | | | Extension_Block\ | | | | **0:** Parameters included in | | | | **PAR** field: Simple | | | | Codec_List_Extension\ | | | | **1:** Length Indicator (**LI**) | | | | included: Parameters follow in | | | | subsequent Extension_Blocks | +--------------+----------------+------------------------------------+ | Bit 3..10 | **CoID =\ | This field identifies the AMR | | | HR_AMR or\ | Codec_Type for which the | | | FR_AMR or\ | subsequent attributes are valid. | | | UMTS_AMR or\ | The same coding as in the Codec_x | | | UMTS_AMR2 or\ | Extension_Block is used (long | | | OHR_AMR** | form) | +--------------+----------------+------------------------------------+ | Bit 11 | \"**0** \" | normal IS-Message Sync Bit, | | | | constant | +--------------+----------------+------------------------------------+ | Bit 12.. 15: | **LI / PAR** | If Par_Sel==1: LI: Length | | | | Indicator:\ | | | | 0000: reserved;\ | | | | 0001: one other Extension_Block | | | | follows, etc.\ | | | | If Par_Sel==0: PAR: Codec | | | | specific definition of these four | | | | bits | +--------------+----------------+------------------------------------+ | Bit 16..18: | **CRC** | 3 CRC bits protecting Bits 2 to 10 | | | | and 12 to 15 | +--------------+----------------+------------------------------------+ | Bit 19..20: | **EX** | The normal 2 bits for IS_Message | | | | Extension: | | | | | | | | 00: No other extension block | | | | follows | | | | | | | | 11: An other extension block | | | | follows | +--------------+----------------+------------------------------------+
If PAR_Sel is set to \"1\" then the AMR_ACS and potentially AMR_SCS is/are
following.\ The option \"Par_Sel=0\" and the corresponding configuration codes
can only be used in TFO Version 5 and onwards. A Pre-REL-5 implementation does
not understand it and shall ignore it.
If PAR_Sel is set to \"0\", then one of 16 possible AMR Configurations is
indicated in the\ PAR field and no additional Codec Attribute Extension_Blocks
do follow.\ The coding for PAR (bits 12.13.14.15) is defined in Table
7.11.3.1.3-2 (Config-NB-Code):
Table 7.11.3.1.3-2: Preferred Configurations for the Adaptive Multi-Rate Codec
Types
* * *
**Configuration →\** \ **\** \ **\** \ **\** \ **\** \ **\** \ **\** \ **\** \
**\ (Config-NB-Code)\ 0** 1**2** 3**4** 5**6** 7**8** 9**10** 11**12**
13**14** 15**↓ Codec Mode**
**12,20** **(1)** **1** **1** **1**
**10,20** **1** **1** **1**
**7,95** **1** **1** **1**
**7,40** **1** **1** **1** **1**
**6,70** **1** **1** **1** **1** **1** **1**
**5,90** **1** **1** **1** **1** **1** **1** **1** **1** **1** **1**
**5,15**
**4,75** **1** **1** **1** **1** **1** **1** **1** **1** **1** **1**
**OM** **F** **F** **F** **F** **F** **F** **F** **F** **F** **F** **F** **A**
**F** **A** **F** **A**
**HR_AMR** **Y** **Y** **Y** **Y** **Y** **Y** **Y** **Y** **Y**
**FR_AMR, OHR_AMR,\** \ **\** \ **\** \ **\** \ **\** \ **\** \ **\** \ **\**
\ **\ UMTS_AMR,\ Y** Y**Y** Y**Y** Y**Y** Y**Y** Y**Y** Y**Y** Y**Y**
Y**UMTS_AMR_2**
* * *
The \"1\" in the table indicates that the Codec Mode is included in the Active
Codec Set of the Configuration.
The parameter \"OM\" (Optimisation Mode) defines whether the indicated
Configuration can be changed to any of the other [A]{.underline}llowed ones
(OM == A) or if the change is [F]{.underline}orbidden (OM == F). For the three
\"A\" configurations (11, 13 and 15) the TFO Decision algorithm shall consider
the SCS {1, 1, 1, 1, 1, 1, 0, 1}, i.e. all AMR modes except the 5.15 kbps
shall be treated as supported and the OM shall be assumed to be \"Optimisation
of the ACS supported\". For the other \"F\" configurations the ACS and SCS
shall be assumed to be identical and as shown in the configuration table. The
OM shall be assumed to be \"Optimisation of the ACS not supported\".
**Note:** If one TFO Partner uses this short form to offer one of these three
Preferred Configurations that allow a change of the configuration (i.e. offers
Config-NB-codes 11, 13 or 15) and the other TFO Partner uses the long form to
offer a configurations (i.e. with ACS, SCS, OM and MACS), then it might happen
that the TFO Decision determines a common configuration that is
[not]{.underline} within the set of these 16 Preferred Configurations.
A change via Maximum Rate Control is always possible (e.g. from configurations
10, 11, 12, 13, 14, 15 to 9 and 8).
The \"Y\" in the table indicates, which Configuration is defined for which
Codec Type.
Among these 16 preferred AMR Configurations is one with specific importance
for calls between GERAN and UTRAN: \"Config-NB-Code = 1\", with modes 12.2,
7.4, 5.9, 4.75. This Configuration is especially recommended, because it leads
in all call cases to TFO/TrFO compatible connections with optimal voice
quality.
In case this Configuration \"Config-NB-Code = 1\" is signalled in the TFO
Negotiation for the HR_AMR Codec Type, then it shall be assumed that AMR mode
12.2 kbps is (of course) not included. For all other AMR Codec Types all four
modes are included.
##### 7.11.3.1.4 AMR-WB specific Codec_Attribute_Head Extension_Block
The AMR-WB specific Codec_Attribute_Head Extension_Block is defined in Table
7.11.3.1.4-1.
Table 7.11.3.1.4-1: AMR-WB specific Codec_Attribute_Head Extension_Block
+--------------+------------------+----------------------------------+ | Bit | Description | Comment | +--------------+------------------+----------------------------------+ | Bit 1 | \"**0** \" | normal IS-Message Sync Bit, | | | | constant. | +--------------+------------------+----------------------------------+ | Bit 2 | **PAR_Sel** | Differentiates this | | | | Extension_Block\ | | | | **0:** Parameters included in | | | | **PAR** field: Simple | | | | Codec_List_Extension\ | | | | **1:** undefined | +--------------+------------------+----------------------------------+ | Bit 3..10 | **CoID =\ | This field identifies the AMR-WB | | | FR_AMR-WB or\ | Codec_Type for which the | | | UMTS_AMR-WB or\ | subsequent attributes are valid. | | | OHR_AMR-WB or\ | The same coding as in the | | | OFR_AMR-WB** | Codec_x Extension_Block is | | | | used (long form) | +--------------+------------------+----------------------------------+ | Bit 11 | \"**0** \" | normal IS-Message Sync Bit, | | | | constant | +--------------+------------------+----------------------------------+ | Bit 12.. 15: | **PAR** | AMR-WB configuration as defined | | | | in TS 26.103, table 5.7-1\ | | | | (Config-WB-Code) | +--------------+------------------+----------------------------------+ | Bit 16..18: | **CRC** | 3 CRC bits protecting Bits 2 to | | | | 10 and 12 to 15 | +--------------+------------------+----------------------------------+ | Bit 19..20: | **EX** | The normal 2 bits for | | | | IS_Message Extension: | | | | | | | | 00: No other extension block | | | | follows | | | | | | | | 11: An other extension block | | | | follows | +--------------+------------------+----------------------------------+
# 8 Time Alignment of TFO Frames and TFO Messages
## 8.1 Alignment of TFO Frames and TFO Messages for GSM
The relative TRAU Frame phase positions of the two TRAUs using TFO across the
A interface are arbitrary and depend on the local timing structure of the
relevant BTSs. These BTSs are typically not synchronised. The TFO Protocol can
not and does not change this. The clock systems of the transmission channels
are typically also not synchronised and octet slips may occur.
TFO Frames and embedded TFO Messages are always exactly aligned with each
other and follow the uplink TRAU Frames with a small, negligible, constant
delay (Tultfo: some PCM samples).
For the Codec Types GSM_FR, GSM_HR and GSM_EFR the time alignment procedures
for the **downlink** TRAU Frames, as specified in 3GPP TS 48.060 (full rate
traffic) and 3GPP TS 48.061 (half rate traffic) on the Abis/Ater interface,
are not affected by the TFO procedures on the A interface. For these Codec
Types the TRAU shall buffer the received TFO Frames until they fit into the
downlink timing as commanded by the local BTS.
For the Codec Types FR_AMR, HR_AMR and FR_AMR-WB the phase of the downlink
TRAU Frame depends on the phase of the received TFO Frames. An AMR/AMR-WB TRAU
does not follow the Time Alignment procedure, when TFO is established, but
sends the received TFO Frames as soon as possible in downlink as TRAU Frames.
Therefor the local BTS has to buffer the TRAU Frames accordingly until they
fit for the transmission on the air interface.
### 8.1.1 Time Alignment of TFO Messages in GSM
At start up of the TFO Protocol the first regular TFO Message is aligned to an
uplink TRAU Frame in the same way as a TFO Frame or an embedded TFO Message
would be aligned (see clause 8.1.2). Then, after that, all regular TFO
Messages follow contiguously, without any phase shift in time alignment, until
the first TFO Frame needs to be sent (in general after the TFO_TRANS Message).
Then, the required number of T_Bits is inserted before the first TFO Frame,
see clause 8.1.2. Consequently, all following embedded TFO Messages are always
aligned with the TFO Frames in a way, that the first bit of any TFO Messages
is placed into the LSB of the first sample of a TFO Frame. Due to this
definition, embedded TFO Messages only modify some of the synchronisation bits
of the TFO Frames and the EMBED bit.
### 8.1.2 Time Alignment of TFO Frames to Uplink TRAU Frames
The contents of the Uplink TRAU Frame, received from the BTS via the Abis/Ater
Interface, undergo the small, constant delay (Tultfo) required to perform the
modifications of the EMBED, Sync and potentially CRC bits, before being
forwarded to the other TRAU over the A Interface as TFO Frame. Since this
delay is substantially smaller than the delay for the decoded speech signal,
the TFO Frames precede the corresponding speech samples. Figure 8.1.2-1 shows
the relations. Note that no exact delay value for Tultfo is defined or need to
be defined.
{width="4.385416666666667in" height="2.0104166666666665in"}
Figure 8.1.2-1: Uplink TFO Frame Time Alignment in GSM
In case of AMR-WB with Codec Modes higher than 12.65 kbit/s the lower main 16k
part defines synchronisation and control bits, while the upper 16k extension
carries only data bits. It is important that these lower and upper part are
exactly synchronised to each other on the A-interface. If this is not already
the case on the uplink Abis/Ater interface, then the TRAU shall delay the
earlier arriving part to achieve the synchronisation.
On the transition between the sending of [regular]{.underline} TFO Messages
and the first TFO Frame, a sufficient number (up to a maximum of 159) of Time
Alignment Bits, also called \"T_Bits\", are inserted into the LSBs of the PCM
samples to align the TFO Frame as described above.
This insertion of Time Alignment Bits (if necessary) is started exactly with
the 16^th^ PCM sample after the last bit of the last regular TFO Message (i.e.
the TFO_TRANS Message).
Whenever, in a later stage, the phase of the uplink TRAU Frame changes, then
again T_Bits need to be inserted between two consecutive TFO Frames or deleted
from the tail of the last TFO Frame to ensure proper alignment.
The insertion of T_Bits as a result of timing changes shall occur
**_between_** TFO Frames and not within TFO Frames.
If the time alignment is necessary while a TFO Message is embedded into a
series of TFO Frames, then the TFO Message may be cut into two parts with the
T_Bits in between. Therefore, whenever an adjustment of the phase of the TFO
Frames is necessary, then one additional TFO Message shall be embedded into
the next TFO Frames (after the possibly ongoing TFO Message). If nothing else
is to be transmitted, then the TFO_FILL Message shall be used. One TFO_TRANS
Message is **_always_** embedded into the first TFO Frames. See the following
Figure 8.1.2-2:
{width="7.319444444444445in" height="1.7513888888888889in"}
Figure 8.1.2-2: Time Alignment by inserting T_Bits and embedding one TFO_TRANS
Message
### 8.1.3 Time Alignment of TFO Frames to Downlink TRAU Frames
For the Codec Types GSM_FR, GSM_HR and GSM_EFR the TFO Protocol does not
affect the phase position of the downlink TRAU frames.
The phase difference between the received TFO Frames and the downlink TRAU
Frames is in general constant, but arbitrary between 0 and 159 PCM samples.
The time alignment of the TFO Frames to the downlink TRAU Frames must
therefore be managed by buffering the TFO Frames within the receiving downlink
TRAU. This can be done in one of two methods:
**Method 1** : The received TFO Frame is buffered for a period between 0 to
159 PCM samples in addition to the processing delay _(Tbfh)_ required _to
perform a suitable Bad Frame Handling on parameter level._ Transmission of the
downlink TRAU Frame may in this case begin **_prior_** to receipt of the
complete TFO Frame.
NOTE 1: In this first method the overall one way signal delay will be between
_30 ms and 10 ms lower than the delay_ in normal tandem connections.
**Method 2:** Alternatively the received TFO Frame is buffered for a period
between 160 to 319 PCM samples in addition to the processing delay required
_to perform a suitable Bad Frame Handling on parameter level (Tbfh)._
Transmission of the downlink TRAU Frame will in this case always begin
**_after_** the receipt of the complete TFO Frame.
NOTE 2: In this second method the overall one way signal delay will always _be
up to 10ms lower or up to 10 ms higher_ than the delay in normal tandem
connections.
NOTE 3: The two methods differ in one way signal delay always by exactly 20
ms. Figure 8.1.3-1 highlights the relations for an arbitrarily selected
relative phase difference between TFO and TRAU Frames of 80 samples (10 ms).
_Tbfh is in the order of some PCM samples only, if error concealment is done
\"in advance\" based on the parameters of the previous TFO Frame, before the
actual TFO Frame is even received._
{width="5.03125in" height="2.566666666666667in"}
Figure 8.1.3-1: Downlink Time Alignment of TFO Frames in GSM
For the Codec Types FR_AMR, HR_AMR and FR_AMR-WB no error concealment is
necessary within the downlink TRAU. The received TFO Frames are passed as soon
as possible downlink as TRAU Frames, without considering the previous phase of
the TRAU Frames.
**[General:]{.underline}** TRAU Frames shall always be sent as complete TRAU
Frames.
The transition from normal Tandem Operation to Tandem Free Operation shall be
done by inserting the necessary number of T-Bits [between]{.underline} the
previous - time aligned TRAU Frame - and the new - TFO aligned TRAU Frame. By
this the BTS does not loose synchronisation. The signal delay within the TRAU
is kept at minimum. The BTS has to buffer the received TRAU Frames until they
fit for transmission on the air interface. Time Alignment and phase alignment
are discontinued as long as the BTS is in States TFO_MAYBE, TFO_YES or
TFO_TERM, see Annex C.
In case TFO is terminated the transition from TFO aligned TRAU Frames back to
time aligned TRAU Frames shall be done in the following way: The first TRAU
Frames after TFO is terminated shall be sent in exactly the same phase as the
TFO aligned TRAU Frames. Then the BTS will re-start the time alignment
procedure and command time and phase alignments. Then the necessary number of
T-Bits shall be inserted [between]{.underline} the TFO aligned TRAU Frames and
the time aligned TRAU Frames.
## 8.2 Time Alignment of TFO Frames and TFO Messages for 3G
There is no requirement for the Time Alignment of TFO Frames and the Iu User
Plane. However, all implementation should minimise the transmission delay
between Iu User Plane PDUs and TFO Frames in the uplink and the downlink
directions.
TFO Frames and embedded TFO Messages shall always be exactly aligned with each
other and follow the uplink with minimal delay.
### 8.2.1 Time Alignment of TFO Messages in 3G
At start up of the TFO Protocol the first regular TFO Message is aligned to
the uplink Iu frames in the same way as a TFO Frame or an embedded TFO Message
would be aligned (see clause 8.2.2). Subsequently, all regular TFO Messages
follow contiguously, without any phase shift in time alignment, until the
first TFO Frame needs to be sent (in general after the TFO_TRANS Message).
Then, the required number of T_Bits is inserted before the first TFO Frame,
see clause 8.2.2.
Consequently, all following embedded TFO Messages are always aligned with the
TFO Frames in a way, that the first bit of any TFO Messages is placed into the
LSB of the first sample of a TFO Frame. Due to this definition, embedded TFO
Messages only affect some of the synchronisation bits of the TFO Frames and
the EMBED bit.
### 8.2.2 Time Alignment of TFO Frames to Uplink Iu Frames
The contents of the Uplink Iu User Plane PDU undergo a variable delay (Tultfo)
required to perform the generation of the necessary framing bits (control and
Sync) and also to ensure the continuous flow of TFO Frames. It is important
that this is optimised to remove the jitter from the uplink Iu frame reception
to ensure a constant and continuous play-out of TFO Frames to the distant
partner.
On the transition between the sending of regular TFO Messages and the first
TFO Frame, a sufficient number (up to a maximum of 159) of Time Alignment
Bits, also called \"T_Bits\", are inserted into the LSBs of the PCM samples to
align the TFO Frame as described above.
This insertion of Time Alignment Bits (if necessary) is started exactly with
the 16^th^ PCM sample after the last bit of the last regular TFO Message (i.e.
the TFO_TRANS Message).
Whenever, in a later stage, it is necessary to alter the play-out timing, then
again T_Bits need to be inserted **_between_** two consecutive TFO Frames or
deleted from the tail of the last TFO Frame to ensure proper alignment.
If the adjustment is necessary while a TFO Message is embedded into a series
of TFO Frames, then the TFO Message may be cut into two parts with the T_Bits
in between. Therefore, whenever an adjustment of the phase of the TFO Frames
is necessary, then one additional TFO Message shall be embedded into the next
TFO Frames (after the possibly on-going TFO Message). If nothing else is to be
transmitted, then the TFO_Fill Message shall be used. One TFO_TRANS Message is
**_always_** embedded into the first TFO Frames.
### 8.2.3 Time Alignment of TFO Frames to Downlink Iu Frames
The Transcoder should wait for the complete reception of a TFO Frame and send
a corresponding Iu UP PDU with the minimum buffering delay to perform the
required conversion between TFO Frames and Iu UP Frames as defined in clause
5.
# 9 TFO State Machine
A State Machine, consisting of 17 States can describe the TFO_Protocol
Process, see the following figure.
Figure 9-1: TFO_Protocol State Machine with most important transitions
There are five main States:
\- Initialisation (• Not_Active, • Wakeup)
\- Establishment (• First_Try, • Continuous_Retry, • Periodic_Retry, •
Monitor, • Mismatch)
\- Contact (• Contact)
\- Preparation (• Wait_RC, • Konnect)
\- Operation (• Operation)
Exception handling needs further States (see figure 9-1):
\- Local Handover (• Fast_Try, • Fast_Contact).
\- Distant Handover (• Sync_Lost, • Re_Konnect).
\- Misbehaviour (• Failure).
\- Termination (• TFO_Term).
It is assumed that Events (Conditions checking), Actions and Transitions to
another State are handled almost instantaneous and in any case significantly
faster than the time required to complete the transmission of any TFO Message
or TFO Frame.
## 9.1 Initialisation
### 9.1.1 Not_Active State
The Not_Active state shall be the initial state of the TFO_Protocol. In this
state the TFO_Protocol is not active and the TRAU/TC works in a conventional
way. The state Not_Active is left and a transition to the Wakeup state is
performed when a new speech call is set up or/and when TFO gets enabled.
### 9.1.2 Wakeup State
In the Wakeup state the TFO_Protocol waits until PCM speech samples are
received that are different from PCM_Idle. Then a transition to the First_Try
state is performed and three TFO_FILL messages and some TFO_REQ messages are
initiated.
**Option:** The number of TFO_REQ messages may be adapted to achieve a longer
time before the Runout occurs in First_Try. The default value is 35 TFO_REQ
Messages (about 5 seconds). This may be extended to 7*35 TFO_REQ Messages
(about 35 seconds), or any other value resulting in a timeout longer than the
usual \"not reachable\" timer.
## 9.2 Establishment
### 9.2.1 First_Try State
The TC enters the First_Try state from the Wakeup state if TFO was enabled and
PCM_Non_Idle speech samples are received. Regular TFO_REQ Messages are sent
continuously for a certain maximum time. After that, if no TFO Partner answers
before a Runout of TFO Messages, TFO_Protocol enters automatically into the
Monitor State.
If TFO_REQ Messages are received with the same, own Signature, then a circuit
loop back is assumed, i.e. the call is still not through connected. The TC
selects a new Signature and continues sending TFO_REQ Messages, until a
different Signature is received or a TFO_ACK is received. Since loop back
delays may be substantial in some cases, the TC has to remember and compare
also the previously selected own Signature. Care must be taken that the
Signature selection contains a true random element to avoid that two different
TCs select by coincidence identical signatures again and again.
When the TC receives a TFO_REQ with an appropriate signature and TFO is
possible, it enters the Contact State.
If the TC receives a TFO_ACK to a previously sent TFO_REQ, TFO_Protocol enters
the Mismatch State, if immediate TFO establishment is not possible.
If immediate TFO establishment is possible, TFO_Protocol enters directly the
Konnect State in the case of Non_AMR Codec Types. If immediate TFO
establishment is possible in case of an AMR or AMR-WB Codec Type, the
TFO_Protocol enters the Wait_RC State, before it goes on to the Konnect State.
If the TC receives TFO Frames in the First_Try State, it should assume that a
TFO might have been established previously and was recently broken because of
a local handover. The TC should then enter the Fast_Try State.
### 9.2.2 Continuous_Retry State
In this state, TFO Contact has existed either by TFO Messages or by TFO
Frames, but was interrupted and sync was lost. The TC sends a maximum number
of regular TFO_REQ Messages continuously in order to test, if TFO could be re-
established. In case of Runout of TFO messages, the TFO_Protocol enters the
Periodic_Retry State.
### 9.2.3 Periodic_Retry State
The Periodic_Retry state is typically entered from Continuous_Retry in the
case of Runout of TFO messages. The TFO_Protocol tests from time to time by
sending a single TFO_REQ_L message, if TFO could be re-established. As soon as
a TFO Message is received, TFO_Protocol leaves this State.
NOTE: Since no contiguous transmission of TFO Messages is ongoing, possible
IPEs may be unsynchronised.
### 9.2.4 Monitor State
In this state the TC monitors the PCM samples for TFO messages or TFO Frames,
but it does not send any TFO messages or TFO frames. As soon as a TFO message
has been received from a distant partner, the TC knows that a TFO Partner
exists. Moreover, it knows that the transmission path from the distant partner
is digitally transparent. The TC may already now see, whether TFO is possible,
but it must ensure that all IPEs are synchronised. It therefore transits into
the Continuous_Retry state. If no TFO is possible, the TFO_Protocol informs
its local BSS/RAN and transits into the Mismatch state by sending back
TFO_REQ_L messages.
**Option:** The incoming PCM stream may be searched in the Monitor state for
the occurrence of any PCM pattern that is constant for at least 500ms. If such
a long constant pattern is detected, then a transition back into Wakeup may be
performed to re-trigger the TFO Negotiation. This search need not be performed
longer than 30 seconds after entering the Monitor state.
NOTE: Since no contiguous transmission of TFO Messages is ongoing, possible
IPEs may be unsynchronised.
### 9.2.5 Mismatch State
In this state it is obvious from a previous contact that a distant TFO Partner
exists, but TFO establishment was not possible because of incompatible codec
types or codec configurations. The TC waits without sending TFO messages or
TFO frames until the mismatch situation is resolved.
NOTE: Since no contiguous transmission of TFO Messages is ongoing, possible
IPEs may be unsynchronised.
## 9.3 Contact State
In this state the TFO_Protocol knows that there is a distant TFO Partner,
which has sent TFO_REQ. The Codecs do match and the ACSs are compatible, or
Immediate Codec Type Optimisation is possible (see below). The link from the
distant partner is transparent. Now TFO_ACK need to be sent to check the
transparency of the link to the distant partner.
After the exchange of TFO_REQ and/or TFO_ACK messages, it may become obvious
that a preferred TFO configuration is possible when changing the codec type at
the local and/or the distant side. For example, this is the case when both
sides support AMR-WB but one side is currently using AMR-NB (in this case,
Immediate Codec Type Optimisation is an alternative to Codec Mismatch
Resolution). In this case, the TFO protocol stays in the Contact state and
performs an Immediate Codec Type Optimization (see 11.7). After the codecs
have been changed, the normal protocol flow continues.
As soon as a TFO_ACK or TFO_TRANS from a distant partner has been received,
the TC knows that the links in both directions are digitally transparent. In
the case of a Non_AMR Codec Type the TC sends TFO_TRANS to bypass the IPEs and
starts sending TFO Frames, and the TFO_Protocol transits into Konnect State.
In the case of an AMR or AMR-WB Codec Type the TC sends a Rate Control Command
downlink to its BTS/RNC in order to steer the uplink Codec Mode down to the
TFO_Setup_Mode for a safe TFO Setup. Additionally, TFO_ACK is sent to the
distant TFO Partner and the TFO_Protocol transits into the Wait_RC State.
## 9.4 Preparation
### 9.4.1 Wait_RC State
This State exists only when the local used Codec Type is an AMR or AMR-WB
Codec. For all other Codec Types this State is not entered and all transitions
go instead directly into Konnect State.
The state WAIT_RC is typically entered when a TFO_ACK message is received in
Contact State. Rate control is done. In GSM, a TFO_Soon message is sent to the
BTS. In 3G a Rate Control command is sent to the RNC.
In this Wait_RC State the TFO_Protocol waits for the acknowledgement from the
BTS / RNC that the Rate Control Command has been received and executed. Then
the TC sends TFO_TRANS to bypass the IPEs, starts sending TFO Frames and
TFO_Protocol transits into the Konnect State.
### 9.4.2 Konnect State
In the Konnect state the TC sends TFO Frames and possibly embedded TFO
Messages as long as it receives correct TFO Messages.
The first received TFO Frame causes the transition into the Operation State.
If no TFO Frames are received within a certain period, the TC transits to the
Failure State.
## 9.5 Operation State
In this State - the Main State of TFO_Protocol - the TC sends and receives TFO
Frames, thus the TFO Connection is fully operating. TFO Messages may occur
embedded into TFO Frames.
## 9.6 Local Handover
### 9.6.1 Fast_Try State
When the TC is in First_Try and suddenly receives TFO Frames and the Codecs do
match, then there is a high probability that a local handover has initialised
the TC into an existing TFO connection and a fast TFO establishment is likely.
The TFO_Protocol has still to check, whether the link to the distant TFO
Partner is (already) transparent. This is done by the specific TFO_DUP
Message.
Since the handover must have been a local handover, i.e. close to the (new)
TC, it can be assumed that the possibly existing IPEs are still in transparent
mode and TFO Messages therefore pass through directly.
### 9.6.2 Fast_Contact State
This State is entered from First_Try via Fast_Try, if TFO Frames and then
TFO_SYL Messages are received. The TC continues to send TFO_DUP Messages,
until TFO Frames are received again. Then it immediately starts to send TFO
Frames, with a TFO_TRANS embedded into the first TFO Frames. The TC transits
directly to Operation State.
## 9.7 Distant Handover, TFO Interruption
### 9.7.1 Sync_Lost State
If the TC was in Operation State and suddenly the TFO Frame synchronisation is
lost, then the TC enters the Sync_Lost State for a short while, before it
transits to Continuous_Retry.
If synchronisation was lost due to a distant handover, then a fast TFO
establishment might be possible and the TC enters Operation State soon again.
In Sync_Lost it expects TFO_DUP Message as confirmation of the distant
handover. Then it transits to Re_Konnect.
### 9.7.2 Re_Konnect State
This State is entered from Operation via Sync_Lost, if TFO_DUP Messages are
received. The TC starts immediately to send TFO Frames again, with a TFO_TRANS
embedded into the first TFO Frames. The TC transits back to Operation State,
as soon as TFO Frames are received, again.
### 9.7.3 TFO_Term
This State is entered when TFO is disabled by either the local or distant
TRAU/TC. The TRAU/TC stops then sending TFO frames but still accepts receiving
TFO frames and messages sent by the distant TRAU/TC.
When the TFO termination has been initiated locally the TRAU/TC transits
through this state before entering to Not_Active state after the TFO
termination has been acknowledged by the distant side.
When the TFO termination has been initiated by the distant TRAU/TC, the
TRAU/TC enters in MONITOR state when TFO frames are no more received.
## 9.8 Failure State
This State is entered when the distant partner shows an incorrect behaviour.
The TC then sends pure PCM samples and waits for the failure to disappear. It
does not send TFO Frames or TFO Messages.
# 10 Detailed Description of the TFO Protocol
## 10.1 Syntax Used for the TFO_Protocol Description
The TFO_Protocol Process is always in one of the states defined in clause 9.
It is fully described by the set of Tables in clause 10.6 defining the
required **Actions** and state **Transitions** triggered by all relevant
**Events**. The syntax used for this description is showed in Table 10.1-1.
The **Events** are the Column entries, while the different states are listed
as Rows entries.
Table 10.1-1: Definition of the Syntax for the State Machine Description
+-------------------+-------------------+-----+-------------------+ | **Event:** | **\ **| | Event >** | | **Or** | | | | | | **\ **| | Event >** | +-------------------+-------------------+-----+-------------------+ | Number | \ | | number> | +-------------------+-------------------+-----+-------------------+ | Condition: | [\] | | [\] | | | | | | | & | [\] | | [\] | +-------------------+-------------------+-----+-------------------+ | Comment: | [\]\ | | [\]\ | | | [\] | | [\] | | **State:** | | | | +-------------------+-------------------+-----+-------------------+ | \: | \;[\;[\;] | | name>;] | | | | | | | | \; | | \; | | | | | | | | [\] | | [\] | +-------------------+-------------------+-----+-------------------+ | ... | | | | +-------------------+-------------------+-----+-------------------+ | \: | \;[\;[\;] | | Name>;] | | | | | | | | \; | | \; | | | | | | | | [\] | | [\] | +-------------------+-------------------+-----+-------------------+
## 10.2 Detailed Description of the Conditions
For a short notation the following abbreviations are used in the conditions
row of the TFO protocol tables:
### 10.2.1 Conditions for TFO_REQ, TFO_ACK, TFO_REQ_L, TFO_ACK_L,
New_Local_Codec, New_Local_Config, Distant Config
In the context of TFO_REQ, TFO_ACK, TFO_REQ_L, TFO_ACK_L, New_Local_Codec,
New_Local_Config, Distant_Config the following conditions are used:
**A_TP (AMR_TFO_Possible)** \ This condition is fulfilled if an AMR NB or AMR-
WB codec type is used and the TFO decision algorithms results in an immediate
TFO situation. According to clause 11.2.3 these immediate TFO situations are:
\- Immediate TFO with LACS == DACS
\- Immediate TFO with FR -- HR -- Matching
\- Immediate TFO with IACS == OACS
\- Immediate TFO with the IACS is a subset of the OACS
**NA_TP (Non_AMR_TFO_Possible)** \ This condition is fulfilled if a non-AMR
codec type is used and the distant used codec type is equal to the local used
codec type (Duc==Luc).
TM (TFO_Mismatch)
This condition is fulfilled if the TFO decision algorithm does not result in
an immediate TFO situation. This is the case in the following situations:
\- The local and distant side use incompatible codec types.
\- Both sides use compatible AMR or compatible AMR-WB codec types and the OACS
doesn\'t exist or the OACS isn\'t acceptable (Codec Mismatch Resolution has to
be invoked).
\- Both sides use compatible AMR or compatible AMR-WB codec types and the OACS
is acceptable for TFO, but first the ACS has to be changed to the OACS.
ICO (Immediate_Codec_Type_Optimisation)
This condition is fulfilled if
\- both sides indicate a TFO version greater than or equal to 5.3 and
\- the available information on alternative codec types indicates that a
change of the local and/or distant codec type results in a TFO configuration
with a higher preference level.
The condition is re-evaluated whenever new information on alternative codec
types becomes available.
### 10.2.2 Conditions for TFO_Frame
In the context of a TFO_Frame event the conditions Match_1, Match_2,
Mismatch_1, and Mismatch_2 are used.\ N represents the number of consecutive
TFO frames received, corresponding to the conditions.
**Match_1** \ Match_1 is fulfilled if one of the following conditions is true:
\- A non-AMR codec type is used and\ the distant used codec type is equal to
the local used codec type (Duc==Luc) and\ n\2.
\- An AMR or AMR-WB codec type is used and\ the local used codec type and the
distant used codec type are compatible and\ the distant used codec mode is
contained in the local ACS and\ n>2
\- An AMR or AMR-WB codec type is used and\ the local used codec type and the
distant used codec type are compatible and\ a Non_Speech TFO frame (i.e.
Sid_First, Sid-Update, Sid_Bad, No_Data and Onset) is received and\ n>2.
**Mismatch_1** \ Mismatch_1 is fulfilled if one of the two following
conditions is true:
\- A non-AMR codec type is used and\ the distant used codec type is different
from the local used codec type (Duc!=Luc) and\ n==1.
\- An AMR or AMR-WB codec type is used and\ the TFO frame doesn\'t match
because of incompatible codec types or a used codec mode that is not in the
ACS and\ n\1.
\- An AMR or AMR-WB codec type is used and\ the TFO frame doesn\'t match
because of incompatible codec types or a used codec mode that is not in the
ACS and\ n>2.
## 10.3 Abbreviations, Definitions, Notations used in the TFO_Protocol
Description
The following Abbreviations and Definitions are used in the TFO_Protocol
Tables.
**Local_Used_Codec** **(** short form: **Luc)** refers to the Speech Codec
Type used in the local transcoder and RAN (e.g. GSM_FR, GSM_EFR, GSM_HR,
FR_AMR, HR_AMR, OHR_AMR, UMTS_AMR or UMTS_AMR_2, FR-AMR-WB, UMTS_AMR-WB,
OFR_AMR-WB or OHR_AMR-WB).
**Distant_Used_Codec (Duc)** refers to the Speech Codec Type used by the
distant partner, as reported in TFO_REQ... or TFO_ACK (e.g. GSM_FR, GSM_EFR,
GSM_HR, FR_AMR, HR_AMR, UMTS_AMR, OHR_AMR, UMTS_AMR_2, FR-AMR-WB, UMTS_AMR-WB,
OFR_AMR-WB, OHR_AMR-WB).
All these variables are initialised to **UNKNOWN** , which means that the
content of the variables is not defined.
**Local_Signature** **(Lsig)** refers to the 8-bit random number in TFO_REQ,
which identifies the local TFO_REQ Messages. It is also used in TFO_REQ_L.
**Distant_Signature** **(Dsig)** refers to the 8-bit random number as received
in TFO_REQ, TFO_REQ_L, TFO_ACK and TFO_ACK_L. If received in TFO_REQ or
TFO_REQ_L , it should be different from the Local_Signature, otherwise loop
back must be assumed (exceptions exist).\ If received in TFO_ACK or TFO_ACK_L,
then it should be identical to the Local_Signature. Otherwise the TFO_ACK is
not a response to an own TFO_REQ, but was possibly created during an handover
situation or after a fast answer with TFO_ACK without a TFO_REQ before. The
Distant_Signature received in TFO_ACK and/or TFO_ACK_L serves no important
purpose and may optionally be ignored.
**Local Channel Type (LCh)** and **Distant Channel Type (DCh)** refer to the 8
or 16 kbit/s or 32kbit/s transparent channel used by the local Transmission
process or received through the distant TFO_TRANS.
**Error protection** and error handling: It is assumed that the defined error
protection is strong enough for the error rates encountered on typical
transmission links. The few occurring errors are usually all detected and
possibly corrected by Rx_TFO, before reported to TFO_Protocol. Therefore
TFO_Protocol can rely on the correctness of the received Events. The protocol
is, however, \"self healing\" and will handle the unlikely erroneous Events.
**Fast Handover** handling: The defined protocol assumes that the new
Transcoder, to which the handover is performed, is already in State Wakeup
before the A-Interface is switched to that Transcoder. Only then, the TFO
Frames can be received and fast handover handling is possible.
**Timing** : If two Events occur by coincidence at the same time, then they
shall be processed in the order given by the tables 10.6-1 to 10.6-13 (left to
right). TFO Messages arrive always some time before the embedding TFO Frame
and shall be handled therefore first.
## 10.4 Detailed Description of the Events
Table 10.4-1 lists all events of the Protocol Tables.
Table 10.4-1: Events of the State Machine Description
+----+-------------------------------+-------------------------------+ | # | Event | Description | +----+-------------------------------+-------------------------------+ | 1 | TFO_Enable | The event TFO_Enable occurs | | | | when all TFO parameters get | | | | available in the transcoder | | | | and the controlling entity | | | | enables TFO. In GSM, it means | | | | that the TFOE bit of AMR or | | | | AMR-WB TRAU Frames toggles | | | | from \'0\' to \'1\'. Enabling | | | | TFO might involve a | | | | proprietary process not | | | | further addressed in the | | | | present document. | +----+-------------------------------+-------------------------------+ | 2 | New_Speech_Call | This event occurs when a new | | | | speech call is set-up or the | | | | TRAU/TC is re-initialised | | | | (e.g. after a handover | | | | failure). In GSM, this means | | | | that the transcoder is | | | | initialised by the BTS by two | | | | consecutive TRAU frames with | | | | identical codec types | | | | (GSM_FR, GSM_HR, GSM_EFR) | | | | or by a config frame (AMR or | | | | AMR-WB codec types). In 3G, | | | | this means that the Iu User | | | | Plan is initialised. | +----+-------------------------------+-------------------------------+ | 3 | TFO_Disable | The event TFO_Disable occurs | | | | when TFO is disabled by the | | | | controlling entity.\ | | | | In GSM, the TFO_Disable | | | | event is also controlled by | | | | the TFOE bit of AMR or AMR-WB | | | | TRAU Frames. | +----+-------------------------------+-------------------------------+ | 4 | TRAU_Idle | This event occurs when the | | | | transcoder is set into idle | | | | mode. | +----+-------------------------------+-------------------------------+ | 5 | PCM_Non_Idle | The event PCM_Non_Idle | | | | occurs if more than one PCM | | | | samples are received that are | | | | different to PCM_Idle. | +----+-------------------------------+-------------------------------+ | 12 | TFO_Frame and | This event means that a valid | | | | TFO Frame was received by the | | | Match_1 | transcoder and the condition | | | | Match_1 is fulfilled. | +----+-------------------------------+-------------------------------+ | 17 | TFO_Frame and | This event means that a valid | | | | TFO Frame was received by the | | | Match_2 | transcoder and the condition | | | | Match_2 is fulfilled. | +----+-------------------------------+-------------------------------+ | 38 | TFO_Frame and | This event means that a valid | | | | TFO Frame was received by the | | | Mismatch_1 | transcoder and the condition | | | | Mismatch_1 is fulfilled. | +----+-------------------------------+-------------------------------+ | 39 | TFO_Frame and | This event means that a valid | | | | TFO Frame was received by the | | | Mismatch_2 | transcoder and the condition | | | | Mismatch_2 is fulfilled. | +----+-------------------------------+-------------------------------+ | 13 | New_Local_Codec and | This event occurs when the | | | | local used codec type | | | (NA_TP \| A_TP) and | changes, either the condition | | | | NA_TP or the condition A_TP | | | ICO==0 | is fulfilled, and Immediate | | | | Codec Type Optimisation is | | | | not performed. | +----+-------------------------------+-------------------------------+ | 15 | New_Local_Codec and | This event occurs when the | | | | local used codec type | | | TM and | changes, the condition TM is | | | | fulfilled, and Immediate | | | ICO==0 | Codec Type Optimisation is | | | | not performed. | +----+-------------------------------+-------------------------------+ | 14 | New_Local_Config and | This event occurs when an AMR | | | | or AMR-WB codec type is used, | | | (NA_TP \| A_TP) and | the local codec configuration | | | | changes, either the condition | | | ICO==0 | A_TP or NA_TP is fulfilled, | | | | and Immediate Codec Type | | | | Optimisation is not | | | | performed. | +----+-------------------------------+-------------------------------+ | 16 | New_Local_Config and | This event occurs when an AMR | | | | or AMR-WB codec type is used, | | | TM and | the local codec configuration | | | | changes, the condition TM is | | | ICO==0 | fulfilled, and Immediate | | | | Codec Type Optimisation is | | | | not performed. | +----+-------------------------------+-------------------------------+ | 32 | RC_ack | This event (rate control | | | | acknowledgement) occurs when | | | | an acknowledgement to the RCi | | | | action is received from the | | | | BTS/RNC indicating that the | | | | rate control command was | | | | understood (TFO_Soon | | | | acknowledgement in GSM, | | | | Rate_Ack in UMTS). | +----+-------------------------------+-------------------------------+ | 40 | New_Local_Codec_List | This event occurs when the | | | | local codec list changes. | +----+-------------------------------+-------------------------------+ | 41 | Data_Call | This event is only relevant | | | | for GSM systems. It occurs | | | | when the transcoder is | | | | informed that a Data Call is | | | | set-up. | +----+-------------------------------+-------------------------------+ | 44 | Runout | The event Runout occurs when | | | | the last TFO message has been | | | | taken from the Transmit Queue | | | | and the last 10 bits are | | | | going to be sent. So there is | | | | still some time for | | | | TFO_Protocol to react and | | | | place a further TFO Message | | | | in the Transmit Queue, which | | | | then shall be transmitted | | | | without gap to the messages | | | | before. | +----+-------------------------------+-------------------------------+ | 45 | T==0 | This event occurs when a | | | | time-out has been reached. | +----+-------------------------------+-------------------------------+ | 46 | Frame_Sync_Lost and | This event occurs when the | | | | TFO frame synchronisation is | | | n\2 and TFO_Disabled | lost for more than two times | | | | and TFO has been disabled. | | | | For further details see Annex | | | | C. | +----+-------------------------------+-------------------------------+ | 57 | Frame_Sync_Lost and n>2 | This event occurs when the | | | and TFO_Enabled | TFO frame synchronisation is | | | | lost for more than two times | | | | and TFO is still enabled. For | | | | further details see Annex C. | +----+-------------------------------+-------------------------------+ | 48 | Mes_Sync_Lost | This event corresponds to a | | | | loss of TFO message | | | | synchronisation. For further | | | | details see Annex C. | +----+-------------------------------+-------------------------------+ | 35 | Handover_Soon and | This event occurs when the | | | | TRAU/TC is informed that a | | | (NA_TP \| A_TP) | local hand-over will soon | | | | take place and either the | | | | condition NA_TP or the | | | | condition A_TP is fulfilled. | +----+-------------------------------+-------------------------------+ | 36 | Handover_Soon and | This event occurs when the | | | | TRAU/TC is informed that a | | | TM | local hand-over will soon | | | | take place and the condition | | | | TM is fulfilled. | +----+-------------------------------+-------------------------------+ | 6 | TFO_REQ and | This event occurs when a | | | | TFO_REQ message is received, | | | (NA_TP \| A_TP) and | either the condition NA_TP | | | | or the condition A_TP is | | | Dsig==Lsig and | fulfilled and the distant | | | | signature is equal to the | | | Dsig!=Old_Sig | local signature but different | | | | from the old (local) | | | | signature. | +----+-------------------------------+-------------------------------+ | 7 | TFO_REQ and | This event occurs when a | | | | TFO_REQ message is received, | | | (NA_TP \| A_TP) and | the condition NA_TP or A_TP | | | | is fulfilled, and the distant | | | Dsig==Old_Sig | signature is equal to the old | | | | signature. | +----+-------------------------------+-------------------------------+ | 8 | TFO_REQ and | This event occurs when a | | | | TFO_REQ message is received, | | | (NA_TP \| A_TP) and | either the condition NA_TP | | | | or the condition A_TP is | | | Dsig!=Lsig and | fulfilled, the distant | | | | signature is different from | | | Dsig!=Old_Sig and | the local signature and old | | | | (local) signature, and | | | ICO==0 | Immediate Codec Type | | | | Optimisation is not | | | | performed. | +----+-------------------------------+-------------------------------+ | 24 | TFO_REQ and | This event occurs when a | | | | TFO_REQ message is received, | | | TM and | the condition TM is | | | | fulfilled, and the distant | | | Dsig==Lsig | and the local signatures are | | | | equal. | +----+-------------------------------+-------------------------------+ | 25 | TFO_REQ and | This event occurs when a | | | | TFO_REQ message is received, | | | TM and | the condition TM is | | | | fulfilled, the distant | | | Dsig!=Lsig and | signature is different from | | | | the local signature, and | | | ICO==0 | Immediate Codec Type | | | | Optimisation is not | | | | performed. | +----+-------------------------------+-------------------------------+ | 9 | TFO_ACK and | This event occurs when a | | | | TFO_ACK message is received, | | | NA_TP and | the condition NA_TP is | | | | fulfilled, the local and | | | Dsig==Lsig and | distant signatures are equal, | | | | and Immediate Codec Type | | | ICO==0 | Optimisation is not | | | | performed. | +----+-------------------------------+-------------------------------+ | 10 | TFO_ACK and | This event occurs when a | | | | TFO_ACK message is received, | | | (NA_TP \| A_TP) and | either the condition NA_TP | | | | or the condition A_TP is | | | Dsig!=Lsig | fulfilled, and the distant | | | | signature is different from | | | | the local signature.\ | | | | Optionally the difference | | | | between Distant_Signature | | | | and Local_Signature may be | | | | ignored in TFO_ACK. Then | | | | this event need not be | | | | checked. | +----+-------------------------------+-------------------------------+ | 26 | TFO_ACK and | This event occurs when a | | | | TFO_ACK message is received, | | | TM and | the condition TM is | | | | fulfilled, and Immediate | | | ICO==0 | Codec Type Optimisation is | | | | not performed. The distant | | | (Dsig==?) | signature is ignored for this | | | | event. | +----+-------------------------------+-------------------------------+ | 31 | TFO_ACK and | This event occurs when a | | | | TFO_ACK message is received, | | | A_TP and | the condition A_TP is | | | | fulfilled, the distant | | | Dsig==Lsig and | signature is equal to the | | | | local signature, and | | | ICO==0 | Immediate Codec Type | | | | Optimisation is not | | | | performed. | +----+-------------------------------+-------------------------------+ | 11 | TFO_TRANS and | This event occurs when a | | | | TFO_TRANS message is | | | Luc != AMR and | received when a non-AMR codec | | | | type is used on the local | | | DCh==LCh | side and the distant and | | | | local channel types do match. | +----+-------------------------------+-------------------------------+ | 30 | TFO_TRANS and | This event occurs when a | | | | TFO_TRANS message is | | | Luc == AMR and | received while a AMR or | | | | AMR-WB codec type is used and | | | DCh==LCh | the distant and local channel | | | | types do match. | +----+-------------------------------+-------------------------------+ | 37 | TFO_TRANS and | This event occurs when a | | | | TFO_TRANS message is | | | DCh!=LCh | received and a channel | | | | mismatch occurs. | +----+-------------------------------+-------------------------------+ | 18 | TFO_SYL | This event occurs when a | | | | TFO_SYL message is received. | +----+-------------------------------+-------------------------------+ | 19 | TFO_DUP | This event occurs when a | | | | TFO_DUP message is received. | +----+-------------------------------+-------------------------------+ | 20 | TFO_REQ_L and | This event occurs when a | | | | TFO_REQ_L message is | | | (NA_TP \| A_TP) and | received, either the | | | | condition NA_TP or the | | | Dsig==Lsig | condition A_TP is fulfilled, | | | | and the local signature is | | | | equal to the distant | | | | signature. | +----+-------------------------------+-------------------------------+ | 21 | TFO_REQ_L and | This event occurs when a | | | | TFO_REQ_L message is | | | (NA_TP \| A_TP) and | received, either the | | | | condition NA_TP or the | | | Dsig!=Lsig | condition A_TP is fulfilled, | | | | and the local and distant | | | | signatures are different. | +----+-------------------------------+-------------------------------+ | 27 | TFO_REQ_L and | This event occurs when a | | | | TFO_REQ_L message is | | | TM and | received, the condition TM is | | | | fulfilled, and the local and | | | Dsig==Lsig | distant signatures are equal. | +----+-------------------------------+-------------------------------+ | 28 | TFO_REQ_L and | This event occurs when a | | | | TFO_REQ_L message is | | | TM and | received, the condition TM is | | | | fulfilled and the local and | | | Dsig!=Lsig | distant signatures are | | | | different. | +----+-------------------------------+-------------------------------+ | 22 | TFO_ACK_L and | This event occurs when a | | | | TFO_ACK_L message is | | | (NA_TP \| A_TP) and | received, either the | | | | condition NA_TP or the | | | Dsig==Lsig | condition A_TP is fulfilled, | | | | and the local signature is | | | | equal to the distant | | | | signature. | +----+-------------------------------+-------------------------------+ | 23 | TFO_ACK_L and | This event occurs when a | | | | TFO_ACK_L message is | | | (NA_TP \| A_TP) and | received, either the | | | | condition NA_TP or the | | | Dsig!=Lsig | condition A_TP is fulfilled, | | | | and the local and distant | | | | signatures are different. | | | | | | | | Optionally the difference | | | | between Distant_Signature | | | | and Local_Signature may be | | | | ignored in TFO_ACK_L.Then | | | | this event need not be | | | | checked. | +----+-------------------------------+-------------------------------+ | 29 | TFO_ACK_L and | This event occurs when a | | | | TFO_ACK_L message is | | | TM and | received and the condition TM | | | | is fulfilled. The distant | | | Dsig==? | signature is not relevant for | | | | this event. | +----+-------------------------------+-------------------------------+ | 42 | TFO_FILL | This event occurs when a | | | | TFO_FILL message is | | | | received. | +----+-------------------------------+-------------------------------+ | 43 | TFO_NORMAL | This event occurs when a | | | | TFO_NORMAL message is | | | | received. | +----+-------------------------------+-------------------------------+ | 49 | Distant_Config and | This event occurs when a 3G | | | | system (TC) receives a config | | | (NA_TP \| A_TP) and | request from the distant | | | | TRAU/TC, the TFO_enable bit | | | Con_Req & TC | is set, and the parameters of | | | | this config frame are | | | | compatible with the local | | | | parameters so that TFO is | | | | possible. | +----+-------------------------------+-------------------------------+ | 50 | Distant_Config and | This event occurs when 3G | | | | system (TC) receives a config | | | TM and | request from the distant | | | | TRAU/TC, the TFO_enable bit | | | Con_Req & TC | is set, and the parameters of | | | | this config frame do not | | | | match with the local | | | | parameters so that TFO is not | | | | possible. | +----+-------------------------------+-------------------------------+ | 51 | Distant_Config and | This event occurs when a 3G | | | | system (TC) receives a config | | | (NA_TP \| A_TP) and | acknowledgement from the | | | | distant TRAU/TC, the | | | Con_Ack & TC | TFO_enable bit is set, and | | | | the parameters of this config | | | | frame are compatible with the | | | | local parameters so that TFO | | | | is possible. This event does | | | | not occur when an | | | | acknowledgement for a config | | | | request indicating | | | | Handover_Soon is received. | +----+-------------------------------+-------------------------------+ | 52 | Distant_Config and | This event occurs when 3G | | | | system (TC) receives a config | | | TM and | acknowledgement from the | | | | distant TRAU/TC, the | | | Con_Ack & TC | TFO_enable bit is set, and | | | | the parameters of this config | | | | frame do not match with the | | | | local parameters so that TFO | | | | is not possible. This event | | | | does not occur when an | | | | acknowledgement for a config | | | | request indicating | | | | Handover_Soon is received. | +----+-------------------------------+-------------------------------+ | 53 | Distant_Config and | This event occurs when a 2G | | | | system (TRAU) receives a | | | (NA_TP \| A_TP) and | config frame (config request | | | | or config acknowledgement) | | | TRAU | from the distant TRAU/TC, the | | | | TFO_enable bit is set, and | | | | the parameters of this config | | | | frame are compatible with the | | | | local parameters so that TFO | | | | is possible. This event does | | | | not occur when an | | | | acknowledgement for a config | | | | request indicating | | | | Handover_Soon is received. | +----+-------------------------------+-------------------------------+ | 54 | Distant_Config and | This event occurs when a 2G | | | | system receives a config | | | TM and | request from the distant | | | | TRAU/TC, the TFO_enable bit | | | Con_Req & TRAU | is set, and the parameters of | | | | this config frame do not | | | | match with the local | | | | parameters so that TFO is not | | | | possible. | +----+-------------------------------+-------------------------------+ | 55 | Distant_Config and | This event occurs when a 2G | | | | system receives a config | | | TM and | acknowledgement from the | | | | distant TRAU/TC, the | | | Con_Ack & TRAU | TFO_enable bit is set, and | | | | the parameters of this config | | | | frame do not match with the | | | | local parameters so that TFO | | | | is not possible. This event | | | | does not occur when an | | | | acknowledgement for a config | | | | request indicating | | | | Handover_Soon is received. | +----+-------------------------------+-------------------------------+ | 56 | Distant_Disable | This event occurs when a | | | | config frame (config request) | | | | with a TFO_Enable bit set to | | | | zero is received from the | | | | distant TRAU/TC, i.e. when | | | | the distant side is going to | | | | disable TFO. | +----+-------------------------------+-------------------------------+ | 58 | TFO_REQ and | This event occures when a | | | | TFO_REQ message is received, | | | Dsig != Lsig and | the distant signature is | | | | different from the local | | | ICO==1 | signature, and Immediate | | | | Codec Type Optimisation is | | | | performed. | +----+-------------------------------+-------------------------------+ | 59 | TFO_ACK and | This event occures when a | | | | TFO_ACK message is received, | | | Dsig==Lsig and | the distant signature is | | | | equal to the local signature, | | | ICO==1 | and Immediate Codec Type | | | | Optimisation is performed | +----+-------------------------------+-------------------------------+ | 60 | New_Local_Codec and | This event occurs when the | | | | local used codec type changes | | | ICO==1 | and Immediate Codec Type | | | | Optimisation is performed. | +----+-------------------------------+-------------------------------+ | 61 | New_Local_Config and | This event occurs the local | | | | codec configuration changes | | | ICO==1 | and Immediate Codec Type | | | | Optimisation is performed. | +----+-------------------------------+-------------------------------+
## 10.5 Actions Table
Table 10.5-2 list all actions that can be performed by the TFO protocol. The
syntax is defined in Table 10.5-1.
Table 10.5-1: Definition of Syntax for Action Table
* * *
Name Action List Comment \ \;[ \;] \
...  
\ \;[ \;] \
* * *
The following notations are used in Table 10.5-2.
The **Transmit Queue** or **Tx_Queue** is a **F** irst-**I** n **F**
irst-**O** ut command queue. It is filled by TFO_Protocol and read by the
Transmit Process (e.g. Tx_TFO in Annex C).
The **Transmit Process** or **Tx_TFO** is the Process responsible for the
scheduling and transmission of TFO Messages and TFO Frames to the distant
partner.
The **Receive Process** or **Rx_TFO** is the Process responsible for the
reception of TFO Messages and transfer to the TFO_Protocol.
**Tx := TFO_REQ** means, that TFO_Protocol places a command TFO_REQ in
Tx_Queue. The Transmit Process should then generate a TFO_REQ Message for
transmission when it comes to that command.
**Tx := 31*TFO_REQ** means: put 31 TFO_REQ commands in Tx_Queue. Not
necessarily all will generate TFO_REQ Messages. In most cases Tx_Queue will be
cleared before. Similar definitions hold for the other messages.
**Clear Tx_Queue** means that all remaining commands are deleted from the
Tx_Queue in that very moment (time _Tc_).
Note that due to the duration required to fully transmit a TFO Message, the
TFO_Protocol Process is often already in a different state while TFO Messages
commanded in earlier States are still in the Tx_Queue or under transmission.
**BSS := TFO ()** means that a message is sent to the local RAN.
**Tx_TRAU := ...** means that a message is sent to the downlink Transmit
Process of the Transcoder.
**Tx_TFO := ...** means that a message is sent to the uplink transmit process
of the transcoder.
One Timer **T := \ ** is required to describe time out situations.
The notation **T := DIS** means that the Timer is disabled. Positive values
are decremented in a hidden background process in steps of 20 ms. When T
reaches \'0\', the TFO_Protocol Process is invoked.
Table 10.5-2: Defined Actions
+------+------------------------------+------------------------------+ | Name | Actions | Comments | +------+------------------------------+------------------------------+ | C | Clear Tx_Queue; | Initialise Tx_Queue and | | | | disable the timer. | | | T := DIS; | | +------+------------------------------+------------------------------+ | T1 | T := 1s; | Set Timeout to 1 second. | +------+------------------------------+------------------------------+ | T2 | T := 2s; | Set Timeout to 2 seconds. | +------+------------------------------+------------------------------+ | T5 | T := 5s; | Set Timeout to 5 seconds. | +------+------------------------------+------------------------------+ | NoAc | . | No Action required. | +------+------------------------------+------------------------------+ | S | Lsig := New_Random_Number; | Generate new Signature and | | | | set Old_Sig to unknown. | | | Old_Sig := UNKNOWN | | +------+------------------------------+------------------------------+ | SO | Old_Sig := Lsig; | Remember old Signature and | | | | generate a new Signature. | | | Lsig := New_Random_Number | | +------+------------------------------+------------------------------+ | U | Old_Sig := UNKNOWN; | Reset Old_Sig. | +------+------------------------------+------------------------------+ | F | Tx := 3*TFO_FILL; | Put three TFO_FILL messages | | | | into Tx_Queue. | +------+------------------------------+------------------------------+ | T | Tx := TFO_TRANS (); | Put one TFO_TRANS message | | | | into Tx_Queue. | +------+------------------------------+------------------------------+ | N | Tx := TFO_NORMAL; | Put one TFO_NORMAL message | | | | into Tx_Queue. | +------+------------------------------+------------------------------+ | REQ | Tx := 35*TFO_REQ; | Put 35 TFO_REQ messages | | | | into Tx_Queue. | +------+------------------------------+------------------------------+ | ACK | Tx := 7*TFO_ACK; | Put seven TFO_ACK messages | | | | into Tx_Queue. | +------+------------------------------+------------------------------+ | ACK1 | Tx := 1*TFO_ACK | Put one TFO_ACK messages | | | | into Tx_Queue. | +------+------------------------------+------------------------------+ | SYL1 | Tx := TFO_SYL; | Put one TFO_SYL message | | | | into Tx_Queue. | +------+------------------------------+------------------------------+ | SYL | Tx := 4*TFO_SYL; | Put four TFO_SYL messages | | | | into Tx_Queue. | +------+------------------------------+------------------------------+ | DUP | Tx := 5*TFO_DUP; | Put five TFO_DUP messages | | | | into Tx_Queue. | +------+------------------------------+------------------------------+ | L1 | Tx := TFO_REQ_L; | Put one TFO_REQ_L message | | | | into Tx_Queue. | +------+------------------------------+------------------------------+ | L | Tx := 6*TFO_REQ_L; | Put six TFO_REQ_L messages | | | | into Tx_Queue. | +------+------------------------------+------------------------------+ | LA | Tx := TFO_ACK_L; | Put one TFO_ACK_L message | | | | into Tx_Queue. | +------+------------------------------+------------------------------+ | BT | Tx := Begin_TFO; | Begin Transmission of TFO | | | | Frames. | +------+------------------------------+------------------------------+ | DT | Tx := Discontinue_TFO; | Discontinue Transmission of | | | | TFO Frames. | +------+------------------------------+------------------------------+ | IT | Tx_TRAU := Ignore_TFO; | A soon as no TFO frames are | | | | received any longer, the | | | Tx_TRAU := TFO_Off; | downlink transmit process | | | | works as conventional | | | | downlink TRAU/TC. | | | | Additionally, a TFO_Off | | | | message is sent at this | | | | time. | +------+------------------------------+------------------------------+ | AT | Tx_TRAU := Accept_TFO; | Downlink Transmit Process | | | | bypasses TFO_Frames. | | | Tx_TRAU := TFO_On; | Additionally, a TFO_On | | | | message is sent. | +------+------------------------------+------------------------------+ | B | BSS := TFO (); | Send TFO relevant | | | | information to the BSS or | | | | MSC. Successive identical | | | | information shall not be | | | | sent more than once. | +------+------------------------------+------------------------------+ | RCm | Tx_TRAU := | RCm (Rate Control maximum | | | Set_Max_Rate(); | value):\ | | | | This action is only relevant | | | Tx_TFO := Set_Max_Rate(); | for AMR or AMR-WB codec | | | | types and releases the codec | | | | mode steering by setting the | | | | local max rate to the | | | | maximum value (i.e. 7). | +------+------------------------------+------------------------------+ | RCs | Tx_TRAU := | RCs (Rate Control for | | | Set_Max_Rate(); | Subset):\ | | | | This action is only relevant | | | Tx_TFO := Set_Max_Rate(); | for AMR or AMR-WB codec | | | | types and steers the rate | | | | control depending on the TFO | | | | decision situation in order | | | | to continue TFO on a subset | | | | of the ACS if necessary. | +------+------------------------------+------------------------------+ | RCi | Tx_TRAU := | RCi (Rate Control initial):\ | | | Set_Max_Rate(); | In the case of an AMR or | | | | AMR-WB codec type, this | | | Tx_TFO := Set_Max_Rate(); | action steers the rate | | | | control down to the | | | Tx_TRAU := TFO_Soon; | TFO_Setup_Mode in order to | | | | start TFO using this mode. | | | | Additionally, a TFO_Soon | | | | message is sent to the BTS. | | | | This TFO_Soon message will | | | | be acknowledged by the BTS. | | | | The acknowledgement yields | | | | as an event to leave the | | | | WAIT_RC state.) | +------+------------------------------+------------------------------+ | RCh | Tx_TRAU := | RCh (Rate Control for | | | Set_Max_Rate(); | hand-over): | | | | | | | Tx_TFO := Set_Max_Rate(); | This action is only relevant | | | | for AMR or AMR-WB codec | | | | types and steers the rate | | | | control down to the | | | | Hand_Over_Mode in order to | | | | continue TFO after hand-over | | | | using this mode. | +------+------------------------------+------------------------------+ | CA | Tx_TFO := Con_Ack(); | Send a Con_Ack (config | | | | frame) to the distant | | | | TRAU/TC. | +------+------------------------------+------------------------------+ | CA1 | Wait round trip time to RNC; | Wait round trip time to RNC | | | | (e.g. send first a RC_REQ | | | Tx_TFO := Con_Ack(); | to the RNC and wait for the | | | | corresponding RC_ACK). | | | | | | | | Then send a Con_Ack to the | | | | distant TRAU/TC. | +------+------------------------------+------------------------------+ | CR | TX_TFO := Con_Req(); | This action is conditional | | | | and only relevant for 3G | | | | systems (TC). If the entity | | | | is a TC then send a Con_Req | | | | with TFO_Disable to the | | | | distant TRAU/TC. | +------+------------------------------+------------------------------+
## 10.6 Protocol Tables
Table 10.6-1: Enabling/Disabling/New_Speech_Call/TRAU_Idle
+-------------+-----------------------+-------------------+ | **Event:** | **TFO_Enable** | **TFO_Disable** | | | | | | or | **New_Speech_Call** | **TRAU_Idle** | +-------------+-----------------------+-------------------+ | Number: | 1, 2 | 3, 4 | +-------------+-----------------------+-------------------+ | Condition: | | | | | | | | & | | | +-------------+-----------------------+-------------------+ | Comment: | TFO gets active. | Local disable. | | | | | | **State:** | | | +-------------+-----------------------+-------------------+ | **NAC:** | C;S;IT;RCm; | NoAc; | | | | | | Not_Active | WAK; | NAC; | +-------------+-----------------------+-------------------+ | **WAK:** | NoAc; | NoAc; | | | | | | Wakeup | WAK; | NAC; | +-------------+-----------------------+-------------------+ | **FIT:** | ---------- | C;N; | | | | | | First_Try | | NAC; | +-------------+-----------------------+-------------------+ | **COR:** | ---------- | C;N; | | | | | | Continuous | | NAC; | | | | | | Retry | | | +-------------+-----------------------+-------------------+ | **PER:** | ---------- | C;N; | | | | | | Periodic | | NAC; | | | | | | Retry | | | +-------------+-----------------------+-------------------+ | **MON:** | ---------- | C;N; | | | | | | Monitor | | NAC; | +-------------+-----------------------+-------------------+ | **MIS:** | ---------- | C;N; | | | | | | Mismatch | | NAC; | +-------------+-----------------------+-------------------+ | **CON:** | ---------- | C;N; | | | | | | Contact | | NAC; | +-------------+-----------------------+-------------------+ | **FAT:** | ---------- | C;N;RCm; | | | | | | Fast | | NAC; | | | | | | Try | | | +-------------+-----------------------+-------------------+ | **FAC:** | ---------- | C;N;RCm; | | | | | | Fast | | NAC; | | | | | | Contact | | | +-------------+-----------------------+-------------------+ | **WRC:** | ---------- | C;N;RCm; | | | | | | Wait_RC | | NAC; | +-------------+-----------------------+-------------------+ | **KON:** | ---------- | C;RCm;CR;DT;N;T1; | | | | | | Konnect | | TT; | +-------------+-----------------------+-------------------+ | **REK:** | ---------- | C;RCm;CR;DT;N;T1; | | | | | | Re_Konnect | | TT; | +-------------+-----------------------+-------------------+ | **SOS:** | ---------- | C;RCm;IT;N; | | | | | | Sync_Lost | | NAC; | +-------------+-----------------------+-------------------+ | **OPE:** | ---------- | C;RCm;CR;DT;N;T1; | | | | | | Operation | | TT; | +-------------+-----------------------+-------------------+ | **FAI:** | ---------- | C; | | | | | | Failure | | NAC; | | | | | | | | **Exit from FAI** | +-------------+-----------------------+-------------------+ | **TT:** | ----------\ | NoAc; | | | ---------- | | | TFO_Term | | TT; | +-------------+-----------------------+-------------------+
Table 10.6-2: PCM_Non_Idle and Loopback Handling
+-------------+-----------------+-----------------+-----------------+ | Event: | PCM_Non_Idle | TFO_REQ | TFO_REQ | +-------------+-----------------+-----------------+-----------------+ | Number: | 5 | 6 | 7 | +-------------+-----------------+-----------------+-----------------+ | Condition: | | (NA_TP \| | (NA_TP \| | | | | A_TP) | A_TP) | | & | | | | | | | Dsig==Lsig | Dsig==Old_Sig | | & | | | | | | | Dsig!=Old_Sig | | +-------------+-----------------+-----------------+-----------------+ | Comment: | Occurs only at | Loopback (LB) | Loopback (LB) | | | the beginning | | | | **State:** | | or distant | or distant | | | | handover | handover (HO)? | | | | | | | | | (HO)? wrong Sig | | +-------------+-----------------+-----------------+-----------------+ | **NAC:** | -- | -- | -- | | | -------- | -------- | -------- | | Not_Active | | | | +-------------+-----------------+-----------------+-----------------+ | **WAK:** | C;F;REQ; | -- | -- | | | | -------- | -------- | | Wakeup | FIT; | | | | | | | | | | **Typ 2^nd^ | | | | | Event** | | | +-------------+-----------------+-----------------+-----------------+ | **FIT:** | -- | C;SO;REQ; | NoAc; | | | -------- | | | | First_Try | | FIT; | FIT; | | | | | | | | | **LB!** | **Ignore LB** | +-------------+-----------------+-----------------+-----------------+ | **COR:** | -- | C;SO;REQ; | NoAc; | | | -------- | | | | Continuous | | COR; | COR; | | | | | | | Retry | | LB!? | **Ignore LB** | +-------------+-----------------+-----------------+-----------------+ | **PER:** | -- | C;F;S;ACK; | -- | | | -------- | | -------- | | Periodic | | CON; | | | | | | | | Retry | | Dist HO! | | +-------------+-----------------+-----------------+-----------------+ | **MON:** | -- | C;F;S;REQ; | -- | | | -------- | | -------- | | Monitor | | FIT; | | | | | | | | | | Dist HO! | | +-------------+-----------------+-----------------+-----------------+ | **MIS:** | -- | C;F;S;ACK; | -- | | | -------- | | -------- | | Mismatch | | CON; | | | | | | | | | | Dist HO! | | +-------------+-----------------+-----------------+-----------------+ | **CON:** | -- | C;SO;REQ; | -- | | | -------- | | -------- | | Contact | | COR; | | | | | | | | | | Safe way | | +-------------+-----------------+-----------------+-----------------+ | **FAT:** | -- | C;SO;REQ;RCm; | -- | | | -------- | | -------- | | Fast | | COR; | | | | | | | | Try | | Safe way | | +-------------+-----------------+-----------------+-----------------+ | **FAC:** | -- | C;SO;REQ;RCm; | -- | | | -------- | | -------- | | Fast | | COR; | | | | | | | | Contact | | Safe way | | +-------------+-----------------+-----------------+-----------------+ | **WRC:** | -- | C;SO;RCm;REQ; | -- | | | -------- | | -------- | | Wait_RC | | COR; | | +-------------+-----------------+-----------------+-----------------+ | **KON:** | -- | C;DT | -- | | | -------- | ;SO;RCm;REQ;T1; | -------- | | Konnect | | | | | | | COR; | | | | | | | | | | IPEs | | | | | transparent! | | +-------------+-----------------+-----------------+-----------------+ | **REK:** | -- | C;DT;SO;R | -- | | | -------- | Cm;REQ;IT;B;T1; | -------- | | Re_Konnect | | | | | | | COR; | | | | | | | | | | IPEs | | | | | transparent! | | +-------------+-----------------+-----------------+-----------------+ | **SOS:** | -- | C;IT; | -- | | | -------- | S;RCm;REQ;B;T1; | -------- | | Sync_Lost | | | | | | | COR; | | | | | | | | | | Contact is back | | +-------------+-----------------+-----------------+-----------------+ | **OPE:** | -- | -- | -- | | | -------- | -------- | -------- | | Operation | | | | +-------------+-----------------+-----------------+-----------------+ | **FAI:** | -- | NoAc; | -- | | | -------- | | -------- | | Failure | | FAI; | | +-------------+-----------------+-----------------+-----------------+ | **TT:** | -- | -- | -- | | | -------- | -------- | -------- | | TFO_Term | | | | +-------------+-----------------+-----------------+-----------------+
Table 10.6-3: Most Important Cases, Especially at Call Set-up
+----------+----------+----------+----------+----------+----------+ | ** | **TF |** TF | **TF |** TFO\ | **TFO\ | | Event:** | O_REQ**| O_ACK** | O_ACK**| _TRANS** | _Frame**| +----------+----------+----------+----------+----------+----------+ | Number: | 8 | 9 | 10 | 11 | 12 | +----------+----------+----------+----------+----------+----------+ | Co | (NA_TP | NA_TP | (NA_TP | Luc != | Match_1 | | ndition: | \| | | \| | AMR | | | | A_TP) | Ds | A_TP) | | | | & | | ig==Lsig | | DCh==LCh | | | | Ds | | Ds | | | | & | ig!=Lsig | | ig!=Lsig | | | | | | | | | | | & | Dsig!= | | | | | | | Old_Sig | | | | | | | | | | | | | | ICO==0 | | | | | +----------+----------+----------+----------+----------+----------+ | Comment: | Distant | Distant | Wrong | similar | First or | | | REQ | ACK | Response | to ACK | second | | ** | | | | | | | State:** | Good | Good | H | As | TFO | | | S | S | andover? | response | Frame | | | ignature | ignature | | | | | | | | | to loc | | | | | | | ACK_? | | +----------+----------+----------+----------+----------+----------+ | **NAC:** | -\ | -\ | -\ | -\ | -\ | | | ----\ | ----\ | ----\ | ----\ | ----\ | | Not | ----- | ----- | ----- | ----- | ----- | | _Active | | | | | | +----------+----------+----------+----------+----------+----------+ | **WAK:** | -\ | -\ | -\ | -\ | -\ | | | ----\ | ----\ | ----\ | ----\ | ----\ | | Wakeup | ----- | ----- | ----- | ----- | ----- | +----------+----------+----------+----------+----------+----------+ | **FIT:** | C;U;ACK; | C;U;T; | C;REQ; | NoAc; | C;U; | | | | BT;T;T1; | | | DUP;RCi; | | Fi | CON; | | FIT; | FIT; | | | rst_Try | | KON; | | | FAT; | | | **T | | | Wait for | | | | ypical** | ** | | Frame | **1: | | | | Typical; | | | HO** | | | | IPEs!**| | | | +----------+----------+----------+----------+----------+----------+ |** COR:**| C;U;ACK; | C;U;T; | C;REQ; | NoAc; | C;U;DUP; | | | | BT;T;T1; | | | | | Co | CON; | | COR; | COR; | FAT; | | ntinuous | | KON; | | | | | | Typical | | | Wait for | 1: Call | | Retry | | ** | | Frames | is back? | | | | Typical; | | | | | | | IPEs!** | | | | +----------+----------+----------+----------+----------+----------+ | **PER:** | C;F;ACK; | C; | C;F;REQ; | NoAc; | C;DUP; | | | | F;S;REQ; | | | | | Periodic | CON; | | COR; | PER; | FAT; | | | | COR; | | | | | Retry | OK, | | | Wait for | 1: Call | | | Contact | Rare | | Frames | is back? | | | is back | case, | | | | | | | test | | | | +----------+----------+----------+----------+----------+----------+ | **MON:** | C;F;REQ; | C; | C;F;REQ; | NoAc; | C;DUP; | | | | F;S;REQ; | | | | | Monitor | FIT; | | FIT; | MON; | FAT; | | | | FIT; | | | | | | IPEs? | | | Wait for | 1: Call | | | | Rare | | Frames | is back? | | | | case, | | | | | | | test | | | | +----------+----------+----------+----------+----------+----------+ | **MIS:** | C;F;ACK; | C; | C;F;REQ; | NoAc; | C;DUP; | | | | F;S;REQ; | | | | | Mismatch | CON; | | COR; | MIS; | FAT; | | | | COR; | | | | | | Mismatch | | | Wait for | 1: Call | | | resolved | Rare | | Frames | is back? | | | | case, | | | | | | | test | | | | +----------+----------+----------+----------+----------+----------+ | **CON:** | C;ACK; | C;T; | C;REQ; | C;T; | C;T; | | | | BT;T;T1; | | BT;T;T1; | BT;T;T1; | | Contact | CON; | | COR; | | | | | | KON; | | KON; | KON; | | | ** | | | | | | | Typical: | ** | | **yes! | Missed | | | wait** | Typical: | | Fast | TRANS? | | | | yes!**| | way** | | +----------+----------+----------+----------+----------+----------+ | **FAT:** | C; | C; | C; | NoAc; | NoAc; | | | REQ;RCm; | REQ;RCm; | REQ;RCm; | | | | Fast | | | | FAC; | FAT; | | | COR; | COR; | COR; | | | | Try | | | | Wait for | **2: | | | Safe way | Safe way | Safe way | Frames | Typ. Loc | | | | | | | HO** | +----------+----------+----------+----------+----------+----------+ | **FAC:** | C; | C; | C; | NoAc; | C | | | REQ;RCm; | REQ;RCm; | REQ;RCm; | | ;BT;T;L; | | Fast | | | | FAC; | T2;AT;B; | | | COR; | COR; | COR; | | | | Contact | | | | Wait for | OPE; | | | Safe way | Safe way | Safe way | Frames | | | | | | | | **5: | | | | | | | Typ. Loc | | | | | | | HO** | +----------+----------+----------+----------+----------+----------+ | **WRC:** | C;RCm | -\ | C; | -\ | AT; | | | ;REQ;T1; | ----\ | RCm;REQ; | ----\ | | | Wait_RC | | ----- | | ----- | WRC; | | | COR; | | COR; | | | +----------+----------+----------+----------+----------+----------+ | **KON:** | C;RCm;DT | NoAc; | NoAc; | NoAc; | RCs;AT | | | ;REQ;T1; | | | | ;L;T2;B; | | Konnect | | KON; | KON; | KON; | | | | COR; | | | | OPE; | | | | ** | | ** | | | | IPEs | Typical: | | Typical: | **Typ: | | | tran | wait** | | wait**| call | | | sparent! | | | | set-up** | +----------+----------+----------+----------+----------+----------+ | **REK:** | C;RCm | C | C;DT | NoAc; | AT | | | ;DT;REQ; | ;DT;REQ; | ;RCm;REQ | | ;L;T2;B; | | Re\ | IT;B;T1; | IT;B;T1; | ;IT;B;T1 | REK; | | | _Konnect | | | | | OPE; | | | COR; | COR; | COR; | Wait for | | | | | | | Frames | **5: | | | IPEs | | | | Typ. Dis | | | tran | | | | HO** | | | sparent! | | | | | +----------+----------+----------+----------+----------+----------+ | **SOS:** | C; | C;IT;R | C; | NoAc; | C;BT;T | | | RCm;IT;R | EQ;B;T1; | IT;RCm;R | | ;L;T2;B; | | Sy | EQ;B;T1; | | EQ;B;T1; | SOS; | | | nc_Lost | | COR; | | | OPE; | | | COR; | | COR; | Wait for | | | | | Contact | | Frames | short | | | Contact | is back | Contact | | In | | | is back | | is back | | terrupt? | +----------+----------+----------+----------+----------+----------+ | **OPE:** | -\ | -\ | -\ | NoAc; | NoAc; | | | ----\ | ----\ | ----\ | | | | O | ----- | ----- | ----- | OPE; | OPE; | | peration | | | | | | | | | | | Typical | **Main! | | | | | | in HO | TFO!** | +----------+----------+----------+----------+----------+----------+ | **FAI:** | NoAc; | NoAc; | NoAc; | NoAc; | NoAc; | | | | | | | | | Failure | FAI; | FAI; | FAI; | FAI; | FAI; | +----------+----------+----------+----------+----------+----------+ | **TT:** | -\ | -\ | -\ | -\ | -\ | | | ----\ | ----\ | ----\ | ----\ | ----\ | | T | ----- | ----- | ----- | ----- | ----- | | FO_Term | | | | | | +----------+----------+----------+----------+----------+----------+
Table 10.6-4: In Call Modification and Handover
+----------+----------+----------+----------+----------+----------+ | ** | **New |** New | **TFO\ |** TF | **TF | | Event** : | _Local\ | _Local\ | _Frame**| O_SYL** | O_DUP**| | | _Codec** | _Codec**| | | | | or | | | | | | | |** New\ | **New\ | | | | | | _Local_ | _Local_ | | | | | | Config** | Config**| | | | +----------+----------+----------+----------+----------+----------+ | Number: | 13, 14 | 15, 16 | 17 | 18 | 19 | +----------+----------+----------+----------+----------+----------+ | Co | (NA_TP | TM | Match_2 | | | | ndition: | \| | | | | | | | A_TP) | ICO==0 | | | | | & | | | | | | | | ICO==0 | | | | | +----------+----------+----------+----------+----------+----------+ | Comment: | In Call | In Call | Three or | The dist | The dist | | | Modif.\ | Modif.\ | more\ | TC lost\ | TC\ | | ** | Mismatch | Mismatch | TFO | sync in | re | | State:** | resolv | occurs | Frames | OPE | cognised | | | | | | | HO | | | | | | | | | | | | | | I | | | | | | | dentical | | | | | | | #17 | +----------+----------+----------+----------+----------+----------+ | **NAC:** | -\ | -\ | -\ | -\ | -\ | | | ----\ | ----\ | ----\ | ----\ | ----\ | | Not | ----- | ----- | ----- | ----- | ----- | | _Active | | | | | | +----------+----------+----------+----------+----------+----------+ | **WAK:** | NoAc; | NoAc; | -\ | -\ | -\ | | | | | ----\ | ----\ | ----\ | | Wakeup | WAK; | WAK; | ----- | ----- | ----- | +----------+----------+----------+----------+----------+----------+ | **FIT:** | C;REQ; | C;REQ; | -\ | NoAc; | NoAc; | | | | | ----\ | | | | Fi | FIT; | FIT; | ----- | FIT; | FIT; | | rst_Try | | | | | | | | Restart | Restart | | HO? | HO? | | | | | | Ignore | Ignore | +----------+----------+----------+----------+----------+----------+ | **COR:** | C;REQ; | C;REQ; | -\ | NoAc; | NoAc; | | | | | ----\ | | | | Co | COR; | COR; | ----- | COR; | COR; | | ntinuous | | | | | | | | | | | Ignore | Ignore | | Retry | | | | | | +----------+----------+----------+----------+----------+----------+ | **PER:** | L1;T5; | L1;T5; | -\ | C;F;REQ; | C;F;REQ; | | | | | ----\ | | | | Periodic | PER; | PER; | ----- | COR; | COR; | | | | | | | | | Retry | | | | Rare | Rare | | | | | | case, | case, | | | | | | test | test | +----------+----------+----------+----------+----------+----------+ | **MON:** | NoAc; | NoAc; | -\ | C;F;REQ; | C;F;REQ; | | | | | ----\ | | | | Monitor | MON; | MON; | ----- | FIT; | FIT; | | | | | | | | | | | | | Rare | Rare | | | | | | case, | case, | | | | | | test | test | +----------+----------+----------+----------+----------+----------+ | **MIS:** | C;F;REQ; | C | -\ | C;F;REQ; | C;F;REQ; | | | | ;L;T2;B; | ----\ | | | | Mismatch | COR; | | ----- | COR; | COR; | | | | MIS; | | | | | | ** | | | Rare | Rare | | | Mismatch | **Direct | | case, | case, | | | Res.** | info**| | test | test | +----------+----------+----------+----------+----------+----------+ |** CON:**| C;REQ; | C | -\ | C;F;REQ; | C;F;REQ; | | | | ;L;T2;B; | ----\ | | | | Contact | COR; | | ----- | COR; | COR; | | | | MIS; | | | | | | | | | Rare | Rare | | | | | | case, | case, | | | | | | test | test | +----------+----------+----------+----------+----------+----------+ |** FAT:**| NoAc; | C;L;T | NoAc; | NoAc; | C;F; | | | | 2;B;RCm; | | | REQ;RCm; | | Fast | FAT; | | FAC; | FAC; | | | | | MIS; | | | COR; | | Try | | | |** 3: | | | | | | | Typ. Loc | Rare | | | | | | HO**| case, | | | | | | | test | +----------+----------+----------+----------+----------+----------+ |** FAC:**| NoAc; | C;L;T | C;BT; | NoAc; | C;F; | | | | 2;B;RCm; | T;L;T2;A | | REQ;RCm; | | Fast | FAC; | | T;B;RCs; | FAC; | | | | | MIS; | | | COR; | | Contact | | | OPE; |** 4: Typ | | | | | | | Loc HO**| rare | | | | | assume | | case, | | | | | matching | | test | | | | | ACS | | | +----------+----------+----------+----------+----------+----------+ |** WRC:**| C; | C;RCm | NoAc; | NoAc; | NoAc; | | | RCm;REQ; | ;L;T2;B; | | | | | Wait_RC | | | WRC; | WRC; | WRC; | | | COR; | MIS; | | | | +----------+----------+----------+----------+----------+----------+ |** KON:**| C;RCm | C;RCm;DT | RCs;AT | NoAc; | NoAc; | | | ;DT;REQ; | ;L;T2;B; | ;L;T2;B; | | | | Konnect | | | | KON; | KON; | | | COR; | MIS; | OPE; | | | | | | | | Wait, | Other | | | | | | short | TC? | | | | | | int? | | +----------+----------+----------+----------+----------+----------+ |** REK:**| C;RCm;DT | C;R | -\ | C | NoAc; | | | ;IT;REQ; | Cm;DT;IT | ----\ | ;DT;SYL; | | | Re\ | | ;L;T2;B; | ----- | | REK; | | _Konnect | COR; | | | SOS; | | | | | MIS; | | |** 4: | | | | | | IPEs not | Typ. | | | | | | transp? | Dist | | | | | | | HO**| +----------+----------+----------+----------+----------+----------+ |** SOS:**| C;RCm | C;RCm;IT | -\ | NoAc; | C; | | | ;IT;REQ; | ;L;T2;B; | ----\ | | BT;T;T1; | | Sy | | | ----- | SOS; | | | nc_Lost | COR; | MIS; | | | REK; | | | | | | Short | | | | | | | Int |** 3: typ | | | | | | errupt.? | Dis HO**| +----------+----------+----------+----------+----------+----------+ |** OPE:**| R | C;R | NoAc; | NoAc; | NoAc; | | | Cs;L;T2; | Cm;DT;IT | | | | | O | | ;L;T2;B; | OPE; | OPE; | OPE; | | peration | OPE; | | | | | | | | MIS; | Main! | Short | Typical | | | | | TFO! | in | | | | | | | terrupt? | | +----------+----------+----------+----------+----------+----------+ |** FAI:**| NoAc; | NoAc; | NoAc; | NoAc; | NoAc; | | | | | | | | | Failure | FAI; | FAI; | FAI; | FAI; | FAI; | +----------+----------+----------+----------+----------+----------+ |** TT:** | C;F;REQ; | NoAc; | NoAc; | IT;N; | NoAc; | | | | | | | | | T | COR; | TT; | TT; | NAC; | TT; | | FO_Term | | | | | | +----------+----------+----------+----------+----------+----------+
Table 10.6-5: Special Matching TFO Messages
+-------------+-------------+-------------+-------------+-------------+ | **Event** : | **TF |** TF | **TF |** TF | | | O_REQ_L**| O_REQ_L** | O_ACK_L**| O_ACK_L** | +-------------+-------------+-------------+-------------+-------------+ | Number: | 20 | 21 | 22 | 23 | +-------------+-------------+-------------+-------------+-------------+ | Condition: | (NA_TP \| | (NA_TP \| | (NA_TP \| | (NA_TP \| | | | A_TP) | A_TP) | A_TP) | A_TP) | | & | | | | | | | Dsig==Lsig | Dsig!=Lsig | Dsig==Lsig | Dsig!=Lsig | +-------------+-------------+-------------+-------------+-------------+ | Comment: | Only sent | Only sent | Only sent | HO? | | | in | in | in MIS; HO? | | | **State:** | MIS/OPE/PER | MIS/OPE/PER | | | | | HO? Loop? | Codec_List | | | +-------------+-------------+-------------+-------------+-------------+ | **NAC:** | ---- | ---- | ---- | ---- | | | ------ | ------ | ------ | ------ | | Not_Active | | | | | +-------------+-------------+-------------+-------------+-------------+ | **WAK:** | ---- | ---- | ---- | ---- | | | ------ | ------ | ------ | ------ | | Wakeup | | | | | +-------------+-------------+-------------+-------------+-------------+ | **FIT:** | NoAc; | NoAc; | NoAc; | NoAc; | | | | | | | | First_Try | FIT; | FIT; | FIT; | FIT; | | | | | | | | | Ignore | Ignore | Ignore | Ignore | +-------------+-------------+-------------+-------------+-------------+ | **COR:** | NoAc; | NoAc; | NoAc; | NoAc; | | | | | | | | Continuous | COR; | COR; | COR; | COR; | | | | | | | | Retry | Ignore | Ignore | Ignore | Ignore | +-------------+-------------+-------------+-------------+-------------+ | **PER:** | C;F;S;REQ; | C;F;REQ; | C;F;S;REQ; | C;F;REQ; | | | | | | | | Periodic | COR; | COR; | COR; | COR; | | | | | | | | Retry | Start again | Start again | Test | Test | +-------------+-------------+-------------+-------------+-------------+ | **MON:** | C;F;S;REQ; | C;F;REQ; | C;F;S;REQ; | C;F;REQ; | | | | | | | | Monitor | FIT; | FIT; | FIT; | FIT; | | | | | | | | | Test | Test | Test | Test | +-------------+-------------+-------------+-------------+-------------+ | **MIS:** | C;F;S;REQ; | C;F;REQ; | C;F;S;REQ; | C;F;REQ; | | | | | | | | Mismatch | COR; | COR; | COR; | COR; | | | | | | | | | Test | Test | Test | Test | +-------------+-------------+-------------+-------------+-------------+ | **CON:** | C;S;REQ; | C;REQ; | C;S;REQ; | C;REQ; | | | | | | | | Contact | COR; | COR; | COR; | COR; | | | | | | | | | Safe way! | Safe way! | Safe way! | Safe way! | +-------------+-------------+-------------+-------------+-------------+ | **FAT:** | C | C;REQ;RCm; | C | C;REQ;RCm; | | | ;S;REQ;RCm; | | ;S;REQ;RCm; | | | Fast | | COR; | | COR; | | | COR; | | COR; | | | Try | | Safe way! | | Safe way! | | | Safe way! | | Safe way! | | +-------------+-------------+-------------+-------------+-------------+ | **FAC:** | C | C;REQ;RCm; | C | C;REQ;RCm; | | | ;S;REQ;RCm; | | ;S;REQ;RCm; | | | Fast | | COR; | | COR; | | | COR; | | COR; | | | Contact | | Safe way! | | Safe way! | | | Safe way! | | Safe way! | | +-------------+-------------+-------------+-------------+-------------+ | **WRC:** | C | C;RCm;REQ; | C | C;RCm;REQ; | | | ;S;RCm;REQ; | | ;S;RCm;REQ; | | | Wait_RC | | COR; | | COR; | | | COR; | | COR; | | +-------------+-------------+-------------+-------------+-------------+ | **KON:** | C;RCm;D | C;RCm | C;RCm;D | C;RCm | | | T;S;REQ;T1; | ;DT;REQ;T1; | T;S;REQ;T1; | ;DT;REQ;T1; | | Konnect | | | | | | | COR; | COR; | COR; | COR; | | | | | | | | | Safe way! | Safe way! | Safe way! | Safe way! | +-------------+-------------+-------------+-------------+-------------+ | **REK:** | C;RCm;DT;I | C;RCm;DT | C;RCm;DT;I | C;RCm;DT | | | T;S;REQ;T1; | ;IT;REQ;T1; | T;S;REQ;T1; | ;IT;REQ;T1; | | Re_Konnect | | | | | | | COR; | COR; | COR; | COR; | | | | | | | | | Safe way! | Safe way! | Safe way! | Safe way! | +-------------+-------------+-------------+-------------+-------------+ | **SOS:** | C;RCm;IT; | C;RCm;I | C;RCm;IT; | C;RCm;I | | | S;REQ;B;T1; | T;REQ;B;T1; | S;REQ;B;T1; | T;REQ;B;T1; | | Sync_Lost | | | | | | | COR; | COR; | COR; | COR; | | | | | | | | | Safe way! | Safe way! | Safe way! | Safe way! | +-------------+-------------+-------------+-------------+-------------+ | **OPE:** | S;L;T2;B; | C;RCs;LA;B; | C;RCs;B; | S;L;T2;B; | | | | | | | | Operation | OPE; | OPE; | OPE; | OPE; | | | | | | | | | Tx | Ack List, | Ack ok, | Exchange | | | Codec_List | stop | stop | list | +-------------+-------------+-------------+-------------+-------------+ | **FAI:** | NoAc; | NoAc; | NoAc; | NoAc; | | | | | | | | Failure | FAI; | FAI; | FAI; | FAI; | +-------------+-------------+-------------+-------------+-------------+ | **TT:** | ---- | C;B; | C;B; | ---- | | | ------ | | | ------ | | TFO_Term | | TT; | TT; | | +-------------+-------------+-------------+-------------+-------------+
Table 10.6-6: TFO Messages with mismatching Codec Type / Configuration
+---------+---------+---------+---------+---------+---------+---------+ | **E |** TFO | **TFO |** TFO | * | * | * | | vent**: | _REQ** | _REQ**| _ACK** | _TFO_R |_ TFO_R | _TFO_A | | | | | | EQ_L_ _| EQ_L_ _| CK_L_ _| +---------+---------+---------+---------+---------+---------+---------+ | Number: | 24 | 25 | 26 | 27 | 28 | 29 | +---------+---------+---------+---------+---------+---------+---------+ | Con | TM | TM | TM | TM | TM | TM | | dition: | | | | | | | | | Dsi | Dsi | Dsig=? | Dsi | Dsi | Dsig==? | | & | g==Lsig | g!=Lsig | | g==Lsig | g!=Lsig | | | | | | ICO==0 | | | | | & | | ICO==0 | | | | | +---------+---------+---------+---------+---------+---------+---------+ | C | M | M | M | M | M | M | | omment: | ismatch | ismatch | ismatch | ismatch | ismatch | ismatch | | | | | | | | | | __S | Wrong | Good | w/wo HO | Code | Code | Code | | tate:__| Sig, | Sig | | c_List | c_List | c_List | | | HO? | | id | | | | | | | | entical | Wrong | Id | Id | | | | | #8 | Sig, | entical | entical | | | | | | HO? | #20 | #19 | +---------+---------+---------+---------+---------+---------+---------+ | * | --\ | --\ | --\ | --\ | --\ | --\ | |_ NAC:**| ---- | ---- | ---- | ---- | ---- | ---- | | | ---- | ---- | ---- | ---- | ---- | ---- | | Not\ | | | | | | | | _Active | | | | | | | +---------+---------+---------+---------+---------+---------+---------+ | * | --\ | --\ | --\ | --\ | --\ | --\ | | *WAK:** | ---- | ---- | ---- | ---- | ---- | ---- | | | ---- | ---- | ---- | ---- | ---- | ---- | | Wakeup | | | | | | | +---------+---------+---------+---------+---------+---------+---------+ | * | C;S; | C;U; | C;U; | C; | C; | C; | | _FIT:__| L;T2;B; | L;T2;B; | L;T2;B; | S;LA;B; | U;LA;B; | U;LA;B; | | | | | | | | | | Fir | MIS; | MIS; | MIS; | MIS; | MIS; | MIS; | | st_Try | | | | | | | | | Rare |__T | HO? | rare |__T | HO? | | | | ypical: | | | ypical: | | | | | Setup_ _| | | Setup_ _| | +---------+---------+---------+---------+---------+---------+---------+ | * | C;S; | C;U; | C;U; | C; | C; | C; | |_ COR:**| L;T2;B; | L;T2;B; | L;T2;B; | S;LA;B; | U;LA;B; | U;LA;B; | | | | | | | | | | Con | MIS; | MIS; | MIS; | MIS; | MIS; | MIS; | | tinuous | | | | | | | | | | | | | | | | Retry | | | | | | | +---------+---------+---------+---------+---------+---------+---------+ | * | C;F;S; | C;F; | C;F; | C;F; | C; | C; | | *PER:** | L;T2;B; | L;T2;B; | L;T2;B; | S;LA;B; | F;LA;B; | F;LA;B; | | | | | | | | | | P | MIS; | MIS; | MIS; | MIS; | MIS; | MIS; | | eriodic | | | | | | | | | | | | | | | | Retry | | | | | | | +---------+---------+---------+---------+---------+---------+---------+ | * | C;F;S; | C;F; | C;F; | C;F; | C; | C; | | _MON:__| L;T2;B; | L;T2;B; | L;T2;B; | S;LA;B; | F;LA;B; | F;LA;B; | | | | | | | | | | Monitor | MIS; | MIS; | MIS; | MIS; | MIS; | MIS; | +---------+---------+---------+---------+---------+---------+---------+ | * | C;S; | C; | C; | C; | C;LA;B; | C;LA;B; | |_ MIS:**| L;T2;B; | L;T2;B; | L;T2;B; | S;LA;B; | | | | | | | | | MIS; | MIS; | | M | MIS; | MIS; | MIS; | MIS; | | | | ismatch | | | | |** Te | **Te | | | | | | | rminate | rminate | | | | | | | Prot.** | Prot.**| +---------+---------+---------+---------+---------+---------+---------+ | * | C;S; | C; | C; | C; | C;LA;B; | C;LA;B; | | *CON:** | L;T2;B; | L;T2;B; | L;T2;B; | S;LA;B; | | | | | | | | | MIS; | MIS; | | Contact | MIS; | MIS; | MIS; | MIS; | | | +---------+---------+---------+---------+---------+---------+---------+ | * | C | C;L;T2 | C;L;T2 | C;S;LA | C;LA | C;LA | | _FAT:__| ;S;L;T2 | ;B;RCm; | ;B;RCm; | ;B;RCm; | ;B;RCm; | ;B;RCm; | | | ;B;RCm; | | | | | | | Fast | | MIS; | MIS; | MIS; | MIS; | MIS; | | | MIS; | | | | | | | Try | | | | | | | +---------+---------+---------+---------+---------+---------+---------+ | * | C | C;L;T2 | C;L;T2 | C;S;LA | C;LA | C;LA | |_ FAC:**| ;S;L;T2 | ;B;RCm; | ;B;RCm; | ;B;RCm; | ;B;RCm; | ;B;RCm; | | | ;B;RCm; | | | | | | | Fast | | MIS; | MIS; | MIS; | MIS; | MIS; | | | MIS; | | | | | | | Contact | | | | | | | +---------+---------+---------+---------+---------+---------+---------+ | * | C | C;RCm; | C;RCm; | C;S;RC | C;RC | C;RC | | *WRC:** | ;S;RCm; | L;T2;B; | L;T2;B; | m;LA;B; | m;LA;B; | m;LA;B; | | | L;T2;B; | | | | | | | W | | MIS; | MIS; | MIS; | MIS; | MIS; | | ait_RC | MIS; | | | | | | +---------+---------+---------+---------+---------+---------+---------+ | * | C;RC | C; | C; | C; | C;RCm;D | C;RCm;D | | _KON:__| m;DT;S; | RCm;DT; | RCm;DT; | RCm;DT; | T;LA;B; | T;LA;B; | | | L;T2;B; | L;T2;B; | L;T2;B; | S;LA;B; | | | | Konnect | | | | | MIS; | MIS; | | | MIS; | MIS; | MIS; | MIS; | | | +---------+---------+---------+---------+---------+---------+---------+ | * | C;RCm;D | C;RCm | C;RCm | C;RCm | C;R | C;R | |_ REK:**| T;S;L;T | ;DT;L;T | ;DT;L;T | ;DT;S;L | Cm;DT;L | Cm;DT;L | | | 2;IT;B; | 2;IT;B; | 2;IT;B; | A;IT;B; | A;IT;B; | A;IT;B; | | Re_ | | | | | | | | Konnect | MIS; | MIS; | MIS; | MIS; | MIS; | MIS; | +---------+---------+---------+---------+---------+---------+---------+ | * | C;RC | C; | C; | C; | C;RCm;L | C;RCm;L | | *SOS:** | m;S;L;T | RCm;L;T | RCm;L;T | RCm;S;L | A;IT;B; | A;IT;B; | | | 2;IT;B; | 2;IT;B; | 2;IT;B; | A;IT;B; | | | | Syn | | | | | MIS; | MIS; | | c_Lost | MIS; | MIS; | MIS; | MIS; | | | | | | | | | **I | | | | | | | | n_Call | | | | | | | | _Mod** | | +---------+---------+---------+---------+---------+---------+---------+ | * | --\ | --\ | --\ | NoAc; | NoAc; | --\ | | _OPE:__| ---- | ---- | ---- | | | ---- | | | ---- | ---- | ---- | OPE; | OPE; | ---- | | Op | | | | | | | | eration | | | | Trans | Trans | | | | | | | Error? | Error? | | +---------+---------+---------+---------+---------+---------+---------+ | * | NoAc; | NoAc; | NoAc; | NoAc; | NoAc; | NoAc; | |_ FAI:**| | | | | | | | | FAI; | FAI; | FAI; | FAI; | FAI; | FAI; | | Failure | | | | | | | +---------+---------+---------+---------+---------+---------+---------+ |** TT:** | --\ | --\ | --\ | --\ | C;B; | C;B; | | | ---- | ---- | ---- | ---- | | | | TF | ---- | ---- | ---- | ---- | TT; | TT; | | O_Term | | | | | | | +---------+---------+---------+---------+---------+---------+---------+
Table 10.6-7 AMR and AMR-WB Cases: TFO_TRANS, TFO_ACK, RC_ack
+-------------+-----------------+-----------------+-----------------+ | **Event** : | **TFO_TRANS** | **TFO_ACK** | **RC_ack** | +-------------+-----------------+-----------------+-----------------+ | Number: | 30 | 31 | 32 | +-------------+-----------------+-----------------+-----------------+ | Condition: | Luc == AMR | A_TP | | | | | | | | & | DCh==LCh | Dsig==Lsig | | | | | | | | & | | ICO==0 | | +-------------+-----------------+-----------------+-----------------+ | Comment: | | Good Sig | BTS/RNC has | | | | | steered the | | **State:** | | Immediate TFO | mode down, but | | | | possible | this has not | | | | | been completed, | | | | | therefore delay | | | | | by another | | | | | TFO_ACK | +-------------+-----------------+-----------------+-----------------+ | **NAC:** | -- | -- | NoAc; | | | -------- | -------- | | | Not_Active | | | NAC; | +-------------+-----------------+-----------------+-----------------+ | **WAK:** | -- | -- | NoAc; | | | -------- | -------- | | | Wakeup | | | WAK; | +-------------+-----------------+-----------------+-----------------+ | **FIT:** | NoAc; | C;U;RCi;ACK;T1; | NoAc; | | | | | | | First_Try | FIT; | WRC; | FIT; | | | | | | | | Wait for Frame | **Typical;** | | +-------------+-----------------+-----------------+-----------------+ | **COR:** | NoAc; | C;U;RCi;ACK;T1; | NoAc; | | | | | | | Continuous | COR; | WRC; | COR; | | | | | | | Retry | Wait for Frames | **Typical** | | +-------------+-----------------+-----------------+-----------------+ | **PER:** | NoAc; | C;F;S;REQ; | NoAc; | | | | | | | Periodic | PER; | COR; | PER; | | | | | | | Retry | Wait for Frames | Rare case, test | | +-------------+-----------------+-----------------+-----------------+ | **MON:** | NoAc; | C;F;S;REQ; | NoAc; | | | | | | | Monitor | MON; | FIT; | MON; | | | | | | | | Wait for Frames | Rare case, test | | +-------------+-----------------+-----------------+-----------------+ | **MIS:** | NoAc; | C;F;S;REQ; | NoAc; | | | | | | | Mismatch | MIS; | COR; | MIS; | | | | | | | | Wait for Frames | Rare case, test | | +-------------+-----------------+-----------------+-----------------+ | **CON:** | C;RCi;ACK;T1; | C;RCi;ACK;T1; | NoAc; | | | | | | | Contact | WRC; | WRC; | CON; | | | | | | | | Missed Ack | **Typical** | | +-------------+-----------------+-----------------+-----------------+ | **FAT:** | NoAc; | C;REQ;RCm; | NoAc; | | | | | | | Fast | FAC; | COR; | FAT; | | | | | | | Try | Wait for Frames | Safe way | | +-------------+-----------------+-----------------+-----------------+ | **FAC:** | NoAc; | C;REQ;RCm; | NoAc; | | | | | | | Fast | FAC; | COR; | FAC; | | | | | | | Contact | Wait for Frames | Safe way | | +-------------+-----------------+-----------------+-----------------+ | **WRC:** | NoAc; | NoAc; | C; | | | | | ACK1;T;BT;T;T2; | | Wait_RC | WRC; | WRC; | | | | | | KON; | | | | | | | | | | **Typical** | +-------------+-----------------+-----------------+-----------------+ | **KON:** | NoAc; | NoAc; | NoAc; | | | | | | | Konnect | KON; | KON; | KON; | | | | | | | | **Typical: |** Typical: | | | | wait**| wait** | | +-------------+-----------------+-----------------+-----------------+ | **REK:** | NoAc; | C; | NoAc; | | | | DT;REQ;IT;B;T1; | | | Re_Konnect | REK; | | REK; | | | | COR; | | | | Wait for Frames | | | +-------------+-----------------+-----------------+-----------------+ | **SOS:** | NoAc; | C;IT;REQ;B;T1; | NoAc; | | | | | | | Sync_Lost | SOS; | COR; | SOS; | | | | | | | | Wait for Frames | Contact is back | | +-------------+-----------------+-----------------+-----------------+ | **OPE:** | NoAc; | -- | NoAc; | | | | -------- | | | Operation | OPE; | | OPE; | | | | | | | | Typical in HO | | | +-------------+-----------------+-----------------+-----------------+ | **FAI:** | NoAc; | NoAc; | NoAc; | | | | | | | Failure | FAI; | FAI; | FAI; | +-------------+-----------------+-----------------+-----------------+ | **TT:** | -- | -- | NoAc; | | | -------- | -------- | | | TFO_Term | | | TT; | +-------------+-----------------+-----------------+-----------------+
Table 10.6-8 Handover_Soon
+-------------+---------------------+---------------------+ | **Event** : | **Handover_Soon** | **Handover_Soon** | +-------------+---------------------+---------------------+ | Number: | 35 | 36 | +-------------+---------------------+---------------------+ | Condition: | (NA_TP \| A_TP) | TM | | | | | | & | | | +-------------+---------------------+---------------------+ | Comment: | Local hand-over | Local hand-over | | | | | | **State:** | future parameters | future parameters | +-------------+---------------------+---------------------+ | **NAC:** | ---------- | ---------- | | | | | | Not_Active | | | +-------------+---------------------+---------------------+ | **WAK:** | ---------- | ---------- | | | | | | Wakeup | | | +-------------+---------------------+---------------------+ | **FIT:** | C; | C; | | | | | | First_Try | NAC; | NAC; | +-------------+---------------------+---------------------+ | **COR:** | C; | C; | | | | | | Continuous | NAC; | NAC; | | | | | | Retry | | | +-------------+---------------------+---------------------+ | **PER:** | C; | C; | | | | | | Periodic | NAC; | NAC; | | | | | | Retry | | | +-------------+---------------------+---------------------+ | **MON:** | C; | C; | | | | | | Monitor | NAC; | NAC; | +-------------+---------------------+---------------------+ | **MIS:** | C; | C; | | | | | | Mismatch | NAC; | NAC; | +-------------+---------------------+---------------------+ | **CON:** | C; | C; | | | | | | Contact | NAC; | NAC; | +-------------+---------------------+---------------------+ | **FAT:** | C;RCm; | C;RCm; | | | | | | Fast | NAC; | NAC; | | | | | | Try | | | +-------------+---------------------+---------------------+ | **FAC:** | C;RCm; | C;RCm; | | | | | | Fast | NAC; | NAC; | | | | | | Contact | | | +-------------+---------------------+---------------------+ | **WRC:** | C;RCm; | C;RCm; | | | | | | Wait_RC | NAC; | NAC; | +-------------+---------------------+---------------------+ | **KON:** | RCh; | C;RCm;DT; | | | | | | Konnect | KON; | NAC; | +-------------+---------------------+---------------------+ | **REK:** | RCh; | C;RCm;DT;IT; | | | | | | Re_Konnect | REK; | NAC; | +-------------+---------------------+---------------------+ | **SOS:** | RCh; | C;RCm;IT; | | | | | | Sync_Lost | SOS; | NAC; | +-------------+---------------------+---------------------+ | **OPE:** | RCh; | C;RCm;DT;T1; | | | | | | Operation | OPE; | TT; | +-------------+---------------------+---------------------+ | **FAI:** | ---------- | ---------- | | | | | | Failure | | | +-------------+---------------------+---------------------+ | **TT:** | NoAc; | NoAc; | | | | | | TFO_Term | TT; | TT; | +-------------+---------------------+---------------------+
Table 10.6-9: Mismatching TFO_TRANS and TFO Frames
+-------------+---------------------+-------------------------+---------------------+ | **Event** : | **TFO_TRANS** | **TFO_Frame** | **TFO_Frame** | +-------------+---------------------+-------------------------+---------------------+ | Number: | 37 | 38 | 39 | +-------------+---------------------+-------------------------+---------------------+ | Condition: | DCh!=LCh | Mismatch_1 | Mismatch_2 | | | | | | | & | | | | +-------------+---------------------+-------------------------+---------------------+ | Comment: | Mismatch | Mismatch for one or two | Continued Mismatch | | | | | | | **State:** | of channel type | TFO Frames | | +-------------+---------------------+-------------------------+---------------------+ | **NAC:** | ---------- | ---------- | ---------- | | | | | | | Not_Active | | | | +-------------+---------------------+-------------------------+---------------------+ | **WAK:** | ---------- | ---------- | ---------- | | | | | | | Wakeup | | | | +-------------+---------------------+-------------------------+---------------------+ | **FIT:** | C;U;L;T2;B; | NoAc; | C;U;L;T2;B; | | | | | | | First_Try | MIS; | FIT; | MIS; | | | | | | | | HO? | HO? be tolerant | **Typical in HO** | +-------------+---------------------+-------------------------+---------------------+ | **COR:** | C;U;L;T2;B; | NoAc; | C;U;L;T2;B; | | | | | | | Continuous | MIS; | COR; | MIS; | | | | | | | Retry | | Call Forw? | | +-------------+---------------------+-------------------------+---------------------+ | **PER:** | C;F;L;T2;B; | NoAc; | C;F;L;T2;B; | | | | | | | Periodic | MIS; | PER; | MIS; | | | | | | | Retry | | Call Forw? | | +-------------+---------------------+-------------------------+---------------------+ | **MON:** | C;F;L;T2;B; | NoAc; | C;F;L;T2;B; | | | | | | | Monitor | MIS; | MON; | MIS; | | | | | | | | | Call Forw? | | +-------------+---------------------+-------------------------+---------------------+ | **MIS:** | C;L;T2;B; | NoAc; | C;L;T2;B; | | | | | | | Mismatch | MIS; | MIS; | MIS; | | | | | | | | | Call Forw? | | +-------------+---------------------+-------------------------+---------------------+ | **CON:** | C;L;T2;B; | NoAc; | C;L;T2;B; | | | | | | | Contact | MIS; | CON; | MIS; | +-------------+---------------------+-------------------------+---------------------+ | **FAT:** | C;L;T2;B;RCm; | NoAc; | C;L;T2;B;RCm; | | | | | | | Fast | MIS; | FAT; | MIS; | | | | | | | Try | | | | +-------------+---------------------+-------------------------+---------------------+ | **FAC:** | C;L;T2;B;RCm; | NoAc; | C;L;T2;B;RCm; | | | | | | | Fast | MIS; | FAC; | MIS; | | | | | | | Contact | | | | +-------------+---------------------+-------------------------+---------------------+ | **WRC:** | C;RCm;L;T2;B; | NoAc; | C;RCm;L;T2;B; | | | | | | | Wait_RC | MIS; | WRC; | MIS; | +-------------+---------------------+-------------------------+---------------------+ | **KON:** | C;RCm;DT;L;T2;B; | NoAc; | C;RCm;DT;L;T2;B; | | | | | | | Konnect | MIS; | KON; | MIS; | +-------------+---------------------+-------------------------+---------------------+ | **REK:** | C;RCm;DT;L;T2;IT;B; | NoAc; | C;RCm;DT;L;T2;IT;B; | | | | | | | Re_Konnect | MIS; | REK; | MIS; | +-------------+---------------------+-------------------------+---------------------+ | **SOS:** | C;RCm;L;T2;IT;B; | NoAc; | C;RCm;L;T2;IT;B; | | | | | | | Sync_Lost | MIS; | SOS; | MIS; | +-------------+---------------------+-------------------------+---------------------+ | **OPE:** | NoAc; | NoAc; | C;RCm;DT;L;T2;IT;B; | | | | | | | Operation | OPE; | OPE; | MIS; | | | | | | | | Ignore? | Hard HO? | Hard HO into TFO | +-------------+---------------------+-------------------------+---------------------+ | **FAI:** | NoAc; | NoAc; | NoAc; | | | | | | | Failure | FAI; | FAI; | FAI; | +-------------+---------------------+-------------------------+---------------------+ | **TT:** | ---------- | ---------- | ---------- | | | | | | | TFO_Term | | | | +-------------+---------------------+-------------------------+---------------------+
Table 10.6-10: Local Events, TFO_FILL, TFO_NORMAL
+-------------+-------------+-------------+-------------+-------------+ | **Event** : | **New |** D | ** | **TF | | | _Local_Co | ata_Call** | TFO_FILL**| O_NORMAL** | | | dec_List**| | | | +-------------+-------------+-------------+-------------+-------------+ | Number: | 40 | 41 | 42 | 43 | +-------------+-------------+-------------+-------------+-------------+ | Condition: | | | | | | | | | | | | & | | | | | +-------------+-------------+-------------+-------------+-------------+ | Comment: | From RAN | In Call | Ignore\ | Ignore\ | | | | Modif. | is just\ | al | | **State:**| | | Filler | ternative:\ | | | | Stop TFO | | Soft Reset | | | | (see | | | | | | TF | | | | | | O_Disable) | | | +-------------+-------------+-------------+-------------+-------------+ |** NAC:**| NoAc; | NoAc; | ---- | ---- | | | | | ------ | ------ | | Not_Active | NAC; | NAC; | | | +-------------+-------------+-------------+-------------+-------------+ |** WAK:**| NoAc; | NoAc; | ---- | ---- | | | | | ------ | ------ | | Wakeup | WAK; | NAC; | | | +-------------+-------------+-------------+-------------+-------------+ |** FIT:**| NoAc; | C;N; | NoAc; | NoAc; | | | | | | | | First_Try | FIT; | NAC; | FIT; | FIT; | | | | | | | | | Update loc. | | | | | | Par. | | | | +-------------+-------------+-------------+-------------+-------------+ |** COR:**| NoAc; | C;N; | NoAc; | NoAc; | | | | | | | | Continuous | COR; | NAC; | COR; | COR; | | | | | | | | Retry | | | | | +-------------+-------------+-------------+-------------+-------------+ |** PER:**| NoAc; | C;N; | NoAc; | NoAc; | | | | | | | | Periodic | PER; | NAC; | PER; | PER; | | | | | | | | Retry | | | | | +-------------+-------------+-------------+-------------+-------------+ |** MON:**| NoAc; | C;N; | NoAc; | NoAc; | | | | | | | | Monitor | MON; | NAC; | MON; | MON; | +-------------+-------------+-------------+-------------+-------------+ |** MIS:**| C;L;T2; | C;N; | NoAc; | NoAc; | | | | | | | | Mismatch | MIS; | NAC; | MIS; | MIS; | | | | | | | | |** direct | | | | | | info**| | | | +-------------+-------------+-------------+-------------+-------------+ |** CON:**| NoAc; | C;N; | NoAc; | NoAc; | | | | | | | | Contact | CON; | NAC; | CON; | CON; | +-------------+-------------+-------------+-------------+-------------+ |** FAT:**| NoAc; | C;N;RCm; | NoAc; | NoAc; | | | | | | | | Fast | FAT; | NAC; | FAT; | FAT; | | | | | | | | Try | | | | | +-------------+-------------+-------------+-------------+-------------+ |** FAC:**| NoAc; | C;N;RCm; | NoAc; | NoAc; | | | | | | | | Fast | FAC; | NAC; | FAC; | FAC; | | | | | | | | Contact | | | | | +-------------+-------------+-------------+-------------+-------------+ |** WRC:**| NoAc; | C;N; | NoAc; | NoAc; | | | | | | | | Wait_RC | WRC; | NAC; | WRC; | WRC; | +-------------+-------------+-------------+-------------+-------------+ |** KON:**| NoAc; | C;DT;N; | NoAc; | NoAc; | | | | | | | | Konnect | KON; | NAC; | KON; | KON; | +-------------+-------------+-------------+-------------+-------------+ |** REK:**| NoAc; | C;DT;IT;N; | NoAc; | NoAc; | | | | | | | | Re_Konnect | REK; | NAC; | REK; | REK; | +-------------+-------------+-------------+-------------+-------------+ |** SOS:**| NoAc; | C;IT;N; | NoAc; | NoAc; | | | | | | | | Sync_Lost | SOS; | NAC; | SOS; | SOS; | +-------------+-------------+-------------+-------------+-------------+ |** OPE:**| L;T2; | C;DT;IT;N; | NoAc; | NoAc; | | | | | | | | Operation | OPE; | NAC; | OPE; | OPE; | | | | | | | | |** direct | | | | | | info**| | | | +-------------+-------------+-------------+-------------+-------------+ |** FAI:**| NoAc; | C; | NoAc; | NoAc; | | | | | | | | Failure | FAI; | NAC; | FAI; | FAI; | | | | | | | | | |** exit from | | | | | | FAI**| | | +-------------+-------------+-------------+-------------+-------------+ |** TT:** | NoAc; | IT;N; | ---- | ---- | | | | | ------ | ------ | | TFO_Term | TT; | NAC; | | | +-------------+-------------+-------------+-------------+-------------+
Table 10.6-11: Special Events, Timeouts
+----------+----------+----------+----------+----------+----------+ | ** | ** | **T==0** | **Fra |** Fra | **M | | Event** : | Runout**| | me_Sync | me_Sync | es_Sync | | | | | _Lost** | _Lost**| _Lost** | +----------+----------+----------+----------+----------+----------+ | Number: | 44 | 45 | 46 | 47 | 48 | +----------+----------+----------+----------+----------+----------+ | Co | | | n\2 | | | ndition: | | | | | | | | | | | TFO_ | | | & | | | | Disabled | | +----------+----------+----------+----------+----------+----------+ | Comment: | IPEs may | Time-Out | start to | Stop TFO | | | | become | | send | Frames | | | ** | | | | | | | State:**| unsync | | SYL | if 3 | | | | hronised | | already | Frames | | | | | | | missing | | +----------+----------+----------+----------+----------+----------+ |** NAC:**| -\ | -\ | -\ | -\ | -\ | | | ----\ | ----\ | ----\ | ----\ | ----\ | | Not | ----- | ----- | ----- | ----- | ----- | | _Active | | | | | | +----------+----------+----------+----------+----------+----------+ |** WAK:**| -\ | -\ | -\ | -\ | -\ | | | ----\ | ----\ | ----\ | ----\ | ----\ | | Wakeup | ----- | ----- | ----- | ----- | ----- | +----------+----------+----------+----------+----------+----------+ |** FIT:**| U;N; | -\ | -\ | -\ | NoAc; | | | | ----\ | ----\ | ----\ | | | Fi | MON; | ----- | ----- | ----- | FIT; | | rst_Try | | | | | | | |** PSTN | | | | | | | Call**| | | | | +----------+----------+----------+----------+----------+----------+ |** COR:**| U;L1;T5; | C;N;REQ; | -\ | -\ | NoAc; | | | | | ----\ | ----\ | | | Co | PER; | COR; | ----- | ----- | COR; | | ntinuous | | | | | | | |** at end | Reset | | | | | Retry | of COR**| IPEs | | | | +----------+----------+----------+----------+----------+----------+ |** PER:**| NoAc; | L1;T5; | -\ | -\ | NoAc; | | | | | ----\ | ----\ | | | Periodic | PER; | PER; | ----- | ----- | PER; | | | | | | | | | Retry | | ** | | | | | | | Periodic | | | | | | | Test** | | | | +----------+----------+----------+----------+----------+----------+ | **MON:** | -\ | C;N; | -\ | -\ | -\ | | | ----\ | | ----\ | ----\ | ----\ | | Monitor | ----- | MON; | ----- | ----- | ----- | +----------+----------+----------+----------+----------+----------+ | **MIS:** | NoAc; | N;B; | NoAc; | NoAc; | NoAc; | | | | | | | | | Mismatch | MIS; | MIS; | MIS; | MIS; | MIS; | | | | | | | | | | **typ | List not | | | | | | Final | Ack_ed! | | | | | | state** | | | | | +----------+----------+----------+----------+----------+----------+ | **CON:** | REQ; | -\ | -\ | -\ | C;REQ; | | | | ----\ | ----\ | ----\ | | | Contact | COR; | ----- | ----- | ----- | COR; | | | | | | | | | | can this | | | | | | | occur? | | | | | +----------+----------+----------+----------+----------+----------+ | **FAT:** | REQ;RCm; | -\ | NoAc; | NoAc; | C; | | | | ----\ | | | REQ;RCm; | | Fast | COR; | ----- | FAT; | FAT; | | | | | | | | COR; | | Try | fast HO | | typical | typical | | | | failed | | in HO | in HO | fast HO | | | | | | | failed | +----------+----------+----------+----------+----------+----------+ | **FAC:** | REQ;RCm; | -\ | NoAc; | NoAc; | C; | | | | ----\ | | | REQ;RCm; | | Fast | COR; | ----- | FAC; | FAC; | | | | | | | | COR; | | Contact | fast HO | | typical | typical | | | | failed | | in HO | in HO | fast HO | | | | | | | failed | +----------+----------+----------+----------+----------+----------+ | **WRC:** | C;RCm; | C;RCm; | NoAc; | IT; | C; | | | | | | | RCm;REQ; | | Wait_RC | FAI; | FAI; | WRC; | WRC; | | | | | | | | COR; | | | Missing | Missing | | | | | | RC_Ack | RC_Ack | | | | +----------+----------+----------+----------+----------+----------+ | **KON:** | NoAc; | C;R | -\ | -\ | C;RCm;DT | | | | Cm;DT;N; | ----\ | ----\ | ;REQ;T1; | | Konnect | KON; | | ----- | ----- | | | | | FAI; | | | COR; | | | may | | | | | | | happen | Misbe | | | after | | | | haviour! | | | Timeout: | | | | | | | N | +----------+----------+----------+----------+----------+----------+ | **REK:** | NoAc; | C;RCm;DT | -\ | -\ | C;RCm | | | | ;N;IT;B; | ----\ | ----\ | ;DT;REQ; | | Re\ | REK; | | ----- | ----- | IT;B;T1; | | _Konnect | | FAI; | | | | | | may | | | | COR; | | | happen | Misbe | | | | | | | haviour! | | | after | | | | | | | Timeout: | | | | | | | N | +----------+----------+----------+----------+----------+----------+ | **SOS:** | RCm;REQ; | -\ | -\ | NoAc; | C; | | | IT;B;T1; | ----\ | ----\ | | RCm;REQ; | | Sy | | ----- | ----- | SOS; | IT;B;T1; | | nc_Lost | COR; | | | | | | | | | | wait for | COR; | | | after | | | Runout | | | | Timeout: | | | | after | | | N | | | | Timeout: | | | | | | | N | +----------+----------+----------+----------+----------+----------+ | **OPE:** | NoAc; | B; | SYL1; | C | NoAc; | | | | | | ;DT;SYL; | | | O | OPE; | OPE; | OPE; | | OPE; | | peration | | | | SOS; | | | | **typ | List not |** 1: | | **Typ | | | Final | Ack_ed! | Alarm, |** 2: | Final | | | event**| | go on** | Alarm, | event**| | | | | | stop!** | | +----------+----------+----------+----------+----------+----------+ | **FAI:** | NoAc; | -\ | -\ | -\ | NoAc; | | | | ----\ | ----\ | ----\ | | | Failure | FAI; | ----- | ----- | ----- | FAI; | | | | | | | | | | typical | | | | don´t | | | | | | | trust! | +----------+----------+----------+----------+----------+----------+ | **TT:** | NoAc; | IT;N: | NoAc; | IT;N; | NoAc; | | | | | | | | | T | TT; | NAC; | TT; | NAC; | TT; | | FO_Term | | | | | | +----------+----------+----------+----------+----------+----------+
Table 10.6-11b: Special Events, Timeouts (continuation)
+-------------+-----------------------+ | **Event** : | **Frame_Sync_Lost** | +-------------+-----------------------+ | Number: | 57 | +-------------+-----------------------+ | Condition: | n>2 | | | | | & | TFO_Enabled | +-------------+-----------------------+ | Comment: | Stop TFO Frames | | | | | **State:** | if 3 Frames missing | +-------------+-----------------------+ | **NAC:** | ---------- | | | | | Not_Active | | +-------------+-----------------------+ | **WAK:** | ---------- | | | | | Wakeup | | +-------------+-----------------------+ | **FIT:** | ---------- | | | | | First_Try | | +-------------+-----------------------+ | **COR:** | ---------- | | | | | Continuous | | | | | | Retry | | +-------------+-----------------------+ | **PER:** | ---------- | | | | | Periodic | | | | | | Retry | | +-------------+-----------------------+ | **MON:** | ---------- | | | | | Monitor | | +-------------+-----------------------+ | **MIS:** | NoAc; | | | | | Mismatch | MIS; | +-------------+-----------------------+ | **CON:** | ---------- | | | | | Contact | | +-------------+-----------------------+ | **FAT:** | NoAc; | | | | | Fast | FAT; | | | | | Try | typical in HO | +-------------+-----------------------+ | **FAC:** | NoAc; | | | | | Fast | FAC; | | | | | Contact | typical in HO | +-------------+-----------------------+ | **WRC:** | IT; | | | | | Wait_RC | WRC; | +-------------+-----------------------+ | **KON:** | ---------- | | | | | Konnect | | +-------------+-----------------------+ | **REK:** | ---------- | | | | | Re_Konnect | | +-------------+-----------------------+ | **SOS:** | NoAc; | | | | | Sync_Lost | SOS; | | | | | | wait for Runout | +-------------+-----------------------+ | **OPE:** | C;DT;SYL; | | | | | Operation | SOS; | | | | | | **2: Alarm, stop!** | +-------------+-----------------------+ | **FAI:** | ---------- | | | | | Failure | | +-------------+-----------------------+ | **TT:** | C;RCm;B; | | | | | TFO_Term | MON; | +-------------+-----------------------+
Table 10.6-12 Distant Config Frame for 3G systems (TC)
+-------------+-------------+-------------+-------------+-------------+ | **Event** : | **Distan |** Distan | **Distan |** Distan | | | t_Config**| t_Config** | t_Config**| t_Config** | +-------------+-------------+-------------+-------------+-------------+ | Number: | 49 | 50 | 51 | 52 | +-------------+-------------+-------------+-------------+-------------+ | Condition: | (NA_TP \| | TM | (NA_TP \| | TM | | | A_TP) | | A_TP) | | | & | | Con_Req & | | Con_Ack & | | | Con_Req & | TC | Con_Ack & | TC | | | TC | | TC | | +-------------+-------------+-------------+-------------+-------------+ | Comment: | Config | Config | Config | Config | | | request | request | ackn | ackn | | **State:** | | | owledgement | owledgement | | | Matching | TFO | | | | | parameters | Mismatch | Matching | TFO | | | | | parameters | Mismatch | +-------------+-------------+-------------+-------------+-------------+ | **NAC:** | ---- | ---- | ---- | ---- | | | ------ | ------ | ------ | ------ | | Not_Active | | | | | +-------------+-------------+-------------+-------------+-------------+ | **WAK:** | ---- | ---- | ---- | ---- | | | ------ | ------ | ------ | ------ | | Wakeup | | | | | +-------------+-------------+-------------+-------------+-------------+ | **FIT:** | C | C;RCm;B; | C | C;RCm;B; | | | ;U;DUP;RCi; | | ;U;DUP;RCi; | | | First_Try | | MIS; | | MIS; | | | FAT; | | FAT; | | | | | | | | | | Same as 1. | | Same as 1. | | | | TFO_Frame | | TFO_Frame | | +-------------+-------------+-------------+-------------+-------------+ | **COR:** | C;U;DUP; | C;RCm;B; | C;U;DUP; | C;RCm;B; | | | | | | | | Continuous | FAT; | MIS; | FAT; | MIS; | | | | | | | | Retry | Same as 1. | | Same as 1. | | | | TFO_Frame | | TFO_Frame | | +-------------+-------------+-------------+-------------+-------------+ | **PER:** | C;DUP; | C;RCm;B; | C;DUP; | C;RCm;B; | | | | | | | | Periodic | FAT; | MIS; | FAT; | MIS; | | | | | | | | Retry | Same as 1. | | Same as 1. | | | | TFO_Frame | | TFO_Frame | | +-------------+-------------+-------------+-------------+-------------+ | **MON:** | C;DUP; | C;RCm;B; | C;DUP; | C;RCm;B; | | | | | | | | Monitor | FAT; | MIS; | FAT; | MIS; | | | | | | | | | Same as 1. | | Same as 1. | | | | TFO_Frame | | TFO_Frame | | +-------------+-------------+-------------+-------------+-------------+ | **MIS:** | C;DUP; | C;RCm;B; | C;DUP; | C;RCm;B; | | | | | | | | Mismatch | FAT; | MIS; | FAT; | MIS; | | | | | | | | | Same as 1. | | Same as 1. | | | | TFO_Frame | | TFO_Frame | | +-------------+-------------+-------------+-------------+-------------+ | **CON:** | C | C;RCm;B; | C | C;RCm;B; | | | ;T;BT;T;T1; | | ;T;BT;T;T1; | | | Contact | | MIS; | | MIS; | | | KON; | | KON; | | | | | | | | | | Same as 1. | | Same as 1. | | | | TFO_Frame | | TFO_Frame | | +-------------+-------------+-------------+-------------+-------------+ | **FAT:** | NoAc; | C;RCm;B; | NoAc; | C;RCm;B; | | | | | | | | Fast | FAT; | MIS; | FAT; | MIS; | | | | | | | | Try | Same as 1. | | Same as 1. | | | | TFO_Frame | | TFO_Frame | | +-------------+-------------+-------------+-------------+-------------+ | **FAC:** | C;BT;T | C;RCm;B; | C;BT;T | C;RCm;B; | | | ;L;T2;AT;B; | | ;L;T2;AT;B; | | | Fast | | MIS; | | MIS; | | | OPE; | | OPE; | | | Contact | | | | | | | Same as 1. | | Same as 1. | | | | TFO_Frame | | TFO_Frame | | +-------------+-------------+-------------+-------------+-------------+ | **WRC:** | NoAc; | C;RCm;B; | NoAc; | C;RCm;B; | | | | | | | | Wait_RC | WRC; | MIS; | WRC; | MIS; | +-------------+-------------+-------------+-------------+-------------+ | **KON:** | RCs;CA1 | C;RCm; | RCs | C;R | | | ;AT;L;T2;B; | CA;DT;B;T1; | ;AT;L;T2;B; | Cm;DT;B;T1; | | Konnect | | | | | | | OPE; | MIS; | OPE; | MIS; | | | | | | | | | Same as 1. | | Same as 1. | | | | TFO_Frame | | TFO_Frame | | +-------------+-------------+-------------+-------------+-------------+ | **REK:** | RCs;CA1 | C;RCm;CA; | RCs | C;RCm; | | | ;AT;L;T2;B; | DT;IT;B;T1; | ;AT;L;T2;B; | DT;IT;B;T1; | | Re_Konnect | | | | | | | OPE; | MIS; | OPE; | MIS; | | | | | | | | | Same as 1. | | Same as 1. | | | | TFO_Frame | | TFO_Frame | | +-------------+-------------+-------------+-------------+-------------+ | **SOS:** | C;RCs;CA1;B | C;RCm;CA; | C;RCs;B | C;RCm; | | | T;T;L;T2;B; | DT;IT;B;T1; | T;T;L;T2;B; | DT;IT;B;T1; | | Sync_Lost | | | | | | | OPE; | MIS; | OPE; | MIS; | | | | | | | | | Same as 1. | | Same as 1. | | | | TFO_Frame | | TFO_Frame | | +-------------+-------------+-------------+-------------+-------------+ | **OPE:** | RCs;CA1; | C;RCm;CA; | RCs; | C;RCm; | | | | DT;IT;B;T1; | | DT;IT;B;T1; | | Operation | OPE; | | OPE; | | | | | MIS; | | MIS; | | | Same as 1. | | Same as 1. | | | | TFO_Frame | | TFO_Frame | | +-------------+-------------+-------------+-------------+-------------+ | **FAI:** | ---- | ---- | ---- | ---- | | | ------ | ------ | ------ | ------ | | Failure | | | | | +-------------+-------------+-------------+-------------+-------------+ | **TT:** | B; | B; | B; | B; | | | | | | | | TFO_Term | TT; | TT; | TT; | TT; | +-------------+-------------+-------------+-------------+-------------+
Table 10.6-13 Distant Config Frame for GSM systems (TRAU) and Distant_Disable
+-------------+-------------+-------------+-------------+-------------+ | **Event** : | **Distan |** Distan | **Distan |** Distant | | | t_Config**| t_Config** | t_Config**| _Disable** | +-------------+-------------+-------------+-------------+-------------+ | Number: | 53 | 54 | 55 | 56 | +-------------+-------------+-------------+-------------+-------------+ | Condition: | (NA_TP \| | TM | TM | | | | A_TP) | | | | | & | | Con_req & | Con_Ack & | | | | TRAU | TRAU | TRAU | | +-------------+-------------+-------------+-------------+-------------+ | Comment: | Config req | Config | Config | Distant | | | or Config | request | ackn | side has | | **State:** | ack | | owledgement | disabled | | | | TFO | | TFO | | | Matching | Mismatch | TFO | | | | parameters | | Mismatch | | +-------------+-------------+-------------+-------------+-------------+ | **NAC:** | ---- | ---- | ---- | ---- | | | ------ | ------ | ------ | ------ | | Not_Active | | | | | +-------------+-------------+-------------+-------------+-------------+ | **WAK:** | ---- | ---- | ---- | ---- | | | ------ | ------ | ------ | ------ | | Wakeup | | | | | +-------------+-------------+-------------+-------------+-------------+ | **FIT:** | C | C;RCm;B; | C;RCm;B; | C;RCm;B; | | | ;U;DUP;RCi; | | | | | First_Try | | MIS; | MIS; | MON; | | | FAT; | | | | | | | | | | | | Same as 1. | | | | | | TFO_Frame | | | | +-------------+-------------+-------------+-------------+-------------+ | **COR:** | C;U;DUP; | C;RCm;B; | C;RCm;B; | C;RCm;B; | | | | | | | | Continuous | FAT; | MIS; | MIS; | MON; | | | | | | | | Retry | Same as 1. | | | | | | TFO_Frame | | | | +-------------+-------------+-------------+-------------+-------------+ | **PER:** | C;DUP; | C;RCm;B; | C;RCm;B; | C;RCm;B; | | | | | | | | Periodic | FAT; | MIS; | MIS; | MON; | | | | | | | | Retry | Same as 1. | | | | | | TFO_Frame | | | | +-------------+-------------+-------------+-------------+-------------+ | **MON:** | C;DUP; | C;RCm;B; | C;RCm;B; | C;RCm;B; | | | | | | | | Monitor | FAT; | MIS; | MIS; | MON; | | | | | | | | | Same as 1. | | | | | | TFO_Frame | | | | +-------------+-------------+-------------+-------------+-------------+ | **MIS:** | C;DUP; | C;RCm;B; | C;RCm;B; | C;RCm;B; | | | | | | | | Mismatch | FAT; | MIS; | MIS; | MON; | | | | | | | | | Same as 1. | | | | | | TFO_Frame | | | | +-------------+-------------+-------------+-------------+-------------+ | **CON:** | C | C;RCm;B; | C;RCm;B; | C;RCm;B; | | | ;T;BT;T;T1; | | | | | Contact | | MIS; | MIS; | MON; | | | KON; | | | | | | | | | | | | Same as 1. | | | | | | TFO_Frame | | | | +-------------+-------------+-------------+-------------+-------------+ | **FAT:** | NoAc; | C;RCm;B; | C;RCm;B; | C;RCm;B; | | | | | | | | Fast | FAT; | MIS; | MIS; | MON; | | | | | | | | Try | Same as 1. | | | | | | TFO_Frame | | | | +-------------+-------------+-------------+-------------+-------------+ | **FAC:** | C;BT;T | C;RCm;B; | C;RCm;B; | C;RCm;B; | | | ;L;T2;AT;B; | | | | | Fast | | MIS; | MIS; | MON; | | | OPE; | | | | | Contact | | | | | | | Same as 1. | | | | | | TFO_Frame | | | | +-------------+-------------+-------------+-------------+-------------+ | **WRC:** | NoAc; | C;RCm;B; | C;RCm;B; | C;RCm;B; | | | | | | | | Wait_RC | WRC; | MIS; | MIS; | MON; | +-------------+-------------+-------------+-------------+-------------+ | **KON:** | RCs | C;RCm; | C;R | C;RCm; | | | ;AT;L;T2;B; | CA;DT;B;T1; | Cm;DT;B;T1; | CA;DT;B;T1; | | Konnect | | | | | | | OPE; | MIS; | MIS; | MON; | | | | | | | | | Same as 1. | | | | | | TFO_Frame | | | | +-------------+-------------+-------------+-------------+-------------+ | **REK:** | RCs | C;RCm;CA; | C;RCm; | C;RCm;CA; | | | ;AT;L;T2;B; | DT;IT;B;T1; | DT;IT;B;T1; | DT;IT;B;T1; | | Re_Konnect | | | | | | | OPE; | MIS; | MIS; | MON; | | | | | | | | | Same as 1. | | | | | | TFO_Frame | | | | +-------------+-------------+-------------+-------------+-------------+ | **SOS:** | C;RCs;B | C;RCm;CA; | C;RCm; | C;R | | | T;T;L;T2;B; | DT;IT;B;T1; | DT;IT;B;T1; | Cm;IT;B;T1; | | Sync_Lost | | | | | | | OPE; | MIS; | MIS; | MON; | | | | | | | | | Same as 1. | | | | | | TFO_Frame | | | | +-------------+-------------+-------------+-------------+-------------+ | **OPE:** | RCs; | C;RCm;CA; | C;RCm; | C;RCm;CA; | | | | DT;IT;B;T1; | DT;IT;B;T1; | DT;IT;B;T1; | | Operation | OPE; | | | | | | | MIS; | MIS; | MON; | | | Same as 1. | | | | | | TFO_Frame | | | | +-------------+-------------+-------------+-------------+-------------+ | **FAI:** | ---- | ---- | ---- | ---- | | | ------ | ------ | ------ | ------ | | Failure | | | | | +-------------+-------------+-------------+-------------+-------------+ | **TT:** | B; | B; | B;IT;N; | B;IT;N; | | | | | | | | TFO_Term | TT; | TT; | NAC; | NAC; | +-------------+-------------+-------------+-------------+-------------+
Table 10.6-14 Immediate Codec Type Optimisation
+---------------+----------------+----------------+----------------+ | **Event** : | **TFO_REQ** | **TFO_ACK** | **New_ | | | | | Local_Codec** | | | | | | | | | | **New_L | | | | | ocal_Config** | +---------------+----------------+----------------+----------------+ | Number: | 58 | 59 | 60, 61 | +---------------+----------------+----------------+----------------+ | Condition: | Lsig != Dsig | Lsig == Dsig | ICO==1 | | | | | | | & | ICO==1 | ICO==1 | | +---------------+----------------+----------------+----------------+ | Comment: | Good | Good | New Config, | | | signature, | signature, | | | **State:** | | | Immediate | | | Immediate | Immediate | Codec Opt. | | | Codec Opt. | Codec Opt. | | +---------------+----------------+----------------+----------------+ | **NAC:** | --\ | --\ | --\ | | | -------- | -------- | -------- | | Not_Active | | | | +---------------+----------------+----------------+----------------+ | **WAK:** | --\ | --\ | --\ | | | -------- | -------- | -------- | | Wakeup | | | | +---------------+----------------+----------------+----------------+ | **FIT:** | C;U;ACK;B; | C;U;ACK;B; | --\ | | | | | -------- | | First_Try | CON; | CON; | | | | | | | | | **enter ICO** | **enter ICO** | | +---------------+----------------+----------------+----------------+ | **COR:** | C;U;ACK;B; | C;U;ACK;B; | C;U;ACK;B; | | | | | | | Continuous | CON; | CON; | CON; | | | | | | | Retry | | | | +---------------+----------------+----------------+----------------+ | **PER:** | C;U;ACK;B; | C;U;ACK;B; | C;U;ACK;B; | | | | | | | Periodic | CON; | CON; | CON; | | | | | | | Retry | | | | +---------------+----------------+----------------+----------------+ | **MON:** | C;U;ACK;B; | C;U;ACK;B; | C;U;ACK;B; | | | | | | | Monitor | CON; | CON; | CON; | +---------------+----------------+----------------+----------------+ | **MIS:** | C;U;ACK;B; | C;U;ACK;B; | C;U;ACK;B; | | | | | | | Mismatch | CON; | CON; | CON; | +---------------+----------------+----------------+----------------+ | **CON:** | C;ACK; | NoAc; | C;ACK;B; | | | | | | | Contact | CON; | CON; | CON; | | | | | | | | **wait for |** wait for HO | | | | HO**| or Runout** | | +---------------+----------------+----------------+----------------+ | **FAT:** | C;ACK;RCm;B; | C;ACK;RCm;B; | C;ACK;RCm;B; | | | | | | | Fast | CON; | CON; | CON; | | | | | | | Try | | | | +---------------+----------------+----------------+----------------+ | **FAC:** | C;ACK;RCm;B; | C;ACK;RCm;B; | C;ACK;RCm;B; | | | | | | | Fast | CON; | CON; | CON; | | | | | | | Contact | | | | +---------------+----------------+----------------+----------------+ | **WRC** | C;ACK;RCm;B; | C;ACK;RCm;B; | C;ACK;RCm;B; | | | | | | | Wait_RC | CON; | CON; | CON; | +---------------+----------------+----------------+----------------+ | **KON:** | C | C | C | | | ;ACK;RCm;B;DT; | ;ACK;RCm;B;DT; | ;ACK;RCm;B;DT; | | Konnect | | | | | | CON; | CON; | CON; | +---------------+----------------+----------------+----------------+ | **REK:** | C;AC | C;AC | C;AC | | | K;RCm;B;DT;IT; | K;RCm;B;DT;IT; | K;RCm;B;DT;IT; | | Re_Konnect | | | | | | CON; | CON; | CON; | +---------------+----------------+----------------+----------------+ | **SOS:** | C | C | C | | | ;ACK;RCm;B;IT; | ;ACK;RCm;B;IT; | ;ACK;RCm;B;IT; | | Sync_Lost | | | | | | CON; | CON; | CON; | +---------------+----------------+----------------+----------------+ | **OPE:** | C;AC | --\ | C;AC | | | K;RCm;B;DT;IT; | -------- | K;RCm;B;DT;IT; | | Operation | | | | | | CON; | | CON; | +---------------+----------------+----------------+----------------+ | **FAI:** | NoAc; | NoAc; | NoAc; | | | | | | | Failure | FAI; | FAI; | FAI; | +---------------+----------------+----------------+----------------+ | **TT :** | --\ | --\ | --\ | | | -------- | -------- | -------- | | **TFO_Term** | | | | +---------------+----------------+----------------+----------------+
# 11 TFO Decision Algorithm
The TFO decision algorithm defines the processes invoked in both transcoders
in order to examine the possibility for TFO establishment. Codec Types are in
general only compatible to itself.
All members of the AMR-NB Codec Type family, except UMTS_AMR, are compatible,
when both Codec Types use compatible multi-mode ACSs. In any multi-mode
configuration the UMTS_AMR shall be regarded as only compatible to itself, not
to any other AMR-NB Codec Type, to avoid incompatibilities in TFO-TrFO-TFO
interworking scenarios. In single mode configuration, UMTS_AMR and UMTS_AMR_2
are compatible, when both Codec Types use the same single rate ACS. The
UMTS_AMR_2 is the preferred AMR-NB Codec Type for 3G systems.
All members of the AMR-WB Codec Type family are compatible, when both codec
types use compatible multi-mode ACSs.
For the AMR Codec Type family the following tables 11-1 and 11-2 illustrate
the compatible combinations (Table 11-1 for AMR-NB codec types, table 11-2 for
AMR-WB codec types):
Table 11-1: Compatibility of AMR-NB Codec Types
+----------+----------+----------+----------+----------+----------+ | * | UMTS | U | FR_AMR | HR_AMR | OHR_AMR | | _distant | _AMR_2 | MTS_AMR | | | | | →_ _| | | | | | | | | | | | | |__↓ | | | | | | | local_ _| | | | | | +----------+----------+----------+----------+----------+----------+ |__UMTS_ | co | co | co | co | co | | AMR_2_ _| mpatible | mpatible | mpatible | mpatible | mpatible | | | | (Note) | | | | +----------+----------+----------+----------+----------+----------+ |__UMT | co | co | - | - | - | | S_AMR_ _| mpatible | mpatible | | | | | | (Note) | | | | | +----------+----------+----------+----------+----------+----------+ |__F | co | - | co | co | co | | R_AMR_ _| mpatible | | mpatible | mpatible | mpatible | +----------+----------+----------+----------+----------+----------+ |__H | co | - | co | co | co | | R_AMR_ _| mpatible | | mpatible | mpatible | mpatible | +----------+----------+----------+----------+----------+----------+ |__OH | co | - | co | co | co | | R_AMR_ * | mpatible | | mpatible | mpatible | mpatible | +----------+----------+----------+----------+----------+----------+
Note: only for single mode ACSs.
Table 11-2 Compatibility of AMR-WB Codec Types
+------------------+------------+------------------+-----------------+-----------------+ | **distant →** | FR_AMR-WB | **UMTS_AMR-WB** | **OFR_AMR-WB** | **OHR_AMR-WB** | | | | | | | | **↓ local** | | | | | +------------------+------------+------------------+-----------------+-----------------+ | **FR_AMR-WB** | compatible | compatible | compatible | compatible | +------------------+------------+------------------+-----------------+-----------------+ | **UMTS_AMR-WB** | compatible | compatible | compatible | compatible | +------------------+------------+------------------+-----------------+-----------------+ | **OFR_AMR-WB** | compatible | compatible | compatible | compatible | +------------------+------------+------------------+-----------------+-----------------+ | **OHR_AMR-WB** | compatible | compatible | compatible | compatible | +------------------+------------+------------------+-----------------+-----------------+
## 11.1 Main TFO Decision Procedure
The main TFO decision procedure is depicted in figure 11.1-1.
Figure 11.1-1: Main TFO Decision Algorithm
## 11.2 TFO Decision Algorithm for AMR codec types
The TFO Decision Algorithm for AMR codec types defines the processes that are
invoked in order to examine the possibility for a TFO establishment if both
radio legs use compatible AMR codec types.
### 11.2.1 Principles
In order to yield high speech quality the following items are underlying
principles of the TFO decision algorithm for AMR codec types:
\- Avoid immediate TFO establishment with a following codec optimisation that
has to interrupt the TFO connection.
\- Go into immediate TFO if this is possible with a good configuration,
otherwise do codec optimisation.
\- Only do codec mode optimisation if the ongoing TFO connection is
established on a contiguous subset of the ACS and if this ongoing TFO
connection need not be interrupted.
### 11.2.2 Available Information at Call Set-up
After the exchange of TFO_REQ and TFO_ACK messages the following information
is available at the transcoders on both sides:
\- Local / distant codec type (FR_AMR, HR_AMR, UMTS_AMR, UMTS_AMR_2, OHR_AMR,
FR_AMR-WB, UMTS_AMR-WB, OHR_AMR-WB, OFR_AMR-WB)
\- Local / distant supported codec set (LSCS / DSCS)
\- Local / distant ACS (LACS / DACS)
\- Local / distant MACS
\- Local / distant ACS optimisation mode (OM)
\- Local / distant version number (Ver)
With this information the following can be calculated:
\- Common ACS (CACS)
\- Common supported codec set (CSCS)
\- Common MACS (CMACS)
\- Optimised ACS (OACS)
Furthermore, additional information on supported codecs may become available
when the Codec List is received. There are several possibilities for receiving
this information: 1) by TFO_REQ and TFO_ACK messages including optional
Extension_Blocks, 2) by TFO_REQ_L and TFO_ACK_L messages, and 3) by
Configuration Frames (Con_Req, Con_Ack). In any case, the following
information is available for each supported codec in the Codec List:
\- Local / distant supported codec type
\- Local / distant supported codec set (LSCS / DSCS)
\- Local / distant MACS
In the case that Generic Configuration Frames are used to transmit the Codec
List the following information is also available for each codec in the Codec
List:
\- Local / distant intended ACS (LACS/ DACS)
\- Local / distant ACS optimisation mode (OM)
In all other cases (no Generic Configuration Frames are used) the OM bit shall
be assumed to be set (\"ACS optimisation allowed\").
With this information the following can be calculated for each compatible
codec combination in the local and distant Codec List:
\- Common supported codec set (CSCS)
\- Common MACS (CMACS)
\- Optimised ACS (OACS)
### 11.2.3 Void
### 11.2.4 Flowchart for AMR-NB TFO Decision
Figure 11.2.4-1: Flowchart for AMR-NB TFO Establishment at Call Set-Up
Figure 11.2.4-2: Flowchart for AMR-WB TFO Establishment at Call Set-Up
### 11.2.5 Annotations to the Flowcharts
\- LACS == DACS:\ Establish immediate TFO if the local and distant ACS are
identical.\ Example: Enable immediate TFO establishment within one operator\'s
homogenous network. The operator\'s choice is always acceptable and needs no
optimisation.
\- FR -- HR Matching\ The rules for FR -- HR -- Matching are stated in clause
12.6.\ Goal: Enable immediate TFO between 3G channels and 2G FR and 2G HR
channels.
\- FR -- HR -- Optimisation\ The rules for FR -- HR -- Optimisation are stated
in clause 11.4.
\- Calculate OACS and IACS:\ The calculation of the OACS is described in
clause 12.\ The Immediate ACS (IACS) is given by the common ACS (CACS) if it
is contiguous.
\- OACS acceptable:\ The acceptability rules for the OACS are stated in clause
12.5.
\- IACS == OACS\ If the immediate ACS is already optimal, establish immediate
TFO.
\- IACS subset of OACS:\ Immediate TFO is established on a contiguous subset
of the OACS. Afterwards, a codec mode optimisation is performed without
interrupting the TFO connection.
\- Change ACS to OACS\ If immediate TFO cannot be established, both sides must
change their ACS to the OACS in order to enable TFO. If one side doesn\'t
support an ACS change (ACS Optimisation Mode), the OACS determination rules
ensure that the OACS is a contiguous subset of the fix ACS. So a TFO
connection can be established without the need for an ACS change on that side.
\- Codec Mismatch Resolution\ A TFO connection with the currently used AMR
codec types will not be possible, but the remaining codec types have to be
investigated.
## 11.3 Immediate TFO Establishment
Immediate TFO establishment shall take place if
\- both radio legs use the same codec type that is different from an AMR codec
type; or
\- the local ACS is equal to the distant ACS in the case of two compatible AMR
codec types; or
\- the CACS is equal to the OACS and the CACS fulfils the contiguity rule in
the case of two compatible AMR codec types; or
\- the rules for FR -- HR -- matching are fulfilled in the case of two
compatible AMR-NB codec types; or
\- the CACS is a contiguous subset of the OACS in the case of two compatible
AMR codec types and Codec Mode Optimisation is supported and will be done
after immediate TFO establishment.
If both radio legs use the same codec type that is different from an AMR codec
type, immediate TFO shall be established on this common codec type. If both
radio legs use compatible AMR codec types and immediate TFO can be
established, each side keeps its own AMR codec type (e. g. FR_AMR, HR_AMR,
UMTS_AMR, UMTS_AMR_2) and Active Codec Set (ACS).
If immediate TFO is possible on a currently used codec type, but also on a
supported codec type with a higher preverence level (see 11.6.2), then TFO
shall not be started on the used codec type, but only after switching to the
preferred codec. For details on this Immediate Codec Type Optimisation see
11.7.
## 11.4 FR -- HR -- Optimisation (only for AMR-NB)
FR -- HR -- Optimisation takes place after immediate TFO establishment in the
case of FR -- HR -- Matching. The FR_AMR-side adopts the ACS of the HR_AMR-
side, if this ACS is supported and the optimisation mode allows an ACS change.
This ACS change can be done without interrupting the TFO connection that is
established on a contiguous subset.
## 11.5 Codec Mode Optimisation
After an immediate TFO establishment with compatible AMR codec types, a codec
mode optimisation shall be invoked if the optimisation can be done without
interrupting the TFO connection, i.e. without degradation of speech quality.
Codec Mode Optimisation takes place in the following situations:
\- After immediate TFO establishment on a IACS that is a contiguous subset of
the OACS.
## 11.6 Codec Type Optimisation and Codec Mismatch Resolution
The objective of the Codec Mismatch Resolution and the Codec Type Optimisation
is to find the optimised TFO codec type and configuration for a TFO
connection. Codec Mismatch Resolution is invoked if a TFO establishment is not
possible on the currently used codec types. Codec Type Optimisation may happen
while a TFO connection is ongoing and the capabilities of one radio leg have
changed (e. g. after a hand-over, other reasons).
Codec Mismatch Resolution and Codec Type Optimisation are optional features.
If one radio leg doesn\'t support these features, the codec list sent in the
TFO_REQ_L and TFO_ACK_L messages (or Con_Req and Con_Ack frames) shall be
restricted to the local used codec. If supported, the Codec Type Mismatch
Resolution or the Codec Type Optimisation shall be performed every time a new
codec list is sent or received by TFO_REQ_L or TFO_ACK_L (or Con_Req and
Con_Ack frames) messages.
The determination of the local codec list (list of all codec types supported
by the local radio leg, consisting of the local UE and the local RAN) is
outside the scope of the present document. Similarly, the determination of the
attributes of all locally supported codec types (e.g. LSCS for AMR codec
types) is also outside the scope of the present document. Only codec types
that are real alternatives, considering all resources (UE, RAN, TC, radio
interface, cell capacity, interference), shall be reported within the local
codec list. Only codec type Attributes that can be considered shall be
indicated with the codec list as well. This means that if a TFO configuration
is not desirable, it should not be listed in the TFO_REQ_L or TFO_ACK_L
messages (or Con_Req and Con_Ack frames).
### 11.6.1 Procedure
1) The transcoders shall exchange their lists of supported codec types (codec
list) and their associated attributes. This is done either by the exchange of
TFO_REQ_L and/or TFO_ACK_L messages or Con_Req and Con_Ack frames.
2) Each side shall identify all candidate TFO configurations involving
compatible codec types supported by both radio legs.
3) Each side shall calculate the OACS in the case of an AMR TFO candidate. If
the OACS is not acceptable, this candidate shall be removed from the list of
candidate TFO configurations.
4) The candidate TFO configuration with the highest preference level shall
define the optimised codec type and the optimised codec configuration.
5) Each side shall switch its operation to the optimised codec type and the
optimised codec configuration. If no acceptable TFO candidate was found, TFO
is not possible.
### 11.6.2 Preference List of TFO candidates
The preference list of TFO candidates orders all possible TFO combinations
according to the speech quality they provide.
Table 11.6.2-1: Codec Type Combination Preference List, Part 1
* * *
**distant →\ OFR_AMR-WB** UMTS_AMR-WB**** FR_AMR-WB**** OHR_AMR-WB**↓ local**
**OFR_AMR-WB** **1** **2** **4** **7**
**UMTS_AMR-WB** symmetric **3** **5** **8**
**FR_AMR-WB** symmetric symmetric **6** **9**
**OHR_AMR-WB** symmetric symmetric symmetric **10**
* * *
For AMR-WB the preference is determined by the OACS: A combination with the
highest mode in the OACS has preference. If the highest mode in OACSs for at
least two combinations is identical, then the preference level as given in
Table 11.6.2-1 shall decide.
Examples:\ The configuration (OFR_AMR-WB, UMTS_AMR-WB, OACS={6,60, 8,85,
12,65, 23,85}) is preferred to (OFR_AMR-WB, OFR_AMR-WB, OACS={6,60, 8,85,
12,65, 15,85}).\ The configuration (OFR_AMR-WB, OFR_AMR-WB, OACS={6,60, 8,85,
12,65}) is preferred to (OFR_AMR-WB, UMTS_AMR-WB, OACS={6,60, 8,85, 12,65}).
Table 11.6.2-2 Codec Type Combination Preference List, Part 2
* * *
**distant →\ UMTS_AMR_2 FR_AMR UMTS_AMR OHR_AMR HR_AMR ↓ local**
**UMTS_AMR_2** **11** **12** **15** (Note) **17** **20**
**FR_AMR** symmetric **13** Not compatible **18** **21**
**UMTS_AMR** symmetric Not compatible **14** Not compatible Not compatible
**OHR_AMR** symmetric symmetric Not compatible **19** **22**
**HR_AMR** symmetric symmetric Not compatible symmetric **23**
* * *
Note: only for single mode ACSs
Table 11.6.2-3 Codec Type Combination Preference List, Part 3
* * *
**distant →\ GSM_EFR GSM_FR GSM_HR ↓ local**
**GSM_EFR** **16** Not compatible Not compatible
**GSM_FR** Not compatible **24** Not compatible
**GSM_HR** Not compatible Not compatible **25**
* * *
All other possible codec type combinations not listed in these table
11.6.2.3-1/2/3 are not compatible.
The codec type FR_AMR-WB is preferred to the AMR-NB codec types, because it
still provides significantly better speech quality.
The two equivalent combinations FR_AMR-WB  UMTS_AMR-WB and UMTS_AMR-WB 
FR_AMR-WB should not exist in parallel, because these two AMR-WB codec types
are not offered by one side simultaneously.
The speech quality of some AMR-WB codec type combinations involving FR_AMR-WB,
UMTS_AMR-WB and OHR_AMR-WB are very similar. Therefore within category 1 the
OACSs of the possible combinations are evaluated. For details on this
evaluation see clause 12.3.2.2 .
The codec type UMTS_AMR_2 is the most preferred AMR-NB codec type, because it
is compatible with all other AMR codec types.
The codec type FR_AMR is preferred to UMTS_AMR because UMTS_AMR is not
compatible with FR_AMR and HR_AMR.
If the two equivalent AMR-NB combinations like FR_AMR  HR_AMR and HR_AMR 
FR_AMR or UMTS_AMR_2  HR_AMR and HR_AMR  UMTS_AMR_2 etc. exist in parallel,
then they shall be ranked according to the following rules:
1) The combination with the highest number of modes shall be selected.
2) If they have the same number of modes, then the combination with the widest
spread shall be selected. The spread is the difference between the highest and
the lowest mode indexes.
3) If the spreads are identical, then the combination with the highest mode in
the OACS shall be selected.
4) If the highest modes are identical, repeat 3 with the second highest mode.
If the second highest are identical, then repeat 3 with the third highest,
etc.
## 11.7 Immediate Codec Type Optimisation
The Codec Type Optimisation described in the previous section is performed
after the exchange of TFO_REQ_L and TFO_ACK_L messages. Because these messages
are exchanged in a late phase of the protocol and may require significant time
for transmission, the optimisation may be delayed by a significant amount of
time. Furthermore, if TFO was already established before optimisation, a
switch to the preferred codec type may disturb the ongoing speech call. To
avoid these drawbacks, the codec type optimisation can also be performed
immediately during TFO establishment, i.e., in a very early stage of the TFO
protocol. This option for TFO establishment is termed \"Immediate Codec Type
Optimisation\" and is explained in the following.
The objective of the Immediate Codec Type Optimisation is to switch the codec
type at the local and/or the distant side if this results in a preferred TFO
configuration. The required information to decide if Immediate Codec Type
Optimization shall be performed is included in the TFO_REQ and TFO_ACK
messages by means of the TFO_Version Extension_Block (see Clause 7.4.5). This
information is equivalent to the Codec_List included in TFO_REQ_L and
TFO_ACK_L messages, however, signalled in a different way. If a preferred TFO
configuration becomes possible by changing the local and/or the distant codec
type, both sides remain in the Contact state as long as the Immediate Codec
Type Optimisation is being performed, i.e., until the local and/or the distant
side has/have changed the codec type. After the switch, the TFO protocol
continues as usual.
Immediate Codec Type Optimisation becomes only effective in TFO version 5 or
higher. If either the local or the distant side is using a lower version, no
Immediate Codec Type Optimisation is used. Hence, the protocol is compatible
with older versions that do not include Immediate Codec Type Optimisation.
Note that a switch to a different codec type is always possible using the
normal Codec Type Optimisation in the Mismatch state.
The procedure and preference list used for finding the optimal configuration
is exactly identical to Clause 11.6. The only difference is that the required
information (active codec, codec list, attributes, ...) is obtained from
TFO_REQ and TFO_ACK messages instead of TFO_REQ_L and TFO_ACK_L messages.
Furthermore, the change of codec type is performed in the Contact state
instead of the Mismatch or Operation state.
## 11.8 TFO Decision Table for AMR-WB
For AMR-WB only a limited set of configurations is allowed. Table 12.8-1.gives
the effective ACS for all combinations of these allowed configurations.
Table 11.8-1: Effective ACS for AMR-WB TFO
* * *
Local scenario\ **0** :\ **1** :\ **2** :\ **3** :\ **4** :\ **5** :\ \
**ACS:=A** =SCS\ ACS:=A, SCS:=D\ **ACS:=B** =SCS\ ACS:=A, SCS=D\ **ACS:=C**
=SCS\ ACS=C, SCS=D\ \ \ 23,85\ \ \ 23,85\ 23,85\ \ \ 15,85\ 15,85\ 15,85\ \ \
\ 12,65\ 12,65 12,65\ 12,65\ 12,65\ 12,65\ 12,65\ \ 8,85\ 8,85 8,85\ 8,85\
8,85\ 8, 85\ 8,85\ Distant scenario 6,60\ 6,60 6,60\ 6,60\ 6,60\ 6,60\ 6,60\ \
\ \ \ \ \ OM=F\ OM=A\ OM=F\ OM=A\ OM=F\ OM=A\ MACS=3 MACS=4 MACS=4 MACS=4
MACS=4 MACS=4
**0** A A A A A A
**1** Symmetrical A B\ B\ C\ C\ (config. 1 changes to 3) (config. 1 changes to
3) (config. 1 changes to 5) (config. 1 changes to 5)
**2** Symmetrical Symmetrical B B A B\ (config. 5 changes to 3)
**3** Symmetrical Symmetrical Symmetrical B C\ C\ (config. 3 changes to 5)
(config. 3 changes to 5)
**4** Symmetrical Symmetrical Symmetrical Symmetrical C C
**5** Symmetrical Symmetrical Symmetrical Symmetrical Symmetrical C
* * *
Immediate TFO (see 11.3) is always possible for each combination of the
allowed configurations. In some cases a Codec Mode Optimisation (see 11.5) is
invoked after TFO establishment. For these cases the changing configuration is
also specified in the table 12.8-1. Remark: For all combinations where one
side changes the configuration, immediate TFO is established on ACS A.
All final (and immediate) ACSs as listed in table 12.8-1 are contiguous and
acceptable, by design. No check -- as for an AMR-NB OACS (see clause 12.4,
12.5 and 12.7) -- is needed.
# 12 Determination of the OACS for AMR-NB
In case of inconsistencies between the TFO decision C-Code in Annex E and this
clause the C-Code shall take precedence.
## 12.1 Principles
The determination of the OACS shall be done considering the available
information (see 11.2.2).
The common MACS is defined as the minimum value of the local and distant MACS.
The determination of the OACS shall depend on the local and distant
optimisation mode (LOM / DOM).
## 12.2 Algorithm for OACS Determination
### 12.2.1 Case 1: No side supports ACS change
If neither the local side nor the distant side supports an ACS change, the
OACS is equal to the CACS if it fulfils the contiguity rule. Otherwise, the
rules for contiguous subset selection are applied to the CACS in order to
obtain the OACS.
{width="3.1930555555555555in" height="3.6333333333333333in"}
Figure 12.2.1-1: OACS Determination when No side supports ACS Change
### 12.2.2 Case 2: Only one side supports ACS change
If only one side supports an ACS change, the CSCS is built with the common
modes of the SCS of the flexible side and the unchangeable ACS.
If the CSCS doesn\'t fulfil the contiguity rule or the common MACS is lower
than the number of modes in the CSCS, the OACS is obtained by applying the
rules for contiguous subset selection. Otherwise, the OACS is equal to the
CSCS.
{width="3.196527777777778in" height="4.804861111111111in"}
Figure 12.2.2-1: OACS Determination when only one side supports ACS Change
### 12.2.3 Case 3: Both sides support ACS change
If both sides support ACS change, the CSCS is built with the common modes of
both SCS.
The Optimised Active Codec Set (OACS) is equal to the Common Supported Codec
Set (CSCS) if the number of modes in the CSCS is equal or lower than the
common MACS.
If the number of modes in the CSCS is higher than the common MACS, the OACS
shall be defined as a subset of the CSCS using the OACS selection rules.
If the CSCS is not empty, then a Optimised Active Codec Set (OACS) exists.
The existence of an OACS doesn\'t mean the OACS is acceptable. To check this,
the acceptability rules for the OACS have to be applied.
{width="3.1930555555555555in" height="3.6333333333333333in"}
Figure 12.2.3-1: OACS Determination when both sides support ACS Change
## 12.3 OACS Selection Rules
If both radio legs support ACS change and if the number of modes contained in
the CSCS is greater than the common MACS, the OACS is determined by the
following rules. These rules are skipped as soon as an OACS containing CMACS
modes is found.
The reference C-Code also implements the OACS rules (see Annex E). In case of
inconsistencies between this clause and the C-code, the C-code takes
precedence.
### 12.3.1 Case 1: No Half Rate Channel is involved
**[Case MACS == 1]{.underline}**
1) Select mode according to preference list {6,7, 7,4, 5,9, 5,15, 4,75, 7,95,
10,2, 12,2}.
**[Case MACS == 2]{.underline}**
1) If mode 10,2 is supported, do not include mode 12,2.
2) Select highest mode.
3) If mode 12,2 or mode 10,2 is selected, select mode according to preference
list {6,7, 7,4, 5,9, 5,15, 4,75, 7,95, 10,2, 12,2}.
4) Select lowest mode.
**[Case MACS > 2]{.underline}**
1) If mode 10,2 is supported, do not include mode 12,2.
2) If mode 4,75 is supported, do not include mode 5,15.
3) If mode 5,15 is supported, do not include mode 5,9.
4) If mode 5,9 is supported and mode 4,75 is not supported, do not include
mode 6,7.
5) If mode (12,2 or 10,2) and 7,4 is supported, do not include mode 7,95.
6) If mode 7,95 is supported, do not include 7,4.
7) Select lowest mode.
8) Select highest mode.
9) Select mode 6,7.
10) Select mode 5,9.
### 12.3.2 Case 2: A Half Rate Channel is involved
**[Case MACS == 1]{.underline}**
1) Select mode according to preference list {5,9, 5,15, 4,75, 6,7, 7,4, 7,95}.
**[Case MACS == 2]{.underline}**
1) Select highest mode.
2) Select lowest mode.
**[Case MACS > 2]{.underline}**
The same rules apply as in clause 12.3.1 for the case MACS>2.
## 12.4 Rules for Contiguous Subset Selection
The rules for contiguous subset selection are necessary if one or both radio
legs don\'t support ACS change. If TFO should be established in these cases,
the resulting OACS must fulfil the contiguity rule considering the fixed ACS.
If the CSCS doesn\'t fulfil the contiguity rule, a contiguous subset with a
maximum number of modes shall be selected as the new CSCS. This subset must
contain the lowest mode of the fixed ACS, otherwise there is no OACS.
If the common MACS is lower than the number of modes in the CSCS, the highest
modes shall be removed from the CSCS until the number of modes in the CSCS is
equal to the common MACS. This new codec set defines the OACS.
## 12.5 Acceptability Rule for the OACS
An optimised ACS (OACS) is acceptable for AMR-NB TFO if
1) the Highest-Mode-Rule is fulfilled and
2) the Lowest-Mode-Rule is fulfilled.
[High Mode Rule]{.underline} (don\'t give up tandem with high quality modes)\
The highest mode in the OACS is not lower than one mode below the minimum of
the highest modes of both ACS.
[Low Mode Rule]{.underline} (tandem AMR with robust low modes performs
better)\ Either the lowest mode of the OACS is not higher than a specific
maximum mode or both ACS don\'t contain lower modes than the lowest mode in
the OACS. The specific maximum mode is 5,9 for TFO connections involving a
half rate channel and 7,4 otherwise.
## 12.6 FR -- HR -- Matching
A common ACS (CACS) is acceptable for immediate TFO establishment without
consideration of the OACS if all of the following conditions are fulfilled:
\- the one radio leg uses FR_AMR or UMTS_AMR_2 or HR_AMR, the other uses
HR_AMR [for AMR-NB TFO];
\- the CACS is contiguous;
\- the CACS fulfils the acceptability rule.
## 12.7 Contiguity Rule
The Contiguity Rule states that the codec modes of the CACS must be contiguous
modes in the local ACS (LACS) and the distant ACS (DACS). Additionally, the
CACS must contain the lowest mode of both ACS. The Contiguity Rule is used to
enable TFO establishment on a CACS different from the ACS. In a GSM system
this is necessary because link adaptation is only possible using maximum rate
control with adjacent modes of the ACS.
Example A: LACS: 12,2 10,2 7,95 5,9\ DACS: 10,2 7,95 5,9\ CACS: 10,2 7,95 5,9
Contiguity Rule is fulfilled
Example B: LACS: 12,2 10,2 4,75\ DACS: 10,2 7,4 4,75\ CACS: 10,2 4,75
Contiguity Rule is not fulfilled for the DACS
## 12.8 Examples of OACS Computation
### 12.8.1 TFO between a full rate channel and a half rate channel
* * *
         SCS   ACS   CACS   OACS   CSCS   ACS   SCS
12,2 x  
10,2 x x  
7,95 x  
7,4 x x x x x 6,7 x x x x x x x 5,9 x x x x x x x 5,15 x x x 4,75 x x x x x x
x
* * *
This is an example for FR -- HR -- Matching.\ Immediate TFO is possible using
the CACS.\ Afterwards, a codec mode optimisation is performed without
interrupting the ongoing TFO connection.
### 12.8.2 TFO between two full rate channels with different ACS
* * *
         SCS   ACS   CACS   OACS   CSCS   ACS   SCS
12,2 x x x x 10,2 x x x x x 7,95 x x x 7,4 x x x 6,7 x x x x x x x 5,9 x x x x
x x x 5,15 x x x 4,75 x x x x x x x
* * *
The CACS is a contiguous subset if the OACS.\ Immediate TFO and subsequent
codec mode optimisation without interrupting TFO is performed.
### 12.8.3 Full Rate Channel with restricted capabilities
* * *
         SCS   ACS   CACS   OACS   CSCS   ACS   SCS
12,2 x  
10,2 x x  
7,95 x  
7,4 x x x x x 6,7 x x x x x x x 5,9 x x  
5,15 x  
4,75 x x x x x x x
* * *
Immediate TFO is not possible because the CACS is not contiguous.\ TFO on the
OACS is acceptable since a tandem connection would not provide a better speech
quality.\ The OACS is acceptable since both the High Mode Rule and the Low
Mode Rule are fulfilled.
### 12.8.4 Scenario: Full Rate Channel with MACS == 2
* * *
         SCS   ACS   CACS   OACS   CSCS   ACS   SCS
12,2  
10,2  
7,95  
7,4 x x x x x 6,7 x x 5,9 x x x x 5,15 x x  
4,75 x x
* * *
The OACS is acceptable for a TFO connection. A tandem connection would not
provide better speech quality. Both High Mode Rule and Low Mode Rule are
fulfilled. For good radio channels a tandem between 7,4 and 6,7 is worse than
a 7,4 TFO connection. For poor radio channels a 5,9 TFO connection is
considered to be robust enough.
### 12.8.5 Scenario: AMR codec type with only one supported mode
* * *
         SCS   ACS   CACS   OACS   CSCS   ACS   SCS
12,2 x x x x x 10,2 x x  
7,95 x  
7,4 x  
6,7 x x  
5,9 x x  
5,15 x  
4,75 x x
* * *
One side offers an FR_AMR codec type with only the 12,2 mode in the supported
codec set.
The OACS is not acceptable, TFO should not be established. A tandem connection
would provide better overall speech quality. If the only supported mode is
lower or equal to the 7,4 mode, TFO shall be established on this single mode.
The 7,4 mode is considered to be robust enough in the case of poor radio
channels. On the other hand, a tandem connection between 7,4 and 12,2 would be
worse than a 7,4 TFO connection for good radio channels.
###### ## Annex A (normative): In-band Signalling Protocol: Generic Structure
# A.0 Scope of Annex A and Annex B
Inband Signalling Messages (IS Messages) can be used to construct a specific
IS Protocol for the communication between telecommunication entities for
various purposes. The original purpose was to establish Tandem Free Operation
of Mobile-to-Mobile calls in GSM networks. The IS Messages provide
communication channels inside the speech signal paths between the speech
transcoders.
In addition IS Messages allow the control of equipment within the speech
signal paths between these telecommunication entities (e.g. speech
transcoders). These equipments are termed \"In Path Equipments\" (IPEs).
Annex A defines the generic structure of these IS Messages and rules for the
IS_Sender.
Annex B defines the generic rules with respect to these IS Messages for the
IPEs.
Annex A is mandatory for TFO--capable Transcoder Equipment and informative for
IPEs.
Annex B is informative for TFO--capable Transcoder Equipment.
Annex B shall be followed by IPEs, which want to be compatible to IS Messages.
# A.1 Generic Structure of Inband Signalling Messages
All IS Messages follow a set of design rules, or a generic structure, which
allow to identify and bypass them by IPEs without detailed knowledge of the IS
Protocol served. The principle of the IS Protocol shall in that sense be
future proof: it can be enhanced and extended to other applications without
modifying the IPEs.
The IS Messages replace some of the LSBs of the PCM samples of the Speech,
Audio or Modem signal.
By construction the introduced signal distortion is practically inaudible in
case of Speech signals.
Modem signals will in most cases not be affected with respect to their data
transmission performance.
## A.1.1 Frequency and Order of Bit Transmission
IS Messages are transferred within the Least Significant Bit (LSB) of PCM
samples on 64 kbit/s links, by replacing the LSB of every 16^th^ consecutive
PCM sample with one bit of the IS Message (16_PCM_Sample_Grid).
This is equivalent to an average bit rate of 10 bit per 20 ms or 500 bits per
second. See Figure A1.1-1:
{width="6.889583333333333in" height="1.613888888888889in"}
Figure A.1.1-1: Inband Signalling Structure
A vertical bar denotes an 8-bit PCM sample, the shadowed box in bit 1 (LSB)
represents an inserted bit of the IS-Message.
By definition each IS Message \"occupies\" an integer multiple of 16 PCM
samples. Especially the 15 PCM samples after the last inserted bit of an IS
Message \"belong\" still to that IS Message.
All IS Messages, whichever type, have by construction \"0\"-Bits at every
10^th^ position, starting with position 1, 11, 21 and so on. This \"0\"-Bits
occur therefor regularly every 20 ms and may be used for synchronization
purposes.
Each IS Message consists of an IS_Header followed by an IS_Command_Block. Most
IS Messages have a number of further IS_Extension_Blocks. Figure A1.1-2 shows
an example with two IS_Extension_Blocks.
{width="6.840277777777778in" height="0.9847222222222223in"}
Figure A.1.1-2: Example for IS Message with two IS_Extension_Blocks
The MSB of each constituent field is transmitted first. The IS_Header is
transmitted first, followed by the IS_Command_Block and - if applicable - any
further IS_Extension_Block(s).
By construction all IS Messages do have lengths of integer multiples of 10
bits, thus occupying integer multiples of 160 PCM samples, thus lasting
integer multiples of 20 ms. The shortest IS Message has a length of 60 ms.
## A.1.2 IS_Header
The IS_Header consists of a 20-Bit long sequence, as defined in Figure A1.2-1:
{width="6.375694444444444in" height="1.179861111111111in"}
Figure A.1.2-1: Structure of the 20 bit IS_Header
## A.1.3 IS_Command_Block
The IS_Command identifies the IS Message and/or serves for the control of
IPEs. The names of the IS_Commands and their codes in hexadecimal notation in
the IS_Command_Block are given in the Table A.1.3-1
Table A.1.3-1: Defined IS_Commands
* * *
Index Command Code Meaning / Action
                     hexadecimal\   
                     Nibble 1-3
0 Reserved 0x000 no extension
1 **REQ** 0x05D Denotes an IS_REQ Message, with extension
2 **ACK** 0x0BA Denotes an IS_ACK Message, with extension
3 **IPE** 0x0E7 Denotes an IS_IPE Message, with extension,\ i.e. an IS_TRANS
or the IS_NORMAL Message
4 **FILL** 0x129 Denotes the IS_FILL Message, no extension
5 **DUP** 0x174 Denotes the IS_DUP Message, no extension
6 **SYL** 0x193 Denotes the IS_SYL Message, no extension
7 reserved 0x1CE no extension
* * *
All other values are reserved for future use.
Each IS_Command is protected by the binary, systematic (9,3) block code with
generator polynomial\ g(x) = x\^6 + x\^4 + x\^3 + x\^2 + 1. The minimum
Hamming distance of this code is dmin = 4, which allows the correction of up
to one bit error within each code word of length 9 bits.
The first bit (MSB) of the IS_Command_Block is defined to be \"0\", for
synchronisation purposes, see Figure A1.3-1.
Table A-1 gives the hexadecimal notation of the complete IS_Command_Block.
{width="4.823611111111111in" height="1.125in"}
Figure A.1.3-1: General Construction of an IS_Command_Block
## A.1.4 IS_Extension_Block(s)
Most IS Messages have one or more IS_Extension_Block(s). Each
IS_Extension_Block is 20 bits long and shall consist of two
\"0\"-Synchronization_Bits at position 1 (MSB) and 11, a 16-bit
Information_Field (split into two fields of 9 and 7 bits, respectively) and a
2-bit Extension_Field (EX), see Figure A1.4-1:
{width="4.538194444444445in" height="0.6930555555555555in"}
Figure A1.4-1: General Construction of an IS_Extension_Block
The Extension_Field indicates if an other IS_Extension_Block is following (EX
:=\"1.1\" ) or not (EX := \"0.0\").
All other codes are reserved. This may be used to detect transmission errors
within the Extension_Field.
# A.2 Detailed Specification of IS Messages
## A.2.1 IS_REQ Message
With the IS_REQ Message an IS_Sender can test, if there is an IS Partner and
indicates that it is willing to negotiate.
IS_REQ is used to initiate the IS Protocol or to indicate changes in the
configuration, etc.
IS_REQ has at least one IS_Extension_Block, containing the
IS_System_Identification. (see clause A.5).
Other IS_Extension_Blocks may follow, see Figure A2.1-1.
{width="6.832638888888889in" height="0.9888888888888889in"}
Figure A.2.1-1: General Construction of an IS_REQ Message
In general an IS_REQ Message shall be as short as possible. Special care must
be taken in the design of the IS_Extension_Blocks to avoid audible effects,
since sometimes an IS_REQ Message may be transmitted for quite some time
(several seconds).
## A.2.2 IS_ACK Message
With the IS_ACK Message an IS Partner typically answers an IS_REQ Message or
an IS_ACK Message. It can also be used to submit further information to the
other IS Partner. IS_REQ and IS_ACK are the main message types between IS
Partners.
The IS_ACK has at least an IS_Extension_Block containing the
IS_System_Identification (see clause A.5).
Other IS_Extension_Blocks may follow, see Figure A.2.2-1.
{width="6.822916666666667in" height="0.9895833333333334in"}
Figure A.2.2-1: General Construction of an IS_ACK Message
No specific design constraints with respect to audibility exist, since IS_ACK
is typically not sent very often.
### A.2.3 IS_IPE, IS_TRANS and IS_NORMAL Messages
The IPE command denotes IS_IPE Messages. An IPE shall always look for this
type of message and follow the instruction. An IS_Sender shall use this IS_IPE
Message to command all IPEs into a specific mode of \"Bit Transparency\".
This Message has one IS_Extension_Block, indicating the requested IPE_Mode.
See Figure A.2.3-1.
{width="5.129861111111111in" height="0.9881944444444445in"}
Figure A.2.3-1: General Construction of an IS_IPE Message
No specific design constraints with respect to audibility exist, since IS_IPE
is typically not sent very often.
Table A-2 defines 16 out of 32 possible IPE_Commands. The other codes are
reserved for future extensions.
Table A.2.3-1: Defined IPE_Modes
* * *
Index IPE_Mode Code MEANING / ACTION
                         hexadecimal\   
                         Nibble 1 - 5
0 Normal 0x00000 Normal Operation
1 Trans_1_u 0x044DC pass 1 LSB; 7 upper Bits are used
2 Trans_2_u 0x089B8 pass 2 LSBs; 6 upper Bits are used
3 Trans_3_u 0x0CD64 pass 3 LSBs; 5 upper Bits are used
4 Trans_4_u 0x11570 pass 4 LSBs; 4 upper Bits are used
5 Trans_5_u 0x151AC pass 5 LSBs; 3 upper Bits are used
6 Trans_6_u 0x19CC8 pass 6 LSBs; 2 upper Bits are used
7 Trans_7_u 0x1D814 pass 7 LSBs; 1 upper Bit is used
8 Transparent 0x22CE0 Full Transparent Mode for all eight bits
9 Trans_1 0x2683C pass 1 LSB; 7 upper Bits are free and unused
10 Trans_2 0x2A558 pass 2 LSBs; 6 upper Bits are free and unused
11 Trans_3 0x2E184 pass 3 LSBs; 5 upper Bits are free and unused
12 Trans_4 0x33990 pass 4 LSBs; 4 upper Bits are free and unused
13 Trans_5 0x37D4C pass 5 LSBs; 3 upper Bits are free and unused
14 Trans_6 0x3B028 pass 6 LSBs; 2 upper Bits are free and unused
15 Trans_7 0x3F4F4 pass 7 LSBs; 1 upper Bit is free and unused
16 reserved 0x41D1C reserved
17..31 reserved Reserved reserved
* * *
The IPE_Mode is protected by the binary, systematic (16,5) block code with
generator polynomial g(x) = x\^11 + x\^7 + x\^5 + x\^4 + x\^2 + x + 1. The
minimum Hamming distance of this code is dmin=7, which allows the correction
of up to 3 bit errors within each code word of length 16 bits.
Bits 1 (MSB) and 11 are the synchronisation bits and set to \"0\", see Figure
A-9. The EX field is set to \"0.0\" in all currently defined IPE_Modes, i.e.
no further IS_Extension_Block is following.
Table A2.3-2 defines the coding in hexadecimal notation for the complete
IPE_Mode_Extension_Block, with EX := 00.
{width="4.65in" height="1.0152777777777777in"}
Figure A.2.3-2: IPE_Mode_Extension_Block for the IS_IPE Message
An IS_ IPE Message containing the NORMAL command is termed **IS_NORMAL
Message**.
An IS_ IPE Message containing a TRANS_x command is termed **IS_TRANS_x
Message**.
An IS_ IPE Message containing a TRANS_x_u command is termed **IS_TRANS_x_u
Message.**
The latter two are sometimes also termed **IS_TRANS Message** , if the details
are not important.
The behaviour of IPEs, when receiving such commands, is described in Annex B.
The first IS Message in a series is often \"swallowed\" by IPEs (see Annex B).
An IS_IPE Message must therefore never be the first message of a series of IS
Messages, i.e. it shall be sent as an isolated IS Message or after a
(sufficiently long) uninterrupted IS Protocol.
### A.2.4 IS_FILL Message
The IS_FILL Message has no IS_Extension_Block and no specific meaning. An IS_
Sender can use the IS_FILL Message to fill a temporary gap in the protocol
flow. This may be important to keep all IPEs in synchronization and open for
further IS Messages, see Figure A-10. An IS_FILL Message shall also be used by
the IS_Sender to resynchronize all IPEs in case of a phase shift of the
Keep_Open_Indication.
{width="3.453472222222222in" height="0.8895833333333333in"}
Figure A.2.4-1: Construction of the IS_FILL Message
IS_FILL is designed in a way that multiple repetitions cause minimal audible
effects.
### A.2.5 IS_DUP Message
The IS_DUP Message may be used between IS Partners to indicate an half duplex
mode. It may be especially important in Handover situations. The IS_DUP
Message has no IS_Extension_Block, see Figure A.2.5-1.
{width="3.43125in" height="0.93125in"}
Figure A.2.5-1: Construction of the IS_DUP Message
### A.2.6 IS_SYL Message
The IS_SYL Message may be used between IS Partners to indicate the loss of
synchronisation. It may be especially important in Handover situations. The
IS_SYL Message has no IS_Extension_Block, see Figure A.2.6-1.
{width="3.453472222222222in" height="0.8895833333333333in"}
Figure A.2.6-1: Construction of the IS_SYL Message
## A.3 Keep_Open_Indication
In Transparent_Mode, i.e. after properly receiving an IS_TRANS Message, all
IPEs shall monitor the bypassing bit stream for the Keep_Open_Indication. If
this Keep_Open_Indication is not seen for some time, then the IPEs shall fall
automatically back into normal operation, i.e. the mode of operation before
the IS_TRANS Message.
This automatic fall back shall have the same effect as the IS_NORMAL Message
would have.
By definition the Keep_Open_Indication is a continuous bit stream of one
\"0\"-Bit in the LSB of every 160^th^ PCM sample, i.e. every 20 ms. At least
one \"1\"-Bit must be present within the LSBs of the other 159 PCM samples,
see Figure A.3-1.
{width="6.8in" height="1.53125in"}
Figure A.3-1: Keep_Open_Indication
The \"0\"-Bit stream of the Keep_Open_Indication shall always be present as
long as the IPEs need to be in Transparent_Mode.
The Keep_Open_Indication shall be in phase with the preceding IS Messages.,
i.e. the first bit of the Keep_Open_Indication shall be in the position of the
first bit of the (hypothetical) next IS Message. In fact, the IS Messages
themselves contain this Keep_Open_Indication by definition.
In case of a known phase shift of the Keep_Open_Indication, the IS_Sender has
to send at least one IS Message, which defines the new phase position of the
Keep_Open_Indication. If no other IS Message is to be sent, then the IS_FILL
Message shall be used. If an IS Message longer than 160 ms is scheduled for
transmission, then an IS_FILL Message should be inserted before, to guarantee
fast resynchronization of the IPEs.
## A.4 Rules for Sending of IS Messages
IS Messages replace some bits of the PCM samples and therefor cause a minimal
signal distortion. Therefore IS Messages shall be used with care and not
longer than necessary. The IS Protocol is kept to a minimum to avoid
unnecessary complexity. One basic assumption is that only one IS Protocol is
active at a time between two IS Partners.
Only specific telecommunication entities shall be allowed to initiate IS
Protocols. They are called **IS_Active** or active IS Partners. In principle
these shall only be terminal devices or their \"representatives\" within the
network. Examples are ISDN-Terminals, Speech-Servers and Transcoders (as
representatives of the MSs).
Other telecommunication entities shall only react on IS Protocols. They are
called **IS_Passive**. Most IPEs are of this type. They bypass the IS
Messages, they obey the IS_IPE Messages, but they never initiate IS Messages.
Other telecommunication entities are IS_Passive by default. But if they
receive IS Protocols that they can understand, then they may become IS_Active
and start to initiate IS Protocols. They thus become active IS Partners and
shall take care that only one IS Protocol is active on both of their sides.
They are called **IS_Responsive.** TCMEs are examples of such entities.
Active IS Partners shall send:
\- either continuous sequences of IS Messages without interruption of the
16_PCM_Sample_Grid; or
\- isolated IS Messages with same message lengths; or
\- isolated IS Messages with sufficient distance between them, if shorter IS
Messages follow longer IS Messages.
The latter case is important, because shorter isolated IS Messages travel
faster through IPEs than longer ones, see annex B.
As said above, after initialisation of an IS Message sequence, no interruption
of the 16_PCM_Sample_Grid shall occur within the sequence. Adjustments of the
phase position of the Keep_Open_Indication shall be done only after the
IS_TRANS Message by inserting the necessary number _n_ (with 0 \ \- or its Configuration Parameters (e.g. the ACS in case of AMR or AMR-WB)
> (New_Local_Config); and
>
> \- a modification of the list of the alternative speech Codec Types
> (New_Local_Codec_List);
>
> \- TFO Enable or TFO Disable;
>
> \- Handover Soon.
The New_Local_Codec is extracted from the uplink TRAU Frames and reported by
Rx_TRAU.
The other parameters are received from the BSC, via the BTS in Config Frames
(AMR and AMR-WB cases only) or in an manufacturer dependent way.
### C.3.5.1 Messages from Rx_TRAU or local BSS
Rx == New_Speech_Call (); Rx_TRAU is activated by BTS\ (several TRAU Frames).
Rx == New_Local_Codec (); In Call Modification to other Codec Type (several
TRAU Frames).
Rx == New_Local_Config (); In call modification (e.g. new ACS, in Config
Frame)
Rx == Data_Call; Received from Rx_TRAU: In Call Modification to Data_Call.
Rx == Local_Codec_List; Manufacturer dependent
Rx == TRAU_Idle; Manufacturer dependent, either from Rx_TRAU or BSC.
Rx == TFO_Enable; Received from Rx_TRAU for AMR or AMR-WB: Enable the TFO
process\ Optionally received from the BSC for GSM_FR, GSM_HR and GSM_EFR.
Rx == TFO_Disable; Received from Rx_TRAU for AMR or AMR-WB: Disable the TFO
process\ Optionally received from the BSC for GSM_FR, GSM_HR and GSM_EFR.
Rx == TFO_Soon; The sent TFO_Soon is acknowledged by the BTS, especially
important and handled as RC_Ack in WAIT_RC State.
Rx == Handover_Soon (); Optional Pre-Handover warning (e.g. in Config_Frame)
### C.3.5.2 Messages to Tx_TRAU
Tx_TRAU := Accept_TFO; If TFO Frames are correctly received, they shall be
used. Rate Control in Tx_TRAU shall take the distant side into account.
Tx_TRAU := Ignore_TFO; TFO Frames shall be ignored in general. Rate Control in
Tx_TRAU shall ignore the distant side..
Tx_TRAU := Set_Max_Rate (); The Rate Control shall be limited to the give
maximum rate, e.g. TFO Setup Mode, Handover Mode, Maximum mode of the Common
ACS. The new Max_Rate value shall be taken into account in the next possible
frames.
Tx_TRAU := Config_Frame (); A Dis_Req frame with all available distant TFO
parameters is sent to the BTS (The BTS acknowledges this by UL_Ack).
Tx_TRAU := TFO_Soon; TFO_Soon is sent to the BTS (The BTS stops Time alignment
and acknowledges with TFO_Soon => RC_ACK).
Tx_TRAU := TFO_On; TFO_On is sent to the BTS (The BTS may perform round trip
delay measurements; the BSC should not alter the configuration during
handover).
Tx_TRAU := TFO_Off; TFO_Off is sent to the BTS after no more TFO Frames are
received and the normal Tx_TRAU operation has been resumed. The BTS shall
resume normal operation, too.
### C.3.5.3 Optional Messages to the local BSC
Tx_BSC := TFO (Distant_Used_Codec, Distant_Codec_List, Distant_Configuration,
Optimal Codec Type and Configuration, ...).
For the AMR, AMR-WB, GSM_FR, GSM_HR and GSM_EFR Codec Types these parameters
may be transmitted on a proprietary interface to the BSC to allow the BSC to
perform the optional Codec Type and Codec Configuration Mismatch resolution
and Optimisation.
In case of AMR and AMR-WB these configuration parameters are transferred in
Config_Prot Frames or on a proprietary interface to the BSC to allow the BSC
to perform the optional Codec Type and Codec Configuration Mismatch resolution
and Optimisation.
### C.3.5.4 Messages to Tx_TFO
The symbol () indicates that these Messages contain parameters, see Clause 8.
Tx := TFO_REQ (); main TFO_REQ Message.
Tx := TFO_ACK (); main TFO_ACK Message, response only to TFO_REQ.
Tx := TFO_REQ_L (); used in Mismatch, Operation and Periodic_Retry to inform
about alternative Codecs.
Tx := TFO_ACK_L (); response only to TFO_REQ_L.
Tx := TFO_TRANS (); commands IPEs to go transparent.
Tx := TFO_NORMAL; resets IPEs into their normal operation.
Tx := TFO_FILL; mainly to pre-synchronise IPEs.
Tx := TFO_DUP; \"I receive TFO Frames in Establishment\".
Tx := TFO_SYL; \"I lost TFO Frame synchronisation\".
Tx := Begin_TFO; Insert TFO Frames from now on.
Tx := Discontinue_TFO; Discontinue inserting TFO Frames.
Tx_TFO := Set_Max_Rate (); The Rate Control shall be limited to the given
maximum rate,\ e.g. Handover Mode, Maximum mode of the Common ACS.\ The new
Max_Rate value shall be taken into account in the next possible frames.
Clear Tx_Queue; Clears all remaining commands from Tx_Queue.
> Rx == Runout; Reports that the continuous stream of outgoing TFO Messages
> may be interrupted (from Tx_TFO).
>
> Tx_TFO := Con_Req(); Send a Con_Req config frame.
>
> Tx_TFO := Con_Ack(); Send a Con_Ack config frame.
#### C.3.5.5 Messages from Rx_TFO
The symbol () indicates that these Messages contain parameters, see Clause 8.
Rx == TFO_REQ ();
Rx == TFO_ACK ();
Rx == TFO_REQ_L ();
Rx == TFO_ACK_L ();
Rx == TFO_TRANS (); may serve as alternative TFO_ACK in some cases!.
Rx == TFO_NORMAL;
Rx == TFO_FILL;
Rx == TFO_DUP;
Rx == TFO_SYL;
Rx == TFO_Frame (); TFO_Frame (Distant_Used_Codec; Number_of_Received_Frames).
Rx == Distant_Config();
Rx == Frame_Sync_Lost (); Frame_Sync_Lost (Number_of_Lost_Frames).
Rx == Mess_Sync_Lost; Message_Sync_Lost.
Rx == PCM_Non_Idle; at the beginning of a period with several samples/frame
different from PCM_Idle.
The message \"TFO_Frame ()\" needs to be sent only at the first five
occurrences, either after a not valid TFO Frame, or if the Distant_Used_Codec
changed.
The message \"Frame_Sync_Lost ()\" needs to be sent only at the first five
occurrences of errors in TFO Frames or loss of synchronisation, after a
correctly received TFO Frame.
The message \"Mess_Sync_Lost\" is sent, when after a valid TFO Message no
following TFO Message is found.
# C.4 TFO_BTS
The following clauses apply only when an AMR or AMR-WB Codec Type is the
Used_Codec_Type and when TFO is enabled.
## C.4.1 TFO_States and Transitions
The BTS needs to know the status of the TFO connection for best operation of
the AMR Link adaptation and Optimal Handover procedure.
The TFO_BTS state machine is made of five states:
**\- TFO_DIS** : No Tandem Free Operation is allowed or ongoing;
**\- TFO_NO** : Tandem Free Operation is enabled, but is neither ongoing nor
under establishment;
**\- TFO_MAYBE** : Tandem Free Operation is under establishment, but is still
not ongoing;
**\- TFO_YES** : Tandem Free Operation is ongoing.
**\- TFO_TERM** : Tandem Free Operation is still ongoing, but will terminate
soon.
The following TFO_State diagram (Figure C.4.1-1) shows the five States and the
most important transitions.
{width="3.3541666666666665in" height="3.1354166666666665in"}
Figure C.4.1-1: Main TFO _State Diagram within the BTS
At resource allocation the BTS enters either **TFO_DIS** or **TFO_NO** ,
depending on the Configuration Message from the BSC (see clause C.5.2.1). The
transition from one state to another one is triggered by the reception of a
message, either from the BSC or the TRAU. According to the TFO_State the BTS
shall initiate different actions.
In **TFO_DIS** and **TFO_NO** the BTS may perform Time and Phase Alignment. In
all other States (**TFO_MAYBE** , **TFO_YES** , **TFO_TERM** which are often
gathered under the expression \"TFO ongoing\", the BTS should not send Time or
Phase Alignment Messages to the TRAU, since the TRAU shall not obey them. In
State **TFO_YES** the BTS may perform Phase Alignment on the air interface,
see 3GPP TS 45.009 [9].
_TFO_Enable_ and _TFO_Disable_ are not messages per se, but are included in
Configuration Message from the BSC (see clause C.5.1) by setting or resetting
the TFO_Enable bit. In any case the local configuration parameters shall be
sent to the TRAU immediately.
_TFO_Soon, TFO_On_ and _TFO_Off_ are sent from the TRAU, either with or
without configuration parameters and rate Control commands from the distant
side.
_TFO_Enable_ at resource allocation brings the BTS into **TFO_NO**.
_TFO_Enable_ is relayed to the TRAU by the BTS (TFOE bit in TRAU frames). The
TRAU shall then start TFO_Negotiation with a potential TFO_Partner.
_TFO_Enable_ in State **TFO_DISABLED** or **TFO_TERMINATING** starts the same
procedure and brings the BTS also into State **TFO_NO**. In any other State
the _TFO_Enable_ has no effect on the ongoing procedures.
_TFO_Disable_ at resource allocation brings the BTS into **TFO_DISABLED**. The
TRAU shall not initiate nor respond to any TFO_Negotiation. It shall terminate
TFO operation or Negotiation.
_TFO_Disable_ in **TFO_YES** brings the BTS into State **TFO_TERMINATING**.
_TFO_Disable_ in any other State brings the BTS immediately into
**TFO_DISABLED**.
If TFO is enabled the TRAU will get the knowledge about the distant side by
the first received TFO_REQ or TFO_ACK Message or by Con_Req or Con_Ack
Messages. As soon as the TRAU gets knowledge that a TFO_Partner exists, it
informs the BTS in downlink about the Distant configuration, see clauses C.6.1
and C.6.2). If TFO is possible, the TRAU sends a _TFO_Soon_ Message to the
BTS. If TFO is not possible, the BSS may then perform Mismatch Handling.
Alternatively the TRAU sends only the Optimal Codec Type and Optimal Codec
Configuration to the BTS and/or further to the BSC.
_TFO_Soon_ in State **TFO_NO** brings the BTS into State **TFO_MAYBE**. The
BTS has to discontinue Time and Phase Alignment with the TRAU and instead has
to buffer the received TRAU frames for downlink transmission.
_TFO_On_ reports that finally TFO is ongoing, i.e. TFO Frames are exchanged in
both directions. The BTS enters State **TFO_YES** and enables the AMR
Adaptation, now considering both radio legs for the selection of the optimal
Codec_Mode. In TFO handover situations a Con_Ack instead of a TFO_On will
bring the BTS into State TFO_YES.
_TFO_Off_ brings the BTS immediately into the State **TFO_NO**. The BSC should
be informed.
## C.4.2 Handling of downlink DTX in TFO
If TFO is ongoing and the BTS receives downlink TRAU frames classified with
\"SID_First or \"SID_Update\", it shall use one of the following options:
\- Option 1) The BTS performs normal DTX operation in downlink if DTX DL is
enabled.
\- Option 2) The BTS shall send the SID_First, SID_Update frames as in normal
DTX, but shall send SID_Filler frames between SID frames when DTX DL is
disabled.
See 3GPP TS 26.093 for the definition of the SID_Filler frames.
Note : In all cases ONSET frames may be ignored, see 3GPP TS 45.009 [9], but
may be used to ensure proper synchronisation.
## C.4.3 Handling of Errors in Configuration Parameters
The BTS shall check the consistency of the configuration data sent by the
TRAU. If inconsistent they shall be ignored, i.e. no report is made to the
BSC, no change of the MS-BTS ACS is attempted, no acknowledgement is sent back
to the TRAU. The missing Acknowledgement will trigger a repetition of the
configuration data.
## C.4.4 Procedures for Round Trip Delay Measurements
In case of AMR and AMR-WB, the link adaptation may need information on the
round trip delay between the local BTS and the local TRAU or - when TFO is
ongoing - with the distant BTS. Therefore, the BTS shall count the number of
elapsed TRAU frames between the sending of a \"Con_Req\" (see clause C.6.2)
message and the receipt of the corresponding acknowledgement. This number,
multiplied by 20 ms, gives an estimate of the round trip delay between the BTS
and its partner. The type of acknowledgement (DL_Ack or Con_Ack) indicates the
type of partner, i.e. whether the local TRAU or the distant BTS has answered.
This procedure may be repeated whenever the status of the connection changes.
The round trip delay measurement is triggered by the transition into State
TFO_YES. But there are other cases, where a new delay measurement is required,
although the State TFO_YES has not changed. This is e.g. the case when a
distant handover occurred. The BTS where the handover takes place shall send
the \"Handover_Complete\" Notification within the Time Alignment field of a
Con_Req frame to the other BTS. This then shall repeat the Delay Measurement
on its side.\ The Handover_Complete Notification shall be re-sent in every
Con_Req frame until a Con_Ack was received.
The BTS may report the round trip delay measurement result to the BSC by
sending a round Trip Delay Report (see 3GPP TS 48.058). Any substantial change
(more than 60 ms difference) in the round trip delay may be reported, too.
# C.5 TFO_BSC
The role of the BSC in TFO depends on the speech Codec Type in use, and on the
degree of flexibility desired.
For the GSM_FR, GSM_EFR and GSM_HR speech Codec Types the BSC may perform the
Resolution of Codec Type Mismatch and Codec Type Optimization (see clause
C.5.1).
For the AMR and AMR-WB Speech Codec Types the role of the BSC can be much more
important (see clause C.5.2).
## C.5.1 Resolution of Codec Type Mismatch and Codec Type Optimization
The BSC is in charge of solving the Codec Type Mismatches. The BSC receives
from the TRAU or the BTS in case of AMR and AMR-WB the distant speech service
configuration (e.g. the distant used codec and the distant codec list), or
alternatively, the Optimal Codec Type and the Optimal Codec Configuration.
The BSC transmits to the TRAU the Local configuration, via the BTS for AMR and
AMR-WB. It may have to refresh this information if the configuration changes
along the time.
The BSC may implement the TFO decision algorithm provided in the Clause 11 and
12, or alternatively get the results from the BTS or TRAU. This TFO decision
algorithm ensures that both BSCs obtain the same result. The BSC can then
initiate an intra-cell Handover if a different Codec Type is required to
ensure Tandem Free Operation.
## C.5.2 Role of the BSC for AMR and AMR-WB TFO
AMR introduces a degree of complexity, due to its multi-rate nature, to its
link adaptation and to the different options it allows. It is required that
the AMR configurations of the two terminals and two BSS be aligned.
The ACS can vary and depends on the BTS generation, BTS manufacturer or on
Operators\' preferences. The ACS can be tailored to cope with the environment
of a given cell, e.g. a dense urban area or a flat rural area.
The MS may either support FR_AMR only or FR_AMR and HR_AMR and FR_AMR-WB. The
BSS can support from one mode to all fourteen AMR modes (8 in FR_AMR and 6 in
HR_AMR) and between between 3 and 11 modes for AMR-WB (3 in FR_AMR-WB, 3 in
OHR_AMR-WB and 5 in OFR_AMR-WB). The ACS in GSM may include between 1 and 4
modes for AMR and AMR-WB.
In addition to resolving the Codec Type Mismatch as explained in clause C.5.1,
the BSC can also be involved in the following TFO related tasks:
1\. Determination and Establishment of the Optimal ACS.
2\. Keep as far as possible the same ACS during Handovers.
### C.5.2.1 Configuration of the AMR and AMR-WB speech service.
The MS is configured by the BSC at Call set-up and during handovers through
Layer 3 signalling (see GSM 04.18 [14]). The BTS is configured through the
CHANnel ACTIVation message (see 3GPP TS 48.058). The TRAU circuit pools are
managed by the MSC on request of the BSC (see 3GPP TS 48.008 [10]).
The AMR configuration of the MS and BTS can be changed during the call by:
\- Intra-Cell Handover (see 3GPP TS 44.018 and 3GPP TS 48.058 [12]),
\- Mode-Modify (see 3GPP TS 44.018 and 3GPP TS 48.058 [12]),
\- RATSCCH (see 3GPP TS 45.009 [9] and 3GPP TS 48.058 [12]).
These procedures are initiated by the BSC. The RATSCCH can in addition be
delegated to the BTS by the BSC at the Channel Activation. This can modify the
way TRAU handles TFO setup. (see clause C.5.2.2)
The RATSCCH is the most efficient technique from a speech quality point of
view since it can be faster and can minimize the number of lost frames.
The Intra-Cell Handover is a synchronized handover and creates less speech
frame losses than the typical Handovers.
The Mode Modify offers the advantage of keeping the same radio resource but
can introduce long speech blanks.
### C.5.2.2 Determination and Establishment of the Common ACS
The resolution of the AMR Codec Configuration Mismatch is based on similar
principles as the Codec Type Mismatch. The corresponding TFO Decision
algorithm is defined in Clause 12. When applied, it leads to a common optimal
ACS at both ends of the TFO connection.
The resolution of Codec Configuration Mismatch depends on the Optimisation
Mode, see table C.5.2.2-1.
Table C.5.2.2-1: Coding of the Optimisation Mode (OM)
* * *
OM Code Optimisation Mode Comment 0 No Change Change of the ACS is not
supported 1 Change Change of the ACS is supported
* * *
The reporting of the Configuration parameters from the TRAU to the local BTS
depends on the \"Optimal or Distant Configuration (OD)\" parameter, see table
C.5.2.2-2.
Table C.5.2.2-2: Optimal or Distant Configuration (OD)
* * *
OD Code Optimal or Distant\ Comment Configuration
0 Distant TRAU shall send Distant Configuration Parameters
1 Optimal TRAU shall send Optimal Configuration Parameters
* * *
In case of OM = Change, the TRAU provides the BTS and further on the BSC (see
3GPP TS 48.058 clause 4.15) with the Distant Configuration (OD = Distant) or
the Optimal Configuration (OD = Optimal).
OD is a configuration parameter set by the BTS (respectively the BSC) and send
to the local TRAU.
The configuration is changed using one of the methods listed in the clause
C.5.2.1.
### C.5.2.3 Handovers and the AMR TFO
Handover in an ongoing AMR-TFO connection needs more attention. It can be
handled more efficiently, if the BSC takes the configurations (the active
local one in the serving, old BTS, the future local one in the new BTS and the
distant one in the distant BTS) into account and informs the serving BTS a
before performing the handover (\"Pre-Handover Notification\"). The sending of
the Pre-Handover Notification should take into account the round-trip delay if
it has been reported by the BTS (see clause C.4.5).
The BSC, as a central point of the BSS, manages the AMR Speech Service
configuration along the communication.
The BSC has at any time control over the ongoing call, especially over all
used resources. Some AMR specific adaptation procedures are, however, handled
by lower layer inband signalling directly, e.g. time alignment, CMI/CMC phase
alignment and Codec_Mode adaptation (Rate Control).
# C.6 The Dialogue between TFO_TRAU and TFO_BTS
From REL-5 onwards the \"Generic Configuration Frame\" is defined (Annex H) as
a mechanism to exchange Configuration parameters between BTS and TRAU, between
the TRAUs and between local and distant BTSs. These generic configuration
frames are codec-type-independent and may in principle be used also for older
Codec Types. Clause 4.3 defines when to use this generic configuration frame
and when to use the AMR Configuration frame or the TFO_REQ_L / TFO_ACK_L
mechanism.
The BTS [need]{.underline} not to be involved in TFO when GSM_FR, GSM_EFR or
GSM_HR Speech Codec Types are used.
But from REL-5 onwards the generic configuration frames [may]{.underline} also
be used for these Codec Types. Then the BTS shall be able to handle them, at
least to ignore them, when they appear in downlink on the Abis/Ater interface.
If this is not possible, then the TRAU shall not use it either.
The following clauses address therefore mainly the dialog between the BTS and
TRAU or between the Local and Distant TRAUs or BTSs in case of the AMR-NB and
AMR-WB families of Codec Types.
## C.6.1 Configuration Parameters in AMR-NB TRAU/TFO frames
### C.6.1.1 Configuration Protocol Format
\"TRAU AMR Configuration frames\" and \"TFO AMR Configuration frames\" contain
AMR-NB and TFO configuration parameters. The \"generic configuration frames\"
contain configuration parameters for all codec types. These parameters are
exchanged by the following configuration protocol between several entities
(local BTS to local TRAU, local BTS to distant BTS, local TRAU to distant BTS
and local TRAU to local BTS).
Three control fields are defined for the TFO and TRAU AMR Configuration frames
and in generic configuration frames:
\- Config_Prot field defines the sender and the recipient;
\- Message_No field is a protocol counter;
\- Par_Type field defines the contents of the parameter fields.
The Parameter fields carry the TFO and AMR Configuration parameters.
Each TFO (or TRAU) AMR configuration frame contains a set or a subset of these
configuration parameters. Some exceptions exist (12,2 kbit/s for instance, see
mapping of Configuration Parameters clause C.6.1.5).\ Generic configuration
frames do always contain a full set, see Annex H.
### C.6.1.2 Config_Prot field
This field serves for the Configuration Protocol on the Abis/Ater interface
and the A interface in both directions to indicate the source and meaning of
the configuration parameters. It is defined in UL TRAU frames, in DL TRAU
frames and in TFO frames, both for the AMR Configuration Frames and the
Generic Configuration Frames.
Table C.6.1.2-1: Coding of Config_Prot
+----------+----------+----------+----------+----------+----------+ | **Config |** Name**|** Exists | **M |** sent | **rec | | _Prot** | | on**| eaning** | by**| ipient** | +----------+----------+----------+----------+----------+----------+ | 0.0.0 | No_Con | UL, DL, | No | | | | | | TFO | confi | | | | | | frame | guration | | | | | | | i | | | | | | | ncluded, | | | | | | | shall | | | | | | | not be | | | | | | | ackn | | | | | | | owledged | | | +----------+----------+----------+----------+----------+----------+ | 0.0.1 | Con_Req | UL, DL, | confi | L_BTS | D_BTS, | | | | TFO | guration | | | | | | frame | in | | L_TRAU | | | | | cluded,\ | | | | | | | shall be | | | | | | | ackn | | | | | | | owledged | | | +----------+----------+----------+----------+----------+----------+ | 0.1.0 | Dis_Req | DL | (subset | L_TRAU | L_BTS | | | | | of) | | | | | | | config | | | | | | | uration\ | | | | | | | shall be | | | | | | | ackn | | | | | | | owledged | | | +----------+----------+----------+----------+----------+----------+ | 0.1.1 | Con_Ack | UL, DL, | ack | L_BTS, | D_BTS, | | | | TFO | nowledge | D_BTS | L_BTS | | | | frame | for | | | | | | | Con_Req | | | +----------+----------+----------+----------+----------+----------+ | 1.0.0 | Spare | - | for | | | | | | | future | | | | | | | use | | | +----------+----------+----------+----------+----------+----------+ | 1.0.1 | UL_Ack | UL | ack | L_BTS | L_TRAU | | | | | nowledge | | | | | | | for | | | | | | | Dis_Req | | | +----------+----------+----------+----------+----------+----------+ | 1.1.0 | DL_Ack | DL | ack | L_TRAU | L_BTS | | | | | nowledge | | | | | | | for | | | | | | | Con_Req | | | +----------+----------+----------+----------+----------+----------+ | 1.1.1 | Spare | - | for | | | | | | | future | | | | | | | use | | | +----------+----------+----------+----------+----------+----------+
**Notation:** L_TRAU: local TRAU, L_BTS: local BTS, D_BTS: distant BTS.
For the mapping of these bits on TRAU/TFO frames, see clause C.6.1.5 for AMR
Configuration frames and Annex H for generic configuration frames.
For the use of the Config_Prot, see clause C.8.
### C.6.1.3 Message_No Field
The Message_No is used to mark a configuration request message at sender side
in order to bind the acknowledgement from the receiver side. It is two bits
long. For the mapping of these bits see clause C.6.1.5 and Annex H.
### C.6.1.4 Configuration Parameters Fields
The configuration parameters are:
[**TFOE** (1 bit)\ ]{.underline}TFOE (TFO_Enable) set to 0: TFO disabled; set
to 1: TFO enabled.\ By this bit set to 1 the BTS enables the TRAU to perform
TFO negotiation and to go into Tandem Free Operation, if possible.
Respectively, if this bit is set to 0, the TRAU shall terminate TFO as soon as
possible and shall not initiate or respond to any TFO negotiation message.
TFOE in AMR Configuration frames or generic configuration frames is also used
to signal to the distant TFO partner that TFO is terminated (see Annex G.3).
[**Time Alignment Field** (6 bits)**\**]{.underline}The Time Alignment Field
is defined in 3GPP TS 48.060 [3] for time and phase alignment.\ In addition
five more code points, which are reserved in3GPP TS 48.060 [3] are defined for
TFO and Handover Notifications:
* * *
Time Alignment Field Name defined on 1.1.1.**0.0.0** TFO_On Abis/Ater
1.1.1.**0.0.1** TFO_Soon Abis/Ater 1.1.1.**0.1.0** TFO_Off Abis/Ater
1.1.1.**0.1.1** Handover_Soon Abis/Ater and A 1.1.1.**1.0.0**
Handover_Complete Abis/Ater and A
* * *
The protocol for the exchange of these Notifications is defined in Annex
C.6.2.
[**Par_Type** (2 bits)**\**]{.underline}Par_Type defines the meaning of the
Configuration Parameters. It is set by the sender of the configuration frame.\
MSB.LSB:\ 0.0 Configuration Parameters not valid\ 0.1 local Configuration
Parameters\ 1.0 distant Configuration Parameters\ 1.1 optimal Configuration
Parameters
[**Codec_List** (13 bits)]{.underline}\ The supported Codec Types are coded as
defined in 3GPP TS 26.103, clause \"Codec Bitmap\", bit 1 to bit 13. Bit 13 is
defined to be the MSB of the Codec List field. For the mapping of these bits
on TRAU/TFO frames, see clause C.6.1.5 for AMR Configuration frames. This
field is not present in generic configuration frames.
**[Sys_ID]{.underline}** (4 bits)**\** The Sys_ID codes the
System_Identification of the sending side, see table Annex A.5-1. Only the
four LSBs are used here (short form) in AMR Configuration frames. The four
MSBs are assumed to be \"0\". In generic configuration frames this parameter
is coded with 8 bits.
[**Active_Codec_Type** (ACT: 4 bits)]{.underline}\ The Active_Codec_Type
identifies the Codec_Type actually used. The coding is according to 3GPP TS
26.103, table 6.3-1. The lower four bits are used here in AMR configuration
frames (short form). The long form is used in generic configuration frames.
**[Active_Codec_Set]{.underline}** (ACS: 8 bits see 3GPP TS 45.009 [9]):\ The
ACS is defined, if the Active_Codec_Type is from the AMR-NB family. The coding
is according to 3GPP TS 26.103.
**[Supported_Codec_Set]{.underline}** (SCS: 8 bits; see 3GPP TS 45.009 [9]):\
The SCS is defined, if the Active_Codec_Type is from the AMR-NB family.. The
coding is according to 3GPP TS 26.103.
[**Maximum Number of Modes in the ACS** (MACS: 3 bits)**\**]{.underline}The
MACS is defined, if the Active_Codec_Type is from the AMR-NB family. The
coding is according to 3GPP TS 26.103.
[**AMR TFO Version Number** (ATVN: 1 bit)\ ]{.underline}The current AMR TFO
Version Number is 0.
[**Optimisation Mode** (OM: 1 bit)\ ]{.underline}The Optimisation Mode is
defined, if the Active_Codec_Type is from the AMR-NB family. The coding is
according to 3GPP TS 26.103.
[**Optimal or Distant Configuration** (OD: 1 bit)\ The \"Optimal or Distant
Configuration\" parameter is described in clause C.5.2.2.]{.underline}
**[CRC_A]{.underline}** : 3-bit CRC (see clause 7.3).
**[CRC_B:]{.underline}** 3-bit CRC (see clause 7.3).
**[CRC_C:]{.underline}** 3-bit CRC (see clause 7.3).
### C.6.1.5 Mapping of the Configuration Parameters on 16 and 8 kbit/s
TRAU/TFO frames for AMR Configuration
AMR Configuration frames are defined for REL-4 and REL-5. In case generic
configuration frames shall be used (see clause 4.3) the AMR Configuration bits
in TFO/TRAU Speech and No_Speech Frames shall be set to spare = \"1\".
Table C.6.1.5-1 gives the mapping of the AMR configuration fields for each
frame (TRAU/TFO) format:
Table C.6.1.5-1: Mapping of the configuration parameters in the TRAU/TFO
frames
* * *
Sub-multiplexing 8 kbit/s 8 kbit/s 8 kbit/s 16 kbit/s 16 kbit/s 16 kbit/s
Codec Modes #bits No_Data SID Speech\ No_Speech Speech\ Speech\ ≤5,9 kbit/s
≤7,95 kbit/s 10,2kbit/s
**Time Align. Field** 6 D1..D6 D1..D6 # (= TFO_On) C6..C11 C6..C11 C6..C11
**Config_Prot** 3 D55..D57 D55..D57 D55..D57 C14..C16 C14..C16 C14..C16
**Message_No** 2 D58..D59 D58..D59 D58..D59 C17..C18 C17..C18 C17..C18
**TFO_Enable** 1 D64 D64 # (= 1) C20 C20 C20
**Par_Type^(5)^** 2 D65..D66 D65..D66 # (= 0.0) D1..D2 D1..D2 D1..D2
**OD** 1 D67 D67 # D3 D3 D3
**OM^(3)^** 1 D68 D68 # D4 D4 D4
**ACS^(3)\ 8 D69..D76 D69..D76 # D5..D12 D5..D12 D5..D12 ^(Optimal ACS)^(5)^**
**SCS^(3)^** 8 D77..D84 D77..D84 # D13..D20 D13..D20 D13..D20
**ATVN^(3),^ short^(6)^** 1 D85 D85 # D21 D21 # (= 0)
**Sys_ID, short^(6)^** 4 D86..D89 D86..D89 # D22..D25 D22..D25 # (= 0..0)
**spare (= 0)** 3 D90..D92 D90..D92 # D26..D28 D26..D28 # (= 0)
**CRC_A\ 3 D93..D95\ D93..D95\ # D29..D31\ D29..D31\ #^(1)^ (of 28 bits:)**
(D65..92) (D65..92) (D1..D28) (D1..D28)
**ACT^(3)^\ 4 D96..D99 D96..D99 # D234..D237 D234..D237 D234..D237 (Optimal
ACT)^(5)^**
**MACS^(3)^** 3 D100..D102 D100..D102 # D238..D240 D238..D240 D238..D240
**Codec List** 13 D103..D115 D103..D115 # D241..D253 D241..D253 D241..D253
**CRC_B\ 3 D116..D118\ D116..D118\ # D254..D256\ D254..D256\ #^(2)^ (of 20
bits:)** (D96..115) (D96..115) (D234..253) (D234..253)
**SCS_2^(4)^** 8 D17..D24 # (= 1..1) **^(7^** # D203..D210 D203..D210 # (=
1..1) **^(7)^**
**OM_2^(4)^** 1 D25 # (= 0) # D211 D211 # (= 0)
**MACS_2^(4)^** 3 D26..D28 # (= 1.0.0) # D212..D214 D212..D214 # (= 1.0.0)
**ATVN_2^(4)(6)^** 1 D29 # (= 0) # D215 D215 # (= 0)
**SCS_3^(4)^** 8 D30..D37 # (= 1..1) **^(7^** # D216..D223 D216..D223 # (=
1..1) **^(7)^**
**OM_3^(4)^** 1 D38 # (= 0) # D224 D224 # (= 0)
**MACS_3^(4)^** 3 D39..D41 # (= 1.0.0) # D225..D227 D225..D227 # (= 1.0.0)
**ATVN_3^(4)(6)^** 1 D42 # (= 0) # D228 D228 # (= 0)
**spare (=0)** 2 D43..D44 # # D229..D230 D229..D230 #
**CRC_C\ 3 D45..D47\ # # D231..D233\ D231..D233\ # (of 28 bits:)** (D17..44)
(D203..230) (D203..230)
8k_spare 7 D48..D54 # #
8k_spare 7 D119..D125 D119..D125 #
16k_spare 14 D44..D57 # #
* * *
The bit positions refer to the positions reserved in 3GPP TS 48.060 [3] and
3GPP TS 48.061 [4] : D bits are data bits, C bits are control bits. The
parameters are mapped into the field with MSB first, example:\ Par_Type: MSB
=> D65, LSB => D66 in 8k frames.
**#** denotes not existing fields; the entries in brackets () denote the
default values of the missing parameters, see Note**^(7)^**. Only if the
missing parameters are set to these default values, these frames may be used.
Otherwise No_Data frames shall be used.
**NOTE 1: In Mode 10,2 the bits D93..D95 are already used for the CRC1 of the
first sub-frame. The bits otherwise protected by CRC_A shall be protected in
Mode 10,2 by CRC1 (see 3GPP TS 48.060 [** 3**]).**
**NOTE 2: In Mode 10,2 the bits D254..D256 are already used for the CRC4 of
the fourth sub-frame. The bits otherwise protected by CRC_B shall be protected
in Mode 10,2 by CRC4 (see 3GPP TS 48.060 [** 3**]).**
**NOTE 3: The fields ACS, SCS,MACS, OM and ATVN shall always be used for the
Active Codec Type, if from the AMR family.**
**NOTE 4:** The fields SCS_2 ... ATVN_3 are reserved for the other AMR Codec
Types, when flagged in the Codec_List, according to the following mapping:
* * *
Active Codec Type ACS, SCS, OM, MACS, ATVN SCS_2, OM_2, MACS_2, ATVN_2 SCS_3,
OM_3,\ MACS_3, ATVN_3
**none of AMR** FR_AMR HR_AMR UMTS_AMR(_2)
**FR_AMR** FR_AMR HR_AMR UMTS_AMR(_2)
**HR_AMR** HR_AMR FR_AMR UMTS_AMR(_2)
**UMTS_AMR(_2) ^(8)^** UMTS_AMR(_2) FR_AMR HR_AMR
* * *
If a Codec Type is not within the Codec_List, then the corresponding fields
are undefined and shall be set to \"0\".
**NOTE 5: If Par_Type is set to \"Optimal Configuration\", then ACT and ACS
shall carry the optimal configuration. All other configuration parameters
shall carry the Codec List and the relevant configuration parameters.**
**NOTE 6: For Sys_ID and ATVN a short form is used: only lower 4 bits for
Sys_ID, only LSB for AVTN. The missing bits are defined to be \"0\".**
**NOTE 7: The default setting for the SCS fields shall be \"1111.1111\" for
FR_AMR and UMTS_AMR and \"0001.1111\" for HR_AMR.**
**NOTE 8: Either** UMTS_AMR or UMTS_AMR_2 shall be indicated, but not both
together, with preference to UMTS_AMR_2.
**Note for the AMR_TFO_8+8k frames:** Only the \"No_Data\" frames convey all
configuration parameters. Thus, a speech frame has to be stolen when this
configuration information has to be sent. The frames with a rate lower or
equal to 5,9 kbit/s can convey only the Config_Prot and Mess_No without
stealing a speech frame. Par_Type in these speech frames is assumed to be
\"0.0\".
**Note for the AMR_TFO_16k frames:** All the configuration parameters are
included in the rates below the 10,2 kbit/s. The 12,2 kbit/s conveys TFO
enable and the Config_Prot only. Par_Type in 12,2 kbit/s speech frames is
assumed to be \"0.0\". Thus a speech frame has to be stolen to send
configuration parameters.
## C.6.2 TFO and Handover Status of the Connection
### C.6.2.1 TFO Status Messages
The TRAU shall inform the BTS of its TFO status with three TFO Notifications:
_\- TFO_Off_ TFO is not established.
_\- TFO_Soon_ TFO is likely to be established.
_\- TFO_On_ TFO is established and ongoing.
The BTS may inform the TRAU and the distant partner with two Handover
Notifications
_\- Handover_Soon_ Handover is to be expected soon.
_\- Handover_Complete_ Handover has been performed.
### C.6.2.2 Notification of Status of Connection
The Messages \"_TFO_Soon_ \", \"_TFO_On_ \" and \"_TFO_Off_ \" are sent by the
Tx_TRAU within the Time Alignment Field.
The BTS shall acknowledge the correct receipt of TFO Notifications by sending
the received TFO Notification back to the TRAU. If the TRAU does not get a
correct acknowledgement within _N_out_1_ frames, then it shall repeat the TFO
Notification. _N_out_1_ shall be initialised at resource allocation to [4],
but shall be adapted to the round trip delay between TRAU and BTS during the
connection.
The Handover Notifications \"_Handover_Soon_ \" and \"_Handover_Complete_ \"
are sent by the BTS to the TRAU within the Time Alignment. Field, always
embedded in Con_Req() frames. Since Con_Req() frames shall always be
acknowledged, no further acknowledgement for the Handover Notifications is
required. If the BTS does not get a correct acknowledgement within _N_out_2_
frames, then it shall repeat the Handover Notification. _N_out_2_ is set to
[4]. It should be adapted according to the round-trip delay.
The Time Alignment Field is used for several purposes: TFO Notifications,
Handover Notifications, Time Alignment Request and Time Alignment
Acknowledgement. The TRAU and BTS may initiate requests independently and
uncoordinated. In case of conflicts the following priority shall be obeyed:
Time Alignment Message may always be overwritten. Otherwise: Acknowledgements
shall always have higher priorities than requests. With other words: an
ongoing exchange shall first be terminated before a new one is started.
In case of ongoing TFO all uplink TRAU frames shall be relayed with minimal
delay onto the A-interface as TFO frames. Likewise the received TFO frames
shall be relayed as TRAU frames down to the BTS. The time alignment field of
the TFO frames shall be copied, too.
# C.7 The Dialogue between TFO_BTS and TFO_BSC
This clause is valid for all Codec Types of the AMR-NB and AMR-WB families. If
BTS and TRAU exchange Configuration information, then they shall use the
meachnism defined here. From REL-5 onwards the generic configuration frames
[may]{.underline} also be used for all other codec types.
The BSC and the BTS exchange messages through Layer 3 signalling as specified
in **3GPP** TS 48.058 [12].
First, the BSC sends local configuration information to the BTS.
The BTS is also in contact with the TRAU and relays information received from
the BSC toward the TRAU within the AMR Configuration frames (REL-4) or in
generic configuration frames (REL-5 and onwards).
The BTS also extracts the configuration information sent downlink by the TRAU
or the distant BTS in the AMR Configuration frames (REL-4) or in generic
configuration frames (REL-5 and onwards).
Finally, the BTS relays this received configuration information back to the
BSC.
## C.7.1 BSC to BTS messages
The BSC at Channel activation informs the BTS of the local codec
configuration. It enables or disable TFO too. It can also delegate the ACS
modification to the BTS (MultiRate Control by RATSCCH).
The BSC can enable or disable TFO at any moment during a call whether TFO is
ongoing or not (TFO MODIFICATION REQUEST).
The BSC informs the BTS of any change of the local configuration, if the Codec
Type Mismatch resolution and/or AMR optimization is supported (MultiRate Codec
Mode Req).
The BSC should notify to the BTS when an handover procedure is about to be
launched (PRE-HANDOVer NOTIFication). It should also notify the BTS is the
handover procedure has failed (PRE-HANDOVer NOTIFication).
## C.7.2 BTS to BSC messages
The BTS should report to the BSC the status of the TFO, i.e. when TFO starts
and stops (TFO REPort).
The BTS should report the Round trip delay it has estimated (Round Trip Delay
REPort). It should report it every time a significant change (e.g. 60 ms) is
detected in the round trip delay (see clause 8.2.4).
The BTS should report to the BSC the distant codec configuration (REMOTE CODEC
CONFiguration REPort). It should also report any modification of this
configuration. It should report the optimal TFO configuration, if the Optimal
or Distant Configuration (OD) tells so (MultiRate Codec Mode Req).
# C.8 Configuration Parameter Exchange on Abis/Ater and A Interfaces for AMR
and AMR-WB
The TFO Speech Service Configuration parameters for TFO may be sent from the
BSC via the BTS to the TRAU;
The following block diagram is intended for guidance only. If no TFO is
ongoing, then the Config_Prot ends always in the (local) TRAU. If TFO is
ongoing, then a mirrored (distant) BSS´ exists. Between the local TRAU and the
distant TRAU´ an unknown transit network exists, which is transparent for the
TFO Messages and the TFO Frames, but may contain devices involved in the TFO
connection (e.g. TFO specific Circuit Multiplication Equipments, TCMEs, for
cost efficient transmission).
{width="5.844444444444444in" height="1.59375in"}
Figure C.8-1: Block diagram of the transmission paths for the exchange of
Configuration Parameter
The Configuration parameters received from the BSC (1) shall be sent uplink to
the TRAU by inband signalling on the Abis/Ater interface (6). In most
Codec_Modes the TRAU speech frames have sufficiently spare capacity to
transmit these configuration parameters. Otherwise a No_Speech frame (mainly a
No_Data Frame) shall be used, i.e. a speech frame shall be stolen. No_Data
Frames are naturally used at call setup or after handover. From REL-5 onwards
generic configuration frames are used, when both sides support this (see
clause 4.3).
## C.8.1 Protocol for the Exchange of Configuration Parameters
A simple protocol is defined to ensure correct receipt. It uses the
Config_Prot field to code a Request or Acknowledge message and the Message_No
field to bind Request and Acknowledgement together. Both are defined in
clauses C.6.1.2 and C.6.1.3.
The Par_Type field defines whether a Request or Acknowledgement has defined
configuration parameters or not, and which type of parameters are included:
None, Local, Distant or Optimal. If a Con_Req has no configuration parameters,
then the corresponding Con_Ack shall include the local ones. If Con_Req
contains new or modified distant Configuration parameters, then the
corresponding Con_Ack shall contain the local configuration parameters. If no
configuration is to be exchanged, then the Config_Prot field shall be set to
\"No_Con\". In this case the configuration parameter field is undefined. The
receiver shall not acknowledge a No_Con message.
The configuration exchange shall start always with a Request from one side and
shall end with an Acknowledgement from the other side. If the Acknowledgement
is not received before _N_Out_3_ frames are elapsed, then the Request shall be
repeated without modifying the Message_No. _N_Out_3_ is at resource allocation
initialised (e.g. _N_Out_3_ := 4), but shall be adapted to the round trip
delay during the connection (see clause C.4.5).
If more than three consecutive repetitions are without success, then TFO shall
be terminated and the TFO Protocol shall enter State FAILURE.
The sender of the Request shall always use a new Message_No, e.g. by
incrementing a counter, for a new Request. The receiver shall acknowledge by
sending the appropriate Acknowledge_Code and the received Message_No back, if
the Request was received without detectable errors. Otherwise, in case of
detected errors, it shall not acknowledge, but wait for a repetition.
Typically no new request shall be sent before the previous configuration
exchange is terminated. Exceptions exist at Resource Allocation, because it is
not clear if and when the path between BTS and TRAU is connected through.
## C.8.2 Initial Configuration at Resource Allocation
The BTS shall send \"Con_Req\" Messages. Typically at resource allocation no
speech is received from the air interface or at least some FACCH arrive.
Therefore \"No_Data\" frames may be used. Generic configuration frames are
used from REL-5 onwards. The local TRAU shall acknowledge with \"DL_Ack\".
As long as No_Speech frames are sent in uplink direction the BTS shall
increment the Message_No and send the configuration in every new frame, until
a DL_Ack is received, i.e. the TRAU is synchronized. The exchange is
considered as terminated, when the last sent Message_No is received back.
If, however, already speech frames are received in uplink direction from the
air interface before the TRAU is synchronized, then appropriate speech frames
shall be sent. If the configuration parameters can be included in these speech
frames (e.g. as for all Codec_Modes below 10,2 kbit/s in 16 kbit/s sub-
multiplexing), then the procedure is exactly as described for No_Speech
frames. If, however, the configuration parameters cannot be included, then
every 4^th^ speech frame shall be stolen on the Abis/Ater interface and be
replaced by a No_Speech (No_Data) frame (generic configuration frame) to
transmit the configuration.
## C.8.3 Distant Configuration before TFO is established
After call set-up the TRAU may try to establish a TFO connection by using the
TFO Protocol. During that time and before TFO is established the TRAU may get
already knowledge about the distant configuration, either by TFO_REQ or
TFO_Ack.
If distant and local configurations allow TFO (see Clauses 11 and 12 for the
TFO Decision algorithm) then the TRAU shall immediately send TFO_Soon with the
appropriate Rate Control to its local BTS. It may also include the partially
known distant configuration parameters by using Dis_Req together with
_TFO_Soon_.
Otherwise the distant configuration parameters shall be sent by using Dis_Req
together with TFO_Off, when the information required for Codec Type and/or
Configuration mismatch resolutions are available, either after TFO_REQ_L or
TFO_ACK_L.
Dis_Req shall be used by the TRAUin downlink to transmit the distant or the
optimal configuration parameters, when these have not been received by Con_Req
or Con_Ack from the distant side.
## C.8.4 Optimal TFO configuration
In TFO mode versions 5 and 6 (see C.2.4), the TFO Decision algorithm is only
run by the TRAU. In this case the TRAU does not send the distant configuration
to the BTS or the BSC, but the result of the TFO Decision algorithm, i.e. the
optimal Codec Type and the optimal configuration parameters.
As soon as the optimal TFO configuration is known (result of the TFO Decision
algorithm), the TRAU shall send it to the BTS by using Dis_Req.
## C.8.5 Configuration Exchange in TFO
If TFO is ongoing (state OPERATION: the BTS is informed about that by _TFO_On_
, see clause C.6.2) then the configuration sent by the BTS with Con_Req shall
be relayed through by the local TRAU and the distant TRAU´ down to the distant
BTS´. All devices in the path (TRAUs, but maybe also others, e.g. TCMEs) are
updated to the new configuration. The distant BTS´ shall acknowledge this by
Con_Ack. This message takes the same way back. The exchange shall be
considered terminated when the originating BTS received the Con_Ack.
NOTE: The round trip delay in TFO connections shall be considered.
In case of TFO with a non_AMR Codec Type of a release lower than REL-5 only
TFO_REQ_L and TFO_ACK_L messages can be used for exchange of TFO Configuration
data (mainly the Codec_List).
In case of TFO with an AMR or AMR-WB Codec Type the Config_Frames may be used
instead, because they are substantially faster in transmission and are exactly
traffic frame synchronised and they may come anyhow from the BTS within the
traffic flow. TFO_REQ_L messages with the same piece of information may be
transmitted as for non AMR Codec Types, but only one of these methods shall be
used, either Con_Req or TFO_REQ_L, not both in parallel. In case of
discrepancy between the Config_Frames and the TFO messages, the receiving side
decides which shall have precedence.\ In any case TFO_REQ_L must be
acknowledged by a TFO_ACK_L and a Con_Req by a Con_Ack. . In the (rare) case
that a TFO_ACK_L contains an embedded Con_Req frame, the parameters of the
TFO_ACK_L shall be ignored, because the Con_Req travels faster and contains
more recent configuration parameters.
## C.8.6 Handover_Complete Notification in TFO
A new BTS shall reset an internal \"Handover_Flag\", when it is activated for
a new call setup.\ A new BTS shall set this internal Handover_Flag, when it is
activated for a handover.
The new BTS shall send the \"Handover_Complete Notification\" within each
Con_Req in the uplink direction as long as the Handover_Flag is set. The
Handover_Flag shall be reset when receiving a Con_Ack from the distant side. A
DL_Ack from the local TRAU shall not reset the Handover_Flag.
After a local handover, there are two events that trigger the new BTS to enter
the TFO_YES State:
\- a TFO_On Message (Inter-BSC handover and call setup);
\- a Con_Ack Frame (Intra-BSC handover).
In the case of a local Inter-BSC handover a new TRAU is initialized. This new
TRAU starts the TFO protocol with Not_Active. The Con_Req(loc) (with the
Handover_Complete Notification) of the new BTS is acknowledged directly with a
DL_Ack(empty) by the local TRAU. This shall not reset the Handover_Flag within
the new BTS, but shall terminate the sending of the Con_Req(loc) in uplink.
Later, a TFO_On message from the new local TRAU will trigger the new BTS to
enter TFO_YES. In this case a Con_Req(loc) shall be sent to the distant side,
because the time delay is not measured yet. Since the Handover_Flag is still
set, the \"Handover_Complete Notification\" shall be included and the distant
side is informed that a handover has taken place and the time delay has to be
measured again. The distant BTS therefore shall send a Con_Ack(dis) to
acknowledge the Con_Req(loc) and then a Con_Req(dis) and wait for the
Con_Ack(loc) for delay determination.
In the case of a local Intra-BSC handover the TRAU typically doesn\'t change
and therefore doesn´t interrupt the ongoing TFO connection. It remains in
State Operation. Therefore no TFO_On message will be sent to the new local
BTS. In this case, the Con_Req(loc) (with the Handover_Complete Notification)
of the local BTS will not be acknowledged by the local TRAU, but directly with
a Con_Ack(dis) by the distant BTS. This Con_Ack(dis) allows to determine the
round trip delay on the local side, resets the Handover_Flag and triggers the
local BTS to enter TFO_YES. No further Con_Req(loc) has to be sent to the
distant side because the time delay was already measured. Since the distant
side has received the Handover_Complete Notification, it knows that the time
delay has to be measured again on its side. The distant BTS therefore shall
send a Con_Req(dis) and wait for the Con_Ack(loc) for delay determination.
# C.9 Location of the TFO Decision Algorithm
The TFO Decision Algorithm as described in clause 11 and 12 shall always be
located within the TRAU. Optionally it may in addition be located in the BTS
(for Codec Configuration Optimisation) and the BSC (for Codec Type and Codec
Configuration Optimisation).
## C.9.1 Immediate TFO Set-up
The TFO Decision Algorithm shall always be within the TRAU. This is important
and sufficient for Immediate TFO_Setup. It might be available also within the
BTS, but that is not essential.
The TRAU shall inform the BTS with TFO_Soon, that Immediate TFO is possible
(TFO_BTS into TFO_MAYBE).\ The TRAU shall inform the BTS with CMR =\ TFO-xyz.exe \
The program displays first of all a help text with examples how to use it:
=====================================================================
TFO Decision Algorithm; C-Reference for TS 28.062 Version x.y.z
for GSM_FR GSM_HR GSM_EFR
FR_AMR HR_AMR OHR_AMR UMTS_AMR_2 UMTS_AMR
FR_AMR-WB OFR_AMR-WB OHR_AMR-WB UMTS_AMR-WB
This TFO Decision Algorithm determines, if TFO can be established
and on which Configuration.
Several input formats are supported (l_=local and d_=distant):
l_Type Preferred_Configuration d_Type Preferred_Configuration
l_Type Preferred_Configuration d_Type ACS SCS MACS OM
l_Type ACS SCS MACS OM d_Type ACS SCS MACS OM
Preferred_Configuration: 0..15 for AMR and 0..5 for AMR-WB.
ACS and SCS: highest ... lowest mode; x: mode present, -: not present
MACS: 1..8; OM: n or y.
Please separate parameters by blanks or tabs. Valid examples are:
GSM_EFR 1 GSM_EFR 1
FR_AMR 12 HR_AMR 10
FR_AMR x--x-x-x xxxxxxxx 4 y HR_AMR ---x-x-x --xxxxxx 3 n
UMTS_AMR x------- xxxxxxxx 1 n UMTS_AMR_2 x------- xxxxxxxx 1 n
UMTS_AMR_2 1 HR_AMR ---x-x-x --xxxxxx 3 n
UMTS_AMR-WB 5 FR_AMR-WB 0
Your input, please; (e=exit h=help ;=comment):
This help text can be recalled at any time by typing: h\ at the
beginning of a new input line.
To terminate the program type: e\.
## E.1.1 Input and Output
The program reads from stdin and outputs to stdout, which are typically the
keyboard and the display.
These input and output can be redirected to text-file input and/or text-file
output at invocation time by typing (example):
DOS_Command_Prompt> TFO-xyz.exe **\ TFO-Out.txt \
Within a TFO-In.txt file each line starting with a single isolated \ is
treated as comment line and is ignored by the TFO Decision algorithm.
If an output text-file name is provided, then all input and output is listed
there in this output file for offline study. In that case only error messages
are displayed on screen.
For each combination of local and distant codec types the input parameters
must be specified in one input line.\ Codec Type and parameters must be
separated by blanks or tabs. Three different input formats are supported:
1) l_Type Preferred_Configuration d_Type Preferred_Configuration
2) l_Type Preferred_Configuration d_Type ACS SCS MACS OM
3) l_Type ACS SCS MACS OM d_Type ACS SCS MACS OM
The first input format is a combination of\ \- a local Codec Type (l_Type) and
its Preferred Configuration (short form) with\ \- a distant Codec Type
(d_Type) and its Preferred Combination (short form).\ This can be used for all
Codec Types: for the \"legacy\" single mode ones, for the AMR family and the
AMR-WB family.
Please note that for GSM_FR, GSM_HR and GSM_EFR one \"dummy\" parameter (equal
to \) must be provided.
The second input format allows combine\ \- a local Codec Type and its
Preferred Configuration (short form) with\ \- a distant AMR Codec Type and its
long from of AMR parameters.
The third input format allows the combination of two AMR Codec Types with long
form of AMR configuration parameters.
Note: the long form is only defined for AMR, not for AMR-WB.
The combination \ \- \ is not allowed in this program,
but this is not a severe restriction since the TFO Decision algorithm is
perfectly symmetrical.
Wrong or undefined input parameters are (to the largest extent) detected and
flagged in error messages.
Note: in a DOS command window You can use the arrow keys (up/down, right/left)
to recall the previous input lines and to correct the input.
Please find more and detailed explanations in the help text of the program
itself (reprinted above).
Many examples may be found in the attached text file \"TFO-Out.Txt\".
Some are reprinted here:
**Example 1:**
GSM_EFR 1 GSM_EFR 1
\---------------------------------------------------------------------
==> Immediate TFO
**Example 2:**
GSM_FR 1 GSM_HR 1
\---------------------------------------------------------------------
==> TFO is not possible
**Example 3:**
; Now a test for AMR with the most recommended Preferred Configuration 1
FR_AMR 1 HR_AMR 1
\---------------------------------------------------------------------
==> Immediate TFO on iACS; FR-HR Matching; no further optimisation
FR_AMR HR_AMR
MACS = 4 MACS = 3
OM = no OM = no
SCS ACS **iACS** oACS cSCS ACS SCS
12.2 x x - - - - -
10.2 - - - - - - -
7.95 - - - - - - -
7.40 x x **x** x x x x
6.70 - - - - - - -
5.90 x x **x** x x x x
5.15 - - - - - - -
4.75 x x **x** x x x x
**Example 4:**
; Now a test for AMR with the long input format.
; This is only defined for the AMR Family, not for AMR-WB.
; L_Type ACS SCS # OM D_Type ACS SCS # OM
FR_AMR x--x-x-x x--x-x-x 4 n FR_AMR x--x-x-x x--x-x-x 4 n
\---------------------------------------------------------------------
==> Immediate TFO on iACS; no further optimisation
FR_AMR FR_AMR
MACS = 4 MACS = 4
OM = no OM = no
SCS ACS iACS oACS cSCS ACS SCS
12.2 x x x x x x x
10.2 - - - - - - -
7.95 - - - - - - -
7.40 x x x x x x x
6.70 - - - - - - -
5.90 x x x x x x x
5.15 - - - - - - -
4.75 x x x x x x x
**Example 5:**
; An example of interworking of short form and long form.\ ; This specific
example is not recommendable: Please note that\ ; the result is
[not]{.underline} within the set of 16 Preferred Configurations.
FR_AMR 11 FR_AMR x--x---x xxxxxxxx 3 n
\---------------------------------------------------------------------
==> Immediate TFO on iACS, then Codec Mode Optimization to oACS.
FR_AMR FR_AMR
MACS = 4 MACS = 3
OM = yes OM = no
SCS ACS iACS **oACS** cSCS ACS SCS
12.2 x - - **x** x x x
10.2 x - - - x - x
7.95 x - - - x - x
7.40 x x - **x** x x x
6.70 x x - - x - x
5.90 x x - - x - x
5.15 - - - - - - x
4.75 x x x **x** x x x
**Example 6:**
FR_AMR-WB 0 OFR_AMR-WB 2
\---------------------------------------------------------------------
==> Immediate TFO - no Modification necessary
FR_AMR-WB OFR_AMR-WB
MACS = 3 MACS = 4
OM = no OM = no
SCS ACS iACS oACS cSCS ACS SCS
23.85 - - - - - - -
15.85 - - - - - x x
12.65 x x x x x x x
8.85 x x x x x x x
6.60 x x x x x x x
###### ## Annex F (informative): Operator\'s Guide
This clause presents guidelines, which should be followed by the operator to
optimise the establishment of TFO with AMR, and avoid unnecessary intra cell
hand-overs for configuration optimisation once TFO is established.
The guidelines can be classified into the following families :
\- Avoidance of Codec Type Optimisation;
\- Earliest possible TFO Establishment;
\- Usage of AMR tandem in preference of TFO with GSM_EFR, GSM_FR, or GSM_HR;
\- Balance between Speech Quality and Network Capacity.
The guidelines are most helpful inside one PLMN. They can be applied to inter-
PLMN constellations to extend their benefits. They may also be applied in
parts of a PLMN, which would of course lower their benefits.
# F.1 Avoidance of Codec Type Optimisation
Depending on the call configuration on both sides of the connection a Codec
Type Optimisation may follow after TFO has been established, because the full
list of supported Codec Types is only available then. For this Codec Type
Optimisation an intra-cell hand-over is required. In many call scenarios with
a TFO Connection with HR_AMR the resulting communication quality may be
sufficient. The benefits of a Codec Type Optimisation by an intra cell hand-
over may be not obvious, but the signalling load may be too costly.
Guideline 1:
If the operator wants to avoid any Codec Type Optimisation, then the supported
Codec List shall contain only one, the Active Codec Type.
# F.2 Earliest possible TFO Establishment
Since speech quality is improved by TFO, it is important to establish TFO as
soon as possible. This can be achieved by reducing / simplifying the TFO
negotiation.
This leads to two categories of guidelines:
1) Immediate TFO establishment without Codec Mode Optimisation (TFO is
established with the current ACS, or with a subset of this ACS).
2) Immediate TFO establishment with Codec Mode Optimisation (after TFO
establishment the ACS may be changed by a) Intra Cell Hand-over, b) Mode
Modify or c) RATSCCH).
## F.2.1 Avoidance of Codec Mode Optimisation
Guideline 2:
If the operator wants to avoid Codec Mode Optimisation after TFO establishment
with AMR, then he shall set the \"Optimisation Mode\" to \"No_Change\".
Guideline 3:
All operators should configure all AMR Codec Types, except UMTS_AMR, in their
networks with preferred configuration 1 (see Table 7.11.3.1.3-2, Config-NB-
code 1). For UMTS_AMR the ACS should include only mode 12,20 kbps. By these
configurations the chances for TFO/TrFO between systems (GSM-UMTS) and between
different PLNMs are substantially enhanced.
This configuration 1 fulfils automatically also Guidelines 2, 4 and 5.
Other ACSs for FR_AMR, UMTS_AMR, UMTS_AMR_2, OHR_AMR and HR_AMR are possible.
They should include as many as possible common Codec Modes in the lower,
contiguous subsets. Also for UMTS_AMR other ACSs are possible. In that case
Inter-PLNM TFO is not as obvious and may need other inter-operator agreements.
Guideline 4:
The operator should configure AMR so that the ACSs are homogeneous within the
whole PLMN (same ACS used in all BSS of a given PLMN for a given Codec Type:
UMTS_AMR_2, FR_AMR, OHR_AMR, HR_AMR). The ACSs of different Codec Types of the
AMR Family should contain as many as possible Codec Modes within the common,
lower, contiguous subset. Also UMTS_AMR should be configured homogeneous
within the whole PLMN, but since it is not compatible to the other AMR codec
types, another configuration is possible (see Guideline 3).
Guideline 5:
If the network is heterogeneous, the operator should choose ACSs so that all
resulting Common ACSs are acceptable (see clause 12), with as many as possible
Codec Modes within the common, lower, contiguous subset.
Guideline 6:
If for AMR-WB an optimisation shall be restricted to certain configurations,
this can be acchieved by choosing a suitable configuration with OM=F(orbidden)
in a combination with Maximum Rate Control.\ Example: If configuration 4 and 5
shall not be possible, then configuration 2 shall be indicated. Then the
effective ACS A and B (see Table 12.8-1) are possible, but not ACS C.
## F.2.2 Immediate TFO establishment with Codec Mode Optimisation
Guideline 6:
The operator should choose the ACSs in a way that all resulting immediate
Common ACSs are acceptable and CACSs are subsets of Optimised ACSs (see clause
12).
Then TFO will most of the times establish immediately (with the obvious
benefits in speech quality) and the Codec Mode Optimisation may be achieved
with Mode Modify or RATSCCH, i.e. without the problematic Intra-Cell hand-
over.
Remark: This guideline is not easy to fulfil since it is of course in general
not possible to foresee all possible ACS constellations, especially not for
inter-PLMN calls.
# F.3 Usage of AMR Tandem compared to TFO with GSM_EFR, GSM_FR, or GSM_HR
Guideline 7:
If an AMR is the Active Codec Type and the operator prefers a tandeming
connection with this AMR Codec on one side to a tandem free connection with
GSM_EFR, GSM_FR or GSM_HR, then he should not include GSM_EFR, GSM_FR or
GSM_HR within the supported Codec list.
Reason: The TFO algorithm will always try to establish TFO with the best
available **common** Codec Type, which could be GSM_EFR, GSM_FR or GSM_HR. But
often a Tandem Connection including one AMR Codec Type may be preferable in
terms of speech quality.
# F.4 Balance between Speech Quality and Network Capacity
The preference order for the Codec Type Optimisation and Codec Mismatch
Resolution is based on speech quality and does not take into account the load
in the network.
Guideline 8:
In capacity limited networks, the operator should only include Codec Types
using half rate channels in the supported Codec List (GSM_HR, HR_AMR).
###### ## Annex G (informative): Call flows for AMR TFO
Some example TFO protocol flows are shown for GSM (2G: left side) and UMTS
(3G: right side) for a GSM-UMTS (2G-3G) TFO call. Other scenarios, like for
GSM-GSM or UMTS-UMTS TFO calls can be derived by mirroring the relevant side.
In cases where this is not directly obvious the other side is shown, too.
Configuration Frames (Con_Req, Con_Ack, etc) exist in GSM between BTS and TRAU
(Abis Interface) as well as between TRAU and TRAU (the TFO Interface). They
are used for delay measurements and for fast exchange of configuration
parameters.
These Configuration Frames exist in UMTS between TC and TC or TC and TRAU (the
TFO interface), but not on the Iu Interface. Instead the TFO Configuration is
exchanged between SMSC and TC directly, e.g. via H.248 protocol. Optionally a
proprietary interface between BSC and TRAU may also be used in GSM. In that
case the Configuration Frames on the BTS-TRAU interface may be irrelevant.
The example in G.4 shows the version where the complete distant configuration
is sent down to the BTS and further on to the BSC. In another version, G.5,
only the Optimal Codec Type and Configuration is sent down to the BTS and BSC.
The protocol flows on the TFO interface (TRAU-TRAU, TRAU-TC, TC-TC) is in all
cases identical.
[Notations:]{.underline}
The TFO_Protocol States and the States of TFO_BTS are marked in yellow. The
messages are shown as they appear on the interfaces, i.e. [after]{.underline}
the TFO_Protocol has already entered the new State.
The colours of the TFO Messages and Comments have no further meaning than
highlighting the important parts and indicating what belongs together.
Some of the closed boxes contain comments or global descriptions of the
ongoing procedures.
The TFO_Messages require a relatively long transmission time, up to several
hundreds of milliseconds. These transmission times are not reflected within
these call flow charts. But please consider that some sequences that appear in
chronological sequence within the charts are in practise occurring in parallel
and are overlapping in time.
The left side in the flow charts is arbitrarily called \"local\" side and is
show as GSM, while the right side is called \"distant\" and is mainly shown as
UMTS. But that is in most scenarios not relevant and the opposite is as true.
The hand-over is per definition on the local side, just to simplify the
discussion.
The mapping of the messages shown in the flow charts to the BTS-BSC messages
is:
TFO_Report (Distant Configuration) is \"RemoteCodecConfigurationReport
(Distant Parameters)\"
TFO_Report (Optimal Configuration) is \"MultiRateCodecModeReq (Optimal
Parameters)\"
TFO_Report (Delay) is \"RoundTripDelayReport (delay)\"
TFO_Report (Status) is \"TFO_Report (Status)\"
ChannelActivation () is \"ChannelActivation (Configuration,
Handover_Indication)\"
# G.1 Typical Initialisation for TRAU, TC and TFO Protocol
The following protocol flows show schematically the typical Initialisation of
the TRAU, the TC and the TFO Protocol.
{width="6.020833333333333in" height="3.9791666666666665in"}
Figure G.1-1: Typical Initialisation of the TRAU, the TC and the TFO Protocol
# G.2 Re-Initialisation during the Call after TFO_Disable
Sometimes the TFO Protocol is re-initialised during the ongoing call, e.g.
after a TFO_Disable.
{width="6.020833333333333in" height="2.9583333333333335in"}
Figure G.2-1: Re-Initialisation during the Call after TFO_Disable
# G.3 TFO_Disable during Operation
## G.3.1 TFO_Disable -- passive partner: UMTS
The following protocol flow shows TFO_Disable, where UMTS is the passive
partner.
Figure G.3.1-1: TFO_Disable during operation -- passive partner: UMTS
## G.3.2 TFO_Disable -- passive partner: GSM
The following protocol flow shows TFO Disable, where GSM is the passive
partner.
Figure G.3.2-1: TFO_Disable during operation -- passive partner: GSM
# G.4 Immediate TFO establishment for AMR
## G.4.1 Con_Req / Con_Ack used on the TFO Interface
The following protocol flow shows the example where immediate TFO setup is
possible, either because both sides use identical Codec Types and
Configurations, or because the Codec Types and/or Configurations are
compatible in the \"lower, contiguous subset\". In the latter case potentially
an optimisation phase might follow after TFO has been set up.
{width="6.020833333333333in" height="7.84375in"}
Figure G.4.1-1: Immediate TFO establishment for AMR with Con_Req / Con_Ack
NOTE: The round trip delay is important for the GSM side for optimal Link
Adaptation. It should be as precise as possible and therefore the RNC on the
distant side is taken into consideration, but not the Node B or the UE,
because that would be too complicated. The round trip delay is not important
on the UMTS side, since this radio channel is more stable due to fast power
control.
## G.4.2 TFO_REQ_L / TFO_ACK_L used on the TFO Interface
The following protocol flow shows the same example as above. This version
shows the option with TFO_REQ_L / TFO_ACK_L instead of Con_Req / Con_Ack on
the TFO Interface. Please note that these TFO Messages take about 300ms for
transmission, while Con_Req / Con_Ack need about 20ms.\ In addition this
example shows how the Optimal Configuration is reported to the BSC / MSC.
{width="6.020833333333333in" height="7.84375in"}
Figure G.4.2-1: Immediate TFO establishment for AMR with TFO_REQ_L / TFO_ACK_L
NOTE: The round trip delay measurement could be done without Config parameters
(Par_Type = 00).
# G.5 Configuration Optimisation
The following protocol flow shows the example where only the local side needs
to change its AMR Configuration (the ACS) to the optimal configuration, while
the distant side has this optimal configuration already (shown here), or does
not need or want to change. Typically this optimisation takes place
immediately after TFO setup and is triggered by the TFO Report to the BSC or
the TFO Report to the SMSC.
{width="6.020833333333333in" height="3.6875in"}
Figure G.5-1: Configuration Optimisation
# G.6 AMR TFO: Mismatch Case
The following protocol flow shows the example where the Codec Types or Codec
Configurations do not match and where an immediate TFO is not possible.
Potentially a mismatch resolution is following, in which case a second TFO
establishment is attempted (indicated in dashed lines for local side).\ In
this example the TRAU reports the Optimal Configuration to the BTS and to the
BSC.
{width="6.020833333333333in" height="4.875in"}
Figure G.6-1: AMR TFO Mismatch Case
# G.7 Intra BSC TFO Handover (TRAU remains)
## G.7.1 TRAU-TC TFO connection
The following protocol flow shows a local handover in a TRAU-TC TFO
connection, where the local TRAU remains the same. The distant TC sees
potentially some phase alignment of the TFO Frames, but no interruption of the
TFO Operation. The Round Trip Delay is not important for TC and RNC and is
therefore not measured. The local BTS estimates the round trip delay when it
receives the first Con_Ack.
{width="6.1875in" height="4.479166666666667in"}
Figure G.7.1-1: Intra BSC TFO Handover - TRAU-TC TFO connection
## G.7.2 TRAU-TRAU TFO connection
The following protocol flow re-shows the lower part of a local handover in a
TRAU-TRAU TFO connection, where the local TRAU remains the same. The Round
Trip Delay is important for both BTSs and therefore the Handover_Complete
Message triggers a new delay measurement within the distant BTS.
{width="6.645833333333333in" height="2.8958333333333335in"}
Figure G.7.2-1: Intra BSC TFO Handover - TRAU-TRAU TFO connection
# G.8 Inter BSC TFO Handover (TRAU changes)
The following protocol flow shows a hard local handover in TFO, where the
local TRAU changes. New BTS and new TRAU are synchronised and working before
the handover takes place. On the TFO Interface the fast handover handling is
applied. The handling of the Handover_Complete Message on the distant side is
as described for the Intra BSC handover (not shown here again).
{width="6.354166666666667in" height="6.072916666666667in"}
Figure G.8-1: Inter BSC TFO Handover (TRAU changes)
# G.9 Immediate Codec Type Optimization
The following protocol flow shows an example for Immediate Codec Type
Optimation. Both sides start with AMR-NB, but indicate that AMR-WB is also
supported. In this case no immediate TFO Setup in AMR-NB is performed because
both sides can use better Codec Types and Configurations. No additional
optimisation phase is necessary after AMR-WB TFO Setup.
Figure G.9-1: Immediate Codec Type Optimisation for AMR-WB with AMR-NB at call
setup
Note: The TFO protocol is kept in the Contact state on both sides as long as
contact to the distant side exists and the configurations (local and distant)
indicate that TFO setup is possible with a preferred configuration (in this
case AMR-WB). The numbers indicate the event number as listed in Table 10.4-1.
###### ## Annex H (normative): Definition of the Generic Configuration Frames
for TFO
# H.1 Scope
Annex H describes the Generic Configuration Frames for TFO. They may be used
on the A-Interface and on the Abis/Ater-Interface for all Codec Types.
They are designed to carry the same information as the TFO_REQ_L (TFO_ACK_L)
Messages, see section 7.
These Generic Configuration Frames are based on the design of the Codec List
as layed down in TS 26.103.
# H.2 Structure for Generic Configuration Frames
## H.2.1 Frame Structure for 8 kBit/s sub-multiplexing
The frame structure is defined in TS 48.061 REL-5 and is reprinted here for
ease of use.
* * *
             TRAU8k / TFO8k Generic Configuration Frame\                                                       
             Bit number
Octet no 1 2 3 4 5 6 7 8
1 0 0 0 0 0 0 0 0
2 1 C1 = 1 C2 = 1 C3 = 1 C4 = 1 C5 =\ D1 D2 EMBED
3 0 1 D3 D4 D5 D6 D7 D8
4 1 D15
5 1 D22
6 1 D29
7 1 D36
8 1 D43
9 1 D50
10 1 D57
11 1 D64
12 1 D71
13 1 D78
14 1 D85
15 1 D92
16 1 D99
17 1 D106
18 1 D113
19 1 D120
20 1 D121 D122 D123 D124 **D125** T1 T2
* * *
## H.2.2 Frame Structure for 16 kBit/s sub-multiplexing
The frame structure is defined in TS 48.060 REL-5 and is reprinted here for
ease of use.
* * *
              **TRAU16k / TFO16k Generic Configuration Frame**\                                                      
              Bit number
Octet no. 1 2 3 4 5 6 7 8
0 0 0 0 0 0 0 0 0
1 0 0 0 0 0 0 0 0
2 1 C1 = 1 C 2= 1 C3 = 1 C4 = 1 C5=\ D1 D2 EMBED
3 D3 D4 D5 D6 D7 D8 D9 D10
4 1
5 D25
6 1
7 D40
8 1
9 D55
10 1
11 D70
12 1
13 D85
14 1
15 D100
16 1
17 D115
18 1
19 D130
20 1
21 D145
22 1
23 D160
24 1
25 D175
26 1
27 D190
28 1
29 D205
30 1
31 D220
32 1
33 D235
34 1
35 D250
36 1
37 D265
38 1 D272
39 D273 D274 D275 **D276** T1 T2 T3 T4
* * *
# H.3 Coding of Generic Configuration Frames
The coding of Generic Configuration Frames in 8 kBit/s and 16 kBit/s sub-
multiplexing follow exactly the same rules. The only difference is that 8k
frames carry less configurations bits and may need an extension frames
earlier.
## H.3.1 Generic Configuration Frame Administration Section
### H.3.1.1 Extendability
The first bits of each Generic Configuration Frame is reserved for the
configuration frame administration.
**FOLLOW** : D1, 1 bit.\ If FOLLOW is set to \"0\", then this is the first
Generic configuration frame, if FOLLOW is set to\"1\", then this is a second
or further Generic configuration frame.
**EXTEND** : D2, 1 bit.\ If EXTEND is set to \"0\", then no further Generic
configuration frame is following, if EXTEND is set to \"1\", then an
additional Generic configuration frame will follow. This next Generic
configuration frame may follow immediately, or with a maximum distance of 3
frames in between to allow \"house-keeping\" for the active codec type.
Then follows a [sub-selector]{.underline} field that allows future extension
to the Generic Configuration Frame design.
**CON_SEL** : D3..D5, 3 bits\ Coding: D3.D4.D5 = 0.0.0:
**TFO_Configuration_Frame** , all other codes are reserved.\ A receiver that
does not understand a (for it) reserved code shall ignore the whole
configuration frame.\ Note: A potential application in future could be the
introduction of a DTMF_Frame.
### H.3.1.2 Version Handling
A field for a Version.Subversion is following:\ **Ver.Sver** :
D6..D9.D10..D13, 4+4 bits;
Example for Coding: 0101.0001 is used to code \"REL 5.1.x\".\ Details for
handling of the version in the TFO procedures are defined in clause 4.3.
### H.3.1.3 Configuration Exchange Protocol
Then the next part of each Generic Configuration Frame shall contain the
[protocol related parameters]{.underline}:\ **Config_Prot** : D14..D16, 3
bits\ **Mess_No** : D17.D18, 2 bits\ **ParType** : D19.D20, 2 bits\ The
definitions are given in Annex C.
### H.3.1.4 System Identification, TFO and DTX control
System Identification (Sys_ID), DTXd, TFOE and OD are included in Generic
Configuration Frames:\ **Sys_ID:** D21..D28, 8 bits (see TS 26.103 and Annex
A.5).\ **DTXd:** D29, 1 bit\ **TFOE:** D30, 1 bit\ **OD:** D31, 1 bit
### H.3.1.5 Specific Section for the Active Codec Type
Now follows a [specific section for the Active Codec Type]{.underline}
(==Local Used Codec). This section has a flexible design to allow future
adaptations. It carries signals that are important for the real-time operation
of the active codec type.
**Active_Codec_Type:** D32..D39, 8 bits**\ ACT_Specific_Length:** D40..D42, 3
bits.\ **ACT_Specific_Extend:** D43, 1 bit.\ ACT_Specific_Length defines the
length of the proprietary section in multiples of 8 bits (octets).\
ACT_Specific_Extend specifies an extension of this, in case these 56 bits are
not sufficient. If ACT_Specific_Extend is set to \"0\", then no additional
proprietary section follows. If ACT_Specific_Extend is set to \"1\" then after
the first proprietary section again a second ACT_Specific_Length and
ACT_Specific _Extend Field are following, and so on.
#### H.3.1.5.1 Specific Section for GSM_FR, GSM_HR, GSM_EFR
If the Active Codec Type is either GSM_FR or GSM_HR or GSM_EFR, then the
parameters are set to:
ACT_Specific_Length := 0.0.0 (no byte is following)\ ACT_Specific_Extend := 0
(no further extension).
#### H.3.1.5.2 Specific Section for the AMR Narrow Band Family
If the Active Codec Type is either FR_AMR, HR_AMR, UMTS_AMR, UMTS_AMR2 or
OHR_AMR,\ then the parameters are set to:
ACT_Specific_Length := 0.0.1 (one byte is following)\ ACT_Specific_Extend := 0
(no further extension),
and the following parameters are defined in addition:\ RIF: D44, 1 bit,
Request or Indication Flag, as defined in TS 48.060.\ CMI_abs: D45..D47, 3
bits, Codec Mode Indication, as defined in TS 48.060.\ CMR_abs: D48..D50, 3
bits, Codec Mode Request, as defined in TS 48.060.\ spare: D51, 1 bit,
reserved for future use, set to \"0\".
#### H.3.1.5.3 Specific Section for the AMR Wide Band Family
If the Active Codec Type is either FR_AMR-WB, UMTS_AMR-WB, OFR_AMR-WB or
OHR_AMR-WB,\ then the parameters are set to:
ACT_Specific_Length := 0.0.1 (one byte is following)\ ACT_Specific_Extend := 0
(no further extension),
and the following parameters are defined in addition:\ RIF: D44, 1 bit,
Request or Indication Flag, as defined in TS 48.060.\ CMI_abs: D45..D47, 3
bits, Codec Mode Indication, as defined in TS 48.060.\ CMR_abs: D48..D50, 3
bits, Codec Mode Request, as defined in TS 48.060.\ spare: D51, 1 bit,
reserved for future use, set to \"0\".
### H.3.1.6 Spare Bits
If bits remain after the last used configuration parameters, see H.3.2, then
these bits shall be filled with \"0\" (spare code in Generic Configuration
Frames).
### H.3.1.6a TFO and Handover_Notifications Bits
The last field in the first Generic Configuration Frame before CRC is
dedicated to TFO and Handover_Notifications:
TFO_HO_NOTIF8k: D115 to D117 in TRAU8k / TFO8k frames and\ TFO_HO_NOTIF16k:
D266 to D268 in TRAU16k / TFO16k frames.
See Table 5.2.2.1-2, bits c9 to c11 for detailed coding.
If more than one Generic Configuration Frame is necessary for the whole
message, then only the first Generic Configuration Frame shall contain these
TFO and Handover_Notification bits.
If a Generic Configuration Frame uses the code \"Handover_Soon\", then the
Configuration Parameter Section (H.3.2) is dedicated to the situation after
the announced handover.
### H.3.1.7 Error Detection and Error Handling
A Generic Configuration Frame contains important information and is protected
by an 8-bit-CRC including C1..C5, all data bits and all spare bits.
The 8-bit-CRC parity bits shall be placed at a fixed position at the very end
of the Generic Configuration Frame:\ **CRC8k:** D118 to D125 in TRAU8k / TFO8k
frames and\ **CRC16k:** D269 to D276 in TRAU16k / TFO16k frames.
These 8 parity bits are in both cases generated by the cyclic generator
polynomial:\ _g(D) = D8 + D4 + D3 + D2 + 1._ \ The encoding is performed in a
systematic form, which means that, in GF(2), the polynomial:
\- b(1)D^(N+8-1)^ + b(2)D^(N+8-2)^ +...+b(N)D^8^ + p(1)D^7^ + p(2)D^6^ +...+
p(7)D^1^ + p(8);
\- p(1) ‑ p(8): the parity bits (D118 - D125 or the parity bits (D269 - D276);
\- b(1) ‑ b(N): the data bits (C1- C5, D1-D117) or the data bits (C1- C5, D1
-- D268);
when divided by _g(D),_ yields a remainder equal to 0.
A Generic Configuration Frame with CRC-error shall be regarded as invalid and
shall be ignored, i.e. its parameters shall not be used and it shall not be
acknowledged. A TRAU passing these Generic Configuration Frames from the Abis
interface to the A interface or vice versa shall not correct the CRC, if
errors are detected.\ If the TRAU has to recalculate the CRC and it detects at
the end that the incoming CRC indicated a transmission error, then the TRAU
shall deliberately invert the newly calculated CRC before sending it along.
## H.3.2 Configuration Parameter Section
The Configuration Parameter section fits between the ACT specific section and
the TFO and Handover_Notification field. If not enough space is left there,
then another Generic Configuration Frame shall be used for the remaining
parameter bits. These remaining bits shall be placed in the next
Configuratioin Frame starting after the ACT specific section, and so on.
### H.3.2.1 Mapping for Single Codec Type
An exactly defined **Mapping between TS 26.103 and TFO_Configuration_Frames**
exists.\ This is defined as follows:
The \"Single_Codec\" identifier as defined in TS 26.103 is omitted.
The \"Length_Indicator\" is shortened to 3 bits and an \"Extension_Indicator\"
is introduced in addition.\ That allows directly up to 7 octets for parameters
per Codec Type. If this is not sufficient (potentially in future cases), then
the \"Extension_Indicator\" is set to \"1\" and then a Length_Indicator and
Extension_Indicator is again following with again a parameter field of up to 7
octets for the remaining configuration parameters, and so on.\ The
Length_Indicator counts all octets after the OID_Indicator.
The \"Compatibility Information\" is omitted, when not necessary. This is
indicated by a single bit (\"Compatibility_Information_Indicator\") that is
set to \"0\" normally and to \"1\" if the Compatibility_Information octet is
present.
The \"Organisation IDentifier\" (OID) is omitted, when not necessary. This is
indicated by a single bit (\"OID_Indicator\") that is set to \"0\" normally
and to \"1\", if the OID octet is present.
When the OID is omitted then OID==\"ETSI\" shall be assumed.
The \"CoID\" (Codec Type Identifier) is exactly copied (8 bits).
The configuration parameters are exactly copied as specified in TS 26.103, MSB
first.\ Note: in that light the definition for AMR-WB is cumbersome, because
it is somewhat \"octet-hungry\".
Table H.3.2-1 summarises the design for the example \"FR AMR\" as one Codec
Type in the Codec List.
Table H.3.2-1 Design of the Codec Type Configuration for the example FR AMR
* * *
Name TS 26.103 TS 28.062 Comment Single_Codec_Indicator 8 bits 0 bits omitted
in TS 28.062 Length_Indicator 8 bits 3 bits \"1.0.0\" (4 octets following
after the [Organisation_Identifier_Indicator]{.underline}) Extension_Indicator
- 1 bits \"0\" no further Extension necessary
Compatibility_Information_Indicator - 1 bit \"0\" Compatibility_Information is
omitted Organisation_Identifier_Indicator 1 bit 1 bit \"0\"
Organisation_Identifier is omitted Compatibility_Information 8 bits 0 bits
omitted, when not indicated Organisation_Identifier 8 bits 0 bits omitted,
when not indicated Codec_Type_Identifier 8 bits 8 bits \"FR_AMR_CoID\" ACS 8
bits 8 bits 0.1.0.0.1.1.0.1 (e.g.) SCS 8 bits 8 bits 1.1.1.1.1.1.1.1 (can be
omitted) OM, MACS 8 bits 8 bits 0.0.0.0.0.0.0.0 (can be omitted)
* * *
For the example \"AMR with all configuration parameters present\" the coding
in TS 26.103 takes 8*8=64 bits, while the coding in the Configuration frame
takes 6+8+3*8=38 bits, with de facto identical contents. In the case of full\
support (i.e. SCS and OM, MACS omitted) the relation is 48 bits to 22 bits.
### H.3.2.2 Codec List
If more Codec Types are present in the Codec List, then they shall follow one
by one, each one coded as specified in H3.2.1 above.
The Codec Types shall be ordered according to their preference.
Per default the most preferred Codec Type shall be the first in the list (as
in TS 26.103). Then Par_Type shall be set to \"0.1\" (local configuration
parameters) or \"1.0\" (distant configuration parameters).
The first Codec Type in the Codec_List shall be the optimal Codec Type, when
sent by the TRAU downlink with Par_Type set to \"1.1\".
#
# Foreword
This Technical Report has been produced by the 3rd Generation Partnership
Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# 1 Scope
The present document studies forward compatibility for 3GPP Charging
Applications over Rf and Ro Reference Points, specified by using IETF Diameter
protocol.
In particular, it is investigated how to conform with TR 29.819 [413]
conclusion on Diameter extensibility rules, per following clause 5.3.1.4
statement:
_\"For 3GPP Diameter Accounting application using the Diameter Base Protocol
Accounting (application Id =3), such as specified in the 3GPP TS 32.299 [16],
further studies are required to evaluate how AVPs can be added to existing
commands with the M-bit cleared to avoid backward compatible issues. \"_
This document is independent of whether IETF RFC 3588 [401] or IETF RFC 6733
[412] is referred to as the Diameter Base protocol for Rf and Ro. Update from
IETF RFC 3588 [401] to IETF RFC 6733 [412] can be decided prior to any
conclusion from this study.
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or nonâ€‘specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
[1] 3GPP TS 32.240: \"Telecommunication management; Charging management;
Charging architecture and principles\".
[2] - [10] Void.
[11] 3GPP TS 32.251: \"Telecommunication management; Charging management;
Packet Switched (PS) domain charging\".
[12] Void.
[13] 3GPP TS 32.253: \"Telecommunication management; Charging management;
Control Plane (CP) data transfer domain charging\".
[14] - [19] Void.
[20] 3GPP TS 32.260: \"Telecommunication management; Charging management; IP
Multimedia Subsystem (IMS) charging\".
[21] - [29] Void.
[30] 3GPP TS 32.270: \"Telecommunication management; Charging management;
Multimedia Messaging Service (MMS) charging\".
[31] 3GPP TS 32.271: \"Telecommunication management; Charging management;
Location Services (LCS) charging\".
[32] 3GPP TS 32.272: \"Telecommunication management; Charging management;
Push-to-talk over Cellular (PoC) charging\".
[33] 3GPP TS 32.273: \"Telecommunication management; Charging management;
Multimedia Broadcast and Multicast Service (MBMS) charging\".
[34] 3GPP TS 32.274: \"Telecommunication management; Charging management;
Short Message Service (SMS) charging\".
[35] 3GPP TS 32.275: \"Telecommunication management; Charging management;
MultiMedia Telephony (MMTel) charging\".
[36] 3GPP TS 32.276: \"Telecommunication management; Charging management;
Voice Call Service Charging\".
[37] 3GPP TS 32.277: \"Telecommunication management; Charging management;
Proximity-based Services (ProSe) Charging\".
[38] 3GPP TS 32.278: \"Telecommunication management; Charging management;
Monitoring Event charging\".
[39] Void.
[40] 3GPP TS 32.280: \"Telecommunication management; Charging management;
Advice of Charge (AoC) service\".
[41] 3GPP TS 32.281: \"Telecommunication management; Charging management;
Announcement service\".
[42] - [49] Void.
[50] 3GPP TS 32.299: \"Telecommunication management; Charging management;
Diameter charging application\".
[51- [52] Void.
[53] 3GPP TS 32.296: \"Telecommunication management; Charging management;
Online Charging System (OCS) applications and interfaces\".
[54 - 55] Void.
[56] 3GPP TS 32.293: \"Telecommunication management; Charging management;
Proxy Function\".
[57] - [99] Void.
[100] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[101] 3GPP TS 22.115: \"Service aspects; Charging and billing\".
[102-199] Void.
[200-203] Void.
[204] 3GPP TS 29.229: \"Cx and Dx Interfaces based on the Diameter protocol;
Protocol Details\".
[205] 3GPP TS 29.230: \"Diameter applications;3GPP specific codes and
identifiers\".
[206-299] Void.
[300-399] Void.
[400] Void.
[401] IETF RFC 3588 (2003): \"Diameter Base Protocol\".
[402] IETF RFC 4006 (2005): \"Diameter Credit-Control Application\".
[403] - [411] Void.
[412] IETF RFC 6733: \"Diameter Base Protocol\".
[413] 3GPP TR 29.819: \"Study on Impacts of the Diameter Base Protocol
Specification Update\".
# 3 Definitions, symbols and abbreviations
## 3.1 Definitions
For the purposes of the present document, the terms and definitions given in
3GPP TR 21.905 [100] and the following apply. A term defined in the present
document takes precedence over the definition of the same term, if any, in
3GPP TR 21.905 [100].
## 3.2 Symbols
For the purposes of the present document, the following symbols apply:
Gy Online charging reference point between a PCEF and an OCS.
Gyn Online charging reference point between a TDF and an OCS.
Gz Offline charging reference point between a PCEF and an OFCS.
Gzn Offline charging reference point between a TDF and an OFCS.
Rf Offline charging reference point between a 3G network element and the CDF.
Ro Online charging reference point between a 3G network element and the OCS.
## 3.3 Abbreviations
For the purposes of the present document, the abbreviations given in 3GPP TR
21.905 [100] and the following apply.\ An abbreviation defined in the present
document takes precedence over the definition of the same abbreviation, if
any, in 3GPP TR 21.905 [100].
AVP Attribute Value Pair
DCCA Diameter Credit-Control Application
IE Information Element
# 4 3GPP charging applications forward compatibility
## 4.1 3GPP charging applications and mandatory concept
### 4.1.1 High level charging requirements
In TS 22.115 [101], the high level principles for the charging requirements
are stated as \"_It shall be possible to charge...\"_ identifying the required
criteria to be considered. The charging mechanisms have therefore been
specified to mandate necessary information (matching the criteria) to be
available in CDRs (offline charging) and OCS (online charging), for complying
with these requirements.
As part of the mechanisms, category has been defined, and it is further
detailed how this category concept applies within the whole charging
framework, focusing on Rf/Ro Reference Points as they use the IETF Diameter
protocol.
One of the key assumption is: CDF and OCS addresses allocation mechanisms are
kept unchanged, therefore CDF and OCS addresses which are allocated to the UE
for the transaction (IMS session, IP-CAN session, SMS...) cannot be changed
during this transaction.
### 4.1.2 Charging TSs structure
How Charging TSs are organized (the complete structure is defined in TS 32.240
[1]), is essential to interpret the category for an information, and it is
summarized below:
A set of domain/subsystem/service specific charging stage 2 TSs (referred to
as the middle tier charging TSs) covers:
\- the bearer (CS, PS, CP Data Transfer domains) level in the TS 32.25x;
\- the subsystem (IMS) level in the TS 32.26x;
\- the service (MMS, LCS, PoC, MBMS, SMS, MMTel, ProSe, Monitoring Event,
etc.) levels, in the TS 32.27x;
\- common services (Advice of Charge, Announcement) in the TS 32.28x.
The TSs 32.29x range stage 3 cover common aspects, one of those is the TS
32.299 [50], which specifies the Diameter based 3GPP online and offline
charging applications, when applicable (i.e. not all the stage 2 Charging TSs
have Rf/Ro applicable), and therefore owns the Diameter part description.
### 4.1.3 Information Element -- Category per middle Tier TS
#### 4.1.3.1 Category definition
In order to meet the high level requirements as mentioned in clause 4.1.1,
category settings are specified per stage 2 TSs (i.e. for the corresponding
service) for Information Elements (IE) and CDRs fields.
The categories are defined in clause 5.4 of TS 32.240 [1] and copied below:
> _\"__M_ _This parameter is_ _M_ _andatory and shall always be present in the
> event / CDR._
>
> _**C** This parameter shall be present in the event / CDR only when certain
> Conditions are met. These Conditions are specified as part of the parameter
> definition._
_**OM** This is a parameter that, if provisioned by the operator to be
present, shall always be included in the events CDRs. In other words, an OM
parameter that is provisioned to be present is a mandatory parameter._
_**OC** This is a parameter that, if provisioned by the operator to be
present, shall be included in the events / CDRs when the specified conditions
are met. In other words, an OC parameter that is configured to be present is a
conditional parameter.\"_
#### 4.1.3.2 IE Category and charging architecture
IEs are conveyed over Rf/Ro and their category apply to the CTF (Network
Element): i.e. on the sender side. There is no differentiation between Rf and
Ro for the category, from the CTF\'s perspective.
The CDF is the receiver side for Rf.
The receiver side for Ro is the OCS.
#### 4.1.3.3 IE category and receiver
Whatever the category **M** , **C** , **OM** or **OC** , they are specified,
per middle Tier TS, to mandate the CTF to send the IE (unconditionally, or
under conditions), or to prevent the CTF from sending the IE (unconditionally,
or under conditions).
IE category is a mean to control the IE to be sent, with the assumption this
IE will be processed by the receiver. This is explained in more details,
considering the different categories:
\- An IE with category M is mandatory to be sent by the CTF unconditionally,
and obviously, mandatory to be supported by the receiver.
\- An IE with category C is mandatory to be sent by the CTF when certain
conditions are met, therefore such IE is also mandatory to be supported by the
receiver, so the met conditions can be complied with (although it may not
always be possible for the receiver, to check this upon the IE reception).
\- An IE with category **OM** or **OC** is mandatory to be sent by the CTF
under the condition it is provisioned by the operator to be present
unconditionally or with conditions respectively. The provisioning in CTFs is
expected to be consistent with the support of IEs by the receivers (CDF/OCS):
in that sense, when provisioned in the CTF, they are mandatory to be supported
by the receiver, otherwise there is an inconsistency.
In addition to the category, a \"Supported fields in _Charging Data Request_
message\" table and \"Supported fields in _Debit / Reserve Units Request_
message\" table specify whether the IE is applicable per Node and per message
for Rf and Ro respectively. When marked as \"-\" in these tables, the IE is
not expected to be sent.
For an IE which is not specified by the middle Tier TS as applicable over
Ro/Rf (i.e. not part of corresponding \"Service Information\" definition, not
expected from this node, not expected from this message), when received
corresponds to an error scenario (supported or not supported by the receiver).
In practice, such cases are not checked by the receiver, i.e. the IE is simply
ignored since it is not considered during the processing.
It can be summarized that in all cases an IE, is mandatory to be supported by
the receiver, when received in the context of a specific middle Tier TS. When
unexpected in the context of a specific middle Tier TS, specific Node and
specific message: this determines the conditions for the receiver to be able
to decide to reject the non-supported IEs. In other conditions, the IE can be
ignored if not supported.
#### 4.1.3.4 Category for CDR fields
The categories defined in clause 5.4 of TS 32.240 [1] and copied in clause
4.1.3.1 are also applicable to CDR fields, and relate to the CDR content
description on Bx interface. The Charging Gateway Function (CGF) has the role
of CDRs validation per clause 4.3.1.3 of TS 32.240 [1].
Therefore, the categories **M** , **C** , **OM** or **OC** , specified, per
CDR per middle Tier TS, to mandate the CDR fields to be present
unconditionally, or under conditions are expected to be enforced by the CGF,
when possible to do so. Although the CDF can act upon charging events (ACR)
receptions when IEs corresponding to mandatory fields are missing (e.g. when
the corresponding AVP is mandatory per ABNF grammar), it is not expected the
CDF to fully handle this check, since this is the role of the CGF.
Furthermore, multiple charging events can be used by the CDF to build a CDR,
therefore it is not possible to conclude from a single ACR that a IE is
missing.
In summary, the categories **M** , **C** , **OM** or **OC** , specified for
CDRs on Bx interface do not govern the behavior of the receiver for mandatory
concept for IEs received over Rf.
## 4.2 3GPP charging applications and Diameter
### 4.2.1 Mapping of charging and Diameter
Since the introduction of Rf and Ro Reference points from 3GPP Rel-6, Diameter
has been the protocol used, by adoption of IETF Diameter Applications extended
with 3GPP-specific AVPs, i.e.:
\- IETF RFC 3588 [401] Diameter Base Protocol Accounting application
(application Id =3), for Rf.
\- IETF RFC 4006 [402] Diameter Credit-Control Application and Authentication
application (Auth-Application-Id = 4), for Ro.
This is specified in TS 32.299 [50], and the mapping of the stage 2 TSs to
this Diameter description is based on following principles:
\- \"Charging Data Request/Response messages contents\" common structure is
mapped to IETF RFC 3588 [401] ACR/ACA commands and AVPs for Rf.
\- \"Debit / Reserve Units Request/Response contents\" common structure is
mapped to IETF RFC 4006 [402] CCR/CCA commands and AVPs for Ro.
With the \"Operation Token\" IE mapped to \"Service-Context-Id\" AVP which
identifies the middle-tier TS where the message contents are specified along
with IEs and their category.
The mapping of IEs under the \"Service Information\" to Diameter AVPs is
either explicitly described under binding tables in middle tiers TSs (e.g.
\"SM Client Address\" IE in TS 32.274 table 6.3.1.2.1 is mapped to Client-
Address AVP per binding table 6.4.1 in same TS 32.274), either implicit by
adoption of similar names.
### 4.2.2 Use of Diameter capability
#### 4.2.2.1 General principle
In order to achieve the IE Category setting to govern IE presence/absence per
middle Tier TSs and per 3GPP Diameter applications Rf/Ro, it was needed to use
Diameter appropriately.
#### 4.2.2.2 AVP ABNF syntax
In particular, it was needed to have most of the AVPs used by 3GPP Diameter
charging applications \"optional\" per ABNF syntax (i.e. with []), so that
corresponding IE category can override the ABNF syntax.
The few AVPs which are used as \"required\" AVP in the ABNF syntax (i.e. with
{} and \<>), are for most of them, inherited from IETF ACR/ACA, CCR/CCA common
structure, (e.g. { Origin-Host }), and it can be only category M for the
corresponding IE.
#### 4.2.2.3 M-bit setting
The selected approach to reject the command with an AVP identified by the
receiver as not supported by the 3GPP Diameter Charging application Rf/Ro
whatever under which \"Service-Context-Id\" this AVP is received, is achieved
by mandating the M-bit set for all AVPs used by 3GPP Diameter Charging
applications.
This approach does not address the expected behaviour per clause 4.1.3.3,
where the receiver would need to differentiate per \"Service-Context-Id\",
specific Node and specific message for ignoring or rejecting non-supported
IEs.
### 4.2.3 Conformance to Diameter extensibility Rule
Rf and Ro have been specified since 3GPP Rel-6, by extending Acct-Application-
Id (3) and Auth-Application-Id (4) respectively, with AVPs having their M-bit
set, and updated in Rel-14 to comply with the new IETF RFC 6733 [412] Diameter
base protocol.
Rf and Ro Diameter Charging applications should conform to IETF RFC 6733 [412]
Diameter extensibility rules:
\"However, a new Diameter application MUST be created when one or more
of the following criteria are met:
M-bit Setting
An AVP with the M-bit in the MUST column of the AVP flag table is
added to an existing Command/Application. An AVP with the M-bit
in the MAY column of the AVP flag table is added to an existing
Command/Application.\"
Although until Rel-14, IETF RFC 3588 [401] recommendations on extensibility
rules were not followed by Rf and Ro Diameter Charging Applications, no
related interoperability issues have been reported so far, either because AVPs
are supported, either because workarounds to ignore such AVPs have been
implemented.
Therefore, it can be considered there is no need to modify the existing
specifications for the purpose of interoperability with the M-bit set of AVPs,
and the basis for extensibility consideration by the solution, is the existing
Rel-14 Rf and Ro.
Therefore, it is not allowed to introduce new AVPs with M-bit set (MUST or MAY
column):
\- in Rf as it is defined up to Rel-14: Rf reuses IETF RFC 6733 [412] Diameter
Base Protocol Accounting ACR/ACA commands and application (application Id =3).
\- in Ro as it is defined up to Rel-14: Ro reuses IETF RFC 4006 [402] Diameter
Credit-Control Application CCR/CCA commands and Authentication application
(Auth-Application-Id = 4).
# 5 Key issues
## 5.1 Key issue#1: M-bit setting Charging applications specific
### 5.1.1 Description
IETF RFC 6733 [412] states the M-bit setting for an AVP needs to be
application and command specific:
_\"Note: The M-bit setting for a given AVP is relevant to an Application and
each command within that application that includes the AVP. That is, if an AVP
appears in two commands for application Foo and the M-bit settings are
different in each command, then there should be two AVP flag tables describing
when to set the M-bit.\"_
All AVPs used for charging need to have dedicated Rf and Ro M-bit setting.
### 5.1.2 Current status
For AVPs owned by Diameter Charging applications, the M-bit setting is
Diameter Charging applications specific (i.e. specified in TS 32.299 [50]).
For AVPs used in TS 32.299 [50], but owned by other 3GPP Diameter
Applications, the M-bit setting is specified as inherited from these Diameter
applications. This implies the resulting M-bit setting for this AVP for Rf and
Ro may not be appropriate. In particular, this is not aligned with the current
principle where for most of the AVPs, the M-bit should be set for Rf and Ro.
In addition, in case of AVP owned by another 3GPP Diameter Application and
appearing in more than one command for this application, it is not identified
which M-bit setting applies to the AVP for TS 32.299 [50].
### 5.1.3 Solutions
#### 5.1.3.1 Solution #1.1
The solution is to explicitly specify the M-bit setting for Rf/Ro in TS 32.299
[50] Table 7.2.0.1, for any AVP inherited from other 3GPP Diameter
Applications, which are new for Diameter Charging applications.
#### 5.1.3.2 Solution #1.2
The solution is to create a new AVP in TS 32.299 [50], each time a new AVP is
needed for Diameter Charging applications, even when an AVP with the same
definition exists for other 3GPP Diameter Applications.
### 5.1.4 Solutions evaluation and conclusion.
#### 5.1.4.1 Evaluation
The solution #1.2 is against the recommendation to re-use existing AVPs per TS
29.230 [205] clause A.3 AVP codes, and having the same information conveyed in
different AVPs introduces a risk of discrepancy. This solution #1.2 would
substantially increase the number of AVPs codes for Diameter Charging
applications.
#### 5.1.4.2 Conclusion
The solution #1.1 is the preferred solution.
## 5.2 Key issue#2: M-bit setting Ro specific and Rf specific
### 5.2.1 Description
Per clause 5.1.1 description, in addition, all AVPs used for Rf need to have
dedicated M-bit setting compared to AVPs used for Ro.
### 5.2.2 Current status
The M-bit setting AVPs defined in TS 32.299 [50], are not differentiated
between Rf and Ro Applications.
### 5.2.3 Solutions
#### 5.2.3.1 Solution #2.1
The solution is to explicitly specify the M-bit setting for Rf, and M-bit
setting for Ro, in addition to solution #1.1.
#### 5.2.3.2 Solution #2.2
### The solution is to create two separate AVPs in TS 32.299 [50], each time
it is needed to have the AVP M-bit setting different between Rf and Ro, in
addition to solution #1.2.5.2.4 Solutions evaluation and conclusion.
#### 5.2.4.1 Evaluation
The solution #2.2 has the same drawbacks as the solution #1.2.
#### 5.2.4.2 Conclusion
The solution #2.1 is the preferred solution.
## 5.3 Key issue #3: AVPs via Diameter Proxy Agent
### 5.3.1 Description
IEs conveyance are specified for Rf and Ro from a CTF (Client) to a CDF/OCS
(Server), and whether to reject the IE if not supported needs to be checked by
the server, which implies that corresponding AVPs needs to pass through
intermediate Proxy even those not supporting the AVP.
### 5.3.2 Current status
Per Diameter Base protocol specification IETF RFC 6733 [412], Diameter Proxy
Agents, in the path between the Diameter Client and Diameter Server \"may
optionally perform more in-depth message validation for applications in which
it is interested\".
Unrecognized AVP received by Proxy Agents with the 'M' bit, are rejected with
DIAMETER_AVP_UNSUPPORTED Result-Code AVP value indicating the offending AVP,
resulting in the request rejection, preventing the request from reaching the
server.
Before 3GPP Rel-12, both Rf and Ro are specified for intra-PLMN behaviour as
stated in TS 32.299 [50] clause 4.1.1:
_\"Within the scope of this release, each Network Element that generates
charging information sends the information only to the charging entities of
the same PLMN, and not to charging entities in other PLMNs.\"_
2 exceptions were introduced:
\- From 3GPP Rel-12, an architecture where the Ro reference point is used
between specific Service-NE (known as a Proxy Function) from one provider to
an OCF in another network.
\- From 3GPP Rel-13, PS domain online charging for roaming context, where both
the PCEF and the TDF uses Ro interface toward the OCS crossing PLMNs, with a
simplified profile specified for deployment purposes.
Within an Operator\'s domain, it can be expected that deployed Diameter Proxy
Agents and Diameter Charging servers are consistent, as far as 3GPP Diameter
Charging applications are concerned, therefore implemented so that all
required AVPs are recognized throughout the path.
However, in the 2 inter-Operator scenario introduced from Rel-12, it can be
expected situation where Diameter Proxy Agents at the edge of the PLMNs reject
incoming Ro requests due to unrecognized AVPs with M-bit set.
### 5.3.3 Solutions
#### 5.3.3.1 Solution #3.1
The solution is to mandate M-bit to be cleared for any new AVPs.
All AVPs are ignored by Diameter Proxy Agent in the middle, when not
supported.
For existing AVPs:
Interoperability issue may arise from Rel-13 in inter-PLMN deployment, however
to the best of our knowledge inter-PLMN Gy is not deployed today. In case of
such deployment, Diameter Proxy Agents are expected to be configured per
roaming agreements: either apply rejection per M-bit rule, either implement a
workaround to let the messages going through when AVPs are identified as not-
supported.
Therefore, it can be considered there is no need to modify the existing
specifications for the purpose of interoperability with the M-bit set of AVPs
by Diameter Agents. The solution applies for new AVPs introduced from Rel-15
onwards.
### 5.3.4 Solution evaluation and conclusion
#### 5.3.4.1 Evaluation
This solution #3.1 allows requests with new mandatory AVPs to pass through
intermediate Diameter Proxy Agents, even those not supporting the AVPs.
#### 5.3.4.2 Conclusion
This solution #3.1 is adopted.
## 5.4 Key issue #4: Limit service rejection to when appropriate
### 5.4.1 Description
An AVP needs to be rejected by the receiver when the corresponding IE is
specified by the middle Tier TS as mandatory to be supported and this AVP is
not understood, as per summary in clause 4.1.3.3. Otherwise it has to be
ignored so the service can continue.
### 5.4.2 Current status
By requiring the M-Bit to be set for all AVPs specified in TS 32.299 [50], it
is not possible for AVPs received out of \"Service-Context-Id\", specific Node
and specific message, to be able to be ignored when not supported; they are
always rejected if not supported whatever the conditions.
### 5.4.3 Solutions
#### 5.4.3.1 Solution #4.1
The solution is to define AVP M-bit setting per \"Service-Context \", specific
Node and specific message: mandate or allow M-bit set under these specific
conditions for AVPs mandatory to be supported by the receiver, and mandate the
M-bit cleared otherwise (i.e. AVPs to be ignored if not supported by the
receiver).
#### 5.4.3.2 Solution #4.2
The solution is to create a new AVP dedicated to the specific condition (i.e.
\"Service-Context \", specific Node and specific message) with the appropriate
M-bit setting, even when an AVP with the same definition exists and could be
re-used but the M-bit setting for this AVP is not suitable.
### 5.4.4 Solutions evaluation and conclusion
#### 5.4.4.1 Evaluation
The solution #4.2 has the same drawbacks as solution #1.2, which are even more
significant due to the per \"Service-Context \", specific Node and specific
message granularity (e.g, more new AVPs).
#### 5.4.4.1 Conclusion
The solution #4.1 is the preferred solution.
## 5.5 Key issue #5: New 3GPP Release with new mandatory IEs.
### 5.5.1 Description
A new 3GPP Release (e.g. Rel-13, Rel-14...) is a major version introducing new
functionalities, and the charging server is expected to support the same
Release as the Network elements for the charging of new network
functionalities to be supported.
Introduction of major versions of SA5 specifications (i.e. new Release)
results in most cases, creation of new IEs over Ro/Rf, with at least some of
them mandatory to be supported by the receiver for new functionalities, when
invoked by the Network elements.
When a first request is sent for the new Release from a network element, this
request may include new AVPs mandatory to be supported by the charging server,
in order to invoke new functionalities. The scenario for this key issue is
when such request is initiated towards a charging server not upgraded to the
new Release.
This key issue is to investigate on how the charging server can react towards
the Network element, based on a Release mismatch instead of based on
unsupported new AVPs, to help Operators in their deployments for new Releases
and functionalities.
### 5.5.2 Current status
The Service-Context-Id AVP is defined for Release version control over Rf and
Ro, which is defined per TS 32.299 [16] clause 7.1.12:
\"extensions\".MNC.MCC.\"Release\".\"service-context\" \"@\" \"domain\"
Where the \"Release\" refers to the 3GPP Release the service specific document
is based upon e.g. 12 for Release 12.
When a Rel-n CTF initiates a Rf/Ro request with the appropriate Service-
Context-Id AVP, towards a receiver which does not support this new Rel-n, and
the request contains one or more new AVPs with M-bit set (new
functionalities):
\- any Diameter Proxy Agents in the middle, which has not been upgraded to
Rel-n, may reject the request due to unsupported AVPs and M-bit set,
preventing the request to reach the server. It will not be possible for the
charging server to indicate the Release mismatch (e.g. this Rel-n release for
this service context is not supported).
\- The charging server receiving the request, may apply the M-bit set rule for
AVPs identified as not-supported and reject the request, in practice on the
first AVP processing error encountered. The Release mismatch may not have been
determined by the charging server, or if determined will not be indicated as
such to the network element in the rejection message.
### 5.5.3 Solutions
#### 5.5.3.1 Solutions #5.1
This solution is the same as the solution #3.1.
All new AVPs are ignored by Diameter Proxy Agents in the middle, when not
supported..
In this solution the charging server receiving the request for a non-supported
Release of a \"service-context\" (e.g. Rel-15 IMS charging: 15.32260\@3gpp.org
is not supported, only IMS charging prior to Rel-15 is supported) can reject
with appropriate error, instead of sending errors due to unsupported new
mandatory AVPs.
#### 5.5.3.2 Solutions #5.2
New Diameter applications are created at each 3GPP Release:
\- New Auth-Application-Id value for Ro
\- New Acct-Application-Id value for Rf.
New AVPs mandating or allowing M-bit set, can be created in the commands for
these new Diameter applications.
In order to reach the charging server, a new route is selected by the sender
when a diameter Proxy Agent in the path does not support the new applications.
The client is aware the 3GPP Release is not supported by the charging server,
when the request is rejected due to the new applications are not supported.
### 5.5.4 Solutions evaluation and conclusion
#### 5.5.4.1 Evaluation
Both solutions allow to quickly identify the release mismatch between the
client and the charging server, however once this mismatch is solved (i.e. by
upgrading the Charging server, or new charging server):
\- in the solution #5.1, after the charging server has been upgraded with the
new 3GPP Release for a service-context, it is still not possible for the
client, to know whether the receiver supports or not the mandatory AVPs, as
they are ignored if not supported.
\- In the solution #5.2, after the charging server has been upgraded with the
new Diameter application, the M-bit setting mechanism can apply for mandatory
AVPs and the client receives appropriate error.
#### 5.5.4.2 Conclusion
The solution #5.2 is preferred.
## 5.6 Key issue #6: New functionality with new mandatory IEs.
### 5.6.1 Description
Amongst the set of new functionalities introduced within a 3GPP Release (e.g.
Rel-13, Rel-14...) only a set of them may be selected to be implemented by an
Operator. It is needed in consequence, for the charging server to support
these set of network functionalities accordingly, in addition to the support
of the 3GPP Release in which they were introduced.
For these new functionalities, new IEs over Ro/Rf may have been created, with
at least some of them mandatory to be supported by the receiver, when invoked
by the Network elements.
The scenario for this key issue is new functionality invocation by a network
element, initiating a request with new AVPs mandatory to be supported, towards
a charging server not upgraded with the new functionality, although upgraded
to the new 3GPP Release.
This key issue is to investigate on how the charging server can react towards
the Network element, based on unsupported functionality or unsupported new
AVPs, in a way to help Operators in their deployments for new functionalities.
### 5.6.2 Current status
When a CTF initiates a Rf/Ro request towards a receiver for this new
functionality, including the appropriate AVPs with M-bit set:
\- Any Diameter Proxy Agents in the middle, which has not been upgraded with
this new functionality, may reject the request due to unsupported AVPs and
M-bit set, preventing the request to reach the server. It will not be possible
for the charging server to indicate the non supported AVPs.
\- The charging server receiving the request, may apply the M-bit set rule for
AVPs identified as not supported, and reject the request, in practice on the
first AVP processing error encountered. This rejection may not be sufficient
for the charging server to indicate the new functionality is not supported, as
it may not indicate the appropriate AVP.
### 5.6.3 Solutions
#### 5.6.3.1 Solutions #6.1: M-bit cleared
This solution is the same as the solution #3.1.
All new AVPs are ignored by Diameter Proxy Agents in the middle, when not
supported.
In this solution the charging server receiving the request for a supported
Release of a \"service-context\", which includes a new AVP associated to a new
functionality, will ignore or reject the AVP per a release basis if not
supported.
#### 5.6.3.2 Solutions #6.2: new Diameter application per 3GPP Release
This solution is the same as the solution #5.2.
In this solution, the M-bit rule will apply for the new functionality within
the 3GPP Release.
The charging server receiving the request for a supported application, which
includes any new AVP associated to new functionalities, which is not
supported, will reject the request.
#### 5.6.3.3 Solutions #6.3: new Diameter application per functionality
This solution is to create new Diameter applications for each functionality.
.
The concept of functionality here, is similar to the concept of \"feature\"
described in TS 29.229 [204] clause 7.1.1. It has a meaning as a whole and
corresponds to the network capability or functionality, the charging relates
to (e.g. Trusted WLAN).
When a new functionality is specified, which needs new IEs to be introduced
over Ro/Rf, and these IEs are determined as \"mandatory to be supported by the
receiver\" to ensure proper charging functionality, the corresponding new AVPs
are created with M-bit set \"MUST\", and new applications are created:
\- New Auth-Application-Id value for Ro.
\- New Acct-Application-Id value for Rf.
For IEs identified as \"optional\" (i.e. to be ignored if not supported by the
receiver) for this new functionality, the corresponding new AVPs are created
mandating the M-bit cleared.
Although introduction of a new functionality, is always in a context of a
specific middle Tier TS (i.e. service-context) for a given application Ro or
Rf, for corresponding new AVPs created with M-bit setting associated to this
functionality, it is assumed this M-bit setting applies at application (Ro/Rf)
level.
It is possible for this new functionality to re-use existing AVPs, and
mandatory setting takes precedence as follows:
\- In case at least one of them needs the M-bit setting to be changed from
optional to mandatory, new applications are created, if not already created
from new AVPs. These AVPs become mandatory to be supported at application
level.
\- In case the M-bit setting needs to be changed from mandatory to optional,
the M-bit setting remains as mandatory.
In case none of the IEs are identified as \"mandatory to be supported by the
receiver\" by the new functionality, the existing application can be used.
#### 5.6.3.4 Solutions #6.4: Supported-feature mechanism
The supported feature mechanism is based on Supported-Features AVP which is
specified in TS 29.229 [204], clause 6.3.29, and used by other 3GPP Diameter
applications for non-charging interfaces. It allows a Diameter Application-
level negotiation of supported features, so that Diameter application can be
extended with features in a backward compatible manner. It also avoids the
situation with M-bit cleared, when a receiver silently ignores an AVP whereas
the sender assumes the AVP is processed.
When a new functionality is specified, the set of IEs introduced, associated
to this functionality correspond to a set of AVPs which, for part of them are
mandatory to be supported by the receiver, and others can be ignored by the
receiver if not supported.
All the new AVPs are created with the M-bit \"MUST\" to be cleared, except the
\"Supported-Features AVP\".
In offline/online charging, each request initiation (ACR [Start], CCR
[Initial]) is sent with the new IEs (AVPs) associated to the new
functionality. This request includes the \"Supported-Features AVP\" containing
the \"new Feature\".
In case the charging server (CDF/OCF) supports the \"new Feature\", this new
feature is processed, and the charging server includes the Supported-Features
AVP with the \"new Feature\" in the answer to indicate to the CTF this feature
is supported.
In case the charging server (CDF/OCF) does not support the \"new Feature\",
two cases:
\- The \"Supported-Features AVP\" containing the \"new Feature\" was sent with
M-bit set (i.e. required to be supported by the receiver): the charging server
rejects the request with DIAMETER_ERROR_FEATURE_UNSUPPORTED.
\- The \"Supported-Features AVP\" containing the \"new Feature\" was sent with
M-bit cleared (i.e. optionally to be supported by the receiver): the charging
server accepts the request and answers by indicating the feature was ignored.
The supported feature mechanism as specified in TS 29.229 [204] is used.
###
### 5.6.4 Solutions evaluation
In the solution #6.1, the request is successfully handled by the charging
server, however the client is not aware AVPs (i.e. the functionality) are not
supported and not processed by the charging server on a per functionality
basis: in consequence the rating or subsequent billing will not be accurate.
This solution #6.1 is not adequate.
In the solution #6.2: the M-bit setting rule is used for rejection by the
charging server due to unsupported functionalities within the new Diameter
application associated to the 3GPP Release. However, the request is rejected
on the first AVP processing error encountered, which does not allow to
identify which functionality is not supported, unless the combination of
solutions #1.1, #2.1, #4.1 (i.e. M-bit setting per \"Service-Context \",
specific Node and specific message) is adopted, which is complex.
The solution #6.3 allows introduction of new functionalities in alignment with
clause 4.2.3, through new Diameter application id creation (i.e. application
Id = 3 and Auth-Application-Id = 4 are not re-used) for extension with
mandatory AVPs. Considering there are multiple middle Tier TSs
(service/domains), and multiple functionalities per middle Tier TSs, it can be
expected many Diameter applications to be created for a given Release (almost
one per functionality): this is complex to specify and deploy.
The solution #6.4, in alignement with diameter extensibility rule per clause
4.2.3, is a flexible mechanism allowing the charging client to be aware of
functionalities supported or not by the charging server, in order to be able
to react appropriately, when the rating or subsequent billing cannot be
accurate.
# 6 Conclusion and recommendation
It is concluded on supported feature mechanism solution #6.4 and recommended
to use the mechanism as specified in TS 29.229 [204].
It is needed to specify how the supported feature mechanism is used by 3GPP
Charging applications, in particular, the corresponding AVP(s) to be included
for each specific service-context (e.g. under PS-information, IMS-
information).
For any new AVPs introduced for new Rel-15 functionalities, the following
should apply:
\- if new in TS 32.299: M-bit should be cleared;
\- if inherited from other 3GPP Diameter applications: M-bit should be
explicitly cleared for TS 32.299.
#
# Foreword
This Technical Report has been produced by the 3^rd^ Generation Partnership
Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# 1 Scope
The present document studies the overload control mechanisms for Rc, Re, Rf
and Ro interfaces based on the conclusion of TR 29.809 [212].
For 3GPP Diameter Charging interfaces, the Diameter overload control mechanism
are based on the IETF Draft \"Diameter Overload Indication Conveyance\" that
defines the AVPs for the transport of overload information of Diameter
application as well as the basic behaviour of the Diameter endpoints receiving
this information.
The IETF RFC 7683 [404] is considered as the reference of the present document
and not the IETF Draft draft-ietf-dime-ovli-02 referenced by TR 29.809 [212].
As per TR 29.809 [212], the following conclusions apply and are not studied in
the present document:
\- How a reporting node determines it is entering into an overload condition
is implementation dependent.
\- How a reporting node determines the contents value of the overload report
(i.e. OC-OLR AVP) is implementation dependent.
\- How a reacting node achieves traffic reduction (i.e. selection of impacted
sessions) is implementation dependent.
The following issues are covered by the present document:
\- Application and/or modification of current failure handling functionality
defined in TS 32.299 [50] for Diameter online and offline charging in the
Charging Trigger Function when reacting to overload control indication from
the OCS or CDF, respectively.
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or nonâ€‘specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
[1] 3GPP TS 32.240: \"Telecommunication management; Charging management;
Charging Architecture and Principles\".
[2] - [10] Void.
[11] 3GPP TS 32.251: \"Telecommunication management; Charging management;
Packet Switched (PS) domain charging\".
[12] - [19] Void.
[20] 3GPP TS 32.260: \"Telecommunication management; Charging management; IP
Multimedia Subsystem (IMS) charging\".
[21] - [29] Void.
[30] 3GPP TS 32.270: \"Telecommunication management; Charging management;
Multimedia Messaging Service (MMS) charging\".
[31] 3GPP TS 32.271: \"Telecommunication management; Charging management;
Location Services (LCS) charging\".
[32] 3GPP TS 32.272: \"Telecommunication management; Charging management;
Push-to-talk over Cellular (PoC) charging\".
[33] 3GPP TS 32.273: \"Telecommunication management; Charging management;
Multimedia Broadcast and Multicast Service (MBMS) charging\".
[34] 3GPP TS 32.274: \"Telecommunication management; Charging management;
Short Message Service (SMS) charging\".
[35] 3GPP TS 32.275: \"Telecommunication management; Charging management;
MultiMedia Telephony (MMTel) charging\".
[36] 3GPP TS 32.276: \"Telecommunication management; Charging management;
Voice Call Service Charging\".
[37] 3GPP TS 32.277: \"Telecommunication management; Charging management;
Proximity-based Services (ProSe) Charging\".
[38] 3GPP TS 32.278: \"Telecommunication management; Charging management;
Monitoring Event charging\".
[39] Void.
[40] 3GPP TS 32.280: \"Telecommunication management; Charging management;
Advice of Charge (AoC) service\".
[41] 3GPP TS 32.281: \"Telecommunication management; Charging management;
Announcement service\".
[42] - [49] Void.
[50] 3GPP TS 32.299: \"Telecommunication management; Charging management;
Diameter charging applications\".
[51] - [52] Void.
[53] 3GPP TS 32.296: \"Telecommunication management; Charging management;
Online Charging System (OCS) applications and interfaces\".
[54] - [99] Void.
[100] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[101] 3GPP TS 22.115: \"Service aspects; Charging and billing\".
[102] - [199] Void.
[200] - [211] Void.
[212] 3GPP TR 29.809: \"Study on Diameter overload control mechanisms\".
[213] - [299] Void.
[300] - [399] Void.
[400] Void.
[401] IETF RFC 6733 (2015): \"Diameter Base Protocol\".
[402] IETF RFC 4006 (2005): \"Diameter Credit-Control Application\".
[403] IETF RFC 7683 (2015): \"Diameter Overload Indication Conveyance \".
[404] - [499] Void.
[500] - [599] Void.
# 3 Definitions, symbols and abbreviations
## 3.1 Definitions
For the purposes of the present document, the terms and definitions given in
TR 21.905 [100] and the following apply. A term defined in the present
document takes precedence over the definition of the same term, if any, in TR
21.905 [100].
**middle tier TS:** 3GPP charging TSs that specify the domain / subsystem /
service specific, online and offline, charging functionality. These are all
the TSs in the numbering range from TS 32.250 to TS 32.27x.
NOTE1: e.g. TS 32.250 [10] for the CS domain, or TS 32.270 [30] for the MMS
service.
NOTE 2: Currently, there is only one \"tier 1\" TS in 3GPP, which is the TS
32.240 that specifies the charging architecture and principles. There are a
number of top tier TSs in the 32.29x numbering range ([50] ff) that specify
common charging aspects such as parameter definitions, encoding rules, the
common billing domain interface or common charging applications.
**offline charging:** charging mechanism where charging information **does
not** affect, in real-time, the service rendered
**online charging:** charging mechanism where charging information can affect,
in real-time, the service rendered and therefore a direct interaction of the
charging mechanism with session/service control is required
## 3.2 Symbols
For the purposes of the present document, the following symbols apply:
Gy Online charging reference point between a PCEF and an OCS.
Gz Offline charging reference point between a PCEF and an OFCS.
Rf Offline Charging Reference Point between a 3G network element and the CDF.
Ro Online Charging Reference Point between a 3G network element and the OCS.
## 3.3 Abbreviations
For the purposes of the present document, the abbreviations given in 3GPP TR
21.905 [100] and the following apply.\ An abbreviation defined in the present
document takes precedence over the definition of the same abbreviation, if
any, in 3GPP TR 21.905 [100].
ACA ACcounting-Answer
ACR ACcounting-Request
AS Application Server
ASA Abort-Session-Answer
ASR Abort-Session- Request
AVP Attribute Value Pair
CCA Credit-Control-Answer
CCR Credit-Control-Request
CDF Charging Data Function
CDR Charging Data Record
CEA Capabilities-Exchange-Answer
CER Capabilities-Exchange-Request
DBPA Diameter Base Protocol Accounting
DCCA Diameter Credit-Control Application
DCD Dynamic Content Delivery
DPA Disconnect-Peer-Answer
DPR Disconnect-Peer-Request
DWA Device-Watchdog-Answer
DWR Device-Watchdog-Request
ECUR Event Charging with Unit Reservation
FUI Final-Unit-Indication
GSU Granted-Service-Unit
IE Information Element
IEC Immediate Event Charging
MSCC Multiple Services Credit-Control
OCS Online Charging System
OFCS OFfline Charging System
RAA Re-Auth-Answer
RAR Re-Auth-Request
TDF Traffic Detection Function
# 4 Overview
## 4.1 Introduction
TR 29.809 [212] investigated the possible Diameter-based mechanisms to support
overload control mechanisms in 3GPP core networks.
Two main activities were addressed:
\- Identification of requirements for an improved overload control mechanism
over Diameter based signaling interfaces used in 3GPP core networks.
\- Evaluations of the proposed IETF solutions to cover the requirements of
Diameter overload control.
The TR 29.809 [212] concludes that the generic solution as currently defined
in the draft-ietf-dime-ovli-02, which is IETF RFC 7683 [403] is recommended as
the basis to perform overload control over 3GPP Diameter applications (see
clause 8.3.2 in TR 29.809 [212]). This solution provides a set of generic
Diameter AVPs that can be re-used over any Diameter application to transport
overload indication between Diameter endpoints. However, the exact solution to
implement will be decided per Diameter application, depending on the specific
requirements of each interface. Since the solution is application dependent
this study aims to investigate the solution applicable for the Charging
applications.
## 4.2 Problems and goals
The Diameter Base Protocol, IETF RFC 6733 [401], uses the Protocol Error
\"DIAMETER_TOO_BUSY\", in the Result_Code AVP of the answer to a related
request, as a means for overload control. Specifically, the Protocol Error
\"DIAMETER_TOO_BUSY\" is used by the Diameter server nodes to indicate that it
is unable to provide the requested service due to overload. The main
limitation in the use of the Protocol Error indication \"DIAMETER_TOO_BUSY\"
is that the Diameter client nodes receive overload indication after the
request was sent to an overloaded server, which comprise an unnecessary
server, and transport network, resource utilisation in overload condition.
This limitation in the Diameter Base Protocol have been addressed by the
generic DOIC (Diameter Overload Indication Conveyance) mechanisms specified in
IETF RFC 7683 [403], which makes possible to convey servers\' overload
indications to the clients before the sever starts rejecting requests due to
overload and that prevents retransmission of the requests due to overload of
the servers.
The TR 29.809 [212] recommends the generic DOIC mechanisms to be the base for
the overload control over 3GPP Diameter interfaces (see clause 8.3.2 in TR
29.809 [212]). However, the RFC 7683 [403] and TR 29.809 [212] do not provide
specific guidance on how to implement the DOIC (Diameter Overload Indication
Conveyance) mechanism for Diameter charging applications, it is the scope of
the present document to investigate that.
# 5 Impacts of Diameter overload on 3GPP charging interfaces
## 5.1 Introduction
This clause considers application and/or modification of current failure
handling functionality defined in TS 32.299 [50] for Diameter online and
offline charging in the Charging Trigger Function (CTF) when reacting to
overload control indication from the Offline Charging System (OFCS) and Online
Charging Systems (OCS), respectively.
Today there is a support on the reference points for alternative servers both
in online and offline charging in the case one service is not reachable. In
most cases charging messages cannot be dropped, even if there is a Diameter
overload situation on charging interfaces, since these are the bases for the
subscribers\' bill and dropping a charging message will mean that there will
be no means to charge for the service.
### 5.1.1 3GPP Diameter Charging Interfaces
The Offline Charging System (OFCS) terminates the Rf reference point as
defined in TS 32.240 [1]. Other 3GPP specifications define additional
reference points that are functionally equivalent to the Rf reference point.
These are the Gz reference point for PCEF embedded in PGW and the Gzn
reference point for TDF. The OFCS can be structured into Charging Data
Function (CDF) and the Charging Gateway Function (CGF) in which case the CDF
provides the Diameter Accounting Application. Diameter protocol is not used
for communication between CDF and CGF. As defined in TS 32.240 [1], the
network elements connected to the OFCS by the Rf reference point, such as PGW
can be regarded as Diameter client.
The Online Charging System (OCS) terminates the Ro reference point as defined
in TS 32.240 [1]. Other 3GPP specifications define additional reference points
that are functionally equivalent to the Ro reference point. These are the Gy
for PCEF embedded in PGW and the Gyn reference point for TDF. The OCS can be
structured into Online Charging Function (OCF), Account Balance Management
Function (ABMF) and Rating Function (RF) and between these functions Diameter
is used, but for the Ro reference point it is the OCS as such that provides
the Diameter Credit-Control Application. As defined in TS 32.240 [1], the
network elements connected to the OCS by the Ro reference point, such as PGW
can be regarded as Diameter clients.
The Diameter Accounting Application used on the Rf interface and Diameter
Credit-Control Application used on the Ro interface are defined in TS 32.299
[50].
### 5.1.2 IETF Diameter Overload Indication Conveyance
The interaction between reacting node and reporting node specified in IETF RFC
7683 [403] can be illustrated as following figure.
Figure 5.1.2.1: Interaction between Reacting Node and Reporting Node
The default abatement algorithm described in IETF RFC 7683 [403] is to select
a random number between 1 and 100. If the random number is less than or equal
to the indicated reduction percentage received by the reacting node then the
request will be given abatement treatment otherwise the request is given
normal routing treatment.
Editor\'s note: This needs to be extended with more details about the DIOC
concept.
## 5.2 Overload of the Offline Charging System (OFCS)
### 5.2.1 Existing overload control mechanism on Diameter charging interface
#### 5.2.1.1 Failure handling
The current failure handling uses the Charging Characteristics as defined in
TS 32.251 [11] Annex A, allows to specify both primary and secondary OFCS
addresses as well as the possibility to produce CDR or buffer these for
offline charging as a backup for the Diameter offline.
#### 5.2.1.2 Limitation
The current solution will only be used when there is a failure and cannot be
used for preventing an overload situation, i.e. it will manage the event that
a failure occurs but it cannot decrease the load if the systems are getting
close to their limits.
### 5.2.2 Solutions for Diameter overload indication handling
#### 5.2.2.1 Alternative solution #1.1: OLR with buffer mechanism
The default loss algorithm together with buffer mechanism is proposed to be
alternative solution 1. The reacting node determines if overload control
treatment should be applied to the request based on the OLR. One approach that
could be taken for each request is to select a random number between 1 and
100. If the random number is less than or equal to the indicated reduction
percentage received by the reacting node then the request is buffered,
otherwise the request is given normal routing treatment. This algorithm
enables request messages of the reduction percentage to be buffered. And when
the overload ends, according to FIFO (first-in first-out) principle, the
buffered request messages will be sent out to CDF in order. The CDF can apply
existing duplicate detection and sort ACRs according to sequence number of
each ACR to generate CDR. The shortage of the solution is that buffering
request messages randomly may lead to additional workload on sorting ACRs in
CDF.
OLR_DEFAULT_ALGO (0x0000000000000001) of OC-Feature-Vector AVP specified in
IETF RFC 7683 [403] is used.
The above described abatement mechanism is illustrated by the diagram in
Figure 5.2.2.1.1, which assumes configuration with a single CDF; configuration
with redundant standby CDF is not considered in the present document.
Figure 5.2.2.1.1: Basic buffer mechanism solution
1\. Charging session is ongoing.
2\. CTF sends its supported overload control features stating support for the
default loss algorithm.
3\. CDF selects OC-Reduction-Percentage based on load situation (i.e. CPU
load) and default loss algorithm as expected overload control algorithm and
fill value of OLR_DEFAULT_ALGO in OC-Feature-Vector AVP
4\. CDF responds with the selected values.
5\. CTF is set to enforce the buffer mechanism based on the result of the
default loss algorithm until next ACR.
6a. An overload occurs
6b. Any ACA response during overload condition may contain the validity
duration and reduction percentage, resulting in buffering of ACRs.
> 7\. When the overload ends, this can either be after the OLR has timed out
> or a new OLR is sent without restriction, the buffered ACRs are sent to CDF
> in the order they were buffered.
#### 5.2.2.2 Alternative solution #1.2: OFCS without DOIC mechanism
In this alternative solution 2 the OFCS will not use the DOIC but instead
selects which messages to reply with a Protocol Error \"DIAMETER_TOO_BUSY\"
and for these the client will follow the Charging Characteristics on the
treatment, e.g. try the secondary address, start buffering or producing CDR.
This means that the OFCS would have to decide on which request that should be
buffered and this can in this case be based on type of service. This will mean
that the OFCS still will receive all Diameter messages and will reject them
one by one, that is if the Client itself do not start using an algorithm to
select messages to go to the secondary address would it encounter a Protocol
Error \"DIAMETER_TOO_BUSY\".
## 5.3 Overload of the Online Charging System (OCS)
### 5.3.1 Existing overload control mechanism on Diameter charging interface
#### 5.3.1.1 Failure handling
The current failure handling uses the Charging Characteristics as defined in
TS 32.251 [11] Annex A, allows to specify both primary and secondary OCS
addresses as well as the possibility to produce CDR as a backup for the
Diameter online charging.
#### 5.3.1.2 Limitation
The current solution will only be used when there is a failure and cannot be
used for preventing an overload situation, i.e. it will manage the event that
a failure occurs but it cannot decrease the load if the systems are getting
close to their limits.
### 5.3.2 Solutions for Diameter overload indication handling
#### 5.3.2.1 Alternative solution #2.1: OLR with buffer mechanism
The default loss algorithm together with buffer mechanism is proposed to be
alternative solution 1. Since it is not possible to buffer a request for quota
to grant service access, the mechanism will buffer the current online
mechanism and use it as a sort of offline mechanism. This means that they will
only be provided after service has been granted. The reacting node determines
if overload control treatment should be applied to the request based on the
OLR. One approach that could be taken for each request is to select a random
number between 1 and 100. If the random number is less than or equal to the
indicated reduction percentage received by the reacting node then the request
is buffered, otherwise the request is given normal routing treatment. This
algorithm enables request messages of the reduction percentage to be buffered
and sent offline. And when the overload ends, according to FIFO (first-in
first-out) principle, the buffered request messages will be sent out to OCS in
order, with an indication that they have been buffered. The shortage of the
solution is that it means that the system falls back to an offline behaviour
even if it uses the online mechanism when an overload occurs and can no longer
support online charging, this may result in loss of revenue depending on the
account status when the buffered online requests are sent to the OCS.
OLR_DEFAULT_ALGO (0x0000000000000001) of OC-Feature-Vector AVP specified in
IETF RFC 7683 [403] is used.
The above described abatement mechanism is illustrated by the diagram in
Figure 5.3.2.1.1, which assumes configuration with a single OCS; configuration
with redundant standby OCS is not considered in the present document.
Figure 5.3.2.1.1: Basic buffer mechanism solution
1\. Charging session is ongoing.
2\. CTF sends its supported overload control features stating support for the
default loss algorithm.
3\. OCS selects OC-Reduction-Percentage based on load situation (i.e. CPU
load) and default loss algorithm as expected overload control algorithm and
fill value of OLR_DEFAULT_ALGO in OC-Feature-Vector AVP
4\. OCS responds with the selected values.
5\. CTF is set to enforce the buffer mechanism based on the result of the
default loss algorithm until next CCR.
6a. An overload occurs
6b. Any CCA response during overload condition may contain the validity
duration and reduction percentage, resulting in buffering of CCRs.
> 7\. When the overload ends, this can either be after the OLR has timed out
> or a new OLR is sent without restriction, the buffered CCRs are sent to OCS
> in the order they were buffered, with an indication that they were buffered,
> for further processing.
#### 5.3.2.2 Alternative solution #2.2: OCS without DOIC mechanism
In this alternative solution 2 the OCS will not use the DOIC but instead
selects which messages to reply with a Protocol Error \"DIAMETER_TOO_BUSY\"
and for these the client will follow the Charging Characteristics on the
treatment, e.g. try the secondary address or producing CDR. This means that
the OCS would have to decide which request that the CTF should treat in
accordance with the Charging Characteristics, this can in this case be based
on type of service. This means that the OCS will still receive all Diameter
messages and will reject them one by one. There is a possibility for the CTF
to apply the treatment according to the Charging Characteristics not only to
the CCR where the Protocol Error \"DIAMETER_TOO_BUSY\" was received, but also
to other CCRs.
#### 5.3.2.3 Alternative solution #2.3: OLR with service specific mechanism
A new specific loss algorithm together with buffer mechanism is proposed to be
alternative solution 3. Since it is not possible to buffer a request for quota
to grant service access, the mechanism will buffer the current online
mechanism and use it as a sort of offline mechanism. This means that they will
only be provided after service has been granted. The reacting node determines
if overload control treatment should be applied to the request based on the
OLR. The specific loss algorithm has a more detailed information (compared to
alternative solution 1) for the reduction mechanism, based on Rating-Group or
interrogation type (e.g. First, Intermediate and Final). For each of these
there may be a separate reduction percentage.
When the overload ends, according to FIFO (first-in first-out) principle, the
buffered request messages will be sent out to OCS in order, with an indication
that they have been buffered. The shortage of the solution is that it means
that the system falls back to an offline behaviour even if it uses the online
mechanism when an overload occurs and can no longer support online charging,
this may result in loss of revenue depending on the account status when the
buffered online requests are sent to the OCS.
A new value of OC-Feature-Vector AVP is needed.
The above described abatement mechanism is illustrated by the diagram in
Figure 5.3.2.3.1, which assumes configuration with a single OCS; configuration
with redundant standby OCS is not considered in the present document.
Figure 5.3.2.3.1: Basic buffer mechanism solution
1) Charging session is ongoing.
2) CTF sends its supported overload control features stating support for the
new specific loss algorithm, it may be more detailed stating for which types
are supported e.g. for rating group, service identifier or type of
interrogation.
3) OCS selects the new specific loss algorithm as expected overload control
algorithm. The OC-Reduction-Percentage is selected based on load situation
(e.g. CPU load) and specified for each type it wants separate treatment of.
4) OCS responds with the types and their respective selected OC-Reduction-
Percentage value.
5) CTF is set to enforce the mechanism based on the result of the service loss
algorithm until next CCR.
6a) An overload occurs.
6b) Any CCA response during overload condition may contain the reduction
percentage for specified Rating Group and interrogation type as well as
validity duration and default percentage for others, resulting in buffering of
CCRs matching.
7) When the overload ends, this can either be after the OLR has timed out or a
new OLR is sent without restriction, the buffered CCRs are sent to OCS in the
order they were buffered, with an indication that they were buffered, for
further processing.
# 6 Evaluation and recommendation
All the solutions #1.1, #1.2, #2.1, #2.2 and #2.3 are valid and could be used
to solve the issue and giving better control in the case of an overload
scenario. To require support of at least one of the #1.1 and #1.2 as well as
one of the #2.1, #2.2 and #2.3 is necessary to be able to handle overload
situations.
This will mean that a new clause in the TS 32.299[50] is needed to introduce
and define Overload Control.
#
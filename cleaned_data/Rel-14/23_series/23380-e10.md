# Foreword
This Technical Specification has been produced by the 3^rd^ Generation
Partnership Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# Introduction
Although network nodes in the IMS Core Network should have a very high
availability, some maintenance downtime and occasional failures are
unavoidable. Communication links although designed with robust protocols
between the network elements are also subject to failures. This document
specifies a set of standardized procedures for automatic restoration after
loss or corruption of data reducing the impact of these problems in order to
improve service to the users. The scenarios covered here for the IMS Domain
are similar to those covered in 3GPP TS 23.007 [2] for the CS and PS Domains.
# 1 Scope
The present document specifies the procedures required in 3GPP IMS to handle a
S-CSCF or a P-CSCF service interruption scenario with minimum impact to the
service to the end user.
> NOTE: IMS Restoration Procedures covering service interruption of other
> network elements are not defined in this version of the specification.
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or nonâ€‘specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
[1] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[2] 3GPP TS 23.007: \"Restoration procedures\".
[3] 3GPP TS 29.228: \"IP Multimedia (IM) Subsystem Cx and Dx interfaces;
Signalling flows and message contents\".
[4] 3GPP TS 24.008: \"Mobile radio interface Layer 3 specification\".
[5] 3GPP TS 29.213: \"Policy and charging control signalling flows and Quality
of Service (QoS) parameter mapping\".
[6] 3GPP TS 29.212: \"Policy and Charging Control (PCC); Reference points\".
[7] 3GPP TS 29.214: \"Policy and Charging Control over Rx reference point\".
[8] 3GPP TS 29.060: \"General Packet Radio Service (GPRS); GPRS Tunnelling
Protocol (GTP) across the Gn and Gp interface\".
[9] 3GPP TS 29.061: \"Interworking between the Public Land Mobile Network
(PLMN) supporting packet based services and Packet Data Networks (PDN)\".
[10] 3GPP TS 29.274: \"3GPP Evolved Packet System. Evolved GPRS Tunnelling
Protocol for EPS (GTPv2)\".
[11] IETF RFC 3361: \"Dynamic Host Configuration Protocol (DHCP-for-IPv4)
Option for Session Initiation Protocol (SIP) Servers\".
[12] IETF RFC 1034: \"Session Initiation Protocol (SIP): Locating SIP
Servers\".
[13] IETF RFC 3319: \"Dynamic Host Configuration Protocol (DHCPv6) Options for
Session Initiation Protocol (SIP) Servers\".
[14] IETF RFC 6223: \"Indication of Support for Keep-Alive\".
[15] 3GPP TS 29.275: \"Proxy Mobile IPv6 (PMIPv6) based Mobility and
Tunnelling protocols; Stage 3\".
[16] IETF RFC 7077: \"Update Notifications for Proxy Mobile IPv6\".
[17] 3GPP TS 23.401: _\"_ GPRS Enhancements for E-UTRAN Access _\"_.
[18] IETF RFC 3261: \"SIP: Session Initiation Protocol\".
[19] 3GPP TS 24.229: \"IP multimedia call control protocol based on Session
Initiation Protocol (SIP) and Session Description Protocol (SDP); Stage 3\".
[20] 3GPP TS 23.060: \"General Packet Radio Service (GPRS); Service
description; Stage 2\".
[21] GSMA PRD IR.65: \"IMS Roaming and Interworking Guidelines, version
14.0\".
[22] 3GPP TS 24.244: _\"_ Wireless LAN control plane protocol for trusted WLAN
access to EPC; Stage 3 _\"_.
[23] IETF RFC 7296: \"Internet Key Exchange Protocol Version 2 (IKEv2)\".
[24] 3GPP TS 29.273: \"Evolved Packet System (EPS); 3GPP EPS AAA interfaces\".
[25] IETF RFC 3588: \"Diameter Base Protocol)\".
[26] IETF RFC 5996 (September 2010): \"Internet Key Exchange Protocol Version
2 (IKEv2)\".
# 3 Definitions, symbols and abbreviations
## 3.1 Definitions
For the purposes of the present document, the terms and definitions given in
TR 21.905 [1] and the following apply. A term defined in the present document
takes precedence over the definition of the same term, if any, in TR 21.905
[1].
**Service Interruption:** A period of time in which one or more network
elements do not respond to requests and do not send any requests to the rest
of the system.
**S-CSCF Restoration Information:** Information required for the S-CSCF to
handle traffic for a registered user. This information is stored in HSS and if
lost, retrieved by the S-CSCF.
## 3.2 Abbreviations
For the purposes of the present document, the abbreviations given in TR 21.905
[1] and the following apply. An abbreviation defined in the present document
takes precedence over the definition of the same abbreviation, if any, in TR
21.905 [1].
APCO Additional Protocol Configuration Options
ePDG Evolved Packet Data Gateway
IKEv2 Internet Key Exchange Protocol Version 2
LIA Location Information Answer
LIR Location Information Request
LMA Local Mobility Anchor
NBIFOM Network-Based IP Flow Mobility
PCO Protocol Configuration Options
PGW PDN Gateway
PMIP Proxy Mobile IP
RCS Rich Communication Services
SAA Server Assignment Answer
SAR Server Assignment Request
SGW Serving Gateway
TWAN Trusted WLAN Access Network
UAA User Authorization Answer
UAR User Authorization Request
VoLTE Voice over LTE
WLAN Wireless Local Area Network
WLCP Wireless LAN Control Plane Protocol
# 4 Restoration of Data in the S-CSCF
## 4.1 General
The following clauses describe the IMS Restoration Procedures for the S-CSCF
service interruption in each of the scenarios where they apply.
## 4.2 Registration Procedure
### 4.2.1 Introduction
The following clauses specify the behaviour of HSS and S-CSCF if they support
the IMS restoration feature.
### 4.2.2 S-CSCF Restoration after Failure
If the UE initiates a SIP REGISTER and the S-CSCF returned by the HSS during
user registration status query procedure fails, the I-CSCF is unable to
contact the S-CSCF. In this case, regardless of this registration is an
initial registration, a re-registration or a de-registration, the I-CSCF shall
send UAR with Authorization Type set to REGISTRATION_AND_CAPABILITIES to the
HSS to explicitly request S-CSCF capabilities. After re-assignment of another
S-CSCF according to the S-CSCF capabilities, the I-CSCF shall forward the
REGISTER to the new S-CSCF _. For registrations and re-registrations, S-CSCF
shall proceed with the registration procedure as for initial registration,
except for the clauses specified in 4.2.3._
_For de-registrations, S-CSCF shall proceed as for user-initiated de-
registration._
### 4.2.3 S-CSCF Restoration during Registration Process
During the registration procedure, the HSS shall send all the registered
Private User Identities sharing the same Public User Identity which is being
registered in the SAA, in addition to the basic user data to the S-CSCF.
Subject to the operator policy, the HSS may include the S-CSCF restoration
information for the registered Public User Identity in the response. Then the
S-CSCF compares the registered Private User Identities received from the HSS
with the ones it stores. If there are any registered Private User Identities
the S-CSCF does not have their registration data, the S-CSCF shall send SAR
with Server Assignment Type set to NO_ASSIGNMENT to the HSS to retrieve the
S-CSCF restoration information for the registered Public User Identity. If
there are S-CSCF restoration information related to the Public User Identity
stored in the HSS, the HSS shall send the S-CSCF restoration information
together with the user profile in the SAA to the S-CSCF. The result code shall
be set to DIAMETER_SUCCESS. Subject to the operator policy, sending this SAR
with Server Assignment Type set to NO_ASSIGNMENT may be skipped if the S-CSCF
restoration information for the registered Public User Identity information
was already received from the HSS.
If there are more than one group of S-CSCF restoration information related to
the Public User Identity stored in the HSS, which may happen if the Public
User Identity is shared by multiple Private User Identities, the HSS shall
include all of the S-CSCF restoration information in the SAA. One group of
S-CSCF restoration information corresponds to one Private User Identity.
If the S-CSCF receives an initial registration request for a Public User
Identity that does not match any Public User Identity currently registered
with the same Private User Identity as in the request at this S-CSCF, the
S-CSCF shall check whether there is a reg-id parameter in the Contact header
in the SIP REGISTER message and whether there is an \"sos\" SIP URI parameter
in the SIP REGISTER message. Only when a reg-id parameter exists and an
\"sos\" SIP URI parameter does not exist, the S-CSCF shall indicate to the HSS
that the registration is related to a multiple registration.
If the HSS receives an SAR request with multiple registration indication, and
the Public User Identity is stored as registered in the HSS, and there is
restoration information related to the Private User Identity, the HSS shall
not overwrite stored restoration information, instead, it shall send the
stored S-CSCF restoration information together with the user profile in the
SAA. Subject to the operator policy, the HSS may include all the S-CSCF
restoration information groups associated to the registered Public User
Identity in the response. The result code shall be set to
DIAMETER_ERROR_IN_ASSIGNMENT_TYPE. The S-CSCF shall send a new SAR with
Server-Assignment-Type set to RE_REGISTRATION and t _he_ User Data Already
Available parameter set to USER_DATA_ALREADY_AVAILABLE to update the
restoration information in the HSS in accordance to the current registration
event.
If the S-CSCF receives a user-initiated deregistration request for a Public
User Identity that does not match any Public User Identity currently
registered with the same Private User Identity as in the request at this
S-CSCF, the S-CSCF shall check whether there is a reg-id parameter in the
Contact header in the received SIP REGISTER message,
\- if a reg-id parameter exists, the S-CSCF shall:
1\. Send SAR with Server-Asignment-Type set to NO_ASSIGNMENT to retrieve the
S-CSCF restoration information associated with the Public User Identity. The
Result-Code shall be set to DIAMETER SUCCESS.
2\. Compare the contact address(es) received in SAA with the contact
address(es) in REGISTER request:
\- If they are not the same, the S-CSCF shall send SAR with Server-Asignment-
Type set to RE_REGISTRATION to update the S-CSCF restoration information in
HSS with the Contact address(es) still associated with the Public User
Identity after the deregistration event.
Otherwise, the S-CSCF shall send SAR with Server-Asignment-Type set to
USER_DEREGISTRATION.
## 4.3 UE Terminating Procedure
### 4.3.1 Introduction
The following clauses specify the behaviour of HSS, I-CSCF and S-CSCF if they
support the IMS Restoration feature.
### 4.3.2 S-CSCF Restoration after Restart
The S-CSCF _lost all user data if it restarts after a failure or_ it is unable
to trust any data after it resumes operation, due to the fact that it may have
lost profile updates from the HSS in the service interruption period. If such
a S-CSCF receives a terminating service request from the I-CSCF, it sends an
SAR to the HSS for unregistered service data. In this case, HSS and S-CSCF
proceed as indicated in 3GPP TS 29.228 [3], except that
\- if the Public User Identity is stored as registered in the HSS, and there
are S-CSCF restoration information related to the Public User Identity stored
in the HSS, the HSS shall send the S-CSCF restoration information together
with the user profile in the SAA. The result code shall be set to
DIAMETER_ERROR_IN_ASSIGNMENT_TYPE. The S-CSCF shall trigger matched registered
services for the Public User Identity.
If there are more than one group of S-CSCF restoration information related to
the Public User Identity, which may happen if the Public User Identity is
shared by multiple Private User Identities, the HSS shall include all of the
S-CSCF restoration information in the SAA. One group of S-CSCF restoration
information corresponds to one Private User Identity.
If the S-CSCF restoration information received includes the UE's subscription
information, the S-CSCF shall construct a NOTIFY message according to the
information and send it to the UE (or UEs if the IMPU is shared between
several IMPIs) to trigger a new registration at anytime after normal
processing of the terminating request.
### 4.3.3 S-CSCF Restoration after Failure
If the S-CSCF returned by the HSS during location query procedure fails, the
I-CSCF is unable to contact the S-CSCF during terminating procedure. In this
case, the I-CSCF shall send LIR to the HSS to explicitly request S-CSCF
capabilities. If the HSS returns the S-CSCF capabilities to the I-CSCF, after
re-selection of another S-CSCF according to the S-CSCF capabilities, the
I-CSCF shall forward the service request to the new S-CSCF _. The HSS and this
new S-CSCF shall behave as described in clause 4.3.2, except that the HSS
shall overwrite the S-CSCF name when receiving the SAR request, only if there
is a previous explicit LIR request for S-CSCF capabilities._
NOTE: If the HSS indicates during location query procedure that the server
name returned corresponds to an AS, then the service request is for PSI direct
routing. In this case, IMS Restoration Procedures will not be executed and
I-CSCF will reject the service request.
## 4.4 UE Originating Procedure
### 4.4.1 Introduction
The following clauses specify the behaviour of HSS, S-CSCF and P-CSCF if they
support the IMS Restoration feature.
### 4.4.2 S-CSCF Restoration after Restart
The S-CSCF _lost all user data if it restarts after a failure or_ it is unable
to trust any data after it resumes operation, due to the fact that it may have
lost profile updates from the HSS in the service interruption period. If such
a S-CSCF receives an originating request different from SIP REGISTER coming
from the UE, the S-CSCF shall send SAR to the HSS with Server Assignment Type
set to NO_ASSIGNMENT to restore the user data. If the S-CSCF name sent in the
Server-Assignment-Request command and the previously assigned S-CSCF name
stored in the HSS are different, which may happen if S-CSCF reassignment
occurred during a terminating restoration before, the HSS shall not overwrite
the S-CSCF name; instead it shall send a response to the S-CSCF with result
code set to DIAMETER_UNABLE_TO_COMPLY, as specified in the 3GPP TS 29.228 [3].
If there are S-CSCF restoration information related to the Public User
Identity stored in the HSS, the HSS shall send the S-CSCF restoration
information together with the user profile in the SAA to the S-CSCF. If the
HSS returns an error DIAMETER_UNABLE_TO_COMPLY to the S-CSCF, the S-CSCF shall
then return a specific error response to the UE to trigger a new registration.
If there are more than one group of S-CSCF restoration information related to
the Public User Identity stored in the HSS, which may happen if the Public
User Identity is shared by multiple Private User Identities, the HSS shall
include all of the S-CSCF restoration information in the SAA. One group of
S-CSCF restoration information corresponds to one Private User Identity.
If authentication of SIP request methods initiated by the UE excluding
REGISTER is desired according to operator's policy, for other authentication
schemes different from IMS-AKA, the S-CSCF requires authentication information
(e.g. authentication vectors). If this information is not stored in the
S-CSCF, the S-CSCF shall fetch that information from the HSS by means of the
authentication procedures (Cx-MAR/MAA).
NOTE 1: The S-CSCF restoration information includes authentication scheme
information (SIP-Authentication-Scheme). It allows the S-CSCF to identify the
corresponding scheme for authentication when multiple schemes are supported.
NOTE 2: The authentication information (e.g. authentication vectors) was
retrieved by the S-CSCF from the HSS for the authentication of REGISTER
requests and it can be stored locally. This data may be lost after the S-CSCF
restart.
If the S-CSCF receives SAA with the service profile of the user, the S-CSCF
shall continue the originating service as normal.
If the S-CSCF receives SAA with S-CSCF restoration information and the S-CSCF
restoration information includes the UE's subscription information, the S-CSCF
shall construct a NOTIFY message according to the information and send it to
the UE (or UEs if the IMPU is shared between several IMPIs) to trigger a new
registration at anytime after normal processing of the originating request.
### 4.4.3 S-CSCF Restoration after Failure
If the UE initiates an originating service request different from SIP REGISTER
and the P-CSCF is unable to contact the S-CSCF in the Route, the P-CSCF shall
return a specific error response to the UE to trigger a new registration.
## 4.5 SIP-AS Originating Procedure
### 4.5.1 Introduction
The following clauses specify the behaviour of HSS, I-CSCF and S-CSCF if they
support the IMS Restoration feature.
### 4.5.2 S-CSCF Restoration after Restart
The S-CSCF _lost all user data if it restarts after a failure or_ it is unable
to trust any data after it resumes operation, due to the fact that it may have
lost profile updates from the HSS in the service interruption period. If such
S-CSCF receives an originating request on behalf of a user (i.e. top-most
route header in request contains \"orig\" parameter) coming from an AS, the
S-CSCF shall send SAR to the HSS with Server Assignment Type set to
UNREGISTERED_USER to inform the HSS that the user is unregistered. HSS and
S-CSCF proceed as indicated in 3GPP TS 29.228 [3], except that:
\- if the Public User Identity is stored as registered in the HSS, and there
is S-CSCF restoration information related to the Public User Identity stored
in the HSS, the HSS shall send the S-CSCF restoration information together
with the user profile in the SAA. The result code shall be set to
DIAMETER_ERROR_IN_ASSIGNMENT_TYPE. The S-CSCF shall trigger matched
originating services for the Public User Identity.if the Public User Identity
is stored as registered in the HSS, and there is no S-CSCF restoration
information related to the Public User Identity stored in the HSS, the HSS
shall send the user profile in the SAA and set the registration state for the
Public Identity to unregistered. The result code shall be set to
DIAMETER_SUCCESS. The S-CSCF shall trigger matched originating unregistered
services for the Public User Identity.
\- if the S-CSCF name sent in the Server-Assignment-Request command and the
previously assigned S-CSCF name stored in the HSS are different, the HSS shall
not overwrite the S-CSCF name. Result Code will be
DIAMETER_IDENTITY_ALREADY_REGISTERED. The S-CSCF shall return a specific error
response to AS. The AS shall resend the request to the I-CSCF.
NOTE: The address of the S-CSCF can be obtained by AS either by querying the
HSS on the Sh interface or during third-party registration. It may happen that
if AS is using third party registration and a reassignment occurred during a
terminating request, AS will have the wrong S-CSCF name.
### 4.5.3 S-CSCF Restoration after Failure
If the application server sends the originating service request on behalf of
the user to the S-CSCF, and the S-CSCF can not be contacted, after timeout,
the application server shall resend the originating service request to the
I-CSCF _._
If the application server sends the originating service request directly to
the I-CSCF, or resends the originating service request to the I-CSCF due to
the S-CSCF can not be contacted, the I-CSCF shall behave as in section 4.3.3.
The S-CSCF and HSS shall behave as in section 4.5.2, except _that the HSS
shall overwrite the S-CSCF name when receiving the SAR request, only if there
is a previous explicit LIR request for S-CSCF capabilities._
## 4.6 S-CSCF Data Restoration Information Backup and Update Procedures
### 4.6.1 Introduction
The following clauses specify the behaviour of HSS and S-CSCF if they support
the IMS Restoration feature.
### 4.6.2 Backup and Update of S-CSCF Restoration Information during
Registration Process
The S-CSCF shall backup the following data in the HSS during the initial
registration process.
\- the list of SIP proxies in the path (normally it would be just the P-CSCF
address)
\- the Contact Information (Contact Addresses and Contact Header parameters)
\- the Authentication Information (SIP-Authentication-Scheme)
The S-CSCF may backup the following data in the HSS during the initial
registration process.
\- the Initial-CSeq-Sequence-Number and the Call-ID used if used for temporary
GRUU generation (see IETF RFC 3261 [18])
This is done with an additional information element in the SAR requesting user
information, in addition to the basic set of information required to handle
traffic, as specified in the 3GPP TS 29.228 [3]. The information is associated
with the Private User Identity and the Implicit Registration Set that is
affected by the SAR request. The HSS shall store this information.
If any of the above data is changed, the S-CSCF shall update it in the HSS
using SAR request with Server-Assignment-Type set to RE_REGISTRATION and t
_he_ User Data Already Available parameter set to USER_DATA_ALREADY_AVAILABLE,
as specified in the 3GPP TS 29.228 [3].
### 4.6.3 Backup and Update of S-CSCF Restoration Information after UE's
Subscription
If the S-CSCF receives the UE's subscription to notification of the reg-event
for the first time, the S-CSCF shall send an SAR to the HSS to store _the
following UE's subscription information._
\- Call-ID, From, To, Record-Route, Contact
_To avoid frequent storing of the subscription information in the HSS, the
CSeq should not be included in the S-CSCF restoration information. Instead,
the CSCF shall ensure that subsequent notification after retrieving this data
includes a sufficiently large Cseq value so that the UE is able to accept it._
This is done with _Server Assignment Type set to_ RE_REGISTRATION and t _he_
User Data Already Available parameter set to USER_DATA_ALREADY_AVAILABLE in
the SAR, as specified in the 3GPP TS 29.228 [3]. The information is associated
with the Private User Identity affected by the SAR request. The HSS shall
store this information.
If any of the above data is changed, the S-CSCF shall update it in the HSS
using SAR request with Server-Assignment-Type set to RE_REGISTRATION and t
_he_ User Data Already Available parameter set to USER_DATA_ALREADY_AVAILABLE,
as specified in the 3GPP TS 29.228 [3].
The S-CSCF shall send the registration data together with the subscription
data as one S-CSCF restoration information. Each time the HSS receives the
S-CSCF restoration information related to the same Private User Identity in
the SAR with Server-Assignment-Type set to RE_REGISTRATION, the HSS shall
overwrite the previous S-CSCF restoration information.
# 5 Recovery after P-CSCF failure
## 5.0 General
The following clauses show the requirements and information flows of IMS
Restoration Procedures for the P-CSCF service interruption in each of the
scenarios where they apply.
Procedures over S9 between V-PCRF and H-PCRF are not supported in this release
of the specification.
## 5.1 Update PDP context/Bearer at P-CSCF failure
These flows show the procedures performed by the network at P-CSCF failure
after user initiated registration..
### 5.1.1 General requirements
The following points are considered as requirements for the purpose of these
procedures.
1\. P-CSCF discovery is performed by requesting and provisioning P-CSCF
address(es) within Protocol Configuration Options (PCO), as specified in 3GPP
TS 29.061 [9], subclause 13a.2.1
2\. The UE supports PCO IE, as specified in 3GPP TS 24.008 [4], subclause
10.5.6.3.
3\. For the GTP based S5 interface, GTPv1, as specified in 3GPP TS 29.060 [8]
or GTPv2, as specified in 3GPP TS 29.274 [10] are supported by the GGSN/PDN-
GW.
4\. For the PMIP based S5 interface, PMIPv6, as specified in 3GPP TS 29.275
[15] is supported by the PDN-GW.
### 5.1.2 Network recovery information flow - Update PDP context / Bearer
Figure 5.1.2a: P-CSCF failure (new list of P-CSCFs in PCO)
1\. The UE initiates an IP-CAN session.
2\. P-CSCF discovery is performed. A list of P-CSCF addresses is received in
CreatePDPContextResponse / CreateBearerResponse within the PCO IE.
3\. The GGSN/PDN-GW sends CCR to request for PCC rules, as specified in 3GPP
TS 29.212 [6].
4\. The PCRF provides PCC rules to be applied in CCA.
5\. The UE performs an initial registration towards a P-CSCF from the received
list.
6\. The P-CSCF sends Rx Push (see 3GPP TS 29.214 [7]) to provide the PCRF with
the P-CSCF selected by the UE.
7\. The PCRF sends Rx Push reponse.
8\. The PCRF uses a Gx push procedure to provide the GGSN/PDN-GW with the
P-CSCF address.
9\. The GGSN/PDN-GW stores this address for the UE and sends Gx Push Rsp.
Also, the GGSN/PDN-GW starts monitoring the health of the P-CSCF if not
already done.
10\. The P-CSCF sends 200 OK to the UE.
11\. A failure in P-CSCF is detected via Gi/sGi by the GGSN/PDN-GW. The
GGSN/PDN-GW sends a new PCO IE with a new list of P-CSCF addresses (which does
not include the failed P-CSCF) to all UEs associated to the failed P-CSCF
address.
12\. The UEs acknowledge the request.
13\. Upon receiving the new list of P-CSCFs, if the P-CSCF in use is missing,
each UE performs an initial registration towards a new P-CSCF.
### 5.1.3 Network recovery information flow with S5 PMIP
Figure 5.1.3: P-CSCF failure with S5 PMIP
1 \~ 10. The IMS session is setup as described in subclause 5.1.2 except S5
PMIP procedure is used between SGW and PGW.
11\. Once a P-CSCF failure is detected via Gi/sGi by the PDN-GW, the PDN-GW
shall send a PMIP UPN message (MN ID, APN, PDN connection ID, PCO, and
Additional parameters) as specified in 3GPP TS 29.275 [15] and IETF draft-
ietf-netext-update-notifications-12 [16]. The PCO contains a new list of
P-CSCF address. The Notification reason shall indicate that update Bearer
Context at P-CSCF failure is needed.
12\. If the SGW supports the PMIP Update Notification message, it shall send
Update Bearer Request message with the new list of P-CSCF address in the PCO
to the MME/SGSN as part of the PGW initiated bearer modification without QoS
update procedure as specified in 3GPP TS 23.401[17].
> Once the Update Bearer Response message is received, the SGW shall response
> with a PMIP UPA message (MN ID, APN, PDN connection ID, PCO, and Additional
> parameters) as specified in 3GPP TS 29.275 [15] and IETF RFC 7077 [16].
13\. If the PGW knows the SGW does not support the PMIP Update Notification
procedure, the PGW shall skip step 11 and release the PMIP binding with cause
code \"Reactivation Requested\".
14\. Upon receiving the new list of P-CSCFs, the UE may perform an initial
registration towards a new P-CSCF.
## 5.2 Inform UE about P-CSCF failure
These flows show the procedures performed by the network at P-CSCF failure
after user initiated registration..
### 5.2.1 General requirements
The following points are considered as requirements for the purpose of these
procedures.
1\. P-CSCF discovery is performed by requesting P-CSCF address(es) via DHCP
method, as specified in 3GPP TS 29.061 [9], subclause 13a.2.1
2\. The UE supports PCO IE, as specified in 3GPP TS 24.008 [4], subclause
10.5.6.3.
3\. For the GTP based S5 interface, GTPv1, as specified in 3GPP TS 29.060 [8]
or GTPv2, as specified in 3GPP TS 29.274 [10] are supported by the GGSN/PDN-GW
4\. For the PMIPv6 based S5 interface, PMIPv6, as specified in 3GPP TS 29.275
[15] is supported by the PDN-GW.
### 5.2.2 Network recovery information flow -- Inform UE at P-CSCF failure
Figure 5.2.2a: P-CSCF failure for DHCP based scenarios
> 1-2. The UE initiates an IP-CAN session.
>
> 3\. P-CSCF discovery is performed using DHCP based method. The GGSN/PDN-GW
> relays/send the list of P-CSCF addresses in DHCP response.
NOTE: The DHCP response can include either a list of P-CSCF IPv4/IPv6
addresses or a list of FQDNs (see IETF RFC 3361 [11] and IETF RFC 3319 [13]).
If P-CSCF FQDNs were provided, the UE uses DNS SIP server resolution mechanism
(see IETF RFC 3263 [12])
> 4\. The GGSN/PDN-GW sends CCR to request for PCC rules, as specified in 3GPP
> TS 29.212 [6].
>
> 5\. The PCRF provides PCC rules to be applied in CCA.
>
> 6\. The UE performs an initial registration towards the P-CSCF received.
>
> 7\. The P-CSCF sends Rx Push (see 3GPP TS 29.214 [7]) to provide the PCRF
> with the P-CSCF selected by the UE,
>
> 8\. The PCRF sends Rx Push reponse.
>
> 9\. The PCRF uses a Gx push procedure to provide the GGSN/PDN-GW with the
> P-CSCF address.
>
> 10\. The GGSN/PDN-GW stores this address for the UE and sends Gx Push Rsp.
> Also, the GGSN/PDN-GW starts monitoring the health of the P-CSCF if not
> already done.
>
> 11\. The P-CSCF sends 200 OK to the UE.
>
> 12\. A failure in P-CSCF is detected via Gi/sGi by the GGSN/PDN-GW. The
> GGSN/PDN-GW informs to all UEs associated to the failed P-CSCF address that
> the P-CSCF is not available.
>
> 13\. The UEs acknowledge the request.
>
> 14\. The UE requests P-CSCF addresses (if needed) via new DHCP request.
>
> 15\. The UE selects a new P-CSCF and initiates an initial IMS registration.
### 5.2.3 Network recovery information flow -- Inform UE at P-CSCF failure
with S5 PMIP
Figure 5.2.3-1: P-CSCF failure for DHCP based scenarios with S5 PMIP
1 \~ 11. Same as figure 5.2.2a step 1 \~ 11
12\. A failure in P-CSCF is detected via Gi/sGi by the GGSN/PDN-GW. The
GGSN/PDN-GW informs to all UEs associated to the failed P-CSCF address that
the P-CSCF is not available.
\- The PDN-GW shall send a PMIP UPN message (MN ID, APN, PDN connection ID,
PCO, and Additional parameters) as specified in 3GPP TS 29.275 [15] and IETF
RFC 7077 [16]. The PCO contains a P-CSCF failure Indicator. The Notification
reason shall indicate that there is a P-CSCF failure.
\- If the SGW supports the PMIP Update Notification message, it shall send
Update Bearer Request message with the P-CSCF failure Indicator in the PCO to
the MME as part of the PGW initiated bearer modification without QoS update
procedure as specified in 3GPP TS 23.401 [17]. Once the Update Bearer Response
message is received, the SGW shall response with a PMIP UPA message (MN ID,
APN, PDN connection ID, PCO, and Additional parameters) as specified in 3GPP
TS 29.275 [15] and IETF RFC 7077 [16].
\- If the PGW knows the SGW does not support the PMIP Update Notification
procedure, the PGW may release the PMIP binding with cause code \"Reactivation
Requested\".
13 \~ 15. Same as figure 5.2.2a step 13 \~15.
### 5.3 Network recovery information flow -- UE uses keep alive mechanism
Figure 5.3a: P-CSCF failure detected by UE
1\. After establishment of an IP-CAN session and acquiring P-CSCF addresses,
the UE performs initial registration towards a P-CSCF.
2\. If registration is successful, the UE monitors the P-CSCF health according
to IETF RFC 6223 [14]
3\. When a failure is detected, the UE acquires new P-CSCF addresses (if
needed) and performs an initial registration.
## 5.4 HSS-based P-CSCF restoration for 3GPP access
### 5.4.1 Introduction
The HSS-based P-CSCF restoration described in the subclause 5.4 is an optional
mechanism which applies when the UE is using a 3GPP access for the IMS PDN
connection.
When supported, this mechanism shall be executed when a terminating request
cannot be serviced due to a P-CSCF failure, as long as there are no other
registration flows for this terminating UE using an available P-CSCF.
The HSS-based P-CSCF restoration consists of a basic mechanism that makes
usage of a path through HSS and MME/SGSN to request the release of the IMS PDN
connection to the corresponding UE, as described in subclause 5.4.2; and an
optional extension that avoids the IMS PDN deactivation and re-activation, as
described in subclause 5.4.3.
### 5.4.2 Description
#### 5.4.2.1 General
The call flow for the HSS-based P-CSCF restoration mechanism is described in
figure 5.4.2.1-1. The nodes included in this call flow shall execute following
procedures if they support the HSS-based P-CSCF restoration mechanism.
Figure 5.4.2.1-1: HSS-based P-CSCF restoration
1\. The terminating S-CSCF receives a SIP message for a destination UE.
2\. The S-CSCF forwards the SIP message to this called UE's terminating
P-CSCF.
3\. The S-CSCF shall identify whether the called UE's terminating P-CSCF is
not able to process this request, based on received error codes (i.e. the UE
registration data is not present) or no response. In this case, the following
steps shall apply to execute the HSS-based P-CSCF restoration. For more
information about S-CSCF failure detection, see subclause 5.4.2.2.
4\. The S-CSCF shall check the registration status of the Public User Identity
associated to the called UE. If the registration state of the Public User
Identity is Registered, the S-CSCF shall check if the Public User Identity is
currently registered with one or more Private User Identities.
\- If the Public User Identity is currently registered with only one Private
User Identity, the S-CSCF shall unregister this Public User Identity by
sending a Cx SAR to the HSS, including a P-CSCF Restoration indication.
\- If the Public User Identity is currently registered with more than one
Private User Identity, the S-CSCF shall send a deregistration request to the
HSS for the corresponding Public User Identity and Private User Identity pair
via Cx SAR, including a P-CSCF Restoration indication.
5\. The HSS shall identify whether the MME/SGSN supports HSS-based P-CSCF
restoration based on feature support information provided by the MME/SGSN as
described in subclause 5.4.2.3, then when the HSS receives a Cx SAR with a
P-CSCF Restoration indication, it shall check whether the serving node(s) for
corresponding user support this feature:
\- if at least one of the serving nodes support the feature:
\- the HSS shall send a P-CSCF restoration indication to the supporting
serving node(s) where the IMSI associated to the received Private Identity is
registered, i.e. SGSN and/or MME, using S6a/S6d IDR/IDA or Gr ISD
request/answer; and
\- the HSS shall perform either the unregistration or deregistration requested
and it shall send a successful response to the S-CSCF via Cx SAA. The S-CSCF
shall set respectively this Public User Identity as Unregistered or this UE as
not registered.
NOTE 1: The S-CSCF can start a P-CSCF Restoration Ongoing Timer to monitor the
P-CSCF Restoration procedure. If the UE performs a new IMS registration before
this timer expires, as a result of the P-CSCF Restoration procedure execution,
the S-CSCF stops the timer. Otherwise, the S-CSCF registers again the Public
User Identity by sending a Cx SAR to the HSS and it stops the timer. The value
of the P-CSCF Restoration Ongoing Timer can consider how long the P-CSCF
Restoration execution may take, and then it can take into account factors like
paging re-transmission timers.
\- in addition, if the 3GPP AAA Server supports P-CSCF restoration for WLAN
and if the user has an IMS APN configuration subscription for a WLAN access
and is registered to a WLAN access, the procedure described in subclause
5.6.2.2 from step 5 onwards shall apply.
\- otherwise, the HSS shall provide an error response back in Cx SAA to the
S-CSCF.
NOTE 2: In case there is not homogeneous support of this feature in
corresponding user serving nodes, the P-CSCF Restoration procedure may be
triggered as long as one serving node supports this feature, but if the UE is
only reachable in the non-supporting serving node, the restoration procedure
is not successful.
6\. The S-CSCF shall send a SIP response back to the originating side. This
shall be an error response if only one Private User Identity is registered,
since the S-CSCF is not able to progress the request; otherwise the S-CSCF
shall select the best possible response following normal forking procedures.
> Subject to an operator policy, the error response sent by S-CSCF may in
> addition inform the originating side that a terminating request reattempt is
> possible based on timer expiration.
NOTE 3: Steps 4 and 6 above are not required to be in this order, reverse
order is also possible.
7\. Upon reception of the P-CSCF Restoration indication from the HSS, the
MME/SGSN from the received IMSI shall identify if the MM context of the UE
exists and if the UE has an IMS PDN connection context. If either the MM
context or the IMS PDN connection context does not exist, the MME/SGSN shall
discard the P-CSCF Restoration indication without further processing;
otherwise the MME/SGSN shall continue as below.
NOTE 4: GSMA PRD IR.65 [21] clause 2.3 recommends one single IMS APN in case
of simultaneous usage of VoLTE and RCS.
> The MME/SGSN shall check the UE state:
\- If the UE is in ECM-IDLE state, the MME/SGSN shall page the UE.
\- If the UE is initially in ECM-CONNECTED state or when it gets a response
from the UE after paging:
\- If ISR is active, the MME/SGSN shall send a message, via the S3 interface,
to stop paging the UE at the other ISR-associated node; and
\- The MME/SGSN shall execute the optional PCO-based optional extension to
this mechanism as described in subclause 5.4.3, if this optional extension is
supported by the MME/SGSN and by the serving SGW/PGW; otherwise it shall
proceed as below.
NOTE 5: The support of this feature by the serving SGW/PGW is determined based
on the local configuration at the MME/SGSN.
\- The SGSN, or the MME if this is not the last PDN connection of the UE,
shall release the UE's IMS PDN connection towards the UE by initiating a PDN
disconnection procedure with the NAS cause \"reactivation requested\". If this
is the last PDN connection of the UE, the MME shall initiate a detach
procedure with the NAS cause code \"reactivation requested\". Additionally,
the MME/SGSN shall also release the same PDN connection towards the SGW/PGW by
sending Delete Session message (not shown in the figure).
8\. As a result of the release of the IMS PDN connection, the UE shall
activate the IMS PDN connection, select an available P-CSCF and perform a new
initial IMS registration, as per 3GPP TS 29.061 [9].
#### 5.4.2.2 P-CSCF restart/failure detection by S-CSCF
##### 5.4.2.2.1 General
If the P-CSCF is not reachable, the S-CSCF does not receive any SIP response
when it sends a request. In this case, the S-CSCF shall consider the P-CSCF to
be non-reachable. As long as the S-CSCF considers the P-CSCF to be non-
reachable, the S-CSCF shall not try to contact again this P-CSCF for
subsequent terminating requests. The S-CSCF shall consider the P-CSCF to be
reachable as soon as a SIP request, including REGISTER, is received from that
P-CSCF.
Various mechanisms can be used for the S-CSCF to detect a non-reachable
P-CSCF, e.g. keep-alive mechanisms or expiry of timers.
If the P-CSCF is reachable, but it is not able to process the request, it
shall send an error indication to the S-CSCF.
##### 5.4.2.2.2 Direct connection from S-CSCF to P-CSCF
This is the normal case when the terminating user is not roaming.
When the S-CSCF receives a terminating request towards a UE registered to a
P-CSCF that is not considered non-reachable, the S-CSCF shall forward the
request to the P-CSCF. If the P-CSCF does not respond, after a pre-defined
number of retransmissions, the S-CSCF shall consider the P-CSCF to be non-
reachable.
##### 5.4.2.2.3 S-CSCF connection to P-CSCF via IBCF/ATCF
This is the normal case when the terminating user is roaming and there are
IBCFs between the S-CSCF and the P-CSCF. It can also be that an ATCF is
inserted between the S-CSCF and the P-CSCF.
In this case, the SIP node closest to the P-CSCF shall identify when the
P-CSCF is not reachable. It rejects the request with a SIP error response with
an indication that the P-CSCF is not reachable.
#### 5.4.2.3 MME/SGSN mechanism support
If the MME/SGSN supports this mechanism, it shall indicate support of this
feature to the HSS in S6a/S6d ULR. If support is indicated, this information
shall be stored by HSS per MME/SGSN.
### 5.4.3 PCO-based optional extension
#### 5.4.3.1 Introduction
The HSS-based P-CSCF basic mechanism is optionally extended by reusing part of
the \"Update PDP context/bearer at P-CSCF failure\" mechanism described in
subclause 5.1, in order to avoid the need to deactivate and reactivate the IMS
PDN connection.
This extension is based on the possibility for the P-GW/GGSN to know whether
or not the UE supports the \"Update PDP context/bearer at P-CSCF failure\"
mechanism. This is described in subclause 5.4.3.3.
#### 5.4.3.2 Description
This procedure is described by figure 5.4.3.2-1 (for EPC) and 5.4.3.2-2 (for
GPRS). The nodes included in this call flow shall execute following procedures
if they support the HSS-based P-CSCF restoration mechanism.
Figure 5.4.3.2-1: PCO-based optional extension - EPC
Figure 5.4.3.2-2: PCO-based optional extension - GPRS
Steps from 1 to 6 are the same as explained in figure 5.4.2.1-1 above.
7\. The MME/SGSN shall send Modify Bearer Request / Update PDP Context Request
to the P-GW/GGSN for this associated PDN connection with a P-CSCF Restoration
indication.
> The MME/S4 SGSN shall provide this indication to the P-GW via the S-GW. When
> the Modify Bearer Request is received by the S-GW with the P-CSCF
> Restoration indication, this message shall be forwarded to the P-GW.
8\. Upon reception of the P-CSCF Restoration indication, the P-GW/GGSN shall
check whether the UE has indicated it supports "Update PDP context/bearer at
P-CSCF failure\" mechanism, as described in subclause 5.4.4.3:
\- if supported, the PGW/GGSN shall send Update Bearer Request / Update PDP
Context Request to the MME/SGSN with the list of available P-CSCF addresses
within PCO IE to update destination UE. The list of available P-CSCFs may
contain the address of the P-CSCF used by the UE if this P-CSCF has restarted
and is again available.
\- if not supported, the P-GW/GGSN shall release the IMS PDN connection/PDP
context by sending a Delete Bearer Request / Delete PDP Context Request to the
MME/SGSN with GTP cause \"reactivation requested\".
9\. Upon reception of the Update Bearer Request / Update PDP Context Request,
the MME/SGSN shall send an Update EPS Bearer Context Request / Modify PDP
Context Request to the UE, including the PCO with the list of available P-CSCF
addresses; otherwise, upon reception of a Delete Bearer Request / Delete PDP
Context Request, the MME/SGSN shall send a Delete EPS Bearer Context Request /
Delete PDP Context Request to the UE with the NAS cause \"reactivation
requested\", then once the PDN connection is released, the UE shall re-
activate the IMS PDN connection.
10\. The UE selects an available P-CSCF. If the UE has received a Modify EPS
Bearer Context Request / Modify PDP Context Request, the UE shall select one
available P-CSCF from the list for IMS registration and perform a new initial
IMS registration.
#### 5.4.4.3 UE indication of support for \"Update PDP context/bearer at
P-CSCF failure\" Restoration
This optional extension is based on the possibility for the P-GW/GGSN to
identify whether or not the UE supports \"Update PDP context/bearer at P-CSCF
failure\", as described in subclause 5.1 and 3GPP TS 24.229 [19] (subclauses
B.2.2.1C and L.2.2.1C).
The UE shall indicate this capability to the P-GW/GGSN at the activation of
the IMS PDN connection /PDP context, in a PCO parameter as described in 3GPP
TS 24.008 [4] subclause 10.5.6.3. The P-GW/GGSN shall store this UE
capability.
This method has no impact on the MME/SGSN or SGW, as PCO information is
transparently transferred through these network elements.
### 5.4.5 Coexistence with \"Update PDP context/bearer at P-CSCF failure\"
mechanism
If the \"Update PDP context/bearer at P-CSCF failure\" mechanism is deployed,
as soon as a P-CSCF failure is detected, as described in subclause 5.1, it
triggers massive radio signalling first and then massive IMS registration.
Therefore, the HSS-based P-CSCF restoration triggering use case does not occur
in most cases, and benefits are minimal; i.e., in case of coexistence, the
\"Update PDP context/bearer at P-CSCF failure\" mechanism takes precedence
over the HSS-based P-CSCF restoration mechanism in most cases. Hence, if the
optional HSS-based P-CSCF restoration is deployed in a network, the
recommendation is to only deploy the HSS-based P-CSCF restoration.
### 5.4.6 HSS based P-CSCF restoration in roaming scenarios
The considered roaming scenarios are the ones described in 3GPP TS 23.401
[17], clause 4.2.2.
For these roaming scenarios, when the VPLMN and the HPLMN both support the HSS
based P-CSCF restoration mechanism, this mechanism shall be used for P-CSCF
restoration. The HPLMN shall be aware that the VPLMN supports the HSS based
P-CSCF restoration mechanism by signalling from the VPLMN. The HPLMN should
not trigger a P-CSCF restoration otherwise.
For the roaming scenarios when either the VPLMN or the HPLMN does not support
the HSS based P-CSCF restoration mechanism, then the PGW/GGSN which is located
in network supporting the HSS based mechanism, depending on operator policy,
may apply:
\- no P-CSCF restoration mechanism; or
\- another existing mechanism e.g. the \"Update PDP context/bearer at P-CSCF
failure\" mechanism described in subclause 5.1. The PGW/GGSN shall be aware
(e.g. by local configuration) that the HSS based P-CSCF restoration mechanism
cannot be used.
NOTE: The PGW/GGSN identifies the roaming or non-roaming scenario based on the
serving PLMN-ID and IMSI received from the MME/SGSN at the PDN connection
establishment.
## 5.5 PCRF-based P-CSCF restoration
### 5.5.1 Introduction
The PCRF-based P-CSCF restoration is an optional mechanism.
This mechanism is executed when a terminating request does not proceed due to
a P-CSCF failure, as long as there are no other registration flows for this
terminating UE using an available P-CSCF.
The PCRF-based P-CSCF restoration consists of a basic mechanism that makes
usage of a path through an alternative P-CSCF and PCRF to request the release
of the IMS PDN connection to the corresponding UE, as described in clause
5.5.2; and an optional extension that avoids the IMS PDN deactivation and re-
activation, as described in clause 5.5.3.
### 5.5.2 PCRF-based P-CSCF restoration information flow - deactivate PDN
connection/PDP context
The following figures illustrate the details of PCRF-based P-CSCF restoration
information flow.
The nodes included in this call flow shall execute following procedures if
they support the PCRF-based P-CSCF restoration mechanism.
Figure 5.5.2-1: PCRF based P-CSCF restoration
This call flow provides two options for termination call being treated.
Option a) makes terminating UE to be deregistered until next re-registration.
Option b) continues terminating call after successful re-IMS registration.
1\. The S-CSCF receives a terminating INVITE message.
2a. The S-CSCF shall populate IMSI into the terminating INVITE message. IMSI
is maintained in the S-CSCF, which is obtained from HSS when the UE registers.
Then the S-CSCF shall forward the Terminating INVITE message to alternative
P-CSCF. The alternative P-CSCF is chosen by local configuration.
NOTE 1: The IMSI is used by the alternative P-CSCF to find the associated PCRF
associated for the UE. The IMSI information is subtracted in P-CSCF.
2b. The S-CSCF shall populate IMSI into the terminating INVITE message. IMSI
is maintained in the S-CSCF, which is obtained from HSS when the UE registers.
Then the S-CSCF shall forward the terminating INVITE message to visited
network.
2c. If IBCF or ATCF next to the failed P-CSCF has detected the P-CSCF failure,
IBCF or ATCF shall forward the terminating INVITE message to alternative
P-CSCF. The alternative P-CSCF is chosen by local configuration.
3\. The alternative P-CSCF shall send SIP ERROR message to the S-CSCF.
4a. If option a) is chosen, the S-CSCF shall check the registration status of
the Public User Identity associated to the called UE. If the registration
state of the Public User Identity is registered, the S-CSCF shall check if the
Public User Identity is currently registered with one or more Private User
Identities.
\- If the Public User Identity is currently registered with only one Private
User Identity, the S-CSCF shall unregister this Public User Identity sending a
Cx SAR/SAA to HSS. If the response is successful, the S-CSCF shall set this
Public User Identity as Unregistered.
\- If the Public User Identity is currently registered with more than one
Private User Identity, the S-CSCF shall send a deregistration to HSS for the
corresponding Public User Identity and Private User Identity pair via Cx
SAR/SAA. If the response is successful, the S-CSCF shall set this UE as not
registered.
NOTE 2: the S-CSCF can start a P-CSCF Restoration Ongoing Timer to monitor the
P-CSCF Restoration procedure. If the UE performs the new IMS registration
before this timer expires, as a result of the P-CSCF Restoration procedure
execution, the S-CSCF stops the timer. Otherwise, the S-CSCF registers again
the Public User Identity by sending a Cx SAR to the HSS and it stops the
timer. The value of the P-CSCF Restoration Ongoing Timer can consider how long
the P-CSCF Restoration execution may take, and then it can take into account
factors like paging re-transmission timers.
4b. If option a) is chosen the S-CSCF shall send a SIP response back to the
originating side. This shall be an error response if only one Private User
Identity is registered; otherwise the S-CSCF shall select the best possible
response following normal forking procedures.
5\. The alternative P-CSCF shall send an Rx AAR message with the P-CSCF
restoration indication to the associated PCRF, the associated PCRF is found by
UE's IP address (if available), IP Domain (if UE's IP address is provided and
IP address overlapping can occur), IMSI and APN. The APN and IP Domain are set
based on local configuration and additionally referring to the SDP
information, e.g. media field, on the received SIP INVITE message.
NOTE 3: When the UE's IP address is not available, the P-CSCF has to include
both IMSI and APN in the Rx AAR command.
NOTE 4: When IMSI is not available, the associated PCRF for the UE can be
found by IP address of the UE with the condition that there is no IP
translation function in the P-CSCF.
6\. The PCRF shall send an Rx AAA to the P-CSCF
7\. The PCRF shall find the IP-CAN session related to that UE based on the
available information received in step 5 and shall send a Gx RAR including the
P-CSCF restoration indication to the PDN GW/GGSN that has been associated with
that IP-CAN session. In case where the alternative P-CSCF is located in the
HPLMN and the associated PDN GW/GGSN is located in the VPLMN, in this case
both S9 interface and Gx interface are used.
8\. The PDN GW/GGSN shall send Gx RAA to the PCRF.
9\. Then the PDN GW/GGSN shall perform one of following procedures.
\- For 3GPP accesses, the PDN GW/GGSN initiates bearer deactivation procedure
for the default bearer with \"reactivation requested\", if the PDN GW/GGSN has
no knowledge whether the UE supports the \"Update PDP context/bearer at P-CSCF
failure\". If the UE supports the \"Update PDP context/bearer at P-CSCF
failure\" mechanism, step 11 and 12 in the procedure that is described in
clause 5.1 is reused instead.
\- For the S2a and S2b, the PDN GW initiates bearer deactivation procedure to
the trusted non 3GPP access domain and the ePDG, respectively.
\- For the S2c, the PDN GW/GGSN initiates detach procedure.
NOTE 5: For the S2a/b/c, it should be noted that although this procedure does
not request UE to re-attach to the IMS explicitly by signalling, it is assumed
that IMS compliant UE shall re-attempt to obtain IMS service soon after
detached from the IMS service.
10\. UE activates the PDN connection and registers to IMS. As a result of the
release of the IMS PDN connection, the voice centric UE activates the IMS PDN
connection, selects a new available P-CSCF and performs a new initial IMS
registration.
11\. If option b) is chosen, the S-CSCF shall send the suspended terminating
SIP INVITE message to a newly selected P-CSCF after the successful SIP
registration for the UE.
### 5.5.3 PCO-based optional extension
#### 5.5.3.1 Introduction
The PCRF-based P-CSCF basic mechanism is optionally extended by reusing part
of the \"Update PDP context/bearer at P-CSCF failure\" mechanism described in
clause 5.1, in order to avoid the need to deactivate and reactivate the IMS
PDN connection.
This extension is based on the possibility for the P-GW/GGSN to know whether
or not the UE supports the \"Update PDP context/bearer at P-CSCF failure\"
mechanism. This is described in clause 5.5.3.3.
#### 5.5.3.2 Description
This procedure is described by figure 5.4.3.2-1 (for EPC) starting with step
8a and 5.4.3.2-2 (for GPRS) starting with step 8. The nodes included in this
call flow shall execute following procedures if they support the PCRF-based
P-CSCF restoration mechanism.
#### 5.5.3.3 UE indication of support for \"Update PDP context/bearer at
P-CSCF failure\" Restoration
This function is identical to the HSS-based P-CSCF restoration. Refer to
5.4.4.3.
### 5.5.4 Coexistence with \"Update PDP context/bearer at P-CSCF failure\"
mechanism
If the \"Update PDP context/bearer at P-CSCF failure\" mechanism is deployed,
as soon as a P-CSCF failure is detected, as described in clause 5.1, it
triggers massive radio signalling first and then massive IMS registration.
Therefore, the PCRF-based P-CSCF restoration triggering use case does not
occur in most cases, and benefits are minimal; i.e., in case of coexistence,
the \"Update PDP context/bearer at P-CSCF failure\" mechanism takes precedence
over the PCRF-based P-CSCF restoration mechanism in most cases. Hence, if the
optional PCRF-based P-CSCF restoration is deployed in a network, the
recommendation is to only deploy the PCRF-based P-CSCF restoration.
### 5.5.5 P-CSCF restoration in roaming scenarios for PCRF based solution
In a home routed scenario, i.e., S-GW(or any other gateway node) is in VPLMN
and P-GW and P-CSCF are in HPLMN, the PCRF based solution can work sorely
within HPLMN that supports the PCRF based solution, no matter VPLMN supports
the solution or not.
The following procedures only apply to the local breakout scenario.
In roaming scenarios, the VPLMN and HPLMN operators may deploy the same or
different P-CSCF restoration mechanisms, amongst those described in subclause
5.1 (Update PDP context/bearer at P-CSCF failure), subclause 5.4 (HSS based
P-CSCF restoration) and subclause 5.5 (PCRF based P-CSCF restoration),
independently from each other.
The PCRF based P-CSCF restoration can work in roaming scenarios if:
1) Both HPLMN and VPLMN support the PCRF based P-CSCF restoration; or
2) When the HPLMN does not support the PCRF based P-CSCF restoration but VPLMN
does and NAT is not performed.
NOTE: If the HPLMN does not support the PCRF based P-CSCF restoration, IMSI
may not be available on terminating INVITE message.
Alternatively, based on the operator policy or roaming agreement, the VPLMN
can use the \"Update PDP context/bearer at P-CSCF failure\" mechanism
described in subclause 5.1.
For a terminating call to outbound roamers, the S-CSCF may not populate IMSI
to terminating INVITE message if HPLMN knows, e.g. by configuration in the
S-CSCF according to roaming agreements, that VPLMN for outbound roamer does
not support the PCRF based P-CSCF restoration.
## 5.6 P-CSCF restoration for WLAN
### 5.6.1 Introduction
The clause 5.6 describes solutions to support P-CSCF restoration for UEs with
an IMS PDN connection supported over a WLAN access.
The subclauses 5.6.2 and 5.6.3 describe the basic mechanism for the HSS-based
solution and for the PCRF-based solution. The basic mechanism relies on the
release of the IMS PDN connection followed by its re-establishment to trigger
a new IMS registration by the UE.
The subclauses 5.6.4 and 5.6.5 describe extensions for trusted WLAN and for
untrusted WLAN accesses to avoid the release of the IMS PDN connection and to
trigger a new IMS registration by the UE over the existing IMS PDN connection.
The extensions between the UE and the PGW are common for the HSS-based and for
the PCRF-based solutions and rely on the same UE behavior.
### 5.6.2 Basic mechanism for the HSS-based solution
#### 5.6.2.1 Overview and principles
The HSS-based P-CSCF restoration mechanism for WLAN extends the HSS-based
P-CSCF restoration mechanism (specified for 3GPP accesses in subclause 5.4) to
trusted and untrusted WLAN accesses and is based on the same principles to
disconnect the UE, which then re-establishes the connection via an available
P-CSCF.
If the UE is registered to the EPC via a WLAN access and has an IMS APN
subscription permitting non-3GPP accesses, the HSS forwards a P-CSCF
restoration indication to the 3GPP AAA Server which transfers it to the PGW.
Then the PGW initiates the release of the IMS PDN connection towards the UE
via the WLAN access.
Following the release of the IMS PDN connection, the UE re-establishes a new
IMS PDN connection and performs a new P-CSCF discovery (according to the
existing procedures), and then registers again to IMS.
#### 5.6.2.2 Description
The call flow for the HSS-based P-CSCF restoration mechanism for WLAN is
described in figure 5.6.2.2-1. The functional entities involved by this call
flow shall execute the following procedure if they all support the HSS-based
P-CSCF restoration for WLAN.
Figure 5.6.2.2-1: HSS-based P-CSCF restoration for WLAN
For a WLAN access, the basic mechanism to request the UE to do a new IMS
registration is to release the IMS PDN connection over the interface (S2a or
S2b) through which the UE is connected. The solution avoids disconnecting
other PDN connections than the IMS PDN one.
NOTE 1: the UE may establish multiple PDN connections via untrusted WLAN and
trusted WLAN in multi-connection mode; while there is a single SWm Diameter
session per PDN connection, there is a unique STa Diameter session per UE.
Steps 1 to 4 are common with the steps 1 to 4 of subclause 5.4.2.1.
5\. After having checked that the 3GPP AAA Server supports the HSS-based
P-CSCF restoration for WLAN, the HSS, if the user has a non-3GPP access
subscription with an IMS APN configuration and if the user has a non-3GPP
access registration in the HSS for the WLAN access, shall forward a P-CSCF
restoration indication to the 3GPP AAA Server over SWx by using a PPR command,
perform either the IMS unregistration or deregistration requested by the
S-CSCF and send a successful response to the S-CSCF via a Cx SAA command. The
S-CSCF shall set respectively this Public User Identity as unregistered or
this UE as not registered.
If the user has also an IMS APN configuration subscription for a 3GPP access
and is registered to a 3GPP access, the procedure described in subclause
5.4.2.1 from step 5 onwards shall apply in addition.
Otherwise, if the P-CSCF restoration is not triggered over WLAN or 3GPP
access, the HSS shall provide an error response in Cx SAA to the S-CSCF.
6\. Step 6 is common with step 6 described in subclause 5.4.2.1 for 3GPP
accesses.
NOTE 2: Steps 4 and 6 above are not required to be in this order, reverse
order is also possible.
7\. If the 3GPP AAA Server has the information that an IMS PDN connection is
established via a WLAN access for the user, the 3GPP AAA Server, after having
checked that the PGW supports the HSS-based P-CSCF restoration for WLAN, shall
send a P-CSCF restoration indication to the PGW over S6b in a Re-authorization
Request (RAR) command, via a 3GPP AAA Proxy over SWd if a VPLMN is involved.
NOTE 3: The PGW does not send any AA-Request (AAR) command to the 3GPP AAA
server after having received the Re-authorization Request (RAR) command in
step7, given that it will send a Session Termination Request (STR) in step 9.
NOTE 4: GSMA PRD IR.65 [21] clause 2.3 recommends one single IMS APN in case
of simultaneous usage of VoLTE and RCS. If there were two PDN connections with
the IMS APN, the reception of the P-CSCF restoration indication would result
in the release of the two IMS PDN connections although only the PDN connection
related to the failed P-CSCF should be released.
8\. The PGW shall proceed with the release of the IMS PDN connection as
follows:
\- For a TWAN access, the PGW shall initiate over the S2a interface a Delete
Bearer Request procedure (GTP) or a Proxy Mobile IPv6 LMA Initiated PDN
Connection Deletion procedure (PMIP) to the TWAN which then shall initiate:
\- a WLCP PDN Disconnection procedure towards the UE for a UE in multi
connection mode as described in 3GPP TS 24.244 [22];
\- a TWAN specific resource release procedure, in single connection mode or
transparent single connection mode;
\- For an untrusted WLAN access, the PGW shall initiate over the S2b interface
a Delete Bearer Request procedure (GTP) or a Proxy Mobile IPv6 LMA Initiated
PDN Connection Deletion procedure (PMIP) to the ePDG which then initiates the
release of the associated IKEv2 tunnel.
> A cause \"reactivation requested\" (as supported over 3GPP accesses) is
> added by the PGW over GTP-C based S2a and WLCP for TWAN and over GTP-C based
> S2b and IKEv2 for untrusted WLAN.
9\. The PGW shall indicate the termination of the associated session to the
3GPP AAA Server by sending a Session Termination Request (STR).
10\. As a result of the release of the IMS PDN connection, the UE shall re-
establish the IMS PDN connection, and also perform a new P-CSCF discovery (as
the IMS PDN connection was lost). After discovering a new P-CSCF, the UE shall
perform a new initial IMS registration towards IMS.
### 5.6.3 Basic mechanism for the PCRF-based solution
The basic mechanism for the PCRF-based P-CSCF restoration for WLAN is part of
the PCRF-based solution described in subclause 5.5.
### 5.6.4 Optional extension for the HSS and PCRF-based solutions for the TWAN
access
#### 5.6.4.1 Overview and principles
The basic mechanism for P-CSCF restoration over WLAN is optionally extended
for the TWAN access to avoid the need to deactivate and reactivate the IMS PDN
connection. This P-CSCF restoration extension applies to the HSS-based and the
PCRF-based solutions.
Upon receipt of a P-CSCF restoration indication from the 3GPP AAA Server, the
PGW may invoke this P-CSCF restoration extension procedure if
\- the UE is accessing the EPC via a TWAN in the multi-connection mode;
\- the UE indicated support of this extension for the TWAN access (as further
described in subclause 5.6.4.3); and
\- if the TWAN indicated support of the WLCP PDN connection modification
procedure.
If so, the PGW shall send the updated list of the addresses of available
P-CSCFs towards the UE via the TWAN. This triggers the UE to initiate a new
IMS registration towards an available P-CSCF over the existing IMS PDN
connection.
Otherwise, the PGW shall initiate the release of the IMS PDN connection and
proceed with the basic P-CSCF restoration mechanism specified in subclause
5.6.2 and 5.6.3.
#### 5.6.4.2 Description
The call flow for the P-CSCF restoration extension for the TWAN access is
described in figure 5.6.4.2-1. The functional entities involved by this call
flow shall execute the following procedure if they all support the P-CSCF
restoration extension for the TWAN access.
Figure 5.6.4.2-1: P-CSCF restoration extension for the TWAN access -- GTP-
based S2a
For the HSS-based solution, steps from 1 to 7 are the same as those explained
in subclause 5.6.2.2 for the P-CSCF restoration basic mechanism for WLAN**.**
In step 7, the 3GPP AAA Server, when receiving a P-CSCF restoration indication
from the HSS, transfers this indication to the PGW in a Re-authorization
Request (RAR) command, This generates an authorisation procedure (step 7a) as
according to 3GPP TS 29.273 [24].
For the PCRF-based solution, steps from 1 to 7 are the same as those explained
in subclause 5.3.2 for the P-CSCF restoration basic mechanism**.** In step 7,
the PCRF transfers the P-CSCF restoration indication to the PGW.
Hereafter steps 8 to 11 are common to the HSS-based solution and to the PCRF-
based solutions:
8\. If the PGW has previously received the indication that the UE supports the
P-CSCF restoration extension for the TWAN access and that the TWAN supports
the WLCP PDN connection modification procedure, and if the UE is accessing the
TWAN in multi-connection mode, the PGW shall send an Update Bearer Request to
the TWAN including the PCO information element set with a list of available
P-CSCF addresses,
NOTE: the TWAN reports to the PGW whether the UE is accessing the TWAN in
multi-connection mode, single-connection mode or transparent single-connection
mode, during the PDN connection establishment procedure.
9\. The TWAN shall initiate a WLCP PDN connection modification request
procedure towards the UE as described in 3GPP TS 24.244 [22] to transparently
forward the PCO information element received from the PGW.
10\. The UE shall send a response to the TWAN which then shall send an Update
Bearer Response to the PGW.
11\. As per the P-CSCF restoration procedures described in 3GPP TS 24.229
[19], the UE shall select one P-CSCF from the received list and proceed with
an IMS registration.
The same call flow applies to PMIP-based S2a, whereby, in step 8, the PGW
shall initiate an LMA Initiated Update Notification procedure to provide the
TWAN with the available P-CSCF addresses.
#### 5.6.4.3 Indication of UE support of the P-CSCF restoration extension for
the TWAN access
If the UE supports the P-CSCF restoration extension for the TWAN access, it
shall send an indication of this capability to the PGW via the PCO information
element at the establishment (or handover) of the IMS PDN connection over the
WLAN access.
### 5.6.5 Optional extension for the HSS and PCRF-based solutions for the
untrusted WLAN access
#### 5.6.5.1 Overview and principles
The basic mechanism for P-CSCF restoration over WLAN is optionally extended
for the untrusted WLAN access to avoid the need to deactivate and reactivate
the IMS PDN connection. This P-CSCF restoration extension applies to the HSS-
based and the PCRF-based solutions.
Upon receipt of a P-CSCF restoration indication from the 3GPP AAA Server, the
PGW may invoke this P-CSCF restoration extension procedure if
\- the UE is accessing the EPC via an untrusted WLAN access;
\- the UE and the ePDG indicated support of this extension for the untrusted
WLAN access (as further described in subclause 5.6.5.3).
If so, the PGW shall send the updated list of the addresses of available
P-CSCFs towards the UE via the ePDG. This triggers the UE to initiate a new
IMS registration towards an available P-CSCF over the existing IMS PDN
connection.
Otherwise, the PGW shall initiate the release of the IMS PDN connection and
proceed with the basic P-CSCF restoration mechanism specified in subclauses
5.6.2 and 5.6.3.
#### 5.6.5.2 Description
The call flow for the P-CSCF restoration extension for the untrusted WLAN
access is described in figure 5.6.5.2-1. The functional entities involved by
this call flow shall execute the following procedure if they all support the
P-CSCF restoration extension for the untrusted WLAN access.
Figure 5.6.5.2-1: P-CSCF restoration extension for the untrusted WLAN access
-- GTP-based S2b
For the HSS-based solution, steps from 1 to 7 are the same as those explained
in subclause 5.6.2.2 for the P-CSCF restoration basic mechanism for WLAN**.**
In step 7, the 3GPP AAA Server, when receiving a P-CSCF restoration indication
from the HSS, transfers this indication to the PGW in a Re-authorization
Request (RAR) command. This generates an authorisation procedure (step 7a) as
according to 3GPP TS 29.273 [24].
For the PCRF-based solution, steps from 1 to 7 are the same as those explained
in subclause 5.3.2 for the P-CSCF restoration basic mechanism**.** In step 7,
the PCRF transfers the P-CSCF restoration indication to the PGW.
Hereafter steps 8 to 11 are common to the HSS-based solution and to the PCRF-
based solution:
8 If the PGW has previously received the indication that the UE and the ePDG
support the P-CSCF restoration extension for the untrusted WLAN access, the
PGW shall send an Update Bearer Request (as described in 3GPP TS 29.274 [10])
to the ePDG including the APCO information element set with a list of
available P-CSCF addresses.
9 The ePDG shall initiate an IKEv2 informational exchange procedure, as
described in IETF RFC 7296 [23], towards the UE to forward the list of
available P-CSCF addresses received from the PGW.
10 The UE shall send a response to the ePDG which then shall send an Update
Bearer Response to the PGW.
11 As per the P-CSCF restoration procedures described in 3GPP TS 24.229 [19],
the UE shall select one P-CSCF from the received list and proceed with an IMS
registration.
The same call flow applies to PMIP-based S2b, whereby, in step 8, the PGW
shall initiate an LMA Initiated Update Notification procedure, as described in
3GPP TS 29.275 [15], to provide the ePDG with the available P-CSCF addresses.
#### 5.6.5.3 Indication of UE support of the P-CSCF restoration extension for
the untrusted WLAN access
If the UE supports the P-CSCF restoration extension for the untrusted WLAN
access, it shall send an indication of this capability to the ePDG via a
notify payload in the IKEv2 message to the ePDG at the establishment (or
handover) of the IMS PDN connection over the untrusted WLAN access.
An ePDG which supports the P-CSCF restoration extension for untrusted WLAN
shall forward this UE capability in the APCO information element to the PGW
over the S2b interface.
NOTE: The receipt by the PGW of the UE capability indicating the support of
P-CSCF restoration for the untrusted WLAN access at the IMS PDN connection
establishment (or handover) over the untrusted WLAN access serves also as an
indication that the ePDG supports this procedure.
### 5.6.6 Supported features and capabilities
#### 5.6.6.1 Introduction
The P-CSCF restoration mechanism for WLAN, compared to the 3GPP access one,
requires additional functionalities from the HSS, the 3GPP AAA Server, the PGW
for the basic mechanism and in addition from the PGW, the TWAN, the ePDG and
the UE for the extended mechanism.
The support or not of the additional functionalities by the involved entities
has consequences on the applicability of the P-CSCF restoration mechanism,
both for the basic mechanism and the extended mechanism. User roaming may
imply a modification of the supported features.
#### 5.6.6.2 Feature support in the HSS and S-CSCF
The S-CSCF behaviour when triggering the HSS with a P-CSCF restoration
indication is independent of the 3GPP access or of the WLAN access that the UE
is using. The signalling regarding P-CSCF restoration over the Cx interface
and the S-CSCF behaviour are common for the P-CSCF restoration over a 3GPP or
a WLAN access.
If the HSS does not support P-CSCF restoration for WLAN, but supports P-CSCF
restoration over a 3GPP access and if the UE is registered in a 3GPP access,
the HSS shall behave as described in subclause 5.4.
If the HSS does not support P-CSCF restoration for 3GPP access, but supports
P-CSCF restoration for WLAN, if the user is registered in the non 3GPP access
with an IMS APN configuration for non 3GPP access in its subscription and if
the 3GPP AAA Server previously indicated the support of P-CSCF restoration for
WLAN to the HSS, then the HSS shall behave as described in subclause 5.6.2.
If the HSS supports P-CSCF restoration both for 3GPP access and WLAN and if
the UE is registered both with 3GPP access and WLAN, the HSS shall initiate
P-CSCF restoration for 3GPP access and WLAN as described in subclause 5.4 for
3GPP access and in subclause 5.6.2 for WLAN.
The HSS shall report DIAMETER_SUCCESS to S-CSCF if at least one serving node
(SGSN, MME or 3GPP AAA Server) supports HSS-based P-CSCF Restoration and a
request indicating P-CSCF restoration is sent to at least one of these
supporting nodes.
#### 5.6.6.3 Feature support in the 3GPP AAA Server
The 3GPP AAA Server shall inform the HSS, at the user registration over SWx,
if it supports the P-CSCF restoration feature through a supported feature
indication, so to allow the HSS to correctly react to a P-CSCF restoration
indication received from the S-CSCF. This feature support indication does not
contain any information about the support of the P-CSCF restoration feature by
the PGW handling the IMS PDN connection.
NOTE: The user registration over SWx can result from the establishment of
another PDN connection via a different PGW, before the user sets up the IMS
PDN connexion. So, at the user registration, the 3GPP AAA Server does not know
if the PGW that will later handle the IMS PDN connection supports the P-CSCF
restoration feature.
Therefore, when the PGW informs the 3GPP AAA Server over S6b that an IMS PDN
connection is established, the PGW shall advertise the 3GPP AAA Server if the
PGW supports the P-CSCF restoration mechanism for WLAN. A 3GPP AAA Server that
supports the P-CSCF restoration mechanism shall store this information and
when the 3GPP AAA Server receives a P-CSCF restoration indication from the HSS
(as described in figure 5.6.2.2-1 step5b):
\- if an IMS PDN connection is established and if the PGW supports the P-CSCF
restoration mechanism for WLAN, the 3GPP AAA Server shall behave as described
in step 7 of subclause 5.6.2.2;
\- if an IMS PDN connection is established and if the PGW does not support the
P-CSCF restoration mechanism for WLAN, the 3GPP AAA Server shall ignore the
P-CSCF restoration indication received from the HSS;
\- if no IMS PDN connection is established, the 3GPP AAA Server shall ignore
the P-CSCF restoration indication received from the HSS.
#### 5.6.6.4 Feature support in the PGW
A PGW supporting the basic P-CSCF restoration mechanism for trusted and/or
untrusted WLAN shall indicate the support of P-CSCF restoration for WLAN to
the 3GPP AAA Server in the Authorization Request message sent over S6b at the
creation of the IMS PDN connection.
The support of the extended mechanism by the PGW requires the support of the
basic mechanism. The extended mechanism is optionally supported by the PGW for
TWAN or for untrusted WLAN or for both.
#### 5.6.6.5 Feature support in the TWAN
The TWAN shall advertise the support of the WLCP PDN connection modification
request procedure over S2a at establishment (or handover) of the IMS PDN
connection. This is to allow the PGW to use the P-CSCF restoration extension
on this TWAN.
#### 5.6.6.6 Feature support in the ePDG
As described in subclause 5.6.5.3, the ePDG indicates its support of the
P-CSCF restoration extension to the PGW over S2b when sending the UE
capability indication to the PGW at the IMS PDN connection establishment (or
handover) over S2b.
#### 5.6.6.7 Capability support in the UE
A UE supporting the P-CSCF restoration extension may support this mechanism
for:
\- the 3GPP access (e.g. a Rel-12 UE) and/or;
\- the TWAN and/or;
\- the untrusted WLAN.
In consequence, a UE capability is defined for each type of access to indicate
the UE support of the extended P-CSCF restoration mechanism for this type of
access, meaning up to three capabilities with all the possible combinations.
During the set up (or handover) of the IMS PDN connection over a given type of
access, the UE shall indicate its capability over this type of access.
## 5.7 Interaction between P-CSCF restoration and NBIFOM
### 5.7.1 Introduction
P-CSCF restoration and NBIFOM present interactions as NBIFOM can be applied to
the IMS PDN connection which can be set on a 3GPP access or on a WLAN access
or be simultaneously active over the two types of accesses. This impacts the
P-CSCF restoration procedures for a network supporting both P-CSCF restoration
and NBIFOM with IMS UEs supporting NBIFOM, as described in the hereafter
subclauses which cover:
\- the HSS-based and the PCRF-based solutions;
\- the cases where the IMS PDN connection is established over one access or
over two accesses (3GPP access, WLAN access);
\- the cases where the basic mechanism and/or the extended mechanism for
P-CSCF restoration are supported by the network over only one access or on
both accesses used by the IMS PDN connection;
\- the capabilities of the IMS UEs with NBIFOM regarding the support or not of
the extended mechanism for P-CSCF restoration over the 3GPP access, the
trusted WLAN and/or the untrusted WLAN.
Regarding WLAN accesses, the statements in subclause 5.7 are the same for
trusted WLAN with multi-connection mode and untrusted WLAN. For a trusted WLAN
with the single connection mode or the transparent single connection mode,
only the basic P-CSCF restoration mechanism may apply.
The support of the basic mechanism or of the extended mechanism for P-CSCF
restoration in subclause 5.7 is meant as the support over the whole chain of
involved functional elements over an access type at the creation of the IMS
PDN connection over the concerned access, so, in particular, taking into
account the UE capability for the extended mechanism over this access.
### 5.7.2 HSS-based solution
If the MME/SGSN is configured with the extended mechanism (i.e. the MME/SGSN
forwards a received P-CSCF restoration indication to the PGW) and:
\- If the IMS PDN connection is established over at least one access
supporting the extended mechanism with the UE, the PGW, when receiving a
P-CSCF restoration indication, shall select one access supporting the extended
mechanism and send the list of available P-CSCF addresses over this access.
The PGW shall ignore any second P-CSCF restoration indication which may be
received shortly afterwards;
\- If the IMS PDN connection is established over access(es) not supporting the
extended mechanism with the UE, but over at least one supporting the basic
mechanism, the PGW, when receiving a P-CSCF restoration indication (be it from
the MME or the 3GPP AAA server), shall:
\- select one access supporting the basic mechanism and release the IMS PDN
connection over that access with the cause \"reactivation requested\". The PGW
shall ignore any second P-CSCF restoration indication which may be received
shortly afterwards. If the IMS PDN connection is established on both accesses
with the single connection mode over the trusted WLAN, the PGW shall select
the 3GPP access; and
\- release the IMS PDN connection over the other access with a \"local
release\" cause. The MME/SGSN or TWAN/ePDG in the other access shall release
the corresponding bearer resources as specified in 3GPP TS 23.401 [17] or IETF
RFC 5996 [26], but without signalling to the UE. Further, for the local
release of the bearer resources by the MME/SGSN for a UE that is in connected
mode, the MME/SGSN shall initiate the radio access bearer release procedure
towards the serving eNB/NB.
If the MME/SGSN supports only the basic mechanism (i.e. the MME/SGSN does not
forward the P-CSCF restoration indication to the PGW), the MME/SGSN, when
receiving a P-CSCF restoration indication, shall release the IMS PDN
connection with the cause \"reactivation requested\" sent to the UE or, if
this is the last PDN connection of the UE, sends an explicit detach to the UE
with the cause \"reattach required\" (as specified in subclause 5.4.2.1). The
MME/SGSN shall release the IMS PDN connection towards the PGW by sending a
Delete Session Request to the PGW with the Release Over Any Access Indication.
Upon receipt of such a message and indication, the PGW shall initiate a Delete
Bearer Request procedure with a \"local release\" cause to tear down the PDN
connection over the other access, if this is a NBIFOM PDN connection and
resources still exist on that other access. The TWAN/ePDG shall then proceed
with the local disconnection of the PDN connection, i.e. the TWAN/ePDG need
not send signalling to the UE to release that access. The UE may, over the
WLAN access, also receive a release of the IMS PDN connection or a list of
available P-CSCFs.
Upon receipt of a request to release an IMS PDN connection with the cause
\"reactivation requested\" over the 3GPP or the WLAN access, or a Detach
request with the cause \"reattach required\" over the 3GPP access, the UE
shall locally release the IMS PDN connection over the other access if the IMS
PDN connection was established on both accesses, then re-establish the IMS PDN
connection and do a new IMS registration. The UE should avoid doing two new
IMS registrations in a row.
NOTE: When a Detach request with the cause \"reattach required\" over the 3GPP
access occurs due to a P-CSCF restoration indication, there is no PDN
connection other than the IMS PDN connection established over the 3GPP access,
so any PDN connection established over the WLAN access other than the IMS PDN
connection is maintained.
### 5.7.3 PCRF-based solution
If the IMS PDN connection is established over at least one access supporting
the extended mechanism with the UE, the PGW, when receiving a P-CSCF
restoration indication, shall select one access supporting the extended
mechanism and send the list of available P-CSCF addresses over this access.
If the IMS PDN connection is established over access(es) not supporting the
extended mechanism with the UE, but over at least one supporting the basic
mechanism, the PGW, when receiving a P-CSCF restoration indication, shall:
\- select one access supporting the basic mechanism and release the IMS PDN
connection over that access with the cause \"reactivation requested\". If the
IMS PDN connection is established on both accesses with the single connection
mode over the trusted WLAN, the PGW shall select the 3GPP access; and
\- release the IMS PDN connection over the other access with a \"local
release\" cause. The MME/SGSN or TWAN/ePDG in the other access shall release
the corresponding bearer resources as specified in 3GPP TS 23.401 [17] or IETF
RFC 5996 [26], but without signalling to the UE. Further, for the local
release of the bearer resources by the MME/SGSN for a UE that is in connected
mode, the MME/SGSN shall initiate the radio access bearer release procedure
towards the serving eNB/NB.
Upon receipt of a request to release an IMS PDN connection with the cause
\"reactivation requested\" over the 3GPP or the WLAN access, or a Detach
request with the cause \"reattach required\" over the 3GPP access, the UE
shall locally release the IMS PDN connection over the other access if the IMS
PDN connection was established on both accesses, then re-establish the IMS PDN
connection and do a new IMS registration.
NOTE: When a Detach request with the cause \"reattach required\" over the 3GPP
access occurs due to a P-CSCF restoration indication, there is no PDN
connection other than the IMS PDN connection established over the 3GPP access,
so any PDN connection established over the WLAN access other than the IMS PDN
connection is maintained.
# 6 Recovery after SCC AS failure
## 6.1 General
The following clauses show the requirements and information flows of IMS
Restoration Procedures for the SCC-AS service interruption in each of the
scenarios where they apply.
It is an optional feature to support SCC-AS restoration. If SCC-AS restoration
is supported, it is required to support enhanced third part registration
procedure described in 6.2.1 and enhanced service request procedure described
in 6.2.2 together.
## 6.2 General Procedure
During the 3^rd^ party registration, the SCC-AS should store extra SRVCC
related information, i.e, ATCF-Path-URI and ATCF-Management-URI, in the HSS as
Repository Data.
When a service request is received when assigned SCC-AS is down, the S-CSCF
should forward the service request to a working SCC-AS and this SCC-AS should
download corresponding ATCF related information previously stored in the HSS
and it should notify the ATCF with its own ATU-STI for SRVCC.
### 6.2.1 Enhanced Third Party Registration Procedure
#### 6.2.1.1 Introduction
The restoration described in the subclause 6.2.1 is an optional mechanism
which applies for third party registration. The SCC-AS are optionally enhanced
to store ATCF related information in the HSS as Repository Data.
#### 6.2.1.2 Description
Enhanced third party registration procedure is described in figure 6.2.1.2-1.
###
Figure 6.2.1.2-1 Enhanced Third Party Registration Procedure
1 \~ 20. Registration procedure as normal.
21\. For the first time the SCC-AS receives a third party registration of a
served user, the SCC-AS shall store the ATCF-Path-URI and ATCF--Management-URI
parameters contained in the SIP REGISTER request as new Repository Data in the
HSS. For the subsequent third party registration of that served user, the SCC-
AS shall update the ATCF-Path-URI and the ATCF-Management-URI stored in the
HSS as Repository Data with the new received value.
> _The SCC-AS may as well store this data locally, and then for the subsequent
> third party registration of that served user, if the ATCF-Path-URI and/or
> the ATCF-Management-URI contained in the SIP REGISTER request is different
> from previously stored one, the SCC-AS shall update the locally stored ATCF-
> Path-URI or the ATCF-Management-URI as well as that stored in the HSS as
> Repository Data with the new received value._
NOTE x: The SCC-AS already updates STN-SR in the HSS using PUR/PUA command,
then the SCC-AS may send the new Repository Data along with STN-SR in a single
PUR (only if Update-Eff-Enhance feature is supported).
22\. HSS updates data and responds back.
23 \~ 24. HSS sends the received STN-SR and C-MSISDN to update MME/SGSN as
normal.
### 6.2.2 Enhanced Service Request Procedure
#### 6.2.2.1 Introduction
The restoration described in the subclause 6.2.2 is an optional mechanism
which applies for service request. And SCC-AS is optionally enhanced to upload
SRVCC related information as Repository Data from the HSS and notify the ATCF
with new _ATU-STI._
_Enhanced Service Request Procedure is based on enhanced_ third part
registration procedure in 6.2.1.
#### 6.2.2.2 Description
Enhanced service request procedure is described in figure 6.2.2.2-1.
Figure 6.2.2.2-1 Enhanced Service Request Procedure
1\. The S-CSCF receives session service request message and it attempts to
route the message towards the registered SCC-AS, that in the figure 6.1.2.2-1
is \"SCC-AS1\".
2\. The S-CSCF detects the failure of SCC-AS1.
3\. S-CSCF re-selects a new available SCC-AS, i.e. \"SCC-AS2\" e.g. by a DNS
procedure or by configuration in the matched Filter Criteria of an alternative
SCC-AS to provide services to the user.
4\. The S-CSCF sends the message to the selected SCC-AS2.
5\. After receiving the service request message, if no subscriber data is
found, SCC-AS2 starts implicit registration procedure as normal (not displayed
in figure 6.2.2.2-1). A _fter retrieving required subscriber data from the
HSS, the SCC-AS2 shall request the ATCF related information stored as
Repository Data (if present)_.
6\. If ATCF related Repository Data is stored in the HSS, it is received back
by the SCC-AS2.
7\. If ATCF related Repository Data is received by the SCC-AS2, it shall send
a MESSAGE with its own ATU-STI towards the ATCF that is identified by received
ATCF-Management-URI.
8\. The SCC-AS2 continues the session as normal.
#
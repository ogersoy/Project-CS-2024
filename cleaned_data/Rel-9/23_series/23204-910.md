# Foreword
This Technical Specification has been produced by the 3^rd^ Generation
Partnership Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# Introduction
The Short Message Service (SMS) has have enjoyed great success in cellular
networks. At the same time, specifications have been and are being developed
for extending 3GPP services to non-cellular IP Connectivity Access Networks
(IP-CANs). In this same spirit, this specification describes the capabilities
needed to support SMS for generic IP-CANs.
SMS over generic IP access can be used to support applications and services
that use SMS when a generic IP access is used.
# 1 Scope
The present document specifies the new capabilities and enhancements needed to
support SMS over a generic IP Connectivity Access Network (IP-CAN) using IMS
capabilities (TS 23.228 [9]). These include (but are not limited) to:
1 Enhancements to the HSS;
2 Communication between the SMS-GMSC/SMS-IWMSC and the HSS;
3 Authentication of service usage and registration;
4 Transfer of UE Terminated SMS, UE Originated SMS, and Delivery reports;
5 Mechanisms to handle SMS when there is more than one IP connection active
with the UE, etc.
The document also specifies the capabilities and enhancements needed to
support the service level interworking for the Short Message service as
defined in the TS 23.040 [2] and in this specification and the Instant
Messaging service as defined in OMA-TS-SIMPLE_IM-V1_0-20070816-C [12]. The
features supported from the IM specification are limited to the exchange of
short or large immediate messages in pager mode.
NOTE: The page-mode immediate message as defined in TS 24.247[14] is
considered as a subset of OMA-TS-SIMPLE-IM-V1_0-20070816-C [12].
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
  * References are either specific (identified by date of publication, > edition number, version number, etc.) or non‑specific.
  * For a specific reference, subsequent revisions do not apply.
  * For a non-specific reference, the latest version applies. In the > case of a reference to a 3GPP document (including a GSM document), > a non-specific reference implicitly refers to the latest version > of that document _in the same Release as the present document_.
[1] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[2] 3GPP TS 23.040: \"Technical realization of the Short Message Service (SMS)
Point to Point (PP)\".
[3] Void.
[4] Void.
[5] Void.
[6] 3GPP TS 29.002: \"Mobile Application Part (MAP) specification\".
[7] Void.
[8] Void.
[9] 3GPP TS 23.228: \"IP Multimedia Subsystem (IMS); Stage 2\".
[10] Void.
[11] Void.
[12] OMA: \"Instant Messaging using SIMPLE\", OMA-TS-
SIMPLE_IM-V1_0-20070816-C,\
http://member.openmobilealliance.org/ftp/Public_documents/MWG/IM/Permanent_documents/OMA-
TS-SIMPLE_IM-V1_0-20070816-C.zip.
[13] IETF RFC 5438: \"Instant Message Disposition Notification\", February,
2009.
[14] 3GPP TS 24.247: \"Messaging service using the IP Multimedia (IM) Core
Network (CN) subsystem; Stage 3\".
# 3 Definitions and abbreviations
## 3.1 Definitions
For the purposes of the present document, the terms and definitions given in
TR 21.905 [1] and the following definitions apply. A term defined in the
present document takes precedence over the definition of the same term, if
any, in TR 21.905 [1]:
**IM origination:** origination of an Instant Message by an IMS UE.
**IM termination:** termination of an Instant Message by an IMS UE.
**IMS core:** refers to the core session control elements of the IM CN
Subsystem, i.e. the CSCFs, and the IBCF.
**Instant Message:** an Instant Message as defined in the OMA-TS-
SIMPLE_IM-V1_0-20070816-C [12] and TS 24.247 [14].
**SIMPLE IM service:** the Instant Messaging Service as defined in the OMA-TS-
SIMPLE_IM-V1_0-20070816-C [12].
**SM origination:** origination of a Short Message (including SMS over IP) by
an SMS capable UE, as defined in TS 23.040 [2] and this specification.
**SM termination:** termination of a Short Message (including SMS over IP) by
an SMS capable UE, as defined in TS 23.040 [2] and this specification.
**SMS:** the Short Message Service as defined in the TS 23.040 [2].
**SMSIP MESSAGE:** an immediate message as defined in TS 23.228 [9], which
encapsulates a SM in its text body.
**SMSIP UE:** a UE which supports SMSIP MESSAGE.
## 3.2 Abbreviations
For the purposes of the present document, the abbreviations given in TR 21.905
[1] and the following apply:
IM Instant Message
IMDN Instant Message Disposition Notification
IP‑SM‑GW IP-Short-Message-Gateway
SM Short Message
# 4 Void
# 4a Architecture Requirements
## 4a.1 General
The SMS-IP architecture supports the following:
\- Notification shall be sent to the HSS that a previously unreachable UE is
now reachable.
\- Functionality is required to be able to select the domain for message
delivery between IMS and CS/PS, and to have the message delivered to the
selected domain.
\- Functionality is required to determine whether to transform the message
format or not, and to perform the transformation of the message format when
determined.
\- The interworking function shall generate the appropriate charging-related
information and provide the appropriate online charging mechanism (if it is
applied for the Short Message Service and/or SIMPLE IM services) for the
interworking services.
## 4a.2 Transport-level interworking
For transport-level interworking , the architecture allows for the following:
\- A registration and de-registration mechanism shall be supported where UEs
are required to explicitly indicate their ability to send and receive
encapsulated Short Messages.
\- It shall provide for the transport of Short Message Service TP layer PDUs
(TS 23.040 [2]) and associated RP layer information.
## 4a.3 Service-level interworking
For service-level interworking, the architecture allows for the following:
\- The service-level interworking is a value added service which requires
service subscription. In addition, it shall also take the operator\'s policy,
if available, into account, e.g. checking on the barring setting of the
subscriber to determine whether to provide this interworking or not, so the
service authorisation shall be supported before the interworking is executed.
\- The service-level interworking applies as a fallback only if the users
cannot communicate with each other using their chosen messaging service
according to the user preference and operator policy. The location of the
interworking service can be in the originating network and in the terminating
network.
\- The service-level interworking shall support interworking between OMA
SIMPLE IM service as defined in OMA-TS-SIMPLE_IM-V1_0-20070816-C [12] and
Short Message Service, as defined in the TS 23.040 [2] and in the current
specification.
\- The service-level interworking shall take the capability of the terminating
UE into account when possible.
\- The service level interworking shall be transparent to the end user.
\- The service-level interworking shall minimize the impact on the IMS
architecture.
\- The service-level interworking shall not impact existing functionality of
the Short Message Service as described in TS 23.040 [2] or of the SIMPLE IM
service enabler as described in OMA-TS-SIMPLE_IM-V1_0-20070816‑C [12].
Existing security mechanisms for both the SIMPLE IM service and the Short
Message Service shall be reused.
\- The interworking function shall be aware if the message should be
interworked or not, e.g. specific types of Short Messages such as an over the
air configuration message, shall not be interworked at service-level, but
shall be instead transported as a Short Message via IMS, CS or PS.
\- If an SMS user requests an SMS status report that the message was delivered
to the recipient, then an SMS status report shall be generated when the
message is delivered using Instant Message.
\- If an IMS user requests a notification that the message was delivered to
the recipient and the Instant Message is interworked to Short Message on the
originating side, an SMS status report shall be interworked to a delivery
notification when the message is delivered.
\- The interworking functionality shall be executed in the following cases:
\- Originating network:
\- The sender is an IM user has subscribed to the interworking function and
the recipient is not routable in IMS;
\- The operator policy on the originating side has been set to send the
Instant Messages via Short Message Service.
\- Terminating network:
\- The user preferences and/or the operator policy of the recipient have been
set to receive the incoming Instant Messages via Short Message Service;
\- The received message is an Short Message and the recipient is an IM user
and has subscribed to the interworking service.
NOTE: For ensuring the integrity of the response messages from the IM UE, it
is strongly recommended that in networks where the IP-SM-GW is deployed, no
intermediate nodes modify or terminate the message between the IP-SM-GW and
the terminating IM UE. If intermediate nodes are deployed, they can send
response messages that do not reflect the final response from the IM UE. Final
responses from the IM UE are necessary to ensure correct charging and delivery
reports on the Short Message Service side.
# 5 Architecture model and reference points
## 5.1 Reference architecture
Figure 5.1 below shows the overall architecture for providing SMS over a
generic IP CAN.
Figure 5.1: Architecture for providing SMS over a generic IP-CAN
## 5.2 Reference points
### 5.2.1 General
The sub-sections below describe the needed enhancements and specific
considerations to existing interfaces in order to support SMS over a generic
IP-CAN.
### 5.2.2 C interface
The C interface allows the SMS-GMSC, using MAP, to obtain the address of the
IP-Message-GW via mechanisms described in clause 5.3.
### 5.2.3 Interface between the IP-SM-GW and the HLR/HSS
The interface(s) between the IP-SM-GW and the HLR/HSS is used for:
\- Supporting the registration and de-registration from the IP-SM-GW to the
HLR/HSS for SMS delivery.
\- Forwarding of the Send Routeing Information for Short Message requests from
HLR/HSS to IP-SM-GW in order to return the address where the SM should be
forwarded.
\- Interrogating the HLR/HSS using Send Routeing Information for Short Message
to retrieve the IMSI and the current MSC and/or SGSN addresses.
\- Informing the HLR/HSS when a memory capacity exceeded condition ceases.
\- Retrieving SMS related data from the HLR/HSS: subscriber data of the short
message service similar to the data for the current CS/PS domain and
additional service data on the service authorisation of the encapsulated short
message delivery via IMS, SC address for service-level interworking from
Instant Message to Short Message if the SC address is stored in the HLR/HSS.
Both the J and a Sh interface can be deployed between the IP-SM-GW and the
HLR/HSS. During the functional allocation the change on existing MAP functions
should be minimized. The deployment of the J interface is mandatory, since it
is used for forwarding the SRI for SM MAP message.
### 5.2.4 E/Gd interface
The E/Gd interface allows the IP-SM-GW to connect to the SMS‑GMSC using MAP,
appearing to the SMS‑GMSC as an MSC or SGSN.
### 5.2.5 ISC interface
The ISC interface allows the IP-SM-GW to forward the receiving message to the
SIP based UE via IMS core.
### 5.2.6 Void
## 5.3 Functional entities
### 5.3.1 IP-Short-Message-Gateway (IP-SM-GW)
#### 5.3.1.1 General
The IP-SM-GW shall provide the protocol interworking for delivery of the short
message between the IP-based UE and the SMS-SC. The message is routed to the
SMS-SC for delivery to the SMS-based user or the message is received from the
SMS-SC of an SMS-based UE for delivery to an IP-based UE.
The general functions of the IP-SM-GW are:
\- to determine the domain (CS/PS or IMS) for delivery of a Short Message;
\- to connect to the SMS‑GMSC using established MAP protocols, appearing to
the SMS‑GMSC as an MSC or SGSN using the E or Gd interfaces;
\- to respond to Send Routeing Information for Short Message requests made by
the SMS-GMSC, and forwarded from the HSS, with its own address;
\- to connect to the SMS-IWMSC using established MAP protocols, appearing to
the SMS-IWMSC as an MSC or SGSN using the E or Gd interfaces;
\- to connect to the HSS using established MAP protocols , to obtain the
address of MSC/SGSN address(es) for SM termination in CS/PS;
NOTE: The IP-SM-GW need not support all of the functionality defined in MAP in
TS 29.002 [6].
\- to acquire and maintain knowledge of the association between the MSISDN,
IMSI and the address of the S‑CSCF serving of the user;
\- to check that it has a valid address in SMS for the sender as well as the
recipient when receiving an IMS message for an SMS user. The IP-SM-GW shall
obtain a valid address for both from the SIP headers of the IMS message (e.g.
the sender would be identified in the asserted id in form of TEL URI);
\- for terminating procedures, to map the recipient's address from an
MSISDN/IMSI to TEL URI format when receiving an SMS for an IP-based UE, and
then it is the responsibility of the IMS core to perform any further mapping
towards a SIP URI as required;
\- to act as an Application Server towards the IMS core;
\- to perform domain selection to choose the appropriate domain to deliver a
message to a recipient and to obtain the MSC and/or SGSN addresses from the
HSS; and
\- to manage flags indicating user availability for SMS termination in the
HSS.
#### 5.3.1.2 Transport-level interworking
The additional functions of the IP-SM-GW when interworking is done by carrying
encapsulated Short Messages in IMS messages are:
\- to communicate with the UE using IMS messaging as transport while
maintaining the format and functionality of the Short Message;
\- to carry the SMS status messages as encapsulated bodies of IMS messages;
\- to store the subscriber data of the short message service similar to the
data for the current CS/PS domain and to perform the short message
authorization as performed by the MSC/SGSN, as well as to store additional
service data on the service authorisation of the encapsulated Short Message
delivery via IMS and to perform the service authorization.
NOTE 1: The short message subscriber data of the CS/PS domain and additional
service data on the authorisation of encapsulated Short Message delivery via
IMS are retrieved from the HLR/HSS via third party registration procedure as
specified in the clause 6.1. The IP‑SM‑GW can request the HSS to send a
notification whenever the subscriber data and/or additional service data is
updated, which the IP‑SM‑GW can then retrieve.
NOTE 2: The mechanism for prioritizing whether the short message is delivered
via a GSM/UMTS or other IP‑CAN connection when the terminal is simultaneously
connected to both access networks is outside the scope of this specification.
#### 5.3.1.3 Service-level interworking
The additional functions of the IP-SM-GW when service-level interworking is
done between Short Messages and Instant Messages in IMS are:
\- to determine whether to transform the message format or not, and to perform
the transformation of the message format when determined.
\- to use the SC address retrieved either as part of the subscriber data from
the HSS at registration or as provisioned by configuration, when transforming
the Instant Message into Short Message.
\- to perform the authorization for service-level interworking.
### 5.3.2 HSS
In order to support SMS over generic IP access, the HSS shall support the
following functions:
\- storing the pre-configured address of the IP-SM-GW on a subscriber basis;
NOTE: If all subscribers are assigned to a single IP‑SM‑GW address, the
IP‑SM‑GW address does not need to be pre-configured in the HSS.
\- handling an indication that the terminal is registered with an IP-SM-GW for
delivery of SMS;
\- responding to the \"send routing information for short message\" query from
IP‑SM‑GW with the address of the MSC/SGSN;
\- forwarding the Send Routeing Information for Short Message, from an SMS-
GMSC, towards the IP-SM-GW and forwarding any responses to the originator of
the Send Routeing Information for Short Message;
\- returning the IMSI and the MSC and/or SGSN addresses as a response to Send
Routeing Information for Short Message required from IP-SM-GW;
\- alerting the SCs stored in the message waiting data when the terminal is
registered with an IP‑SM‑GW for delivery of short message;
\- reporting notification to the IP-SM-GW of the reachability of a UE at the
transport layer after a delivery failure ; and
\- accepting delivery status reports from IP-SM-GWs instead of SMS-GMSC.
# 6 Procedures
## 6.0 General
The section describes the procedures for the support of transport-level
interworking between Short Message service and encapsulated Short Message via
IP service, and for the support of the service-level interworking for the
Short Message service and Instant Messaging service as defined in OMA-TS-
SIMPLE_IM-V1_0-20070816-C [12]. Clauses only applying to either transport-
level interworking or service-level interworking are indicated as such.
NOTE: In the procedures in the following clauses, the I‑CSCF, P‑CSCF and ASs
such as IM AS are not shown in the figures.
## 6.1 Registration procedure
Figure 6.1: Registration procedure
1) The UE establishes IP connection.
2) At any time after the establishment of the IP connection, the UE registers
at the S-CSCF according to the IMS registration procedures.
NOTE 1: For simplicity, not all messages between UE and S-CSCF and between
S-CSCF and HSS are shown in detail.
3) S-CSCF checks the initial filter criteria retrieved from the HSS during the
IMS registration procedure.
4) After successful IMS registration and based on the retrieved initial filter
criteria, the S-CSCF informs the IP-SM-GW (AS) about the registration of the
user.
5) The IP-SM-GW (AS) returns OK to the S-CSCF.
6) The IP-SM-GW (AS) sends IP-SM-GW Register Req to the HSS.
7) The HSS stores the received information if necessary, uses it as an
indication that the UE is available to be accessed via the IMS to trigger an
Alert service centre message if the message waiting flag is set, and responses
to the IP-SM-GW (AS) with IP‑SM‑GW Register Res.
NOTE 2: IP-SM-GW Register Res can include the SC address to be used for this
user in the subscriber data (see also clause 6.7).
NOTE 3: In order to keep a consistent service experience, the IP‑SM‑GW address
stored in the HSS via registration procedure shall be the same as the
preconfigured IP‑SM‑GW address.
8) After successful registration of the IP‑SM‑GW address at the HSS the HSS
checks whether message waiting data are stored and alerts all SCs using
procedures described in TS 23.040 [2] (see also clause 6.5b).
## 6.2 De-registration procedure
### 6.2.1 UE initiated
Figure 6.2: UE initiated de-registration procedure
1) At any time after the registration procedure, the UE may initiate a de-
registration procedure. The UE sends a De-Register request (Register request
with Expires header having value 0) to the S-CSCF.
2) S-CSCF responds to the UE with OK.
3) S-CSCF checks the initial filter criteria retrieved from the HSS during the
IMS registration procedure.
4) Based on initial filter criteria the S-CSCF informs the IP-SM-GW (AS) about
the de-registration of the user.
5) The IP-SM-GW (AS) returns OK to the S-CSCF.
6) The IP-SM-GW (AS) de-registers the UE at the HSS sending a De-register Req.
7) The HSS de-registers the UE and responds to the IP-SM-GW (AS) with De-
register Res.
NOTE: The pre-configured IP‑SM‑GW address in the HSS, if any, is not removed,
as it is used for subsequent SM termination.
### 6.2.2 Network initiated
Figure 6.2a: Network initiated de-registration procedure
1) After receiving a trigger (e.g. De-Register message from the S‑CSCF), the
IP‑SM‑GW shall de-register the IP‑SM‑GW of a subscriber from the HSS sending a
De-Register Req.
2) The HSS de-registers the UE and responds to the IP‑SM‑GW (AS) with
De‑register Res.
## 6.3 Transport-level interworking: Successful encapsulated Short Message
origination procedure
Figure 6.3: Successful encapsulated Short Message origination procedure
1) The UE registers to S-CSCF according the IMS registration procedure. Note
that I-CSCF and P-CSCF are not shown in this figure.
2) UE submits the encapsulated Short Message (SMS-SUBMIT, SC Address) to the
S-CSCF using an appropriate SIP method.
3) S-CSCF forwards the encapsulated Short Message (SMS- SUBMIT, SC Address) to
IP-SM-GW (AS) based on stored iFC.
NOTE: Subscribers who have no subscription for transport level interworking
will be provided with the relevant iFCs, to provide SMS filtering/blocking.
4) IP-SM-GW (AS) acknowledges the SIP message.
5) SIP message acknowledge is forwarded by S-CSCF to UE.
6) The IP-SM-GW performs service authorization based on the stored subscriber
data as described in the clause 6.1. The IP‑SM‑GW shall check whether the
subscriber is authorised to use the short message service (e.g. Operator
Determined Barring settings), similar to the authorization performed by
MSC/SGSN in case the Short Message is delivered via CS or PS domain. In
addition, the IP-SM-GW shall also check whether the user is authorised to use
the encapsulated Short Message delivery via IMS. If the result of service
authorization is negative, the IP-SM-GW shall not forward the message, and
shall return the appropriate error information to the UE in a failure report.
Otherwise, the IP-SM-GW (AS) extracts the Short Message (SMS- SUBMIT) and
forwards it towards the SMS-SC (SC Address) via the SMS-IWMSC using standard
MAP signalling (as described in TS 23.040 [2]).
7) The SMS-IWMSC forwards the Short Message (SMS-SUBMIT) to the SMS-SC (see TS
23.040 [2]).
8) SMS-SC sends a Submit report (SMS-SUBMIT‑REPORT) to SMS-IWMSC (see TS
23.040 [2]).
9) SMS-IWMSC sends the Submit report to IP-SM-GW (AS) (see TS 23.040 [2]).
10) IP-SM-GW (AS) sends the Submit report to S-CSCF, encapsulated in an
appropriate SIP request.
11) The S-CSCF sends the Submit report to the UE.
12) The UE acknowledges the SIP request.
13) The S-CSCF forwards the acknowledgement of the SIP request to IP-SM-GW
(AS).
## 6.4 Transport-level interworking: Successful encapsulated Short Message
termination procedure
Figure 6.4: Successful encapsulated Short Message termination procedure
1) The UE registers to the S-CSCF according to the IMS registration procedure.
2) The SMS-SC forwards the Short Message (SMS‑DELIVER) to the SMS-GMSC.
3a) The SMS‑GMSC interrogates the HSS to retrieve routeing information. Based
on the pre-configured IP-SM-GW address for the user, the HSS forwards the
request to the corresponding IP-SM-GW.
NOTE 1: The Send Routeing Info for SM request is not forwarded if it has been
sent originally from the IP‑SM‑GW.
NOTE 2: If there is only a single IP‑SM‑GW address, the IP‑SM‑GW address does
not need to be pre-configured in the HSS, the Send Routeing Info for SM
request can be forwarded on the STP level.
3b) The HLR/HSS returns the addresses of the current MSC, SGSN to the IP‑SM‑GW
for delivery of the Short Message in CS/PS domain. The HLR/HSS also returns
the IMSI, for the IP‑SM‑GW to correlate the receipt of Short Message from the
MT Correlation ID within the IMSI field of the Forward Short Message.
3c) The IP SM GW creates a MT Correlation ID as per TS 23.040 [2] which
associates the Send Routeing Info for SM with the subsequent Forward Short
Message messages(s), and stores this along with the IMSI of the receiving
subscriber. The IP-SM-GW returns only one address, which is of itself, along
with the MT Correlation ID as routeing information to the SMS-GMSC.
NOTE 3: For the case where the IP‑SM‑GW address is not pre-configured in the
HSS, the Send Routeing Info for SM request will be forwarded on the STP level,
the IP-SM-GW returns the address of itself as routeing information to SMS-GMSC
upon receipt of the forwarded Send Routeing info for SM request.
4) SMS-GMSC delivers the Short Message (SMS‑DELIVER) to IP-SM-GW (AS)
including the MT Correlation ID received from the IP‑SM‑GW, in the same manner
that it delivers the Short Message to an MSC or SGSN.
5) The IP‑SM‑GW performs service authorization based on the stored subscriber
data described in the clause 6.1. The IP‑SM‑GW shall check whether the
subscriber is authorised to use the short message service (e.g. Operator
Determined Barring settings), similar to the authorization performed by
MSC/SGSN in case the Short Message is delivered via CS or PS domain. In
addition, the IP‑SM‑GW shall also check whether the subscriber is authorised
to use the encapsulated Short Message delivery via IMS. If the result of
service authorization is negative, the IP‑SM‑GW shall not forward the message,
and shall return the appropriate error information to the SMS-SC in a failure
report. Otherwise, the IP-SM-GW performs domain selection function to
determine the preferred domain for delivering the message according to
operator policy and user preferences. The logic for selecting preferred route
for message delivery is a matter of implementation.
6) If the preferred domain is IMS, the IP-SM-GW (AS) uses the TEL-URI
associated with the IMSI of the message received for the target UE to send the
Short Message (SMS‑DELIVER, SC Address) encapsulated in the appropriate SIP
method towards the S-CSCF.
7) S-CSCF forwards the encapsulated Short Message (SMS-DELIVER, SC Address) to
the UE.
8) The UE acknowledges the SIP request.
NOTE 4: This is not yet the Delivery report.
9) The S-CSCF forwards the acknowledgement of the SIP request to the IP-SM-GW
(AS).
## 6.5 Transport-level interworking: Delivery Report procedure
Figure 6.5: Delivery report procedure
1) The UE has received the Short Message as described in clause 6.4.
2) The UE sends a Delivery report (SMS‑DELIVER‑REPORT) to the S-CSCF,
including either a positive or a negative acknowledgement to the Short Message
received in step 1.
3) The S-CSCF forwards the Delivery report to the IP-SM-GW (AS). It shall be
ensured that the Delivery report reaches the same IP-SM-GW that forwarded the
Short Message in step 1.
4) IP-SM-GW (AS) acknowledges, at the SIP level, the Delivery report to
S-CSCF.
NOTE: This is the acknowledgement to the Forward Short Message in the SM
termination procedure.
5) S-CSCF forwards the SIP acknowledgement to the Delivery report to the UE.
6) The IP-SM-GW (AS) sends a Delivery report to the SMS-GMSC.
7) The IP-SM-GW may send a Report SM Delivery Status to the HSS. This may
trigger the Alert service centre procedure or an update of the message waiting
data in the HSS as described in TS 23.040 [2], if necessary.
8) The SMS-GMSC may send a Report SM Delivery Status to the HSS. The HSS shall
ignore the information provided in this report.
## 6.5a Unsuccessful SM termination procedure
When a Short Message fails to reach the UE via the selected domain, a failure
delivery report is returned to the IP‑SM‑GW. The IP‑SM‑GW takes responsibility
to re-attempt the delivery of the message in another domain which is listed in
the sequence of the priority in the IP‑SM‑GW while the domain selection is
performed during the SM termination procedure. If the message successfully
reaches the UE after re-delivery, the IP‑SM‑GW forwards the received
successful Delivery report to the SMS‑GMSC. Otherwise, if the message still
fails after the IP‑SM‑GW has tried all selectable domains, the IP-SM-GW
forwards the received unsuccessful Delivery report to the SMS‑GMSC and sends
Report SM Delivery Status message to the HLR/HSS. The HLR/HSS then records the
corresponding Messages Waiting Data (MWD), and an Alert service centre
procedure may be initiated as described in clause 6.5b or 6.6.
The order in which domains are selected for message delivery by the IP‑SM‑GW
is subject to operator policy and/or user preferences and any known or assumed
timer values in the SMS-GMSC for the Forward Short Message message (see NOTE
1).
The following flow shows only an example order of selected domains, i.e. the
IMS is the preferred domain, followed by the PS domain, and finally the CS
domain.
NOTE 1: If the timer at the SMS-GMSC has been configured to a short value
(near to the minimum value), the IP‑SM‑GW may not have sufficient time to try
the message delivery in all three domains. This problem can be resolved by
several implementation solutions, e.g. re-configuring the SMS-GMSC timer to be
longer, enhancing the IP-SM-GW to try the delivery only in two or one
domain(s).
Figure 6.5a: Unsuccessful SM termination procedure
1) As described in clause 6.4, the Short Message is routed to the UE via
S‑CSCF after the domain selection is performed in the IP‑SM‑GW and all the
available domains have been listed in the sequence of the priority in the
IP‑SM‑GW. The message fails to reach the UE, e.g. due to the UE not being
reachable in IMS, or exceeded memory capacity of the UE.
2) The S‑CSCF sends an appropriate failure message according to normal IMS
procedure as defined in TS 23.228 [9], and sends it to the IP‑SM‑GW (AS)
including an appropriate error value. This Delivery report is an
acknowledgement to the Short Message received by the S-SCSF in step 1.
NOTE 2: When the failure message is sent from the UE, e.g. the UE notifies the
network that the UE has been unable to accept a Short Message because its
memory capacity has been exceeded, the S‑CSCF forwards the failure message to
the IP‑SM‑GW (AS).
3) IP‑SM‑GW (AS) acknowledges the failure message to S‑CSCF.
4) The IP‑SM‑GW verifies the error cause of the failure delivery report. If
the error is due to exceeded memory capacity of the UE, the IP‑SM‑GW forwards
the Delivery report (SMS‑DELIVER‑REPORT) back to the SMS-GMSC and the
procedure continues as described in step 10. Otherwise, the IP‑SM‑GW forwards
the Short Message to the domain which is listed in the second place in its
priority list. It is supposed that the SGSN is selected.
5) The SGSN delivers the message to the UE but the message fails to reach the
UE, e.g. the UE is not reachable in PS domain.
NOTE 3: If the delivery succeeds in the PS domain at this point, the procedure
for successful message delivery over PS domain is described in clause 6.4.
6) The SGSN generates a Delivery report (SMS‑DELIVER‑REPORT) and sends it to
the IP‑SM‑GW, including an appropriate error value. This Delivery report is an
acknowledgement to the Short Message received by the SGSN in step 5.
7) The IP-SM-GW forwards the Short Message to the domain which is listed in
the third place in its priority list. It is supposed that the MSC is selected.
8) The MSC delivers the message to the UE but the message fails to reach the
UE, e.g. the UE is not reachable in CS domain.
NOTE 4: If the delivery succeeds in the CS domain at this point, the procedure
for successful message delivery over CS domain is described in clause 6.4.
9) The MSC generates a Delivery report (SMS‑DELIVER‑REPORT) and sends it to
the IP‑SM‑GW, including an appropriate error value. This Delivery report is an
acknowledgement to the Short Message received by the MSC in step 9.
10) The IP‑SM‑GW sends a Delivery report to the SMS‑GMSC.
NOTE 5: The SMS-GMSC is aware of the availability of the UE on only one domain
(see clause 6.4), and so will not attempt redelivery to another domain after
receiving a failure report.
11) The IP-SM-GW sends a Report SM Delivery Status to the HSS with accurate
results from different domains. The HSS records the corresponding MWD, i.e.
the SMS‑SC address which stores the un-delivered message and the failure
reason which indicates that the message failed to be sent by IP‑SM‑GW due to
the UE not being available or the memory capacity of the UE being exceeded.
12) The IP-SM-GW subscribes to the HSS for a one-time notification of the UE
being reachable again. The HSS records the subscription and instructs the
transport layer to report when the UE is reachable.
13) The SMS-GMSC sends a Report SM Delivery Status to the HSS. The HSS shall
ignore the information provided in this report.
## 6.5b Alert Service Centre procedure when UE is available
When a Short Message is received in the IP-SM-GW for delivery to an IMS
subscriber, the IP-SM-GW shall verify the registration status of the UE. If
the UE is not registered in IMS, or is registered in IMS but does not
advertise the SIMPLE IM or SMSIP capability, the Short Message shall not be
interworked; neither at service level nor at transport level. Based on
operator policy and user preferences, either the message is sent over CS/PS or
an error indication is sent back to the SMS-SC. In the latter case, when the
UE registers in IMS advertising the SIMPLE IM and/or the SMSIP capability at a
later time, this information is sent to the SMS-SC and the delivery is
attempted at that time, as an Instant Message or an encapsulated Short Message
as appropriate.
NOTE: The service level or transport level interworking of a message is
prohibited as identified in the above scenario in order to prevent the
possibility of the message being deferred in the terminating network.
If the HLR/HSS has recorded the MWD with a failure reason that the message
failed to be sent by IP‑SM‑GW due to the UE not being available, once the
HLR/HSS receives a message from any of the domains indicating that the UE is
available again, e.g. IMSI attached, or IMS registered, the HLR/HSS initiates
an Alert service centre procedure to request the SMS-SC to re-send the stored
message.
The following figure shows an example of how a deferred message is re-
transmitted to an IMS UE upon the UE availability.
Figure 6.5b: Alert service centre procedure when UE is available
1) The message is transmitted from SMS‑SC to IP‑SM‑GW for delivery to the
subscriber, possibly after transport-level and/or service-level interworking.
Prior to this interworking, the IP‑SM‑GW shall check for UE availability. If
the UE is not registered in IMS, and delivery over CS/PS is unsuccessful (see
clause 6.5a), the IP‑SM‑GW returns an appropriate error response to SMS‑SC.
The SMS-SC then informs the HSS/HLR about the unavailability of the UE. After
an unsuccessful SM termination procedure due to the UE being unavailable, the
HSS records the MWD i.e. the SMS‑SC address which stores the un-delivered
message and the failure reason which indicates that the message failed to be
sent by IP‑SM‑GW due to the UE not being available, for a subsequent Alert
service centre procedure.
At any time after the unsuccessful SM termination procedure, the UE may attach
in the PS and or CS domain again, in which case a Ready for SM message from
the SGSN or MSC is sent to the HLR/HSS as described in TS 23.040 [2]. The
HLR/HSS initiates an Alert service centre procedure to the SM‑IWMSC when the
user\'s MWD is not NULL, and the procedure continues as described in step 3.
2) At any time after the unsuccessful SM termination procedure, the status of
the UE may indicate that the UE is available due to, e.g. registration in IMS
(step 2a). At that point UE-Not-Reachable-for-IP (UNRI) is updated in HLR/HSS,
as described in TS 23.040 [2]. After the IMS registration is finished, the
procedure continues as described in step 3.
At any time after the unsuccessful SM termination procedure, the HSS can
receive a notification from the transport layer e.g. MME that the UE is
reachable again (step 2b). As the IP-SM-GW has subscribed to the event as
described in clause 6.5a, the HSS shall notify the IP-SM-GW of the UE being
reachable again (step 2c). If the UE is already registered in IMS, the IP-SM-
GW shall then send a Ready for SM message to the HLR/HSS (step 2d) and the
procedure continues as described in step 3. Otherwise, the IP-SM-GW discards
the notification message. The procedure will resume when one of the conditions
described in steps 1 and 2 is fulfilled.
3) The HLR/HSS checks the user\'s MWD. If MWD is not Null, the HLR/HSS
initiates an Alert service centre message to the SMS‑IWMSC.
4) The SMS‑IWMSC forwards the Alert service centre procedure to the responding
SMS‑SC.
5) Upon receipt of the Alert service centre message, the SMS‑SC re-attempts to
send the stored Short Message. The message is transmitted to IP-SM-GW and
thereafter to the UE after appropriate interworking (transport-level and/or
service-level interworking) is performed. The UE acknowledges the reception of
the message.
## 6.6 Transport-level interworking: Alert service centre procedure when
memory capacity is available
If the HLR/HSS has recorded the MWD with a failure reason that the message
failed to be sent by IP‑SM‑GW due to the memory capacity of the UE is
exceeded, once the HLR/HSS receives a message from any of the domain
indicating that the memory capacity of the UE is available again, e.g. form
the IMS, PS or CS domain, the HLR/HSS initiates a Alert service centre
procedure to request the SMSC to re-send the stored message.
The following figure only shows an example where the HLR/HSS invokes the Alert
service centre procedure when the memory capacity available message is
received from IMS.
Figure 6.6: Alert service centre procedure when memory capacity is available
1) If SM termination attempts (via IP-SM-GW) failed because the UE's Memory
Capacity Exceeded, the message to be transferred to IP Based UE is queued in
the SMS-SC.
2) UE sends a message to IP-SM-GW indicating that the UE has memory available
to receive one or more Short Messages.
3) IP-SM-GW notifies the HLR/HSS of memory being available in the UE.
4) If the HLR/HSS receives the indication that the UE has memory available to
receive one or more Short Messages, it initiates a Alert service centre
procedure with the SC address and the MSIsdn‑Alert to SMS‑IWMSC as described
in TS 23.040 [2].
5) The SMS‑IWMSC forwards the Alert service centre message to the SMS-SC whose
address was provided by the HLR/HSS in step 4.
## 6.7 Service-level Interworking: IM capable UE sends an Instant Message to
an SMS user
Figure 6.7: Successful IM origination to SMS procedure
1) The UE registers to S-CSCF according the IMS registration procedure.
2) UE submits the Instant Message to the S-CSCF using an appropriate SIP
method. The UE may request to hide its Public User Identity from the recipient
within the Instant Message, as described in OMA‑TS‑SIMPLE_IM‑V1_0‑20070816‑C
[12].
3) S-CSCF forwards the Instant Message to IP-SM-GW based on stored iFC.
NOTE 1: Subscribers with no subscription for service level interworking will
not be provided with the relevant iFCs.
4) The IP-SM-GW shall decide whether to perform service-level interworking
depending on SIP request header (e.g. Request-URI), operator policy, when the
Instant Message is not routable in the IMS. If IP-SM-GW decided to perform
service-level interworking, the IP-SM-GW performs service authorization based
on the stored subscriber data retrieved from the HLR/HSS at the time of the
registration procedure as specified in clause 6.1. The IP-SM-GW shall check
whether the originating subscriber is authorised to use the interworking
service. If the result of service authorization is negative, the IP-SM-GW
shall not forward the message, and shall return the appropriate error
information to the UE in a failure report. Otherwise, the IP-SM-GW shall use
the SC Address in the subscriber data retrieved from the HSS at registration
or provisioned by configuration and translates the Instant Message to a Short
Message (SMS- SUBMIT) carrying SC Address, then forwards it towards SMS-SC (SC
Address) via the SMS-IWMSC (as described in TS 23.040 [2]). If the size of the
content of the Instant Message is larger than the size of the content that one
Short Message could transfer, the IP-SM-GW shall split the content of the
Instant Message into several parts, translate them to concatenated Short
Messages, and forward the concatenated Short Messages to the SMS-SC as
described in TS 23.040 [2]. If the sender of the Instant Message requests to
hide its Public User Identity from the recipient and operator policy allows
for this, the IP-SM-GW shall anonymise the identity of the user to the
recipient. Otherwise, if operator policy prohibits this, the IP SM GW shall
return an appropriate error to the user.
5) If service authorization is successful, the IP-SM-GW acknowledges the
Instant Message.
6) Instant Message acknowledgement is forwarded by S-CSCF to UE.
NOTE 2: Steps 5 and 6 can occur anytime after the subscriber authorization
check has been performed by the IP‑SM‑GW.
7) The SMS-IWMSC forwards the Short Message (SMS- SUBMIT) to the SMS-SC (see
TS 23.040 [2]).
8) The SMS-SC sends a Submit report (SMS-SUBMIT REPORT) to the SMS-IWMSC (see
TS 23.040 [2]).
9) SMS-IWMSC sends a Submit report to IP-SM-GW (see TS 23.040 [2]).
NOTE 3: The procedure can end in step 9. Steps 10 to 13 occur only if the IM
user requested a processing notification in the Instant Message sent in step
2, as described in IETF RFC 5438 [13].
10) IP-SM-GW translates the received Submit report to an appropriate Instant
Message, and forwards it to the S‑CSCF. If the IP‑SM‑GW sent concatenated
Short Messages to SMS-SC in step 4, the IP‑SM‑GW should wait for the last
Submit report, and translate the last Submit report to an appropriate Instant
Message, and forward it to the S‑CSCF.
11) S-CSCF sends the translated Instant Message to the UE.
12) UE acknowledges the translated Instant Message.
13) Acknowledgement of the translated Instant Message is forwarded by S-CSCF
to IP-SM-GW.
## 6.8 Interaction between transport-level and service-level Interworking
### 6.8.1 General
The interaction between transport-level interworking (between SMS over CS/PS
and SMS over IMS) and service-level interworking (between Instant Messaging
and SMS) depends on the user subscription and authorisation, on the UE
capabilities, and on operator policy.
If a user is only subscribed to either transport-level interworking or
service-level interworking, only procedures defined for the subscribed
interworking may be performed.
If a user is subscribed to both transport-level interworking and service-level
interworking, but the user is only authorised for one of the interworking when
the message is processed, only the authorised interworking may be performed.
If a user is subscribed to both transport-level interworking and service-level
interworking, and is authorised for both, the behaviour of the IP-SM-GW
depends on the specific scenario, on the registered capabilities of the UE,
and finally is defined by operator policy and user preferences.
For a user subscribed to service-level interworking, two Application Servers
in the network are normally called upon to handle an Instant Message:
\- the IM AS, defined in OMA-TS-SIMPLE_IM-V1_0-20070816-C [12];
\- the IP-SM-GW.
The following sections describe the different interaction scenarios.
### 6.8.2 IMS Originating
In the originating network, a UE sends a SIP MESSAGE (Encapsulated Short
Message or Instant Message). The originating S‑CSCF forwards the SIP MESSAGE
to the IP-SM-GW based on the iFC. The subscription of the transport level
interworking and the service level interworking applies for different iFC.
However, the SIP MESSAGE is forwarded to the IP-SM-GW if the user subscribes
to one of the interworking services. If there is no subscription for the
interworking service, the S‑CSCF continues with the subsequent iFC check.
After all the originating iFC triggers have been handled, the S‑CSCF attempts
to route the message to the terminating IMS network. If it fails, an error is
returned to the sender.
NOTE 1: if an IM AS is present in the network, Instant Messages are routed to
it before going to the IP-SM-GW.
NOTE 2: An encapsulated Short Message uses the PSI of the SC as the Request-
URI. If the user is not subscribed to transport-level interworking and the IP-
SM-GW is not invoked, the ENUM query fails, and an error is returned to the
sender.
When the IP-SM-GW receives the SIP MESSAGE, it shall decide which interworking
should be performed based on the content of the received SIP MESSAGE, as the
IP-SM-GW can distinguish between an encapsulated Short Message and an Instant
Message. If an encapsulated Short Message is received and if the subscriber is
authorised for the service, the IP-SM-GW maps the encapsulated Short Message
to a Short Message. Similarly, when an Instant Message is received, the IP-SM-
GW considers performing the service-level interworking if the service is
authorized: the IP‑SM‑GW shall decide whether to send the SIP MESSAGE via
interworking service based on SIP request header (e.g., R‑URI), operator
policy, when the Instant Message is not routable in the IMS.
Figure 6.8.2.1: Performing interworking service on originating side
### 6.8.3 IMS Terminating
When the IP-SM-GW receives a Short Message from the legacy network on the
terminating side, it performs the domain selection to determine the preferred
domain to transfer the short message. If the selected network is IMS, the IP-
SM-GW will determine whether the transport level interworking or the service
level interworking is to be preformed based on the users\' subscription and
authorisation, and on the UE capability as indicated during IMS registration.
If the user has subscribed to both services, is authorised for both and the UE
has indicated its capability to receive both encapsulated Short Messages and
Instant messages, the priority between the transport-level interworking and
the service-level interworking is based on operator policy and user
preferences.
NOTE 1: If the incoming Short Message is interworked to an Instant Message,
the resulting Instant Message could be routed to the IM AS before being sent
to the UE.
Figure 6.8.3.1: Performing interworking service on terminating side for an
incoming Short Message
When the IP-SM-GW receives an Instant Message, based on user subscription and
authorisation for service-level interworking, on operator policy and user
preferences, and on UE capability indicated during IMS registration, the
IP‑SM‑GW may perform service-level interworking to transform the message
format to SMS and deliver the message to the UE. If the user is subscribed and
authorised for transport-level interworking, and based on UE capability
indicated during IMS registration, and on operator policy and user
preferences, the message may be delivered as an encapsulated Short Message to
the UE over IMS. Otherwise, the Short Message is delivered over CS/PS.
## 6.9 Service-level Interworking: Concatenated Short Messages delivered as a
large Instant Message
An IMS registered user with IM service receives a concatenated short message
delivered as two or more short messages. The information below describes the
behaviour when the received concatenated Short Message exceed the maximum
payload size of an Instant Message.
Figure 6.9: Concatenated Short Messages delivered as an IM large message
1) The UE registers to the S-CSCF according to the IMS registration procedure.
2) The SMS-SC forwards a Short Message that is part of a concatenation of two
or more Short Messages to the SMS-GMSC.
3a) The SMS GMSC interrogates the HSS to retrieve routeing information. Based
on the pre-configured IP-SM-GW address for the user, the HSS forwards the
request to the corresponding IP-SM-GW.
3b) The HLR/HSS returns the IMSI and the address(es) of the current MSC and/or
SGSN to the IP-SM-GW for delivery of the SMS SM in CS/PS domain.
3c) The IP-SM-GW creates a MT Correlation ID as per TS 23.040 [2], which
associates the Routeing Info retrieval with the subsequent Forward Short
Message messages(s), and stores this along with the IMSI of the receiving
subscriber. The IP-SM-GW returns to the SMS-GMSC the address of itself, along
with the MT Correlation ID in the IMSI field, as routeing information.
Alternatively, the IP-SM-GW may return the address(es) of the current MSC
and/or SGSN, in which case, the subsequent procedure to forward the message is
the same as defined in TS 23.040 [2].
4) The SMS-GMSC delivers the Short Message to the IP-SM-GW in the same manner
that it delivers the Short Message to an MSC or SGSN, including the MT
Correlation ID received from the IP-SM-GW, in place of the IMSI.
5) The IP-SM-GW checks whether the recipient is authorized for the
interworking service. If the user is authorized, the IP-SM-GW recognizes that
the received message is part of a concatenated Short Message and stores the
received message.
NOTE 1: The IP-SM-GW needs to have access to a persistent storage in order to
aggregate all the Short Message parts.
6) The IP-SM-GW acknowledges the Forward Short Message to the SMS-GMSC.
7) The SMS-GMSC may send a Report SM Delivery Status to the HSS. The HSS shall
ignore the information provided in this report.
8) The SMS-GMSC sends a Delivery report (SMS-DELIVER-REPORT) to the SMS-SC.
9) The SMS-SC forwards the next Short Message that is part of a concatenation
of two or more Short Messages to the SMS-GMSC.
NOTE 2: If this is not the last Short Message of the concatenation, then
processing continues at step 4.
10) If this is the last Short Message of the concatenation, then the SMS GMSC
delivers the Short Message to the IP-SM-GW in the same manner that it delivers
the Short Message to an MSC or SGSN, including the MT Correlation ID received
from the IP-SM-GW, in place of the IMSI.
11) The IP-SM-GW checks whether the recipient is authorized for the
interworking service. If the user is authorized, the IP-SM-GW recognizes that
the received message is part of a concatenated Short Message and stores it.
12-13) Once all the segments have been received, the IP-SM-GW establishes an
MSRP session with the recipient\'s UE to deliver the message. The session
invitation is sent to the recipient UE.
NOTE 3: As a matter of implementation efficiency, the IP-SM-GW may initiate
the connection towards the recipient after receiving the first Forward Short
Message and passing a service authorization check. This may help prevent
timeouts at the SMS GMSC (while it waits for the final Delivery report) but
may also result in unnecessary session initiation signalling if there is a
failure in a service check for subsequently received Short Messages.
14) The IP-SM-GW delivers the message in one or more MSRP SEND requests to the
recipient UE.
15) -16) The IP-SM-GW closes the session after message delivery is complete.
17) The IP-SM-GW acknowledges the Forward Short Message to the SMS-GMSC.
18) The IP-SM-GW may send a Report SM Delivery Status to the HLR/HSS for
either of the following cases:
\- setting of the Message Waiting flags when the Forward Short Message was
unsuccessful;
\- clearing of the Message Waiting flags in HLR/HSS when the Forward Short
Message was successful, but had previously failed.
NOTE 4: See TS 23.040 [2] for a full explanation of when the Message Waiting
flags are set and unset.
19) The SMS-GMSC may send a Report SM Delivery Status to the HSS. The HSS
shall ignore the information provided in this report.
20) The SMS-GMSC sends a Delivery report (SMS-DELIVER-REPORT) to the SMS-SC.
## 6.10 Service-level interworking: Status Report procedure for Instant
Message to Short Message interworking
Figure 6.10: Status report procedure for Instant Message to Short Message
interworking
1) An Instant Message from the UE is successfully delivered to the SMS user
after service-level interworking. The original Instant Message requested a
Disposition Notification.
NOTE 1: A Disposition Notification can be requested in the message sent by the
UE in step 1 as described in IETF RFC 5438 [13]. If the requested Disposition
Notification by the IM user is a request for a read notification, the IP-SM-GW
ignores the request.
2) The SMS-SC sends a Status report to the SMS-GMSC.
NOTE 2: The Status report will, from the SMS-GMSC\'s point of view be treated
as any SM termination.
NOTE 3: The Status report is an optional message.
3a) The SMS GMSC interrogates the HLR/HSS to retrieve routeing information.
Based on the pre-configured IP-SM-GW address for the user, the HLR/HSS
forwards the request to the corresponding IP-SM-GW.
3b) The HLR/HSS returns the IMSI and the address(es) of the current MSC and/or
SGSN to the IP-SM-GW for delivery of the Short Message in CS/PS domain.
3c) The IP-SM-GW creates a MT Correlation ID as per TS 23.040 [2], which
associates the Routing Info retrieval with the subsequent Forward Short
Message messages(s), and stores this along with the IMSI of the receiving
subscriber. The IP-SM-GW returns to the SMS-GMSC the address of itself, along
with the MT Correlation ID in the IMSI field, as routeing information.
Alternatively, the IP-SM-GW may return the address(es) of the current MSC
and/or SGSN, in which case, the subsequent procedure to forward the message is
the same as defined in TS 23.040 [2].
4) The SMS-GMSC sends the status report in the Forward Short Message to the
IP-SM-GW.
NOTE 4: Steps 5 to 11 only occur if the original IM requested a delivery
notification in the Disposition Notification.
5) The IP-SM-GW translates and maps the Status report in the Forward Short
Message into an Instant Message carrying a Delivery Notification as described
in the IETF RFC 5438 [13]. The IP‑SM‑GW should keep the message id for a
message for which IMDN was requested so it can send the message id to the UE
in the IMDN.
6-7) The IP-SM-GW sends a Delivery Notification within an Instant Message to
the S-CSCF, which sends the Instant Message to the UE.
8-9) The UE acknowledges receipt of the Instant Message containing the
Delivery Notification to the S-CSCF. The S‑CSCF sends the acknowledgment to
the IP-SM-GW.
10) The IP-SM-GW sends a Delivery report (SMS-DELIVER-REPORT) to the SMS-GMSC.
11) The SMS-GMSC sends an acknowledgement back to the SMS-SC.
## 6.11 IM user sends an Instant Message to an SMSIP UE
An IMS registered user with SIMPLE IM service sends an Instant Message via
service-level interworking as an encapsulated Short Message to an SMSIP UE,
which did not indicate support for SIMPLE IM when registering to IMS.
NOTE 1: Based upon user subscription and depending on network deployment,
other Application Servers could be processing the incoming Instant Message
before the IP-SM-GW. The behaviour of the IM AS is described in OMA-TS-
SIMPLE_IM-V1_0-20070816-C [12].
Figure 6.11: Successful UE termination Instant Message to encapsulated Short
Message procedure
1) IM UE sends an Instant Message to the S-CSCF#1. The UE may request to hide
its Public User Identity from the recipient within the Instant Message, as
described in OMA‑TS‑SIMPLE_IM‑V1_0‑20070816‑C [12].
2) The S-CSCF#1 forwards the Instant Message to the S-CSCF#2.
3) The S-CSCF#2 forwards the Instant Message to the IP-SM-GW based on iFC.
4) Based on user subscription and authorisation for service-level
interworking, on operator policy and user preferences, and on UE capability
indicated during IMS registration, the IP-SM-GW shall decide whether to
perform service-level interworking. If the user is subscribed and authorised
for transport-level interworking, and based on UE capability indicated during
IMS registration, and on operator policy and user preferences, the message may
be delivered as an encapsulated Short Message to the UE over IMS. Otherwise,
the Short Message is delivered over CS/PS, as described in clause 6.13. If the
sender of the Instant Message requests to hide its Public User Identity from
the recipient and operator policy allows for this, the IP‑SM‑GW shall
anonymise the identity of the user to the recipient. Otherwise, if operator
policy prohibits this, the IP‑SM‑GW shall return an appropriate error to the
user.
NOTE 2: If a delivery notification was requested in the message sent by the UE
in step 1 as described in IETF RFC 5438 [13], the procedure for delivery
report described in clause 6.12 applies. Otherwise IP-SM-GW will just
acknowledge, at the SIP level, the Delivery report received from the SMSIP UE.
5) The IP-SM-GW forwards the encapsulated Short Message to the S-CSCF#2.
6) The S-CSCF#2 forwards the encapsulated Short Message to the SMSIP UE.
7) The SMSIP UE acknowledges the translated encapsulated Short Message.
8) The S-CSCF forwards the acknowledgement of the translated encapsulated
Short Message to the IP-SM-GW.
9-11) The IP-SM-GW forwards the acknowledgement of the translated encapsulated
Short Message to the originating IM UE.
## 6.12 Delivery report for an Instant Message delivered as encapsulated Short
Message
This procedure follows the procedure described in clause 6.11, when the
original Instant Message included a delivery notification request.
Figure 6.12: Delivery report after a successful Instant Message to
encapsulated Short Message procedure
NOTE: An encapsulated Short Message has been sent successfully according to
the procedure described in clause 6.11 before the procedure below can be
performed.
1-2) The SMSIP UE has received the Short Message as described in clause 6.11
and sends a Delivery report (SMS-DELIVER-REPORT) to the IP-SM-GW via the
S-CSCF.
3-4) The IP-SM-GW acknowledges, at the SIP level, the Delivery report to the
SMSIP UE via the S-CSCF.
5-7) The IP-SM-GW sends a Delivery Notification to the IM UE.
8-10) The IM UE acknowledges the reception of the Delivery Notification.
## 6.13 Service-level interworking: IM capable UE sends an Instant Message to
an SMS user with Interworking in the terminating side
This procedure describes the delivery of an Instant Message to a registered or
an un-registered IMS subscriber. For the unregistered case, the S‑CSCF
forwards the Instant Message to the IP‑SM‑GW based on the unregistered iFC of
the subscriber.
Figure 6.13: Successful IM terminating to SMS procedure with Interworking in
the Terminating Side
1) UE submits an Instant Message, destined to another IM user in another IMS
domain, using an appropriate SIP method. The UE may request to hide its Public
User Identity from the recipient within the Instant Message, as described in
OMA‑TS‑SIMPLE_IM‑V1_0‑20070816‑C [12].
2) The S-CSCF resolves the destination domain and routes the message towards
the S-CSCF in the terminating network (\"Terminating S-CSCF\").
3) The terminating S-CSCF forwards the Instant Message to the IM AS
(\"Terminating IM AS\") based on stored iFC.
NOTE: Depending on iFC configuration, it is possible that the IM AS is not
triggered for the unregistered subscribers.
4) The terminating IM AS invokes terminating IM services as applicable for the
destination IM user.
5) The IM AS can forward the Instant Message back to the terminating S-CSCF,
e.g. the terminating IM user is offline.
6) The terminating S-CSCF forwards the Instant Message to the IP-SM-GW, e.g.
based on stored iFC.
7) If the user is authorized, the IP-SM-GW performs service-level interworking
by converting the Instant Message to Short Message. The IP-SM-GW shall obtain
the routeing information for the UE from the HLR/HSS and deliver the message
to the UE. If the sender of the Instant Message requests to hide its Public
User Identity from the recipient and operator policy allows for this, the
IP‑SM‑GW shall anonymise the identity of the user to the recipient. Otherwise,
if operator policy prohibits this, the IP‑SM‑GW shall return an appropriate
error to the user.
8) The IP-SM-GW obtains the routeing information for the destination UE from
the HLR/HSS.
9) The IP-SM-GW sends the Forward Short Message message to the target MSC.
10) The MSC sends the Short Message to the UE.
11) The UE acknowledges the receipt of the Short Message.
12) The MSC sends a Delivery report (SMS-DELIVER-REPORT) to the IP-SM-GW.
13) The IP-SM-GW sends OK response to the terminating S-CSCF.
14) The S-CSCF forwards the OK to the terminating IM AS.
15) The terminating IM AS forwards the OK response back to the terminating
S-CSCF.
16) The terminating S-CSCF forwards the OK back towards the originating
S-CSCF.
17) The originating S-CSCF forwards the OK to the originating UE.
## 6.14 Service-level interworking: IM user receives Short Message from an SMS
user
An IMS registered user with SIMPLE IM service receives a Short Message
formatted via service-level interworking to an Instant Message.
Figure 6.14: Successful IM termination after service-level interworking
1) The UE registers to the S-CSCF according to the IMS registration procedure.
2) The SMS-SC forwards a Short Message to the SMS-GMSC.
3a) The SMS GMSC interrogates the HSS to retrieve routeing information. Based
on the pre-configured IP-SM-GW address for the user, the HSS forwards the
request to the corresponding IP-SM-GW.
3b) The HLR/HSS returns the IMSI and the address(es) of the current MSC and/or
SGSN to the IP-SM-GW for delivery of the SM in CS/PS domain.
3c) The IP-SM-GW creates a MT Correlation ID as per TS 23.040 [2], which
associates the Routing Info retrieval with the subsequent Forward Short
Message messages(s), and stores this along with the IMSI of the receiving
subscriber. The IP-SM-GW returns to the SMS-GMSC the address of itself, along
with the MT Correlation ID in the IMSI field, as routeing information.
4) The SMS-GMSC delivers the Short Message to the IP-SM-GW in the same manner
that it delivers the Short Message to an MSC or SGSN, including the MT
Correlation ID received from the IP-SM-GW, in place of the IMSI.
5) The IP-SM-GW checks whether the recipient is authorized for the
interworking service.
NOTE 1: The IP-SM-GW will determine whether the transport-level interworking
or the service-level interworking is to be performed according to clause
6.8.3.
6) If the user is authorized for service-level interworking, the IP-SM-GW
converts the Short Message to an Instant Message. It sends the Instant Message
using the appropriate SIP method towards the S-CSCF.
7) The S-CSCF forwards the Instant Message to the UE.
8) The UE acknowledges the SIP request to the S-CSCF.
9) The S-CSCF forwards the acknowledgement of the SIP request to the IP-SM-GW.
10) The IP-SM-GW acknowledges the Forward Short Message to the SMS-GMSC.
11) The SMS-GMSC sends a Delivery report (SMS‑DELIVER‑REPORT) to the SMS‑SC.
12) The IP‑SM‑GW may send a Report SM Delivery Status to the HLR/HSS.
13) The SMS-GMSC may send a Report SM Delivery Status to the HSS. The HSS
shall ignore the information provided in this report.
###### ## Annex A (informative): Service-level interworking: IM user sends an
Instant Message to a group list including SMS users
Figure A.1: IM user sends an Instant Message to a group list via service-level
interworking
1) The UE registers to S-CSCF according the IMS registration procedure.
2) UE generates Instant Message which includes group information, e.g. Group
identifier in the Request-URI and/or recipient list in the body of the Instant
Message. UE submits the Instant Message to the S-CSCF using an appropriate SIP
method.
3) Based on the stored iFC, S-CSCF forwards the Instant Message to an AS in
charge of the group delivery, e.g., the controlling function server defined in
OMA-TS-SIMPLE_IM-V1_0-20070816-C [12].
4) The group delivery AS replicates per Instant Message for per recipient
according to the group information it obtains acting as a B2BUA. See detail in
OMA-TS-SIMPLE_IM-V1_0-20070816-C [12].
5) The group delivery AS sends the generated multiple Instant Messages to
S-CSCF (e.g., the Instant Messages can be delivered as what the list server
does defined in the TS 24.247 [14]).
6) The S-CSCF forwards the Instant Messages to the IP-SM-GW based on the
stored iFC.
7) The IP-SM-GW shall decide whether to perform service-level interworking
depending on SIP request header (e.g. Request-URI), operator policy, when the
Instant Message is not routable in the IMS. If IP-SM-GW decided to perform
service-level interworking, the IP-SM-GW performs service authorization based
on the stored subscriber data retrieved from the HLR/HSS at the time of the
third party registration procedure as described in the clause 6.1. The IP-SM-
GW shall check whether the originating subscriber is authorised to use the
interworking service .If the result of service authorization is negative, the
IP-SM-GW shall not forward the message, and shall return the appropriate error
information to the UE in a failure report. Otherwise, the IP-SM-GW shall
translate the IMS message to a Short Message (SMS- SUBMIT) and forwards it
towards the SMS-SC (SC Address) via the SMS-IWMSC (as described in TS 23.040
[2]).
8) If service authorization is successful, the IP-SM-GW acknowledges the
Instant Messages.
9-11) Instant Message acknowledgement is forwarded by S-CSCF to UE.
12) The SMS-IWMSC forwards the Short Messages (SMS- SUBMIT) to the SMS-SC (see
TS 23.040 [2]).
13) The SMS-SC sends multiple Submit reports (SMS-SUBMIT REPORT) to SMS-IWMSC
(see TS 23.040 [2]).
14) SMS-IWMSC sends the Submit reports to IP-SM-GW (see TS 23.040 [2]).
15) IP-SM-GW translates the received Submit reports to appropriate IMS
delivery notifications defined in IETF RFC 5438 [13], and forwards the IMS
delivery notifications to the S-CSCF.
16) The S-CSCF forwards the IMS delivery notifications to the group delivery
AS.
17) The group delivery AS aggregates the delivery notifications of the same
type from different recipients into a single delivery notification.
18) The group delivery AS sends the delivery notification to the S‑CSCF.
19) The S-CSCF forwards the delivery notification to the UE.
20-23) Acknowledgement of the delivery notification is forwarded by S-CSCF to
IP-SM-GW.
#
# Foreword
This Technical Specification has been produced by the 3^rd^ Generation
Partnership Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# Introduction
User Equipment (UE) Test Loop functionality is a mandatory feature to support
E-UTRA / EPC conformance testing. It forms part of the core requirements and
thus has a direct impact on the design of the UE.
The test methods applied in RF Conformance Test Specification TS 36.521-1 [27]
and the test models used in Protocol Conformance Test Specifications TS
36.523-1 [30] and TS 36.523-3 [32] define the corresponding UE Test Loop
functionality. The present specification describes the location of the data
loop in the protocol stack as well as the procedure and specific messages to
activate/deactivate the Test Loop functionality in the UE.
# 1 Scope
The present document defines for User Equipment (UE) in E-UTRA FDD or TDD mode
those special functions and their activation/deactivation methods that are
required in UE for conformance testing purposes.
This document also describes the operation of these special functions for UEs
supporting E-UTRA FDD or TDD mode, when operating in UTRA FDD and TDD mode, in
GSM/GPRS mode, and in CDMA2000 mode.
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
  * References are either specific (identified by date of publication, > edition number, version number, etc.) or non‑specific.
  * For a specific reference, subsequent revisions do not apply.
  * For a non-specific reference, the latest version applies. In the > case of a reference to a 3GPP document (including a GSM document), > a non-specific reference implicitly refers to the latest version > of that document in the same Release as the present document.
[1] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[2] 3GPP TS 23.003: \"Numbering, Addressing and Identification\".
[3] 3GPP TS 23.122: \"Non-Access-Stratum functions related to Mobile Station
(MS) in idle mode\".
[4] 3GPP TS 23.401: \"3GPP System Architecture Evolution; GPRS enhancements
for E-UTRAN access\".
[5] 3GPP TS 24.007: \"Mobile radio interface signalling layer 3; General
aspects\".
[6] 3GPP TS 24.008: \"Mobile Radio Interface Layer 3 specification; Core
Network Protocols; Stage 3\".
[7] 3GPP TR 24.801: \"3GPP System Architecture Evolution; CT WG1 Aspects\".
[8] 3GPP TS 27.007: \"AT command set for User Equipment (UE)\".
[9] 3GPP TS 31.101: \"UICC-Terminal Interface; Physical and Logical
Characteristics\".
[10] 3GPP TS 34.108: \"Common Test Environments for User Equipment (UE)
Conformance Testing\".
[11] 3GPP TS 34.109: \"Terminal logical test interface; Special conformance
testing functions\".
[12] 3GPP TS 34.123-1: \"User Equipment (UE) conformance specification; Part
1: Protocol conformance specification\".
[13] 3GPP TS 34.123-2: \"User Equipment (UE) conformance specification; Part
2: Implementation Conformance Statement (ICS) proforma specification\".
[14] 3GPP TS 34.123-3: \"User Equipment (UE) conformance specification; Part
3: Abstract Test Suites (ATS)\".
[15] 3GPP TS 36.133: \"Requirements for support of Radio Resource
Management\".
[16] 3GPP TS 36.211: \"Physical Channels and Modulation\".
[17] 3GPP TS 36.212: \"Multiplexing and Channel Coding\".
[18] 3GPP TS 36.300: \"Evolved Universal Terrestrial Radio Access (E-UTRA) and
Evolved Universal Terrestrial Radio Access Network (E-UTRAN); Overall
description; Stage 2\".
[19] 3GPP TS 36.302: \"Services provided by the physical layer for E-UTRA\".
[20] 3GPP TS 36.304: \"Evolved Universal Terrestrial Radio Access (EUTRA) User
Equipment (UE) Procedures in idle mode \".
[21] 3GPP TS 36.306: \"Evolved Universal Terrestrial Radio Access (EUTRA) User
Equipment (UE) Radio Access capabilities \".
[22] 3GPP TS 36.321: \"Evolved Universal Terrestrial Radio Access (EUTRA)
Medium Access Control (MAC) protocol specification\".
[23] 3GPP TS 36.322: \"Evolved Universal Terrestrial Radio Access (EUTRA)
Radio Link Control (RLC) protocol specification\".
[24] 3GPP TS 36.323: \"Evolved Universal Terrestrial Radio Access (EUTRA)
Packet Data Convergence Protocol (PDCP) specification\".
[25] 3GPP TS 36.331: \"Evolved Universal Terrestrial Radio Access (EUTRA)
Radio Resource Control (RRC) Protocol Specification\".
[26] 3GPP TS 36.508: \"Evolved Universal Terrestrial Radio Access (E-UTRA) and
Evolved Packet Core (EPC); Common test environments for User Equipment (UE);
Conformance Testing\".
[27] 3GPP TS 36.521-1: \" Evolved Universal Terrestrial Radio Access (E-UTRA);
User Equipment (UE) conformance specification Radio transmission and
reception; Part 1: Conformance Testing\".
[28] 3GPP TS 36.521-2: \"Evolved Universal Terrestrial Radio Access (E-UTRA);
User Equipment (UE) conformance specification Radio transmission and
reception; Part 2: Implementation Conformance Statement (ICS)\".
[29] 3GPP TS 36.521-3: \"Evolved Universal Terrestrial Radio Access (E-UTRA);
User Equipment (UE) conformance specification Radio transmission and
reception; Part 3: Radio Resource Management Conformance Testing\".
[30] 3GPP TS 36.523-1: \" Evolved Universal Terrestrial Radio Access (E-UTRA)
and Evolved Packet Core (EPC); User Equipment (UE) conformance specification;
Part 1: Protocol conformance specification\".
[31] 3GPP TS 36.523-2: \"Evolved Universal Terrestrial Radio Access (E-UTRA)
and Evolved Packet Core (EPC); User Equipment (UE) conformance specification;
Part 2: Implementation Conformance Statement (ICS) proforma specification\".
[32] 3GPP TS 36.523-3: \" Evolved Universal Terrestrial Radio Access (E-UTRA)
and Evolved Packet Core (EPC)); User Equipment (UE) conformance specification;
Part 3: Abstract Test Suites (ATS)\".
[33] 3GPP TS 44.014: \"Individual equipment type requirements and
interworking; Special conformance testing functions\".
[34] 3GPP TS 51.010-1: \"Mobile Station (MS) conformance specification; Part
1: Conformance specification \".
[35] ISO/IEC 9646 (all parts): \"Information technology - Open Systems
Interconnection - Conformance testing methodology and framework\".
[36] 3GPP TS 24.301: \"Non-Access-Stratum (NAS) protocol for Evolved Packet
System (EPS); Stage 3\".
# 3 Definitions and abbreviations
## 3.1 Definitions
For the purposes of the present document, the terms and definitions given in
TR 21.905 [1] apply, unless specified below:
Bi-directional Data Radio Bearer: Data radio bearer identified by a data radio
bearer identifier capable to deliver data in both downlink and uplink
Logical Test Interface: interface which provides the logical service to
interwork and to communicate between UE and System Simulator during the test
of a UE
SS (System Simulator): test system (or equipment) that drives the test process
with UE, like eNB (evolved Node B) simulator
TC (Test Control): UE protocol entity used by the SS to control the UE
specific testing functions
UE (User Equipment): user equipment as defined in [1] that is under test
User: test user, who handles the test and measurement process via the logical
test interface
## 3.2 Abbreviations
For the purposes of the present document, the abbreviations specified in TR
21.905 [1] apply, with any additional abbreviations specified below:
DRB Data Radio Bearer
EMM EPS Mobility Management
ENB Evolved Node B
EPS Bearer Evolved Packet System Bearer
ESM EPS Session Management
LB Loop Back
MAC Media Access Control
MTC Main Test Component
RAB Radio Access Bearer
RMC Reference Measurement Channel
ROHC Robust Header Compression
SDF Service Data Flow
SS System Simulator
TC Test Control
# 4 UE special conformance test functions
## 4.1 General description
The SS performs activation and deactivation of the conformance test functions
in the UE by sending Security Protected NAS Layer 3 messages. Apart from
sending the appropriate deactivation command to the UE the functions shall be
deactivated by:
switching off the UE; or
by removing the USIM.
The following special UE conformance testing functions can be activated (and
deactivated):
\- UE test loop function;
\- Electrical Man Machine Interface (EMMI).
The following Test Control (TC) procedures are used to control the UE test
loop function:
\- Close UE test loop;
\- Open UE test loop.
No specific TC procedures are associated with EMMI.
# 5 Test Control (TC) protocol procedures and test loop operation
## 5.1 General description
The UE test loop function provides access to isolated functions of the UE via
the radio interface without introducing new physical interfaces just for the
reason of conformance testing.
NOTE: It should be emphasised that the UE test loop function only describes
the functional behaviour of the UE with respect to its external interfaces;
physical implementation of the UE test loop function is completely left open
to the manufacturer.
The UE test loop function is activated by transmitting the appropriate TC
message to the UE, see clause 6.
The UE test loop function can be operated in two different loopback modes:
\- UE test loop mode A; and
\- UE test loop mode B.
UE test loop mode A provides loopback of PDCP SDUs for bi-directional data
radio bearers while UE is operating in E-UTRA mode. The downlink PDCP SDUs
received by the UE on each bi-directional data radio bearer are returned on
the same radio bearer regardless of the PDCP SDU contents and of the TFT of
the associated EPS bearer context [36].
UE test loop mode B provides loopback of PDCP SDUs (E-UTRA and UTRA), SNDCP
PDUs (GSM/GPRS) and RLP PDUs (CDMA2000) for bi-directional EPS bearers while
UE is operated in E-UTRA, UTRA, GSM/GPRS or CDMA2000 modes. UE test loop mode
B can not be used when more than one PDN connection is established or more
than one primary PDP context is active. When operating in E-UTRA, the downlink
PDCP SDUs received by the UE on all bi-directional data radio bearers are
returned by the UE on the data radio bearer associated with an EPS bearer
context with a TFT matching the TCP/UDP/IP protocol information within the
PDCP SDU [36]. When operating in UTRA, GSM/GPRS or CDMA2000 modes, the
downlink PDCP SDUs received by the UE on all bi-directional data radio bearers
are returned by the UE on the data radio bearer with the smallest identity,
regardless of the PDCP SDU contents and of the TFT of the associated EPS
bearer context.
UE test loop mode A is mandatory to all E-UTRA UEs.
UE test loop mode B for operation in E-UTRA mode is mandatory to all E-UTRA
UEs.
UE test loop mode B for operation in UTRA mode is mandatory to all E-UTRA UEs
supporting UTRA radio access.
UE test loop mode B for operation in GSM/GPRS mode is mandatory to all E-UTRA
UEs supporting GSM/GPRS radio access.
UE test loop mode B for operation in CDMA2000 mode is mandatory to all E-UTRA
UEs supporting CDMA2000 radio access.
For E-UTRA UE supporting multiple radio access technologies then UE reception
of Test Control messages is limited to UE operating in E-UTRA mode, while
continuation of loopback of user data is provided over the change to other UE
supported radio access technologies.
UE test loop mode B for operation in UTRA, GSM/GPRS and CDMA2000 mode is only
applicable for loopback of user data in PS domain.
The TC entity may be seen as a L3 or a NAS entity.
Figure 5.1-1 shows a functional block diagram of UE test loop function for TC
entity and UE test loop mode A. The loopback of PDCP SDUs for UE test loop
mode A is specified in sub clause 5.3.3.
Figure 5.1-2 shows a functional block diagram of UE test loop function for TC
entity and UE test loop mode B. The loopback of IP PDUs/PDCP SDUs for UE test
loop mode B and UE in E-UTRA mode is specified in subclauses 5.3.4.2 and
5.3.4.3.
Figure 5.1-3 shows a functional block diagram of UE test loop function for UE
test loop mode B and UE operating in UTRA mode. The loopback of IP PDUs/PDCP
SDUs for UE test loop mode B and UE in UTRA mode is specified in subclauses
5.3.4.4 and 5.3.4.5.
Figure 5.1-4 shows a functional block diagram of UE test loop function for UE
test loop mode B for UE operating in GSM/GPRS mode. The loopback of IP
PDUs/SNDCP SDUs for UE test loop mode B and UE in GSM/GPRS mode is specified
in subclauses 5.3.4.6 and 5.3.4.7.
Figure 5.1-5 shows a functional block diagram of UE test loop function for UE
test loop mode B for UE operating in CDMA2000 mode. The loopback of IP
PDUs/RLP SDUs for UE test loop mode B and UE in CDMA2000 mode is specified in
subclauses 5.3.4.8 and 5.3.4.9.
NOTE: ROHC functionality in PDCP Layer 2 is optional for UE implementations.
Figure 5.1-1: Model for Test Control and UE Test Loop Mode A on UE side for
E-UTRA
Figure 5.1-2: Model for Test Control and UE Test Loop Mode B on UE side for
E-UTRA
{width="2.645138888888889in" height="5.343055555555556in"}
Figure 5.1-3: Model for UE Test Loop Mode B on UE side for UTRA
{width="3.3847222222222224in" height="4.71875in"}
Figure 5.1-4: Model for UE Test Loop Mode B on UE side for GSM/GPRS
{width="3.0097222222222224in" height="3.8333333333333335in"}
Figure 5.1-5: Model for UE Test Loop Mode B on UE side for CDMA2000
## 5.2 Security protection of test control messages
The test control messages, i.e. ACTIVATE TEST MODE, DEACTIVATE TEST MODE,
CLOSE UE TEST LOOP, and OPEN UE TEST LOOP, are integrity protected and
ciphered according to TS 24.301 clause 4.4.
## 5.3 UE test mode procedures
### 5.3.1 General
The UE test mode procedures are intended for setting the UE into a test mode
where the SS can set up data radio bearers (UE test loop mode A) or EPS
bearers (UE test loop mode B) to be terminated in the UE test loop function;
as well as, for making UE leave the test mode if it has previously been set
into it and return to normal operation.
### 5.3.2 Activate UE test mode
Figure 5.3.2-1: Activate UE test mode procedure
#### 5.3.2.1 General
The SS uses the activate UE test mode procedure to get the UE into a test mode
where the SS can set up one or more sets of data radio bearers with an
associated EPS bearer context (UE test loop mode A) or EPS bearers (UE test
loop mode B) before commanding the UE to terminate them in the UE test loop
function. The activation of the UE test loop function in UE test loop mode A
or UE test loop mode B will control if the UE is terminating the data radio
bearers or the EPS bearers in the UE test loop function.
#### 5.3.2.2 Initiation
The SS can activate the UE test mode when UE is in E-UTRA connected state.
NOTE: Refer to TS 36.508 [28] subclause 4.5.1 for more details on UE states.
The SS requests the UE to activate the UE test mode by transmitting an
ACTIVATE TEST MODE message.
#### 5.3.2.3 Reception of ACTIVATE TEST MODE message by UE
Upon receiving the ACTIVATE TEST MODE message the UE shall:
1> if a default EPS bearer context is already activated:
2> the UE behaviour is unspecified.
  1. else:
2> activate the UE test mode;
2> send ACTIVATE TEST MODE COMPLETE message.
When the UE test mode is active:
1> the UE shall accept any request to establish a data radio bearer with an
associated EPS bearer context, both included in the same RRC message, and
within the radio access capabilities of the UE;
1> if neither test loop mode A operation nor test loop mode B operation is
ongoing:
2> if the UE is operating in E-UTRAN mode:
3> if the UE hasn\'t received the ACTIVATE DEFAULT EPS BEARER CONTEXT REQUEST
message in response to the PDN CONNECTIVITY REQUEST message included in an
ATTACH REQUEST message; or
3> if the UE has received the response message with the PDN type IE set to
\'IPv4\' and an IPv4 address value different from \'0.0.0.0\':
4> the UE may not transmit any uplink PDCP SDU on any DRB:
4> the UE may discard any received downlink PDCP SDU on any DRB is.
NOTE: If the UE has requested the use of DHCPv4 signalling for allocation of
an IPv4 address, the UE may either accept the IPv4 address provided via NAS
signalling and may not transmit any uplink PDCP SDU on any DRB and may discard
downlink PDCP SDUs on any DRB, or the UE may transmit and receive DHCPv4
messages to obtain an IPv4 address, according to the procedure described in TS
36.508 clause 4.5.2A.
3> if the UE has received the response message with the PDN type IE set to a
value different from \'IPv4\' or with the IPv4 address equal to \'0.0.0.0\';
4> the UE may transmit uplink PDCP SDUs on any DRB.
### 5.3.3 Deactivate UE test mode
Figure 5.3.3-1: Deactivate UE test mode procedure
#### 5.3.3.1 General
The purpose of this procedure is to deactivate the UE test mode and return UE
to normal operation.
NOTE: Deactivation of the UE test loop mode may occur as well as a result of
other events. For further details see e.g. 4.1, 5.4.2.1.
#### 5.3.3.2 Initiation
The SS can deactivate the UE test mode when UE is in E-UTRA connected state
and the UE test mode is active.
NOTE: Refer to TS 36.508 [28] subclause 4.5.1 for more details on UE states.
The SS requests the UE to deactivate the UE test mode by transmitting a
DEACTIVATE TEST MODE message.
#### 5.3.3.3 Reception of DEACTIVATE TEST MODE message by UE
Upon receiving the DEACTIVATE TEST MODE message the UE shall:
1> deactivate the UE test mode;
1> send a DEACTIVATE TEST MODE COMPLETE message.
## 5.4 UE test loop procedures
### 5.4.1 General
The UE test loop function is intended for:
\- E-UTRA RF receiver and transmitter testing to generate data transfer in
downlink and uplink.
\- E-UTRA layer 2 (MAC, RLC, PDCP) and data radio bearer testing to generate
data transfer in downlink and uplink.
\- EPC and E-UTRA layer 3 testing to verify data transfer continuation over
RRC and EPC procedures.
\- EPC NAS user-plane testing to verify uplink TFT handling.
\- E-UTRA/EPC Inter-system testing to verify data transfer continuation over
Inter-system change procedures to and from UTRA, GSM/GPRS and CDMA2000.
### 5.4.2 Close UE test loop
{width="3.7402777777777776in" height="1.6465277777777778in"}
Figure 5.4.2-1: Close UE test loop procedure
#### 5.4.2.1 General
The SS uses the close UE test loop procedure to start the UE Test Loop
function in the UE while in E-UTRA mode.
A prerequisite for UE test loop mode A is that at least one bi-directional
data radio bearer has been established between SS and UE.
A prerequisite for UE test loop mode B is that at least one EPS bearer context
has been established between SS and UE.
The UE shall provide for normal layer 1, layer 2, RRC, EMM and ESM
functionality while the UE test loop function is active. This includes (but is
not limited to) handover procedures and normal disconnection of the data radio
bearer.
For UE test loop mode A the loopback shall be maintained across handovers
within E-UTRA, but after data radio bearer release, the loopback shall cease
to exist.
For UE test loop mode B the loopback shall be maintained across handovers
within E-UTRA and between radio access system (E-UTRA to/from UTRA, E-UTRA
to/from GSM/GPRS and E-UTRA to/from CDMA2000). This means that any buffered IP
PDUs in the UE test loop function at the time of the intra- or inter-system
change shall be kept in the UE test loop function and being scheduled for
transmission transparently to the intra- or inter-system change.
For UE test loop mode A or B, UE shall not transmit any uplink U-plane data
other than the data returned by the loopback entity.
#### 5.4.2.1a UE test loop mode A PDCP SDU and UE test loop mode B IP PDU
buffer size requirement
The minimum UE loopback buffer size for PDCP SDUs (UE test loop mode A) and IP
PDUs (UE test loop mode B), when UE is operated in RLC AM or UM mode, shall be
according to table 5.4.2.1a-1. The UE behaviour, when the loopback buffer
capacity is exceeded, is unspecified.
Table 5.4.2.1a-1: Minimum loopback buffer size for different UE categories
+--------------------------------------+------------------------------+ | UE Category | Minimum loopback buffer size | | | | | | [byte] | | | | | | (note 1) | +--------------------------------------+------------------------------+ | Category 1 | 60000 | +--------------------------------------+------------------------------+ | Category 2 | 60000 | +--------------------------------------+------------------------------+ | Category 3 | 60000 | +--------------------------------------+------------------------------+ | Category 4 | 60000 | +--------------------------------------+------------------------------+ | Category 5 | 60000 | +--------------------------------------+------------------------------+ | Note 1: Minimum loopback buffer size | | | has been selected 1) for each UE | | | category such that the UE shall be | | | able to forward all data received in | | | one TTI when the applicable maximum | | | transport block size of the UE is | | | used, and 2) to allow execution of | | | MAC test case 7,1.4.3 in TS 36.523-1 | | | [30], which requires a minimum | | | loopback buffer size of 56922 bytes | | | for all UE categories. | | +--------------------------------------+------------------------------+
#### 5.4.2.2 Initiation
The SS can request the UE to close a test loop in mode A if at least one bi-
directional data radio bearer is established and the UE test mode is active.
The SS can request the UE to close a test loop in mode B if at least one EPS
bearer is established and the UE test mode is active.
The SS requests the UE to close its UE test loop mode A or UE test loop mode B
test loop(s) by transmitting a CLOSE UE TEST LOOP message.
#### 5.4.2.3 Reception of CLOSE UE TEST LOOP message by the UE
Upon receiving the CLOSE UE TEST LOOP message the UE shall:
1> if UE test loop mode A has been selected;
2> if no bi-directional data radio bearers are established or if the UE test
mode is not active; or
2> if test loop mode A or test loop mode B operation is already closed on one
or more data radio bearers:
3> the UE behaviour is unspecified
2> else:
3> for LB_ID=0 to MAX_ModeA_LB-1_entities:
4> set DRB_ID(LB_ID) to 0 (indicate no DRB mapped)
4> set UL_PDCP_SDU_scaling(LB_ID) to FALSE
3> set LB_ID to 0
3> for each established bi-directional data radio bearer in ascending order
and starting with the data radio bearer with the lowest configured Data Radio
bearer identity number:
4> if LB_ID is less than MAX_ModeA_LB_entities:
5> set DRB_ID(LB_ID) to the Data Radio bearer identity number
5> increment LB_ID by 1
4> else:
5> the UE behaviour is unspecified
3> if the UE test loop mode A setup IE is included:
4> for each LB Setup DRB IE in the LB setup list of the UE test loop mode A
setup IE:
5> for LB_ID=0 to MAX_ModeA_LB_entities-1:
> 6> if DRB_ID(LB_ID) is equal to the Data Radio bearer identity number
> parameter of the LB Setup DRB IE:
>
> 7> if the LB Setup DRB(LB_ID) IE is included:
>
> 7> set UL_PDCP_SDU_scaling(LB_ID) to TRUE
>
> 7> set UL_PDCP_SDU_size(LB_ID) to UL PDCP SDU size parameter of the LB Setup
> DRB(LB_ID) IE
3> perform the UE actions for UE Test Loop Mode A operation as specified in
subclause 5.4.3; and
3> send CLOSE UE TEST LOOP COMPLETE message (the loopback shall be operational
prior to the sending of the acknowledgement).
1> else if UE test loop mode B has been selected;
2> if no EPS bearer is established or if the UE test mode is not active; or
2> if the test loop is already active on one or more EPS bearers:
3> the UE behaviour is unspecified.
2> otherwise:
3> set TEST_LOOP_MODE_B_ACTIVE to TRUE
3> set timer T_delay_modeB to the value of IP PDU delay timer parameter of the
UE test loop mode B IE;
3> if the IP PDU delay timer parameter of the UE test loop mode B IE has a
value larger than zero:
4> set BUFFER_IP_PDUs to TRUE
3> else:
4> set BUFFER_IP_PDUs to FALSE
3> set CDMA2000_INITIATED to FALSE
3> perform the UE actions for UE Test Loop Mode B operation as specified in
subclause 5.4.4 and 5.4.4.1 to 5.4.4.11; and
3> send CLOSE UE TEST LOOP COMPLETE message (the loopback shall be operational
prior to the sending of the acknowledgement).
1> else;
2> the UE behaviour is unspecified.
### 5.4.3 UE test loop mode A operation
Upon receiving a PDCP SDU identified by LB_ID when operating in E-UTRA mode
with UE Test Loop Mode A active the UE shall:
1> if UL_PDCP_SDU_scaling(LB_ID) is FALSE:
2> take the PDCP SDU from the output of the PDCP Service Access Point (SAP)
and provide it as input to the correspondent PDCP SAP in uplink and transmit,
see Figure 5.4.3-1.
1> else:
2> if UL_PDCP_SDU_size(LB_ID) = 0:
3> discard the PDCP SDU (no data is returned).
2> else:
3> if the size of the received PDCP SDU in downlink is equal to
UL_PDCP_SDU_size(LB_ID):
4> take the PDCP SDU from the output of the PDCP SAP and provide it as input
to the correspondent PDCP SAP in uplink and transmit, see Figure 5.4.3-1.
3>else if the size of the received PDCP SDU in downlink is bigger than
UL_PDCP_SDU_size(LB_ID):
4> create a UL PDCP SDU of size UL_PDCP_SDU_size(LB_ID) by taking the first K
bits of the received PDCP SDU in downlink PDCP SAP, where K is equal to
UL_PDCP_SDU_size(LB_ID) and provide it as input to the correspondent PDCP SAP
in uplink and transmit, see Figure 5.4.3-2.
3> else if the size of the received PDCP SDU in downlink is less than
UL_PDCP_SDU_size(LB_ID):
4> create a UL PDCP SDU of size UL_PDCP_SDU_size(LB_ID) by repeating the data
received in downlink PDCP SDU in downlink to fill the UL PDCP SDU (truncating
the last block if necessary), provide it as input to the correspondent PDCP
SAP in uplink and transmit, see Figure 5.4.3-3.
Note: Size of the received PDCP SDUs in downlink shall be bit strings that are
byte aligned (i.e. multiple of 8 bits) according to TS 36.323 [24] clause
6.2.1.
{width="4.302083333333333in" height="2.2083333333333335in"}
Figure 5.4.3-1: Loop back of PDCP SDU\ (DL PDCP SDU size = UL PDCP SDU size =
N)
{width="3.8854166666666665in" height="2.3333333333333335in"}
Figure 5.4.3-2: DL > UL PDCP SDU block size\ (DL PDCP SDU size = N, UL PDCP
SDU size = K)
{width="4.552083333333333in" height="2.25in"}
Figure 5.4.3-3: DL \ if T_delay_modeB timer is running:
2> buffer the received PDCP SDU
1> else
2> if BUFFER_IP_PDUs is TRUE
3> buffer the received PDCP SDU
3> Start T_delay_modeB timer
2> else
3> submit the received PDCP SDU without any modification of the IP header to
the UL TFT handling SAP for transmission in uplink. See note.
Note: The UL TFT function in the UE is mapping IP PDUs received from SDF to
EPS bearer/radio bearer as configured by SS in the UL TFT IE sent as part of
the EPS bearer establishment procedures. See figure 5.1-2.
Note: Size of the received PDCP SDUs in downlink shall be bit strings that are
byte aligned (i.e. multiple of 8 bits) according to TS 36.323 [24] clause
6.2.1.
#### 5.4.4.3 Expiry of T_delay_modeB timer when UE is in E-UTRA mode
When timer T_delay_modeB expires when UE is operating in E-UTRA mode and has
UE Test Loop Mode B active then the UE shall:
1> submit the buffered PDCP SDUs in the same order as received (first-in-
first-out) and without any modification of the IP header to the UL TFT
handling SAP for transmission in uplink. See note 1.
1> set BUFFER_IP_PDUs to FALSE
Note 1: The UL TFT function in the UE is mapping IP PDUs received from SDF to
EPS bearer/radio bearer as configured by SS in the UL TFT IE sent as part of
the EPS bearer establishment procedures. See figure 5.1-2.
NOTE 2: After the PDCP SDU buffer becomes empty the loopback will return any
received PDCP SDU in uplink directly as specified in clause 5.4.4.2. In order
to reactivate the loopback delay and PDCP SDU buffering the SS shall
deactivate UE test loop B function first.
#### 5.4.4.4 Reception of IP PDUs when UE is in UTRA mode
When UE receives a PDCP SDU when UE is operating in UTRA mode and has UE Test
Loop Mode B active then the UE shall:
1> if T_delay_modeB timer is running:
2> buffer the received PDCP SDU
1> else
2> if BUFFER_IP_PDUs is TRUE
3> buffer the received PDCP SDU
3> Start T_delay_modeB timer
2> else
3> submit the received PDCP SDU without any modification of the IP header [to
the PDCP SAP for transmission in uplink on the radio bearer with the lowest
radio bearer identity number].
Editor's note: It is FFS at which layer the PDCP PDU is submitted for
transmission, directly to the PDCP SAP or to the UL TFT handling service
access point (SAP) for transmission in uplink on the EPS bearer/radio bearer
as configured by SS in the UL TFT IE sent as part of the radio bearer
establishment procedure.
#### 5.4.4.5 Expiry of T_delay_modeB timer when UE is in UTRA mode
When timer T_delay_modeB expires when UE is operating in UTRA mode and has UE
Test Loop Mode B active the then UE shall:
1> submit the buffered IP PDUs in the same order as received (first-in-first-
out) and without any modification of the IP header [to the PDCP SAP for
transmission in uplink on the radio bearer with the lowest radio bearer
identity number].
1> set BUFFER_IP_PDUs to FALSE.
Editor's note: It is FFS at which layer the PDCP PDU is submitted for
transmission, directly to the PDCP SAP or to the UL TFT handling service
access point (SAP) for transmission in uplink on the EPS bearer/radio bearer
as configured by SS in the UL TFT IE sent as part of the radio bearer
establishment procedure.
NOTE: After the IP PDU buffer becomes empty the loopback will return any
received PDCP SDU in uplink directly as specified in clause 5.4.4.4. In order
to reactivate the loopback delay and PDCP SDU buffering the SS shall
deactivate UE test loop B function and UE shall return to E-UTRA mode first.
#### 5.4.4.6 Reception of IP PDUs when UE is in GSM/GPRS mode
When UE receives a SNDCP SDU when UE is operating in GSM/GPRS mode and has UE
Test Loop Mode B active then the UE shall:
1> if T_delay_modeB timer is running:
2> buffer the received SNDCP SDU.
1> else
2> if BUFFER_IP_PDUs is TRUE;
3> buffer the received SNDCP SDU;
3> Start T_delay_modeB timer.
2> else
3> submit the received SNDCP SDU without any modification of the IP header to
the SNDCP SAP for transmission in uplink.
Editor\'s note: It is FFS on which NSAPI the SNDCP SDU is submitted (i.e. a
fixed NSAPI value or a value determined by the uplink TFT handling function).
#### 5.4.4.7 Expiry of T_delay_modeB timer when UE is in GSM/GPRS mode
When timer T_delay_modeB expires when UE is operating in GSM/GPRS mode and has
UE Test Loop Mode B active then the UE shall:
1> submit the buffered IP PDUs without any modification of the IP header in
the same order as received (first-in-first-out), to the SNDCP SAP for
transmission in uplink.
1> set BUFFER_IP_PDUs to FALSE
Editor\'s note: It is FFS on which NSAPI the SNDCP SDU is submitted (i.e. a
fixed NSAPI value or a value determined by the uplink TFT handling function).
NOTE: After the IP PDU buffer becomes empty the loopback will return any
received SNDCP SDU in uplink directly as specified in clause 5.4.4.6. In order
to reactivate the loopback delay and SNDCP SDU buffering the SS shall
deactivate UE test loop B function and UE shall return to E-UTRA mode first.
#### 5.4.4.8 Reception of IP PDUs when UE is in CDMA2000 mode
When UE receives a RLP SDU when UE is operating in CDMA2000 mode and has UE
Test Loop Mode B active then the UE shall:
1> if CDMA2000_INITIATED is FALSE:
2> if T_delay_modeB is running:
3> restart T_delay_modeB
2> else:
3> start T_delay_modeB
2> set CDMA2000_INITIATED to TRUE;
1> if T_delay_modeB is running;
2> deliver the received RLP SDU to upper layers;
1> else
2> submit the received RLP SDU without any modification of the IP header to
the RLP SAP for transmission in uplink.
NOTE: When CDMA2000_INITIATED is FALSE or when T_delay_modeB is running, the
UE may send RLP SDUs in uplink upon initiation from upper layers.
#### 5.4.4.9 Expiry of T_delay_modeB timer when UE is in CDMA2000 mode
When timer T_delay_modeB expires when UE is operating in CDMA2000 mode and has
UE Test Loop Mode B active then the UE shall not take any action.
#### 5.4.4.10 Establishment of the RRC/RR connection in E-UTRA, UTRA, GSM/GPRS
and CDMA2000 mode
When the RRC or the RR connection and one or more EPS bearers are is
established, in E-UTRA, UTRA, GSM/GPRS and CDMA2000 mode then the UE shall:
1> if TEST_LOOP_MODE_B_ACTIVE is set to TRUE;
2> perform the UE actions for UE Test Loop Mode B operation as specified in
subclause 5.4.4 and 5.4.4.1 to 5.4.4.11.
#### 5.4.4.11 Release of RRC/RR connection in E-UTRA, UTRA, GSM/GPRS and
CDMA2000 mode after T_delay_modeB timer has expired
When the RRC or the RR connection is released in E-UTRA, UTRA, GSM/GPRS and
CDMA2000 mode then the UE shall:
1> if UE test loop mode B is active; and
1> if BUFFER_IP_PDUs is TRUE or T_delay_modeB timer is running:
2> keep UE test loop mode B active
1> else
2> the UE behaviour is unspecified.
### 5.4.5 Open UE test loop
{width="3.7402777777777776in" height="1.6465277777777778in"}
Figure 5.4.5-1: Open UE test loop procedure
#### 5.4.5.1 General
The SS uses the procedure open UE test loop to deactivate the UE test loop
function in the UE.
#### 5.4.5.2 Initiation
The SS requests the UE to open all closed test loops by transmitting an OPEN
UE TEST LOOP message.
#### 5.4.5.3 Reception of OPEN UE TEST LOOP message by the UE
When UE receives the OPEN UE TEST LOOP message then the UE shall:
1> If no test loops are closed:
2> the UE behaviour is unspecified;
1> else if one or more test loops are closed:
2> open all test loops;
2> if TEST_LOOP_MODE_B_ACTIVE is TRUE
3> set TEST_LOOP_MODE_B_ACTIVE to FALSE
2> send OPEN UE TEST LOOP COMPLETE message;
NOTE: The UE test mode is still active so the UE continues behaving as
described in 5.3.2.3
# 6 Message definitions and contents
In this clause, only TC protocol messages are described. TC messages are
intended to be sent using the _DLInformationTransfer_ and
_ULInformationTransfer_ procedures, see TS 36.331 [25], sub clause 5.6.1 and
5.6.2.
NOTE 1: A message received with skip indicator different from 0 will be
ignored.
NOTE 2: For general definition of Layer 3 message format see TS 24.007 [5],
clause 11.
NOTE 3: E-UTRA, UTRA and GSM/GPRS test control messages uses the same protocol
discriminator value (\"1111\"). Following message type value series are
reserved for GSM/GPRS testing commands as specified by TS 44.014 [33]:
0000xxxx, 0001xxxx and 0010xxxx where x represent 0 or 1. Following message
type value series are reserved for UTRA testing commands as specified by TS
34.109 [11]: 0100xxxx where x represent 0 or 1. For E-UTRA test commands the
message type value series 1000xxxx is reserved.
## 6.1 CLOSE UE TEST LOOP
This message is only sent in the direction SS to UE.
* * *
Information Element Reference Presence Format Length Protocol discriminator TS
24.007 [5], sub clause 11.2.3.1.1 M V ½ Skip indicator TS 24.007 [5], sub
clause 11.2.3.1.2 M V ½ Message type M V 1 UE test loop mode M V 1 UE test
loop mode A LB setup CV-ModeA LV 1-25 UE test loop mode B LB setup CV-ModeB V
1
* * *
* * *
Condition Explanation CV-ModeA This IE is mandatory present if the IE \"UE
test loop mode \" is set to UE test loop Mode A. Else it shall be absent. CV-
ModeB This IE is mandatory present if the IE \"UE test loop mode \" is set to
UE test loop Mode B. Else it shall be absent.
* * *
where message type is:
* * *
8 7 6 5 4 3 2 1 bit no. 1 0 0 0 0 0 0 0 octet 1
* * *
where UE test loop mode is:
* * *
8 7 6 5 4 3 2 1 bit no. 0 0 0 0 0 0 X2 X1 octet 1
* * *
X2=0 and X1=0 then UE test loop mode A is selected.
X2=0 and X1=1 then UE test loop mode B is selected.
Other combinations of X1 and X2 are reserved for future versions of the
protocol.
where UE test loop mode A LB setup is:
+---+------------------------------------------------------+--------------+ | | 8 7 6 5 4 3 2 1 | | +---+------------------------------------------------------+--------------+ | | Length of UE test loop mode A LB setup list in bytes | Octet 1 | +---+------------------------------------------------------+--------------+ | | LB setup list | Octet 2 | | | | | | | | Octet N*3+1 | +---+------------------------------------------------------+--------------+
N is the number of LB entities in the LB setup list and is less than or equal
to MAX_ModeA_LB_entities.
where LB setup list is:
+---+--------------------+--------------+ | | 8 7 6 5 4 3 2 1 | | +---+--------------------+--------------+ | | LB setup DRB IE#1 | Octet 2 | | | | | | | | Octet 3 | | | | | | | | Octet 4 | +---+--------------------+--------------+ | | LB setup DRB IE#2 | Octet 5 | | | | | | | | Octet 6 | | | | | | | | Octet 7 | +---+--------------------+--------------+ | | ... | | +---+--------------------+--------------+ | | LB setup DRB IE#N | Octet N*3-1 | | | | | | | | Octet N*3 | | | | | | | | Octet N*3+1 | +---+--------------------+--------------+
where LB Setup DRB#k IE is:
* * *
8 7 6 5 4 3 2 1 bit no. Z15 Z14 Z13 Z12 Z11 Z10 Z9 Z8 octet 1 Z7 Z6 Z5 Z4 Z3
Z2 Z1 Z0 octet 2 Reserved Q4 Q3 Q2 Q1 Q0 octet 3
* * *
Z15..Z0 = Uplink PDCP SDU size in bits 0.. 12160 (binary coded, Z15 is most
significant bit and Z0 least significant bit). See Note 1.
Q4..Q0 = Data Radio Bearer identity number, 1..32 (binary coded value of 'DRB-
Identity' -1, Q4 is most significant bit and Q0 least significant bit), where
Data Radio Bearer identity identifies the radio bearer, see TS 36.331 [25].
NOTE 1: The UL PDCP SDU size is limited to 12160 bits (1520 octets).
NOTE 2: A \"LB Setup DRB IE\" is only needed for a DRB if UL PDCP SDU scaling
is needed. If there is no \"LB Setup DRB IE\" associated with a DRB in the
CLOSE UE TEST LOOP message then the same size of the PDCP SDU received in
downlink is returned in uplink.
NOTE 3: The UL PDCP SDU size shall be byte aligned (i.e. multiple of 8 bits)
according to TS 36.323 [24] clause 6.2.1.
And where UE test loop mode B setup is:
* * *
     8 7 6 5 4 3 2 1   
     IP PDU delay      Octet 1
* * *
Where
* * *
8 7 6 5 4 3 2 1 bit no. T7 Z6 T5 T4 T3 T2 T1 T0 octet 1
* * *
T7..T0 = value of T_delay_modeB timer 0..255 seconds (binary coded, T7 is most
significant bit and T0 least significant bit).
NOTE: For E-UTRAN to CDMA2000 test cases, the SS should not sent any downlink
U-plane data in E-UTRAN after sending a CLOSE UE TEST LOOP message with an IP
PDU delay parameter set to value different from zero. In CDMA2000, the
T_delay_modeB timer is not used to buffer downlink U-plane data, and at expiry
of this timer, if there are buffered data received while in E-UTRAN, it is not
specified what the UE will do with these data. See clause 7.3 for the
definition of the T_delay_modeB timer.
## 6.2 CLOSE UE TEST LOOP COMPLETE
This message is only sent in the direction UE to SS.
* * *
Information Element Reference Presence Format Length Protocol discriminator TS
24.007 [5], sub clause 11.2.3.1.1 M V 1/2 Skip indicator TS 24.007 [5], sub
clause 11.2.3.1.2 M V 1/2 Message type M V 1
* * *
where message type is:
* * *
8 7 6 5 4 3 2 1 bit no. 1 0 0 0 0 0 0 1 octet 1
* * *
## 6.3 OPEN UE TEST LOOP
This message is only sent in the direction SS to UE.
* * *
Information Element Reference Presence Format Length Protocol discriminator TS
24.007 [5], sub clause 11.2.3.1.1 M V ½ Skip indicator TS 24.007 [5], sub
clause 11.2.3.1.2 M V ½ Message type M V 1
* * *
where message type is:
* * *
8 7 6 5 4 3 2 1 bit no. 1 0 0 0 0 0 1 0 octet 1
* * *
## 6.4 OPEN UE TEST LOOP COMPLETE
This message is only sent in the direction UE to SS.
* * *
Information Element Reference Presence Format Length Protocol discriminator TS
24.007 [5], sub clause 11.2.3.1.1 M V 1/2 Skip indicator TS 24.007 [5], sub
clause 11.2.3.1.2 M V 1/2 Message type M V 1
* * *
where message type is:
* * *
8 7 6 5 4 3 2 1 bit no. 1 0 0 0 0 0 1 1 octet 1
* * *
## 6.5 ACTIVATE TEST MODE
This message is only sent in the direction SS to UE.
* * *
Information Element Reference Presence Format Length Protocol discriminator TS
24.007 [5], sub clause 11.2.3.1.1 M V ½ Skip indicator TS 24.007 [5], sub
clause 11.2.3.1.2 M V ½ Message type M V 1 UE test loop mode M V 1
* * *
where message type is:
* * *
8 7 6 5 4 3 2 1 bit no. 1 0 0 0 0 1 0 0 octet 1
* * *
And where UE test loop mode is specified in clause 6.1.
NOTE: No specific UE action is currently specified upon reception of the \"UE
test loop mode\" IE.
## 6.6 ACTIVATE TEST MODE COMPLETE
This message is only sent in the direction UE to SS.
* * *
Information Element Reference Presence Format Length Protocol discriminator TS
24.007 [5], sub clause 11.2.3.1.1 M V ½ Skip indicator TS 24.007 [5], sub
clause 11.2.3.1.2 M V ½ Message type M V 1
* * *
where message type is:
* * *
8 7 6 5 4 3 2 1 bit no. 1 0 0 0 0 1 0 1 octet 1
* * *
## 6.7 DEACTIVATE TEST MODE
This message is only sent in the direction SS to UE.
* * *
Information Element Reference Presence Format Length Protocol discriminator TS
24.007 [5], sub clause 11.2.3.1.1 M V ½ Skip indicator TS 24.007 [5], sub
clause 11.2.3.1.2 M V ½ Message type M V 1
* * *
where message type is:
* * *
8 7 6 5 4 3 2 1 bit no. 1 0 0 0 0 1 1 0 octet 1
* * *
## 6.8 DEACTIVATE TEST MODE COMPLETE
This message is only sent in the direction UE to SS.
* * *
Information Element Reference Presence Format Length Protocol discriminator TS
24.007 [5], sub clause 11.2.3.1.1 M V ½ Skip indicator TS 24.007 [5], sub
clause 11.2.3.1.2 M V ½ Message type M V 1
* * *
where message type is:
* * *
8 7 6 5 4 3 2 1 bit no. 1 0 0 0 0 1 1 1 octet 1
* * *
## 6.9 RESET UE POSITIONING STORED INFORMATION
This message is only sent in the direction SS to UE.
FFS
Editor's note: It is FFS if procedure for reset of UE positioning stored
information will be included.
# 7 Variables, constants and timers
## 7.1 State variables
BUFFER_IP_PDUs
This boolean state variable is used to control if UE is to buffer IP PDUs or
not.
TEST_LOOP_MODE_B_ACTIVE
This boolean state variable is used to indicate if UE test loop mode B is
active. TEST_LOOP_MODE_B_ACTIVE shall be set to FALSE when UE is switched on.
CDMA2000_INITIATED
This boolean state variable is used to indicate if IP control signalling was
initiated by the network on CDMA2000.
## 7.2 Constants
MAX_ModeA_LB_entities = 8.
## 7.3 Timers
T_delay_modeB
In E-UTRAN, UTRAN and GERAN, this timer is used to delay the transmission of
the first IP PDU when UE test loop function is operated in UE test loop mode
B. In CDMA2000, this timer is used to temporarily interrupt UE test loop mode
B operation so as to allow IP control signalling required before data
transmission. The timer value is configured by the UE test loop mode B setup
IE in the CLOSE UE TEST LOOP message.
## 7.4 Configurable parameters
DRB_ID(LB_ID)
This parameter is used by the UE when operating in UE test loop mode A to map
a bi-directional Data Radio bearer to a loopback entity. LB_ID = 0..
(MAX_ModeA_LB_entities-1). The value is configured when UE receives the CLOSE
UE TEST LOOP message DRB_ID(LB_ID)=0 indicate that no DRB is mapped to the
loopback identity.
UL_PDCP_SDU_scaling(LB_ID)
This parameter is used to enable/disable scaling of UL PDCP SDU size. If
UL_PDCP_SDU_scaling is set to TRUE then scaling based on
UL_PDCP_SDU_size(LB_ID) parameter is performed, otherwise no scaling is done
(UL PDCP SDU size is equal to received DL PDCP SDU size). The value is
configured by the UE test loop mode A setup IE in the CLOSE UE TEST LOOP
message.
UL_PDCP_SDU_size(LB_ID)
This parameter is used to set the UL PDCP SDU size for returned UL PDCP SDUs
on the data radio bearer with data radio bearer ID equal to DRB_ID(LB_ID).
This parameter is only applicable for UE test loop mode A and when state
variable UL_PDCP_SDU_scaling(LB_ID) is TRUE. The value is configured by the UE
test loop mode A setup IE in the CLOSE UE TEST LOOP message.
# 8 Electrical Man Machine Interface (EMMI)
The EMMI is used for automation of conformance testing. The commands used on
the EMMI by the System Simulator, shall be limited to those specified in TS
36.523-3 [32]. An illustration is given in figure 8-1 as an example.
At the System Simulator side, the logical EMMI using mandatory AT commands
shall interface with the Main Test Component (MTC) of TTCN test cases which
hosts the Upper Tester. The physical EMMI interface towards the UE may be for
example a standard USB interface. Other interfaces of proprietary or
standardized type shall not be precluded.
At the UE side an adapter needs to be provided by the UE manufacturer for
converting the commands into the UE manufacturer specific interface and
format.
The use of EMMI is optional for the UE.
Figure 8-1: An example of EMMI and its use for automation of signalling
testing
###### ## Annex A (informative): Void
Void.
#
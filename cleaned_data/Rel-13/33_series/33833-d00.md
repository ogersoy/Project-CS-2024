# Foreword
This Technical Report has been produced by the 3^rd^ Generation Partnership
Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, I.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# 1 Scope
The present document contains a study of the security aspects of Proximity
Services (ProSe) and an evaluation of possible technical solutions needed to
support such services. The Stage 1 requirements for these services are defined
in TS 22.278 [2] and TS 22.115 [3]. These requirements include a list of
general requirements on ProSe Security, Authorization and Privacy (TS 22.278
[2] clause 9.4), which are taken into consideration when developing the
security key issues, security requirements and security solutions in the
present document.
Different possible Stage 2 solutions for Proximity Services are studied in TR
23.703 [4].
Normative provisions/requirements are included in the present specification
solely for the purposes of studying solutions and are not to be considered as
implying normative requirements on 3GPP entities.
NOTE: Lawful Interception (LI) aspects are not covered in this document.
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or non‑specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
[1] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[2] 3GPP TS 22.278: \"Service requirements for the Evolved Packet System (EPS)
\".
[3] 3GPP TS 22.115: \"Service aspects; Charging and billing\".
[4] 3GPP TR 23.703: \"Study on architecture enhancements to support Proximity
Services (ProSe)\".
[5] 3GPP TS 33.222: \"Generic Authentication Architecture (GAA); Access to
network application functions using Hypertext Transfer Protocol over Transport
Layer Security (HTTPS)\".
[6] 3GPP TS 33.220: \"Generic Authentication Architecture (GAA); Generic
Bootstrapping Architecture (GBA)\".
[7] 3GPP TS 33.223: \"Generic Authentication Architecture (GAA); Generic
Bootstrapping Architecture (GBA) Push function\".
[8] ETSI TS 102 225: \"Smart Cards; Secured packet structure for UICC based
applications (Release 9)
[9] ETSI TS 102 226: \"Smart cards; Remote APDU structure for UICC based
applications (Release 6)\"
[10] 3GPP TS 31.115: \"Secured packet structure for (Universal) Subscriber
Identity Module (U)SIM Toolkit applications\".
[11] 3GPP TS 31.116: \"Remote APDU Structure for (U)SIM Toolkit
applications\".
[12] IETF RFC 6509: \"MIKEY-SAKKE: Sakai-Kasahara Key Encryption in Multimedia
Internet KEYing (MIKEY)\".
[13] 3GPP TS 36.331: \"Evolved Universal Terrestrial Radio Access (E-UTRA);
Radio Resource Control (RRC); Protocol specification\".
[14] IETF RFC 3830: \"MIKEY: Multimedia Internet KEYing\", August 2004.
[15] IETF RFC 6507: \"Elliptic Curve-Based Certificateless Signatures for
Identity-Based Encryption (ECCSI)\".
[16] 3GPP TS 33.328: \"IP Multimedia Subsystem (IMS) media plane security\".
[17] IETF RFC 6043: \"MIKEY-TICKET: Ticket-Based Modes of Key Distribution in
Multimedia Internet KEYing (MIKEY)\".
[18] 3GPP TS 33.210: \"3G security; Network Domain Security (NDS); IP network
layer security\".
[19] 3GPP TS 33.310: \"Network Domain Security (NDS); Authentication Framework
(AF)\".
[20] 3GPP TS 23.303: \"Proximity based Services (ProSe); Stage 2\".
[21] 3GPP TS 33.401: \"3GPP System Architecture Evolution (SAE); Security
architecture\".
[22] IETF RFC 3550: \"RTP: A Transport Protocol for Real-Time Applications\".
[23] IETF RFC 3711: \"The Secure Real-time Transport Protocol (SRTP)\".
[24] NIST FIPS 186-4: \"Digital Signature Standard (DSS)\"
[25] BSI TR-03111: \"Technical Guideline TR-03111; Elliptic Curve
Cryptography\"
[26] IETF RFC 5639: \"Elliptic Curve Cryptography (ECC) Brainpool Standard;
Curves and Curve Generation\"
[27] IETF RFC 3339: \"Date and Time on the Internet: Timestamps\"
[28] IETF RFC 5280: \"Internet X.509 Public Key Infrastructure Certificate and
Certificate Revocation List (CRL) Profile\"
[29] NIST FIPS 180-4: \"Secure Hash Standard (SHS)\"
[30] Open Mobile Alliance, OMA AD SUPL: \"Secure User Plane Location
Architecture\", (http://www.openmobilealliance.org).
[31] ETSI TS 102 223: \"Smart Cards; Card Application Toolkit (CAT)\".
[32] 3GPP TR 23.713: \"Study on extended architecture support for Proximity-
based services\".
[33] 3GPP TS 33.303: \"Proximity-based Services (ProSe); Security aspects\".
[34] 3GPP TS 33.259: \"Key establishment between a UICC Hosting Device and a
Remote Device\".
[35] 3GPP TS 24.334: \"Proximity-services (ProSe) User Equipment (UE) to ProSe
function protocol aspects\"
[36] 3GPP TS 33.187: \"Security aspects of Machine-Type Communications (MTC)
and other mobile data applications communications enhancements\"
[37] 3GPP TS 33.246: \"3G Security; Security of Multimedia Broadcast/Multicast
Service (MBMS)\".
# 3 Definitions and abbreviations
## 3.1 Definitions
For the purposes of the present document, the terms and definitions given in
TR 21.905 [1] and the following apply. A term defined in the present document
takes precedence over the definition of the same term, if any, in TR 21.905
[1].
**Open ProSe Discovery** : is ProSe Discovery without explicit permission from
the UE being discovered.
**ProSe Application Identity** : An identity identifying application related
information for the ProSe enabled UE.\ There can exist more than one ProSe
Application Identities per UE.
**ProSe Application Key** : A key associated with a ProSe Application
Identity, meant to be used for restricted discovery.
**ProSe Discovery** : A process that identifies that a ProSe-enabled UE is in
proximity of another, using E-UTRA (with or without E-UTRAN) or EPC.
**ProSe Direct Discovery:** A procedure employed by a ProSe-enabled UE to
discover other ProSe-enabled UEs in its vicinity by using only the
capabilities of the two UEs with Rel-12 E-UTRA technology.
**EPC-level ProSe Discovery:** A process by which the EPC determines the
proximity of two ProSe-enabled UEs and informs them of their proximity.
**ProSe UE-to-Network Relay** : is a form of relay in which a Public Safety
ProSe-enabled UE acts as a ProSe E-UTRA communication relay between a Public
Safety ProSe-enabled UE and the ProSe-enabled network using E-UTRA.
**ProSe UE-to-UE Relay** : is a form of relay in which a Public Safety ProSe-
enabled UE acts as a ProSe E-UTRA Communication relay between two other Public
Safety ProSe-enabled UEs.
**ProSe-enabled UE:** An UE that fulfils ProSe requirements for ProSe
Discovery and/or ProSe Communication. Unless explicitly stated otherwise, a
ProSe-enabled UE refers to any ProSe-enabled UE (I.e. Public Safety or not).
**ProSe-enabled Network** : A network that supports ProSe Discovery and/or
ProSe Communication. Unless explicitly stated otherwise in the present
document, a network refers to a ProSe-enabled Network.
**ProSe Communication:** A communication between two or more ProSe-enabled UEs
in proximity by means of a ProSe Communication path. Unless explicitly stated
otherwise, the term \"ProSe Communication\" refers to any/all of the
following:
\- ProSe E-UTRA Communication between only two ProSe-enabled UEs; or
\- ProSe Group Communication or ProSe Broadcast Communication among Public
Safety ProSe-enabled UEs; or
\- ProSe-assisted WLAN direct communication.
**ProSe Broadcast Communication:** An One-to-all ProSe E-UTRA Communication,
between all authorized Public Safety ProSe-enabled UEs in proximity, by means
of a common ProSe E-UTRA Communication path established between these UEs.
**ProSe Group Communication:** An One-to-many ProSe E-UTRA Communication,
between more than two Public Safety ProSe-enabled UEs in proximity, by means
of a common ProSe E-UTRA Communication path established between the Public
Safety ProSe-enabled UEs.
**ProSe UE Identity** : An unique identity allocated by EPS which identifies
the ProSe enabled UE. It can be assigned to a UE at any moment in time for a
configurable duration, can be stored at the UE, but its value cannot be
assigned by the user, and is subject to operator assignment and re-assignment.
**Proximity:** is determined (\"a UE is in proximity of another UE\") when
given proximity criteria are fulfilled. Proximity criteria can be different
for discovery and communication.
**Restricted ProSe Discovery** : A ProSe Discovery that only takes place with
explicit permission from the UE being discovered.
**EPC ProSe User ID** : An identifier for EPC-level ProSe Discovery and EPC
support for WLAN direct communication that uniquely identifies a UE registered
for ProSe. This identifier can be occasionally reassigned by the ProSe
Function.
**Remote UE:** A ProSe-enabled Public Safety UE, that is not served by
E-UTRAN, and that communicates with a PDN via a ProSe UE-to-Network Relay.
## 3.2 Abbreviations
For the purposes of the present document, the abbreviations given in TR 21.905
[1] and the following apply. An abbreviation defined in the present document
takes precedence over the definition of the same abbreviation, if any, in TR
21.905 [1].
ProSe Proximity Services
# 4 Proximity Services (ProSe)
## 4.1 Overview of Proximity Services (ProSe)
### 4.1.1 ProSe Discovery
ProSe Discovery is a process which determines that ProSe-enabled UEs are in
proximity of each other. Its use is authorized by the operator, and the
authorization can be on a \"per UE\" basis, or a \"per UE per application\"
basis. Similarly, the operator may also provide configuration data, e.g. the
proximity criteria, for the use of ProSe Discovery, to a ProSe-enabled UE. The
network controls the use of E-UTRAN resources used for ProSe Discovery for a
ProSe-enabled UE served by E-UTRAN. ProSe Discovery can be used as a
standalone process (I.e. it is not necessarily followed by ProSe
Communication) or as an enabler for other services.
There are two different types of Prose Discovery, namely open and restricted.
In open discovery, a UE may be discovered without explicit permission, while
restricted discovery only takes place with explicit permission from the UE
that is being discovered.
### 4.1.2 ProSe Communication
ProSe Communication enables establishment of new communication paths between
two or more ProSe-enabled UEs. The use of ProSe Communication is authorized by
the operator and it may take place over E-UTRA or WLAN.
The network controls the use of E-UTRAN resources used for ProSe Communication
for a ProSe-enabled UE served by E-UTRAN. In particular, according to policy a
UE\'s communication path can be switched between an EPC path and a ProSe
Communication path and a UE can also have concurrent EPC and ProSe
Communication paths.
In addition there are several scenarios that only apply to Public Safety
usage:
\- ProSe Communication can start without the use of ProSe Discovery;
\- Public Safety ProSe-enabled UEs establishing the communication path
directly between them, regardless of whether the Public Safety ProSe-enabled
UE is served by E-UTRAN;
\- Public Safety ProSe-enabled UEs may participate in ProSe Group
Communication or ProSe Broadcast Communication. ProSe Communication is also
facilitated by the use of a ProSe UE-to-Network Relay, which acts as a relay
between E-UTRAN and UEs not served by E-UTRAN. The use of this relay function
is controlled by the operator;
\- ProSe Communication can also take place over a ProSe UE-to-Network Relay,
which acts as a relay between\ E-UTRAN and UEs not served by E-UTRAN.
### 4.1.3 Scope of ProSe
The scope of ProSe in Rel-12 is as follows:
\- Configuration of ProSe-enabled UEs;
\- Open ProSe Direct Discovery (in network coverage);
\- One-to-many communication for Public Safety UEs;
\- EPC-level ProSe Discovery;
\- EPC support for WLAN Direct Communication.
The scope of ProSe in Rel-13 is as follows:
\- Restricted ProSe Direct Discovery for non-Public Safety use;
\- Support for model B ProSe Direct Discovery;
\- ProSe UE-Network relays for Public Safety use;
\- ProSe Direct Communication one-to-one for Public Safety use.
## 4.2 Architecture for ProSe
The high level ProSe architecture is given here for SA3 to study security
threats, requirements and solution in the present document. This architecture
is based on the Non-Roaming Reference Architecture (Figure 4.2-1), Inter-PLMN
Reference Architecture (Figure 4.2-2), and Roaming Reference Architecture
(Figure 4.2-3) of TS 23.303 [20].
{width="6.688888888888889in" height="4.6194444444444445in"}Figure 4.2-1: Non-
Roaming Reference Architecture (TS 23.303 [20])
Figure 4.2-2: Inter-PLMN Reference Architecture (TS 23.303 [20])
NOTE: A ProSe Proxy Function may be needed when PDN GW is located in the
VPLMN.
Figure 4.2-3: Roaming Reference Architecture (TS 23.303 [20])
For Discovery and Direct Communication, SA3 should study the security of the
reference points given below:
**PC1** : The reference point between the ProSe application in the UE and in
the ProSe Application Server.\ It is used to define application level
signalling requirements. This reference point is not described in Rel-12 of
the present document.
Editor\'s Note: It is FFS if this is in scope of 3GPP SA3.
**PC2** : The reference point between the ProSe Application Server and the
ProSe Function. It is used to define the interaction between ProSe Application
Server and ProSe functionality provided by the 3GPP EPS via ProSe Function
(e.g. name translation) for EPC-level ProSe Discovery.
**PC3** : The reference point between the UE and the ProSe Function. PC3
relies on EPC user plane for transport (I.e. an \"over IP\" reference point).
It is used to authorize ProSe Direct Discovery and EPC-level ProSe Discovery
requests, and perform allocation of ProSe Application Codes corresponding to
ProSe Application Identities used for ProSe Direct Discovery. It is used to
define the authorization policy per PLMN for ProSe Direct Discovery (for
Public Safety and non -Public Safety) and communication (for Public Safety
only) between UE and ProSe Function.
**PC4a** : The reference point between the HSS and ProSe Function. It is used
to provide subscription information in order to authorize access for ProSe
Direct Discovery and ProSe Direct Communication on a per PLMN basis.\ It is
used by the ProSe Function (EPC-level ProSe Discovery Function) for retrieval
of EPC-level ProSe Discovery related subscriber data.
**PC4b** : The reference point between the SUPL Location Platform (SLP)
defined in OMA AD SUPL [30] and the ProSe Function. PC4b is used by the ProSe
Function (EPC-level ProSe Discovery Function) (in the role of LCS client to
query the SLP defined in OMA AD SUPL [30].
**PC5** : The reference point between ProSe-enabled UEs used for control and
user plane for ProSe Direct Discovery, ProSe Direct Communication and ProSe
UE-to-Network Relay.
**PC6** : When the UE is not roaming, the reference point between the ProSe
Function in the HPLMN and the ProSe Function in a different PLMN. It is used
to authorize ProSe Direct Discovery requests, and perform allocation of ProSe
Application Identity Codes and ProSe Application Identity Names from the
HPLMN. It is used for HPLMN control of ProSe Service Authorization.
**PC7** : When the UE is roaming, the reference point between the ProSe
Function in the HPLMN and the ProSe Function in the VPLMN or ProSe Function in
another PLMN. It is used to authorize ProSe Direct Discovery requests, and
perform allocation of ProSe Application Identity Codes and ProSe Application
Identity Names from the HPLMN.\ It is used for HPLMN control of ProSe Service
Authorization.
**S6a** : In addition to the relevant functions defined in TS 23.401 [5] for
S6a, in case of ProSe S6a is used to download ProSe related subscription
information to MME during E UTRAN attach procedure or to inform MME that
subscription information in the HSS has changed.
**S1-MME:** In addition to the relevant functions defined in TS 23.401 [5] for
S1-MME, in case of ProSe it is also used to provide an indication to eNB that
the UE is authorized to use ProSe Direct Discovery.
Editor\'s Note: It is proposed to reuse the existing security mechanisms as
much as possible for above interfaces.
# 5 Key Issues for Rel-12
## 5.1 Key Issues on Configuration
### 5.1.1 Key Issue #1.1: Configuration of ProSe-enabled UEs
#### 5.1.1.1 Key issue details
In order to utilise ProSe features, e.g. ProSe Discovery and/or ProSe
Communication, the operator needs to be able to configure the ProSe enabled
UEs.
Configuration data may include e.g. proximity criteria as well as PLMN
sensitive radio resource configuration.\ A Public Safety ProSe UE, when in
coverage, will receive resource configuration by the registered PLMN, whereas
when out-of-coverage will use resource configuration obtained by the last
registered PLMN (before losing E-UTRAN coverage) or, as a backup, resources
pre-configured (by the HPLMN operator). It is then crucial that these data are
not prone to manipulation by anybody else than the registered PLMN (as a
Public Safety ProSe UE transmitting on unauthorized bands could represent a
serious source of radio interference).
Configuration data for LTE network operations will be provided only by
Operators (either HPLMN or VPLMN).
Third party are not allowed to provide such parameters.
NOTE: The requirement above does not apply to all types of configuration data.
For example, a parameter for how often an NSPS device polls a Certificate
Revocation List server is something that indirectly impacts network
operations: If there are many NSPS UEs in a certain area, the network may have
to adapt to a higher traffic load at the times they request CRLs. The
parameter setting this frequency may be an application layer parameter (ProSe
APP parameter) and hence not directly related to the network operations, but
it still may have impact on the network operation.
Editor\'s Note: The scenario when the configuration data for the ProSe APP
layer is provided by a provisioning server controlled by a different entity
than the 3GPP operator, needs to be considered as well.
#### 5.1.1.2 Security threats
There are several threats to the downloading of configuration data to the UE.
\- An attacker pretending to be a configuration server may maliciously
configure the UE with false configuration data, thus causing improper UE
operation.
\- An attacker pretending to be a configuration server may maliciously delete
the UE configuration data, rendering the UE unable to operate in ProSe mode.
\- Similarly the authorized ProSe configuration server will want to know the
identity of the ProSe-enabled UE that is requesting configuration information,
as otherwise it is not possible to download correct information to the UE.
\- An attacker may manipulate of modify the configuration data being
transmitted between the UE and the configuration server, thus adversely
affecting the ProSe configuration.
\- An attacker may eavesdrop on transmitted configuration data and further
distribute it to unauthorized parties for improper use.
\- An attacker may replay an intercepted configuration data thus affecting an
expected configuration state at the ProSe-enabled UE and/or a configuration
server.
An attacker may manipulate of modify the configuration data while stored on
the UE.
#### 5.1.1.3 Potential security requirements
The only entities entitled to provide configuration data impacting the network
operations (e.g. radio resource allocation) to the ProSe-enabled UE shall be
operators. 3rd parties shall not be allowed to provide such parameters.
NOTE: The requirement above does not apply to all types of configuration data.
For example, a parameter for how often an NSPS device polls a Certificate
Revocation List server is something that indirectly impacts network
operations: If there are many NSPS UEs in a certain area, the network may have
to adapt to a higher traffic load at the times they request CRLs. The
parameter setting this frequency may be an application layer parameter (ProSe
APP parameter) and hence not directly related to the network operations, but
it still may have impact on the network operation.
Editor\'s Note: The scenario when the configuration data for the ProSe APP
layer is provided by a provisioning server controlled by a different entity
than the 3GPP operator, needs to be considered as well.
The ProSe-enabled UE and the entity providing the configuration data shall
mutually authenticate each other.
The transmission of configuration data between the authorized ProSe
configuration server in the network and the ProSe-enabled UE shall be
integrity protected.
The transmission of configuration data between the authorized ProSe
configuration server in the network and the ProSe-enabled UE shall be
confidentiality protected
The transmission of configuration data between the authorized ProSe
configuration server in the network and the ProSe-enabled UE shall be
protected from replays
The configuration data shall be stored in the UE in a protected way to prevent
modification.
Some configuration data may be required to be stored in the UE in a protected
way to prevent eavesdropping.
## 5.2 Key Issues on Discovery
### 5.2.1 Key Issue #2.1: Direct Request and Response Discovery
#### 5.2.1.1 Key issue details
In the solutions for discovery procedure in TR 23.703 [4] (clause 6.1 ProSe
Discovery) there are two ways to perform discovery:
1) Without network interaction: UE sends a message directly to other UEs for
discovery without any network interaction.
2) With network interaction: UE sends a message to other UEs via a network
entity.\ Options for network entities are ProSe Function, PDCF and eNB and/or
MME.
NOTE: The messages for discovery purpose are named differently in SA2
solutions in TR 23.703 [4], clause 6.1. SA3 categorizes them into (1)
Discovery Request and (2) Discovery Response for the present study.
#### 5.2.1.2 Security threats
The following addresses the threats when discovery is carried by sending
discovery request and response messages.
1) UE may randomly or maliciously send discovery request and/or discovery
response messages. This could also include malicious UE sending messages to
those UEs that are not authorized for ProSe service.\ This can lead to
resource depletion of other UEs.
2) The message discovery request and response messages may be modified during
transmission, this can cause various issues including incorrect discovery.
3) The discovery request or response messages could be replayed. This could
lead to various attacks like unauthorized UE using the ProSe Discovery service
that in turn leads to fraudulent charging.
#### 5.2.1.3 Potential security requirements
The discovery request and discovery response messages should be integrity
protected.
The entity which receives the discovery request or discovery response message
should be able to verify the source authenticity.
Replay protection on discovery request and response messages should be
provided.
Authorization and verification of UE that requests or responds for discovery
should be provided.
### 5.2.2 Key Issue #2.2: Security analysis for Open Direct Discovery
#### 5.2.2.1 Key Issue Details
In the existing SA3 TR, security threat, requirements and solution are
addressing restricted discover (cf. Key issues #3 and solution 2). In Key
issue #A1.2 the clause A.1.2.2 \'Security Threats\' mentions impersonation as
one of the security threat. However the clause A.1.2.3 \'Security
requirements\' does not capture impersonation attack as one of the security
requirements. Further, replay attack and impersonation attack are applicable
to open discover also, especially for standalone service enabler (e.g.
advertisements by a store). Excerpt from TR 23.703 (clause 6.1.1.2.3) which
specifies the standalone service enabler:
_\"ProSe Discovery can be a standalone service enabler that could for example
use information from the discovered UE for certain applications in the UE that
are permitted to use this information e.g. \"find a taxi nearby\", \"find me
police officer X\". Additionally depending on the information obtained ProSe
Discovery can be used for subsequent actions e.g. to initiate direct
communication.\"_
Discovering a specific restaurant/shop by a discovering UE in a place where
they do not exist (or are not in proximity) or discovering a friend by a
discovering UE when the friend is not in proximity should not be the outcome
of replayed/faked direct discovery.
#### 5.2.2.2 Security Threats
In the absence of any protection for the open discovery, a rogue UE can easily
receive the discovery information announced by the ProSe UEs and can easily
mount replay attack. Further, a ProSe UE can easily impersonate another ProSe
UE, so that the discovering ProSe UEs will find the discoverable UEs even when
they are not there or will receive wrong standalone service (like, receiving
advertisements which are not valid, as to destroy reputation).
The security threat on open discovery is, impersonation by a monitoring Prose
UE, who is authorized to receive and understood discovery information
transmitted, by replaying the received discovery message or transmitting a new
discovery message as receiving UE has all information of the transmitting UE.
Network controlled ProSe Discovery service under consideration in solution D13
in the SA2 TR 23.307, allows ProSe enabled UEs to send the collected
ProSe_Code(s) through NAS message, for which the ProSe Application Identity(s)
match is found. Authenticated and authorized ProSe enabled UEs creating NAS
traffic arbitrarily based on discovery message from other malicious or
compromised UEs may lead to mounting DoS attack on the MME.
#### 5.2.2.3 Potential security requirements
The system shall support a method to mitigate the replay and impersonation
attack for ProSe open discovery.
### 5.2.3 Key Issue #2.3: Security analysis for registration in Network based
ProSe Discovery
#### 5.2.3.1 Key issue details
A ProSe enabled UE first initiates a registration process before it gets ProSe
ID to communicate with other ProSe enabled UEs. In solution D8 from TR 23.703
[4], UE has to perform LTE attach procedure after power on, and the EPS layer
in UE sends a ProSe registration request NAS signalling to the ProSe Server
via RRC signalling. Then the ProSe server verifies the subscription of the UE
to see whether the indicated Open/Restrictive ProSe service is subscribed.\ If
the UE is subscribed, the ProSe Server will assign a ProSe ID to the UE for
this application instance.
#### 5.2.3.2 Security threats
There exists such a threat that an attacker can utilize the registration
procedure to send many signalling to ProSe Server to fake a legal UE, which
can cause ProSe server huge consumption. The details of this attack are as
below.
When the attacker is not subscribed to ProSe server, it still sends
registration request NAS signalling by a ProSe-enabled device to the ProSe
Server via eNodeB and MME. Since the eNodeB and MME have no capability to
check the UE\'s limits of authority and the eNB and MME just send this
signalling forward to the ProSe Server, the ProSe server finally deals with
the check. When it finds out the UE is not subscribed, the ProSe server
refuses to allocate ProSe ID.
Then the attacker will continually sends registration request signalling and
the ProSe server has to reply this request and continually check and refuse
this request. As a result, this process will bring DoS attack and performance
degradation in ProSe Server, even bring down the network.
#### 5.2.3.3 Potential security requirements
The network should take measures to detect the DoS attack so that the impact
from the attacker to ProSe server can be decreased.
NOTE: Existing security mechanism will be reused whenever possible and
appropriate.
### 5.2.4 Key Issue #2.4: Application Registration for ProSe
#### 5.2.4.1 Key issue details
The following text replicates the procedure of Application Registration for
ProSe depicted in Annex I of TR 23.703 [4].
Editor\'s note: Annex I of TR 23.703 is a temporary home for this, so
reference will need to be updated later
When a user registers with a 3rd party application server (App Server), it is
designated an Application Layer User ID (e.g. ALUID_A for user A). This
procedure is out of 3GPP specification scope. Then to activate ProSe features
such as EPC-level ProSe Discovery for a specific application, the UE registers
the application with the ProSe Function, as illustrated in Figure 5.2.4.1-1
(copied from TR 23.703[4]).
{width="4.246527777777778in" height="1.4736111111111112in"}
Figure 5.2.4.1-1: Application registration for ProSe
> 1\. UE A sends Application Registration Request (EPUID_A, Application ID,
> ALUID_A) message to ProSe Function A to register an application for ProSe.
> EPSID_A is the EPC ProSe Subscriber ID for UE A. The Application ID is used
> to identify the 3^rd^ party App Server platform. EPUID_Ais user A\'s
> Application Layer User ID.
>
> 2\. ProSe Function A retrieves user\'s EPC ProSe Subscriber ID (EPUID_A).
> ProSe Function A may interact with the HSS in order to check whether the UE
> is authorized to register this application for ProSe. Alternatively, all
> user settings related to authentication and authorization for ProSe may be
> configured locally in ProSe Function A, in which case the interaction with
> the HSS is not needed.
>
> 3\. ProSe Function A sends a ProSe Registration Request (ALUID_A, EPUID_A,
> PFID_A) message to the App Server indicating that a user of this application
> (identified as ALUID_A) has requested to use ProSe for that application.
> PFID_A is the ProSe Function ID of ProSe Function A. If the App Server
> accepts the request, it stores the user\'s Application Layer User ID
> (ALUID_A) and EPC ProSe Subscriber ID (EPUID_A) together with the PFID_A.
>
> 4\. The App Server sends a ProSe Registration Response message to ProSe
> Function A indicating that the registration was successful (or not).
>
> 5\. ProSe Function A sends Application Registration Response (Allowed Range)
> message to UE A indicating that the registration was successful (or not).
> The Allowed Range parameter contains the set of range classes that are
> allowed for this application.
The following is the SA3 interpretation of this process:
1) The EPUID is used by the ProSe function to verify user\'s authorization to
use ProSe services, possibly with the assistance of the EPS HSS.
2) The ALUID is assigned to the application user by the App server.
Authentication and authorization of the ALUID forwarded by the ProSe function
to the App server is a responsibility of the App server.
3) When registering an Application for ProSe, App Server gets the EPUID and
ProSe Function ID of the user and stores it in association with the ALUID.
When the UE A later makes a Proximity Request for the targeted UE B, App
Server is queried with ALUID_B and in response returns the EPUID and ProSe
Function of UE B.
#### 5.2.4.2 Security threats
Since the ALUID is not part of a 3GPP user profile, it is not permanently
stored either in any HSS profile data or as a \"buddy list\" in ProSe
Function. The ALUID is only temporary stored in the ProSeFunction for the
duration in which the Application is registered in the ProSe Function.
Therefore App Server cannot rely on the correctness of ALUID_A in message 3:
ProSe Registration Request. The ProSe UE, not otherwise authorized to use
selected application service resources, may maliciously use someone else\'s
ALUID in order to fraudulently obtain these resources.
#### 5.2.4.3 Potential security requirements
Security means have to be in place to ensure that the EPSID and the ALUID
belong to the same user.
## 5.3 Key Issues on One-to-many communications
### 5.3.1 Key Issue #3.1: One-to-many communications between Public Safety UEs
#### 5.3.1.1 Key issue details
There is a requirement for Public Safety ProSe UEs to be able to communicate
in a one-to-many fashion. Relating to this there is a requirement in TS 22.278
[2] for UEs to be able to start communication without first discovering the
receiving UE(s). This means that a UE is unilaterally be able to start sending
encrypted one-to-many data packets that may be successfully decrypted by other
group members without knowing in advance which group members can actually
receive the data.
Groups may be very large, sometimes including hundreds of UEs. Interactions
with GCSE Group Communications may also need to be considered.
#### 5.3.1.2 Security threats
The following threats are identified as data is exchanged between any of the
UEs:
\- A passive attacker may intercept the data packets exchanged by the two UEs
and may be able to obtain their true/original content.
\- An active attacker may modify the data packets sent by a UE without
detection by either the sender UE or any of the receiver UEs.
Due to the one-to-many nature of the communication scenario at hand, it may
not be possible to fully protect against replay attacks of one-to-many
communications. For example, if a group member does not hear a particular
transmission, then it may well be possible to replay that transmission later
and have the UE accept this as a fresh transmission.
The threats against data integrity in one-to-many configuration do not seem to
be different from the threats for user plane between the UE and eNB. In
addition, encryption may also provide some additional level of protection
against sensible modifications. If it is assumed that no integrity protection
is used, and that the outsider attacker does not have a correct encryption key
used by the members in the one-to-many Group, then the received data packet
will most likely be discarded after decryption as either: corrupted,
meaningless or out-of-context, at the upper layers.
If NSPS organizations are not able to accept a one-to-many communication with
no integrity protection on PDCP user plane, then required integrity protection
should be provided at session layer (e.g. in SRTP) or at application layer.
#### 5.3.1.3 Potential security requirements
The system shall support providing the Public Safety ProSe UEs with the all
the necessary keying material and chosen algorithms that will be used protect
the data sent between the Public Safety ProSe UE(s). This material shall be
provided without requiring interaction between the Public Safety ProSe UEs.
Confidentiality of one-to-many communications should be provided for both the
in-coverage and out-of-coverage cases. Its use would be a configuration option
related to network operations and should hence be under control of the network
operator.
Integrity protection of one-to-many communications in PDCP layer is agreed to
not be supported.
Editor\'s note: Requirements on integrity protection and replay of the data on
application/session layer are FFS
Security mechanisms shall scale effectively to large groups, and be compatible
with rapid setup of group communications.
### 5.3.2 Key Issue #3.2: key distribution for group communications
#### 5.3.2.1 Key issue details
Several scenarios of SA2 TR 23.703 [4] require the presence of a security
mechanism to generate and distribute keys that could be shared by different
members of a ProSe Group. These shared keys could be used for one-to-many
communication when the ProSe-enabled UEs are in or out of network coverage. It
is possible to have a network-supported key distribution for group
communications.
For out of coverage scenario, when establishing ProSe one-to-many
communications in group owner mode it is necessary for the group owner to
generate a session key and distribute it to the group members, In
decentralized mode the group members will already have a common pre-shared key
but it is still desirable to use session keys to secure the communications in
order to limit the exposure of the pre-shared key. The group member initiating
the communication will need to generate and distribute the session key in this
case.
#### 5.3.2.2 Security threats
There are several threats related to key distribution for group
communications:
> In case that an attacker could eavesdrop a key to be shared between ProSe-
> enabled UEs then the attacker would be able to eavesdrop and/or modify all
> the communications protected with this shared key.
>
> In case that an attacker could modify or spoof a key to be shared between
> ProSe-enabled UEs then we could have the following impacts:
  * The different ProSe-enabled UEs of a ProSe Group may not share the same key and they could no longer communicate with each other. This attack could be considered as Denial of Service attack.
  * The different ProSe-enabled UEs may share a key chosen by the attacker. The attacker could take care to choose a weaker key. Then, the attacker could eavesdrop and/or modify all the communications protected with the chosen key.
> It is also possible for an attacker to perform replay attacks.
>
> In case that a key would be distributed to an unauthorized ProSe-enabled UE,
> this unauthorized ProSe-enabled UE could participate in all the
> communications within the ProSe group. The unauthorized member would know
> all the sensitive information exchanged between the members of the ProSe
> Group. He could also provide false information to the other members of the
> ProSe Group, which could have serious impacts.
If a ProSe group member does not receive the shared key or session key then
they will not be able to communicate with the other group members. This can
happen when:
\- The UE is out of network coverage during an update of the shared key.
\- The UE attempts to join a group communication already in progress.
#### 5.3.2.3 Potential security requirements
The shared keys and session keys, when used for out of coverage scenario,
shall be protected in integrity and confidentiality during their distribution.
Editor\'s Note: The type of key to be protected is FFS.
Only authorized ProSe-enabled UEs shall receive the shared keys.
It should be possible to authenticate the network entity distributing the
shared keys or the group member distributing the session keys.
Note: Expired keys may need to be kept.
It should be possible for the UE to store shared keys for past and future
cryptoperiods.
The mechanism for distributing session keys should support late entry to group
communications.
### 5.3.3 Key issue #3.3: ProSe one-to-many communication in decentralized
mode
#### 5.3.3.1 Key issue details
It is proposed to pre-provision the security key in all the group members for
the group communication in TR 23.703 for c5, c6, c8. This pre-shared key may
use directly or as basis for one-to-many communication of decentralized mode.\
The authentication between ProSe UEs may be implicit in this decentralized
mode communication to reduce the number of authentication procedures.
The security key for group members needs to be able to be distributed or
updated to support creation and modifications of groups. This modification or
distribution process needs to be straight-forward and efficient to allow
groups in a public safety network to be reasonably dynamic.
NOTE：Pre-provisioned key is one option for security and it does not exclude
any other options.
#### 5.3.3.2 Security threats
The pre-shared key is the basis of the group communication. In case the
attacker gets hold of the pre-shared key stored in the ProSe UEs, then the
attacker would be able to eavesdrop and/or modify the communication data on
multicast mode which is protected using this pre-shared key.
In case the key is used for a sufficient long time, the attacker may deduce
some information on security key from the received protected data. Then the
attacker may obtain the original content sent in multicast mode.
#### 5.3.3.3 Potential security requirements
The pre-provisioned key should be securely stored in the ProSe UE.
The security key should not be used when required by the group manager, its
lifetime expires or when it is considered to be not secure any more.
### 5.4 Key Issues on other areas
### 5.4.1 Key Issue #4.1: ProSe enabled UE security aspects
#### 5.5.1.1 Key issue details
Generally speaking, in the internal architecture of a ProSe-enabled UE various
layers can be identified (e.g. EPS layer, Operating System layer, Application
layer).
Depending on the solution chosen, ProSe functionalities can be implemented in
a ProSe enabled UE at the EPS layer and/or involving upper layers. Examples of
such ProSe functionalities are: authorization of starting discovery
(announce/monitor) by the application, allocation of codes to be announced,
detection and processing of codes.
UE procedures at EPS layer are subject to 3GPP conformance tests, whereas
Operating System and application layer logic are not tested by 3GPP.
The implementation of ProSe functionalities at a layer that is not subject to
3GPP conformance tests may lead to unpredictable UE (mis)behaviour, depending
on different device implementations.
#### 5.4.1.2 Security threats
Preventing possible attacks to the Operating System and/or to the Application
layer might be very difficult, if not potentially impossible. Moreover,
functionalities implemented at Application /OS layers are not subject to 3GPP
conformance tests and thus their operations cannot be predictable.
#### 5.4.1.3 Potential security requirements
Void
### 5.4.2 Key Issue #4.2: Ensuring a trusted and reliable accounting
#### 5.4.2.1 Key issue details
A trusted and reliable accounting is a crucial point for the relationship
between MNOs and end users.
Referring to the ProSe service, this applies in general, both for Public
Safety ProSe UEs and for the non-Public Safety ProSe UEs.
According to the Rel-12 prioritization, non-Public Safety ProSe UEs will
operate always \"in-coverage\", whilst Public Safety ProSe UEs may operate
(e.g. for the \"one-to-many communication\" ProSe feature) both \"in
coverage\" or \"out of coverage\".
Since non network based accounting mechanisms are deemed to more prone to
possible attacks, there is no justification to deviate from the existing
principle of a trusted and reliable network-based accounting, wherever
possible (e.g. for\ \"in coverage\" ProSe scenarios). However, \"out of
coverage\" Public Safety ProSe (one-to-many communications are in the scope of
Rel-12) will probably require non network-based accounting mechanisms that
rely on ProSe UEs, since network is not involved in the communication.
Credit control (especially prepaid) and usage information for post-paid
charging are of commercial interest for the ProSe scenarios, but there are
cases where a network-based accounting mechanism cannot be performed (e.g.
potentially for the Public Safety ProSe \"out of coverage\" scenario of
Rel-12). The security issue with the non network-based charging is that
charging information provided from compromised/malicious UEs might be subject
to manipulation (under report).
#### 5.4.2.2 Security threats
Non network based accounting mechanisms are deemed to more prone to possible
attacks/manipulation as they might be exploited by the ProSe end
user/application to perform security violations against the MNO such as theft
of service, e.g. by tampering the UE to properly manipulate (under-report) the
accounting information.
#### 5.4.2.3 Potential security requirements
For a trusted and reliable accounting, the VPLMN/HPLMN shall be able to
produce CDRs for ProSe services.
For \"out of coverage\" (Public Safety) ProSe scenarios CDRs created based on
possible non-network based accounting mechanisms shall be trusted and
reliable.
Charging information shall be securely collected and communicated by the ProSe
enabled UE to the network, so that the operator may trust the accounting
information.
### 5.4.3 Key Issue #4.3: Data communication security between ProSe network
entities
#### 5.4.3.1 Key issue details
ProSe network entities will be required to communicate with each other.
#### 5.4.3.2 Security threats
There are several threats to the communication between ProSe network entities
including forged or replayed messages and eavesdropping on the contents of the
messages.
#### 5.4.3.3 Potential security requirements
The ProSe network entities shall be able to authenticate the source of the
received data communications.
The transmission of data between ProSe network entities shall be integrity
protected.
The transmission of data between ProSe network entities shall be
confidentiality protected.
The transmission of data between ProSe network entities shall be protected
from replays.
Note: The requirements of this clause do not apply to ProSe UEs and ProSe UE-
to-Network Relays.
### 5.4.4 Key Issue #4.4: Protection of UE identity for ProSe direct discovery
#### 5.4.4.1 Key issue details
A ProSe enabled UE sends a Discovery Request message to announce, monitor and
report match of direct discovery.\ As specified in the TS 23.303 (clause
5.3.3), the Discovery Request message includes a UE identity parameter that
identifies the UE subscription and can be the e.g. IMSI or MSISDN.
IMSI is the permanent identity of subscriber and is subject to privacy of
subscriber. MSISDN is configurable by end user or applications of a UE (e.g.
using OMA DM or user\'s manual configuration).
#### 5.4.4.2 Security threats
If IMSI is used to identify the UE subscription, an attacker may intercept the
data packets of Discovery Request messages and is able to obtain the IMSI of
the requesting UE.
If MSISDN is used to identify the UE subscription, the end user or
applications of the ProSe enabled UE may manipulate the MSISDN to be sent to
the ProSe Function, thus causing improper Discovery Request.
#### 5.4.4.3 Potential security requirements
The transmission of UE identity shall be confidentiality protected.
The transmission of UE identity shall be integrity protected.
Editor\'s Note: The solution of the protection of the UE identity is FFS.
### 5.4.5 Key Issue #4.5: Security for EPC support WLAN direct discovery and
communication
#### 5.4.5.1 Key issue details
The EPC support WLAN direct discovery and communication consist of the
following procedures based on TS 23.303 [20].
1\. WLAN direct Group setup with assistance information from EPC
2\. WLAN direct group establishment and WLAN direct communication between UEs
#### 5.4.5.2 Security threats
There are several threats to the communication between ProSe-enabled UEs and
Prose Function, or to the communication between ProSe-enabled UEs, such as
eavesdropping and replay attack.
#### 5.4.5.3 Potential security requirements
Procedure 1 includes traffic between Prose UE and Prose Functions ProSe-
enabled UEs and Prose Function, therefore the requirements in clause 5.3.2 for
configuration of ProSe-enabled UEs shall be applied to this case.
Procedure 2 includes traffic between the ProSe-enabled UEs. Therefore, the
following requirements have to be satisfied;
The communication data between ProSe UEs should be protected. UEs, therefore,
the communication data between ProSe-enabled UEs should be protected.
# 6 Solutions for Rel-12
## 6.1 Solutions for configuration data transfer
### 6.1.1 Solution #6.1: Security for configuration data transfer
#### 6.1.1.1 General
This solution addresses key issue #1.1 in the current specification and is the
security part of solution D1 in TR 23.703 [4].
#### 6.1.1.2 Overview of solution
In solution D1 from TR 23.703 [4], the UE gets the authorization for direct
services from the DPFs of the local PLMNs. The UE and local DPF use TLS to
protect the traffic between them. Standard GBA/GAA authentication can be used
to for authentication between the UE and local DPF (NAF) with a TLS-PSK
ciphersuite to protect the traffic (see TS 33.222 [5]). For Public-safety UEs
that support certificates, mutual certificate based authentication in TLS
should be used. It is assumed that in this case the UE would be pre-
provisioned with the relevant certificates to use with the local PDF.
### 6.1.2 Solution #6.2: Security for configuration data transfer
#### 6.1.2.1 General
This solution addresses key issue #1.1 in the present document and protects
reference point PC3 in TR 23.303 [20]. The solution does hence not cover the
case of provisioning ProSe APP configuration data directly from the ProSe APP
server to the UE; a separate solution is needed to cover that case as well.
This solution can solve the case when the ProSe APP server delegates the
provisioning of its parameters to the ProSe Function. The ProSe APP server
then transfers its ProSe APP configuration data to the ProSe Function over
PC2, and the ProSe Function forwards also the ProSe APP configuration data to
the UE over the PC3 reference points.
#### 6.1.2.2 Overview of solution
The UE is authenticated by using Authentication and Key Agreement (AKA). The
UE and ProSe Function are mutually authenticated using AKA procedures. After
UE is authenticated, the reference point between UE and Prose Function is
protected by IPSec.
For Public-safety UEs that support certificates, mutual certificate based
authentication in TLS should be used.\ It is assumed that in this case the UE
would be pre-provisioned with the relevant certificates to use with the local
PDF.
Editor\'s note: Relationship between AKA and IPsec needs to explained.
The applicability to visited networks can be referred to the TS 23.303 Figure
4.2-3 roaming reference architecture, and ProSe function in the visited
network can retrieve the AV needed for AKA from the ProSe function in the home
network.
#### 6.1.2.3 Solution description: keys establishment procedure for PC3
The ProSe function can interact with the HSS to retrieve the authentication
data in order to authenticate the UE for ProSe service. The ProSe function
retrieves the ProSe AV from the HSS and performs AKA with ProSe UE to share
IK\', CK\' with the Prose UE, and uses the IK\'\|\|CK\' as the integrity
protection and encryption keys needed for PC3 security protection. The content
of the ProSe AV includes {RAND, XRES, IK\', CK\', AUTN}.
{width="5.6097222222222225in" height="2.4715277777777778in"}
Figure 6.1.2.3-1: PC3 security protection keys establishment procedure
1\. The ProSe UE sends its IMSI to the ProSe Function in the registration
request message.
2\. The ProSe Function includes UE\'s IMSI and the ProSe Function\'s ID in the
ProSe authentication data request message to the HSS to retrieve the ProSe
authentication vector.
3\. After the HSS derives CK, IK, the HSS derives CK\'\|\|IK\' =KDF (CK\|\|IK,
Prose Function ID,SQN⊕ AK).
4\. The HSS sends the AV including CK\', IK\' to the ProSe Function.
5\. The ProSe function sends ProSe authentication request to the ProSe UE,
6\. The ProSe UE authenticates the network, derives CK, IK, and then the UE
derives CK\'\|\|IK\'=KDF(CK\|\|IK, Prose Function ID,SQN⊕ AK)
7\. The ProSe UE sends ProSe authentication response to the ProSe function,
which authenticates the UE.
8\. The ProSe Function sends the registration response message.
#### 6.1.2.4 Solution evaluation
GBA framework could also be used to protect the reference point between the UE
and the ProSe Function.\ The ProSe Function would play the role of the NAF as
defined in GBA framework specified in 3GPP TS 33.220.\ After the establishment
of the NAF key (Ks_(ext/int)_NAF) between the UE and the ProSe function, PSK-
TLS procedure could be performed between the UE and the ProSe function.
The solution described in this clause relies on a direct interface between the
ProSe Function and the HSS, and the usage of such a direct interface to the
HSS was discussed several times in 3GPP SA3. When GBA was under definition
several architectures were discussed and analysed to lead to GBA architecture.
HSS-related design guidelines for a security architecture was provided and the
BSF (Bootstrapping Server Function) of GBA was created to avoid direct
interface between Application Servers and the HSS.
Direct access to the HSS should be avoided when an alternative solution,
already specified, is available and fulfils the requirements.
#### 6.1.2.5 Solution Analysis
This solution adds a new authentication domain to the existing domains CS, PS,
IMS, GBA, and WLAN. In order to minimize synchronisation failures due to
interleaving authentications with existing authentication domains, the HSS
should be adapted to treat authentication requests via the PC4a interface as a
new authentication domain.
Editor\'s note: For AKA solution, since for each authentication request a
request to the HLR will be made, load on HSS is FFS
The benefits of this solution are analysed as the following:
1\. No extra network entity is required for the AKA-based solution
Editor\'s note: For AKA solution, the security risks by adding an additional
interface to HLR/HSS are FFS.
> As shown in the Figure 6.1.2.5-1, on the network side, for the AKA-based
> solution, the key distribution is from the HSS to the ProSe Function
> utilizing the PC4a interface, but for the GBA-based solution, the BSF is
> needed for the purpose of the key distribution.
{width="5.522916666666666in" height="2.928472222222222in"}
Figure 6.1.2.5-1: Network entities and interfaces involved for different
solutions
2\. Evaluation of interface for AKA based solution.
> For the AKA-based solution, the ProSe Function utilizes the existing network
> interface. As described in the TS 23.303, the interface between the ProSe
> Function and the HSS is PC4a, and it is used to provide subscription
> information in order to authorize access for ProSe Direct Discovery and
> ProSe Direct Communication on a per PLMN basis. It is used by the ProSe
> Function (EPC-level ProSe Discovery Function) for retrieval of EPC-level
> ProSe Discovery related subscriber data. Therefore, for security purpose,
> the PC4a interface can be reused to provide key material for PC3 interface.
>
> The design purpose of GBA is to limit the number of different types of
> interfaces to the HSS. One raison is to keep the complexity of the HSS low.
> The GBA base solution for configuration data security does not avoid the
> PC4a interface between the ProSe function and the HSS.
For the GBA-based solution, the ProSe function entity needs to support the
extra interface Zn to the BSF, in order to receive the keys, as shown in the
Figure 6.1.2.5-1. The presence of the BSF allows to decrease the consumption
of Authentication Vectors by deriving a bootstrapped key.
3\. Evaluation of HSS handling for ProSe service for AKA solution
> As described in the TS 23.303, the authorization information and the
> subscriber data for ProSe service is provided from the HSS to the ProSe
> Function through PC4a interface, and the above information and data request
> security protection, so as the ProSe AV.
### 6.1.3 Solution #6.3: Security for configuration data transfer
#### 6.1.3.1 General
This solution addresses key issue #1.1 in ProSe scenarios when the
configuration data of ProSe-enabled UE are stored in the UICC. After
deployment of the ProSe-enabled UE the configuration parameters stored in the
UICC may need to be updated to reflect the changes in the configuration
applied by the operator.
Editor\'s note: it needs to be clarified if the configuration data is only for
network operations or also ProSe APP configuration data. If it is also the
latter it needs to be clarified under which circumstances it is applicable to
store it on the UICC.
#### 6.1.3.2 Overview of solution
In case that configuration data of ProSe-enabled UE are stored in the UICC,
the UICC OTA mechanism (as specified in ETSI TS 102 225 [8] / TS 102 226 [9]
and 3GPP TS 31.115 [10] / TS 31.116 [11]) is used to secure the transfer of
the configuration data to be updated in the UICC.
## 6.2 Solutions for Discovery
### 6.2.1 Solution #2.1: Security for ProSe discovery
#### 6.2.1.1 General
This clause provides a security solution for ProSe discovery procedure in Key
issue #2.1.
#### 6.2.1.2 Solution description
Potential security solutions for security requirements given in clause 5.2.1.3
are discussed below.
1) Without network interaction, as shown in Figure 6.2.1.2-1:
a) UEs participating in discovery can share a pre-configured secret. The UEs
can derive session keys from the secret to protect and verify the discovery
request and response messages.
b) UE may be allocated a certificate for discovery use which can be verified
by the other UEs with or without network support.
{width="2.66875in" height="2.216666666666667in"}
Figure 6.2.1.2-1: Secure discovery procedure, without network interaction
Editor\'s note: If certificates are used, then revocation etc., need to be
considered.
1 With network interaction, as shown in Figure 6.2.1.2-2:
a) UE and network entity (e.g. ProSe Function) share a secret such that UE and
the network entity can perform integrity protection and verification of the
discovery request and response messages.
UE and ProSe Function should perform mutual authentication at registration
phase. Such mutual authentication was agreed in clause 6.1.2, and registration
to ProSe Function can be found in SA2 TR 23.703 [4] solution D4, D8 and D11.
After the mutual authentication, UE and ProSe Function can share a secret,
from which UE and ProSe function can derive subkeys. The subkeys will be used
for Discovery Request and Discovery Response integrity protection and
verification, in case of discovery with network interaction.
NOTE: When UE only interacts with eNB and/or MME, the current SAE/LTE security
may be sufficient.
{width="3.8319444444444444in" height="2.625in"}
Figure 6.2.1.2-2: Secure discovery procedure, with network interaction
### 6.2.2 Solution #2.2:Security for Direct Discovery
#### 6.2.2.1 Using Asymmetric Cryptography and Timestamp for Direct Discovery
Potential solution to prevent replay and impersonation attack is to digitally
sign the discovery message using private key of the transmitting Prose UE
along with time stamp, as shown in Figure 6.2.2.1-1. Announcing ProSe UE signs
the discovery information using its Private Key and time stamp of radio frame.
Monitoring ProSe UE verifies the received discovery information using the
Public key of the announcing UE and time stamp of radio frame in which the
digitally signed discovery information is received. If verification is
successful, then discovery information is sent to upper layer otherwise it is
discarded.
The time stamp used in this solution, is the time stamp of the radio frame in
which the discovery message is transmitted (additionally subframe number can
also be used, one radio frame has 10 subframes and discovery message is
transmitted in one of the subframe), which will be in sync between the
announcing and monitoring Prose UEs (by using the \'TimeInfoUTC\' field in SIB
16 of the macro eNB, see TS 36.331[13]). Discovery information protection and
verification is performed at the AS layer. The AS layer decides the radio
frame and the subframe in which discovery information is transmitted, as the
AS layer has the time stamp information of the radio frame. By using the
Timestamp of the radio frame and may also sub-frame number, the overhead
introduced to carry the absolute time stamp in the discovery message is
avoided and also use of non-sync system time of the ProSe UE is avoided.
Asymmetric security keys can provide protection against impersonation by
monitoring ProSe UE, especially for one to many communication scenarios.
Public Key of the ProSe UE or application is provided to ProSe server securely
and ProSe server distributes the Public Key to the authorized ProSe UEs for
discovery information verification.\ Once the Prose UE get authorized and
configured for ProSe discover, then the ProSe UE starts sending its
announcement for other UEs to discover it. The announcement message is
digitally signed using its private key and the announcement message carries
the digital signature. When this announcement is received by other prose UEs
which are in interest to communicate with this UE, would have obtained public
key of this UE from the ProSe Server.\ So the monitoring ProSe UEs verifies
the authenticity of the announcement message. This mechanism is applicable for
both Open and Restricted discovery in order to protect a discovery message
against replay and impersonation attacks. Further this solution provide option
to the network to restrict the discovery announcements by distributing only
authorized UE\'s public key to other Prose UEs.
Editor Notes: Mechanism to distribution Public Key is FFS. Requirement for the
mechanism for dynamic distribution of public keys is FFS. Details of the
solution when roaming are FFS
{width="5.145833333333333in" height="2.607638888888889in"}
Figure 6.2.2.1-1: Security mechanism for Direct Discovery
Editor\'s note: It is FFS how this solution is applicable for confidentiality
protected Discovery Information in restricted discovery
Editor\'s note: Details of on the message size and how it fits into discovery
frames is FFS
### 6.2.3 Solution #2.3: Solution against DOS attack in registration procedure
#### 6.2.3.1 General
This solution addresses key issue #2.3 in the present document and gives the
security solution of the registration process in ProSe discovery.
A ProSe enabled UE first initiate a registration process before it gets ProSe
ID to communicate with other ProSe enabled UEs. Then the ProSe server verifies
the subscription of the UE to see whether the indicated Open/Restrictive ProSe
service is subscribed.
There is a threat in this procedure. An attacker can utilize the registration
procedure to send many signalling to ProSe Server to fake a subscribed UE,
which can cause ProSe Server huge consumption.
There are two options to deal with this attack.
#### 6.2.3.2 Option1: Blacklist:
In this solution, when there are more than one registration requests from the
same UE, the ProSe Function will check how much requests this UE has sent
before in a period of time. If the amount of requests exceeds the preset
threshold (based on a local policy), the ProSe Function might decide to ignore
all such request from the same UE for a period of time.\ The ProSe Function
will keep a blacklist which contains a list of the misbehaving UEs,. In order
to set and maintain this blacklist the ProSe Function collects information
from which UE the requests are sent. The subscription ID or UE ID could be a
part of the registration request message or could be added by other network
entities e.g. MME. When the ProSe Function receives a registration request, it
will first check whether this UE is in the blacklist. The request from the UE
which is in the blacklist will be discarded. UEs\' ID that stayed in blacklist
for more than n hours without trying to re-register might be deleted from the
list.
NOTE: Using a blacklist could lead to a DoS vulnerability by blacklisting UEs
for the wrong reason.
#### 6.2.3.3 Option 2: Captcha
In this solution, the UE who sends a ProSe registration request to the ProSe
Server receives a captcha from the ProSe Server instructing the UE of the
minimum allowable delay between any two consecutive ProSe registrations.
This method can stretch the time between the UE attempts to send two
consecutive registrations to the ProSe server and avoiding the DOS attack from
the terminal side.
{width="6.686111111111111in" height="3.9256944444444444in"}
Figure 6.2.3.3-1: procedure of registration against DOS attack
  1. The attacker uses a ProSe-enabled device to perform LTE attach procedure after power on and establishes a PDN connection to PGW.
  2. The application running in this UE asks the EPS layer in UE to send the request message that includes application id and open/restrictive indication to the ProSe Server.
  3. The EPS layer in UE sends a ProSe registration request the ProSe server. The registration request includes the application identity, and the open/restrictive indication.
  4. The ProSe server determines based on the UE\'s subscription and behaviour, if captcha is required.
  5. If yes, the ProSe server sends the captcha request to the UE. The captcha is presented to the user.
  6. The UE sends back the captcha response to the ProSe server
  7. The ProSe server verifies captcha response, verifies and authorizes the registration.
### 6.2.4 Solution #2.4: Security for discovery with network checking
#### 6.2.4.1 General
This solution addresses key issues #1.1, #2.2 and #4.3 in the present document
and is the security part of solution in clause 5.3 of TS 23.303 [20].
#### 6.2.4.2 Overview of solution
The solution proposed in clause 5.3 of TS 23.303 [20] describes several
procedures. These are the following:
1\. The Service Authorization procedure: The UE contacting the ProSe
function(s) in the network in order to obtain authorization to use direct
discovery in the various PLMNs. This step also includes the ability of the
network to revoke authorization with via a push message.
2\. The Discovery Request procedure: This allows an announcing and monitoring
UE to obtain the necessary configuration information to be able to announce a
code or monitor for codes on a particular PLMN. Among other things, the
configuration information includes the codes to be announced or monitored for
and for announcing UE only the key that is used to integrity protected the
code during its announcement.
3\. The Discovery procedure: The code is announced by the announcing UE and
received by the monitoring UE
4\. The Match Report procedure: This allows a code received by the monitoring
UE to be checked and confirmed by the network. As part of this procedure the
network checks the integrity protection on the received code and also provides
the UE with the ProSe App Id Name of that code and possibly the meta-data
corresponding to the that code.
1, 2 and 4 above all include the possibility to exchange traffic between ProSe
functions in different PLMNs.\ Analysing the above procedures 1, 2, and 4
require the security requirements in Key issue #1.1 on protecting
configuration data to be satisfied (strictly 4 is not about configuration data
but has the same requirements).\ Steps 1, 2 and 4 also require the protection
of traffic between network entities and hence require the security requirement
in key issue #4.3.\ Finally, for open discovery the security requirements in
key issue #2.2 needs to be satisfied.
The following subclauses detail the proposed security solution to each of the
key issue above.
#### 6.2.4.3 Security procedures
##### 6.2.4.3.1 Protection of Interface between the UE and ProSe Function
using GBA
For UE initiated messages, PSK TLS with GBA based shared key-based mutual
authentication is to be used between UE and ProSe Function as specified by
clause 5.4 of TS33.222 [5].
The ProSe Function (NAF) requests USSs from the BSF when requesting the
Ks_(ext/int)_NAF key and the ProSe Function checks in the USS if the USIM is
authorized to be used for ProSe services. If the authorization in the ProSe
Function fails then the ProSe Function releases the PSK-TLS connection with
the UE.
For network initiated messages one of the following mechanisms is used:
\- If a PSK TLS connection has been established as a part of a pull message
and is still available, the available PSK TLS session is used.
\- Otherwise, PSK TLS with GBA push based shared key-based mutual
authentication between the UE and the ProSe Function is used. GBA push is
specified in TS 33.223 [7]. The ProSe Function (pushNAF)requests USSs from the
BSF when requesting a GPI, and the ProSe Functionchecks in the USS if the USIM
is authorized to be used for ProSe services. If the authorization in the ProSe
Function fails then the ProSe Function refrains from establish PSK TLS with
GBA push.
NOTE: If a TLS connection is released, it can only be re-established by the
client side, I.e. UE, even though the TLS session including security
association would be alive on both sides. TLS connection, in turn, is
dependent on the underlying TCP connection.
##### 6.2.4.3.2 Interface between network elements
For all interfaces between network elements,
\- TS 33.210 [18]is to be applied to secure signalling messages on the
reference points unless specified otherwise, and
\- TS 33.310 [19] may be applied regarding the use of certificates with the
security mechanisms of TS 33.210 [18] unless specified otherwise in the
present document.
NOTE: For the case of an interface between two entities in the same security
domain, TS 33.210 [18] does not mandate the protection of the interface by
means of IPsec.
##### 6.2.4.3.3 Integrity protection and validation of the transmitted code
for open discovery
##### 6.2.4.3.3.1 Open discovery security flows {#open-discovery-security-
flows .H6}
The announced code is integrity protected as shown in the following flow which
includes only the additional security parameters. The system is assumed to
ensure that there is a UTC based time counter parameter that is known to both
the announcing and monitoring UEs, as clarified in the latest LS (see
S3-140566). The message flows apply when both the UEs are roaming or when one
or both are in the HPLMN.
Note that integrity protection via this MIC furthermore enables the ProSe
Function to verify that the announcing UE was indeed authorized to announce
this ProSe App Code at that time instance.
Figure: 6.2.4.3.3.1-1: Integrity protection of the transmitted code
1\. The Announcing UE sends a Discovery Request message containing the ProSe
Application ID name to the ProSe Function in its HPLMN in order to be allowed
to announce a code on its serving PLMN (either VPLMN or HPLMN).
2./3. The ProSe Functions in the HPLMN and VPLMN of the announcing UEs
exchange Announce Auth. messages. There are no changes to these messages for
the purpose of protecting the transmitted code for open discovery.\ If the
Announcing UE is not roaming, these steps do not take place.
4\. The ProSe Function in HPLMN of the announcing UE returns the ProSe App
Code that the announcing UE can announce and a 128-bit Discovery Key
associated with it. The ProSe Function stores the Discovery Key with the ProSe
App Code. In addition, the ProSe Function provides the UE with a CURRENT_TIME
parameter, which contains the current UTC-based counter at the ProSe Function
and a MAX_OFFSET parameter, which indicates the maximum counter difference
between the counter held in the UE (\"UE clock\") and the UTC based counter
value associated with the discovery slot. The UE sets its clock to the value
of CURRENT_TIME UTC based counter and stores the MAX_OFFSET parameter,
overwriting any previous values.
NOTE: The MAX_OFFSET defines the size of the window during which the announced
code could be replayed.
5\. The UE starts announcing. In each slot that it announces, if the UTC based
counter provided by the system for the discovery slot is within the MAX_OFFSET
of the announcing UE\'s clock, the announcing UE calculates a 32-bit Message
Integrity Check (MIC) to include with the ProSe App Code in the discovery
message. The MIC is calculated as described in subclause 6.2.5.3.3.2.
6\. The Monitoring UE sends a Discovery Request message containing the ProSe
Application ID name to the ProSe Function in its HPLMN in order to get the
ProSe App Code(s) that it wants to listen for.
7/8. The ProSe Functions in the HPLMN of the monitoring UE and VPLMN of the
announcing UEs exchange Monitor Req./Resp. messages. There are no changes to
these messages for the purpose of protecting the transmitted code for open
discovery.
9\. The ProSe Function returns the ProSe App Code(s) along with the
CURRENT_TIME, UTC based counter, and the MAX_OFFSET parameters. The UE sets
its clock to CURRENT_TIME and stores the MAX_OFFSET parameter, overwriting any
previous values.
10\. The Monitoring UE listens for a discovery message that contains a ProSe
App Code that it is interested in.
11\. On hearing such a discovery message, if the UTC based counter provided by
the system for that discovery slot is within the MAX_OFFSET of the monitoring
UE\'s clock, the Monitoring UE sends a Match Report message to the ProSe
function containing the UTC based counter parameter related to the slot where
it heard the announcement and the discovery message including the ProSe App
Code and MIC.
12\. The ProSe Function in the HPLMN of the monitoring UE passes the discovery
and associated UTC based counter time parameter to the ProSe Function in the
VPLM of the announcing UE in the Match Report message.
13\. The ProSe Function in the HPLMN of the announcing UE checks the MIC is
valid. The relevant Discovery Key is found using the ProSe App Code.
14\. The ProSe Function in the HPLMN of the announcing UE acknowledges a
successful check of the MIC to the ProSe Function in the HPLMN of the
monitoring UE in the Match Report Ack message.
15\. The ProSe Function in the HPLMN of the monitoring UE returns an
acknowledgement that the integrity checked passed to the Monitoring UE. The
ProSe function returns the parameter ProSe Application ID name to the UE.\ It
also provides the CURRENT_TIME, UTC based counter parameter, by which the UE
(re)sets its clock.
##### 6.2.4.3.3.2 Calculation of the MIC value {#calculation-of-the-mic-value
.H6}
When calculating a MIC using the Discovery Key, the following parameters are
used to form the input S to the KDF that is specified in Annex B of TS 33.220
[6].
\- FC = to be allocated if there is normative work here
\- P0 = Time parameter provided by the network for that discovery slot
\- L0 = length of above (which is FFS)
\- P1 = Contents of the discovery message excluding the MIC
\- L1 = length of above (which is FFS)
The Discovery Key, Time parameter and discovery message follow the encoding
also specified in Annex B of TS 33.220 [6].
Editor\'s note: The discovery messages contain all the parameters transmitted
over the air as it is expected that all of these need to be included the MIC
calculation. Whether it is better to have just discovery message or encode the
separate parameters in the discovery message as distinct Pi parameters in the
above KDF is FFS.
### 6.2.5 Solution #2.5: Security for discovery response
#### 6.2.5.1 General
This solution addresses key issue #2.1 in the present document. Direct
Discovery procedure is described in SA2 TS 23.303 [20] for Rel-12. Note that
no signalling flows have been provided to the SA2 TS 23.303 [20] for Model B.
This solution is therefore based on some assumptions on possible combinations
of broadcasted identities in Direct Discovery Request message and Direct
Discovery Response message.
#### 6.2.5.2 Overview of solution
In the discussion below the term \'Discoverer UE\' could be mapped to either a
\'Discoverer UE\' as defined in Model B in TS 23.303 [20] or an \'Announcing
UE\' as defined in Model A in TS 23.303 [20].
In the discussion below the term \'Discoveree UE\' could be mapped to either a
\'Discoveree UE\' as defined in Model B in TS 23.303 [20] or an \'Monitoring
UE\' as defined in Model A in TS 23.303 [20].
When the Discoverer UE wishes to discover users in vicinity, it broadcasts a
Direct Discovery Request message.
The Discoveree UE process the Direct Discovery Request message and based on
the information in the Direct Discovery Request message the Discoveree UE\'s
may decide to respond with a Direct Discovery Response message.
When the Discoverer UE receives the Direct Discovery Response message, then
the Discoverer UE:
  * Needs to ensure that the Discoveree UE is authentic and that the Direct Discovery Response message is not replayed by a false UE, and
  * Needs to ensure that the Discoveree UE is authorized by the ProSe Function in the network to respond to the announced Direct Discovery Request message.
This solution proposes that a Token is included in the Direct Discovery
Response message from the Discoveree UE to the Discoverer UE.
Figure 6.2.5.2-1: Generation of Token
The Token is calculated by the ProSe Function in the network and provided to
the Discoveree UE. The Discoveree UE includes the Token in the Direct
Discovery Response message back to the Discoverer UE.
The Discoverer UE calculates the Token and compares it with the broadcasted
Token in the Direct Discovery Response message. If the Tokens are equal then
the Discoverer UE knows that the Discoveree UE is authentic and authorized to
respond and the Direct Discovery Response message is not a replayed Direct
Discovery Response message.
#### 6.2.5.3 Signalling flows
An example of a detailed signalling flow can be found below in the Figure
6.2.5.3-1 below.
Figure 6.2.5.3-1: Security for Model B
  1. The Discoverer UE sends a Discovery Request message to the ProSe Function in the network in order to request to be allowed to announce a ProSe code on that PLMN. The ProSe Function returns the Discovery Response message containing a ProSe App Code that the Discoverer UE can announce and a Discovery Key associated with it. The ProSe Function stores the Discovery Key with the Discovery Request message.
  2. The Discoverer UE starts announcing the Direct Discovery Request message.
  3. The Discoveree UE sends a Discovery Request message to the ProSe Function in the network in order to get the ProSe App Code that it wants to listen to. The ProSe Function in the network returns the ProSe App Code to the Discoveree UE.
  4. The Discoveree UE listens for announced codes that contain a ProSe App Code that it is interested in.
  5. On hearing such an announced code, the Discoveree UE sends a Match Request containing the \'timevalue\' parameter related to the slot it heard the announcement and the announced code, I.e. the ProSe App Code and MIC, together with any other potential included identity in the Direct Discovery Request message.\ The Discoveree UE also sends an indication that it wants to announce a Direct Discovery Response message if the match is successful.
  6. The ProSe Function in the network verifies the received ProSe App Code and MIC and if verification is successful, then the ProSe Function in the network generates a Token.
  7. The ProSe Function in the network provides the Token to the Discoveree UE.
  8. The Discoveree UE starts to broadcast the Direct Discovery Response message including the Token.
  9. The Discoverer UE listens for Direct Discovery Response message and receives the Direct Discovery Response message which it is interested in.
  10. The Discoverer UE verifies the Token using the Discovery Key. If the verification is successful then the Discoverer UE knows that authentic Discoveree UE is within proximity.
#### 6.2.5.4 Token
Token = MAC (First parameter, Second parameter, Third parameter, Fourth
parameter)
The First parameter could provide some freshness. Example of parameters which
could provide this:
  * ProSe App Code. The ProSe App Code included in the Direct Discovery Request message, which could provide freshness in a time window. The ProSe App Code is constructed by the ProSe Function in the network and has an associated validity timer. When the validity timer expires then the ProSe App Code is no longer valid.
  * Time stamp or time value.
The Second parameter could make it difficult to forge tokens. Example of
parameter which could be used:
  * Discovery security key. The Discovery security key can be shared by the Discoverer UE and the ProSe Function in the network.
The Third parameter could make the token unique per Discoveree UE. Example of
parameter which could be used:
  * Discoveree UE identity as ProSe UE identity.
The Fourth parameter could map the Direct Discovery Response to the Direct
Discovery Request. Example of parameter which could be used:
  * ProSe App Code. The ProSe App Code included in the Direct Discovery Request message. Note that if ProSe App Code has been used in the First parameter then it would not be needed to include it twice.
Editor\'s Note: Other possible parameters of the Token are FFS.
### 6.2.6 Solution #2.6: Security for proximity request authentication and
authorization
#### 6.2.6.1 General
The following solution addresses the key issue #2.2.
The ProSe Function of two UEs may belong to different PLMNs and, according to
the current version of TS 23.303 [20], the application server is the entity
which discloses the EPUID of a particular target UE to a ProSe Function so
that it can request to the Prose Function managing that target UE the sending
of its location information for a particular period of time.
However, no mechanism currently exist to ensure that the ProSe Function
requesting the location information of that particular target UE has genuinely
been requested by the UE itself, not the ProSe UE.
The risk is that it would take just one Proximity Request from the UE for the
ProSe Function to actually keep a record of [ALUID_B, EPUID_B, PFID_B] mapping
and have the capability to later send a proximity request (step 4 of Proximity
Request procedure in clause 5.5.5 of [20]) although the UE did not actually
send a proximity request at all (step 4 of Proximity Request procedure in
clause 5.5.5 of [20]). This could lead to massive surveillance of users by
other PLMNs that may be very difficult to detect by the PLMN which serves
particular ProSe UEs.
{width="5.982638888888889in" height="3.3118055555555554in"}
Figure 6.2.6.1-1: extract from 3GPP TS 23.303 [20],\ Proximity Request
Procedure (clause 5.5.5)
#### 6.2.6.2 UE-signed proximity request
UE A signs all the proximity requests sent to its ProSe Function A over the
PC3 interface.
The UE\'s signature key can be provided by the application server over the PC1
interface. Or the UE could generate a signature and verification key pair,
securely stores the signature key in its memory and export the verification
key to the Application Server.
The UE\'s verification key is provided to ProSe Function B by the Application
Server over the PC2 interface. ProSe Function B is assured of the authenticity
of the proximity request received from ProSe Function A over the PC6 interface
by verifying a cryptographic signature with a verification key from the U.E.
The procedure below further defines the Proximity Request procedure in clause
5.5.5 of TS 23.303 [20] to support authenticity of the request.
Figure 6.2.6.2-1: UE-signed Proximity Request
0\. UE A and the Application Server perform a key establishment ceremony,
which results in having a signature key in UE_A and a verification key in the
Application Server. The communication between UE A and the application is end-
to-end secured over the PC1 interface.
1\. UE A sends as part of the Proximity Request the following additional data:
a signature UEA_signature of the cryptographic hash of the concatenation of
the EPUID_A, the ALUID_A, the ALUID_B and a timestamp value to ProSe Function
A. Theses should therefore be transmitted to the Application Server and the
ProSe function B so that both may verify the cryptographic signature with the
UE\'s verification key.
2\. ProSe Function A sends as part of the Map Request message the following
additional data: the UEA_signature and the timestamp provided by UE A to the
Application Server.
3\. The Application Server verifies the UEA_signature with the verification
key of ALUID_A. An error message is returned if the verification fails. If the
verification is successful, the Application Server may optionally add in the
Map Response the associated certificate of ALUID_A\'s verification key.
4\. ProSe Function A sends as part of the Proximity Request to ProSe Function
B the following additional data: the UEA_signature, ALUID_A, ALUID_B and the
timestamp, the Application ID and optionally the ALUID_A\'s certificate.
5\. If ALUID_A\'s certificate or verification key was not part of the
Proximity request, ProSe Function B sends a Verification Key fetching requests
to Application Server (identifiable from its Application ID) ALUID_A\'s
verification key.
6\. The Application Server returns the verification key of ALUID_A.
7\. If the verification of UEA_signature is successful then the procedure
continues the procedure from step 5 in clause 5.5.5 of 3GPP TS 23.303 [20].
#### 6.2.6.3 Application Server-signed proximity request
UE A does not sign the proximity requests sent to its ProSe Function A, but
trusts the Application Server to control the authorization of the proximity
request sent on its behalf.\ The authorization criteria can be based on
detection mechanisms of very high volume of incoming proximity requests from a
ProSe Function that does not match with the frequency usage of the ProSe
Application by the users, or it can be based on a presence detection mechanism
over the PC1 interface.\ ProSe Function A requests an authorization to the
Application Server for each proximity request it should transmit over the PC2
interface. The Application Server returns parameter which specifies which
operations are authorized\ (e.g. authorized to send only one request,
authorized to send X requests until particular date, etc.).\ ProSe Function B
is assured of the authenticity of the proximity request received from ProSe
Function A by verifying the signature with a verification key from the
Application server.\ The token verification key is fetched over the PC2
interface between the ProSe Function B and the Application Server.
The procedure below further defines the Proximity Request procedure in clause
5.5.5 of TS 23.303 [20] to support authenticity of the request.
{width="5.794444444444444in" height="3.2395833333333335in"}
Figure 6.2.6.3-1: Application Server-signed Proximity Request
1\. Same as Step 1 of procedure in clause 5.5.5 of [20]
2\. Same as Step 2 of procedure in clause 5.5.5 of [20]
3\. The Application Server returns as part of the Map Response following
additional data: the authorized operations\ (e.g. authorized to send only one
request, authorized to send X requests until particular date, etc.), a
timestamp,\ the signature AS_signature of the cryptographic hash of the
concatenation of the ALUID_A, the ALUID_B,\ the authorized operations and the
timestamp value, and optionally the associated certificate CertKey_AS of
Application Server\'s verification key
4\. ProSe Function A sends as part of the Proximity Request to ProSe Function
B the following additional data:\ the AS_signature, ALUID_A, ALUID_B, the
timestamp, the authorized operations, the Application ID and optionally the
CertKey_AS\'s certificate.
5\. If the CertKey_AS\'s certificate was not part of the Proximity request, or
that either the CertKey_AS\'s certificate or verification key was not stored
in internal memory, then ProSe Function B sends a Verification Key fetching
requests to Application Server Application ID\'s verification key
(identifiable from its Application ID).
6\. The Application Server returns the verification key.
7\. If the verification of signature from the Application Server is successful
then the procedure continues the procedure from step 5 in clause 5.5.5 of TS
23.303 [20].
#### 6.2.6.4 Proximity request digital signature algorithms and key strength
The cryptographic length of the signing asymmetric keys should have at least a
key strength equivalent to a 128-bits symmetric key. The following digital
signature algorithms may be used:
  * RSA as specified in FIPS 186-4 [24]: the minimum key length should be 3072 bits. The minimal size for the hash function is at least be SHA-256 which should be used as specified by NIST [29].
  * DSA as specified in FIPS 186-4 [24]: the minimum key length should be 256 bits.
  * ECDSA as specified in BSI TR-03111 [25]: the minimum key length should be 256 bits, the elliptic curve domain parameters should be selected among those available in RFC 5639 [26]. The corresponding hash function should be chosen depending on the previously selected elliptic curve domain parameters (cf. clause 5 in RFC 5639 [26]).
#### 6.2.6.5 Proximity request hash input format
The input to the hash function should be encoded as specified in Annex B.1 of
TS 33.220 [6] and should consist of the concatenation of proximity request
parameters and their respective lengths:
  * FC = TBD
  * P0 = EPUID_A
  * L0 = Length of P0 value
  * P1 = ALUID_A
  * L1 = Length of P1 value
  * P2 = ALUID_B
  * L2 = Length of P2 value
  * P3 = Timestamp. It should use the date-time format as defined in clause 5.6 of RFC 3339 [27] and should be encoded according to Annex B.2.1.2 of TS 33.220 [6]
  * L3 = Length of P3 value
#### 6.2.6.5 Verification key format
The following should be supported by the Application Server and the ProSe
function:
For the UE-signed proximity request case, the verification key of the
initiating ProSe UE is directly transmitted from the Application server to the
ProSe function of the target UE.
For the Application Server-signed proximity request case, the verification key
of the Application Server is directly transmitted from the Application server
to the ProSe function of the target UE.
The verification key should be formatted like the \"Subject Public Key Info\"
element of a X.509 certificate. The \"Subject Public Key Info\" is specified
in clause 4.1.2.7 of RFC 5280 [28]. RFC 5639 [26] should also be supported in
order to include ECDSA with Brainpool elliptic curve domain parameters.
#### 6.2.6.6 Profile for Application Server and Application UE certificate
The following may be supported by the Application Server and the ProSe
function:
For the UE-signed proximity request case, the certificate is transmitted from
the Application Server over the requesting ProSe function of the initiating
ProSe UE to the ProSe function of the target ProSe UE. It may also be
transmitted
It is optional to use certificates for the verification of the proximity
request signature. If however used, the following should apply:
Certificates used for authentication of the Proximity Request should meet the
certificate profiles given in TS 33.310 [19] as follows: clause 6.1.3, for SEG
certificates should apply to ALUID-associated certificates, and clause 6.1.4
for SEG CA certificates should apply to any CA certificates used in a chain to
validate the certificates, with the following additions and exceptions:
\- Mandatory critical key usage: only digitalSignature should be set
## 6.3 Solutions for One-to-many Communications
### 6.3.1 Solution #3.1: Security for ProSe Group Communications
#### 6.3.1.1 General
This solution address key issue #A3.2 in the present document and is aimed to
provide the security solution for solutions C1, C5, C6, C7 and C8 in TR 23.703
[4]. It is primarily aimed at meeting the public safety user requirements for
group communications out-of-network coverage, but can also be applied for in-
coverage scenarios.
#### 6.3.1.2 IDENTITY Security Solution
##### 6.3.1.2.1 General
The IDENTITY solution provides a flexible end-to-end security solution capable
of setting up secure one-to-one or group sessions without requiring a
connection to network infrastructure. It is intended for use by public-safety
users who require direct one-to-one or group connections when a connection to
the network does not exist. It provides a solution to perform authentication
and key-agreement for direct one-to-one communications (C3 and C4) and for
group communications (C1, C5, C6, C7, C8) as specified in TR 23.703 [4].
The IDENTITY solution allows information to be encrypted to a given UE using
solely their public identity (alongside pre-provisioned domain-level
information). Only a UE with this identity (alongside private keys provisioned
by the network infrastructure) is able to decrypt information encrypted to the
identity and sign information as this identity.\ As a result, provisioning
either occurs prior to deployment or while users are connected to the network
infrastructure, but secure connections may be established without access to
network infrastructure.\ The security mechanism which achieves this uses the
MIKEY-SAKKE protocol as specified in RFC 6509 [12].
##### 6.3.1.2.2 IDENTITY KMS
IDENTITY is a security protocol rooted and managed at the domain level. Each
domain supporting IDENTITY secure communications requires an IDENTITY Key
Management Server (KMS). The KMS controls the security of IDENTITY
communications within the domain, including the key period, the User IDs which
a user may use and the domains with which a user may securely communicate.
The KMS issues a public certificate for the domain for which it manages
communication security.\ To securely communicate with users in a domain, the
single KMS public certificate for the domain is required.\ The KMS issues its
own KMS public certificate to its users, along with KMS public certificate for
other domains KMS, allowing secure, inter-domain communications. Individual
users do not require certificates.
##### 6.3.1.2.3 Use of User IDs within IDENTITY
##### 6.3.1.2.3.1 General {#general-10 .H6}
To secure communications with a specific user, the initiator composes the
IDENTITY User ID (UID) to which the message will be encrypted. It is intended
that the format of the UID should be defined by the KMS. As a result, there is
flexibility on the choice of UID depending on the requirements of the specific
user group. The only constraint is that UID is well-defined and derived by the
initiator of the communication unambiguously.
For example, for IMS communications, the UID is likely to contain the user\'s
IMPU (e.g. alice\@domain.com), or in other contexts, perhaps the MSISDN.
However, for most domains, the UID used for IDENTITY communications will also
contain a reference to the current year, and perhaps also the current month or
week within the year. This defines the length of time a particular UID is
used, and also the key period for the key associated with the User ID.
The format for the UID for users within a domain is specified within the KMS
public certificate. For example,
> #uri?uidyear=#year&uidmonth=#month />
In this case, the initiator would construct a UID for a user within the KMS
domain by replacing \'#uri\' with the recipient\'s URI, \'#year\' with the
current year and \'#month\' with the current month. For example:
alice\@domain.com?uidyear=2014&uidmonth=03
It is recommended that the KMS issues keys for a new month prior to the
beginning of the month.\ This allows the two month\'s UIDs to both be valid
for use on the month boundary.
##### 6.3.1.2.3.2 Group UIDs {#group-uids .H6}
Just as users are able to communicate independently of the network using
IDENTITY, groups may be managed independently of the network using group UIDs.
In this case, the KMS provisions a UID to the Group Manager using the URI for
the group. For example, for pre-configured groups the following may be
appropriate:
group.antipolis.police\@domain.com?uidyear=2014&uriusage=group;
Or, if a user is allowed to create their own ad-hoc group, they could be
provisioned with a UID for this purpose:
group.alice\@domain.com?uidyear=2014&uriusage=group;
The Group Manager may sign group management messages using the group UID
corresponding to the URI for the group. The group members are able to
authenticate the validity of the management message as only the Group Manager
is provisioned by the KMS to use the group UID. It is recommended to include
the attribute \'uriusage=group\' in the IDENTITY UID to ensure separation
between group UIDs and user UIDs.
6.3.1.2.4 IDENTITY UE Provisioning
6.3.1.2.4.2 General
To securely communicate using IDENTITY, each public safety UE needs to be
provisioned with keys corresponding to the public safety UE\'s UIDs, along
with domain specific information such as KMS\'s public certificate.
To be configured, the UE creates a secure connection to the KMS, and as part
of this process, the KMS verifies the identity of the UE. Within the secure
connection, the UE makes a request to the KMS which responds with domain
information and key material appropriate to the request and local domain
policy.
##### 6.3.1.2.4.2 Pre-Provisioning {#pre-provisioning .H6}
Prior to provisioning, the public safety UE requires the address (e.g. URL) of
the domain\'s KMS.
Public-safety UEs may also be pre-provisioned with additional security
parameters where required. For some user groups, such as UEs which may always
be outside of network coverage, the UE may be entirely provisioned prior to
deployment.
##### 6.3.1.2.4.3 UE to KMS connection security {#ue-to-kms-connection-
security .H6}
To be provisioned, the public safety UE establishs a secure connection to the
KMS. If security credentials have already been agreed between the KMS and UE
(e.g. due to a previous GBA connection, a secure IMS tunnel or pre-provisioned
parameters), an HTTPS connection is established using these credentials.
However the secure connection is established, the KMS is able to verify the
identity of the UE.
Otherwise, the KMS acts as a NAF and directs the UE to perform a GBA
bootstrapping procedure as described in TS 33.220 [6] and depicted in Figure
6.3.1.2.4.3-1. To achieve this, a BSF and the UE\'s HSS are used. As a result
of this procedure, the BSF and the UE have a shared key Ks. The KMS knows the
identity of the UE and receives the shared key Ks_(ext/int)_NAF from the BSF.
The Ks_(ext/int)_NAF which is NAF specific, is established between the KMS and
UE to protect the HTTPS connection between them as outlined in TS 33.222 [5].
NOTE: The usage of the type of key depends on the protocols used on Ua / Upa.
Figure 6.3.1.2.4.3-1: Bootstrap architecture for IDENTITY Provisioning
Should the KMS require keys to be updated outside of the normal schedule, a
GBA push procedure may be started by the KMS to establish a connection between
the KMS and the UE for key transfer.
6.3.1.2.5 Procedures for UE Configuration to use IDENTITY
6.3.1.2.5.1 General
This clause specifies the key management procedures between the KMS and the UE
that allows the UE to be configured to use the IDENTITY solution. It describes
the security procedures for the following processes:
\- IDENTITY Provisioning Request
\- IDENTITY Authorize Request
\- IDENTITY Information Request
6.3.1.2.5.2 IDENTITY Provisioning Request
This procedure registers a public safety UE within a specific domain. The
public safety UE sends a provisioning request to the KMS in the message-body
of a HTTP GET request. The Request-URI indicates the type of the message. Upon
successful request, KMS returns indication of success.
It is assumed that this request is made and responded to over an established
secure connection as described in clause 6.3.1.2.4. Figure 6.3.1.2.5.2-1
describes the procedure.
Figure 6.3.1.2.5.2-1: IDENTITY Provisioning Request
The provisioning shown in Figure 6.3.1.2.5.2-1 is as follows:
  1. The public safety UE sends the HTTP GET (Provision) to the KMS.
a) The Request-URI of the GET request contains a URI parameter \"requesttype\"
that is set to \"prov\" I.e. Request-URI takes the form of
\"/keymanagement/mikeysakke?requesttype=prov\".\ The GET request may contain
other URI parameters and headers as required.
  1. The KMS checks that the HTTP GET is valid, and extracts the request for further processing. During processing, the KMS ensures the public safety UE\'s identity is verified and apply the domain policy on assigning UIDs to the UE.
  2. After successful processing, the KMS returns a HTTP 200 OK to the public safety UE. The KMS populates the HTTP response with XML containing all information required to provision the UE. The contents of XML response may be signed by the KMS using the KMS public certificate. The response will include key material corresponding to the UE\'s UIDs. It may also include:
a) The KMS public certificate.
b) Public certificate of other KMS domains with which the UE may securely
communicate.
c) Domain policies (e.g. frequency of provisioning, or use KMS certificate A
to communicate with users in domain Z).
d) If the UE is able to create groups, key material corresponding to the group
UIDs.
For most user groups, the public safety UE will periodically (e.g. monthly)
make the provisioning request to the KMS.
##### 6.3.1.2.5.3 IDENTITY Authorize Request {#identity-authorize-request .H6}
Where the public safety UE receives a MIKEY-SAKKE I_MESSAGE using a UID for
which the private key has not been provisioned by the KMS, the public safety
UE may request the private key for this UID from the KMS. The UE sends an HTTP
GET (Authorize) request to the KMS. The Request-URI indicates the type of the
message and the UID required. Upon successful request, KMS returns an
indication of success.
It is assumed that this request is made and responded to over an established
secure connection as described in clause 6.3.1.2.4. The signalling flow of the
request is shown in Figure 6.3.1.2.5.3-1.
Figure 6.3.1.2.5.3-1: IDENTITY Authorize Request
The UID authorization procedure shown in Figure 6.3.1.2.5.3-1 follows:
  1. The public safety UE sends the HTTP GET (Authorize) to the KMS.
a) The Request-URI contains an URI parameter \"requesttype\" that is set to
\"idrequest\" and the Request-URI contains an URI parameter \"userid\" that is
set to the URL-encoding of the User ID required. For example, Request-URI
takes the form of \"/keymanagement/mikeysakke?requesttype=
idrequest&userid=alice%40operator.example%3FP-Year%3D2013%26P-Month%3D09\";
  1. The KMS checks that the HTTP GET is valid, and extracts the request for further processing. During processing, the KMS ensures the public safety UE\'s identity is verified and the UE is authorized to use the User ID requested.
  2. After successful processing, the KMS returns a HTTP 200 OK to the public safety UE. The KMS populates the HTTP response with XML containing key material corresponding to the requested UE\'s User ID.\ The contents of XML response may be signed by the KMS using the KMS public certificate.
##### 6.3.1.2.5.4 IDENTITY Information Request {#identity-information-request
.H6}
Where the public safety UE would like to send a MIKEY-SAKKE I_MESSAGE to a
public safety URI for which it does not know or have the KMS public
certificate corresponding to the URI, the UE may request this information from
the KMS or appropriate public server hosting KMS public certificates. The
Request-URI indicates the type of the message and the URI for which
information is required. Upon successful request, KMS returns indication of
success.
This request may be made without a security association between the server and
the UE, however the response from the server should be authenticated by the
UE\'s KMS. The signalling flow for this procedure can be seen in Figure
6.3.1.2.5.4-1.
Figure 6.3.1.2.5.4-1: IDENTITY Information Request
The URI information procedure is as follows:
  1. The public safety UE sends the HTTP GET (Information) request to the server.
a. The Request-URI contains a URI parameter \"requesttype\" that is set to
\"inforequest\" and the Request-URI contains a URI parameter \"uri\" that is
set to the URL-encoding of the public safety URI for which information is
required. For example, Request-URI takes the form of:
\"/keymanagement/mikeysakke?requesttype=inforequest&uri=alice%40operator.another\";
b. Where the server is not the user\'s KMS, the Request-URI may also contain a
URI parameter \"certuri\" that is set to the URL-encoding of the domain
certificate URI that the public safety UE trusts. The Information Server may
then respond with domain information signed using this Certificate URI. For
example: \"certuri=domaincert1.kms.operator.example\".
  2. If the request is valid and can be fulfilled by the server, it returns a HTTP 200 OK to the public safety UE. The server populates the HTTP response with XML containing the relevant domain certificate and domain policies provided by the public safety UE\'s KMS. The contents of XML response may be signed by the public safety UE\'s KMS.
6.3.1.2.6 Key Storage
It is assumed that the UE includes a secure storage. The secure storage may be
realized on the ME or on the UICC and should be used to store the key material
provisioned by KMS and any other long term key material (e.g. group master
key).
#### 6.3.1.3 IDENTITY Group Communications
##### 6.3.1.3.1 General
This clause describes how security associations for group communications can
be created and used to secure direct one-to-many communications. The same
procedures also apply to network-routed, one-to-many communications.
The procedures provide support for two different types of group:
\- Pre-configured groups, which are setup using the network prior to
communication. It is expected that the majority of groups will be of this
type.
\- Ad-hoc groups, which are created by UEs as required, and can also be
created without network connectivity.
The architecture for pre-configured groups is shown in Figure 6.3.1.3.1-1.
Figure 6.3.1.3.1-1: IDENTITY security architecture for Pre-Configured Group
Communications
Figure 6.3.1.3.1-1 describes the IDENTITY security architecture to create pre-
configured group communications for ProSe. The architecture uses the IDENTITY
public safety solution to distribute group keys and authenticate group
communications. At the top of the diagram, a public safety UE is provisioned
by a KMS with key material associated with its identity. If required, GBA is
used to bootstrap the security of the connection between the UE and the KMS.\
The KMS also provisions the Group Manager with keying material for the
identity of groups which it manages (if the group manager is a UE, the group
identity may be related to the identity of the public safety UE). This process
is described in clause 6.3.1.2.
For pre-configured groups, the Group Manager is responsible for advertising
the group and distributing Group Master Keys (GMKs) to UEs within the group.
This process, to configure the security association for a pre-configured
group, is described in clause 6.3.1.3.2.
Once a Group Master Key has been shared for the pre-configured group, UEs are
able to setup group communications. The initiating UE generates, encrypts and
transmits a Group Session Key (GSK) to the group members.\ This transmission
is encrypted using the GMK and may be authenticated, allowing the origin of
the transmission to be verified. The distribution process may also be
performed over a direct transmission. This process is described in clause
6.3.1.3.3.
With a Group Session Key shared, it is then used to protect data transmitted
directly between UEs. Communication security is described in clause 6.3.1.3.5.
It is anticipated that the majority of groups will be pre-configured. However,
this approach does not support all group communications requirements. For
example, pre-configured groups cannot be managed without network connectivity,
cannot support the dynamic setup of groups and cannot support \'Out-Of-The-
Box\' group communications. As a result, the IDENTITY solution supports the
creation of ad-hoc groups for this purpose.
For ad-hoc groups, the group is created by a single UE without a central
distribution function. The UE generates and distributes a group session key
encrypted to specific identities using the IDENTIY solution. As a separate
message iscreated by the UE for each user, this mechanism does not scale to
large groups, but supports highly flexible group creation. This mechanism for
distributing group session keys is described in clause 6.3.1.3.4.
##### 6.3.1.3.2 Pre-configured Group Security Configuration
###### 6.3.1.3.2.1 General
Pre-configured groups are managed by a Group Manager. This is likely to be a
central server whose role is to create, advertise and share a security
association for the group. To create the group\'s security association, a
Group Master Key (GMK) is distributed to public safety group members.
The security associations are setup using group notification or advertisement
messages, created by the Group Manager. The group advertisement messages
notify users of the existence of the group, but also provide the GMK encrypted
for the user. Using the IDENTITY solution, the GMK is encrypted to the public
safety user\'s identity and signed using the (key associated with the) group
identity, an identity which the group manager is authorized to use by the KMS.
In this way, the group manager\'s management messages are authenticated.
Figure 6.3.1.3.2.1-1: Overview of Pre-Configured Group Security Configuration
###### 6.3.1.3.2.2 Security Procedures for Pre-configured Group Security
Configuration
This procedure distributes a Group Master Key (GMK) from the group manager to
the public safety UEs within the group.
It is assumed that for a group within the network there will be a local
participating group server which manages communications with group members.
For pre-configured groups, it is also assumed that there exists a group
manager, which is a server (e.g. in the public safety control room) with the
authority to manage a specific pre-configured group. The security association
for the group is created via a group notification/advertisement message sent
from the group manager to public safety UEs within the group.
Figure 6.3.1.3.3.2.2-1 shows the security procedures for creating a security
association for a pre-configured group.
Figure 6.3.1.3.2.2-1: Security Configuration for Pre-Configured Groups
A description of the procedures depicted in Figure 6.3.1.3.3.2.2-1 follows:
  1. Prior to beginning this procedure it is assumed that all the public safety UEs within the group have been provisioned by an IDENTITY KMS as described in clause 6.3.1.2. The group manager should also be securely provisioned by the KMS to use the identities of the group(s) that it manages.
  2. A UE registers with its serving signalling server to use communication services. As part of this mechanism the public safety UEs registers with a group server and group manager. There are no additional security procedures associated with the registration process, although as a consequence, the group server obtains address information for local public safety UEs.
  3. The group manager notifies/advertises the group to public safety users within the group (e.g. using a SIP Group Advertisement message). It transfers the notification message to the participating local group servers.\ The message contains a MIKEY-SAKKE I_MESSAGE as specified in RFC 6509 [12]. The I_MESSAGE encapsulates the new GMK for the public safety UE. It is encrypted to the identity of the UE group member and signed using the (key associated with the) group identity. The message also contains the GMK key id and period of use.
> NOTE: Only a Group Manager authorized by a trusted KMS knows the private key
> associated with the group identity and is able to sign a message. All group
> members are able to verify the signature and hence can confirm the group
> manager is authorized to manage this group.
>
> NOTE: If there is a requirement to multicast the group notification message,
> the group manager may send the group notification message to a URI-List, and
> include a different I_MESSAGE for each UE.\ This will only be feasible where
> the group is small.
  1. The local group server forwards the group advertisement to the user\'s serving signalling server.
  2. The serving signalling server forwards the message to the public safety UE. The UE authenticates the sender and extracts the new GMK from the I_MESSAGE. The UE uses the last received GMK as the current group key (based on the timestamp in the I_MESSAGE).
  3. Upon successful receipt and processing, the public safety UE confirms receipt of the group advertisement message (e.g. within SIP OK) to its serving signalling server. The confirmation contains no security information.
  4. The serving signalling server forwards the confirmation to the local group server.
  5. The local group server forwards the confirmation to the group manager.
Should rekeying of the GMK be required, the Group manager may repeat the above
procedure.
NOTE: It is anticipated that the Group Manager will be a network entity.
However, it could also be a privileged UE without impacting the above security
procedures. The group manager does not require an on-going interaction with
the KMS to create a security association for a pre-configured group.
##### 6.3.1.3.3 Session Key Distribution for Pre-Configured Groups
###### 6.3.1.3.3.1 General
Group communications within a session are protected using a Group Session Key
(GSK). Hence, prior to beginning a communication, a session key is generated
by the session initiator and be shared with the group members.\ For pre-
configured groups, the Group Master Key (GMK) is used to protect the
distribution of the GSK. The GSK may also be signed using the initiator\'s
IDENTITY UID.
This process is summarised in Figure 6.3.1.3.3.1-1.
{width="6.690277777777778in" height="2.5506944444444444in"}
Figure 6.3.1.3.3.1-1: Overview of Session Key Distribution for Pre-Configured
Groups
###### 6.3.1.3.3.2 Session key distribution for pre-configured groups (network
connected)
These procedures assume the existence of a group controller. The group
controller is aware of which UEs are members of the group and is also
responsible for routing signalling and media traffic to the members of the
group.\ The group controller need not be a member of the group or have access
to the media that it routes. If this entity requires access to the group
communication to fulfil its function, it should be treated as a member of the
group and be provisioned with the Group Master Key by the group manager.
Figure 6.3.1.3.3.2-1 demonstrates the signalling flow for session key
distribution.
{width="5.566666666666666in" height="4.766666666666667in"}
Figure 6.3.1.3.3.2-1: Security Procedures for Session Key Distribution for\
Pre-Configured Groups (network connected)
The procedure in Figure 6.3.1.3.3.2-1 is now described step-by-step:
  1. Prior to beginning this procedure it is assumed that the security association for the pre-configured group has been created, as described in clause 6.3.1.3.2.
  2. Public safety UE 1 generates a GSK and sends a session creation notification (e.g. SIP INVITE) to the group controller, via a serving signalling server and local group server. Within the SDP Offer of this message, UE 1 includes a MIKEY Pre-Shared-Key message, as specified in RFC 3830 [14]. The MIKEY-PSK message encapsulates the session key with the Group Master Key (GMK) which is denoted by a key identifier.\ The MIKEY message may be signed using the (key associated with the) identity of UE 1 by attaching a ECCSI SIGN payload, as defined in RFC 6509 [12] and RFC 6507 [15].
NOTE: This message may be pre-generated to increase the efficiency of the
communication.
  1. The group controller notifies UE 1 that it received the message (e.g. SIP TRY). This message does not contain any security information.
  2. The group controller sends a session creation notification (e.g. SIP INVITE) to each public safety UE within the group, via each UEs local group server and signalling server. The SDP Offer of the message provided by public safety UE 1 is duplicated within each message, including the MIKEY-PSK content. The message is routed via each public safety UE\'s local group server and serving signalling server.
  3. Each member of the group uses the key identifier to find the GMK used by UE 1 and extracts the Group Session Key. The public safety UEs notify the group controller that they received the message. This message does not contain any security information.
  4. Further messages are sent to setup the group session. These messages contain no security information.
As a result of this procedure, the members of the group will created a group
session and shared a Group Session Key (GSK) to protect media within the
session.
###### 6.3.1.3.3.3 Session key distribution for pre-configured groups (network
independent)
This security mechanism is expected to be included as part of the procedures
to create a media session over a one-to-many direct communication.
From a security perspective, this procedure follows exactly the same security
mechanism as for network connected group communications described in clause
6.3.1.3.3.2, though the routing differs. In this case, the SDP Offer is
broadcast by the initiating UE and no response is expected. The SDP Offer
contains the Group Session Key (GSK) protected by the Group Master Key (GMK).
Following the broadcast of the SDP Offer, the media is broadcast over the one-
to-many direct link, protected under the GSK.
Figure 6.3.1.3.3.3-1 describes the procedure. As there are no responses or
acknowledgements, this procedure proceeds on a \'best-endeavour\' basis.
{width="4.466666666666667in" height="3.6666666666666665in"}
Figure 6.3.1.3.3.3-1: Security Procedures for Session Key Distribution for\
Pre-Configured Groups (network independent)
The procedure in Figure 6.3.1.3.3.3-1 is now described step-by-step.
  1. Prior to beginning this procedure it is assumed that the security association for the pre-configured group have been created, as described in clause 6.3.1.3.3.2.3.
  2. Public safety UE 1 generates a GSK and broadcasts a \'media session creation message\' containing an SDP Offer. Within the SDP Offer, UE 1 includes a MIKEY Pre-Shared-Key message, as specified in RFC 3830 [14].\ The MIKEY PSK message encapsulates the session key with the Group Master Key (GMK) and is denoted by a key identifier. The MIKEY message may be signed using the (key associated with the) identity of UE 1 by attaching a ECCSI SIGN payload, as defined in RFC 6509 [12] and RFC 6507 [15].
> NOTE: This message may be pre-generated to increase the efficiency of the
> communication.
  1. Each member of the group uses the key identifier to find the GMK used by UE 1 and extracts the Group Session Key. Further messages are sent by UE 1 to setup the one-to-many broadcast media session. These messages contain no security information.
As a result of this procedure, the members of the group will have shared a
Group Session Key (GSK) which is used to protect the media.
##### 6.3.1.3.4 Session Key Distribution for Ad-Hoc Groups
###### 6.3.1.3.4.1 General
Ad-hoc groups are designed to support edge cases that are not supported by
pre-configured groups. For ad-hoc groups, the user selects a set of users and
invites them into a group session. Unlike in clause 6.3.1.3.3, there is no
prior\ pre-arrangement of the group by a Group Manager and no GMK.
As it operates entirely independently of a group manager it allows any public-
safety UE to setup a group with any set of other public-safety UEs. This
allows group to be created dynamically. This mechanism also supports group
creation for UEs which have never had access to the network (out-of-the-box
group creation).
The solution is intended for small groups of handsets (at most 20) which wish
to dynamically setup a new group.\ It is not suitable for large groups, due to
the number of individual MIKEY-SAKKE I_MESSAGEs required.\ As it is able to
operate entirely without network connectivity, it is also well suited to
supporting public safety UEs in highly remote locations which are unlikely to
ever have access to the network.
{width="6.947916666666667in" height="2.970138888888889in"}Figure
6.3.1.3.4.1-1: Overview of ad-hoc group session key distribution
Ad-hoc groups are created by a single UE. The UE distributes the same Group
Session Key (GSK) to each user within its own MIKEY-SAKKE I_MESSAGE, though
these I_MESSAGEs may be transmitted within a single session setup request.
Figure 6.3.1.3.4.1-1 provides an overview of the security process for
distributing session keys for ad-hoc groups.
NOTE: An ad-hoc group containing two users (initiator and terminating user) is
equivalent to an IDENTITY one-to-one connection as described in RFC 6509 [12].
For an ad-hoc group to be created, no prior security association need exist
between the UEs. However, all UEs in the group are provisioned as described in
clause 6.3.1.2.
###### 6.3.1.3.4.2 Session key distribution security procedures for ad-hoc
groups (network connected)
Figure 6.3.1.3.4.2-1 describes the procedures for distributing a session key
among ad-hoc group members via the signalling network.
{width="5.5625in" height="5.416666666666667in"}
**Figure 6.3.1.3.4.2-1: Security Procedures for Session Key Distribution for\
Ad-Hoc Groups (network connected)**
The procedure in Figure 6.3.1.3.4.2-1 is now described step-by-step.
  1. Prior to beginning this procedure it is assumed that all the public safety UEs within the group have been provisioned by an IDENTITY KMS as described in clause 6.3.1.2.
  2. Prior to beginning this procedure it is assumed that the public safety UE has registered with its serving signalling server and local group server.
  3. Public safety UE 1 generates a GSK and sends a session creation notification (e.g. SIP INVITE) to the group controller, via a serving signalling server and local group server. This message contains a URI List of the group members. Within the SDP Offer of this message, UE 1 includes a set of MIKEY-SAKKE I_MESSAGEs as defined in RFC 6509 [12]. A different I_MESSAGE is included for each member of the ad-hoc group, encapsulating the GSK separately for each public safety UE. Each I_MESSSAGE encrypts the GSK to the IDENTITY UID of the UE group member and is signed using (the key associated with) UE 1\'s UID.
NOTE 1: This message may be pre-generated to increase the efficiency of the
communication.
  1. The group controller notifies UE 1 that it received the message. This message does not contain any security information.
  2. The group controller sends a session creation notification (e.g. SIP INVITE) to each public safety UE within the group. This message may list the other members of the group. For each public safety UE within the group, the message sent by the group controller contains an SDP Offer containing one MIKEY-SAKKE I_MESSAGE received from UE 1 and designated for the UID of the UE group member. The message is routed via each public safety UE\'s local group server and serving signalling server.
  3. Each member of the group extracts the GSK encapsulated by UE 1 and checks the signature on the message using keys provisioned by the KMS. The public safety UEs notify the group controller that they received the message. This message does not contain any security information.
  4. Further messages may be sent to setup the group session. These messages contain no security information.
As a result of this procedure, the members of the group will have shared a
Group Session Key (GSK).\ This is used to protect the media transmitted by
group members.
NOTE 2: Using a similar signalling flow, the initiator can add members to the
group using an appropriate message (e.g. SIP REFER) containing a MIKEY-SAKKE
I_MESSAGE for this user.
###### 6.3.1.3.4.3 Session key distribution security procedures (network
independent)
This security mechanism is part of a procedure to create a media session over
a one-to-many direct communication.
From a security perspective, this procedure follows exactly the same security
mechanism as for network-connected group communications described in clause
6.3.1.3.4.2. In this use case, the SDP Offer is broadcast by the initiating UE
and no response is expected. The SDP Offer contains a set of MIKEY-SAKKE
I_MESSAGEs protecting the Group Session Key (GSK). Following the broadcast of
the SDP Offer, the media is broadcast over the one-to-many direct link,
protected under the GSK.
Figure 6.3.1.3.4.3-1 describes the procedure. As there are no responses or
acknowledgements, this procedureproceeds on a \'best-endeavour\' basis.
{width="4.466666666666667in" height="3.6666666666666665in"}
**Figure 6.3.1.3.4.3-1: Security Procedures for Session Key Distribution for\
Ad-Hoc Groups (network independent)**
The procedure in Figure 6.3.1.3.4.3-1 is now described step-by-step.
  1. Prior to beginning this procedure it is assumed that all the public safety UEs within the group have been provisioned by an IDENTITY KMS as described in clause 6.3.1.2.
  2. Public safety UE 1 generates a GSK and broadcasts a \'media session creation message\' containing a URI list of group members and an SDP Offer. Within the SDP Offer, UE 1 includes a set of MIKEY-SAKKE I_MESSAGEs as defined in RFC 6509 [12]. A different I_MESSAGE is included for each member of the ad-hoc group, encapsulating the GSK separately for each public safety UE. Each I_MESSSAGE encrypts the GSK to the IDENTITY UID of the UE group member and is signed using (the key associated with) UE 1\'s UID.
NOTE: This message may be pre-generated to increase the efficiency of the
communication.
  1. Each member of the group extracts the GSK from the I_MESSAGE containing their identity and checks the signature on the message using keys provisioned by the KMS. Further messages may be sent by UE 1 to setup the one-to-many broadcast media session. These messages contain no security information.
As a result of this procedure, the members of the group will have shared a
Group Session Key (GSK).\ This is used to protect the media transmitted
directly as part of this session.
###### 6.3.1.3.4.4 Using ad-hoc groups to meet the \'Out-of-the-box\'
requirement
The key distribution mechanism used to setup ad-hoc groups, may also be used
to allow groups of public safety UEs to begin group calls \'out-of-the-box\',
and in particular, prior to a network connection.
To achieve this, separate security credentials are installed on each ME during
the deployment process. Each ME is pre-configured with a unique IDENTITY UID
per ME (e.g. public safety IMEI) and related private keys. This identity and
related keys are fixed within the ME and absolutely tied to the ME. The ME is
also pre-configured with a maximum key-period for ad-hoc groups.
\'Out-of-the-box\' groups can now be setup using the security procedures in
clause 6.3.1.3.4.3. A group member creates the group by listing every ME
identity (public safety IMEI) in the group, ensuring that only uncompromised
MEs are listed. A GSK is shared using these security procedures and group
communications can begin. This process operates entirely independently of the
network.
##### 6.3.1.3.5 Media Stream Protection
The following mechanism are used to protect one-to-many communications which
use the Real-Time Transport Protocol (RTP) or the RTP Control Protocol (RTCP),
cf. RFC 3550 [22].
The integrity and confidentiality protection for one-to-many communications
using RTP is achieved by using the Secure Real-Time Transport Protocol (SRTP),
RFC 3711 [23]. The integrity and confidentiality protection for one-to-many
communications using RTCP is achieved by using the Secure RTCP protocol
(SRTCP), RFC 3711 [23].
The key management mechanism for SRTP and SRTCP is described in clause
6.3.1.3.3 or 6.3.1.3.4. As a result of this mechanism, the group members will
have shared a GSK as part of the session setup procedure. The shared GSK is
used as the SRTP and SRTCP master key. This applies regardless of whether the
group members are within an ad-hoc or pre-configured group. The session may
only last for a single transmission, or may be maintained for a period to
allow many members of the group to efficiently communicate.
If late-entry to the media session is required, the transmitted SDP offer,
described in clause 6.3.1.3.3 and 6.3.1.3.4, may be periodically resent (e.g.
every 5 seconds within a SIP REFER).
### 6.3.2 Solution #3.2: Network-supported key distribution for group
communications
#### 6.3.2.1 General
This solution addresses key issue #3.2 in the present document and takes place
when the ProSe-enabled UEs are under network coverage.
#### 6.3.2.2 GBA-based key distribution for group communications
##### 6.3.2.2.1 General
This solution relies on GBA framework to generate and distribute a shared key
among members of a ProSe Group. Several GBA-based solutions models exist to
distribute the shared key.
##### 6.3.2.2.2 GBA-based key distribution for group communications with
invitation
{width="6.43125in" height="3.175in"}
Figure 6.3.2.2.2-1
**Pre-requisites**
  * The ProSe-enabled UEs, involved in the procedure to retrieve a shared key, support GBA and GBA PUSH mechanisms as specified in TS 33.220 [5] and TS 33.223 [6].
  * The ProSe-enabled UEs involved in the procedure have established NAF-key with the NAF-ProSe Key Establishment as specified in TS 33.220 [5] and TS 33.223 [6].
**Procedure**
  1. The User_GO (Group Owner) initiates the creation of a group and > sends to the NAF-ProSe Key Establishment server a request to > create a key gp_ID. The B-TID of User_GO is associated to the > request. The request is signed with User_GO NAF key shared with > the server.
Editor\'s Note: The details for signature are FFS.
  1. NAF-ProSe Key Establishment server verifies the signature and creates a key for gp_ID associated to User_GO.
  2. NAF-ProSe Key Establishment server sends to User_GO the key associated to the gp_ID thanks to GBA PUSH mechanism.
  3. The User_GO stores the key for gp_ID.
  4. The User_GO asks a User_n if he wants to join the Group (User_n was identified thanks to discovery procedure). An invitation for User_n, signed with User_GO NAF key, is joined to the request.
Editor\'s Note: It should be checked whether Man-in-the-Middle attack is
possible.
  1. User_n sends a request to join to NAF-ProSe Key Establishment server, the invitation of User_GO is included in the request. The request is signed with User_n NAF key shared with the server.
  2. NAF-ProSe Key Establishment server verifies the signatures of request and invitation
  3. After successful signature verifications, the NAF sends the key associated to the gp_ID thanks to GBA PUSH mechanism.
\- For any other user allowed to join the group, the steps 5 to 8 are
executed.
\- In case of need to refresh the key for gp_ID, the steps 9 to 11 could be
executed for all the members of the ProSe Group who share a key.
Editor\'s Note: It is FFS whether mechanism specified in 3GPP TS 33.259 could
be reused.
Editor\'s Note: It is FFS whether this solution presents some scalability
issue.
##### 6.3.2.2.3 GBA-based key distribution for group key communications with
white list
{width="6.43125in" height="4.682638888888889in"}
Figure 6.3.2.2.3-1
**Pre-requisites**
  * The ProSe-enabled UEs, involved in the procedure to retrieve a shared key, support GBA and GBA PUSH mechanisms as specified in TS 33.220 [5] and TS 33.223 [6].
  * The ProSe-enabled UEs involved in the procedure have established NAF-key with the NAF-ProSe Key Establishment as specified in TS 33.220 [5] and TS 33.223 [6].
  * Whenever there is a change about the white list, GO needs to send a refreshed white list to NAF_ProSe, so the NAF_ProSe can always keep the accurate list.
NOTE: If one UE had already got the group key before being removed, then only
after the re-keying, the removed UE will be actually banned from the group.
**Procedure**
  1. The User_GO (Group Owner) initiates the creation of a group and sends to the NAF-ProSe Key Establishment server a request to create a key gp_ID. The B-TID of User_GO is associated to the request with a white list of users allowed to join gp_ID. The request is signed with User_GO NAF key shared with the server.
Editor\'s Note: The details for signature are FFS.
  1. NAF-ProSe Key Establishment server verifies the signature, creates a key for gp_ID associated to User_GO, and stores the white list associated to gp_ID.
  2. NAF-ProSe Key Establishment server sends to User_GO the key associated to the gp_ID thanks to GBA PUSH mechanism.
  3. The User_GO stores the key associated to the group.
  4. The User_n asks the NAF-ProSe Key Establishment server to join the gp_ID and retrieve the corresponding key. The request is signed with User_n NAF key shared with the server.
Editor\'s Note: It is FFS to determine if the request needs to be signed.
  1. NAF-ProSe Key Establishment server checks the signature and that the User_n is among the white list of the gp_ID.
  2. If the verification is successful, then the NAF sends the key associated to the gp_ID thanks to GBA PUSH mechanism.
\- For any other user allowed to join the group, the steps 5 to 7 are
executed.
\- In case of need to refresh the key for gp_ID, the steps 8 to 10 could be
executed for all the members of the ProSe Group who share a key.
Editor\'s Note: It is FFS whether mechanism specified in 3GPP TS 33.259 could
be reused.
Editor\'s Note: It is FFS whether this solution presents some scalability
issue.
### 6.3.3 Solution #3.3: security for D2D communications based on overlay
#### 6.3.3.1 Introduction
Editor\'s Note: The signalling to establish security for the ProSe APP layer
and ProSe EPS layer is FFS.
Editor\'s Note: It needs to be identified which of the solutions in TR 23.703
this applies to.
The ProSe architecture shows the existence of two separate layers, the ProSe
EPS layer and the ProSe APP layer.\ The ProSe APP layer contains the ProSe APP
function in the UE, the ProSe APP server and the PC1, PC2 and PC5 reference
points. The functions of the ProSe APP server may be out of scope for 3GPP as
described in clause 4.3.3 of TR 23.703 [4]; however, the function related to
security will still be required. The ProSe EPS layer consists of the rest of
the mobile network functions required for ProSe, I.e., what is required to
provide IP connectivity between UEs and QoS guarantees for the connection.
#### 6.3.3.2 Use cases analysis
##### 6.3.3.2.1 NSPS users
When ProSe is used by, e.g., National Security and Public Safety (NSPS)
organizations, there may be different requirements on security than what is
provided by regular LTE. There may, for example, be requirements on non-3GPP
encryption algorithms or real end-to-end encryption. Real end-to-end
encryption here means that not even the operator is able to decrypt the
traffic sent between the UEs. This implies that the session keys used for
encryption cannot be based on K~ASME~ or any key derived from the UICC.
Instead, there needs to be a separate root of trust for the session keys,
controlled by the operator of the ProSe APP server. When security is applied
to the ProSe APP layer, it is unnecessary to provide confidentiality and
integrity protection for the user plane data no on the EPS layer.
Editor\'s Note: If there are EPS layer control plane functions that still
require confidentiality or integrity protection for NSPS use cases is FFS.
Assume that two NSPS UEs are in LTE coverage, communicate over the regular LTE
IP access, and that they have established a secure end-to-end connection. As
noted in the previous paragraph, this cannot always rely only on normal LTE
security. On high level, there are two alternatives for establishing the
security. Either the security protection - based on non-3GPP credentials - is
constructed as an extension to the EPS protocols (e.g., NAS, RRC and PDCP),
or, the security protection is applied on a higher layer. If the protection is
provided on a higher layer, it can be made largely independent from the normal
EPS protocols and procedures.
If an NSPS UE switches between a ProSe bearer and a normal EPS bearer during a
secure communication with another NSPS UE, a security solution relying on EPS
layer security either have establish security for the ProSe bearers and EPS
bearers every time they switch, or there needs to be some form of caching of
security context in the UEs. Both these alternatives imply a higher degree of
complexity compared to a solution based on higher layer security. A solution
based on higher layer security could, for instance, work even if there is no
security provided on the ProSe bearer; such a solution would keep its security
context on a higher layer regardless of which bearer is used.
ProSe also includes the possibility that a UE provides relay services to NSPS
UEs that are out of coverage as depicted in Figure 6.3.3.2.1-1. To enable true
end-to-end security based on credentials controlled by the NSPS organization
in this situation, the security processing has to be applied above the PDCP
layer. It could be applied on the IP layer, the transport layer or the
application layer.
{width="6.689583333333333in" height="2.692361111111111in"}
**Figure 6.3.3.2.1-1: Example where security is applied above the EPS layer**
##### 6.3.3.2.2 Conclusions
From the above, it seems that it makes sense to separate the security
requirements between the ProSe APP layer and the ProSe EPS layer. The ProSe
EPS layer should provide the same, or very similar, security functions as
normal LTE does. For users with stronger security requirements, the ProSe APP
layer can take care of these. Parts of the ProSe APP layer may be specified by
3GPP in form of enablers that will aid the ProSe APP servers and functions to
establish secure and reliable communications. Figure 6.3.3.2.2-1 below shows
several examples of the two different layers of security.
{width="5.981944444444444in" height="2.897222222222222in"}
Figure 6.3.3.2.2-1: The two layers of security in ProSe and\ their relations
in three example configurations
One option to realize the ProSe APP layer security could be to use IMS media
security as defined in TS 33.328 [16].\ If the KMS based solution is used for
key distribution, an NSPS organization can run the KMS themselves, to ensure
that they control the trust anchor for their private overlay network. The KMS
based solution described in TS 33.328 [16] does not work in offline mode. The
operator can offer IMS infrastructure, in addition to the ProSe EPS layer, as
a service the NSPS organization.
Another option is to use an IPsec or TLS VPN.
In both cases there is less work to do for 3GPP, so the ProSe work can be
completed quicker than if 3GPP have to design and specify the security for
this layer as well.
#### 6.3.3.3 Structure of the PC5 reference point
The ProSe EPS layer, at the bottom of the protocol stack, is comparable to the
LTE-Uu reference point between the UE and the eNB. This can provide similar
security functions as the LTE-Uu reference point, integrity for potential
control plane traffic and encryption for both user plane and control plane
traffic. These security functions provide sufficient protection for regular
users.
The ProSe EPS layer may, in addition to the security functions of LTE-Uu,
provide some NSPS enabler functions.\ An example of these enabler functions is
prioritization of traffic to provide NSPS UEs with better quality of service.
Even if NSPS enabler functions are added, this layer does not provide stronger
confidentiality or integrity protection functions such as end-to-end
encryption or mutual authentication between devices.
On top of the ProSe EPS layer, the ProSe APP layer provides stronger security
functions such as end-to-end encryption. The ProSe APP layer also makes it
possible to allow the trust anchor to belong to the NSPS organization, which
is likely to make ProSe more attractive to NSPS organizations.
Establishing security for the ProSe APP layer over the PC5 reference point may
require signalling over PC1, PC2 and PC3 reference points. Security may also
be established using pre-configured security parameters.
### 6.3.4 Solution #3.4: Security for one-to-many communication
#### 6.3.4.1 General
This solution addresses key issues #A2.1, #3.1 and #3.3 in the present
document. It is aimed to provide the security solution for one-to-many direct
communication solution described in clause 5.4.1, TS 23.303 [20].\ The one-to-
many direct communication solution has the following characteristics about
security:
\- Members of a group share a secret from which a group security key may be
derived to encrypt all user data for that group.
\- Authorization for one-to-many ProSe Direct Communication is configured in
the UE by the ProSe Function using PC3 reference point.
\- ProSe UE configuration parameters (e.g. including ProSe Group IP multicast
addresses, ProSe Group IDs, Group security material, radio related parameters)
are configured in the UE.
The overall procedure is as follows:
{width="6.6875in" height="3.7069444444444444in"}
Figure 6.3.4.1-1: Security procedure for one-to-many direct communication
solution
#### 6.3.4.2 Solution for configuration
From SA2 agreements, a configuration procedure is performed to provision the
security material, which is the shared group secret. From this group secret,
SA3 may develop security solution for one-to-many ProSe Direct Communication.
The security solution for configuration data transfer is specifically defined
in clause 6.1.\ Either solution defined could be used here to protect the
configuration procedure.
#### 6.3.4.3 Solution for ProSe UE direct communication
There is no signalling over PC5 control plane, so only protection for user
data should be considered. For en/de-crypting the user data, ProSe UEs of the
same group should share group ID, the group encryption key, the group key
identifier, the encryption algorithm and a validity timer, all of which are
configured to ProSe UE as group secret.
The ProSe Function directly configures the ProSe UE with the group encryption
key. This means no derivation is performed for ProSe UE, and there is no need
to synchronise parameter(s) for key derivation between ProSe UEs either. If
the valid timer of the group encryption key expires, the ProSe Function
reconfigures the updated group key to ProSe UEs.
The ProSe UEs are authenticated by the ProSe Function during the configuration
procedure. Only authenticated UEs are provided with the group secret. So the
mutual authentication between UEs could be implicit by possessing the shared
group secret. Then the ProSe UEs start communication protected by the
configured key and algorithm.
#### 6.3.4.4 Key management
When the group en/de-cryption key is configured to the ProSe UE, it should be
securely stored in the UICC or in the ME. The pre-configured key never leaves
the secure environment within the UICC or ME.
The confidentiality key used to protect the communication data are the
configured key and sent to the ProSe layer in the UE. The ProSe UE directly
uses this key and the configured encryption algorithm to protect all the user
data.
Once the confidentiality key used to protect the communication data expires or
is not secure, the ProSe Function should reconfigure ProSe UEs with new key
and algorithm.
As the basis of secure group communication is the safety of the pre-configured
key, it should be refreshed when it is expired or when it is not secure any
more. In case the pre-configured key is stored in UICC, it could be refreshed
by OTA. The configuration/reconfiguration procedure could be used to update
the group key As TS 23.303 [20] specified, OMA DM is used as the protocol to
authorize and provision the UE via PC3, OMA DM can also be used to update the
group key of ProSe UE.
If a ProSe UE intents to join the group, it should communicate with the group
manager to get authentication and authorization. In this phase the shared
group security material is configured into the ProSe UE.\ The configuration
may be performed online or manually.
### 6.3.5 Solution #3.5: Security for one-to-many security
#### 6.3.5.1 General
This solution addresses key issue #1.1, #3.1 and #3.2 in the present document
and is a security proposal for the one-to-many communication in TS 33.303
[20].
#### 6.3.5.2 Solution description
##### 6.3.5.2.1 Security keys and their lifetimes
A UE needs to have algorithm identities and a PGK (ProSe Group Key)
provisioned for each group that they belong to. From this key, a UE that
wishes to broadcast some encrypted data first generates a PTK (ProSe Traffic
Key).\ The parameters used in this generation ensure that PTKs are unique for
each UE and the parameters need to be transferred to the receiving UE in the
header of the user data packet (see below for more information).
From the PTK, a UE firstly derives the needed ProSe Encryption Key (PEK)
depending on whether the traffic is to be encrypted.
NOTE: Integrity protection could be added to this solution at a later phase if
requirements change.
The UE then protects the data to be sent with the relevant keys and
algorithms. at the bearer level (see below for more details). A receiving UE
would need to derive the PTK using the information in the bearer header and
from this the PEK used to decrypt the data.
When the PGKs are provided to the UE (either through initial provisioning or
from the ProSe Key Management Function (see subclause 6.2.6.2.3)), they are
provided with an Expiry Time. The Expiry Times of the PGK need to be set in
such that the later PGK keys have longer expire time before they expire.
When a PGK key expires in the sending UE and receiving UE, all related keys as
PTK and PEK derived from the expired PGK are deleted.
When protecting data that is to be sent, the UE uses the first of the PGKs
that has not expired to derive the PTK etc. When receiving protected data the
UE only uses a PGK that has not expired or the PGK that has most recently
expired. All other PGK should be deleted.
Editor\'s note: The validity of this key management for PS purposes needs to
be confirmed.
##### 6.3.5.2.2 Identities
The PGKs are specific to a particular group and hence have a Group Identity
associated with them. In addition each PGK associated with a group has PGK
Identity to identify it. This allows several PGKs for a group to be held
simultaneously as each can be uniquely identified. This means that the
combination of Group Identity and PGK identity uniquely identifies a PGK. The
Group Identity is the Layer 2 destination identity of the group.
Each member of a group has a unique Group Members Identity. This is used a
part of the PTK derivation to ensure each user generates unique PTKs for
protecting the data that they send. The Group Members Identity is the Layer 2
source address when the UE sends data.
The PTK identity is set to a unique value in the sending UE that has not been
previously used together with the same PGK and PGK identity in the UE.
Editor note: It\'s FFS how the PTK Identity is updated.
It is necessary for each group member to be able to ensure keystream
freshness.
NOTE: The PTK identity part is not needed to ensure freshness but does provide
a way of limiting the amount of material protected directly by a specific key
Taking all the above into account, a PTK is uniquely identified by the
combination of Group Identity, PGK Identity, Group Member Identity of the
sending UE and PTK identity.
The Counter is used under a particular PTK to ensure keystream freshness in
the same way that the PDCP Counter or NAS Counters are used in regular LTE,
I.e. each Counter value is used only once with a particular PTK.
Editor\'s note: The difference between PDCP sequence number in legacy PDCP
protocol and Counter needs to be explained.
Editor\'s note: The exact size of the above parameters requires further study
to ensure that the fit with PS needs.
If the Counter is about to wrap around in the sending UE then a new PTK
Identity is selected (which has not been previously used together with the
same PGK and PGK identity in the UE), and a new PTK key is derived from the
PGK key taking the new PTK Identity into use. A new PEK is derived from the
new PTK key as well.\ The old PTK key is deleted together with the
corresponding old PEK derived from the old PTK key.
If the receiving UE receives a PDCP packet with a new PTK Identity that has
not been previously used with the same PGK and PGK identity in the receiving
UE, then the receiving UE deletes any old PTK key kept for the same PGK and
PGK identity and also delete the corresponding old PEK derived from the old
PTK key.
Editor\'s note: Its FFS whether the sending UE at UE power off needs to store
the PTK Identities that has been used with a specific PGK and PGK Identity in
order to avoid key-stream reuse at UE power on.
##### 6.3.5.2.3 Security flows
The protection of one-to-many communication proceeds as shown in the figure
below.
Figure 6.3.5.2.3-1: One-to-many security flows
0a or 0b: If needed the UE is configured with any private keys, associated
certificates or root certificate that they may need for contacting the ProSe
Key Management Function to allow the keys to be kept secret from the operator.
If none are provided, then the USIM credentials will be used to protect that
interface.\ The [UE]{.underline} may also be pre-configured with the address
of the ProSe Key Management Function.
0c and 0d: The ProSe Function needs to be configured with which subscriptions
(either mobile subscriptions or identities in certificates) are member of
which groups.
1a or 1b: The UE fetches the one-to-many communication parameters from the
ProSe Function. As part of this procedure the UE get their Group Identity (see
TS 23.303 [20]). In addition the UE may be provided with the address of the
ProSe Key Management Function that it will use for obtaining keys for this
group.
2a.i or 2b.i: The UE sends the Key Request message to the ProSe Key Management
Function including the Group Identity of the group for which it wants to fetch
keys and UE security capabilities (including the set of security algorithms
the UE supports).
2a.ii or 2b.ii: The ProSe Key Management Function checks whether the group
security algorithms are supported by the UE according to the UE security
capabilities, I.e. whether the group security algorithms are included by the
set of security algorithms the UE supports.
2a.iii or 2b.iii: The ProSe Key Management Function responds with the Key
Response message. If the check of step 2a.ii or 2b.ii is successful, this
message contains an ordered set of key information made of ProSe Group Key
Identity, ProSe Group Key, Expiry Time, the UE\'s Group Member Identity and
the confidentiality algorithm that the UE should use when sending or receiving
protected data. Otherwise, this message contains an indicator of algorithms
support failure as the UE does not support the required algorithm.
3a or 3b: The UE calculates the PTK and PEK as necessary to protect the
traffic it will send to the group. It does this by selecting the PGK as
described in subclause 6.3.6.2.1 and uses the next unused combination of PTK
Identity and Counter. It then protects the data using the algorithm given in
step 2x.ii.
4a or 4b: A receiving UE gets the Group Identity and Group Member Identity
from the layer 2 header. It then uses the PGK Identity provided to first check
that the PGK is valid (see subclause 6.3.5.2.1) and if so calculates the PTK
and PEK as needed to process the received message.
##### 6.3.5.2.4 Protection of traffic between UE and ProSe network entities
using GBA
Between the UE and ProSe Function, for UE initiated messages, PSK TLS with GBA
based shared key-based mutual authentication is used as specified by clause
5.4 of TS33.222 [5].
The ProSe Function (NAF) requests USSs from the BSF when requesting the
Ks_(ext/int)_NAF key and the ProSe Function checks in the USS if the USIM is
authorized to be used for ProSe services. If the authorization in the ProSe
Function fails then the ProSe Function releases the PSK-TLS connection with
the UE.
For network initiated messages one of the following mechanisms is used:
\- If a PSK TLS connection has been established as a part of a pull message
and is still available, the available PSK TLS session is used.
\- Otherwise, PSK TLS with GBA push based shared key-based mutual
authentication between the UE and the ProSe Function is used. GBA push is
specified in TS 33.223 [7]. The ProSe Function (pushNAF) requests USSs from
the BSF when requesting a GPI, and the ProSe Function checks in the USS if the
USIM is authorized to be used for ProSe services. If the authorization in the
ProSe Function fails then the ProSe Function refrains from establish PSK TLS
with GBA push.
NOTE: If a TLS connection is released, it can only be re-established by the
client, I.e. UE, even though the TLS session including security association
would be alive on both sides. TLS connection, in turn, is dependent on the
underlying TCP connection.
Between the UE and ProSe Key Management Server, if the USIM credentials are to
be used then the same security procedures as above are used. If the USIM
credentials are not used, mutual certificate based authentication in TLS is
used using the private key and certificates provisioned on the UE. In both
case, a ciphersuite using non-null encryption is used.
##### 6.3.5.2.5 Protection of traffic between UEs
###### 6.3.5.2.5.1 Key derivation
When calculating a PTK from PGK, the following parameters are used to form the
input S to the KDF that is specified in Annex B of TS 33.220 [6].
\- FC = to be allocated if there is normative work here
\- P0 = Group Member Identity (I.e. the Layer 2 source address of the sending
UE)
\- L0 = length of above (which is FFS)
\- P1 = PTK Identity
\- L1 = length of above (which is FFS)
When calculating a PEK from PTK, the following parameters are used to form the
input S to the KDF that is specified in Annex B of TS 33.220 [6].
\- FC = to be allocated if there is normative work here
\- P0 = algorithm type distinguisher (similar to TS 33.401 [21])
\- L0 = length of algorithm type distinguisher (I.e. 0x00 0x01)
\- P1 = algorithm identity
\- L1 = length of algorithm identity (I.e. 0x00 0x01)
The parameters follow the encoding also specified in Annex B of TS 33.220 [6].
###### 6.3.5.2.5.2 Protection of data
The LTE ciphering algorithms (see TS 33.401 [21]) are used with the following
modifications:
Direction is always set to 0
Bearer[0] to Bearer[4] are set to zero
COUNTER is pre-pended with 0s to make it 32 bits long and it is input into
COUNT[0] to COUNT[31]
###### 6.3.5.2.5.3 Packet Format
In terms of signalling between the UEs, e.g. to indicate the correct PTK to
use, the header and payload of the PDCP packet for user plane data will need
to look similar to the below:
Figure 6.3.5.2.5.3-1: Proposed PDCP packet format for user plane data
NOTE: The Group ID and Group member ID are parameters present in the MAC
header.
### 6.3.6 Solution #3.6: Public safety security layered over network security
#### 6.3.6.1 General
This solution provides a general approach to key issue #3.1 in the present
document.
#### 6.3.6.2 Overview of solution
Public safety users may be viewed as requiring a similar service to a standard
user, but requiring additional security features. The following are
advantageous for public safety users:
\- Able to harness the functionality available to a standard user.
\- Difficult to distinguish from a standard user.
\- Protection of privacy of identifiers from a local eavesdropper.
These desirable properties imply that a public safety solution should be a
solution designed for a standard user, but with public safety security
additions built on top. Another advantage of this approach is that it prevents
public safety security requirements impacting the normal user.
At present it appears that solutions aimed at general users are being defined
at the network layer (e.g. encryption of payload within PDCP packets) whereas
public safety solutions are being defined at the session layer (e.g.
encryption of RTP packets). It is also clear that the network layer may not be
able to provide enhanced security features that the public safety user may
require, such as cryptographic authentication, due to efficiency constraints
and packet lengths. Hence this solution proposes that two security solutions
are required for ProSe under the following model:
Figure 6.3.6.2-1: Multiple security layers for Public Safety Services
While this double layered approach may seem to introduce redundancy, it is
equivalent to the approach used for media layer security, where the network
layer is encrypted to the base station and within that the session is
encrypted as SRTP.
Another way of viewing this model is that eventually the MNO may wish to treat
ProSe as a commercial service, and public safety users as an isolated user
group within that service. Whether the MNO is simply providing access to the
transport network/spectrum, or the managing entire service, the MNO stays in
control of the use of ProSe at the network layer. At the same time, the burden
on the MNO is reduced. Network layer configuration to support public safety
users will be minimal, with intelligent group management occurring at the
(entirely software-based) session layer.
Figure 6.3.6.2-2 describes this approach to ProSe security. The MNO manages
access to the public safety services via network layer security, the service
provider manages dynamic subgroups via session layer security.
Figure 6.3.6.2-2: Group separation over two layers
As part of this approach, it is essential to define the security processes at
both the network layer, and the session layer. Only with both components
defined will it be possible to setup secure group communications between UEs,
as required by SA1.
#### 6.3.6.3 General Security Procedures
This clause describes general procedures to setup and use a public safety one-
to-many communication.
##### 6.3.6.3.1 Network Operator Setup Procedures
The network operator is responsible for controlling which UEs are allowed
access to public safety services.\ Upon request by the service provider, the
network operator may enable public safety ProSe services (among other
additional features). As part of the process of enabling the service, the MNO
will add the user to the \'public safety group\' and provision keying material
appropriately to allow the user to decrypt traffic at the network layer.
NOTE: At the same time, the MNO may similarly allow discovery of public safety
users.
At this point, the user can now view sessions (including identities) created
at the session layer but will not be able to read traffic at that layer.
##### 6.3.6.3.2 Service Provider Setup Procedures
Once a user has been allowed access to the public safety services by the MNO,
the service provider (which may also be the MNO) can configure the public
safety groups which the user can access and keying material associated with
those groups. This configuration may be more dynamic than that used at the
network layer.
##### 6.3.6.3.3 One-to-many Communications
Once configured, one-to-many communications are secured with all traffic
encrypted at the network layer (using a generally-applicable network-layer
security solution) and RTP traffic encrypted at the session layer (using a
security solution for public safety users).
### 6.3.7 Solution #3.7: Security for One-to-many ProSe Direct Communication
#### 6.3.7.1 General
This solution addresses key issues on one-to-many in the present document and
protects reference point PC5 in TS 23.303 [20].
#### 6.3.7.2 Authentication for One-to-many ProSe Direct Communication
The ProSe enabled UEs for One-to-many communication should be authenticated to
get the Group ID and Group Key. After the UEs for One-to-many ProSe Direct
communication are authenticated and registered ProSe Function, UEs can get
Prose Group Key. For public safety UE, UE sends the value to HSS to get
verification for public safety.\ After provisioning or verification, public
safety UE can perform Prose One-to-many Prose Direct Communication.\ To
authenticate each other for ProSe Group members, mutual authentication should
be used.
Figure 6.3.7.2-1: Overview of security for one-to-many ProSe direct
communication
#### 6.3.7.3 Key generation for One-to-many ProSe Direct Communication
After the UE is authenticated and registered ProSe Function, UE can receive
the group join request or broadcast message for Prose Group communication. The
Group Key is generated or provisioned in HSS as subscription data, and it can
be registered to ProSe function.
### 6.3.8 Conclusion on one-to-many security
#### 6.3.8.1 Summary of ProSe one-to-many communication solutions
Clause 6.3 contains four solutions which aim to meet the requirement for ProSe
one-to-many communications; solution #3.1, #3.4, #3.5 and #3.7.\ Solutions
#3.3 and #3.6 are relevant but describe a generic approach rather than a full
solution.\ Solution #3.2 provides solutions for group owner mode and hence
these cannot be directly compared as they apply to a different ProSe
architecture.\ Table 6.3.8.1-1 summarizes the features of the four solutions.
Table 6.3.8.1-1: Summary of solutions for ProSe one-to-many communications
* * *
                                                  Solution \#3.1                                                                                       Solution \#3.4                                                                              Solution \#3.5                                                                                                                               Solution \#3.7
**Configuration requirements** IDENTITY user key configuration by KMS. The
encryption key, the encryption algorithm and group ID are configured to the
ProSe UE. Group identities and group key IDs. Potentially also the address and
certificates (or keys) for connecting to the key management function. ProSe UE
should be authenticated. **Group Key Distribution process** Group key sent
inside a Group Notification message. As part of configuration process (clause
6.1) Direct connection to key management function delivering a key response
The Group Key is generated or provisioned in HSS as subscription data.
**Confidentiality of Group Key Distribution** Group Key encrypted to UserID.
As part of configuration process (clause 6.1) TLS-PSK connection to group
manager keyed by GBA or shared certificates - **Authentication of Group Key
Distribution** Group Key is signed by Group UserID. As part of configuration
process (clause 6.1) Either GBA or shared certificates provide authentication
of tunnel. - **Group Key Update/ Revoke mechanism** Repeat group key
distribution process. Revocation implicit as latest group key is used. Rekeyed
over OTA or OMA DM. Uses existing connection or GBA push mechanism. Keys have
lifetime and expire. - **Generation of traffic encryption keys** Generation
process is performed by UE, but process is undefined. Not required. Traffic
key appears to be the Group key. Generated directly from group key using KDF,
traffic key ID and algorithm ID. - **Group key storage** Inside secure storage
(ME or USIM). Inside secure storage (ME or USIM). - - **Traffic Key
distribution** Distributed during setup and protected by group key. No traffic
key distribution. Traffic key appears to be the Group key. No traffic key
distribution required. Traffic key ID sent in PDCP packet header. -
**Encryption algorithms** SRTP algorithms. Defined as part of configuration
process (clause 6.1) LTE ciphering algorithms. - **Replay protection**
Provided by SRTP. PDCP count by default. - - **Layer at which encryption is
applied** SRTP (over UDP/IP) PDCP or application layer PDCP - **Data
encrypted** All RTP data routed over ProSe. May also be applied to other use
cases. User data All data routed over ProSe link. - **Initiating UE
Authentication** Setup may be signed by initiator No authentication due to
lack of integrity protection. No authentication due to lack of integrity
protection. Mutual authentication should be used **Privacy of user
information.** User IDs available. These may be anonymized (e.g. \'User1234\')
where greater privacy is required. User data encrypted. Share group ID and
group key identifier. Group ID and Group member ID are parameters present in
the MAC header. Group key ID and traffic key ID in PDCP header. -
* * *
#### 6.3.8.2 Evaluation against requirements
Clause 6.3 contains four solutions which aim to meet the requirement for ProSe
one-to-many communications (decentralized-mode). These are Solution #3.1,
#3.4, #3.5 and #3.7. Solutions #3.3 and #3.6 are relevant but describe a
generic approach rather than a full solution. Solution #3.2 provides solutions
for group owner mode and hence these cannot be directly compared as they apply
to a different ProSe architecture.
Clause 5.3 lists requirements on these solutions resulting from key issues.
This clause evaluates the solutions against the requirements.
At this time, Solution #3.7 does not contain sufficient detail to evaluate it
against the requirements and hence has not been included in the table.
**Table 6.3.8.2-1: Evaluation of solutions against requirements**
* * *
                                                                               Solution \#3.1                                           Solution \#3.4                                   Solution \#3.5
Necessary keying material provided without UE-to-UE interaction Yes, provided
within Group Notification Yes, provided as part of configuration process Yes,
provided over TLS-PSK connection Confidentiality provided both in and out of
coverage. Yes, via SRTP No detail on encryption of user data. Yes, via PDCP
encryption Security mechanism is scalable Yes, centrally keyed Yes, centrally
keyed Yes, centrally keyed Allows rapid setup of group communications Yes No
detail on encryption of user data. Yes, once group has been keyed Keys shall
be integrity and confidentiality protected during transmission. Yes, integrity
protection provided via MIKEY signature Dependent on configuration solution
Yes, inside TLS-PSK tunnel. Only authorized UEs shall receive keys Yes, keys
encrypted to authorized user identity. Dependant on configuration solution
Yes, only authorized UEs can establish TLS-PSK tunnel. Key distribution entity
shall be authenticated Yes, via MIKEY signature on key Dependant on
configuration solution Yes, via authentication of TLS-PSK tunnel. Keys can be
stored for past and future cryptoperiods Yes Yes Yes Late entry shall be
supported. Yes, though not explicitly described. No detail on encryption of
user data. Yes, though not explicitly described. Key shall be securely stored
in UE. Yes Yes Yes, but not explicitly described. Key should not be used when
required (revoked) or its lifetime expires. Keys can be revoked / updated and
have a cryptoperiod. May be revoked via OTA or OMA DM, Keys have a
cryptoperiod. Revocation mechanism not explicitly described.
* * *
Table 6.3.8.2-1 demonstrates that solution #3.1 and #3.5 are able to meet the
requirements placed upon the solutions.\ At the present time there is not
sufficient detail to establish if solution #3.4 or solution #3.7 will meet the
requirements.
The following are advantages of solution #3.1:
\- Flexible group management. Group information need not be configured as part
of operator configuration.\ Group keyed/revoked via single message per user.
Allows for asynchronous keying of group members.
\- Enhanced security such as caller authentication during initiation of
connection and group key revocation.
\- Solution provides group RTP encryption and hence may be applicable to a
wide variety of public safety use cases.
\- More closely related to media security mechanisms.
The following are advantages of solution #3.5:
\- Encrypts entire packet sent by UE and hence able to control access to all
ProSe communication resources.
\- More closely related to LTE air-interface security mechanisms.
Solution #3.1 and #3.5 are very different, independent approaches to meeting
the requirement which operate at different layers. As discussed in Solution
#3.6, if run in tandem the advantages for both solutions could be realised at
the same time and, in addition, there is the further advantage that the
granularity of group management could differ for each solution. For example,
Solution #3.5 could manage access security to ProSe communications, meaning
that the group in this case will be the entire user group, whereas Solution
#3.1 could manage the day-to-day, fine-grained manipulation of public safety
groups.
#### 6.3.8.3 Conclusion to evaluation of one-to-many communication solutions
At this stage, Solution #3.1 and #3.5 are the only two fully formed solutions
for one-to-many communications.\ These two solutions both meet all the
requirements listed in the key issues. In direct comparison, Solution #3.5 has
the advantage that it encrypts the entire packet, and hence can provide access
control to all ProSe communication features, whereas Solution #3.1 has the
advantage of enhanced security, flexible group management and, potentially,
wider applicability. Both solutions are entirely independent and can operate
concurrently.
As discussed in Solutions #3.3 and #3.6 of clause 6.3 of the TR, there are
advantages to layering security solutions for public safety users to better
meet these user\'s enhanced security requirements. In mirroring the approach
to media security (where SRTP is layered over LTE network security) layering
SRTP over a PDCP security will enhance security, maintain control with the
MNO, while allowing the public safety users the flexibility to manage their
own groups.
In conclusion, these are complementary solutions which meet the user\'s
requirements and provide additional benefits when used concurrently. Hence
both should be specified in the ProSe TS 33.303 [20], Solution #3.1 providing
media plane security and Solution #3.5 providing network layer security.
### 6.4 Solutions for other areas
### 6.4.1 Solution #4.1: ProSe accounting
#### 6.4.1.1 UICC based ProSe Accounting
In order to confirm sufficient level of trust, UICC should impose accounting
limits for ProSe communication.\ Involving UICC allows the operators to
control and also collect the data on the amount of authorized
transmission/receptions. By linking security mechanism with charging
functions, an acceptable level of trust is achieved for ProSe accounting.
Potential mechanism would be to allow the UICC to perform accounting based on
the number of security keys issued to the device or the time allowed for ProSe
direct communication.
The ProSe accounting related parameters are included and configured in the
UICC by the ProSe Function using PC3 reference point, along with the
provisioning parameters for ProSe Direct Communication (TS 23.303 [20]).\ The
UICC that has been configured for ProSe have the accounting capabilities and
may be provisioned with a credit limit based on network policy and/or
subscription (prepaid or post-paid). The credit limit and accounting
information are based on the number of keys to be provided (which is related
to number of messages received/transmitted) by the UICC to the device for
ProSe Direct Communication.
Linking of security mechanism with charging function is achieved by making the
ME to obtain parameters needed for its security context (Group Session Key)
from the UICC always, so that the ME performs communicates with other UEs
securely. Eventually when exhausting the security context after particular
volume of data transmission, the ME needs to obtain fresh session key in order
to further communicate with other UEs, when requested for new key by the ME,
the UICC will account the number of keys issued to the ME and provides the new
session key. By doing so, the UICC can collect the information on the number
of keys received by the ME over a period of time and/or control the number of
key to be issues based on the preconfigured credit limit. The operator
retrieves the accounting information from the UICC directly which operator can
trust the information for generation of the Charging Data Records (CRDs).
Optionally the operator may also authorize some maximum amount of key to be
retried (e.g. prepaid) in the UICC, to control the credit limits.
Most of the solution in the present document for ProSe Direct communication
uses group pre-shared key provisioned by the network and securely storage in
the UICC and group session key is derived from the group pre-shared key to
protect the group communication data traffic. Since the UICC provides the
session key for limited volume of data, the UICC can account the volume of
data based on the number of keys issued and report the accounting data to the
network to generate CRD for the UE. Below clauses details the two possible
charging mechanisms namely volume based charging and time based charging for
the ProSe direct communication involving the UICC.
Editor Notes: Integrity of the volume parameter and time parameter received
from ME should be ensured.
##### 6.4.1.1.1 Volume based charging
Figure 6.4.1.1.1-1: UICC based ProSe Accounting
Figure 6.4.1.1.1-1 below details the flow for volume based charging aspects
for Prose direct communication (one-to-many communications).
  1. Service authorization for ProSe direct services is performed for ProSe Direct Communication and UE is configured with the related information for one-to-many ProSe Direct Communication.\ The UE obtains the necessary group context including the ProSe accounting information.\ The accounting information may include the credit limit Volume~Threshold~.
  2. The provisioning of accounting parameters for ProSe Direct Communication may be configured in the UICC.
  3. The originating UE finds the appropriate radio resource to conduct one-to-many ProSe Direct Communication.
  4. Most of the solution in the present document for ProSe Direct communication uses group pre-shared key provisioned by the network and securely stored in the UICC and group session key is derived from the group pre-shared key to protect the data traffic. Since the UICC provides the session key for limited volume of data, the UICC can account the volume of data based on the number of keys issued. The group session key is derived from the group pre-shared key as follows:
> K~Group-ProSe-Session~ = KDF {K~Group-Pre-shared~, UE-a ID,
> Volume~Threshold-UE-a~}
\- K~Group-ProSe-Session~ : Key used to protect the group data. This key is
valid only till the data transfer reaches the threshold value
(Volume~Threshold~UE-x)
\- K~Group-Pre-shared~ : Provisioned by the network as part of group
information.
\- UE-a ID : Identity of the originating Prose device
\- Volume~Threshold~UE-a : Provide by UICC based on the permitted Volume
threshold value. Volume~ThresholdUE-a~ value will be less than or equal to
Permitted Threshold value. UICC decides on the splitting of permitted
threshold values as to refresh session key, so that session key will not be
used for long time. Volume~Threshold-UE-a~ value may not be the permitted
value (pre-paid capacity), it can be random within the total credit limit. The
UICC will not provide new Volume~Threshold-UE-a~ and the session key (charging
key), if the Volume~Threshold-UE-a~ reached the permitted threshold value.\
Since the permitted Threshold value is not known to the device and
Volume~Threshold~ is required to refresh the session key, complete control on
the charging can be achieved by the security mechanism. Since
Volume~Threshold~ is used for key derivation, any tampering or faking by the
originating ME will lead to wrong key generation in the other UEs.
  1. ProSe Direct communication confidentiality is performed as shown below in the figure. Volume~COUNT~ and Volume~Threshold~ are used to ensure and enforce, that the other party in communication expects new fresh key once the Volume~COUNT~ reaches the Volume~Threshold~. For every key establishment (including Key refresh), the Volume~COUNT~ value is initialized to \"0\" and increment for every packet. Alternatively, the Volume~COUNT~ will be increment based on the application data size. The Volume~COUNT~ value is carried along with the message. Volume~COUNT~ can be PDCP COUNT, if ProSe uses the PDCP layer. Since the permitted Threshold value is not known to the device and it is required to refresh the session key for every intermediate Volume~Threshold~, device always depends on the threshold value and the session key.
{width="6.105555555555555in" height="3.3048611111111112in"}
Figure 6.6.1.1.1-2 : Ciphering of ProSe direct communication data
  1. When the ME performs communicates with other UEs, eventually exhausts the security context after particular volume of data transmission. Then the ME needs to obtain fresh session key in order to further communicate with other UEs, when requested by the ME for new key, the UICC will account the number of keys issued to the ME. By doing so, the UICC can collect the information on the number of keys received by the ME and/or control the number of key to be issues based on the credit limit. The MEs when requesting for new key or when closing the group communication, provide the key usage details (volume count details) to the UICC, to make note of it for accounting.
  2. The originating UE then provides the new Volume~Threshold~ to others UEs to refresh the key K~Group-ProSe-Session~
  3. Other UEs in the group request the respective UICC to provide refreshed keys by providing the originating UE-ID and the Volume~Threshold~ value. The UICC provides new key and updates it in the accounting information.
  4. Data Transfer resumes with new session key protection (increments Count value for each packet transfer).
  5. and 11. UEs reports the accounting details (number of key issued to ME, IDs of the other ProSe UEs, Time information, volume of data transmitted/received (in terms of Volume~Thresholds~)) to the ProSe Function securely through management protocols, periodically or when UE establish communication with the network.\ The accounting detail contains its information and also other UEs information it communicates with.\ For Public Safety UEs in \"out of network coverage\" cases, the ProSe session accounting data is reported to the network, when the UEs go back into coverage (offline accounting). Therefore, delayed reporting of the ProSe session accounting data is possible.
```{=html}
``` 12\. The ProSe function consolidates the report received from different
UEs and prepares the CRDs.\ A fraudulent use of keys could be detected by
means of discrepancies (more data was received from a UE than it claims to
have sent) among the reports from the listening UEs.
Editor\'s Note: Complete mechanism to be developed in alignment with the
direct communication security mechanism and charging architecture.
Editor\'s Note: If the group context, ProSe configuration and related
credentials are stored in the secure environment of the ME, then the secure
environment performs the ProSe accounting mechanism detailed in this clause.
##### 6.4.1.1.2 Time based charging
The ProSe Function provisioning the configuration data provides Prose
configuration with its lifetime (how long it is valid) for prepaid scenario.
The ProSe configuration along with its lifetime is stored in the UICC and then
provided to the device, based on request from the device. Once the validity
time is expired, the UICC and device deletes the configuration. Based on the
authorized subscription and credits/credentials available for the particular
subscriber, the network renews the ProSe configuration in the UICC. Before the
lifetime expires, either the network provides configuration along with new
validity time or alternatively, the device contacts the network to obtain
validity time extensions. This allows an operator to define a limited use
policy for the UE.
In case of post-paid scenario, the UICC may also include the \"TIMER
MANAGEMENT\" proactive command along with the ProSe direct communication
configuration (c.f. ETSI TS 102 223 [31]) to the device, so that the device
replies back for the proactive command, the time period the configuration was
used, for the UICC to performing accounting.\ Then the network obtains the
accounting information from the UICC and creates CRD for the UE.
# 7 Key Issues for Rel-13
## 7.1 Key Issues on ProSe Relays
### 7.1.1 Key Issue #7.1.1: Maintain 3GPP communication security through relay
#### 7.1.1.1 Issue Detail
Based on SA1\'s requirement, the ProSe system ensures the confidentiality of
user data and network signalling to a level comparable with that provided by
the existing 3GPP system. This equally applies to communications over a UE-to-
UE relay or UE-to-network relay. In a normal communication the relay will not
be able to access the security context between a pair of UEs or between the UE
and network. Hence, for relay communications, the relay should not be able to
access the content of the communications it is relaying.
#### 7.1.1.2 Security Threats
Should the relay be able to access communications, the relay becomes a user-
controlled entity with direct access to another user\'s communications. This
may enable a number of attacks including:
1\. Impersonation of a relayed user or network (injection of user-plane data)
2\. Evesdropping of the user\'s communication
3\. Replaying user/network communications
4\. Offering a relay service while preventing some/all packets from transiting
the relay.
5\. Using the relay service to unnecessarily undermine the privacy of the
user.
Such attacks may be performed by a malicious relay, or by a malicious entity
impersonating a relay. Therefore, the SA1 requirements can be fulfilled only
when the relay is excluded from the UE-to-UE or UE-to-network security
context.
#### 7.1.1.3 Potential security requirements
The security of ProSe communications should not be adversely impacted when a
relay is used.
A mechanism should be available to prevent impersonation by the relay of other
user\'s communications/signalling.
A mechanism should be available to prevent the relay from reading the
communications.
A mechanism should be available to prevent the relay from modifying/replaying
the communication.
A mechanism should be available to enable the UE to authenticate that the
relay is offering a legitimate service.
### 7.1.2 Key Issue #7.1.2: ProSe UE-Network Relays Connection
#### 7.1.2.1 Issue Detail
As described in TR 23.713[32], UE-to-Network Relay function supports both
unicast relaying and eMBMS relay for Remote UEs that are not served by
E-UTRAN. Both Model A (UE-Network Relay announces \"I am here\" or \"service X
available\") and Model B (\"who/which service is there?\" / \"are you
there?\") are supported for UE-to-Network Relay discovery.
#### 7.1.2.2 Security Threats
The Remote UE is out of network coverage, if it does not have proper
information of the UE-to-Network Relay, the Remote UE may select and connect
to a fraudulent UE-to-Network Relay. In the same way, UE-to-Network Relay may
provide relaying function to a Remote UE which is not authorized for it, that
may lead attack to the core network.
The Remote UE and UE-to-Network Relay will perform direct discovery and direct
communication over the PC5 interface. An attacker may intercept and/or modify
the traffic or data packets exchanged between the Remote UE and UE-to-Network
Relay. This can cause MitM attack and also the data exposure to the attacker.
#### 7.1.2.3 Potential security requirements
The system should support mutual authentication between Remote UE and UE-to-
Network Relay.
Editor\'s Note: it is FFS that whether mutual authentication between UE and
UE-to-Network Relay is needed.
Both Remote UE and UE-to-Network Relay shall be authorised.
The messages for relay discovery request and response should be protected.
Editor\'s Note: the type of the protection is for FFS.
The system should provide protection to against replay attack over PC5.
### 7.1.3 Key Issue #7.1.3: Key Issues for UE-to-Network Relays
#### 7.1.3.1 Key issue details
{width="6.3375in" height="1.7347222222222223in"}
Figure 7.1.3.1-1: ProSe UE-to-Network Relay
A remote ProSe-enabled public safety UE communicates with UE-to-Network relay
via PC5 interface when the remote UE is out of network coverage. When the
ProSe-enabled UE acts as the relay, it needs to establish secure connection
with the network via Uu interface.
For example the following aspects should be considered:
\- Security credential used in the UE-to-Network relay for establishing secure
connection with the eNB
\- Whether the UE-to-Network relay need to communicate with the OAM
\- The security protocol between the UE-to-Network relay and eNB
\- Key exchange and agreement between UE-to-Network relay and eNB
Editor\'s Note: Whether the above issues apply depends on SA2 clarification of
the capabilities and functionalities of the UE-to-Network relay.
### 7.1.4 Key Issue #7.1.4: UE-to-UE Relay
#### 7.1.4.1 Issue detail
SA2 has defined the UE-to-UE relay discovery in model A and model B
irrespective of whether the public safety UEs are in coverage of network or
out of coverage of network. For both models, the UE-to-UE relay and remote UEs
firstly need to make group member discovery such as to discover each other,
then if UE1 (announcer or discoverer) finds UE-to-UE relay can relay the data
to UE2(monitor or discoveree), it decides to establish a one-to-one link with
UE-R and engage in communication with UE-2 via UE-R.
#### 7.1.4.2 Threats
There are some threats related to UE-to-UE relay discovery. The aim of the UE-
to-UE-relay procedures is to connect the UE1 and UE2 together via the UE-to-UE
relay.
As the discovery and connection signalling between UE1 and UE2 is not a direct
discovery but relies on the UE-to-UE Relay. If remote UEs do not have proper
information of the UE-to-UE Relay, the Remote UEs may select and connect to a
fraudulent UE-to-UE Relay. Vice versa, UE-to-UE Relay may provide relaying
function to a Remote UE which is not authorized for it.
Also the announcer/discoverer UE may discover and connect (both happening via
the UE-to-UE relay) to a fake monitor/discoveree UE, and the
monitor/discoveree UE may discover and connect (both happening via the UE-to-
UE relay) to a fake announcer/discover UE. This may be caused by an attacker
modifying or replaying the UE-to-UE relay discovery signalling.
#### 7.1.4.3 Potential security requirements
The system should support following security requirements:
\- Replay and impersonation of UE-to-UE Relay discovery message shall be
prevented.
\- The system shall prevent the UE1 being connected via the UE-to-UE Relay to
the wrong UE2.
\- Remote UEs and UE-to-UE Relay should be mutual authenticated and
authorized.
\- The requirements on the one-to-one communication from Key Issue #7.2.2
apply to the communication between the remote UEs and the UE-to-UE Relay.
## 7.2 Key Issues on One-to-one Communications
### 7.2.1 Key Issue #7.2.1: Security analysis for ProSe communication
#### 7.2.1.1 Issue Detail
Based on SA1\'s requirement, the system ensures the confidentiality of user
data and network signalling over the direct link to a level comparable with
that provided by the existing 3GPP system. Now the security context is
separate for different UE in existing 3GPP system. So it requires that the
separate security context usage in ProSe system.
#### 7.2.1.2 Security Threats
When the user plane ciphering is applied, a security issue would be raised
that a ProSe-enabled UE can decrypt the communication between two other ProSe-
enabled UEs if the same security contexts are used. The attack details are
shown in the following scenario.
There are three ProSe-enabled UEs, e.g. Mary\'s UE, Peter\'s UE, John\'s UE.
When Mary, Peter, and John are communicating through the 3GPP network, there
is no common security context between them. Peter\'s UE cannot get any plain
information between Mary\'s UE and John\'s UE. If the security context for the
communication between Mary\'s UE and Peter\'s UE was the same as for Mary\'s
UE and John\'s UE, Peter\'s UE would be able to decipher the communication
between Mary\'s UE and John\'s UE when the encrypted data is eavesdropped by
Peter\'s UE. Peter\'s UE could get the information between Mary\'s and John\'s
UE.
But in existing 3GPP, Peter\'s UE ca not get the information between Mary\'s
and John\'s UE, specifically, when Mary\'s UE communicates with Peter\'s and
John\'s UE in LTE network. Based on LTE security architecture, Peter\'s UE and
John\'s UE will use different security context to protect the communication
with eNBs, and eNB will forward the decrypted UP data to core network and
finally send to Mary\'s UE with the protection by using other security context
between Mary\'s UE and eNB. So in this case, it does not follow SA1\'s
requirement. Therefore, the SA1 requirements can be fulfilled only when
Mary\'s UE use separate contexts communicating with different UEs.
#### 7.2.1.3 Potential security requirements
A ProSe-enabled UE should use different security contexts for ProSe one-to-one
communication with different ProSe-enabled UEs.
### 7.2.2 Key Issue #7.2.2: One-to-One Direct Communications using E-UTRA
#### 7.2.2.1 Key issue details
A key capability of ProSe-enabled UEs is to engage in one-to-one
communications with another UE directly over the air interface.
#### 7.2.2.2 Security threats
There are the following threats to the data as it is exchanged between the
UEs;
> A passive attacker may intercept the data packets exchanged by the two UEs
> and is able to obtain their true/original content.
>
> An active attacker may modify the data packets exchanged by the two UEs
> without detection by either UE.
#### 7.2.2.3 Potential security requirements
Direct link signalling ciphering may be provided. Direct link signalling
ciphering is a configuration option.
Direct link user plane ciphering may be provided.
Direct link signalling integrity protection and replay protection shall be
provided.
Direct link user plane packets between UEs shall not be integrity protected.
Establishment of the security between the UEs shall be protected from man-in-
the-middle attacks.
Editor\'s note: Whether there is a split between user plane and signalling is
FFS
### 7.2.3 Key Issue #7.2.3: Mutual authentication of ProSe enabled devices for
public safety in out of coverage scenario
#### 7.2.3.1 Key issue details
In network coverage scenarios UEs are mutually authenticated to the network.
Currently UE to UE authentication is not standardized. Mutual authentication
of public safety UEs without network coverage cannot be performed with AKA.
Authentication credentials have to be securely stored in the UE in order to be
available in the UE even without network coverage. It is beneficial to use an
authentication method that is suitable to generate and distribute session keys
for a secure direct link in order to provide confidentiality and integrity
protection for the communication after the authentication procedure succeeded.
Depending on the sensitiveness of the credentials secure storage e.g. in the
UICC could be required. Also for maintenance it could be beneficial to store
the configuration data inclusive credentials on a removable UICC.
> Editor\'s Note: The scenario when the configuration data is provided by a
> provisioning server controlled by a different entity than the 3GPP operator,
> needs to be considered as well. For example, the credentials may need to be
> managed by an NSPS organization, and storage of the configuration data in
> the UE needs to be considered also in this scenario.
#### 7.2.3.2 Security threats
Device theft is a security threat; especially if there is an extensive effort
needed to exclude a single device. This was the case if e.g. the same pre-
shared secret for multiple devices is used. Such an authentication mechanism
is not scalable. If one device is compromised all communication of other
devices with the same shared secret is compromised with it. Since entropy from
network initiated challenge response procedure is not available sufficient
entropy is needed for session key generation. Session keys ca not be
distributed via network.
#### 7.2.3.3 Potential security requirements
The system should support mutual authentication of public safety UEs out of
network coverage.
Compromise of a single UE should not affect the security of the others.
Authentication credentials should be securely stored in UE.
It should be possible to establish session keys securely between the UEs.
### 7.2.4 Key Issue #7.2.4: One-to-one ProSe Direct Communication
#### 7.2.4.1 General Description
ProSe direct communication between two UEs is realized over the PC5 interface,
with or without the help of a UE-Network relay or UE-UE relay to set up the
direct communication path. The UEs need to be authenticated and need to
establish secure communication between them when one or both UEs is (are) out
of E-UTRAN coverage.
#### 7.2.4.2 Security threats
If the relay node generates the key for secure communication between the UEs,
a misbehaving relay would be able to eavesdrop and/or modify the communication
data between the UEs.
For a session that is reasonably long, if the session keys are not updated,
there could be keystream reuse and attacker can take advantage to try to
recover the communication data.
#### 7.2.4.3 Potential security requirements
UEs engaged in one-to-one communication should be mutually authenticated.
Communication between UEs engaged in one-to-one communication should be
confidentiality and integrity protected
UEs should support key update or key refresh to avoid keystream reuse.
## 7.3 Key Issues on Direct Discovery
### 7.3.1 Key Issue #7.3.1: Restricted ProSe Direct Discovery (Model A and B)
#### 7.3.1.1 Key issue details
SA2 describe how restricted direct discovery will work in TR 23.713[32] for
both model A and model B. This work builds on top of the open discovery flows
from Rel-12. In Open discovery, there is no explicit permission that is needed
from the UE being discovered, while in restricted discovery, explicit
permission from the UE that is being discovered is required. Model A consists
of a monitoring UE discovering an announcing UE by listening for discovery
messages containing the correct ProSe Code. The Model B discovery allows the
direct exchange of ProSe Query Code and ProSe Response Code between Discoverer
UE and Discoveree UE, without requiring signalling to the network in between.
The solution in clause 5.3 of TR 23.713 [32] supports Restricted Discovery
with application-controlled extension. In the solution, the ProSe Code
contains two parts:
ProSe Code Prefix: In Discovery with application-controlled extension, a part
of the ProSe Code that is assigned by the ProSe Function.
ProSe Code Suffix: In Discovery with application-controlled extension, a part
of the ProSe Code that is under the control of the announcing application. The
ProSe Code Suffix represents application specific information pertaining to
the application that is indicated in the Restricted ProSe App User ID.
#### 7.3.1.2 Security threats
In direct discovery, a ProSe-enabled UE broadcasts an identity that can be
received by other Pro-enabled UEs that are in proximity. The receiving UE can
analyse received identities in order to decide if any UEs of interest to
discover are in its proximity.
As noted above there are two types of discovery, open and restricted. With
open discovery, there is no requirement for the one UE to be authorized to
discover the other UE. This means that the identity that is broadcast for this
type of discovery is assumed to be knowable to all UEs (this is true whether
the actual identity is broadcast or some well known mapping of the identity is
broadcast).
With restricted discovery, a UE needs to be authorized to be able to discover
a particular UE. In particular the broadcast identities should prevent the
discovery of a UE without their explicit permission. This threat also extends
to the ability to track such a broadcasting UE even if it is not known who the
UE belongs to based on the broadcast identity. Clearly anyone with the
permission to discover the UE would be able to track them, as this is
effectively part of the permission to discover the UE.
Similar threats as in the above paragraph also apply to the restricted
discovery messages sent over the air by the discoverer UE, as in the case that
the ProSe Query Code is expected to be responded to by a relatively small set
of UEs, then a response to such a discovery messages could lead to information
being leaked about a responding user.
Another security threat is that of unauthorized announcements (e.g.,
impersonation and replay threats). This may cause a receiver to believe that
the other UE is in proximity when it currently is not, and hence take whatever
action discovering that UE would involve. This threat also applies to the
initial discovery message sent by the discoverer UE in model B discovery. In
this latter case, there is no value providing individual keys to discoverer
UEs to protect this message, as it only requires one of this key compromised
to be able to force the discoveree UE to send its broadcast. Furthermore the
use of a Match Report will not provide any additional protection for the ProSe
Query Code against compromised Discoverer UEs and in fact causes more
resources to be used as the Discoveree UE needs to contact the network.
Similarly a compromised Discoveree UE would enable an attacker to form a
correct ProSe Query Code. Using Match Reports to try to protect against this
would use more resources than just responding with a ProSe Response Code that
would not be understood by non-Discoverer UE at any rate. A UE that is neither
a Discoverer nor a Discoveree UE should not have the information to form a
message that the attacked Discoveree UE believes contains its ProSe Query
Code. In summary, there is no value in the Discoveree UE sending Match Reports
containing ProSe Query Codes.
An attacker could eavesdrop on the application-controlled extensions part of
the ProSe Code while it is transmitted over the air. Similarly such data could
be modified by a man-in-the-middle.
An attacker could start announcing random numbers to the PC5 interface in
order to make the processing of the protected messages exhaustive to the
receiving UE if the amount of processing required from the receiving UE is not
kept reasonable.
#### 7.3.1.3 Potential security requirements
ProSe Restricted discovery shall allow a UE to discover only other UEs which
it is currently authorized to discover. That is, the identities announced on
the air interface shall be able to be protected from being understood by
currently unauthorized UEs.
The possibility of tracking of UEs based on the content of their discovery
messages over time should be minimized.
The system shall support the prevention of impersonation attacks.
The possibility of replay attacks on discovery messages sent over the air
interface should be minimized.
The system should support integrity protection and confidentiality protection
of Restricted Discovery ProSe Codes.
NOTE 1: Any structure present in the ProSe Code before any security processing
should be preserved to enable checking for matches. Preserving the structure
needs to be done in a way that does not affect the security.
The confidentiality protection solution for Restricted Discovery ProSe Codes
should keep the amount of processing reasonable for the receiving UE.
NOTE 2: These requirements apply to both model A and model B restricted
discovery.
### 7.3.2 Key Issue #7.3.2: Security - PC2 interface in Restricted ProSe
Direct Discovery
#### 7.3.2.1 Key issue details
SA2 describe how restricted direct discovery will work in TR 23.713 [32]. The
Restricted ProSe Direct Discovery allows permission defined at application
layer by Announcing/Discoveree UE to determine the capability of the
Monitoring/Discoverer UE to discover the Announcing/Discoveree UE. The
permission information for the Restricted Direct Discovery defined at
application layer, is maintained by the ProSe Application Server. This binding
information is exchanged over the reference point PC2 and needs to be
transported securely between a ProSe Function in 3GPP network and a ProSe
Application Server. Therefore the PC2 interface needs to be secured.
#### 7.3.2.2 Security threats
When the ProSe Application Server is controlled by a 3rd party, then the
communication on the PC2 interface between the ProSe Application Server and
the ProSe Function may take place over an insecure link or over a secured
link. In case insecure link, the security threats which may occur on this
interface are:
\- A malicious ProSe Application Server, which is not authorized to update
authorization data in a ProSe Function in a3GPP network, may update
authorization data regarding a specific user illegitimately in the ProSe
Function in the3GPP network.
\- Attackers can eavesdrop the data on the interface between the ProSe
Application Server and a ProSe Function in a 3GPP network.
\- Attackers can tamper an Authorization Request/Response message or an Update
Authorization Request message on the interface between the ProSe Application
Server and a ProSe Function in a 3GPP network.
\- Attackers can replay an Authorization Request/Response message or an
Authorization Update Request message on the interface between the ProSe
Application Server and a ProSe Function in a 3GPP network.
\- The 3GPP private user identity (IMSI) could be exposed to the ProSe
Application Server controlled by a 3rd party.
#### 7.3.2.3 Potential security requirements
When the ProSe Application Server is controlled by a 3rd party, then the
following security requirements apply to PC2 interface:
\- The ProSe Function in the 3GPP network and the ProSe Application Server
shall be able to mutually authenticate each other.
\- The ProSe Function in the 3GPP network shall be able to determine whether
the ProSe Application Server is authorized to send Authorization Update
Requests message to the ProSe Function in the 3GPP network.
\- The signalling messages between the ProSe Function in the 3GPP network and
the ProSe Application Server shall be integrity protected.
\- The signalling messages between the ProSe Function in the 3GPP network and
the ProSe Application Server should be confidentiality protected.
\- The signalling messages between the ProSe Function in the 3GPP network and
the ProSe Application Server shall be protected from replays.
\- Ensure the privacy of the 3GPP user, in particular the 3GPP private user
identity (IMSI) shall not be sent outside the 3GPP domain.
### 7.3.3 Key Issue #7.3.3: Spatial Replay for ProSe Direct Discovery
Currently, there is no mechanism in the ProSe Direct Discovery Procedure that
guarantees that ProSe-enabled UE\'s that discover each other are in fact in
proximity. As a result, the following attack becomes feasible: An attacker
listens to the air interface, collects discovery messages and broadcasts them
somewhere else. This is what we will refer to as \"spatial replay\". Such an
attack can be considered as even more harmful than replay in time since an
attacker could keep replaying messages without being noticed even after
fooling the UEs into wrongly discovering each other (although not in
proximity). Then, the UEs would keep communicating (e.g. through direct
communication) believing that they are in proximity although they might even
be in different PLMNs.
#### 7.3.3.1 Key issue details
Consider two ProSe-enabled UEs, UE_A and UA_B in two different areas not
necessarily under network coverage and completely out of ProSe range (around
500 meters). An attacker (UE_1 in Figure 1) in direct range of UE_A can
collect discovery messages and tunnel them through the internet (or even LTE)
to another malicious UE_2. UE_2 can then broadcast the collected discovery
messages to any UE in its direct range (such as UE_B in Figure 1) fooling it
to believe that it is in proximity of UE_A.
{width="128.57569444444445in" height="2.9791666666666665in"}
**Figure 7.3.3.1-1: Spatial Replay**
In case UE_A and UE_B are configured to discover each other, then the MIC
checking procedure would most likely succeed at UE_B.
Observe that the attacker does not need to modify the discovery messages. The
attack\'s only effect on the discovery procedure is that it introduces some
additional delay between the transmission (from UE_A) and the reception of the
discovery message (at UE_B).
The attack is possible in Open and Restricted Discovery, Model A and Model B.
**Model A vs. Model B**
In Model A, UE_1 simply tunnels discovery messages to UE_2 which broadcasts
them in the new location. UE_B receiving the broadcasts will believe UE_A is
in its proximity.
In Model B, UE_2 also needs to tunnel the response from UE_B back to UE_1.
UE_1 in turn broadcasts the tunnelled response to UE_A.
**Open vs. Restricted Discovery**
The attack is possible for both types of discovery. In open discovery, since
there is no encryption, the attacker is even able to tune his attack by
selecting which messages to tunnel depending on the ProSe application codes.
#### 7.3.3.2 Security threats
A UE can be tricked into believing that another UE is in proximity when it
currently is not.
#### 7.3.3.3 Potential security requirements
Spatial replay protection of discovery request and response messages should be
provided. The possibility to track UEs based on location information should be
minimized.
Editor\'s note: The attack was agreed to be possible. It is FFS which
mitigation mechanisms (if any) will be specified.
## 7.4 Key Issues on ProSe Direct Discovery (Public Safety use)
### 7.4.1 Key Issue #7.4.1: Direct Discovery (public safety use) in out of
coverage scenario - Group Discovery
#### 7.4.1.1 Key issue details
Security aspects of out-of-coverage ProSe discovery mechanism for public
safety use needs to be considered. The group member discovery (public safety
use) should be possible irrespective of whether the discovering public safety
UE and/or public safety UE being discovered is in coverage of network or out
of coverage of network. Rel-12 standardized security mechanism for discovery
operates only in the coverage of network and the security validation is
performed by the ProSe Function in the network. Therefore, for the out-of-
coverage, security validation cannot be performed by the ProSe Function and
there is a need for security mechanism to mitigate the security threats
identified on direct discovery (public safety use).
#### 7.4.1.2 Security threats
Security threats identified for the open discovery (clause 5.2.1.2 and clause
5.2.2.2 in the present specification) applies for direct discovery in out-of-
coverage scenario also. In addition, security threats identified for
restricted discovery (clauses 7.3.1 and 7.3.2 in the present document), such
as tracking, impersonation and replay, also apply to group member discovery
out of coverage. Information inserted into the message by the group member may
be eavesdropped as it is transmitted over the air.
> Editor\'s Notes: It is FFS, any other security threat is possible for group
> discovery.
#### 7.4.1.3 Potential security requirements
The system should support a method to mitigate the replay attack, source
authenticity verification and integrity protection for Direct Group member
Discovery (public safety use) in out of coverage scenario.
The system should provide a means of minimising the possibility of tracking of
UEs based on the content of their discovery messages over time.
The system should support the confidentiality of information added by group
members to the message.
# 8 Solutions for Rel-13
## 8.1 Solutions on ProSe Relays
### 8.1.1 Solution #8.1.1 UE-to-Network relay discovery
#### 8.1.1.1 Solution description
This is an optimization of 6.2.5, \"Solution #2.5: Security for discovery
response\" in current TR, to adopt it for UE-Network Relay Model B discovery.
Assumption: The Remote UE has previously registered to ProSe Function and
shares a ProSe key with Prose Function.
Figure 8.1.1.1.1-1: UE-to-Network relay discovery (Model B)
0\. The Remote UE and the UE-to-Network Relay get authorization to perform
ProSe Direct Discovery by exchanging Discovery Request/Discovery Response
messages with their respective HPMLN ProSe Functions, and obtaining a
Discovery key associated with the ProSe App Code that is assigned to them for
initiating discovery procedures. This is done while both the Remote UE and the
UE-to-Network Relay are in-coverage.1. The Remote UE begins discovery process
by broadcasting the Direct Discovery Request message. This message includes
the ProSe App code, UTC based counter and the 32-bit MIC calculated to provide
integrity protection of the code.
2\. Upon receiving the message for relay discovery from Remote UE, the UE-to-
Network Relay sends a Match Report message to the Prose Function for
verification, forwarding the UE-to-Network Relay Identity and the message from
Remote UE.
3\. The ProSe Function verifies whether the UE-NW Relay UE is authorized to
act as a relay based on the UE-to-Network Relay Identity. If the verification
is successful, the ProSe Function further verifies 1) if the relay discovery
message is from the Remote UE, 2) whether Remote UE is authorized to use the
relay. This is done by checking whether the MIC is valid. The relevant
Discovery Key is found using the ProSe App Code. If the verification is
successful, the ProSe Function generates a token as described in clause
8.1.1.2, which binds the two UEs engaged in the discovery process and proves
the authenticity of the UE-to-Network Relay to the Remote UE.
4\. The ProSe Function sends a Match Report Ack to UE-Network Relay, including
in it an indication of the verification result and the token.
5\. The UE-to-Network Relay sends the Direct Discovery Response message to the
Remote UE. It includes the UE-to-Network Relay Identity and the token it
received in the Match Report Ack message.
6\. Remote UE receives the message and verifies whether the UE-to-Network
Relay is authorized to serve as relay. This is done by verifying the received
token from the UE-to-Network Relay using its Discovery key. If the
verification of the token is successful, then the Remote UE knows UE-to-
Network Relay is authorized to provide relay services.
#### 8.1.1.2 Token Calculation
The Token is calculated by the HPLMN ProSe Function of the remote UE and
provided to the UE-to-Network Relay UE. The Relay UE includes the Token in the
Direct Discovery Response message back to the Remote UE.
The Remote UE calculates the Token by itself, as described below and compares
it with the received Token in the Direct Discovery Response message. If the
Tokens are equal then the Remote UE knows that the UE-to-Network Relay UE is
authentic and authorized to respond and the Direct Discovery Response message
is not a replayed Direct Discovery Response message.
The token parameter is calculated as follows:
Token = KDF (Discovery key, ProSe App Code, UE-to-Network Relay Identity)
\- Discovery key is shared between the Remote UE and HPLMN ProSe Function in
the network. It is valid within the identified validity timer window.
\- ProSe App Code provides binding of the Token to the Remote UE.
\- UE-to-Network Relay Identity provides binding of the Token to the UE-to-
Network Relay.
### 8.1.2 Solution #8.1.2 Security between Remote UE and UE-to-Network Relay
using GBA push for direct communication key
#### 8.1.2.1 General
This solution uses GBA push for key establishment between Remote UE and UE-to-
Network Relay. The established direct communication key can be used for mutual
authentication and securing communications on PC5.
The solution is primarily targeted for communication between a Remote UE and
UE-to-Network Relay as it assumes that the Remote UE is out of network
coverage. However, the solution also applies to provide security between the
two UEs for one-to-one communications in case one of the UEs happens to be out
of network coverage.
#### 8.1.2.2 Solution description
Figure 8.1.2.2-1: Procedure for UE-to-Network relay security
The procedure for UE-to-Network relay security is described in figure above
for the general case when the Remote UE and UE-to-Network Relay are related to
different HPLMNs, and therefore to different ProSe KMFs. In case the Remote UE
and UE-to-Network Relay are related to the same KMS and HPLMN, the
functionality of ProSe KMF of Remote UE and ProSe KMF of Relay is combined
into one ProSe KMF and steps 6 and 12 are omitted in the flow.
The UE-to-Network Relay has performed initial E-UTRAN Attach and established a
PDN connection for relaying.
1) The UE-to-Network Relay has established secure channel over PC3/PC8.
2) The Remote UE and UE-to-Network Relay have discovered each other using
either Model A or Model B.
3) The Remote UE sends a Direct Communication Setup Request message to UE-to-
Network Relay in order to trigger the establishment of secure link over PC5.
The request includes Remote UE ID, and NAF-ID (which identifies the ProSe KMF
of the Remote UE acting as NAF).
4) The UE-to-Network Relay sends a Retrieve ProSe Direct Key Request to the
ProSe KMF of Relay. The request includes Remote UE ID, UE-to-Network Relay ID
and NAF-Id identifying the ProSe KMF of Remote UE.
5) The ProSe KMF of Relay checks if a Remote UE from the HPLMN associated to
the NAF_Id is authorized to set-up security over PC5 with the UE-to-Network
Relay.
6) The ProSe KMF of Relay sends a ProSe key request over PC6 to ProSe KMF of
Remote UE. The request includes Remote UE ID, UE-to-Network Relay ID and
NAF_Id. If the Remote UE and UE-to-Network Relay are related to the same ProSe
KMF, this step is omitted.
7) The ProSe KMF of Remote UE checks if the Remote UE is authorized to set-up
security over PC5 with a UE-to-Network Relay belonging to HPLM of the Relay.
8) If the authorization is successful, the ProSe KMF of Remote UE sends GPI
request to the BSF. The Remote UE ID is included in the message as it will be
used as the public user identity to obtain the GPI or it will be translated to
an appropriate public user identity, if needed.
9) BSF contacts the HSS.
10) The BSF prepares the GPI and Ks_(ext/int)_NAF according to the GBA push TS
33.223 and sends them to the ProSe KMF of Remote UE. The ProSe KMF of Remote
UE checks from the USS if the USIM is authorized to be used for ProSe
services.
11) The ProSe KMF of Remote UE derives ProSe Direct Key from the
Ks_(ext/int)_NAFand UE-to-Network Relay ID, and generates ProSe Direct Key ID
and lifetime for ProSe Direct Key.
12) The ProSe KMF of Remote UE sends the parameters GPI, ProSe Direct Key,
ProSe Direct Key ID and lifetime to ProSe KMF of Relay in ProSe key response
over PC6. If the Remote UE and UE-to-Network Relay are related to the same
ProSe KMF, this step is omitted.
13) The ProSe KMF of Relay sends Retrieve ProSe Direct Key Response to the UE-
to-Network Relay. The response includes GPI, ProSe Direct Key, ProSe Direct
Key ID and the lifetime.
14) The UE-to-Network Relay stores the ProSe Direct Key, ProSe Direct Key ID
and the lifetime and sends Direct Communication Setup Response message to the
Remote UE. The message includes GPI, UE-to-Network Relay ID, Lifetime, ProSe
Direct Key ID and Nonce-Relay protected with a MAC using ProSe Direct Key.
15) The Remote UE processes the GPI to get the Ks_(ext/int)_NAF, lifetime and
P-TID and derives the ProSe Direct Key similarly as the ProSe KMF of Remote UE
did. The Remote UE checks the MAC of the message using ProSe Direct Key.
NOTE: Steps 16 -18 for nonce based authentication are an optional part of the
solution and are not part of key establishment procedure. Also other
authentication mechanisms could be considered
> Steps 16 -- 18 are performed only if authentication was desired by the Relay
> by sending Nonce-Relay in step 14.
>
> 16) The Remote UE sends Direct Communication Setup Accept message to UE-to-
> Network Relay. The message includes Nonce-UE, and \"ok\" protected with a
> MAC using ProSe Direct Key. Also Nonce-Relay is taken into MAC calculation.
>
> 17) Upon receiving the Direct Communication Setup Accept message, the UE-to-
> Network Relay checks the MAC. If MAC check is successful, UE-to-Network
> Relay has authenticated Remote UE, and UE-to-Network Relay sends Direct
> Communication Setup Complete message to the Remote UE. The message includes
> an \"ok\" protected with a MAC using the ProSe Direct Key. Also Nonce-UE is
> taken into MAC calculation.
>
> 18) Upon receiving the Direct Communication Setup Complete message, the UE-
> to-Network Relay checks the MAC. If MAC check is successful at the Remote
> UE, the Remote UE has authenticated UE-to-Network Relay.
### 8.1.3 Solution #8.1.3 Security between Remote UE and UE-to-Network relay
using GBA push for transport of direct communication key
#### 8.1.3.1 General
This solution uses GBA push to transport a direct communication key from the
KMS to Remote UE and UE-to-Network Relay. The transported direct communication
key can be used for mutual authentication and securing communications on PC5.
The solution is primarily targeted for communication between a Remote UE and
UE-to-Network Relay as it assumes that the Remote UE is out of network
coverage. However, the solution also applies to provide security between the
two UEs for one-to-one communications in case one of the UEs happens to be out
of network coverage.
#### 8.1.3.2 Solution description
Figure 8.1.3.2-1. Procedure for UE-to-Network relay security
The procedure for UE-to-Network relay security is described in figure above
for the general case when the Remote UE and UE-to-Network Relay are related to
different HPLMNs, and therefore to different ProSe KMFs. In case the Remote UE
and UE-to-Network Relay are related to the same KMS and HPLMN, the
functionality of ProSe KMF (of Remote UE) and ProSe KMF (of Relay) is combined
into one ProSe KMF and steps 6 and 12 are omitted in the flow.
The UE-to-Network Relay has performed initial E-UTRAN Attach and established a
PDN connection for relaying.
> 1) The UE-to-Network Relay has established secure channel over PC3/PC8.
>
> 2) The Remote UE and UE-to-Network Relay have discovered each other using
> either Model A or Model B.
>
> 3) The Remote UE sends a Direct Communication Setup Request message to UE-
> to-Network Relay in order to trigger the establishment of secure link over
> PC5. The request includes Remote UE ID, and NAF-ID (which identifies the
> ProSe KMF of the Remote UE acting as NAF).
>
> 4) The UE-to-Network Relay sends a Retrieve ProSe Direct Key Request to the
> ProSe KMF of Relay. The request includes Remote UE ID, UE-to-Network Relay
> ID, and NAF-Id identifying the ProSe KMF of Remote UE.
>
> 5) The ProSe KMF of Relay checks if a Remote UE from the HPLMN associated to
> the NAF_Id is authorized to set-up security over PC5 with the UE-to-Network
> Relay.
>
> 6) The ProSe KMF of Relay sends a ProSe key request over PC6 to ProSe KMF of
> Remote UE. The request includes Remote UE ID, UE-to-Network Relay ID and
> NAF_Id. If the Remote UE and UE-to-Network Relay are related to the same
> ProSe KMF, this step is omitted.
>
> 7) The ProSe KMF of Remote UE checks if the Remote UE is authorized to set-
> up security over PC5 with a UE-to-Network Relay belonging to HPLM of the
> Relay.
>
> 8) If the authorization is successful, the ProSe KMF of Remote UE sends GPI
> request to the BSF. The Remote UE ID is included in the message as it will
> be used as the public user identity to obtain the GPI or it will be
> translated to an appropriate public user identity, if needed.
>
> 9) BSF contacts the HSS.
>
> 10) The BSF prepares the GPI and Ks_(ext/int)_NAFaccording to the GBA push
> TS 33.223 and sends them to the ProSe KMF of Remote UE. The ProSe KMF of
> Remote UE checks from the USS if the USIM is authorized to be used for ProSe
> services.
>
> 11) The ProSe KMF of Remote UE derives ProSe Transport Key from the
> Ks_(ext/int)_NAFand UE-to-Network Relay. ID The ProSe KMF of Remote UE
> generates ProSe Direct Key ID and lifetime for ProSe Direct Key. The KMS
> then protects (i.e. encrypts and integrity protects) the ProSe Direct Key
> with ProSe Transport Key.
>
> 12) The ProSe KMF of Remote UE sends the parameters GPI, ProSe Direct Key,
> ProSe Direct Key ID, Protected(ProSe Direct Key) and the lifetime in ProSe
> key response over PC6. If the Remote UE and UE-to-Network Relay are related
> to the same ProSe KMF, this step is omitted.
>
> 13) The ProSe KMF of Relay sends Retrieve ProSe Direct Key Response to the
> UE-to-Network Relay. The response includes GPI, ProSe Direct Key, ProSe
> Direct Key ID, Protected(ProSe Direct Key) and the lifetime.
>
> 14) The UE-to-Network Relay stores the ProSe Direct Key, ProSe Direct Key ID
> and the lifetime and sends Direct Communication Setup Response message to
> the Remote UE. The message includes GPI, UE-to-Network Relay ID, Lifetime,
> ProSe Direct Key ID, Protected(ProSe Direct Key) and Nonce-Relay protected
> with a MAC using ProSe Direct Key.
>
> 15) The Remote UE processes the GPI to get the Ks_(ext/int)_NAF, and derives
> the Ks_(ext/int)_NAFand ProSe Transport Key similarly as the KMS did. Then
> Remote UE unprotects (decrypts and check integrity of) ProSe Direct Key with
> ProSe Transport Key. The Remote UE checks the MAC of the message using ProSe
> Direct Key.
>
> NOTE: Steps 16 -18 for nonce based authentication are an optional part of
> the solution and are not part of key establishment procedure. Also other
> authentication mechanisms could be considered.
>
> Steps 16 -- 18 are performed only if authentication was desired by the Relay
> by sending Nonce-Relay in step 14.
>
> 16) The Remote UE sends Direct Communication Setup Accept message to UE-to-
> Network Relay. The message includes Nonce-UE an \"ok\" protected with a MAC
> using ProSe Direct Key. Also Nonce-Relay is taken into MAC calculation.
>
> 17) Upon receiving the Direct Communication Setup Accept message, UE-to-
> Network Relay checks the MAC. If MAC check is successful, UE-to-Network
> Relay has authenticated Remote UE, and UE-to-Network Relay sends Direct
> Communication Setup Complete message to the Remote UE. The message includes
> an \"ok\" protected with a MAC using the ProSe Direct Key. Also Nonce-UE is
> taken into MAC calculation.
>
> 18) Upon receiving the Direct Communication Setup Complete message, the UE-
> to-Network Relay checks the MAC. If MAC check is successful at the Remote
> UE, the Remote UE has authenticated UE-to-Network Relay.
### 8.1.4 Solution #8.1.4 Security between Remote UE and UE-to-Network Relay
using PC4a interface to generate Direct Communication key
#### 8.1.4.1 General
In this solution:
\- ProSe Direct Key, required for securing communication between the Remote UE
and the UE-to-Network Relay, is generated by the KMS, based on the
authentication vector it retrieved from the HSS using the PC4a interface. KMS
also generates the corresponding GPI data object.
\- The UE-to-Network Relay receives the key and the GPI object. It forwards
the GPI object to the remote UE.
\- The Remote UE uses the NAF key obtained from processing the GPI to generate
the ProSe Direct Key.
This solution is applicable in scenarios where the termination points of both
the Ua and Ub interfaces reside inside the KMS and KMS supports PC4a reference
point with the HSS.
#### 8.1.4.2 Solution description
{width="6.685416666666667in" height="6.235416666666667in"}
Figure 8.1.4.2-1: UE-to-Network relay security based on PC4a
The procedure for PC4a based UE-to-Network relay security works as follows:
Step 0: The UE-to-Network Relay has performed initial E-UTRAN Attach and
established a PDN connection for relaying. The UE-to-Network Relay has
established secure channel over PC8. The Remote UE and UE-to-Network Relay
have discovered each other using Model A or Model B.
1) The Remote UE sends a Direct Communication Setup Request message to the UE-
to-Network Relay in order to trigger the establishment of secure link over
PC5. The request includes Remote UE ID, and NAF-ID (KMS acting as NAF).
Editor\'s Note: It is ffs how the solution works if the Remote UE and UE-to-
Network Relay Relay are related to two different KMSs.
Editor\'s Note: It is ffs in which case the NAF ID needs to be transmitted to
the Relay.
2) The UE-to-Network Relay sends a Retrieve ProSe Direct Key Request to the
KMS. The request includes Remote UE ID and UE-to-Network Relay ID.
Editor\'s Note: It is ffs how the UE-to-Network Relay behaves when it receives
a NAF ID it cannot connect to.
3) The KMS checks if Remote UE and UE-to-Network Relay are authorized to set-
up security over PC5.
4) and 5) If the authorization is successful, the KMS contacts the HSS over
PC4a to retrieve the Authentication vector for the Remote UE.
6) Once the response is received from HSS, the KMS:
\- generates NAF-key(s) according to the provided NAF_Id
\- generates GPI according to TS 33.223
\- derives ProSe Direct Key from the NAF-key, and generates ProSe Direct Key
ID and lifetime for ProSe Direct Key
7) The KMS sends Retrieve ProSe Direct Key Response to the UE-to-Network
Relay. The response includes GPI, ProSe Direct Key, ProSe Direct Key ID and
the lifetime.
8) The UE-to-Network Relay stores the ProSe Direct Key, ProSe Direct Key ID
and the lifetime, and sends Direct Communication Setup Response message to the
Remote UE. The message includes GPI, UE-to-Network Relay ID, Lifetime, ProSe
Direct Key ID and Nonce-Relay protected with a MAC using ProSe Direct Key.
9) The Remote UE processes the GPI to get the NAF key, and derives the ProSe
Direct Key similarly as the KMS did. The Remote UE checks the MAC of the
message using ProSe Direct Key.
10) The Remote UE sends Direct Communication Setup Accept message to UE-to-
Network Relay. The message includes Nonce-UE, and \"ok\" protected with a MAC
using ProSe Direct Key. Also Nonce-Relay is taken into MAC calculation.
11) Upon receiving the Direct Communication Setup Accept message, the UE-to-
Network Relay checks the MAC. If MAC check is successful, UE-to-Network Relay
has authenticated Remote UE, and UE-to-Network Relay sends Direct
Communication Setup Complete message to the Remote UE. The message includes an
\"ok\" protected with a MAC using the ProSe Direct Key. Also Nonce-UE is taken
into MAC calculation.
12) Upon receiving the Direct Communication Setup Complete message, the UE-to-
Network Relay checks the MAC. If MAC check is successful at the Remote UE, the
Remote UE has authenticated UE-to-Network Relay.
### 8.1.5 Solution #8.1.5 Security between Remote UE and UE-to-Network Relay
based on the secure transfer of Direct Communication key generated using PC4a
#### 8.1.5.1 General
In this solution,
\- ProSe Direct Key, required for securing communication between the Remote UE
and the UE-to-Network Relay, is generated by the KMS, based on the
authentication vector for the Remote UE it retrieved from the HSS using the
PC4a interface. KMS encrypts the ProSe Direct Key by the security association
based on the retrieved authentication vector. KMS also generates the
corresponding GPI data object.
\- The UE-to-Network Relay receives the ProSe Direct Key, the encrypted ProSe
Direct Key and the GPI object from the KMS.
\- The UE-to-Network Relay retains the ProSe Direct Key, and forwards the
encrypted ProSe Direct Key as well as the GPI to the Remote UE.
\- The Remote UE uses the NAF key obtained from processing the GPI to decrypt
the ProSe Direct Key.
This solution is applicable in scenarios where the termination points of both
the Ua and Ub interfaces reside inside the KMS and KMS supports PC4a reference
point with the HSS.
#### 8.1.5.2 Solution description
{width="6.685416666666667in" height="7.0256944444444445in"}
Figure 8.1.5.2-1: UE-to-Network Relay security based on PC4a
The procedure for PC4a based UE-to-Network relay security works as follows:
Step 0: The UE-to-Network Relay has performed initial E-UTRAN Attach and
established a PDN connection for relaying. The UE-to-Network Relay has
established secure channel over PC8. The Remote UE and UE-to-Network Relay
have discovered each other using Model A or Model B.
1) The Remote UE sends a Direct Communication Setup Request message to the UE-
to-Network Relay in order to trigger the establishment of secure link over
PC5. The request includes Remote UE ID, and NAF-ID (KMS acting as NAF).
Editor\'s Note: It is ffs how the solution works if the Remote UE and Relay
are related to two different KMSs.
Editor\'s Note: It is ffs in which case the NAF ID needs to be transmitted to
the Relay.
2) The UE-to-Network Relay sends a Retrieve ProSe Direct Key Request to the
KMS. The request includes Remote UE ID and UE-to-Network Relay ID.
Editor\'s Note: It is ffs how the UE-to-Network Relay behaves when it receives
a NAF ID it cannot connect to.
3) The KMS checks if Remote UE and UE-to-Network Relay are authorized to set-
up security over PC5.
4) and 5) If the authorization is successful, the KMS contacts the HSS over
PC4a to retrieve the Authentication vector for the Remote UE.
6) Once the response is received from the HSS, the KMS:
\- generates the NAF-key(s) according to the provided NAF_Id
\- generates GPI according to TS 33.223
\- derives ProSe Transport Key from the NAF-key and UE-to-Network Relay ID. It
also generates ProSe Direct Key, ProSe Direct Key ID and lifetime for ProSe
Direct Key
\- protects (i.e. encrypts and integrity protects) the ProSe Direct Key with
the ProSe Transport Key
7) The KMS sends Retrieve ProSe Direct Key Response to the UE-to-Network
Relay. The response includes GPI, ProSe Direct Key, ProSe Direct Key ID,
Protected(ProSe Direct Key) and the lifetime.
8) The UE-to-Network Relay stores the ProSe Direct Key, ProSe Direct Key ID
and the lifetime and sends Direct Communication Setup Response message to the
Remote UE. The message includes GPI, UE-to-Network Relay ID, Lifetime, ProSe
Direct Key ID, Protected(ProSe Direct Key) and Nonce-Relay protected with a
MAC using ProSe Direct Key.
9) The Remote UE processes the GPI to get the NAF key, and derives the NAF key
and ProSe Transport Key similarly as the KMS did. Then Remote UE unprotects
(decrypts and check integrity of) ProSe Direct Key with ProSe Transport Key.
The Remote UE checks the MAC of the message using ProSe Direct Key.
10) The Remote UE sends Direct Communication Setup Accept message to UE-to-
Network Relay. The message includes Nonce-UE an \"ok\" protected with a MAC
using ProSe Direct Key. Also Nonce-Relay is taken into MAC calculation.
11) Upon receiving the Direct Communication Setup Accept message, UE-to-
Network Relay checks the MAC. If MAC check is successful, UE-to-Network Relay
has authenticated Remote UE, and UE-to-Network Relay sends Direct
Communication Setup Complete message to the Remote UE. The message includes an
\"ok\" protected with a MAC using the ProSe Direct Key. Also Nonce-UE is taken
into MAC calculation.
12) Upon receiving the Direct Communication Setup Complete message, the UE-to-
Network Relay checks the MAC. If MAC check is successful at the Remote UE, the
Remote UE has authenticated UE-to-Network Relay.
### 8.1.6 Solution #8.1.6 Security between Remote UE and UE-to-Network Relay
using pre-shared key (PGK)
#### 8.1.6.1 General
One of the requirements of D2D communication is that a UE out of coverage of
network should be able to communicate with network via another UE (i.e. UE-to-
Network Relay) which is in coverage of network and is in proximity of remote
UE.
In order to support one-to-one communication security, the one-to-many
communication key ProSe Group Key (PGK) is used. In other words, the PGK is
used for both one-to-one communication and also for one-to-many communication.
When the Remote UE and UE-to-Network relay belongs to same group, which means
the Remote UE and UE-to-Network relay have the same PGK, then security
procedure as detailed in TS 33.303 [33] for group communication is applied.
In case of communication between Remote UE and UE-to-Network relay wherein the
Remote UE and UE-to-Network relay belongs to different group, then different
security key is available at Remote UE and UE-to-Network relay. In other
words, when the PGK of the Remote UE is not available with the UE-to-Network
relay, then the communication between Remote UE and UE-to-Network relay cannot
be secured. For this scenario, the solution to secure the communication
between Remote UE and UE-to-Network relay is detailed below. Because PGK for a
group is used for secure communication between Remote UE and UE-to-Network
relay, all the group members of that group can derive the same key.
#### 8.1.6.1 Solution description for the communication between Remote UE and
UE-to-Network relay
Figure 8.1.6.1-1: Procedure for establishing securing communication between
Remote UE and UE-to-Network Relay
1\. The Remote UE sends the direct communication request to the UE-to-Network
Relay including the Remote UE ID and remote UE\'s network capabilities.
2\. When the UE-to-Network Relay receives the direct communication request
from Remote UE, it sends security key request to the PKMF. The PKMF of the
Remote UE is reachable by the UE-to-Network Relay. The security key request
comprises of remote UE\'s network capabilities, Remote UE ID, UE-to-Network
Relay\'s UE ID, and the Remote UE Group ID. Remote UE ID and Remote UE Group
ID together identifies the Remote UE. The UE-to-Network Relay obtains the
Remote UE ID and Remote UE Group ID of remote UE during the UE-to-Network
Relay discovery. Alternately UE-to-Network Relay may receive these from Remote
UE in direct connection request.
Editor\'s note: How this works if the UE and Relay are related to different
PKMFs is FFS.
3\. PKMF derives the security key i.e. ProSe Traffic Key which is used by UE-
to-Network relay to secure the packets transmitted to Remote UE. PKMF derives
the security key as follows:
PTKUE-to-NW Relay = KDF (PGK~UE-to-NW\ Relay~, PTK ID, UE-to-Network Relay UE
ID).
PGKRemote-UE is any valid ProSe Group Key of Remote UE corresponding to the
group identified by Remote UE Group ID.
4\. PKMF sends the security key response to the UE-to-Network Relay. The
security key response comprises of PTK~UE-to-NW\ Relay~, PTK ID and PGK ID.
PTKUE-to-NW Relay is derived by PKMF which is used by UE-to-Network relay to
secure the packets transmitted to Remote UE. PTK ID is the ID used as input to
derive the PTKUE-to-NW Relay. PGK ID is the index of PGKRemote-UE used to
derive the PTKUE-to-NW Relay.
5\. UE-to-Network relay selects the used algorithms with the highest priority
based on its own network capabilities and received network capabilities of
remote UE, then generates PEK~UE-to-NW\ Relay~ and PIKUE-to-NW Relay using
PTK~UE-to-NW\ Relay~ received in the security key response from PKMF. PEK~UE-
to-NW\ Relay~ and PIK~UE-to-NW\ Relay~ are then used for securing the packets
transmitted to Remote UE and also to decrypt and/or MAC-I verification of the
packets received from Remote UE.
6\. The UE-to-Network relay informs the selected algorithms, remote UE\'s
network capabilities, PGK ID and PTK ID received in security key response to
remote UE in a Authentication request message. The Authentication request
message is integrity protected using the PIK~UE-to-NW\ Relay~.
7\. Remote UE checks if the received network capabilities is equal to the
network capabilities sent in the initial message, then it generates the
security key i.e. Prose Traffic Key for transmission to UE-to-Network Relay.
The security key is derived as follows:
PTK~UE-to-NW\ Relay~ = KDF (PGK corresponding to PGK ID and Remote UE Group ID
received from UE-to Network Relay, PTK ID received from UE-to Network Relay,
UE-to-Network relay UE ID).
PEK~UE-to-NW\ Relay~ = KDF (PTK~UE-to-NW\ Relay~, Algorithm ID).
PIK~UE-to-NW\ Relay~ = KDF (PTK~UE-to-NW\ Relay~, Algorithm ID).
PEK~UE-to-NW\ Relay~ and PIK~UE-to-NW\ Relay~ are used by Remote UE for
securing the packets transmitted to UE-to-Network relay. PEK~UE-to-NW\ Relay~
and PIK~UE-to-NW\ Relay~ are also used by Remote UE for decrypting and MAC-I
verification of the packets received from UE-to-Network relay.
8\. The Remote UE verifies the MAC-I received, if the MAC-I verification is
successful, then Remote UE sends Authentication response message to the UE-to-
Network relay. The Authentication response message is integrity protected
using the PIK~UE-to-NW\ Relay~.
9\. The UE-to-Network relay verifies the MAC-I received.
10\. If the MAC-I verification is successful, then UE-to-Network relay sends
direct communication response message to the Remote UE.
### 8.1.7 Solution #8.1.7: UE-Network Relay security using pre-allocated
symmetric key
#### 8.1.7.1 Solution overview
The solution relies on a UE fetching a ProSe Relay User Key (PRUK) from the
ProSe Key Management Function (PKMF) while it is in coverage. The PRUK is
specific to a particular UE. In order to communicate with a particular relay,
the UE derives a ProSe Relay Key (PRK) from the PRUK and the Relay ID. This
PRK is then specific to the particular UE and Relay. The relay fetches a PRK
from the PKMF using the identity provided by the UE during the Direct
Communication Request.
The UE and relay then use the PRK to derive a K~D-SESS~ and the procedures
described in clause 8.2.2.2.
The PRUK is fetched using the same procedures as for bearer layer one-to-many
security as described in TS 33.303 [33], i.e. while in coverage the UE
exchanges Key Request/Response messages with the PKMF in order to get the PRUK
send in MIKEY messages. As in Rel-12, one-to-many communications, the PKMF
needs to be reachable by UEs that do not have a PDN connection that terminates
in the home network related to the PKMF. Hence ensuring the PKMF is reachable
by the remote UE may require the deployment of a Proxy PKMF similar to the
Proxy ProSe Function described in TS 23.303 [20].
#### 8.1.7.2 Security procedures
##### 8.1.7.2.1 General
##### 8.1.7.2.1.1 Connection with PRUK {#connection-with-pruk .H6}
##### 8.1.7.2.1.1.1 Security flows {#security-flows-1 .H6}
The establishment of the UE-network relay communication session is as shown in
figure 8.1.7.2.1.1.1-1.
Figure 8.1.7.2.1.1.1-1: Security set-up for UE-Network Relay
0\. The Remote UE and the UE-to-network relay fetched the parameters necessary
to act as a Remote UE and UE-to-network relay respectively (see TS
23.303[20]), the PKMF address for accessing the relay and the security
parameters required to protect the relay discovery messages.
1\. UE fetches the PRUK and the associated PRUK ID from the PKMF. The UE needs
to fetch the PRUK while it is in coverage.
1a. The Remote UE send a Key Request message to the PKMF of the UE-to-network
relay. The message indicates that the Remote UE is requesting a ProSe Relay
User Key (PRUK) from the PKMF. IF the UE already has a PRUK from this PKMF,
the message also contains the PRUK ID of the PRUK. This message is also used
by the Remote UE to indicate that it no longer wants to receive PRUKs from the
PKMF. For such a message, the PKMF responds with a Key Response containing an
acknowledgment.
Editor\'s Note: It is ffs if the Remote UE knows at steps 0 and 1 all the
relays that it will be allowed to connect to. In particular, the Remote UE
needs to get the address(es) of the PKMF(s) (e.g. is it possible to provision
PKMF addresses which are associated with the Relay Service Codes) that
provides the keys for those relays so that it can fetch the needed PRUKs while
in coverage.
1b. The ProSe Key Management Function checks that the UE is authorised to
receive UE-to-network Relay service from one of its relays. This is done by
using the UE identity that is bound to the keys that established the TLS
tunnel in which the message is sent. If the Remote UE is successfully
authorised, the PKMF of the Relay sends a Key Response message to the Remote
UE that contains a Key Type ID and may contain a PMK and a PMK ID (for
protecting MIKEY messages as in one-to-many communication -- see subclause
6.2.3.1 of TS 33.303 [33]). Key Type ID is used in the MIKEY messages to
inform the Remote UE that it is receiving a PRUK in the MIKEY message. The
PKMF may set Key Type ID to any value expect the values of Group ID that the
UE is requesting keys for. If a PMK and PMK ID are included, the UE stores
these and delete any previously stored ones for this ProSe Key Management
Function.
Editor\'s Note: It is ffs whether a push based solution is needed in addition
to these procedures to deal with this case of rekeying the UE while it is out-
of coverage
1c. The ProSe Key Management Function initiates the PRUK delivery procedure
using MIKEY, if either the UE does not have a PRUK or the PKMF wants to
provide the UE with a new one. This message is protected using PMK and carries
Key Type ID to indicate that it carriers a PRUK.
1d. The UE responds with a MIKEY Verification message if the PKMF requests
one.
2\. The UE discovers the Relay and its Relay ID as described in TS 23.303[20].
3\. UE sends the Direct Communication Request message to the relay as
described in subclause 8.2.2.2. 4. Relay fetches the PRUK from the PKMF.
> 4a. The UE-to-network relay sends a Key Request message to the PKMF. The
> message contains the PRUK ID provided by the Remote UE.
>
> 4b. The PKMF checks that the UE-to-network relay is authorised to serve the
> Remote UE that is identified by the PRUK ID. If so, it uses the PRUK
> associated with the supplied PRUK ID to calculate K~D~ with K~D~ Derivation
> Parameter (locally stored) as input. The PKMF sends the K~D~ and K~D~
> Derivation Parameter to the UE-to-network relay.
Editor\'s note: The K~D~ Derivation Parameter may provide the Remote UE with
authorisation information. If each connection is to be authorised then a nonce
for K~D~ derivation could be provided in the Direct Communication Request.
Similarly the key derivation may include Relay Service Code if it is want to
bind the connection set-up to a particular Relay Service Code. The exact
derivation details of K~D~ are FFS.
5\. The UE-to-network relay establishes the security using the procedures
described in subclause 8.2.2.2.
> 5a. Using the supplied KD to protect the message, the UE-to-network relay
> sends a Direct Security Mode Command message to the Remote UE. This message
> contains the KD Derivation Parameter.
5b. The Remote UE derives KD from its PRUK and the received KD Derivation
Parameter. It then processes the Direct Security Mode Command. If this is
successful, the Remote UE responds with a Direct Security Mode Complete
message.
##### 8.1.7.2.1.1.2 MIKEY messages {#mikey-messages .H6}
The MIKEY message processing is the same as for the delivering of PGKs, except
that the PKMF uses Key Type ID concatenated with PRUK ID in the IDi payload.
Similarly the UE recognise the Key Type ID as corresponding to PRUK and hence
the UE knows it is being sent a PRUK. The PKMF uses an all zero PRUK ID to
indicate to the UE that wants the UE to send a Key Request.
##### 8.1.7.2.2 Procedure when PRUK is not recognized at PKMF
Editor\'s Note: It needs to be decided by SA3 if Push or pull-based model or
both is needed.
If due to some error the PKMF does not recognize the PRUK ID coming via the
Relay (e.g. PKMF has lost it due to restart) and the UE is out of coverage,
the UE cannot fetch a new PRUK from the PKMF. In this case the UE contacts the
Relay with UE identity, e.g. IMSI and GBA push is used to derive the PRK.
The establishment of the UE-network relay communication session is as shown in
figure 8.1.7.2.2-1.
Figure 8.1.7.2.2-1: Security set-up for UE-Network Relay
1: UE fetches the PRUK and the associated PRUK ID from the PKMF. The UE needs
to fetch the PRUK while it is in coverage.
2\. The UE discovers the Relay and its Relay ID as described in TR 23.713[32].
3: UE sends the Direct Communication Request message to the relay. UE includes
PRUK ID of its PRUK, Nonce_1 (a random number) and a DKSI (this gives the
values of the Key Set Identifier for a security context created from the
PRUK). It also calculates PRK using PRUK and the Relay ID.
4\. Relay sends the received PRUK ID and its Relay ID to the PKMF.
5: If the PKMF does not recognize the PRUK ID, it sends an error message to
the Relay indicating that the PRUK ID is unknown. The Relay conveys the
message to the UE.
6: When the UE receives the error message, it tries to fetch a new PRUK from
the PKMF. If this is successful, the UE starts over from step 3 with the new
PRUK ID.
7: If fetching a new PRUK is not successful (e.g. the UE is out of coverage),
the UE sends the Direct Communication Request with UE identity, e.g. IMSI
instead of the PRUK ID. The message also includes Nonce_1 and DKSI.
8.The Relay sends a message to get ProSe Relay Key to the PKMF but now with
the UE identity, e.g. IMSI.
9: When the PKMF receives the \"\" it checks if the relay is authorised to
serve the UE (which is identified by the ProSe UE ID\"), and it fetches the
GPI and Ks_ext/int_NAF from the BSF using the UE identity, e.g. IMSI as the
identity or an identity mapped to UE identity, e.g. IMSI. PRK is calculated by
the PKMF using Ks_ext/int_NAF with the Relay ID as input.
10: The PKMF sends the PRK and GPI to the Relay.
Editor\'s note: How this works if the UE and Relay are related to different
PKMFs.
11: The relay generates Nonce_2 (a random number), calculates K~D-SESS~ (the
key that will be used to protect this one-to-one communication session).
K~D-SESS~ is calculated using PRK as the key and Nonce_1 and Nonce_2 as
inputs.
12: The relay then sends a Direct Security Mode Command message to UE (as
described in subclause 8.2.2.2.2). It includes the DKSI from step 7 to
indicate the security context used to protect this message, GPI and Nonce_2.
This message is integrity protected with an integrity key from the K~D-SESS~.
13: UE retrieves Nonce_2 from the Direct Security Mode Command message,
calculates Ks_ext/int_NAF from GPI, then calculates PRK using Ks_ext/int_NAF
and the Relay ID (This PRK will overwrite the PRK calculated in step 3). Then
the UE calculates K~D-SESS~ from PRK, Nonce_1 and Nonce_2. It then checks the
integrity protection of the received message using the integrity algorithm
indicated in the messages (see 8.2.2.2.2) and integrity key generated from the
K~D-SESS~.
14: UE_1 responds to UE_2 with a Direct Security Mode Complete message which
is integrity protected.
##### 8.1.7.2.3 Protection of traffic between UE and ProSe Function
In order to protect the messages between the UE and ProSe Function, the UE
supports the procedures for the UE given in subclause 5.3.3.2 of TS 33.303
[33] and the ProSe Function supports the procedures for the network function
given in subclause 5.3.3 of TS 33.303 [33].
##### 8.1.7.2.4 Protection of traffic between UE and ProSe Key Management
Function
In order to protect the UE-initiated messages between the UE and ProSe Key
Management Function, the UE supports the procedures for the UE given in
subclause 5.3.3.2 of TS 33.303 [33] and the ProSe Key Management Function
supports the procedures for the network function given in subclause 5.3.3.2 of
TS 33.303 [33].
The MIKEY messages are protected as described in subclause 8.7.1.2.1.1.2.
##### 8.1.7.2.5 Protection of traffic between UEs
The signalling and user plane traffic sent between the UE and UE-to-network
relay are protected as described in subclause 8.2.2.2.
### 8.1.8 Solution #8.1.8: UE-Network Relay security using normal GBA for
direct communication key
#### 8.1.8.1 Solution overview
In the UE-to-Network Relay case the Remote UE may be in or out of network
coverage. When the Remote UE is in network coverage it can run GBA
bootstrapping and use the resulting key material later on to establish
security with the UE-to-Network Relay. For that case, solution #8.2.1.1 for
one-to-one communication described in clause 8.2.1.1 and using normal GBA for
direct communication key can be used also to secure the UE-to-Network Relay
case.
#### 8.1.8.2 Solution procedures
This solution uses the same procedures as solution #8.2.1.1 described in
clause 8.2.1.1 with the change that UE1 takes the role of the Remote UE and
UE-2 takes the role of the UE-to-Network Relay.
### 8.1.9 Solution #8.1.9: UE-Network Relay security using normal GBA for
transport of direct communication key
#### 8.1.9.1 Solution overview
In the UE-to-Network Relay case the Remote UE may be in or out of network
coverage. When the Remote UE is in network coverage it can run GBA
bootstrapping and use the resulting key material later on to establish
security with the UE-to-Network Relay. For that case, solution #8.2.1.2 for
one-to-one communication described in clause 8.2.1.2 and using normal GBA for
transport of direct communication key can be used also to secure the UE-to-
Network Relay case.
#### 8.1.9.2 Solution procedures
This solution uses the same procedures as solution #8.2.1.2 described in
clause 8.2.1.2 with the change that UE1 takes the role of the Remote UE and
UE-2 takes the role of the UE-to-Network Relay.
### 8.1.10 Solution #8.1.10: Security of Relay Service Code
#### 8.1.10.1 Solution description
This solution addresses the requirements in key issue #7.1.1 and #7.1.2.
#### 8.1.10.2 Security procedures
In Figure 8.1.10.2-1, the security solution on Relay Service Code is
presented.
Figure 8.1.10.2-1: Relay Service Code procedure
> 1) ProSe UE-to-Network Relay sends Relay Service Code Request (relay
> indicator, UE Identity) to its ProSe Function. The relay indicator indicates
> that the sending UE is a ProSe UE-to-Network Relay.
>
> 2) ProSe Function of the Relay authorises the Relay according to its
> subscription information.
>
> 3) ProSe Function of the Relay responds with a Relay Service Code Response
> (Relay Service Code, Relay Service Code Key) message.
>
> 4) ProSe UE-to-Network Relay starts announcing the Relay Service Code in PC5
> interface. It also generates a random number RAND_1, and calculate a
> signature_m = SIGNATURE (string, key). The string = Relay Service Code \|\|
> Layer 2 ID of Relay. The key = KDF (Relay Service Code Key, RAND_1). The
> RAND_1 and signature_m are also announced with the Relay Service Code.
>
> 5) Remote UE sends Relay Service Code Request (UE Identity) to it ProSe
> Function.
>
> 6) ProSe Function of the remote UE authorises the remote UE according to its
> subscription information.
>
> 7) ProSe Function of the remote UE responds with a Relay Service Code
> Response (Relay Service Code, Relay Service Code Key) message.
>
> 8) Remote UE monitors in PC5 interface and receives announced Relay Service
> Code, along with RAND_1 and singnature_m.
>
> 9) If the code received in PC5 matches the code obtained in step 7, remote
> UE checks the signature_m by calculating a signature_n = SIGNATURE (string,
> key). The string = Relay Service Code \|\| Layer 2 ID of Relay. The key =
> KDF (Relay Service Code Key, RAND_1). If signature_n = signature_m, the
> ProSe UE-to-Network Relay is authenticated.
>
> 10) Remote UE generates a random number RAND_2, and calculate a signature_A
> = SIGNATURE (string, key). The string = Relay Service Code \|\| Layer 2 ID
> of remote UE. The key = KDF (Relay Service Code Key, RAND_2).
>
> 11) Remote UE sends Relay Connect Request (signature_A, RAND_2) to ProSe UE-
> to-Network Relay.
>
> 12) ProSe UE-to-Network Relay checks the signature_A by calculating a
> signature_B = SIGNATURE (string, key). The string = Relay Service Code \|\|
> Layer 2 ID of remote UE. The key = KDF (Relay Service Code Key, RAND_2). If
> signature_B = signature_A, the remote UE is authenticated.
13) If successful authenticated, ProSe UE-to-Network Relay responds with a
Relay Connect Response message.
### 8.1.11 Solution #8.1.11: Authentication and Key Agreement for one-to-one
Communication between Remote UE and UE-Network Relay using identity-based
cryptography
#### 8.1.11.1 General
The security solution uses The \"Elliptic Curve-based Certificateless
Signatures for Identity-based Encryption\" (ECCSI) signature scheme, as
defined in IETF RFC 6507. And Sakai-Kasahara Key Encryption (SAKKE) algorithm
used to exchange a shared secret from a Sender to a Receiver, as defined in
IETF RFC 6508.
Here it is assumed that the Remote UE and UE-Network Relay are provisioned
with credentials required by ECCSI and SAKKE schemes, as described in TR
33.833, clause 8.4.2.1 [\"Authentication and Key Agreement for ProSe Direct
Discovery using identity-based cryptography\"]. The following sub-sections
describe secure one-to-one between Remote UE and UE-Network Relay that may
follow ProSe UE-Network Relay Discovery with Model A or B.
#### 8.1.11.2 Secure One-2-One Communication between Remote UE and UE-Network
Relay that follows ProSe UE-Network Relay Discovery with Model A
Figure 8.1.11.2-1 illustrates secure one-to-one communication between Remote
UE and UE-Network Relay that follows ProSe UE-Network Relay Discovery with
Model A, using ECCSI & SAKKE schemes.
{width="6.322222222222222in" height="3.283333333333333in"}
Figure 8.1.11.2-1: Secure one-to-one layer-2 link setup that follows ProSe UE-
Network Relay Discovery with Model A
1\. A process E-UTRAN attachment.
2\. A process of UE-Network Relay Discovery with Model A. For more details,
please refer to TR 23.713, clause 6.1.2.2.1.
3\. Upon reception of the discovery announcement in step 2, identity of the
UE-Network Relay (\"Announcer Info\") is presented to the user of Remote UE.
If the user of Remote UE decides to engage in one-to-one communication, Remote
UE sends a Direct Communication Request message, including the following
parameters:
\- User Info of Remote UE = upper layer information about the user of Remote
UE. This information is used to derive the Signer\'s identifier (used by
ECCSI).
\- SIGN -- an ECCSI signature of the Direct Communication Request message. The
signature may be computed over all or a subset of the parameters in the
message. At a minimum the signature is computed over the User info of Remote
UE parameter.
4\. Upon reception of the Direct Communication Request message, UE-Network
Relay verifies the signature payload SIGN. If the verification test is
successful, UE-Network Relay presents the authenticated identity (\"User of
Remote UE Info\") to the user of UE-Network Relay. If user of UE-Network Relay
decides to accept the request, UE-Network Relay sends a Direct Communication
Response message, including the following parameters:
\- User Info Relay UE = upper layer information identifying the user of Relay-
UE. This information is used to derive the Signer\'s identifier (used by
ECCSI).
\- SIGN -- an ECCSI signature of the Direct Communication Response message.
The signature may be computed over all or a subset of the parameters in the
message. At a minimum the signature is computed over the User of Relay-UE Info
parameter:
\- SAKKE -- Relay-UE generates a Shared Secret Value (SSV) and encodes it into
a SAKKE payload according to the algorithm described in IETF RFC 6508, using
the KMS Pubic Key and the public identity of the Remote UE user. Upon receipt
of the Direct Communication Response message, the Remote UE verifies the
signature payload SIGN. If the verification test is successful, it decrypts
SAKKE payload to extract the SSV which is used to encrypt all subsequent data
exchanged between the two UEs,
#### 8.1.11.3 Secure One-2-One Communication between Remote UE and UE-Network
Relay that follows ProSe UE-Network Relay Discovery with Model B
Figure 8.1.11.3-1 illustrates secure one-to-one communication between Remote
UE and UE-Network Relay that follows ProSe UE-Network Relay Discovery with
Model B, using ECCSI & SAKKE schemes.
{width="6.322222222222222in" height="3.283333333333333in"}
**Figure 8.1.11.3-1:** Secure one-to-one layer-2 link setup that follows ProSe
UE-Network Relay Discovery with Model B
1\. A process E-UTRAN attachment.
2 (a,b). A process of UE-Network Relay Discovery with Model B. For more
details, please refer to TR 23.713, clause 6.1.2.2.2.
3\. Upon reception of the Response message in step 2b, identity of the UE-
Network Relay (\"Discoveree Info\") is presented to the user of Remote UE. If
the user of Remote UE decides to engage in one-to-one communication, Remote UE
sends a Direct Communication Request message, including the following
parameters:
\- Discoverer Info = upper layer information about the user of Remote UE. This
information is used to derive the Signer\'s identifier (used by ECCSI).
\- SIGN -- an ECCSI signature of the Direct Communication Request message. The
signature may be computed over all or a subset of the parameters in the
message. At a minimum the signature is computed over the Discoverer Info
parameter.
4\. Upon reception of the Direct Communication Request message, UE-Network
Relay verifies the signature payload SIGN. If the verification test is
successful, UE-Network Relay presents the authenticated identity (\"Discoverer
Info\") to the user of UE-Network Relay. If user of UE-Network Relay decides
to accept the request, UE-Network Relay sends a Direct Communication Response
message, including the following parameters:
\- User of Discoveree Info = upper layer information identifying the user of
Discoveree UE. This information is used to derive the Signer\'s identifier
(used by ECCSI).
\- SIGN -- an ECCSI signature of the Direct Communication Response message.
The signature may be computed over all or a subset of the parameters in the
message. At a minimum the signature is computed over the User of Discoveree
Info parameter.
\- SAKKE -- Discoveree UE generates a Shared Secret Value (SSV) and encodes it
into a SAKKE payload according to the algorithm described in IETF RFC 6508,
using the KMS Pubic Key and the public identity of the Remote UE\'s user. Upon
receipt of the Direct Communication Response message, the Discoverer UE
verifies the signature payload SIGN. If the verification test is successful,
it decrypts SAKKE payload to extract the SSV which is used to encrypt all
subsequent data exchanged between the two UEs.
#### 8.1.11.4 Solution Evaluation
1) The proposed solution does not require EPC involvement for establishment of
secure communication between Remote UE and ProSe UE-to-Network Relay.
2) The proposed solution provides a common method for establishment of secure
communication for both \"UE-to-UE\" (clause 8.2.2.1.3) and \"Remote-UE to
ProSe UE-to-Network-Relay\" (clause 8.1.11) cases.
3) The proposed solution enables Remote UE and ProSe UE-to-Network Relay to
establish secure communication where Remote UE and ProSe UE-to-Network Relay
may not belong to the same group.
4) The proposed solution uses identity-based cryptography similar to that used
for media security with one-to-many ProSe Direct Communication defined in
Rel-12.
### 8.1.12 Solution #8.1.12 Security for UE-to-Network Relay using GBA and
GBApush
#### 8.1.12.1 General
This solution uses B-TID/Ks obtained from GBA bootstrapping whenever possible
and uses GBApush only when the Ks related to the B-TID cannot be used and GBA
bootstrapping is not possible, e.g. due to Remote UE being out of coverage.
The established direct communication key can be used for mutual authentication
and securing communications on PC5.
The solution is compatible with TS 33.303 [33] clause 6.5.5: General security
establishment for one-to-one communications.
#### 8.1.12.2 Security procedure for UE-to-network relay security
{width="7.10625in" height="8.906944444444445in"}
Figure 8.1.12.2-1. Procedure for UE-to-network relay security
NOTE: This solution requires network coverage for the Remote UE only in the
beginning to run GBA bootstrapping.
The solution is described for the general case when the Remote and UE-to-
network relay are related to different HPLMNs.
The bootstrapping functionality may be deployed either with a standalone BSF
or as an integrated bootstrapping entity within the ProSe Function and ProSe
KMF according to Annex F.4 of TS 33.303 [33].
> 0) Remote UE and UE-to-network relay have established TLS connection to
> their respective ProSe Function and ProSe KMF. For BSF deployed case
> bootstrapping is run with BSF, and for PC4a case bootstrapping is run with
> integrated bootstrapping entity within ProSe Function and Prose KMF. The UE
> and ProSe KMF are required to store the last used B-TID between them with
> associated IMSI even though the B-TID would be expired. The purpose is to
> use B-TID as a temporary Remote UE identity. This helps to maintain user
> privacy.
>
> 1a) The Remote UE and the UE-to-network relay fetch the parameters necessary
> to act as a Remote UE and UE-to-network relay respectively (see TS 23.303
> [33]), and the ProSe KMF address of the UE-to-network relay.
>
> 1b) The Remote UE and the UE-to-network relay fetch security parameters
> required to protect the relay discovery messages from ProSe KMF of the UE-
> to-network relay.
>
> 2) Remote UE and UE-to-network relay have discovered each other using either
> Model A or Model B.
>
> 3) Remote UE sends a Direct Communication Setup Request message to UE-to-
> network relay in order to trigger the establishment of secure link over PC5.
> The request includes B-TID, NAF_Id (which identifies the ProSe KMF of UE-to-
> network relay acting as NAF. This is the same ProSe KMF with which the
> Remote UE communicated in step 1)) and the other parameters as defined in TS
> 33.303 [33] clause 6.5.5.
>
> The Remote UE will send the B- TID according to the following rules.
>
> \- If the UE has a valid B-TID and related Ks available, the B-TID is sent.
>
> \- If the UE has a B-TID, but it is expired, the UE runs bootstrapping if
> possible, and the new B-TID is sent.
\- If the UE has a B-TID, but it is expired and bootstrapping is not possible,
i.e. the Remote UE is out of coverage, the B-TID stored in step 0) is sent.
Editor\'s Note: It is FFS if it is possible not to use GBA push every time a
key is needed for PC5.
Editor\'s Note: It is FFS if it would be possible to use key derivation to
derive the key rather than using MIKEY to protect the key.
> 4) UE-to-network relay sends a Retrieve ProSe Relay Key Request to the ProSe
> KMF of UE-to-network relay. The request includes B-TID, UE-to-network relay
> ID (i.e. the ProSe Relay UE ID) and NAF-Id.
>
> 5) The ProSe KMF of UE-to-network relay checks if the Remote UE is
> authorised to receive UE-to-network Relay service from the UE-to-network
> relay. This is done by using the B-TID to find the UE identity that is bound
> to the keys that established the TLS connection over PC8 in step 0). If the
> Remote UE is successfully authorised, the processing continues.
>
> 6) The behaviour of ProSe KMF of UE-to-network relay is as follows depending
> if BSF or integrated bootstrapping entity is deployed, i.e. either step 6a
> or 6b is performed:
>
> 6a) When BSF is deployed, the ProSe KMF sends the B-TID and NAF_Id to the
> BSF to request for NAF keys. The NAF_Id has a different Ua security protocol
> Id than the one that was used for the TLS connection for PC8:
>
> 6a1) If the request is successful, the ProSe KMF of UE-to-network relay
> checks if the Remote UE is authorized to use GBA for ProSe security, and
> processing continues in step 7.
>
> 6a2) If the request is not successful, the ProSe KMF uses the stored B-TID
> to identify the Remote UE and requests GPI and NAF keys from the BSF.
>
> 6b) When integrated bootstrapping entity is deployed, the ProSe KMF
> internally checks if the Ks related to the B-TID from step 0) is available.
> The NAF_Id has a different Ua security protocol Id than was used for the TLS
> connection for PC8.
>
> 6b1) If the Ks is available, the ProSe KMF derives the NAF keys, and
> processing continues in step 7).
>
> 6b2) If the Ks is not available, the ProSe KMF uses the stored B-TID to
> identify the Remote UE and requests AV from the HSS and prepares GPI and NAF
> keys. Processing continues in step7.
>
> 7) The ProSe KMF of UE-to-network relay derives ProSe MIKEY Key (PMK) from
> the Ks_(ext)_NAF and UE-to-network relay UE ID. ProSe KMF of Remote UE
> generates K~D~ and protects it with PMK in a MIKEY message. UE-to-network
> relay ID and B-TID or RAND@\'naf\' (depending on which was used) are used to
> identify the PMK and they are placed in MIKEY header.
>
> NOTE 2: RAND@\'naf\' is downlink NAF SA identifier in TS 33.223.
>
> 8) The ProSe KMF of UE-to-network relay sends Retrieve ProSe Relay Key
> Response to UE-to-network relay. The response includes K~D~ and MIKEY
> message.
>
> 9) UE-to-network relay sends Direct Security Mode Command message to Remote
> UE using the supplied K~D~ to protect the message as defined in TS 33.303
> [33], clause 6.5.5. The message includes also the MIKEY message carrying the
> K~D~. If GPI was received in step 8, then it is sent as well.
>
> 10) If GPI was received in step 9, then the Remote UE processes the GPI to
> get Ks_(ext)_NAF. Otherwise Remote UE uses the Ks_(ext)_NAF as indicated by
> the B-TID in the MIKEY header and which was sent in step 3. Remote UE
> retrieves B-TID or RAND@\'naf\' (depending if GBA push was used) and UE-to-
> network relay ID from the MIKEY header. Then Remote UE derives the PMK from
> Ks_(ext)_NAF and UE-to-network relay ID similarly as the ProSe KMF of UE-to-
> network relay did and processes the MIKEY message to get K~D~. Remote UE
> also derives KD~sess~ and processes the Direct Security Mode Command as
> defined in TS 33.303 [33] clause 6.5.5. If this is successful, processing
> continues in step 11).
>
> 11) Remote UE sends Direct Security Mode Complete message to UE-to-network
> relay.
## 8.2 Solutions for one-to-one communications
### 8.2.1 Solution for one-to-one communications with at least one UE in
coverage
#### 8.2.1.1 Solution #8.2.1.1 Security for in coverage one-to-one direct
communication using GBA for direct communication key
##### 8.2.1.1.1 General
This solution uses GBA for key establishment between two UEs for one-to-one
direct communication. The established direct communication key can be used for
mutual authentication and securing communications on PC5.
The solution re-uses the principles of key establishment between a UICC
hosting device and a remote device specified in TS 33.259 [35].
The solution is primarily targeted for one-to-one direct communication as it
assumes that both UEs are in network coverage. However, the solution also
applies to provide security between the Remote UE and UE-to-Network Relay in
case the Remote UE happens to be in network coverage.
Editor\'s Note: The applicability of this solution to UE-to-Network Relay case
depends on the SA2 reply on the UE-to-Network Relay capabilities.
8.2.1.1..2 Solution description
**Figure 8.2.1.1.2-1: Procedure for one-to-one security**
> NOTE 1: This solution requires network coverage for UE-1 only in the
> beginning to run GBA bootstrapping.
The procedure for one-to-one security is described in figure above for the
general case when the Remote UE and UE-to-Network Relay are related to
different HPLMNs, and therefore to different ProSe KMFs. In case UE1 and UE-2
are related to the same KMS and HPLMN, the functionality of ProSe KMF of UE-1
and ProSe KMF of UE-2 is combined into one ProSe KMF and steps 6 and 12 are
omitted in the flow.
UE-2 has established secure channel over PC3/PC8.
> 1) UE-1 has run GBA bootstrapping with its BSF.
>
> 2) UE-1 and UE-2 have discovered each other using either Model A or Model B.
>
> 3) UE-1 sends a Direct Communication Setup Request message to UE-2 in order
> to trigger the establishment of secure link over PC5. The request includes
> UE-1 ID, B-TID and NAF-ID (which identifies the ProSe KMF of UE-1 acting as
> NAF).
>
> 4) UE-2 sends a Retrieve ProSe Direct Key Request to the KMF of UE-2. The
> request includes B-TID, UE-1 ID, UE-2 ID and NAF-Id identifying the ProSe
> KMF of UE-1.
>
> 5) The ProSe KMF of UE-2 checks if a UE from the HPLMN associated to the
> NAF_is authorized to set-up security over PC5 with UE-1.
>
> 6) The ProSe KMF of UE-2 sends a ProSe key request over PC6 to ProSe KMF of
> UE-1. The request includes B-TID, UE-1 ID, UE-2 ID.. If the UE-1 and UE-2
> are related to the same ProSe KMF, this step is omitted.
>
> 7) The ProSe KMF of UE-1checks if the UE-1 is authorized to set-up security
> over PC5 with a UE belonging to HPLM of UE-2.
>
> 8) If the authorization is successful, the ProSe KMF of UE-1 sends the B-TID
> and NAF_Id to the BSF.
>
> 9) BSF contacts the HSS over Zh.
>
> 10) The BSF prepares the Ks_(ext/int)_NAFand sends it to the ProSe KMF of
> UE-1. The ProSe KMF of UE-1 checks from the USS if the USIM is authorized to
> be used for ProSe services.
>
> 11) The ProSe KMF of UE-1 derives ProSe Direct Key from the Ks_(ext/int)_NAF
> and UE-2 ID, and generates ProSe Direct Key ID and lifetime for ProSe Direct
> Key.
>
> 12) The ProSe KMF of UE-1sends the parameters ProSe Direct Key, ProSe Direct
> Key ID and lifetime to ProSe KMF of UE-2 in ProSe key response over PC6. If
> the UE-1 and UE-2 are related to the same ProSe KMF, this step is omitted.
>
> 13) The ProSe KMF of UE-2 sends Retrieve ProSe Direct Key Response to UE-2.
> The response includes ProSe Direct Key, ProSe Direct Key ID and the
> lifetime.
>
> 14) UE-2 stores the ProSe Direct Key, ProSe Direct Key ID and the lifetime
> and sends Direct Communication Setup Response message to UE-1. The message
> includes UE-2 ID, NAF-ID, B-TID, Lifetime, ProSe Direct Key ID and Nonce-
> UE-2 protected with a MAC using ProSe Direct Key.
>
> 15) UE-1 derives the Ks_(ext/int)_NAF, and ProSe Direct Key similarly as the
> ProSe KMF of UE-1 did. UE-1 checks the MAC of the message using ProSe Direct
> Key.
NOTE 2: Steps 16 -18 for nonce based authentication are an optional part of
the solution and are not part of key establishment procedure. Also other
authentication mechanisms could be considered.
> Steps 16 -- 18 are performed only if authentication was desired by the UE-2
> by sending Nonce-UE-2 in step 14.
>
> 16) UE-1 sends Direct Communication Setup Accept message to UE-2. The
> message includes an \"ok\" and Nonce-UE-1 protected with a MAC using ProSe
> Direct Key. Also Nonce-UE-2 is taken into MAC calculation.
>
> 17) UE-2 checks the MAC. If MAC check is successful, UE-2 has authenticated
> UE-1, and UE-2 sends Direct Communication Setup Complete message to UE-1.
> The message includes an \"ok\" protected with a MAC using ProSe Direct Key.
> Also Nonce-UE-1 is taken into MAC calculation.
>
> 18) Upon receiving the Direct Communication Setup Complete message, the UE-1
> checks the MAC. If MAC check is successful, UE-1 has authenticated UE-2.
#### 8.2.1.2 Solution #8.2.1.2 Security for in coverage one-to-one direct
communication using GBA for transport of direct communication key
##### 8.2.1.2.1 General
This solution uses GBA to transport a direct communication key from the KMS to
UEs involved in one-to-one communications. The transported direct
communication key can be used for mutual authentication and securing
communications on PC5.
The solution re-uses the principles of key establishment between a UICC
hosting device and a remote device specified in TS 33.259 [34].
The solution is primarily targeted for one-to-one direct communication as it
assumes that both UEs are in network coverage. However, the solution also
applies to provide security between the Remote UE and UE-to-Network Relay in
case the Remote UE happens to be in network coverage.
Editor\'s Note: The applicability of this solution to UE-to-Network Relay case
depends on the SA2 reply on the UE-to-Network Relay capabilities.
##### 8.2.1.2.2 Solution description
**Figure 8.2.1.2.2-1: Procedure for one-to-one security**
> NOTE 1: This solution requires network coverage for UE-1 only in the
> beginning to run GBA bootstrapping.
The procedure for one-to-one security is described in figure above for the
general case when the Remote UE and UE-to-Network Relay are related to
different HPLMNs, and therefore to different ProSe KMFs. In case UE-1 and UE-2
are related to the same KMS and HPLMN, the functionality of ProSe KMF of UE-1
and ProSe KMF of UE-2 is combined into one ProSe KMF and steps 6 and 12 are
omitted in the flow.
UE-2 has established secure channel over PC3/PC8.
> 1) UE-1 has run GBA bootstrapping with its BSF.
>
> 2) UE-1 and UE-2 have discovered each other using either Model A or Model B.
>
> 3) UE-1 sends a Direct Communication Setup Request message to UE-2 in order
> to trigger the establishment of secure link over PC5. The request includes
> UE-1 ID, B-TID and NAF-ID (which identifies the ProSe KMF of UE-1 acting as
> NAF).
>
> 4) UE-2 sends a Retrieve ProSe Direct Key Request to the ProSe KMF of UE-2.
> The request includes B-TID, UE-1 ID, UE-2 ID and NAF-Id identifying the
> ProSe KMF of UE-1.
>
> 5) The ProSe KMF of UE-2 checks if a UE from the HPLMN associated to the
> NAF_Id is authorized to set-up security over PC5 with UE-1.
>
> 6) The ProSe KMF of UE-2 sends a ProSe key request over PC6 to ProSe KMF of
> UE-1. The request includes B-TID, UE-1 ID, UE-2 ID.. If the UE-1 and UE-2
> are related to the same ProSe KMF, this step is omitted.
>
> 7) The ProSe KMF of UE-1checks if the UE-1 is authorized to set-up security
> over PC5 with a UE belonging to HPLM of UE-2.
>
> 8) If the authorization is successful, the ProSe KMF of UE-1sends the B-TID
> and NAF_Id to the BSF.
>
> 9) BSF contacts the HSS over Zh.
>
> 10) The BSF prepares the Ks_(ext/int)_NAFand sends it to the ProSe KMF of
> UE-1. The ProSe KMF of UE-1 checks from the USS if the USIM is authorized to
> be used for ProSe services.
>
> 11) The ProSe KMF of UE-1 derives ProSe Transport Key from the
> Ks_(ext/int)_NAFand UE-2 ID. The ProSe KMF of UE-1 and generates ProSe
> Direct Key ID and lifetime for ProSe Direct Key. The ProSe KMF of UE-1 then
> protects (i.e. encrypts and integrity protects) the ProSe Direct Key with
> ProSe Transport Key.
>
> 12) The ProSe KMF of UE-1sends the parameters ProSe Direct Key, ProSe Direct
> Key ID, Protected(ProSe Direct Key) and the lifetime to ProSe KMF of UE-2 in
> ProSe key response over PC6. If the UE-1 and UE-2 are related to the same
> ProSe KMF, this step is omitted.
>
> 13) The ProSe KMF of UE-2 sends Retrieve ProSe Direct Key Response to UE-2.
> The response includes ProSe Direct Key, ProSe Direct Key ID, Protected(ProSe
> Direct Key) and the lifetime.
>
> 14) UE-2 stores the ProSe Direct Key, ProSe Direct Key ID and the lifetime
> and sends Direct Communication Setup Response message to UE-1. The message
> includes UE-2 ID, NAF-ID, B-TID, lifetime, ProSe Direct Key ID,
> Protected(ProSe Direct Key) and Nonce-UE-2 protected with a MAC using ProSe
> Direct Key.
>
> 15) UE-1 derives the Ks_(ext/int)_NAFand ProSe Transport Key similarly as
> the KMS did. Then UE-1 unprotects (decrypts and check integrity of) ProSe
> Direct Key with ProSe Transport Key. UE-1 checks the MAC of the message
> using ProSe Direct Key.
NOTE 2: Steps 16 -18 for nonce based authentication are an optional part of
the solution and are not part of key establishment procedure. Also other
authentication mechanisms could be considered.
> Steps 16 -- 18 are performed only if authentication was desired by the UE-2
> by sending Nonce-UE-2 in step 14.
>
> 16) UE-1 sends Direct Communication Setup Accept message to UE-2. The
> message includes an \"ok\" and Nonce-UE-1 protected with a MAC using ProSe
> Direct Key. Also Nonce-UE-2 is taken into MAC calculation.
>
> 17) UE-2 checks the MAC. If MAC check is successful, UE2- has authenticated
> UE-1, and UE-2 sends Direct Communication Setup Complete message to UE-1.
> The message includes an \"ok\" protected with a MAC using the ProSe Direct
> Key. Also Nonce-UE-1 is taken into MAC calculation.
>
> 18) Upon receiving the Direct Communication Setup Complete message, the UE-1
> checks the MAC. If MAC check is successful, UE-1 has authenticated UE-2.
#### 8.2.1.3 Solution #8.2.1.3: One to one security using GBA push for direct
communication key
##### 8.2.1.3.1 Solution overview
Clause 8.2.1 collects solutions for one to one security when at least one UE
is in network coverage. The UE2 is always in network coverage. Solution #8.1.2
\"Security between Remote UE and UE-to-Network Relay using GBA push for direct
communication key\" describes a solution for UE-to-Network Relay security.
Solution #8.1.2 to secure the UE-to-Network Relay described in clause 8.1.2
can be used also to provide security for one-to-one communication case.
##### 8.2.1.3.2 Solution procedures
This solution uses the same procedures as solution #8.1.2 described in clause
8.1.2 with the change that the UE-1 takes the role of Remote UE and UE-2 takes
the role of UE-to-Network Relay.
#### 8.2.1.4 Solution #8.2.1.4: One to one security using GBA push for
transport of direct communication key
##### 8.2.1.4.1 Solution overview
Clause 8.2.1 collects solutions for one to one security when at least one UE
is in network coverage. The UE2 is always in network coverage. Solution #8.1.3
\"Security between Remote UE and UE-to-Network Relay using GBA push for
transport of direct communication key\" describes a solution for UE-to-Network
Relay security. Solution #8.1.3 to secure the UE-to-Network Relay described in
clause 8.1.3 can be used also to provide security for one-to-one communication
case.
##### 8.2.1.4.2 Solution procedures
This solution uses the same procedures as solution #8.1.3 described in clause
8.1.3 with the change that the UE-1 takes the role of Remote UE and UE-2 takes
the role of UE-to-Network Relay.
#### 8.2.1.5 Solution #8.2.1.5 Security for in coverage one-to-one direct
communication and UE-to-Network Relay using GBA and GBApush
##### 8.2.1.5.1 General
> Editor\'s Note: It is ffs how this solution works with the PC4a network
> option. Especially, how the step for bootstrapping can be done in that case.
This solution is a combination of solutions #8.1.2 and #8.2.1.1. It uses
B-TID/Ks obtained from GBA bootstrapping whenever possible and uses GBApush
only when the B-TID/Ks are not available, i.e. have been lost of expired and
GBA bootstrapping is not possible, e.g. due to one of the UEs being out of
coverage for key establishment between two UEs for one-to-one direct
communication. The established direct communication key can be used for mutual
authentication and securing communications on PC5.
The solution is compatible with Solution #8.2.2.2: General security
establishment for one-to-one communications.
The solution is intended for both one-to-one direct communication and
communication between the Remote UE and UE-to-Network Relay.
##### 8.2.1.5.2 Security procedure for one-to-one security
**Figure 8.2.1.5.2-1: Procedure for one-to-one security**
NOTE: This solution requires network coverage for UE-1 only in the beginning
to run GBA bootstrapping.
The procedure for PC5 security is similar for both one-to-one and UE-to-
Network relay case. In the following UE-1 is used to mean UE-1 in one-to-one
case and the Remote UE in UE-to-Network Relay case. Similarly, UE-2 is used to
mean UE-2 in one-to-one case and the Relay in UE-to-Network Relay case. It is
described in figure 8.2.1.5.2-1 above for the general case when UE-1 and UE-2
are related to different HPLMNs, and therefore to different ProSe KMFs. In
case UE-1 and UE-2 are related to the same ProSe KMF and HPLMN, the
functionality of ProSe KMF of UE-1 and ProSe KMF of UE-2 is combined into one
ProSe KMF and steps 6 and 9 are omitted in the flow.
UE-2 has established secure channel over PC8. The UE and ProSe KMF are
required to store the last used B-TID between them with associated IMSI even
though the B-TID would be expired. The purpose is to use B-TID as a temporary
UE identity. This helps to maintain user privacy.
> 1) UE-1 has run GBA bootstrapping with its BSF. This may be done as part of
> establishing security for PC8.
>
> 2) UE-1 and UE-2 have discovered each other using either Model A or Model B.
>
> 3) UE-1 sends a Direct Communication Setup Request message to UE-2 in order
> to trigger the establishment of secure link over PC5. The request includes
> UE-1 ID (IMSI or B-TID), DKSI (this gives the values of the Key Set
> Identifier for a security context created from the PDK), NAF-ID (which
> identifies the ProSe KMF of UE-1 acting as NAF), UE-1 supported security
> algorithms, and Nonce-UE-1.
The UE will send either B-TID or IMSI but not both in the \"UE-1_ID\"
parameter according to the following rules.
\- If the UE has a valid B-TID and related Ks available, the B-TID is sent.
\- If the UE has a B-TID, but it is expired, the UE runs bootstrapping if
possible, and the new B-TID is sent
\- If the UE has a B-TID, but it is expired and bootstrapping is not possible,
the B-TID is sent only if it has been previously used between the UE and the
PKMF.
\- If the UE does not have a B-TID, the UE runs bootstrapping if possible, and
the new B-TID is sent.
\- If the UE does not have a B-TID, and bootstrapping is not possible, IMSI is
sent.
\- If the UE has previously received bootstrapping renegotiation request to an
outbound Direct Communication Setup Request, but was not able to run
bootstrapping, IMSI is sent,
> 4) UE-2 sends a Retrieve ProSe Direct Key Request to the PKMF of UE-2. The
> request includes UE-1 ID (B-TID or IMSI), UE-2 ID (i.e. the ProSe UE ID) and
> NAF-Id identifying the ProSe KMF of UE-1.
>
> 5) The ProSe KMF of UE-2 checks if a UE from the HPLMN associated to the
> NAF-ID is authorized to set-up security over PC5 with UE-2.
>
> 6) The ProSe KMF of UE-2 sends a ProSe key request over PC6 to ProSe KMF of
> UE-1. The request includes UE-1 ID (B-TID or IMSI), UE-2 ID (i.e. the ProSe
> UE ID) and NAF-Id identifying the ProSe KMF of UE-1. If the UE-1 and UE-2
> are related to the same ProSe KMF, this step is omitted.
>
> 7) The behaviour of ProSe KMF of UE-1 is as follows:
When receiving a B-TID:
\- 7a) If the B-TID and related Ks_(ext/int)_NAF are found at ProSe KMF, and
are valid, the ProSe KMF of UE-1checks if the UE-1 (associated to the B-TID)
is authorized to set-up security over PC5 with a UE belonging to HPLMN of
UE-2. If the authorization is successful, processing continues in step 8.
\- 7b) If the BTID and related Ks_(ext/int)_NAF are found at ProSe KMF, but
they are not valid (e.g. expired or too old for PKMF policy), the ProSe KMF of
UE-1checks if the UE-1 (associated to the B-TID) is authorized to set-up
security over PC5 with a UE belonging to HPLMN of UE-2. If the authorization
is successful, then the ProSe KMF requests GPI and NAF keys from the BSF.
Processing continues in step 8.
> NOTE 1: The ProSe KMF could also send bootstrapping renegotiation request in
> this case. However, using GBA push is the preferred choice as GBApush is
> also a bootstrapping but with less signalling. The benefit of using regular
> bootstrapping over Ub would the possibility to share the Ks with other
> applications, but this is not considered to be significant benefit in the
> public safety case. Also, the UE is likely out of coverage and could not run
> bootstrapping anyway.
\- 7c) If the B-TID is not found at ProSe KMF, the ProSe KMF sends the B-TID
to the BSF to request for NAF keys. If the request is successful, the ProSe
KMF of UE-1checks if UE-1 (identified by information in the USS and associated
to the B-TID) is authorized to set-up security over PC5 with a UE belonging to
HPLMN of UE-2, and processing continues in step 8. If the request is not
successful, the ProSe KMF of UE-1 sends a bootstrapping re-negotiation request
towards the UE1. See clause 8.2.1.3.3.
> NOTE 2: If the request is not successful, the ProSe KMF sends the
> bootstrapping re-negotiation request towards the UE instead of using GBApush
> because the real identity of the UE is not known to the ProSe KMF. The UE is
> expected to come back with a new B-TID (if it was able to run bootstrapping)
> or with IMSI. The latter case will trigger GBApush to be used.
When receiving IMSI:
\- 7d) The ProSe KMF of UE-1checks if the UE-1 is authorized to set-up
security over PC5 with a UE belonging to HPLMN of UE-2. The IMSI will be
translated to an appropriate public user identity, if needed. Then the ProSe
KMF requests GPI and NAF keys from the BSF. Processing continues in step 8.
> 8) The ProSe KMF of UE-1 derives ProSe Direct Key from the Ks_(ext)_NAF and
> UE-2 ProSe UE ID.
>
> 9) The ProSe KMF of UE-1sends the ProSe Direct Key, to ProSe KMF of UE-2 in
> ProSe key response over PC6. If the UE-1 and UE-2 are related to the same
> ProSe KMF, this step is omitted. If GPI was received in step 7, then it is
> sent as well.
>
> 10) The ProSe KMF of UE-2 sends Retrieve ProSe Direct Key Response to UE-2.
> The response includes ProSe Direct Key. If GPI was received in step 9, then
> it is sent as well.
>
> 11) UE-2 derives KD~sess~ from PDK, Nonce-UE-1 and Nonce-UE-2 and
> confidentiality and integrity key keys from KD~sess~ and stores them with
> the DKSI.
>
> 12) UE-2 sends Direct Security Mode Command message to UE-1. The message
> includes UE-2 ID, DKSI, chosen security algorithms, UE-1 supported
> algorithms list and Nonce-UE-2 protected with a MAC using the derived
> integrity key. If GPI was received in step10, then it is sent as well.
>
> 13) If GPI was received in step 12, then UE-1 processes the GPI. Otherwise
> UE-1 uses the Ks_(ext)_NAF as indicated by the B-TID in step 3. UE-1 derives
> ProSe Direct Key similarly as the ProSe KMF of UE-1 did. UE-1 also derives
> KD~sess~ from PDK, Nonce-UE-1 and Nonce-UE-2 and confidentiality and
> integrity keys from KD~sess~ and stores them with the DKSI. UE-1 checks the
> MAC of the message using integrity key. UE-1 will not accept a Direct
> Security Mode Command if the UE-1supported algorithms list is different from
> what it sent in step 3.
>
> 14) UE-1 sends Direct Security Mode Complete message to UE-2protected with a
> MAC using integrity key. After this, all messages are integrity and
> confidentiality protected.
##### 8.2.1.3.3 Bootstrapping re-negotiation request
The ProSe KMF may send a bootstrapping re-negotiation request to UE-1 via
UE-2. The conditions for sending it and related functionality is described in
clause 8.2.1.5.2.
**Figure 8.2.1.3.3-1: Bootstrapping re-negotiation request**
> 1) Conditions for sending bootstrapping re-negotiation request are described
> in clause 8.2.1.5.2.
>
> 2) ProSe KMF of UE-1 sends the bootstrapping re-negotiation request to ProSe
> KMF of UE-2.
>
> 3) ProSe KMF of UE-2 relays the bootstrapping re-negotiation request to
> UE-2.
4) UE-2 sends the bootstrapping re-negotiation request to UE-1.
### 8.2.2 Solutions for one-to-one communications with both UEs out of
coverage
#### 8.2.2.1 Solution #8.2.2.1 Authentication and Key Agreement for one-to-one
ProSe communication using identity-based cryptography
The security solution uses The \"Elliptic Curve-based Certificateless
Signatures for Identity-based Encryption\" (ECCSI) signature scheme, as
defined in IETF RFC 6507. And Sakai-Kasahara Key Encryption (SAKKE) algorithm
used to exchange a shared secret from a Sender to a Receiver, as defined in
IETF RFC 6508.
Here it is assumed that the UEs are provisioned with credentials required by
ECCSI and SAKKE schemes during Group Member Discovery phase, as described in
clause 8.4.2.1 [\"Authentication and Key Agreement for ProSe Group Member
Discovery using identity-based cryptography\"]. The following sub-sections
describe secure one-to-one ProSe communication that may follow ProSe Group
Member Discovery with Model A or B.
Editor\'s note: Harmonisation of the contents on the Direct Communication
Request and Direct Communication Response message in all cases should be
considered. This could simplify the UE implementation and maybe make it easier
to align all case with any subsequent security set-up signalling.
Editor\'s note: Credentials are based on the identity of the user rather than
the identity of the UE. Since the Public safety user is not tied to any
particular UE, the credentials used for discovery need to follow the user. In
addition, a public safety user may be simultaneously signed into more than one
UE or other public safety device. In this case, the user should be
discoverable on any or all of the devices.
##### 8.2.2.1.1 Secure One-2-One Communication that follows ProSe Group Member
Discovery with Model A
Figure 8.2.2.1.1-1 illustrates secure one-to-one ProSe Direct communication
that follows ProSe Group Member Discovery with Model A, using ECCSI (as
described in clause 8.4.2.1.2.1).
{width="6.3493055555555555in" height="2.490972222222222in"}
Figure 8.2.2.1.1-1: Secure one-to-one layer-2 link setup that follows ProSe
Group Member Discovery with Model A
1\. A process of Group Member Discovery with Model A with security feature.
For more details, please refer to clause 8.4.2.1.2.1.
2\. Upon reception of the Announcement message, UE-2 (in the role of
\"monitoring UE\") verifies the signature payload SIGN. If the verification
test is successful, UE-2 presents the authenticated identity (\"Announcer
Info\") to the user of UE-2. If user of UE-2 decides to establish a secure
layer-2 link for one-to-one ProSe Direct Communication, UE-2 sends a Direct
Communication Request message including the following parameters:
\- User of UE-2 Info = upper layer information about the user of UE-2. This
information is used to derive the Signer\'s identifier (used by ECCSI).
\- SIGN -- an ECCSI signature of the Direct Communication Request message. The
signature may be computed over all or a subset of the parameters in the
message. At a minimum the signature is computed over the User of UE-2 Info
parameter.
\- SAKKE -- UE-2 generates a Shared Secret Value (SSV) and encodes it into a
SAKKE payload according to the algorithm described in IETF RFC 6508, using the
KMS Pubic Key and the public identity of the UE-1\'s user (Announcer Info).
3\. Upon reception of the Direct Communication Request message, UE-1 verifies
the signature payload SIGN. If the verification test is successful, UE-1
presents the authenticated identity (\"User of UE-2 Info\") to the user of
UE-1. If user of UE-1 decides to accept the request, UE-1 sends a Direct
Communication Response message. The Direct Communication Response message is
encrypted using a key derived from the Shared Secret Value contained in the
SAKKE payload received in step 2.
##### 8.2.2.1.2 Secure one-to-one Communication that follows Group Member
Discovery with Model B
Figure 8.2.2.1.2-1 illustrates secure one-to-one ProSe Direct communication
that follows ProSe Group Member Discovery with Model B, using ECCSI (as
described in clause 8.4.2.1.2.2).
{width="6.346527777777778in" height="3.3201388888888888in"}
Figure 8.2.2.1.2-1: Secure one-to-one layer-2 link setup that follows Group
Member Discovery with Model B
1\. A process of Group Member Discovery with Model B discovery with security
feature. For more details, please refer to clause 8.4.2.1.2.2.
2\. Please refer to clause 8.4.2.1.2.2. Please Note that the inclusion of the
SAKKE payload in the Response message is optional, as stated in clause
8.4.2.1.2.2.
3a. Upon reception of the discovery announcement in step 2, identity of the
UE-1 is presented to the user of UE-2. If the user of UE-1 decides to engage
in one-to-one communication, UE-1 sends a Direct Communication Request
message, including the following parameters:
\- User Info of UE-1 = upper layer information about the user of UE-1. This
information is used to derive the Signer\'s identifier (used by ECCSI).
\- SIGN -- an ECCSI signature of the Direct Communication Request message. The
signature may be computed over all or a subset of the parameters in the
message. At a minimum the signature is computed over the User info of UE-1
parameter.
3b. Upon reception of the Direct Communication Request message, UE-2 verifies
the signature payload SIGN. If the verification test is successful, UE-2
presents the authenticated identity (\"User of UE-1 Info\") to the user of
UE-2. If user of UE-2 decides to accept the request, UE-2 sends a Direct
Communication Response message, including the following parameters:
\- User Info UE-2 = upper layer information identifying the user of UE-2. This
information is used to derive the Signer\'s identifier (used by ECCSI).
\- SIGN -- an ECCSI signature of the Direct Communication Response message.
The signature may be computed over all or a subset of the parameters in the
message. At a minimum the signature is computed over the User of UE-2 Info
parameter:
\- SAKKE -- UE-2 generates a Shared Secret Value (SSV) and encodes it into a
SAKKE payload according to the algorithm described in IETF RFC 6508, using the
KMS Pubic Key and the public identity of the UE-1 user. Upon receipt of the
Direct Communication Response message, the UE-1 verifies the signature payload
SIGN. If the verification test is successful, it decrypts SAKKE payload to
extract the SSV which is used to encrypt all subsequent data exchanged between
the two UEs,
4a. Upon reception of the solicitation message in step 1, identity of the UE-3
is presented to the user of UE-1. If the user of UE-3 decides to engage in
one-to-one communication, UE-3 sends a Direct Communication Request message,
including the following parameters:
\- User Info of UE-3 = upper layer information about the user of UE-3. This
information is used to derive the Signer\'s identifier (used by ECCSI).
\- SIGN -- an ECCSI signature of the Direct Communication Request message. The
signature may be computed over all or a subset of the parameters in the
message. At a minimum the signature is computed over the User info of UE-3
parameter.
4b. Upon reception of the Direct Communication Request message, UE-1 verifies
the signature payload SIGN. If the verification test is successful, UE-1
presents the authenticated identity (\"User of UE-3 Info\") to the user of
UE-1. If user of UE-1 decides to accept the request, UE-1 sends a Direct
Communication Response message, including the following parameters:
\- User Info UE-1 = upper layer information identifying the user of UE-1. This
information is used to derive the Signer\'s identifier (used by ECCSI).
\- SIGN -- an ECCSI signature of the Direct Communication Response message.
The signature may be computed over all or a subset of the parameters in the
message. At a minimum the signature is computed over the User of UE-1 Info
parameter:
\- SAKKE -- UE-1 generates a Shared Secret Value (SSV) and encodes it into a
SAKKE payload according to the algorithm described in IETF RFC 6508, using the
KMS Pubic Key and the public identity of the UE-1 user. Upon receipt of the
Direct Communication Response message, the UE-3 verifies the signature payload
SIGN. If the verification test is successful, it decrypts SAKKE payload to
extract the SSV which is used to encrypt all subsequent data exchanged between
the two UEs, encrypted using a key derived from the Shared Secret Value
contained in the SAKKE payload received in step 3a.
##### 8.2.2.1.3 Secure one-to-one layer-2 link setup without prior Group
Member discovery
Figure 8.2.2.1.3-1 illustrates secure one-to-one ProSe Direct communication
without prior discovery (or without prior secure discovery). This is possible
if e.g. the two UEs have been previously involved in one-to-many ProSe direct
communication, allowing UE-1 to learn the Layer-2 ID of UE-2.
{width="5.459722222222222in" height="1.9368055555555554in"}
Figure 8.2.2.1.3-1: One-to-one layer-2 link setup without prior discovery
1\. UE-1 wishing to engage in one-to-one ProSe Direct Communication with UE-2
sends a Direct Communication Request message including the following
parameters:
\- User of UE-1 Info = upper layer information identifying the user of UE-1.
This information is used to derive the Signer\'s identifier (used by ECCSI).
\- SIGN -- an ECCSI signature of the Direct Communication Request message. The
signature may be computed over all or a subset of the parameters in the
message. At a minimum the signature is computed over the User of UE-1 Info
parameter.
2\. Upon reception of the Direct Communication Request message, UE-2 verifies
the signature payload SIGN. If the verification test is successful, UE-2
presents the authenticated identity (\"User of UE-1 Info\") to the user of
UE-2. If user of UE-2 decides to accept the request, UE-2 sends a Direct
Communication Response message including the following parameters:
\- User of UE-2 Info = upper layer information identifying the user of UE-2.
This information is used to derive the Signer\'s identifier (used by ECCSI).
\- SIGN -- an ECCSI signature of the Direct Communication Response message.
The signature may be computed over all or a subset of the parameters in the
message. At a minimum the signature is computed over the User of UE-2 Info
parameter.
\- User of Discoveree Info = upper layer information identifying the user of
Discoveree UE. This information is used to derive the Signer\'s identifier
(used by ECCSI).
\- SIGN -- an ECCSI signature of the Direct Communication Response message.
The signature may be computed over all or a subset of the parameters in the
message. At a minimum the signature is computed over the User of Discoveree
Info parameter.
SAKKE -- Discoveree UE generates a Shared Secret Value (SSV) and encodes it
into a SAKKE payload according to the algorithm described in IETF RFC 6508,
using the KMS Pubic Key and the public identity of the Remote UE\'s user. Upon
receipt of the Direct Communication Response message, the Discoverer UE
verifies the signature payload SIGN. If the verification test is successful,
it decrypts SAKKE payload to extract the SSV which is used to encrypt all
subsequent data exchanged between the two UEs.
##### 8.2.2.1.4 Solution Evaluation
1) The proposed solution provides a common method for establishment of secure
communication for both \"UE-to-UE\" (clause 8.2.2.1.3) and \"Remote-UE to
ProSe UE-to-Network-Relay\" (clause 8.1.11) cases.
2) The proposed solution enables UEs to establish secure communication even
between UEs that do not belong to the same group.
3) The proposed solution uses identity-based cryptography similar to that used
for media security with one-to-many ProSe Direct Communication defined in
Rel-12.
#### 8.2.2.2 Solution #8.2.2.2: General security establishment for one-to-one
communications
##### 8.2.2.2.1 Solution overview
This solution show a method of establishing the security for on-to-one
communications that could be used for all cases that one-to-one communication
is used.
##### 8.2.2.2.2 Solution description
Like in standard LTE, there is will be a key set identifier, called a K~D~ ID
associated with the D2D root key, called KD, of the security context, and
these play the same roles as eKSI and KASME in standard LTE. KD is generated
per pair of UEs. It is proposed to use Nonces to ensure fresh keys at each
connection.
The list of security parameters is broken down into three sets to reflect the
parameters needed for the following states (each state is with respect to a
particular other UE):
\- D2D-Provisioned-Security: the UE has everything it needs to start the
process of communicating with another UE, but no security parameters or any
info about the other UE.
\- D2D-Partial-Security: the UE has connected to another UE and retained some
security parameters for use with that UE.
\- D2D-Full-Security: the UE is actually connected to another UE and
transmitting and/or receiving data.
Editor\'s Note: This breakdown of states would need to be aligned with any SA2
and/or RAN work. It is included here at this stage to help with the
description of proposed solution.
Stored parameters while in D2D-Provisioned-Security are as follows:
\- D2D authorization parameters that give the UE permission to use D2D direct
communications
\- Set of security algorithms that it is willing to use for direct connections
-- this may be reduced from complete set supported by the UE by the
authorization parameters ruling out some algorithms, e.g. Null confidentiality
only
\- The Long term keys etc. that will be used to establish the keys between UEs
NOTE: The Long term key that is provisioned into the UE and is the root of the
security for one-to-one communications (including the use of UE-to-network
relay uses of one-to-one communications). It may be a symmetric key or
public/private key pair depending on the particular use case. Examples of Long
term keys include the IDENTITY credentials of solution #8.2.2.1 and the PRUK
for solution #8.1.7.
Stored parameters while in D2D-Partial-Security are as follows:
\- Everything from D2D-Provisioned-Security
\- Key set identifier, KD ID, which plays the role of eKSI in LTE
\- D2D Root key, KD, which plays of the role of KASME in LTE
Stored parameters while in D2D-Full-Security are as follows:
\- Everything from D2D-Partial-Security
\- (At least held implicitly), a pair of NONCES (one from each UE) that are
used to calculate KD-sess :
\- KD-SESS, the session key to be used for deriving further keys to protect
the traffic between UEs -- this is the equivalent of KeNB from LTE
\- The confidentiality and integrity algorithms that are chosen to protect the
traffic between UEs
\- The keys that are used in the above algorithms
\- The PDCP counts or ProSe equivalent parameters that are used at the RAN
layer as inputs to the ciphering and integrity algorithms
Once a UE ends its communication session with another UE, it deletes
K~D-sess~, PEK and PIK, the choice of algorithms and the counters. It may also
delete K~D~.
##### 8.2.2.2.3 Security procedures
##### 8.2.2.2.3.1 Connection establishment {#connection-establishment .H6}
The establishment of security then follows a Direct Communication Request (see
clause 7.1.2.1 of TR 23.713[32]) as shown in figure 8.2.2.2.3.1-1.
Figure 8.2.2.5.3-1: Direct Security mode procedure
1\. UE_1 has sent a Direct Communication Request (see TR 23.713) to UE_2. This
message includes Nonce_1 (for session key generation), UE_1 security
capabilities (the list of algorithms that UE_1 is OK to use in this
connection) and the most significant bits of the KD-sess ID. These bits are be
chosen such that UE_1 will be able to locally identify a security context that
is created by this procedure. The message may also include a KD ID if the UE_1
has an existing KD with the UE that it trying to communicate with. The absence
of the KD ID parameter indicates that UE_1 does not have a KD for UE_2. The
messagealso contains the necessary information to establish a KD from the
relevant long terms keys held on the UE. Long-term ID is the info needed by
the UE_2 in order to retrieve the right Long-term Key.
Editor\'s note: Identities related to user may be included in the Direct
Communication Request where these identities help identify the keying material
that will be used to establish the secure session, e.g. if the one-to-many
communications key PGK is used to establish the security, then Group ID would
be included in the Direct Communication Request.
2\. UE_2 may initiate a Key establishment procedure with UE_1. This is
mandatory if the UE_2 does not have a K~D~ ID and KD pair and signalling is
needed to establish the keys for the particular use case.
NOTE: Authentication signalling is exchanged between the UEs (and possibly
with entities in the network for ProSe UE-to-network relay case) to derive the
K~D~. The exact format of the signalling depends of the use case -- see the
proposed one-to-one communications and UE-to-network relay solutions for
examples.
3\. UE_2 sends the Direct Security Mode Command to UE_1. It includes the most
significant bits of KD ID if a fresh KD is generated, Nonce_2 to allow a
session key to be calculated and the Chosen_algs parameter to indicate which
security algorithms the UEs will use to protect the data. The included bits of
KD ID will uniquely identify the KD at UE_2. UE_2 also returns the UE_1
security capabilities parameter to protect them from man-in-the-middle
attacks. UE_2 also includes the least significant bits of K~D-sess~ ID in the
messages. This bits are chosen so that UE_2 will be able to locally identify a
security context that is created by this procedure. UE_2 calculates K~D-Sess~
from K~D~ and Nonce_1 and Nonce_2 and then derives the confidentiality and
integrity keys based on the chosen algorithms (Annex A.4). UE_2 then integrity
protects the Direct Security Mode Command before sending it to UE_1. UE_2 is
then ready to receive both signalling and user plane traffic protected with
the new security context. UE_2 forms the K~D-sess\ ID~ from the most
significant bits it received in message 1 and least significant bits it sent
in message 3.
Editor\'s note: Necessary protection against bidding down attack on K~D~
generation is FFS.
4\. On receiving the Direct Security Mode Command, UE_1 calculates K~D-sess~
and the confidentiality and integrity keys in the same way as UE_2. UE_1
checks that the returned UE_1 security capabilities are the same as those it
sent in step 1. UE_1 also checks the integrity protection on the message. If
both these checks pass, then UE_1 is ready to send and receive signalling and
user traffic with the new security context. If most significant bits of K~D~
ID were included in the Direct Security Mode Command, UE_1 generates the least
significant bits of K~D~ ID such that these bits uniquely identify K~D~ at
UE_1 and shall store the complete K~D~ ID with K~D~. UE_1 sends an integrity
and confidentiality protected Direct Security Mode Complete message to UE_2.
UE_1 includes the least significant bits of K~D~ ID in this message. UE_1
forms the K~D-sess~ ID from the most significant bits it sent in message 1 and
least significant bits it received in message 3.
5\. UE_2 checks the integrity protection on the received Direct Security Mode
Complete. If this passes, UE_2 is now ready to send user plane and signalling
traffic protected with the new security context. UE_2 deletes any old security
context is has for UE_1. UE_2 forms the K~D~ ID from the most significant bits
it sent in step 3 and least significant bits it received in the Direct
Security Mode Complete. If the most significant bits of K~D~ ID were included
in the Direct Security Mode Command, UE_2 uses the least significant bits of
K~D~ ID to construct the K~D~ ID and stores the complete K~D~ ID with K~D~.
###### 8.2.2.2.3.2 Rekeying security
Either UE may rekey the connection at any time. This is done before the
counter for a particular LCID repeats with the current keys. A rekeying
operation refreshes the K~D-sess~ and PEK and PIK, and may refresh K~D~. A
rekeying operation follows the flows given in figure 8.2.2.2.3.2-1.
NOTE 1: The UE that initiates a rekeying does not need to be the same one that
imitated the connection set-up.
{width="7.113888888888889in" height="4.270138888888889in"}
**Figure 8.2.2.2.3.2-1: Security establishment during rekeying**
1\. UE_1 sends a Direct Rekey Request to UE_2. This message includes Nonce_1
(for session key generation), UE_1 security capabilities (the list of
algorithms that UE_1 will accept for this connection) and the most significant
bits of the K~D-sess\ ID~. These bits are chosen such that UE_1 will be able
to locally identify a security context that is created by this procedure. The
message may also include a Re-auth Flag, if UE_1 wants to rekey K~D~. The
message also contains the necessary information to establish a K~D~ from the
relevant long terms keys held on the UE.
2\. UE_2 may initiate a Direct Auth Key Establish procedure with UE_1. This is
mandatory if UE_1 included the Re-auth Flag and signalling is needed to
establish K~D.~
3\. This step is the same as step 3 in 8.2.2.2.3.1 except the most significant
bits of K~D~ ID are included if a fresh K~D~ is generated during this
rekeying.
4\. This step is the same as step 4 in 8.2.2.2.3.1.
5\. This step is the same as step 5 in 8.2.2.2.3.1.
6\. When UE_1 receive a message integrity protected with the new security
context, it deletes any old security context is has for the other UE_2.
##### 8.2.2.2.4 Protection of the one-to-one traffic
##### 8.2.2.2.4.1 General {#general-32 .H6}
Protection for the traffic between the UEs is provided at the PDCP layer. As
the security is not preserved through a drop of the connection, all signalling
messages that are need to be sent before security is established may be sent
with no protection.
> Editor\'s note: This exact message that may be sent without protection are
> FFS.
All other messages are both integrity and confidentiality protected except the
Direct Security Mode Command which is sent integrity protected only.
The bearer with LCID = 0 is used to carry signalling messages that are not
protected.
The bearer with LCID = 1 is used for Direct Security Mode Command and Direct
Security Mode Complete.
The bearer with LCID = 2 is used for signalling messages that are
confidentiality and integrity protected.
The bearer with LCID = 3 to 31 may be used for user plane traffic with
confidentiality protection.
##### 8.2.2.2.4.2 Integrity protection {#integrity-protection .H6}
ProSe enabled Public Safety UEs implements 128-EEA1 and 128-EEA2 and may
implement 128-EEA3 for ciphering one-to-one traffic.
The LTE ciphering algorithms (see TS 33.401 [21]) are used with the following
modifications;
\- The key used is PIK;
\- Direction is set to 1 for traffic transmitted by the UE that sent the
Direct Security Mode Command for this security context and 0 otherwise;
\- Bearer[0] to Bearer[4] are set to LCID;
\- COUNT[0] to COUNT[15] are set to KD-sess ID;
\- Counter is input into COUNT[16] to COUNT[31].
The receiving UE ensures that received messages are not replayed.
##### 8.2.2.2.4.3 Confidentiality protection {#confidentiality-protection .H6}
ProSe enabled Public Safety UEs implements EEA0, 128-EEA1 and 128-EEA2 and may
implement 128-EEA3 for ciphering one-to-one traffic.
The LTE ciphering algorithms (see TS 33.401 [21]) are used with the following
modifications;
\- The key used in PEK;
\- Direction is set as for integrity protection (see 8.2.2.2.4.2);
\- Bearer[0] to Bearer[4] are set to LCID;
\- COUNT[0] to COUNT[15] are set to K~D-sess~ ID;
\- Counter is input into COUNT[16] to COUNT[31].
##### 8.2.2.2.4.4 Security contents in the PCDP header {#security-contents-in-
the-pcdp-header .H6}
The 16-bit K~D-sess~ ID and 16-bit Counter parameters are carried in the PDCP
header, along with any MAC that is needed for integrity protection. This is
illustrated in the Figure 8.2.2.2.4.4-1.
{width="4.905555555555556in" height="0.2604166666666667in"}
**Figure 8.2.2.2.4.4-1: Security contexts of the PDCP header for one-to-one
communications**
#### 8.2.2.3 Solution #8.2.2.3: One-to-one communications using the group key
##### 8.2.2.3.1 Solution overview
This solution shows how to members of the same group could use their pre-
provisioned group key to establish one-to-one communications.
NOTE: This solution does not provide protection from other members of the
group.
##### 8.2.2.3.2 Security procedures
Before the UEs start the process of establishing the one-to-one communication
session, it is necessary that both UEs have obtained any needed authorisation
to perform one-to-one communication, and have obtained the PGK(s) for their
group. The establishment of the one-to-one communication session is as shown
in figure 8.2.2.3.2-1.
Figure 8.2.2.3.2-1: Security set-up using PGK (the one-to-many communication
group key)
1: UE_1 sends the Direct Communication Request message to UE_2. UE_1 include
Group ID, PGK ID of the PGK it would use to send one-to-many communications
for this group (see TS 33.303 [33]), Nonce_1 (a random number) and a DKSI
(this gives the values of the Key Set Identifier for a security context
created from the PGK).
2: UE_2 checks that the suggested PGK ID is one that it would be accept to
receive one-to-many communication with (see TS 33.303). If so, it generates
Nonce_2 (a random number) calculates KD-SESS (the key that will be used to
protect this one-to-one communication session).
3: UE_2 then sends a Direct Security Mode Command message to UE_1 (as
described in subclause 8.2.2.2.3). It includes the DKSI from step 1 to
indicate the security context used to protect this message and Nonce_2. This
message is integrity protected with an integrity key generated from the KD-
SESS.
4: UE_1 retrieves Nonce_2 from the Direct Security Mode Command message and
calculates KD-SESS from the PGK, Nonce_1 and Nonce_2. It then checks the
integrity protection of the message using the integrity algorithm indicated in
the messages (see 8.2.2.2.3) and an integrity key generated from the KD-SESS.
5: UE_1 responds to UE_2 with a Direct Security Mode Complete message which is
integrity protected.
### 8.2.3 Media layer solutions
#### 8.2.3.1 Solution #8.2.3.1: Media-plane security
##### 8.2.3.1.1 General
This solution addresses the requirements in key issue 7.2.1, 7.2.2, and 7.2.3
in a way that may be applied to both the ProSe use-case and other use-cases.
##### 8.2.3.1.2 Overview of solution
End-to-end media-plane encryption (e.g. SRTP) is applied to the communication
data to provide confidentiality. Key management and authentication is provided
via the signalling layer of the communication (e.g. IMS/SIP).
Editor\'s Note: The technical details of the media-layer security solution(s)
are FFS.
## 8.3 Solutions for direct discovery (non-Public Safety)
### 8.3.1 Solution #8.3.1: Authorisation for restricted ProSe direct discovery
The authorisation procedure for restricted ProSe direct discovery can be
referenced to SA2\'s TR 23.713[32].
### 8.3.2 Solution #8.3.2: Security for restricted discovery
#### 8.3.2.1 General
This solution addresses Key Issue #7.3.1 in the present document and is a
proposal for the security part of solution in clause 5 of TR 23.713 [32]. In
particular it addresses the discovery, impersonation, replay and tracking
requirements.
#### 8.3.2.2 Tracking of UEs using restricted discovery announcements
The risk of tracking of a UE by passive receivers in proximity exists if the
same announcement is repeatedly sent on PC5.
To mitigate against this attack, the ProSe identifiers announced/broadcasted
over the air by a UE should change from announcement to announcement, in a
manner not easily predictable by any passive receiver. Naturally, given this
is restricted discovery, the UEs that have been authorized to discover a UE
are able to understand the next ProSe identifier the UE in question uses.
Fresh input to the calculation can be provided by the same method as used to
calculate the MIC in open direct discovery.
#### 8.3.2.3 Protecting restricted discovery ProSe Codes
A class of solutions that readily suggest themselves involve using a
fresh/non-repeatable known value in order to generate new and different
Temporary ID values used in the PC5 discovery message from the ProSe Code
provided to the UE. Necessarily, the construction of such Temporary IDs are
non-reversible, i.e. a passive attacker should not be able to determine the
underlying ProSe Code from the knowledge of the announcedTemporary ID.
In order to provide freshness, it is proposed to use the same UTC-based
counter that is used for open direct discovery (see TS 33.303 [33]). The
TempID that is sent over the air is then calculated as shown in figure
8.3.2.3-1.
{width="6.075694444444444in" height="1.9430555555555555in"}
Figure 8.3.2.3-1: Calculation of the identity to be sent over PC5 in
restricted discovery messages
The receiver of such TempID compares it to locally-generated TempID
corresponding to all the ProSe Codes that are of interest to that UE. The
receiving UE has the exact same information to generate the OTA ProSe ID as
the announcer UE (this includes the UTC-based counter).
This solution only works with the entire ProSe Code of the Discovery Filter at
the receiving UE, but not when using masked ProSe Codes of the Discovery
Filter.
An alternative solution is to provide both UEs with a Scrambling Key that is
used instead of the ProSe Code as input to the One-way keyed hash function.
The output of the hash function is then XOR\'ed with the ProSe Code to form
the Announced TempID as illustrated in Figure 8.3.2.3.-2.
Figure 8.3.2.3-2: Alternative calculation of the identity to be sent over PC5
in restricted discovery messages
As above, the receiver of such a TempID can easily compare it to its locally
generated ones to find a match, as it has the same information as the sending
UE.
#### 8.3.2.4 Authorisation of a UE for restricted discovery
In restricted discovery, the ProSe Code used by the UE to be discovered should
only be meaningful to a select set of other UEs.
A simple way to achieve the access control required by restricted discovery
involves obtaining ProSe Codes for PC5 Discovery Messages, and disseminating
those only to the specified set of UEs. The ProSe Function provides a UE with
the ProSe Code it can use to be discovered. This ProSe Code is a sensitive
parameter and is not to be correlated with the application user ID and/ or
subscriber IDs.
There are several approaches to this dissemination operation. From a security
perspective, the requirement is only that the process of dissemination should
ensure that these sensitive parameters are not disclosed to untrusted third
parties, since their knowledge constitutes a grant of access.
#### 8.3.2.5 Prevention of impersonation of a UE for restricted discovery
Both the methods described in clause 8.3.2.3 can prevent impersonation attacks
for some use cases. Without knowledge of the ProSe Code or Scrambling Key
respectively for the two cases, a UE would not be able to form a correct
announced TempID. An example use case would be being discovered by your
friends that you trust not to pass the Scrambling Key onto others. The ProSe
Function would be in control of security applied for a particular discovery
and hence could determine the necessary security (e.g. by indicating whether
Match Report are necessary or not).
### 8.3.3 Solution #8.3.3 ProSe Restricted Discovery in Model B with Match
Report procedures initiated by Discoveree UE and Discoverer UE
#### 8.3.3.1 General
#### 8.3.3.2 Overview of solution
The following figure provides a very simplified signalling model of a
potential security solution that could be applied to Restricted Discovery
procedure for Model B. Note that all nodes and signalling interfaces impacted
by the Restricted Discovery procedure for Model B are not shown in this figure
for simplicity:
Figure 8.3.3.2-1: Overview
> NOTE: The step numbering of the overview figure is not aligned with the step
> numbering of the detailed flow. This is because the overview presents a
> simplified, view which has omitted some steps for simplicity.
Figure **8.3.3.2-1** describes the following proposals:
  * HPLMN ProSe Function of Discoverer UE ((Discoverer ProSe Function)) stores/includes a Discovery Key-A and provides the key to the Discoverer UE in Discovery Response procedure in step 6 in Figure 8.3.3.2-1. The Discovery Key-A is used by the Discoverer UE to calculate the MIC over the ProSe Query Code as described in TS 33.303 [33].
  * HPLMN ProSe Function of Discoveree UE (Discoveree ProSe Function) stores/includes a Discovery Key-B and provides the key to the Discoveree UE in DiscoveryResponse message in step 2 in Figure 8.3.3.2-1. The Discovery Key-B is used by the Discoveree UE to calculate the Token (i.e. MIC) over the ProSe Response Code in a similar way as described in TS 33.303 [33].
More detailed signalling flows can be found in clause 8.3.3.3.
#### 8.3.3.3 Detailed signalling flows
##### 8.3.3.3.1 Discovery Request procedure of Discoverer UE and Discoveree UE
Figure 8.3.3.3.1-1: Discovery Request procedure
Note: \'Discoveree ProSe Function\' is used as the abbreviation for \'the
HPLMN ProSe Function of the Discoveree UE\' and \'Discoverer ProSe Function is
used as the abbreviation for \'HPLMN ProSe Function of the Discoverer UE\' in
the following description.
0.The Discoveree UE and Discoverer UE are configured with Restricted ProSe
Application User ID using mechanisms that are out of 3GPP scope.
**Discoveree UE performs Discovery Request procedure:**
1\. The Discoveree UE sends a Discovery Request message containing the
Restricted ProSe Application User ID name to the ProSe Function in its HPLMN
in order to get a Discovery Filter that it wants to listen for. The command
indicates that this is for Model B and ProSe Response operation i.e. for a
Discoveree UE.
2/3. The Discoveree ProSe Function may check for the authorization in the
ProSe Application Server depending on ProSe Function configuration.
4\. The Discoveree ProSe Function stores/includes the Discovery Key-B for the
Discoveree UE together with the ProSe Query Code and the Discovery Filter
built on ProSe Query Code.
5/6The ProSe Functions in the HPLMN and VPLMN of the Discoveree UE exchange
Announce Auth. messages. If the Discoveree UE is not roaming, these steps do
not take place.
7\. The Discoveree ProSe Function returns the Discovery Filter along with the
CURRENT_TIME, Discovery Key-B and MAX_OFFSET parameters. The Discoveree UE
takes the same actions as described for the Monitoring UE in clause 6.1.3.3.1
in step 9 in TS 33.303. The Discovery Filter provides the filter for the
Dicoveree UE to determine if a received ProSe Query Code over the air should
trigger sending off the ProSe Response Code.
**Discoverer UE performs Discovery Request procedure:**
8\. The Discoverer UE sends a Discovery Request message for ProSe Query
operation containing the Restricted ProSe App User ID to the Discoverer ProSe
Function in order to be allowed to announce a ProSe Query code in its serving
PLMN (either VPLMN or HPLMN).
9/10. The Discoverer ProSe Function sends an authorization request to the
Application Server. If, based on the permission setting, the Restricted ProSe
App User ID is allowed to discover at least one of the Target Restricted ProSe
App User ID\'s contained in the Application Transport Container, the ProSe
Application returns an authorization response.
11\. If the Discovery Request is authorized, and the PLMN ID in the Target
Restricted ProSe App User ID indicates a different PLMN, the ProSe Function
contacts the indicated PLMN\'s ProSe Function i.e. the Discoveree ProSe
Function, by sending a Discovery Request message.
12/13. The Discoveree ProSe Function may send an authorization request to the
ProSe Application Server.
14\. The Discoveree ProSe Function responds to the Discoverer ProSe Function
with a Discovery Response including the ProSe Query Code and ProSe Response
Code.
15/16. The ProSe Functions in the HPLMN and VPLMN of the Discoverer UE
exchange Announce Auth. messages. If the Discoverer UE is not roaming, these
steps do not take place.
17\. The Discoverer ProSe Function returns the ProSe Query Code that the
Discoverer UE can announce and a 128-bit Discovery Key-A associated with it.
The Discoverer ProSe Function stores the Discovery Key-A with the ProSe Query
Code. In addition, the Discoverer ProSe Function provides the Discoverer UE
with a CURRENT_TIME parameter, which contains the current UTC-based time at
the ProSe Function in HPLMN of the Discoverer UE, a MAX_OFFSET parameter, and
a Validity Timer (see TS 23.303 [2]). The Discoverer UE takes the same actions
as described for the Announcing UE in step 4 in clause 6.1.3.3.1 in TS 33.303
and calculates the MIC.
18\. The Discoverer UE starts announcing the ProSe Query Code together with
the MIC, on the same conditions as described in step 5 in clause 6.1.3.3.1 in
TS 33.303 [33].
19\. The Discoveree UE listens for a discovery message that satisfies its
Discovery Filter under the same conditions as described in step 10 in clause
6.1.3.3.1 in TS 33.303 [33].
##### 8.3.3.3.2 Match Report procedure of Discoverer UE and Discoveree UE
{width="6.0784722222222225in" height="7.573611111111111in"}
Figure 8.3.3.3.2-1: Match Report procedure
> NOTE: \'Discoveree ProSe Function\' is used as the abbreviation for \'the
> HPLMN ProSe Function of the Discoveree UE\' and \'Discoverer ProSe Function
> is used as the abbreviation for \'HPLMN ProSe Function of the Discoverer
> UE\' in the following description.
18\. The Discoverer UE starts announcing the ProSe Query Code together with
the MIC, on the same conditions as described in step 5 in clause 6.1.3.3.1 in
TS 33.303 [33].
19\. The Discoveree UE listens for a discovery message that satisfies its
Discovery Filter under the same conditions as described in step 10 in clause
6.1.3.3.1 in TS 33.303 [33].
**Discoveree UE performs Match Report procedure:**
20\. When Discoveree UE hears such a discovery message, the Discoveree UE
sends a Match Report message to the Discoveree ProSe Function. The Match
Report contains the UTC-based counter value described in step 11 in clause
6.1.3.3.1 in TS 33.303 [33] in addition to the discovery message (i.e. the
ProSe Query Code and MIC).
21\. The Discoveree ProSe Function passes the discovery message including the
ProSe Query Code and MIC and associated time parameter to the Discoverer ProSe
Function.
22\. The Discoverer ProSe Function checks if the MIC is valid using Discovery
Key-A.
23\. The Discoverer ProSe Function acknowledges a successful check of the MIC
to the Discoveree ProSe Function.
24/25. The Discoveree ProSe Function may check for the authorization in the
ProSe Application Server.
26\. The Discoveree ProSe Function provides the Discoveree UE with the ProSe
Response Code. In addition, the Discoveree ProSe Function provides the
Discoveree UE with a CURRENT_TIME parameter, which contains the current UTC-
based time at the Discoveree ProSe Function, a MAX_OFFSET parameter, and a
Validity Timer (see TS 23.303 [2]).
27.The Discoveree UE calculates a Token, i.e. a MIC as described in TS 33.303,
over the ProSe Response Code together with some additional parameters using
Discovery Key-B. The Discoveree UE starts to broadcast the Direct Discovery
Response message including the ProSe Response Code and Token (MIC).
28\. The Discoverer UE listens for a Direct Discovery Response message
containing a ProSe Response Cod that satisfies its Discovery Filter.
**Discoverer UE performs Match Report procedure:**
29.When Discoverer UE hears such a discovery message, the Discoverer UE sends
a Match Report message to the Discoverer ProSe Function. The Match Report
contains the ProSe Response Code together with the Time and Token (i.e. MIC).
30\. The Discoverer ProSe Function passes the discovery message to the
Discoveree ProSe Function in the Match Report message.
31\. The Discoveree ProSe Function checks if the Token (i.e. MIC) is valid
using Discovery Key-B. If the verification is successful then the Discoverer
UE knows that an authentic Discoveree UE is within proximity.
32\. The Discoveree ProSe Function acknowledges a successful check of the
Token (i.e. MIC) to the Discoverer ProSe Function in the Match Report Ack
message.
33/34. The Discoverer ProSe Function may check for the authorization in the
ProSe Application Server depending on ProSe Function configuration.
35\. The Discoverer ProSe Function returns an acknowledgement that the
verification of the Token (i.e. MIC) was successful. The Discoverer ProSe
Function returns the Application ID, ProSe Response Code and Target Restricted
ProSe App User ID to the Discoverer UE.
### 8.3.4 Solution #8.3.4: Integrity protection of the ProSe code for
restricted discovery (Model A)
#### 8.3.4.1 General
This solution addresses the requirements in key issue #7.3.1. It reuses the
security solution for integrity protection of the ProSe code defined in TS
33.303 [33].
#### 8.3.4.2 Solution description
This solution uses the procedures described in TS 33.303 [33] in clause
6.1.3.3.
### 8.3.5 Solution #8.3.5 ProSe Restricted Discovery in Model B with Match
Report procedure initiated by Discoverer UE only
#### 8.3.5.1 General
#### 8.3.5.2 Overview of solution
The following figure provides a very simplified signalling model of a
potential security solution,
This solution requires that only the Discoverer UE initiate a Match Report
procedure with the network in order to verify the MIC broadcasted with the
ProSe Response Code in the direct discovery response message.
Note that all nodes and signalling interfaces impacted by the Restricted
Discovery procedure for Model B are not shown in the figures for simplicity:
Figure 8.3.5.2-1: Overview
NOTE: The step numbering of the overview figure is not aligned with the step
numbering of the detailed flow. This is because the overview presents a
simplified, view which has omitted some steps for simplicity.
Figure 8.3.5.2-1 describes the following proposals:
\- HPLMN ProSe Function of Discoveree UE (Discoveree ProSe Function)
constructs/stores a Discovery Key-B together with a ProSe Response Code and:
\- provides the Discovery Key-B together with the ProSe Response Code to the
Discoveree UE in Discovery Response message in step 3 in Figure 8.3.3.2-2. The
Discovery Key-B is used by the Discoveree UE to calculate the Token (i.e. MIC)
over the ProSe Response Code in a similar way as described in TS 33.303 [33].
\- provides the ProSe Response Code to the HPLMN ProSe Function of Discoverer
UE ((Discoverer ProSe Function)) which builds a discovery filter and forwards
the filter to the Discoverer UE in Discovery Response message in step 7 in
Figure 8.3.x.2-1. The Discovery Key-B corresponding to the ProSe Response Code
in the Discovery Filter is not handed out to the HPLMN ProSe Function of
Discoverer UE ((Discoverer ProSe Function)) and the Discoverer UE. This
implies that the Discoverer UE needs to initiate a Match Report procedure with
the network in order to requests the ProSe Function of the Discoveree UE to
check the Token (i.e. MIC) calculated over the Time and ProSe Response Code
using the Discovery Key B, in order to find out whether the Discoveree UE
responding to a direct discovery request message on PC5 interface is genuine
or not. Note that if the Discoverer UE\'s does not have the same Discovery Key
B as the Discoveree UE, then this would prevent attacks as Discoverer UE\'s
replaying the ProSe Response Code on PC5 interface pretending to be the
Discoveree UE.
\- HPLMN ProSe Function of Discoveree UE ((Discoveree ProSe Function))
constructs/stores a Discovery Key-A together with a ProSe Query Code and:
\- provides the Discovery Key-A together with the ProSe Query code to the
HPLMN ProSe Function of Discoverer UE ((Discoverer ProSe Function)) which
stores and forwards the key/code to the Discoverer UE in Discovery Response
message in step 7 in Figure 8.3.5.2-1. The Discovery Key-A is used by the
Discoverer UE to calculate the MIC over the ProSe Query Code as described in
TS 33.303 [33].
\- builds a Discovery filter based on the ProSe Query Code and provides the
Discovery Key-A and Discovery filter to the Discoveree UE in Discovery
Response message in step 3 in Figure 8.3.x.2-1. The Discovery Key-A is used by
the Discoveree UE to check the announced MIC as described in TS 33.303 [33],
when it finds a match of the announced ProSe Query Code using its Discovery
Filter.
More detailed signalling flows can be found in clause 8.3.5.3.
#### 8.3.5.3 Detailed signalling flows
##### 8.3.5.3.1 Discovery Request procedure of Discoverer UE and Discoveree UE
Figure 8.3.5.3.1-1: Discovery Request procedure
Note: \'Discoveree ProSe Function\' is used as the abbreviation for \'the
HPLMN ProSe Function of the Discoveree UE\' and \'Discoverer ProSe Function is
used as the abbreviation for \'HPLMN ProSe Function of the Discoverer UE\' in
the following description.
0.The Discoveree UE and Discoverer UE are configured with Restricted ProSe
Application User ID using mechanisms that are out of 3GPP scope.
**Discoveree UE performs Discovery Request procedure** :
1\. The Discoveree UE sends a Discovery Request message containing the
Restricted ProSe Application User ID name to the ProSe Function in its HPLMN
in order to get a Discovery Filter that it wants to listen for. The command
indicates that this is for Model B and ProSe Response operation i.e. for a
Discoveree UE.
2/3. The Discoveree ProSe Function may check for the authorization in the
ProSe Application Server depending on ProSe Function configuration.
4\. The Discoveree ProSe Function constructs and stores a Discovery Key-B for
the Discoveree UE together with the ProSe Response Code and construct and
stored a Discovery Key-A together with a ProSe Query Code. A Discovery Filter
is built on ProSe Query Code.
5/6The ProSe Functions in the HPLMN and VPLMN of the Discoveree UE exchange
Announce Auth. messages. If the Discoveree UE is not roaming, these steps do
not take place.
7\. The Discoveree ProSe Function returns the Discovery Filter built on ProSe
Query Code and the Discovery Key-A, along with the CURRENT_TIME, ProSe
Response Code, Discovery Key-B and MAX_OFFSET parameters. The Discoveree UE
takes the same actions as described for the Monitoring UE in clause 6.1.3.3.1
in step 9 in TS 33.303. The Discovery Filter provides the filter for the
Dicoveree UE to determine if a received ProSe Query Code over the air should
trigger sending off the ProSe Response Code.
**Discoverer UE performs Discovery Request procedure:**
8\. The Discoverer UE sends a Discovery Request message for ProSe Query
operation containing the Restricted ProSe App User ID to the Discoverer ProSe
Function in order to be allowed to announce a ProSe Query code in its serving
PLMN (either VPLMN or HPLMN).
9/10. The Discoverer ProSe Function sends an authorization request to the
Application Server. If, based on the permission setting, the Restricted ProSe
App User ID is allowed to discover at least one of the Target Restricted ProSe
App User ID\'s contained in the Application Transport Container, the ProSe
Application returns an authorization response.
11\. If the Discovery Request is authorized, and the PLMN ID in the Target
Restricted ProSe App User ID indicates a different PLMN, the ProSe Function
contacts the indicated PLMN\'s ProSe Function i.e. the Discoveree ProSe
Function, by sending a Discovery Request message.
12/13. The Discoveree ProSe Function may send an authorization request to the
ProSe Application Server.
14\. The Discoveree ProSe Function responds to the Discoverer ProSe Function
with a Discovery Response including the ProSe Query Code, Discovery Key_A and
theProSe Response Code.
15/16. The ProSe Functions in the HPLMN and VPLMN of the Discoverer UE
exchange Announce Auth. messages. If the Discoverer UE is not roaming, these
steps do not take place.
17\. The Discoverer ProSe Function returns the ProSe Query Code that the
Discoverer UE can announce and a 128-bit Discovery Key-A associated with it.
The Discoverer ProSe Function stores the Discovery Key-A with the ProSe Query
Code. In addition, the Discoverer ProSe Function provides the Discoverer UE
with a CURRENT_TIME parameter, which contains the current UTC-based time at
the ProSe Function in HPLMN of the Discoverer UE, a MAX_OFFSET parameter, the
Discovery Filter built on ProSe Response Code and a Validity Timer (see TS
23.303 [2]). The Discoverer UE takes the same actions as described for the
Announcing UE in step 4 in clause 6.1.3.3.1 in TS 33.303 and calculates the
MIC.
18\. The Discoverer UE starts announcing the ProSe Query Code together with
the MIC, on the same conditions as described in step 5 in clause 6.1.3.3.1 in
TS 33.303 [33].
19\. The Discoveree UE listens for a discovery message that satisfies its
Discovery Filter under the same conditions as described in step 10 in clause
6.1.3.3.1 in TS 33.303 [33].
##### 8.3.5.3.2 Match Report procedure of Discoverer UE
Figure 8.3.5.3.2-1: Match Report procedure
NOTE: \'Discoveree ProSe Function\' is used as the abbreviation for \'the
HPLMN ProSe Function of the Discoveree UE\' and \'Discoverer ProSe Function is
used as the abbreviation for \'HPLMN ProSe Function of the Discoverer UE\' in
the following description.
18\. The Discoverer UE starts announcing the ProSe Query Code together with
the MIC, on the same conditions as described in step 5 in clause 6.1.3.3.1 in
TS 33.303 [33].
19\. The Discoveree UE listens for a discovery message that satisfies its
Discovery Filter under the same conditions as described in step 10 in clause
6.1.3.3.1 in TS 33.303 [33]. When the Discoveree UE hears such a discovery
message, the Discoveree UE checks if the MIC is valid using Discovery Key-A.
If the check of the MIC is successful, then the Discoveree UE proceeds with
step 20.
20.The Discoveree UE calculates a Token, i.e. a MIC as described in TS 33.303,
over the ProSe Response Code together with some additional parameters using
Discovery Key-B. The Discoveree UE starts to broadcast the Direct Discovery
Response message including the ProSe Response Code and Token (MIC).
21\. The Discoverer UE listens for a Direct Discovery Response message
containing a ProSe Response Cod that satisfies its Discovery Filter.
22.When Discoverer UE hears such a discovery message, the Discoverer UE sends
a Match Report message to the Discoverer ProSe Function. The Match Report
contains the ProSe Response Code together with the Time and Token (i.e. MIC).
23\. The Discoverer ProSe Function passes the discovery message to the
Discoveree ProSe Function in the Match Report message.
24\. The Discoveree ProSe Function checks if the Token (i.e. MIC) is valid
using Discovery Key-B. If the verification is successful then the Discoverer
UE knows that an authentic Discoveree UE is within proximity.
25\. The Discoveree ProSe Function acknowledges a successful check of the
Token (i.e. MIC) to the Discoverer ProSe Function in the Match Report Ack
message.
26/27. The Discoverer ProSe Function may check for the authorization in the
ProSe Application Server depending on ProSe Function configuration.
28\. The Discoverer ProSe Function returns an acknowledgement that the
verification of the Token (i.e. MIC) was successful. The Discoverer ProSe
Function returns the Application ID, ProSe Response Code and Target Restricted
ProSe App User ID to the Discoverer UE.
### 8.3.6 Solution #8.3.6 ProSe Restricted Discovery in Model B with local MIC
Checking
#### 8.3.6.1 General
In the presented solution the Discoveree/Discoverer UE do not contact the
network for a match report since both UEs store the discovery key for MIC
creation and MIC checking locally. Thus, this solution is more efficient than
Solution 8.3.3 and Solution 8.3.5 since no match report is needed (for
security reasons).
#### 8.3.6.2 Overview of solution
The following figure provides a very simplified signalling model of a
potential security solution that could be applied to Restricted Discovery
procedure for Model B. Note that all nodes and signalling interfaces impacted
by the Restricted Discovery procedure for Model B are not shown in this figure
for simplicity:
Figure 8.3.6.2-1: Overview
NOTE 1: The step numbering of the overview figure is not aligned with the step
numbering of the detailed flow. This is because the overview presents a
simplified view which has omitted some steps.
Figure 8.3.6.2-1 describes the following proposals:
HPLMN ProSe Function of Discoveree UE (Discoveree ProSe Function) allocates
and stores a Discovery Key
The Discoveree ProSe Function provides the Discovery key to the Discoveree UE
in the Discovery Response procedure in step 2 in Figure 8.3.6.2-1. The
Discovery Key is used by the Discoveree UE to calculate the Token (i.e. MIC-2
as described in TS 33.303) over the ProSe Response Code as well as to validate
the MIC-1 of a received ProSe Query Code.
HPLMN ProSe Function of Discoverer UE (Discoverer ProSe Function) obtains the
Discovery Key from the Discoveree ProSe Function in step 4/5 and provides the
key to the Discoverer UE in the Discovery Response in step 6 in Figure 2. The
Discovery Key is used by the Discoverer UE to calculate MIC-1 over the ProSe
Query Code in a similar way as described in TS 33.303 as well as to validate
MIC-2 over a received ProSe Response Code.
NOTE 2: This solution is only applicable for scenarios where the Discoverer
UEs can be trusted. Otherwise, one Discoverer UE could impersonate the
Discoveree UE towards another Discoverer UE in the group since the Discoverer
UEs know the Discovery Key which the Discoveree UE uses for signing Response
Codes.
#### 8.3.6.3 Procedures
##### 8.3.6.3.1 Discovery Request procedure of Discoverer UE and Discoveree UE
Figure 8.3.6.3-1: Discovery Request procedure
Note: \'Discoveree ProSe Function\' is used as the abbreviation for \'the
HPLMN ProSe Function of the Discoveree UE\' and \'Discoverer ProSe Function is
used as the abbreviation for \'HPLMN ProSe Function of the Discoverer UE\' in
the following description.
0.The Discoveree UE and Discoverer UE are configured with Restricted ProSe
Application User ID using mechanisms that are out of 3GPP scope.
**Discoveree UE performs Discovery Request procedure:**
1\. The Discoveree UE sends a Discovery Request message containing the
Restricted ProSe Application User ID name to the ProSe Function in its HPLMN
in order to get a Discovery Filter that it wants to listen for. The command
indicates that this is for Model B and ProSe Response operation i.e. for a
Discoveree UE.
2/3. The Discoveree ProSe Function may check for the authorization in the
ProSe Application Server depending on ProSe Function configuration.
4\. The Discoveree ProSe Function allocates a Discovery Key and stores it
together with the ProSe Query Code, ProSe Response Code, and the Discovery
Filters.
5/6The ProSe Functions in the HPLMN and VPLMN of the Discoveree UE exchange
Announce Auth. messages. If the Discoveree UE is not roaming, these steps do
not take place.
7\. The Discoveree ProSe Function returns the Discovery Filter along with the
CURRENT_TIME, Discovery Key and MAX_OFFSET parameters. The Discoveree UE takes
the same actions as described for the Monitoring UE in clause 6.1.3.3.1 in
step 9 in TS 33.303. The Discovery Filter provides the filter for the
Dicoveree UE to determine if a received ProSe Query Code over the air should
trigger sending off the ProSe Response Code.
**Discoverer UE performs Discovery Request procedure:**
8\. The Discoverer UE sends a Discovery Request message for ProSe Query
operation containing the Restricted ProSe App User ID to the Discoverer ProSe
Function in order to be allowed to announce a ProSe Query code in its serving
PLMN (either VPLMN or HPLMN).
9/10. The Discoverer ProSe Function sends an authorization request to the
Application Server. If, based on the permission setting, the Restricted ProSe
App User ID is allowed to discover at least one of the Target Restricted ProSe
App User ID\'s contained in the Application Transport Container, the ProSe
Application returns an authorization response.
11\. If the Discovery Request is authorized, and the PLMN ID in the Target
Restricted ProSe App User ID indicates a different PLMN, the ProSe Function
contacts the indicated PLMN\'s ProSe Function i.e. the Discoveree ProSe
Function, by sending a Discovery Request message.
12/13. The Discoveree ProSe Function may send an authorization request to the
ProSe Application Server.
14\. The Discoveree ProSe Function responds to the Discoverer ProSe Function
with a Discovery Response including the ProSe Query Code, Discovery Filter and
Discovery Key.
15/16. The ProSe Functions in the HPLMN and VPLMN of the Discoverer UE
exchange Announce Auth. messages. If the Discoverer UE is not roaming, these
steps do not take place.
17\. The Discoverer ProSe Function returns the ProSe Query Code that the
Discoverer UE can announce, the Discovery Filter, and the Discovery Key
obtained from the Discoveree ProSe Function in step 14. In addition, the
Discoverer ProSe Function provides the Discoverer UE with a CURRENT_TIME
parameter, which contains the current UTC-based time at the ProSe Function in
HPLMN of the Discoverer UE, a MAX_OFFSET parameter, and a Validity Timer (see
TS 23.303 [2]). The Discoverer UE takes the same actions as described for the
Announcing UE in step 4 in clause 6.1.3.3.1 in TS 33.303 and calculates the
MIC.
18\. The Discoverer UE starts announcing the ProSe Query Code together with
the MIC, on the same conditions as described in step 5 in clause 6.1.3.3.1 in
TS 33.303 [33].
19\. The Discoveree UE listens for a discovery message that satisfies its
Discovery Filter under the same conditions as described in step 10 in clause
6.1.3.3.1 in TS 33.303 [33].
##### 8.3.6.3.2 MIC Check procedures of Discoverer UE and Discoveree UE
Figure 8.3.6.3-2: MIC check procedure of Discoveree and Discoverer UE
NOTE: \'Discoveree ProSe Function\' is used as the abbreviation for \'the
HPLMN ProSe Function of the Discoveree UE\' and \'Discoverer ProSe Function is
used as the abbreviation for \'HPLMN ProSe Function of the Discoverer UE\' in
the following description.
18\. The Discoverer UE starts announcing the ProSe Query Code together with
the MIC, on the same conditions as described in step 5 in clause 6.1.3.3.1 in
TS 33.303 [33].
19\. The Discoveree UE listens for a discovery message that satisfies its
Discovery Filter under the same conditions as described in step 10 in clause
6.1.3.3.1 in TS 33.303 [33].
**Discoveree UE performs MIC Check**
20\. When the Discoveree UE hears such a discovery message, the Discoveree UE
validates the MIC received together with the message using the Discovery Key
obtained in step 7 in the Discovery Response.
21.The Discoveree UE calculates a Token, i.e. a MIC as described in TS 33.303,
over the ProSe Response Code together with some additional parameters using
the Discovery Key obtained in step 7. The Discoveree UE starts to broadcast
the Direct Discovery Response message including the ProSe Response Code and
Token (MIC-2).
22\. The Discoverer UE listens for a Direct Discovery Response message
containing a ProSe Response Code that satisfies its Discovery Filter.
**Discoverer UE performs MIC Check**
23\. When the Discoverer UE hears such a discovery message, then the
Discoverer UE validates the Token (i.e. MIC-2) received together with the
discovery message by using the Discovery Key received in step 14 in the
Discovery Response.
### 8.3.7 Solution #8.3.7: Security for Restricted ProSe Direct Discovery
#### 8.3.7.1 General
This solution addresses the requirements in key issue #7.3.1 and is the
security part of the solution in clause 5.3 of TR 23.713 [32].
#### 8.3.7.2 Solution description
The solution proposed in clause 5.3 of TR 23.713 [32] described Announce
Request, Monitor Request and Match Report procedures. Compared with the
procedures of the Open Discovery described in clause 5.3 of TS 23.303 [20],
several differences are introduced, as the following
1\. In the Monitor Request procedure, The ProSe Function in the other PLMN
returns to the ProSe Function in the HPLMN the ProSe Code, rather than the
ProSe Mask. And the ProSe Function in the HPLMN of the Monitoring UE builds
the binding between ProSe Code with Target Restricted ProSe App User ID and
stores it into the user context of the monitoring UE.
2\. In the Match Report procedure, the ProSe Function in the HPLMN of the
Monitoring UE does not interact with the ProSe Function in the HPLMN of the
announcing UE. It checks out the Target Restricted ProSe App User ID by using
the binding built above.
With these differences, the security flow the Restricted ProSe Direct
Discovery is as following
Figure: 8.3.7.2-1: Integrity protection of the transmitted code
1\. The Announcing UE sends a Discovery Request message containing the ProSe
Application ID name to the ProSe Function in its HPLMN in order to be allowed
to announce a code on its serving PLMN (either VPLMN or HPLMN).
2./3. The ProSe Functions in the HPLMN and VPLMN of the announcing UEs
exchange Announce Auth. messages. There are no changes to these messages for
the purpose of protecting the transmitted code for restricted discovery,
referring to the Announce Request procedure described in clause 5.1.2.3 of TR
23.713 [32]. If the Announcing UE is not roaming, these steps do not take
place.
4\. The ProSe Function in HPLMN of the announcing UE returns the ProSe App
Code that the announcing UE can announce and a 128-bit Discovery Key
associated with it. The ProSe Function stores the Discovery Key with the ProSe
App Code. In addition, the ProSe Function provides the UE with a CURRENT_TIME
parameter, which contains the current UTC-based time at the ProSe Function, a
MAX_OFFSET parameter, and a Validity Timer (see TS 23.303 [2]). The UE sets a
clock it uses for ProSe authentication (i.e. ProSe clock) to the value of
CURRENT_TIME and stores the MAX_OFFSET parameter, overwriting any previous
values. The announcing UE obtains a value for a UTC-based counter associated
with a discovery slot based on UTC time. The counter is set to a value of UTC
time in a granularity of seconds. The UE may obtain UTC time from any sources
available, e.g. the RAN via SIB16, NITZ, NTP, GPS (depending on which is
available).
NOTE 1: The UE may use unprotected time to obtain the UTC-based counter
associated with a discovery slot. This means that the discovery message could
be successfully replayed if a UE is fooled into using a time different to the
current time. The MAX_OFFSET parameter is used to limit the ability of an
attacker to successfully replay discovery messages or obtain correctly MICed
discovery message for later use. This is achieved by using MAX_OFFSET as a
maximum difference between the UTC-based counter associated with the discovery
slot and the ProSE clock held by the UE.
NOTE 2: A discovery slot is the time at which an announcing UE sends the
announcement.
5\. The UE starts announcing, if the UTC-based counter provided by the system
associated with the discovery slot is within the MAX_OFFSET of the announcing
UE\'s ProSe clock and if the Validity Timer has not expired (see TS 23.303
[2]).For each discovery slot it uses to announce, the announcing UE calculates
a 32-bit Message Integrity Check (MIC) to include with the ProSe App Code in
the discovery message. Four least significant bits of UTC-based counter are
transmitted along with the discovery message. The MIC is calculated as
described in sub clause A.2 using the Discovery Key and the UTC-based counter
associated with the discovery slot.
6\. The Monitoring UE sends a Discovery Request message containing the ProSe
Application ID name to the ProSe Function in its HPLMN in order to get the
Discovery Filters that it wants to listen for.
7/8. The ProSe Functions in the HPLMN of the monitoring UE and HPLMN of the
announcing UEs exchange Monitor Req./Resp. messages. For the purpose of
protecting the transmitted code for restricted discovery, the Monitor Response
message contains the ProSe Discovery Key. The rest are no changes to these
messages of the Monitor Request procedure described in clause 5.1.2.4 of TR
23.713 [32].
9\. The ProSe Function returns the Discovery Filter containing the ProSe App
Code(s) along with the CURRENT_TIME and the MAX_OFFSET parameters. The UE sets
its ProSe clock to CURRENT_TIME and stores the MAX_OFFSET parameter,
overwriting any previous values. The monitoring UE obtains a value for a UTC-
based counter associated with a discovery slot based on UTC time. The counter
is set to a value of UTC time in a granularity of seconds. The UE may obtain
UTC time from any sources available, e.g. the RAN via SIB16, NITZ, NTP, GPS
(depending on which is available).
10\. The Monitoring UE listens for a discovery message that satisfies its
Discovery Filter, if the UTC-based counter associated with that discovery slot
is within the MAX_OFFSET of the monitoring UE\'s ProSe clock.
11\. On hearing such a discovery message, and if the UE has either not checked
the MIC for the discovered ProSe App Code previously or has checked a MIC for
the ProSe App Code and the associated Match Report refresh timer (see steps 14
and 15 for details of this timer) has expired, or as required based on the
procedures specified in TS 23.303 [2], the Monitoring UE sends a Match Report
message to the ProSe Function in the HPLMN of the monitoring UE. The Match
Report contains the UTC-based counter value with four least significant bits
equal to four least significant bits received along with discovery message and
nearest to the monitoring UE\'s UTC-based counter associated with the
discovery slot where it heard the announcement, and the discovery message
including the ProSe App Code and MIC.
12\. The ProSe Function in the HPLMN of the monitoring UE checks the MIC is
valid. The relevant Discovery Key is found using the ProSe App Code.
13\. The ProSe Function in the HPLMN of the monitoring UE returns an
acknowledgement that the integrity checked passed to the Monitoring UE. The
ProSe Function returns the parameter Target ProSe Application User ID to the
UE. It also provides the CURRENT_TIME parameter, by which the UE (re)sets its
ProSe clock The ProSe Function in the HPLMN of the monitoring UE includes a
Match Report refresh timer in the message to the Monitoring UE. The Match
Report refresh timer indicates how long the UE will wait before sending a new
Match Report for the ProSe App Code.
### 8.3.8 Solution #8.3.8: Security for Restricted ProSe Direct Discovery
(Model B)
#### 8.3.8.1 General
This solution addresses the requirements in key issue #7.3.2 and is the
security part of the solution in clause 5.2 of TR 23.713 [32].
#### 8.3.8.2 Solution description
This security solution of ProSe Restricted Discovery (Model B) includes 4
procedures: Discoveree UE procedure, Discoverer UE procedure, Query procedure
and Match Report procedure. For simplicity, some steps in the following
procedures are referring to steps described in clause 5.2 of TR 23.713 [32] if
they are identical.
#### 8.3.8.3 Discoveree UE procedure
Figure 8.3.8.3-1: Discoveree UE procedures for Model B discovery (roaming)
0\. The Discoveree UE is configured with Restricted ProSe Application User ID
using mechanisms that are out of scope of 3GPP. This is the same as step 0 of
5.1.2.3 of TR 23.713 [32].
1\. If the Discoveree UE is authorised to use Model B discovery in the serving
PLMN, it establishes a secure connection with the ProSe Function and send a
Discovery Request (Discovery Model, Restricted ProSe Application User ID, UE
Identity, command, Application ID) message. The Discovery Model indicates that
Model B is used. The ProSe Application ID indicates what the UE is interested
to announce. The UE Identity is set to e.g. IMSI. The command indicates that
this is for ProSe Response operation, i.e. for a Discoveree UE. The
Application ID represents a unique identifier of the UE application that has
triggered the transmission of the Discovery Request message. This request is
always sent to the ProSe Function in HPLMN.
2\. As in TS 23.303 [3].
2.a and 2.b are only used when the Discovery Type indicates Restricted
Discovery. They are identical to those of the 5.1.2.3 of TR 23.713 [32].
3a. The ProSe Function allocates a ProSe Response Code and a ProSe Discovery
Filter.
3\. If the Discovery Request is authorised then the HPLMN ProSe Function
informs the ProSe Function in VPLMN with the Announce Authorisation
(Restricted ProSe Application User ID, Application ID, ProSe Response Code,
validity timer, UE Identity) message. The Restricted ProSe Application User ID
corresponds to the request from the UE, whereas the ProSe Response Code
indicates the assigned code for this request. The request also includes the UE
identity information e.g. IMSI or MSISDN in order to allow the ProSe Function
in VPLMN to perform charging. The validity timer indicates for how long this
ProSe Response Code is going to be valid.
4\. The ProSe Function in VPLMN authorizes the UE to perform ProSe Direct
Discovery announcing.
5\. The ProSe Function in HPLMN responds with a Discovery Response (Discovery
Model, Discovery Filter, ProSe Response Code, validity timer, ProSe Response
Key, CURRENT_TIME, MAX_OFFSET) message. The Discovery Model indicates that
Model B is used. Multiple Discovery Filters may be returned. The Discovery
Filter provides the filter for the Discoveree UE to determine if a received
ProSe Query Code over the air should trigger sending of the ProSe Response
Code. The ProSe Response Code is provided by the ProSe Function and
corresponds to the Restricted ProSe Application User ID that was contained in
the Discovery Request. The validity timer indicates for how long this ProSe
Response Code is going to be valid. When the validity timer expires or the UE
changes its registered PLMN, the UE needs to request a new ProSe Response
Code. The ProSe Response Key is a 128-bit key associated with the ProSe
Response Code. The CURRENT_TIME contains the current UTC-based counter at the
ProSe Function. The MAX_OFFSET indicates the maximum counter difference
between the counter held in the UE (\"UE clock\") and the UTC based counter
value associated with the discovery slot. The UE sets its clock to the value
of CURRENT_TIME UTC based counter and stores the MAX_OFFSET parameter,
overwriting any previous values.
6\. The UE may start to obtain the radio resources to monitor using the
Discovery Filter, as authorised and configured by E-UTRAN for ProSe as defined
in RAN specifications.
#### 8.3.8.4 Discoverer UE procedure before discovery
Figure 8.3.8.4-1: Discoverer UE procedures for Model B discovery (roaming)
0\. The Discoverer UE are configured with Restricted ProSe Application User
IDs using mechanisms that are out of scope of 3GPP. This is the same as that
of 5.1.2.4 of TR 23.713 [32].
1\. If the Discoverer UE is authorised to use Model B discovery in the serving
PLMN, it establishes a secure connection with the ProSe Function and send a
Discovery Request (Discovery Model, Discovery Type, Restricted ProSe
Application User ID, UE Identity, command, Application ID, Application
Transparent Container) message. The Discovery Model indicates that Model B is
used. The command indicates this is for ProSe Query operation, i.e. for a
Discoverer UE. The UE Identity is set to e.g. IMSI. The Application ID
represents a unique identifier of the UE application that has triggered the
transmission of the Discovery Request message. This request is always sent to
the ProSe Function in HPLMN.
2\. As in TS 23.303 [3].
2.a and 2.b are identical to steps 3 and 4 of clause 5.1.2.4 of TR 23.713
[32].
3\. If the Discovery Request is authorized, and the PLMN ID in the Target
ProSe Discovery UE ID indicates a different PLMN, the ProSe Function contacts
the indicated PLMN\'s ProSe Function to obtain the necessary information with
a Discovery Request (Restricted ProSe App User ID, UE Identity, Target ProSe
Discovery UE ID, Application ID, Target Restricted ProSe App User ID).
3.a and 3.b are identical to steps 8.a and 8.b of the clause 5.1.2.4 of TR
23.713 [32].
4\. Based on the Target ProSe Discovery UE ID, Application ID, and Target
Restricted ProSe App User ID, the ProSe Function locates the Discoveree UE(s)
context, and responds with a Discovery Response (ProSe Query Code(s), ProSe
Response Code, validity timer, ProSe Query Key, ProSe Response Key). The ProSe
Query Code is the code used by the ProSe Function to build the Discovery
Filter of step 3a of clause 5.2.2.2, such that it can trigger the Discoveree
UE to send the response. The ProSe Response Code is that allocated to the
Discoveree UE in step 3a of clause 5.2.2.2. The validity timer indicates for
how long a ProSe Query Code and ProSe Response Code are going to be valid. The
ProSe Query Key is a 128-bit key associated with the ProSe Query Code. The
ProSe Response Key is a 128-bit key associated with the ProSe Response Code.
5\. The HPLMN ProSe Function informs the ProSe Function in VPLMN with the
Announce Authorisation (Restricted ProSe Application User ID, Application ID,
ProSe Query Code(s), validity timer, UE Identity) message. The Restricted
ProSe Application User ID corresponds to the request from the UE, whereas the
ProSe Query Code is that obtained in step 4. The request also includes the UE
identity information e.g. IMSI or MSISDN in order to allow the ProSe Function
in VPLMN to perform charging. The validity timer indicates for how long this
ProSe Query Code is going to be valid.
6\. The ProSe Function in VPLMN authorizes the UE to perform ProSe Direct
Discovery announcing.
7\. The ProSe Function responds with a Discovery Response (Discovery Model,
Discovery Filter(s), ProSe Query Code(s), ProSe Query key(s), CURRENT_TIME,
MAX_OFFSET, validity timer) message. The Discovery Model indicates the model B
is used. Multiple Discovery Filters may be returned. The Discovery Filter is
generated by the ProSe Function based on the ProSe Response Code of step 4.
The ProSe Query Code is that received in step 4. The validity timer indicates
for how long a ProSe Query Code and Discovery Filter pair are going to be
valid. When the validity timer expires the UE needs to request a new ProSe
Query Code and Discovery Filter.
8\. The UE may start to obtain the radio resources to announce the ProSe Query
Code, as authorised and configured by E-UTRAN for ProSe as defined in RAN
specifications.
#### 8.3.8.5 Query procedure
Figure 8.3.8.5-1: Query procedure for Model B Discovery (roaming)
0/1. The Discoverer UE starts announcing the Query Request message, if the
UTC-based counter provided by the system associated with the discovery slot is
within the MAX_OFFSET of the Discoverer UE\'s ProSe clock and if the Validity
Timer has not expired (see TS 23.303 [2]).For each discovery slot it uses to
announce, the Discoverer UE calculates a 32-bit Query Message Integrity Check
(MIC) to include with the ProSe Query Code in the Query Request message. Four
least significant bits of UTC-based counter are transmitted along with the
Query Request message. The Query MIC is calculated as described in clause
8.3.6.7 using the ProSe Query Key, Message Type, Prose Query Code and the UTC-
based counter associated with the discovery slot.
2\. On hearing such a Query Request message, the Discoveree UE sends an
Authenticate Request message to the ProSe Function in the HPLMN of the
Discoveree UE. The Authenticate Request contains the UTC-based counter value
with four least significant bits equal to four least significant bits received
along with Query Request message and nearest to the monitoring UE\'s UTC-based
counter associated with the discovery slot where it heard the announcement,
and the Authenticate Request message includes the ProSe Query Code and Query
MIC.
3\. The ProSe Function in the HPLMN of the Discoveree UE checks the Query MIC
is valid. The relevant ProSe Query Key is found using the ProSe Query Code.
4\. The ProSe Function in the HPLMN of the Discoveree UE acknowledges a
successful check of the Query MIC to the Discoveree UE in the Authenticate
Response message.
5/6. The Discoveree UE starts announcing the Query Response message, if the
UTC-based counter provided by the system associated with the discovery slot is
within the MAX_OFFSET of the Discoveree UE\'s ProSe clock and if the Validity
Timer has not expired (see TS 23.303 [2]).For each discovery slot it uses to
announce, the Discoveree UE calculates a 32-bit Response Message Integrity
Check (MIC) to include with the ProSe Response Code in the Query Response
message. Four least significant bits of UTC-based counter are transmitted
along with the Query Response message. The Response MIC is calculated as
described in clause 8.3.6.7 using the ProSe Response Key, Message Type, Prose
Response Code and the UTC-based counter associated with the discovery slot.
#### 8.3.8.6 Match Report procedure for Discoverer UE
Figure 8.3.8.6-1: Match Report procedure for Model B Discovery (roaming)
1\. When the Discoverer UE has received a ProSe Code over the air that matches
the Discovery Filter it obtained from monitoring Request procedure, and if the
UE does not have a corresponding Restricted ProSe App User ID associated with
it with a valid TTL, the UE sends a Match Report (Restricted ProSe App User
ID, UE Identity, Discovery Type, Application ID, ProSe Response Code, Response
MIC, UTC-based counter) message to the ProSe Function in the HPLMN to get the
Target Restricted ProSe App User ID. The Restricted ProSe App User ID is the
identifier the monitoring UE used to obtain the Discovery Filter from the
Monitoring Request. The UE Identity is set to e.g. IMSI. The Application ID
represents a unique identifier of the application that triggered the
monitoring Request. Discovery Type is set to \"restricted discovery\". The
ProSe Response Code is the code received over the air. The Response MIC is the
Response MIC received over the air. The UTC-based counter value is with four
least significant bits equal to four least significant bits received along
with Query Response message and nearest to the Discoverer UE\'s UTC-based
counter associated with the discovery slot where it heard the announcement.
2\. The HPLMN ProSe Function checks the authorization for the Discoverer UE to
perform restricted discovery.
3\. The HPLMN ProSe Function analyses the ProSe Response Code and identifies
in the UE context of the Discoverer UE the corresponding Target Restricted
ProSe App User ID. It checks the Response MIC is valid. The relevant ProSe
Response Key is found using the ProSe Response Code.
4.a Optionally, the ProSe Function sends a Auth Request (Restricted ProSe App
User ID, Target Restricted ProSe App User ID, indicator) to the ProSe
Application Server. The ProSe Function locates the ProSe Application Server
based on the Application ID. The indicator is set to \"restricted
discovery/match\".
4.b If, based on the permission setting, the Restricted ProSe App User ID is
allowed to discover the Target Restricted ProSe App User ID, the ProSe
Application Server returns a Auth Response (ProSe Discovery UE ID, Target
ProSe Discovery UE ID, indicator, metadata(opt.)) message. The ProSe Discovery
UE ID corresponds to Restricted ProSe App User ID, the Target ProSe Discovery
UE ID corresponds to the Target Restricted ProSe App User ID stored in the
ProSe Application Server. The indicator is set to \"restricted discovery/match
ack\". This message may also contain certain metadata corresponding to the
Target ProSe Discovery UE ID e.g. welcome message, etc.
4.c The ProSe Function verifies that the returned ProSe Discovery UE ID
belongs to the requesting UE, and the Target ProSe Discovery UE ID is the same
as the stored Target ProSe Discovery UE ID.
5\. The ProSe Function in HPLMN returns a Match Report Ack (Application ID,
Target Restricted ProSe App User ID, validity timer, metadata(opt.)) to the
UE. The UE stores the mapping between the Restricted ProSe App User ID, the
ProSe Code and the Application ID for the duration of the validity timer.
6\. The ProSe Function in HPLMN may optionally send a Match Report Info
(Restricted ProSe App User ID, UE Identity, ProSe Code, Discovery Type) to the
ProSe Function of the Discoveree UE. Discovery Type is set to \"restricted
discovery\".
#### 8.3.8.7 Calculation of the MIC value
When calculating a MIC using the Discovery Query/Response Key, the following
parameters are used to form the input S to the KDF that is specified in Annex
B of TS 33.220 [6].
\- FC = 0x49
\- P0 = Message Type (see TS 24.334).
\- L0 = length of above (i.e. 0x00 0x01).
\- P1 = ProSe Query/Response Code.
\- L1 = length of above (i.e. 0x00 0x17).
\- P2 = UTC-based counter associated with the discovery slot.
\- L2 = length of above (i.e. 0x00 0x04).
The Discovery Query/Reponse Key, Time parameter and discovery message follow
the encoding also specified in Annex B of TS 33.220 [6].
### 8.3.9 Solution #8.3.9 Obtaining the security parameters needed for ProSe
Restricted Discovery
#### 8.3.9.1 General
ProSe Restricted Discovery, Model B, allows a UE to query for other UEs of
interest in the proximity. It consists of a ProSe Query Code sent by a
Discoverer UE, a ProSe Response Code sent by a Discoveree UE in response to
that query, as in Figure 8.3.9.1-1. The analogy with the Model A discovery is
that the Discoverer UE acts like a Monitoring UE, while the Discoveree UE acts
like an Announcing UE.
Figure 8.3.9.1-1. Model B discovery
#### 8.3.9.2 Overview of solution
The ProSe Function can provide the Discoveree with a Discovery Key (if
needed), just like in Open Discovery, along with the ProSe Response Code and
Discovery Filter(s). If in addition, there is a need for other security
protection of the ProSe Response Code, the ProSe Function can provide both the
Discoveree and Discoverer with a set of Security Parameters necessary to
achieve all protection necessary (e.g. tracking/impersonation/replays, as well
as integrity and /or confidentiality).
Every ProSe Code (Model B or Model A) has a set of Security Parameters
associated with it. These Security Parameters will be generated by the ProSe
Function who assigns that Code. A Discovery Filter contains one ProSe Code,
and so it will also contain its own set of Security Parameters.
The Security Parameters are obtained in the \"Discoverer UE procedure before
discovery\" and \"Discoveree UE procedure before discovery\", as shown in
Figure 8.3.9.1-1.
#### 8.3.9.3 Security procedures for model B
First, procedures take place whereby the Discoveree and Discoverer
independently prepare for the PC5 discovery operation - Model B, that is, each
one obtains the necessary Code, associated set of Security Parameters
(SecParam), and associated Discovery filter(s) each with its own Security
Parameters. As part of this process, the Discoveree may also be provided with
a Discovery Key if Match Reports are to be used for security purposes. The
overall flow for model B is given in figure 8.3.9.3-1. The message elements
added for security requirements are shown in red.
Figure 8.3.9.3-1: Discovery procedure, Model B: obtaining security parameters.
In Figure 8.3.9.3-1, steps 1 through 4 describe the simplified \"Discoveree UE
procedure\" of clause 5.2.2.2 of [32]. Steps 5 through 8 described the
simplified \"Discoverer UE procedure\' of clause 5.2.2.3 of [32].
For Model B, the HPLMN ProSe Function of the Discoveree generates all Security
Parameters (SecParam), one set for the ProSe Response Code for that UE, and
another set that goes into the Discovery Filter(s) that contain the Query
Code(s) the Discoveree is supposed to use. Several Query Code(s) can share the
same set of security parameters.
The HPLMN ProSe Function of the Discoverer has to retrieve both Codes (Query
and Response) and their security parameter sets from the PLMN of the
Discoveree, via messages 6-7.
Messages 9 and 10 occur over the PC5 interface.
Messages 11 through 13 describe the Match Report procedure from the Discoverer
UE. A Match Report procedure from the Discoverer is optional, and may be
subject to configuration by the ProSe Function at the time the Discoverer
undertakes the Discoverer UE procedure before discovery. The ProSe Function of
the Discoverer UE does the MIC checking itself, without contacting the ProSe
Function of the Discoveree UE again, but using the necessary security
parameters received via steps 6-7.
#### 8.3.9.4 Security procedures for model A
Model A uses the procedure as follows (for simplicity, non-roaming case is
shown, and the interaction with HSS is omitted):
Figure 8.3.9.4-1: Discovery procedure, Model A: obtaining security parameters
In Figure 8.3.9.4-1, steps 1 through 4 describe the simplified \"Announce
Request procedure for restricted discovery (roaming)\" of clause 5.3.3.3A of
[32].
1: as Step 1 of clause 5.3.3.3A of [32]
2: as Step 2a of clause 5.3.3.3A of [32]
3: as Step 2b of clause 5.3.3.3A of [32]
4a: the ProSe Function allocates ProSe Code and selects Security Parameters.
If the A-UE is roaming, then between steps 4a and 4b, the H-PLMN ProSe
Function initiates an Announce Auth/Ack transition with the V-PLMN ProSe
Function of the announcing UE, but no security parameters are exchanged, as in
steps 4 and 5 of clause 5.3.3.3A of [32].
4b. As in step 6 of clause 5.3.3.3A of [32], the Discovery Response message
the ProSe Function sends back to the Announcing UE contains the Security
Parameters to protect the assigned ProSe Code over PC5.
Steps 5 through 12 describe the simplified \"Monitor Request procedure for
restricted discovery (-roaming)\' of clause 5.3.3.5A of [32]:
5: as Step 1 of clause 5.3.3.3A of [32]
6: as Step 3 of clause 5.3.3.3A of [32].
7: as Step 4 of clause 5.3.3.3A of [32]
8: as Step 6 of clause 5.3.3.3A of [32].
9: as Step 8a of clause 5.3.3.3A of [32]
10: as Step 8b of clause 5.3.3.3A of [32]
11: as Step 9 of clause 5.3.3.3A of [32]. The HPLMN ProSe Function of the
Announcing UE already has the Security Parameters associated with the ProSo
Code to be monitored for. The HPLMN ProSe Function of the Monitoring UE has to
retrieve ProSe Code and Security Parameters from the HPLMN of the Announcing
UE.
12: as Step 10 of clause 5.3.3.3A of [32], the Discovery Response message the
ProSe Function sends back to the Monitoring UE contains the Security
Parameters to undo the protection of the ProSe Code present in the Discovery
Filter.
Messages 13 and 14 occur over the PC5 interface.
> Message 15 is the Match Report procedure from the Monitoring UE. A Match
> Report procedure may be skipped. Note that the HPLMN of the Monitoring UE is
> able to do the MIC checking, if requested, without having to contact the
> other PLMN, since it already received the Security Parameters in step 11.
### 8.3.10 Solution #8.3.10: Confidentiality of ProSe identifiers in PC5
interface
#### 8.3.10.1 New definitions specific to this solution
dCK: Discovery Confidentiality Key is a shared secret between two or more
ProSe UEs optionally used to encrypt/decrypt ProSe Code, ProSe Query Code or
ProSe Response Code sent over the air in PC5 interface.
Temporary Decryption Mask: A PC5 message specific temporary mask optionally
used to decrypt protected ProSe Code, ProSe Query Code or ProSe Response Code
in that message. The UE needs the Discovery Confidentiality Key to produce the
mask.
Temporary Encryption Mask: A PC5 message specific temporary mask optionally
used to encrypt protected ProSe Code, ProSe Query Code or ProSe Response Code
in that message. The UE needs the Discovery Confidentiality Key to produce the
mask.
#### 8.3.10.2 General
This solution addresses Key Issue #7.3.1 in the present document addressing
the risk of tracking of UE or a group of UEs when the same codes (e.g. ProSe
Code, ProSe Query Code or ProSe Response Code) are repeatedly sent on PC5.
This solution assumes that even without encryption a ProSe UE possesses a
filter that includes a code, and a mask. The ProSe UE needs to be able to
discover not only a full code, but also a fragment of a code that may indicate
for example that the code is related to some group, organization or
application. Discovery of certain part of the code is assumed to done using a
procedure similar to the Release 12 match event specified in clause 6.2.3.4 of
TS 24.334 [35]. This procedure includes calculating a bitwise AND operation
between the code and the mask. This essentially means that several different
codes received from the PC5 interface may need to be discovered using a single
Discovery Filter.
This solution is using a similar principle of changing the ProSe identifiers
announced/broadcases over the air interface than solution #8.3.2. Instead of
using a one-way hash function to create temporary identifiers, this solution
is using the hash function to create a Temporary Encryption/Decryption Mask.
Encryption/decryption operations are done using a bitwise XOR operation
between the ProSe Code and the Encryption/Decryption Mask.
#### 8.3.10.3 Solution details
The proposed Temporary Encryption/Decryption Mask is counted using a one-way
hash function. Fresh input to the calculation of the mask is provided by using
the MIC related to the message. In the encrypting UE side, the MIC has been
counted before the encryption operation. In the decryption UE side, the MIC is
visible as a clear text in the message received from the PC5 interface. There
is also a shared secret component that is called here as Discovery
Confidentiality Key (dCK). dCK is the other input to the one-way hash function
in order to make the Encryption/Decryption Mask unique between certain UEs. It
is assumed that the used one-way hash function produces longer than 184 bits
output, and the output needs to be truncated to match the length of the code.
184 bits is the current maximum length of the code, but this solution will
propose that the length of the Temporary Encryption/Decryption Mask vary in
length between 161-181 bits. Figure 8.3.10.3-1 demonstrates the process of
creating the Temporary Encryption/Decryption Mask.
{width="6.70625in" height="2.4055555555555554in"}
Figure 8.3.10.3-1: Creation of Temporary Encryption/Decryption Mask
This solution proposes that only part of the ProSe Code is encrypted. The PLMN
ID part of the ProSe Code is not encrypted because it does not include
sensitive data and by leaving this part as a clear text, the solution makes it
possible for the receiving UE to ignore some messages without doing the
decryption operation. Temporary ID part of the ProSe Code is encrypted if
encryption feature is used. This essentially means that the PLMN ID part tells
the length of the Temporary Encryption/Decryption Mask which is between
161-181 (184 bits minus PLMN ID bits where PLMN ID bits vary between 3 and 23
in length).
Each PC5 message includes an 8-bits long Message Type field. This field is
used to indicate the type of the discovery, e.g. Open, Restricted, Model A,
Model B. It is proposed that one new bit is reserved for indicating if the
ProSe Code carried in the PC5 is encrypted or not. This encryption bit could
potentially apply to all discovery types. The encryption bit makes it possible
to do some filtering before decryption operations. For example, UE that is
interested in encrypted codes only, can leave all unencrypted codes
unprocessed. UE that is interested in clear-text codes only, can leave all
encrypted codes unprocessed.
NOTE 1: There is no technical reason why the PLMN ID part of the message could
not be encrypted. The proposal is based only on efficiency reasons. If the
PLMN was owned by e.g. a public safety organization, encrypting also the PLMN
part could make sense. It is recommended that if both variants are
standardized, they are given two different Message Type indicators in order to
facilitate interoperability between the UEs.
NOTE 2: This mechanism is assumed to be optional; however, it can easily be
modified as a mandatory feature to cover all Restricted Direct Discovery
messages sent over PC5 interface. If made mandatory, the new encryption
indication bit added in this solution to the Message Type is not needed
because all codes are encrypted.
Figure 8.3.10.3-2 demonstrates the decryption operation.
{width="6.696527777777778in" height="3.3291666666666666in"}
Figure 8.3.10.3-2: Decryption of the ProSe Code received over the PC5 in
restricted discovery messages
#### 8.3.10.4 Distribution of Discovery Confidentiality Keys
Editor\'s note: Distribution of dCKs is FFS. It is currently assumed that dCK
are distributed with the Discovery Keys related to the protection of PC5
interface with Message Integrity Codes. However, there are currently many
alternative solutions, and it is not clear which one should be used.
Alternatively, each security solution wishing to use this solution as a
mechanism for encrypting the codes in PC5 interface are free to specify how
the dCK could be distributed in relation to Discovery Keys.
### 8.3.11 Solution #8.3.11 Protecting a Restricted Discovery Message (Model A
and Model B)
#### 8.3.11.1 General
This solutions describes how a discovery message is protected between two UE
based on security information provided to the UEs by their respective HPLMN
ProSe Function. A companion solution #8.3.9 describes the flows that allocate
that security information.
#### 8.3.11.2 Overview of solution
The applicable security measures are as follows:
1\. Integrity of entire ProSe Code: If needed, this can be done via ProSe-
Function-checked MICs just like for Open Discovery or by a locally checked MIC
as described in this contribution. In the former case, the ProSe Function
needs to provide the announcer/discoveree with a Discovery Key. In the latter
case, both announcer and monitorer (discoveree/discoverer) UEs need to be
provided with the information to able to calculate an integrity key. The ProSe
Functions indicate which kind of integrity will be used for each ProSe Code as
part of the Announce Request or Monitor Request procedures.
2\. Anti-replay/tracking/impersonation of the ProSe Code: This can be achieved
as in solution 8.3.2 of the current TR, but applying time-hashing to the
message.
3\. Confidentiality of the user specific bits: If needed, this can be done via
XORing the user specific bits with a keystream derived from a key given by the
Prose Function as associated with the assigned Prefix. In the case of a
discovery filter that finds only one UE, this can be done by the time-hashing
for 2 above (that is described below). Otherwise it is done as described below
using a key that is specific for confidentiality and should be different for
each UEs.
One solution can be as follows: A UE (that is either sending or receiving a
discovery message) is provided with a Discovery User Master Key (DUMK) for an
assigned ProSe Code for the sending UE and a discovery filter for the
receiving UE. From this DUMK, a UE calculates as necessary:
Discovery User Scrambling Key (DUSK), to calculate a time-hash bitsequence
Discovery User Integrity Key (DUIK),
Discovery User Confidentiality Key (DUCK), to protect the suffix if there is
one.
The ProSe Function also provides mask(s) (of the same length as the ProSe
Code) to indicate several needed parameters -- the presence of these Masks and
other parameters inform the UE what security to apply in this case:
Key_calc_mask: selects which bits of message are used to calculate the
DUCK/DUIK from the DUMK;
\- If a sending UE gets Key_calc_mask and no discovery key from the ProSe
Function for a particular ProSe Code, then it applies integrity use the DUIK
associated to that ProSe code to messages containing that ProSe Code.
Similarly if a receiving UE gets Key_calc_mask and no MIC Refresh timer (from
Rel-12 open discovery -- see TS 33.303 [33]), it checks the integrity of
message for a particular discovery filter using the DUIK associated with that
discovery filter.
\- Encrypted_bits_mask: selects which bits are protected by DUCK (as opposed
to the DUSK). This may be set to all zeros if the is no suffix.
\- If the sending UE or receiving UE get both Key_calc_mask and
Encrypted_bits_mask from the ProSe Function, then it applies or removes
confidentiality based on DUCK respectively.
\- Scrambled_bits_mask: selects which bits scrambling protects (time-hash
applied before announcing/ right after receiving). This could be set to all
ones (i.e. select all the bits in the ProSe Code)
\- The sending or receiving UE gets the Scrambled_bits_mask, so it can apply
or remove time-hashing to/from the message respectively.
Editors\' Note: It is FFS whether to use the same or different masks (i.e. a
different Key_calc_mask ) for each case to calculate the DUCK and DUIK.
#### 8.3.11.3 Security procedures
##### 8.3.11.3.1 UE checked integrity
Both UE sending and receiving discovery message calculate the MIC as shown in
Figure 8.3.11.3.1-1:
Editor\'s note: The need for the using the (key_calc_mask and message) as an
input to KDF1 is FFS.
{width="6.108333333333333in" height="3.5277777777777777in"}
Figure 8.3.11.3.1-1: Calculating the UE checked MIC
##### 8.3.11.3.2 Scrambling time-hashing
Both the UE sending and the UE receiving a discovery message calculates the
DUSK from DUMK. From it, a \"Scrambling Time Hash\" bitsequence is computed
and then XOR\'ed into the Discovery Message before sending (for receivers, it
is XOR\'ed into the received Discovery Message to recover the original
Message). The receiving side can then check for matches.
This processing is shown in Figure 8.3.11.3.2-1:
{width="6.816666666666666in" height="2.942361111111111in"}
Figure 8.3.11.3.2-1: Processing of the Scrambling time hash (announcer)
We note that unlike the already-proposed solution where the time-hash depends
on the Prefix and its length, this time-hash is based on a key with an
appropriate length, not dependent on the Prefix length.
##### 8.3.11.3.3 Message specific confidentiality
Both the UE sending and the UE receiving a discovery message calculates the
DUCK from DUMK. The encryption is applied as shown in Figure 8.3.11.3.3-1:
{width="6.327083333333333in" height="4.323611111111111in"}
Figure 8.3.11.3.3-1: Processing of confidentiality protection
Here we note that the sender UE (announcer) uses the bitsequence output of the
AND operation to XOR into the Message that is formed by the application
(prefix and suffix, unaltered). The receiver does the inverse operation.
#### 8.3.11.4 Processing of Discovery Message at the UEs
1\. Form the discovery message
2\. If the sending UE received a Discovery Key with the ProSe Code, then the
sender adds a MIC calculated as in Rel-12. Otherwise if the sending UE
received a Key_calc_mask, it applies integrity protection using DUIK as
described above. If no integrity was applied then an all zero MIC is appended
to the message to keep the final message the same length as the others.
3\. If the sending UE received an Encrypted_bits_mask, it applies the message
specific confidentiality as described above.
4\. The sending UE performs the Scrambling time-hashing as described above.
Summary of steps for the receiving UE:
1\. For each of its discovery filters, the receiving UE calculates the
Scrambling Time Hash, selects the Scrambed_bits_mask; then XOR the result with
the received TempID from the PC5 Discovery Message detected. It then checks if
there is a match. If so, proceed to next step.
2\. If the receiving UE received an Encrypted_bits_mask in the Discovery
Filter, it removes the message specific confidentiality as described above.
3\. If the receiving UE has a MIC Refresh Timer associated with the discovery
filter, then it performs the Match Report procedure as in Rel-12 (e.g. first
match for a ProSe Code or MIC Refresh timer has expired). Otherwise if it
received a Key_calc_mask associated with the discovery filter, it checks the
MIC using the UE checked integrity procedures described above.
4\. The receiving UE has recovered the original Discovery Message.
#### 8.3.11.5 ProSe Function control of used security
If the security requirements are:
Scrambling only, then the PF sends the DUMK plus the Scrambled_bits_mask. This
is the most basic security requirement, always applicable
Scrambling plus UE-checked integrity: The PF sends the above plus the
Key_calc_mask
Scrambling plus UE-checked integrity plus confidentiality: the PF sends the
above plus the Encrypted_bits_mask
Scrambling plus PF-checked MIC: DUMK plus the Scrambled_bits_mask, and the
Discovery Key (only to the Announcer), and a MIC refresh timer (only to the
Monitorer).
Scrambling plus PF-checked MIC plus confidentiality: The PF sends the above
plus Encrypted_bits_mask.
### 8.3.12 Solution #8.3.12: Security for PC2 interface in Restricted Direct
Discovery
#### 8.3.12.1 General
This solution addresses the security requirements in key issue \'#7.3.2:
Security --PC2 interface in Restricted ProSe Direct Discovery\'.
It is assumed that the ProSe Application Server is controlled by a business
partner i.e. a 3rd party.
#### 8.3.12.2 Solution description
Since the ProSe Application Server is not considered as 3GPP network function
then this interface should be protected using TLS/TCP, DTLS/SCTP or IKE/IPsec
mechanisms as defined for Tsp in TS 33.187 [36] and MB2 in TS 33.246 [37].
If the interface between the ProSe Function in the 3GPP network and the ProSe
Application Server can be trusted, e.g. physically protected, there is no need
to use protection via cryptographic means mentioned above.
8.3.13 Solution #8.3.13: Security for Restricted Discovery with application-
controlled extension
8.3.13.1 General
This solution addresses the requirements in key issue #7.3.1 and is the
security part of the solution in clause 5.3 of TR 23.713 [32].
8.3.13.2 Solution description
To support Restricted Discovery with application-controlled extension, the
ProSe Code contains a prefix, which is assigned by the ProSe Function, and a
suffix, which is application-controlled.
The following identifiers are defined:
**ProSe Code Prefix** : In Discovery with application-controlled extension, a
part of the ProSe Code that is assigned by the ProSe Function.
**ProSe Code Suffix** : In Discovery with application-controlled extension, a
part of the ProSe Code that is under the control of the announcing
application. The ProSe Code Suffix represents application specific information
pertaining to the application that is indicated in the Restricted ProSe App
User ID.
This security solution of Restricted Discovery with application-controlled
extension only applies integrity protection of ProSe Code Prefix and Prose
Code Suffix. It includes 3 procedures: Announce Request procedure, Monitore
Request procedure and Match Report procedure. For simplicity, some steps in
the following procedures are referring to steps described in clause 5.1 and
5.3 of TR 23.713 [32] if they are identical.
Editor\'s Note: The Use case and value of checking 2 MICs separately needs to
be explained.
8.3.13.3 Announce Request procedure
In Figure 8.3.13.3-1, security Announce Request procedure for Restricted
Discovery with application-controlled extension is presented, changes from
procedure in clause 5.3.2.1 of TR 23.713 [32] is highlighted in red.
Figure 8.3.13.3-1: Announce Request procedures for Restricted Discovery with
application-controlled extension
0\. to 2.b As in clause 5.3.2.1 of TR 23.713 [32].
3\. As in clause 5.3.2.1 of TR 23.713 [32], with the following change: The
Prose Function in HPLMN generates a Prefix Key for the ProSe Code Prefix, and
a Suffix Key for each Prose Code Suffix in the ProSe Code Suffix Pool.
4\. to 5. As in clause 5.3.2.1 of TR 23.713 [32].
6\. As in clause 5.3.2.1 of TR 23.713 [32], with the following change: The
Prefix Key and the Suffix Key(s) are also included in the message.
7\. As in clause 5.3.2.1 of TR 23.713 [32].
8.3.13.4 Monitor Request procedure
In Figure 8.3.13.4-1, security Monitor Request procedure for Restricted
Discovery with application-controlled extension is presented, which is
identical with procedure in clause 5.3.2.2 of TR 23.713 [32].
Figure 8.3.13.4-1: Monitor Request procedures for Restricted Discovery with
application-controlled extension
0\. to 11. As in clause 5.3.2.2 of TR 23.713 [32].
8.3.13.5 Match Report procedure
In Figure 8.3.13.5-1, security Match Report procedure for Restricted Discovery
with application-controlled extension is presented, changes from procedure in
clause 5.1.2.5 of TR 23.713 [32] is highlighted in red.
Figure 8.3.13.5-1: Match Report Request procedures for Restricted Discovery
with application-controlled extension
1\. As in clause 5.1.2.5 of TR 23.713 [32], with the following change: The
ProSe Code is replaced by ProSe Code Prefix. The Prefix MIC, ProSe Code
Suffix, Suffix MIC, UTC Counter and 4 LSBs of Counter are also included in the
message.
2\. As in clause 5.3.2.1 of TR 23.713 [32].
3\. As in clause 5.3.2.1 of TR 23.713 [32], with the following change: The
Prose Code is replaced by ProSe Code Prefix. The Prose Function in HPLMN
checks Prefix MIC and Suffix MIC.
4.a to 5. As in clause 5.3.2.1 of TR 23.713 [32], with the following change:
6\. As in clause 5.3.2.1 of TR 23.713 [32], with the following change: The
ProSe Code is replaced by ProSe Code Prefix. The Prose Code Suffix is also
included in the message.
### 8.3.14 Solution #8.3.14: Hint of scrambling key
#### 8.3.14.1 General
This solution addresses the requirements in key issue #7.3.1: Restricted ProSe
Direct Discovery (Model A and B). The solution is a partial solution related
to scrambling, and intends to make the verification of confidentiality
protected ProSe Codes more efficient.
#### 8.3.14.2 Solution description
It is proposed that PC5 message is enhanced with a 6 bits long hint of
scrambling key (see Figure 8.3.14.2-1). The hint is similar to key identifier;
however, it does not identify the key but only gives a hint which key to try.
The reason why key identifier cannot be used is because it would make it
possible to track the UE which was the original reason of introducing the
scrambling in the first place.
Figure 8.3.14.2-1: Enhanced PC5 message with hint of scrambling key
Editor\'s note: The frequency on which the key hint is changing increases the
risk of tracking if there are only few UEs around, the frequency of changing
the key hint is short, and the UEs use different UTC masks. The exact impact
on the security is FFS.
When a sending UE receives the scrambling key, it counts a static hint string
related to that key and stores it. Before sending the confidentiality
protected message over the PC5 interface, the UE adds a key hint to the
message. The key hint is calculated using the Masked UTC counter specified in
Solution #8. 3.16: Masked UTC counter.
When a UE receives a message from the PC5 interface, it first checks the hint
of scrambling key. If it does not have a scrambling key that has the same key
hint, it does not further process the message but ignores it. Note that in
this phase the UE may need to re-calculate the key hint if the Masked UTC
counter has changed the value. If the hint matches one of the hints of the
scrambling keys, the UE proceeds to the verification of the ProSe Code. The UE
may have more than one scrambling key that have the same key hint, and
consequently it needs to try all of them for the received message.
The hint string is calculated using a one-way hash function over the
scrambling key:
For Restricted Discovery Model A, the key hint is:
\- Hint_string_C = one-way hash(scrambling key, \"prosecode\")
For Restricted Discovery Model B, the key hints are:
\- Hint_string_Q = one-way hash(scrambling key, \"querycode\")
\- Hint_string_R = one-way hash(scrambling key, \"responsecode\")
The actual key hint is calculated using the Masked UTC counter specified in
Solution #8. 3.16: Masked UTC counter. The Annouced TempID is calculated
according to solution #8.3.15.3.2.
{width="4.451388888888889in" height="1.9930555555555556in"}
Figure 8.3.14.2-2: Key hint calculation using Masked UTC counter
### 8.3.15 Solution #8.3.15 Protecting a Restricted Discovery Message (Model A
and Model B)
#### 8.3.15.1 General
This solutions describes how a discovery message is protected between two UE
based on security information provided to the UEs by their respective HPLMN
ProSe Function. A companion solution #8.3.9 describes the flows that allocate
that security information. It is proposed to be a simpler alternative to the
solution #8.3.11. The main difference is that the UE is directly supplied the
keys need to provide the needed security protections rather than give a master
key. Also the security procedures can be applied in one step.
#### 8.3.15.2 Overview of solution
The applicable security measures are as follows:
1\. Integrity of entire ProSe Code: If needed, this can be done via ProSe-
Function-checked MICs just like for Open Discovery or by a locally checked
MIC. In the former case, the ProSe Function needs to provide just the sending
UE with a key for integrity protection. In the latter case, both UEs need to
be provided with integrity key. The ProSe Functions indicate which kind of
integrity will be used for each ProSe Code as part of the Discovery Request
procedures. 2. Scrambling the code to provide anti-
replay/tracking/impersonation of the ProSe Code: Scrambling provides integrity
protection for parts of a message that do not vary for a particular scrambling
key and hence makes checking integrity of unnecessary in all cases.
3\. Message specific confidentiality of the user specific bits: If needed,
this can be done via XORing the user specific bits with a keystream derived
from a key given by the Prose Function as associated with the assigned Prefix.
In the case of a discovery filter that finds only one UE, this can be done by
the scrambling in 2 above (that is described below). Otherwise it is done as
described below using a keystream that is specific for confidentiality and
should be different for each UEs.
A UE (that is either sending or receiving a discovery message) is provided
with a following for an assigned ProSe Code for the sending UE and a discovery
filter for the receiving UE as needed:
Discovery User Scrambling Key (DUSK), to calculate a time-hash bitsequence
Discovery User Integrity Key (DUIK), to provide integrity protection
Discovery User Confidentiality Key (DUCK), to provide confidentiality of user
specific bits.
The ProSe Function also provides an Encrypted_bits_mask if along with the
DUCK. This selects which bits are protected by the message specific
confidentiality.
For MIC checking at the ProSe Function, the ProSe Function has the DUIK. In
this case the UE is provided with an indication that it should use Match
Reports for MIC checking.
The security mechanism of adding/checking a MIC, scrambling and message
specific confidentiality can be combined together in many ways to provide
different overall security protection of ProSe Code over the PC5 interface.
Not all such combinations are suitable for restricted discovery as without
scrambling it would be possible to track (some of the other combinations may
be suitable for Public Safety Discovery where the threats are different).
Table 8.3.15.2-1 lists the combinations of security mechanisms that are
proposed for the protection of codes in restricted discovery. The particular
security mechanisms used in each combination are indicated by listing the keys
used at each side. On the receiving side, when a DUIK is included, the MIC
could be checked at either the UE or (except for ProSe Query Codes where Match
Reports are not used) at the ProSe Function. The security mechanism applied to
a ProSe Query Code may differ from those applied to a ProSe Response Code.
Table 8.3.15.2-1: Different combination of security mechanism for restricted
discovery
+---------------------+---------------------+------------------------+ | Sending UE | Receiving Side | Comments and/or | | | | example uses case | +---------------------+---------------------+------------------------+ | DUSK and DUIK | DUSK | Only one ProSe code | | | | protected by DUSK and | | | | hence scrambling | | | | provides integrity | | | | protection | +---------------------+---------------------+------------------------+ | | DUSK and DUIK | Either one user | | | | sending Application | | | | Controlled Extension | | | | bits or several users | | | | sending unique codes | | | | | | | | MIC checking is | | | | performed at either | | | | the ProSe Function or | | | | UE | +---------------------+---------------------+------------------------+ | DUSK, DUIK and DUCK | DUSK | DUSK applies to | | | | exactly one full code | | | | and ciphered | | | | Application Controlled | | | | Extension bits | | | | included in the | | | | message but are not | | | | decryptable by this | | | | receiver as it was not | | | | given DUCK. The | | | | receivers allowed to | | | | decrypt the | | | | Application Controlled | | | | Extension Bits would | | | | need DUSK, DUIK and | | | | DUCK. | +---------------------+---------------------+------------------------+ | | DUSK, DUIK and DUCK | More than one sender | | | | using the same DUSK | | | | and there are | | | | Application Controlled | | | | Extensions bits that | | | | are | | | | encrypted/decrypted | | | | using DUCK | | | | | | | | MIC checking is | | | | performed at either | | | | the ProSe Function or | | | | UE | +---------------------+---------------------+------------------------+
#### 8.3.15.3 Security procedures
##### 8.3.15.3.1 UE checked integrity
The sending UE does the following
1\. Compute output bitsequence from DUIK, Message, and UTC-based counter
passed through a MIC calculation function.
2\. Take the first 4 bytes of the output and set that as the value of the MIC
for this Message.
The receiving UE does the exact same steps but also does a comparison between
the computed MIC and the received MIC.
Both the UE sending and receiving discovery message or the ProSe Function
checking the MIC calculate the MIC as shown in Figure 8.3.15.3.1-1:
Figure 8.3.15.3.1-1: Calculating the MIC
##### 8.3.15.3.2 Scrambling time-hashing
The sending UE does the following:
1\. Compute time-hash-bitsequence from DUSK and UTC-based counter passed
through a keyed hash function.
2\. XOR the time-hash-bitsequence with the entire \"Message\" (part of the
Discovery Message being processed to get ready to send)
The receiving UE does the exact same steps except applied to the received
message being processed.
This processing is shown in Figure 8.3.15.3.2-1:
{width="5.725in" height="1.2868055555555555in"}
Figure 8.3.15.3.2-1: Processing of the Scrambling time hash (announcer)
We note that unlike the already-proposed solution where the time-hash depends
on the Prefix and its length, this time-hash is based on a key with an
appropriate length, not dependent on the Prefix length.
##### 8.3.15.3.3 Message specific confidentiality
Sending UE does the following:
1\. Compute the Key_calc_mask as the bits not covered by Encrypted_bits_mask,
plus 4 bytes of 1s for MIC
2\. Compute keystream from the DUCK, UTC-based counter, Key_calc_mask, Message
and MIC passed through a KDF.
3\. AND the keystream with the Encrypted_bits_mask.
4\. XOR the result of step 4 above with the (unscrambled, but not containing
the MIC) Message being processed for sending.
Monitorer does the exact same steps except applied to the received Message
being processed.
The confidentiality calculation is shown in Figure 8.3.15.3.3-1:
Figure 8.3.15.3.3-1: Processing of confidentiality protection.
Here we note that the sender UE (announcer) uses the bitsequence output of the
AND operation to XOR into the Message that is formed by the application
(prefix and suffix, unaltered). The receiver does the inverse operation.
#### 8.3.15.4 Processing of Discovery Message at the UEs
The UE sending the discovery message gets the following security parameters
with the ProSe Code:
DUSK -- mandatory
DUCK -- optional
Encrypted_bits_mask (mandatory with DUCK)
DUIK -- mandatory
The sending UE does the following steps:
1\. Form message (e.g. add Suffix if only Prefix was allocated). 2. Calculate
MIC and add to the message
3\. If DUCK received, add message specific confidentiality:
a. Compute Key_calc_mask = (Encr_bits_mask XOR 0xFF...F) \|\| 0xFFFFFFFF
b. Key_stream = FKDF (DCK, Time, (Key_calc_mask AND (Message+MIC))) AND
Encrypted_Bits_Mask
d. XOR Key_stream into Message
4\. Add scrambling
a. Calculate time hash sequence
b. XOR time-hash sequence into Message and MIC
The UE receiving the discovery message is provided the following with the
Discovery Filter containing a ProSe Code:
> DUSK -- mandatory
>
> DUCK -- optional
>
> Encrypted_bits_mask (mandatory with DUCK)
>
> DUIK or Indication to use PF MIC checking -- mandatory if DUCK not included,
> otherwise optional
NOTE: Both UE and PF MIC checking may only be omitted when the scrambling
provides integrity protection of the message bit relevant to the receiving UE.
The receiving UE does the following steps:
1\. If received DUSK, then undo scrambling (as in step 4 of Announcing UE)
2\. Check for partial match on bits not encrypted by any message specific
confidentiality. If no match, then abort
3\. Undo message specific confidentiality (as in step 3 of Announcing UE)
4\. Check for full match if applicable. If not match then abort
5\. Check MIC directly if it received DUIK or via Match Report if received the
Indication to use PF MIC checking
### 8.3.16 Solution #8.3.16: Masked UTC counter
#### 8.3.16.1 General
This solution addresses the requirements in key issue #7.3.1: Restricted ProSe
Direct Discovery (Model A and B). The solution is a partial solution related
to scrambling, and intends to make the verification of confidentiality
protected ProSe Codes more efficient.
#### 8.3.16.2 Solution description
It is proposed that in the context of scrambling, the UTC based counter is
slowed down in order to make the system more efficient, and more persistent
towards Denial-of-Service attacks while still making the tracking of ProSe UEs
difficult for the attacker.
> NOTE 1: Masked UTC counter can be used as an input parameter to scrambling
> (solution in clause 8.3.15) or as an input parameter to key hint calculation
> (solution in clause 8.3.14). If used for scrambling, however, it would be
> better to have one or very few UTC masks for several UEs in the area in
> order to prevent the tracking being based on the frequencies of the masked
> UTC counters. This solution does not take a stand in which context it is
> used.
The UTC based counter can be slowed down using a new UTC mask. The UTC mask is
essentially hiding some least significant bits of the UTC based counter making
the counter change its value less frequently. The masked UTC counter value is
a bitwise AND operation between the UTC mask and the UTC based counter (see
Figure 8.3.16.2-1).
> NOTE 2: UTC based counter is used for other purposes too, e.g. for MIC
> calculation. This solution does not introduce any changes to how the UTC
> based counter is used except when used with scrambling.
{width="5.321527777777778in" height="1.3625in"}
Figure 8.3.16.2-1: Masked UTC counter
The UTC mask is distributed by the ProSe Function of the Discoveree/Announcing
UE as a security parameter related to the Direct Discovery.
## 8.4 Solutions for Direct Discovery (public safety use)
### 8.4.1 Solution #8.4.1: Direct Discovery (public safety use)
#### 8.4.1.1 Security key for discovery message protection
The UE transmitting the discovery message for group member discovery is a
member of one or more groups. ProSe Function provides the Public Safety ProSe-
enabled UEs with the all the necessary keying material and chosen algorithms
that are used to protect the data sent between the Public Safety ProSe-enabled
UE(s). In Rel-12, the PGK is used for securing data packets for one-to-many
communication. For Public Safety discovery (in and out of coverage), PGK is
used for securing discovery message in addition to securing data packets for
one-to-many communication. The security keys for securing discovery message
and for securing data packets for group communication is derived as shown in
Figure 8.4.1.1-1. For example, two Prose Traffic Keys, PTK~i~ and PTK~i+1~ are
derived from the PGK for securing discovery message and securing data packets
of a group respectively, if simultaneously used.
> PTK~i~ = KDF (PGK, PGK ID, PTK ID ~i~, Group member identity of
> transmitter).
The PTK is computed using the current value of the PTK ID. For example, PTK~i~
is used to derive PIK (for integrity protection of PS discovery message), then
PTK~i+1~ is used to derive PEK (for encrypting PS one-to-many communication).
The chosen algorithm for message integrity check is provided by the ProSe
Function along with chosen encryption algorithm. One PGK and two PTKs are
active per group in the PS enabled UE.
> {width="5.779861111111111in" height="1.7666666666666666in"}
Figure 8.4.1.1-1: Security key derivation for discovery message protection
(Public safety use)
Discovery message is protected in ProSe Protocol and group communication
packets are protected in PDCP protocol.
Editor\'s Note: Need to check with SA2/RAN2 for the specific protocols (how
the discovery messages are sent) to apply security.
#### 8.4.1.2 Discovery message protection mechanism
The discovery message protection mechanism is shown in Figure 8.4.1.2-1. The
security key specific to member (detailed in the clause 8.4.1.1), discovery
information to be transmitted and time stamp (time counter) corresponding to
discovery slot in which discovery information is transmitted are inputs to
security algorithm to derive MIC. MIC, PGK ID, PTK ID and 4LSBS of time
counter together with discovery information is transmitted by the transmitter.
The Source UE ID and Group ID are also added in discovery message. They can be
added in PS discovery information or added in lower protocol headers (e.g. MAC
header). The receiving UE determine the security key used using PGK ID, PTK
ID, source UE ID and Group ID received. The receiving UE then verify MIC using
the determined security key.
Editor\'s Note: Need to check with SA2/RAN2 for the specific fields in the PS
discovery message, for inclusion of Source UE ID and Group ID in the discovery
message.
{width="4.530555555555556in" height="2.7736111111111112in"}
Figure 8.4.1.2-1: Discovery message protection (Public safety use)
Editor\'s Note: It needs to be determined, the applicability of this solution
when a prose group (for communication) is not deployed.
### 8.4.2 Solution #8.4.2: Direct Discovery (public safety use)
#### 8.4.2.1 Authentication and Key Agreement for ProSe Direct Discovery using
identity-based cryptography
The security solution uses The \"Elliptic Curve-based Certificateless
Signatures for Identity-based Encryption\" (ECCSI) signature scheme, as
defined in IETF RFC 6507. And optionally, Sakai-Kasahara Key Encryption
(SAKKE) algorithm used to exchange a shared secret from a Sender to a
Receiver, as defined in IETF RFC 6508.
A Key Management Server (KMS), as defined in IETF RFC 6507 and 6508, is used
to provision credentials for secure ProSe Direct Discovery operation in the
UE. The solution uses IETF RFC 6507 and RFC 6509 to provide authentication
feature for ProSe direct discovery with both Model A and B. And optionally, it
uses IETF RRC 6508 and 6509 to provision the two UEs with a shared session key
that can be used to encrypt all future data exchanged between the two UEs when
ProSe direct discovery with Model B is used.
The overall solution is described in the following sub-sections: 1)
Provisioning Credential for ProSe Direct Discovery operation 2) Authentication
and Key Agreement for ProSe Direct Discovery operation.
##### 8.4.2.1.1 Provisioning Credential for ProSe Direct Discovery operation
The UEs are provisioned with the required credentials (as defined in IETF RFC
6507 and 6508) in advance, where the UEs have a secure access to the KMS.
The KMS, common root of trust for the UEs, provisions the UEs with a set of
credentials for ECCSI and optionally SAKKE schemes.
Upon successful provisioning for ECCSI, each UE will be configured with the
public key of the KMS, and a set of credentials associated with the UE\'s
identity, which are: Secret Signing Key (SSK) and Public Validation Token
(PVT). The UE acts as \"signer\" and \"verifier\". As a signer, the UE uses
its SSK to sign a message, and when acting as a verifier, the UE uses the
public key of the KMS and the signer\'s PVT to verify the signature.
Upon successful provisioning for SAKKE, each UE will be configured with the
public key of the KMS, and a Receiver Secret Key (RSK) which is associated
with the UE\'s identity. The sender UE uses the receiver\'s UE identity
(receiving entity for SAKKE payload) and the public key of the KMS to create
an encrypted SAKKE payload. The receiving UE uses its identity and the public
key of the KMS to decrypt SAKKE payload.
The public identity of a UE may be encoded in any format that is compatible
with the guidelines provided in RFC 6509. For example, the public identity of
a UE may be a concatenation of a fixed part (in the form of IMSI, SIP URI, TEL
URI, other user\@domain types of URI, etc.) and a varying part (in the form of
a timestamp).
Editor\'s note: Use of any public / private keys schemes for signature will
include communication overhead. With ECCSI scheme in RFC 6507, the signature
is at least 512 bits. Therefore, the communication overhead over the air
interface needs to be carefully considered.
Editor\'s note: It is FFS to determine if we can achieve open (i.e., not
authenticated) discovery while maintaining the necessary security, e.g. by
performing authentication after the discovery is complete.
##### 8.4.2.1.2 Authentication and Key Agreement for ProSe Direct Discovery
operation
##### 8.4.2.1.2.1 Group Member Discovery with Model A {#group-member-
discovery-with-model-a .H6}
Figure 8.4.2.1.2.1-1 illustrates authentication feature for Group Member
Discovery with Model A, using ECCSI.
{width="6.3493055555555555in" height="1.9951388888888888in"}
Figure 8.4.2.1.2.1-1: Authenticated Group Member Discovery with Model A
A process of authenticated Group Member Discovery with Model A may include the
following:
1\. UE-1 (in the role of \"announcing UE\") periodically transmits a discovery
message including the following parameter settings:
\- Type = Announcement
\- Discovery Type = Group Member Discovery
\- Announcer Info = upper layer information about the user of the announcing
UE. This information is used to derive the Signer\'s identifier (used by
ECCSI).
\- ProSe UE ID = the Layer-2 ID of the announcing UE. When PC5 Signalling
Protocol is used to transport the Announcement message, the ProSe UE ID may be
carried in the Source Layer-2 ID field of the MAC frame
\- SIGN = an ECCSI signature of the Announcement message. The signature may be
computed over all or a subset of the parameters in the message. At a minimum
the signature is computed over the Announcer Info parameter.
2\. Upon reception of the Announcement message, UE-2 (in the role of
\"monitoring UE\") verifies the signature payload SIGN. If the verification
test is successful, UE-2 presents the authenticated identity (\"Announcer
Info\") to the user of UE-2.
##### 8.4.2.1.2.2 Group Member Discovery with Model B {#group-member-
discovery-with-model-b .H6}
Figure 8.4.2.1.2.2-1 illustrates authentication and key agreement (optional)
features for Group Member Discovery with Model B, using ECCSI and SAKKE
respectively.
{width="6.3493055555555555in" height="3.3180555555555555in"}
Figure 8.4.2.1.2.2-1: Authentication and Key Agreement for Group Member
Discovery with Model B
A process of authentication and key agreement for Group Member Discovery with
Model B may include the following:
Solicitation:
1\. UE-1 (in the role of \"discoverer\"), wishing to discover group members in
vicinity, transmits a discovery message including the following parameter
settings:
\- Type = Solicitation
\- Discovery Type = Group Member Discovery
\- Discoveree Info = upper layer information identifying the target user or
group of users.
\- Discoverer Info = upper layer information about the user of UE-1. This
information is used to derive the Signer\'s identifier (used by ECCSI).
\- ProSe UE ID = the Layer-2 ID of the discoverer UE. When PC5 Signalling
Protocol is used to transport the Solicitation message, the ProSe UE ID may be
carried in the Source Layer-2 ID field of the MAC frame carrying the
Solicitation message.
\- SIGN -- an ECCSI signature of the Solicitation message. The signature may
be computed over all or a subset of the parameters in the message. At a
minimum the signature is computed over the Discoverer Info parameter.
Response:
2\. Upon reception of the Solicitation message, UE-2 (in the role of
\"discoveree\") checks whether it is concerned by the message by inspecting
the Discoveree Info parameter and then verifies the signature payload SIGN. If
the verification test is successful, UE-2 responds with a discovery message
including the following parameter settings:
\- Type = Response
\- Discovery Type = Group Member Discovery
\- Discoveree Info = upper layer information identifying the user of UE-2.
This information is used to derive the Signer\'s identifier (used by ECCSI and
SAKKE). (NOTE: The Discoveree Info in the Response (step 2 or 3) may be
different from Discoveree Info in the Solicitation (step 1). For example,
Discoveree Info in the Solicitation (step 1) may refer to a targeted group of
users, whereas in the Response (step 2 or 3), Discoveree Info refers to a
single discoveree user).
\- ProSe UE ID = the Layer-2 ID of the discoveree UE. When PC5 Signalling
Protocol is used to transport the Response message, the ProSe UE ID may be
carried in the Source Layer-2 ID field of the MAC frame carrying the Response
message.
\- SIGN -- an ECCSI signature of the Response message. The signature may be
computed over all or a subset of the parameters in the message. At a minimum
the signature is computed over the Discoveree Info parameter.
\- SAKKE -- UE-2 generates a Shared Secret Value (SSV) and encodes it into a
SAKKE payload according to the algorithm described in RFC 6508, using the KMS
Pubic Key and the public identity of the UE-1\'s user (Discoverer Info). This
parameter is optional. If included, it can be used to encrypt all future data
exchanged between the two UEs.
3\. UE-3 responds with a Response message. The parameter settings are the same
as in step 2.
### 8.4.3 Solution #8.4.3: Obtaining parameters for protection of Public
Safety Group Member Discovery messages
#### 8.4.3.1 Solution overview
Public Safety discovery encompasses ProSe UE-Network Relay discovery and Group
Member discovery. Public Safety Discovery can use the same type of
provisioning as one-to-many group communications, that is, a ProSe Key
Management Function pre-provisions the Public Safety UEs with the necessary
parameters.
#### 8.4.3.2 Solution procedures
##### 8.4.3.2.1 Fetching the Keys from the PKMF
The credential to be provisioned are linked to a Discovery Identifier. This
term is used here to refer to any of the following identifiers mentioned in
[32], [20] as applicable to Public safety discovery and sent over the PC5
interface: Announcer Info, Discoveree Info, Discoverer Info, Target Info, and
Relay Service Code.
The other identifiers also used in Public Safety discovery, such as layer-2
IDs (ProSe Relay UE ID and ProSe UE ID), do not need to be associated with the
provisioned credentials. They can be configured via other means, e.g. self-
configured.
The configuration of the security material for the protection of direct
discovery messages is shown in the figure 8.4.3.2.1-1:
Figure 8.4.3.2.1-1: Configuration of parameters for public safety discovery
0: If needed the UE could be configured with any private keys, associated
certificates or root certificate that may be needed for contacting the ProSe
Key Management Function to allow the keys to be kept secret from the operator.
If none are provided, then the USIM credentials are used to protect that
interface. The UE may also be pre-configured with the address of the ProSe Key
Management Function.
1: The UE fetches the Discovery identifier(s) from the ProSe Function. These
may be, according to TR 23.713 [32], and depending on the role of the
requesting UE in Discovery (announcers and monitorers, discoverer and
discoveree), one of the following: Announcer Info, Discoverer Info, Relay
Service Code, Discoveree Info, Target Info. In addition, the UE may be
provided with the address of the ProSe Key Management Function that it uses
for obtaining keys for discovery.
2.i: The UE sends the Key Request message to the ProSe Key Management Function
including the Discovery Id(s) which it wishes to protect upon sending or undo
protection for upon receiving.
2.ii: The ProSe Key Management Function checks the authorization for this
Discovery Identifier, and what types of protection algorithms to apply to it.
This decision takes into account the type and format of the Discovery
Identifier (e.g. if it contains a Group ID and then a member ID, if it
contains other portions that may be confidentiality-protected, etc.).
2.iii: The ProSe Key Management Function responds with the Key Response
message. If the check of step 2.ii is successful, this message contains the
_security metadata_ associated with the discovery keys to be sent later. Such
security metadata may include: Discovery User Scrambling Key ID, Discovery
User Integrity Key ID, Discovery User Confidentiality Key ID and associated
Encrypted_bits_mask.
2.iv: The ProSe Key Management Function sends the relevant Keys and Discovery
User Key IDs plus validity times to the UE using MIKEY.
3: The UE is now ready to send protected discovery messages or receive
protected discovery messages listed in clause 6.1.1.1 of TR 23.713 [32].
8.4.3.2.2 Protection of the Discovery Message over PC5 interface
The discovery messages are protected as described in clause 8.3.15 with some
modification to account for the differing security requirements of Public
Safety Discovery (e.g. scrambling may be a less important requirement for
Public Safety).
###### ### Annex A: Possible post-Rel-13 Key Issues
# A.1 Key Issues on One-to-many communications
## A.1.1 Key Issue #A1.1: Mutual authentication of ProSe enabled devices in
group owner mode
### A.1.1.1 Key issue details
In network coverage scenarios UEs are mutually authenticated to the network.
Currently UE to UE authentication is not standardized. Mutual authentication
of public safety UEs in group owner mode without network coverage cannot be
performed with AKA. Authentication credentials have to be securely stored in
the UE in order to be available in the UE even without network coverage.
Depending on the sensitiveness of the credentials secure storage e.g. in the
UICC could be required. Also for maintenance it could be beneficial to store
the configuration data inclusive credentials on a removable UICC.
Editor\'s Note: The scenario when the configuration data is provided by a
provisioning server controlled by a different entity than the 3GPP operator,
needs to be considered as well. For example, the credentials may need to be
managed by an NSPS organization, and storage of the configuration data in the
UE needs to be considered also in this scenario.
### A.1.1.2 Security threats
Device theft is a security threat; especially if there is an extensive effort
needed to exclude a single device. This was the case if e.g. the same pre-
shared secret for multiple devices is used. Such an authentication mechanism
is not scalable. If one device is compromised all communication of other
devices with the same shared secret is compromised with it.
### A.1.1.3 Potential security requirements
The system should support mutual authentication of public safety UEs out of
network coverage.
Compromise of a single UE should not affect the security of the others.
Authentication credentials should be securely stored in UE.
## A.1.2 Key Issue #A1.2: ProSe Communications in Group Owner Mode
### A.1.2.1 Key issue details
A key capability of ProSe-enabled UEs is to engage in one-to-one
communications with another UE directly over the air interface or in one-to-
many communication with other UEs over the Group Owner.
### A.1.2.2 Security threats
All security threats in subclause 5.3.1.2 apply to ProSe Communications in
Group Mode. Additionally the following threats also exist;
The man-in-the-middle attack may exist if the communication is not protected
between the first UE to the GO and between the GO and the second UE.
Though the traffic sent by an ordinary ProSe Group member is delivered in
unicast mode to the GO, which subsequently distributes it to one or all ProSe
Group members, the distribution from the GO can be in either unicast or
multicast mode. A passive attacker may eavesdrop the data packets exchanged
between the two UEs. If the GO communicates to group members in multicast mode
without applying protection to the original content, other group members in
proximity may obtain the original content broadcast by GO.
### A.1.2.3 Potential security requirements
All security requirements in subclause 5.3.1.3 apply to ProSe Communications
in Group Mode. Following security requirements are for Group Mode ProSe
communication.
ProSe UEs should be authenticated by GO;
The communication data between ProSe UEs should be protected.
The data distributed by GO to all members in the same group in multicast mode
should be protected from eavesdropping by other UEs who are do not belong to
the same group as the GO.
###### ### Annex B: Possible post-Rel-13 Solutions
# B.1 Solutions for One-to-many Communications
## B.1.1 Solution #A1.1: Security for ProSe communication in group owner mode
### B.1.1.1 Authentication by GO
The ProSe UE should be authenticated by GO when it joins to the communication
group. All the group members, e.g. ProSe UEs and GO, may be out of coverage,
the authentication credential should be pre-configured and securely stored in
the ProSe UE. As the group may be dynamic when the group members joins in or
leave the group, which means the group member and GO is not fixed, the
credential should be valid in a large-scale. Certificate could be competent to
be the required credential.
The authentication conforms to the following steps:
ProSe UE enrols certificate from its HPLMN. To support the roaming scenario, a
list of other PLMN\'s root certificate may be also enrolment;
GO authenticates with the ProSe UE when the UE joins to the group. CRL stored
in GO and ProSe UE is used to verify the certificate validity. CRL updates
whenever the ProSe UE or GO connects to the network.
### B.1.1.2 Key generation and for ProSe communication
Before direct communication can be established between two or multiple ProSe-
enabled UEs, these UEs need to become members of the same _ProSe Group_.
When ProSe UE joins a group, the UE first authenticates with the GO. Then GO
generates Kunicast and Kmulticast for the unicast communication and multicast
communication. The Kunicast and Kmulticast are ProSe group specified, so group
ID could be used as input parameter to derive the keys Kunicast and
Kmulticast.
Editor\'s Note: The details of certificate validation are FFS.
### B.1.1.3 Key distribution to ProSe UE from GO
The keys to protect the message/traffic between ProSe UE and GO are generated
by GO, and need to securely distribute to ProSe UE. The public key of the
ProSe UE could be used to encrypt the keys. The encryption ensures that only
ProSe UE can obtain the keys and those keys is not useful for users which do
not have the private key.
The security algorithms can be negotiated along with the key distribution
procedure. The message/traffic should be confidentially protected and
integrity protected after this procedure.
# B.2 Solutions for One-to-one communications
## B.2.1 Solution #A2.1: Security for direct one-to-one connections
### B.2.1.1 General
This solution addresses key issue #A3.2 in the present document and is the
security part of solutions C3 and C4 in TR 23.703 [4].
### B.2.1.2 Overview of solution
#### B.2.1.2.1 General
One major difference between the security of direct communication between LTE
UEs and regular LTE communications between the UE and network is that in the
former there is only one endpoint for the signalling, which brings into
question the need for replicating the two layers of LTE security for direct
communications.
NOTE: The above is not claiming that there will not be in effect two types of
signalling between UEs, e.g. a;\'NAS\'-like layer that could be considered
independent of the radio layer and radio layer that might be dependent on the
actual radio being used. It is merely saying that if there is no need for more
than one layer of security, as the termination point for possible signalling
layers are in the same entity.
For this reason, this solution proposes to have only one layer of security
that is identical to or at least very similar to the RAN layer security that
is in standard LTE.
> Editor\'s note: This will need to be reviewed as the RAN groups make more
> progress on their work
One consequence of the above decision is that there can be no protection of
the initial message (post radio connection establishment). This is not a
problem as the proposed context of those messages is only connection
identifiers and security establishment parameters.
Another consequence of not having a NAS security in ProSe is the derivation of
fresh keys for the RAN security cannot use NAS COUNTs. It is proposed to
replace these with NONCEs from both sides.
Another difference is that each side issues a connection identity to the other
in order to ensure privacy in the same way that S-TMSI can be used to prevent
tracking of UEs.
Like in standard LTE, there is will be a key set identifier, called a DKSI
associated with the D2D root key, called K~D~, of the security context that
play the same roles as eKSI and K~ASME~ in standard LTE. K~D~ is generated per
pair of UEs.
#### B.2.1.2.2 Difference between network independent and network authorized
cases
As described in solutions C3 and C4 of TR 23.703 [4], there are two possible
connection cases, network independent and network authorized. The only
difference from a security perspective is in the way that K~D~ is generated.
In the network authorized case, the UEs are connected to the network and they
rely on assistance from the network to generate the keys. In the network
independent case (which applies to public safety only-- solution C3 in TR
23.703 [4]), it is assumed that the UEs are pre-provisioned with some private
keys and associated certificates and these are used to generate a mutually
shared key K~D~.
Figure B.2.1.2.2-1 gives a high level flow for network independent connection
establishment.
{width="5.819444444444445in" height="4.186111111111111in"}
Figure B.2.1.2.2-1: Network independent connection establishment
**In the network independent connection establishment, an initial Direct
Connection Request message is sent directly between the UEs. The UEs then (if
needed) perform a key generation between them using their private keys and
certificates (see clause B.2.1.4.3.1) and then run the Direct security mode
procedure to start the security (see clause B.2.1.4.4). Finally new connection
identities are exchanged (if needed) in the Direct Connection
Response/Complete (see clause B.2.1.4.2) to allow a connection to be re-
established without using a permanent identity.**
Figure B.2.1.2.2-2 gives a high level flow for network authorized connection
establishment.
{width="5.819444444444445in" height="3.988888888888889in"}
Figure B.2.1.2.2-2: Network authorized connection establishment
**In the network authorized connection establishment, the first stage is for
the UEs to generate keying material for their direct connection using their
respective MMEs (see clause B.2.1.4.3.2.1). Then an initial Direct Connection
Request message is sent directly between the UEs. The UEs then run the Direct
security mode procedure to start the security (see clause B.2.1.4.4). Finally
new connection identities are exchanged (if needed) in the Direct Connection
Response/Complete (see clause B.2.1.4.2) to allow a connection to be re-
established without using a permanent identity.**
### B.2.1.3 Security parameters
This clause contains a description of the security parameters used and the
purpose of that parameter. The list of security parameters is broken down into
three sets to reflect the parameters needed for the following states (each
state is in respect to a particular other UE):
\- D2D-Null: the UE has everything it needs to start the process of
communicating with another UE, but no security parameters or any info about
the other UE
\- D2D-Idle: the UE has connected to another UE and retained some security
parameters for use with that UE
\- D2D-Connected: the UE is actually connected to another UE and transmitting
data
Stored parameters while in D2D-Null
  * D2D authorization parameters that give the UE permission to use D2D direct communications
  * Expressions it will announce, listen to and/or accept direct communication on
Editor\'s note: More details on relationship between expression and security
contexts is needed
  * Set of security algorithm that it is willing to use for direct connections -- this may be reduced from complete set supported by the UE by the authorization parameters ruling out some algorithms, e.g. Null confidentiality only
  * For UEs using autonomous connections, the private key/certificate pairs that relate to the various expression it is using
Stored parameters while in D2D-Idle
  * Everything from D2D-Null
  * Connection identities: Uni-directional identities (I.e. a local and remote pair) that play the role of S-TMSI in providing privacy for the UE. The remote connection id is assigned by the peer UE to ensure that they are unique at that peer UE.
  * Key set identifier, DKSI, which plays the role of eKSI in LTE
  * D2D Root key, K~D~, which plays of the role of K~ASME~ in LTE
  * List of expression used with this security context
Stored parameters while in D2D-Connected
  * Everything from D2D-Idle
  * (At least held implicitly), a pair of NONCES (local and remote), one for each UE that are used to calculate K~D-sess\ :~
  * K~D-SESS~, the session key to be used for deriving further keys to protect the traffic between UE -- this is the equivalent of K~eNB~ from LTE
  * The confidentiality and integrity algorithms that are chosen to protect the traffic between UEs
  * The keys that are used in the above algorithms
  * The PDCP counts or ProSe equivalent parameters that are used at the RAN layer as inputs to the ciphering and integrity algorithms
### B.2.1.4 Security procedures
#### B.2.1.4.1 General
There are four different security procedures required for direct
communications;
  * Allocating a Connection identity
  * Establishing an DKSI, K~D~ pair at each UE
  * Direct-security mode procedure
  * Direct re-keying procedure
The procedures are described in the following subclauses. Each procedure
contains a description of when it can be run and how it fits with other
security. For details of how each procedure fits in overall connection etc.,
see solutions C3 and C4 in TR 23.703 [4].
#### B.2.1.4.2 Allocating a connection identity
When creating a direct communications link between two UEs, the UEs may both
pass a connection identity to each other. The connection identity needs to be
unique at the UE that created it. At a later re-connection attempt the
previously negotiated security can be used if still stored by the initiating
UE by sending the other UE the connection identity it has previously sent.
Connection identities may be re-allocated during connection set-ups or during
network assisted keying. This allows a connection identity to be only used
once if so desired by the UEs in order to protect their privacy.
{width="5.819444444444445in" height="2.2569444444444446in"}
Figure B.2.1.4.2.1-1: Connection identity allocation
UE_1 sends UE_2 a new connection identity that UE_2 should use next time it
communicates with UE_1 either:
a) Directly in Direct-Connection-Response/Complete messages; or
b) Through signalling via their respective MMEs (for more details see the
messages flow described in figure B.2.1.4.3.2-1).
#### B.2.1.4.3 Establishing a shared key
##### B.2.1.4.3.1 Network independent case
This procedure may only be run after receiving a Direct Connection Request
(see solution C3 in TR 23.703 [4]) or a Direct Rekeying Request message (see
subclause B.2.1.4.5 of the present document). This case is only for public
safety UEs (see solution C3 in TR 23.703 [4]). It results in the UEs sharing a
DKSI and K~D~ pair.
{width="6.075694444444444in" height="3.595833333333333in"}
Figure B.2.1.4.3.1-1: Network independent key establishment
  1. UE_1 sends UE-2 either a Direct-Connection-Request (see SA2 specification) or Direct-Rekeying-Request (see subclause B.2.1.4.5).
Note: Either UE can send a Direct-Rekeying-Request when they are connected to
each other.
  1. \-- 4. UEs exchange messages to result in a shared DSKI and K~D~ pair
Editor\'s note: The details of the key establishment need to be added. How to
ensure associated certificates point to the same root certificate? How to
ensure validity of the certificate? OCSP needs the involvement of the network.
There is the problem of clock synchronisation in UEs. If the clock of one UE
is not correct, the UE may wrongly treat its peer\'s certificated as expired.
##### B.2.1.4.3.2 Network authorized case
This procedure may only be run prior to sending a Direct Connection Request or
after a Direct Rekeying Request when it is desired by one UE to use a fresh
K~D~ as opposed to a fresh K~D-sess~. The Direct-Rekeying-Request can only be
sent when the UEs are already directly connected. The following flow shows the
security part of the relevant SA2 flow (see TR 23.703 [4]).
Figure B.2.1.4.3.2-1: Network authorized key establishment
  1. Either
a. UE_1 has received a Direct-Connection-Request or Direct-Rekeying-Request
and want to generate a new K~D~; or.
b. UE_1 wants to establish a connection with UE_2 using network authorized
connection procedure
  2. UE_1 sends an Extended Service Request (ESR) indicating direct connection to MME_1. It contains connection identity given it by UE_2 previously if it has one or the EXP code that is or wants to communicate with. Other parameters are FFS.
  3. MME_1finds out the address of MME_2 (this is FFS in rekeying case) and sends it a Direct-Keying-Request. It includes the connection identity or EXP code that was received in message 1. It also includes Keying_material_1. Other parameters are FFS.
  4. MME_2 sends UE_2 the connection identity or EXP code that was received in message 2. Other parameters are FFS.
  5. UE_2 sends a new connection identity if there was not one in message 3 or it wants to refresh its connection identity. It also selects a DKSI that will be associated with the calculated K~D~. Other parameters are FFS.
  6. MME_2 sends MME_1 the parameters received in message 2 and Keying_material_2. Other parameters are FFS.
  7. MME_1 sends UE_1 the parameters received in message 2. Other parameters are FFS.
  8. Both UEs establish the final K~D~ from the received keying material parameters and parameters held locally.
Editor\'s note: The details of the key establishment protocol need to be
added. What\'s the life time of this security context of D2D?
#### B.2.1.4.4 Direct security mode procedure
This procedure is run in response to a Direct Connection Request in order to
establish a secure connection between the UEs.
UE_2 may initiate one of the procedures described in clause B.2.1.4.3 to
establish a key. These may be run between the UEs before the start of the D2D
security mode procedure if a K~D~ is needed or UE_2 wants to establish a new
K~D~.
{width="5.819444444444445in" height="4.186111111111111in"}
Figure B.2.1.4.4-1: Direct Security mode procedure
  1. UE_1 has sent a Direct-Connection-Request to UE_2. This message includes Nonce_1 (for session key generation), Supported_algs (the list of algorithms that UE_1 is OK to use in this connection) and Key_creation_data (information needed to determine the method of key generation - the details of this are FFS). The UEs have also agreed on a DKSI and K~D~ pair either at step 0a or 0c.
  2. UE_2 sends the Direct-Security-Mode-Command to UE_1. It includes the DKSI to indicate which K~D~ to use, Nonce_2 to allow a session key to be calculated and the chosen_algs parameter to indicate which security algorithms the UEs will use to protect the data. UE_2 also returns the Supported_algs parameter and part of the Key_creation_data to protect them from man-in-the-middle attacks. UE_1 will not accept a Direct-Security-Mode-Command if there are different what it sent. UE_2 calculates K~D-Sess~ from K~D~ and Nonce_1 and Nonce_2 and then derives the confidentiality and integrity keys based on the chosen algorithms (see subclause 6.4.1.6.1). It integrity protect the Direct-Security-Mode-Command before sending it to UE_1. UE_1 performs the same key calculation and checks the integrity of the message before accepting it.
  3. UE_1 send an integrity protected Direct-security-mode-complete message to UE-2. After this all messages are integrity and confidentiality protected except possibly rekeying messages (see subclause 6.4.1.4.5).
#### B.2.1.4.5 Direct re-keying procedure
This procedure can be run at any time and initiated be either UE. It results
in a new K~D-sess~ being used to protect the traffic between the UEs. The new
K~D-sess~ can either be calculated from the current K~D~ or a new K~D~
established during this procedure using the appropriate procedure from
B.2.1.4.3.
{width="5.819444444444445in" height="3.595138888888889in"}
Figure B.2.1.4.5-1: D2D re-keying procedure
  1. UE_1 sends UE_2 a Direct-Rekeying-Request message when they are already directly connected and UE_1 wants to refresh the keys. This message includes a parameter (this is FFS) to enable MME_2 to find MME_1 and get signalling to UE_1 via the network, a flag to indicate whether a refresh of K~D~ is requested and Nonce_1.
  2. A DKSI and K~D~ pair are generated if request by UE_1 or desired by UE_2 using the procedures in subclause 6.
  3. UE_2 sends UE_1 a Direct-Rekey-command message. It includes DKSI and Nonce_2. Along with Nonce_1 these allow the calculation of a new K~D-sess~. The message needs to be at least integrity protected.
  4. UE_2 responds with a Direct-Rekey-complete message that is at least integrity protected.
## B.2.2 Solution #A2.2: Security for direct one-to-one connections
### B.2.2.1 General
This solution addresses key issue #7.2.4 in the present document and is the
security part of solution C4 in TR 23.703 [4]. It is best suited to solution
D5 in TR 23.703 [4], where direct communications are treated as a new IMS
service, though the solutions could also be applied outside of IMS.
### B.2.2.2 Overview of solution
#### B.2.2.2.1 D2D Authentication and Key Agreement using IMS E2E security
solutions
Securing a direct one-to-one connection requires setting up a security context
between two end-point devices.\ In addition, the security context should be
unique per UE to UE connection, and not obtainable by any other entities.\ A
number of other requirements may also apply such as the ability to refresh a
security context, protect private identities and support LI.
In reality, any successful solution to this challenge will provide a generic
end-to-end security context between two UEs. This assertion is clear as there
are only these two devices involved in a direct one-to-one connection, and the
security solution cannot rely on any security provided by the transport
mechanism.
It is noted that solving the challenge of producing an end-to-end security
context between two UEs has already been addressed in other environments. In
particular, IMS media-plane security as specified by TR 33.328 [16] provides
two end-to-end security solutions, SDES and MIKEY-TICKET, which are both able
to setup a shared session key at each end-point to secure a session. Within TR
33.328 [16], this session key is used to secure an RTP media session, however,
the same mechanisms could be used to securely and successfully share a session
key for any e2e security requirement.
This solution proposes that the security for a direct one-to-one connection is
setup using the same techniques as an IMS e2e media service. In other words,
SDES and MIKEY-TICKET are both able to share a session key between two end
points and authenticate both end-points for RTP streams. It is proposed to re-
use these solutions to share a session key between two end-points for direct
one-to-one communications.
The advantages of using either of the two IMS e2e security solutions for
direct one-to-one connections are as follows:
\- These solutions have already been specified and their security analysed
thus agreeing their use may speed up the specification of a ProSe security
solution.
\- A consistent approach to media security will be achieved regardless of the
type of network access provided (trusted access, untrusted access, direct
connection).
\- LI support of these solutions has already been assessed.
It is noted that these two solutions do not specify how to support network-
independent direct communications, hence this only provides a solution for C4
in TR 23.703 [4]. The requirement for Solution C3 in TR 23.703 [4] can be
viewed as a specialised use-case, applicable only to public safety users where
a network does not exist. The solution that will be required by the majority
of users is C4, I.e. to setup direct communications where a network can be
accessed.\ This solution is described in clause B.3.2.3.
Both the defined IMS e2e security solutions currently require a connection to
the network in order to operate.\ In the majority of use cases, including all
commercial use cases, this will not be a concern as a network connection will
exist or be required to setup a direct one-to-one connection. In the
restricted use-case of public safety use without network connectivity, direct
communications may be required when the UEs are operating independently of the
network. The solution described does not address this requirement and we
believe a new solution will be required.
### B.2.2.3 D2D authentication and key-agreement using IMS E2E security
solutions
#### B.2.2.3.1 General
This clause defines how to adapt the two end-to-end solutions defined in TR
33.328 [16] for use as authentication and key-agreement solutions for direct
one-to-one communications.
There are two possible outcomes on of the ProSe architecture study.
\- It is agreed that ProSe should be an IMS service (Solution D5 as defined in
TR 23.703 [4])
\- It is decided ProSe will not be an IMS service.
In the following subclauses, the D2D authentication and key-agreement
mechanism is defined for these two possible outcomes.
In terms of this security solution, the first outcome is preferred as it
simplifies defining the security solution. If ProSe is an IMS service, end-to-
end security solutions are already defined for IMS so integration is easy to
specify.
#### B.2.2.3.2 D2D authentication and key-agreement within IMS-managed ProSe
As described in TR 23.703 [4], if Solution D5 is agreed, direct communications
are setup using IMS. The D2D communication is setup by routing the SIP
signalling via the network. Attached to the SIP signalling, the D2D
authentication and key-agreement can also be performed. With SIP signalling
complete, the D2D authentication and key-agreement process is also complete
and a D2D traffic keys can be derived to create a shared security context.
With an identical security context created at both UEs, it is possible to
begin a secure D2D communication.
{width="4.275in" height="2.09375in"}
Figure B.2.2.3.2-1: Simplified session setup with IMS support
Figure B.2.2.3.2-1 describes a simplified session setup using IMS. Both SDES
and MIKEY-TICKET attach security parameters to SDP Offer and SDP Answer
messages. These messages are attached to the SIP exchange for setting up a D2D
connection.
B.2.2.3.2.1 D2D authentication and key-agreement security procedures for SDES
The following are the security procedures for SDES:
> 1\. D2D UE A sends a SIP INVITE to D2D UE B via the IMS, indicating the D2D
> interface for the media. The INVITE also contains an SDP Offer with
> appropriate additional SDES crypto attributes as specified in the SDES e2e
> security procedures (TR 33.328 [16]). In particular, the SDES crypto
> attributes contains at least one master key, K1.
>
> 2\. D2D UE B replies with an SDP Answer for a D2D media stream. The SDP
> Answer includes the SDES crypto attributes containing at least one master
> key,K2.
>
> 3\. The exchanged keys, K1 and K2, are combined via a KDF to create the D2D
> session key, K~D~. In both UEs, this session key is used to create the D2D
> traffic keys forming the full security context. Secure media communication
> is then setup directly between D2D UE A and D2D UE B via the specified D2D
> interface.
B.2.2.3.2.2 D2D authentication and key-agreement security procedures for KMS
The following are the security procedures for the MIKEY-TICKET KMS e2e
security solution. As specified in TR 33.328 [16], D2D UE A will either
interact with the KMS to obtain keys and a MIKEY-TICKET Ticket usable for D2D
communications with UE B, or it will create the ticket by itself.
> 1\. D2D UE A sends a SIP INVITE to D2D UE B via the IMS, indicating the D2D
> interface for the media.\ The INVITE also contains an SDP Offer containing
> the obtained/generated MIKEY-TICKET ticket.
>
> 2\. D2D UE B checks if it is authorized to resolve the ticket and if that is
> the case IMS UE B interacts with the KMS to resolve the ticket and receive
> keys. D2D UE B replies with an SDP answer, including a MIKEY-TICKET
> response.
>
> 3\. As a consequence of the exchange, MIKEY-TICKET produces a TEK as
> specified in RFC 6043 [17].\ The output MIKEY-TICKET TEK is used as the D2D
> session key, K~D~. In both UEs, this session key is used to create the D2D
> traffic keys forming the full security context. Secure media communication
> is then setup directly between D2D UE A and D2D UE B via the specified D2D
> interface.
B.2.2.3.3 D2D authentication and key-agreement within IMS-independent ProSe
If IMS is not used as part of a D2D setup procedure, the defined security
methodologies behind SDES and MIKEY-TICKET may still be applied. Both
protocols require a single SDP message to be passed in each direction.\ To
achieve this independently of IMS, the (information within the) SDP Offer is
attached to the Direct Connection Request and the (information within the) SDP
Answer is attached to the Direct Connection Accept.
{width="6.125in" height="2.9270833333333335in"}
Figure B.2.2.3.3-1: D2D connection establishment
This exchange is displayed in Figure B.2.2.3.3-1. For SDES, the Direct
Connection Request and Direct Connection Accept contain SDES crypto attributes
containing K1 and K2 respectively. For KMS, the Direct Connection Request and
Direct Connection Accept contain MIKEY-TICKET tickets. The D2D traffic keys
should be derived from the session key as in the IMS-integrated case.
The Direct Connection Request and Accept messages should be sent via the
network for SDES, but may be sent either via the network or directly for KMS.
## B.2.3 Solution #A2.3: Security for ProSe one-to-one communications
### B.2.3.1 General
This solution addresses key issue #7.2.4 in the present document, and is aimed
to provide the security solution for solutions C3, C4 in TR 23.703 [4]. It is
primarily aimed at meeting the public safety user requirements for one-to-one
communication out-of-network coverage, but can also be applied for in-coverage
scenarios.
### B.2.3.2 IDENTITY Security Solution
#### B.2.3.2.1 General
The IDENTITY solution provides a flexible end-to-end security solution capable
of setting up secure one-to-one or group sessions without requiring a
connection to network infrastructure. It is intended for use by public-safety
users who require direct one-to-one or group connections when a connection to
the network does not exist. It provides a solution to perform authentication
and key-agreement for direct one-to-one communications (C3 and C4) and for
group communications (C1, C5, C6, C7, C8) as specified in TR 23.703 [4].
The IDENTITY solution allows information to be encrypted to a given UE using
solely their public identity (alongside pre-provisioned domain-level
information). Only a UE with this identity (alongside private keys provisioned
by the network infrastructure) is able to decrypt information encrypted to the
identity and sign information as this identity.\ As a result, provisioning
either occurs prior to deployment or while users are connected to the network
infrastructure, but secure connections may be established without access to
network infrastructure. The security mechanism which achieves this uses the
MIKEY-SAKKE protocol as specified in RFC 6509 [12].
Full details of the IDENTITY solution, including procedures for provisioning
of IDENTITY UEs, can be found in clause 6.3.1.2 of the present document.
### B.2.3.3 IDENTITY One-to-One communications
#### B.2.3.3.1 General
This clause describes the generic setup of an IDENTITY one-to-one
authentication and key-agreement procedure between two UEs. IDENTITY one-to-
one communications are very similar to ad-hoc group communications detailed in
clause 6.3.1.3.4. Ad-hoc group communications may be viewed as the creation of
multiple simultaneous one-to-one communications with group members. Like for
ad-hoc groups, for one-to-one group communications, a user of a public safety
UE selects a public safety UE with which to securely communicate. The UE then
generates a session key and securely transmits this key to the terminating
UE\'s IDENTITY using a MIKEY-SAKKE I_MESSAGE. The session key is used to
protect media in the session.
Figure B.2.3.3.1-1 provides an overview of the security process for
distributing session keys for one-to-one communications.
Figure B.2.3.3.1-1: Overview of one-to-one session key distribution
For a one-to-one session to be created, no prior security association need
exist between the UEs. However, all UEs in the group is provisioned as
described in clause 6.3.1.2.
#### B.2.3.3.2 Configuration
The solution requires that public safety UEs have a public identity (e.g.
IMPU). The network configures each public safety UE with security parameters
associated with the IDENTITY solution as detailed in clause 6.3.1.2 of the
present document.
#### B.2.3.3.3 One-to-one security procedures for session key distribution
using IDENTITY (network connected)
Figure B.2.3.3.3-1 shows the set-up procedures for one direct one-to-one
connection session using IDENTITY authentication and key-agreement.
Figure B.2.3.3.3-1: One-to-one security procedures for session key
distribution\ using IDENTITY (network connected)
The procedure in Figure B.2.3.3.3-1 is now described step-by-step. 1. Prior to
beginning this procedure it is assumed that the public safety UEs have been
provisioned by an IDENTITY KMS as described in clause 6.3.1.2.
2\. Prior to beginning this procedure it is assumed that the public safety UE
has registered with its serving signalling server and local group server.
3\. The initiating public safety UE generates a session key and sends a
session initialisation message (e.g. SIP INVITE) to the terminating public
safety UE. This message is routed via the signalling servers of the initiating
UE and terminating UE. Within the SDP Offer of this message, UE 1 includes a
MIKEY-SAKKE I_MESSAGEs as defined in RFC 6509 [12]. The I_MESSAGE encapsulates
the session key for the terminating public safety UE, encrypting the key to
the IDENTITY UID of the terminating UE and is signed using (the key associated
with) the initiating UE\'s UID.
NOTE 1: This message may be pre-generated to increase the efficiency of the
communication.
4\. The terminating UE receives the message, checks the signature on the
message and extracts the session key using keys provisioned by the IDENTITY
KMS. The terminating UE returns an acknowledgement (e.g. SIP 183) containing
an SDP Answer. Optionally, the response may contain another MIKEY-SAKKE
I_MESSAGE returning the session key.
NOTE 2: The optional return of an I_MESSAGE is not required to create a secure
session, but allows explicit authentication of the terminating user and
confirmation that the session key has been successfully extracted.
5\. Further messages are sent to setup the group session. These messages
contain no security information.
With a session key shared between the initiating and terminating users, the
media communicated between the UEs may be protected with this session key.
#### B.2.3.3.4 One to one security procedures for session key distribution
using IDENTITY (network independent)
This clause assumes that the IDENTITY authentication and key-agreement
procedure occurs directly, rather than via the network. This is designed to
accommodate public-safety users who wish to establish connectivity when a
connection to the network does not exist. This solution assumes that the
public safety UEs have established connectivity sufficiently to transport a
Direct Connection Request/Accept exchange containing MIKEY-SAKKE I_MESSAGEs.
The procedure could also be performed via a relay.
From a security perspective, this procedure follows exactly the same security
mechanism as for network-connected group communications described in clause
6.3.1.3.4.2. In this use case, the SDP Offer is broadcast by the initiating UE
and no response is expected. The SDP Offer contains a set of MIKEY-SAKKE
I_MESSAGEs protecting the Group Session Key (GSK). Following the broadcast of
the SDP Offer, the media is broadcast over the one-to-many direct link,
protected under the GSK.
Figure B.3.3.3.4-1 describes the procedure. As there are no responses or
acknowledgements, this procedure proceeds on a \'best-endeavour\' basis.
{width="4.46875in" height="3.65625in"}
Figure B.2.3.3.4-1: One-to-one security procedures for session key
distribution\ using IDENTITY (network independent)
The procedure in Figure B.2.3.3.4-1 is now described step-by-step.
  1. Prior to beginning this procedure it is assumed that the public safety UEs have been provisioned by an IDENTITY KMS as described in clause 6.3.1.2.
  2. Public safety UE 1 generates a session key and broadcasts a \'session initialisation message\' containing the URI of the terminating UE and an SDP Offer. Within the SDP Offer, the initiating UE includes a MIKEY-SAKKE I_MESSAGEs as defined in RFC 6509 [12], encapsulating the session key. The session key is encrypted to the IDENTITY UID of the terminating UE signed using (the key associated with) the initiating UE\'s UID.
NOTE: This message may be pre-generated to increase the efficiency of the
communication.
  1. The terminating UE extracts the session key from the I_MESSAGE and checks the signature on the message. Further messages may be sent to setup the one-to-one direct media session. These messages contain no security information.
As a result of this procedure, the UEs will have shared a session key. This is
used to protect the media transmitted directly as part of this session.
B.2.3.3.5 Media Stream Protection
As a result of completing a security procedure described in clause B.2.3.3.3
or B.2.3.3.4, the public safety UEs will have shared a session key as part of
the session setup procedure. All transmitted media within this session will
now be protected under this session key (e.g. to key an SRTP stream). The
session may only last for a single transmission, or may be maintained for a
period to allow on-going efficient communications.
This applies whether the media is transmitted directly, via a relay or via
signalling servers in the network.
## B.2.4 Solution #A2.4: Network assisted key establishment for one-to-one
communication
### B.2.4.1 General
This solution addresses the network assisted key establishment procedure
between two ProSe enabled UEs (UE1 and UE2). UE1 and UE2 are served by the
MME1 and MME2, respectively. It is assumed that UE1 (UE2) has already been
attached to MME1 (MME2, respectively). The shared keys (e.g. Kasme) between
UE1 and MME1, as well as between UE2 and MME2 are used in the key
establishment procedure.
### B.2.4.2 Procedure
The procedure of the solution in Figure B.2.4.2-1 is described as follows:
Figure B.2.4.2-1: Network assisted key establishment for one-to-one
communication
> 1\. UE1 selects a parameter p1 (e.g. a random parameter), and sends p1 to
> MME1 in a NAS message, which is protected by NAS security mechanism.
>
> 2\. MME1 derives a key p2=KDF(Kasme1, p1) using the secret key Kasme1 shared
> between MME1 and UE1.
>
> 3\. MME1 sends p2 to MME2, which is protected by NDS mechanism.
>
> 4\. MME2 sends p2 to UE2 in a NAS message, which is protected by NAS
> security mechanism.
>
> 5\. UE2 selects a parameter p3 (e.g. a random parameter), and sends p3 to
> MME2 in a NAS message, which is protected by NAS security mechanism.
>
> 6\. MME2 derives a key p2=KDF(Kasme2, p3) using the secret key Kasme2 shared
> between MME2 and UE2.
>
> 7-8. MME2 sends p4 to UE1 via MME1, which is protected by NDS/NAS security
> mechanism.
>
> 9\. UE1 derives a key p2=KDF(Kasme1, p1); similarly, UE2 derives a key
> p4=KDF(Kasme2, p3). Both UE1 and UE2 derive a session key K~D~=KDF(p2, p4).
>
> Therefore, now both UE1 and UE2 share the same session key K~D~ between
> them.
Editor\'s Notes: The use of KDF and Kasme is FFS.
# B.3 Solutions for Relays
## B.3.1 Solution #A3.1: Security for ProSe communication through UE-to-
Network relay with network authorization
### B.3.1.1 Security procedure for Relay UE
Relay UE connects to network and establishes IP connection across eNB. The
security for Relay UE is the same as normal LTE UE, e.g. AKA procedure is used
for authenticating between relay UE and MME and NAS/AS SMC procedure is used
to activate NAS/AS security.
{width="4.475in" height="2.811111111111111in"}
Figure B.3.1.1-1: Security Procedure for Relay UE
### B.3.1.2 Security procedure for remote UE
In ProSe communication through UE-to-Network relay with network authorization,
remote UE connects to relay UE with D2D setup procedure.
{width="6.3375in" height="3.365972222222222in"}
Figure B.3.1.2-1: Security Procedure for Remote UE
Step 1. Remote UE connects to relay UE;
Step 2. The relay UE acts as non-3GPP AP and triggers the Remote UE
authentication procedure. The AAA server and the UE perform the mutual
authentication using I.e. EAP-AKA ^(\')^ protocol. The Relay UE and the AAA
proxy transfer the authentication message between the AAA server and the
remote UE.
A key identifier KSI~D2D~ and a pair of shared keys, MSK and EMSK is generated
after the authentication procedure in remote UE and AAA server. The KSI~D2D~
and MSK is shared between remote UE and relay UE.
Editor\'s Note: It is FFS where the AAA client is located and which entity is
the EAP authenticator.
Editor\'s Note: What protocol to use (Radius or Diameter) between Relay UE and
AAA is FFS and is within the scope of SA2.
Editor\'s Note: Which protocol is used to transport the EAP signalling between
the UE and Relay is FFS.
Editor\'s Note: How P-GW distinguishes EAP signalling from regular user plane
traffic is FFS.
Step 3. A procedure to generate synchronized security context between remote
UE and relay UE.\ After this step, the keys to protect sessions between remote
UE and relay UE are setup.
Step 4. Remote UE completes the IP address assignment procedure.
Step 5. The Remote UE can transfer the data packet via the Relay UE. The Relay
UE selects the PDN connection based on the bearer mapping, I.e. the mapping
between PC5 bearer and the Relay PDN connection). The network can also
transfer the unicast data packet to the Remote UE via the Relay UE.
## B.3.2 Solution #A3.2: Security for relays
### B.3.2.1 General
This solution is the security part of solution in TS 23.303 [20].
### B.3.2.2 Overview of solution
#### B.3.2.2.1 Solution description
This solution follows the solution 3.6 for one-to-many security except as
described below. The security solution proceeds as in the following flow.
Figure B.3.2.2.1-1: Security flows for relays
1\. The UE that wishes to communicate with relay nodes fetches the relevant
parameters from the ProSe Function
2\. The UE also fetches the ProSe App Codes, Group Member Identity,
Algorithms, PRK and PRK ID from the ProSe Key Mgmt Function from the ProSe Key
Mgmt Function
> Note: After completing step 2, the UE needs to have the ProSe App code of
> the relays it may connect to, and an associated Group Member Identity, PRK
> and PRK identity. It is FFS whether the former three parameters are provided
> at steps 1 or 2.
3\. The relay fetches the authorization/configuration parameter(s) it needs to
act as a relay
4\. The relay broadcasts its discovery message containing a ProSe Relay ID
5\. The UE hears the discovery message and decides it wants to connect to the
relay. It calculates the relevant PRGK for the relay node
6\. Using the next available PTK to both integrity and confidentiality protect
the messages, the UE initiates the relevant IP address assignment process. The
relay fetches the relevant PRGK using the Group Identity and Group Member
Identity used by the UE if needed and the relay and UE complete the IP address
assignment procedures
7\. The UE and relay exchange encrypted data as in the one-to-many security
solution.
#### B.3.2.2.2 Security Keys
In the one-to-many case, each UE in a group is given a ProSe Group Key (PGK)
that is used to derive the ProSe Traffic Keys (PTK) which actually protects
the transmitted data. For the proposed relay solution, each UE can be viewed
as being part of a group of 2 with the relays it can connect to. Instead of
provisioning the UE with a key for each relay that the UE may communicate
with, a UE is provisioned with a single ProSe Relay Key (PRK) from which it
can derive all the necessary ProSe Relay Group Keys (PRGK)s for any relay. In
addition, the relay may fetch the necessary PRGKonly if needed, I.e. after the
UE has communicated with it, rather than needing to be provisioned in advance.
NOTE: Knowledge of PRGKs does not allow either a UE or Relay to calculate a
PGK or vice versa.
#### B.3.2.2.3 Identities
Along with the PRK, the UE is provided with a PRK identity, that also becomes
the PRGK identity of any PRGK derived from it. The UE is also given a group
member identity associated with the PRK that becomes it Group Member identity
for all communications with relays. The relay has a Group Member identity of
all zeros. The Group identity is the ProSe Relay ID (which is layer 2
destination identity of the relay) that the relay broadcasts in a discovery
message.
#### B.3.2.2.4 Key Derivation and Data Protection
The derivation of the PRGK from the PRK is as follows:
PRGK = F_1(PRK, ProSe Relay ID)
The other key derivations and protection of data follow the one-to-many
security solution, except the PTK is generated using PRGK rather than PGK.
The initial IP address assignment messages between the UE and relay are
integrity protected. By using a new PTK for each session with the same relay,
replay protection is enabled between these different sessions. This is
achieved by each side keeping the largest PTK Identity that was used to
successfully establish a session between them and always ensuring any new
session uses a larger PTK identity. This requires one change from the one-to-
many case in that a receiving entity needs to know if a particular message is
integrity protected.
#### B.3.2.2.5 Packet Format
In terms of signalling between the UE and relay, the correct PTK to use and
whether the data is integrity protected or not, the header and payload of the
PDCP packet will need to look as below:
Figure B.3.2.2.5-1: Proposed PDCP packet format
This is the same as in the one-to-many solution except the flag to indicate
whether integrity protection is applied or not.
Editor Note: It is FFS whether this solution is in scope or not.
#
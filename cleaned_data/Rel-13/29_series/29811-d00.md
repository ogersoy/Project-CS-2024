# Foreword
This Technical Report has been produced by the 3^rd^ Generation Partnership
Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# 1 Scope
The present document analyses various EPC race conditions scenarios and
scenarios with hanging session or bearer contexts in EPC nodes, **and assesses
whether to improve the existing protocols and/or specifications for effective
handling of these scenarios. The specification updates, if needed, may consist
in EPC (GTP-C, PMIP and/or Diameter) signalling improvements, recommendations
on how to minimize the occurrences of the issues, and/or clarifications on how
the EPC nodes should behave in these scenarios.**
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or nonâ€‘specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
[1] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[2] 3GPP TS 29.274: \"3GPP Evolved Packet System; Evolved General Packet Radio
Service (GPRS) Tunnelling Protocol for Control plane (GTPv2-C); Stage 3\".
[3] 3GPP TS 23.401: \"General Packet Radio Service (GPRS) enhancements for
Evolved Universal Terrestrial Radio Access Network (E-UTRAN) access\".
[4] 3GPP TS 29.212: \"Policy and Charging Control (PCC); Reference points\".
[5] 3GPP TS 29.273: \"3GPP EPS AAA Interfaces\"
# 3 Definitions, symbols and abbreviations
## 3.1 Definitions
For the purposes of the present document, the terms and definitions given in
3GPP TR 21.905 [1] and the following apply. A term defined in the present
document takes precedence over the definition of the same term, if any, in
3GPP TR 21.905 [1].
## 3.2 Abbreviations
For the purposes of the present document, the abbreviations given in 3GPP TR
21.905 [1] and the following apply.\ An abbreviation defined in the present
document takes precedence over the definition of the same abbreviation, if
any, in 3GPP TR 21.905 [1].
# 4 **EPC race conditions scenarios and scenarios with hanging session/bearer
contexts**
## 4.1 Introduction
In the following subclauses the scenarios which lead to race conditions
scenarios and scenarios with hanging session/bearer contexts should be
described. Scenarios related to the same key issue(s) should be described in
the same subclause.
## 4.2 Scenario 1 -- Create Session Request at SGW colliding with an existing
PDN connection context
### 4.2.1 Description of the Scenario
Per subclause 7.2.1 of 3GPP TS 29.274 [2], upon receipt of a Create Session
Request (with a null or non-null TEID in the header) which collides with an
existing PDN connection context, the SGW should delete the existing PDN
connection context locally and then proceed with the creation of the new PDN
connection.
If both PDN connections (the existing and the new ones) are served by the same
PGW, the PGW will clean up the existing PDN connection context (if any) upon
receipt of the new Create Session Request.
However if both PDN connections are served by different PGWs, the PGW serving
the existing PDN connection may end up with a hanging context.
Examples of scenarios with a Create Session Request at SGW colliding with an
existing PDN connection context:
A) Delete Session Request lost over S11/S4
> An MME or SGSN fails to send a Delete Session Request to the SGW e.g. due to
> a transient S11 or S4 path failure. This results in a hanging PDN connection
> context at the SGW and PGW. Later on, the UE establishes a PDN connection
> and the MME or SGSN sends a new Create Session Request towards the same SGW
> (with the same EBI).
B) Inter-SGW mobility
> The SGW serving a particular UE is re-assigned from SGW1 to SGW2 due to a
> transient path failure between the MME and SGW1, and subsequently re-
> assigned back from SGW2 to SGW1. SGW1 detects a collision between the new
> Create Session Request and its existing PDN connection context (if it was
> not deleted by other means beforehand).
C) Mobility between 3GPP and non-3GPP accesses
> An SGW1 is assigned to a particular UE during the establishment of a PDN
> connection via a 3GPP access.
>
> The UE performs a handover (with IP address preservation) to a non-3GPP
> access. The PGW fails to send a Delete Bearer Request to SGW1 e.g. due to
> some transient path failure over S5.
>
> The UE moves back to 3GPP access (with IP address preservation) and the
> MME/SGSN selects the same SGW1.
>
> SGW1 detects the collision between the new Create Session Request (handover)
> and the existing PDN connection context.
D) Delete Bearer Request lost over S5/S8
> The PGW fails to send a Delete Bearer Request to the SGW due to a transient
> path failure over S5/S8. Later on, the MME also fails to send a Delete
> Session Request to the SGW e.g. due to a S11/S4 path failure. This results
> in a hanging context in the SGW only.
E) Delete Bearer Command lost over S11/S4
> An MME/SGSN fails to send a Delete Bearer Command to the SGW e.g. due to a
> transient S11/S4 path failure. The dedicated bearer is deleted in the
> MME/SGSN, which results in a hanging bearer context at the SGW and PGW.
> Later on, the UE establishes a new PDN connection and the MME/SGSN sends a
> Create Session Request towards the same SGW, with the EBI which corresponds
> to the hanging bearer context in the SGW/PGW.
>
> This scenario is more likely to happen over S4 than over S11, since over S11
> all the UE\'s bearers are established when the UE initiates a Service
> Request procedure, which allows the SGW to detect and clean-up any hanging
> bearer context(s).
### 4.2.2 Summary of identified problems
When the new and the existing PDN connections are served by different PGWs,
the PGW serving the existing PDN connection ends up with a stale PDN
connection context. This wastes resources and may result in unexpected
event/operation taking place for these stale sessions that could make the PGW
vulnerable.
Upon receipt of a Create Session Request (with a null or non-null TEID in the
header) which collides with an existing dedicated bearer context, deleting the
existing PDN connection context (as currently specified in GTPv2), rather than
just the dedicated bearer context, can lead to unnecessarily tear down the PDN
connection and affect the end user\'s services, e.g. in scenarios where there
is a desynchronization between the MME/SGSN and SGW/PGW only for dedicated
bearer(s) like in scenario E.
## 4.3 Scenario 2 -- Hanging IP-CAN session context in PCRF
### 4.3.1 Description of scenario
When dynamic PCC is deployed in the network, the PGW initiates an IP-CAN
Session Establishment and an IP-CAN Session Termination towards the PCRF upon
establishment and release of e.g. an IMS PDN connection, as specified in 3GPP
TS 23.401 [3] e.g. in subclauses 5.3.2.1 (E-UTRAN Initial Attach) and 5.3.8
(Detach procedure).
The PGW sends a CCR-I command (Credit Control Request, INITIAL_REQUEST) and a
CCR-T command (Credit Control Request, TERMINATION_REQUEST) to the PCRF to
establish and terminate the IP-CAN session respectively. See 3GPP TS 29.212
[4].
In actual deployments, the IP-CAN Session Termination may not be performed
successfully in some cases during the PDN connection release, i.e. the CCR-T
command is not received by the PCRF. Examples of such scenarios are:
a) the PDN connection is not cleanly released (e.g. MME does not receive a
Detach Request because the UE is powered off out of coverage),
b) SGW or PGW problem (e.g. Delete Session Request dropped by SGW or PGW due
to overload or internal failure),
c) Delete Session Request lost between the MME/SGSN and the PGW, or CCR-T lost
between the PGW and PCRF, due to path failure over the S11/S4, S5/S8 or Gx
interface.
Figure 4.3.1.1 illustrates the scenario where the Delete Session Request
message is lost over the S5 interface, either due to a path failure or because
of a PGW overload.
Figure 4.3.1.1: Delete Session Request lost over the S5 interface
1\. During a UE initiated detach procedure, the MME sends a GTP-C Delete
Session Request towards an SGW and PGW1. Due to some abnormal conditions (e.g.
PGW in overload, transient path failure), the PGW does not receive or drops
the Delete Session Request message. After a number of repetitions, the MME
locally deletes its PDN connection context. This results in a hanging PDN
connection at the PGW and PCRF.
2\. Later on, the UE initiates a new PDN connectivity Request procedure. The
MME selects a different SGW/PGW. The PCRF receives an incoming IP-CAN session
establishment request for the same UE and APN colliding with the hanging IP-
CAN session.
### 4.3.2 Summary of identified problems
This results in hanging IP-CAN session contexts in the PCRF and stale Gx
sessions between the PCRF and PGWs, and possibly hanging contexts in other EPC
nodes too (e.g. hanging PDN connection context or Diameter session context in
the PGW if a GTP-C Delete Session Request could not be sent over S5 due to a
transient path failure).
The behaviour of the PCRF upon subsequent receipt of a subsequent IP-CAN
session establishment for the same UE and same APN is unspecified in 3GPP
specifications, in particular when the new and the hanging IP-CAN sessions are
supported via different PGWs, which might result in incorrect PCRF behaviour
and denial of service for the subscriber if the PCRF does not accept such
subsequent requests.
## 4.4 Scenario 3 -- Overlapping transactions in the network
### 4.4.1 Scenario description
#### 4.4.1.1 Introduction
Heavy usage of core network resources may possibly cause processing or
transport delays, which can lead to unexpected race conditions. This subclause
addresses use cases with potential overlapping transactions in the network, in
networks experiencing processing or transport delays, whereby the original
request is repeated towards an alternative node. If the original request is
still pending in the network, it may lead to tear down valid context/session
established via the alternative node.
#### 4.4.1.2 MME/SGSN reselecting an alternative PGW during a PDN connection
establishment -- overlapping transactions over Gx
If during a PDN connection establishment, the PGW defers its response to the
MME/SGSN due to signalling delays in the PGW, PCRF, OCS or in the network, the
MME/SGSN may re-attempt to establish the PDN connection via an alternative
PGW. If the first PGW still processes the original request and subsequently
requests the PCRF to establish a Gx session, the PCRF tears down the IP-CAN
session established via the second PGW, resulting then in failure of any
subsequent VoLTE call establishment, as illustrated in figure 4.4.1.2.1.
Figure 4.4.1.2.1: MME reselecting an alternative PGW during a PDN connection
establishment
1\. During an E-UTRAN Attach or PDN connectivity request procedure, the MME
sends a GTP-C Create Session Request towards an SGW and PGW1. Due to some
abnormal conditions (e.g. PGW in overload, internal PGW problem, transient
path failure towards the PCRF, problem or delay in an upstream node such as
external AAA server, OCS), the PGW1 initiates the IP-CAN session establishment
towards the PCRF with some delay.\ \ The SGW repeats the GTP-C Create Session
Request towards the PGW1 and finally returns a negative response to the MME
with the indication that the remote peer is not responding.
2\. The MME selects an alternative PGW2 and initiates a new GTP-C Create
Session Request procedure towards the same SGW and PGW2. PGW2 performs an IP-
CAN session establishment successfully and returns a GTP-C Create Session
Response with the UE\'s IP address assigned by the PGW2.\ \ The E-UTRAN Attach
or PDN Connectivity request procedure ends successfully. The UE can then
register to IMS with the UE\'s IP address assigned by the PGW2.
3\. The PGW1 eventually initiates the IP-CAN session establishment procedure
towards the same PCRF. The PCRF detects that this new request collides with
the previous IP-CAN session established for the same UE and same APN with the
PGW2. The PCRF accepts the new request and overwrites the existing session
context.\ \ PGW1 returns a GTP-C Create Session Response to the SGW, which
ignores the response.
NOTE 1: See subclause 4.3 for the handling of hanging IP-CAN session context
by the PCRF.
4\. If the PCRF does not tear down the previous Gx session with PGW2, when the
UE initiates SIP signalling e.g. to establish a VoLTE call, the PCRF is not
able to bind the UE\'s IP address (from PGW2) received via the Rx interface
with the IP-CAN session established over Gx (from PGW1). The PCRF rejects the
Rx request and the P-CSCF returns a SIP error to the UE, i.e. the VoLTE call
establishment fails. Subsequent UE\'s re-attempts to establish the VoLTE call
continue to fail.\ \ If the PCRF tears down the previous Gx session with PGW2
(not represented in the figure), the PGW2 initiates the procedure to release
the PDN connection towards the UE. In that case, the UE can re-establish the
PDN connection and re-register to IMS, and subsequent calls succeed.
All upstream nodes may receive an overlapping request (from PGW2) when the MME
reselects an alternative PGW to establish the PDN connection.
The problem exists when a new PGW is selected, with or without reselecting the
SGW.
#### 4.4.1.3 TWAN/ePDG reselecting an alternative PGW during a PDN connection
establishment - overlapping transactions over Gx
A similar scenario as described in subclause 4.4.1.2 (with the TWAN/ePDG
replacing the MME/SGW) can also occur when the TWAN or ePDG reselects an
alternative PGW during a PDN connection establishment.
#### 4.4.1.4 TWAN/ePDG reselecting an alternative PGW during a PDN connection
establishment -- overlapping transactions over S6b
The scenario described in 4.4.1.3 also involves a 3GPP AAA Server, which may
receive a late S6b Authorization request from the first selected PGW1. The
3GPP AAA Server accepts the late incoming S6b authorization request from PGW1
and overwrites the valid / existing S6b session established via the
alternative PGW2. The 3GPP AAA Server ends up pointing to the wrong PGW1.
#### 4.4.1.5 PDN connection re-establishment via an alternative serving node
-- overlapping transactions over Gx
A similar scenario as described in subclause 4.4.1.2 can also occur whereby
the UE re-attempts to establish its PDN connection via a different serving
node (MME/SGSN or TWAN/ePDG).
Example scenarios:
1\. The UE tries to establish the PDN connection via an MME, but the UE
request gets rejected due to the PGW not responding. Then the UE attempts to
establish the PDN connection via WLAN and a different PGW is selected. The
former PGW eventually initiates the IP-CAN session establishment procedure
towards the same PCRF.
2\. The UE performs an Attach Request (with IMSI), but the UE request gets
rejected due to the PGW not responding. Then the UE performs a new Attach
(with IMSI) procedure, which ends up selecting a different MME. The new MME
selects a different PGW. The former PGW eventually initiates the IP-CAN
session establishment procedure towards the same PCRF.
3\. During the establishment of a PDN connection via an ePDG, the ePDG fails.
Then the UE re-establishes the PDN connection via a different ePDG which
selects a different PGW. The former PGW eventually initiates the IP-CAN
session establishment procedure towards the same PCRF.
4\. The UE tries to establish the PDN connection via an MME, but the UE
request gets rejected due to the PGW not responding. As a result of UE
mobility or MME load re-balancing, the UE is relocated to a different MME.
Then the UE tries to re-establish its PDN connection. The new MME selects a
different PGW. The former PGW eventually initiates the IP-CAN session
establishment procedure towards the same PCRF.
These scenarios should only happen rarely though, as they assume a combination
of events (delay in the network combined with UE repeating its PDN connection
establishment after reselecting an alternative serving node) and a delay in
the former PGW which extends beyond the time required by the UE to re-initiate
a PDN connection procedure via an alternative serving node.
#### 4.4.1.6 MME/SGSN reselecting an alternative SGW during a PDN connection
establishment -- overlapping transactions over S5/S8
The PGW may possibly receive a late incoming Create Session Request from an
SGW in the following scenario:
\- the MME sends a Create Session Request to SGW1 and PGW1, but SGW1 processes
the request with some delay (e.g. due to overload or to a transient
communication failure over S11);
\- the MME\'s N3xT3 duration expires, while N3xT3 is still running at SGW1,
and the MME reselects another SGW2 and the same PGW1. The PGW1 accepts the PDN
connection establishment request from SGW2;
\- the SGW1 is then able to process and forward the original Create Session
Request; per existing requirements, the PGW wrongly overwrites the existing
PDN connection established via the SGW2 when receiving the late incoming
Create Session Request from SGW1.
### 4.4.2 Summary of identified problems
The following problems are identified:
1\. There is a risk of potential overlapping transactions in the network, in
networks experiencing processing or transport delays, whereby the original
request is repeated towards an alternative node. If the original request is
still pending in the network, it may lead to tear down valid context/session
established via the alternative node.
> This may happen in the following scenarios:
\- MME/SGSN or TWAN/ePDG reselecting an alternative PGW during a PDN
connection establishment;
\- PDN connection re-establishment via a different serving node (in rare
scenarios);
\- MME/SGSN reselecting an alternative SGW during a PDN connection
establishment.
This problem might occur in rare scenarios/conditions; however, when
occurring, this may affect a lot of UEs (as the conditions driving to long
network answers would likely affect a lot of UEs).
NOTE: The GTP-C/Diameter overload control mechanisms introduced in Release 12
can help reducing the occurrence of these problems.
2\. Requests may possibly arrive late at a node due to transport or processing
delays, possibly after the sender has timeout. This leads to unnecessary
signalling and processing overhead for obsolete requests by the receiver and
possibly upstreams nodes.
3\. Overlapping transactions over Gx or S5/S8 may result in:
\- failure of subsequent SIP session (e.g. VoLTE) establishments; or
\- disconnection of the user\'s PDN connection, generating additional
signalling to re-establish the PDN connection and to re-register to IMS, in a
network already experiencing problems/delays, and impacting the end user\'s
experience.
4\. Overlapping transactions over S6b may result in:
\- failure of subsequent Service Authorization Information Update procedures,
e.g. user\'s subscription\'s updates, trace activation/deactivation or other
HSS notifications not being pushed to the PGW; or
\- failure of subsequent 3GPP AAA Initiated Session Termination procedures; or
\- potential disconnection of the user\'s PDN connection (the PGW may trigger
some error handling as a result of ending up with a PDN connection over
S2a/S2b without an associated S6b Diameter session), generating additional
signalling to re-establish the PDN connection and to re-register to IMS, in a
network already experiencing problems/delays, and impacting the end user\'s
experience;
## 4.5 Scenario 4 - Hanging session context in 3GPP AAA Server
### 4.5.1 Description of scenario
Upon establishment (respectively release) of a PDN connection via a trusted or
untrusted WLAN, the PGW performs an authorization procedure (respectively a
session termination procedure) towards the 3GPP AAA Server over the S6b
interface to update the AAA/HSS about the PGW address.
To do so, the PGW sends respectively an AAR command (Authorization Request)
and an STR command (Session Termination Request) to the 3GPP AAA Server to,
which establishes or tears down an S6b Diameter session between the PGW and
the 3GPP AAA Server. See 3GPP TS 29.273 [5].
In actual deployments, the session termination procedure may not be performed
successfully in some cases during the PDN connection release, i.e. the STR
command is not received by the 3GPP AAA Server. Examples of such scenarios
are: PGW problem (e.g. overload, internal issue or PGW failure), communication
issues between the PGW and PCRF, or between the TWAN/ePDG and the PGW.
Subsequently the 3GPP AAA server may receive a new S6b authorisation request
for the same UE - APN combination, from the same or a different PGW.
### 4.5.2 Summary of identified problems
If the session termination procedure over S6b fails, this results in hanging
session contexts in the 3GPP AAA Server and stale S6b sessions between the
3GPP AAA Server and PGWs, and possibly hanging contexts in other EPC nodes too
(e.g. hanging PDN connection context or Diameter session context in the PGW if
a GTP-C Delete Session Request could not be sent over S2a due to a transient
path failure).
3GPP TS 29.273 [5] **subclause 9.1.2.2.3** specifies that on reception of
session establishment request for a UE and the APN is authorised, the 3GPP AAA
Server shall accept the request. It is left open how the 3GPP AAA Server
should treat the case when the request was a subsequent S6b session
establishment for the same UE and the same APN; it is not specified what the
3GPP AAA server should do with the existing/hanging session in particular when
the existing/hanging session is via a different PGW.
If the 3GPP AAA server receives a new S6b authorisation request from the same
PGW as the PGW supporting an existing S6b session for the same UE-APN
combination, the 3GPP AAA server cannot determine whether the existing session
is a stale or a valid session.
# 5 Possible solutions for effective handling of **EPC race conditions
scenarios and scenarios with hanging session/bearer contexts**
## 5.1 Introduction
The following subclauses assess potential improvements of the existing
protocols and/or specifications for effective handling of the race conditions
scenarios or the scenarios with hanging session/bearer contexts identified in
clause 4. The specification updates, if needed, may consist in EPC (GTP-C,
PMIP and/or Diameter) signalling improvements, recommendations on how to
minimize the occurrences of the issues, and/or clarifications on how the EPC
nodes should behave in these scenarios.
## 5.2 Solutions for scenario 1 -- Create Session Request at SGW colliding
with an existing PDN connection context
### 5.2.1 Solution1 -- Delete stale context in PGW upon Create Session Request
with different PGW S5/S8 control plane IP address
#### 5.2.1.1 Solution description
The SGW can determine whether the new requested PDN connection is towards the
same old PGW or a different PGW based on the S5/S8 PGW control plane IP
address received in the Create Session Request message:
\- if this address is different from the PGW S5/S8 control plane IP address of
the existing PDN connection, then the SGW can derive that the PGW may be
different;
\- if this address is the same, the SGW can derive that this is the same PGW.
So the following solution is proposed:
\- upon receipt of a Create Session Request with a null TEID in the header
which collides with the default bearer or a dedicated bearer of an existing
PDN connection context, or upon receipt of a Create Session Request with a
non-null TEID in the header which collides with the default bearer of an
existing PDN connection context, if the PGW S5/S8 IP address for control plane
received in the new Create Session Request is different from the PGW S5/S8 IP
address for control plane of the existing PDN connection, the SGW should
delete the existing PDN connection context locally and in the corresponding
PGW by sending a Delete Session Request message;
\- upon receipt of a Create Session Request with a non-null TEID in the header
which collides with an existing dedicated bearer context, the SGW should
delete the existing dedicated bearer context locally;
\- upon receipt of a Create Session Request with TEID 0 in the header which
collides with the default bearer of an existing PDN connection context, the
PGW should delete the existing PDN connection context before creating a new
session; the PGW shall allocate a new PGW S5/S8 F-TEID for control plane to
the new PDN connection, i.e. not the same F-TEID value as the one which was
assigned to the existing PDN connection;
\- upon receipt of a Create Session Request with TEID 0 in the header which
collides with an existing dedicated bearer context, the PGW should delete the
existing dedicated bearer context and, if a related Gx session was established
for the IP-CAN session for which the existing bearer got deleted, inform the
PCRF that it has deleted the PCC rules corresponding to the deleted bearer,
before creating a new session. Then the PGW shall allocate a new PGW S5/S8
F-TEID for control plane to the new PDN connection, i.e. not the same F-TEID
value as the one which was assigned to the existing PDN connection.
NOTE 1: The SGW can send the Create Session Request and Delete Session Request
over S5/S8 asynchronously, e.g. the SGW can send the Delete Session Request
and then the Create Session Request without having to wait for the Delete
Session Response.
NOTE 2: Even if the PGWs happened to be the same (despite having different PGW
S5/S8 control plane IP addresses), sending an extra Delete Session Request in
this case does not cause any specific problem. Sending a Delete Session
Request to the existing PDN context ahead of forwarding the new Create Session
Request does not create any unnecessary PDN deactivations; it will only clear
the old PDN connection which will anyway be replaced if the SGW were to
directly send the Create Session Request (w/o a Delete Session Request).
Besides, it does not matter if the PGW happens to receive the Delete Session
Request after the Create Session Request since the PGW assigns a different
F-TEID to the new PDN connection.
The system behaviour with this proposal is further analysed below for the
example scenarios identified in subclause 4.2.1:
A) Delete Session Request lost over S11/S4
> If the new Create Session Request contains the same PGW S5/S8 control plane
> IP address as the one stored in the hanging PDN connection context, the SGW
> does not send a Delete Session Request to the PGW. The PDN connection
> context hanging in the PGW is cleaned up when the PGW receives the Create
> Session Request.
>
> If the new Create Session Request does not contain the same PGW S5/S8
> control plane IP address as the one stored in the hanging PDN connection
> context, the SGW sends a Delete Session Request to the PGW, which leads to
> tear down the hanging PDN connection context in the PGW.
>
> The solution works fine in this scenario.
B) Inter-SGW mobility
> The PGW S5/S8 IP address for control plane for the new and the existing PDN
> connection contexts are the same, so the SGW does not initiate a Delete
> Session Request towards the PGW. I.e. mobility with inter-SGW relocation
> works fine.
C) Mobility between 3GPP and non-3GPP accesses
> SGW1 detects the collision between the new Create Session Request (handover)
> and the existing PDN connection context and, assuming that both use
> different PGW S5/S8 IP addresses for control plane (i.e. that the PGW
> assigned a different PGW S5/S8 control plane IP address during the original
> PDN connection establishment via the 3GPP access), the SGW sends a Delete
> Session Request (F-TEID) to clear the existing PDN connection context in the
> PGW. This could possibly lead to tear down the PDN connection in the PGW if
> the PGW kept its PGW S5/S8 F-TEID assigned to the PDN connection and if the
> Delete Session Request is received by the PGW before the new Create Session
> Request.\ \ The problem can be avoided by requiring the SGW to include the
> Sender F-TEID for Control Plane IE in the Delete Session Request message
> when it sends this message to clean up the old PDN connection and by
> requiring the PGW to ignore a Delete Session Request received from S5/S8
> after a handover from 3GPP to non-3GPP accesses. This would require a small
> extension of the following existing requirements (cf Table 7.2.9.1-1 of 3GPP
> TS 29.274 [2]: Information Elements in a Delete Session Request)
+-------------------------+---+-------------------------+--------+---+ | Sender F-TEID for | O | This IE may be included | F-TEID | 0 | | Control Plane | | on the S5/S8 | | | | | | interfaces. | | | | | | | | | | | | If the Sender F-TEID | | | | | | for Control Plane is | | | | | | received by the PGW, | | | | | | the PGW shall only | | | | | | accept the Delete | | | | | | Session Request message | | | | | | when the Sender F-TEID | | | | | | for Control Plane in | | | | | | this message is the | | | | | | same as the Sender | | | | | | F-TEID for Control | | | | | | Plane that was last | | | | | | received in either the | | | | | | Create Session Request | | | | | | message or the Modify | | | | | | Bearer Request message | | | | | | on the given interface. | | | | | | See NOTE 6. | | | +-------------------------+---+-------------------------+--------+---+
D) Delete Bearer Request lost over S5/S8
> Sending a Delete Session Request to the PGW when the SGW detects a colliding
> Create Session Request may in the worst case end up in tearing down another
> (valid) PDN connection if the PGW already reassigned the F-TEID to a
> different PDN connection and if the Linked EPS Bearer ID (LBI) in the Delete
> Session Request matches the LBI assigned to the new PDN connection. Note
> though that the PGW should avoid reassigning the same F-TEID too quickly.
> The probability of such scenario is small. This problem can be eliminated by
> requiring the SGW to include the Sender F-TEID for Control Plane IE in the
> Delete Session Request message when it sends this message to clean up the
> old PDN connection.
E) Delete Bearer Command lost over S11/S4
> The SGW deletes the existing dedicated bearer context.
>
> If the new Create Session Request contains the same PGW S5/S8 control plane
> IP address as the one stored in the existing PDN connection context, the
> dedicated bearer context hanging in the PGW is cleaned up when the PGW
> receives the Create Session Request.
>
> If the new Create Session Request does not contain the same PGW S5/S8
> control plane IP address as the one stored in the existing PDN connection
> context, the hanging dedicated bearer connection context in the PGW will be
> torn down e.g. upon receipt of a later GTP-U Error Indication when the PGW
> sends downlink user plane packets over S5/S8 for this dedicated bearer.
> Deferring the release of the stale dedicated bearer context in the PGW is
> not expected to entail charging problems.
>
> The solution works fine in this scenario.
#### 5.2.1.2 Impacts on existing nodes and functionality
Impacts on SGW:
\- deleting the stale PDN connection context in the previous PGW, upon receipt
of a new Create Session Request colliding with an existing PDN connection in
the conditions specified in subclause 5.2.1.1;
\- deleting the stale dedicated bearer context in the SGW upon receipt of a
new Create Session Request with a non-null TEID in the header colliding with
an existing dedicated bearer context.
Impacts on PGW:
\- deleting the stale dedicated bearer context in the PGW upon receipt of a
new Create Session Request colliding with an existing dedicated bearer
context;
\- allocate a new PGW S5/S8 F-TEID for control plane to the new PDN
connection, upon receipt of a new Create Session Request colliding with an
existing PDN connection.
NOTE: It is anyway a general requirement that PGWs should not reassign too
quickly the same F-TEID to new PDN connections, so there isn\'t any real PGW
impact here.
#### 5.2.1.3 Evaluation of the solution
The solution is an enhancement to the existing behaviour by allowing to clear
the existing PDN connections contexts both in the SGW and PGW, thus avoiding
to create hanging contexts in PGWs.
The solution also avoids tearing down the PDN connection and affecting the end
user\'s services in scenarios where there is a desynchronization between the
MME and SGW/PGW only for dedicated bearer(s) like in scenario E.
The solution has minimal impact on the SGW and PGW.
The solution can still result in hanging dedicated bearer contexts in the PGW
in the scenario E.
## 5.3 Solutions for scenario 2 -- Hanging IP-CAN session context in PCRF
### 5.3.1 Solution1 -- PCRF accepts subsequent IP-CAN session establishment
#### 5.3.1.1 Solution description
A UE may establish multiple PDN connections to the same APN, but as in 3GPP TS
23.401 [3], all the UE\'s PDN connections to the same APN shall be supported
by the same PGW.
Upon receipt of a new IP-CAN Session Establishment request which collides with
an existing IP-CAN session for the same UE and APN established with a
different PGW, the PCRF shall delete all the existing IP-CAN session(s)
context(s) for this UE and APN, and proceed with the new IP-CAN Session
Establishment request.
While deleting the existing IP-CAN session(s), the PCRF shall also tear down
any existing associated Diameter session (e.g. Gx session towards the previous
PGW, Sd session towards a TDF) by sending session termination request(s)
towards the PCRF\'s peer(s). As a result, the previous PGW initiates a GTP-C
Delete Bearer Request to release the PDN connection. In the scenario
illustrated in subclause 4.3.1, the SGW ignores the Delete Bearer Request
message.
The PCRF can determine whether an incoming session establishment request, for
the same UE and APN as an existing session context, originates from the same
or a different PGW, by checking the Origin-Host AVP.
NOTE: It is assumed that the Origin-Host AVP **received by the PCRF has not
been modified or does still allow to identify uniquely the originating PGW,**
in network deployment with intermediate Diameter Routing Agent or Diameter
Proxy Agent between the PGW and the PCRF.
#### 5.3.1.2 Impacts on existing nodes and functionality
Impacts on PCRF:
\- overwrite the existing UE\'s IP-CAN session context when a new Gx session
is established while another one is already established for the same UE and
APN with a different PGW.
#### 5.3.1.3 Evaluation of the solution
The solution provides the following benefits:
\- it ensures an IP-CAN session can be established successfully even if a
former IP-CAN session for the same UE and APN had not been terminated
successfully, i.e. so it ensures service resilience when abnormal scenarios
take place in the network.
No drawbacks have been identified.
## 5.4 Solutions for scenario 3 -- Overlapping transactions in the network
### 5.4.1 Solution 1 -- Guard timer at PGW to control the maximum time to
respond to a Create Session Request
#### 5.4.1.1 Solution description
The PGW monitors the time it takes to respond to an incoming Create Session
Request and returns a negative Create Session Response if this time exceeds
the maximum response time configured locally. In such a case, the PGW tears
down any session it may have already established towards upstreams node(s),
e.g. PCRF, AAA or OCS.
#### 5.4.1.2 Impacts on existing nodes and functionality
Impacts on PGW:
\- control the maximum time to respond to a Create Session Request;
\- tear down sessions established towards upstreams nodes if the PGW cannot
return a response to the originating node before the maximum response time.
#### 5.4.1.3 Evaluation of the solution
Pros:
\- only minimal impact in the PGW;
\- can be implemented without standardization changes.
Cons:
\- does not address the case of message loss or transport delay from the
MME/SGSN to the PGW, i.e. when the request is already received late by the
PGW; so this only deals with upstreams delays e.g. towards PCRF, AAA or OCS;
\- there are difficulties, for roaming with home routed traffic, to ensure
accurate and coordinated timer configuration in the network such that the PGW
ceases to try to process the request not too early but not too late either
(compared to when the originating node will timeout its request), since the
PGW and MME/SGSN pertain to different PLMNs;
\- evaluating for every incoming request whether the request is still valid or
obsolete (i.e. receiving node comparing the current time with the time at
which the message was received plus the maximum response time); cease
processing a request if it is too late.
### 5.4.2 Solution 2 -- Longer T3 timer for the last GTP-C repetition
#### 5.4.2.1 Solution description
The originator of the GTP-C Create Session Request (MME/SGSN, TWAN/ePDG) uses
a longer T3 timer for the last GTP-C repetition of the message, so as to leave
enough time to the PGW to respond and minimize the risk of generating
overlapping transactions in the network.
#### 5.4.2.2 Impacts on existing nodes and functionality
Impacts on MME/SGSN, TWAN/ePDG:
\- have a longer T3 timer for the last GTP-C repetition.
#### 5.4.2.3 Evaluation of the solution
Pros:
\- only minimal impact in MME/SGSN, TWAN/ePDG
\- can be implemented without standardization changes.
Cons:
\- causes some extra delay before reselecting an alternative node (in rare
scenarios);
\- decreases but does not completely remove the risk of overlapping
transactions in the network;
\- requires accurate timer configuration in the network such that the MME/SGSN
(TWAN/ePDG) does not wait too short nor too long before reselecting an
alternative PGW. In roaming with home routed traffic, the PGW and MME/SGSN
pertain to different PLMNs and may use different timers setting.
### 5.4.3 Solution 3 -- PCRF accepting the new IP-CAN session and tearing down
the Gx session towards the previous PGW
#### 5.4.3.1 Solution description
The PCRF accepts the new IP-CAN session and tears down the Gx session towards
the previous PGW, upon receipt of a new Gx session establishment colliding
with an existing IP-CAN session context for the same UE and APN combination
from a different PGW. In the scenario of figure 4.4.1.2, upon receipt of the
late Gx request from PGW1 (which is received by the PCRF after the Gx session
is established with PGW2), the PCRF tears down the Gx session with PGW2. As a
result, PGW2 initiates a PDN disconnection and the UE re-establishes its IMS
PDN connection, which leads to clear the stale contexts in PGW1.
The PCRF can determine whether an incoming session establishment request, for
the same UE and APN as an existing session context, originates from the same
or a different PGW, as specified in subclause 5.3.1.1.
#### 5.4.3.2 Impacts on existing nodes and functionality
Impacts on PCRF:
\- accepting the new IP-CAN session and tearing down the stale Gx session
towards the previous PGW.
#### 5.4.3.3 Evaluation of the solution
Pros:
\- only minimal impact in the PCRF;
\- can be implemented without standardization changes.
Cons:
\- this can result in the termination of the valid IP-CAN session connection
and hence cause extra signalling to tear down and re-establish the IMS PDN
connection, during network conditions that were not ideal and caused the race
condition in the first place;
\- this is a reactive solution, after the problem has already taken place; the
end user\'s services may possibly be affected for a short duration (until the
UE completes its IMS re-registration);
\- this may not converge, i.e. there is no guarantee that the same race
condition could not happen again and the PCRF could end up terminating the
valid IP-CAN session yet again.
### 5.4.4 Solution 4 -- Including a Timestamp in the session request
#### 5.4.4.1 Solution description
The node originating the GTP-C Create Session Request (MME/SGSN, TWAN/ePDG)
includes a Timestamp in the message, indicating the time at which the request
is initiated.
Intermediate nodes (e.g. SGW, PGW) forwards the Timestamp of the originating
node towards the upstream nodes that need to process the request (e.g. PCRF,
3GPP AAA Server).
Any node (PCRF or 3GPP AAA Server) receiving a new session request colliding
with an existing session context, for the same UE and APN and from a different
PGW, accepts the new session request only if it contains a more recent
timestamp than the timestamp stored for the existing session. I.e. the
receiving node uses the Timestamp to detect and reject a late arriving request
colliding with an existing context.
The PCRF and 3GPP AAA Server can determine whether an incoming session
establishment request, for the same UE and APN as an existing session context,
originates from the same or a different PGW, as specified in subclauses
5.3.1.1 and 5.5.1.1 respectively.
The PGW may also use the Timestamp, upon receiving a new Create Session
Request colliding with an existing session context for the same UE, and accept
the new Create Session Request only if it contains a more recent timestamp
than the timestamp stored for the existing session. I.e. the PGW may use the
Timestamp to detect and reject a late arriving request colliding with an
existing context.
The SGW propagates the Timestamp parameter to the PGW and does not make any
further use of this parameter.
The solution assumes that all originating nodes (MME/SGSN, TWAN/ePDG) are
synchronized on time (universal time NTP). Any originating node that detects a
NTP failure does not include the information towards peers.
NOTE: NTP synchronization is necessary for scenarios where the UE repeats its
request via an alternative originating node (e.g. MME relocation scenarios or
UE reattaching to a different MME), but also to avoid rejecting new valid
session establishment requests from other originating entities.
Figure 5.4.4.1.1 illustrates the scenario described in subclause 4.4.1.2 (MME
reselecting a different PGW to establish the PDN connection due to delays in
the first PGW to forward the request to the PCRF) with the above proposal.
Figure 5.4.4.1.1: Use of TimeStamp - MME reselecting an alternative PGW during
a PDN connection establishment
Differences with the scenario documented in subclause 4.4.1.2 are highlighted
below.
1\. The MME includes its Timestamp (TS~1~) in the GTP-C Create Session
Request. The SGW forwards the TS~1~ received from the MME towards the PGW1.
2\. The MME includes its Timestamp (TS~2~) in the GTP-C Create Session
Request. The SGW forwards the TS~2~ received from the MME towards the PGW2.
PGW2 also forwards the TS~2~ towards the PCRF during the IP-CAN session
establishment.
3\. PGW1 eventually initiates the IP-CAN session establishment procedure
towards the same PCRF. PGW1 forwards the TS~1~ towards the PCRF. The PCRF
detects that this request collides with the existing session (same UE and APN,
different PGW) and thus rejects the request as TS~1~ is older than TS~2~.
4\. Upon subsequent SIP session establishments, the PCRF is able to bind the
UE\'s IP address (from PGW2) received via the Rx interface with the IP-CAN
session established over Gx (from PGW2).
#### 5.4.4.2 Impacts on existing nodes and functionality
Impacts on MME/SGSN, TWAN/ePDG, SGW, PGW:
\- new Timestamp IE in GTP-C Create Session Request over S11/S4, S5/S8;
\- NTP monitoring and fallback to existing behaviour (i.e. no Timestamp in
request) upon detection of a NTP failure;
\- MME/SGSN and TWAN/ePDG need to be NTP synchronized;
Impacts on PGW, PCRF, 3GPP AAA Server:
\- new Timestamp AVP in CCR-I command over Gx and in Authorization Request
over S6b.
\- PGW, PCRF and 3GPP AAA Server stores the Timestamp of the originating node
during a session establishment; upon detection of a collision between a new
session establishment request with an existing session, the timestamps are
compared to determine whether to accept or reject the new request.
#### 5.4.4.3 Evaluation of the solution
Pros:
\- this is a proactive solution, avoiding to overwrite and tear down valid
session contexts;
\- avoids generating extra signalling to tear down and re-establish the IMS
PDN connection for possibly a lot of UEs when the network starts experiencing
delays (as the conditions driving to long network answers would likely affect
a lot of UEs);
\- avoids impacts to end user\'s services;
\- also works in scenarios where the UE re-attempts to establish its PDN
connection via a different serving node (MME/SGSN or TWAN/ePDG);
Cons:
\- impacts several nodes: MME/SGSN, TWAN/ePDG, SGW, PGW, PCRF, 3GPP AAA
Server; with small to moderate impacts;
\- add some little overhead (processing and storing information) to all
nominal scenarios, in many nodes/interfaces, all the time, for overlapping
transactions scenarios that should remain rare;
\- additional 10 to 15 bytes (64 bit NTP Time Stamp) needed for every GTP-C
Create Session Request / CCR-I or S6b Authorization Request command;
\- does not avoid hanging contexts to occur;
\- all originating nodes need to monitor their NTP state and revert to the
existing behaviour in case of NTP failure.
\- all originating nodes (MME/SGSN, TWAN/ePDG) need to be NTP synchronized;
### 5.4.5 Solution 5 -- Including a Timestamp and Maximum Wait Time in the
session request
#### 5.4.5.1 Solution description
The node originating the GTP-C Create Session Request (MME/SGSN, TWAN/ePDG)
includes in the message:
\- a Timestamp indicating the time at which the request is initiated;
\- a Maximum Wait Time indicating the maximum time to complete the processing
of the request, i.e. the time the originating node waits before it times out.
Intermediate nodes (e.g. SGW, PGW) forwards the Timestamp and the Max Wait
Time of the originating node towards the upstream nodes that need to process
the request (e.g. PCRF, 3GPP AAA Server).
Any node (PCRF or3GPP AAA Server) receiving a new session request colliding
with an existing session context, for the same UE and APN and from a different
PGW, accepts the new session request only if it contains a more recent
timestamp than the on-going one (as per the solution 4). As per the solution
4, the PGW may also use the Timestamp, upon receiving a new Create Session
Request colliding with an existing session context for the same UE, and accept
the new Create Session Request only if it contains a more recent timestamp
than the timestamp stored for the existing session. Besides, any node (PCRF,
3GPP AAA Server, or intermediate nodes such as SGW or PGW) receiving the
message after the time \"Timestamp + Max Wait Time\" should reject the
message. I.e. the receiving node uses:
\- the Timestamp to detect a late arriving request colliding with an existing
context;
\- the Max Wait Time to detect an obsolete request which has already timed out
at the originating node.
A node (PCRF, 3GPP AAA Server, or intermediate nodes such as SGW or PGW) which
supports this solution:
\- should check that the request is not obsolete upon receipt of that request;
\- may perform additional checks that the request has not become obsolete
during the processing of the request, e.g. for scenarios where some upstream
nodes would not support this feature, or to avoid ending up with hanging
contexts if the request has become obsolete since the request was received;
An SGW or PGW that has forwarded a (non obsolete) Create Session Request to
the next upstream node may, based on implementation\'s choice, either
\- not make any further check on the Maximum Wait Time, i.e. fallback to the
existing behaviour, or
\- reject or ignore the Create Session Request later on, when detecting that
the request has become obsolete, e.g. upon receipt of a Response message from
the next upstream node.
NOTE 1: sending a rejection response over the last hop towards the originating
node, i.e. S11/S4 or S2a/S2b, for a request that has become obsolete, is not
useful as the corresponding request at the originating node will already have
timed out.
Any node (PCRF, 3GPP AAA Server, or intermediate nodes such as SGW or PGW)
that created a session with a peer node and is now rejecting (or ignoring) the
message should initiate a clean up to avoid stale sessions in the network.
E.g. an SGW should send a Delete Session Request to the PGW.
The PCRF and 3GPP AAA Server can determine whether an incoming session
establishment request, for the same UE and APN as an existing session context,
originates from the same or a different PGW, as specified in subclauses
5.3.1.1 and 5.5.1.1 respectively.
The solution assumes all network elements are synchronized on time (universal
time NTP). Any node that detects a NTP failure ignores the new parameters and
does not include the information towards peers.
**The Maximum Wait Time shall be set to a value** smaller or equal to (N3+1) x
T3 set in the SGW, to avoid upstream nodes continuing to process requests
which would have ceased to be processed by the SGW, which could result in
hanging contexts in upstream nodes.
NOTE 2: If the Maximum Wait Time is set to a value smaller than N3 x T3 set in
the SGW, the SGW actually stops retransmitting a given GTP-C Create Session
Request as soon as it receives a negative response from the PGW due to the
expiry of the Maximum Wait Time. I.e. the Maximum Wait Time actually leads to
shorten the duration during which the SGW may retransmit the GTP-C request.
Figure 5.4.5.1.1 illustrates the scenario described in subclause 4.4.1.2 (MME
reselecting a different PGW to establish the PDN connection due to delays in
the first PGW to forward the request to the PCRF) with the above proposal.
Figure 5.4.5.1.1: Use of TimeStamp and Max Wait Time - MME reselecting an
alternative PGW during a PDN connection establishment
Differences with the scenario documented in subclause 4.4.1.2 are highlighted
below.
1\. The MME includes its Timestamp (TS~1~) and Max Wait Time (MWT) in the
GTP-C Create Session Request. The SGW forwards the TS~1~ and MWT received from
the MME towards the PGW1.
2\. The MME includes its Timestamp (TS~2~) and Max Wait Time (MWT) in the
GTP-C Create Session Request. The SGW forwards the TS~2~ and MWT received from
the MME towards the PGW2. PGW2 also forwards the TS~2~ and MWT towards the
PCRF during the IP-CAN session establishment.
3\. PGW1 eventually initiates the IP-CAN session establishment procedure
towards the same PCRF. PGW1 forwards the TS~1~ and MWT towards the PCRF. The
PCRF detects that this request arrives after the time \" TS~1~ + MWT\" and
thus rejects (or ignores) the request.\ \ PGW1 detects rejects (or ignores)
the Create Session Request.
4\. Upon subsequent SIP session establishments, the PCRF is able to bind the
UE\'s IP address (from PGW2) received via the Rx interface with the IP-CAN
session established over Gx (from PGW2).
#### 5.4.5.2 Impacts on existing nodes and functionality
Impacts on MME/SGSN, TWAN/ePDG, SGW, PGW, PCRF, 3GPP AAA Server:
\- new Timestamp and Max Wait Time IEs in GTP-C Create Session Request over
S11/S4, S5;
\- new Timestamp and Max Wait Time AVPs in CCR-I command over Gx and
Authorization Request command over S6b;
\- NTP time synchronization, monitoring and fallback to existing behaviour
upon NTP failure
\- PGW, PCRF and 3GPP AAA Server stores the Timestamp of the originating node
during a session establishment; upon detection of a collision between a new
session establishment request with an existing session, the timestamps are
compared to determine whether to accept or reject the new request.
\- evaluating for every incoming request whether the request is still valid or
obsolete (i.e. receiving node comparing the current NTP time with the
Timestamp + Max Wait Time information in the request); cease processing a
request if it is too late;
\- SGW, PGW, PCRF, 3GPP AAA Server optionally performing additional checks
that the request has not become obsolete during the processing of the request,
and if so, storing the Maximum Wait Time of the request message of a pending
transaction.
#### 5.4.5.3 Evaluation of the solution
Pros:
\- this is a proactive solution, avoiding overwriting valid session contexts;
\- avoids generating extra signalling to tear down and re-establish the IMS
PDN connection for possibly a lot of UEs when the network starts experiencing
delays (as the conditions driving to long network answers would likely affect
a lot of UEs);
\- avoids impacts to end user\'s services.
\- avoids processing incoming obsolete requests at the receiver and further
upstream nodes;
\- receiver knows exactly when the originator of the request will time out.
Alleviates the need for tight coordination in timers setting between
originators and receivers;
\- also works in scenarios where the UE re-attempts to establish its PDN
connection via a different serving node (MME/SGSN or TWAN/ePDG);
Cons:
\- impacts several nodes: MME/SGSN, TWAN/ePDG, SGW, PGW, PCRF, 3GPP AAA
Server, with moderate to fair impacts;
\- all network nodes need to be NTP synchronized;
\- add some little overhead (processing and storing information) to all
nominal scenarios, in many nodes/interfaces, all the time. Overlapping
transactions scenarios should remain rare, while the overhead applies to all
transactions;
\- network nodes need to monitor their NTP state and revert to the existing
behaviour in case of NTP failure;
\- about additional 15 bytes (64 bit NTP Time Stamp, + Max Wait Time) needed
for every GTP-C Create Session Request / CCR-I or S6b Authorization Request
command;
\- might be limited to intra-PLMN scenarios (due to tight NTP
synchronization);
\- does not avoid hanging contexts when delays occur for Diameter/GTP answers
(or this requires the originator to wait for the response for a longer period
than the Max Wait Time communicated to the upstream nodes);
\- upstream nodes continue to process a request until the end of \'Timestamp +
Max Wait Time\' provided by the node originating the request (e.g. MME), while
intermediate nodes may possibly use a shorter maximum retransmission time
(e.g. if the T3 x N3 period used by the SGW ends before \'Timestamp + Max Wait
Time\'). So the intermediate nodes timeout obviates the Max Wait Time at the
end node still causing processing at upstream node for obsolete requests.
### 5.4.6 Solution 6 - Introducing \"Resend Indicator\" in Create Session
Request
#### 5.4.6.1 Solution description
When the MME receives a Create Session Response with the cause \"Peer not
Responding\" and the MME decides to send a Create Session Request via an
alternative PDN GW, the MME shall add a \"Resend Indicator\" in the Create
Session Request. The SGW forwards the Indicator to the PDN GW. The PDN GW
forwards this \"Resend Indicator\" to the PCRF in the CCR-I message.
Handling in the PCRF:
\- If the PCRF receives an IP-CAN Session Establishment request with the
\"Resend Indicator\" and the PCRF has already an IP-CAN session for that
UE/APN combination associated to a different PGW, then the PCRF shall release
the existing IP-CAN session and accept the new IP-CAN session establishment
request.
\- If the PCRF has established an IP-CAN session with the Resend Indicator and
receives during a subsequent short period of time an IP-CAN session
establishment request for that UE/APN combination without the \"Resend
Indicator\" from a different PDN GW, the PCRF shall reject the IP-CAN session
establishment request.
NOTE: the late incoming CCR-I message (step 3 of of Figure 4.4.1.2.1) cannot
be used as a trigger for the PCRF to re-accept subsequent IP-CAN session
establishment request without the \"Resend Indicator\", because this message
may in certain scenarios not be received at all by the PCRF or be
retransmitted over the Gx interface.
\- If the PCRF has established an IP-CAN session without the \"Resend
Indicator\" and receives an IP-CAN session establishment request for that
UE/APN combination without the \"Resend Indicator\" from a different PDN GW,
the PCRF shall release the existing IP-CAN session and accept the new IP-CAN
session establishment request.
The same principles would also apply to an SGSN, TWAN or ePDG reselecting an
alternative PGW to establish a PDN connection.
The \"Resend Indicator\" is also set in the Authorization Request over S6b to
solve scenarios with overlapping transactions other S6b (see subclause
4.4.1.4).
The PCRF and 3GPP AAA Server can determine whether an incoming session
establishment request, for the same UE and APN as an existing session context,
originates from the same or a different PGW, as specified in subclauses
5.3.1.1 and 5.5.1.1 respectively.
#### 5.4.6.2 Impacts on existing nodes and functionality
Impacts on MME/SGSN, TWAN/ePDG, SGW, PGW:
\- new IE \"Resend Indicator\" in GTP-C Create Session Request over S11/S4,
S5/S8;
Impacts on PGW, PCRF, 3GPP AAA Server:
  * new \"Resend Indicator\" AVP in CCR-I command over Gx and in Authorization Request over S6b.
#### 5.4.6.3 Evaluation of the solution
Pros:
  * this is a proactive solution, avoiding to overwrite and tear down valid session contexts;
  * avoids generating extra signalling to tear down and re-establish the IMS PDN connection for possibly a lot of UEs when the network starts experiencing delays (as the conditions driving to long network answers would likely affect a lot of UEs);
  * avoids impacts to end user\'s services.
  * The solution impacts only the procedure (message) when the MME chooses an alternative PDN-GW when the session creation failed to a PDN GW.
Cons:
  * Impacts several nodes: MME, SGSN, SGW, PGW, PCRF, TWAN, ePDG, 3GPP AAA Server, with small impacts.
  * Difficulty to set the period of time during which the PCRF should reject an IP-CAN session establishment request without the \"Resend Indicator\" for the same UE/APN after the establishment of an IP-CAN session with the Resend Indicator. A too short period could result in the PCRF overwriting a valid session context due to a late incoming session establishment request from the former PGW; a too long period could result in rejecting new valid IP-CAN session establishment requests if the PDN connection established with the \"Resend Indicator\" is not terminated correctly.
  * Does not work in scenarios where the UE re-attempts to establish its PDN connection via a different serving node (MME/SGSN or TWAN/ePDG), since both serving nodes establish the PDN connection without any Resend Indicator. Thus the problems identified in subclause 4.4.2 still exist in these scenarios.
## 5.5 Solutions for scenario 4 - Hanging session context in 3GPP AAA Server
### 5.5.1 Solution1 -- 3GPP AAA Server sends an ASR command to clean up
possible hanging resources
#### 5.5.1.1 Solution description
Per stage 2 requirements, multiple PDN connections for the same UE - APN
combination shall be supported by the same PGW.
**After the 3GPP AAA has accepted a new S6b session** from a particular PGW**,
the 3GPP AAA server considers** that any **existing S6b session(s)** for the
same UE -- APN combination supported via a different PGW is **obsolete and
sends ASR command(s) to initiate the termination of the hanging session(s) in
that PGW and 3GPP AAA server, either immediately or after some delay.**
The 3GPP AAA Server can determine whether an incoming session establishment
request for the same UE and APN as an existing session context originates from
the same or a different PGW, using the Origin-Host AVP received in the S6b
Authorization Request message (see subclause 9.1.2.2 of 3GPP TS 29.273 [5]).
NOTE: It is assumed that the Origin-Host AVP **received by the 3GPP AAA Server
has not been modified or does still allow to identify uniquely the originating
PGW,** in network deployment with intermediate Diameter Routing Agent or
Diameter Proxy Agent between the PGW and the 3GPP AAA Server.
Upon receipt of an ASR command, the PGW does not immediately release the PDN
connection, as the TWAN/ePDG is responsible for releasing the PDN connection
over S2a/S2b. However, if the PGW does not receive any request to delete the
PDN connection from the TWAN/ePDG shortly after receipt of the ASR command,
the PGW locally deletes the resources.
#### 5.5.1.2 Impacts on existing nodes and functionality
Impacts on 3GPP AAA Server:
\- sending an ASR command to tear down a hanging session, either immediately
or after some delay.
#### 5.5.1.3 Evaluation of the solution
The solution provides the following benefits:
\- it ensures that possible hanging resources in PGW and 3GPP AAA server are
cleared without impacting the user.
No drawbacks have been identified.
# 6 Conclusions and recommendations
## 6.1 Introduction
The following subclauses contain the summary of conclusions on the solutions
for the scenarios and key issues identified in clause 4 based on solutions and
evaluations described in clause 5.
## 6.2 Conclusion for scenario 1 -- Create Session Request at SGW colliding
with an existing PDN connection context
Several scenarios have been identified in subclause 4.2.1 which may result in
hanging PDN connection context in the SGW and PGW. Based on existing
specifications, upon receipt of a GTP-C Create Session Request over S11/S4
which collides with an existing PDN connection context, the SGW deletes the
existing PDN connection context locally, but as identified in subclause 4.2.2,
the scenario results in a hanging PDN connection context in the PGW when the
new and the existing PDN connections are served by different PGWs, which
wastes resources in the PGW. Besides, the existing behaviour may lead to
unnecessarily tear down the entire PDN connection when there is just a hanging
dedicated bearer context in the SGW and PGW.
The solution 1 in subclause 5.2.1 comprises two (independent) parts:
a) avoid to tear down the entire PDN connection in the SGW and PGW when there
is just a dedicated bearer context mismatch between the MME/SGSN and the
SGW/PGW.
b) SGW sending a Delete Session Request to the PGW to clear the hanging PDN
connection context.
It is recommended to specify the solution 1 (both parts) and to recommend the
SGW and PGW to support these changes.
It is finally recommended that the necessary details within this report be
used as a basis for further normative work within the Release 13 timeframe.
Table 6.2.1 identifies the 3GPP specifications which require modifications to
support the above conclusions.
Table 6.2.1: Impacts for scenario 1 -- CSREq at SGW colliding with an existing
PDN connection context
+------------------------+----------------+-------------------------+ | Existing Specification | Responsible WG | Brief summary of | | | | impacts | +------------------------+----------------+-------------------------+ | TS 29.274 | CT4 | - SGW sends a Delete | | | | Session Request to | | | | the PGW to delete | | | | the stale PDN | | | | connection context | | | | in the previous | | | | PGW, in the | | | | conditions | | | | specified in | | | | subclause 5.2.1.1. | | | | | | | | - SGW and PGW deletes | | | | (only) the stale | | | | dedicated bearer | | | | context locally in | | | | the conditions | | | | specified in | | | | subclause 5.2.1.1. | | | | | | | | - PGW shall assign a | | | | new PGW S5/S8 | | | | F-TEID for control | | | | plane to the new | | | | PDN connection. | | | | | | | | - The description of | | | | the \'Sender F-TEID | | | | for Control Plane\' | | | | IE in the Delete | | | | Session Request is | | | | extended as defined | | | | in subclause | | | | 5.2.1.1. | +------------------------+----------------+-------------------------+
There is no Gx protocol impact since the behaviour specified in subclause
5.2.1.1 (i.e. the PCEF informing the PCRF that the PCC rules corresponding to
a deleted bearer have been deleted) corresponds to the existing behaviour over
the Gx reference point.
## 6.3 Conclusion for scenario 2 -- Hanging IP-CAN session context in PCRF
Scenarios have been identified in subclause 4.3.1 which may result in hanging
IP-CAN session contexts in the PCRF and stale Gx sessions between the PCRF and
PGWs.
Recommendations on the PCRF behaviour upon receipt of a subsequent IP-CAN
session establishment for the same UE and same APN are captured in subclause
6.4.
## 6.4 Conclusion for scenario 3 -- Overlapping transactions in the network
There is a risk of potential overlapping transactions over the Gx and S6b
reference points, in networks experiencing processing or transport delays, in
the following scenarios:
\- MME/SGSN or TWAN/ePDG reselecting an alternative PGW during a PDN
connection establishment;
\- PDN connection re-establishment via a different serving node.
As identified in subclause 4.4.2, these scenarios can result in valid PDN
connections being disconnected and in failure of various procedures; besides,
late incoming requests can cause unnecessary signalling and processing by
upstreams nodes, after the request times out at the serving node.
Workarounds exist, without standardization changes, to reduce the risk of
occurrence of these issues, e.g. by using a guard timer at the PGW controlling
the maximum time to respond to a Create Session Request (see solution 1 in
subclause 5.4.1) or by using a longer T3 timer for the last GTP-C repetition
(see solution 2 in subclause 5.4.2). They do not completely eliminate though
the possibility of overlapping transactions in the network. Besides, ensuring
accurate and coordinated timer configuration may also be an issue in roaming
scenarios with home routed traffic.
The solution 6 (i.e. introducing a \'resend indicator\' information element in
a repeated Create Session Request, see subclause 5.4.6) has minimal system
impacts, but does not work in scenarios when the UE re-establishes its PDN
connection via a different serving node. Besides, this solution can cause
difficulties in setting the period of time during which the PCRF should reject
an IP-CAN session establishment, and a conservative, smaller value would need
to be used to avoid rejecting new valid PDN connection establishment requests,
possibly still causing the PCRF to overwrite a valid session context upon
receipt of a late incoming session establishment request.
It is recommended for the PCRF to support the solution 3 by default, i.e. the
PCRF shall accept the new IP-CAN session, however the behaviour of whether to
tear down the old Gx session is out of scope and left to implementations (see
subclause 5.4.3). Depending on existing PCRF implementations, this solution
requires no or minimal impact in the PCRF, and ensures that the end user\'s
services (e.g. VoLTE call) will eventually be served, although it can cause
additional signalling and affect the end user\'s services for a short
duration.
It is also recommended to specify the solution 4 (i.e. including a Timestamp
in the session request, see subclause 5.4.4) as a network/operator option,
i.e. to define a new optional Timestamp information element in the GTP-C
Create Session Request over S11/S4, S5/S8 and S2a/S2b, and a new corresponding
AVP in the CCR-I command over Gx and in the Authorization Request over S6b.
When supported, this option should preferably be supported by all the involved
nodes, but the feature also works if some originating nodes (e.g. MME, SGSN,
TWAN or ePDG) do not yet support it. The PCRF should behave according to the
default behaviour specified above, if the incoming request does not contain
the new Timestamp information, either because some originating nodes (MME,
SGSN, TWAN or ePDG) or intermediate node (e.g. SGW or PGW) does not support
the new information element. All the originating nodes shall be NTP
synchronized if they support this solution.
The Maximum Wait Time information, in the solution 5 (see subclause 5.4.5)
further helps in avoiding to process incoming obsolete requests at the
receiver and further upstream nodes, but this requires the PGW and further
upstreams nodes to be also NTP synchronized with the originating nodes
(MME/SGSN, TWAN/ePDG). It is recommended to specify this additional
network/operator option, when the Timestamp option is also supported, for use
over non roaming interfaces (i.e. to nodes pertaining to the same PLMN). If
allowed by operator policy:
\- the originating node (MME/SGSN, TWAN/ePDG) may also include the Maximum
Wait Time information if the PGW does not pertain to the same PLMN (i.e. Home
Routed roaming);
\- the PGW may also send the Maximum Wait Time information towards the PCRF
and 3GPP AAA Server if they do not pertain to the same PLMN (i.e. Local
Breakout roaming).
When supported, this option shall not affect how intermediate nodes (e.g. SGW)
compute their own retransmission timers (e.g. the SGW is not expected to adapt
its T3 x N3 retransmission period to the \'Timestamp + Max Wait Time\'
received from an MME/SGSN).
It is finally recommended that the necessary details within this report be
used as a basis for further normative work within the Release 13 timeframe.
Table 6.4.1 identifies the 3GPP specifications which require modifications to
support the above conclusions.
Table 6.4.1: Impacts for scenario 3 -- Overlapping transactions in the network
+------------------------+----------------+-------------------------+ | Existing Specification | Responsible WG | Brief summary of | | | | impacts | +------------------------+----------------+-------------------------+ | TS 29.274 | CT4 | - Requirements | | | | related to the use | | | | of the new | | | | Timestamp and | | | | Maximum Wait Time | | | | information; | | | | | | | | - New Timestamp and | | | | Max Wait Time IEs | | | | in Create Session | | | | Request over | | | | S11/S4, S5/S8, | | | | S2a/S2b | +------------------------+----------------+-------------------------+ | TS 29.275 | CT4 | - New Timestamp and | | | | Max Wait Time IEs | | | | in PBU (PDN | | | | connection | | | | establishment) over | | | | S5/S8 and S2a/S2b | +------------------------+----------------+-------------------------+ | TS 29.282 | CT4 | - New 3GPP specific | | | | PMIPv6 Mobile | | | | Options Sub Type(s) | | | | need to be added | +------------------------+----------------+-------------------------+ | TS 29.273 | CT4 | - New Timestamp and | | | | Max Wait Time AVPs | | | | in Authorization | | | | command over S6b | +------------------------+----------------+-------------------------+ | TS 29.230 | CT4 | - New Timestamp and | | | | Max Wait Time AVPs | | | | and error causes | +------------------------+----------------+-------------------------+ | TS 29.212 / TS 29.213 | CT3 | - New Timestamp and | | | | Max Wait Time AVPs | | | | in CCR-I command | | | | over Gx | | | | | | | | - If no Timestamp is | | | | received, the PCRF | | | | accepts the new | | | | IP-CAN session as | | | | per the solution 3 | | | | however the | | | | behaviour of | | | | whether to tear | | | | down the old Gx | | | | session is out of | | | | scope and left to | | | | implementation. | +------------------------+----------------+-------------------------+ | TS 23.008 | CT4 | - Storage of the | | | | Timestamp and Max | | | | Wait Time in the | | | | relevant EPC nodes. | +------------------------+----------------+-------------------------+
NOTE 1: 3GPP CT3 confirmed the impacts above regarding the functional entities
and reference points under their remit (see C3-153436).
NOTE 2: 3GPP CT3 will evaluate during the normative specification work whether
the intermediate Diameter Routing Agents or Diameter Proxy Agents between the
PCEF and the PCRF need to be further involved in the processing of the
Timestamp and Maximum Wait Time information, beyond simply propagating these
parameters to the PCRF.
## 6.5 Conclusion for scenario 4 -- Hanging session context in 3GPP AAA Server
In subclause 4.5.2 scenarios have been identified which may result in hanging
session in the 3GPP AAA server, possibly in PGW and possibly hanging PDN
connection contexts in the PGW.
The solution in subclause 5.5.1 describes how ASR command can be used to tear
down hanging resources in 3GPP-AAA server and the PGW when the 3GPP-AAA server
receives an S6b session establishment for an UE-APN configuration from a
different PGW than the current PGW, if the S6b session establishment is not
regarded as an outdated S6b request received due to delay in the network.
The criteria when (immediately or with some delay) to trigger the tear down of
a hanging session is implementation specific.
Table 6.5.1: Impacts for scenario 4 -- Hanging session context in 3GPP AAA
Server
+------------------------+----------------+-------------------------+ | Existing Specification | Responsible WG | Brief summary of | | | | impacts | +------------------------+----------------+-------------------------+ | TS 29.273 | CT4 | - A recommendation | | | | should be added to | | | | clarify that the | | | | ASR command can be | | | | used to tear down | | | | possible hanging | | | | session | +------------------------+----------------+-------------------------+
#
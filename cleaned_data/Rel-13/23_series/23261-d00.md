# Foreword
This Technical Specification has been produced by the 3^rd^ Generation
Partnership Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# 1 Scope
This document specifies the Stage 2 system description for IP flow mobility
between a 3GPP and a WLAN. The technical solution is based on the working
principles of DSMIPv6 [2] and it is applicable to both the Evolved Packet
System and the I-WLAN mobility architecture.
The specification covers the system description of seamless WLAN offload and
IP flow mobility between 3GPP and WLAN as well as the respective interactions
with the PCC and ANDSF frameworks. The system description for non seamless
WLAN offload is covered in 3GPP TS 23.402 [3].
This document specifies also the detailed extensions to S2c [3] and H1 [4]
reference points for IP flow mobility. The extensions to the PCC and to the
ANDSF framework are specified respectively in 3GPP TS 23.203 [5] and in 3GPP
TS 23.402 [3].
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or non‑specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
[1] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[2] IETF RFC 5555 (June 2009): \"Mobile IPv6 support for dual stack Hosts and
Routers (DSMIPv6)\".
[3] 3GPP TS 23.402: \"Architecture enhancements for non-3GPP accesses\".
[4] 3GPP TS 23.327: \"Mobility between 3GPP-Wireless Local Area Network (WLAN)
interworking and 3GPP systems\".
[5] 3GPP TS 23.203: \"Policy and Charging Control architecture\".
[6] IETF RFC 4877 (April 2007): \"Mobile IPv6 Operation with IKEv2 and the
Revised IPsec Architecture\".
[7] IETF RFC 5648 (October 2009): \"Multiple Care-of Addresses Registration\".
[8] IETF RFC 6089 (January 2011): \"Flow Bindings in Mobile IPv6 and Network
Mobility (NEMO) Basic Support\".
[9] 3GPP TS 23.234: _\"_ 3GPP System to Wireless Local Area Network (WLAN)
Interworking; System Description _\"_.
[10] 3GPP TS 23.401: \"General Packet Radio Service (GPRS) enhancements for
Evolved Universal Terrestrial Radio Access Network (E-UTRAN) access\".
[11] 3GPP TS 23.060: \"General Packet Radio Service (GPRS); Service
description; Stage 2\".
[12] IETF RFC 6088 (January 2011): \"**Traffic Selectors for Flow Bindings**
\"**.**
[13] IETF RFC 5846 (June 2010): \"Binding Revocation for IPv6 Mobility\".
[14] IETF RFC 6275 (July 2011): \"Mobility Support in IPv6\".
# 3 Definitions and abbreviations
## 3.1 Definitions
For the purposes of the present document, the terms and definitions given in
TR 21.905 [1] and the following apply.
The following terms used in this Technical Specification are defined in RFC
6275 [14]: Home Address, Care-of Address, binding cache, binding cache entry.
The following terms used in this Technical Specification are defined in TS
23.402 [3]: Home network prefix.
**Home Agent:** The Home Agent functionality consists in the DSMIPv6 anchor
point functionality described in RFC 5555 [2] and in RFC 4877 [6] and the
extensions defined in RFC 5648 [7] and RFC 6089 [8]. As per TS 23.402 [3], the
HA functionality is located in the PDN Gateway. As per TS 23.327 [4] the HA
functionality can be either a standalone entity or co-located with the GGSN or
with the PDG.
_**Local Operating Environment Information:** This is a set of implementation
specific parameters which describe the local environment in which the UE is
operating._
**routing address:** A routable IP address. In DSMIPv6 this is either the CoA
(visited link case) or the HoA (in home link case).
**routing filter:** A set of packet flow IP header parameter values/ranges
used to identify one or more IP flows for routing purposes.
**routing rule:** The association of a routing filter with a routing address.
## 3.2 Abbreviations
For the purposes of the present document, the abbreviations given in TR 21.905
[1] and the following apply.
BID Binding Identifier
CoA Care-of Address
DSMIPv6 Dual-Stack Mobile IPv6
EPC Evolved Packet Core
ePDG Evolved Packet Data Gateway
EPS Evolved Packet System
FID Flow Identifier
GW Gateway
HA Home Agent
HoA Home Address
UE User Equipment
# 4 Architecture model and concepts
## 4.1 General concepts
This document specifies a mechanism for a UE to simultaneously connect to 3GPP
access and WLAN and exchange different IP flows belonging to the same PDN
connection through different accesses. The mechanism also enables seamless IP
flow mobility, with IP flows belonging to the same or different applications
being moved seamlessly between a 3GPP access and WLAN.
The solution allows the operator to indicate how the IP flows are routed
through the available access systems and to selectively offload some traffic
(e.g. best effort traffic) to WLAN while using UTRAN or E-UTRAN for other
traffic (e.g. traffic with specific QoS requirements). This is usually
referred to as WLAN offload.
The technical solution is based on DSMIPv6 [2] and is applicable to both the
Evolved Packet System and the I-WLAN mobility architecture. Since the solution
is based on DSMIPv6, IP address preservation and session continuity is
provided when moving IP flows from one access to the other.
## 4.2 Architecture reference model
### 4.2.1 Non-roaming architecture
The baseline architecture reference model for IP flow mobility when EPS is
deployed in the non roaming case is specified in TS 23.402 [3].
The baseline architecture reference model for IP flow mobility when I-WLAN
mobility is deployed in the non roaming case is specified in TS 23.327 [4].
The baseline Non-roaming architecture for I-WLAN is specified in TS 23.234
[9].
The baseline Non-roaming architecture for ANDSF is specified in TS 23.402 [3].
### 4.2.1 Roaming architecture
The baseline architecture reference model for IP flow mobility when EPS is
deployed in the roaming case is specified in TS 23.402 [3].
The baseline architecture reference model for IP flow mobility when I-WLAN
mobility is deployed in the roaming case is specified in TS 23.327 [4].
The baseline roaming architecture for I-WLAN is specified in TS 23.234 [9].
The baseline roaming architecture for ANDSF is specified in TS 23.402 [3].
## 4.3 High level functions
### 4.3.1 S2c and H1 extensions for IP flow mobility
#### 4.3.1.1 General
The granularity of access system connectivity and inter system mobility based
on TS 23.402 [3] and TS 23.327 [4] is per PDN connection basis. This implies
that when a handover occurs all the IP flows belonging to the same PDN
connection are moved from the source access system to the target access
system.
With IP flow mobility it is possible to have a finer granularity in access
system connectivity and inter system mobility: the handover procedures can be
applied to a single or multiple IP flows belonging to the same PDN connection.
This implies that some IP flows of one PDN connection can be routed via one
access system while simultaneously some IP flows of the same PDN connection
can be routed via another access system.
To achieve IP flow mobility the inter-system mobility signalling is enhanced
in order to carry routing filters. The extensions to DSMIPv6 mobility
signalling needed to carry routing filters when the UE is connected to
multiple accesses simultaneously are specified in RFC 5648 [7] and RFC 6089
[8] and are applicable to both S2c and H1.
#### 4.3.1.2 DSMIPv6 enhancements
When a UE configures different IP addresses on multiple accesses, it can
register these addresses with the HA as CoAs using multiple bindings as
specified in IETF RFC 5648 [7].
To register multiple bindings, the UE generates a Binding ID (BID) for each
CoA and stores the BID in the binding update list. The UE then registers its
CoAs by sending a Binding Update (BU) with a Binding Identifier mobility
option. The BID is included in the Binding Identifier mobility option. When
the UE is on the home link in one of the access, the CoA field is set to the
HoA in the respective BID.
When the HA receives the BU with a Binding Identifier mobility option, it
copies the BID from the mobility option to the corresponding field in the
Binding Cache entry. If there is an existing Binding Cache entry for the UE,
and if the BID in the BU does not match the one with the existing entry, the
HA creates a new Binding Cache entry for the new CoA and BID.
Based on this extension, a typical Binding Cache in HA according to this
specification in case the UE is not on the home link is shown in Table
4.3.1.2-1.
NOTE: A BID is only unique for a given HoA, i.e. different mobile nodes can
use the same BID value.
Table 4.3.1.2-1: Binding Cache in HA supporting multiple CoAs registration
* * *
Home Address Care-of Address Binding ID Priority HoA1 CoA1 BID1 x HoA1 CoA2
BID2 y ... ... ... ...
* * *
In order to route IP flows through a specific access, the UE needs to request
to store routing filters for that access at the HA: the UE includes the Flow
Identification (FID) mobility option in the BU message as defined in RFC 6089
[8]. The FID option defines a routing rule which contains a routing filter and
a routing address. The routing address (either CoA or HoA) is indicated by the
BID. The routing filter is included in the DSMIPv6 signalling as described in
RFC 6088 [12]. The routing filters are unidirectional and can be different for
uplink and downlink traffic.
It is assumed that between UE and the Home Agent function there is always a
default routing address via which packets not matching any specific routing
filter are routed. The UE provides a relative priority with each BID, where
the BID with the highest priority is the default route. The UE may update the
priority of a BID during IP flow mobility procedures.
To install/remove/move an IP flow, the UE shall create a new IP flow binding
or remove/update the IP flow binding at the HA by using DSMIPv6 signalling as
specified in RFC 5555 [2], RFC 5648 [7] and RFC 6089 [8].
An example of a typical Binding Cache in HA with routing filters is shown in
Table 4.3.1.2-2. Note that a FID is only unique for a given HoA, i.e.
different PDN connections can use the same FID value. Each flow binding entry
contains a relative priority.
Table 4.3.1.2-2: Binding Cache in HA supporting flow bindings
* * *
Home Address Routing Address Binding ID BID Priority Flow ID FID Priority
Routing Filter HoA1 CoA1 BID1 x FID1 a Description of IP flows... FID2 b
Description of IP flows... HoA1 CoA2 BID2 y FID3 ... ...
* * *
NOTE: This clause shows only a conceptual representation of the binding cache.
The actual format is implementation specific.
### 4.3.2 Policy provisioning for Inter-system mobility and WLAN offload
In order to allow the operator to indicate to the UE through which access
technology IP flows are expected to be routed, inter system routeing policies
are introduced in TS 23.402 [3]. Such policies can be defined per APN, per IP
flow class under any APN or per IP flow class under a specific APN and can be
provided to the UE either through ANDSF or by means of static pre-
configuration.
For IP flows that are routed over WLAN, the inter system routeing policies
also specify whether the traffic should be routed through the HA or directly
via the WLAN access, bypassing the HA.
The normative procedures for ANDSF and UE can be found in TS 23.402 [3].
### 4.3.3 Policy Control and Charging support
When IP flow mobility is used and PCC is deployed, the PCC architecture is
enhanced to handle multiple simultaneous access connections for a single
IP‑CAN session. These enhancements require the PDN GW to keep the PCRF up to
date about the current routing address for each IP flow.
The detailed description of the normative procedures for PCC enhancements can
be found in TS 23.203 [5].
### 4.3.4 Local Operating Environment Information
In addition to operator policy and user preferences, the UE may take into
account the Local Operating Environment Information when deciding which access
to use for an IP flow.
The actual Local Operating Environment Information is implementation dependent
and may comprise of such items as, radio environment information, quality of
IP connection, application specific requirements, power considerations, etc.
# 5 IP Flow Mobility procedures and flows
## 5.1 General
This section describes the IP flow mobility procedures for different
scenarios. The call flows are described in a common way for I-WLAN and EPS and
the procedures which are applicable to EPS only are marked as optional and
identified as not applicable to an I-WLAN mobility deployment. Furthermore the
call flows do not differentiate between trusted or untrusted accesses as the
IP flow mobility procedures are common as soon as the UE configures a Care-of
Address.
## 5.2 PDN connection establishment over first access
### 5.2.1 General
This clause specifies the additional UE procedures when establishing a PDN
connection through a 3GPP or through a WLAN access when the UE supports IP
flow mobility. In these flows it is assumed that the UE has not established
the PDN connection through any access yet.
NOTE: In the rest of the document the PDN connection establishment procedure
is meant to be PDP context activation procedure in case of I-WLAN mobility
architecture.
### 5.2.2 PDN connection establishment over 3GPP access
The UE performs the initial PDN connection establishment to a 3GPP access as
shown in Figure 5.2.2-1. This procedure applies independently whether the UE
attaches to EPS or GPRS.
Figure 5.2.2-1: PDN connection procedure over 3GPP access
1\. The initial PDN establishment procedure is performed by the UE according
to TS 23.401 [10] or TS 23.060 [11], depending if the PDN connection
establishment is to EPS or GPRS. During this step an IPv4 address and/or an
IPv6 address/prefix is assigned to the UE.
2\. The UE performs HA discovery, DSMIPv6 bootstrapping and the home link
detection procedure as described in TS 23.402 [3] or TS 23.327 [4].
If the UE requests the home network prefix in the Protocol Configuration
Option (as in TS 23.402 [3]), the UE shall requests in the Protocol
Configuration Option an indication of HA support of IP flow mobility.
If the UE obtains the home network prefix using the IKEv2 procedure, the UE
shall use IKEv2 signaling to indicate IFOM support. The HA supporting IFOM
shall use IKEv2 signaling to confirm the IFOM support.
If the HA does not support IFOM, the UE shall disable IFOM capabilities for
that PDN connection.
The presence of ANDSF inter-system routing policies for a given PLMN may be
considered by the UE as an implicit indication that the Home Agents of that
PLMN support IP flow mobility. If the UE has ANDSF inter-system routing
policies, the UE may skip the IKEv2 and PCO procedures to check the IFOM
support of the PDN GW for the PDN GWs residing in the PLMN where the ANDSF
policies are valid.
3\. If the UE detects it is not on the home link, the UE sends a DSMIPv6
Binding Update (HoA, CoA, Lifetime, BID) message to the HA as specified in RFC
5555 [2] and RFC 5648 [7]. The inclusion of the BID mobility option at this
stage is an indication that the UE supports IP Flow Mobility extensions. The
UE may also include some FID mobility options as described in RFC 6089 [8].
NOTE: This step cannot happen in case IP flow mobility is used in EPS as 3GPP
is always the home link in EPS.
4\. The HA validates the BU, installs the IP flow mobility routing rules,
establishes the DSMIPv6 bindings and sends a BA to the UE per RFC 5555 [2],
RFC 5648 [7] and RFC 6089 [8].
### 5.2.3 PDN connection establishment over WLAN
The UE performs the initial PDN connection establishment over a WLAN access as
shown in Figure 5.2.3-1.
Figure 5.2.3-1: PDN connection procedure over non-3GPP access
1\. The UE connects to the WLAN and configures an IPv4 address and/or an IPv6
address/prefix. Depending on the specific scenario considered the UE attaches
either to a trusted WLAN, an ePDG via an untrusted WLAN or to a PDG via a
I-WLAN access as specified in TS 23.402 [3] or TS 23.327 [4]. If the UE
connects to PDG or ePDG, an IPv4 address and/or an IPv6 address/prefix is
assigned to the UE.
2\. If the UE connects to a Trusted non-3GPP access and dynamic PCC is
deployed, a GW control session may be established as specified in TS 23.203
[5].
3\. The UE performs HA discovery, DSMIPv6 bootstrapping and the home link
detection procedure as described in TS 23.402 [3] or TS 23.327 [4].
During the home link detection procedure in IKEv2, the UE shall use IKEv2
signalling to indicate IFOM support. The HA supporting IFOM shall use IKEv2
signalling to confirm the IFOM support.
If the HA does not support IFOM, the UE shall disable IFOM capabilities for
that PDN connection.
The presence of ANDSF inter-system routing policies for a given PLMN may be
considered by the UE as an implicit indication that the Home Agents of that
PLMN support IP flow mobility. If the UE has ANDSF inter-system routing
policies, the UE may skip the IKEv2 and PCO procedures to check the IFOM
support of the PDN GW for the PDN GWs residing in the PLMN where the ANDSF
policies are valid.
4\. If the UE detects it is not on the home link, the UE sends a DSMIPv6
Binding Update (HoA, CoA, Lifetime, BID) message to the HA as specified in RFC
5555 [2] and RFC 5648 [7]. The inclusion of the BID mobility option at this
stage is an indication that the UE supports IP Flow Mobility extensions. The
BID mobility option contains the Binding ID of the WLAN access. The UE may
also include some FID mobility options as described in RFC 6089 [8].
5\. If the HA function is located in the PDN GW and dynamic PCC is deployed,
the PDN GW performs an IP-CAN session establishment procedure with the PCRF as
specified in TS 23.203 [5].
6\. The HA validates the BU, installs the IP flow mobility routing rules,
establishes the DSMIPv6 bindings and sends a BA to the UE per RFC 5555 [2],
RFC 5648 [7] and RFC 6089 [8].
## 5.3 Addition of an access to a PDN connection
### 5.3.1 General
This clause specifies the additional procedures for adding an access to an
existing PDN connection over a 3GPP access or a WLAN access when the UE
supports IP flow mobility. In these flows it is assumed that the UE has
performed a PDN Connection establishment procedure through one access as
specified in clause 5.2. Subsequently the UE attaches to a second access and
starts using both accesses for the same PDN connection. As a result the UE is
simultaneously connected via both accesses and a set of traffic flows are
routed through one access while the remaining traffic flows are routed through
the other access.
Non-roaming, home routed roaming and Local Breakout cases are supported by
this procedure. The AAA proxy and vPCRF are only used in the case of home
routed roaming and Local Breakout. In non-roaming scenarios, the AAA proxy and
vPCRF are not involved.
The optional interaction steps between the gateways and the PCRF in the
procedures only occur if dynamic policy provisioning is deployed in EPC. These
steps are never present when the solution is applied to I-WLAN mobility
architecture according to TS 23.327 [4].
### 5.3.2 Addition of WLAN access
After successfully attachment to 3GPP access, the UE has established a PDN
connection over 3GPP access as specified in clause 5.2.2. Subsequently the UE
performs the WLAN attachment, and requests to establish a PDN connection using
the same APN, and attempts to use both accesses for the same PDN connection
simultaneously. The WLAN access may be considered as the UE\'s foreign link
from DSMIPv6 perspective.
Figure 5.3.2-1: Addition of WLAN access to the PDN connection
The signalling flow above shows the particular case where the UE is first
connected to a 3GPP access and then it requests addition of a WLAN access.
1\. The UE discovers a WLAN and connects to it and configures an IPv4 address
and/or an IPv6 address/prefix according to TS 23.402 [3] or TS 23.327 [4],
depending whether the WLAN access is used in the context of EPC or I-WLAN
mobility architecture.
2\. The UE performs HA discovery, DSMIPv6 bootstrapping and DSMIPv6 home link
detection procedure according to TS 23.402 [3] unless already performed in the
3GPP access.
3\. The UE sends a DSMIPv6 Binding Update (HoA, CoA, Lifetime, BID, FID, flow
description) message to the HA over the WLAN access. The UE may include the
requested routing rules via the FID mobility option with both the routing
filters and the BID (which includes the routing address) as specified in IETF
RFC 5555 [2], IETF RFC 5648 [7] and RFC 6089 [8]. The UE can include more than
one routing rule by including multiple FID mobility options in the Binding
Update. The DSMIPv6 Binding Update also contains an indication which indicates
that the home link (3GPP access) is still connected and also the BID mobility
options which identify that one binding is associated with the home address
(3GPP access) and the other with the Care-of-Address from the WLAN access. The
UE also indicates in the Binding Update which is the default binding where the
HA should route packets not matching any FID as specified in RFC 6089 [8].
4\. In case the HA function is located in the PDN GW and dynamic PCC is
deployed, the PDN GW sends an IP-CAN session modification request to the PCRF.
In this request, the PDN GW provides the updated routing rules to the PCRF.
The PCRF stores the mapping between each SDF and its routing address.
5\. If the HA function is located in the PDN GW, based on the successful
establishment of resources at the BBERF, the PCRF sends an acknowledgement to
the PDN GW, including updated PCC rules if appropriate.
6\. The HA creates a DSMIPv6 binding, installs the IP flow routing rules and
sends a Binding Acknowledgment (Lifetime, HoA, CoA, BID, FID) as specified in
RFC 5555 [2], RFC 5648 [7] and RFC 6089 [8], to indicate which routing rules
requested by the UE are accepted.
The PDN GW may send message 6 before receiving the reply from PCRF in message
5.
7\. Based on the IP-CAN session modification request (if step 4 was
performed), the PCRF ensures that the relevant QoS rules for the SDFs are
installed in the target BBERF. This is done by a GW control session and QoS
rules provision procedure as specified in TS 23.203 [5].
8\. In case the HA function is located in the PDN GW, appropriate 3GPP
resource release procedures are executed for the resources associated with the
flows that were moved away from the 3GPP source access. This procedure may be
triggered by the PCRF via a GW control session and QoS rules provision
procedure if PMIPv6 is used on S5 and it may be triggered by the PDN GW in
case GTP is used on S5.
If the HA function is implemented in I-WLAN mobility, the UE may initiate GPRS
resource release procedures for those resources that were moved away from the
3GPP source access, as specified in TS 23.060 [11].
### 5.3.3 Addition of 3GPP access
After successfully attachment to WLAN access, the UE has established a PDN
connection over WLAN as specified in clause 5.2.3. As the UE detected the WLAN
access is not the home link from DSMIPv6 perspective, DSMIPv6 signalling was
triggered over the WLAN access.
Subsequently, as described in this clause, the UE performs the initial
attachment procedure or PDN Connection establishment procedure over a 3GPP
access and establishes a PDN connection using the same APN, as described in TS
23.060 [11], TS 23.401 [10] or TS 23.402 [3]. As the UE has indicated IP flow
mobility during the initial attachment over WLAN, the 3GPP access attachment
completion shall not trigger the DSMIPv6 binding deregistration.
Figure 5.3.3-1: Addition of 3GPP access to the PDN connection
The signalling flow above shows the particular case where the UE is first
connected to a WLAN access and then it requests addition of a 3GPP access.
1\. The UE discovers a 3GPP access and performs the Attach or PDN Connection
establishment procedure according to TS 23.401 [10] or TS 23.060 [11].
Specifically, the UE sets the Request Type to Handover to facilitate the MME
selects the same PDN GW/HA as the UE connects in WLAN Access. Since the UE has
indicated IP flow mobility support during the initial attachment over WLAN,
the HA shall not deregister the DSMIPv6 binding by sending a Binding
Revocation Indication towards the WLAN access.
2\. The UE sends a DSMIPv6 Binding Update (HoA, CoA, Lifetime, BID, FID, flow
description) message to the HA over the 3GPP access. The UE may include the
requested routing rules via the FID mobility option with both the routing
filters and the BID (which includes the routing address) as specified in RFC
5555 [2], RFC 5648 [7] and RFC 6089 [8]. If the 3GPP access is the home link,
the UE sets the \'H\' flag in the respective BID mobility option, as specified
in RFC 6089 [8]. The UE can include more than one routing rule by including
multiple FID mobility options in the Binding Update. The UE also indicates in
the Binding Update which is the default binding where the HA should route
packets not matching any FID as specified in RFC 6089 [8].
3\. In case the HA function is located in the PDN GW and dynamic PCC is
deployed, the PDN GW sends an IP-CAN session modification request to the PCRF.
In this request, the PDN GW provides the updated routing rules to the PCRF.
The PCRF stores the mapping between each SDF and its routing address.
4\. If the HA function is located in the PDN GW, based on the successful
establishment of resources at the BBERF, the PCRF sends an acknowledgement to
the PDN GW, including updated PCC rules if appropriate.
5\. The HA sends a Binding Acknowledgment (Lifetime, HoA, CoA, BID, FID) as
specified in RFC 5555 [2], RFC 5648 [7] and RFC 6089 [8], to indicate which
routing rules requested by the UE are accepted.
The PDN GW/HA may send message 5 before receiving the reply from PCRF in
message 4.
6\. Based on the IP-CAN session modification request (if step 3 was
performed), the PCRF ensures that the relevant QoS rules for the SDFs are
installed in the target BBERF. This is done by a GW control session and QoS
rules provision procedure as specified in TS 23.203 [5].
7\. In case the HA function is located in the PDN GW, appropriate 3GPP bearer
setup or modification procedures are executed for the resources associated
with the flows that were moved onto the 3GPP access. This procedure may be
triggered by the PCRF via a GW control session and QoS rules provision
procedure if PMIPv6 is used on S5 and it may be triggered by the PDN GW in
case GTP is used on S5.
If the HA function is implemented in I-WLAN mobility, the UE may initiate GPRS
bearer setup or modification procedures for those resources that were moved
onto the 3GPP access, as specified in TS 23.060 [11].
## 5.4 IP flow mobility within a PDN connection
### 5.4.1 General
This clause specifies the IP flow mobility procedures within a PDN connection.
In these procedures the UE is assumed to simultaneously connect via a 3GPP
access and a WLAN access. The UE is using both the accesses for the same PDN
connection. Subsequently, the UE adds/modifies/deletes/moves between accesses
IP flows using DSMIPv6 messages.
Non-roaming, home routed roaming and Local Breakout cases are supported by
this procedure. The AAA proxy and vPCRF shown in Figure 5.4.2-1 are only used
in the case of home routed roaming and Local Breakout. In non-roaming
scenarios, the AAA proxy and vPCRF are not involved.
The optional interaction steps between the gateways and the PCRF in the
procedures only occur if dynamic policy provisioning is deployed in EPC. These
steps are not present when the solution is applied to I-WLAN mobility
architecture according to TS 23.327 [4].
There are two scenarios, depending on UE initiates the QoS establishment in
the target access or the network performs the QoS establishment when the IP
flow is moved.
### 5.4.2 IP flow mobility within a PDN connection with network-initiated
dynamic PCC
In this scenario the UE moves one or more IP flow(s) from one access to the
other access and network-intiated dynamic PCC is used is used to set up or
remove appropriate resources.
Figure 5.4.2-1: IP Flow Mobility and network initiated dynamic PCC
1\. The UE is simultaneously connected to a 3GPP access and a WLAN access
based on the procedures specified in clauses 5.2 and 5.3. Based on current
routing rules some traffic is routed through the 3GPP access and some other
traffic through the WLAN access.
2\. The UE sends a Binding Update (HoA, BID, FID) as specified in RFC 5555
[2], RFC 5648 [7] and RFC 6089 [8] to the HA to install a new routing rule or
to modify the routing address of an existing routing rule to route the
respective traffic (identified by the included FID) through one particular
access (identified by the included BID) or to remove an existing routing rule.
In case of new routing rule with a new FID mobility option, the UE includes
the routing filter description.
NOTE: The UE can send the Binding Update either from the 3GPP or from the WLAN
access irrespective of which access the IP flow is moved to.
3\. In case the HA function is implemented in EPC, the PDN GW sends an IP-CAN
session modification request to the PCRF. In this request the PDN GW provides
the updated routing rules to the PCRF. The PCRF stores the updated mapping
between routing addresses and SDFs.
4\. If the HA function is implemented in EPC, based on the successful
establishment of resources in the WLAN access, the PCRF sends an
acknowledgement to the PDN GW, including updated PCC rules if appropriate.
5\. The HA sends a Binding Acknowledgment (Lifetime, HoA, BID, FID) as
specified in RFC 5555 [2], RFC 5648 [7] and RFC 6089 [8], to indicate which
routing rules requested by the UE are accepted.
The PDN GW/HA may send message 5 before receiving the reply from PCRF in
message 4.
6\. If the HA function is implemented in EPC, based on the IP-CAN session
modification request, the PCRF ensures that the relevant QoS rules are
installed in the target access or the relevant QoS rules are uninstalled from
the source access. For non-3GPP access, this is done by a GW control session
and QoS rules provision procedure as specified in TS 23.203 [5].
7\. If the HA function is implemented in EPC, appropriate EPS resource release
procedures are executed for those resources that were moved away from the 3GPP
source access or appropriate EPS resource allocation procedures are executed
for those resources that were moved onto the 3GPP access, as specified in TS
23.402 [3]. This procedure may be triggered by the PCRF via a GW control
session and QoS rules provision procedure if PMIPv6 is used on S5 and it may
be triggered by the PDN GW in case GTP is used on S5.
### 5.4.3 IP flow mobility within a PDN connection with UE-initiated resource
request
In this scenario the UE requests for resources in the target access with UE-
initiated procedures and when the resources are provided, the UE moves one or
more IP flow(s) to the target access.
Figure 5.4.3-1: IP Flow Mobility and UE initiated resource request
1\. The UE is simultaneously connected to a 3GPP access and a WLAN access
based on the procedures specified in clauses 5.2 and 5.3. Based on current
routing rules some traffic is routed through the 3GPP access and some other
traffic through the WLAN access.
2\. Before moving an IP flow currently routed over WLAN to the 3GPP access,
the UE requests appropriate resources in the 3GPP access. This is done as
specified in clause 5.4.5 of TS 23.401 [10] or in clause 9.2.2.1.1 or
9.2.2.1.1A of TS 23.060 [11]. In this procedure the UE includes the packet
filters related to the requested resources. In this step if the HA function is
implemented in EPC, the PDN GW may interact with the PCRF to trigger the
appropriate PCC decision. The PCRF can authorize the resource establishment
but since there is no change in the routing rules provided by the PDN GW.
NOTE 1: After this step and until step 5 is performed, resources are allocated
in two accesses for the same SDF.
3\. The UE sends a Binding Update (HoA, BID, FID) as specified in RFC 5555
[2], RFC 5648 [7] and RFC 6089 [8] to the HA to install a new routing rule or
to modify the routing address of an existing routing rule to route the
respective traffic (identified by the included FID) through one particular
access (identified by the included BID) or to remove an existing routing rule.
In case of new routing rule with a new FID mobility option, the UE includes
the routing filter description.
NOTE 2: The UE can send the Binding Update either from the 3GPP or from the
WLAN access irrespective of which access the IP flow is moved to.
NOTE 3: The routing filters included in the BU can be different from the
packet filters included in step 2 by the UE. QoS will be provided only based
on the packet filters installed in step 2 but the UE can include different,
e.g. more generic, routing filters in this operation.
4\. In case the HA function is implemented in EPC, the PDN GW sends an IP-CAN
session modification request to the PCRF. In this request the PDN GW provides
the updated routing rules to the PCRF. The PCRF stores the updated mapping
between routing addresses and SDFs.
  1. If the HA function is implemented in EPC, based on the successful establishment of resources in the WLAN access, the PCRF sends an acknowledgement to the PDN GW, including updated PCC rules if appropriate.
6\. The HA sends a Binding Acknowledgment (Lifetime, HoA, BID, FID) as
specified in RFC 5555 [2], RFC 5648 [7] and RFC 6089 [8], to indicate which
routing rules requested by the UE are accepted.
The PDN GW may send message 6 before receiving the reply from PCRF in message
5.
  1. If the HA function is implemented in EPC, based on the IP-CAN session modification request, the PCRF ensures that the resources associated with the routing filters moved to the 3GPP access are released. This is done by a GW control session and QoS rules provision procedure as specified in TS 23.203 [5].
## 5.5 Removal of an access from a PDN connection
### 5.5.1 UE-initiated removal of an access from a PDN connection
In this scenario, the UE is attached to a 3GPP access and a WLAN access and is
using both the accesses for the same PDN connection. Subsequently, the UE
moves all IP flows associated with one access to another access and
disconnects from the one access (e.g. due to loss of coverage or by an
explicit detach).
The optional interaction steps between the gateways and the PCRF in the
procedures only occur if dynamic policy provisioning is deployed in EPC. These
steps are never present when the solution is applied to I-WLAN mobility
architecture according to TS 23.327 [4].
Figure 5.5-1: Removal of one access from the PDN connection
1\. The UE is simultaneously connected to a 3GPP access and a WLAN access
based on the procedures specified in clauses 5.2 and 5.3. Based on current
routing rules some IP flows are routed through the 3GPP access and some other
IP flows through the WLAN access.
2\. The UE decides to move all IP flows to one access and to disconnect from
the other access (e.g. due to loss of coverage, based on internal trigger,
based on updated policies from ANDSF).
a. If UE disconnects one access (either a home link or a foreign link) and
maintains the other access which is the foreign link, the UE sends a Binding
Update (Lifetime, HoA, BID) to the HA with lifetime set to 0 to remove the BID
of the access it disconnects from. Or, alternatively, the UE sends a Binding
Update (HoA, BID) over the maintained foreign link to the HA with lifetime set
to non-zero, the BID of the maintained foreign link, and \"O\" flag set.
b. If the UE disconnects the WLAN access which is a foreign link and maintains
only the 3GPP access which is the home link, the UE sends a Binding Update
with lifetime 0 without any BID. This de-registration Binding Update can be
sent from any available access.
3\. In case the HA function is located in the PDN GW, the PDN GW initiates the
IP-CAN session modification procedure with the PCRF. In this procedure, the
PDN GW removes the routing address related to the removed BID associated with
the IP-CAN session.
4\. The HA sends a Binding Acknowledgment (Lifetime, HoA, BID) as specified in
RFC 5555 [2], RFC 5648 [7] and RFC 6089 [8].
NOTE 1: As specified in RFC 6089 [8] the routing rules which point to a
routing address which is not registered become inactive and don\'t influence
the routing of the packets, i.e. there is no need for the UE to change the
routing rules as all packets will be anyway routed to the only existing
binding.
5\. If the HA function is located in the PDN GW, as part of the IP-CAN session
modification procedure initiated in step 3, the PCRF ensures that the relevant
QoS rules for the SDFs are installed in the target BBERF. This is done by a GW
control session and QoS rules provision procedure as specified in TS 23.203
[5].
6\. If in step 2 the UE has removed the BID associated with the 3GPP access
and maintained the BID for the WLAN access, the PDN GW shall initiate the PDN
GW Initiated PDN Disconnection procedure in 3GPP access as defined in TS
23.402 [3], clause 5.6.2.2 or the PDN GW Initiated Bearer Deactivation
procedure as defined in TS 23.401 [10], clause 5.4.4.1. The PDN GW shall set
the release cause to \'RAT changed from 3GPP to Non-3GPP\' to avoid the MME
remove the PDN GW ID from the HSS. In case of I-WLAN mobility architecture and
the UE has removed the BID associated with the 3GPP access, the UE may
initiate PDP Context Deactivation as described in TS 23.060 [11].
If the BID associated with the WLAN access is removed, according to TS 23.402
[3] the security associations between the UE and the HA should not be
immediately deleted. As the security associations were created dynamically
using IKEv2 they will be automatically deleted when they expire. Similarly,
for I-WLAN mobility architecture, the H2 session between the HA and the AAA
Server should not be immediately deleted. The H2 session will be deleted by
the HA immediately after security associations are deleted. In case of I-WLAN
mobility architecture, the UE may initiate release of the IKEv2 security
association with the PDG according to TS 23.234 [9].
NOTE 2: In case a detach from 3GPP access needs to be triggered, e.g. based on
O&M, a PDN GW initiated PDN disconnection procedure is used instead of a
MME/SGSN-initiated detach/PDN disconnection procedure.
### 5.5.2 HA-initiated removal of an access from a PDN connection
In this scenario, the UE is attached to a 3GPP access and a WLAN access and is
using both the accesses for the same PDN connection. The HA disconnects the UE
from the one access (e.g. due to change of subscription) .
The optional interaction steps between the gateways and the PCRF in the
procedures only occur if dynamic policy provisioning is deployed in EPC. These
steps are never present when the solution is applied to I-WLAN mobility
architecture according to TS 23.327 [4].
Figure 5.5-1: Removal of one access from the PDN connection
1\. The UE is simultaneously connected to a 3GPP access and a WLAN access
based on the procedures specified in clauses 5.2 and 5.3. Based on current
routing rules some IP flows are routed through the 3GPP access and some other
IP flows through the WLAN access.
2\. The HA sends a BRI message including a BID mobility option to remove only
one of the binding registered for the UE as defined in IETF RFC 5846 [13].
NOTE: If HA disconnects the UE from the WLAN access and the 3GPP access is the
home link, alternatively the HA can terminate the DSMIPv6 session omitting the
BID mobility option.
3\. The UE replies with a BRA message and removes the BID indicated by the HA
as defined in IETF RFC 5846 [13].
4\. In case the HA function is located in the PDN GW, the PDN GW initiates the
IP-CAN session modification procedure with the PCRF. In this procedure, the
PDN GW removes the routing address related to the removed BID associated with
the IP-CAN session.
5\. If the HA function is located in the PDN GW, as part of the IP-CAN session
modification procedure initiated in step 3, the PCRF ensures that the relevant
QoS rules for the SDFs are installed in the target BBERF. This is done by a GW
control session and QoS rules provision procedure as specified in TS 23.203
[5].
6\. If in step 2 the HA has removed the BID associated with the 3GPP access
and maintained the BID for the WLAN access, the PDN GW shall initiate the PDN
GW Initiated PDN Disconnection procedure in 3GPP access as defined in TS
23.402 [3], clause 5.6.2.2 or the PDN GW Initiated Bearer Deactivation
procedure as defined in TS 23.401 [10], clause 5.4.4.1. The PDN GW shall set
the release cause to \'RAT changed from 3GPP to Non-3GPP\' to avoid the MME
remove the PDN GW ID from the HSS. In case of I-WLAN mobility architecture and
the UE has removed the BID associated with the 3GPP access, the UE may
initiate PDP Context Deactivation as described in TS 23.060 [11].
If the BID associated with the WLAN access is removed, according to TS 23.402
[3] the security associations between the UE and the HA should not be
immediately deleted. As the security associations were created dynamically
using IKEv2 they will be automatically deleted when they expire.
For I-WLAN mobility architecture, the H2 session between the HA and the AAA
Server should not be immediately deleted. The H2 session will be deleted by
the HA immediately after security associations are deleted. In case of I-WLAN
mobility architecture, the UE may initiate release of the IKEv2 security
association with the PDG according to TS 23.234 [9].
## 5.6 Addition of one access for multiple PDN connections to the same APN
When a UE having multiple PDN connections to the same APN via one access
attaches to a second access, the UE needs to decide which of the multiple PDN
connections the UE has would use both accesses simultaneously.
When the UE having multiple PDN connections to the same APN via a 3GPP access
attaches to a WLAN, the UE shall perform DSMIPv6 procedures only for the PDN
connections for which it will use IP flow mobility.
When the UE having multiple PDN connections to the same APN via the WLAN
attaches to the 3GPP access, the UE should only establish the PDN connections
for which it will use IP flow mobility. However, due to the restriction that
the UE cannot indicate which PDN connection is to establish, the UE shall
repeat UE PDN Connectivity Request until the desired PDN connections have been
established and shall perform DSMIPv6 procedures for the desired PDN
connections.
## 5.7 Detach and PDN disconnection procedures
When the UE is attached to the same PDN through two accesses and a detach or
PDN disconnection procedure is required, the following considerations apply:
\- In case of UE initiated PDN disconnection the UE-initiated PDN
disconnection procedure described in clause 6.5.2 of TS 23.402 [3] shall be
performed (in case of untrusted access the procedure described in clause 7.5.2
of TS 23.402 [3] shall be performed). When this procedure is completed, UE-
initiated Detach procedure described in clause 5.3.8.2 of TS 23.401 [10] shall
be performed.
\- In case of HSS initiated detach, the HSS-initiated Detach procedure
described in 6.5.3 of TS 23.402 [3] shall be performed (in case of untrusted
access the procedure described in clause 7.5.3 of TS 23.402 [3] shall be
performed). When this procedure is completed, the HSS-initiated Detach
procedure described in clause 5.3.8.4 of TS 23.401 [10] shall be performed.
\- In case of PDN-GW initiated PDN disconnection procedure, the procedure in
clause 6.5.4 of TS 23.402 [3] shall be performed (in case of untrusted access
the procedure described in clause 7.5.4 of TS 23.402 [3] shall be performed).
When this procedure is completed, the PDN GW Initiated Bearer Deactivation
procedure as defined in TS 23.401 [10], clause 5.4.4.1, shall be performed.
When the UE is attached to I-WLAN architecture through 3GPP and WLAN accesses
and a detach or PDN disconnection procedure is required, similar
considerations as above apply with reference to the procedures described in TS
23.327 [4] and TS 23.060 [11].
#
# Foreword
This Technical Report has been produced by the 3rd Generation Partnership
Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
In the present document, modal verbs have the following meanings:
**shall** indicates a mandatory requirement to do something
**shall not** indicates an interdiction (prohibition) to do something
The constructions \"shall\" and \"shall not\" are confined to the context of
normative provisions, and do not appear in Technical Reports.
The constructions \"must\" and \"must not\" are not used as substitutes for
\"shall\" and \"shall not\". Their use is avoided insofar as possible, and
they are not used in a normative context except in a direct citation from an
external, referenced, non-3GPP document, or so as to maintain continuity of
style when extending or modifying the provisions of such a referenced
document.
**should** indicates a recommendation to do something
**should not** indicates a recommendation not to do something
**may** indicates permission to do something
**need not** indicates permission not to do something
The construction \"may not\" is ambiguous and is not used in normative
elements. The unambiguous constructions \"might not\" or \"shall not\" are
used instead, depending upon the meaning intended.
**can** indicates that something is possible
**cannot** indicates that something is impossible
The constructions \"can\" and \"cannot\" are not substitutes for \"may\" and
\"need not\".
**will** indicates that something is certain or expected to happen as a result
of action taken by an agency the behaviour of which is outside the scope of
the present document
**will not** indicates that something is certain or expected not to happen as
a result of action taken by an agency the behaviour of which is outside the
scope of the present document
**might** indicates a likelihood that something will happen as a result of
action taken by some agency the behaviour of which is outside the scope of the
present document
**might not** indicates a likelihood that something will not happen as a
result of action taken by some agency the behaviour of which is outside the
scope of the present document
In addition:
**is** (or any other verb in the indicative mood) indicates a statement of
fact
**is not** (or any other negative verb in the indicative mood) indicates a
statement of fact
The constructions \"is\" and \"is not\" do not indicate requirements.
# 1 Scope
The present document studies the security and privacy aspects of proximity
based services in 5G system phase 2. It ensures that the security solutions
are aligned with the work in SA2 (i.e. TR 23.700-33 [2]), RANs, SA1 (i.e. TS
22.278 [3], TS 22.261 [4], and TS 22.115 [5]) and SA3 (i.e. TS 33.503 [6] and
TR 33.870 [7]). The present document covers the following issues:
\- Security and privacy key issues, threats and potential requirements of
proximity based services in 5G system phase 2.
\- Potential security solutions to cover these potential requirements.
Both roaming and non-roaming scenarios are considered.
# 2 References {#references-1}
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or non‑specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
[1] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[2] 3GPP TR 23.700-33: \"Study on System enhancement for Proximity based
Services (ProSe) in the 5G System (5GS); Phase 2\".
[3] 3GPP TS 22.278: \"Service requirements for the Evolved Packet System
(EPS)\".
[4] 3GPP TS 22.261: \"Service requirements for the 5G system; Stage 1\".
[5] 3GPP TS 22.115: \" Service aspects; Charging and billing\".
[6] 3GPP TS 33.503: \"Security Aspects of Proximity based Services (ProSe) in
the 5G System (5GS)\".
[7] 3GPP TR 33.870: \"Study of privacy of identifiers over radio access\".
[8] 3GPP TS 23.304: \"Proximity based Services (ProSe) in the 5G System
(5GS)\".
[9] 3GPP TS 33.536: \"Security aspects of 3GPP support for advanced Vehicle-
to-Everything (V2X) services\".
[10] IRTF \"CPace, a balanced composable PAKE\" available online at
[https://datatracker.ietf.org/doc/draft-irtf-cfrg-cpace/]{.underline}
[11] IRTF \"The OPAQUE Asymmetric PAKE Protocol\" available online at
[https://datatracker.ietf.org/doc/draft-irtf-cfrg-opaque/]{.underline}
[12] IRTF \"SPAKE2, a PAKE\" available online at
[https://datatracker.ietf.org/doc/draft-irtf-cfrg-spake2/]{.underline}
[13] IRTF \"SPAKE2+, an Augmented PAKE\" available online at
[https://datatracker.ietf.org/doc/draft-bar-cfrg-spake2plus/]{.underline}
[14] 3GPP TS 33.220: \"Generic Authentication Architecture (GAA); Generic
Bootstrapping Architecture (GBA)\".
[15] 3GPP TS 33.535: \"Authentication and Key Management for Applications
(AKMA) based on 3GPP credentials in the 5G System (5GS)\".
[16] 3GPP TS 22.101: \"Service aspects; Service principles\".
[17] Hao, Feng, and Paul C. van Oorschot. \"SoK: Password-Authenticated Key
Exchange--Theory, Practice, Standardization and Real-World Lessons.\"
Proceedings of the 2022 ACM on Asia Conference on Computer and Communications
Security. 2022.
[18] Joern-Marc Schmidt, RFC 8125: \"Requirements for Password-Authenticated
Key Agreement (PAKE) Schemes\", April 2017, available online at
https://datatracker.ietf.org/doc/rfc8125/
# 3 Definitions of terms, symbols and abbreviations
## 3.1 Terms
For the purposes of the present document, the terms given in 3GPP TR 21.905
[1] and the following apply. A term defined in the present document takes
precedence over the definition of the same term, if any, in 3GPP TR 21.905
[1].
**5G ProSe U2U UE:** A 5G ProSe-enabled UE that discovers or is discovered by
a 5G ProSe-enabled UE(s) via a 5G ProSe UE-to-UE Relay; or a 5G ProSe-enabled
UE that communicates with other 5G ProSe-enabled UE(s) via a 5G ProSe UE-to-UE
Relay.
**5G ProSe UE-to-UE Relay:** A 5G ProSe-enabled UE that provides functionality
to support connectivity between 5G ProSe U2U UEs.
## 3.2 Abbreviations
For the purposes of the present document, the abbreviations given in 3GPP TR
21.905 [1] and the following apply. An abbreviation defined in the present
document takes precedence over the definition of the same abbreviation, if
any, in 3GPP TR 21.905 [1].
5G DDNMF 5G Direct Discovery Name Management Function
CP Control Plane
DCA Direct Communication Accept
DCR Direct Communication Request
E2E End-to-End
PAKE Password-based key establishment
PKMF ProSe Key Management Function
PRUK Prose Remote User Key
RSC Relay Service Code
U2U UE-to-UE
UP User Plane
# 4 Security Aspects of 5G ProSe
## 4.1 General
Security solutions should build on the 5G ProSe architecture principles as
defined in TS 23.304 [8] and 5G ProSe security architecture principles as
defined in TS 33.503 [6], including flexibility and modularity for newly
introduced functionalities.
## 4.2 Architecture assumption
\- Security architecture defined in TS 33.503 [6] is used as basis security
architecture for supporting 5G ProSe Security phase 2.
\- The security architecture needs to enable secure UE-to-UE relay discovery
and communication when the Source UE, Target UE as well as the UE-to-UE relay
can be out of coverage.
\- The 5G ProSe UE-to-UE Relay is specified in TS 23.304 [8].
\- It is assumed that the 5G ProSe UE-to-UE Relay is a trusted entity.
# 5 Key issues
## 5.1 Key Issue #1: Security for UE-to-UE Relay discovery
### 5.1.1 Key issue details
In case of UE-to-UE Relay communication, a source UE discovers a target UE via
a UE-to-UE Relay in proximity. The discovery messages to discover either a UE-
to-UE Relay or a target UE via UE-to-UE Relays in proximity need to be
security protected. Failure to protect the security of these discovery
messages for UE-to-UE Relay communication may lead to various attacks by
unauthorized UEs, e.g. discovery message manipulation, or potential leakage of
privacy sensitive information. Therefore, the security aspects of the
discovery messages broadcasted in UE-to-UE Relay discovery should be studied.
### 5.1.2 Security threats
If the discovery messages are not integrity protected and replay protected,
the parameters included in the discovery messages (e.g. Relay Service Code and
ProSe Restricted Code) can be modified, or replayed by an attacker.
Consequently, a source UE may fail to find a relay UE or a target UE for an
intended service.
If the discovery messages are not confidentiality protected, the privacy
sensitive parameters (e.g. Relay Service Code and ProSe Restricted Code) can
be eavesdropped by an attacker.
### 5.1.3 Potential security requirements
The 5G System shall provide a means for confidentiality protection, integrity
protection and replay protection of discovery messages for UE-to-UE Relay
discovery.
The 5G System shall provide a means to protect the privacy sensitive
information of source UE and target UE during UE-to-UE Relay discovery
procedure.
The 5G System shall provide a means to securely provision the security
materials for UE-to-UE Relay discovery.
## 5.2 Key Issue #2: Security of UE-to-UE Relay
### 5.2.1 Key issue details
3GPP system has to be able to protect security (i.e. the integrity and
confidentiality) of information between the peer UEs over the UE-to-UE Relay.
Failure to protect integrity and confidentiality of information exchanged
between the peer UEs over the UE-to-UE Relay will open vulnerability in 5GS
and allow various attacks such as unauthorized disclosure and modification of
information. Protection of communications between the peer UEs should take
into consideration that the UE-to-UE Relay is a trusted node.
TR 23.700-33 [2], key Issue #1: Support of UE-to-UE Relay, has the following
key issue:
_\- How to enhance the system architecture to provide security/privacy
protection for a relayed connection._
_NOTE 3: For security/privacy protection aspects, coordination with SA WG3 is
needed.\"_
### 5.2.2 Security threats
Failure to protect integrity and confidentiality of information exchanged
between the peer UEs over the UE-to-UE Relay will open vulnerability in 5GS
and allow various attacks such as unauthorized disclosure and modification of
information.
A malicious Relay UE that can establish a unicast link with the source UE, as
well as the target UE may conduct an MITM attack.
Failure to protect integrity and confidentiality of information during path
change will open vulnerability in 5GS and allow various attacks resulting in
unauthorized disclosure and modification of information.
### 5.2.3 Potential security requirements
The 3GPP system shall support a means to provide confidentiality, integrity
and replay protection of end-to-end information exchanged between the peer UEs
over the UE-to-UE Relay.
The 3GPP system shall support a means to protect security (i.e. the integrity,
confidentiality, and replay protection) of user-plane and control-plane
messages, including during UE-to-UE Relay path switch.
The 3GPP system shall support a means to establish a secure connection between
the source UE and the target UE in the UE-to-UE relay scenario.
## 5.3 Key issue #3: Authorization in the UE-to-UE Relay Scenario
### 5.3.1 Key issue details
TR 23.700-33 [2], key issue #1 describes its key Issue regarding support of
UE-to-UE Relay:
_\"- Whether and how the network can control UE-to-UE Relay operation, at
least including how to:_
_\- Authorize the UE-to-UE Relay, e.g. authorize a UE as UE-to-UE Relay._
_\- Authorize Source/Target UEs to use a UE-to-UE Relay._
_..._
_NOTE 3: For security/privacy protection aspects, coordination with SA WG3 is
needed.\"_
From a security point of view, whether the UE can act as a UE-to-UE Relay
should be assured by the Source UE or Target UE. Similarly, whether the UE can
act as a Source UE or Target UE should be assured by the UE-to-UE relay.
3GPP system should be able to authorize a UE to perform as UE-to-UE Relay and
a UE to communicate with another UE via a UE-to-UE Relay.
### 5.3.2 Security threats
An attacker may impersonate the UE-to-UE Relay. If the Source/Target UE cannot
verify if the UE acting as UE-to-UE relay is authorized, the attacker UE may
impersonate the UE-to-UE relay. The attacker may then deny the UE services
between the two UEs (e.g. arbitrary discard messages).
Similarly, an attacker may impersonate the Source UE or the Target UE.
### 5.3.3 Potential security requirements
The 5GS shall support authorization of the UE as a UE-to-UE relay in the UE-
to-UE relay scenario.
The 5GS shall support authorization of the UE as a Source UE or a Target UE in
the UE-to-UE relay scenario.
## 5.4 Key Issue #4: Privacy of information over the UE-to-UE Relay
### 5.4.1 Key issue details
3GPP system has to be able to protect the privacy of identities exchanged in
the communications between peer UEs over a UE-to-UE Relay. Failure to protect
the privacy of identities of peer UEs communicating over the UE-to-UE Relay
will open vulnerability in 5GS and allow various privacy attacks including
tracing and tracking of identities.
TR 23.700-33 [2] Key Issue #1: Support of UE-to-UE Relay, has the following
key issue:
> _\'- How to enhance the system architecture to provide security/privacy
> protection for relayed connections._
>
> _..._
>
> _NOTE 3: For security/privacy protection aspects, coordination with SA WG3
> is needed.\'_
### 5.4.2 Security threats
Failure to protect the privacy of identities exchanged in the communications
between the peer UEs over the UE-to-UE Relay will open vulnerability in 5GS
and allow various privacy attacks including tracing and tracking of
identities.
The existing Link identifier update procedure specified in TS 33.536 [9]
provides privacy of the identities on a per unicast link basis (e.g. the link
between a UE and the UE-to-UE Relay). Therefore an attacker may be able to
link identities exchanged over the link between a UE and the UE-to-UE Relay to
those exchanged over the corresponding link between the peer UE and the UE-to-
UE Relay
Path switch between UE-to-UE Relay UEs is a new feature aiming to preserve
user experience. Such preservation may be achieved by making certain elements
(e.g. IP addresses) of user experience persistent across sessions and UE-to-UE
Relays. Persistent parameters may leak unique attributes associated with UEs
and other ProSe entities and allow privacy attacks on these entities (e.g.
UEs). Failure to protect the privacy of entities and identities during UE to
UE Relay path change will open vulnerability in 5GS and allow various privacy
attacks including tracing and tracking of entities and identities.
### 5.4.3 Potential security requirements
The 5G System should provide means for mitigating trackability attacks on peer
UEs during communications over a UE-to-UE Relay including during the UE-to-UE
Relay path switch.
The 5G System should provide means for mitigating linkability attacks on peer
UEs during communications over a UE-to-UE Relay including during the UE-to-UE
Relay path switch.
## 5.5 Key Issue #5: Security of source and target UE communication via U2U
relay
### 5.5.1 Key issue details
3GPP system has to be able to protect security (i.e. the integrity and
confidentiality) of information transmitted between the source and target UEs
over the UE-to-UE Relay. With the U2U relay being trusted, the protection of
security between source and target UEs connected via the U2U relay can be
realized either hop-by-hop or end-to-end or both. However, from an efficiency
point of view, it does not make sense to do both hop-by-hop and end-to-end at
the same time, especially since the U2U relay scenario most likely focuses on
the case where the UEs are out of network coverage and therefore out of power
source.
This key issue addresses the need for the U2U relay and the source and target
UEs to negotiate and agree on a protection scheme, whether it is hop-by-hop or
end-to-end. It is independent of the need to apply integrity-,
confidentiality-, and replay-protection once the protection scheme is
negotiated. Key issue is for L3 relay.
### 5.5.2 Security threats
If source and target UEs communicating with each other via U2U relay are not
using the same protection scheme (i.e. hop-by-hop or end-to-end), the source
and target UEs will not be able to communicate with each other or the traffic
between the source and target UEs may not be protected at all.
### 5.5.3 Potential security requirements
The 3GPP system shall support a means for the source UE, target UE and U2U
relay to use the same security protection method in protecting source UE to
target UE traffic via the U2U relay.
## 5.6 Key Issue #6: Support for Emergency service over UE-to-Network Relaying
### 5.6.1 Key issue details
In TR 23.700-33 [1], key issue #7 is about support of Emergency for UE-to-
Network Relaying. According to TS 22.101 [16], emergency service is defined as
citizen to authority services, and it is left to the national authorities to
decide whether the network accepts emergency calls e.g. for valid UE only, or
for UEs without the SIM/USIM/ISIM.
In the 5G ProSe UE-to-Network relaying, for both layer 2 UE-to-network relay
and layer 3 UE-to-network relay, if there is an emergency request from the
remote UE, it implies that the Relay UE needs to be responsible for remote
UE\'s emergency service.
A Remote UE which has no USIM inserted may need to initiate an emergency
service with a network over PC5 interface via a Layer 3 UE-to-network relay.
This Remote UE can only discover UE-to-network relays which indicates a RSC
for emergency in clear text. Also, this Remote UE is not able to establish a
secure PC5 link with a UE-to-network relay.
Based on the operator policy, _the Relay UE needs to support to establish PC5
communication for emergency service_ with or without PC5 security _._
### 5.6.2 Security threats
_Emergency service cannot be fulfilled if a Remote UE cannot be properly
identified and establish the PC5 security with the relay UE (if required)._
### 5.6.3 Potential security requirements
The 5G system shall support the establishment of PC5 communication for
emergency service over UE-to-network relay with or without PC5 security _._
## 5.X Key Issue #X: \
### 5.X.1 Key issue details
### 5.X.2 Security threats
### 5.X.3 Potential security requirements
# 6 Solutions
## 6.0 Mapping of Solutions to Key Issues
Table 6.0-1: Mapping of Solutions to Key Issues
              Key Issues
* * *
Solutions 1 2 3 4 5 6  
1 X X X  
2 X  
3 X X  
4 X X  
5 X X  
6 X  
7 X  
8 X  
9 X  
10 X X  
11 X  
12 X X  
13 X X X  
14 X X  
15 X X  
16 X X  
17 X X  
18 X  
19 X X X  
20 X  
21 X  
22 X  
23 X  
24 X  
25 X  
26 X X  
27 X  
28 X  
29 X X X  
30 X X  
31 X X  
32 X  
33 X  
34 X  
35 X  
36 X  
37 X X
## 6.1 Solution #1: Restricted Peer UE IP Discovery with Layer-3 UE-to-UE
Relay
### 6.1.1 Introduction
This solution is for the 5G ProSe Layer-3 UE-to-UE Relay case. It addresses
Key Issue #4: Privacy of information over the UE-to-UE Relay, Key Issue #3:
Authorization in the UE-to-UE Relay Scenario, and 2^nd^ requirement of Key
Issue #1: Security for UE-to-UE Relay discovery (protection of privacy
sensitive information of source and target UEs).
TR 23.700-33 [2] describes several solutions for Layer-3 based which are all
based on IP routing functionality at the UE-to-UE Relay. As part of the PC5
unicast link establishment procedure, the ProSe 5G UE-to-UE Relay allocates an
IP address/prefix to the UE or is informed of the UE\'s IP address/prefix. The
Relay stores the association of the UE\'s Application layer ID (also called
User Info) and UE\'s IP address/prefix (e.g. into its DNS entries). When a
source UE needs to communicate with a target UE via the ProSe 5G UE-to-UE
Relay, it sends a request (e.g. DNS query) to the ProSe 5G UE-to-UE Relay,
over the unicast link, to obtain the target UE\'s IP address/prefix (based on
Target User Info). The Relay returns the IP address/prefix of the target UE.
The source UE sends IP data to the target UE via the PC5 unicast link to UE-
to-UE Relay. The UE-to-UE Relay acts as an IP router and forwards the packets
to the corresponding PC5 unicast link towards the target UE.
When using the IP based routing, a UE connected to a UE-to-UE Relay may wish
to restrict the discovery of its IP address/prefix for privacy reasons, such
as only authorized peer UEs can discover the UE. This is similar to the
restricted discovery mechanism where only an authorized Discoverer UE may
discover a Discoveree UE. Besides IP address/prefix privacy aspect, the UE-to-
UE Relay also needs to ensure that only authorized peer UEs can communicate
with the UE.
To enable the support of Restricted IP address/prefix discovery, a UE
indicates to the UE-to-UE Relay during the PC5 link establishment procedure if
its IP address/prefix may be discovered/shared with peer UEs without seeking
the UE authorization or if a prior authorization from the UE is required. In
addition, to minimize the PC5 signaling needed to support Restricted IP
address/prefix discovery, the UE may provide a token to the UE-to-UE Relay to
delegate IP address/prefix sharing authorization to the UE-to-UE Relay using
this token.
### 6.1.2 Solution details
This procedure enables a UE (UE1) to indicate to the UE-to-UE Relay if its IP
address/prefix may be shared with a peer UE (UE2) without seeking its
authorization or if its authorization is required. It also enables UE1 to
provide information to the UE-to-UE Relay to verify directly if UE2 is
authorized to receive IP address/prefix information of UE1.
Figure 6.1.2-1: \"Restricted\" IP discovery procedure for 5G ProSe Layer-3 UE-
to-UE Relay
1\. UE1 provides an indication (_IP discovery_ _authorization required_) and
may provide an authorization token during the PC5 Link Establishment procedure
with the UE-to-UE Relay. UE-to-UE Relay stores this indication and token (if
received) along with other UE1 and PC5 link information. UE1 may be pre-
provisioned with the IP discovery authorization token. The token may be
generated by UE1 to allow UE2 to discover its IP address. The validity of the
token can be associated with the current PC5 unicast link, particular target
UE(s), for a particular period, etc. The token is sent protected over the
secure PC5 link using the security keys established with the relay.
2\. UE-to-UE Relay receives a DNS query from UE2 including UE1\'s User Info
and possibly a token. UE-to-UE Relay retrieves UE1\'s info and if the _IP
discovery_ _authorization required_ indication is set, UE-to-UE Relay
validates the token received from UE2 with UE1\'s saved token, if a token is
received on Query and if a token from UE1 is saved on the UE-to-UE Relay.
The distribution of such token to the UE2 may be performed out of band or in
band, e.g. by UE-to-UE Relay after/during a successful DNS query (as specified
at step 5).
3\. If no token is received from UE2 and/or no token has been provided by UE1
during the link establishment procedure, UE-to-UE Relay sends a PC5-S IP
Discovery Authorization Request message with UE2\'s User Info, UE2\'s IP
address, and the token from UE2 (if received on the Query) to UE1, requesting
authorization to share UE1\'s IP address with UE2.
4\. UE1 receives the PC5-S IP Discovery Authorization Request message and
replies with a PC5-S IP Discovery Authorization Accept or Reject message,
specifying UE2\'s User Info. UE1 may provide a token at this point for future
DNS query messages to be authorized directly at the UE-to-UE Relay using this
token. UE1\'s decision to authorize IP disclosure via the UE-to-UE Relay or
provide an authorization token to the UE-to-UE Relay may be based on policies,
Application\'s layer authorization, etc.
5\. UE-to-UE Relay sends a DNS response to UE2 with UE1\'s IP address (if
token matches at the UE-to-UE Relay or if a PC5-S IP Discovery Authorization
Accept message is received from UE1) or does not reply to the Query message
(if no match with token or if a PC5-S IP Discovery Authorization Reject
message is received from UE1). UE-to-UE Relay stores the token, if provided by
UE1, and may send it to the UE2 with the response. UE2 may use this token the
next time it needs to send a DNS query message to discover UE1\'s IP address.
### 6.1.3 Evaluation
This solution proposes to use an authorization request with optional token
exchanged with a L3 UE-to-UE Relay prior to allowing the discovery of UE\'s IP
address/prefix information. This solution ensures that private UE\'s IP
address/prefix information is only exposed to authorized peer UEs.
The U2U Relay and UE need to support a PC5-S Authorization Request/Accept,
with optional authorization token, prior to providing UE\'s IP address/prefix
information to a requesting UE. The DNS server logic at the U2U Relay needs to
check for IP sharing authorization before returning IP address/prefix
information.
This solution addresses:
\- Key Issue #3 (2^nd^ requirement): Authorization in the UE-to-UE Relay
Scenario
\- Key issue #4 (all requirements): Privacy of information over the UE-to-UE
Relay
NOTE: Further evaluation is not addressed in the present document.
## 6.2 Solution #2: Privacy handling for Layer-3 UE-to-UE Relay based on IP
routing
### 6.2.1 Introduction
This solution addresses Key Issue #4: Privacy of information over the UE-to-UE
Relay and in the case of the 5G ProSe Layer-3 UE-to-UE Relay.
A Source UE (UE1) communicating with a Target UE (UE2) over PC5 unicast links,
via a UE-to-UE Relay, may need to change its Layer-ID, MSB of Knrp-sess ID and
potentially IP address/prefix and other identifiers, e.g. for privacy reasons.
When a Source UE changes its identifiers, the UE-to-UE Relay also needs to
update its identifiers at the same time (as per the Link Identifier Update
(LIU) procedure defined in TS 23.304 [8] and TS 33.536 [9]) since the PC5 link
is established between UE1 and the UE-to-UE Relay. In the case where UE1
changes its IP address/prefix, its Target UE needs to be informed of UE1\'s
new IP address/prefix since communication between UE1 and UE2 is IP-based.
Note that the UE IP address is protected over PC5, however existing LIU
procedure mandates the change of IP address for IP communications, as per TS
24.554, clause 7.3.2.4. Furthermore, the UE-to-UE Relay needs to be informed
as well of UE1\'s new IP address/prefix since the UE-to-UE Relay handles the
IP routing of messages exchanged between the UE1 and UE2. In other words, when
used in the UE-to-UE Relay scenario, current LIU procedure would lead to
breaking the communication between Source UE and Target UE without proper IP
change handling. Therefore, LIU procedure needs enhancements for the UE-to-UE
Relay scenario to correctly handle the Source UE IP address change (or Target
UE IP address change if LIU procedure is run between Target UE and the UE-to-
UE Relay) to avoid this issue.
Likewise, UE1 may be communicating with more than one Target UE over the PC5
unicast link via the UE-to-UE Relay. In that case, all Target UEs need to be
informed of UE1\'s new IP address/prefix.
### 6.2.2 Solution details
Figure 6.2.2-1 illustrates the procedure between the Source UE (UE1), the UE-
to-UE Relay, and the Target UE (UE2) handling the change of identifiers at the
Source UE. The Link Identifier Update procedure defined in TS 23.304 [8] is
reused between UE1 and the UE-to-UE Relay complemented with additional
messages between the UE-to-UE Relay and UE2 (i.e. Target UE(s)).
The new procedure between the Relay and the Target UE(s) is needed to inform
the Target UE(s) about UE1\'s new IP address/prefix. The Target UE(s) do not
need to change their IDs at this point since they are using a distinct PC5
link with the UE-to-UE Relay. The UE-to-UE Relay however needs to inform UE2
of UE1\'s new IP address/prefix during the Link Identifier Update procedure
between UE1 and UE-to-UE Relay to avoid disruption and loss of communication
between UE1 and UE2.
This solution applies to Layer-3 based Solutions #2, #3, #11, #12 and #34
described in TR 23.700-33[2]. These solutions are all based on IP routing
functionality at the UE-to-UE Relay with a difference related to the proposed
method for IP address/prefix allocation. With some solutions, the UE-to-UE
Relay allocates the IP address/prefix to the UE, while for other solutions, a
link-local IP address that is assigned by the UE itself is used and sent to
the UE-to-UE Relay. Differences in the procedure detailed below are explained
when needed.
Figure 6.2.2-1: Privacy handling procedure for 5G ProSe Layer-3 UE-to-UE Relay
0) A PC5 unicast link is established between UE1 and the UE-to-UE Relay. A
distinct PC5 unicast link is established between the UE-to-UE Relay and UE2.
Both Source/Target UEs learn their peer UE\'s IP addresses/prefixes via the
Relay UE using e.g. DNS. IP data is exchanged between UE1 and UE2 via the UE-
to-UE Relay over the PC5 unicast links. The UE-to-UE Relay handles the routing
of IP packets to another PC5 unicast link based on the destination IP
address/prefix.
1) UE1 is informed (e.g. via the application layer, privacy timer expiration)
that its Layer-2 ID, Knrp-sess ID, and IP address/prefix, needs to be changed.
UE1 sends a Link Identifier Update Request message to the UE-to-UE Relay,
which includes the usual parameters sent on the Link Identifier Update Request
message, e.g. new Layer-2 ID and new MSB of Knrp-sess ID. In addition,
information related to the change of IP address/prefix may also be included
e.g. \"new IP address needed\" and \"inform peer UE\" indications as well as
UE2\'s specific information needed at step 2, i.e. UE2\'s IP address/prefix,
UE2\'s user info.
a) The \"new IP address needed\" indication is included to request a new IP
address/prefix for UE1 from the UE-to-UE Relay.
b) If UE1 uses a link-local IP address, a new link-local IP address is self-
allocated on UE1, sent to the UE-to-UE Relay using the Link Identifier Update
Request message and, in this case, the \"new IP address needed\" indication is
not included.
2) If the \"new IP address needed\" indication is included, UE-to-UE Relay
assigns a new IP address/prefix to UE1, otherwise, the UE-to-UE Relay saves
the new IP address/prefix provided by UE1. If the \"inform peer UE\"
indication is included, the UE-to-UE Relay uses UE2\'s specific information
received at steps 1 to retrieve the PC5 link established with UE2 and sends a
new PC5 Relay Update Request message to UE2 over the PC5 link including UE1\'s
new IP address/prefix.
3) UE2 saves UE1\'s new IP address/prefix. UE2 sends a new PC5 Relay Update
Response message to the UE-to-UE Relay including all parameters received on
the PC5 Relay Update Request message to ACK them.
4) UE-to-UE Relay sends a Link Identifier Update Response message to UE1
including the usual parameters sent on the Link Identifier Update Response
message, e.g. new Layer-2 ID and new LSB of Knrp-sess ID and including UE1\'s
new IP address/prefix.
5) UE1 completes the Link Identifier Update procedure by sending a Link
Identifier Update ACK message to the UE-to-UE Relay. UE1 starts using its new
IP address/prefix. The new Layer-2 IDs and Knrp-sess ID associated with the
PC5 unicast link are also used at that point.
### 6.2.3 Evaluation
This solution proposes to enhance the existing per-hop Link Identifier Update
(LIU) procedure to support the L3 UE-to-UE Relay scenario. A UE is informed by
the L3 UE-to-UE Relay about the IP address/prefix change of its peer UE when a
per-hop LIU procedure is performed between the peer UE and the L3 UE-to-UE
Relay. This mechanism allows to avoid disruption to IP communications between
the peer UEs that would result otherwise from a conventional per-hop LIU run.
This solution fully addresses Key issue #4: Privacy of information over the
UE-to-UE Relay.
## 6.3 Solution #3: PC5 security establishment when L3 UE-to-UE relay is in
coverage
### 6.3.1 Introduction
This solution addresses Key issue #2: Security of UE-to-UE Relay and Key issue
#3: Authorization in the UE-to-UE Relay Scenario. This solution addresses a L3
UE-to-UE relay.
For L3 UE-to-UE relay use cases, the L3 UE-to-UE relay may be in or out of
3GPP coverage. This solution provides a mechanism for PC5 security setup
procedure between a source UE or target UE and a L3 UE-to-UE relay when the L3
UE-to-UE relay is in 3GPP coverage.
This solution assumes 5GC NFs e.g. 5GDDNMF and PKMF are deployed in the
network.
### 6.3.2 Solution details
#### 6.3.2.1 Procedure for PC5 security establishment between the 5G ProSe
Source UE and 5G ProSe UE-to-UE Relay
Figure 6.3.2.1-1 illustrates the high-level procedure of the proposed
solution.
Figure 6.3.2.1-1: High-level procedure of PC5 security between Source/Target
UE and UE-to-UE relay
0\. The 5G ProSe Source/Target UE and UE-to-UE relay are provisioned with the
discovery security materials, PC5 security policies and/or PRUK when they are
in coverage.
NOTE 1: 5GC NF(s) that provision PC5 security policies are to be determined
during normative work.
1\. The discovery procedure for UE-to-UE Relay is performed by the 5G ProSe
Source UE using the discovery parameters and discovery security material,
based on the Relay Service Code for UE-to-UE Relay. If the UE-to-UE Relay is
in 3GPP coverage, it also indicates whether network-based Relay service
authentication and authorization is supported for UE-to-UE relay in the
discovery announcement message.
Note 1a: How to verify the service authorization information if relay UE uses
the same security materials for both in-coverage and out-of-coverage mode is
not addressed in the present document.
NOTE 2: In case the Relay UE is capable to support more security methods (e.g.
as described in Solution #4) when the Relay UE is in 3GPP coverage, it is
preferrable to use the security method described in this solution.
2\. If the discovered UE-to-UE Relay supports network-based Relay service
authentication and authorization, the 5G ProSe Source UE sends a Direct
Communication Request (DCR) that contains PRUK ID or SUCI, Relay Service Code
(RSC) of the 5G ProSe UE-to-UE Relay service and K~NRP~ freshness parameter 1
to the 5G ProSe UE-to-UE Relay. Protection of PRUK ID and RSC in DCR can be
done same as described in TS 33.503 [6].
3\. The 5G ProSe UE-to-UE Relay sends a Key Request message that contains PRUK
ID or SUCI, RSC and K~NRP~ freshness parameter 1 to the 5GC.
NOTE 3: 5GC NFs and internal signalling are not described in detail. Here for
brevity. The similar security procedure as Security for 5G ProSe Communication
via 5G ProSe Layer-3 UE to-Network Relay as defined in TS 33.503 [6] can be
reused.
4\. The 5GC sends the Key Response message to the 5G ProSe UE-to-UE Relay,
which includes K~NRP~, K~NRP~ freshness parameter 2. The message may also
contain GPI, EAP message exchange depending on the selected security methods
(UP or CP) as defined in TS 33.503 [6]
5a. The 5G ProSe UE-to-UE Relay derives the session key (K~NRP-SESS~) from
K~NRP~ and then derive the confidentiality key (NRPEK) (if applicable) and
integrity key (NRPIK) based on the PC5 security policies as specified in TS
33.536 [9]. The 5G ProSe UE-to-UE Relay sends a Direct Security Mode Command
message to the 5G ProSe Source UE and include K~NRP~ Freshness Parameter 2 in
the message.
5b. The 5G ProSe Source UE derives K~NRP~ from its PRUK, RSC, K~NRP~ Freshness
Parameter 1 and the received K~NRP~ Freshness Parameter 2 and then derive the
session key (K~NRP-SESS~) and the confidentiality key (NRPEK) (if applicable)
and integrity key (NRPIK) based on the PC5 security policies in the same
manner as the 5G ProSe UE-to-UE Relay and process the Direct Security Mode
Command. Successful verification of the Direct Security Mode Command assures
the 5G ProSe Source UE that the 5G ProSe UE-to-UE Relay is authorized to
provide the UE-to-UE relay service.
5c. The 5G ProSe Source UE responds with a Direct Security Mode Complete
message to the 5G ProSe UE‑to-UE Relay.
5d. On receiving the Direct Security Mode Complete message, the 5G ProSe UE-
to-UE Relay verifies the Direct Security Mode Complete message. Successful
verification of the Direct Security Mode Complete message assures the 5G ProSe
UE-to-UE Relay that the 5G ProSe Source UE is authorized to get the UE-to-UE
relay service.
6\. After successful verification, the 5G ProSe UE-to-UE Relay responds a
Direct Communication Accept message to the 5G ProSe Source UE to complete the
PC5 connection establishment procedure.
7\. PC5 security establishment between the 5G ProSe Target UE and 5G ProSe UE-
to-UE Relay is performed according to the procedure described in clause
6.3.2.2.
#### 6.3.2.2 Procedure for PC5 security establishment between the 5G ProSe
Target UE and 5G ProSe UE-to-UE Relay
Figure 6.3.2.2-1 PC5 security establishment between the 5G ProSe Target UE and
5G ProSe UE-to-UE Relay
1\. If the target UE is not discovered by the 5G ProSe UE-to-UE Relay yet, the
discovery procedure is performed.
2\. The 5G ProSe UE-to-UE Relay sends a Direct Communication Invite that
contains Relay Service Code to the 5G ProSe Target UE. It is assumed the PRUK
of Target UE is used as root for the PC5 security thus the Target UE needs to
send another DCR in step 3 with PRUK ID or SUCI of Target UE to establish PC5
security as described in TS 33.503 [6].
Note: The need for the new Direct Communication Invite message is not
addressed in the present document.
3-7. Steps 3-7 are same as steps 2-6 of clause 6.3.2.1, where the 5G ProSe
Target UE acts the role of the 5G ProSe Source UE.
### 6.3.3 Evaluation
This solution resolves Key issue #2: Security of UE-to-UE Relay and Key issue
#3: Authorization in the UE-to-UE Relay Scenario when L3 UE-to-UE relay is
within 3GPP coverage.
This solution is for commercial services and public safety and supports the
PC5 communication with a UE-to-UE Relay capable with network-based Relay
service authentication and authorization similar to the UE-to-network relay as
described in clauses 6.3.3.2.2 and 6.3.3.3.2 in TS 33.503 for the PC5 security
establishment when in 3GPP coverage.
This solution only works when the UE-to-UE relay is located within network\'s
coverage area. The 5G ProSe Source/Target and UE-to-UE relay need to store
security materials dedicated to the In-Coverage scenario. Apart from the PC5
signalling, additional user plane/signalling interactions with the network are
required in this mechanism.
In the case the UEs (Source/Target/Relay) support multiple security methods
(i.e. for In-Coverage and Out-of-Coverage), the 5G ProSe Source/Target and UE-
to-UE relay are required to have the logic to choose between the In-Coverage
dedicated mechanism and the Out-of-Coverage dedicated mechanism before
starting the direct communication establishment.
This solution supports per-hop links setup. The Source UE initiates the PC5
security link setup with UE-to-UE Relay (first hop) similar to the UE-to-
network relay as defined in TS 33.503. And the UE-to-UE Relay initiates the
PC5 security link setup with the target UE (second hop) after the Security
Establishment procedure is completed at the first hop. In order to trigger the
Target UE to initiate a DCR message, the UE-to-UE Relay could send a new
Direct Communication Invite message that contains Relay Service Code to the 5G
ProSe Target UE. The need for this new message can be decided during normative
work.
## 6.4 Solution #4: PC5 security establishment when L3 UE-to-UE relay is out
of coverage
### 6.4.1 Introduction
This solution addresses Key issue #2: Security of UE-to-UE Relay and Key issue
#3: Authorization in the UE-to-UE Relay Scenario. This solution addresses a L3
UE-to-UE relay.
For UE-to-UE relay use cases, the L3 UE-to-UE relay may be in or out of 3GPP
coverage. This solution provides a mechanism for PC5 security setup procedure
between a source UE or target UE and a L3 UE-to-UE relay when the L3 UE-to-UE
relay is out of 3GPP coverage.
This solution assumes long term credentials are provisioned into the UE(s) and
form the root of the security of the PC5 unicast link as specified in TS
33.536 [9].
This solution proposes to use authorization tokens as in OAuth 2.0 to indicate
that a source UE or a target UE or a L3 UE-to-UE relay is authorized to use a
specific UE-to-UE service or to serve a specific UE-to-UE service. When the
source UE or the target UE or the L3 UE-to-UE relay registers in the 3GPP
network and is authorized to use the UE-to-UE service, the network provides a
token stating what kind of UE-to-UE service it can use or serve. The token has
an expiration time and is signed with a private key. The network also provides
the public key to the UEs to be used for verifying the token from other
parties.
This solution assumes the peer UEs retrieve authorization token and public key
for token verifying from the Prose Application server. The method how the UEs
retrieve tokens and public keys is application specific and not described in
3GPP specification.
### 6.4.2 Solution details
Figure 6.4.2-1 illustrates the high-level procedure of the proposed solution.
Figure 6.4.2-1: High-level procedure of PC5 security between Source/Target UE
and UE-to-UE relay
0\. The 5G ProSe Source/Target UE and UE-to-UE relay are provisioned with the
discovery security materials and PC5 security policies, and request
authorization tokens when they are in coverage.
1\. The discovery procedure for UE-to-UE Relay is performed by the 5G ProSe
Source UE using the discovery parameters and discovery security material,
based on the Relay Service Code for UE-to-UE Relay.
2\. If discovery result indicates the UE-to-UE Relay supports Direct Relay
service authentication and authorization, the 5G ProSe Source UE sends a
Direct Communication Request (DCR) that contains Relay Service Code (RSC) of
the 5G ProSe UE-to-UE Relay service and Authorization token of 5G ProSe Source
UE which is retrieved from step 0, and also the Key_Est_Info used for direct
authentication and key establishment. Protection of Authorization token and
RSC in DCR can be done in a similar way as described in TS 33.503 [6].
NOTE 1: The details regarding the ciphering algorithm for the token are not
addressed in the present document.NOTE 2: The need for authorization token is
not addressed in the present document.3. Direct Auth and Key Establish
procedure as specified in TS 33.536 [9] is performed.
4\. The 5G ProSe UE-to-UE Relay uses the public key provided by the network to
verify the token of the 5G ProSe Source UE that the 5G ProSe Source UE is
authorized to get the UE-to-UE relay service.
5\. The 5G ProSe UE-to-UE Relay derives K~NRP~ and other security material as
specified in TS 33.536 [9]. The 5G ProSe UE-to-UE Relay sends a Direct
Security Mode Command message to the 5G ProSe Source UE including the
Authorization token of 5G ProSe UE-to-UE Relay which is retrieved from step 0.
The protection of the Authorization token is applied in the same way as step
2.
6\. The 5G ProSe Source UE uses the public key provided by the network to
verify the token of the 5G ProSe UE-to-UE Relay that the 5G ProSe UE-to-UE
Relay is authorized to provide the UE-to-UE relay service. The 5G ProSe Source
UE derives K~NRP~ and other security material similar as the 5G ProSe UE-to-UE
Relay in step5.
7\. The 5G ProSe Source UE sends the Direct Security Mode Complete message to
the 5G ProSe UE-to-UE.
8\. The 5G ProSe UE-to-UE Relay responds a Direct Communication Accept message
to the 5G ProSe Source UE to complete the PC5 connection establishment
procedure.
9\. Steps 1-8 are repeated for PC5 security establishment between the 5G ProSe
Target UE and 5G ProSe UE-to-UE Relay.
### 6.4.3 Evaluation
This solution resolves Key issue #2: Security of UE-to-UE Relay and Key issue
#3: Authorization in the UE-to-UE Relay Scenario when L3 UE-to-UE relay is out
of 3GPP coverage.
This solution is for commercial services and public safety and assumes that
the long term credentials are provisioned into the UE(s) and form the root of
the security of the PC5 unicast link as specified in TS 33.536 [9].
This solution proposes that Authorization tokens are used by the UE\'s during
PC5 connection establishment in order for the UE\'s being able to authorize
each other as the involved Source/Target UE and UE-to-UE Relay are out of 3GPP
coverage and the network cannot perform the authorization of the Source/Target
UE and UE-to-UE Relay. The Authorization tokens are provisioned by the AF to
the Source UE, Target UE and UE-to-UE Relay when the UE\'s are in 3GPP
coverage.
This solution supports per-hop links setup. The UEs are then using the
security procedures as defined in V2X in TS 33.536 [9] to establish a secure
PC5 link and exchange and use the tokens for authorization.
NOTE 1: It is not addressed in the present document about how the token is
bound to the authentication based on the configured long term credential.The
Authorization token included in the DCR message can be protected in a similar
way as described in TS 33.503 [6].
The Authorization token\'s are exchanged during PC5 security establishment
between the Target UE and the 5G ProSe UE-to-UE Relay in a similar way as for
the Source UE and UE-to-UE Relay.
Note 2: Further evaluation is needed.
## 6.5 Solution #5: PC5 link security establishment for Layer-3 U2U Relay
### 6.5.1 Introduction
This solution addresses Key Issue #2 and Key Issue #3. This solution provides
a means to establish the secure PC5 link between the source UE/target UE and
the UE-to-UE Relay. When UE-to-UE Relay is in coverage, the source UE/target
UE may establish the secure PC5 link with the UE-to-UE Relay by using the same
security procedure as 5G ProSe UE-to-Network Relay communication.
NOTE: How to select the PC5 link security procedure proposed by this solution
for the source UE/target UE and the UE-to-UE Relay is not addressed in the
present document.
### 6.5.2 Solution details
#### 6.5.2.0 General
Both user-plane (UP) based and control-plane (CP) based procedures of 5G ProSe
UE-to-Network Relay can be reused for 5G ProSe UE-to-UE Relay authorization
and PC5 link security establishment. 5G ProSe UE-to-UE Relay service and 5G
ProSe UE-to-Network Relay service can be distinguished by Relay Service Code.
#### 6.5.2.1 PC5 link security establishment procedure over User Plane
The PC5 link security establishment procedure over User Plane for 5G ProSe UE-
to-UE Relay is as follows:
{width="6.695138888888889in" height="6.488194444444445in"}
Figure 6.5.2.1-1: PC5 link security establishment procedure over User Plane
for 5G ProSe UE-to-UE Relay
NOTE 1: Figure 6.5.2.1-1 shows the security procedure of the non-roaming for
5G ProSe UE-to-UE Relay services. In this figure, the source UE and the target
UE and UE-to-UE Relay use a subscription of the same PLMN.
0\. The source UE and the target UE is provisioned with the discovery security
materials and Prose Remote User Key (PRUK) when it is in coverage. The UE-to-
UE Relay is provisioned with the discovery security materials when it is in
coverage. These security materials are associated with an expiration time,
after which they become invalid. If the UE does not have valid discovery
security materials, it needs to connect to the 5G PKMF and obtain fresh ones
to use the 5G ProSe UE-to-UE Relay services. The UE gets the 5G PKMF address
from the 5G DDNMF.
NOTE 2: The detail of discovery procedure is not addressed in the present
document.
1\. The source UE performs the discovery procedure and discover the target UE
via UE-to-UE Relay.
NOTE 2a: UE-to-UE Relay discovery and communication establish is not addressed
in the present document.2a. The source UE sends a Direct Communication Request
(DCR) that contains the PRUK ID or a SUCI if the source UE does not have a
valid PRUK, Relay Service Code (RSC) of the 5G ProSe UE-to-UE Relay service
and K~NRP~ freshness parameter 1 to the 5G ProSe UE-to-UE Relay.
NOTE 3: The PRUK ID and RSC in DCR message can be protected by the same
security mechanism as described in clause 6.3.5 of TS 33.503 [6].
2b. The source UE and the UE-to-UE Relay perform the same authorization and
key establishment procedure over User Plane as 5G ProSe UE-to-Network Relay.
According the PC5 key hierarchy over user plane as defined in clause 6.3.3.2.3
of TS 33.503 [6], the PRUK of source UE (Remote UE) will be shared by 5G ProSe
UE-to-Network Relay service and 5G ProSe UE-to-UE Relay service. And the PKMF
of source UE use the PRUK identified by PRUK ID, K~NRP~ freshness parameter 1,
K~NRP~ freshness parameter 2 and the RSC indicating the UE-to-UE Relay service
to derive the K~NRP~ different from the 5G ProSe UE-to-Network service.
2c. The UE-to-UE Relay derive the session key (K~NRP-SESS~) from K~NRP~ and
then derive the confidentiality key (NRPEK) (if applicable) and integrity key
(NRPIK) based on PC5 policies. The UE-to-UE Relay sends a Direct Security Mode
Command message to the source UE. This message also include the K~NRP~
freshness parameter 2 and be protected as specified in TS 33.536 [9].
2d. If the source UE receives the message containing the GPI, it processes the
GPI and derive the PRUK and obtain the PRUK ID from the GPI.
The source UE derives K~NRP~ from its PRUK, RSC, K~NRP~ Freshness Parameter 1
and the received K~NRP~ Freshness Parameter 2. It then derive the session key
(K~NRP-SESS~) and the confidentiality key (NRPEK) (if applicable) and
integrity key (NRPIK) based on the PC5 security policies in the same manner as
the UE-to-UE Relay and process the Direct Security Mode Command. Successful
verification of the Direct Security Mode Command assures the source UE that
the UE-to-UE Relay is authorized to provide the relay service.
The source UE responds with a Direct Security Mode Complete message to the UE-
to-UE Relay as specified in TS 33.536 [9].
3\. On receiving the Direct Security Mode Complete message, the UE-to-UE Relay
verifies the Direct Security Mode Complete message. Successful verification of
the Direct Security Mode Complete message assures the UE-to-UE Relay that the
source UE is authorized to get the relay service. After successful
verification, the UE-to-UE Relay sends a Direct Communication Request message
that contains Relay Service Code to the target UE to trigger the second hop
PC5 link establishment.
4a. The target UE responds a Direct Communication Response message to the 5G
ProSe UE-to-UE Relay to perform the second hop PC5 security procedure. The
Direct Communication Response message contains the PRUK ID or a SUCI if the
target UE does not have a valid PRUK, Relay Service Code (RSC) and K~NRP~
freshness parameter 1.
4b-4d. Step 4b-4d are same as step 2b-2d, where the target UE acts the role of
the source UE.
5\. On receiving the Direct Security Mode Complete message from the target UE,
the 5G ProSe UE-to-UE Relay verifies the Direct Security Mode Complete
message. Successful verification of the Direct Security Mode Complete message
assures the UE-to-UE Relay that the target UE is authorized to get the relay
service. After successful verification, the 5G ProSe UE-to-UE Relay sends a
Direct Communication Ack message to the target UE.
6\. The target UE sends the Direct Communication Accept message to the 5G
ProSe UE-to-UE Relay after received Direct Communication Ack message.
7\. The 5G ProSe UE-to-UE Relay sends the Direct Communication Accept message
to source UE after received Direct Communication Accept message from Target
UE.
NOTE 3a: The need for the new Direct Communication Response and Direct
Communication Ack message is not addressed in the present document.
8\. The source UE and the target UE establish a secure connection between
them.
NOTE 4: How to establish a secure connection between the source UE and the
target UE is not addressed in the present document.
#### 6.5.2.2 PC5 link security establishment procedure over Control Plane
The PC5 link security establishment procedure over Control Plane for 5G ProSe
UE-to-UE Relay, as follows:
{width="6.695138888888889in" height="6.459722222222222in"}
Figure 6.5.2.2-1: PC5 link security establishment procedure over Control Plane
for 5G ProSe UE-to-UE Relay
NOTE 1: Figure 6.5.2.2-1 shows the security procedure of the non-roaming for
5G ProSe UE-to-UE Relay services. In this figure, the source UE and the target
UE and UE-to-UE Relay use a subscription of the same PLMN.
0\. The source UE and the target UE and the UE-to-UE Relay are registered with
the network. The UE-to-UE Relay is authenticated and authorized by the network
to provide UE-to-UE Relay service. The source UE and the target UE are
authenticated and authorized by the network to receive UE-to-UE Relay service.
Discovery security material and PC5 security policies are provisioned to the
source UE and the target UE and the UE-to-UE Relay respectively during this
authorization and information provisioning procedure.
NOTE 2: The detail of discovery procedure is not addressed in the present
document.
1\. The source UE performs the discovery procedure and discover the target UE
via UE-to-UE Relay.
NOTE 2a: UE-to-UE discovery and communication establish is not addressed in
the present document.2a. The source UE sends a Direct Communication Request
(DCR) that contains its security capabilities and PC5 signalling security
policy, the PRUK ID or a SUCI if the source UE does not have a valid PRUK, RSC
of the 5G ProSe UE-to-UE Relay service and Nonce_1.
NOTE 3: The PRUK ID and RSC in DCR message can be protected by the same
security mechanism as described in clause 6.3.5 of TS 33.503 [6].
2b. The source UE and the UE-to-UE Relay perform the same authorization and
key establishment procedure over Control Plane as 5G ProSe UE-to-Network
Relay. According the PC5 key hierarchy over control plane as defined in clause
6.3.3.3.3 of TS 33.503 [6], the PRUK of source UE (Remote UE) will not be
shared by 5G ProSe UE-to-Network Relay service and 5G ProSe UE-to-UE Relay
service. The source UE performs an 5G ProSe Remote UE specific authentication
independent of 5G ProSe UE-to-Network Relay service and derive the PRUK from
K~AUSF-P~ by using the RSC of 5G ProSe UE-to-UE Relay service.
2c. When receiving a K~NR_ProSe~ from the AUSF of the source UE via the AMF of
UE-to-UE Relay, the UE-to-UE Relay derive the PC5 session key (K~relay-SESS~)
from K~NR_ProSe~ and then derive the confidentiality key (K~relay-enc~) (if
applicable) and integrity key (K~relay-int~) based on PC5 policies. The UE-to-
UE Relay sends a Direct Security mode command message to the source UE. This
message also include the received Nonce_2 and source UE\'s PC5 signalling
security policy and be integrity protected using K~relay-int~. EAP Success
message also be included if received from the AMF.
2d. The source UE generate the K~NR_ProSe~ key in the same way as its AUSF,
and derive the PC5 session key K~relay-sess~ and confidentiality and integrity
keys from K~NR_ProSe~ and process the Direct Security Mode Command. Successful
verification of the Direct Security Mode Command assures the source UE that
the UE-to-UE Relay is authorized to provide the relay service.
The source UE send the Direct Security Mode Complete message containing its
PC5 user plane security policies to the UE-to-UE relay, which is protected by
K~relay-int~ or/and K~relay-enc~ according to the negotiated PC5 signalling
policies between the source UE and the UE-to-UE Relay.
3\. After the successful verification of the Direct Security Mode complete
message, the 5G ProSe UE-to-UE Relay store the 5GPRUK ID in the security
context associated to the PC5 link with the source UE and sends a Direct
Communication Request message that contains Relay Service Code to the target
UE to trigger the second hop PC5 link establishment.
4a. The target UE responds a Direct Communication Response message to the 5G
ProSe UE-to-UE Relay to perform the second hop PC5 security procedure. The
Direct Communication Response message contains the security capabilities and
PC5 signalling security policy of the target UE, the PRUK ID or a SUCI if the
target UE does not have a valid PRUK, RSC of the 5G ProSe UE-to-UE Relay
service and Nonce_1.
4b-4d. Step 4b-4d are same as step 2b-2d, where the target UE acts the role of
the source UE.
5\. After the successful verification of the Direct Security Mode complete
message, the 5G ProSe UE-to-UE Relay store the 5GPRUK ID in the security
context associated to the PC5 link with the target UE and sends a Direct
Communication Ack message to the target UE.
6\. The target UE sends the Direct Communication Accept message to the 5G
ProSe UE-to-UE Relay after received Direct Communication Ack message.
7\. The 5G ProSe UE-to-UE Relay sends the Direct Communication Accept message
to source UE after received Direct Communication Accept message from Target
UE.
NOTE 3a: The need for the new Direct Communication Response and Direct
Communication Ack message is not addressed in the present document.
8\. The source UE and the target UE establish a secure connection between
them.
NOTE 4: How to establish a secure connection between the source UE and the
target UE is not addressed in the present document.
### 6.5.3 Evaluation
This solution only works when the UE-to-UE relay is located within network\'s
coverage area. The 5G ProSe Source/Target and UE-to-UE relay need to store
security materials dedicated to the In-Coverage scenario. Apart from the PC5
signalling (i.e. step 2b), additional user plane/signalling interactions with
the network are required in this mechanism.
In the case the UEs (Source/Target/Relay) support multiple security methods
(i.e. for In-Coverage and Out-of-Coverage), the 5G ProSe Source/Target and UE-
to-UE relay are required to have the logic to choose between the In-Coverage
dedicated mechanism and the Out-of-Coverage dedicated mechanism before
starting the direct communication establishment.
## 6.6 Solution #6: End-to-end security establishment for Layer-2 UE-to-UE
relay
### 6.6.1 Introduction
This solution addresses security requirement for providing confidentiality,
integrity protection of end-to-end information exchanged between the peer UEs
over the L2 UE-to-UE Relay in key issue #2.
### 6.6.2 Solution details
#### 6.6.2.1 End-to-end security establishment for Layer-2 UE-to-UE relay
Figure 6.6.2.1: End to end security establishment for Layer-2 UE-to-UE relay
1\. Service authorisation and policy provisioning is performed for the Source
UE, Target UE and UE-to-UE Relay, the security policy can be provisioned by
PCF as defined in TS 33.536 [9].
2\. Source UE has selected a suitable UE-to-UE Relay and received the Layer-2
ID of the target UE after Model A or Model B discovery, and the discovery
procedure described here is standalone. Source UE decides to connect with
target UE via the selected UE-to-UE Relay.
3a. If there is no PC5 link between source UE and UE-to-UE Relay existing for
the required RSC, the source UE sends a Direct Communication Request to UE-to-
UE Relay.
3b. If there is an existing PC5 link between the source UE and UE-to-UE relay
for the required RSC, the source UE sends a Link Modification Request to UE-
to-UE relay. The security for this existing PC5 link may have been
established, then the step 4 can be skipped.
4\. The security establishment for PC5 link between the source UE and UE-to-UE
relay is as specified in clause 5.3.3 of TS 33.536 [9].
5a. If there is no PC5 link between UE-to-UE Relay and the target UE exist for
the required RSC, UE-to-UE Relay sends a Direct Communication Request to the
target UE.
5b. If there is an existing PC5 link between the target UE and UE-to-UE relay
for the required RSC, UE-to-UE relay sends a Link Modification Request to the
target UE. The security for this existing PC5 link may have been established,
then the step 6 can be skipped.
6\. The security establishment for PC5 link between the target UE and UE-to-UE
relay is as specified in clause 5.3.3 of TS 33.536 [9].
NOTE a: Which entity (e.g., U2U relay or target UE) initiates the DSMC
procedure in step 6 is not addressed in the present document.7a. After step 6,
the target UE sends the Direct Communication Accept to the UE-to-UE relay.
7b. After step 5b, the target UE sends the Link Modification Accept to the UE-
to-UE relay.
8a. If step 3a is performed, the UE-to-UE relay sends the Direct Communication
Accept to the source UE.
8b. If step 3b is performed, the UE-to-UE Relay sends the Link Modification
Accept to the source UE.
9\. After PC5 link between source UE and UE-to-UE relay, UE-to-UE relay and
target UE sets up, the E2E PC5 link establishment performs. The source UE
sends a Direct Communication Request message to initiate the E2E PC5 link
establishment procedure with the target UE.
To establish the End-to-End security between source UE and target UE, the
message includes RSC, source UE\'s security capability and source UE\'s
security policy. This message may include shared security credential ID
between source UE and target UE to generate K~D~, or if there exists a shared
key K~D~ between source UE and target UE, the message may include K~D~ ID,
Nonce_1 (for session key K~D-sess~ generation), and the most significant
8-bits of the K~D-sess~ ID (for uniquely identifying K~D-sess~ at source UE).
Note 1: The provisioning of security credentials and security credential ID in
the Source UE and Target UE is out of 3GPP scope.
The privacy information of source UE such as source UE\'s security capability
and security policy, Nonce_1 can be protected by these security per-hop links
between source UE and UE-to-UE relay, UE-to-UE relay and target UE.
10\. During the Direct Auth and Key Establishment, several authentication
signallings are exchanged between the peer UEs to derive the shared key K~D~
based on the shared credential between source UE and target UE.
Note 2: How the source UE and the target UE generate the shared key K~D~ is
not addressed in this solution.
11a. In case the target UE decides to active the End-to-End security
protection, based on source UE\'s security policy, target UE choose Nonce_2
and generates the session key K~D~-sess as specified in clause 6.6.2.3.1,
selects integrity and encryption algorithms from Source UE\'s capability,
generates integrity and encryption keys as specified in clause 6.6.2.3.2. The
target UE may choose LSB of K~D-sess~ ID, forms K~D-sess~ ID, and stores
K~D-sess~ ID with K~D-sess~. The target UE may choose the MSB of KD ID to
uniquely identify K~D~ at target UE if a new K~D~ is generated.
11b. The target UE activates the integrity protection before sending the
Direct Security Mode message if the U2U relay integrity key K~D-int~ has been
derived.
12\. The target UE sends the Direct Security Mode message to source UE through
UE-to-UE relay, including Source UE\'s security capabilities, Source UE\'s
security policy to protect from bidding down attack. The message also includes
Nonce_2, LSB of KD-sess ID, chosen_algs, and MAC for integrity protection, or
the message may include MSB of KD ID.
13a. Upon reception of the Direct Security Mode message from the UE-to-UE
Relay, the source UE generates the session key K~D~-sess as specified in
clause 6.6.2.3.1. According to the chosen_algs from target UE, source UE
generates integrity and encryption keys as specified in clause 6.6.2.3.2. The
source UE forms K~D~-sess ID from the received LSB of K~D~-sess ID and chosen
MSB of K~D~-sess ID, and stores K~D~-sess ID with K~D~-sess. Or, if a new K~D~
is generated, the source UE forms K~D~ ID from the received MSB of K~D~ ID and
chosen LSB of K~D~ ID, and stores the complete K~D~ ID with K~D~.
13b. The source UE verifies the integrity protection using the indicated
integrity algorithm in chosen_algs and the generated integrity key. After the
successful verification, source UE starts integrity and encryption protection
before sending the Direct Security Mode Complete message.
14\. The source UE sends the Direct Security Mode Complete message to target
UE through the UE-to-UE Relay, which may contain the LSB of K~D~ ID if a new
K~D~ is generated.
15\. Upon reception of the Direct Security Mode Complete message from the UE-
to-UE Relay, the target UE deciphers and checks the integrity protection on
the Direct Security Mode Complete message. The target UE may form the K~D~ ID
and store it with K~D~.
16\. The Target UE sends a Direct Communication Accept message to the Source
UE.
Note 3: How the PC5-S messages in steps 4, 5, 7, 9, 11 are forwarded by the
UE-to-UE Relay is to be determined by RAN2, such as based on an Adaptation
layer.
#### 6.6.2.2 Key Hierarchy for UE-to-UE relay
There are 4 different layers of keying material as shown in figure 6.6.2.2-1.
Figure 6.6.2.2-1: Key Hierarchy for UE-to-UE relay
\- Security Credentials: Upon successful configuration procedure, each UE will
be configured with the credentials which include a public/private key pair.
Authentication signallings are exchanged between source UE and target UE via
UE-to-UE relay to derive the K~D~.
\- K~D~: This is a root key that is shared between source UE and target UE
that communicating using UE-to-UE relay link. It may be refreshed by re-
running the authentication signallings using the security credentials. Nonces
are exchanged between the UEs and used with the K~D~ to generate a K~D~-sess
(the next layer of keys). The K~D~ ID is used to identify K~D~.
\- K~D~-sess: This key is derived by source UE and target UE from K~D~ and is
used derive keys that to protect the transfer of data between the peer UEs.
The actual keys (see next bullet) that are used in the confidentiality and
integrity algorithms are derived directly from K~D~-sess. The K~D~-sess ID
identifies the K~D~-sess ID.
\- K~D-enc~, K~D-int~: The U2U relay Encryption Key (K~D-enc~) and Integrity
Key (K~D-int~) are used in the chosen confidentiality and integrity algorithms
respectively for protecting control plane data and user plane data between
source UE and target UE.
#### 6.6.2.3 Key derivation functions
##### 6.6.2.3.1 KD-sess derivation function
The K~D~-sess derivation function is specified in clause A.3 of TS 33.536 [9],
and the input key is K~D~.
##### 6.6.2.3.2 Integrity and encryption keys derivation function
The integrity key K~D-int~ and encryption key K~D-enc~ derivation function are
specified in clause A.2 of TS 33.536 [9], and the input key is K~D-sess~.
### 6.6.3 Evaluation
The solution fulfils the security requirement of Key Issue #2: Security of UE-
to-UE Relay.
The solution supports security per hop links (i.e. PC5 link between Source UE
and UE-to-UE Relay, as well as between UE-to-UE Relay and Target UE) and
security E2E PC5 link between source UE and target UE setup.
The solution supports security method (i.e. Out-of-Coverage). With the
provisioned/pre-configured security materials, the security keys can be
generated without the assistance of the network.
This solution is suitable for the standalone discovery.
This solution proposes that the security credential and security credential ID
could be pre-configured in the ProSe enabled UE (i.e. Source UE, Target UE and
UE-to-UE Relay), and provisioning of the security credential and the security
ID in the ProSe enabled UE is out of the 3GPP scope.
## 6.7 Solution #7: Non-network-assisted Security Establishment Procedure for
5G ProSe Layer-3 UE-to-UE Relay
### 6.7.1 Introduction
The solution addresses Key Issue #2: Security of UE-to-UE Relay. It largely
reuses the mechanism of Direct Security Establishment procedure defined in TS
33.503 [6] to ensure the security of UE-to-UE Relay Communication.
For Layer-3 UE-to-UE Relay, the full security of a UE-to-UE PC5 link depends
on the security of two separate PC5 links, i.e. the link between the Source UE
and UE-to-UE Relay and the link between UE-to-UE Relay and Target UE. The
security of these two separate PC5 link relies on the security materials (i.e.
the long term credential), which can be pre-configured on the 5G ProSe UE
(incl. Source UE, Target UE and UE-to-UE Relay) or provisioned by the network
during the service authorization procedure. In other words, all the ProSe UEs
can obtain the security materials without the assistance of network.
Therefore, the Source UE and the Target UE can establish the UE-to-UE PC5 link
via Layer-3 UE-to-UE Relay regardless of whether they are within or out of
network coverage.
### 6.7.2 Solution details
Figure 6.7.2-1: Non-network-assisted PC5 link security establishment procedure
for 5G ProSe Layer-3 UE-to-UE Relay
0\. The long term credential and long term credential ID are associated with
RSC, which could be pre-configured on the 5G ProSe UE (incl. Source UE, Target
UE and UE-to-UE Relay) or provisioned by the network e.g. during Service
Authorization and Provisioning procedure before the U2U discovery procedure.
Note 1: How to pre-configure the long term credential to UE is out of the 3GPP
scope.
1\. The Discovery & Relay Selection procedure is performed between the peer
UEs and the UE-to-UE Relay.
Note 2: It is assumed that after the Discovery & Relay Selection procedure,
the Source UE (UE1) and the Target UE (UE2) can discover each other by
selecting the same UE-to-UE Relay.
2\. The Source UE sends a Direct Communication Request that contains the long
term credential ID, Source UE\'s security capabilities, RSC and nonce 1 to the
UE-to-UE Relay as specified in the TS 33.503 [6]. The message may also include
a Knrp ID if the Source UE has an existing Knrp with this UE-to-UE Relay for
the same RSC.
3\. The UE-to-UE Relay may initiate a Direct Auth and Key Establish procedure
with Source UE to generate the Knrp. If the Knrp ID is included in the Direct
Communication Request, this step is skipped.
4\. The UE-to-UE Relay derives the session key (K~NRP-SESS~) from K~NRP~ and
then derives the confidentiality key (NRPEK) (if applicable) and integrity key
(NRPIK) based on the PC5 security policies as specified in TS 33.503 [6]. The
UE-to-UE Relay sends a Direct Security Mode Command message to the Source UE.
This message also includes the chosen security algorithm and nonce 2.
5\. The Source UE responds with a Direct Security Mode Complete message to the
UE-to-UE Relay.
6\. The UE-to-UE Relay sends a Direct Communication Request that contains the
long term credential ID, the chosen security algorithm, RSC and nonce 1\' to
the Target UE as specified in the TS 33.503 [6]. The message may also include
a Knrp ID\' if the UE-to-UE Relay has an existing Knrp\' with this Target UE
under the same RSC.
Note 3: How the U2U relay determines to send DCR to UE2 is determined by SA2.
7\. The Target UE may initiate a Direct Auth and Key Establish procedure with
UE-to-UE Relay to generate the Knrp\'. If the Knrp ID\' is included in the
Direct Communication Request, this step is skipped.
8\. The Target UE derives the session key (K~NRP-SESS\'~) from K~NRP\'~ and
then derives the confidentiality key (NRPEK\') (if applicable) and integrity
key (NRPIK\') based on the PC5 security policies. The Target UE sends a Direct
Security Mode Command message to the UE-to-UE Relay. This message also
includes the nonce 2\'.
9\. The UE-to-UE Relay responds with a Direct Security Mode Complete message
to the Target UE.
10\. The Target UE sends the Direct Communication Accept message to the UE-to-
UE Relay.
11\. Only receiving the Direct Communication Accept message from the Target
UE, the UE-to-UE Relay then responds with the Direct Communication Accept
message to the Source UE.
12\. The secure Layer-3 PC5 link between the Source UE and the Target UE via
the UE-to-UE Relay is established. The UE-to-UE Relay can forward the traffic
between the peer Prose UEs.
### 6.7.3 Evaluation
This solution is based on the Direct Security Establishment procedure defined
in TS 33.503 [6]. This solution fulfils all the security requirements of KI#2.
Once the security has been established, the user-plane/control-plane messages
exchanged between the Source End UE and Target End UE via UE-to-UE Relay are
integrity protected and confidentiality protected.
This solution is aligned with the SA2\'s procedure defined in TS 23.304 [8].
This solution can ensure that the Source End UE and the Target End UE can
establish the UE-to-UE PC5 link via Layer-3 UE-to-UE Relay regardless of
whether they are within or out of network coverage.
In this solution, the long term credential is used as the root key for UE-to-
UE Relay link establishment. The long term credential can be pre-configured on
the 5G ProSe UE (incl. Source End UE, Target End UE and UE-to-UE Relay).
Using the V2X solution with a long term key between an End UE and UE-to-UE
relay, when UE-to-UE relay is in 3GPP coverage and UE-to-UE relay is able to
establish a secure PC5 link with network assistant, will provide lower
security as V2X solution does not support authorization. UE-to-UE relay in
3GPP coverage should therefore always establish a secure PC5 link with network
assistant with End UE.
## 6.8 Solution #8: Restricted 5G ProSe UE-to-UE Relay Discovery Model A
### 6.8.1 Introduction
The solution addresses Key Issue #1: Security for UE-to-UE Relay discovery and
Key Issue #3: Authorization in the UE-to-UE Relay Scenario. It largely reuses
the mechanism of Prose Discovery defined in TS 33.503 [6] to ensure the
security of UE-to-UE Relay Discovery.
If the Source UE cannot reach the Target UE directly, it will try to discover
a UE-to-UE Relay, which is responsible for providing relay service in
connecting two Remote UEs over PC5. In the Model A method of the ProSe
discovery, the UE-to-UE Relay plays the role of the Announcing UE and
broadcasts the announcement message to all the UEs in proximity. To protect
the announcement message, the UE-to-UE relay needs to request the security
parameters from the DDNMF in the control plane or the PKMF in the user plane.
The solution meets all the security requirements in Key issue #1 by achieving
privacy protection, protection of messages and security materials
provisioning.
### 6.8.2 Solution details
Figure 6.8.2-1: Security procedure for restricted 5G ProSe U2U Discovery Model
A
The ProSe Application Server allocates a User Info ID for each ProSe UE and
returns the User Info ID to the application client in the UE.
As defined in the TS 23.304 [8], the UE-to-UE Relay can discover other UEs in
proximity via the previous U2U discovery or U2U communication procedures, the
UE-to-UE Relay may buffer their User Info ID as Discovered UE ID. The
Discovered UE ID will be removed by UE-to-UE Relay in case the buffer timer
expired.
When the user-plane based security procedure for the UE-to-UE Relay discovery
is used, the 5G PKMF takes the role of the 5G DDNMF. Steps 1-3 refer to the
Relay Discovery Key Request procedure of UE-to-UE Relay. For the 5G ProSe UE-
to-UE Relay Discovery, the UE-to-UE Relay plays the role of the Announcing UE.
1\. UE-to-UE Relay sends a Relay Discovery Key Request message containing its
User Info ID and Relay Service Code (RSC) to its 5G DDNMF in order to get the
associated security material. In addition, the UE-to-UE Relay includes its PC5
UE security capability that contains the list of supported ciphering
algorithms by the UE-to-UE Relay in the Relay Discovery Key Request message.
Note 1: The RSC may either be pre-configured on the UE or provisioned by the
network during the service authorization and provisioning procedure.
2\. The 5G DDNMF of the UE-to-UE Relay may check for the announcement
authorization with the PCF/UDM of the UE-to-UE relay or the ProSe App Server.
Note 2: If the UE-to-UE relay is roaming, the 5G DDNMFs in the HPLMN and VPLMN
of the UE-to-UE Relay may exchange Announcement Auth, which is omitted in the
above figure.
3\. The 5G DDNMF of the UE-to-UE Relay returns the corresponding Code-Sending
Security Parameters, along with the CURRENT_TIME and MAX_OFFSET parameters.
The Code-Sending Security Parameters are stored with the RSC, which provide
the necessary information for the UE-to-UE Relay. The 5G DDNMF of the UE-to-UE
Relay includes the chosen PC5 ciphering algorithm in the Relay Discovery Key
Response message, which is determined by the RSC and the received PC5 UE
security capability in step 1.
Steps 4-9 refer to the Relay Discovery Key Request procedure of Source
UE/Target UE. For the 5G ProSe UE-to-UE Relay Discovery, the Source UE and
Target UE play the role of the Monitoring UE.
4\. The Source UE/Target UE sends a Relay Discovery Key Request message
containing its User Info ID, RSC and its PC5 UE security capability and
optionally the Relay User Info ID(s) to its 5G DDNMF in order to be allowed to
monitor for one or more UE-to-UE Relay.
Note 3: The application client provides the Source UE/Target UE with the list
of potential UE-to-UE Relay containing the Relay User Info ID(s). The Relay
User Info ID(s) of Source UE/Target UE to be monitored are passed in an
Application Lever Container.
5\. The 5G DDNMF of the Source UE/Target UE sends an authorization request to
the PCF/UDM of the Source UE/Target UE or the ProSe App Server. If, based on
the permission settings, the Source UE/Target UE is allowed to monitor the
announcement message under this specific U2U relay service and allowed to
discover at least one of the Relay User Info(s) contained in the Application
Level Container, the PCF/UDM of the Source UE/Target UE or the ProSe App
Server returns an authorization response.
6\. If the Relay Discovery Key Request is authorized, and the PLMN ID in the
Relay User Info ID(s) indicates a different PLMN, the 5G DDNMF of the Source
UE/Target UE contacts the indicated PLMN\'s 5G DDNMF (i.e. the 5G DDNMF of the
UE-to-UE Relay) by sending a Monitor Request message including the PC5 UE
security capability received in step 4.
7\. The 5G DDNMF of the UE-to-UE Relay may exchange authorization messages
with the ProSe App Server. The ProSe Application Server may check whether the
Source UE/Target UE and the UE-to-UE Relay are authorized to perform the U2U
discovery under the specific U2U relay service.
8\. If the Monitor Request is authorized and the PC5 UE security capability in
step 4 includes the chosen PC5 ciphering algorithm, the 5G DDNMF of the UE-to-
UE Relay responds to the 5G DDNMF of the Source UE/Target UE with a Monitor
Response message including the corresponding Code-Receiving Security
Parameters and the chosen PC5 ciphering algorithm. The Code-Receiving Security
Parameters provide the information needed by the Source UE/Target UE to undo
the protection applied by the UE-to-UE relay. The 5G DDNMF of the Source
UE/Target UE stores the RSC and the Code-Receiving Security Parameters.
9\. The 5G DDNMF of the Source UE/Target UE returns the Code-Receiving
Security Parameters, along with the CURRENT_TIME and MAX_OFFSET parameters and
the chosen PC5 ciphering algorithm. The Source UE/Target UE stores Code-
Receiving Security Parameters, and the chosen PC5 ciphering algorithm together
with the RSC.
Steps 10 and 11 occur over PC5:
10\. The UE-to-UE relay broadcasts the U2U Relay announcement message and
protects it by using the corresponding Code-sending security parameters. The
U2U announcement message may contain the Type of Discovery (i.e. U2U relay),
RSC, User Info ID of U2U Relay and Discovered UE ID (i.e. User Info ID of
discovered UEs in proximity via the previous U2U Discovery or U2U
Communication), etc..
11\. The Source UE/Target UE listens to the announcement message that
satisfies its RSC if the UTC-based counter associated with that discovery slot
is within the MAX_OFFSET of the Source UE/Target UE\'s ProSe clock. In order
to find such a matching message, it processes the message. Only if the
integrity check is passed, the UE can decide if it can use this UE-to-UE relay
according to RSC and Discovered UE ID(s). If the UE wants to communicate with
other UEs via this relay, the UE may initiate the U2U relay link establishment
procedure.
Note 4: The Source UE/Target UE may check the integrity of the announcement
message on its own or check the integrity by sending a Match Report as defined
in TS 33.503 [6].
### NOTE 5: Solution details are not addressed in the present document.NOTE 6:
It is not addressed in the present document about whether both CP and UP based
procedures are needed for security materials provisioning.6.8.3 Evaluation
This solution is aligned with the procedure defined in TS 23.304 [8].
By using the security materials, the 5G Prose End UEs can securely discover
each other via UE-to-UE Relay and the Announcement message can be protected.
This solution fulfils the security requirements of KI#3 based on the
DDNMF/PKMF\'s authorization by reusing the Discovery procedure defined in
clause 6.1.3.2 of TS 33.503 [6]. Once the authorization is passed, the 5G
Prose End UEs and UE-to-UE Relay can perform UE-to-UE relay discovery.
This solution uses one set of discovery security material to protect the
Announcement message by reusing the Discovery procedure defined in clause
6.1.3.2 of TS 33.503 [6].
## 6.9 Solution #9: Restricted 5G ProSe UE-to-UE Relay Discovery Model B
### 6.9.1 Introduction
The solution addresses Key Issue #1: Security for UE-to-UE Relay discovery and
Key Issue #3: Authorization in the UE-to-UE Relay Scenario. It largely reuses
the mechanism of Prose Discovery defined in TS 33.503 [6] to ensure the
security of UE-to-UE Relay Discovery.
If the Source UE cannot reach the Target UE directly, it will try to discover
a UE-to-UE Relay, which is responsible for providing relay service in
connecting two Remote UEs over PC5. In the Model B method of the ProSe
discovery, the Source UE plays the role of the Discoverer UE, the Target UE
plays the role of the Discoveree UE and the UE-to-UE Relay forwards all the
messages between the Source UE and the Target UE. To achieve the security of
UE-to-UE Relay Discovery, the UEs need to request the security parameters from
the DDNMF in the control plane or the PKMF in the user plane.
The solution meets all the security requirements in Key issue #1 by achieving
privacy protection, protection of messages and security materials
provisioning.
### 6.9.2 Solution details
Figure 6.9.2-1: Security procedure for restricted 5G ProSe U2U Discovery Model
B
The ProSe Application Server allocates a User Info ID for each Prose UE and
returns the User Info ID to the application client in the UE.
When the user-plane based security procedure for the UE-to-UE Relay discovery
is used, the 5G PKMF takes the role of the 5G DDNMF. Steps 1-3 refer to the
Discovery Key Request procedure of UE-to-UE Relay.
1\. UE-to-UE Relay sends a Relay Discovery Key Request message containing its
User Info ID and Relay Service Code (RSC) to its 5G DDNMF in order to get
associated security materials. In addition, the UE-to-UE Relay includes its
PC5 UE security capability that contains the list of supported ciphering
algorithms by the UE in the Relay Discovery Key Request message.
Note 1: The RSC may either be pre-configured on the UE or provisioned by the
network during the service authorization and provisioning procedure.
2\. The 5G DDNMF of the UE-to-UE Relay may check for the announcement
authorization with the PCF/UDM of the UE-to-UE Relay or the ProSe App Server
depending on the local configuration.
Note 2: If the UE-to-UE relay is roaming, the 5G DDNMFs in the HPLMN and VPLMN
of the UE-to-UE Relay may exchange Announcement Auth message, which is omitted
in the above figure.
3\. The 5G DDNMF of the UE-to-UE Relay returns the Code Security Parameters
along with the CURRENT_TIME and MAX_OFFSET parameters and the chosen PC5
ciphering algorithm. The Code Security Parameters are stored with the RSC,
which provides the necessary information for the UE-to-UE relay. The 5G DDNMF
of the UE-to-UE Relay includes the chosen PC5 ciphering algorithm in the Relay
Discovery Key Response message, which is determined by the RSC and the
received PC5 UE security capability in step 1.
Steps 4-9 refer to the Relay Discovery Key Request procedure of Discoveree
UE/Discoverer UE. For the 5G ProSe UE-to-UE Relay Discovery, the Source UE
plays the role of the Discoverer UE and the Target UE plays the role of the
Discoveree UE.
4\. The Source UE/Target UE sends a Relay Discovery Key Request message
containing the User Info ID, RSC, its PC5 UE security capability and
optionally the Relay User Info ID(s) to its 5G DDNMF in order to be allowed to
discover one or more UE-to-UE Relay.
Note 3: The application client provides the Source UE/Target UE with the list
of potential UE-to-UE Relay containing the Relay User Info ID(s). The Relay
User Info ID(s) of Source UE/Target UE to be monitored are passed in an
Application Lever Container.
5\. The 5G DDNMF of the Source UE/Target UE sends an authorization request to
the PCF/UDM of the Source UE/Target UE or the ProSe App Server. If, based on
the permission setting, the Source UE/Target UE is allowed to perform UE-to-UE
Relay Discovery procedure under this specific U2U relay service and allowed to
discover at least one of the Relay User Info(s) contained in the Application
Level Container,, the PCF/UDM of the Source UE/Target UE or the Prose App
Server returns an authorization response.
6\. If the Relay Discovery Key Request is authorized, and the PLMN ID in the
Relay User Info ID indicates a different PLMN, the 5G DDNMF of the Source
UE/Target UE contacts the indicated PLMN\'s 5G DDNMF (i.e. the 5G DDNMF of the
UE-to-UE Relay) by sending a Discovery Request message including the PC5 UE
security capability in step 4.
7\. The 5G DDNMF of the UE-to-UE Relay may exchange authorization messages
with the ProSe Application Server. The ProSe Application Server may check
whether the Source UE/Target UE and the UE-to-UE relay are authorized to
perform the UE-to-UE Relay Discovery under the specific U2U relay service.
8\. If the Discovery Request is authorized and the PC5 UE security capability
in step 4 includes the chosen PC5 ciphering algorithm, the 5G DDNMF of the UE-
to-UE Relay responds to the 5G DDNMF of the Source UE/Target UE with a
Discovery Response message including the Code Security Parameters and a chosen
PC5 ciphering algorithm. The Code Security Parameters provide the information
needed by the Source UE/Target UE to protect/unprotect all discovery messages
under the specific U2U relay service. The 5G DDNMF of the Source UE/Target UE
stores the RSC and Code Security Parameters.
9\. The 5G DDNMF of the Source UE/Target UE returns the Code Security
Parameters along with the CURRENT_TIME, MAX_OFFSET parameters and the chosen
PC5 ciphering algorithm. The Source UE/Target UE stores the Code Security
Parameters together with the RSC.
Steps 10 and 13 occur over PC5:
10\. The Source UE broadcasts the Solicitation Message and protects it by
using the corresponding code security parameters. The Solicitation Message may
contain the Type of Discovery (i.e. U2U relay), RSC, source UE info (i.e. User
Info ID of the Source UE) and target UE info (i.e. User Info ID of Target UE),
etc..
11\. The UE-to-UE Relay listens to a solicitation Message that satisfies the
RSC if the UTC-based counter associated with that discovery slot is within the
MAX_OFFSET of the UE-to-UE Relay\'s ProSe clock. On receiving the solicitation
message including the supported RSC, UE-to-UE Relay(s) process it by using the
corresponding code security parameters. If the integrity check/confidentiality
check is passed, the UE-to-UE Relay adds the relay information in the
solicitation message and broadcasts the new solicitation message, which is
protected by the corresponding code security parameters. The new solicitation
message may contain the Type of Discovery, Relay Info (i.e. User Info ID of
UE-to-UE Relay), RSC, Relay indication (to indicate ProSe direct discovery
forwarding), original Discoverer Info (i.e. User Info ID of Source UE) and
target discoveree info (i.e. User Info ID of Target UE).
12\. The Target UE listens to the solicitation Message that satisfies its RSC
if the UTC-based counter associated with that discovery slot is within the
MAX_OFFSET of the Target UE\'s ProSe clock. If the integrity check/
confidentiality check is passed, the Target UE responds to the solicitation
message via a response message.
Note 4: The Source UE/Target UE may check the integrity of the discovery
message on its own or check the integrity by sending a Match Report as defined
in TS 33.503 [6].
13\. On receiving the response message, UE-to-UE Relay(s) checks its integrity
and confidentiality based on the security policies. If the check is passed,
UE-to-UE relay forwards response message containing the Type of Discovery,
Relay Info (i.e. User Info ID of Relay), RSC, Relay indication (to indicate
ProSe direct discovery forwarding), original Discoveree Info (i.e. User Info
ID of Target UE) and Discoverer Info (i.e. User Info ID of Source UE).
On receiving the response message from UE-to-UE relay, Source UE checks its
integrity and confidentiality based on the security policies and determines if
it can use this relay. If the Source UE wants to communicate with the Target
UE via this Relay, the Source UE may initiate the U2U relay link establishment
procedure.
Note 5: The UE-to-UE relay selection may be performed on the Target UE or
Source UE.
### NOTE 6: Solution details based on the conclusion of TR 23.700-33 [2] are
not addressed in the present document.NOTE 7: It is not addressed in the
present document about whether both CP and UP based procedures are needed for
security materials provisioning.6.9.3 Evaluation
This solution is aligned with the procedure defined in TS 23.304 [8].
By using the security materials, the 5G Prose End UEs can securely discover
each other via UE-to-UE Relay and the Solicitation/Response messages can be
protected.
This solution fulfils the security requirements of KI#3 based on the
DDNMF/PKMF\'s authorization by reusing the Discovery procedure defined in
clause 6.1.3.2 of TS 33.503 [6]. Once the authorization is passed, the 5G
Prose End UEs and UE-to-UE Relay can perform UE-to-UE relay discovery.
This solution uses one set of discovery security material to protect the
Solicitation/Response message by reusing the Discovery procedure defined in
clause 6.1.3.2 of TS 33.503 [6].
## 6.10 Solution #10: PAKE-based security for UE-to-UE relay
### 6.10.1 Introduction
This solution addresses Key Issue #2 and Key Issue #3.
This solution proposes the usage of a password-based key establishment (PAKE)
for UE-to-UE relay security and authorization. A PAKE allows establishing a
secure channel while authenticating the peers based on a password. The PAKE is
used to setup the security between:
\- the source UE (S-UE) and the UE-to-UE Relay (UE2UE),
\- the target UE (T-UE) and the UE2UE and
\- the S-UE and the T-UE.
The password(s) may be configured in an initial authorisation and parameter
provisioning phase when the UEs are in coverage. When this is done, it is
ensured that the network remains in control of the UE-to-UE relay secure
communication. However, the password(s) may also be entered by a user or
generated by the involved devices, e.g. when one or more of the devices are
out-of-coverage. This option ensures that the security requirements can be
fulfilled even in challenging operational cases.
Furthermore, the usage of a PAKE provides a reasonable approach for the
authentication/authorization of the communicating parties:
\- using a balanced PAKE authenticates two peers in a similar role, e.g.
source and target UE;
\- using an augmented PAKE can be used to differentiate roles, e.g. the role
of a UE-to-UE relay and the role of a source/target UE preventing
impersonation.
For cases in which these authorisation capabilities are not enough, this
solution proposes the optional use of authorization tokens and policies \--
deployed in the initial authorisation and parameter provisioning phase -- for
enhanced authorization capabilities.
### 6.10.2 Solution details
#### 6.10.2.0 General
Figure 6.10.2-1 depicts the steps of this solution.
{width="5.14375in" height="4.126388888888889in"}
Figure 6.10.2-1
The required steps are as follows:
\- Step 0 is the initial authorization and parameter provisioning of S-UE,
UE2UE and T-UE.
\- Steps 1 and 2 involve the exchange of an initial Direct Communication
Request (DCR) message.
\- Step 3 involves the setup of a secure authenticated channel between UE2UE
and T-UE based on a PAKE.
\- Step 4 involves an optional authorization phase.
\- Step 5 involves the exchange of Direct Communication Accept (DCA) from T-UE
to UE2UE.
\- Step 6 involves the setup of a secure authenticated channel between S-UE
and UE2UE based on a PAKE.
\- Step 7 involves an optional authorization phase.
\- Step 8 involves the exchange of DCA from UE2UE to S-UE.
\- Step 9 involves the setup of a secure authenticated channel between S-UE
and T-UE based on a PAKE.
\- Step 10 involves an optional authorization phase.
\- Step 11 involves the exchange of DCA from T-UE to S-UE.
The PAKE in Steps 3, 6, and 9 may rely on a password shared amongst both UEs
(in case of balanced PAKE), or a password and a password derived value (in
case of augmented PAKE) that might be, e.g. pre-configured in Step 0. This
password may also be entered in the involved devices by the users or generated
by the devices and exchanged out-of-band.
The PAKE in Steps 3 and 6 may be an augmented PAKE in which, e.g. the Target
UE (or Source UE) does not have access to the password itself, but a password-
derived value used in the augmented PAKE and from which the actual password
can only be retrieved by means of an offline dictionary attack. This prevents
the target UE (or Source UE) from impersonating the UE2UE.
The PAKE in Steps 3, 6, and 9 allow the communicating parties to authenticate
to each other and establishing symmetric-cryptographic keys used to protect
the communication link. This process provides a certain level of
authorization, e.g. if two UEs share a same password (-derived) value, the
authentication will be successful fulfilling authorization requirements in
many scenarios.
Note 1: The PAKE choice is left to application layer. This solution only
provides the means to support an application layer defined PAKE in ProSe.
The message flow in Figure 6.10.2-1 can be adapted to other message flows,
e.g. relying on discovery messages. For instance, the S-UE can send a
Discovery Solicitation message towards the T-UE through the UE2UE. The T-UE
replies with a Discovery Response message towards the S-UE through the UE2UE.
Next, S-UE and UE2UE can establish a secure PC5 interface relying on a PAKE.
Next, UE2UE and T-UE can establish a secure PC5 interface relying on a PAKE.
And finally, S-UE and T-UE can establish a secure PC5 interface (assuming an
L2 UE2UE) based on a PAKE.
This PAKE based solution can be either fully in ProSe scope or partial ProSe
scope.
\- In partial ProSe scope, it is required the ProSe definition of at least (1)
parameters to be provisioned, (2) parameters exchanged prior to the PAKE
itself, and (3) method to provision a password in out-of-coverage situations.
\- In full ProSe scope, it is required the choice of at least a PAKE protocol.
Full ProSe scope provides increased interoperability.
#### 6.10.2.1 Parameter provisioning in-coverage and out-of coverage
The provisioning of passwords can be done either in coverage or out-of-
coverage in Step 0.
When the provisioning is done when a UE is in coverage, the UE is configured
with one or multiple passwords \"raw-passwords\" or \"password-derived
tokens\".
Each \"raw-password\" or \"password-derived token\" is associated to
\"metadata\". The \"metadata\" includes \"password hint\", \"expiration
date\", and \"access rights\". The field \"password hint\" indicates which
password to use; the field \"expiration date\" indicates how long a password
is valid; the field \"access rights\" indicates which authorization provides a
password. The bitstring used as \"password\" in a PAKE is computed as the KDF
of the \"raw-password\" and the associated metadata fields. In the case of an
augmented PAKE, the \"password-derived token\" is derived from the
\"password\" itself.
As in other solutions, the parameters can be received from the 5G PKMF and 5G
DDNMF when the UE is in coverage.
During provisioning in-coverage, a UE is also provisioned with an \"out-of-
coverage policy\" determining whether a UE may use a temporary password
entered or provisioned by the user when the UE is out-of-coverage. When the UE
is then out-of-coverage, a UE can be provisioned with a temporary password
entered by the user if \"out-of-coverage policy\" allows for it.
Note: Details on how a UE can be provisioned with a temporary password in an
out-of-coverage situation (out of band, keyboard, QR code,...) are left to
normative phase.
#### 6.10.2.2 PAKE protocols
There are many PAKE protocols in the literature. Specific PAKE protocols that
are of special interest are IETF PAKE protocols in discussion and/or
standardization at IRTF CFRG, e.g. CPAKE[10], OPAQUE[11], SPAKE2[12] or
SPAKE2+[13]. CPAKE and SPAKE2 are balanced PAKE protocols. OPAQUE and SPAKE2+
are augmented PAKE protocols. While CPAKE and OPAQUE have been formally
endorsed in the PAKE selection process by IRTF CFRG as balanced and augmented
options, the choice of SPAKE2 and SPAKE2+ as balanced and augmented PAKE
protocols, respectively, is also meaningful due to the similarity between
them.
#### 6.10.2.3 Parameters exchanged prior to the PAKE execution
Several parameters need to be exchanged prior to the PAKE execution in Steps
3, 6, and 9. These parameters include:
\- The Relay Service Code,
\- A \"password hint\" used to identify the \"raw password\". In the absence
of an explicit password hint, then it is the RSC that serves as a password
hint, i.e. the password is linked to the RSC.
In particular,
\- The DCR message in Step 1 includes the RSC and password-hints for the PAKEs
in Steps 6 and 9.
\- The DCR message in Step 2 includes the RSC and password-hints for the PAKEs
in Steps 3 and 9.
When the UE2UE relay receives message of Step 1, the UE2UE relay may remove
the password hint for the PAKE in Step 6. Furthermore, the UE2UE relay adds
its password hint for the PAKE to the DCR message in Step 2.
When the target UE receives message in Step 2, the target UE starts the PAKE
in Step 3 based on the received password hint.
#### 6.10.2.4 PAKE execution
This subclause explains how a PAKE can be executed in the context of SPAKE2
and SPAKE2+ that involve the exchange of four messages as explained in Clause
3.1 in [12] and [13].
The first and second PAKE messages are exchanged in a _Direct Auth and Key
Establish Request_ and a _Direct Auth and Key Establish Response_ messages,
respectively.
The third and fourth messages are exchanged in the _Direct Security Mode
Command_ and the _Direct Security Mode Complete_ , respectively.
#### 6.10.2.5 Secure exchange of data
The secure exchange of data relies on a shared key Ks between two UEs result
of the PAKE. This key Ks is K_shared as defined in Clause 3.4 in [13] or TT as
defined in Clause 4 in [12].
For a L2 UE2UE relay, Ks is used as shared secret to derive PC5 keys for
user/control planes and encryption/integrity by means of a key derivation
function according to TS 33.220.
For a L3 UE2UE relay, Ks is used to derive a PSK hint and a PSK. PSK and PSK
hint are used in IKE-PSK to secure the L3 communication by means of a key
derivation function according to TS 33.220.
Note: Details related to the inputs to the KDF such FC value or other
identifiers are left to normative phase.
#### 6.10.2.6 PAKE-based authorization
As described in Clause 6.10.2.1, the bitstring used as \"password\" in a PAKE
is computed as the KDF of the \"raw-password\" and the associated metadata
fields. Thus, a successful PAKE authentication procedure allows verifying the
associated metadata fields, including, access rights. This allows the peers of
the PAKE to perform PAKE-based authorization.
The optional authorization phase in Steps 4, 7, and 9 might be required when
one of the devices requires further authorisation assurances. This phase
relies on the exchange of authorization tokens and policies configured in Step
0. For instance, in Step 4, the target UE can send an authorization token so
that the UE2UE can verify that the target UE is indeed entitled to use the
UE2UE relay.
Note: Details on the optional authorization phase in Steps 4, 7, and 9 are
left to normative phase.
### 6.10.3 Evaluation
This solution addresses Key Issue #2 and Key Issue #3 by describing how ProSe
can support the usage of PAKEs. This allows setting up a secure/authenticated
link and authorizing it based on the usage of passwords.
Impact on ProSe is limited to the exchange of information/messages required to
support a PAKE:
\- The configuration of Source-UE, Target-UE, UE-to-UE relay with PAKE
parameters as in Clause 6.10.2.1.
\- The derivation of the PAKE parameters and password from the \"raw-
password\" and the associated metadata fields as in Clause 6.10.2.1.
\- The exchange of PAKE related parameters required for the PAKE execution as
in Clause 6.10.2.3.
\- The usage of PAKE derived keys as in Clause 6.10.2.5.
\- The configuration of a policy determining whether a user is allowed to
enter a password when Source-UE/Target-UE/UE-to-UE relay is/are out-of-
coverage.
This solution allows authorizing the Source-UE, Target-UE, UE-to-UE relay
based on the configured password information. This provides a simple approach
to ensure that the involved UEs are authenticated and authorized to
communicate with each other regardless of their coverage situation.
TS 33.536 [9] defines long-term credentials as \"the credentials that are
provisioned into the UE(s) and form the root of the security of the PC5
unicast link. The credentials may include symmetric key(s) or public/private
key pair depending on the particular use case\". This definition in TS 33.536
[9] enables multiple protocols for key establishment and authentication based
on symmetric keys or public key cryptography; but it leaves out PAKEs.
However, PAKE-based schemes are very useful and have been adopted in real-
world commercial systems for various use cases such as credential recovery
(e.g. SRP-6a in iCloud), device pairing (e.g. third-generation e-passports and
readers\' mutual authentication with Machine Readable Zone (MRZ) data used as
a shared secret), or end-to-end security (e.g. J-PAKE in Thread) [17]. IRTF
has also performed extensive research and standardisation in this area [18].
PAKEs are a type of protocol for authentication and key establishment that are
based on passwords. Passwords as such are a type of credentials that may be
valid for a variable (e.g. short or long) time period.
There are multiple features that make PAKEs interesting:
\- passwords may be short, and still, PAKEs allow for secure communication
links;
\- authentication is based on passwords hence allowing for
authentication/authorization without the need for a public key infrastructure;
\- passwords may be short, thus, passwords may be entered in a device by a
user, e.g. to provide authentication in out-of-coverage scenarios or in
emergency situations when no other credentials are available;
\- in augmented PAKEs, the password is not stored in the clear, thus providing
protection against impersonation.
## 6.11 Solution #11: Security for UE-to-UE Relay (Model A) discovery
### 6.11.1 Introduction
This solution addresses Key Issue #1 (as defined in clause 5.1). This solution
is based on the solutions in TR23.700-33[2], the UE-to-UE Relay may perform
Direct Discovery Model A or Model B to discover Target UE in advance.
In this solution, during UE-to-UE Relay model A discovery, the announcement
discovery message sent and received between the source/target UE and the UE-
to-UE Relay can be protected by using the discovery key associated with the
RSC, which is obtained from the DDNMF of the HPLMN of the UE-to-UE Relay
pointed by Relay\'s RPAUID, and the RSC can carry one or more the ProSe
Application information or associate with the ProSe Application information.
### 6.11.2 Solution details
#### 6.11.2.1 Restricted 5G ProSe UE-to-UE Relay discovery Model A
Figure 6.11.1: Security procedure for UE-to-UE Relay discovery with Model A
NOTE 1: Figure shows the security procedure of the non-roaming for 5G ProSe
UE-to-UE Relay discovery. In this figure, the source UE and the target UE and
UE-to-UE Relay are in HPLMN.
NOTE 1a: Details parameters for relay discovery are not addressed in the
present document.NOTE 1b: Details network function involved in relay discovery
are not addressed in the present document.Steps 1-4 refer to the Security
procedure of UE-to-UE Relay
1\. UE-to-UE Relay sends Relay Discovery Key Request message containing the
Restricted ProSe Application User ID(RPAUID) and RSC to the 5G DDNMF in order
to get the associated security material. In addition, the UE-to-UE Relay
includes its PC5 UE security capability that contains the list of supported
ciphering algorithms by the UE-to-UE Relay in the Relay Discovery Key Request
message.
2\. The 5G DDNMF may check for the UE-to-UE Relay authorization with the ProSe
Application Server.
3\. The 5G DDNMF of the UE-to-UE Relay returns the corresponding Code-Sending
Security Parameter and Code-Receiving Security Parameter, along with the
CURRENT_TIME and MAX_OFFSET parameters. The UE-to-UE Relay takes the same
actions with CURRENT_TIME and MAX_OFFSET as described for the Announcing UE in
step 4 of clause 6.1.3.1 of the TS 33.503 specification. The 5G DDNMF of the
UE-to-UE Relay includes the chosen PC5 ciphering algorithm in the Relay
Discovery Key Response message. The 5G DDNMF determines the chosen PC5
ciphering algorithm based on the received PC5 UE security capability in step
1. The UE stores the chosen PC5 ciphering algorithm, Code-Sending Security
Parameter and Code-Receiving Security Parameter together with the RSC.
Steps 4a-9a refer to Security procedure for Source UE
4a. The Source UE sends a Relay Discovery Key Request message containing the
RPAUID, RSC and its PC5 UE security capability to the 5G DDNMF in order to be
allowed to monitor for one or more RPAUIDs of UE-to-UE Relay UEs.
5a. The 5G DDNMF of the Source UE sends an authorization request to the ProSe
Application Server. If, based on the RPAUID and RSC of Source UE, the RPAUID
is allowed to discover at least one of the UE-to-UE Relay RPAUIDs contained in
the Application Level Container, the ProSe Application Server returns an
authorization response.
6a. If the Authorization Request is authorized in Step5a, and the PLMN ID in
the UE-to-UE Relay RPAUID indicates a different PLMN, the 5G DDNMF of the
Source UE contacts the indicated PLMN\'s 5G DDNMF of UE-to-UE Relay by sending
a Discovery Request message including the PC5 UE security capability and RSC
received in step 4a.
7a. The 5G DDNMF of the UE-to-UE Relay may exchange authorization messages
with the ProSe Application Server. ProSe Application Server may check whether
the Source UE is authorised to implement UE-to-UE Relay Discovery under
specific UE-to-UE Relay Service.
8a. If the PC5 UE security capability in step 4a includes the chosen PC5
ciphering algorithm, the 5G DDNMF of the UE-to-UE Relay responds to the 5G
DDNMF of the Source UE with a Discovery Response message including the
corresponding Code-Receiving Security Parameters, an optional Discovery User
Integrity Key (DUIK), and the chosen PC5 ciphering algorithm. The Code-
Receiving Security Parameters provide the information needed by the Source UE
to undo the protection applied by the UE-to-UE Relay. The 5G DDNMF of the
Source UE stores the RSC and the Code-Receiving Security Parameters.
9a. The 5G DDNMF of the Source UE returns the Code-Receiving Security
Parameters, along with the CURRENT_TIME and MAX_OFFSET parameters and the
chosen PC5 ciphering algorithm. The Source UE takes the same actions with
CURRENT_TIME and MAX_OFFSET as described for the Monitoring UE in step 9 of
clause 6.1.3.1 of the TS 33.503 specification. The Source UE stores Code-
Receiving Security Parameters and the chosen PC5 ciphering algorithm together
with the RSC.
Steps 4b-9b refer to Security procedure for Target UE
NOTE 2: UE-to-UE Relay may perform Direct Discovery Model A or Model B to add
UEs in Target UE list based on previous discovery.
4b. The Target UE sends a Relay Discovery Key Request message containing the
RPAUID, RSC and its PC5 UE security capability to the 5G DDNMF in order to be
allowed to monitor/discover for one or more RPAUIDs of UE-to-UE Relay UEs.
5b. The 5G DDNMF of the Target UE sends an authorization request to the ProSe
Application Server. If, based on the RPAUID and RSC of Target UE, the RPAUID
is allowed to monitor/discover at least one of the UE-to-UE Relay RPAUIDs
contained in the Application Level Container, the ProSe Application Server
returns an authorization response.
6b. If the Authorization Request is authorized in Step5b, and the PLMN ID in
the UE-to-UE Relay RPAUID indicates a different PLMN, the 5G DDNMF of the
Target UE contacts the indicated PLMN\'s 5G DDNMF of UE-to-UE Relay by sending
a Discovery Request message including the PC5 UE security capability and RSC
received in step 4b.
7b. The 5G DDNMF of the UE-to-UE Relay may exchange authorization messages
with the ProSe Application Server. ProSe Application Server may check whether
the Target UE is authorised to implement UE-to-UE Relay Discovery under
specific UE-to-UE Relay Service.
8b. If the PC5 UE security capability in step 4b includes the chosen PC5
ciphering algorithm, the 5G DDNMF of the UE-to-UE Relay responds to the 5G
DDNMF of the Target UE with a Discovery Response message including the
corresponding Code-Sending Security Parameters, Code-Receiving Security
Parameters, an optional Discovery User Integrity Key (DUIK), and the chosen
PC5 ciphering algorithm. The Code-Receiving Security Parameters provide the
information needed by the Target UE to undo the protection applied by the UE-
to-UE Relay. The 5G DDNMF of the Target UE stores the RSC, Code-Sending
Security Parameters and the Code-Receiving Security Parameters.
9b. The 5G DDNMF of the Target UE returns Code-Sending Security Parameters,
the Code-Receiving Security Parameters, along with the CURRENT_TIME and
MAX_OFFSET parameters and the chosen PC5 ciphering algorithm. The Target UE
takes the same actions with CURRENT_TIME and MAX_OFFSET as described for the
Monitoring UE in step 9 of clause 6.1.3.1 of the TS 33.503 specification. The
Target UE stores Code-Sending Security Parameters, Code-Receiving Security
Parameters, and the chosen PC5 ciphering algorithm together with the RSC.
10\. UE-to-UE Relay broadcasts Relay Announcement message with a Target UE
list and protect it.
11a. The UE-to-UE Relay may perform Discovery procedure with the RSC it
supports to discover target UEs it can announce.
In this procedure, Target UE monitors Relay Announcement message, after
receiving Relay Announcement message, if Target UE wants to use the relay to
be discovered by other UEs, the Target UE will send a Response message and use
Code-Sending Security Parameters to protect it.
NOTE 3: There are two methods for Target UE adding into UE lists. 1. When
Target UE adds into UE list by previous discovery. The UE-to-UE Relay may
perform Direct Discovery procedure (either Model A or Model B) with the RSC it
supports to discover target UEs it can announce. Previous discovery is not
shown in this solution. 2. When Target UE adds into UE list after receiving
Relay announcement message, the step 11a will be implemented
11b. Source UE receives Announcement message, if the Source UE wants to
communicate with the UEs in Target UE list, the UE will implement UE-to-UE
relay link establishment procedure.
### 6.11.3 Evaluation
None.
## 6.12 Solution #12: Security of Layer-2 UE-to-UE Relay and Adaptation Layer
### 6.12.1 Introduction
This contribution proposes a solution to address KI #2: Security of UE-to-UE
Relay and Key Issue #4: Privacy of information over the UE-to-UE Relay. Most
specifically, this contribution provides a solution for E2E security
establishment during E2E PC5 unicast link establishment via a Layer-2 UE-to-UE
Relay and privacy when using such E2E PC5 unicast link. The solution uses the
new Adaptation Layer on the Control Plane and User Plane protocol stacks as
specified in TR 23.700-33 [2], Annex A2 as a baseline.
A PC5 unicast link (also called per-hop link or management link), is
established with the UE-to-UE Relay by source/target UEs to send E2E messages
such as DSMC messages via the Relay. The management link is secured between
the source/target UEs and the UE-to-UE Relay using existing procedures and
does not use an adaptation layer.
### 6.12.2 Solution details
#### 6.12.2.1 End-to-End PC5 unicast link establishment and data forwarding
Figure 6.12.1.1-1: End-to-End PC5 unicast link establishment and data
forwarding using Relay-specific identifiers.
0\. UE-to-UE Relay registers with the network and specifies its relay
capabilities. UE-to-UE Relay is provisioned with relay security policy
parameters from the network based on existing procedures as described in TS
23.304 [8], TS 33.503 [6].
1\. UE1 establishes a secure per-hop PC5 unicast link with the UE-to-UE Relay
using existing procedures.
2\. UE1 sends a DCR message which includes security parameters (i.e. UE1 MSB
of K~NRP-sess~ ID, K~NRP~ ID, nonce1, etc.) as specified in TS 33.536 [9],
clause 5.3.3.1.4 to establish an E2E PC5 unicast link via the UE-to-UE Relay.
3\. The UE-to-UE Relay retransmits the DCR message if it is authorized to
relay for this application based on provisioned relay policy/parameters. The
UE-to-UE Relay adds an adaptation header containing info identifying UE1 and
includes its unique Relay ID and relay-specific MSB of K~NRP-sess~ ID in the
DCR. The UE-to-UE Relay keeps the association of its relay-specific MSB of
K~NRP-sess~ ID and MSB of K~NRP-sess~ ID received from UE1. Any subsequent E2E
messages (i.e. PC5-S and data) are forwarded based on UE identifier info
specified in the adaptation header.
NOTE: The details of handling of messaging via L2 UE-to-UE Relay (i.e., with
adaptation layer) are not addressed in the present document.4. Interested
Target UE (i.e. UE3) receives the DCR message via the UE-to-UE Relay,
establishes a PC5 unicast link establishment with the UE-to-UE Relay, if such
link does not already exist.
5\. Authentication between UE1 and UE3 via the Relay is performed to establish
K~NRP~/K~NRP~ ID pair if UE3 does not have a K~NRP~ and K~NRP~ ID pair as
indicated in DCR from UE1. Authentication and K~NRP~/K~NRP~ ID establishment
via the relay is done according to the same principles as described in TS
33.536 [9], clause 5.3.3.1.3 (i.e. using E2E exchange of Key_Est_Info).
6\. UE3 sends a Direct Security Mode Command message to UE1 via the Relay
(i.e. over the direct PC5 unicast link to the UE-to-UE Relay). UE3 generates
and includes its LSB of K~NRP-sess~ ID. UE3 forms the K~NRP-sess~ ID from the
MSB of K~NRP-sess~ ID received from the Relay in step 4, and its LSB of K~NRP-
sess~ ID. UE3 derives K~NRP-sess~ from K~NRP~ to create the e2e security
context used with UE1 and NRPEK/ NRPIK as described in TS 33.536 [9]. UE3 adds
an adaptation header including its LSB of K~NRP-sess~ ID, and the info
identifying UE1 as received with the DCR message. UE3 includes the Relay ID in
the adaptation header when sending the first message to UE1 (i.e. Direct Link
Authentication Request or Direct Security Mode Command).
The UE-to-UE Relay retransmits the DSMC message to UE1 (over PC5 unicast link
with UE1) including info identifying UE3 in the adaptation header. The UE-to-
UE Relay also includes in the adaptation header a relay-specific LSB of K~NRP-
sess~ ID associated with the E2E link between UE3 and UE1 (i.e. associated to
MSB of K~NRP-sess~ ID as received in step 3). UE-to-UE Relay puts its Layer-2
ID as the source and UE1 Layer-2 ID as the destination. The UE-to-UE Relay
keeps the association of UE3 LSB of K~NRP-sess~ ID and its relay-specific LSB
of K~NRP-sess~ ID associated with UE3. When receiving a DSMC message from the
Relay, UE1 extracts the Relay ID. UE1 forms K~NRP-sess~ ID using LSB of K~NRP-
sess~ ID specified in the adaptation header and its MSB of K~NRP-sess~ ID sent
in step 2. UE1 derives K~NRP-sess~ from K~NRP~ to create the e2e security
context used with UE3 and NRPEK/ NRPIK as described in TS 33.536 [9].
7\. UE1 sends a Direct Security Mode Complete message to UE3 via the Relay
(i.e. over the direct PC5 unicast link to the UE-to-UE Relay) protected using
the established e2e security context. UE3 processes the security of the DSM
Complete message which completes the E2E link security establishment procedure
between UE1 and UE3.
8\. UE3 sends a DCA message to UE1 via the Relay to complete the secure e2e
link establishment between UE1 and UE3.
9\. UE1 and UE3 exchange E2E data via the UE-to-UE Relay. UE-to-UE Relay
replaces the fields specified in the PDCP header with relay-specific
identifiers, based on the mapping established in steps 2 and 5, before
forwarding the E2E messages.
#### 6.12.2.2 Privacy of identifiers for End-to-End PC5 unicast link
As described in clause 6.12.2.1, an end-to-end (E2E) PC5 unicast link is
established with an E2E peer UE via the 2 per-hop links, i.e. between source
UE and the Relay and between the Relay and target UE. The E2E PC5 packets are
using an adaptation header containing information identifying the source UE
and/or destination UE, enabling the forwarding of packets E2E between peer
UEs. PC5 packets also carry E2E session key identifiers, as for regular non-
relayed PC5 communication, in the headers (e.g. PDCP header).
Considering the new adaptation layer and that all identifiers sent as
cleartext needs to be updated at the same time, the Link Identifier Update
procedure, designed in the context of direct communication only, is enhanced
to support the periodic change of the source/destination UEs identity
information carried into the adaptation header, at the same time as the per-
hop identifiers (i.e. L2 IDs) and the end-to-end session key identifiers. In
other words, all identifiers carried together, in cleartext, and that may be
associated needs to be changed at the same time.
Furthermore, multiple end-to-end unicast links may be used via a shared single
per-hop link which means that source/destination UEs identity information
carried in the adaptation header, of all end-to-end unicast links, may be
associated (i.e. bound) to the same per-hop identifiers since they are sent in
the clear when end-to-end peer UEs exchange messages via the UE-to-UE Relay.
This implies that the source UE and all its peer UEs communicating over the
same per-hop link/ UE-to-UE Relay would need to change their identifiers (i.e.
per-hop identifiers, end-to-end identifiers in the adaptation layer and
session key identifiers for related to per-hop and end-to-end communication)
at the same time. Using conventional per-hop LIU procedure could therefore
lead to a signalling storm of PC5-S message exchanges.
To overcome this problem, the UE-to-UE Relay replaces the received source UE
identifiers with mapped relay-specific identifiers (as defined in 6.12.2.1)
before forwarding a message to a peer UE via another per-hop link. This limits
the scope of identifiers sent in cleartext (i.e. in the headers) to the per-
hop link, allowing reuse of per-hop LIU procedure while preserving the privacy
of the E2E identifiers and without the need the change the latter at the same
time.
Figure 6.12.2.2-1: Privacy of Identifiers for End-to-End PC5 unicast link
0\. UE1 and UE2 establish and end-to-end PC5 unicast link via the UE-to-UE
Relay. Security is established E2E between UE1 and UE2. Both UEs have a PC5
unicast link (also called per-hop link or management link) established with
the UE-to-UE Relay. The PC5 unicast link established with the UE-to-UE Relay
is used for the transport of E2E messages, and also for the management of
these E2E links when the UE-to-UE Relay needs to be involved.
1\. UE1 receives a trigger to change its identifiers e.g. privacy timer
expiry. UE1 sends a Link Identifier Update (LIU) Request message to the UE-to-
UE Relay via the management link. The LIU Request message includes a new L2 ID
and new security parameters (i.e. UE1 MSB of K~NRP-sess~ ID) for the
management link. In addition, new E2E security parameters (i.e. UE1 E2E MSB of
K~NRP-sess~ ID) for the E2E link with UE2 and a new E2E identifier used in the
adaptation header are included.
2\. The UE-to-UE Relay receives the message and generates a new L2 ID and new
security parameter (i.e. LSB of K~NRP-sess~ ID) for the management link. In
addition, a new relay-specific E2E security parameter (i.e. E2E LSB of K~NRP-
sess~ ID) and a new relay-specific E2E identifier associated with UE2 and used
in the adaptation header are included. The UE-to-UE Relay sends a LIU Response
message to UE1 which includes its new L2 ID and security parameter for the
management link, the new relay-specific E2E identifier, and the new relay-
specific E2E security parameter.
3\. [optional] If UE1 has triggered the LIU procedure because a new
Application layer ID and/or a new IP address/prefix has been received from the
upper layer, UE1 sends a Link Modification Request to UE2 including its new
Application layer ID and new IP address/prefix.
4\. [optional] UE2 sends a Link Modification Accept to acknowledge the new IDs
from UE1.
5\. UE1 completes the LIU procedure by sending a LIU Ack message to the Relay.
### 6.12.3 Evaluation
For security, this solution proposes that a PC5 unicast link (also called per-
hop link or management link), is established with the L2 UE-to-UE Relay by
source/target UEs using unicast mode security mechanism defined in clause 5.3
of TS 33.503 [6] before establishing E2E security via the L2 UE-to-UE Relay.
NOTE: Further evaluation on end-to-end link establishment is needed.During E2E
link security establishment, the L2 UE-to-UE Relay creates a mapping between
its Relay specific MSB and LSB of K~NRP-sess~ ID respectively with Source
UE\'s MSB of K~NRP-sess~ ID, and Target UE\'s LSB of K~NRP-sess~ ID. The Relay
forwards messages and data between Source and Target UE by replacing the
security context E2E identifiers (i.e. MSB or LSB of K~NRP-sess~ ID) in the
PDCP header with relay specific identifiers according to the above mapping.
For privacy, this solution proposes a mechanism so that the LIU procedure
between a UE and the L2 UE-to-UE Relay does not impact the E2E peer UEs, using
TR 23.700-33 [2], sol#32 as baseline.
This solution fully addresses the following KI for the L2 UE-to-UE Relay
scenario:
\- Key Issue #2: Security of UE-to-UE Relay.
\- Key issue #4: Privacy of information over the UE-to-UE Relay.
## 6.13 Solution #13: E2E authentication with Layer-3 UE-to-UE Relay
### 6.13.1 Introduction
This solution is for the 5G ProSe Layer-3 UE-to-UE Relay case. It addresses
Key Issue #4: Privacy of information over the UE-to-UE Relay, Key Issue #3:
Authorization in the UE-to-UE Relay Scenario, and 2^nd^ requirement of Key
Issue #1: Security for UE-to-UE Relay discovery (protection of privacy
sensitive information of source and target UEs).
TR 23.700-33[2] describes several solutions for Layer-3 based UE-to-UE Relay
which are all based on IP routing functionality at the UE-to-UE Relay. As part
of the PC5 unicast link establishment procedure, the ProSe 5G UE-to-UE Relay
allocates an IP address/prefix to the UE or is informed of the UE\'s IP
address/prefix. The Relay stores the association of the UE\'s Application
layer ID (also called User Info) and UE\'s IP address/prefix (e.g. into its
DNS entries). When a source UE needs to communicate with a target UE via the
ProSe 5G UE-to-UE Relay, it sends a request (e.g. DNS query) to the ProSe 5G
UE-to-UE Relay, over the unicast link, to obtain the target UE\'s IP
address/prefix (based on Target User Info). The Relay returns the IP
address/prefix of the target UE. The source UE sends IP data to the target UE
via the PC5 unicast link to UE-to-UE Relay. The UE-to-UE Relay acts as an IP
router and forwards the packets to the corresponding PC5 unicast link towards
the target UE.
When using the IP based routing, the UE and UE-to-UE Relay may wish to allow
E2E communication only with a peer UE that is authenticated and authorized by
the UE for both privacy reasons and to prevent unauthorized usage of UE-to-UE
Relay resources (e.g. due to unauthorized IP traffic). To enable this, a UE
informs the UE-to-UE Relay during the PC5 link establishment procedure whether
E2E authentication/authorization with peer UEs is required before allowing
communications via the UE-to-UE Relay. The Relay enforces the E2E
authentication/authorization between peer UEs accordingly.
### 6.13.2 Solution details
This solution describes how E2E authentication and authorization is enforced
prior to allowing user data traffic. Key_Est_Info used in the procedure below
is a generic authentication container as defined in TS 33.536 [9]. This
container is transparent to the PC5 interface and used to transport different
data required for key establishment depending on the authentication method
used by the application.
Figure 6.13.2-1: End-to-end authentication via Layer-3 UE-to-UE Relay
1\. PC5 unicast links are established between UE1 and the Relay, UE2 and the
Relay. During PC5 link establishment, UE1 and/or UE2 informs the Relay that
E2E authentication and authorization is required prior to E2E communication,
i.e. DNS resolution/E2E IP communication is not allowed before E2E
authentication and authorization is successfully run. The Relay stores the E2E
authentication and authorization requirement information along with UE1 and/or
UE2 user info.
NOTE: Privacy of IP address/prefix requirement can be configured on a per RSC
and/or 5G ProSe service basis.
2\. UE1 sends IP Discovery Authorization Request to Relay including target UE2
user info, UE1 user info, and Key_Est_Info.
3\. Relay determines that E2E authentication and authorization is required
based on stored UE1 and UE2 user info and triggers E2E authentication and
authorization.
The following steps 4 and 5 may be run multiple times depending on the
authentication method used.
4\. (a) Relay sends a Relayed Auth and Key Establishment Request message to
UE2 including UE1 user info, UE2 user info, and Key_Est_Info. (b) UE2 sends a
Relayed Auth and Key Establishment Response message to Relay including UE1
user info, UE2 user info, and Key_Est_Info. The final response indicates to
the relay the authentication is complete with the corresponding result.
5\. (a) Relay sends a Relayed Auth and Key Establishment Request message to
UE1 including UE2 user info, UE1 user info, and Key_Est_Info. (b) UE1 sends a
Relayed Auth and Key Establishment Response message to Relay including UE1
user info, UE2 user info, and Key_Est_Info. The final response indicates to
the relay the authentication is complete with the corresponding result.
6\. The relay stores the authorization result with UE1 and UE2 user info.
7\. Once a final successful authentication result is received by the Relay
from UE1 and UE2, Relay replies with an IP Discovery Authorization Response
message including the successful authorization result. If the E2E
authentication and authorization fails, the Relay sends a Response indicating
failure.
8\. If UE1 is authorized, it sends a DNS Query to obtain UE2\'s IP
address/prefix. Relay verifies that UE1 is authorized to obtain UE2\'s IP
address/prefix based on stored UE1 and UE2 user info and sends UE2\'s IP
address/prefix in a DNS Response message.
### 6.13.3 Evaluation
This solution proposes a new PC5-S messaging to initiate E2E authentication
and authorization via a L3 UE-to-UE Relay prior to allowing the discovery of
peer UE\'s IP address/prefix information. This solution ensures that private
UE\'s IP address/prefix information is only exposed to authorized peer UEs.
The peer UEs need to support exchange of E2E PC5-S Authentication and
Authorization Request messaging. The U2U Relay needs to support handling of
exchange of mutual authentication messages between the peer UEs and store the
authorization result. The Relay provides IP Discovery authorization result to
the requesting UE. The Relay replies to DNS Query with peer UE\'s IP
address/prefix information to the requesting UE if authorization is
successful.
This solution addresses:
\- Key Issue #3 (2^nd^ requirement): Authorization in the UE-to-UE Relay
Scenario
\- Key issue #4 (all requirements): Privacy of information over the UE-to-UE
Relay.
## 6.14 Solution #14: path switching with Layer-2 UE-to-UE Relay
### 6.14.1 Introduction
This contribution proposes a solution to address KI #2: Security of UE-to-UE
Relay and Key Issue #4: Privacy of information over the UE-to-UE Relay. Most
specifically, this contribution provides a solution for path switching between
two Layer-2 UE-to-UE Relays (i.e. relay re-selection).
This solution proposes to enable the preparation of the new security keys
between the Source UE and Target UE using the existing PC5 unicast link via
the first Relay and associated existing security association. The new security
keys are then used for the security of a new PC5 unicast link that the UEs
establish for path switching via a second relay. New security keys are
necessary since the K~NRP-sess~ is derived per unicast link as per TS 33.536,
clause 5.3.3.1.2.1.
As in the UE-to-Network Relay scenario, it is assumed that PC5 signalling
integrity security policy is set to \"REQUIRED\".
Details related to the establishment of the new security keys for the new PC5
unicast link using the existing security association from the existing PC5
unicast link are specified in the following clause.
### 6.14.2 Solution details
Figure 6.14.2-1 illustrates the high-level procedure of the proposed solution.
Figure 6.14.2-1: Layer-2 based UE-to-UE Relay Path Switching
  1. A PC5 unicast link is established between Source UE and Target UE > via Relay_1. Traffic is exchanged between the Source UE and the > Target UE over the PC5 unicast link, via Relay_1.
  2. Source UE triggers path switching, i.e. change of UE-to-UE Relay. > The Source UE has obtained a list of candidate UE-to-UE Relay IDs > (i.e. RIDs).
  3. Source UE sends a Link Modification Request message to Target UE > (via Relay_1) including a list of candidate RIDs and a source UE > link ID, which is used on the Source UE to associate the existing > PC5 unicast link via Relay_1 to the new PC5 unicast link with the > selected Relay (e.g. Relay_2). Security parameters (i.e. > nonce_1, MSB of K~NRP-sess~ ID) to enable the establishment of > new K~NRP-sess~ and its ID and security keys are included as well.
The Source UE link ID is a locally generated random number by the Source UE.
To avoid replay and linkability/trackability attacks across path switching
procedures, a new Source UE link ID is generated and used each time a new path
switch is initiated, i.e. each time a Link Modification message for path
switching is sent. To preserve the privacy of the transmitted ids (Source UE
link ID, MSB of K~NRP-sess~ ID) the Link Modification Request message is
protected for confidentiality, using current PC5 link security context.
4\. Target UE selects a Relay from the received list of candidate RIDs (e.g.
Relay_2). Target UE uses the security parameters received from Source UE in
the Link Modification Request message and its own security parameters to
generate a new K~NRP-sess~ (from current K~NRP~) and K~NRP-sess~ ID and new
security keys for the link to be established via the selected Relay. The new
keys are stored to be later located when a DCR message for new link
establishment is received (at step 8).
5\. Target UE sends a Link Modification Accept message to Source UE (via
Relay_1) including its selected RID and a Target UE link ID, which is used on
the Target UE to associate the existing PC5 unicast link via Relay_1 to the
new PC5 unicast link with the selected Relay (i.e. Relay_2). Target UE\'s
security parameters (i.e. nonce_2, LSB of K~NRP-sess~ ID) used to establish a
new K~NRP-sess~ and K~NRP-sess~ ID and new security keys for the link to be
established via the selected Relay are also included. The Target UE link ID is
generated as described for the Source UE link ID in step 3. To preserve the
privacy of the transmitted ids (Target UE link ID, LSB of K~NRP-sess~ ID) the
Link Modification Accept message is protected for confidentiality, using
current PC5 link security context.
6\. Source UE uses the security parameters received from the Target UE on the
Link Modification Accept message and its own security parameters to generate a
new K~NRP-sess~ (from current K~NRP~) and K~NRP-sess~ ID and new security keys
for the link to be established via the selected Relay. Source UE protects for
integrity the Target UE link ID using the new security keys.
7\. Source UE sends a broadcast Direct Communication Request (DCR) message
including the selected RID (i.e. Relay_2), Target UE link ID received from
Target UE at step 5. Relay_2 receives the DCR message and forwards it to
Target UE.
8\. Target UE receives the DCR message and uses the Target UE link ID to
locate the new security keys derived in step 4. Target UE uses the new
security keys to verify the integrity of the received Target UE link ID
parameter. A successful verification by the Target UE validates the new PC5
unicast link establishment request used for path switching. Target UE
associates the new security context with the new PC5 unicast link.
9\. Target UE sends a Direct Communication Accept message protected using the
new security context. Target UE includes the Source UE link ID from Source UE
as received at step 3 in the message. Relay_2 receives the DCA message and
forwards it to Source UE.
10\. Source UE verifies the security of the DCA message using the new security
keys. A successful verification by source UE completes the establishment of
the new PC5 unicast link used for path switching. Source UE associates the new
security context with the new PC5 unicast link.
11\. Source UE and Target UE use the newly established PC5 unicast link via
the Relay_2 for path switching.
### 6.14.3 Evaluation
This solution is based on the concluded negotiated L2 UE-to-UE Relay
reselection (see TS 23.700-33, clause 8.1).
This solution proposes to include security parameters in the E2E signalling
over the current relay, to derive security keys that are used for a fast setup
of the E2E security and switch over to the new UE-to-UE Relay.
Impact for the source and target UEs:
\- support preparation via current UE-to-UE Relay of the new security keys
between the Source UE and Target UE.
\- support skipping the Direct Authentication and Key Establish procedures via
the new UE-to-UE Relay by retrieving the new security key using Link ID.
There are no impact for the L2 UE-to-UE Relay as it only needs to perform
regular forwarding of the E2E LMR/LMA and DCR/DCA messages between peer UEs.
This solution addresses requirements of KI #2: Security of UE-to-UE Relay
requirements, including during UE-to-UE Relay re-selection (path switch).
This solution addresses requirements of KI #4: Privacy of information over the
UE-to-UE Relay, including during UE-to-UE Relay re-selection (path switch).
## 6.15 Solution #15: Selection and authorization of in-coverage and out-of-
coverage authentication and key establishment
### 6.15.1 Introduction
This solution addresses Key Issue #2 and Key Issue #3.
Different types of solutions and configurations may be available to establish
a secure and authorized PC5 communication link. For instance, Solution #3 and
#5 address in-coverage scenarios while Solution #4, #6 and #7 address out-of-
coverage scenarios, and Solution #10 may be used in both in-coverage and out-
of-coverage.
Since more than a single solution might be needed to address different
scenarios, it is required to determine which solution is allowed to be used
when. For instance, an out-of-coverage source UE might attempt to use a
solution for out-of-coverage when the UE-to-UE relay is in-coverage. In this
exemplary situation, the UE-to-UE relay should be able to determine, based on
a policy, that an in-coverage solution is (not) required and indicate this to
the source UE.
This solution describes the configuration of a policy that allows
source/target Ues and UE-to-UE relay to agree on the type of solution and
parameters that is preferred and/or authorized to be used.
### 6.15.2 Solution details
{width="6.695138888888889in" height="2.345138888888889in"}
Figure 6.15.2-1
The message flow and steps of this solution are as outlined in Figure
6.15.2-1.
\- In Step 0, the Ues perform an initial authorization and parameter
provisioning for in-coverage and out-of-coverage situations. This step
includes the configuration of parameters for different solutions for in-
coverage and out-of-coverage security establishment and authorization.
Note 1: The configured parameters for in-coverage and out-of-coverage solution
depend on the configured solution.
\- In Step 1, the source UE and UE-to-UE relay perform a discovery phase.
\- In Step 2, the source UE determines its out-of-coverage (in-coverage)
situation, and choses a security solution and/or security parameters for its
out-of-coverage (in-coverage) situation. This choice can be based on multiple
reasons, e.g. application requirements such as performance or an in-coverage
(out-of-coverage) indication received from the UE-to-UE relay during
discovery, etc. The source UE builds correspondingly a Direct Communication
Request based on the chosen out-of-coverage (in-coverage) solution and
security parameters.
\- In Step 3, the UE-to-UE relay receives the DCR message and determines
whether the DCR message either implicitly or explicitly contains parameters
for an out-of-coverage (in-coverage) solution. The UE-to-UE relay then checks
that the requested solution and security parameters fit its out-of-coverage
(in-coverage) situation and whether a policy deployed in Step 0 together with
any authorization information received in Step 2 allow the usage of said
solution and security parameters. Once this policy is evaluated and if the
result is positive, the UE-to-UE relay will proceed executing the requested
out-of-coverage (in-coverage) solution. Alternatively, if the result is
negative, the UE-to-UE relay may -- based on configuration -- indicate the
source UE policy mismatch, and potentially request a different DCR message
including a requested solution and security parameters.
\- In Step 4, the UE-to-UE relay may take one of the following alternative
steps:
\- Step 4-A, send a message to the Source UE to go on with an in-coverage
solution.
\- Step 4-B, send a message to the core network to go on with an out-coverage
solution.
\- Step 4-C, send a message to the Source UE indicating that the security
establishment based on the exchanged parameters is not feasible and requesting
alternative parameters.
Note 2: The above steps can be repeated for the security establishment process
and authorization between Target UE and UE-to-UE relay.
Note 3: The above process illustrates how Ues signal and agree on solution and
security parameters to use by means of the DCR message. This signalling and
agreement phase might also be carried out in the discovery phase.
This solution requires a policy to choose the In-Coverage or Out-of-Coverage
solution to use. This policy might include:
\- Which of the supported solutions or solution parameters are preferred when
in-coverage and/or when out-of-coverage.
\- Whether/how security parameters (e.g. a password, or a key, etc) of an out-
of-coverage solution may be entered when devices are out-of-coverage.
### 6.15.3 Evaluation
This solution coordinates the selection and authorization of in-coverage and
out-of-coverage authentication and key establishment procedures, and thus,
supports Key Issue #2 and Key Issue #3.
This solution allows the UEs (Source/Target/Relay) to support multiple
security methods (i.e. for In-Coverage and Out-of-Coverage). UEs are required
to support both In-Coverage and Out-of-Coverage mechanisms if they intend to
work under both scenarios. The 5G ProSe Source/Target and UE-to-UE relay need
to have the logic and a new policy to choose between the In-Coverage dedicated
mechanism and the Out-of-Coverage dedicated mechanism before/during the direct
communication establishment procedures.
## 6.16 Solution #16: Centralized discovery key management and U2U relay
authorization
### 6.16.1 Introduction
This solution addresses Key Issue #1: Security for UE-to-UE Relay discovery
and Key issue #3: Authorization in the UE-to-UE Relay Scenario. For Key Issue
#1, this solution specifically addresses the security requirement:
_The 5G System shall provide a means to securely provision the security
materials for UE-to-UE Relay discovery._
This solution assumes that the discovery security materials used for direct
discovery and U2U relay discovery are different. Therefore, U2U relay
authorization can be executed during the U2U relay discovery key provision
process. Otherwise this solution does not address the Key Issue #3.
This solution needs to extend the existing specification as follows:
\- Permit multiple roles in the restricted discovery request. (Currently,
there is only one role (Announce, Monitor, Query or Response) in the
restricted discovery request.)
U2U relay communication is carried out without the participation of the
operators\' networks, and the UEs involved can come from different PLMNs. If
the discovery security materials are provisioned by different PLMNs, such as
5G DDNMF or PCF, the key management may be too complex. This solution assumes
that only one ProSe Key Management Function (PKMF) is responsible for
provisioning discovery security materials for direct discovery, U2U relay
discovery or both. This solution does not prevent multiple PKMFs in a U2U
relay communication system. For example, one or more PKMs are used for direct
discovery, and one or more PKMFs are used for RSC specific U2U relay
discovery. However, there is no interaction between PKMFs. Any interaction
between PKMFs needs to be implemented in the application layer.
The PKMF in this solution is also called 5G U2U Relay PKMF to distinguish it
from other kinds of PKMFs. A 5G U2U Relay PKMF can provision various discovery
security materials based on a 5G ProSe UE\'s roles in U2U relay discovery
procedures.
### 6.16.2 Solution details
Figure 6.16.2-1: Centralized discovery key management and U2U relay
authorization procedure
Note 1: This solution only covers the parameters related to security material
retrieval.
Note 2: The U2U relay discovery security materials are used to protect U2U
discovery messages. The direct discovery security materials are used to
protect the direct discovery set in the U2U discovery messages.
0\. The 5G ProSe UE (Source UE/Target UE/Relay UE) gets the address of the 5G
U2U Relay PKMF from the PCF of its HPLMN, which is responsible for
provisioning discovery security materials related to direct discovery and U2U
relay discovery. The direct discovery security materials can also be
provisioned to the Source UE and Target UE using the approaches specified in
clause 6.1.3.2 of TS 33.503 [5].
1\. The 5G ProSe UE establishes a secure connection with the 5G U2U Relay PKMF
and sends a U2U Relay Discovery Key Request to the 5G U2U Relay PKMF. The
request includes User Info ID, RSC, Security capability, and UE\'s roles in
RSC-specified relay service.
Security for the interface between the 5G ProSe UE and the 5G U2U Relay PKMF
relies on Ua security if GBA specified in TS 33.220 [14] is used (see clause
5.2.3.4) or Ua* security if AKMA specified in TS 33.535 [15] is used (see
clause 5.2.5.4).
In U2U relay discovery, a UE can be the role of Announcing UE or Monitoring UE
in Model A, or the role of Discoveree UE or Discoverer UE in Model B.
2\. 5G U2U Relay PKMF checks whether the 5G ProSe UE is authorized to play
these roles in RSC-specified relay service.
3\. The 5G U2U Relay PKMF provides a set of discovery security materials
corresponding to the authorized roles to the 5G ProSe UE through U2U Relay
Discovery Key Response. The discovery security materials related to U2U relay
discovery are associated with the RSC. The 5G U2U Relay PKMF may include relay
discovery security policies specifying how the provided security material is
used in the U2U relay discovery procedure in the response. For example, a
security policy can specify whether end-to-end protection needs to be enabled
in relay discovery messages.
### 6.16.3 Evaluation
Solution #16 addresses the third security requirement of key issue #1 and Key
issue #3.
This solution allows the UE to provide multiple roles that it can play in U2U
relay communication in the security material request; so that all discovered
security materials can be obtained at one time.
This solution assumes that there is only one PKMF involved in a security
material provision process for direct discovery, U2U relay discovery or both.
Therefore, there is no interaction between PKMFs if there are more PKMFs
involved in a U2U relay communication system. If interaction between PKMFs is
required, it needs be implemented in the application layer. The address of the
PKMF is provided to UE by its HPLMN.
The U2U relay authorization check is done by the PKMF during discovery
security materials provision process. The PKMF checks whether a UE can play
its claimed roles, and then provisions corresponding discovery security
materials to the UE. This solution assumes that the discovery security
materials provisioned for direct discovery and U2U relay discovery are
different.
The U2U relay authorization check method is not applicable if the discovery
security materials are not used in the procedure of discovery is integrated
into the PC5 unicast link establishment.
## 6.17 Solution #17: U2U relay discovery security material retrieval and
authorization across PLMNs
### 6.17.1 Introduction
This solution addresses Key Issue #1: Security for UE-to-UE Relay discovery
and Key issue #3: Authorization in the UE-to-UE Relay Scenario. For Key Issue
#1, this solution specifically addresses the security requirement:
_The 5G System shall provide a means to securely provision the security
materials for UE-to-UE Relay discovery._
This solution assumes that the discovery security materials used for direct
discovery and U2U relay discovery are different. Therefore, U2U relay
authorization can be executed during the U2U relay discovery key provision
process. Otherwise this solution does not address the Key Issue #3.
This solution needs to extend the existing specification as follows:
\- Permit multiple roles in the restricted discovery request. (Currently,
there is only one role (Announce, Monitor, Query or Response) in the
restricted discovery request.)
\- Permit to return more than two sets security materials in the restricted
discovery response. (Currently, the restricted discovery response can return
code-sending-security-parameter, code-receiving-security-parameter or both.
This solution assumes that multiple ProSe Key Management Functions (PKMFs) are
used to generate and provision discovery security materials for direct
discovery and U2U relay discovery. The PKMF in this solution is also called 5G
U2U Relay PKMF to distinguish it from other kinds of PKMFs. A 5G U2U Relay
PKMF can provision various discovery security materials based on a 5G ProSe
UE\'s roles in U2U relay discovery procedures. 5G ProSe UEs will always
retrieve discovery security materials from one 5G U2U Relay PKMF which address
is provided by the PCF or 5G DDNMF. It is possible for a 5G U2U Relay PKMF to
retrieve discovery security materials from other 5G U2U Relay PKMFs.
### 6.17.2 Solution details
Figure 6.17.2-1: U2U relay discovery security material retrieval and
authorization procedure across PLMNs
Note 0: This solution only covers the parameters related to security material
retrieval.
0\. The 5G ProSe UE (Source UE/Target UE/Relay UE) gets the address of 5G
DDNMF/5G U2U Relay PKMF from the PCF of its HPLMN, which is responsible for
provisioning discovery security materials related to direct discovery and U2U
relay discovery.
NOTE 1: U2U relay discovery materials are provisioned by the 5G DDNMF or 5G
U2U Relay PKMF can be determined in the conclusion phase or the normative work
phase.
1\. The 5G ProSe UE establishes a secure connection with the 5G DDNMF/5G U2U
Relay PKMF in its HPLMN and sends a U2U Relay Discovery Key Request to the 5G
DDNMF/5G U2U Relay PKMF. The request includes User Info ID, Security
capability, and UE\'s roles in RSC-specified relay service. The request should
include RSC if discovery security materials for U2U relay discovery are
required.
Security for the interface between the 5G ProSe UE and the 5G DDNMF/5G U2U
Relay PKMF relies on Ua security if GBA specified in TS 33.220 [14] is used
(see clause 5.2.3.4) or Ua* security if AKMA specified in TS 33.535 [15] is
used (see clause 5.2.5.4).
In U2U relay discovery, a UE can be the role of Announcing UE or Monitoring UE
in Model A, or the role of Discoveree UE or Discoverer UE in Model B.
2\. The 5G DDNMF/5G U2U Relay PKMF in the HPLMN may need to send an
Authorization Check Request to the UDM/ProSe App Server to check whether the
UE is allowed to play its declared roles. The request includes User Info ID
and the role list. The request should include RSC if discovery security
materials for U2U relay discovery are required.
NOTE 2: Authorization check of U2U relay discovery is performed by the UDM or
ProSe App Server can be determined in the conclusion phase or the normative
work phase.
3\. The UDM/ProSe App Server checks whether the UE is allowed to play the
roles it claims, and returns the allowed roles through Authorization Check
Request
4\. If the security materials for the roles are not available locally, the 5G
DDNMF/5G U2U Relay PKMF in the HPLMN may need to send an U2U Relay Discovery
Key Request to another 5G DDNMF/5G U2U Relay PKMF in a VPLMN to obtain the
security materials. The request includes User Info ID and role list. The
request should include RSC if discovery security materials for U2U relay
discovery are required.
5-6. The 5G DDNMF/5G U2U Relay PKMF in the VPLMN may need to send an
Authorization Check Request to the UDM/ProSe App Server to check whether the
UE is allowed to play its declared roles.
7\. The 5G DDNMF/5G U2U Relay PKMF in the VPLMN gets the discovery security
materials for the allowed roles in the RSC-specific U2U relay service, and
returns them through U2U Relay Discovery Security Material Response. The
discovery security materials related to U2U relay discovery are associated
with the RSC. The 5G DDNMF/5G U2U Relay PKMF may include relay discovery
security policies specifying how the provided security material is used in the
U2U relay discovery procedure in the response. For example, a security policy
can specify whether end-to-end protection needs to be enabled in relay
discovery messages.
8\. The 5G DDNMF/5G U2U Relay PKMF in the HPLMN returns the discovery security
materials obtained from the local and other PLMNs to the UE through U2U Relay
Discovery Key Response. The discovery security materials related to U2U relay
discovery are associated with the RSC. If there are Relay Discovery Security
Policies for the RSC-specific U2U relay service, the 5G DDNMF/5G U2U Relay
PKMF includes these policies in the response.
### 6.17.3 Evaluation
Solution #17 addresses the third security requirement of key issue #1 and Key
issue #3.
This solution allows the UE to provide multiple roles that it can play in U2U
relay communication in the security material request; so that all discovered
security materials can be obtained at one time.
This solution assumes that there may be multiple PKMFs/5G DDNMFs involved in a
security material provision process for direct discovery, U2U relay discovery
or both. This solution supports interaction between multiple PKMFs/5G DDNMFs.
The address of the PKMF is provided to UE by its HPLMN.
The U2U relay authorization check is done by the PKMF/5G DDNMF during
discovery security materials provision process. The PKMF/5G DDNMF checks
whether a UE can play its claimed roles, and then provisions corresponding
discovery security materials to the UE. This solution assumes that the
discovery security materials provisioned for direct discovery and U2U relay
discovery are different.
The U2U relay authorization check method is not applicable if the discovery
security materials are not used in the procedure of discovery is integrated
into the PC5 unicast link establishment.
## 6.18 Solution #18: UE-to-UE Relay security
### 6.18.1 Introduction
This solution addresses Key Issue #2: Security of UE-to-UE Relay.
This solution uses PC5 security mechanism defined in in TS 33.536 [9] for the
security between Remote UE and Relay UE.
This solution uses IPsec for the security between Remote UEs in Layer-3 UE-to-
UE Relay scenario.
This solution uses PC5 security mechanism defined in TS 33.536 [9] for the
security between Remote UEs in Layer-2 UE-to-UE Relay scenario.
### 6.18.2 Solution details
Figure 6.18.2-1: UE-to-UE relay security procedure
0\. The Source UE, Relay UE and Target UE discover each other, and then
establish connections between them. This solution does not address the key
issue of U2U relay discovery security.
1\. According to the PC5 security policies provisioned by the PCFs of the
Source/Target/Relay UEs or the application layer, the Source UE and Target UE
may use the unicast mode security mechanism defined in clause 5.3 of TS 33.536
[9] to establish secure connections with the Relay UE respectively.
NOTE 1: Whether the hop-by-hop link security is implemented between the source
UE and the relay UE and between the target UE and the relay UE is controlled
by the PC5 security policies provisioned to the Source, Target and Relay UEs.
This process is independent of E2E security between the source UE and the
target UE. In order to avoid unnecessary excessive security, appropriate PC5
security policies should be designed for source, target and relay UEs.
2\. For the Layer-3 UE-to-UE relay scenario, establishing a secure connection
between the Source UE and the Target UE is out of the scope of 3GPP.
For the Layer-2 UE-to-UE relay scenario, the Source UE and the Target UE can
reuse the unicast mode security mechanism defined in clause 5.3 of TS 33.536
[9] to establish a secure connection via the Relay UE.
NOTE 2: How the Layer-2 link is established between the Source UE and the
Target UE via a Relay UE can align with the decision of RAN WGs during
normative work.
### 6.18.3 Evaluation
Solution #18 addresses the key issue #2.
This solution proposes that the Source UE and Target UE reuse the security
mechanism defined in clause 5.3 of TS 33.536 [9] to establish secure
connections with the Relay UE respectively.
For the Layer-3 UE-to-UE relay scenario, this solution proposes that
establishing a secure connection between the Source UE and the Target UE is
out of the scope of 3GPP.
For the Layer-2 UE-to-UE relay scenario, this solution proposes that the
Source UE and Target UE reuse the security mechanism defined in clause 5.3 of
TS 33.536 [9] to establish a secure connection via the Relay UE.
## 6.19 Solution #19: End-to-end security establishment over the UE-to-UE
Relay
### 6.19.1 Introduction
This solution addresses Key Issue #2, #3, and #5. When Source/Target UEs and a
Relay UE are in the network coverage, they are authorized and provisioned with
the required information for security establishments during the registration
procedure that includes the primary authentication (i.e. 5G-AKA or EAP-AKA\').
The Source UE sends a Direct Communication Request to the Target UE over the
UE-to-UE Relay, so that the direct authentication takes place and the end-to-
end protection key is established regardless of whether the UEs (the Source
UE, Target UE and/or UE-to-UE Relay) are within or outside the network
coverage. This solution applies to both Layer-2 UE-to-UE Relay and Layer-3 UE-
to-UE Relay.
### NOTE: The need of end-to-end security in Layer-3 solution is not addressed
in the present document.6.19.2 Solution details
#### 6.19.2.1 End-to-end security establishment procedure over the L3 UE-to-UE
Relay
Figure 6.19.2.1-1 illustrates the end-to-end security establishment procedure
between the Source UE and the Target UE over the UE-to-UE Relay.
Figure 6.19.2.1-1: End-to-end security establishment procedure over the UE-to-
UE Relay
  1. The Source UE, Target UE, and UE-to-UE Relay are authorized and provisioned with the security materials for the hop-by-hop and/or end-to-end security establishment (refer to clause 6.19.2.3).
  2. The discovery and selection procedure may be performed between the Source UE, Target UE, and UE-to-UE Relay using Model A or Model B mode as specified in TS 23.304 [2]. If discovery integrated into PC5 unicast link establishment procedure concluded by SA2 in TR 23.700-33 [3] is to be performed in the following steps, this step is skipped.
  3. There are various authentication and key establishment methods to be used between the Source UE and the Target UE over a UE-to-UE Relay. Hence, all the authentication is specified to be carried in a generic container called Auth_Key_Info in the following steps.
The Source UE generates ephemeral public key (UE1.ePK) and private key
(UE1.eSK), and a digital signature (UE1.Sig). The digital signature is signed
over the source UE\'s identity (UE1.ID) and UE1.ePK using the security
materials provisioned in step 0. Then, the Source UE generates
UE1.Auth_Key_Info which includes UE1.ID, UE1.ePK, and UE1.Sig.
  1. The Source UE wants to establish a secure unicast link with the Target UE via the UE-to-UE Relay. The Source UE sends the UE-to-UE Relay a Direct Communication Request message including Relay Service Code (RSC), its Auth_Key_Info, and relay_indication which is enabled if discovery integrated into PC5 unicast link establishment procedure is used. The message also includes the security capabilities and PC5 signalling security policy.
NOTE 1: The relay_indication is a newly proposed field in Sol#1 for KI#1 from
TR 23.700-33 [3], which is concluded to be used as basis for normative phase
in SA2, to indicate whether a relay can be used in the communication and to
integrate the relay discovery/selection into the unicast link establishment
procedure.
  1. The UE-to-UE Relay receives the Direct Communication Request and forwards the message to the Target UE with the relay_indication disabled.
  2. Upon reception of the Direct Communication Request message, the Target UE verifies the Source UE with UE1.Sig included in UE1.Auth_Key_Info using the security materials provisioned in step 0. If the verification is successful and the Target UE decides to accept the request, the Target UE generates ephemeral public key (UE2.ePK) and private key (UE2.eSK), and a digital signature (UE2.Sig). The digital signature is signed over the Target UE\'s identity (UE2.ID) and UE2.ePK using the security materials provisioned in step 0. Then, the Target UE generates UE2.Auth_Key_Info which includes UE2.ID, UE2.ePK, and UE2.Sig.
In this step, the Target UE derives a symmetric key that is used to protect
the end-to-end link (i.e. end-to-end protection key), using the Source UE\'s
ephemeral public key (UE1.ePK) and its own ephemeral private key (UE2.eSK).
  1. In this step, the PC5 unicast link security can be established between the Target UE and the UE-to-UE Relay as defined in clause 5.3 of TS 33.536 [3].
NOTE 2: This solution focuses on the end-to-end security establishment between
the Source UE and the Target UE, as the hop-by-hop security between the
Source/Target UE and the UE-to-UE Relay can be established by Solution #29 in
this specification.
  1. The Target UE sends the UE-to-UE Relay a Direct Communication Accept message including RSC and its Auth_Key_Info.
  2. In this step, the PC5 unicast link security can be established between the Source UE and the UE-to-UE Relay as defined in clause 5.3 of TS 33.536 [3].
  3. The UE-to-UE Relay receives the Direct Communication Accept and forwards the message to the Source UE.
  4. Upon reception of the Direct Communication Accept message, the Source UE verifies the Target UE with UE2.Sig included in UE2.Auth_Key_Info using the security materials provisioned in step 0. If the verification is successful, the Source UE derives a symmetric key that is used to protect the end-to-end link (i.e. end-to-end protection key), using the Target UE\'s ephemeral public key (UE2.ePK) and its own ephemeral private key (UE1.eSK).
  5. The Source UE and the Target UE finish setting up the secure communication link over the UE-to-UE Relay with the shared end-to-end protection key. To suffice the security policies, the IPsec Security Association (SA) can be established between the Source UE and the Target UE by using the end-to-end protection key. With IPsec operating on the IP layer, the IP packets are end-to-end protected between the Source UE and the Target UE over the Layer-3 UE-to-UE Relay.
#### 6.19.2.2 End-to-end security establishment procedure over the L2 UE-to-UE
Relay
The Source UE and the Target UE establish end-to-end security for PC5
connection with the end-to-end protection key shared using the same mechanism
(from step 0 to step 10) specified in clause 6.19.2.1. The encryption key and
integrity key are derived from the end-to-end protection key and used in the
chosen confidentiality and integrity algorithms, respectively. Then, at the
PDCP layer, the signalling and user plane data are end-to-end protected
between the Source UE and the Target UE over the Layer-2 UE-to-UE Relay.
#### 6.19.2.3 Authorization and Parameter Provisioning to the UEs
The Source/Target UE and the UE-to-UE Relay are authenticated and authorized
to receive or provide UE-to-UE Relay service by the network during the primary
authentication procedure (i.e. 5G AKA or EAP-AKA\'). A UE initiates the
procedure by sending a Registration Request message to the network. In the
meanwhile, the UDM checks the subscription information, called UE-to-UE
indication, related to the UE-to-UE Relay service. The UE-to-UE indication of
the Source/Target UE indicates:
\- Whether the Source/Target UE is authorized to receive the UE-to-UE Relay
service;
And the UE-to-UE indication of the UE-to-UE Relay indicates:
\- Whether the UE-to-UE Relay is authorized to provide the UE-to-UE Relay
service.
The UE-to-UE indication is transferred from the UDM to the AUSF, and is
forwarded to the UE along with the AKA challenge. Upon reception of the UE-to-
UE indication, which allows the UE to receive or provide the UE-to-UE Relay
service, the UE provides UE-to-UE_Auth_Info, which can be used by the AUSF to
generate security materials for the end-to-end security establishment, to the
network along with the AKA challenge response. In the Certificate-based
approach, the UE generates a public and private key pair, and generate UE-to-
UE_Auth_Info including the UE\'s ID and the generated public key. In the
Identity-based approach, the UE generates UE-to-UE_Auth_Info including the
UE\'s ID.
NOTE 1: Which identifier is to be used as a UE's ID is not addressed in the
present document.
Note 2: How and which entity associates UE's ID with the U2U relay service is
not addressed in the present document.
Note 3: AUSF impact for generating and provisioning security materials to UEs
is not addressed in the present document.
Note 4: How to support U2U relay services across multiple PLMNs is not
addressed in the present document.
If UE-to-UE indication allows the UE to receive or provide the UE-to-UE Relay
service, the AUSF generates the security materials using the UE-to-
UE_Auth_Info and provisions them to the UE. The provisioned security materials
are used as long term credentials of the UE. The authorized UE is provisioned
with the security materials when it has not been provisioned with the security
materials before or when the validity of the security materials has been
expired.
Note 5: The security materials provisioned to the UE by the network are
associated with an expiration time after which they become invalid. If the UE
does not have valid security materials, the UE needs to obtain fresh ones to
receive or provide the UE-to-UE Relay service.
In the Certificate-based approach, the security materials include the UE\'s
certificate and the root CA certificate(s), which allows the UE to verify the
certificates of other UEs. In the Identity-based approach, the security
materials include the UE\'s identity, secret signing key (SSK), public
validation token (PVT), and KMS public authentication key(s) (KPAK), which
allows the UE to verify the signatures of other UEs.
If the UE is authorized to receive or provide UE-to-UE service based on UE-to-
UE indication, PCF provides the security policy/parameters to the UE. The
security policy/parameters of the Source/Target UE related to the UE-to-UE
Relay service includes Hop-by-hop Security Indicator per RSC and End-to-end
Security Indicator per RSC. The security policy/parameters of the UE-to-UE
Relay related to the UE-to-UE Relay service includes Hop-by-hop Security
Indicator per RSC:
\- The Hop-by-hop Security Indicator indicates whether the Source/Target UE
requires the hop-by-hop security (signalling integrity, signalling
confidentiality, user plane integrity, and user plane confidentiality)
establishment with the UE-to-UE Relay, or not;
\- The End-to-end Security Indicator indicates whether the Source/Target UE
requires the end-to-end security (signalling integrity, signalling
confidentiality, user plane integrity, and user plane confidentiality)
establishment, or not.
The same hop-by-hop and/or end-to-end protection schemes are supported for the
Source UE, Target UE and UE-to-UE Relay provisioned with the same Hop-by-hop
Security Indicator and/or End-to-end Security Indicator by a service level to
protect the UE-to-UE relay traffic.
### 6.19.3 Evaluation
This solution supports authorization and provisioning of the Source/Target UE
and UE-to-UE Relay for the UE-to-UE Relay Communication service when the UEs
are in the network coverage.
This solution proposes the end-to-end security establishment procedure between
the Source UE and the Target UE over the Layer-2 or Layer-3 UE-to-UE Relay
using the provisioned security materials, both within and outside the network
coverage.
This solution employs a generic container, which allows different
authentication and key establishment mechanisms such as certificate-based one
and identity-based one to be applied, for the end-to-end security
establishment. For example, the \"Elliptic Curve-based Certificateless
Signatures for Identity-based Encryption\" (ECCSI) can be used for the
identity-based direct authentication and key establishment as described in
clause 6.5.7 of TS 33.303 [5].
This solution supports a means for the UEs to agree on the same end-to-end
security protection schemes in UE-to-UE Relay service.
The solution requires 5GC to support means of managing security materials,
such as certificates and UEs\' identities, and this may introduce additional
complexities on AUSF, AMF, etc.
## NOTE: Further evaluation is needed.6.20 Solution #20: Network-assisted
security establishment procedure for 5G ProSe Layer-3 UE-to-UE Relay
### 6.20.1 Introduction
The solution addresses Key Issue #2: Security of UE-to-UE Relay. It largely
reuses the mechanism of UE-to-Network Relay Security Establishment procedure
defined in TS 33.503 [6] to ensure the security of UE-to-UE Relay
Communication.
In the UE-to-UE relay scenario, two options (Layer-2 UE-to-UE Relay and
Layer-3 UE-to-UE Relay) are under consideration. For Layer-3 UE-to-UE Relay,
the full security of a UE-to-UE PC5 link depends on the security of two
separate PC5 links, i.e. the link between the Source UE and UE-to-UE Relay and
the link between UE-to-UE Relay and Target UE. The security of these two
separate PC5 link relies on the UE-to-UE Relay\'s security materials, which
are provided by the network after passing the authorization check. With the
assistance of network, the UE-to-UE PC5 link via 5G ProSe Layer-3 UE-to-UE
Relay can be securely established.
### 6.20.2 Solution details
{width="6.684027777777778in" height="8.138194444444444in"}Figure 6.20.2-1:
Network-assisted PC5 link security establishment procedure for 5G ProSe
Layer-3 UE-to-UE Relay
1a. The Source UE/Target UE sends a Prose Key Request message to its 5G PKMF.
The message indicates that the Source UE/Target UE is requesting a PRUK from
the 5G PKMF.
1b. The 5G PKMF checks (or checks with the ProSe Server) that the Source
UE/Target UE is authorized to receive U2U relay services. If the Source
UE/Target UE is authorized to receive the service, the 5G PKMF sends a PRUK to
the Source UE/Target UE and stores the UE identity associated with PRUK. If a
PRUK is included, the Source UE/Target UE stores the new one and deletes any
previously stored ones for this 5G PKMF.
NOTE a: It is not addressed in the present document about how the interface
between PKMF and Prose Server is achieved.2. The Discovery & Relay Selection
procedure is performed between the peer UEs and the UE-to-UE Relay.
NOTE 1: It is assumed that after the Discovery & Relay Selection procedure,
the Source UE and the Target UE can discover each other by selecting the same
UE-to-UE Relay.
3\. The Source UE sends a Direct Communication Request that contains the User
Info ID of Source UE, User Info ID of U2U Relay, User Info ID of Target UE,
Source UE\'s security capabilities, RSC and nonce 1 to the UE-to-UE Relay.
Note 2: Whether the protection of User info ID is needed is not addressed in
the present document.
Note 3: Which identifier is used as a source UE/target UE ID is not addressed
in the present document.
Note 4: How a U2N relay knows Target UE ID is not addressed in the present
document.
4a.The U2U Relay sends a U2U Key Request message that contains Source UE ID,
RSC, Knrp freshness parameter 1 to its 5G PKMF, indicating that the U2U Rely
is requesting the Knrp between the Source UE and U2U Relay.
4b. Once receiving the U2U Key Request message, the 5G PKMF of U2U Relay
checks if the U2U Relay is authorized to provide U2U Relay service. If the U2U
Relay is authorized, the 5G PKMF of U2U Relay sends the U2U Key Request to the
5G PKMF of the Source UE, which may contain the Source UE ID, RSC and the Knrp
freshness parameter 1.
Once receiving the U2U Key Request message, the 5G PKMF of Source UE
identifies the PRUK of Source UE based on the received Source UE ID, then
generates Knrp freshness parameter 2 and derives Knrp as specified in TS
33.503 [6]. The 5G PKMF of Source UE sends a U2U Key Response message that
contains Knrp and Knrp freshness parameter 2.
Note 5: It is not addressed in the present document about how PKMF discovers
each other based the Application layer UE IDs.
4c. The 5G PKMF of U2U Relay forwards the Knrp and the Knrp freshness
parameter 2 to the U2U Relay, by sending the U2U Key Response message.
Note 6: How to provide credential in the CP based security procedure is not
addressed in the present document.
NOTE 7: In this solution, the U2U relay is in the network coverage.
5\. The UE-to-UE Relay derives the session key (K~NRP-SESS~) from K~NRP~ and
then derives the confidentiality key (NRPEK) (if applicable) and integrity key
(NRPIK) based on the PC5 security policies as specified in TS 33.503 [6]. The
UE-to-UE Relay sends a Direct Security Mode Command message to the Source UE.
This message also includes the chosen security algorithm and nonce 2.
6\. The Source UE responds with a Direct Security Mode Complete message to the
5G ProSe UE-to-UE Relay.
Steps 7a-7c are performed to generate the Knrp between the Target UE and U2U
Relay. The details of steps 7a-7c are the same as the details of steps 4a-4c.
8\. Based on the User Info ID or Layer-2 ID of Target UE obtained after the
UE-to-UE Relay discovery, the UE-to-UE Relay sends a Direct Communication
Request that contains the User Info ID of Source UE, User Info ID of U2U
Relay, User Info ID of Target UE , the Chosen security algorithm, RSC, Knrp
freshness parameter 1\', Knrp freshness parameter 2\' and nonce 1 _\'_ to the
Target UE.
Note 9: Security risk of U2U generating Knrp freshness parameter 1' on behave
of target UE (step 7a, 8) is not addressed in the present document.
9\. The Target UE derives the session key (K~NRP-SESS _\'_ ~) from K~NRP _\'_
~ and derives the confidentiality key (NRPEK _\'_) (if applicable) and
integrity key (NRPIK\') based on the PC5 security policies as specified in TS
33.503 [6]. The Target UE sends a Direct Security Mode Command message to the
UE-to-UE relay. This message also includes the nonce 2 _\'_.
10\. The UE-to-UE Relay responds with a Direct Security Mode Complete message
to the Target UE.
11\. The Target UE sends the Direct Communication Accept message to the UE-to-
UE Relay.
12\. Only after receiving the Direct Communication Accept message from the
Target UE, the UE-to-UE Relay then responds the Direct Communication Accept
message to the Source UE.
13\. The secure L3 PC5 link between the Source UE and the Target UE via the
UE-to-UE Relay is established. The UE-to-UE Relay can forward the traffic
between the peer Prose UEs.
### 6.20.3 Evaluation
This solution only works when the UE-to-UE relay is located within network\'s
coverage area. This solution requires user plane message interactions with the
network.
Note: Further evaluation is needed.
## 6.21 Solution #21: E2E security establishment procedure for 5G ProSe
Layer-3 UE-to-UE Relay
### 6.21.1 Introduction
The solution addresses Key Issue #2: Security of UE-to-UE Relay. It largely
reuses the IKEv2 protocol and the mechanism of Direct Security Establishment
procedure defined in TS 33.503 [6] to ensure the end-to-end security between
the Source UE and Target UE.
After the per-hop links (i.e. the PC5 link between Source UE and UE-to-UE
Relay, as well as the PC5 link between UE-to-UE Relay and Target UE) are
established, the peer UEs may exchange their security materials and associate
the end-to-end security keys to establish E2E security. The Source UE and
Target UE perform the IKEv2 protocol, which enables the end-to-end security in
the UE-to-UE relay communication.
### 6.21.2 Solution details
{width="4.166666666666667in" height="3.4368055555555554in"}
Figure 6.21.2-1: PC5 link security establishment procedure for 5G ProSe
Layer-3 UE-to-UE Relay
1\. The Discovery & Relay Selection procedure is performed between the peer
UEs and the UE-to-UE Relay.
2\. The Source UE initiates the PC5 link setup with UE-to-UE Relay by
performing the Direct Communication procedures specified in TS 33.503 [6].
3\. After the PC5 link between the Source UE and UE-to-UE Relay is
established, the UE-to-UE Relay initiates the PC5 link setup with the Target
UE based on the Direct Communication procedure specified in TS 33.503 [6].
4\. The Source UE sends E2E Direct Communication Request to the Target UE,
which is forwarded by the Layer-3 U2U relay. The E2E Direct Communication
Request is protected by the NRPIK/NRPEK of each hop (i.e. the link between
Source UE and Layer-3 U2U Relay and the link between Layer-3 U2U Relay and
Target UE).
5\. [Optional]The Target UE initiates the security negotiation procedure with
the Source UE to establish an end-to-end IPSec connection by performing IKEv2
authentication procedure. After the IKEv2 authentication, the Source UE and
the Target UE generate the E2E security keys. The details of IKEv2 protocol is
out of the scope of 3GPP.
NOTE: The detail of IKEv2 protocol is out of the scope of 3GPP.
6\. The Target UE responds with the E2E Direct Communication Accept forwarded
by the Layer-3 U2U Relay. The E2E Direct Communication Accept is protected by
the E2E security keys generated in step 5.
7\. The End-to-End PC5 link between the Source UE and the Target UE via the
UE-to-UE Relay is established. The UE-to-UE Relay can forward the traffic
between the peer UEs.
### 6.21.3 Evaluation
This solution ensures that the Source End UE can establish the E2E security
with Target End UE via Layer-3 UE-to-UE relay.
If the E2E PC5 link is needed, the E2E security is established after the hop-
by-hop security. The IKEv2 protocol is performed between Source End UE and
Target End UE to establish the E2E security. The detail of IKEv2 protocol is
out of the 3GPP scope.
## 6.22 Solution #22: Common security protection setup via UE-to-UE Relay
### 6.22.1 Introduction
This solution addresses security requirement for the U2U relay and the remote
UEs to use a common security protection scheme in key issue #5.
The solution reuses existing provisioning, discovery, authentication,
authorization, and PC5 establishment procedures as much as possible. Once
Source and Target UEs and U2U relay have been authenticated and authorized, a
common protection scheme is applied among Source UE, Target UE, and U2U relay
so that the communication between Source UE and Target is protected either
using hop-by-hop via the U2U relay or end-to-end between the source and target
UEs.
### 6.22.2 Solution details
{width="3.7243055555555555in" height="2.517361111111111in"}
Figure 6.22.2.1: Security establishment for UE-to-UE relay
1\. While still in network coverage, the source UE, target UE and the U2U
relay get the discovery parameters. The source and target UEs can be
provisioned with the security materials for PC5 security setup or end-to-end
security setup. Additionally, source UE, target UE and U2U relay can be
provisioned with security policy for the protection scheme to be used for
communication between source UE and target UE.
0\. The Source UE, Relay UE and Target UE discover each other. This solution
does not address the key issue of U2U relay discovery security.
1a. During PC5 link setup procedure between source UE and U2U relay, based on
security policy of either the source UE or U2U relay, the PC5 link setup may
include security establishment between the source UE and U2U relay. The PC5
link establishment procedure may need to be enhanced to indicate that which
security is to be applied. If the security policy (e.g. flag or indicator to
use hop-by-hop) of the source UE is to use hop-by-hop security protection,
source UE indicates to the U2U relay by a Direct Communication Request
followed by a Direct Authorization and Key procedure.
If the security policy of the U2U relay is the same as the source UE, the U2U
relay continues with and completes the PC5 link setup procedure, including the
Direct Security Mode procedure. This means that the PC5 link setup includes
security establishment, and that hop-by-hop security is intended. Otherwise,
the source UE and U2U relay only set up the PC5 without security protection.
Since both source UE and U2U relay are aware of the security protection to be
used (e.g. hop-by-hop), the U2U relay repeats the process with target UE.
NOTE: U2U relay may override the security policy of the source UE, for
example, if U2U relay is unable to support hop-by-hop security due to capacity
reasons such as being low in power.
1b. During PC5 link setup procedure between target UE and U2U relay, U2U relay
is aware of the security protection scheme to be used between source UE and
U2U relay. U2U relay proceeds to setup PC5 link with target UE with the same
protection scheme as the one between source UE and U2U relay. If hop-by-hop
security protection is already established between source UE and U2U relay,
the PC5 link setup includes security establishment between the target UE and
U2U relay. If the security policy of the target UE is to use end-to-end
security, target UE may reject the PC5 link setup by including an appropriate
reason for rejecting the setup. Otherwise, target UE and U2U relay completes
the PC5 link setup procedure including security establishment.
2a. Source UE, target UE and U2U relay are aware PC5 security has been
activated, and that end-to-end security is not needed. End-to-end link is
established between source UE and target UE via U2U relay. Step 2b is skipped.
2b. If Step 2a is skipped, it means that Steps 1a and 1b do not contain
security establishment during PC5 link setup. Source UE, target UE and U2U
relay are aware that PC5 security has not been activated and that end-to-end
security is needed. End-to-end security establishment proceeds between source
UE and target UE.
3\. Traffic between source UE and target UE continues. Depending on the
previous steps taken, the traffic between source UE and target UE is either
protected hop-by-hop or end-to-end.
### 6.22.3 Evaluation
This solution addresses the requirements in KI#5 by applying a common security
protection scheme between Source UE, Target UE, and U2U relay. Existing
solutions for provisioning, discovery, authentication and authorization, PC5
link establishment are reused as much as possible.
## 6.23 Solution #23: Security mechanism for UE-to-UE Relay Model A discovery
### 6.23.1 Introduction
This solution addresses the Key Issue #1.
A _n Announcement message by the U2U relay includes two sets of elements, i.e.
direct discovery set(s) (e.g. the User Info ID of source UE and target UE) and
a U2U discovery set (e.g. Type of Discovery Message, RSC, User Info ID of the
relay). The_ 5G ProSe U2U Relay only modifies the elements of the U2U
discovery set. _The direct discovery set is constructed by the target UE and
is only interpreted by the source UE. The U2U Relay can use a single RSC (and
the associated security materials) to relay direct discovery sets associated
with the multiple ProSe services. This means that the 5G ProSe U2U Relay uses
the same security materials to protect the Announcement messages that contain
the direct discovery sets associated with different ProSe services. Unless
each direct discovery set is protected using the security materials of the
corresponding ProSe service, a source UE (or a target UE) that is authorized
to use the RSC for U2U discovery can decrypt (and manipulate) any direct
discovery sets that are delivered using the same RSC. This poses security
threats._
_To prevent such security threats, this solution proposes a U2U discovery
security mechanism that protects the Announcement message using two sets of
security materials (i.e. the Announcement message and the direct discovery
set(s) are protected using the respective set of security materials)._
### 6.23.2 Solution details
Figure 6.23.2-1: Model A discovery
0\. This solution consists of two protection mechanisms using two sets of
security materials: one for the direct discovery set(s) protection and the
other one for the Announcement message protection.
1\. Direct discovery set(s) protection by the target UE:
The target UE is provisioned with the ProSe restricted code, RSC, and the
respective discovery security materials as specified in clause 6.1.3.2.2 of TS
33.503 [6].
The target UE protects the direct discovery set(s) using the discovery
security materials associated with the ProSe restricted code as specified in
clause 6.1.3.2.3 of TS 33.503 [6].
The target UE protects the direct discovery set(s) using the discovery
security materials associated with the RSC as specified in clause 6.1.3.2.3 of
TS 33.503 [6].
The target UE provides the protected direct discovery set(s) to the U2U Relay.
NOTE 1: the protection mechanisms specified in clause 6.1.3.2.3 of TS 33.503
[6] are reused for the direct discovery set and U2U discovery set protection.
The details of how the protection mechanisms in clause 6.1.3.2.3 of TS 33.503
[6] is applied to the U2U discovery message protection will be specified
during the normative work.
NOTE 2: The direct discovery set contains all information (e.g. UTC-based time
counter and MIC) needed to process (decrypt/integrity check) it.
2\. Announcement message protection by U2U Relay:
The U2U Relay and source UE are provisioned with the RSC for a U2U relay
service and the discovery security materials associated with the RSC as
specified in clause 6.1.3.2.2 of TS 33.503 [6].
The U2U Relay constructs an Announcement message that contains RSC, user info
ID of itself, and the direct discovery set(s) received from the target UE, as
specified in TS 23.304 [8].
NOTE 3: The direct discovery set, if its protection is enabled, is protected
by the Target UE. The Relay UE includes them in the Announcement message
without modification.
The U2U Relay protects an Announcement message using the provisioned discovery
security materials associated with the RSC as specified in clause 6.1.3.2.3 of
TS 33.503 [6].
3\. Announcement message processing by Source UE:
The source UE that is provisioned with the ProSe restricted code, RSC, and the
respective discovery security materials as in the target UE, processes the
Announce message as follows.
The source UE decrypts and/or verifies the received Announcement message using
the discovery security materials associated with the RSC. Then, the source UE
extracts the direct discovery set(s) from the Announcement message and
decrypts and/or verifies the direct discovery set(s) using the discovery
security materials associated with the ProSe restricted code as specified in
clause 6.1.3.2.3 of TS 33.503 [6].
### 6.23.3 Evaluation
This solution addresses the Key Issue #1.
This solution fulfils all security requirements of the Key Issue #1.
This solution requires to support provisioning of:
\- two sets of discovery security materials at source UE and target UE.
NOTE: How the freshness of protected direct discovery set is maintained with
Model A with this solution is not addressed in the present document.
## 6.24 Solution #24: Security mechanism for UE-to-UE Relay Model B discovery
### 6.24.1 Introduction
This solution addresses the Key Issue #1.
A _(relayed) Solicitation message and (relayed) Response message by the U2U
relay includes two sets of elements, i.e. direct discovery set(s) (e.g. the
User Info ID of source UE and target UE) and a U2U discovery set (e.g. Type of
Discovery Message, RSC, User Info ID of the relay). The_ 5G ProSe U2U Relay
only modifies the elements of the U2U discovery set. _The direct discovery set
that is constructed by the source UE can only be interpreted by the target UE,
and vice versa. The U2U Relay can use a single RSC (and the associated
security materials) to relay direct discovery sets associated with the
multiple ProSe services. This means that the 5G ProSe U2U Relay uses the same
security materials to protect the discovery messages that contain the direct
discovery sets associated with different ProSe service. Unless each direct
discovery set is protected using the security materials of the corresponding
ProSe service, a source UE (or a target UE) that is authorized to use the RSC
for U2U discovery can decrypt (and manipulate) any direct discovery sets that
are delivered using the same RSC. This poses security threats._
_To prevent such security threats, this solution proposes a U2U discovery
security mechanism that protects the discovery messages using two sets of
security materials (i.e. the discovery messages and the direct discovery
set(s) are protected using the respective set of security materials)._
### 6.24.2 Solution details
Figure 6.24.2-1: Model B discovery
This solution consists of two protection mechanisms using two sets of security
materials: one for the Solicitation and Response message protection and the
other one for the direct discovery set(s) protection.
_The security procedure is described as follows:_
NOTE 1: the procedures for discovery security materials provisioning and
protection mechanisms specified in clause 6.1.3.2 of TS 33.503 [6] are reused
for the U2U Relay Model B discovery. The details of how the protection
mechanisms in clause 6.1.3.2.3 of TS 33.503 [6] is applied to the U2U
discovery message protection will be specified during the normative work.
NOTE 2: The direct discovery set contains all information (e.g. UTC-based time
counter and MIC) needed to process (decrypt/integrity check) it.
NOTE 3: How to retrieve the corresponding direct security material associated
with Prose Code to verify the direct discovery set(s) is not addressed in the
present document.0. The source UE, target UE, and U2U Relay are provisioned
with the following discovery security materials based on the procedure
specified in clause 6.1.3.2.2 of TS 33.503 [6].
0a. The source UE and target UE are provisioned with the discovery security
materials associated with the ProSe code (i.e. query and response code) for a
ProSe service.
0b. The source UE, target UE, and U2U Relay are provisioned with discovery
security materials associated with an RSC.
1\. The source UE protects a direct discovery set(s) (e.g. user info ID of
target UE) using the discovery security materials associated with the ProSe
code. Then, the source UE provides the protected direct discovery set(s) to
the U2U Relay via a Solicitation message. The Solicitation message is
protected as specified in clause 6.1.3.2.3 of TS 33.503 [6].
2\. On receiving the Solicitation message from the source UE, the U2U Relay
decrypts and/or verifies the received Solicitation message using the discovery
security materials associated with the RSC. If the verification is successful,
the U2U Relay constructs a (relayed) Solicitation message that contains U2U
discovery set and the direct discovery set(s). Then, the U2U Relay protects
the (relayed) Solicitation message using the same security materials and
forwards (relays) the message to the target UE.
3\. The target UE decrypts and/or verifies the received Solicitation message
using the discovery security materials associated with the RSC. The target UE
further extracts the protected direct discovery set(s) from the message and
decrypts and/or verifies the direct discovery set(s) using the discovery
security materials associated with the ProSe code.
4\. The target UE protects direct discovery set(s) (e.g. user info ID of
source UE) using the discovery security materials associated with the ProSe
code and includes it in a Response message. Then, the target UE protects the
Response message using the discovery security materials associated with the
RSC and sends the message to the U2U Relay.
5\. The U2U Relay decrypts and/or verifies the received Response message using
the discovery security materials associated with the RSC. If the verification
is successful, the U2U Relay constructs a (relayed) Response message that
contains (modified) U2U discovery set and the direct discovery set(s) and
protects the message using the same security materials. Then, the U2U Relay
forwards (relays) the message to the source UE.
6\. The source UE decrypts and/or verifies the received Response message using
the discovery security materials associated with the RSC. If the verification
is successful, the source UE further extracts the protected direct discovery
set(s) from the message and decrypts and/or verifies the direct discovery
set(s) using the discovery security materials associated with the ProSe code
as specified in clause 6.1.3.2.3 of TS 33.503 [6].
### 6.24.3 Evaluation
This solution addresses the Key Issue #1.
This solution fulfils all security requirements of the Key Issue #1.
This solution requires to support provisioning of:
\- Two sets of discovery security materials at source UE and target UE.
\- This solution reuses the security material provisioning mechanism for
Restricted 5G ProSe Direct Discovery as specified in TS 33.503 for the
provisioning of discovery security materials for the direct discovery set.
\- This solution reuses the security material provisioning mechanism for 5G
ProSe UE-to-Network Relay discovery as specified in TS 33.503 for the
provisioning of discovery security materials for the U2U relay discovery
message.
## 6.25 Solution #25: PC5 link setup for Layer-3 UE-to-UE Relay
### 6.25.1 Introduction
This solution addresses the KI #2. This solution provides a mechanism to setup
a connection between source and target UEs via the UE-to-UE (U2U) Relay. This
solution is a Layer-3 (L3) U2U Relay solution when the U2U Relay is in
coverage and is based on the L3 user-plane UE-to-Network Relay architecture
specified in TS 33.503 [6]. This solution only describes the PC5 link setup
procedure between the source/target UE and the U2U Relay and end-to-end
security setup between source and target UEs. The end-to-end security is an
optional feature and is only established when configured by the service (i.e.
5G ProSe Key Management Function).
### 6.25.2 Solution details
Figure 6.25.2-1:. Secure PC5 link establishment procedure for UE-to-UE Relay
NOTE 1: In this solution, the source and target UEs, and U2U Relay are assumed
to be provisioned with the discovery security materials when they are in
coverage. Also, those security materials are associated with an expiration
time, after which they become invalid. When the security materials become
invalid the source/target UE needs to be in coverage to obtain fresh ones to
be able to connect via U2U Relay.
Note 2: The details of discovery security materials are addressed in other
solutions addressing KI#1 in the present document.
0\. The source UE, target UE and the U2U Relay get the discovery parameters
and 5G Prose Key management function (PKMF) address from the 5G DDNMF and the
discovery security materials from the 5G PKMF respectively. Furthermore, the
source and target UEs are provisioned with the security materials for end-to-
end security setup by the PKMF if the U2U Relay service requires end-to-end
security.
1a. The source UE performs the discovery procedure.
NOTE 3: The discovery procedure is based on the solution of Key Issue #1.
1b. The source UE performs a PC5 unicast link setup procedure with the U2U
Relay. The PC5 unicast link setup procedure is based on the procedure
specified in clause 6.3.3.2.2 of TS 33.503 [6].
2\. The target UE performs the discovery procedure and PC5 unicast link setup
procedure with the U2U Relay in the same manner as source UE.
3\. The source UE and target UE establish an end-to-end IPsec connection via
U2U Relay if security materials for end-to-end security are provisioned by the
5G PKMF. To establish an end-to-end IPsec connection, the source UE and target
UE may perform IKEv2 authentication using the keying materials provisioned in
step 0.
NOTE 4: Whether the end-to-end IPsec is needed is configured at the source UE
and target UE by the 5G PKMF.
### NOTE 5: The needs of E2E security in L3 solution is not addressed in the
present document.6.25.3 Evaluation
This solution provides end-to-end confidentiality and integrity protection of
communication between the peer UEs over the U2U Relay at the IP layer.
This solution provides confidentiality and integrity protection of user-plane
data and control-plane signalling between the source UE/target UE and the U2U
Relay based on the PC5 security establishment procedure over User Plane as
specified in clause 6.3.3.2.2 of TS 33.503 [6] when the U2U Relay is in
coverage.
## 6.26 Solution #26: UE-to-UE relay PC5 connection security establishment
### 6.26.1 Introduction
This solution addresses Key issue #2 (Security of UE-to-UE Relay) and Key
issue #3 (Authorization in the UE-to-UE Relay Scenario). This solution reuses
the mechanism of unicast mode 5G ProSe Direct Communication security defined
in TS 33.503 [6] to setup the security of UE-to-UE Relay Communication. This
solution covers both In-Coverage and Out-of-Coverage under both L2 and L3 UE-
to-UE relay scenarios.
### 6.26.2 Solution details
This solution reuses the mechanism of unicast mode 5G ProSe Direct
Communication security defined in TS 33.503 [6] to setup the security of UE-
to-UE Relay Communication. The security between UEs based on the
provisioned/pre-configured Long-term credentials in the UEs (i.e. source End
UE, target End UE and UE-to-UE Relay) involved in the UE-to-UE relay
communication. The Long-term credentials are used to form the root of the
security of the PC5 unicast link by exchanging the key_est_info during Direct
Authentication and Key Establishment procedures as specified in TS 33.503 [6].
The PC5 connection security establishment procedures between the End UE
(source End UE or target End UE) and UE-to-UE Relay, or between the End UEs
(only for L2 case) follow the procedures below:
> 0\. ProSe UE-to-UE relay communication security-related parameter pre-
> configuration and provisioning, the security-related parameter includes the
> Long-term credential and signalling/user plane security policies. The Long-
> term credentials are provisioned as specified in clause 5.3.3.1.2.1 of TS
> 33.536 [9].
NOTE a: How Long-term credential is provisioned is not addressed in the
present document.
NOTE 1: Step 0 may happen under network coverage (e.g. provisioned by PCF).
NOTE 2: This solution assumes the UE always has valid Long-term credentials.
> 1\. UE-to-UE discovery procedures to find a peer UE. The peer UE can be
> source End UE, target End UE and UE-to-UE Relay.
2\. In the case, initiating UE determines it needs to establish a PC5
connection with another UE (i.e. the peer UE), the initiating UE sends the
Direct Communication Request (DCR) message and this message is received by the
peer UE. Under the condition of initiating UE\'s signalling integrity security
policy is not \'NOT NEEDED\', the DCR includes the Key_Est_Info. The message
may also include a K~NRP~ ID if the initiating UE has an existing K~NRP~ for
the peer UE.
> 3\. The initiating UE and the peer UE exchanges Direct Auth and Key
> Establishment messages including Key_Est_Info. This is mandatory if the peer
> UE does not have the K~NRP~ and K~NRP~ ID pair indicated in step 1, and
> signalling integrity protection is needed.
NOTE 3: It is not addressed in the present document about how the two UE's
authorise each other for direct communication.
4\. In case the signalling integrity protection is needed, peer UE calculates
K~NRP~ and send a Direct Security Mode Command message to initiating UE,
including MSB of K~NRP~ ID.
5\. On receiving the Direct Security Mode Command, the initiating UE
calculates K~NRP~ and choose the LSB of K~NRP~ ID if signalling integrity
protection is needed. Initiating UE shall send a Direct Security Mode Complete
message to UE_2 which contains the LSB of K~NRP~ ID.
### 6.26.3 Evaluation
The security of the PC5 link relies on the provisioned/pre-configured security
materials. Security keys for each PC5 connection can be generated without the
assistance from the network. Therefore, the Source UE and the Target UE can
establish the UE-to-UE connection via UE-to-UE Relay regardless of whether
they are within or out of network coverage.
Note: Further evaluation is needed.
## 6.27 Solution #27: Support Emergency Service over L3 and L2 UE-to-Network
Relay
### 6.27.1 Introduction
This solution addresses KI#6: Support Emergency Service over UE-to-Network
Relay. This solution addresses a L3 UE-to-Network relay.
The PC5 link establishment procedure can be applied to both L3 and L2 Relay.
In the 5G ProSe UE-to-Network relaying, if there is an emergency request from
the remote UE, the Relay UE is responsible for remote UE\'s emergency service.
It is assumed _the Relay UE gets the_ regulation and the associated operator
policy about emergency service from the Relay UE\'s serving PLMN.
Based on the regulation and the operator policy, _the Relay UE supports to
establish PC5 communication for emergency service, for either an authenticated
Remote UE (e.g. Remote UE with USIM and properly being authenticated by UP or
CP based security procedure) or an unauthenticated Remote UE (e.g. Remote UE
without USIM or_ authentication cannot complete for any reason)_._
_Based on the regulation and the operator policy, the announcement and
discovery of Emergency RSC and the PC5 link establishment may be performed
without security protection, e.g. for a Remote UE without USIM_ nor pre-
configured discovery security materials.
_Based on the regulation, the operator policy and UP security policies of the
remote UE and the Relay UE for the emergency RSC, the UP traffic may be
transmitted via PC5 link without security protection for an unauthenticated
Remote UE e.g. Remote UE without USIM or authentication cannot complete for
any reason_.
In Remote UE Report for emergency service, Remote User ID i.e. (UP-/CP-) PRUK
ID is used as UE ID for the authenticated Remote UE. In case of
unauthenticated Remote UE, PEI is used to identify the UE in Remote UE Report.
_It is assumed that the 5G ProSe enabled UE acting as Relay has a_ USIM and is
registered to a PLMN in case of emergency service.
### 6.27.2 Solution details
Figure 6.27.2-1 illustrates the high-level procedure of the proposed solution.
5GC NFs and internal signalling are not described in detail here for brevity.
Figure 6.27.2-1: High-level procedure of PC5 link establishment for Emergency
Service over UE-to-Network relay
0a. The 5G ProSe UE-to-Network relay is provisioned with the discovery
security materials as described in TS 33.503 [6]. Based on the regulation and
the operator policy, there may or may not be discovery security materials
provisioned for Emergency RSC.
0a. The 5G ProSe Remote UE is provisioned with the discovery security
materials and retrieves the UP-PRUK and UP-PRUK ID for UP based security
method from the network as described in TS 33.503 [6]. Based on the regulation
and the operator policy, there may be or may be no discovery security
materials provisioned for Emergency RSC.
If the 5G ProSe Remote UE is USIM-less, this step is skipped. The Emergency
RSC and the discovery security materials if exist are locally configured in
the 5G ProSe Remote UE.
1\. The discovery procedure for the Emergency RSC is performed between the 5G
ProSe Remote UE and the 5G ProSe UE-to-Network Relay using the discovery
parameters and discovery security material as described in TS 33.503 [6].
Based on the regulation and the operator policy, the announcement and
discovery of Emergency RSC may be performed without security protection.
2\. If the 5G ProSe Remote UE has USIM, the 5G ProSe Remote UE sends a Direct
Communication Request (DCR) that contains (UP-/CP-) PRUK ID or SUCI, Emergency
RSC and K~NRP~ freshness parameter 1 to the 5G ProSe UE-to-Network Relay. The
message may additionally include the PEI of the 5G ProSe Remote UE.
If the 5G ProSe Remote UE is USIM-less, the 5G ProSe Remote UE sends a Direct
Communication Request that contains PEI, Emergency RSC to the 5G ProSe UE-to-
Network Relay.
3\. If (UP-/CP-) PRUK ID or SUCI is received, the 5G ProSe UE-to-Network Relay
performs UP or CP based security procedure as described in TS 33.503 [6].
If only PEI and Emergency RSC are received, the 5G ProSe UE-to-Network Relay
skips this step if the regulation and the operator policy allow.
4\. If step 3 is successfully performed, the 5G ProSe UE-to-Network Relay
performs Direct Security Mode Command procedure towards the 5G ProSe Remote UE
as described in TS 33.503 [6].
If step 3 is failed or skipped, e.g. the 5G ProSe Remote UE is USIM-less, the
5G ProSe UE-to-Network Relay performs Direct Security Mode Command procedure
with Null ciphering and integrity protection if the regulation and the
operator policy allow. In this case, the 5G ProSe Remote UE treats UP
integrity protection as not activated for this connection and includes the UP
integrity protection policy as NOT NEEDED in the Direct Security Mode
Complete. The 5G ProSe UE-to-Network Relay sets UP integrity protection to
OFF.
The 5G ProSe Remote UE accepts Null ciphering and integrity algorithms if, and
only if, the Remote UE has sent an Emergency RSC in step 2.
UP confidentiality protection policy is handled as specified in TS 33.536 [9].
5\. If the 5G ProSe Remote UE is not authenticated successfully via UP or CP
based security procedure and PEI is not received from Direct Communication
Request, the 5G ProSe UE-to-Network Relay sends Remote Identity Request to the
5G ProSe Remote UE to retrieve the PEI based on the regulation and the
operator policy.
6\. The 5G ProSe UE-to-Network Relay sends a Direct Communication Accept
message to the 5G ProSe Remote UE to finish the PC5 connection establishment
procedures for the emergency service.
The 5G ProSe UE-to-Network Relay includes the configuration of UP integrity
and confidentiality protection based on the agreed UP security policy in the
Direct Communication Accept message as specified in TS 33.536 [9].
7\. When the 5G ProSe Layer-3 UE-to-Network Relay sends a Remote UE Report to
the SMF for the Emergency RSC, the 5G ProSe Layer-3 UE-to-Network Relay
includes Remote User ID i.e. (UP-/CP-) PRUK ID if UP or CP based security
procedure is successfully performed. Otherwise, the 5G ProSe Layer-3 UE-to-
Network Relay includes the PEI of the 5G ProSe Remote UE in the Remote UE
Report.
If UP confidentiality protection is not activated for this connection, the UP
confidentiality protection algorithm is the same as the selected signalling
confidentiality algorithm as specified in TS 33.536 [9].
If UP integrity protection is not activated for this connection, the 5G ProSe
Remote UE and the 5G ProSe Layer-3 UE-to-Network Relay do not put MAC-I into
PDCP packet
NOTE: It is assumed that the SMF is able to resolve a PRUK ID into a SUPI.
### 6.27.3 Evaluation
This solution resolves KI#6: Support Emergency Service over UE-to-Network
Relay.
This solution can be applied to both Layer 2 Relay and Layer 3 Relay.
_In this solution it is assumed that the 5G ProSe enabled UE acting as a_ UE-
to-Network Relay _has a_ USIM and is registered to a PLMN in case of emergency
service.
This solution assumes that if there is an emergency request from the Remote UE
in the 5G ProSe UE-to-Network relaying, the UE-to-network relay is responsible
for Remote UE\'s emergency service. It is assumed _the_ UE-to-network relay
_gets the_ regulation and the associated operator policy about emergency
service from the UE-to-network relay\'s serving PLMN. Based on the regulation
and the operator policy, _the_ UE-to-network relay _supports to establish PC5
communication for emergency service, for either an authenticated Remote UE
(e.g. Remote UE with USIM and properly being authenticated by UP or CP based
security procedure) or an unauthenticated Remote UE (e.g. Remote UE without
USIM or_ authentication cannot complete for any reason)_._
_This solution assumes that a specific Emergency RSC has been defined. The
announcement and discovery of Emergency RSC and the PC5 link establishment may
be performed without security protection, e.g. for a Remote UE without USIM_
nor pre-configured discovery security materials.
For a Remote UE without a USIM, the Remote UE can provide its PEI via the UE-
to-network relay to the network, which is used to identify the Remote UE in
the network.
In Remote UE Report for emergency service, Remote User ID i.e. (UP-/CP-) PRUK
ID is used as UE ID for the authenticated Remote UE. In case of
unauthenticated Remote UE, PEI is used to identify the Remote UE in Remote UE
Report.
If the Remote UE _is USIM-less or_ authentication cannot complete for any
reason, then the 5G ProSe UE-to-Network Relay performs Direct Security Mode
Command procedure with Null ciphering and integrity protection if the
regulation and the operator policy allow. In this case, the 5G ProSe Remote UE
treats UP integrity protection as not activated for this connection and
_includes the UP_ integrity protection policy as NOT NEEDED _in the_ Direct
Security Mode Complete. The 5G ProSe UE-to-Network Relay sets UP integrity
protection to OFF in this case.
_The UP_ confidentiality _protection policy is handled as specified in_ TS
33.536 [9].
This solution allows a Remote UE without a USIM to initiate emergency services
with the network via a 5G ProSe UE-to-Network.
## 6.28 Solution #28: UE-to-UE relay discovery security
### 6.28.1 Introduction
This solution addresses Key Issue #1: Security for UE-to-UE Relay discovery
and Key issue #3: Authorization in the UE-to-UE Relay Scenario. For Key Issue
#1, this solution specifically addresses the security requirement:
The 5G System provides a means for confidentiality protection, integrity
protection and replay protection of discovery messages for UE-to-UE Relay
discovery.
In clause of 8.1 of TR 23.700-33 [2], there are the following conclusions
about 5G ProSe UE-to-UE Relay discovery:
_\- The 5G ProSe UE-to-UE Relay discovery message contains two sets of
elements, i.e. direct discovery set(s) and a U2U discovery set._
_\- The direct discovery set of elements can be part of the contents of 5G
ProSe Direct Discovery message as defined in Rel-17. This includes for example
the User Info ID of Source UE and Target UE._
_\- The U2U discovery set contains the information to support the discovery of
the UE-to-UE relay and extensions of the direct discovery. This includes for
example Type of Discovery Message, RSC, User Info ID of the relay, etc._
_\- 5G ProSe UE-to-UE relay only modifies the U2U set of the elements, and
forwards the end-to-end elements during the discovery procedures._
In clause 5.1.3 of the present document, there are the following security
requirements for 5G ProSe UE-to-UE Relay discovery:
> _The 5G System shall provide a means for confidentiality protection,
> integrity protection and replay protection of discovery messages for UE-to-
> UE Relay discovery._
>
> _The 5G System shall provide a means to protect the privacy sensitive
> information of source UE and target UE during UE-to-UE Relay discovery
> procedure._
This solution proposes reusing the existing security mechanism specified in TS
33.503 [6] to protect the direct discovery set and U2U discovery set in U2U
relay discovery messages.
The security requirements for U2U relay discovery messages may vary, such as
in a U2U relay application, all the UEs can be the role of Source, Target or
Relay UE, and all of them have the same security parameters used to protect
discovery messages. In this case, no additional security protection may be
required for the direct discovery message. In other cases, only
confidentiality or integrity protection may be required. In addition, when the
UE is in a low power situation, it may want to disable some security
functions, such as direct discovery message security, because in this case,
communication capability is more important than security. Therefore, the
flexibility of controlling the message security of U2U relay discovery should
be considered to meet the requirements of various application scenarios. A
security policy indicator is introduced into the U2U relay discovery message
to control how to handle the security of the direct discovery set to avoid
unnecessary security protection in some scenarios.
This solution introduces two sets of security parameters, one for protecting
the direct discovery set and the other for protecting U2U discovery set. In
this way, the Source/Target UE and the Relay UE can be authorized in the UE-
to-UE relay scenario.
### 6.28.2 Solution details
#### 6.28.2.1 UE-to-UE relay discovery security of Model A
Figure 6.28.2-1: Security procedure of UE-to-UE relay discovery of Model A
> 0\. Key management function (PCF/5G DDNMF/PKMF) is responsible for
> provisioning discovery security parameters to the UEs involved in direct
> discovery and U2U relay discovery. The key management functions used to
> provision direct discovery security parameters and U2U relay discovery
> security parameters can be different. Direct discovery security parameters
> are provisioned to the Source UE (Monitoring UE) and Target UE (Announcing
> UE). U2U relay discovery security parameters are provisioned to the Source
> UE, Target UE and Relay UE, and are associated with a RSC. The security
> related parameters used in U2U relay discovery are the same as those used in
> direct discovery specified in TS 33.503 [6].
>
> For U2U relay discovery Model A, there are:
\- Code-Sending Security Parameters and other security related parameters used
in direct discovery are provisioned to the Target UE (Announcing UE).
\- Code-Receiving Security Parameters and other security related parameters
used in direct discovery are provisioned to the Source UE (Monitoring UE).
\- Code-Sending Security Parameters and other security related parameters used
in U2U relay discovery are provisioned to the Target UE (Announcing UE) and
Relay UE. These parameters are associated with a RSC.
\- Code-Receiving Security Parameters and other security related parameters
used in U2U relay discovery are provisioned to the Source UE (Monitoring UE)
and Relay UE. These parameters are associated with a RSC.
NOTE 1: More details about how to provision discovery security parameters to
the Source UE, Target UE, and Relay UE are not addressed in this solution.
U2U relay discovery security policy can be provisioned or preconfigured in the
Source UE. U2U relay discovery security policy specifies what security
protection should be applied to the direct discovery message carried in the
relay discovery message. Security protection can be confidentiality
protection, integrity protection, scrambling protection, or none. The U2U
relay discovery security policy can also indicate that a preconfigured
security policy will be used to protect U2U relay discovery message. The
method of including security policies in U2U relay discovery messages can
provide maximum security control flexibility for ProSe relay discovery
scenarios.
NOTE 1a: Need for discovery security policy is not addressed in the present
document.1. The Target UE (Announcing UE) generates U2U relay discovery
message as follows:
\- Generate direct discovery set (see clause 8.1 of TR 23.700-33 [2]) , and
then protect it with the direct discovery security parameters by using the
procedures defined in clause 6.1.3.2.3 of TS 33.503 [6] according to the U2U
relay discovery security policy.
\- Generate the plaintext of relay discovery message sent to the Relay UE as
specified in clause 8.1 of TR 23.700-33 [2], and then protect it with the
relay discovery security parameters associated with the RSC by using the
procedures defined in clause 6.1.3.2.3 of TS 33.503 [6] with the following
extensions:
\- RSC indicates which relay discovery security parameters are used to protect
the relay discovery message.
\- Message sender indicator indicates this message is generated by the Target
UE.
\- U2U Relay discovery security policy indicator indicates how the direct
discovery message is protected.
\- Direct discovery set.
\- U2U relay control parameter indicates how the Relay UE handles discovery
message it receives. The U2U relay control parameter can specify:
\- Message validity period: It specifies the validity time of this message.
During this validity period, the Relay UE will continue to include the
announcement information of the message in its announcement messages, even if
the connection to the Announcing UE has been established.
\- Maximum forwarding delay: It specifies the maximum delay time for the Relay
UE to send the announcement information in the message in its announcement
message for the first time. If its value is set to zero, it means that the
Relay UE should immediately process the message.
\- Message forwarding frequency: It specifies at which frequency (such as once
per minute) the Relay UE should announce the announcement information in this
message.
\- Stop forwarding messages: It allows Announcing UE can actively request
Relay UEs to stop forwarding its messages. This option does not affect any
existing connections.
Note 1b: How Model A using protected discovery set is supported for the case
of End UE discovered via prior communication procedure is not addressed in the
present document.
Note 1c: Usage of maximum forwarding delay parameter is not addressed in the
present document.
Note 1d: Usage forwarding frequency and stop forwarding parameter is not
addressed in the present document.
Note 1e: How the U2U relay control parameter is configured in the End UE is
not addressed in the present document.
NOTE 2: How the direct discovery set and U2U discovery set are protected by
the direct discovery security parameters and U2U relay discovery security
parameters is left to the normative phase.
2\. The Target UE sends the relay discovery message to the Relay UE.
3\. The Relay UE receives the relay discovery message, and knows that the
relay discovery message is targeted at it by checking the Message sender
indicator which shows the generator is a Target UE, and then perform the
following operations:
\- The Relay UE undoes the received U2U relay discovery message with relay
discovery security parameters associated with RSC by using the procedures
defined in 6.1.3.2.3 of TS 33.503 [6].
\- According to the U2U relay control parameter carried in the message, the
Relay UE generates a new plaintext of relay discovery message sent to the
Source UE as specified in clause 8.1 of TR 23.700-33 [2], and then protect it
with the relay discovery security parameters associated with the RSC by using
the procedures defined in 6.1.3.2.3 of TS 33.503 [6] with the following
extensions:
\- RSC indicates which relay discovery security parameters are used to protect
the relay discovery message.
\- Message sender indicator indicates this message is generated by the Relay
UE.
\- U2U Relay discovery security policy indicator obtained from the received
relay discovery message.
\- Direct discovery set obtained from the received U2U relay discovery
message.
4\. The Relay UE sends the new generated relay discovery message to the Source
UE.
5\. The Source UE receives the relay discovery message and knows that the
relay discovery message is targeted at it by checking the Message sender
indicator, which shows the generator is a Relay UE, and then perform the
following operations:
\- Undo the received relay discovery message with the relay discovery security
parameters associated with the RSC.
\- If the U2U relay discovery security policy indicator shows that the direct
discovery message is protected, undo the direct discovery message or the
direct discovery set with the direct discovery security parameters.
#### 6.28.2.2 UE-to-UE relay discovery security of Model B
Figure 6.28.2-2: Security procedure of UE-to-UE relay discovery of Model B
0\. Key management function (PCF/5G DDNMF/PKMF) is responsible for
provisioning discovery security parameters to the UEs involved in direct
discovery and U2U relay discovery. The key management functions used to
provision direct discovery security parameters and U2U relay discovery
security parameters can be different. Direct discovery security parameters are
provisioned to the Source UE and Target UE. U2U relay discovery security
parameters are provisioned to the Source UE, Target UE and Relay UE, and are
associated with a RSC. The security related parameters used in U2U relay
discovery are the same as those used in direct discovery specified in TS
33.503 [6].
For U2U relay discovery Model B, there are:
\- Code-Sending Security Parameters, Code-Receiving Security Parameters and
other security related parameters used in direct discovery are provisioned to
the Source UE (Discoverer UE) and Target UE (Discoveree UE).
\- Code-Sending Security Parameters, Code-Receiving Security Parameters and
other security related parameters used in U2U relay discovery are provisioned
to the Source UE (Discoverer UE), Target UE (Discoveree UE) and Relay UE.
These parameters are associated with a RSC.
NOTE 1: More details about how to provision discovery security parameters to
the Source UE, Target UE, and Relay UE are not addressed in this solution.
U2U relay discovery security policy can be provisioned or preconfigured in the
Source UE and Target UE. U2U relay discovery security policy specifies what
security protection should be applied to the direct discovery message carried
in the relay discovery message. Security protection can be confidentiality
protection, integrity protection, scrambling protection, or none. The U2U
relay discovery security policy can also indicate that a preconfigured
security policy will be used to protect U2U relay discovery message. The
method of including security policies in U2U relay discovery messages can
provide maximum security control flexibility for ProSe relay discovery
scenarios.
Note 1a: Need for discovery security policy is not addressed in the present
document.
1\. The Source UE (Discoverer UE) generates relay discovery message as
follows:
\- Generate direct discovery set (see clause 8.1 of TR 23.700-33 [2]) , and
then protect it with the direct discovery security parameters by using the
procedures defined in 6.1.3.2.3 of TS 33.503 [6] according to the U2U relay
discovery security policy.
\- Generate the plaintext of relay discovery message sent to the Relay UE as
specified in clause 8.1 of TR 23.700-33 [2], and then protect it with the
relay discovery security parameters associated with the RSC by using the
procedures defined in 6.1.3.2.3 of TS 33.503 [6] with the following
extensions:
\- RSC indicates which relay discovery security parameters are used to protect
the relay discovery message.
\- Message sender indicator indicates this message is generated by the Source
UE.
\- U2U Relay discovery security policy indicator indicates how the direct
discovery message is protected.
\- Direct discovery set.
\- U2U relay control parameter indicates how the Relay UE handles discovery
message it receives. The U2U relay control parameter can specify:
\- Message validity period: It specifies the validity time of this message.
During this validity period, the Relay UE will continue to forward the
solicitation information in its new solicitation message, even if the
connection to a Discoveree UE has been established.
\- Maximum forwarding delay: It specifies the maximum delay time for the Relay
UE to send the solicitation information in the message in its solicitation
message for the first time. If its value is set to zero, it means that the
Relay UE should immediately process the message.
\- Message forwarding frequency: It specifies at which frequency (such as once
per minute) the Relay UE should forward the announcement information in this
message.
\- Stop forwarding messages: It allows Discoverer UE can actively request
Relay UEs to stop forwarding its messages. This option does not affect any
existing connections.
NOTE 1b: Whether Model B needs these parameters is not addressed in the
present document.NOTE 2: How the direct discovery set and U2U discovery set
are protected by the direct discovery security parameters and U2U relay
discovery security parameters is left to the normative phase.
2\. The Source UE sends the relay discovery message to the Relay UE.
3\. The Relay UE receives the relay discovery message, and knows that the
relay discovery message is targeted at it by checking the Message sender
indicator which shows the generator is a Target UE, and then perform the
following operations:
\- The Relay UE undoes the received U2U relay discovery message with relay
discovery security parameters associated with RSC by using the procedures
defined in 6.1.3.2.3 of TS 33.503 [6].
\- According to the U2U relay control parameter carried in the message, the
Relay UE generates a new plaintext of relay discovery message sent to the
Source UE as specified in clause 8.1 of TR 23.700-33 [2], and then protect it
with the relay discovery security parameters associated with the RSC by using
the procedures defined in 6.1.3.2.3 of TS 33.503 [6] with the following
extensions:
\- RSC indicates which relay discovery security parameters are used to protect
the relay discovery message.
\- Message sender indicator indicates this message is generated by the Relay
UE.
\- U2U Relay discovery security policy indicator obtained from the received
relay discovery message.
\- Direct discovery set obtained from the received U2U relay discovery
message.
4\. The Relay UE sends the new generated relay discovery message to the Target
UE.
5\. The Target UE receives the relay discovery message and knows that the
relay discovery message is targeted at it by checking the Message sender
indicator, which shows the generator is a Relay UE, and then perform the
following operations:
\- Undo the received relay discovery message with the relay discovery security
parameters associated with the RSC.
\- If the U2U relay discovery security policy indicator shows that the direct
discovery message is protected, undo the direct discovery message with the
direct discovery security parameters.
6-10.The Target UE sends discovery response message to the Source UE via the
Relay UE. The security process is similar to the steps 1-5.
### 6.28.3 Evaluation
Solution #28 addresses the first security requirement of key issue #1 and Key
issue #3.
This solution uses two sets of security parameters to protect the direct
discovery set and U2U discovery set. The security parameters used to protect
the direct discovery set are not newly defined. They are the security
parameters used in the direct discovery scenario. The security parameters used
to protect the U2U discovery set are newly defined. The details of which
parameters in the direct discovery set and U2U discovery set need to be
protected and how to protect them will be determined in the normative phase.
This solution introduces a security policy, which can flexibly control how to
protect the direct discovery set in U2U discovery message according to the
security requirements in various situations. For example, all UEs can play the
roles of Source, Target and Relay UEs, or the Source/Target UEs are in a low
power situation and Source/Target turn off some security functions in order to
save some power, etc.
Because the direct discovery security parameters are used to protect the data
exchanged between the Source UE and the Target UE, while the U2U discovery
security parameters are used to protect the data exchanged between the
Source/Target UE and the Relay UE, the authorization requirements described in
KI#3 can be met through the key provision process (not addressed in this
solution) and the cryptographic technology applied to U2U discovery messages.
This solution does not support Source/Target UE and Relay UE authorization
during communication establishment. This authorization may depend on the
application layer or other specific solutions.
## 6.29 Solution #29: Hop-by-hop security establishment for the UE-to-UE Relay
### 6.29.1 Introduction
This solution addresses Key Issue #2, #3, and #5. When Source/Target UEs and a
Relay UE are in the network coverage, they are authorized and provisioned with
the required information for security establishments during the registration
procedure that includes the primary authentication (i.e. 5G-AKA or EAP-AKA\').
The Source UE sends a Direct Communication Request to the UE-to-UE Relay, so
that the direct authentication takes place and the hop-by-hop protection key
is established regardless of whether the UEs (the Source UE, Target UE and/or
UE-to-UE Relay) are within or outside the network coverage. This solution
applies to both Layer-2 UE-to-UE Relay and Layer-3 UE-to-UE Relay.
### 6.29.2 Solution details
#### 6.29.2.1 Hop-by-hop security establishment procedure for the UE-to-UE
Relay
Figure 6.29.2.1-1 illustrates the hop-by-hop security establishment procedure
between the Source/Target UE and the UE-to-UE Relay.
Figure 6.29.2.1-1: Hop-by-hop security establishment procedure for the UE-to-
UE Relay
1) The Source UE, Target UE, and UE-to-UE Relay are authorized and provisioned
with the security materials for the hop-by-hop security establishment (refer
to clause 6.29.2.2).
2) The discovery and selection procedure may be performed between the Source
UE, Target UE, and UE-to-UE Relay using Model A or Model B mode as specified
in TS 23.304 [2]. If discovery integrated into PC5 unicast link establishment
procedure concluded by SA2 in TR 23.700-33 [3] is to be performed in the
following steps, this step is skipped.
3) There are various authentication and key establishment methods to be used
between the Source UE and the UE-to-UE Relay. Hence, all the authentication is
specified to be carried in a generic container called Auth_Key_Info in the
following steps.
4) The Source UE generates ephemeral public key (UE1.ePK) and private key
(UE1.eSK), and a digital signature (UE1.Sig). The digital signature is signed
over the source UE\'s identity (UE1.ID) and UE1.ePK using the security
materials provisioned in step 0. Then, the Source UE generates
UE1.Auth_Key_Info which includes UE1.ID, UE1.ePK, and UE1.Sig.
5) The Source UE wants to establish a secure PC5 unicast link with the UE-to-
UE Relay. The Source UE sends the UE-to-UE Relay a Direct Communication
Request message including Relay Service Code (RSC) and its Auth_Key_Info. The
message also includes the security capabilities and PC5 signalling security
policy.
6) Upon reception of the Direct Communication Request message, the UE-to-UE
Relay verifies the Source UE with UE1.Sig included in UE1.Auth_Key_Info using
the security materials provisioned in step 0. If the verification is
successful and the UE-to-UE Relay decides to accept the request, the UE-to-UE
Relay generates ephemeral public key (UE2.ePK) and private key (UE2.eSK), and
a digital signature (UE2.Sig). The digital signature is signed over the UE-to-
UE Relay\'s identity (UE2.ID) and UE2.ePK using the security materials
provisioned in step 0. Then, the UE-to-UE Relay generates UE2.Auth_Key_Info
which includes UE2.ID, UE2.ePK, and UE2.Sig.
7) In this step, the UE-to-UE Relay derives a symmetric key that is used to
protect the hop-by-hop link (i.e. hop-by-hop protection key), using the Source
UE\'s ephemeral public key (UE1.ePK) and its own ephemeral private key
(UE2.eSK).
8) The UE-to-UE Relay sends the Source UE a Direct Security Mode Command
message including RSC and its Auth_Key_Info.
9) Upon reception of the Direct Security Mode Command message, the Source UE
verifies the UE-to-UE Relay with UE2.Sig included in UE2.Auth_Key_Info using
the security materials provisioned in step 0. If the verification is
successful, the Source UE derives a symmetric key that is used to protect the
hop-by-hop link (i.e. hop-by-hop protection key), using the UE-to-UE Relay\'s
ephemeral public key (UE2.ePK) and its own ephemeral private key (UE1.eSK).
10) The Source UE sends the UE-to-UE Relay a Direct Security Mode Complete
message.
11) The Source UE and the UE-to-UE Relay finish setting up the secure PC5
communication link with the shared hop-by-hop protection key. The encryption
key and integrity key are derived from the hop-by-hop protection key and used
in the chosen confidentiality and integrity algorithms, respectively.
12) The hop-by-hop security between the UE-to-UE Relay and the Target UE is
established by repeating the step 2-8, where the UE-to-UE Relay initiates the
procedure by sending the Direct Communication Request message.
NOTE: This solution applies to the hop-by-hop security establishment of both
Layer-2 UE-to-UE Relay and Layer-3 UE-to-UE Relay with the Source/Target UE.
The end-to-end security between the Source UE and the Target UE over the UE-
to-UE Relay can be established by Solution #19 in this specification.
#### 6.29.2.2 Authorization and Parameter Provisioning to the UEs
The Source/Target UE and the UE-to-UE Relay are authenticated and authorized
to receive or provide UE-to-UE Relay service by the network during the primary
authentication procedure (i.e. 5G AKA or EAP-AKA\'). A UE initiates the
procedure by sending a Registration Request message to the network. In the
meanwhile, the UDM checks the subscription information, called UE-to-UE
indication, related to the UE-to-UE Relay service. The UE-to-UE indication of
the Source/Target UE indicates:
\- Whether the Source/Target UE is authorized to receive the UE-to-UE Relay
service;
And the UE-to-UE indication of the UE-to-UE Relay indicates:
\- Whether the UE-to-UE Relay is authorized to provide the UE-to-UE Relay
service.
The UE-to-UE indication is transferred from the UDM to the AUSF, and is
forwarded to the UE along with the AKA challenge. Upon reception of the UE-to-
UE indication, which allows the UE to receive or provide the UE-to-UE Relay
service, the UE provides UE-to-UE_Auth_Info, which can be used by the AUSF to
generate security materials for the hop-by-hop security establishment, to the
network along with the AKA challenge response. In the Certificate-based
approach, the UE generates a public and private key pair, and generate UE-to-
UE_Auth_Info including the UE\'s ID and the generated public key. In the
Identity-based approach, the UE generates UE-to-UE_Auth_Info including the
UE\'s ID.
Note 1: Which identifier is to be used as a UE's ID is not addressed in the
present document.
Note 2: How and which entity associates UE's ID with the U2U relay service is
not addressed in the present document.
Note 3: AUSF impact for generating and provisioning security materials to UEs
is not addressed in the present document.
Note 4: How to support U2U relay services across multiple PLMNs is not
addressed in the present document.
If UE-to-UE indication allows the UE to receive or provide the UE-to-UE Relay
service, the AUSF generates the security materials using the UE-to-
UE_Auth_Info and provisions them to the UE. The provisioned security materials
are used as long term credentials of the UE. The authorized UE shall be
provisioned with the security materials when it has not been provisioned with
the security materials before or when the validity of the security materials
has been expired.
Note 5: The security materials provisioned to the UE by the network are
associated with an expiration time after which they become invalid. If the UE
does not have valid security materials, the UE needs to obtain fresh ones to
receive or provide the UE-to-UE Relay service.
In the Certificate-based approach, the security materials include the UE\'s
certificate and the root CA certificate(s), which allows the UE to verify the
certificates of other UEs. In the Identity-based approach, the security
materials include the UE\'s identity, secret signing key (SSK), public
validation token (PVT), and KMS public authentication key(s) (KPAK), which
allows the UE to verify the signatures of other UEs.
If the UE is authorized to receive or provide UE-to-UE service based on UE-to-
UE indication, PCF provides the security policy/parameters to the UE. The
security policy/parameters of the Source/Target UE related to the UE-to-UE
Relay service includes Hop-by-hop Security Indicator per RSC and End-to-end
Security Indicator per RSC. The security policy/parameters of the UE-to-UE
Relay related to the UE-to-UE Relay service includes Hop-by-hop Security
Indicator per RSC:
\- The Hop-by-hop Security Indicator indicates whether the Source/Target UE
requires the hop-by-hop security (signalling integrity, signalling
confidentiality, user plane integrity, and user plane confidentiality)
establishment with the UE-to-UE Relay, or not.
\- The End-to-end Security Indicator indicates whether the Source/Target UE
requires the end-to-end security (signalling integrity, signalling
confidentiality, user plane integrity, and user plane confidentiality)
establishment, or not.
The same hop-by-hop and/or end-to-end protection schemes are supported for the
Source UE, Target UE and UE-to-UE Relay provisioned with the same Hop-by-hop
Security Indicator and/or End-to-end Security Indicator by a service level to
protect the UE-to-UE relay traffic.
### 6.29.3 Evaluation
This solution supports authorization and provisioning of the Source/Target UE
and UE-to-UE Relay for the UE-to-UE Relay Communication service when the UEs
are in the network coverage.
This solution proposes the hop-by-hop security establishment procedure between
the Source/Target UE and the Layer-2 or Layer-3 UE-to-UE Relay using the
provisioned security materials, both within and outside the network coverage.
This solution employs a generic container, which allows different
authentication and key establishment mechanisms such as certificate-based one
and identity-based one to be applied, for the hop-by-hop security
establishment. For example, the \"Elliptic Curve-based Certificateless
Signatures for Identity-based Encryption\" (ECCSI) can be used for the
identity-based direct authentication and key establishment as described in
clause 6.5.7 of TS 33.303 [4].
This solution supports a means for the UEs to agree on the same hop-by-hop
security protection schemes in UE-to-UE Relay service.
The solution requires 5GC to support means of managing security materials,
such as certificates and UEs\' identities, and this may introduce additional
complexities on AUSF, AMF, etc.
## 6.30 Solution #30: Security for discovery integrated into PC5 link
establishment
### 6.30.1 Introduction
The solution addresses Key Issue #1: Security for UE-to-UE Relay discovery and
Key Issue #2: Security of UE-to-UE Relay. It largely reuses the mechanism of
Restricted Discovery procedure and Direct Security Establishment procedure
defined in TS 33.503 [6]
In addition to the Model A discovery and Model B discovery, discovery
integrated into PC5 unicast link establishment procedure is supported in the
U2U Relay scenario, which is concluded by SA2. By broadcasting the DCR
message, the Source UE and Target UE can discover and select one U2U Relay to
establish the PC5 link. However, the broadcast UE identity (i.e. User Info ID)
may compromise the user\'s privacy information and the missing of discovery
procedure may introduce additional security threats, e.g. the unauthorized UE-
to-UE Relay can arbitrarily initiate to establish the PC5 link with peer UE.
This solution uses the code security parameters to protect the privacy-
sensitive information in the DCR message and uses the security materials (i.e.
the long term credential) to secure the link establishment. To obtain the code
security parameters, the peer UE and UE-to-UE Relay need to send the Discovery
Request. Once receiving the Discovery Request, the network can check the
authorization of peer UE and U2U Relay, which reuses the Restricted Discovery
procedure specified in TS 33.503 [6]. By authorization checking and direct
authentication, the hop-by-hop security can be provided between the Source UE
and Target UE via 5G ProSe Layer-3 UE-to-UE Relay.
### 6.30.2 Solution details
#### 6.30.2.1 Security for discovery integrated into PC5 link establishment
{width="6.689583333333333in" height="7.534722222222222in"}
Figure 6.30.2-1: Security for discovery integrated into PC5 link establishment
Note 1: When the user-plane based security procedure for the UE-to-UE Relay is
used, the 5G PKMF takes the role of the 5G DDNMF.
Steps 1a-3a refer to the Discovery Key Request procedure of UE-to-UE Relay.
1a. UE-to-UE Relay sends a Discovery Request message containing its User Info
ID, the Relay Service Code (RSC) to the 5G DDNMF in order to get the
associated security parameters. In addition, the U2U Relay includes its PC5 UE
security capability that contains the list of supported ciphering algorithms
by the UE in the Discovery Request message.
2a. The 5G DDNMF may check for the authorization with the ProSe Application
Server based on the User Info ID and RSC.
3a. The 5G DDNMF of the U2U Relay returns the corresponding code security
parameters, along with the CURRENT_TIME and MAX_OFFSET parameters. The code
security parameters provide the necessary information for the UE-to-UE Relay
to protect the information in the DCR message and are stored with the RSC. The
5G DDNMF of the U2U Relay may include the chosen discovery ciphering algorithm
in the Discovery Response message. The 5G DDNMF determines the chosen
discovery ciphering algorithm based on the RSC and the received security
capability in step 1a. The UE-to-UE Relay stores the chosen discovery
ciphering algorithm together with the RSC.
Steps 1b-3b refer to the Discovery Key Request procedure of Source UE/Target
UE.
1b. The Source UE/Target UE sends a Discovery Request message containing the
User Info ID and its PC5 UE security capability to the 5G DDNMF in order to
get the associated security parameters.
2b. The 5G DDNMF of Source UE/Target UE sends an authorization request to the
ProSe Application Server. If, based on the permission settings, the user Info
ID is allowed to access U2U relay service, the ProSe Application Server
returns an authorization response.
3b. If the Discovery Request is authorized and the PC5 UE security capability
in step 1b includes the chosen discovery ciphering algorithm, the 5G DDNMF
responds with the Discovery Response message including the corresponding Code
Security Parameters and the chosen discovery ciphering algorithm (based on the
information/keys stored in step 3a).Steps 4-14 refer to the discovery
integrated into PC5 unicast link establishment procedure.
4\. The Source UE wants to establish unicast communication with the Target UE
via a UE-to-UE relay. Then the Source UE broadcasts Direct Communication
Request containing User Info ID of Source UE and User Info ID of Target UE,
RSC, long term credential ID, nonce 1 and its security capabilities. The
message will be received by U2U relay-1, U2U relay-2. The User Info ID of
Source UE/Target UE are protected by using the method defined in Clause
6.30.2.2.
Note 2: The long term credential and long term credential ID could be pre-
configured on the 5G ProSe UE (incl. Source UE, Target UE and UE-to-UE Relay).
Note 3: How to pre-configure the long term credential and the long term
credential ID to the UE is out of the 3GPP scope.
5\. The U2U Relay-1 and U2U Relay-2 receive the DCR message and check the RSC.
If they are authorized to provide the Relay service associated with RSC, then
broadcast a new Direct Communication Request message. When a U2U Relay
broadcasts the Direct Communication Request message, it includes User info ID
of Source UE, User info ID of Target UE and User info ID of U2U Relay, long
term credential ID, its nonce 1\' and its security capabilities in the
message.
6\. The Target UE receives the Direct Communication Requests from U2U Relay-1
and U2U Relay-2. The Target UE verifies the DCR message by using the code
security parameters and chooses one U2U relay (e.g. U2U Relay-2). The Target
UE may initiate a Direct Auth and Key Establish procedure with U2U Relay-2 to
generate the K~NRP~.
7\. The Target UE derives the session key (K~NRP-SESS~) from K~NRP~ and then
derive the confidentiality key (NRPEK) (if applicable) and integrity key
(NRPIK) based on the PC5 security policies. The Target UE sends a Direct
Security Mode Command message to the U2U Relay-2. This message includes the
chosen PC5 security algorithm, nonce 2\', and is protected as specified in TS
33.536 [9].
8\. The U2U Relay-2 responds with a Direct Security Mode Complete message to
the Target UE.
9\. Once receiving the Direct Security Mode Complete message from the U2U
relay-2, the Target UE sends the Direct Communication Accept message to the
U2U Relay-2.
10\. The U2U Relay-2 may initiate a Direct Auth and Key Establish procedure
with Source UE to generate the K~NRP~\'.
11\. The U2U Relay-2 derives the session key (K~NRP-SESS~\') from KNRP\' and
then derives the confidentiality key (NRPEK\') (if applicable) and integrity
key (NRPIK\') based on the PC5 security policies. The U2U Relay-2 sends a
Direct Security Mode Command message to the Source UE. This message includes
the chosen PC5 security algorithm, the nonce 2.
12\. The Source UE responds with a Direct Security Mode Complete message to
the U2U Relay-2.
13\. The U2U Relay-2 sends the Direct Communication Accept message to the
Source UE.
14\. The secure L3 PC5 link between the Source UE and the Target UE via the
U2U Relay-2 is established. The U2U Relay-2 can relay the traffic between the
peer UEs.
#### 6.30.2.2 Privacy protection of User Info ID and RSC in DCR
The 5G Prose Source UE encrypts the Source User Info ID, Target User Info ID
and RSC, and the 5G Prose UE-to-UE Relay encrypts the Source User Info ID,
Relay User Info, Target User Info ID and RSC as follows:
1) If the UE is configured with Discovery User Confidentiality Key
(DUCK)/Discovery User Scrambling Key (DUSK), the DCR ciphering key K~DCR~ is
set to DUCK/DUSK. If the UE is configured with both DUCK and DUSK, the K~DCR~
is set to DUCK. If the UE is not configured with DUCK/DUSK, the DCR message is
not protected, and Steps 2-3 are skipped.
2) Set Keystream to DCR confidentiality keystream calculated using K~DCR~,
UTC-based counter, Bearer, Direction, and Length as described in Annex A.7 in
TS 33.503 [6].
3) The KEYSTREAM is XORed with RSC+Source User Info ID+Relay User Info
ID+Target User Info ID for privacy protection.
NOTE 1: If the UE is configured with DUIK, the DCR message is integrity
protected as specified in TS 33.503 [6].
NOTE 2: Which other fields of the DCR message (e.g. relay_indication, etc.)
require protection will be decided in the normative phase.
Note 3: How the security mechanism specified in clause A.7 of TS 33.503 [6] is
applied to DCR protection is not addressed in the present document.
### 6.30.3 Evaluation
This solution addresses KI#1 and KI#2 by largely reusing the mechanisms
defined for Restricted Discovery in TS 33.503 [6].
This solution addresses how the 5G Prose UEs retrieve their discovery
materials associated with RSC to protect its privacy sensitive information in
the case that UE-to-UE Relay Discovery is integrated into PC5 link
establishment.
This solution also addresses how the 5G Prose UEs securely establish the ProSe
Communication via UE-to-UE Relay with Discovery integrated into PC5 unicast
link establishment procedure.
This solution is aligned with the procedure defined in TS 23.304 [8].
For discovery integrated into PC5 link establishment, 5G Prose UEs use the
discovery materials associated with RSC to protect the information in DCR
messages. The provisioning of discovery materials reuses the discovery request
procedure defined in clause 6.1.3.2 of TS 33.503 [6].The discovery request in
sol can be seen as the relay discovery key request in the U2N discovery.
This solution proposes in the solution details that the long term credential
and long term credential ID could be pre-configured on the 5G ProSe UE (incl.
Source UE, Target UE and UE-to-UE Relay). But how to pre-configure the long
term credential and the long term key ID to the UE\'s (incl. Source UE, Target
UE and UE-to-UE Relay) is out of the 3GPP scope.
The long term credential ID is used for peer UE to retrieve the same long term
credential for authentication and key derivation, which has the same
functionality as long term ID in clause 6.5.5.2 of TS 33.303 [4].
## 6.31 Solution #31: Security for discovery integrated into PC5 link
establishment when L3 UE-to-UE relay is in coverage
### 6.31.1 Introduction
The solution addresses Key Issue #1: Security for UE-to-UE Relay discovery and
Key Issue #2: Security of UE-to-UE Relay.
SA2 has concluded to support discovery integrated into PC5 unicast link
establishment procedure in the UE-to-UE Relay scenario. It largely reuses the
mechanism of Restricted Discovery procedure and Direct Security Establishment
procedure defined in TS 33.503 [6].
This solution addresses a L3 UE-to-UE relay. For L3 UE-to-UE relay use cases,
the L3 UE-to-UE relay may be in or out of 3GPP coverage. This solution
provides a mechanism for PC5 security setup procedure between a source UE or
target UE and a L3 UE-to-UE relay when the L3 UE-to-UE relay is in 3GPP
coverage. The solution is based on Solution #1 Alternative 1 of TR 23.700-33
[1].
This solution assumes 5GC NFs e.g. 5GDDNMF and PKMF are deployed in the
network.
### 6.31.2 Solution details
#### 6.31.2.1 Procedure for PC5 security establishment between the 5G ProSe
Source UE and 5G ProSe UE-to-UE Relay and between the 5G ProSe Target UE and
5G ProSe UE-to-UE Relay
Figure 6.31.2.1-1 illustrates the high-level procedure of the proposed
solution.
Figure 6.31.2.1-1: High-level procedure of PC5 security between Source/Target
UE and UE-to-UE relay
1\. The 5G ProSe Source/Target UE and UE-to-UE relay1/UE-to-UE relay2 are
provisioned with the discovery security materials, PC5 security policies
and/or PRUK when they are in coverage.
2\. The 5G ProSe Source UE wants to establish unicast communication with the
5G ProSe Target UE via a UE-to-UE relay. The Source UE broadcasts Direct
Communication Request message. The 5G ProSe Source UE includes source UE info,
target UE info, Application ID, as well as Relay Service Code. It is assumed
the PRUK of the 5G ProSe Source UE is used as root for the PC5 security with
the UE-to-UE relay selected by the 5G ProSe Target UE. The 5G ProSe Source UE
includes also PRUK ID or SUCI of the 5G ProSe Source UE, key freshness
parameter to establish PC5 security as described in TS 33.503 [6]. The message
will be received by UE-to-UE relay-1, UE-to-UE relay-2. The User Info ID of 5G
ProSe Source UE/5G ProSe Target UE are protected by the code security
parameters as defined in the TS 33.503 [6].Editor\'s Note: The details of
Direct Communication Request message (e.g. Application ID) is FFS.
3\. The UE-to-UE relay-1 and the UE-to-UE relay-2 decide to participate in the
procedure. They broadcast a new Direct Communication Invite message in their
proximity to the 5G ProSe Target UE. The Relay UE includes source UE info,
target UE info and Relay UE info (e.g. Relay UE ID) in the message and use
Relay\'s L2 address as the source Layer-2 ID.
NOTE: The need for the new Direct Communication Invite message is not
addressed in the present document.
4\. The 5G ProSe Target UE receives the Direct Communication Invite messages
from UE-to-UE relay1 and UE-to-UE relay2 and selects UE-to-UE relay-2. It is
assumed the PRUK of 5G ProSe Target UE is used as root for the PC5 security
established with the UE-to-UE relay-2 thus the 5G ProSe Target UE sends
another Direct Communication Request to the UE-to-UE relay-2 with PRUK ID or
SUCI of Target UE, key freshness parameter and RSC to establish PC5 security
as described in TS 33.503 [6].
5\. The 5G ProSe UE-to-UE relay-2 sends a Key Request message that contains
PRUK ID or SUCI of the 5G ProSe Target UE, key freshness parameter and RSC
received in step 4 to the 5GC.
6\. The 5GC sends the Key Response message to the 5G ProSe UE-to-UE relay-2,
which includes a key derived from PRUK i.e. K~NRP~.
7a. The 5G ProSe UE-to-UE relay-2 derives the session key from K~NRP~ and then
derive the confidentiality key and integrity key. The 5G ProSe UE-to-UE
relay-2 sends a Direct Security Mode Command message to the 5G ProSe Target
UE.
7b. The 5G ProSe Target UE shall derive the K~NRP~ from its PRUK and then
derive the session key from K~NRP~ and the confidentiality key and integrity
key in the same manner as the 5G ProSe UE-to-UE Relay and process the Direct
Security Mode Command. Successful verification of the Direct Security Mode
Command assures the 5G ProSe Target UE that the 5G ProSe UE-to-UE relay-2 is
authorized to provide the UE-to-UE relay service.
7c. The 5G ProSe Target UE responds with a Direct Security Mode Complete
message to the 5G ProSe UE‑to-UE relay-2.
7d. On receiving the Direct Security Mode Complete message, the 5G ProSe UE-
to-UE relay-2 verifies the Direct Security Mode Complete message. Successful
verification of the Direct Security Mode Complete message assures the 5G ProSe
UE-to-UE relay-2 that the 5G ProSe Target UE is authorized to get the UE-to-UE
relay service.
8\. After successful verification, the 5G ProSe UE-to-UE relay-2 UE responds
with a Direct Communication Accept message to the 5G ProSe Target UE to
complete the PC5 connection establishment procedure.
9\. The 5G ProSe UE-to-UE relay-2 sends another Key Request message that
contains PRUK ID or SUCI of the 5G ProSe Source UE, key freshness parameter
and RSC received in step 2, to the 5GC.
10\. The 5GC sends the Key Response message to the 5G ProSe UE-to-UE relay-2,
which includes a key derived from PRUK i.e. K~NRP~.
11a. The 5G ProSe UE-to-UE relay-2 derives the session key from K~NRP~ and
then derive the confidentiality key and integrity key. The 5G ProSe UE-to-UE
relay-2 sends a Direct Security Mode Command message to the 5G ProSe Source
UE.
11b. The 5G ProSe Source UE derives the K~NRP~ from its PRUK and then derive
the session key from K~NRP~ and the confidentiality key and integrity key in
the same manner as the 5G ProSe UE-to-UE relay-2 and process the Direct
Security Mode Command. Successful verification of the Direct Security Mode
Command assures the 5G ProSe Source UE that the 5G ProSe UE-to-UE relay-2 is
authorized to provide the UE-to-UE relay service.
11c. The 5G ProSe Source UE responds with a Direct Security Mode Complete
message to the 5G ProSe UE‑to-UE relay-2.
11d. On receiving the Direct Security Mode Complete message, the 5G ProSe UE-
to-UE relay-2 verifies the Direct Security Mode Complete message. Successful
verification of the Direct Security Mode Complete message assures the 5G ProSe
UE-to-UE relay-2 that the 5G ProSe Source UE is authorized to get the UE-to-UE
relay service.
12\. After successful verification, the 5G ProSe UE-to-UE relay-2 responds
with a Direct Communication Accept message to the 5G ProSe Source UE to
complete the PC5 connection establishment procedure.
The authorization between UEs is described in steps 7b/7d and steps 11b/11d,
which are following the same practice of UE-to-network relay in R17 as
described in TS 33.503.
### 6.31.3 Evaluation
This solution is for commercial services and public safety and supports the
PC5 communication with a UE-to-UE Relay capable with network-based Relay
service authentication and authorization similar to the UE-to-network relay as
described in clauses 6.3.3.2.2 and 6.3.3.3.2 in TS 33.503 for the PC5 security
establishment when in 3GPP coverage.
This solution only works when the UE-to-UE relay is located within network\'s
coverage area. The 5G ProSe Source/Target and UE-to-UE relay need to store
security materials dedicated to the In-Coverage scenario. Apart from the PC5
signalling, additional user plane/signalling interactions with the network are
required in this mechanism.
This solution supports per-hop links setup. The Source UE initiates the PC5
security link setup with UE-to-UE Relay (first hop) similar to the UE-to-
network relay as defined in TS 33.503. And the UE-to-UE Relay initiates the
PC5 security link setup with the Target UE (second hop). After the Security
Establishment procedure is completed between the UE-to-UE Relay and the Target
UE, the UE-to-UE Relay continues the PC5 security link setup with the Source
UE.
In order to trigger the Target UE to initiate a DCR message, the UE-to-UE
Relay could send a new Direct Communication Invite message that contains Relay
Service Code to the 5G ProSe Target UE. The need for this new message can be
decided during normative work.
This solution is not aligned with TR 23.700-33 [2]. More specifically, the DCR
message sent by Target UE and the DCA sent by U2U Relay is not aligned with TR
23.700-33 [2].
Note: Further evaluation is needed.
## 6.32 Solution #32: Security for discovery integrated into PC5 link
establishment procedure
### 6.32.1 Introduction
The solution addresses Key Issue #1: Security for UE-to-UE Relay discovery and
Key Issue #2: Security of UE-to-UE Relay.
This solution reuses the Direct Security Establishment procedure defined in TS
33.503 [6] with the following extensions:
\- Extend the Direct Communication Request (DCR) by adding a new parameter
(named U2U_Dis_Info) to carry the U2U discovery message.
\- The format of the U2U discovery message put into the DCR is the same as the
normal U2U discovery message.
### 6.32.2 Solution details
Figure 6.32.2-1: Security for discovery integrated into PC5 link establishment
procedure
1\. The Source UE, Target UE and Relay UE are provisioned with U2U discovery
security materials that are used to protect the U2U discovery messages.
2\. The Source UE generates a U2U discovery message that is protected by the
security mechanism specified in KI#1. The format of the U2U discovery message
generated here is the same as the normal U2U discovery message.
3\. The Source UE sends Direct Discovery Request (DCR) with U2U_Dis_Info
parameter to the Relay UE. The U2U_Dis_Info parameter carries the U2U
discovery message.
4\. The Relay UE verifies the received U2U discovery message carried in the
DCR message using U2U discovery security materials, and then generates a new
U2U discovery message for discovering the Target UE. The U2U discovery message
is protected by the security mechanism specified in KI#1.
5\. The Relay UE sends Direct Discovery Request (DCR) with U2U_Dis_Info
parameter to the Target UE. The U2U_Dis_Info parameter carries the new
generated U2U discovery message.
6\. The Relay UE and the Target UE establish a secure connection using the
security mechanism specified in clause 6.2 of TS 33.503 [6]
7\. The Target UE replies with Direct Communication Accept message to complete
the PC5 link establishment with the Relay UE.
8\. The Relay UE and the Source UE establish a secure connection using the
mechanism specified in clause 6.2 of TS 33.503 [6]
9\. The Relay UE replies with Direct Communication Accept message to complete
the PC5 link establishment with the Source UE.
10\. The Source UE and the Target UE establish a secure connection using the
security mechanism specified in KI#2.
Note 1: Alignment with stage 2 integrated discovery is not addressed in the
present document.
Note 2: Justification and content of discovery message in DCR is not addressed
in the present document.
### 6.32.3 Evaluation
This solution addresses the first security requirement of key issue #1 and the
first security requirement of Key issue #2 in the scenario where the discovery
is integrated into PC5 link establishment procedure.
This solution realizes the discovery security through extending the Direct
Communication Request (DCR) by adding a new parameter to carry the U2U
discovery message. The format of the U2U discovery message put into the DCR is
the same as the normal U2U discovery message.
The solution does not address the End-to-End security requirement between the
Source UE and the Target UE.
## 6.33 Solution #33: Security policy negotiation for Layer-3 UE-to-UE Relay
Communication
### 6.33.1 Introduction
This solution addresses Key Issue #5. The Source UE, Target UE and UE-to-UE
Relay are provisioned with the hop-by-hop and end-to-end security policies for
5G ProSe UE-to-UE Relay Communication.
The Source UE, Target UE, and UE-to-UE Relay negotiates and decides whether to
activate or deactivate the hop-by-hop and end-to-end security based on the
provisioned security policies during the security establishment. The solution
largely reuses the security policy handling mechanism of security
establishment procedure defined in TS 33.503 [6].
### 6.33.2 Solution details
Figure 6.33.2-1 illustrates the hop-by-hop and end-to-end security policy
negotiation procedure between the Source UE, Target UE, and UE-to-UE Relay.
Figure 6.33.2-1: Security policy negotiation procedure for the Layer-3 UE-to-
UE Relay Communications
  1. The Source UE, Target UE, and UE-to-UE Relay respectively are provisioned with the hop-by-hop and end-to-end security policies per UE-to-UE Relay service (i.e. RSC: Relay Service Code) by the PCF during the service authorization and provisioning procedure as defined in TS 23.304 [8].
NOTE 1: The Source UE, Target UE, and UE-to-UE Relay may get the security
policies in a different way (e.g. from PKMF, from DDNMF, from ProSe
Application Server, or based on operator configuration).
The hop-by-hop security policies indicate whether the signalling integrity
protection, signalling confidentiality protection, user plane integrity
protection, and user plane confidentiality protection for the hop-by-hop links
are required, preferred, or not needed.
The end-to-end security policies indicate whether the signalling integrity
protection, signalling confidentiality protection, user plane integrity
protection, and user plane confidentiality protection for the end-to-end link
are required, preferred, or not needed.
NOTE 2: The security policies can be configured based on UE-to-UE Relay
service, UE resource constraints, operator policy, etc.
  1. The discovery procedure may be performed between the Source UE, Target UE, and UE-to-UE Relay using Model A or Model B mode as specified in TS 23.304 [8]. If discovery integrated into PC5 unicast link establishment procedure concluded in TR 23.700-33 [2] is to be performed in the following steps, this step is skipped.
  2. The Source UE sends the UE-to-UE Relay a Direct Communication Request message. The message includes the RSC, Source UE\'s hop-by-hop security policies, Source UE\'s end-to-end security policies, and Source UE\'s security capabilities (the list of supported algorithms).
Note 3: Whether to include end-to-end security policies in DCR message to/from
the Relay UE is not addressed in the present document.
Note 4: Whether this solution aligns with TR 23.700-33 [2] is not addressed in
the present document.
3-5. The hop-by-hop security establishment between the Source UE and the UE-
to-UE Relay including security policy negotiation and protection of messages
follows the unicast security mechanism defined in TS 33.503 [6], using the
hop-by-hop security policies.
  1. The UE-to-UE Relay sends the Target UE a Direct Communication Request message. The message includes the RSC, UE-to-UE Relay\'s hop-by-hop security policies, UE-to-UE Relay\'s security capabilities, Source UE\'s end-to-end security policies, and Source UE\'s security capabilities.
7-9. The hop-by-hop security establishment between the UE-to-UE Relay and the
Target UE including security policy negotiation and protection of messages
follows the unicast security mechanism defined in TS 33.503 [6], using the
hop-by-hop security policies.
  1. The Target UE may accept the Direct Communication Request and respond with the Direct Communication Accept message which indicates the activation/deactivation of user plane security protection.
  2. The UE-to-UE Relay may accept the Direct Communication Request and respond with the Direct Communication Accept message which indicates the activation/deactivation of user plane security protection.
12-14. The end-to-end security establishment between the Source UE and the
Target UE over the Layer-2 UE-to-UE Relay including security policy
negotiation and protection of messages follows the unicast security mechanism
defined in TS 33.536 [2], using the end-to-end security policies.
NOTE 3: The end-to-end security establishment procedure between the Source UE
and the Target UE over the Layer-3 UE-to-UE Relay including security policy
negotiation and protection of messages is implemented in the application
layer, using the end-to-end security policies.
  1. The Target UE may accept the Direct Communication Request and respond with the Direct Communication Accept message.
### 6.33.3 Evaluation
This solution provides a means for the UEs in UE-to-UE Relay Communications to
negotiate the hop-by-hop and end-to-end security policies so that the UEs
agree on common protection schemes.
The solution requires separate security policies for hop-by-hop and end-to-end
links.
Note: Further evaluation is needed.
## 6.34 Solution #34: L2 U2U Relay reselection using Re-Keying
### 6.34.1 Introduction
This solution addresses KI #2: Security of UE-to-UE Relay in the Layer-2 UE-
to-UE Relay reselection scenario.
This solution proposes to use the exchange of security parameters during the
UE-to-UE Relay reselection procedure to trigger the establishment of new E2E
security keys used for the security over the second L2 UE-to-UE Relay. The new
E2E keys are established by reusing the re-keying procedure enhanced for the
UE-to-UE Relay reselection scenario. The new security keys are then used for
the security of a new PC5 unicast link between the End UEs via the second
relay. New security keys are necessary since the KNRP-sess is derived per PC5
unicast link, as per TS 33.536, clause 5.3.3.1.2.1. As in the UE-to-Network
Relay scenario, it is assumed that PC5 signalling integrity security policy is
set to \"REQUIRED\".
This solution proposes to use the exchange of security parameters during the
UE-to-UE Relay reselection procedure to trigger the establishment of new E2E
security keys used for the security over the second L2 UE-to-UE Relay. The new
E2E keys are established by reusing the re-keying procedure enhanced for the
UE-to-UE Relay reselection scenario. The new security keys are then used for
the security of a new PC5 unicast link between the End UEs via the second
relay. New security keys are necessary since the K~NRP-sess~ is derived per
PC5 unicast link, as per TS 33.536, clause 5.3.3.1.2.1. As in the UE-to-
Network Relay scenario, it is assumed that PC5 signalling integrity security
policy is set to \"REQUIRED\".
### 6.34.2 Solution details
Figure 6.34.2-1 illustrates the high-level procedure of the proposed solution.
Figure 6.34.2-1: Layer-2 based UE-to-UE Relay reselection using (p)Re-keying
procedure
  1. End UEs have set up per hop PC5 unicast links with Relay#1 using the procedure defined in TS 23.304, clause 6.7.2. A connection for unicast communication between the End UEs is established via Relay#1.
  2. End UE#1 decides to perform U2U Relay reselection with End UE#2 with pre-keying of the new connection via current connection based on current connection security policy/configuration (e.g. signalling integrity is turned ON). End UE#1 allocates new MSB of a link reselection correlation (LRC) ID.
  3. End UE#1 sends to End UE#2 a Link Modification Request message which includes MSB of LRC ID, new connection pre-keying indication and other reselection related parameters, as per TS 23.304 [8], clause 6.7.4.2 (e.g. reselection indication, identifiers of Relay candidates including Relay#2).
  4. End UE#2 allocates LSB of LRC ID and combines MSB and LSB of LRC ID to form a new LRC ID and store LRC ID in a new connection context associated with Relay#2, along End UE#1 info (e.g. User Info ID, KNRP/KNRP ID) and Relay#2 info (e.g. Relay User Info ID, L2 ID).
> End UE#2 sends to End UE#1 a Link Modification Accept message which includes
> ack of new connection pre-keying, LSB of LRC ID and other parameters (e.g.
> identifier of selected Relay#2).
  1. End UE#1 combines MSB and LSB to form a new LRC ID and store the LRC ID in a new connection context associated with Relay#2, along End UE#2 info, Relay#2 info.
End UE#1 sends to End UE#2 via first Relay a Re-keying request message
including an indication for generating new keys for the new connection and the
LRC ID. End UE#1 also includes security parameters as per existing Re-keying
procedure as described in TS 33.536 [6], clause 5.3.3.1.4.4 (e.g. security
capabilities, nonce, MSB of new KNRP-sess ID).
Note: Whether Re-keying request and DSM command procedure are performed via an
existing E2E link is not addressed in the present document.
  1. End UE#2 generates a new session (KNRP-sess) and security keys (NRPEK and NRPIK) and store the keys in the new connection context.
> End UE#2 sends to End UE#1 via Relay#1 a DSM Command message including LRC
> ID and security parameters, as per existing Re-keying procedure. The message
> is protected using the already established security context for current
> connection (e.g. no indication is sent to the lower layer to activate new
> security using new keys).
  1. End UE#1 generates and stores the new security keys in the new connection context. End UE#1 sends to End UE#2 via first Relay a DSM Complete message.
  2. End UE#2 sends to End UE#1 a Re-keying response message confirming that End UE#2 is ready to use new keys in a connection via second relay.
  3. End UEs set up per-hop PC5 unicast links, if not already set up, with Relay#2, by using the procedure defined in TS 23.304, clause 6.7.2. End UE#1 sends to End UE#2 via Relay#2 an integrity protected DCR message including the LRC ID. The message is protected using the new keys associated from the new connection context.
> End UE#2 locates the new connection security keys based on LRC ID and verify
> integrity protection of the DCR message. The authentication and security
> establishment procedures are skipped over the new connection. End UE#2
> activates a security context for the new connection using the new connection
> stored security keys.
>
> UE#2 sends a DCA to End UE#1 fully protected using the security context. End
> UE#1 activates a security context for the new connection using the new
> connection stored security keys located with LRC ID.
### 6.34.3 Evaluation
This solution addresses requirements of KI #2: Security of UE-to-UE Relay
requirements, including during UE-to-UE Relay re-selection.
Impact for the End UEs:
\- support preparation via current UE-to-UE Relay of the new security keys
between the Source UE and Target UE using a modified Re-keying procedure to
generate keys for a new connection (i.e. other than the ongoing connection).
\- support skipping the Direct Authentication and Security Establishment
procedures via the new UE-to-UE Relay by using the new security key located
using LRC ID established during Relay reselection procedure.
There is no impact for the L2 UE-to-UE Relay, as it only needs to perform
regular forwarding of the E2E LMR/LMA, Re-Keying Req/Resp and DCR/DCA messages
between End UEs.
Note 1: Whether this solution enables a fast E2E security setup compared to
existing unicast security setup procedure defined in TS 33.503 is not
addressed in the present document.
Note 2: Further evaluation is needed.
## 6.35 Solution #35: KNRP ID privacy in L2 U2U Relay reselection
### 6.35.1 Introduction
This solution addresses Key Issue #4: Privacy of information over the UE-to-UE
Relay, in the Layer-2 UE-to-UE Relay reselection scenario.
This solution proposes to protect the privacy of KNRP ID shared between the
End UEs. The privacy threat allows to link the connection via the original
Relay to the connection via the new Relay, caused by either the same KNRP ID
or same partial KNRP ID value being sent in the Direct Communication Request
message for the connection via the new Relay. A similar privacy threat and
resolution mechanism are specified in TS 33.536 [6], clause 5.3.3.2.
Two scenarios are supported:
\- Scenario#1: The End UEs maintain the connection via original Relay prior to
the setup of the new connection via the new Relay. New KNRP ID is established
during LMR/LMA procedure.
\- Scenario#2: The End UEs release the connection via original Relay prior to
the setup of the new connection via the new Relay. New KNRP ID is established
during coordinated Link Release procedure for the old connection.
### 6.35.2 Solution details
#### 6.35.2.1 New KNRP ID establishment using LMR/LMA
Figure 6.35.2.1-1 illustrates the high-level procedure of the proposed
solution considering Scenario#1.
Figure 6.35.2.1-1: Layer-2 based UE-to-UE Relay reselection with KNRP ID
change in LMR/LMA
  1. A connection for unicast communication between the End UEs is established via Relay#1.
  2. End UE#1 decides to perform U2U Relay reselection with End UE#2 and to generate a new KNRP ID with End UE#2 based on decision to maintain the current connection via Relay#1.
  3. End UE#1 sends to End UE#2 a Link Modification Request message which includes an indication for the maintenance of the initial connection prior to setup of connection via second Relay, an MSB of KNRP ID and other reselection related parameters, as per TS 23.304 [8], clause 6.7.4.2 (e.g. reselection indication, identifiers of Relay candidates including Relay#2). Newly allocated MSB of KNRP ID, associated with End UE#2, uniquely identifies KNRP in End UE#1.
  4. End UE#2 selects Relay#2 from the list of Relay candidates. End UE#2 allocates LSB of KNRP ID, associated with End UE#1, that uniquely identifies KNRP in End UE#2. End UE#2 combines MSB and LSB of KNRP ID to form a new KNRP ID to be used when reconnecting with End UE#1. End UE#2 replaces old KNRP ID with new KNRP. End UE#2 sends to End UE#1 a Link Modification Accept message which includes LSB of KNRP ID and other parameters (e.g. identifier of selected Relay#2).
  5. End UE#1 combines MSB and LSB of KNRP ID to form a new KNRP ID to be used when reconnecting with End UE#2. End UE#1 replaces old KNRP ID with new KNRP. End UE#1 sends to End UE#2 via Relay#2 a DCR message including the new KNRP ID (a direct PC5 link with Relay#2 may be setup or modified before).
  6. End UE#1 and End UE#2 establish the security for the connection between End UEs via Relay#2. The KNRP ID is used to locate the corresponding KRNP used to derive the session and security keys to secure the connection.
  7. End UE#1 receives from End UE#2 a DCA completing the connection establishment.
#### 6.35.2.2 New KNRP ID establishment using coordinated Link Release
Figure 6.35.2.2-1 illustrates the high-level procedure of the proposed
solution considering Scenario#2.
Figure 6.35.2.2-1: Layer-2 based UE-to-UE Relay reselection with KNRP ID
change in coordinated Link Release
  1. A connection for unicast communication between the End UEs is established via Relay#1.
  2. End UE#1 decides to perform U2U Relay reselection with End UE#2 with coordinated release of the initial connection (prior to new connection setup).
  3. End UE#1 sends to End UE#2 a Link Modification Request message which includes an indication to request a coordinated release of the initial connection via Relay#1 and other reselection related parameters, as per TS 23.304 [8], clause 6.7.4.2.
  4. End UE#2 sends to End UE#1 a Link Modification Accept message which includes an acceptance of the coordinated release of the initial connection via Relay#1 and other reselection related parameters.
  5. End UE#1 sends to End UE#2 a Link Release Request message which includes new MSB of KNRP ID.
  6. End UE#2 sends to End UE#1 a Link Release Response message which includes new LSB of KNRP ID. End UE#2 allocates new LSB of KNRP ID and establishes a new KNRP ID combining received MSB of KNRP ID with new LSB of KNRP ID.
  7. End UE#2 establishes a new KNRP ID combining MSB of KNRP ID with received LSB of KNRP ID. End UE#1 setup a new connection with End UE#2 using the newly established KNRP ID.
### 6.35.3 Evaluation
This solution addresses requirements of Key Issue #4: Privacy of information
over the UE-to-UE Relay requirements, including during UE-to-UE Relay re-
selection.
Impact for the End UEs:
\- Exchange of MSB/LSB of KNRP ID in LMR/LMA procedure or Link Release
procedure (resp. if original connection is maintained or release).
\- Exchange of indication to maintain or release original connection in
LMR/LMA procedure.
There is no impact for the L2 UE-to-UE Relay, as it only needs to perform
regular forwarding of the E2E LMR/LMA, Link Release Req/Resp and DCR/DCA
messages between End UEs.
Note: Further evaluation is needed.
## 6.36 Solution #36: Model A Relay discovery using multiple key sets
### 6.36.1 Introduction
This solution addresses Key Issue #1: Security for UE-to-UE Relay discovery
and Key Issue #3: Authorization in the UE-to-UE Relay Scenario.
This solution proposes to ensure the timely transmission of Relay discovery
announcements by the Relay when transporting protected direct discovery sets.
The solution also proposes a mechanism to support the co-existence of both
approaches (i.e. using single key set and multiple key sets).
Two scenarios are supported:
\- Scenario#1: The End UE is discoverable by actively sending announcement
messages. The Relay provide End UEs with timing about its next announcements
to ensure close to real time transmission of protected direct discovery sets
inside the Relay announcement message.
\- Scenario#2: The End UE is discoverable while being already connected (and
not necessarily announcing) to the Relay. The Relay obtains the protected
direct discovery set from the connected End UE on-demand to ensure close to
real time transmission of the protected direct discovery set inside the Relay
announcement message.
### 6.36.2 Solution details
#### 6.36.2.1 UE-to-UE Relay Scheduling of Direct Discovery Set Announcements
Figure 6.36.2.1-1 illustrates the high-level procedure of the proposed
solution considering Scenario#1.
Figure 6.36.2.1-1: 5G ProSe UE-to-UE Relay Model A Discovery using U2U Relay
announcement scheduling assistance to End UEs
  1. The End UEs are provisioned with direct discovery security parameters (including MAX_OFFSET, CURRENT_TIME) using existing mechanisms defined in TS 33.503 [6], clause 6.1.3.2. The End UEs use the security material for E2E protection of the direct discovery set. The End UEs are also provisioned with relay discovery security parameters for Relay discovery message protection.
  2. Relay decides to advertise Relay announcement timing info based on an indication that RSC supports per direct discovery set protection. An example of timing info is a time window for when the Relay expects to receive the End UE\'s announcement for the End UE to be announced via the next Relay announcement.
NOTE 1: other examples of timing info (e.g. deadline, announcing cycle) can be
considered during normative phase
Note 1a: Whether announcement timing info is needed is not addressed in the
present document.
Note 1b: How a timing info is configured and provisioned to End UEs and U2U
relay is not addressed in the present document.
Note 1c: Whether a timing info (i.e., time window) is related to a UTC-based
time counter is not addressed in the present document.
  1. U2U Relay sends a U2U Relay protected discovery message including RSC, U2U Relay User info ID and announcement timing info.
  2. End UE#1 (Announcing) schedules its next announcement message including a protected direct discovery set based on the received advertised Relay announcement timing info (e.g. ensures a timely transmission within advertised time window). End UE#2 (Monitoring) aligns its listening for Relay Announcement messages based on the received advertised Relay announcement timing info.
NOTE 2: How the End UE handle announcement with timing info from multiple
eligible Relays is left to normative phase.
  1. End UE#1 sends a protected U2U Relay discovery message including RSC, and a protected direct discovery set from End UE#1.
Note 6: The new procedure (step 2 and 4) needs to be aligned with stage 2
procedure is not addressed in the present document.
  1. U2U Relay verifies that Announcement message from End UE#1 is received within the acceptable time based on advertised Relay announcement timing info. U2U Relay discards the Announcement message from End UE#1 if not compliant with advertised Relay announcement timing info (e.g. outside time window).
  2. U2U Relay sends a protected U2U Relay protected discovery message including RSC, U2U Relay User info ID the protected direct discovery set received from End UE#1 according to advertised announcement timing info. End UE#2 (Monitoring) receives the Relay Announcement at a time aligned with Relay advertised announcement timing info and discovers End UE#1 presence following the successful processing of the Relay discovery message and included protected direct discovery set of End UE#1.
#### 6.36.2.2 U2U Relay on-demand direct discovery set protection
Figure 6.36.2.2-1 illustrates the high-level procedure of the proposed
solution considering Scenario#2.
Figure 6.36.2.2-1: 5G ProSe UE-to-UE Relay Model A Discovery using U2U Relay
using on-demand direct discovery set protection
  1. The End UEs are provisioned with discovery security parameters (including MAX_OFFSET, CURRENT_TIME) for the direct discovery set using existing mechanisms defined in TS 33.503 [6], clause 6.1.3.2. The End UEs use the security material for E2E protection of the direct discovery set. The End UEs are also provisioned with relay discovery security parameters for Relay discovery message protection.
```{=html}
``` 1\. A prior connection for unicast communication between the End UE#1 with
another End UE (i.e. not shown, other End UE#3) is established via Relay#1 for
a given Prose Service. This prior communication is established following a
prior discovery procedure (e.g. using mechanism as in scenario#1 or other
standalone discovery method) or using direct communication with integrated
discovery (see TS 23.304, clause 6.7.3). The End UE sends with the RSC a ProSe
Restricted code associated with the Prose Service in the DCR message to the
U2U Relay, if the RSC is configured with an indicator for per direct discovery
set protection. Alternatively, the End UE sends the ProSe Restricted code
after the DCR (e.g. using LMR/LMA). The Relay verifies that the RSC supports
per direct discovery set protection and stores the ProSe Restricted code in
the PC5 unicast link context.
  1. U2U Relay decides to announce connected UEs.
  2. For each of the connected End UE with a stored ProSe Restricted Code, the U2U Relay sends a secure PC5-S request message including the ProSe Restricted Code for the Prose Service previously received from End UE#1 to request a corresponding protected direct discovery set. The PC5-S request messages is protected using the per hop PC5 link security context between the Relay and End UE.
Note a: Whether PC5-S Request and PC5-S Response message is needed is not
addressed in the present document.
  1. End UE#1 generates a secure PC5-S response message including RSC and a direct discovery set protected using the provisioned direct discovery security material. The End UE#1 protects the PC5-S message using the per hop PC5 link security context and sends it to U2U Relay.
  2. U2U Relay processes the PC5-S response message security and extracts the included protected direct discovery set(s). U2U Relay sends a U2U Relay protected discovery message including RSC, U2U Relay User info ID the protected direct discovery set received from End UE#1. U2U Relay protects the U2U Relay discovery message using the security material associate with the RSC. End UE#2 processes the security of the Relay discovery message security and of the included protected direct discovery set to discover End UE#1.
NOTE: How the Relay ensures the included protected direct discovery set(s) are
not stale is left to normative phase
### 6.36.3 Evaluation
This solution addresses Key Issue #1: Security for UE-to-UE Relay discovery
and Key Issue #3: Authorization in the UE-to-UE Relay Scenario.
The solution also proposes a mechanism to support the co-existence of both
approaches (i.e. using single key set and multiple key sets) using a
configuration parameter for the RSC indicating support for protected direct
discovery sets.
Impact for the End UEs and Relay:
\- Support for on demand delivery of protected direct discovery to Relay
(Connected).
\- Support for RSC indicator for protected direct discovery sets.
Note: Further evaluation is needed.
## 6.37 Solution #37: PC5 link establishment with secure integrated discovery
### 6.37.1 Introduction
This solution addresses KI#1 Security for UE-to-UE Relay discovery and KI#2
Security of UE-to-UE Relay.
The solution describes means to protect a Direct Communication Request message
with Integrated Discovery, proposes a new field (i.e.
\"integrated_discovery_indication\"), and describes the security establishment
procedures that Target-UE could perform, to establish a secure link with a UE-
to-UE relay and Source-UE, based on its evaluation of the DCR messages
received and its path selection preferences.
### 6.37.2 Solution details
{width="6.689583333333333in" height="5.011805555555555in"}
Figure 6.37.2-1 PC5 link establishment with secure integrated discovery
0\. Source, Target, and UE-to-UE Relays are provisioned with security
policies, discovery security materials and parameters to enable the
establishment of secure PC5 links with a UE-to-UE relay and Source-UE.
NOTE 1: the security parameters and corresponding provisioning procedure will
be decided in normative phase.
1\. Source UE constructs the DCR message including a Direct Discovery set, a
UE-to-UE Discovery set, and fields specific to the DCR message e.g. Security
Information, relay indication, and an integrated_discovery_indication. Source-
UE protects the Direct Discovery set and the integrated_discovery_indication
using the Direct Code-sending security parameters, and the whole DCR message
is protected with the UE-to-UE relay Code-sending security parameters, whereby
the Direct Discovery set and integrated_discovery_indication are not
confidentiality protected.
Note 1a: Whether E2E protection in integrated discovery is required to
maintain consistency with UE-to-UE discovery procedures and/or 5G ProSe Direct
communication is not addressed in the present document.
NOTE 2: The field integrated_discovery_indication indicates to Target-UE
whether the discovery message is integrated into a DCR.
2\. When a UE-to-UE Relay receives the DCR message, it descrambles/decrypts,
and integrity verifies it. If integrity verification succeeds, the UE-to-UE
relay removes the relay indication, and constructs another DCR message (e.g.
DCR~1~ or DCR~2~) as in step 1\.
2.a If the relay e.g. UE-to-UE Relay~1~, identifies Target-UE and a secure
link is already established with Target-UE, UE-to-UE Relay~1~ uses the
security keys corresponding to the already established security context with
Target-UE to protect DCR~1~.
Note 2a: How a UE-to-UE Relay identifies the Target-UE is not addressed in the
present document.
2.b If the relay, e.g. UE-to-UE Relay~2~, cannot identify Target-UE or does
not have a security context established with it, UE-to-UE Relay~2~ uses the
UE-2-UE Code-sending security parameters to protect DCR~2~.
NOTE 3: UE-to-UE Relay2 could protect DCR2 by re-using the same UE-2-UE Code-
sending security parameters used to protect the DCR message.
3.a/b UE-to-UE Relay~1~ and UE-to-UE Relay~2~ transmit DCR~1~ and DCR~2~ to
Target-UE.
4\. As Target-UE may receive several DCR messages (e.g. from one or multiple
UE-to-UE relays). When applicable, Target-UE unscrambles/decrypts, and
verifies the integrity of the received DCR message with the corresponding keys
(either corresponding to an existing security context or UE-2-UE Code-
receiving security parameters). Then, the target-UE uses the Direct Code-
receiving security parameters to decrypt, and integrity verify the Direct
discovery set including integrated_discovery_indication.
Based on the received the DCR messages and Target-UE\'s path selection
preferences in step 4, a secure link is established with Source-UE in either
one of the following ways:
**Case 1: Target-UE selects a communication path going through UE-to-UE
Relay~1~: **
5.a Since a security context is already established, the Direct auth and Key
Establishing, and Direct Security Mode Command procedures are skipped,
instead, Target-UE sends a Direct Communication Accept to UE-to-UE Relay~2~.
6.a/7.a/8.a correspond to the establishment of a secure link between Source-UE
and UE-to-UE Relay~1~.
9.a Source-UE and Target-UE establish an end-to-end secure link through UE-to-
UE Relay~1~.
Case 2: Target-UE selects a communication path going through UE-to-UE
Relay~2~:
5.b/6.b/7.b correspond to the establishment of a secure link between UE-to-UE
Relay~2~ and Target-UE.
8.b/9.b/10.b correspond to the establishment of a secure link between UE-to-UE
Relay~2~ and Source-UE.
11.b. Source-UE and Target-UE establish an end-to-end secure link through UE-
to-UE Relay~2~.
NOTE 4: This solution is applicable to both L2 and L3 UE-to-UE relay
scenarios.
NOTE 5: Secure hop-by-hop or end-to-end links between UE-to-UE Relays and End-
UEs, and between Ends UEs are established as described in clause 5.3 of TS
33.536 [1], based on Security Information in the DCR message.
### 6.37.3 Evaluation
None.
# 7 Conclusions
## 7.1 Key Issue #1: Security for UE-to-UE Relay discovery
The following text is taken as a conclusion for the UE-to-UE Relay discovery:
The two sets of discovery security materials are used for UE-to-UE Relay
discovery message protection. One is used for protecting direct discovery set.
The other one is used for protecting the U2U relay discovery message.
Provisioning of discovery security materials for the direct discovery set
reuses the security material provisioning mechanism for Restricted 5G ProSe
Direct Discovery as specified in TS 33.503 [6].
Provisioning of discovery security materials for the U2U relay discovery
message reuses the security material provisioning mechanism for 5G ProSe UE-
to-Network Relay discovery as specified in TS 33.503 [6].
## 7.2 Key Issue #2: Security of UE-to-UE Relay
For Key Issue #2, the following statements are agreed:
NOTE: The choice and co-existence of the security mechanisms in different use
cases (i.e. U2U Relay in and out of coverage) will be decided in normative
phase.
Regarding End-to-End security:
For L2 relay, the End UEs (Source UE and/or Target UE) reuse the unicast mode
security mechanism defined in clause 5.3.3.1 of TS 33.536 [6] to establish a
secure connection via the Relay UE.
For L3 relay, End-to-End security can be supported in the application layer
which is out of 3GPP scope.
Regarding hop-by-hop security during PC5 link establishment in Layer 3/Layer 2
UE-to-UE Relay Communication:
\- When the Layer 3/Layer 2 UE-to-UE Relay is in 3GPP coverage, the End UE and
the UE-to-UE Relay can establish a secure PC5 link with network assistance.
The similar security procedure as PC5 security for 5G ProSe Communication via
5G ProSe Layer-3 UE to-Network Relay as defined in clause 6.3 in TS 33.503 [6]
can be reused.
\- The solutions for UE-to-UE Relay authorisation and security can be
classified as user-plane (UP) or controlled-plane (CP) based solutions. It is
concluded that both control plane and user plane solutions are supported for
5G ProSe Layer 2 UE-to-UE Relay and 5G ProSe Layer 3 UE-to-UE relay.
\- When the Layer 3/Layer 2 UE-to-UE Relay is out of 3GPP coverage, the End UE
and the UE-to-UE Relay can establish a secure PC5 link without network
assistance. The similar security procedure as PC5 security for unicast mode 5G
ProSe Direct Communication as defined in clause 6.2.3 in TS 33.503 [6] can be
reused.
## 7.3 Key issue #3: Authorization in the UE-to-UE Relay Scenario
For Key Issue #3, the following statement is agreed:
The PCF based service authorisation as defined in TS 23.304 [3] is reused as
the basis for normative work of service authorisation for UE-to-UE Relay
operation.
Authorization in the UE-to-UE Relay Scenario is performed during discovery
security material provision procedure and U2U relay discovery procedure.
During hop-by-hop PC5 link establishment in Layer 3 and Layer 2 UE-to-UE Relay
Communication, when the Layer 3 and Layer 2 UE-to-UE Relay is in 3GPP
coverage, the existing procedures specified in clause 6.3 in TS 33.503 [6] can
be re-used between the Ends UE (Source UE and/or Target UE) and (Layer 3 and
Layer 2) the UE-to-UE Relay for authorization.
## 7.4 Key Issue #4: Privacy of information over the UE-to-UE Relay
For Key Issue #4, the following is agreed:
\- For Layer 3 UE-to-UE relay communication privacy, enhanced Link Identifier
Update (LIU) procedure, Sol#2 is used as basis for normative work.
## 7.5 Key Issue #5: Security of source and target UE communication via U2U
relay
## 7.6 Key Issue #6: Support for Emergency service over UE-to-Network Relaying
For Key Issue #6, the following is agreed:
Solution #27 is selected for the normative work for emergency call via Layer 2
UE-to-Network Relay and Layer 3 UE-to-Network Relay.
NOTE: The SMF of the 5G ProSe UE-to-Network Relay is able to resolve a CP-PRUK
ID or UP-PRUK ID of the 5G ProSe Remote UE into a SUPI of the 5G ProSe Remote
UE as specified in clause 6.3 of TS 33.503 [6].
#
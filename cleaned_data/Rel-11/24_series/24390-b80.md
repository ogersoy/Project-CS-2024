# Foreword
This Technical Specification has been produced by the 3^rd^ Generation
Partnership Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
Y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# 1 Scope
The present document describes the procedures for using Unstructured
Supplementary Service Data (USSD) operations for mobile initiated MMI mode
over IP Multimedia Core Network Subsystem (IMS). MMI mode is for the
transparent transport of MMI strings entered by the user to the Application
Servers (AS) and for the transparent transport of text strings back to the
User Equipment (UE) to be displayed for user information. Support of USSD
service is optional and only applicable for an operator\'s Public Land Mobile
Network (PLMN).
The present document is applicable to UE and AS which are intended to support
USSD operations over IP Multimedia Core Network Subsystem (IMS) in mobile
initiated MMI mode.
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or non‑specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
[1] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[2] IETF RFC 6086 (January 2011): \"Session Initiation Protocol (SIP) INFO
Method and Package Framework\".
[3] 3GPP TS 24.090: \" Unstructured Supplementary Service Data (USSD); Stage
3\".
> [4] 3GPP2 X.S0065-0 v1.0 (April 2012): \"Unstructured Supplementary Service
> Data (USSD) Support\".
[5] 3GPP TS 24.080: \"Mobile radio interface layer 3 supplementary services
specification; Formats and coding\".
[6] 3GPP TS 24.229: \"IP multimedia call control protocol based on Session
Initiation Protocol (SIP) and Session Description Protocol (SDP); Stage 3\".
[7] IETF RFC 4967 (July 2007): \"Dial String Parameter for the Session
Initiation Protocol Uniform Resource Identifier\".
[8] 3GPP TS 24.238: \"Session Initiation Protocol (SIP) based user
configuration; Stage 3\".
[9] IETF RFC 4288 (December 2005): \"Media Type Specifications and
Registration Procedures\".
[10] IETF RFC 3023: \"XML Media Types\".
[11] IETF RFC 3261: \"SIP: Session Initiation Protocol\".
[12] IETF RFC 5646 (September 2009): \"Tags for Identifying Languages\".
# 3 Definitions, symbols and abbreviations
## 3.1 Definitions
For the purposes of the present document, the terms and definitions given in
3GPP TR 21.905 [1] and the following apply. A term defined in the present
document takes precedence over the definition of the same term, if any, in
3GPP TR 21.905 [1].
## 3.2 Abbreviations
For the purposes of the present document, the abbreviations given in 3GPP TR
21.905 [1] and the following apply. An abbreviation defined in the present
document takes precedence over the definition of the same abbreviation, if
any, in 3GPP TR 21.905 [1].
AS Application Server
IMS IP Multimedia core network Subsystem
UE User Equipment
USSD Unstructured Supplementary Service Data
USSI Unstructured Supplementary Service Data over IM CN subsystem
# 4 USSD using IMS
## 4.1 Introduction
This service provides the support for UE initiated MMI-mode USSD operations,
which enables the transparent transport of MMI strings entered by the user to
the IM core network and enables the transparent transport of text strings from
the IM core network which are displayed by the UE for user information.
## 4.2 Description
There is no service description.
## 4.3 Operational requirements
There are no operational requirements.
## 4.4 Coding requirements
There are no coding requirements over and above those specified in
3GPP°TS°24.229°[6].
## 4.5 Signalling requirements
### 4.5.1 General
In the IM CN subsystem USSD messages can be transported in SIP INFO requests,
SIP INVITE requests and SIP BYE requests, using a
application/vnd.3gpp.ussd+xml MIME body.
Figure 4.1 and figure 4.2 give an overview of the supported USSD operations:
UE USSI AS
INVITE
\------------------------------------------------------------------------------------------------------------------------>
language, ussd-String
BYE
\
language, ussd-String
INFO
\
language, ussd-String
INFO
\- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - \- -
- - - - - - - - ->
Error
.
.
.
BYE
\ XML element is used.
In order to send the initial USSD message, the UE shall send an initial INVITE
request, according to 3GPP TS 24.229 [6]. The UE shall populate the request as
follows:
1) Request-URI set to a SIP URI with user part including the USSD string and a
\"phone-context\" parameter set to the home network domain name used in
REGISTER request according to TS 24.229 [6], a host part set to the home
netwok domain name used in REGISTER request as defined in TS 24.229 [6] a
\"user\" URI parameter set to value \"dialstring\" as specified in RFC 4967
[7];
2) Recv-Info header field containing the g.3gpp.ussd info-package name;
3) Accept header field containing the application/vnd.3gpp.ussd+xml,
application/sdp and multipart/mixed MIME types;
4) the Content-Type header, which shall contain \"multipart/mixed\";
5) SDP offer as described in subclause 4.5.2; and
6) application/vnd.3gpp.ussd+xml MIME body as described in subclause 5.1.3
with a Content-Disposition header field set to \"render\" and with
\"handling\" header field parameter set to \"optional\". The XML document
shall contain a single \ element and may contain a \
element.
When receiving an INFO request with Info-Package header field containing the
g.3gpp.ussd info-package and containing application/vnd.3gpp.ussd+xml MIME
body associated with the info package according to IETF RFC 6086 [2], the UE
shall, in addition to the procedures specified in 3GPP TS 24.229 [6]:
1) if the UE is able to process the received information, send an INFO request
within the dialog, according to 3GPP TS 24.229 [6]. The UE shall populate the
INFO request as follows:
a) Info-Package header field containing the g.3gpp.ussd info-package name; and
b) application/vnd.3gpp.ussd+xml MIME body as described in subclause 5.1.3,
associated with the info package according to IETF RFC 6086 [2] containing the
user\'s response in a \ element and optionally a \
element; and
2) if the UE is not able to process the received information or rejects the
received information, send an INFO request within the dialog, according to
3GPP TS 24.229 [6]. The UE shall populate the INFO request as follows:
a) Info-Package header field containing the g.3gpp.ussd info-package name; and
b) application/vnd.3gpp.ussd+xml MIME body as described in subclause 5.1.3,
associated with the info package according to IETF RFC 6086 [2] containing an
\ element.
When receiving a BYE request containing application/vnd.3gpp.ussd+xml MIME
body, the UE shall, in addition to the procedures specified in 3GPP TS 24.229
[6] handle the application/vnd.3gpp.ussd+xml MIME body.
NOTE 2: According to 3GPP TS 24.229 [6], the UE can receive a BYE request
without the application/vnd.3gpp.ussd+xml MIME body and in this case the
dialog is terminated immediately.
#### 4.5.4.2 Actions at the AS
In addition to the procedures specified in this subclause, the USSI AS shall
support the procedures specified in 3GPP TS 24.229 [6] for an AS.
NOTE 1: The Content-Language SIP header field is not used to determine the
language of the USSD string. Only the \ XML element is used.
Upon receiving an initial INVITE request with Request-URI containing the SIP
URI including the USSD string and a \"user\" URI parameter set to value
\"dialstring\" as specified in RFC 4967 [7], if the
application/vnd.3gpp.ussd+xml MIME body contained in the request is accepted
by the USSI AS, the USSI AS shall:
1) pass the USSD data received in the body of the SIP INVITE request to the
USSD application handling and wait for the response of the application;
NOTE 2: How the USSD data are processed at the USSI AS is outside the scope of
this specification. The USSI AS can handle the USSD dialogs or forward the
USSD requests and responses to/from a legacy USSD server.
NOTE 3: The USSD string in the request-URI is not passed to the USSD
application handling. In case of discrepancy between this string and the
\ element contained in the MIME body, the behaviour of the AS is
determined by the \ in the MIME body.
2) send 200 (OK) response to the request following the procedures specified
for AS acting as a terminating UA in 3GPP TS 24.229 [6]. The USSI AS shall
populate the 200 (OK) response to the request as follows:
a) Recv-Info header field containing the g.3gpp.ussd info-package name;
b) Accept header field containing the application/vnd.3gpp.ussd+xml,
application/sdp and multipart/mixed MIME types; and
c) SDP answer as described in subclause 4.5.2.
Upon receiving an ACK request associated with the INVITE request, the USSI AS
shall:
1) if the network requests further information in order to perform the USSD
operation, send an INFO request within the dialog created by the INVITE
request. The USSI AS shall populate the INFO request as follows:
a) Info-Package header field containing the g.3gpp.ussd info-package name; and
b) application/vnd.3gpp.ussd+xml MIME body as described in subclause 5.1.3,
associated with the info package according to IETF RFC 6086 [2] including a
\ element and a \ element;
2) if the network successfully performed the USSD information and does not
need any further information, send a BYE request in order to terminate the
dialog. The USSI AS shall populate the BYE request with
application/vnd.3gpp.ussd+xml MIME body, as described in subclause 5.1.3
including a \ element and a \ element; and
3) if the network informs the UE that the network is unable to process the
USSD request or the network informs the UE that the network rejects the USSD
request, send a BYE request in order to terminate the dialog. The USSI AS
shall populate the BYE request with application/vnd.3gpp.ussd+xml MIME body,
as described in subclause 5.1.3, including, a \ element.
Upon receiving a SIP INFO request with Info-Package header field containing
the g.3gpp.ussd info-package and a application/vnd.3gpp.ussd+xml MIME body
associated with the info package according to IETF RFC 6086 [2], the USSI AS
shall handle the SIP INFO request following the procedures specified for AS
acting as a terminating UA in 3GPP TS 24.229 [6] and generate a SIP response
as described in 3GPP TS 24.229 [6]. If the SIP response is a 2xx response, the
USSI AS shall:
1) pass the USSD data received in the body of the SIP INFO request to the USSD
application handling and wait for the response of the application;
NOTE 4: How the USSD data are processed at the USSI AS is outside the scope of
this specification. The USSI AS can handle the USSD dialogs or forward the
USSD requests and responses to/from a legacy USSD server.
2) if the network requests further information in order to perform the USSD
operation, send an INFO request within the dialog. The USSI AS shall populate
the INFO request as follows:
a) Info-Package header field containing the g.3gpp.ussd info-package name; and
b) application/vnd.3gpp.ussd+xml MIME body as described in subclause 5.1.3,
associated with the info package according to IETF RFC 6086 [2] including a
\ element and a \ element;
3) if the network successfully performed the USSD information and does not
need any further information, send a BYE request in order to terminate the
dialog. The USSI AS shall populate the BYE request with
application/vnd.3gpp.ussd+xml MIME body, as described in subclause 5.1.3
including a \ element and a \ element; and
4) if the network informs the UE that the network is unable to process the
USSD request, or the network informs the UE that the network rejects the USSD
request, send a BYE request in order to terminate the dialog. The USSI AS
shall populate the BYE request with application/vnd.3gpp.ussd+xml MIME body,
as described in subclause 5.1.3, including, a \ element.
## 4.6 Interaction with other services
### 4.6.1 Originating Identification Presentation (OIP)
There are no interaction requirements with OIP.
### 4.6.2 Originating Identification Restriction (OIR)
There are no interaction requirements with OIR.
### 4.6.3 Terminating Identification Presentation (TIP)
There are no interaction requirements with TIP.
### 4.6.4 Terminating Identification Restriction (TIR)
There are no interaction requirements with TIR.
### 4.6.5 Communication Diversion (CDIV)
There are no interaction requirements with CDIV. CDIV is not applicable for
USSI.
### 4.6.6 Communication Hold (HOLD)
There are no interaction requirements with HOLD.
### 4.6.7 Communication Barring (CB)
There are no interaction requirements with CB. CB is not applicable for USSI.
### 4.6.8 Message Waiting Indication (MWI)
There are no interaction requirements with MWI.
### 4.6.9 Conference (CONF)
There are no interaction requirements with CONF.
### 4.6.10 Explicit Communication Transfer (ECT)
There are no interaction requirements with ECT.
### 4.6.11 Advice Of Charge (AOC)
There are no interaction requirements with AOC.
### 4.6.12 Closed User Groups (CUG)
There are no interaction requirements with CUG.
### 4.6.13 Three-Party (3PTY)
There are no interaction requirements with CUG.
### 4.6.14 Flexible Alerting (FA)
There are no interaction requirements with FA.
### 4.6.15 Communication Waiting (CW)
There are no interaction requirements with CW.
### 4.6.16 Completion of Communications to Busy Subscriber (CCBS)
There are no interaction requirements with CCBS.
### 4.6.17 Completion of Communications by No Reply (CCNR)
There are no interaction requirements with CCNR.
### 4.6.18 Customized Alerting Tones (CAT)
There are no interaction requirements with CAT.
### 4.6.19 Customized Ringing Signal (CRS)
There are no interaction requirements with CRS.
### 4.6.20 Personal Network Management (PNM)
There are no interaction requirements with PNM.
### 4.6.21 Malicious Communication Identification (MCID)
There are no interaction requirements with MCID.
### 4.6.22 SIP based user configuration
Based on filter criteria, an initial INVITE request including a dialstring and
an optional XML body as described in subclause 4.5.1 can be forwarded either
to an AS supporting SIP based user configuration as specified in 3GPP TS
24.238 [8] or to an AS supporting USSI as specified in this specification.
An AS supporting USSI and SIP based user configuration as specified in 3GPP TS
24.238 [8], shall handle an initial INVITE request as described in subclause
4.5.1 according to this specification.
NOTE: If an AS supports only SIP based user configuration as specified in 3GPP
TS 24.238 [8], an initial INVITE request as described in subclause 4.5.1 is
handled according to 3GPP TS 24.238 [8].
## 4.7 Service configuration
User self configuration is not applicable to USSD using IMS.
# 5 Extensions within the present document
## 5.1 INFO Package for transport of USSD information
### 5.1.1 Scope
This subclause contains the information required for the IANA registration of
info package g.3gpp.ussd in accordance with IETF RFC 6086 [2].
### 5.1.2 g.3gpp.ussd info package
#### 5.1.2.1 Overall description
3GPP TS 24.390 describes the procedures for using Unstructured Supplementary
Service Data (USSD) (3GPP TS 24.090 [3] and 3GPP2 X. S0065 [4]) operations in
the IP Multimedia Core Network Subsystem (IMS). SIP INFO requests are used to
carry information associated with USSD, using the g.3gpp.ussd info package.
Every SIP INFO request associated with the g.3gpp.ussd info package carries a
single application/vnd.3gpp.ussd+xml MIME body associated with the info
package according to IETF RFC 6086 [2].
NOTE: According to the procedures in IETF RFC 6086 [2], the SIP INFO response
will not contain a MIME body. A message associated with a USSD operation is
always sent in SIP INFO request.
In a given dialog, when a UA sends an INFO request associated with the
g.3gpp.ussd info package, then until receiving an INFO request associated with
the g.3gpp.ussd info package, the UA does not send another INFO request
associated with the g.3gpp.ussd info package.
#### 5.1.2.2 Applicability
A number of solutions were discussed for the transportation of USSD
information between the UE and the USSD AS. The solutions were:
1) use of subscription to the USSD event package as specified in IETF RFC
4575;
2) use of the session related methods (e.g. SIP 200 (OK) response to the SIP
INVITE request);
3) use of the SIP MESSAGE method;
4) use of media plane mechanisms; and
5) use of the SIP INFO method as described in IETF RFC 6086, by defining a new
info package.
Furthermore, each of the solutions 1), 2), 3), 4) and 5) were evaluated.
The use of a USSD event package was discounted as the usage of
subscribe/notify mechanism for two-way communication is not appropriate since
subscribe/notify mechanism is to provide one-way communication consisting of
notifications from notifier to subscriber indicating that certain events in
notifier have occurred.
The use of session related methods for USSD messages other than the initial
USSD message and last USSD message was discounted as it was concluded that
usage of UPDATE method for transport of USSD message would have side effect of
impacting dialog configuration (e.g. possibly changing the remote contact
URI).
Use of the SIP MESSAGE method was discounted since USSD is dialog based and
all information exchange has to be part of the related session.
Use of the media plane mechanisms was discounted because the amount of USSD
messages in a dialog is normally very small (normally only 2) and overhead
caused by user plane setup (e.g. if MSRP is used as transport) would be
disproportionately big in comparion to the actual USSD message size.
Based on the above analyses, the SIP INFO method was chosen to transport the
USSD information between the UE and the USSD AS.
#### 5.1.2.3 Info package name
g.3gpp.ussd
#### 5.1.2.4 Info package parameters
None defined.
#### 5.1.2.5 SIP options tags
None defined.
#### 5.1.2.6 INFO message body parts
The MIME type of the message body carrying the information associated with
USSD is application/vnd.3gpp.ussd+xml. application/vnd.3gpp.ussd+xml MIME type
is defined in 3GPP TS 24.390.
When associated with the g.3gpp.ussd info package, the Content-Disposition
value of the message body carrying the information associated with USSD is
\"info-package\".
#### 5.1.2.7 Info package usage restrictions
None defined.
#### 5.1.2.8 Rate of INFO Requests
No maximum rate or minimum rate is defined for sending INFO requests
associated with the g.3gpp.ussd info package.
For most USSD usages, normally zero, one, or a few, SIP INFO requests are
generated in the SIP session by each participating user agent.
#### 5.1.2.9 Info package security considerations
The security is based on the generic security mechanism provided for the
underlying SIP signalling. No additional security mechanism is defined.
#### 5.1.2.10 Implementation details and examples
UAC generation of INFO requests: See 3GPP TS 24.390:\" Unstructured
Supplementary Service Data (USSD) using IP Multimedia (IM) Core Network (CN)
subsystem IMS; Stage 3\"
Examples: See 3GPP TS 24.390: \" Unstructured Supplementary Service Data
(USSD) using IP Multimedia (IM) Core Network (CN) subsystem IMS; Stage 3\"
### 5.1.3 application/vnd.3gpp.ussd+xml MIME type
#### 5.1.3.1 Scope
This subclause contains the information required for the IANA registration of
the application/vnd.3gpp.ussd+xml MIME type in accordance with IANA
registration procedures.
#### 5.1.3.2 application/vnd.3gpp.ussd+xml
The MIME type is used to carry USSD related information between the UE and the
network. It is coded as an XML document and contains one or more of the
following information:
\- USSD language
\- USSD string
\- USSD error code as defined in subclause 5.1.3.3 of this specification
NOTE: The information elements cannot be present twice in the XML body.
An instance of the XML document is shown below:
\
\
\en\
\*135#\
\
#### 5.1.3.3 Data semantics
\ is coded as defined in IETF RFC 5646 [12] and shall contain
exactly one subtag.
\ is coded as a string.
\ is an integer. The following values are defined. If the received
value is not listed below, it must be treated as 1.
1 error - unspecified
2 language/alphabet not supported
3 unexpected data value
\ contains optional elements defined by future version of this
document.
Entity receiving the XML body ignores any unknown XML element and any unknown
XML attribute.
NOTE: \"unexpected data value\" is used in case of interworking with the MAP
protocol (i.e. in case such an error is received from the MAP interface). It
is not used for the case where the string sent by the UE in response to a
query from the network does not match any expected response. Procedures
covering such cases are part of the USSD application handling. The application
will usually send back another USSD string to the UE asking for a new input
from the user or indicating that the transaction cannot be completed.
#### 5.1.3.4 XML schema
Implementations in compliance with the present document shall implement the
XML schema defined below.
\
\
\
\
\
Unstructured Supplementary Services Data
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
NOTE: The AS can take the information received in the MIME body, formulate a
MAP USSD message and route the message over SS7 to the USSD server via the
HSS. Alternatively, the AS can extract the USSD information from the received
MIME body, and communicate with USSD server using other protocol.
#### 5.1.3.5 IANA registration
NOTE: RFC 4288 [9], subclause 9, states the process that applies in case of
changes to the registry of media types. Any changes to the format or to
subclause 5.1.3.5 after the registration with IANA would invoke this
procedure.
##### 5.1.3.5.1 Name
Frederic Firmin
##### 5.1.3.5.2 Email
frederic.firmin\@etsi.org
##### 5.1.3.5.3 MIME media type name
Application
##### 5.1.3.5.4 MIME subtype name
Vendor Tree -- vnd.3gpp.ussd+xml
##### 5.1.3.5.5 Required parameters
None
##### 5.1.3.5.6 Optional parameters
None
##### 5.1.3.5.7 Encoding considerations
Binary.
##### 5.1.3.5.8 Security considerations
Same as general security considerations for application/xml as specified in
section 10 of IETF RFC 3023 [10]. In addition, this content type provides a
format for exchanging information in SIP, so the security considerations from
IETF RFC 3261 [11] apply.
The information transported in this MIME media type does not include active or
executable content.
Mechanisms for privacy and intregrity protection of protocol parameters exist.
Those mechanisms as well as authentication and further security mechanisms are
described in 3GPP TS 24.229 [6].
##### 5.1.3.5.9 Interoperability considerations
The MIME type allows interoperability of USSD information between mobile
networks and other systems.
##### 5.1.3.5.10 Published specification
3GPP TS 24.390
(http://www.3gpp.org/ftp/Specs/html-info/24390.htm)
##### 5.1.3.5.11 Applications which use this media
n/a
##### 5.1.3.5.12 Applications that manipulate MIME typed objects (messaging,
download etc.)
n/a
##### 5.1.3.5.13 Additional information
1\. Magic number(s): n/a
2\. File extension(s): n/a
3\. Macintosh file type code: n/a
4\. Object Identifiers: n/a
##### 5.1.3.5.14 Intended usage
Common.
The USSD is a very common service available on most mobile networks. The
registration of the associated MIME type allows the USSD service to be
incorporated in messages from other messaging systems.
##### 5.1.3.5.15 Other information/general comment
n/a
##### 5.1.3.5.16 Person to contact for further information
1\. Name: Frederic Firmin
2\. Email: frederic.firmin\@etsi.org
3\. Author/Change controller: Frederic Firmin
###### ## Annex \ (informative): Signalling flows
# A.1 UE sending USSD request, no further information required
In the example flow at the figure A.1-1, UE 1 sends a USSD request. The USSD
application does not require further information, the USSD operation is
successful and the AS hosting the USSD application indicates sends a USSD
response towards UE 1.
Figure A.1-1: UE sends USSD request
NOTE: For clarity, the SIP 100 (Trying) responses are not shown in the
signaling flow.
**1\. UE A sends INVITE request containing the USSD request**
UE sends the INVITE request.
By including the Recv-Info header field, the UE indicates its support for the
g.3gpp.ussd info package.
Table A.1-1: INVITE request (UE-1 to P-CSCF)
> INVITE sip:*135%23;phone-context=home1.net\@home1.net;user=dialstring
> SIP/2.0
>
> Via: SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd]:1357;branch=z9hG4bKnashds7
>
> Max-Forwards: 70
>
> Route: \, \
>
> Accept-Contact: *;+g.3gpp.icsi-ref=\"urn%3Aurn-7%3gpp-
> service.ims.icsi.mmtel\"
>
> P-Preferred-Identity: \"John Doe\" \
>
> P-Access-Network-Info: 3GPP-UTRAN-TDD; utran-cell-id-3gpp=234151D0FCE11
>
> Privacy: none
>
> From: \;tag=171828
>
> To: \
>
> Call-ID: cb03a0s09a2sdfglkj490333
>
> Cseq: 127 INVITE
>
> Require: sec-agree
>
> Supported: precondition, 100rel, gruu
>
> Proxy-Require: sec-agree
>
> Security-Verify: ipsec-3gpp; q=0.1; alg=hmac-sha-1-96; ealg=aes-cbc;
> spi-c=98765432; spi-s=87654321; port-c=8642; port-s=7531
>
> Contact: \;
> +g.3gpp.icsi-ref=\"urn%3Aurn-7%3gpp-service.ims.icsi.mmtel\"
>
> Allow: INVITE, ACK, CANCEL, BYE, PRACK, UPDATE, REFER, MESSAGE, INFO
>
> Accept: application/sdp; application/3gpp-ims+xml;
> application/vnd.3gpp.ussd+xml
>
> Recv-Info: g.3gpp.ussd
>
> Content-Type: multipart/mixed; boundary=outer
>
> Content-Length: (...)
>
> \--outer
>
> Content-Type: application/sdp
>
> v=0
>
> o=- 2987933615 2987933615 IN IP6 5555::aaa:bbb:ccc:ddd
>
> s=-
>
> c=IN IP6 5555::aaa:bbb:ccc:ddd
>
> t=0 0
>
> m=audio 0 RTP/AVP 97 96
>
> a=rtpmap:97 AMR
>
> a=fmtp:97 mode-set=0,2,5,7; maxframes=2
>
> a=rtpmap:96 telephone-event
>
> \--outer
>
> Content-Type: application/vnd.3gpp.ussd+xml
>
> \
>
> \
>
> \en\
>
> \*135#\
>
> \
>
> \--outer---
Request-URI: in this example, the USSD message is *135#, and is represented as
a dialstring.
Application/vnd.3gpp.ussd+xml MIME body: USSD message. The content of the
\ element included in the INVITE message must be equal to the
dialstring inserted in the Request-URI.
**2\. INVITE request (P-CSCF to S-CSCF)**
The P-CSCF forwards the INVITE request based on the Route header field.
**3\. INVITE request (S-CSCF to AS)**
The S-CSCF forwards the INVITE request containing the USSD message based on
iFC to the AS.
**4\. 200 (OK) response (AS to S-CSCF)**
The AS sends a 200 (OK) confirming the receipt of the INVITE and to establish
the dialog. The SIP 200 (OK) will contain a Recv-Info header field set to
g.3gpp.ussd.
**5\. 200 (OK) response (S-CSCF to P-CSCF)**
The S-CSCF forwards the 200 (OK) along the Via header field.
**6\. 200 (OK) response (P-CSCF to UE)**
The P-CSCF forwards the 200 (OK) along the Via header field to the UE.
**7\. ACK request (UE to P-CSCF)**
The UE responds to the 200 (OK) response with an ACK request sent to the
P-CSCF.
**8\. ACK request (P-CSCF to S-CSCF)**
The P-CSCF forwards the ACK request to the S-CSCF.
**9\. ACK request (S-CSCF to AS)**
The S-CSCF forwards the ACK request to the AS.
**10\. USSD operation**
The AS performs the requested USSD operation. Details of USSD processing are
outside the scope of this specification.
In this example the USSD operation is successful and a response indicating
success will be sent to the UE.
**11\. BYE request (AS to S-CSCF) --- see example in table A.1-2**
Table A1-2: BYE request (AS to S-CSCF)
> BYE sip:user1_public1@home1.net;gr=hdg7777ad7aflzig8sf7 SIP/2.0
>
> Via SIP/2.0/UDP
>
> Max-Forwards: 70
>
> Route: \<>, \
>
> From: \;tag=314159
>
> To: \;tag=171828
>
> Call-ID: cb03a0s09a2sdfglkj490334
>
> Cseq: 129 BYE
>
> Content-Type: application/vnd.3gpp.ussd+xml
>
> Content-Length:
>
> \
>
> \
>
> \en\
>
> \
>
> Hello, your credit is \$175.50. Thanks for your query.
>
> We are happy to assist. Your operator
>
> \
>
> \
Application/vnd.3gpp.ussd+xml MIME body: USSD message.
**12\. BYE request (S-CSCF to P-CSCF)**
The S-CSCF forwards the BYE request to the P-CSCF.
**13\. BYE request (P-CSCF to UE)**
The P-CSCF forwards the BYE request to the UE. The UE recognizes the
application/vnd.3gpp.ussd+xml and displays the string.
**14\. 200 (OK) response (UE to P-CSCF)**
The UE sends a 200 (OK) confirming the BYE request.
**15\. 200 (OK) response (P-CSCF to S-CSCF)**
The P-CSCF forwards the 200 (OK) to the S-CSCF.
**16\. 200 (OK) response (S-CSCF to AS)**
The S-CSCF forwards the 200 (OK) to AS.
# A.2 UE sending USSD request, further information required from network
In the example flow at the figure A.2-1, UE 1 sends a USSD request. The USSD
application requires further information, and UE 1 sends further information
in a USSD request. After the USSD operation is successful, the AS hosting the
USSD application sends a USSD response towards UE 1.
Figure A2-1: UE sends USSD request
NOTE: For clarity, the SIP 100 (Trying) responses are not shown in the
21ignaling flow.
**1\. UE A sends INVITE request containing the USSD request**
UE sends the INVITE request.
By including the Recv-Info header field, the UE indicates its support for the
g.3gpp.ussd info package.
Table A.2-1: INVITE request (UE-1 to P-CSCF)
> INVITE sip:*135%23;phone-context=home1.net\@home1.net;user=dialstring
> SIP/2.0
>
> Via: SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd]:1357;branch=z9hG4bKnashds7
>
> Max-Forwards: 70
>
> Route: \, \
>
> Accept-Contact: *;+g.3gpp.icsi-ref=\"urn%3Aurn-7%3gpp-
> service.ims.icsi.mmtel\"
>
> P-Preferred-Identity: \"John Doe\" \
>
> P-Access-Network-Info: 3GPP-UTRAN-TDD; utran-cell-id-3gpp=234151D0FCE11
>
> Privacy: none
>
> From: \;tag=171828
>
> To: \
>
> Call-ID: cb03a0s09a2sdfglkj490333
>
> Cseq: 127 INVITE
>
> Require: sec-agree
>
> Supported: precondition, 100rel, gruu
>
> Proxy-Require: sec-agree
>
> Security-Verify: ipsec-3gpp; q=0.1; alg=hmac-sha-1-96; ealg=aes-cbc;
> spi-c=98765432; spi-s=87654321; port-c=8642; port-s=7531
>
> Contact: \;
> +g.3gpp.icsi-ref=\"urn%3Aurn-7%3gpp-service.ims.icsi.mmtel\"
>
> Allow: INVITE, ACK, CANCEL, BYE, PRACK, UPDATE, REFER, MESSAGE, INFO
>
> Accept: application/sdp; application/3gpp-ims+xml;
> application/vnd.3gpp.ussd+xml
>
> Recv-Info: g.3gpp.ussd
>
> Content-Type: multipart/mixed; boundary=outer
>
> Content-Length: (...)
>
> \--outer
>
> Content-Type: application/sdp
>
> v=0
>
> o=- 2987933615 2987933615 IN IP6 5555::aaa:bbb:ccc:ddd
>
> s=-
>
> c=IN IP6 5555::aaa:bbb:ccc:ddd
>
> t=0 0
>
> m=audio 0 RTP/AVP 97 96
>
> a=rtpmap:97 AMR
>
> a=fmtp:97 mode-set=0,2,5,7; maxframes=2
>
> a=rtpmap:96 telephone-event
>
> \--outer
>
> Content-Type: application/vnd.3gpp.ussd+xml
>
> \
>
> \
>
> \en\
>
> \*135#\
>
> \
>
> \--outer---
Request-URI: in this example, the USSD message is *135#, and is represented as
a dialstring.
Application/vnd.3gpp.ussd+xml MIME body: USSD message. The content of the
\ element in the INVITE message must be equal to the dialstring
inserted in the Request-URI.
**2\. INVITE request (P-CSCF to S-CSCF)**
The P-CSCF forwards the INVITE request based on the Route header field.
**3\. INVITE request (S-CSCF to AS)**
The S-CSCF forwards the INVITE request containing the USSD message based on
iFC to the AS.
**4\. 200 (OK) response (AS to S-CSCF)**
The AS sends a 200 (OK) confirming the receipt of the INVITE and to establish
the dialog. The SIP 200 (OK) will contain a Recv-Info header field set to
g.3gpp.ussd.
**5\. 200 (OK) response (S-CSCF to P-CSCF)**
The S-CSCF forwards the 200 (OK) along the Via header field.
**6\. 200 (OK) response (P-CSCF to UE)**
The P-CSCF forwards the 200 (OK) along the Via header field to the UE.
**7\. ACK request (UE to P-CSCF)**
The UE responds to the 200 (OK) response with an ACK request sent to the
P-CSCF.
**8\. ACK request (P-CSCF to S-CSCF)**
The P-CSCF forwards the ACK request to the S-CSCF.
**9\. ACK request (S-CSCF to AS)**
The S-CSCF forwards the ACK request to the AS.
**10\. USSD operation**
The AS performs the requested USSD operation. Details of USSD processing are
outside the scope of this specification.
In this example, the AS requires further information from the UE.
**11-13. INFO request (AS to UE) - see example in table A.2-11**
Table A.2-11: INFO request (AS to S-CSCF)
> INFO sip:user1_public1\@home1.net;gr=hdg7777ad7aflzig8sf7 SIP/2.0
>
> Via: SIP/2.0/UDP ussias.home1.net:6677;branch=z9hG4bKnashds75454
>
> Max-Forwards: 70
>
> Route: \, \
>
> From: \;tag=t45543543
>
> To: \;tag=171828
>
> Call-ID: cb03a0s09a2sdfglkj490333
>
> Cseq: 4665 INFO
>
> Info-Package: g.3gpp.ussd
>
> Content-Length: (...)
>
> Content-Type: application/vnd.3gpp.ussd+xml
>
> Content-Disposition: Info-Package
>
> \
>
> \
>
> \en\
>
> \
>
> Enter password:
>
> \
>
> \
**14-16. 200 (OK) response (UE to AS)**
> The UE sends a SIP 200 (OK) to the AS confirming the SIP INFO request.
**17-19. INFO request (UE to AS) - see example in table A.2-17**
> The UE sends the SIP INFO request containing the further USSD information
> required.
Table A.2-17: INFO request (UE to P-CSCF)
> INFO sip:ussias.home1.net:12456 SIP/2.0
>
> Via: SIP/2.0/UDP [5555::aaa:bbb:ccc:ddd]:1357;branch=z9hG4bKnashds76565465
>
> Max-Forwards: 70
>
> Route: \, \,
> \
>
> From: \;tag=171828
>
> To: \;tag=t45543543
>
> Call-ID: cb03a0s09a2sdfglkj490333
>
> Cseq: 128 INFO
>
> Info-Package: g.3gpp.ussd
>
> Content-Length: (...)
>
> Content-Type: application/vnd.3gpp.ussd+xml
>
> Content-Disposition: Info-Package
>
> \
>
> \
>
> \en\
>
> \
>
> zAyEx1973
>
> \
>
> \
**20-21. 200 (OK) response (AS to UE)**
> The AS sends a SIP 200 (OK) to the UE confirming the SIP INFO request.
**23\. USSD operation**
The AS performs the requested USSD operation. Details of USSD processing are
outside the scope of this specification.
In this example, the USSD operation is successful and AS sends a response
indicating success will be sent to the UE.
**24-26 BYE request (AS-UE)**
The AS sends a SIP BYE request towards UE containing a USSD response.
Table A.2-2: BYE request (AS to S-CSCF)
> BYE sip:user1_public1@home1.net;gr=hdg7777ad7aflzig8sf7 SIP/2.0
>
> Via SIP/2.0/UDP
>
> Max-Forwards: 70
>
> Route: \<>, \
>
> From: \;tag=314159
>
> To: \;tag=171828
>
> Call-ID: cb03a0s09a2sdfglkj490334
>
> Cseq: 129 BYE
>
> Content-Type: application/vnd.3gpp.ussd+xml
>
> Content-Length:
>
> \
>
> \
>
> \en\
>
> \
>
> Hello, your credit is \$175.50. Thanks for your query.
>
> We are happy to assist. Your operator
>
> \
>
> \
Application/vnd.3gpp.ussd+xml MIME body: USSD message.
**27-29. 200 (OK) response (UE to AS)**
The UE sends a 200 (OK) to AS confirming the BYE request.
#
# Foreword
This Technical Specification (TS) was been produced by ETSI Technical
Committee Telecommunications and Internet converged Services and Protocols for
Advanced Networking (TISPAN) and originally published as ETSI TS 183 028 [17].
It was transferred to the 3rd Generation Partnership Project (3GPP) in January
2008.
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# 1 Scope
The present document describes the stage three protocol for basic
communication procedures common to several services in the IP Multimedia (IM)
Core Network (CN) subsystem when at least one Application Server (AS) is
included in the communication. The common procedures are based on stage three
specifications for supplementary services.
The present document contains examples of signalling flows for the common
basic communication procedures.
The present document is applicable to User Equipment (UE) and Application
Servers (AS) which are intended to support the common basic communication
procedures.
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
  * References are either specific (identified by date of publication, > edition number, version number, etc.) or non‑specific.
  * For a specific reference, subsequent revisions do not apply.
  * For a non-specific reference, the latest version applies. In the > case of a reference to a 3GPP document (including a GSM document), > a non-specific reference implicitly refers to the latest version > of that document _in the same Release as the present document_.
[1] 3GPP TS 24.229: \"IP Multimedia Call Control Protocol based on SIP and
SDP\"..
[2] Void.
[3] Void.
[4] IETF RFC 3261: \"SIP: Session Initiation Protocol\".
[5] IETF RFC 3262: \"Reliability of Provisional Responses in the Session
Initiation Protocol (SIP)\".
[6] IETF RFC 3960: \"Early Media and Ringing Tone Generation in the Session
Initiation Protocol (SIP)\".
[7] ETSI TS 181 005: \"Telecommunications and Internet Converged Services and
Protocols for Advanced Networking (TISPAN); Service and Capability
Requirements\".
[8] Void.
[9] 3GPP TS 29.163: \"Interworking between the IP Multimedia (IM) Core Network
(CN) subsystem and Circuit Switched (CS) networks\".
[10] Void.
[11] ITU-T Recommendation I.112: \"Vocabulary of terms for ISDNs\".
[12] IETF RFC 5009: \"Private Header (P-Header) Extension to the Session
Initiation Protocol (SIP) for Authorization of Early Media\".
[13] IETF RFC 3515: \"The Session Initiation Protocol (SIP) Refer Method\".
[14] IETF RFC 3725: \"Best Current Practices for Third Party Call Control
(3pcc) in the Session Initiation Protocol (SIP)\".
[15] 3GPP TS 24.607: \"Originating Identification Presentation (OIP) and
Originating Identification Restriction (OIR) using IP Multimedia (IM)Core
Network (CN) subsystem; Protocol specification\".
[16] Void.
[17] ETSI TS 183 028 V2.4.0: \"Telecommunications and Internet converged
Services and Protocols for Advanced Networking (TISPAN); Common Basic
Communication procedures; Protocol specification\".
[18] IETF RFC 6228 (May 2011): \"Response Code for Indication of Terminated
Dialog\".
[19] IETF RFC 3840: \"Indicating User Agent Capabilities in the Session
Initiation Protocol (SIP)\"
[20] IETF RFC 4596: \"Guidelines for usage of the Session Initiation Protocol
(SIP) Caller Preferences Extension
# 3 Definitions and abbreviations
## 3.1 Definitions
For the purposes of the present document, the following terms and definitions
apply:
**announcement:** service related message sent to a user that can be of any
type of media e.g. a voice message or a\ video-clip
**communication:** transfer of information between two or more users,
entities, processes or nodes according to some agreed conventions
NOTE: See ITU-T Recommendation I.112 modified [11].
**early media:** media sent before a communication is established
**in-band announcement:** announcement sent by the network using the bearer
established for a communication
**Originating Application Server (O-AS):** controlling application server
responsible for the services provided to the originating user
**Terminating Application Server (T-AS):** controlling application server
responsible for the services provided to the terminating user
## 3.2 Abbreviations
For the purposes of the present document, the following abbreviations apply:
3pcc 3rd party call control
ACR Automatic Call Rejection
AS Application Server
B2BUA Back-to-Back User Agent
IFC Initial Filter Criteria
IMS IP Multimedia Subsystem
ISDN Integrated Services Digital Network
MGCF Media Gateway Control Function
MGW Media GateWay
MRFC Media Resource Function Controller
MRFP Media Resource Function Processors
NDUB Network Determined User Busy
O-AS Originating Application Server
P-CSCF Proxy Call Session Control Function
PSTN Public Switched Telephone Network
S-CSCF Serving Call Session Control Function
SDP Session Description Protocol
SIP Session Initiation Protocol
T-AS Terminating Application Server
T-MGF Trunking Media Gateway Function
UDUB User Determined User Busy
UE User Equipment
URL Uniform Resource Locator
# 4 Common basic communication procedures
## 4.1 Introduction
Services may need to send announcements for example to explain the reason for
rejecting a communication request or to report the progress of a communication
request. The announcement may be of any type of media e.g. an audio
announcement or a video clip. Subclause 4.2 describes the announcement common
procedure and annex A shows examples of signalling flows for some announcement
scenarios.
Some services are triggered by a user\'s busy condition e.g. the Communication
Forwarding on Busy service. The busy condition may be determined by the
network i.e. the Network Determine User Busy (NDUB) condition or by the user
i.e. the User Determine User Busy (UDUB) condition. Subclause 4.4 describes
the network determine user busy common procedure and the annex B shows
examples of signalling flows for some busy scenarios.
Some services are triggered by sending a REFER request, for example Explicit
Communication Transfer. A receiver of the REFER request in some cases might
not be able to process the REFER request. Subclause 4.4a describes fallback
procedures to 3rd party call control. Annex E provides some examples for
signalling flows.
## 4.2 Announcement
### 4.2.1 General
Announcements may be sent during the establishment of a communication session,
when rejecting a communication request, during an established communication
session or during the release of a communication session.
### 4.2.2 Providing announcements to a user during the establishment of a
communication session
A service may provide an announcement during the establishment of a
communication. If an announcement is provided the service shall use one of the
following methods:
\- use an Alert-Info header field in the 180 (Ringing) response to the INVITE
request; or
\- use early media as defined by IETF RFC 3960 [6] and using the P-Early-Media
header field authorizing early media as defined in IETF RFC 5009 [12] for the
gateway model; or
\- use multiple early dialogs as described in annex D and using the P-Early-
Media header field authorizing early media as defined in IETF RFC 5009 [12].
### 4.2.3 Providing announcements to a user during an established
communication session
A service may provide an announcement during an established communication. If
an announcement is provided the service shall use one of the following
methods:
\- use an Call-Info header field in a re-INVITE request; or
\- use the existing media stream. The media stream may have to be
re‑negotiated by the service to a media type suitable for the announcement.
Mixing announcements into an existing media stream requires that the AS use
the 3rd party call control procedure as specified by subclause 5.7.5 in 3GPP
TS 24.229 [1].
### 4.2.4 Communication request rejected by AS
A service may provide an announcement when rejecting a communication request
e.g. in order to explain the reason for rejecting the communication request in
more detail. If an announcement is provided the service shall:
\- use an Error-Info header field in the 3xx, 4xx, 5xx or 6xx response to the
INVITE request; or
\- use early media for sending the announcement in‑band as defined by IETF RFC
3960 [6] and using the P-Early-Media header field authorizing early media as
defined in IETF RFC 5009 [12] for the gateway model [ ]{.underline} and insert
the Reason Header with the proper cause value; or
\- use early media for sending the announcement in‑band in an early dialog as
described in annex D and using the P-Early-Media header field authorizing
early media as defined in IETF RFC 5009 [12] and insert the Reason Header with
the proper cause value; or
\- accept the communication request and use the established session for
sending an in‑band announcement.
### 4.2.5 Providing announcements to a user during the release of a
communication session
A service may provide an announcement to the UE, who does not end the session,
during the release of a communication, in order to, e.g. tell the charge
information. If an announcement is provided the service shall:
\- use the existing media stream. The media stream may have to be re-
negotiated by the service to a media type suitable for the announcement; or
\- change to new media for sending the announcement.
### 4.2.6 Providing announcements to a terminating user just after the call is
answered and before establishing direct communication session between end
users
When a call is established, a service may, before allowing media to be
exchanged between the end points, provide an announcement to the terminating
user after the call is answered.
When the session initiation request is sent from the originating UE, the AS
will act as a B2BUA and modify the SDP offer so that it represents an MRFP
handling the announcement, and a media stream will be established between the
MRFP and the terminating UE once the called user answers the call.
When the announcement is completed, the AS will send a new SDP offer, based on
the SDP offer initially received in the session initiation request, to the
terminating UE, in order to remove the MRFP from the media path and allow
media to be exchanged between the end points.
## 4.3 Alternative ring tone
A service may provide an alternative ring tone using the Alert-Info header
field as specified by IETF RFC 3261 [4].
The intention with this alternative ring tone is to override local ring tones
provided by the UE. It is recommended that the size of the referenced
alternative ring tone is small in order not to delay communication
establishment.
## 4.3A Voicemail server identification
When a voicemail server answers a call:
1\. If the voicemail server is able to record a message, the voicemail server
shall insert in the SIP 200 (OK) response to the INVITE request the media
features tag automata and actor=\"msg-taker\" in the Contact header as
described in IETF RFC 3840 [19] and in IETF RFC 4596 [20].
2\. If the voicemail server is not able to record a message, the voicemail
server shall insert in the SIP 200 (OK) response to the INVITE request the
media feature tag automata in the Contact header as described in IETF RFC 3840
[19] and in IETF RFC 4596 [20]. In that case, the media feature actor=\"msg-
taker\" shall not be inserted in the SIP 200 (OK) response to the INVITE
request.
## 4.4 Network Determined User Busy (NDUB)
Deployment of some service may require the support of the optional service
requirements for \"network determined user busy\" and \"approaching network
determined user busy\" defined in TS 181 005 [7]. In order to support such
requirements it is assumed that a network function/application server is
deployed to track a user\'s busy condition status from the perspective of the
network.
The present document is applicable only in cases whereby the network operator
has complete knowledge of the applications to which an end user has subscribed
and assumes that those applications will furnish the network entity
responsible for tracking \"busy condition\" with appropriate information to
enable this determination to be made. This may require appropriate business
arrangements between the network operator and the application provider.
NOTE: Tracking bandwidth availability in the customer network is out of scope
of the current release. As such it is possible that a communication could be
presented based on the network entity determining that the communication can
be presented when in fact congestion in the customer network will prevent the
communication being presented. This is a limitation of the present document.
Determination of \"network determined user busy\" by the network may restrict
the ability to deploy and support end user devices which perform local
services based on \"user determined user busy\" as part of their base
functionality.
## 4.4a Special REFER request handling procedures
After the reception of a REFER request the AS may start 3pcc procedures under
the following conditions:
\- the Application Server acts as a B2BUA, so the AS has knowledge about the
existing partial dialogs it is involved in, especially of the media user for
this communication; and
\- the REFER request is routed via this AS.
The 3pcc procedures shall be achieved by sending re-INVITE requests in
existing partial dialogs and by sending INVITE requests to establish new
partial dialogs.
Tables 1 and 2 give decision criteria when to start 3pcc procedures.
Table 1: Terminating party of a communication sends a REFER request
* * *
Content of the Allow header in the initial INVITE request from A->B Action
AS-B on the REFER request from B Action that the AS-B does on the initial
INVITE request INVITE request with Allow header with no REFER token Invoke the
3pcc procedure directly AS-B adds the REFER token to the Allow header INVITE
request with Allow header with a REFER token Forward the REFER request and if
the 403 (Forbidden) or 501 (Not implemented) response is received, fall back
to 3pcc procedure No modification needed in the Allow header INVITE request
without Allow header Forward the REFER and if the 403 (Forbidden ) or 501 (Not
implemented) response is received, fall back to 3pcc procedure No modification
needed in the INVITE request
* * *
Table 2: Originating party of a communication sends a REFER request
* * *
Content of the Allow header in the 200 (OK) response on the initial INVITE
request (A->B dialog) Action AS-A on the REFER request from A Action that the
AS-A does on the 200 (OK= response on A-B dialog 200 (OK) response with Allow
header with no REFER token Invoke the 3pcc procedure directly AS-A adds the
REFER token to the Allow header 200 (OK) response with Allow header with a
REFER token Forward the REFER request and if the 403 (Forbidden) or 501 (Not
implemented) response is received, fall back to 3pcc procedure No modification
needed in the Allow header 200 (OK) response without Allow header Forward the
REFER request and if the 403 (Forbidden) or 501 (Not implemented) response is
received, fall back to 3pcc procedure No modification needed in the 200 (OK)
response
* * *
As a network option, an AS of the initiator of the REFER request that has
prior knowledge that the remote party is not allowed to receive or does not
support the REFER request, may initiate 3rd party call control procedures
directly.
To avoid a longer re-negotiation of the media, the media information of the
existing partial dialogs are used for the INVITE requests or the first re-
INVITE requests during the 3pcc procedures.
## 4.5 Operational requirements
### 4.5.1 Provision/withdrawn
No special requirements for provision/withdrawn. Any requirements on
provision/withdrawn belong to the service using the common basic procedures
specified by the present document.
### 4.5.2 Requirements on the originating network side
There are no service specific requirements on the originating network side
defined.
NOTE: If required by local policy the IBCF will remove an Error-Info header
field, Call-Info header field or an Alert-Info header field.
### 4.5.3 Requirements on the terminating network side
There are no service specific requirements on the terminating network side
defined.
NOTE: If required by local policy the IBCF will remove an Error-Info header
field, Call-Info header field or an Alert-Info header field.
## 4.6 Coding requirements
The syntax for the relevant headers in the SIP requests and SIP responses
shall be as follows:
\- The syntax of the Alert-Info header field conforms to the requirements in
3GPP TS 24.229 [1] and IETF RFC 3261 [4].
\- The syntax of the Error-Info header field conforms to the requirements in
3GPP TS 24.229 [1] and IETF RFC 3261 [4].
\- The syntax of the Call-Info header field conforms to the requirements in
3GPP TS 24.229 [1] and IETF RFC 3261 [4].
\- The syntax of the P-Early-Media header field is described in IETF RFC 5009
[12].
\- The syntax of the Allow header field conforms to the requirements in 3GPP
TS 24.229 [1] and IETF RFC 3261 [4].
## 4.7 Signalling procedures
### 4.7.1 Activation, deactivation
There are no procedures for activation or deactivation defined.
### 4.7.1A Registration/erasure
There are no procedures for registration or erasure defined.
### 4.7.1B Interrogation
There are no procedures for interrogation defined.
### 4.7.2 Invocation and operation
#### 4.7.2.1 Actions at the originating UE
Procedures according to 3GPP TS 24.229 [1] shall apply.
Certain services require the usage of the Alert-Info header field, Call-Info
header field and Error-Info header field according to procedures specified by
IETF RFC 3261 [4].
If the UE detects that in-band information is received from the network as
early media, the in-band information received from the network shall override
locally generated communication progress information.
The UE shall not generate the locally generated communication progress
information if an early dialog exists where the last received P-Early-Media
header field as described in IETF RFC 5009 [12] contains \"sendrecv\" or
\"sendonly\".
NOTE: if an early dialog exists where a SIP 18x response to the SIP INVITE
request other than 183 (Session Progress) response was received, no early
dialog exists where the last received P-Early-Media header field as described
in IETF RFC 5009 [12] contained \"sendrecv\" or \"sendonly\" and in-band
information is not received from the network, then the UE is expected to
render the locally generated communication progress information.
If the UE receives a re-INVITE request containing no SDP offer the UE shall
send a 200 (OK) response containing an SDP offer according to 3GPP TS 24.229
[1] indicating the directionality used by UE as \"sendrecv\" regardless of the
actual directionality.
#### 4.7.2.2 Void
#### 4.7.2.3 Void
#### 4.7.2.4 Void
#### 4.7.2.5 Void
#### 4.7.2.6 Void
#### 4.7.2.7 Void
#### 4.7.2.8 Void
#### 4.7.2.9 Actions at the AS
The procedures in this subclause apply for the AS serving the originating UE
and the AS serving the terminating UE.
An AS using the MRFC and MRFP to send in-band media for announcements shall
use the 3rd party call control procedure as specified by subclause 5.7.5 in
3GPP TS 24.229 [1] and the media control procedure as specified by subclause
10.2 in 3GPP TS 24.229 [1].
##### 4.7.2.9.1 Providing announcements during an established communication
session
Services may use the Call-Info header field according to procedures specified
by IETF RFC 3261 [4] to provide an announcement during an established
communication session.
Services may send an in-band message or media using an existing media-stream
to provide an announcement during an established communication session.
##### 4.7.2.9.2 Providing announcements during the establishment of a
communication session
The AS may use the Call-Info header field according to procedures specified by
IETF RFC 3261 [4] in order to provide an announcement, or may use the Alert-
Info header field to provide an alternative ring tone, as specified in
subclause 4.7.2.9.4, during the establishment of a communication session.
The AS may use the MRFC and the MRFP to send an in‑band announcement using
early media according to the rules and procedures of the IETF RFC 3261 [4],
IETF RFC 3262 [5], IETF RFC 3960 [6] and IETF RFC 5009 [12].
##### 4.7.2.9.3 Providing announcements when communication request is rejected
by the AS
The AS may use the Error-Info header field according to procedures specified
by IETF RFC 3261 [4] in order to provide an announcement when the
establishment of a communication session is rejected.
The AS may use the MRFC and MRFP to send an in‑band announcement using early
media according to the rules and procedures of the IETF RFC 3261 [4], IETF RFC
3262 [5], IETF RFC 3960 [6] and IETF RFC 5009 [12].
##### 4.7.2.9.4 Providing alternative ring tone during the establishment of a
communication session
The AS may use the Alert-Info header field according to procedures specified
by IETF RFC 3261 [4] in order to provide an alternative ring tone during the
establishment of a communication session.
##### 4.7.2.9.5 Early dialog procedures at the AS
The procedures for dealing with early dialog established between the AS and
the originating UE is described in annex D.
##### 4.7.2.9.6 Providing announcements during the release of a communication
session
Services may send an in-band message or media using an existing media-stream
or changing to new media-stream to provide an announcement during the release
of a communication session.
##### 4.7.2.9.7 Starting special REFER handling procedures at the AS of the
initiator of the REFER request
##### 4.7.2.9.7.1 REFER is sent inside a dialog {#refer-is-sent-inside-a-
dialog .H6}
##### 4.7.2.9.7.1.1 Normal procedures {#normal-procedures .H6}
If the AS receives a 403 Forbidden or a 501 Not implemented in response to a
REFER request forwarded by the AS, it shall send a 202 Accepted response
followed by a NOTIFY request with a 100 (Trying) status line to the originator
of the REFER request, according to the procedures of IETF RFC 3515 [13].
The AS then shall perform third party call control procedures according to
Flow III or Flow IV of IETF RFC 3725 [14], with the following additions and
clarifications.
The AS should verify if it is involved in the dialogs between the originator
of the REFER request on one side and the REFER target and the Refer-to target
on the other side.
Then the AS shall send an INVITE request to the Refer-to target if it **is
not** involved in a dialog with the Refer-to target (e.g. Blind ECT), or the
AS shall send a re-INVITE request to the Refer-to target if it **is** involved
in a dialog with the Refer-to target (e.g. Consultative ECT). The INVITE
request shall contain if available a P-Asserted-ID header field with a valid
identity of the REFER target and a Referred-by header field matching the
P-Asserted-Identity of the REFER request. When including the P-Asserted-
Identity the AS shall also include the Privacy header fields obtained from the
request or response in which this P-Asserted-Identity was obtained. In
addition the AS shall include a P-Served-User header field including a valid
identity of the referor.
When the partial dialog with the Refer-to target is acknowledged following a
200 (OK), the AS shall send in the original partial dialog a NOTIFY request
with a 100 Trying status line to the originator of the REFER request,
according to the procedures of IETF RFC 3515 [13]. After that the AS shall
send a re-INVITE request to the REFER target. The re-INVITE request shall
contain if available a P-Asserted-ID header field with a valid identity of the
Refer-to target and a Referred-by header field matching the P-Asserted-
Identity of the REFER request.
When the partial dialog with the REFER target is acknowledged following a 200
OK, the AS shall send in the original partial dialog a NOTIFY request with a
200 OK status line to the originator of the REFER request, according to the
procedures of IETF RFC 3515 [13]. If a Replaces parameter is included in the
Refer-To header field of the original REFER request and it refers to the
original partial dialog between the referrer and the refer-to target, the AS
shall send a BYE request in the original partial dialog to the referrer.
When the 3rd party call control procedures were successful, continued
processing procedures according to clause 7 of IETF RFC 3725 [14] shall be
applied.
As a network option, the AS could send a 202 (Accepted) response directly and
initiate 3rd party call control procedures without trying to forward the REFER
request to the REFER target.
NOTE 1: For example, when UE-A and UE-B establish a session, they will
exchange their own capabilities for SIP methods by using \"Allow\" header. If
the AS lies in the signalling path between UE-A and UE-B, it knows whether the
two UEs support REFER or not, and can initiate 3rd party call control
procedures. Another example is that a network operator does not want to send
REFERs to a user because of security reasons.
NOTE 2: The AS can enforce OIR privacy settings on OIR relevant headers
carried in the generated INVITE request and/or reINVITE request, as specified
3GPP TS 24.607 [15] for regular INVITE requests originated by the served user.
NOTE 3: The AS can generate charging events for the generated INVITE requests,
correlated to the initiator of the REFER request.
##### 4.7.2.9.7.1.2 Exceptional procedures {#exceptional-procedures .H6}
If the 3rd party call control procedures fail because a media negotiation
between REFER target and Refer-to target is not possible (e. g. the codes
cannot be negotiated or the offered ports have changed in a subsequent SDP
offer), or REFER target or Refer-to target answer the INVITE request with an
error response, error handling procedures according to clause 6 of IETF RFC
3725 [14] shall be applied. Additionally the AS shall send a NOTIFY for
terminating the original REFER request.
##### 4.7.2.9.7.2 REFER is sent outside a dialog {#refer-is-sent-outside-a-
dialog .H6}
##### 4.7.2.9.7.2.1 Normal procedures {#normal-procedures-1 .H6}
If the AS receives a 403 (Forbidden) response or a 501 (Not Implemented)
response in response to a REFER request forwarded by the AS, it shall send a
202 (Accepted) response followed by a NOTIFY request with a 100 (Trying)
status line to the originator of the REFER request, according to the
procedures of IETF RFC 3515 [13].
The AS then shall perform third party call control procedures according to
Flow III or Flow IV of IETF RFC 3725 [14], with the following additions and
clarifications:
The AS shall send an INVITE request to the Refer-to target. The INVITE request
shall contain if available a P‑Asserted-ID header field with a valid identity
of the REFER target and a Referred-by header field matching the P‑Asserted-
Identity of the REFER request. In addition the AS shall include a P-Served-
User header field including a valid identity of the referor.
When the dialog with the Refer-to target is acknowledged following a 200 (OK),
the AS shall send in the REFER dialog a NOTIFY request with a 100 (Trying)
status line to the originator of the REFER request, according to the
procedures of IETF RFC 3515 [13]. After that the AS shall send an INVITE
request to the REFER target. The INVITE request shall contain if available a
P-Asserted-ID header field with a valid identity of the Refer-to target and a
Referred-by header field matching the P-Asserted-Identity of the REFER
request. When including the P-Asserted-Identity the AS shall also include the
Privacy header fields obtained from the request or response in which this
P-Asserted-Identity was obtained.
When the dialog with the REFER target is acknowledged following a 200 OK, the
AS shall send in the REFER dialog a NOTIFY request with a 200 OK status line
to the originator of the REFER request, according to the procedures of IETF
RFC 3515 [13].
When the 3rd party call control procedures were successful, continued
processing procedures according to clause 7 of IETF RFC 3725 [14] shall be
applied.
As a network option, the AS could send a 202 (Accepted) response directly and
initiate 3rd party call control procedures without trying to forward the REFER
request to the REFER target.
NOTE 1: For example, when UE-A and UE-B establish a session, they will
exchange their own capabilities for SIP methods by using \"Allow\" header. If
the AS lies in the signalling path between UE-A and UE-B, it knows whether the
two UEs support REFER or not, and can initiate 3rd party call control
procedures. Another example is that a network operator does not want to send
REFERs to a user because of security reasons.
NOTE 2: The AS can enforce OIR privacy settings on OIR relevant headers
carried in the generated INVITE request and/or reINVITE request, as specified
3GPP TS 24.607 [15] for regular INVITE requests originated by the served user.
NOTE 3: The AS can generate charging events for the generated INVITE requests,
correlated to the initiator of the REFER request.
##### 4.7.2.9.7.2.2 Exceptional procedures {#exceptional-procedures-1 .H6}
If the 3rd party call control procedures fail because a media negotiation
between REFER target and Refer-to target is not possible, or REFER target or
Refer-to target answer the INVITE request with an error response, error
handling procedures according to clause 6 of IETF RFC 3725 [14] shall be
applied. Additionally the AS shall send a NOTIFY for terminating the original
REFER request.
##### 4.7.2.9.8 Voicemail server
When an AS acts as a voicemail server generates a 200 (OK) response to an
INVITE request:
1\. If the AS is able to record a message, the AS shall insert in the SIP 200
(OK) response to the INVITE request the media features tag automata and
actor=\"msg-taker\" in the Contact header as described in IETF RFC 3840 [19]
and in IETF RFC 4596 [20].
2\. If the AS is not able to take a message, the AS shall insert in the SIP
200 (OK) response to the INVITE request the media feature tag automata in the
Contact header as described in IETF RFC 3840 [19] and in IETF RFC4596 [20]. In
that case, the media feature actor=\"msg-taker\" shall not be inserted in the
200 (OK) SIP response to the INVITE request.
##### 4.7.2.9.9 Providing announcements to a terminating user just after the
call is answered and before establishing direct communication session between
end users
Services can provide an announcement to a terminating user just after the call
is answered and before establishing a direct communication session between end
users using the procedures in this subclause.
When an INVITE request is received from an originating UE, the AS shall
\- act as B2BUA;
\- modify the SDP offer received from the originating UE with the media
parameters necessary for the announcement;
\- indicate that resources at the MRF are available; and
\- send an INVITE request to the terminating UE as specified in 3GPP TS 24.229
[4].
Upon receipt of an 18x provisional response from the terminating UE the AS
shall indicate the progress of the call towards the originating UE, e.g. send
a 180 (Ringing) response or start an announcement.
When the session between the AS and the terminating UE is established the AS
shall start the announcement.
When the announcement is completed, the AS shall send a re-INVITE request or
an UPDATE request towards the terminating UE as specified in 3GPP TS 24.229
[4]. The SDP offer:
NOTE: An UPDATE request can be used if the required bandwidth is the same or
lower for the call as for the announcement towards the terminating UE.
\- shall include the SDP offer received from the originating UE;
\- if not included in the original offer from the originating UE, all media
for providing the announcement shall be removed (i.e. media lines are set to
port \"0\"); and
\- shall indicate that the resources at the originating side are not available
if preconditions are used.
For the rest of the call the AS shall:
\- if needed, modify the sdp sent towards the originating UE so that the
content of the sdp aligns with the offer/answer between the originating UE and
the AS;
\- forward SIP requests and SIP responses received from the terminating UE
towards the originating UE without changing the SDP using the SIP dialog
created above.
For the rest of the call the AS shall:
\- if needed, modify the sdp sent towards the terminating UE so that the
content of the sdp aligns with the offer/answer between the terminating UE and
the AS; and
\- forward SIP requests and SIP responses received from the originating UE
towards the terminating UE without changing the SDP.
#### 4.7.2.10 Action at the terminating UE
Certain services require the usage of the Alert-Info header field and Call-
Info header field according to procedures specified by IETF RFC 3261 [4].
If the UE receives a re-INVITE request containing no SDP offer the UE shall
send a 200 (OK) response containing an SDP offer according to 3GPP TS 24.229
[1] indicating the directionality used by UE as \"sendrecv\" regardless of the
actual directionality.
## 4.8 Interactions with other networks
### 4.8.1 Void
### 4.8.2 Void
### 4.8.3 Void
## 4.9 Signalling flows
Signalling flows are documented in annexes A and B.
## 4.10 Parameter values (timers)
No specific timers are needed.
###### ## Annex A (informative): Signalling flows for announcements
This annex shows some example signalling flows for the procedures described in
subclause 4.1.
These signalling flows are simplified in that,for in-band announcements, they
do not show the AS to MRFC interactions.
# A.1 Providing announcements to a user during the establishment of a
communication session
## A.1.1 Providing in-band announcement
This subclause shows an example signalling flow of how an AS can send an
announcement to the calling user during the establishment of a communication.
Separate dialogs are established between the origination UE and the AS
controlling the announcement, and the originating UE and the terminating UE.
It is allowed that a different SDP answer is sent in the 200 (OK) response
from the terminating UE than the SDP answer that was previously sent from the
AS in the 183 (Session progress) response.
The AS can e.g. be the AS serving the calling party or the AS serving a called
party and may apply for example when a communication is going to be diverted
and the AS serving the diverting user inform the calling party that the
communication is going to be diverted.
Figure A.1 shows the signalling flow for the scenario.
{width="3.7222222222222223in" height="8.245833333333334in"}
NOTE: The called party can return provisional responses to the INVITE request.
However, for simplicity those responses are left out.
Figure A.1: Announcement started during the establishment of a communication
The calling party initiates a communication by means of an INVITE request. The
INVITE request is forwarded toward the called party.
Along the signalling path, created by the INVITE request, some service logic
in an Application Server (AS) wants to send an announcement towards the
calling party.
The flow is based on the assumptions that the Supported header field includes
the option‑tag \"100rel\".
The steps of the signalling flow are as follows:
1) S-CSCF receives an INVITE request.
2) S-CSCF sends the 100 (Trying) response towards to sender of the INVITE
request.
3) S-CSCF evaluates the initial Filter Criteria.
4) S-CSCF sends the INVITE request to the AS.
5) The AS sends the 100 (Trying) to S-CSCF.
6) Service logic in the AS decides to send an announcement to the calling
party.
7) The MRFC interacts with the MRFP in order to reserve resources for the
announcement. As part of the interaction with MRFP the AS receives the
necessary media parameters e.g. IP address and port numbers and provide the IP
address and port number for the calling party to the MRFP.
8) The AS sends a 183 (Session progress) response to S-CSCF. The response
includes:
a) an answer to the SDP received in the INVITE request;
b) a P-Early-Media header field set to \"sendonly\"; and
c) the Require header field set to \"100rel\".
9) S-CSCF sends the 183 (Session progress) response towards the calling party.
10) S-CSCF receives a PRACK request.
11) S-CSCF sends the PRACK request to the AS.
12) The AS sends a 200 (OK) to the PRACK request to S‑CSCF.
13) S-CSCF sends the 200 (OK) towards the calling party.
14) The MRFC interacts with the MRFP in order to start the announcement.
15) The MRFP sends the announcement towards the calling party.
16) The complete announcement is sent and the MRFP interacts with the AS/MRFC
in order to inform that the announcement is terminated.
17) The MRFC interacts with the MRFP in order to release the resources used
for the announcement.
18) The AS sends the INVITE request towards the called party. The INVITE
request contains the same information as the INVITE request received in step 4
with the modification done by AS according to rules and procedures of 3GPP TS
24.229 [1].
19) S-CSCF sends the 100 (Trying) response to the AS.
20) S-CSCF sends the INVITE request towards the called party.
21) S-CSCF receives a 100 (Trying) response.
22) S-CSCF receives a 200 (OK) response to the INVITE request.
23) S-CSCF sends the 200 (OK) response to the INVITE request to the AS.
24) The AS sends the 200 (OK) response to the INVITE request to the S-CSCF.
25) S-CSCF sends the 200 (OK) response to the INVITE request towards the
calling party.
26) S-CSCF receives an ACK request.
27) S-CSCF sends the ACK request to the AS.
28) The AS sends the ACK request to S-CSCF.
29) S-CSCF sends the ACK towards the called party.
When the UE of the calling party receives the 200 (OK) response to the INVITE
request the UE can regard the early dialog created for the announcement
between the UE and the AS terminated.
## A.1.2 Including Alert-Info header field in the 180 (Ringing) response
IETF RFC 3261 [4] specifies the Alert-Info header field as a means to indicate
a source of media to play an alternative ring tone by an originating endpoint.
An example of this mechanism is shown in figure A.2.
{width="2.7958333333333334in" height="5.876388888888889in"}
NOTE: In the figure the SDP signalling details to establish media are not
shown for simplicity.
Figure A.2: Alert-Info header field in the 180 (Ringing) response to indicate
an alternative ring tone
The steps of the flow are as follows:
1) S-CSCF receives an INVITE request from the originating user. The
originating user may be a user served by this S-CSCF, a user served by another
S-CSCF or a user connected to PSTN/ISDN via a MGCF.
2) S-CSCF sends a 100 (Trying) response.
3) S-CSCF evaluates the Initial Filter Criteria.
4) S-CSCF sends the INVITE request to the AS.
5) The AS sends a 100 (Trying) response to S-CSCF.
6) The AS sends the INVITE request to S-CSCF.
7) S-CSCF sends the 100 (Trying) response to the AS.
8) S-CSCF sends the INVITE request towards the called party. The called party
may be a user served by another S-CSCF or a user connected to PSTN/ISDN via a
MGCF.
9) S-CSCF receives a 100 (Trying) response.
10) S-CSCF receives a 180 (Ringing) response.
11) S-CSCF sends the 180 (Ringing) response to the AS.
12) The AS inserts a valid Alert-Info header field in the 180 (Ringing)
including a URL to a media file containing the appropriate tone and sends the
180 (Ringing) response to S-CSCF.
EXAMPLE: This file [http://operator.net/tone.wav]{.underline}, in the picture
abbreviated to http://url.wav is played at the originating UE (step 14).
13) S-CSCF sends the 180 (Ringing) response towards the originating user.
14) The [http://url.wav]{.underline} (for example
http://operator.net/tone.wav) is retrieved and played at the originating user.
15-18) S-CSCF receives a 200 (OK) response to the INVITE request and forwards
it to the originating user via the AS.
19) The originating user stops playing the tone.
20-23) S-CSCF receives an ACK request and forwards it towards the called party
via the AS.
## A.1.3 Announcements provided by the PSTN/ISDN
This subclause shows the signalling flow for a scenario where a user connected
to the IP network establish a communication with a user connected to the
PSTN/ISDN. During the establishment of the communication the PSTN/ISDN
provides an announcement e.g. \"The communication is forwarded\" or \"The user
is not reachable\".
Figure A.3 shows the signalling flow for the scenario.
{width="3.338888888888889in" height="4.64375in"}
NOTE: The flow assumes the use of the option‑tag \"100rel\" defined in RFC
3262 [5] other scenarios may also apply. T-MGF is left out of the figure for
simplicity.
Figure A.3: Announcement provided by PSTN/ISDN during the establishment of a
communication
The steps of the flow are as follows:
1) The MGCF receives an INVITE request from the IP network. The request
includes an SDP offer.
2) The MGCF sends a 100 (Trying) response to the IP network.
3) The MGCF sends an IAM towards PSTN.
4) The MGCF receives an early ACM from the PSTN/ISDN with an indication that
\"In-band information may be available\".
5) The MGCF sends a 183 (Session Progress) response to the IP network. The
response includes:
a) the answer to the SDP offer received in the INVITE request;
b) A P-Early-Media header field set to \"sendonly\"; and
c) The option‑tag \"100rel\" in the Require header.
6) The MGCF receives the PRACK request.
7) The MGCF sends a 200 (OK) response to the PRACK request.
8) The T-MGF sends the in-band announcement received from the PSTN/ISDN to the
IP network.
Depending on the reason for the announcement the establishment of the
communication continues or the establishment of the communication is aborted.
## A.1.4 Announcement provided towards a user connected to the PSTN/ISDN
This subclause shows an example signalling flow for a scenario where a user in
PSTN/ISDN establishes a communication with a user connected to IMS. During the
establishment an AS in the IP network provides an announcement,\ e.g. \"The
communication is forwarded\" or \"The user is not reachable\".
Figure A.4 shows the signalling flow for the scenario.
{width="3.2944444444444443in" height="4.239583333333333in"}
NOTE: The flow assumes the use of the option-tag \"100rel\" defined in RFC
3262 [5] other scenarios can also apply. T-MGF is left out of the figure for
simplicity.
Figure A.4: Announcement provided towards a user connected to PSTN/ISDN\
during establishment of a communication
The steps of the flow are as follows:
1) The MGCF receives an IAM from the PSTN/ISDN.
2) The MGCF sends an INVITE request to the IP network. The request includes a
SDP offer.
3) The MGCF receives a 100 (Trying) response from the IP network.
4) The MGCF receives a 183 (Session Progress) response from the IP network.The
response includes:
a) the answer to the SDP offer sent in the INVITE request;
b) a P-Early-Media header field set to \"sendonly\"; and
c) the option-tag \"100rel\" in the Require header field.
5) The MGCF sends a PRACK request towards the IP network.
6) The MGCF sends an early ACM to the PSTN/ISDN. The early ACM contains the
\"in-band information may be available\" indication.
7) The MGCF receives a 200 (OK) response to the PRACK request.
8) The T-MGF receives the in-band announcement from the IP network and
forwards the announcement to the PSTN/ISDN network.
Depending on the reason for the announcement the establishment of the
communication continues or the establishment of the communication is aborted.
## A.1.5 Providing in-band announcement after a reliable provisional response
has been received by the terminating UE
This subclause shows an example signalling flow of how an AS can send an
announcement to the calling user during the establishment of a communication,
in the case the terminating UE has already sent SDP within a reliable
provisional response.
Separate dialogs are established between the origination UE and the AS
controlling the announcement, in accordance with annex A.1.1.
Figure A.5 shows the signalling flow for the scenario.
Figure A.5: Originating announcement during communication establishment
considering terminating early media
The calling party initiates a communication by means of an INVITE request. The
INVITE request is forwarded toward the called party.
Along the signalling path, created by the INVITE request, some service logic
in an AS wants to send an announcement towards the calling party.
The flow is based on the assumptions that the Supported header field includes
the option‑tag \"100rel\".
The steps of the signalling flow are as follows:
1) S-CSCF receives an INVITE request with the initial SDP offer
2) S-CSCF evaluates the initial Filter Criteria
3) S-CSCF sends the INVITE request to the AS
4), 5) the AS forwards the INVITE to the terminating UE
6), 7) the terminating UE answers with a reliable 180 (Ringing) response
including a SDP answer.
8) based on the received response the service logic in the AS decides to send
an announcement to the calling party
9), 10) the AS forwards the received SDP answer within a reliable183 (Session
progress) response, in order to establish an e2e dialog between the
originating and terminating UEs
11) to 18) the originating UE confirms the reliable response to the
terminating UE
19) The MRFC interacts with the MRFP in order to reserve resources for the
announcement. As part of the interaction with MRFP the AS receives the
necessary media parameters e.g. IP address and port numbers and provide the IP
address and port number for the calling party to the MRFP.
20) to 25) the AS sends a reliable 180 (Ringing) response to the originating
UE and creates a new dialog between the AS and the originating UE. The
response includes:
a) an answer to the SDP received in the INVITE request;
b) a P-Early-Media header field set to \"sendonly\"; and
c) the Require header field set to \"100rel\".
26) The MRFC interacts with the MRFP in order to start the announcement.
27) The MRFP sends the announcement towards the calling party.
28), 29) the terminating UE answers with a 200 OK response without SDP
30) The MRFC interacts with the MRFP in order to release the resources used
for the announcement.
31), 32) the AS forwards the 200 OK response in the e2e dialog to the
originating UE
33) to 36) the communication is confirmed
# A.2 Providing announcements to a user during an established communication
The way an announcement is sent to a user during an established communication
depends on the scenario and the importance of the announcement.
The following scenarios exist:
\- scenario 1: two users are communicating with (at least) one AS in the
signalling path (UE AS -UE); or
\- scenario 2: two (or more) users communicating with (at least) one AS in the
signalling and media path\ (UE-AS/MRFC-UE); or
\- scenario 3: two users communicate and one of the users is connected to
PSTN/ISDN (UE-MGCF). This scenario can be seen as part of basic communication
and requires no SIP signalling; or
\- scenario 4: two users communicate directly with each other without
involving an AS in the signalling path and without involving an AS in the
media path (UE-UE). This scenario is out of scope of the present document.
## A.2.1 Scenario 1: UE - AS - UE
Two users are communicating with (at least) one AS in the signalling path. In
this scenario the AS is connected to the S-CSCF over the ISC interface acting
as a SIP proxy or an AS performing 3rd party call control.
IETF RFC 3261 [4] specifies the Call-Info header field as a means to indicate
a source of media to be played by the receiving endpoint.
Figure A.5 shows an example of the use of this mechanism in the INVITE
request.
{width="6.1875in" height="6.127777777777778in"}
NOTE: Some signalling details are left out of the figure for simplicity.
Figure A.5: Call-Info header field in a re-INVITE request to indicate media
A user wants to place a communication session on hold and sends a re‑INVITE
request towards the remote user involved in the communication.
The steps of the flow are as follows:
1) S-CSCF receives a reINVITE request from a user. The user can be a user
served by this S-CSCF, a user served by another S-CSCF or a user connected to
the PSTN via MGCF.
2) S-CSCF sends the reINVITE request along the signalling path to the AS using
the route set received in the re-INVITE request.
3) Service logic in the AS decides to include a reference to a wav file with
an announcement or music.
4) The AS sends the reINVITE request to the S-CSCF. Including in the Call-Info
header a URL to a media file containing the appropriate announcement or music,
for example [http://operator.net/announcement.wav]{.underline} (in the picture
abbreviated to http://url.wav).
5) The S-CSCF sends the reINVITE request along the signalling path towards the
remote user. The remote user can be a user served by this S-CSCF, a user
served by another S-CSCF or a user connected to the PSTN via MGCF.
6-9) The 200 (OK) response from the remote user is forwarded via the S-CSCF
and the AS towards the originating user.
10-13) The ACK request from the originating user is forwarded via the S-CSCF
and the AS towards the remote user.
14) The [http://url.wav]{.underline} file is retrieved and played to the user.
In the case the user is connected to the PSTN via a MGCF, the T-MGF retrieves
and plays the announcement towards the user. In case the user is connected to
IMS the UE retrieves and plays the announcement.
## A.2.2 Scenario 2: UE - AS/MRFC/MRFP - UE
This subclause describes the scenario when two (or more) users are
communicating with (at least) one AS controlling the media path. The MRFP is
in the media path. In this scenario the AS acts as a B2BUA.
Figure A.6 shows the signalling flow for the scenario.
{width="5.375in" height="4.552083333333333in"}
Figure A.6: In-band announcement during an established communication
An AS, acting as a B2BUA, is involved in a communication session. The AS
controls the media path via a co-located MRFC controlling a MRFP.
The steps of the flow are as follows:
1) Service logic in the AS decides to start an in‑band announcement towards a
user e.g. \"Music on hold\".
2) The AS using the co-located MRFC interacts with the MRP in order to reserve
resources for the announcement.
3) The MRFC co-located with the AS interacts with the MRFP in order to start
the announcement.
4) The MRFP sends the announcement towards the remote user.
5) The MRFC co-located with the AS interacts with the MRFP to stop the
announcement.
# A.3 Communication request rejected
Service logic in an AS, e.g. the ACR service, can decide to reject a
communication request and provide an announcement to explain the reason for
the rejection to the originating user. The AS can:
1) Send the announcement as in-band information.
2) Include a reference to the announcement in a 3xx, 4xx, 5xx and 6xx
response.
## A.3.1 Sending the announcement as in-band information
The network can generate announcement using one of the following procedures:
1) using early media i.e. the AS establish an early session and uses that
early session to send the in-band announcement; or
2) using an established session i.e. the AS accepts the INVITE request and
uses the established session to send the in-band announcement.
### A.3.1.1 Using early media
This subclause explains how an AS can use an early media session to send the
in-band announcement and when the announcement is sent reject the
communication request with an appropriate reject code.
Figure A.7 shows the signalling flow for the scenario.
Figure A.7: Using early media to send in-band announcement
The originating user initiates communication by means of an INVITE request. A
long the path towards the terminating user an AS determines that the INVITE
request cannot be forwarded to the terminating user. The steps of the flow are
as follows:
1) S-CSCF receives an INVITE request from the originating user. The
originating user can be a user served by this S-CSCF, a user served by another
S‑CSCF or a user connected to PSTN/ISDN via a MGCF.
2) S-CSCF sends a 100 (Trying) response.
3) S-CSCF evaluates the Initial Filter Criteria.
4) S-CSCF sends the INVITE request to the AS.
5) The AS sends a 100 (Trying) response to S-CSCF.
6) Service logic in the AS decides to reject the communication request and to
send an announcement in‑band in order to give a detailed reason to the
originating user.
7) The MRFC collocated with the AS interact with the MRFP and reserves
resources for the announcement.
8) The AS sends a 183 (Session progress) response to S-CSCF. The response
includes:
a) the Require header field with the option‑tag \"100rel\";
b) an answer to the SDP received in the INVITE request; and
c) an answer to the SDP received in the INVITE request.
9) S-CSCF sends the 183 (Session Progress) response towards the originating
user.
10) The MRFC collocated with the AS interact with the MRFP in order to start
the announcement.
11) S-CSCF receives a PRACK request from the originating user.
12) S-CSCF sends the PRACK request to the AS.
13) The AS sends the 200 (OK) response to the PRACK request to S-CSCF.
14) S-CSCF sends the 200 (OK) response to the PRACK request to the originating
user.
15)MRFP sends the announcement towards the UE.
16) The MRFP interacts with the MRFC collocated with the AS to indicate that
the announcement is sent.
17) The MRFC collocated with the AS interact with the MRFP in order to release
resources reserved for the announcement.
18) The AS sends a 3xx, 4xx, 5xx or 6xx response to the INVITE request to
S‑CSCF.
19) S‑CSCF sends a 3xx, 4xx, 5xx or 6xx response to the INVITE request to the
originating user.
20) S‑CSCF receives an ACK request from the originating user.
21) S‑CSCF sends an ACK request to the AS.
### A.3.1.2 Using an established session
This subclause explains how an AS can use an established session to send the
in‑band announcement and when the announcement is sent, release the
communication and include an appropriate reject code in the BYE request.
Figure A.8 shows the signalling flow for the scenario.
{width="4.500694444444444in" height="8.872916666666667in"}
Figure A.8: In-band information generated by network when\ an invitation to a
communication is rejected
The originating user initiates communication by means of an INVITE request. A
long the path towards the terminating user an AS determines that the INVITE
request cannot be forwarded to the terminating user.
The steps are as follows:
1) S-CSCF receives an INVITE request from the originating user. The
originating user can be a user served by this S-CSCF, a user served by another
S-CSCF or a user connected to PSTN/ISDN via a MGCF.
2) S-CSCF sends a 100 (Trying) response.
3) S-CSCF evaluates the Initial Filter Criteria.
4) S-CSCF sends the INVITE request to the AS.
5) The AS sends a 100 (Trying) response to S-CSCF.
6) The AS decides to reject the communication request and to send an
announcement in-band in order to give a detailed reason to the originating
user.
7) The MRFC collocated with the AS interact with the MRFP and reserves
resources for the announcement.
8) The AS sends a 200 (OK) response to the INVITE request to S-CSCF.
9) S-CSCF sends the 200 (OK) response to the INVITE request towards the
originating user.
10) The MRFC collocated with the AS interact with the MRFP in order to start
the announcement.
11S-CSCF receives an ACK request from the originating user.
12) S-CSCF sends the ACK request to the AS.
13) MRFP sends the announcement towards the originating user.
14) The MRFP interacts with the MRFC collocated with the AS to indicate that
the announcement is sent.
15) The MRFC collocated with the AS interact with the MRFP in order to release
resources reserved for the announcement.
16) The AS sends a BYE request to S-CSCF. The BYE request can include an
appropriate reject reason.
17) S-CSCF sends the BYE request towards the originating user.
18) S-CSCF receives a 200 (OK) response to the BYE request from the
originating user.
19) S-CSCF sends the 200 (OK) response to the BYE request to the AS.
## A.3.2 Including an Error-Info header field in a 3xx, 4xx, 5xx and 6xx
response
This subclause explains how an AS can include a reference to an announcement
stored in the network.
IETF defines an Error-Info header field for use in 3xx, 4xx, 5xx and 6xx
responses to the INVITE request. The Error‑Info header field transports a
reference to a file e.g. a file containing an announcement.
When the originating UE receives the reference the UE retrieves the
announcement and plays it for the user.
Figure A.9 shows the message flow for the scenario.
{width="4.447916666666667in" height="4.258333333333334in"}
Figure A.9: Error-Info header in 3xx, 4xx, 5xx and 6xx responses
The originating user initiates communication by means of an INVITE request. A
long the path towards the terminating user an AS determines that the INVITE
request cannot be forwarded to the terminating user.
The steps are as follows:
1) S-CSCF receives an INVITE request from the originating user (in the case
the AS is an O-AS) or the originating network (in the case the AS is a T-AS).
2) S-CSCF sends a 100 (Trying) response.
3) S-CSCF evaluates the Initial Filter Criteria.
4) S-CSCF sends the INVITE request to the AS.
5) The AS sends a 100 (Trying) response to S-CSCF.
6)The AS decides to reject the invitation to communication and to provide a
reference to an announcement explaining the reason in more detail.
7) The AS sends a 3xx, 4xx, 5xx or 6xx response to S-CSCF. The application
server inserts a valid Error-Info header field in either a 3xx, 4xx, 5xx or
6xx response to the INVITE request, including a URL to a media file containing
the appropriate tone, announcement or music.
EXAMPLE: [http://operator.net/announcement.wav]{.underline}, in the picture
abbreviated to http://url.wav, is played at the originating UE (after step
10).
8) S-CSCF sends the ACK request to the AS.
9) S-CSCF sends the 3xx, 4xx, 5xx or 6xx response towards the originating
user.
10) S-CSCF receives the ACK request.
## A.3.3 Announcements provided by the PSTN/ISDN
The signalling flow for this scenario is the same as the signalling flow
example given in subclause A.1.3.
## A.3.4 Announcement provided to a user connected to the PSTN/ISDN
The signalling flow for this scenario is the same as the signalling flow
example given in subclause A.1.4.
# A.4 Providing announcements to a user during the release of a communication
session
The way an announcement is sent to a user during the release of a
communication depends on the scenario.
The following scenarios exist:
\- scenario 1: two users are communicating with (at least) one AS in the
signalling path (UE-AS-UE); or
\- scenario 2: two (or more) users communicating with (at least) one AS in the
signalling path and MRFP in the media path (UE-AS/MRFC/MRFP-UE).
## A.4.1 Scenario 1: UE - AS - UE
Two users are communicating with (at least) one AS in the signalling path.
Figure A.10 shows the signalling flow for the scenario.
{width="3.76875in" height="6.2125in"}
NOTE: The party still in the communication can return provisional responses to
the INVITE request. However, for simplicity those responses are left out.
Figure A.10: Play announcement using new media during the release of a
communication
The steps of the signalling flow are as follows:
1) S-CSCF receives a BYE request.
2) S-CSCF sends the BYE request to the AS.
3) Service logic in the AS decides to send an announcement to the party still
in the communication.
4) The MRFC interacts with the MRFP in order to reserve resources for the
announcement. As part of the interaction with MRFP, the AS retrieves the media
parameters from MRFP e.g. IP address and port numbers, and provide the IP
address and port numbers of media that original dialog used to the party still
in the communication.
5) The AS sends a reINVITE request to S-CSCF.
6) S-CSCF sends the reINVITE request towards the party still in the
communication.
7) S-CSCF receives a 200 (OK) response.
8) S-CSCF sends the 200 (OK) response to the AS.
9) The AS sends an ACK request to S-CSCF.
10) S-CSCF sends the ACK request to the party still in the communication.
11) The MRFC interacts with the MRFP in order to start the alternative ring
tone.
12) The MRFP sends the announcement towards the party still in the
communication.
13) The complete announcement is sent and the MRFP interacts with the AS/MRFC
in order to inform that the announcement is terminated.
14) The MRFC interacts with the MRFP in order to release the resources used
for the announcement.
15) The AS sends the BYE request to S-CSCF. The BYE request contains the same
information as the BYE request received in step 2 with the modification done
by AS according to rules and procedures of 3GPP TS 24.229 [1].
16) S-CSCF sends the BYE request towards the party still in the communication.
## A.4.2 Scenario 2: UE - AS/MRFC/MRFP - UE
This subclause describes the scenario when two (or more) users are
communicating with (at least) one AS controlling the media path. The MRFP is
in the media path. In this scenario the AS acts as a B2BUA.
Figure A.11 shows the signalling flow for the scenario.
{width="5.375in" height="4.552083333333333in"}
Figure A.11: Play announcement using exist media during the release of a
communication
The steps of the signalling flow are as follows:
1) The AS receives a BYE request.
2) Service logic in the AS decides to start an in‑band announcement towards a
user.
3) The AS using the co-located MRFC interacts with the MRP in order to reserve
resources for the announcement.
4) The MRFC co-located with the AS interacts with the MRFP in order to start
the announcement.
5) The MRFP sends the announcement towards the remote user.
6) The MRFC co-located with the AS interacts with the MRFP to stop the
announcement.
The AS sends the BYE request towards the remote user. The BYE request contains
the same information as the BYE request received in step 1 with the
modification done by AS according to rules and procedures of 3GPP TS 24.229
[1].
# A.5 Providing announcements to a terminating user just after the call is
answered and before establishing direct communication session between end
users
## A.5.1 Switch media path from (UE-AS/MRFC/MRFP) to (UE-UE) within the same
dialog
In order to provide announcement to the terminating UE when the called user
answers the call, the AS associated with MRFC providing announcement, acting
as a B2BUA, will intercept all SIP messages exchanged between the end UEs
prior to establishing media stream between end UEs. The AS will replace SDP
indicated by the originating UE to establish media stream with MRFC and
provide announcement from MRFC once the call is answered, which later on can
be replaced with SDP indicated originally by the originating UE.
Figure A.12: Announcement provided to the terminating UE when the called user
answers the call and prior to establishing media stream between users
The steps of the flow are as follows:
1-2) The originating UE sends INVITE request to the intermediate IM CN
subsystem.
3-4) The AS modifies the SDP in the received INVITE request so that the media
stream will be established to the MRFP associated with the AS.
5-8) The called party is alerted. The terminating UE sends SIP 183 (Session
Progress) provisional response for the INVITE request.
9-12) PRACK request is sent towards the terminating UE.
13-14) The called party answers the call. The terminating UE sends SIP 200
(OK) response for the INVITE request.\ The AS providing the announcement
terminates this response.
15-16) The AS sends ACK request to the terminating UE. The MRFP associated
with the AS starts the announcement to the terminating UE, and the called user
will receive the announcement.
17-18) When the announcement finishes, the AS sends UPDATE request containing
SDP received in the INVITE request from the originating UE to the terminating
UE.
19-20) The terminating UE updates the media stream based on the information
received in the UPDATE request. The terminating UE sends SIP 200 (OK) response
to the UPDATE request.\ The AS providing the announcement terminates this
response.
NOTE: SDP answer conveyed in this 200 (OK) response from the terminating UE is
assumed to be the same as the SDP answer conveyed in 183 (Session Progress)
response in step 5-8.
21-22) The AS sends 200 OK response to the originating UE.
23-24) The originating UE sends ACK request. The AS providing the announcement
terminates this request. The media between the two UEs are established.
## A.5.2 Using 180 (Ringing) response towards originating UE
This subclause shows an example signalling flow of how an AS can send an
announcement to the called user just after the call is answered and before
establishing direct communication session to the calling user.
Separate early dialogs are established between the originating UE and the AS
controlling the announcement, and the originating UE and the terminating UE.
The dialog between the originating UE and AS is in this example only used for
sending a 180 (Ringing) response.
Figure A.12 shows the message flow for the scenario.
Figure A.12: Announcement provided to the terminating UE when the called user
answers the call and prior to establishing media stream between end users
NOTE: For clarity, the SIP 100 (Trying) responses are not shown in the
signalling flow.
The steps of the flow are as follows:
1-2) The originating UE sends INVITE request to the intermediate IM CN
subsystem. The originating UE does not have resources available.
3-4) The AS modifies the SDP in the received INVITE request so that the media
stream will be established to the MRFP associated with the AS. The media
parameters may be different than those received in the offer. The AS indicates
that the MRF resources are available.
5-6) Since the MRF resources are available, the terminating UE starts
reservation of the resources and when the resources are available the called
party is alerted. The terminating UE sends SIP 180 (Ringing) provisional
response for the INVITE request.
7-8) PRACK request is sent towards the terminating UE.
9-10) terminating UE confirms the PRACK with 200 (OK) response to PRACK.
11-12) The AS sends a 180 (Ringing) response without pre-condition towards the
calling party.
13-14) The called party answers the call. The terminating UE sends SIP 200
(OK) response for the INVITE request.\ The AS providing the announcement
terminates this response.
15-16) The AS sends ACK request to the terminating UE. The MRFP associated
with the AS starts the announcement to the terminating UE, and the called user
will receive the announcement.
17-18) When the announcement finishes, the AS sends a re-INVITE request
containing the SDP offer received in the INVITE request from the originating
UE to the terminating UE. All media offered for providing the announcement is
removed (i.e. media lines are set to port \"0\") if not included in the
original offer from the calling party. The remaining media are indicated
without having resources at the originating side.
19-20) Since the originating UE does not have resources, the terminating UE
sends the SDP answer in 183 (Session Progress) response to the re-INVITE
request based on the information received in the re-INVITE request.
21-22) The AS sends a 183 (Session Progress) response towards the calling
party with the SDP received in message 20. Note that the response is a
different dialog than the dialog created by the 180 (Ringing) response in step
11-12.
23-30) The calling party sends the PRACK request which the AS forwards to
terminating UE and which the terminating UE confirms by 200 (OK) for PRACK.
31-38) When resources are reserved by the originating UE the originating UE
sends an UPDATE request which the AS forwards to the terminating UE and which
the terminating UE confirms by 200 (OK) for UDPATE.
39-40) When the terminating UE has all the resources available, the
terminating UE sends 200 (OK) response to the re-INVITE request.
41-42) The AS sends the 200 (OK) response to the original INVITE request.
43-46) The originating UE sends ACK request. The AS providing the announcement
forwards the ACK to the terminating UE.
The media between the two UEs are established.
###### ## Annex B (informative): Signalling flows for Network Determined User
Busy (NDUB)
# B.1 Basic call with UE busy with T-AS involvement (NDUB condition check)
This subclause describes the signalling flow for the case when the user is
busy but the network does not consider the user to be busy.
Figure B.1 **shows the signalling flow for the scenario.**
{width="6.683333333333334in" height="4.31875in"}
NOTE: The signalling flow is simplified for readability reasons.
Figure B.1: Basic call with UE busy with T-AS involvement (NDUB condition
check)
This signalling flow assumes the following:
\- the user in the terminating network needs the involvement of an AS for NDUB
or other busy condition activated services like CCBS or CFBS; and
\- the filter criteria are set for basic communication accordingly.
NOTE: The same scenario applies also for other error responses e.g. for the
403 (Service Denied) response, the 480 (Temporarily Unavailable) response.
The steps of the flow are as follows:
1) The S-CSCF serving the terminating user receives an INVITE request from the
originating network. The originating network can be an IMS network, a
PSTN/ISDN Emulation network, another SIP based network or a MGCF interworking
with PSTN/ISDN.
2) The S-CSCF checks the IFC and finds that a trigger fires and sends the
INVITE request to the AS. The address to the AS is obtained from the IFC.
3) The AS checks the busy condition and it is not NDUB and sends the INVITE
request to the S‑CSCF.
4) The S-CSCF sends the INVITE request according to the P-CSCF.
5) The P-CSCF sends the INVITE request according to the UE#2.
6) The UE#2 is e.g. involved in another communication and determines itself to
be busy and sends a 486 (Busy here) response to the P-CSCF.
7) The 486 (Busy here) response to originating network via the S-CSCF and the
AS.
# B.2 Busy condition (NDUB) detected by terminating AS
This subclause shows an example of a signalling flow when a terminating
network determines the user to be busy i.e. the NDUB case.
Figure B.2 shows the signalling flow for the scenario.
{width="6.322916666666667in" height="3.907638888888889in"}
NOTE: The signalling flow is simplified for readability reasons.
Figure B.2: Busy condition (NDUB) detected by terminating AS
This signalling flow assumes the following:
\- the user in the terminating network needs the involvement of AS for NDUB or
other busy condition activated services like CCBS or CFBS; and
\- that the filter criteria are set for basic communication accordingly.
The steps of the flow are as follows:
1) The S-CSCF serving the terminating user receives an INVITE request from the
originating network. The originating network may be an IMS network, a
PSTN/ISDN Emulation network, another SIP based network or a MGCF interworking
with PSTN/ISDN.
2) The S-CSCF checks the IFC and finds that a trigger fires and sends the
INVITE request to the AS. The address to the AS is obtained from the IFC.
3) The AS checks the busy condition and detects that it is NDUB and sends a
486 (Busy here) response to the\ S-CSCF.
4) The AS sends the 486 (Busy here) response to the originating network via
the S-CSCF.
5) The S-CSCF sends the 486 (Busy here) response to the originating network.
###### ## Annex C (normative): Void
###### ## Annex D (normative): AS establishing multiple dialogs with
originating UE
# D.1 General
If the AS needs to establish an early dialog between itself and the
originating UE (or originating network), for example in order to establish a
media path in order to send announcements or other kind of early media
backwards, it shall do so by sending a provisional response towards the
originating UE. The setup procedures between the originating UE and the AS are
identical to normal setup procedures.
The To header tag value in the dialog between the originating UE and the AS
shall, in order to separate the dialogs, be different than the To header tag
value in messages used on the dialog used between the originating and
terminating UEs. The AS normally receives the To header tag value for the
dialog between the UEs from the terminating UE (or the terminating network),
but if the AS acts as a B2BUA it may also, depending on the functionality,
generate a new To header value.
If the AS needs to establish an early dialog between itself and the
originating UE triggered by the receipt of a provisional responses of the
terminating UE, and the terminating UE has already included a SDP answer in a
reliable provisional response, the AS first shall forward the provisional
response to the originating UE reliably in the e2e dialog, after changing the
Status-Line to SIP 183 (Session Progress) response.
The need for the AS to establish an early dialog between itself and the
originating UE is determined on the services offered to the originating UE.
If the AS wants to terminate the early dialog between itself and the
originating UE before the terminating UE has sent a final SIP response, and
the originating UE has indicated support of the 199 (Early Dialog Terminated)
response code [18], the AS shall send a 199 (Early Dialog Terminated)
provisional response towards the originating UE.
NOTE 1: Unless the originating UE can determine that the messages sent on the
early dialog between itself and the AS are originated from the AS, it will
assume that forking has occurred in the network.
NOTE 2: If the originating UE has indicated that it does not want the initial
INVITE to be forked, the AS may still establish a separate early dialog
between itself and the originating UE, since even though the originating UE
may assume that the call has been forked only one terminating UE will actually
receive the INVITE request.
NOTE 3: Once the originating UE has received 200 (OK) from the terminating UE
the early dialog between the originating UE and the AS will be terminated, as
described in IETF RFC 3261 [4].
###### ## Annex E (informative): Signalling flows for 3^rd^ party call control
The following signalling flows provide examples for the 3pcc procedures
described in subclause 4.7.2.9.7.
Figure E.1: Example flow for REFER interworking with REFER sent\ inside a
dialog with usage of a media server
Figure E.2: Example flow for REFER interworking with REFER sent\ outside a
dialog with usage of a media server
Figure E.3: Example flow for REFER interworking in case of\ No Reply with
usage of a media server
Figure E.4: Example flow for REFER interworking in case the Refer-to header
field\ contains a replaces parameter with usage of a media server
Figure E.5: Example flow for REFER interworking with REFER sent inside a
dialog\ without usage of a media server
###### ## Annex F (informative): Void
#
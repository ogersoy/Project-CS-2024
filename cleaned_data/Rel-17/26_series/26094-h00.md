# Foreword
This Technical Specification has been produced by the 3^rd^ Generation
Partnership Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# 1 Scope
The present document specifies two alternatives for the Voice Activity
Detector (VAD) to be used in the Discontinuous Transmission (DTX) as described
in [3]. Implementors of mobile station and infrastructure equipment conforming
to the AMR specifications can choose which of the two VAD options to
implement. There are no interoperability factors associated with this choice.
The requirements are mandatory on any VAD to be used either in User Equipment
(UE) or Base Station Systems (BSS)s that utilize the AMR speech codec.
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or nonâ€‘specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
[1] 3GPP TS 26.073: \"Adaptive Multi-Rate (AMR); ANSI C source code\".
[2] 3GPP TS 26.090: \"Transcoding functions\".
[3] 3 GPP TS 26.093: \"Source Controlled Rate operation\".
[4] ITU, The International Telecommunications Union, Blue Book, Vol. III,
Telephone Transmission Quality, IXth Plenary Assembly, Melbourne, 14-25
November, 1988, Recommendation G.711, Pulse code modulation (PCM) of voice
frequencies.
# 3 Technical Description of VAD Option 1
## 3.1 Definitions, symbols and abbreviations
### 3.1.1 Definitions
For the purposes of the present document, the following terms and definitions
apply:
**frame: t** ime interval of 20 ms corresponding to the time segmentation of
the speech\ transcoder
### 3.1.2 Symbols
For the purposes of the present document, the following symbols apply.
#### 3.1.2.1 Variables
**bckr_est[n]** background noise estimate
**burst_count** counts length of a speech burst, used by VAD hangover addition
**hang_count** hangover counter, used by VAD hangover addition
**complex_hang_count** hangover counter, used by CAD hangover addition
**complex_hang_timer** hangover initator, used fo Complex Activity Estimation
**lagcount** pitch detection counter
**level[n]** signal level
**new_speech** pointer of the speech encoder, points a buffer containing last
received samples of a speech frame [2]
**noise_level** average level of the background noise estimate
**oldlagcount** lagcount of the previous frame
**pitch** flag indicating presence of a periodic signal
**complex_warning** flag indicating the presence of a complex signal.
**best_corr_hp** normalized and limited value from maximum HP filtered
correlation vector
**corr_hp** filtered best_corr_hp values
**pow_sum** power of the input frame
**s(i)** samples of the input framer
**snr_sum** measure between input frame and noise estimate
**stat_count** stationarity counter
**stat_rat** measure indicating stationary
**T_op[n]** open-loop lags [2]
**t0** autocorrelation maxima calculated by the open-loop pitch analysis [2]
**t1** signal power related to the autocorrelation maxima t0 [2]
**tone** flag indicating the presence of a tone
**vad_thr** VAD threshold
**VAD_flag** boolean VAD flag
**vadreg** intermediate VAD decision
**complex_low** intermediate complex signal decisions
**complex_high** intermediate complex signal decisions
#### 3.1.2.2 Constants
**ALPHA_UP1** constant for updating noise estimate (see clause 3.3.5.2)
**ALPHA_DOWN1** constant for updating noise estimate (see clause 3.3.5.2)
**ALPHA_UP2** constant for updating noise estimate (see clause 3.3.5.2)
**ALPHA_DOWN2** constant for updating noise estimate (see clause 3.3.5.2)
**ALPHA3** constant for updating noise estimate (see clause 3.3.5.2)
**ALPHA4** constant for updating average signal level (see clause 3.3.5.2)
**ALPHA5** constant for updating average signal level (see clause 3.3.5.2)
**BURST_LEN_HIGH_NOISE** constant for controlling VAD hangover addition (see
clause 3.3.5.1)
**BURST_LEN_LOW_NOISE** constant for controlling VAD hangover addition (see
clause 3.3.5.1)
**COEFF3** coefficient for the filter bank (see clause 3.3.1)
**COEFF5_1** coefficient for the filter bank (see clause 3.3.1)
**COEFF5_2** coefficient for the filter bank (see clause 3.3.1)
**HANG_LEN_HIGH_NOISE** constant for controlling VAD hangover addition (see
clause 3.3.5.1)
**HANG_LEN_LOW_NOISE** constant for controlling VAD hangover addition (see
clause 3.3.5.2)
**HANG_NOISE_THR** constant for controlling VAD hangover addition (see clause
3.3.5.2)
**L_FRAME** size of a speech frame, 160
**L_NEXT** length for the lookahead of the speech encoder, 40
**LTHRESH** threshold for pitch detection (see clause 3.3.2)
**NOISE_MAX** maximum value for noise estimate (see clause 3.3.5.2)
**NOISE_MIN** minimum value for noise estimate (see clause 3.3.5.2)
**NTHRESH** threshold for pitch detection (see clause 3.3.2)
**POW_PITCH_THR** threshold for pitch detection (see clause 3.3.5)
**POW_COMPLEX_THR** threshold for complex detection (see clause 3.3.5)
**STAT_COUNT** threshold for stationary detection (see clause 3.3.5.2)
**CAD_MIN_STAT_COUNT** minimum threshold after complex warning
**STAT_THR** threshold for stationary detection (see clause 3.3.5.2)
**STAT_THR_LEVEL** threshold for stationary detection (see clause 3.3.5.2)
**TONE_THR** threshold for tone detection (see clause 3.3.3)
**VAD_P1** constant of computation for VAD threshold (see clause 3.3.5.2)
**VAD_POW_LOW** constant for controlling VAD hangover addition (see clause
3.3.5.1)
**VAD_SLOPE** constant of computation for VAD threshold (see clause 3.3.5)
**VAD_THR_HIGH** constant of computation for VAD threshold (see clause 3.3.5)
**CVAD_THRESH_ADAPT_HIGH** constant for updating complex_high
**CVAD_THRESH_ADAPT_LOW** constant for updating complex_low
**CVAD_THRESH_HANG** constant for updating complex_hang_timer
**CVAD_HANG_LIMIT** constant for initiating complex_hang_count
**CVAD_HANG_LENGTH** constant for resetting complex_hang_count
#### 3.1.2.3 Functions
**+** addition
**-** subtraction
***** multiplication
**/** division
**\| x \|** absolute value of x
**AND** Boolean AND
**OR** Boolean OR
{width="2.56875in" height="0.25in"}
**MIN(x,y)** ={width="0.6520833333333333in" height="0.5in"}
**MAX(x,y)** ={width="0.6520833333333333in" height="0.5in"}
### 3.1.3 Abbreviations
For the purposes of the present document, the following abbreviations apply:
**ANSI** American National Standards Institute
**DTX** Discontinuous Transmission
**VAD** Voice Activity Detector
**CAD** Complex Activity Detection
**CNG** Comfort Noise Generation
## 3.2 General
The function of the VAD algorithm is to indicate whether each 20 ms frame
contains signals that should be transmitted, i.e. speech, music or information
tones. The output of the VAD algorithm is a Boolean flag (VAD_flag) indicating
presence of such signals.
## 3.3 Functional description
The block diagram of the VAD algorithm is depicted in figure 1. The VAD
algorithm uses parameters of the speech encoder to compute the Boolean VAD
flag (VAD_flag). Samples of the Input frame (s(i)) are divided into sub-bands
and level of the signal in each band (level[n]) is calculated. Input for the
pitch detection function are open-loop lags (T_op[n]), which are calculated by
open-loop pitch analysis of the speech encoder. The pitch detection function
computes a flag (pitch) which indicates presence of pitch. Tone detection
function calculates a flag (tone), which indicates presence of an information
tone. Tones are detected based on pitch gain of the open-loop pitch analysis
The pitch gain is estimated using autocorrelation values (t0 and t1) received
from the pitch analysis. Complex Signal Detection function calculates a flag
(complex_warning), which indicates presence of a correlated complex signal
such as music. Correlate complex signals are detected based on analysis of the
correlation vector available in the open-loop pitch analysis.The VAD decision
function estimates background noise levels. Intermediate VAD decision is
calculated based on the comparison of the background noise estimate and levels
of the input frame (level[n]). Finally, the VAD flag is calculated by adding
hangover to the intermediate VAD decision.
{width="5.590277777777778in" height="5.631944444444445in"}
Figure 3.1: Simplified block diagram of the VAD algorithm: Option 1
### 3.3.1 Filter bank and computation of sub-band levels
The input signal is divided into frequency bands using a 9-band filter bank
(figure 3.2). Cut-off frequencies for the filter bank are shown in table 3.1.
Table 3.1. Cut-off frequencies for the filter bank
* * *
Band number Frequencies 1 0 - 250 Hz 2 250 - 500 Hz 3 500 - 750 Hz 4 750 -
1000 Hz 5 1000 - 1500 Hz 6 1500 - 2000 Hz 7 2000 - 2500 Hz 8 2500 - 3000 Hz 9
3000 - 4000 Hz
* * *
Input for the filter bank is the speech frame pointed by the new_speech
pointer of the speech encoder [1]. Input values for the filter bank are scaled
down by one bit. This ensures safe scaling, i.e. saturation can not occur
during calculation of the filter bank.
{width="4.7in" height="3.097916666666667in"}
Figure 3.2: Filter bank
The filter bank consists of 5^th^ and 3^rd^ order filter blocks. Each filter
block divides the input into high-pass and low-pass parts and decimates the
sampling frequency by 2. The 5^th^ order filter block is calculated as
follows:
{width="2.402083333333333in" height="0.26319444444444445in"} (3.1a)
{width="2.4305555555555554in" height="0.26319444444444445in"} (3.1b)
where
x(i) input signal for a filter block
{width="0.40208333333333335in" height="0.26319444444444445in"} low-pass
component
{width="0.41597222222222224in" height="0.26319444444444445in"} high-pass
component
The 3^rd^ order filter block is calculated as follows:
{width="2.1805555555555554in" height="0.26319444444444445in"} (3.2a)
{width="2.1930555555555555in" height="0.26319444444444445in"} (3.2b)
The filters {width="0.3333333333333333in"
height="0.2361111111111111in"},{width="0.3458333333333333in"
height="0.2361111111111111in"}, and{width="0.3333333333333333in"
height="0.25in"}are first order direct form all-pass filters, whose transfer
function is given by:
{width="1.1930555555555555in" height="0.4576388888888889in"}, (3.3)
where C is the filter coefficient.
Coefficients for the all-pass filters {width="0.3333333333333333in"
height="0.2361111111111111in"},{width="0.3458333333333333in"
height="0.2361111111111111in"}, and{width="0.3333333333333333in"
height="0.25in"} are COEFF5_1, COEFF5_2, and COEFF3, respectively.
Signal level is calculated at the ouput of the filter bank at each frequency
band as follows:
{width="1.4305555555555556in" height="0.5131944444444444in"}, (3.4)
where:
n index for the frequency band
{width="0.375in" height="0.25in"} sample i at the output of the filter bank at
frequency band n
{width="0.5833333333333334in" height="0.25in"} ={width="1.0416666666666667in"
height="0.7777777777777778in"}
{width="0.44305555555555554in" height="0.25in"} ={width="0.9430555555555555in"
height="0.7777777777777778in"}
Negative indices of {width="0.375in" height="0.25in"} refer to the previous
frame.
### 3.3.2 Pitch detection
The purpose of the pitch detection function is to detect vowel sounds and
other periodic signals. The pitch detection is based on comparison of open-
loop lags (T_op[n]), which are calculated by the speech encoder [2]. If the
difference of consecutive open-loop lags (T_op[n]) is smaller than a
threshold, lagcount is incremented. If the sum of the lagcounts of two
consecutive frames is high enough, the pitch flag is set. For 5.15 and 4.75
kbit/s rates, only one open-loop lag is calculated, and therfore only the
first lag-comparison is made every frame. The pitch flag is calculated as
follows:
Lagcount = 0;
If ( \| T_op[-1] - T_op[0] \| \= NTHRESH)
pitch = 1
else
pitch = 0
oldlagcount = Lagcount
T_op[-1] refers to the open-loop lag of the previous frame.
### 3.3.3 Tone detection
Tone detection is used to detect information tones, since the pitch detection
function can not always detect these signals. Also, other signals which
contain very strong periodic component are detected, because it may sound
annoying if these signals are replaced by comfort noise. If the open-loop
pitch gain is higher than the constant TONE_THR, tone is detected and tone
flag is set. The pitch gain can be tested by comparing variables t0 and t1 as
follows:
if (t0 > TONE_THR * t1)
tone = 1
The speech encoder calculates the pitch in three delay ranges, except for mode
10.2 kbit/s, where only one range is used. The above comparison is made once
for each delay range and the tone flag should be set if the condition is true
at least in one range. Otherwise, the tone flag should be set to zero.
The variables t0 and t1 are calculated by the open-loop pitch analysis of the
speech encoder [2]. The variable t0 is autocorrelation maxima given by:
{width="1.5416666666666667in" height="0.375in"} (3.5)
The variable t1 is the signal power related to the autocorrelation maxima t0
at the delay value k:
{width="1.1520833333333333in" height="0.375in"} (3.6)
The open-loop pitch search and correspondingly the tone flag is computed twice
in each frame, except for modes 5.15 kbit/s and 4.75 kbit/s, where it is
computed only once.
### 3.3.4 Correlated Complex Signal Analysis (and detection)
Correlated complex signal detection is used to detect correlated signals in
the highpass filtered weighted speech domain, since the pitch and tone
detection functions can not always detect these signals. Signals which contain
very strong correlation values in the high pass filtered domain are taken care
of, because it may sound really annoying if these signals are replaced by
comfort noise. If the statistics of the maximum normalized correlation value
of a high pass filtered input signal indicates the presence of a correlated
complex signal a flag **_complex_warning_** is set. To reduce complexity the
high band correlation analysis is performed in a simplified manner by
analysing the high pass filtered fullband correlation vector which is
available from the OL-LTP analysis performed by the speech encoder at least
once in each frame.
_best_corr_hp~m~_ is the maximum normalized value of the high pass filtered
correlation in the range 19-146 limited to be in the range [1.0, 0.0]. (Note
that the _best_corr_hp_ value is delayed one frame). The high pass filter is a
simple first order filter with coefficients [1, -1] The _best_corr_hp_ value
is filtered according to :
{width="4.457638888888889in" height="0.25in"},
_where alpha_ is varied between 0.98 and 0.8 as a function of _corr_hp~m~_ and
_best_corr_hp~m~_
The _corr_hp_ output value is thresholded into two to registers _complex_high_
, _complex_low_ and one _counter complex_hang_timer_.
_complex_low_ is set to 1 if the _corr_hp_ value is greater than
CVAD_THRESH_ADAPT_LOW.
_complex_high_ is set to 1 if the _corr_hp_ value is greater than
CVAD_THRESH_ADAPT_HIGH.
_complex_hang_timer_ is increased by 1 if the _corr_hp_ value is greater than
CVAD_THRESH_HANG. If the _corr_hp_ value is lower than or equal to
CVAD_THRESH_HANG the _complex_hang_timer_ value is set to 0 _._
The flag **_complex_warning_** is set if _complex_low have been set for 15
consecutive frames_ or _complex_high_ has been set for 8 consecutive frames
_._
The open-loop pitch search and correspondingly the tone flag is computed twice
in each frame, except for modes 5.15 kbit/s and 4.75 kbit/s, where it is
computed only once. The computation of the corr_hp value is however always
done only once per frame using the newest correlation vector available.
### 3.3.5 VAD decision
Power of the input frame is calculated as follows:
{width="2.1659722222222224in" height="0.5in"}, (3.7)
where samples s(i) of the input frame are pointed by the new_speech pointer of
the speech encoder. If the power of the input frame (pow_sum) is lower than
the constant POW_PITCH_THR, last pitch flag is set to zero. If the power of
the input frame (pow_sum) is lower than the constant POW_COMPLEX_THR, last
complex_low flag is set to zero.
The difference between the signal levels of the input frame and background
noise estimate is calculated as follows:
{width="2.7215277777777778in" height="0.47152777777777777in"}, (3.8)
where:
level[n] signal level at band n
bckr_est[n] level of background noise estimate at band n
VAD decision is made by comparing the variable snr_sum to a threshold. The
threshold (vad_thr) is tuned to get desired sensitivity at each background
noise level. The higher the noise level the lower is the threshold. Specially,
a low threshold at high-level background noise is needed to detect speech
reliably enough, although probability of detecting noise as speech also
increases.
Average level of background noise is calculated by adding noise estimates at
each band:
{width="2.0416666666666665in" height="0.47152777777777777in"} (3.9)
Threshold is calculated using average noise level as follows:
{width="5.138888888888889in" height="0.22152777777777777in"}, (3.10)
where VAD_SLOPE, VAD_P1, and VAD_THR_HIGH are constants.
The variable vadreg indicates intermediate VAD decision and it is calculated
as follows:
if (snr_sum > vad_thr)
vadreg = 1
else
vadreg = 0
#### 3.3.5.1 Hangover addition
Before the final VAD flag is given, a hangover is added. The hangover addition
helps to detect low power endings of speech bursts, which are subjectively
important but difficult to detect. Also a long hangover is added if the signal
has been found to be of very complex nature for a long time (2 seconds) since
the VAD is not likely to work reliably for such a complex signal.
VAD flag is set to \"1\" if less that hang_len frames with \"0\" decision have
been elapsed since burst_len consecutive \"1\" decisions have been detected.
The variables hang_len and burst_len are set depending on the average noise
level (noise_level). The **_vad_flag_** is also controlled by the
**_complex_hang_count_** which indicates that the signal is too complex for
the VAD and should not be used with a Comfort noise generation algorithm. The
filtered correlation value **_corr_hp_** is also used as an activity
indication after the VAD has indicated noise for a while (during 200 ms), this
will aid in situations where the VAD noise estimate has adapted to a rather
stationary but still all to complex signal to make it sound well with CNG.
The power of the input frame is compared to a threshold (VAD_POW_LOW). If the
power is lower, the VAD flag is set to \"0\" and no hangover is added. The
VAD_flag is calculated as follows:
if (noise_level > HANG_NOISE_THR)
burst_len = BURST_LEN_HIGH_NOISE
hang_len = HANG_LEN_HIGH_NOISE
else
burst_len = BURST_LEN_LOW_NOISE
hang_len = HANG_LEN_LOW_NOISE
if(complex_hang_timer > CVAD_HANG_LIMIT) {
if(complex_hang_count \ CVAD_THRESH_IN_NOISE ) ) {
VAD_flag = 1;
Goto **Exit**
}
}
if (vadreg = 1){
burst_count = burst_count + 1}
if (burst_count >= burst_len){
hang_count = hang_len
}
VAD_flag = 1
} else {
burst_count = 0
if (hang_count > 0){
hang_count = hang_count - 1
VAD_flag=1
}
}
Label **Exit**
#### 3.3.5.2 Background noise estimation
Background noise estimate (bckr_est[n]) is updated using amplitude levels of
the previous frame. Thus, the update is delayed by one frame to avoid
undetected start of speech bursts to corrupt the noise estimate. If the
internal VAD decision is \"1\" or if pitch has been detected, the noise
estimate is not updated upwards. The update speed for the current frame is
selected as follows:
if ((vadreg for the last 4 frames has been zero) AND
(pitch for the last 4 frames has been zero) AND
(we are not in complex signal hangover))
alpha_up = ALPHA_UP1
alpha_down = ALPHA_DOWN1
else
if ((stat_count = 0 ) AND (not in complex_signal hangover))
alpha_up = ALPHA_UP2
alpha_down = ALPHA_DOWN2
else
alpha_up = 0
alpha_down = ALPHA3
The variable stat_count indicates stationary and its propose is explained
later in this clause. The variables alpha_up and alpha_down define the update
speed to upwards and downwards. The update speed for each band n is selected
as follows:
if ({width="0.9430555555555555in" height="0.25in"} \ STAT_THR)
stat_count = STAT_COUNT
else
if ((vadreg) AND (stat_count â‰  0))
stat_count = stat_count - 1
The average signal levels (ave_level[n]) are calculated as follows:
{width="4.4430555555555555in" height="0.25in"} (3.13)
The update speed (alpha) for the previous equation is selected as follows:
if (stat_count = STAT_COUNT)
alpha = 1.0
else if (vadreg = 1)
alpha=ALPHA5
else
alpha = ALPHA4
# 4 Technical Description of VAD Option 2
## 4.1 Definitions, symbols and abbreviations
### 4.1.1 Definitions
For the purposes of the present document, the following terms and definitions
apply:
**codec: c** ombination of an encoder and decoder in series (encoder/decoder)
**compand:** process of compressing and expanding a signal. In this text, the
process is described in terms of PCM [4]
**Decoder** : generally, a device for the translation of a signal from a
digital representation into an analog format. For the present document, a
device which converts speech encoded in the format specified in the present
document to analog or an equivalent PCM representation
**DFT** : see Discrete Fourier Transform
**Discrete Fourier Transform (DFT)** : method of transforming a time domain
sequence into a corresponding frequency domain sequence
**Encoder** : generally, a device for the translation of a signal into a
digital representation. For the present document, a device which converts
speech from an analog or its equivalent PCM representation to the digital
representation described in the present document
**Fast Fourier Transform (FFT)** : efficient implementation of the Discrete
Fourier Transform
**FFT** : see Fast Fourier Transform
**Vocoder** :voice coder
**frame: t** ime interval of 20 ms corresponding to the time segmentation of
the speech transcoder
### 4.1.2 Symbols
For the purposes of the present document, the following symbols apply.
#### 4.1.2.1 Variables
_Î±ch_(_m_) channel energy smoothing factor
_Î±_(_m_) exponential windowing factor
âˆ†~Î•~(m) estimated spectral deviation between current power spectrum and
average long term power spectral estimate
Ï†(m) spectral peak-to-average ratio
Ïƒ _q_ ^(i _)_ ^ quantized channel SNR indices
b(m) burst count
b~th~ burst count threshold
{_d_(_m_)} overlapped portion of the frame buffer of input samples
E _ch_(_m,i_) channel energy estimate; channel i, subframe m
**E** _ch_(_m_) vector of channel energy estimates, 0 â‰¤ i \ _Î±~H\ ~_ upper limit for values of _Î±_(_m_)
>
> _Î±~L\ ~_ lower limit for values of _Î±_(_m_)
>
> _Î±~n~_ channel noise smoothing factor
>
> _Î¶p_ pre-emphasis factor
>
> b~table~ table to generate b~th~
>
> D overlap (delay) in sample intervals
>
> DEV_THLD threshold for setting _sinewave_flag_
>
> E~floor~ low threshold for _Etot_(_m_)
>
> _EH_ high energy endpoint for linear interpolation of _E~tot~(m)_
>
> _Einit_ minimum allowable channel noise initialisation energy
>
> _EL_ low energy endpoint for linear interpolation of _E~tot~(m)_
>
> _E_ min minimum allowable channel energy
>
> f _H_ high channel combining table
>
> f _L_ low channel combining table
>
> g(n) trapezoidal window, n = 0 to M
>
> G(k) frequency domain transformation of g(n)
>
> h~table~ table to generate h~cnt~
>
> HYSTER_CNT_THLD threshold for _hyster_cnt_
>
> L subframe length in samples
>
> M DFT sequence length
>
> _Nc_ number of combined channels
_NOISE_FLOOR_D_ low threshold for _Etot_(_m_) in dB
UPDATE_CNT_THLD threshold for update_cnt
UPDATE_THLD threshold for v(m)
> V voice metric table
>
> v~table~ table to generate v~th~
#### 4.1.2.3 Functions
**+** addition
**-** subtraction
***** multiplication
**/** division
{width="0.20833333333333334in" height="0.20833333333333334in"} largest integer
â‰¤ x
**AND** Boolean AND
**OR** Boolean OR
{width="0.5833333333333334in" height="0.5138888888888888in"}
{width="2.5694444444444446in" height="0.25in"}
### 4.1.3 Abbreviations
For the purposes of the present document, the following abbreviations apply:
**ANSI American National Standards Institute**
**DTX Discontinuous Transmission**
**VAD Voice Activity Detector**
**CAD Complex Activity Detection**
**CNG** Comfort Noise Generation
## 4.2 General
The function of the VAD algorithm is to indicate whether each 20 ms frame
contains signals that should be transmitted, i.e. speech, music or information
tones. The output of the VAD algorithm is a Boolean flag (VAD_flag) indicating
presence of such signals.
## 4.3 Functional description
The block diagram of the VAD algorithm is depicted in figure 4.1. The VAD
algorithm uses parameters of the speech encoder to compute the Boolean VAD
flag (VAD_flag).
{width="5.625694444444444in" height="4.073611111111111in"}
Figure 4.1: Block Diagram of the VAD algorithm: Option 2
**Input** :
The output of the High-Pass Filter, {_shp_(_n_)}
_\- LTP_flag_ is generated by the comparison of the long-term prediction gain
to a constant threshold LTP_THLD, where the long-term prediction gain _Î²_ is
derived from the speech encoder[2] open-loop pitch predictor.
**Output** :
_-_ The output of the vad is designated as VAD_flag
**Initialization** :
The following variables shall be set to zero at initialization (frame _m_ =
0):
_-_ The pre-emphasis memory
The following shall be initialized to a startup value other than zero:
The channel energy estimate, **E** _ch_(_m_), (see clause 4.3.2)
The long-term power spectral estimate, {width="0.37569444444444444in"
height="0.15694444444444444in"}, (see clause 4.3.5)
The channel noise estimate, **E** _n_(_m_), (see clause 4.3.8)
Processing: The following procedures shall be executed two times per 20 ms
speech frame and the current 10 ms subframe shall be denoted _m_.
### 4.3.1 Frequency Domain Conversion
The input signal is pre-emphasised and windowed prior to frequency domain
conversion. This process is defined as:
{width="2.69375in" height="0.2638888888888889in"}, (4.1)
where _d_(_n_) is the pre-emphasised speech buffer, _Î¶~p~_ is the pre-emphasis
factor, and _L_ is the subframe length. A rectangular window is then used to
frame the speech prior to frequency domain conversion, which is expressed as:
{width="3.125in" height="0.5in"}, (4.2)
where _D_ is the zero-padding offset into the DFT buffer, and _M_ is the DFT
length. The transformation of _g_(_n_) to the frequency domain is performed
using the Discrete Fourier Transform (DFT) defined[^1] as:
{width="2.763888888888889in" height="0.4722222222222222in"} (4.3)
where _e^jÏ‰ ^_ is a unit amplitude complex phasor with instantaneous radial
position _Ï‰_.
### 4.3.2 Channel Energy Estimator
Calculate the channel energy estimate **E** _ch_(_m_) for the current
subframe, _m_ , as:
{width="5.997222222222222in" height="0.5055555555555555in"} (4.4)
where _E_ min is the minimum allowable channel energy, _Î±ch_(_m_) is the
channel energy smoothing factor (defined below), _Nc_ is the number of
combined channels, and _fL_(_i_) and _fH_(_i_) are the _i_ -th elements of the
respective low and high channel combining tables.
The channel energy smoothing factor, _Î±ch_(_m_), is defined as:
{width="1.5965277777777778in" height="0.5in"} (4.5)
So, this means that _Î±ch_(_m_) assumes a value of zero for the first frame
(_m_ = 1) and a value of 0.45 for all subsequent frames. This allows the
channel energy estimate to be initialized to the unfiltered channel energy of
the first frame.
### 4.3.3 Channel SNR Estimator
Estimate the channel SNR vector { _Ïƒ_ } as:
{width="2.5694444444444446in" height="0.5277777777777778in"} (4.6)
where **E** _n_(_m_) is the current channel noise energy estimate (see clause
4.3.8), and then quantify the channel SNR estimate in 3/8 dB steps to yield
the channel SNR indices { _Ïƒ~q~_ } given as:
{width="3.75in" height="0.2638888888888889in"} (4.7)
where the values of { Ïƒ _q_ } are constrained to be between 0 and 89,
inclusive.
### 4.3.4 Voice Metric Calculation
Next, calculate the sum of voice metrics as:
{width="1.2916666666666667in" height="0.4861111111111111in"} , (4.8)
where _V_(_k_) is the _k_ th value of the 90 element voice metric table **V**.
### 4.3.5 Frame SNR and Long-Term Peak SNR Calculation
The instantaneous frame SNR, _SNR_ , and long-term peak SNR, _SNR~p~_(_m_),
are used to calibrate the responsiveness of the VAD decision. When the frame
count is less than or equal to four (_m_ â‰¤ 4) or the forced update flag (sec
4.3.10) is set (fupdate_flag == TRUE), then the SNR\'s are initialized as:
{width="3.013888888888889in" height="0.5277777777777778in"}. (4.9)
Otherwise, the instantaneous frame SNR is generated by:
{width="2.125in" height="0.5277777777777778in"} (4.10)
and the long-term peak SNR is derived by the following expression:
{width="5.777777777777778in" height="0.8055555555555556in"}. (4.11)
The long-term peak SNR is then quantized in 3 dB steps and limited to be
between 0 and 19, as follows:
{width="2.5965277777777778in" height="0.2638888888888889in"} (4.12)
where {width="0.20833333333333334in" height="0.20833333333333334in"} is the
largest integer â‰¤ _x_ (floor function).
### 4.3.6 Negative SNR Sensitivity Bias
In order for the VAD decision to overcome the problem of being over-sensitive
to fluctuating, non-stationary background noise conditions, a bias factor is
used to increase the threshold on which the VAD decision is based. This bias
factor is derived from an estimate of the variablility of the background noise
estimate. The variability estimate is further based on negative values of the
instantaneous SNR. It is presumed that a negative SNR can only occur as a
result of fluctuating background noise, and not from the presence of voice.
Therefore, the bias factor _Î¼_(_m_) is derived by first calculating the
variability factor _Ïˆ_(_m_) as:
{width="3.1527777777777777in" height="0.5277777777777778in"} (4.13)
which is then clamped in magnitude to {width="1.0138888888888888in"
height="0.2222222222222222in"}. In addition, the variability factor is reset
to zero when the frame count is less than or equal to four (_m_ â‰¤ 4) or the
forced update flag (sec 4.3.10) is set (_fupdate_flag_ == TRUE). The bias
factor _Î¼_(_m_) is then calculated as:
{width="2.2777777777777777in" height="0.2361111111111111in"} (4.14)
### 4.3.7 VAD Decision
The quantized SNR _SNR~q~_ is used to determine the respective voice metric
threshold _vth_ , hangover count _hcnt_ , and burst count threshold _bth_
parameters:
{width="3.763888888888889in" height="0.2638888888888889in"} (4.15)
where _SNRQ_ is the index of the respective table elements. The VAD decision
can then be made according to the following pseudocode:
if ( _v_(_m_) > _vth_ \+ _Î¼_(_m)_) { /* if the voice metric > voice metric
threshold*/\ _VAD_(_m_) = ON\ _b_(_m_) = _b_(_m_ -1) + 1 /* increment burst
counter */\ if ( _b_(_m_) > _bth_ ) { /* compare counter with threshold */\
_h_(_m_) = _hcnt_ /* set hangover */\ }\ } else {\ _b_(_m_) = 0 /* clear burst
counter */\ _h_(_m_) = _h_(_m_ -1) -1 /* decrement hangover **/\ ** if
(_h_(_m_) \ NOISE_FLOOR) and ( âˆ† _E_(_m_) \
HYSTER_CNT_THLD )\ _update_cnt_ = 0
where _E~tot~_ is the total channel energy defined as:
{width="1.2361111111111112in" height="0.4861111111111111in"} (4.23)
and _LTP_flag_ is generated by the comparison of the long-term prediction gain
to a constant threshold LTP_THLD, i.e.:
{width="2.888888888888889in" height="0.5in"} (4.24)
where the long-term prediction gain _Î²_ is derived from the speech encoder [2]
open-loop pitch predictor, and can be expressed as:
{width="1.75in" height="0.6111111111111112in"} (4.25)
where _s~w~_(_n_) is the weighted speech, _k_ is the optimal open-loop lag,
and _N~p~_ is the pitch analysis frame length. This expression is calculated
in the speech encoder on the previous frame.
### 4.3.10 Background Noise Estimate Update
If (and only if) the update flag is set (_update_flag_ == TRUE), then update
the channel noise estimate for the next subframe by:
{width="4.430555555555555in" height="0.25in"} (4.26)
where _E_ min is the minimum allowable channel energy, and _Î±n_ is the channel
noise smoothing factor. The channel noise estimate shall be initialized for
each of the first four frames to the estimated channel energy, i.e.:
{width="3.44375in" height="0.25in"}, (4.27)
where _Einit_ is the minimum allowable channel noise initialization energy.
# 5 Computational details
A low level description has been prepared in form of ANSI C source code [1].
#
# Foreword
The present document describes the detailed mapping of the general audio
service employing the aacPlus general audio codec within the 3GPP system.
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of this TS, it will be re-released by the TSG with an identifying
change of release date and an increase in version number as follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 Indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the specification;
# 1 Scope
This Telecommunication Standard (TS) describes the AAC encoder part of the
Enhanced aacPlus general audio codec [1].
# 2 Normative references
This TS incorporates by dated and undated reference, provisions from other
publications. These normative references are cited in the appropriate places
in the text and the publications are listed hereafter. For dated references,
subsequent amendments to or revisions of any of these publications apply to
this TS only when incorporated in it by amendment or revision. For undated
references, the latest edition of the publication referred to applies.
[1] 3GPP TS 26.401: \"Enhanced aacPlus general audio codec; General
Description\".
[2] ISO/IEC 14496-3:2001: \"Information technology - Coding of audio-visual
objects - Part 3: Audio\".
[3] ISO/IEC 14496-3:2001/Amd.1:2003: \"Bandwidth Extension\".
[4] ISO/IEC 14496-3:2001/Amd.1:2003/DCOR1.
[5] ISO/IEC 14496-3:2001/ Amd.2:2004: \"Parametric Coding for High Quality
Audio\".
# 3 Definitions, symbols and abbreviations
## 3.1 Definitions
For the purposes of this TS, the following definitions apply:
**frame: time segment associated with one AAC single channel or channel pair
element**
**frequency coefficient: output value of the MDCT transform**
**scalefactor band: a group of consecutive frequency coefficients, that will
be coded with the same quantizer step size**
## 3.2 Symbols
For the purposes of this TS, the following symbols apply:
{width="0.1388888888888889in" height="0.19375in"} is the current index for the
spectral coefficients
{width="0.7361111111111112in" height="0.2222222222222222in"} is the index of
the first spectral coefficient in scalefactorband
{width="0.1388888888888889in" height="0.1527777777777778in"}
{width="0.1388888888888889in" height="0.1527777777777778in"} is the current
scalefactor band
## 3.3 Abbreviations
For the purposes of this TS, the following abbreviations apply.
AAC Advanced Audio Coding
aacPlus Combination of MPEG-4 AAC and MPEG-4 Bandwidth extension (SBR)
Enhanced aacPlus Combination of MPEG-4 AAC, MPEG-4 Bandwidth extension (SBR)
and MPEG-4 Parametric Stereo
KBD Kaiser-Bessel derived
PE perceptual entropy
SBR Spectral Band Replication
TNS Temporal Noise Shaping
# 4 Outline description
This TS is structured as follows:
Section 5.1 gives an encoder overview description. Section 5.2 gives a
detailed description of the stereo preprocessing. Section 5.3 gives a detailed
description of the filterbank used in the encoder. Section 5.4 gives a
detailed description of the psychoacoustic model. Section 5.5 gives a detailed
description of the temporal noise shaping and mid/side stereo tools. Section
5.6 gives a detailed description of the quantization and coding procedure used
in the encoder.
# 5 AAC Encoder
## 5.1 Overview
The AAC encoder acts as the core encoding algorithm of the aacPlus system
encoding at half the sampling rate of aacPlus. Since aacPlus implements the
High Efficiency AAC Profile at Level 2 as defined in [3], the AAC LC object
type is used. The AAC LC object type does not implement the Long Term
Predictor (LTP) tool. The Level 2 implies a restriction to a maximum of two
channels. Furthermore in case of SBR being used, the maximum AAC sampling rate
is restricted to 24 kHz whereas if SBR is not used the maximum AAC sampling
rate is restricted to 48 kHz.
The basic layout is depicted below.
{width="5.149305555555555in" height="6.821527777777778in"}
Figure 1: AAC Encoder Block Diagram
## 5.2 Stereo Preprocessing
With stereo preprocessing, the stereo width of difficult to encode signals at
low bitrates is reduced. Stereo preprocessing is active for bitrates less than
60kbit/s.
The side channel is attenuated with influence of the following parameters:
\- The total perceptual entropy {width="0.2638888888888889in"
height="0.2222222222222222in"}before the increase of the thresholds. This PE
is smoothed over past frames and normalized. For a definition of the
perceptual entropy see 5.6.1.1.3. .
\- The energy ratio between side and mid channel smoothed over past frames. If
the side channel is very strong, less attenuation of the side channel should
happen.
\- The energy ratio between the left and right channel. Less attenuation of
the side channel occurs for signals that appear to be nearly on the left or
the right.
\- The smaller the bitrate, the more attenuation of the side channel takes
place.
Depending on these parameters an attenuation factor
{width="0.8465277777777778in" height="0.18055555555555555in"}is calculated for
every frame. Always 1024 samples of one frame for the left and right channel
are then modified as follows:
{width="2.861111111111111in" height="0.8194444444444444in"}
with {width="0.1388888888888889in" height="0.16666666666666666in"},
{width="0.1527777777777778in" height="0.16666666666666666in"} as left resp.
right samples before and {width="0.18055555555555555in"
height="0.16666666666666666in"}, {width="0.19375in"
height="0.16666666666666666in"} as modified left and right samples after
stereo preprocessing.
## 5.3 Filterbank
The filterbank is an MDCT as described in [2]. The window length
{width="0.18055555555555555in" height="0.18055555555555555in"}of the MDCT is
either 2048 for the ONLY_LONG_SEQUENCE, LONG_START_SEQUENCE and
LONG_STOP_SEQUENCE window sequence or 256 for the EIGHT_SHORT_SEQUENCE window
sequence. The spectral coefficients are defined as follows:
{width="2.9583333333333335in" height="0.4722222222222222in"} , for
{width="0.7916666666666666in" height="0.18055555555555555in"}
with {width="0.16666666666666666in" height="0.2222222222222222in"} as windowed
input sequence, n as samples index and k as spectral coefficient index.
For long windows the window shape is always 1, that is a Kaiser-Bessel derived
(KBD) window will be used. As window shape for the short windows always the
sine window will be applied. For the definition of KBD and sine window see
[2].
## 5.4 Psychoacoustic Model
The psychoacoustic model is simplified compared to the model presented in [2].
Note that the model works in combination with the quantization and coding
strategy described in 5.6 below. The following sections describe the steps of
the threshold calculation.
### 5.4.1 Blockswitching
The decision wether to use long windows with a window length of 2048 samples
or a sequence of eight short blocks with a window length of 256 samples will
be taken in the time domain. It is not possible to switch immediately between
an ONLY_LONG_SEQUENCE and an EIGHT_SHORT_SEQUENCE. Thus when switching from
the long window transform to frames with eight short windows a
LONG_START_SEQUENCE has to be inserted, resp. when switching back from short
to long a STOP_WINDOW_SEQUENCE is neeeded. Therefore there needs to be a
lookahead of 1024+576 samples for the blockswitch decision (see figure below).
{width="5.149305555555555in" height="2.9895833333333335in"}
Figure 2: Blockswitch detection lookahead
A high pass IIR-Filter with the transfer function
{width="1.4027777777777777in" height="0.4027777777777778in"}
is applied to the samples. After filtering, eight subblock energies are
calculated by summing up 128 consecutive squared samples. These eight subblock
energies represent the eight short windows of the next frame.
An attack is detected if one of these subblock energies exceeds a sliding
average of the previous energies by a constant factor
{width="0.7638888888888888in" height="0.18055555555555555in"} and is greater
than a constant energy level {width="1.4305555555555556in"
height="0.2361111111111111in"}. The value for {width="0.7638888888888888in"
height="0.18055555555555555in"} depends on the bitrate and the number of
channels:
for mono: {width="2.263888888888889in" height="0.4722222222222222in"}
for stereo: {width="2.25in" height="0.4722222222222222in"}
The window sequence of the next frame is now either set to ONLY_LONG_SEQUENCE
or EIGHT_SHORT_SEQUENCE. Now the final window sequence of the actual frame can
be determined by obeying the following the rules:
1) after a long window there can be a long or a start window
2) after a start window there will always be a short window sequence
3) after a short window sequence follows another short window sequence or a
stop window
4) after a stop window there can be a long window or a start window
If the current window sequence is and EIGHT_SHORT_SEQUENCE, the eight windows
will be grouped to reduce the sideinfo for transmitting scalefactors etc. If
no attack has been detected in the actual short window sequence, there will be
3 groups with the first 3 subwindows in the first group, the next 3 in the
second group and the last 2 subwindows will be in the third group. For short
window sequences with attack there will always be 4 groups. The number of
subwindows in each group depends on the position of the attack subwindow:
Table 1: Grouping of subwindows in an EIGHT_SHORT_SEQUENCE
* * *
position of attack nr of subwindows group 1 nr of subwindows group 2 nr of
subwindows group 3 nr of subwindows group 4 0 1 3 3 1 1 1 1 3 3 2 2 1 3 2 3 3
1 3 1 4 3 1 1 3 5 3 2 1 2 6 3 3 1 1 7 3 3 1 1
* * *
In case of stereo encoding, the blocktype for both channels must be the same
to be able to apply the M/S stereo tool. The final common blocktype is chosen
as shown in the following table:
Table 2: window sequence synchronization for stereo
* * *
blocktype channel 0 blocktype channel 1 final blocktype for both channels Long
long long Long start start Long short short Long stop stop Start long start
Start start start Start short short Start stop short Short long short Short
start short Short short short Short stop short Stop long stop Stop start short
Stop short short Stop stop stop
* * *
If the final window sequence is EIGHT_SHORT_SEQUENCE the grouping is chosen
from the channel containing the higher maximum subblock energy.
### 5.4.2 Threshold Calculation
The following are the necessary steps for the calculation of the
psychoacoustic threshold {width="0.4166666666666667in"
height="0.20833333333333334in"}, which is an upper limit for the quantization
noise of the coder.
#### 5.4.2.1 Calculation of the energy spectrum
The energy spectrum in the coder scalefactor band domain
{width="0.3888888888888889in" height="0.20833333333333334in"} is calculated by
using the output values {width="0.375in" height="0.20833333333333334in"} of
the MDCT-transform that are later quantized and coded. This is done by the
following equation:
{width="1.8333333333333333in" height="0.4583333333333333in"}
Here {width="0.6805555555555556in" height="0.20833333333333334in"} is the
first spectral line of scalefactor band {width="0.125in"
height="0.1388888888888889in"}.
In this psychoacoustic model no threshold partition is used. The threshold
calculation is performed directly in the scalefactor band domain.
#### 5.4.2.2 From energy to threshold
No difference is made between tonal and noisy components in the signal.
Therefore the \"worst case\" is assumed, i.e. the signal is tonal for the
complete frequency range. Thresholds must be achieved that result in a
\"transparent\" audio quality.
The decrease of the energy is done by a constant required signal to noise
ratio {width="0.3333333333333333in" height="0.18055555555555555in"} which is
29dB for AAC . The scaled thresholds {width="0.6527777777777778in"
height="0.2222222222222222in"} are:
{width="1.1527777777777777in" height="0.4027777777777778in"}
#### 5.4.2.3 Spreading
Instead of a convolution of the spectral energy with a spreading function, a
simpler spreading is calculated. Here the slope to higher frequencies is
created by weighting the previous threshold value with a frequency dependent
factor {width="0.3611111111111111in" height="0.2222222222222222in"} and by
building the maximum of the threshold value of the actual band with this
weighted threshold of the previous band.
{width="2.9583333333333335in" height="0.25in"}
Accordingly the steeper slope towards the low frequencies is computed by
another pass beginning at the highest band and weighting the energy values by
a factor {width="0.34652777777777777in" height="0.2222222222222222in"}.
{width="2.763888888888889in" height="0.25in"}
The values for {width="0.3611111111111111in" height="0.2222222222222222in"}
resp. {width="0.34652777777777777in" height="0.2222222222222222in"} are
calculated by the distance of the adjacent bands in Bark and a constant slope
that is 15dB/Bark for the first and 30dB/Bark for the second equation.
#### 5.4.2.4 Threshold in quiet
The comparison with the threshold in quiet {width="0.5965277777777778in"
height="0.25in"} is a simple maximum operation.
{width="2.0694444444444446in" height="0.25in"}
The threshold in quiet is given as array for the Bark scale. Because of the
difference of the scalefactor band scale compared to the Bark scale, the
minimum of the threshold in quiet for the Bark values at the lower and the
upper end of the scalefactor band is used.
#### 5.4.2.5 Pre-echo control
The pre-echo control operates as in the psychoacoustic model of [2]. To avoid
pre-echos the actual threshold {width="0.4583333333333333in" height="0.25in"}
is compared to the previous threshold {width="0.5833333333333334in"
height="0.25in"}:
{width="3.6527777777777777in" height="0.25in"}
with the parameters {width="0.6666666666666666in"
height="0.20833333333333334in"} and {width="0.8194444444444444in"
height="0.20833333333333334in"}.
No pre-echo control can be calculated in case of blockswitching, because the
psychoacoustic model doesn\'t calculate the thresholds for both long and short
blocks simultaneous and the pre-echo control needs the thresholds of the
previous block with the same scalefactor band partition as the actual block.
Thus the pre-echo control is inactive for the first short window (but not all
short windows in a short frame) after a start block and for all frames with a
stop window sequence.
### 5.4.3 Spreaded Energy Calculation
After an eventual filtering of the mdct spectrum with the TNS analysis filter
(see 5.5.1 ), the energy calculation of section 5.4.2.1 has to be performed
again. Spreading this energy {width="0.3888888888888889in"
height="0.20833333333333334in"} the same way as the thresholds (see 5.4.2.3)
yields the spreaded energy {width="0.375in" height="0.20833333333333334in"} in
the scalefactor band domain. The values for {width="0.3611111111111111in"
height="0.2222222222222222in"} resp. {width="0.34652777777777777in"
height="0.2222222222222222in"} are dependent on the blocktype and are derived
from constant slopes in the bark domain.
For long block {width="1.8055555555555556in" height="0.2222222222222222in"}
and {width="3.94375in" height="0.4722222222222222in"}
and for short blocks {width="1.8194444444444444in"
height="0.2222222222222222in"} and {width="1.8055555555555556in"
height="0.2222222222222222in"}, with
{width="0.5965277777777778in" height="0.20833333333333334in"} as the width in
bark of the scalefactor band {width="0.125in" height="0.1388888888888889in"}
Both the scalefactor band energy {width="0.3888888888888889in"
height="0.20833333333333334in"}after TNS and the spreaded energy
{width="0.375in" height="0.20833333333333334in"} are important input values
for the determination of which bands must not be quantized to zero (see
section 5.6.1.1.2. for more details on the avoidance of spectral holes).
### 5.4.4 Grouping
If the window sequence of the current frame is an EIGHT_SHORT_SEQUENCE, a
grouping configuration has been determined by the blockswitching algorithm
described above. The psychoacoustic model calculates thresholds, energies and
other variables in the subwindow domain. The scalefactor band based thresholds
and energies are grouped by adding up the values of all subwindows belonging
to one group. The spectrum has to be reordered to match the new combined
scalefactor bands.
## 5.5 Tools
### 5.5.1 Temporal Noise Shaping (TNS)
For a general description of TNS see [2]. If TNS is active in this encoder,
only one filter per MDCT-spectrum will be applied. The steps in TNS encoding
are described below. TNS is always calculated on a per subwindow basis, so in
case of an EIGHT_SHORT_SEQUENCE window sequence these steps have to be applied
once for each of the eight subwindows.
#### 5.5.1.1 TNS detection
Out of the spectral coefficients {width="0.375in"
height="0.20833333333333334in"} a weighted spectrum
{width="1.4722222222222223in" height="0.2222222222222222in"} is calculated.
The weighting factors are determined from the energy of the appropriate
scalefactor band {width="1.1527777777777777in" height="0.4583333333333333in"}.
For a definition of the scale factor band energy {width="0.3888888888888889in"
height="0.20833333333333334in"} see section 5.4.2.1. The factors are smoothed
by filtering down:
for (k=lpcStopLine-2; k>=lpcStartLine; k--) {
wfac[k] = (wfac[k] + wfac[k+1]) / 2;
}
and up:
for (k=lpcStartLine+1; k\1). See the next figure on how to calculate this factor.
{width="6.083333333333333in" height="3.3048611111111112in"}
Figure 5: Calclation of bitFac
The variables {width="0.4583333333333333in" height="0.20833333333333334in"}
and {width="0.4861111111111111in" height="0.20833333333333334in"} are adjusted
after each calculation of {width="0.44375in" height="0.18055555555555555in"}.
The desired number of bits for the actual frame is:
{width="4.611111111111111in" height="0.20833333333333334in"}
where {width="0.9166666666666666in" height="0.20833333333333334in"} is the
average number of bits per frame matching the given constant bitrate
and {width="1.0138888888888888in" height="0.18055555555555555in"} is the
actual number of bits in the bitreservoir.
#### 5.6.1.3 Calculation of the reduction value
The actual problem of the reduction strategy is to find the loudness value
{width="0.125in" height="0.125in"} of the equation defined in section
5.6.1.1.2. so that the requirements of the granted bits resp. the appropriate
PE {width="0.25in" height="0.2222222222222222in"} are fulfilled. In the
following an iterative process to find the reduction value {width="0.125in"
height="0.125in"} and the thresholds used for the quantization is described.
##### 5.6.1.3.1 Preparatory steps of the perceptual entropy calculation
The calculation of the scalefactor band PEs {width="0.5833333333333334in"
height="0.20833333333333334in"} can be split up in a constant part
{width="0.3194444444444444in" height="0.20833333333333334in"} and a variable,
threshold dependent part {width="1.125in" height="0.2222222222222222in"}.
{width="2.2222222222222223in" height="0.2222222222222222in"}
with {width="2.986111111111111in" height="0.4861111111111111in"}
and {width="2.0416666666666665in" height="0.4861111111111111in"}
It is possible to calculate the constant part once at the start of the
iteration.
##### 5.6.1.3.2 Calculation of the desired perceptual entropy
The goal to spend the number of bits calculated with the method described
above in 5.6.1.2 is approximately achieved by increasing the tresholds in such
a way that the resulting perceptual entropy equals the desired PE
{width="0.25in" height="0.2222222222222222in"}. The desired PE is determined
by the relation between bit demand and perceptual enropy (5.6.1.1.3. ).
{width="1.44375in" height="0.2222222222222222in"}
The actual number of used bits will only approximately match the desired bits.
Small differences will be balanced out with the help of the bitreservoir.
Systematic differences are compensated by applying a correction factor to the
desired perceptual entropy. This factor is obtained by taking into account the
real relation between number of used bits and perceptual entropy of the
previous frames. The allowed range of the correction factor is between 0.85
and 1.15.
##### 5.6.1.3.3 Selection of the bands for avoidance of holes
First all bands are marked to participate in an eventually occurring avoidance
of spectral holes. Then by means of different criteria individual bands are
excluded.
\- For long blocks no avoidance of holes in band {width="0.125in"
height="0.1388888888888889in"}, if the spreaded energy
{width="0.6388888888888888in" height="0.20833333333333334in"} exceeds the
energy {width="0.3888888888888889in" height="0.20833333333333334in"}
\- For short blocks no avoidance of holes in band {width="0.125in"
height="0.1388888888888889in"}, if the spreaded energy
{width="0.7083333333333334in" height="0.20833333333333334in"} exceeds the
energy {width="0.3888888888888889in" height="0.20833333333333334in"}
\- The minimum requirement {width="0.75in" height="0.20833333333333334in"} has
to be greater than 0dB
For a definition of the scalefactor band energy {width="0.3888888888888889in"
height="0.20833333333333334in"} and the spreaded energy {width="0.375in"
height="0.20833333333333334in"}, see section 5.4.2.1 resp. section 5.4.3 .
##### 5.6.1.3.4 First Estimation of the reduction value
In the following an approximation for the total PE is used. It is derived from
the equation of the scalefactor band PE:
{width="3.0965277777777778in" height="0.2361111111111111in"}
with {width="0.7916666666666666in" height="0.2638888888888889in"} as the sum
of the constant parts of {width="0.5833333333333334in"
height="0.20833333333333334in"} and {width="0.7777777777777778in"
height="0.2638888888888889in"} as the total number of estimated lines that
will be unequal zero after quantization. The estimated average total threshold
is {width="9.652777777777778e-2in" height="0.16666666666666666in"}.
In the first iteration the loudness {width="0.2638888888888889in"
height="0.20833333333333334in"} of this average threshold is calculated with
help of the PE {width="0.2638888888888889in" height="0.2222222222222222in"}
without reduction ({width="0.34652777777777777in"
height="0.18055555555555555in"}):
{width="0.69375in" height="0.25in"}
The estimation of the reduction value {width="0.125in"
height="0.2222222222222222in"} follows from the desired PE {width="0.25in"
height="0.2222222222222222in"}:
{width="0.9305555555555556in" height="0.2777777777777778in"}
With this {width="0.125in" height="0.2222222222222222in"} the new thresholds
{width="0.44375in" height="0.2222222222222222in"} can be calculated using the
equation from section 5.6.1.1.2. and also the resulting PE
{width="0.2361111111111111in" height="0.2222222222222222in"}.
##### 5.6.1.3.5 Second Estimation of the reduction value
Usually the value of {width="0.2361111111111111in"
height="0.2222222222222222in"} will be greater than the desired PE
{width="0.25in" height="0.2222222222222222in"}. In scalefactor bands that
avoid holes after the first iteration the thresholds can not be reduced
further. By repeating the two equations above a second guess
{width="0.1388888888888889in" height="0.2222222222222222in"} for the reduction
value can be found, if only the bands that actually do not avoid holes are
considered. Therefore the contributions of bands with active avoidance of
holes have to be subtracted from {width="0.1388888888888889in"
height="0.1388888888888889in"}, {width="0.125in"
height="0.18055555555555555in"}, {width="0.25in"
height="0.2222222222222222in"}and {width="0.2361111111111111in"
height="0.2222222222222222in"}. The modified values are then called
{width="0.2638888888888889in" height="0.2222222222222222in"}, {width="0.25in"
height="0.2222222222222222in"}, {width="0.4166666666666667in"
height="0.2361111111111111in"}and {width="0.4027777777777778in"
height="0.2361111111111111in"}. The loudness {width="0.2638888888888889in"
height="0.2361111111111111in"} of a new average threshold is calculated by:
{width="0.9027777777777778in" height="0.3055555555555556in"}
The second estimation of the reduction value {width="0.1388888888888889in"
height="0.2222222222222222in"} is:
{width="1.3888888888888888in" height="0.3055555555555556in"}
Using {width="0.1388888888888889in" height="0.2222222222222222in"}, new
thresholds {width="0.4583333333333333in" height="0.2222222222222222in"} and PE
{width="0.2638888888888889in" height="0.2222222222222222in"} can be
calculated.
The calculation of {width="0.1388888888888889in"
height="0.2222222222222222in"} may be repeated once more if the absolute
difference between desired and actual PE is greater than 5%.
##### 5.6.1.3.6 Final threshold modification by linearization
If the PE resulting from the second iteration {width="0.2638888888888889in"
height="0.2222222222222222in"} is already close to the desired value
{width="0.25in" height="0.2222222222222222in"} (that means the difference to
the desired PE is less than 15%), the desired PE can be reached by a
linearization of the logarithms.
The formula for the PE after the second guess is:
{width="4.319444444444445in" height="0.34652777777777777in"}
Accordingly the desired PE {width="0.25in" height="0.2222222222222222in"} can
be written as:
{width="2.763888888888889in" height="0.34652777777777777in"}
with {width="0.20833333333333334in" height="0.16666666666666666in"} as the
difference between the reduction value {width="0.125in" height="0.125in"} and
the latest guess {width="0.1388888888888889in" height="0.2222222222222222in"}.
The difference of the two perceptual entropies is:
{width="3.013888888888889in" height="0.44375in"}
A linearization of the logarithm around the zero results to the following:
{width="1.8055555555555556in" height="0.44375in"}
Now the difference of the total PE can be divided among the individual bands,
that actuallly do not avoid holes:
{width="2.4166666666666665in" height="0.44375in"}
with
{width="1.5555555555555556in" height="0.44375in"}
For each band a final modification of the threshold is performed:
{width="1.7638888888888888in" height="0.2361111111111111in"}
##### 5.6.1.3.7 Further perceptual entropy reduction
If the conditions for section 5.6.1.3.6. can not be reached, i.e. the actual
perceptual entropy {width="0.2638888888888889in"
height="0.2222222222222222in"} exceeds the desired {width="0.25in"
height="0.2222222222222222in"} by more than 15%, then it seems that the
constraints given by the minum requirements {width="0.75in"
height="0.20833333333333334in"} or the number of bands with active avoidance
of holes are too strong for the desired PE.
In a first step the values of {width="0.75in" height="0.20833333333333334in"}
are limited to a maximum value of 1dB starting from the scalefactor band with
the highest frequency. By doing so, thresholds can be increased and the
perceptual entropy will decrease.
If the actual perceptual entropy is still too large after having changed
{width="0.75in" height="0.20833333333333334in"} for the whole spectrum, more
spectral holes have to be allowed. In case of M/S stereo always the
scalefactor band of the channel with less energy is now quantized to zero.
Afterwards for mono and stereo subsequently bands with low engergies get
erased. Therefore the bands are partitioned into four categories with
different energy levels. Starting from the highest band all bands falling in
the category with the lowest category get erased. This process is eventually
repeated with the next energy categories, until the resulting perceptual
entropy is as small as the desired value of {width="0.25in"
height="0.2222222222222222in"}.
##### 5.6.1.3.8 Possible failures
In general the difference of the resulting perceptual entropy to the desired
{width="0.25in" height="0.2222222222222222in"}is negligible. The described
algorithm works fine for reasonable combinations of bitrate, samplerate and
bandwidth. Normally inaccuracies especially in the relation between the
perceptual entropy and the really used bits, can be balanced out by the
bitreservoir. But there is no guarantee that there are always enough bits
available to fulfill the requirements of the increased threshold. For measures
that are available to avoid an abort of the encoder in such cases, see section
5.6.4 .
### 5.6.2 Scalefactor determination
The scalefactors determine the quanization step size for each scalefactor
band. By changing the scalefactor, the quantization noise will be controlled.
The equation for the quantization of the spectral coefficients is:
{width="4.666666666666667in" height="0.44375in"}
{width="1.3055555555555556in" height="0.20833333333333334in"} is defined to
0.4054 and {width="0.375in" height="0.20833333333333334in"} is one of the
spectral coefficients that is calculated from the MDCT filterbank. In the
following three steps of combined scalefactor determination and quantization,
always {width="2.111111111111111in" height="0.20833333333333334in"} is
calculated. Only at the end, scalefactors {width="0.44375in"
height="0.20833333333333334in"} and the {width="0.7638888888888888in"
height="0.20833333333333334in"} values are derived from the values for
{width="0.7222222222222222in" height="0.20833333333333334in"}.
The formula for the inverse quantization is:
{width="3.4166666666666665in" height="0.3333333333333333in"}
It is needed for calculating the quantization noise.
#### 5.6.2.1 Scalefactor Estimation
A first guess of {width="0.7222222222222222in" height="0.20833333333333334in"}
that results in quantization noise approximately equal to the threshold
{width="0.4583333333333333in" height="0.2222222222222222in"} is given by the
following equation:
{width="3.6666666666666665in" height="0.3055555555555556in"}
with the form factor {width="1.7083333333333333in"
height="0.4583333333333333in"} that is also needed by the calculation of the
perceptual entropy (see 5.6.1.1.3. ).
#### 5.6.2.2 Scalefactor Improvement by Quantization
The following steps of scalefactor changes include always a quantization and
inverse quantization procedure to be able to calculate and compare the
quantization error. The equation for the distortion is:
{width="2.69375in" height="0.4583333333333333in"}
After quantizing with the scalefactor value calculated in 5.6.2.1, the
resulting distortion {width="0.6805555555555556in"
height="0.20833333333333334in"} may be greater than the threshold
{width="0.4583333333333333in" height="0.2222222222222222in"}. By trying
increased and decreased values for {width="0.7222222222222222in"
height="0.20833333333333334in"} a lower distortion is searched for. If the
distortion was already below the threshold, a search will only be done for
smaller values of {width="0.7222222222222222in"
height="0.20833333333333334in"} to try to further improve the distortion.
#### 5.6.2.3 Scalefactor Difference Reduction
Above each scale factor band is treated individually. The next algorithms take
into acount that finally the difference of the scalefactors will be encoded. A
smaller difference between two adjacent scale factors costs less bits.
In a first step it is searched for single scalefactor bands, where the number
of bits gained by using a smaller {width="0.7222222222222222in"
height="0.20833333333333334in"} is greater than the estimated increased bit
demand for the noiseless coding of the quantized spectral coefficients. The
estimation of needed bits for the noiseless coding is based on the equation
for the perceptual entropy:
{width="3.736111111111111in" height="0.7361111111111112in"}
with {width="0.7638888888888888in" height="0.2222222222222222in"},
{width="0.9027777777777778in" height="0.2222222222222222in"}, {width="0.875in"
height="0.18055555555555555in"}. With {width="0.18055555555555555in"
height="0.18055555555555555in"} the estimated number of lines that won\'t be
zero after the quantization is meant. This number has already been calculated
during the adaptation of the thresholds to the bitrate, for a definition of
{width="0.18055555555555555in" height="0.18055555555555555in"} see 5.6.1.1.3.
If such a band is found and in addition the quantization error is smaller, the
new value for {width="0.7222222222222222in" height="0.20833333333333334in"} is
accepted.
In a second assimilation step the same procedure as above is repeated but now
trying to increase the {width="0.7222222222222222in"
height="0.20833333333333334in"} values for a complete region of scale factor
bands instead of improving only single bands.
#### 5.6.2.4 Final scalefactor determination
The conversion from {width="0.7222222222222222in"
height="0.20833333333333334in"} to scalefactor values {width="0.44375in"
height="0.20833333333333334in"} and a value for {width="0.7638888888888888in"
height="0.20833333333333334in"} is done after limitation of the maximum
scalefactor difference to a value of 60. This is achieved by limiting all
values of {width="0.7222222222222222in" height="0.20833333333333334in"} to a
maximum allowed value of {width="1.0694444444444444in"
height="0.20833333333333334in"} with {width="0.7777777777777778in"
height="0.20833333333333334in"} as the minium over all bands.
The value for {width="0.7638888888888888in" height="0.20833333333333334in"} is
now chosen as the maximum of all {width="0.7222222222222222in"
height="0.20833333333333334in"} values and the scalefactors result in:
{width="2.111111111111111in" height="0.20833333333333334in"}
### 5.6.3 Noiseless coding
Coding of the quantized spectral coefficients is done by the noiseless coding.
The encoder uses a so called greedy merge algorithm to segment the 1024
coefficients of a frame into section and to find the best huffman codebook for
each section. For the sectioning and the huffman codebooks see [2].
### 5.6.4 Out of Bits Prevention
Only after the MDCT values are quantized according to the increased thresholds
{width="0.4583333333333333in" height="0.2222222222222222in"} and after the
following noiseless coding, the number of really needed bits is counted. If
this number is too high, the number of bits have to be reduced. This is
achieved by increasing the global gain value and a new quantization of the
whole spectrum plus additional noiseless coding in a loop until the bit demand
is small enough to match the constraints of the bitreservoir.
#
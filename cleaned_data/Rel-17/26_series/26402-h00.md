# Foreword {#foreword .list-paragraph}
The present document describes tools used in the Enhanced aacPlus general
audio codec for the general audio service within the 3GPP system.
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of this TS, it will be re-released by the TSG with an identifying
change of release date and an increase in version number as follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 Indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the specification;
# 1 Scope {#scope .list-paragraph}
This Telecommunication Standard (TS) describes the error concealment
algorithm, SBR parameter downmix and output resampling for the Enhanced
aacPlus general audio codec [3].
# 2 Normative references {#normative-references .list-paragraph}
This TS incorporates by dated and undated reference, provisions from other
publications. These normative references are cited in the appropriate places
in the text and the publications are listed hereafter. For dated references,
subsequent amendments to or revisions of any of these publications apply to
this TS only when incorporated in it by amendment or revision. For undated
references, the latest edition of the publication referred to applies.
[1] ISO/IEC 14496-3:2001/Amd.1:2003: \"Bandwidth Extension\".
[2] ISO/IEC 14496-3:2001/Amd.1:2003/DCOR1.
[3] 3GPP TS 26.401: \"Enhanced aacPlus general audio codec; General
Description\".
# 3 Definitions, symbols and abbreviations {#definitions-symbols-and-
abbreviations .list-paragraph}
## 3.1 Definitions {#definitions .list-paragraph}
For the purposes of this TS, the following definitions apply:
**band: (as in limiter band, noise floor band, etc.) a group of consecutive
QMF subbands**
**envelope scalefactor: an element representing the averaged energy of a
signal over a region described by a frequency band and a time segment**
**frequency band: interval in frequency, group of consecutive QMF subbands**
**frequency border: frequency band delimiter, expressed as a specific QMF
subband**
**noise floor: a vector of noise floor scalefactors**
**noise floor scalefactor: an element associated with a region described by a
frequency band and a time segment, representing the ratio between the energy
of the noise to be added to the envelope adjusted HF generated signal and the
energy of the same**
**SBR envelope: a vector of envelope scalefactors**
**SBR frame: time segment associated with one SBR extension data element**
**SBR range: the frequency range of the signal generated by the SBR
algorithm**
**subband: a frequency range represented by one row in a QMF matrix, carrying
a subsampled signal**
**time border: time segment delimiter, expressed as a specific time slot**
**time segment: interval in time, group of consecutive time slots**
**time / frequency grid: a description of SBR envelope time segments and
associated frequency resolution tables as well as description of noise floor
time segments**
**time slot: finest resolution in time for SBR envelopes and noise floors. One
time slot equals two subsamples in the QMF domain**
## 3.2 Symbols {#symbols .list-paragraph}
For the purposes of this TS, the following symbols apply:
**E** _~Orig~_ has _L~E~_ columns where each column is of length _N~Low~_ or
_N~High~_ depending on the frequency resolution for each SBR envelope. The
elements in **E** _~Orig~_ contains the envelope scalefactors of the original
signal.
{width="0.3333333333333333in" height="0.2222222222222222in"} the output
sampling rate from the SBR Tool.
{width="0.375in" height="0.2222222222222222in"} internal sampling frequency of
the SBR Tool, twice the sampling frequency of the core coder (after sampling
frequency mapping, ISO/IEC 14496-3:2001, Table 4.55). The sampling frequency
of the SBR enhanced output signal is equal to the internal sampling frequency
of the SBR Tool, unless the SBR Tool is operated in downsampled mode. If the
SBR Tool is operated in downsampled mode, the output sampling frequency
{width="0.3333333333333333in" height="0.2222222222222222in"}is equal to the
sampling frequency of the core coder.
{width="1.3465277777777778in" height="0.2916666666666667in"} has two column
vectors containing the frequency border tables for low and high frequency
resolution.
**f** _~TableHigh~_ is of length _N~High~_ +1 and contains frequency borders
for high frequency resolution SBR envelopes.
**f** _~TableLow~_ is of length _N~Low~_ +1 and contains frequency borders for
low frequency resolution SBR envelopes.
_L~E~_ number of SBR envelopes.
_L~Q~_ number of noise floors.
_N~Q~_ number of noise floor bands.
{width="1.0277777777777777in" height="0.25in"} number of frequency bands for
low and high frequency resolution.
_numTimeSlots_ number of SBR envelope time slots that exist within an AAC
frame, 16 for a 1024 AAC frame and 15 for a 960 AAC frame.
{width="1.2916666666666667in" height="0.25in"} offset-values for the SBR
envelope and noise floor data, when using coupled channels.
**Q** _~Orig~_ has _L~Q~_ columns where each column is of length _N~Q~_ and
contains the noise floor scalefactors.
{width="0.8888888888888888in" height="0.2222222222222222in"} frequency
resolution for all SBR envelopes in the current SBR frame, zero for low
resolution, one for high resolution.
**t** _~E~_ is of length _L~E~_ +1 and contains start and stop time borders
for all SBR envelopes in the current SBR frame.
**t** _~Q~_ is of length _L~Q~_ +1 and contains start and stop time borders
for all noise floors in the current SBR frame.
**Y** is the complex output QMF bank subband matrix from the HF adjuster.
## 3.3 Abbreviations {#abbreviations .list-paragraph}
For the purposes of this TS, the following abbreviations apply.
AAC Advanced Audio Coding
aacPlus Combination of MPEG-4 AAC and MPEG-4 Bandwidth extension (SBR)
Enhanced aacPlus Combination of MPEG-4 AAC, MPEG-4 Bandwidth extension (SBR)
and MPEG-4 Parametric Stereo
MPEG Moving Picture Experts Group
SBR Spectral Band Replication
# 4 Outline description {#outline-description .list-paragraph}
This TS is structured as follows:
Section 5 gives a detailed description of the error concealment algorithms in
the Enhanced aacPlus decoder. In Section 5.1 the error concealment of the AAC
is described, and in section 5.2 the error concealment of the SBR algorithm is
outlined.
Section 6 gives a detailed description of how stereo SBR parameters are down
mixed to mono SBR parameters.
Section 7 gives a detailed description of the additional downsampler tool,
enabling the Enhanced aacPlus codec to give output sampling rates of 8 and
16kHz, disregarded the sampling rate used for the coded signal.
# 5 Error concealment {#error-concealment .list-paragraph}
## 5.1 AAC error concealment {#aac-error-concealment .list-paragraph}
The AAC core decoder includes a concealment function that increases the delay
of the decoder by one frame.
There are various tests inside the core decoder, starting with simple CRC
tests and ending in a variety of plausibility checks. If such a check
indicates an invalid bitstream, then concealment is applied. Concealment is
also applied when the calling main program indicates a distorted or missing
data frame using the frameOK flag. This is used for error detection on the
transport layer.
Concealment works on the spectral data just before the final frequency to time
conversion. In case a single frame is corrupted, concealment interpolates
between the last good and the first good frame to create the spectral data for
the missing frame. Always the previous frame will be processed by the
frequency to time conversion, so here the missing frame to be replaced is the
previous frame, the last good frame is the frame before the previous one and
the first good frame is the actual frame. If multiple frames are corrupted,
concealment implements first a fade out based on slightly modified spectral
values from the last good frame. As soon as good frames are available,
concealment fades in the new spectral data.
**Interpolation of one corrupt frame:**
In the following the actual frame is frame number _n_ , the corrupt frame to
be interpolated is the frame _n-_ 1 and the last but one frame has the number
_n-_ 2.
The determination of window sequence and the window shape of the corrupt frame
follows from the table below:
Table 1: Interpolated window sequences and window shapes
* * *
window sequence _n-2_ window sequence _n_ window sequence _n_ -1 window shape
_n_ -1 ONLY_LONG_SEQUENCE or LONG_START_SEQUENCE or LONG_STOP_SEQUENCE
ONLY_LONG_SEQUENCE or LONG_START_SEQUENCE or LONG_STOP_SEQUENCE
ONLY_LONG_SEQUENCE 0 ONLY_LONG_SEQUENCE or LONG_START_SEQUENCE or
LONG_STOP_SEQUENCE EIGHT_SHORT_SEQUENCE LONG_START_SEQUENCE 1
EIGHT_SHORT_SEQUENCE EIGHT_SHORT_SEQUENCE EIGHT_SHORT_SEQUENCE 1 EIGHT_SHORT
SEQUENCE ONLY_LONG_SEQUENCE or LONG_START_SEQUENCE or LONG_STOP_SEQUENCE
LONG_STOP_SEQUENCE 0
* * *
The scalefactor band energies of frames _n_ -2 and _n_ are calculated. If the
window sequence in one of these frames is an EIGHT_SHORT_SEQUENCE and the
final window sequence for frame _n_ -1 is one of the long transform windows,
the scalefactor band energies are calculated for long block scalefactor bands
by mapping the frequency line index of short block spectral coefficients to a
long block representation. The new interpolated spectrum is built by reusing
the spectrum of the older frame _n_ -2 multiplying a factor to each spectral
coefficient. An exception is made in the case of a short window sequence in
frame _n_ -2 and a long window sequence in frame _n_ , here the spectrum of
the actual frame n is modified by the interpolation factor. This factor is
constant over the range of each scalefactor band and is derived from the
scalefactor band energy differences of frames _n_ -2 and _n_. Finally the sign
of the interpolated spectral coefficients will be flipped randomly.
**Fade out and in:**
A complete fading out takes 5 frames. The spectral coefficients from the last
good frame are copied and attenuated by a factor of:
{width="1.8611111111111112in" height="0.2361111111111111in"}
with {width="1.0833333333333333in" height="0.18055555555555555in"} as frame
counter since the last good frame.
After 5 frames of fading out the concealment switches to muting, that means
the complete spectrum will be set to 0.
The decoder fades in when receiving good frames again. The fade in process
takes 5 frames, too and the factor multiplied to the spectrum is:
where {width="0.9722222222222222in" height="0.18055555555555555in"} is the
frame counter since the first good frame after concealing multiple frames.
## 5.2 SBR error concealment {#sbr-error-concealment .list-paragraph}
The SBR error concealment algorithm is based on using previous envelope and
noise-floor values with an applied decay, as a substitute for the corrupt
data. In the flowchart of Figure 1 the basic operation of the SBR error
concealment algorithm is outlined. If the frame error flag is set, error
concealment bitstream data is generated to be used instead of the corrupt
bitstream data. The concealment data is generated according to the following.
The time frequency grids are set to:
{width="0.4166666666666667in" height="0.2222222222222222in"}
{width="2.0833333333333335in" height="0.25in"}
{width="1.3888888888888888in" height="0.25in"}
{width="1.4166666666666667in" height="0.25in"}
{width="0.9305555555555556in" height="0.20833333333333334in"}
{width="0.4166666666666667in" height="0.25in"}
{width="1.2083333333333333in" height="0.2777777777777778in"}
The delta coding direction for both the envelope data and noise-floor data are
set to be in the time-direction. The envelope data is calculated according to:
{width="4.333333333333333in" height="0.4861111111111111in"}
where
{width="2.111111111111111in" height="0.4722222222222222in"}
{width="3.736111111111111in" height="0.4861111111111111in"}
And where _bs_amp_res_ and _bs_coupling_ are set to the values of the previous
frame.
The noise floor data is calculated according to:
{width="1.8465277777777778in" height="0.5in"}
Furthermore, the inverse-filtering levels in _bs_invf_mode_ are set to the
values of the previous frame, and all elements in _bs_add_harmonic_ are set to
zero.
If the frame error is not set, the present time grid and envelope data may
need modification if the previous frame was corrupt. If the previous frame was
corrupt the time grid of the present frame is modified in order to make sure
that there is a continuous transition between the frames. The envelope data
for the first envelope is modified according to:
{width="5.125in" height="0.5138888888888888in"}
where
{width="3.3194444444444446in" height="0.25in"}.
After the delta coded data has been decoded, a plausibility check is performed
to make sure that the decoded data is within reasonable limits. The required
limits are:
For the envelope data the logarithmic values shall fulfil:
{width="1.75in" height="0.4722222222222222in"}
otherwise the frame will be considered corrupt.
The time grids are also verified according to the following rules (if any of
the below is true the frame is considered to be corrupt):
\- {width="0.4166666666666667in" height="0.2222222222222222in"}
\- {width="0.4305555555555556in" height="0.2222222222222222in"}
\- {width="0.44375in" height="0.25in"}
\- {width="0.625in" height="0.25in"}
\- {width="0.9861111111111112in" height="0.25in"}
\- {width="0.6111111111111112in" height="0.25in"}
\- {width="0.7777777777777778in" height="0.25in"}
\- {width="0.7777777777777778in" height="0.25in"}
\- {width="1.6666666666666667in" height="0.25in"}
\- {width="0.4722222222222222in" height="0.2222222222222222in"}
\- {width="1.1666666666666667in" height="0.25in"}
\- {width="0.9027777777777778in" height="0.2638888888888889in"}
\- {width="1.0833333333333333in" height="0.2916666666666667in"}
\- {width="1.6666666666666667in" height="0.2638888888888889in"}
\- all elements of **t** _~Q~_ are not among the elements of **t** _~E~_
If the plausibility check fails, the frame error flag is set and the error
concealment outlined above is applied.
{width="6.4875in" height="4.959027777777778in"}
Figure 1: SBR error concealment overview
# 6 SBR stereo parameter to mono parameter downmix {#sbr-stereo-parameter-to-
mono-parameter-downmix .list-paragraph}
This module enables a decoder only capable of mono output to downmix stereo
SBR parameters to mono parameters, hence mono decoding can be performed
instead of a stereo decoding.
For all the descriptions in this section left and right applies to the two
stereo channels that are being mapped to one channel from here on called
merged.
## 6.1 Inverse filtering {#inverse-filtering .list-paragraph}
The inverse filtering is mapped from **stereo to mono by taking the maximum
value from left or right as shown below:**
{width="5.638888888888889in" height="0.5833333333333334in"}
## 6.2 Additional harmonics {#additional-harmonics .list-paragraph}
The additional sinusoids in the merged mono bitstream are the union of the
additional sinusoids present in left or right channel as shown below.
{width="5.458333333333333in" height="0.5833333333333334in"}
## 6.3 Envelope time borders {#envelope-time-borders .list-paragraph}
The merging of the time envelope grid is explained by using
{width="0.18055555555555555in" height="0.2222222222222222in"} which contains
all start/stop borders for all SBR envelopes in the current SBR frame, and the
creation of {width="0.18055555555555555in" height="0.2222222222222222in"} from
the bitstream is explained in [1].
Merging the two {width="0.18055555555555555in" height="0.2222222222222222in"}
into one is done in the following sequence
1\. The start border value of the merged {width="0.18055555555555555in"
height="0.2222222222222222in"} is set to the largest of the start border
values for the left and right channels.
2\. The union of all borders for left and right channel values larger than the
merged start border is added to the merged {width="0.18055555555555555in"
height="0.2222222222222222in"}
3\. All envelopes smaller than two time slots are removed from the merged
{width="0.18055555555555555in" height="0.2222222222222222in"}. This is
achieved by starting from the beginning of {width="0.18055555555555555in"
height="0.2222222222222222in"} and remove all stop borders that are closer
than 2 from the start border.
4\. If there are more than 5 envelopes the number of envelopes are reduced.
This is achieved by starting from the end of {width="0.18055555555555555in"
height="0.2222222222222222in"} and search towards the beginning of
{width="0.18055555555555555in" height="0.2222222222222222in"} for a envelope
smaller than 4 and remove the start border of that envelope, this continues
until there are 5 envelopes left.
The index {width="0.1527777777777778in" height="0.2222222222222222in"} defined
in Table 4.119 in [1] has to be merged into one from two. The merging
algorithm uses the following recursion:
{width="2.2083333333333335in" height="1.8333333333333333in"}
## 6.4 Noise time borders {#noise-time-borders .list-paragraph}
The number of noise floors {width="0.20833333333333334in" height="0.25in"} and
the start/stop borders for the noise {width="0.18055555555555555in"
height="0.25in"} is calculated according to [1] for left and right channel and
then merged as shown below.
{width="3.0965277777777778in" height="3.7916666666666665in"}
After this is done. It is possible that the middle noise floor border dose not
coincide with any SBR envelope time border. If this is the case the middle
noise floor border is set equal to the closest time envelope border in the
upwards direction.
## 6.5 Envelope data {#envelope-data .list-paragraph}
Before merging the actual data the per envelope frequency selection of high
and low frequency resolution is merged as shown below.
{width="4.791666666666667in" height="0.5965277777777778in"},
where {width="0.5277777777777778in" height="0.2638888888888889in"} is defined
by {width="3.138888888888889in" height="0.2916666666666667in"} and
{width="0.4722222222222222in" height="0.2638888888888889in"} is defined by
{width="2.9166666666666665in" height="0.2916666666666667in"}
The envelope data referred to as {width="0.3333333333333333in"
height="0.25in"} in [1] for the left and right channels are merged into
{width="0.6527777777777778in" height="0.25in"} as shown below.
{width="6.902777777777778in" height="0.4583333333333333in"}where
{width="0.5277777777777778in" height="0.2638888888888889in"} is defined by
{width="3.138888888888889in" height="0.2916666666666667in"} and
{width="0.5694444444444444in" height="0.2638888888888889in"} is defined by
{width="4.805555555555555in" height="0.3194444444444444in"} and
{width="0.4722222222222222in" height="0.2638888888888889in"} is defined by
{width="2.9166666666666665in" height="0.2916666666666667in"} and
{width="0.5277777777777778in" height="0.2638888888888889in"} is defined by
{width="4.346527777777778in" height="0.3194444444444444in"}.
## 6.6 Noise floor data {#noise-floor-data .list-paragraph}
The noise floor data is merged as the average between left and right channel
data according to the function below.
{width="5.513888888888889in" height="0.4583333333333333in"},
where {width="0.5277777777777778in" height="0.2638888888888889in"} is defined
by {width="3.138888888888889in" height="0.2916666666666667in"} and
{width="0.4722222222222222in" height="0.2638888888888889in"} is defined by
{width="2.9305555555555554in" height="0.2916666666666667in"}.
# 7 Output resampler tool {#output-resampler-tool .list-paragraph}
The audio output from an Enhanced aacPlus decoder using a downsampled
synthesis filterbank (see 4.6.18.4.3 or 4.6.18.8.2.3 of [1]) is given at the
AAC decoder sampling rate {width="0.20833333333333334in"
height="0.18055555555555555in"}. If an output with lower sampling rate is
desired, a downsampler tool is required in order to convert the audio output
from the source sampling frequency {width="0.3333333333333333in"
height="0.2222222222222222in"} to the target sampling frequency
{width="0.625in" height="0.2222222222222222in"}.
The downsampler tool consists of three parts connected to the final operations
of the SBR decoder as in Figure 1. (Refering to Figure 4.44 of [1]). The QMF
bandlimiter operates on QMF samples and is inserted prior to the QMF synthesis
bank, the spline resampler and the postfilter operate on synthesised PCM audio
samples.
{width="3.984722222222222in" height="4.317361111111111in"}
Figure 1: Downsampler tool
## 7.1 QMF bandlimiter {#qmf-bandlimiter .list-paragraph}
The QMF bandlimiter maps the final QMF matrix {width="0.16666666666666666in"
height="0.16666666666666666in"}to {width="0.20833333333333334in"
height="0.2222222222222222in"}, according to the rule
{width="3.7916666666666665in" height="0.4722222222222222in"}
where the cutoff frequency subband index{width="0.18055555555555555in"
height="0.2222222222222222in"}is given by
{width="1.3333333333333333in" height="0.4861111111111111in"}
## 7.2 Spline resampler {#spline-resampler .list-paragraph}
Given the discrete time output {width="0.2916666666666667in"
height="0.20833333333333334in"} from synthesis QMF bank the spline resampler
relies on the continuous time signal representation,
{width="1.7083333333333333in" height="0.4305555555555556in"}
where {width="0.3055555555555556in" height="0.20833333333333334in"}is a cubic
B-spline supported on the interval {width="0.3333333333333333in"
height="0.20833333333333334in"}.The discrete time output of the resampler is
then defined, up to a suitable delay, by {width="0.9722222222222222in"
height="0.20833333333333334in"}. For each {width="0.34652777777777777in"
height="0.18055555555555555in"}, define the integer
{width="0.34652777777777777in" height="0.20833333333333334in"}and the
remainder{width="0.7638888888888888in" height="0.20833333333333334in"} by
{width="1.375in" height="0.4027777777777778in"}
Then the spline evaluation results in the time varying causal filtering,
{width="2.9166666666666665in" height="0.4305555555555556in"}
with homogeneous initialization {width="0.8888888888888888in"
height="0.20833333333333334in"}and filter coefficients
{width="2.513888888888889in" height="0.9583333333333334in"}
## 7.3 Postfilter {#postfilter .list-paragraph}
In order to compensate for a small loss in signal power for high frequencies,
a first order IIR postfilter is applied to the output
{width="0.3333333333333333in" height="0.20833333333333334in"}of the spline
resampler, resulting in the final output {width="0.3194444444444444in"
height="0.20833333333333334in"}, where {width="0.6111111111111112in"
height="0.20833333333333334in"} and
{width="2.7916666666666665in" height="0.25in"}
The value of the parameter {width="0.1527777777777778in"
height="0.1388888888888889in"}is given by Table 1.
Table 1: Postfilter coefficient {width="0.1527777777777778in"
height="0.1388888888888889in"}
* * *
{width="0.3333333333333333in" height="0.2222222222222222in"}
{width="0.20833333333333334in" height="0.18055555555555555in"}  
8 kHz 16 kHz 22.05 kHz 0.06 0.30 24 kHz 0.05 0.24
* * *
#
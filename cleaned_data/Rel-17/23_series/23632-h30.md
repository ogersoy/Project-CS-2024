# Foreword
This Technical Specification has been produced by the 3rd Generation
Partnership Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
In the present document, modal verbs have the following meanings:
**shall** indicates a mandatory requirement to do something
**shall not** indicates an interdiction (prohibition) to do something
The constructions \"shall\" and \"shall not\" are confined to the context of
normative provisions, and do not appear in Technical Reports.
The constructions \"must\" and \"must not\" are not used as substitutes for
\"shall\" and \"shall not\". Their use is avoided insofar as possible, and
they are not used in a normative context except in a direct citation from an
external, referenced, non-3GPP document, or so as to maintain continuity of
style when extending or modifying the provisions of such a referenced
document.
**should** indicates a recommendation to do something
**should not** indicates a recommendation not to do something
**may** indicates permission to do something
**need not** indicates permission not to do something
The construction \"may not\" is ambiguous and is not used in normative
elements. The unambiguous constructions \"might not\" or \"shall not\" are
used instead, depending upon the meaning intended.
**can** indicates that something is possible
**cannot** indicates that something is impossible
The constructions \"can\" and \"cannot\" are not substitutes for \"may\" and
\"need not\".
**will** indicates that something is certain or expected to happen as a result
of action taken by an agency the behaviour of which is outside the scope of
the present document
**will not** indicates that something is certain or expected not to happen as
a result of action taken by an agency the behaviour of which is outside the
scope of the present document
**might** indicates a likelihood that something will happen as a result of
action taken by some agency the behaviour of which is outside the scope of the
present document
**might not** indicates a likelihood that something will not happen as a
result of action taken by some agency the behaviour of which is outside the
scope of the present document
In addition:
**is** (or any other verb in the indicative mood) indicates a statement of
fact
**is not** (or any other negative verb in the indicative mood) indicates a
statement of fact
The constructions \"is\" and \"is not\" do not indicate requirements.
# 1 Scope
The present document defines the Stage 2 architecture, procedures, flows and
Network Function Services for User Data Interworking, Coexistence and
Migration within the 5G System.
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or nonâ€‘specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
[1] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[2] 3GPP TS 23.501: \"System Architecture for the 5G System; Stage 2\".
[3] 3GPP TS 23.002: \"Network Architecture\".
[4] 3GPP TS 23.380: \"IMS Restoration Procedures\".
[5] 3GPP TS 23.502: \"Procedures for the 5G System; Stage 2\".
[6] 3GPP TS 33.501: \"Security Architecture and Procedures for 5G System\".
[7] 3GPP TS 23.228: \"IP Multimedia Subsystem (IMS); Stage 2\".
[8] 3GPP TS 33.401: \"3GPP System Architecture Evolution (SAE); Security
architecture\".
[9] 3GPP TS 33.402: \"3GPP System Architecture Evolution (SAE); Security
aspects of non-3GPP accesses\".
[10] 3GPP TS 33.203: \"3G security; Access security for IP-based services\".
[11] 3GPP TS 33.220: \"3G security; Generic Authentication Architecture (GAA);
Generic Bootstrapping Architecture (GBA)\".
[12] 3GPP TS 24.080: \"Mobile radio interface layer 3 supplementary services
specification - Formats and coding\".
[13] 3GPP TS 23.237: \"IP Multimedia Subsystem (IMS) Service Continuity\".
[14] 3GPP TS 23.008: \"Organization of subscriber data\".
[15] 3GPP TS 29.328: \"IP Multimedia (IM) Subsystem Sh interface; Signalling
flows and message contents\".
[16] 3GPP TS 23.682: \"Architecture enhancements to facilitate communications
with packet data networks and applications; Stage 2\".
[17] 3GPP TS 23.040: \"Technical realization of the Short Message Service
(SMS)\".
[18] 3GPP TS 23.204: \"Support of Short Message Service (SMS) over generic
3GPP Internet Protocol (IP) access; Stage 2\".
# 3 Definitions of terms, symbols and abbreviations
## 3.1 Terms
For the purposes of the present document, the terms given in 3GPP TR 21.905
[1] and the following apply. A term defined in the present document takes
precedence over the definition of the same term, if any, in 3GPP TR 21.905
[1].
## 3.2 Symbols
Void
## 3.3 Abbreviations
For the purposes of the present document, the abbreviations given in 3GPP TR
21.905 [1] and the following apply. An abbreviation defined in the present
document takes precedence over the definition of the same abbreviation, if
any, in 3GPP TR 21.905 [1].
5GS UDR 5G Unified Data Repository
EPS UDR EPS User Data Repository
# 4 System architecture
## 4.1 Architecture for direct UDM-HSS interworking
Figure 4.1-1 shows the reference architecture for direct UDM-HSS interworking.
Figure 4.1-1: Architecture for Direct UDM-HSS interworking
Non-SBA interfaces between the HSS and non-SBA network nodes include
interfaces to / from the SMS-GMSC/IWMSC and SMS Router. In the Architecture
for direct UDM-HSS interworking , as a deployment option, these Non-SBA
interfaces may either be supported by the HSS or by the UDM.
Figure 4.1-2 shows the reference architecture for direct UDM-HSS interworking
using the reference point representation.
Figure 4.1-2: Architecture for Direct UDM-HSS interworking in reference point
representation
The 5GS-UDR (Unified Data Repository) and EPS-UDR (User Data Repository) may
be collocated, forming a common repository.
NOTE: The HSS is only using the NU2 reference point for the purpose of
interworking with 5GS, i.e. NU2 is not a replacement of the Ud interface.
## 4.2 Reference points for direct UDM-HSS interworking
The following reference points are realized by service-based interfaces:
**NU1:** Reference point between the HSS and the UDM.
**NU2:** Reference point between the HSS and the 5GS-UDR.
For a list of other SBA reference points supported in 5GC see 3GPP TS 23.501
[2].
For a list of IMS reference points, including SBA IMS reference points, see
3GPP TS 23.228 [7].
For a list of Non-SBA reference points and Network Nodes interfacing the HSS
see 3GPP TS 23.002 [3].
The HSS makes use of the Ud reference point to interact with the EPS-UDR. The
UDM makes use of the N35 reference point to interact with the 5GS-UDR.
## 4.3 Service based interfaces for direct UDM-HSS interworking
**Nudm:** Service-based interface exhibited by UDM.
**Nhss:** Service-based interface exhibited by HSS.
The HSS shall make use of Nudm services as described in clause 6.2 and may
make use of Nudr services as described in clause 6.3.
The UDM shall make use of Nhss services and Nudr services as described in
clauses 6.1 and 6.3.
## 4.4 Subscription Identifiers
As defined in 3GPP TS 23.501 [2], for interworking with the EPC, the SUPI
allocated to the 3GPP UE shall always be based on an IMSI to enable the UE to
present an IMSI to the EPC.
The subscription identifier used over NU1 reference point in Nhss services
shall be an IMSI. The UDM extracts the IMSI from the user\'s SUPI.
The subscription identifier used over NU1 reference point in Nudm services
shall be a SUPI based on an IMSI. The HSS creates a SUPI from the user\'s IMSI
or the IMSI associated to the user\'s public identifier in the EPS or IMS
domain (e.g. user\'s MSISDN or IMPU).
## 4.5 HSS Discovery and Selection
This clause defines the procedures for HSS discovery and selection by the UDM.
The procedures for HSS discovery and selection by SBI capable IMS entities is
defined in 3GPP TS 23.228 [7].
The UDM performs HSS discovery to discover an HSS that manages the user
subscriptions in EPC.
The UDM shall utilize the NRF to discover the HSS instance(s) unless the
information about HSS instances is available by other means, e.g. locally
configured on the UDM. The HSS selection function in UDM selects an HSS
instance based on the available HSS instances (obtained from the NRF or
locally configured).
When the NRF is used for HSS discovery, the HSS registers in the NRF using the
Nnrf_NFManagement_NFRegister Request message as defined in 3GPP TS 23.502 [5].
Different HSS instances managing different sets of IMSI/MSISDN ranges may be
deployed in a given PLMN. In this case, the HSS instances register in NRF
using either different ranges of IMSI/MSISDN and/or HSS Group IDs.
NOTE 1: In deployments where simple IMSI/MSISDN ranges are not suitable to
describe the IMSI/MSISDN sets served by HSS instances, it is expected the HSS
instances only register HSS Group IDs.
When NRF is used for HSS discovery, the UDM sends a Nnrf_NFDiscovery_Request
to NRF as defined in 3GPP TS 23.502 [5] to discover HSS instances within a
given PLMN. The UDM may store all returned HSS instances and their NF profiles
for subsequent use, including, if applicable, supported IMSI/MSISDN ranges,
and/or HSS Group IDs.
The UDM may use Nnrf_NFStatusSubscribe/Unsubscribe service operations with NRF
as defined in 3GPP TS 23.502 [5] to receive Nnrf_NFStatusNotify service
operation for updates to the NF profiles of HSS instances registered in NRF.
The UDM always selects an HSS within its own PLMN. The HSS selection should
consider one of the following factors when available to the UDM entity:
1\. HSS Group ID of the UE\'s IMSI.
2\. IMSI; the UDM selects an HSS instance based on the IMSI range the UE\'s
IMSI belongs to or based on the results of a discovery procedure with NRF
using the UE\'s IMSI as input for HSS discovery.
NOTE 2: In this release of the specification there is not identified need for
the UDM to be able to select the HSS based on IMS identifiers (IMPI, IMPU)
neither based on MSISDN or External Group ID.
## 4.6 UDM Discovery and Selection
The HSS performs UDM discovery and selection as described in 3GPP TS 23.501
[2].
## 4.7 Subscription Profiles
In the context of Mobility, IMS and SMS use cases, the HSS initiates
interworking with the UDM only for UEs which have a 5G subscription that is
known to be active in 5GC.
NOTE: The HSS may be aware that a 5G subscription for the UE exists based on
the Core Network Type restrictions defined for the UE (i.e. If restriction for
Core Network Type indicates that the UE can access to 5GC, it implies that the
UE has 5G subscription data).\ Additionally, the HSS may be aware that a UE
for which 5G subscription data exist is not active in 5GC e.g. when the HSS
has not yet received an Nhss_UECM_ SNDeregistration request from the UDM for
that UE (see clause 5.3.3 step 3).
# 5 System procedures
## 5.1 General
Procedures involving communication between HSS and UDM comprise
Authentication, Mobilty, IMS interworking, and SMS support.
## 5.2 Authentication
### 5.2.1 General
A subscriber\'s authentication subscription data, including the subscriber\'s
long-term key(s) and sequence number, shall be stored in a single repository
so that a single sequence number can be maintained for the subscriber.
The subscriber\'s long-term key(s) shall not be transferred over the NU1
reference point between HSS and UDM. Also it is not expected that the UDM has
direct standardized access to the EPS-UDR. Therefore, the following options
exist for subscribers with both 5G and EPS subscription:
1) Authentication subscription data are stored in the EPS-UDR and all
authentication vectors are calculated in the HSS. Subscription data stored in
the 5GS-UDR or locally configured in the UDM indicate that the UDM needs to
consume the Nhss_UEAuthentication_Get service operation to retrieve a 5G
vector from the HSS. See clause 5.2.2 for details.
2) Authentication subscription data are stored in the 5GS-UDR and all
authentication vectors are calculated in the UDM. Subscription data stored in
the EPS-UDR or locally configured in the HSS indicate that the HSS needs to
consume the Nudm_UEAuthentication_GetHssAv service operation to retrieve an
EPS vector from the UDM. See clause 5.2.3 for details.
3) Authentication subscription data are stored in the 5GS-UDR, 5G vectors are
calculated in the UDM and EPS vectors are calculated in the HSS. Subscription
data stored in the EPS-UDR or locally configured in the HSS indicate that the
HSS needs to consume the Nudr_DM_Query service operation to retrieve
authentication subscription data from the 5GS-UDR. See clause 5.2.4 for
details.
The following clauses specify the system procedures for these different
alternatives.
### 5.2.2 Vector Generation in HSS
This clause specifies the procedures for authentication vector request when
the subscriber\'s authentication subscription data is stored at the EPS-UDR.
In this case, the UDM requests the generation of the Authentication Vector for
5GS to the HSS.
NOTE: The HSS acts as ARPF rather than as AuC and it is required to generate
authentication vectors as defined in 3GPP TS 33.501 [6].
When the UDM receives an authentication information Request from the AUSF it
shall check (by means of an 5GS-UDR query or local configuration in the UDM)
whether the subscribed authentication method is 5G_AKA or EAP_AKA_PRIME and if
so whether 5G authentication vector generation for the identified subscriber
shall be done in the HSS. If so, the UDM shall make use of the
Nhss_UEAuthentication_Get service operation to retrieve a 5G authentication
vector from the HSS.
Figure 5.2.2-1 shows the scenario where the authentication vector request for
a 5G subscriber who also has an EPS subscription is received by the UDM.
Figure 5.2.2-1: Authentication for 5G subscriber with authentication vector
generation in HSS
1\. The UDM receives an Authentication Vector request, containing the identity
of the user (SUPI or SUCI). If SUCI is received, the UDM performs SUCI to SUPI
de-concealment. For details of the Nudm_UEAuthentication Service see 3GPP TS
23.502 [5] and 3GPP TS 33.501 [6].
2\. If the 5GS-UDR is used, the UDM queries the 5GS-UDR using the SUPI to
retrieve Authentication Subscription Information. In this scenario the
Authentication Subscription Information contains a subscribed authentication
method of 5G_AKA or EAP_AKA_PRIME and an indicator indicating that
authentication vector generation shall be performed in the HSS. Optionally,
the indication that the authentication vector generation shall be performed in
the HSS could be locally configured at the UDM/ARPF.
3\. The UDM uses the Nhss_UEAuthentication_Get service operation to retrieve
an authentication vector from the HSS. The request contains the IMSI the
authentication method and serving network name.
4\. The HSS reads authentication subscription data from the EPS-UDR. This step
is omitted if all relevant authentication subscription data are stored locally
in the HSS.
5\. The HSS (AuC/ARPF) calculates the requested authentication vector taking
into account the serving network name and authentication method received in
step 3 and the authentication subscription information retrieved from the EPS-
UDR.
6\. The calculated authentication vector is sent to the UDM.
7\. The HSS updates the EPS-UDR with the new sequence number. This step is
omitted if the sequence number is stored locally in the HSS.
8\. The UDM forwards the authentication vector to the AUSF.
### 5.2.3 Vector Generation in UDM/ARPF
This clause specifies the procedures for authentication vector request when
the subscriber\'s authentication subscription data is stored at the 5GS-UDR.
In this case, the HSS requests the generation of the Authentication Vector for
EPS and/or IMS to the UDM.
NOTE: The UDM acts as AuC rather than as ARPF and it is required to generate
authentication vectors as defined in 3GPP TS 33.401 [8], 3GPP TS 33.402 [9],
3GPP TS 33.203 [10] and 3GPP TS 33.220 [11].
When the HSS receives an authentication vector request from a serving node
(e.g. MME, SGSN, VLR, S-CSCF, BSF) it shall check (by means of an EPC-UDR
query) whether authentication vector generation for the identified subscriber
shall be done in the UDM. If so, the HSS shall make use of the
Nudm_UEAuthentication GetHssAv service operation to retrieve authentication
vectors from the UDM.
Figure 4.2.3-1 shows the scenario where an authentication vector request for a
subscriber is received by the HSS and subscription data stored in the EPS-UDR
indicate that for the subscriber authentication vector generation is to be
performed in the UDM.
Figure 5.2.3-1: Authentication for a subscriber with authentication vector
generation in UDM
1\. The HSS receives an Authentication Vector request, containing the identity
of the user (IMSI, or Public User Identity and/or Private User Identity).
2\. The HSS queries the EPS-UDR using the identity of the user to retrieve
Authentication Subscription Information. In this scenario the Authentication
Subscription Information contains an indicator indicating that authentication
vector generation shall be performed in the UDM.
3\. The HSS uses the Nudm_UEAuthentication_GetHssAv service operation to
retrieve an authentication vector from the UDM. The request contains the
identity of the user, the type of the requested vector (E-UTRAN/UTRAN or
GERAN/ IMS-AKA and when available the visited PLMN-ID.
4\. The UDM reads authentication subscription data from the 5GS-UDR.
5\. The UDM (ARPF) calculates the requested authentication vectors taking into
account the information received in step 3 and the authentication subscription
information retrieved from the 5GS-UDR.
6\. The calculated authentication vectors are sent to the HSS.
7\. The UDM updates the 5GS-UDR with the new sequence number.
8\. The HSS forwards the authentication vectors to the serving node.
### 5.2.4 HSS using the Nudr SBI
When the HSS receives an S6a-AIR from the MME, it may check (by means of an
EPC-UDR query) whether the subscriber has an 5G subscription. If so, the HSS
can use of the Nudr_DM_Query Get service operation to retrieve the
authentication subscription data from the 5GS UDR and generate the
authentication vector.
Figure 5.2.4-1 shows the scenario where the authentication vector request for
a 5G subscriber who also has an EPS subscription is received by the UDM.
Figure 5.2.4-1: Authentication for 5G subscriber with EPS subscription
1\. The HSS receives an Authentication Vector request containing the identity
of the user (IMSI).
2\. The HSS queries the EPC-UDR using the IMSI to retrieve Authentication
Subscription Information. Since the subscriber is a 5G subscriber the response
indicates that the subscriber\'s authentication information is stored in the
5GS UDR.
NOTE: Local configuration in the HSS may indicate that authentication
subscription data for all subscribers can be obtained from the 5G UDR and thus
this step may be omitted.
3\. The HSS uses the Nudr_DM_Query Get service operation to retrieve the
authentication subscription data from the 5GS UDR. The request contains the
IMSI formatted as a SUPI.
4\. The HSS (AuC) calculates the requested authentication vector taking into
account the serving network name and authentication method received in step 1
and the authentication subscription information retrieved from the 5GS-UDR in
step 3.
5\. The calculated authentication vector is returned to the MME.
6\. The HSS updates the 5GS-UDR with the new sequence number.
## 5.3 5GC-EPC Mobility Scenarios
### 5.3.1 General
As defined in 3GPP TS 23.501 [2], when interworking procedures with N26 are
used, the UE operates in single-registration mode. For the 3GPP access, either
the AMF or the MME is registered in the HSS+UDM. This implies that:
\- The registration of an MME in HSS for a UE that is capable to access the
5GC, triggers the cancellation of the AMF address for 3GPP access registered
in the UDM, if any.
\- The registration of an AMF in UDM for a UE that is capable to access the
EPC, triggers the cancellation of the MME address registered in the HSS, if
any.
Interworking procedures without N26 do not require that the HSS+UDM cancels
the location of the old serving node in the old access domain. However, the
UDM may request from the HSS the cancelation of the SGSN.
Additionally, upon mobility from GERAN/UTRAN to 5GS, the previously registered
SGSN needs to be cancelled from HSS/HLR, otherwise the incoming session can
fail.
Additionally, IP address preservation for PDU sessions that support
interworking is provided to UEs during inter-system mobility procedures by
storing and fetching the PGW-C+SMF FQDN for S5/S8 interface per APN/DNN via
the HSS+UDM.
### 5.3.2 Mobility from 5GC to EPC
Figure 5.3.2-1 shows the interaction between the HSS and UDM in an
interworking scenario when the UE attaches to the EPC.
Figure 5.3.2-1: Mobility from 5GC to EPC
1\. The HSS receives an S6a ULR request containing the IMSI of the subscriber.
The HSS stores the new MME address. If the EPC UDR is used, the HSS updates
the EPS-UDR with the new MME address and reads the subscription information
related to the IMSI from the EPS-UDR.
The UE\'s subscription may include restriction for Core Network Type (5GC). If
restriction for Core Network Type indicates that the UE can access to 5GC, it
implies that the UE has 5G subscription data.
2\. The HSS responds to the MME with an S6a-ULA.
3\. If the dual registration 5GS indicator is not set in the S6a ULR request
and the subscription information related to the IMSI does not indicate that
5GC is restricted, then the HSS uses the Nudm_UECM_AMFDeregistration service
operation to request the UDM to cancel the registration of the user in 5GC for
3GPP access, if any. The HSS includes the user\'s IMSI received in step 1 as
the user\'s SUPI in this request.
If the S6a ULR request includes the initial attach indicator set, the HSS
indicates to the UDM that the deregistration reason is due to \"Initial
Registration\". When the initial attach indicator is not set, the HSS
indicates to the UDM that the deregistration reason is due to 5GS to EPS
mobility.
NOTE: If the dual registration 5GS indicator is set in the S6a ULR request,
the HSS is not required to request the UDM to cancel the location of the UE in
AMF if any.
4\. The UDM responds to the HSS.
The UDM checks if the user is registered in 5GC over 3GPP access. The UDM may
use the 5GS-UDR to retrieve the address of the AMF for 3GPP access registered
in UDM for that user, if any. If the user is registered at an AMF for 3GPP
access, step 5 is executed.
5\. If there is an AMF address for 3GPP access found for the user, the UDM
cancels the user registration in 5GC by sending a
Nudm_UECM_DeregistrationNotification to the AMF.
### 5.3.3 Mobility from EPC to 5GC
Figure 5.3.3-1 shows the interaction between the UDM and the HSS in an
interworking scenario when the UE attaches to the 5GC.
Figure 5.3.3-1: Mobility from EPC to 5GC
1\. The UDM receives a Nudm_UECM_Registration request for 3GPP access
containing the SUPI of the subscriber. In this case the SUPI shall be based on
an IMSI.
The UDM stores the new AMF address for 3GPP access. If the 5GS UDR is used,
the UDM updates the 5GS-UDR with the new AMF address for 3GPP access and reads
the subscription information related to the SUPI from the 5GS-UDR.
The UE\'s subscription may include restriction for Core Network Type (EPC). If
restriction for Core Network Type indicates that the UE can access to EPC, it
implies that the UE has EPC subscription data and that the UE may also be able
to access via GERAN/UTRAN.
2\. The UDM responds to the AMF with a Nudm_UECM_Registration Response.
3\. If the dual registration and the initial registration flags are not set in
the Nudm_UECM_Registration request and the subscription information related to
the SUPI does not indicate that EPC is restricted, then the UDM uses the
Nhss_UECM_SNDeregistration service operation indicating that the
deregistration reason is due to EPS to 5GS mobility to request the HSS to
cancel the MME/SGSN registration of the user in EPC, if any. The UDM includes
the IMSI based on SUPI received in step 1 as the user\'s IMSI in this request.
If the dual registration flags is set in the Nudm_UECM_Registration request
and the subscription information related to the SUPI does not indicate that
EPC is restricted, then the UDM uses the Nhss_UECM_SNDeregistration service
operation indicating that the deregistration reason is due to Initial and Dual
Registration to request the HSS to cancel the SGSN registration of the user in
EPC, if any. The UDM includes the IMSI based on SUPI received in step 1 as the
user\'s IMSI in this request.
If the dual registration flag is not set and the initial registration flag is
set in the Nudm_UECM_Registration request and the subscription information
related to the SUPI does not indicate that EPC is restricted, then the UDM
uses the Nhss_UECM_SNDeregistration service operation indicating that the
deregistration reason is due to Initial and Single Registration to request the
HSS to cancel the MME/SGSN registrations of the user in EPC, if any. The UDM
includes the IMSI based on SUPI received in step 1 as the user\'s IMSI in this
request.
4\. The HSS responds to the UDM.
The HSS checks if the user is registered in EPC. The HSS may use the EPS-UDR
to retrieve the address of the MME or SGSN registered in the HSS for that
user, if any. If the user is registered at an MME or SGSN, step 5 is executed.
5\. If there is an MME address found for the user and the deregistration
reason in the Nhss_UECM_SNDeregistration service operation indicated \"Initial
and Single Registration\" or \"EPS to 5GS mobility\", the HSS cancels the
attachment of the IMSI in the MME by sending a CLR via the S6a interface
setting the cancellation type to MME Update Procedure, and if a VLR number was
found in the HSS for the user, the HSS also cancels attachment of the IMSI in
this MSC/VLR by sending the MAP Cancel Location (IMSI) to the MSC/VLR via the
D interface.
If there is an SGSN address found for the user and the deregistration reason
in the Nhss_UECM_SNDeregistration service operation indicated \"Initial and
Single Registration\", the HSS cancels the attachment of the IMSI in the SGSN
by sending a CLR via the S6d interface or by sending the MAP Cancel Loc via
the Gr interface setting the cancellation type to SGSN Update Procedure. When
deregistration reason indicated \"Initial and Dual Registration\" or \"EPS to
5GS Mobility\", the HSS cancels the attachment of the IMSI in the SGSN by
sending a CLR via the S6d interface setting the cancellation type to SGSN
Update Procedure.
### 5.3.4 Support for PDU session continuity during intersystem mobility
procedures
When the UE is connected to 5GS or 5GC-N3IWF, the PGW-C+SMF may store in UDM
the PGW-C+SMF FQDN for S5/S8/S2b interface, within the UE context in SMF data,
when the PWG-C+SMF registers in UDM. The AMF serving 3GPP access may also
notify the UDM to store the association between DNN and PGW-C+SMF FQDN which
supports EPS interworking as Intersystem continuity context.
During mobility from 5GC to EPC or EPC/ePDG, or mobility from 5GC-N3IWF to
EPC, or mobility from EPC/ePDG to EPC, the HSS uses the Nudm_SDM_Get service
operation to retrieve the PGW-C+SMF FQDN for S5/S8/S2b interface from UDM, and
subscribes to be notified using Nudm_SDM_Subscribe when the Intersystem
continuity context data or the UE context in SMF data are modified. The HSS
retrieves both the UE context in SMF data and the Intersystem continuity
context data from UDM. The HSS checks the Intersystem continuity context
first. If no PGW-C+SMF FQDN associated with the APN exists in Intersystem
continuity context, the HSS selects one of the PGW-C+SMF FQDN for the APN from
the UE context in SMF data based on operator\'s policy.
During UE registration for the scenario when ePDG is connected to SMF+PGW-C
and S6b in not used, the HSS subscribes to be notified from the UDM using
Nudm_SDM_Subscribe when the UE context in SMF data is modified as new PDU
sessions established in the ePDG are not updated in the HSS via the SWx
interface.
Figure 5.3.4-1 shows the interaction between the HSS and the UDM in an
interworking scenario when the UE attaches to the EPC or EPC/ePDG.
Figure 5.3.4-1: PDU session continuity during mobility from 5GC to EPC
0\. While the UE is connected to the 5GC, the AMF and/or SMF may store in UDM
the association between DNN and PGW-C+SMF FQDN which supports EPS
interworking.
If the 5GS UDR is used, the UDM updates the 5GS-UDR with the DNN and PGW-C+SMF
FQDN association.
1\. The HSS receives an S6a ULR or SWx SAR request containing the IMSI of the
subscriber.
The HSS reads the subscription information related to the IMSI. If the EPC-UDR
is used, the HSS retrieves the subscription information from the EPS-UDR. The
UE\'s subscription may include subscribed APNs that support interworking with
5GS.
2\. If the subscription information related to the IMSI includes subscribed
APNs that support interworking with 5GS, then the HSS uses the Nudm_SDM_Get
service operation to fetch the UE context in SMF data and the Intersystem
continuity context data for the user in AMF data, if any. The HSS includes the
user\'s IMSI received in step 1 as the user\'s SUPI in this request.
3\. The UDM responds to the HSS.
The HSS checks the Intersystem continuity context first. If no PGW-C+SMF FQDN
associated with an DNN exists in Intersystem continuity context, the HSS
selects one of the PGW-C+SMF FQDN for the APN from the UE context in SMF data
based on operator\'s policy.
4-5.The HSS subscribes to be notified using Nudm_SDM_Subscribe service
operation when the Intersystem continuity context data or the UE context in
SMF data are modified.
6\. The HSS responds to the MME with an S6a-ULA response or to the AAA with an
SWx-SAA response including the PGW-C+SMF FQDN associated with subscribed APNs
that support interworking with 5GS, if any. This step may happen at any time
after step 3, not necessarily after steps 4-5.
If an S6a ULR is received, the HSS performs steps 3 and 4 of clause 5.3.2.
Figure 5.3.4-2 shows the interaction between the HSS and the UDM when the HSS
receives notification from the UDM when the data requested is modified.
Figure 5.3.4-2: Notification of PGW-C+SMF FQDN from UDM to HSS
0\. The AMF and/or SMF may add or remove or update the association between DNN
and PGW-C+SMF FQDN stored in the UDM.
If the 5GS UDR is used, the UDM updates the 5GS-UDR with the DNN and PGW-C+SMF
FQDN association.
1\. If the UDM finds the UE context in SMF data or the Intersystem continuity
context is changed, and the active subscription from the HSS exists for the UE
to be notified on the change of the UE context in SMF data or the Intersystem
continuity context, then the UDM uses the Nudm_SDM_Notification service
operation to notify the HSS. Notifications may be limited to cases of PGW ID
(FQDN and/or IP) being changed. As part of this notification the UDM informs
the HSS whether the SMF indicated that the access to 5GC was via an ePDG.
2\. The HSS responds to the UDM.
The HSS checks the change of the association between APN and PGW-C+SMF FQDN.
If multiple PGW-C+SMF FQDN exists in the UE context in SMF data, the HSS
selects one of the PGW-C+SMF FQDN for the APN based on operator\'s policy.
3\. The HSS may further trigger PDN GW Identify Notification procedure, as
defined in clause 12.1.4 and clause 12.1.5 in TS 23.402.
Figure 5.3.4-3 shows the interaction between the HSS and the UDM when the HSS
unsubscribes from the UDM to be notified when the data requested is modified.
Figure 5.3.4-3: Unsubscribe of PGW-C+SMF FQDN Notification from HSS to UDM
0\. The HSS checks the conditions to unsubscribe the notification of the UE
context in SMF data or the Intersystem continuity context from the UDM, when
the UE\'s 3GPP access or Non-3GPP access registration in EPC is not valid. For
example, when the MME performs purge UE procedure, or the AAA performs UE
deregistration towards the HSS, or the registration of the user in EPC is
cancelled due to mobility from EPC to 5GC.
1\. The HSS unsubscribes to be notified using Nudm_SDM_Unsubscribe service
operation towards the UDM.
2\. The UDM responds to the HSS.
When the UE is connected to EPC, the MME stores in HSS the PGW-C+SMF FQDN for
S5/S8 interface via S6a reference point. When the UE is connected to EPC via
an ePDG, and the S6b reference point is deployed between the PGW-C+SMF and
AAA, the AAA stores in HSS the PGW-C+SMF FQDN for S5/S8 interface via SWx
reference point.
NOTE: When S6b is not deployed between the PGW-C+SMF and AAA, the registration
and de-registration of the PDN GW address is performed in the UDM using the
N10 interface instead. In this case, for interworking between EPC/ePDG and 5GS
the UDM is not required to contact the HSS to fetch the PDN GW address.
During mobility from EPC or EPC/ePDG to 5GC, or mobility from EPC to
5GC-N3IWF, the UDM uses the Nhss_SDM_Get service operation to retrieve the
PGW-C+SMF FQDN for S5/S8 interface from HSS and subscribes to be notified
using Nhss_SDM_Subscribe when the data requested is modified.
Figure 5.3.4-4 shows the interaction between the HSS and the UDM in an
interworking scenario when the UE moves from EPC or EPC/ePDG to 5GC.
Figure 5.3.4-4: PDU session continuity during mobility from EPC/ePDG to 5GC
0\. While the UE is connected to the EPC or EPC/ePDG, the MME or the AAA
informs the HSS of the PGW-C+SMF address and associated APN.
1\. UE moves to 5G coverage, the AMF registers with the UDM using
Nudm_UECM_Registration for 3GPP access.
The UDM performs steps 3 and 4 in clause 5.3.3.
2\. The AMF retrieves the Access and Mobility Subscription data, SMF Selection
Subscription data and UE context in SMF data using Nudm_SDM_Get.
3\. If the subscription information related to the SUPI includes subscribed
DNNs that support interworking with EPS, then the UDM uses the Nhss_SDM_Get
service operation to fetch the PGW-C+SMF information. The UDM includes the
user\'s IMSI derived from SUPI.
4\. The HSS responds to the UDM.
5\. The UDM includes the PGW-C+SMF address associated with subscribed DNNs
that support interworking with EPS, if any, as UE context in SMF data in
Nudm_SDM_Get_Response.
6\. After a successful response is received, the AMF subscribes to be notified
when the data requested is modified using Nudm_SDM_Subscribe service
operation.
7\. If the UE context in SMF data is subscribed to be notified and the
subscription information related to the SUPI includes subscribed DNNs that
support interworking with EPS, the UDM subscribes towards the HSS (if not
already subscribed, for the same UE) to be notified when the PGW-C+SMF
information is modified using Nhss_SDM_Subscribe service operation.
8\. The HSS responds to the UDM.
9\. The UDM responds to the AMF.
Figure 5.3.4-5 shows the interaction between the HSS and the UDM when the UDM
receives notification from the HSS when the data requested is modified.
Figure 5.3.4-5: Notification of PGW-C+SMF FQDN from HSS to UDM
0\. The MME or the AAA may add or update the association between APN and
PGW-C+SMF FQDN stored in the HSS.
1\. If the HSS finds the association between APN and PGW-C+SMF FQDN is
changed, and the active subscription from the UDM exists for the UE to be
notified on the change of the data requested, then the HSS uses the
Nhss_SDM_Notification service operation to notify the UDM.
2\. The UDM responds to the HSS.
3 - 4. If the UDM finds the association between DNN and PGW-C+SMF FQDN is
changed, and the active subscription from the AMF exists for the UE to be
notified on the change of the UE context in SMF data, then the UDM notifies
the AMF using the Nudm_SDM_Notification service operation.
Figure 5.3.4-6 shows the interaction between the HSS and the UDM when the UDM
unsubscribes from the HSS to be notified when the data requested is modified.
Figure 5.3.4-6: Unsubscribe of PGW-C+SMF FQDN Notification from UDM to HSS
1 - 2. The AMF unsubscribes to be notified using Nudm_SDM_Unsubscribe service
operation.
3\. If the UE context in SMF data is unsubscribed, and no other AMF has
subscribed to the same data (UE context in SMF) for the same UE, the UDM
unsubscribes towards the HSS to be notified when the PGW-C+SMF information is
modified using Nhss_SDM_Unsubscribe service operation.
4\. The HSS responds to the UDM.
## 5.4 Scenarios of Interworking with IMS
### 5.4.1 T-ADS
Figure 5.4.1-1 shows the scenario where the HSS receives a T-ADS request from
the AS for a subscriber who has a 5GC subscription.
Figure 5.4.1-1: T-ADS request for 5G subscriber
1\. The HSS receives a T-ADS request from the AS. The request includes the
user\'s IMPU or MSISDN and optionally the user\'s IMPI.
NOTE: An SBA capable IMS-AS makes use of Nhss_ImsSDM service to interact with
the HSS for this operation as defined in 3GPP TS 23.228 [7]. Otherwise the
IMS-AS makes use of Diameter Sh-UDR/UDA command.
2\. If the EPS-UDR is used, the HSS reads subscription data from the EPS-UDR.
The HSS, retrieves the user\'s IMSI associated with the user\'s identifiers
received in step 1. The subscription data may contain an indication that the
user has a 5GC subscription.
3\. The HSS performs T-ADS info retrieval in the EPC. This may include
contacting the MME and/or SGSN.
4\. If the HSS detects in step 2 that the user has a 5GC subscription and
unless the user is known not to be registered in 5GC (e.g. in case the user is
registered in EPC and the HPLMN is working in single registration mode with
N26), the HSS uses the Nudm_MT_ProvideDomainSelection service operation to
retrieve T-ADS information from the UDM. The HSS includes the user\'s IMSI
associated with the user\'s identifiers received in step 1 as the SUPI in this
request.
5\. The UDM reads data from the 5GS-UDR to see whether the registered AMF(s)
support IMS voice over PS.
6-7. If support/non-support of IMS voice is not homogeneous for the User in
the AMF for 3GPP access, the UDM retrieves domain selection information from
the AMF.
8\. The UDM provides the 5G domain selection info to the HSS.
9\. The HSS combines the 5G domain selection info with the EPS domain
selection info from step 3 and sends the result to the AS.
### 5.4.2 P-CSCF Restoration
Figure 5.4.2-1 shows the scenario where the HSS receives a P-CSCF restoration
indication from the S-CSCF for a subscriber who has a 5GC subscription.
Figure 5.4.2-1: P-CSCF Restoration for 5G subscriber
1\. The HSS receives a P-CSCF Restoration indication from the S-CSCF. The
request includes the user\'s IMPU and IMPI.
NOTE: An SBA capable S-CSCF makes use of Nhss_ImsUECM service to interact with
the HSS for this operation as defined in 3GPP TS 23.228 [7]. Otherwise the
S-CSCF makes use of Diameter Cx-SAR/SAA command.
2\. If the EPS-UDR is used, the HSS reads subscription data from the EPS-UDR.
The HSS, retrieves the user\'s IMSI associated with the user\'s identifiers
received in step 1. The subscription data may contain an indication that the
user has a 5GC subscription.
3-4. The HSS acknowledges receipt of the request and performs P-CSCF
restoration in the EPC. For details see 3GPP TS 23.380 [4] clause 5.4.2.1.
5\. If the HSS detects in step 2 that the user has a 5GC subscription and
unless the user is known not to be registered in 5GC (e.g. in case the user is
registered in EPC and the HPLMN is working in single registration mode with
N26), the HSS uses the Nudm_UECM_P-CscfRestorationTrigger service operation to
trigger P-CSCF restoration in 5GC. See also 3GPP TS 23.380 [4] clause 5.8.4.
The HSS includes the user\'s IMSI associated with the user\'s identifiers
received in step 1 as the SUPI in this request
6\. The UDM reads data from the 5GS-UDR to see which NFs have subscribed to
P-CSCF Restoration Notifications (implicitly during registration).
7\. The UDM acknowledges receipt of Nudm_UECM_PCscfRestorationTrigger to the
HSS.
8-9. The UDM sends a notification to one of the subscribed NFs (either the AMF
or the SMF).
### 5.4.3 Network Provided Location Information Request
Figure 5.4.3-1 shows the scenario where the HSS receives a Location
Information retrieval request from the IMS-AS for a subscriber who has a 5GC
subscription.
Figure 5.4.3-1: Location Information retrieval request for 5G subscriber
1\. The HSS receives a Location Information retrieval request (requested nodes
includes AMF) from the IMS-AS.
NOTE: An SBA capable IMS-AS makes use of Nhss_ImsSDM service to interact with
the HSS for this operation as defined in 3GPP TS 23.228 [7]. Otherwise the
IMS-AS makes use of Diameter Sh-UDR/UDA command.
2\. The HSS reads subscription data from the EPS-UDR.
3\. The HSS performs Location Information Retrieval from other nodes if so
requested. This may include contacting the MME and/or SGSN.
4\. If the HSS detects in step 2 that the user has a 5GC subscription and
unless the user is known not to be registered in 5GC, the HSS uses the
Nudm_MT_ProvideLocationInfo service operation to retrieve 5GS Location
Information. The service request includes indicators for Current Location,
Serving Node Indication, Local Time Zone Indication, and RAT-Type requested as
has been received in step 1.
5\. The UDM reads data from the 5GS-UDR to get the AMF and SMSF for 3GPP
Access Registration Information. If the Serving Node Indication was received
in step 4, steps 6-7 shall be skipped.
6-7. The UDM retrieves location information from the AMF (for 3GPP access) by
means of the Namf_Location_ProvideLocationInfo service operation .
8\. The UDM provides the 5GS location information info to the HSS.
9\. The HSS provides the requested location information to the IMS-AS.
### 5.4.4 User State Retrieval
Figure 5.4.4-1 shows the scenario where the HSS receives a PS User State
retrieval request from the IMS-AS for a subscriber who has a 5GC subscription.
Figure 5.4.4-1: PS User State retrieval request for 5G subscriber
1\. The HSS receives a PS User State retrieval request (requested nodes
includes AMF) from the IMS-AS.
NOTE 1: An SBA capable IMS-AS makes use of Nhss_ImsSDM service to interact
with the HSS for this operation as defined in 3GPP TS 23.228 [7]. Otherwise
the IMS-AS makes use of Diameter Sh-UDR/UDA command.
2\. The HSS reads subscription data from the EPS-UDR.
3\. The HSS performs PS User State Retrieval from other nodes if so requested.
This may include contacting the MME and/or SGSN.
4\. If the request includes AMF as requested node and if the HSS detects in
step 2 that the user has a 5GC subscription and unless the user is known not
to be registered in 5GC, the HSS uses the Nudm_MT_ProvideUserState service
operation to retrieve the 5GS User State. Otherwise, continue with step 9.
5\. The UDM reads data from the 5GS-UDR to get the AMF for 3GPP Access
Registration Information.
6-7. The UDM retrieves the user state from the AMF (for 3GPP access) by means
of the Namf_EventExposure Subscribe service operation (one time immediate
report requested).
8\. The UDM provides the 5GS PS User State to the HSS.
9\. The HSS provides the requested user state to the IMS-AS.
NOTE 2: If the IMS-AS supports 5G SBI it may make use of the Nhss-ims service
instead of Sh.
### 5.4.5 UE Reachability
Figure 5.4.5-1 shows the scenario where the HSS receives a Subscription to
notification request for UE-reachability from the IMS-AS for a subscriber who
has a 5GC subscription.
Figure 5.4.5-1: Subscription to UE reachability for 5G subscriber
1\. The HSS receives a Subscribe request for UE reachability for IP from the
IMS-AS.
NOTE: An SBA capable IMS-AS makes use of Nhss_ImsSDM service to interact with
the HSS for this operation as defined in 3GPP TS 23.228 [7]. Otherwise the
IMS-AS makes use of Diameter Sh-SNR/SNA command.
2\. The HSS reads subscription data from the EPS-UDR.
3\. The HSS sets the UE Reachability flags for EPC and if the UE is registered
in EPC contacts the registered MME and SGSN to get notified when the UE
becomes reachable.
4\. If the HSS detects in step 2 that the user has a 5GC subscription, the HSS
uses the Nudm_EventExposure_Subscribe service operation (one time immediate
report requested) to get notified when the UDM detects UE reachability for SMS
over IP. Otherwise, continue with step 10.
5\. The UDM sets the URRP-AMF flag in the 5GS-UDR and reads data from the 5GS-
UDR to get the AMF for 3GPP Access Registration Information and the AMF for
non-3GPP Access Registration Information if any.
6-7. [Conditional] If an AMF is registered in UDM for the target UE and the
UDM has not already subscribed in AMF due to a previous subscription from a
different NF, the UDM subscribes to UE reachability notifications at the
registered AMFs by means of the Namf_EventExposure_Subscribe service operation
(see 3GPP TS 23.502 [5]).
8\. The UDM updates the 5GS-UDR with the EE-Subscription for the HSS.
9\. The UDM acknowledges the EE Subscription to the HSS.
10\. The HSS acknowledges the Sh subscription to the IMS-AS.
11\. The HSS updates the EPS-UDR with the Sh subscription for the IMS-AS.
Figure 5.4.5-2 shows the scenario where the UDM detects UE reachability for
SMS over IP and notifies the HSS that has previously subscribed.
Figure 5.4.5-2: UE reachability notification for 5G subscriber
1\. The UDM receives a Notification or Registration from the AMF.
2\. The UDM reads subscription data from the 5GS-UDR.
3\. The UDM acknowledges step 1 towards the AMF. If an old AMF is registered
in the UDM, the UDM sends a Nudm_UECM_DeregistrationNotification service
operation to the old AMF.
4\. The UDM notifies the HSS (and any other NF that has subscribed) about the
reachability of the UE.
5\. The HSS reads data from the EPS-UDR to see whether an IMS-AS has
subscribed do reachability notification.
6\. The HSS acknowledges step 4.
7\. The UDM updates the 5GS-UDR to delete the EE-Subscription(s).
8\. The HSS notifies the IMS-AS about UE reachability for IP.
NOTE: An SBA capable IMS-AS receives the notification from HSS using the
Nhss_ImsSDM service as defined in 3GPP TS 23.228 [7]. Otherwise the IMS-AS
receives the notification via a Diameter Sh-PNR/PNA command.
9\. The IMS-AS acknowledges step 8.
10\. The HSS updates the EPS-UDR to delete the IMS-AS\'s subscription.
### 5.4.6 IMEI Retrieval
A pre-requisite for the retrieval of the IMEI when requested by an IMS-AS is
that the IMEI for a given UE stored in HSS and UDM is always synchronized.
This is, when the HSS detects that the IMEI for a UE changes (e.g. during an
Update Location in EPS), the HSS informs the UDM about the IMEI change which
stores the new IMEI accordingly. Similarly, when UDM detects that the IMEI
changes, the UDM informs the HSS about the IMEI change which stores the new
IMEI accordingly.
This allows that the retrieval of the IMEI for a given UE requested by an IMS-
AS from HSS via Sh can be executed locally by HSS without the need of
additional interworking between the HSS and the UDM
Figure 5.4.6-1 shows the scenario where the HSS receives an IMEI retrieval
request from the IMS-AS for a subscriber who has a 5GC subscription.
Figure 5.4.6-1: IMEI retrieval request for 5G subscriber
Steps 1 to 4 are executed when the HSS detects a change in the IMEI for a
given UE (IMSI).
1\. The HSS receives a request from the MME including an IMEI for the UE (e.g.
Update Location Request or Notify Request).
2\. The HSS detects that the IMEI received in the request is different from
the previously stored in the EPS-UDR. The HSS stores the new IMEI in the EPS-
UDR.
3\. The HSS informs the UDM about the new PEI (IMEI) using the
Nudm_UECM_Update service operation.
4\. The UDM stores the new PEI for the UE.
Steps 5 to 8 are executed when the UDM detects a change in the PEI for a given
UE (SUPI).
5\. The UDM receives a request from the AMF including a PEI for the UE (e.g.
Nudm_UECM_Registration/Update).
6\. The UDM detects that the PEI received in the request is different from the
previously stored in the 5GS-UDR. The UDM stores the new IMEI in the 5GS-UDR.
7\. The UDM informs the HSS about the new IMEI using the Nhss_UECM_Update
service operation.
8\. The HSS stores the new IMEI for the UE.
Steps 9 to 11 are executed when the HSS receives an IMEI retrieval request
from the IMS-AS for a subscriber who has a 5GC subscription.
9\. The HSS receives a request from IMS-AS to retrieve the IMEI for a UE.
10\. The HSS reads the IMEI stored in the EPS-UDR.
11\. The HSS replies to the IMS-AS with the users IMEI. Since the IMEI for the
UE has been sinchronized between HSS and UDM at every IMEI/PEI change event as
in steps 1 to 4 or 5 to 8, the HSS can reply to the IMS-AS without any
additional interworking with the UDM.
### 5.4.7 SRVCC: IMS AS obtaining SRVCC data
Figure 5.4.7-1 shows the scenario where the HSS communicates with the IMS-AS
in support of (5G) SRVCC for a subscriber who has a 5GC subscription. An
operator shall be able to control whether the interaction between HSS and UDM
is performed based on local policy.
Figure 5.4.7-1: IMS AS obtaining data related to (5G) SRVCC and updating STN-
SR
1\. As described in 3GPP TS 23.237 [13], the IMS-AS sends Sh-Pull message to
the UDM/HSS in order to know the SRVCC capability indicated by the UE in the
EPS, and to retrieve the STN-SR stored in the UDM/HSS.
2\. The HSS reads STN-SR and UE SRVCC Capability data from the EPS-UDR. The
HSS reads the Câ€‘MSISDN bound to the IMS Private User Identity.
3\. The HSS, based on operator policy, may query UDM to retrieve SRVCC
parameters. The HSS uses the Nudm_MT_Provide5GSRVCCInfo service operation to
retrieve the STN-SR and the UE SRVCC Capability indicated by the UE in the 5GS
(see 3GPP TS 23.008 [14]).
4\. The UDM reads the STN-SR and this UE SRVCC Capability data from the 5GS-
UDR.
5\. The UDM provides the C-MSISDN, STN-SR and UE SRVCC Capability data to the
HSS.
6\. The HSS provides a single Câ€‘MSISDN, a single STN-SR and UE SRVCC
Capability data to the IMS-AS, as follows:
\- if the Câ€‘MSISDN from the HSS and the Câ€‘MSISDN from the UDM are empty, the
HSS indicates an empty Câ€‘MSISDN to the SCC AS. The HSS indicates a non-empty
Câ€‘MSISDN, otherwise;
\- if the STN-SR from the HSS or the STN-SR from the UDM is empty, it
indicates the user is not subscribed to (5G) SRVCC. If the HSS and the UDM
indicate the user is not subscribed to (5G) SRVCC, the HSS indicates an empty
STN-SR to the SCC AS. The HSS indicates a non-empty STN-SR, otherwise.
### 5.4.8 SRVCC: IMS AS obtaining SRVCC data -- HSS using Nudr
When the HSS receives an S6a-AIR from the MME, it may check (by means of an
EPC-UDR query) whether the subscriber has a 5G subscription. If so, the HSS
can use of the Nudr_DM_Query Get service operation to retrieve the 5G SRVCC
subscription data from the 5GS UDR.
Figure 5.4.8-1 shows the scenario where the HSS communicates with the IMS-AS
in support of (5G) SRVCC for a subscriber who has a 5GC subscription. An
operator shall be able to control whether the interaction between HSS and 5GS-
UDR is performed based on local policy.
Figure 5.4.8-1: IMS AS obtaining data related to (5G) SRVCC -- HSS using the
Nudr
1\. As described in 3GPP TS 23.237 [13], the IMS-AS sends Sh-Pull message to
the UDM/HSS in order to know the SRVCC capability indicated by the UE in the
EPS, and to retrieve the STN-SR stored in the UDM/HSS.
2\. The HSS reads STN-SR and this UE SRVCC Capability data from the EPS-UDR.
The HSS reads the Câ€‘MSISDN bound to the IMS Private User Identity.
3\. The HSS, based on operator policy, may query 5G-UDR to retrieve SRVCC
parameters. The HSS uses the Nudr_DM_Query service operation to retrieve the
STN-SR and the UE SRVCC Capability indicated by the UE in the 5GS (see 3GPP TS
23.008 [14]) from the 5GS-UDR.
4\. The HSS provides a single Câ€‘MSISDN, a single STN-SR and UE SRVCC
Capability data to the IMS-AS, as follows:
\- if the Câ€‘MSISDN from the HSS and the Câ€‘MSISDN from the UDM are empty, the
HSS indicates an empty Câ€‘MSISDN to the SCC AS. The HSS indicates a non-empty
Câ€‘MSISDN, otherwise;
\- if the STN-SR from the HSS or the STN-SR from the UDM is empty, it
indicates the user is not subscribed to (5G) SRVCC. If the HSS and the UDM
indicate the user is not subscribed to (5G) SRVCC, the HSS indicates an empty
STN-SR to the SCC AS. The HSS indicates a non-empty STN-SR, otherwise.
### 5.4.9 SRVCC: IMS AS updating STN-SR
Figure 5.4.9-1 shows the scenario where the IMS-AS updates the STN-SR at the
HSS. An operator shall be able to control whether the interaction between HSS
and UDM is performed based on local policy.
Figure 5.4.9-1: Updating STN-SR
1\. As described in 3GPP TS 23.237 [13], the IMS-AS can use Sh-Update to
provide the STN-SR received from the ATCF to the UDM/HSS in order to replace
the STN-SR at the UDM/HSS.
2\. While this updated STN-SR is a transient value and subject to the user
being subscribed to SRVCC, the HSS can update the STN-SR at the EPS-UDR. If
the user is subscribed to SRVCC, the HSS updates the STN-SR at the EPS-UDR and
at the MME/SGSN (not shown).
3\. The HSS, based on operator policy, may update UDM: the HSS updates the
STN-SR at the UDM.
4\. While this updated STN-SR is a transient value, the UDM can update the
STN-SR at the 5GS-UDR using Nudr_DM_Update. The UDM updates the STN-SR at the
AMF using Nudm_SDM_Notification service operation (not shown).
5\. The UDM responds to the request to update the STN-SR.
6\. The HSS responds by sending Sh-Update Response message to the IMS AS.
## 5.5 SMS Support
### 5.5.1 General
Potential MT-SMS target nodes in the EPS are the MME/MSC and the SGSN
registered at the HSS, while in 5GS MT-SMS target nodes are the 3GPP-SMSF and
the Non3GPP-SMSF registered at the UDM. For the role of SMS-Router and IP-SM-
GW see 3GPP TS 23.040 [12].
### 5.5.2 MT-SMS Routing Information Retrieval
Figure 5.5.2-1 shows the interaction when the SMS-GMSC retrieves routing
information from the HSS for MT-SMS delivery.
Figure 5.5.2-1: SMS Routing Info Retrieval
1\. The HSS receives a request for routing information from the SMS-GMSC via
MAP or S6c.
2\. The HSS queries the EPS-UDR via Ud to read the registered MME/MSC, the
registered SGSN, and the UE-not-reachable flags for SMS in MME/MSC, SGSN and
UDM.
3\. If the UE-not-reachable flag for SMS in UDM is not set and unless the user
is known not to be registered in 5GC, the HSS retrieves the registered SMSF
addresses for 3GPP and non-3GPP accesses (if any) from the UDM.
NOTE: This interaction is achieved in the current release by means of the
Nudm_UECM_SendRoutingInfoForSM service operation; however, for backwards-
compatibility reasons, HSS can also use the Nudm_UECM_Get service operation,
as defined in pre-Rel17 versions of this specification.
4-5. The UDM retrieves the requested information from the 5GS-UDR.
6\. The UDM forwards the retrieved addresses to the HSS if any. If the UE is
not reachable for MT-SMS in 5GS for any access type (e.g. there is no SMSF
registered for the UE or SMSF registration exists but UE is known not to be
reachable in 5GS based on URRP flag), the UDM provides a negative response
(Absent Subscriber SM) to the HSS.
If SMS over NAS is not allowed for the user in 5GS based on subscription data,
e.g. SMS teleservice is not provisioned or SMS is barred, the UDM indicates in
the response to the HSS the corresponding error condition.
7\. The HSS returns the relevant MT-SMS target node addresses registered in
HSS and/or UDM to the SMS-GMSC and the procedure is terminated.
Otherwise, if there is no MT-SMS target node address registered in HSS nor in
UDM, a negative response (Absent Subscriber SM) is sent to the SMS-GMSC and
the procedure continues with steps 8 to 11.
8\. The HSS includes the SMSC address to the Message Waiting Data (MWD) stored
in the EPS-UDR and informs the SMSC as defined in TS 23.040 [12]. The relevant
UE-not-reachable flags are set in the EPS-UDR.
If SMS is not allowed for the user in 5GS according to subscription data as
indicated in step 6, steps 9 to 11 are not executed so that the HSS does not
subscribe to notifications about reachability for SMS in the UDM, and the
procedure is terminated.
9\. The HSS subscribes in UDM to be notified when the UE becomes reachable for
SMS (i.e. when the UE gets in radio contact with the AMF while an SMSF
actually is registered, or when an SMSF gets registered) by using the
Nudm_EE_Subscribe service operation (SUPI, UE Reachability for SMS event) as
defined in 3GPP TS 23.502 [5].
10\. The UDM stores the EE-subscription (Reachability for SMS) in the 5G-UDR.
11\. The UDM acknowledges the subscription to the HSS.
### 5.5.3 MT-SMS Delivery Failure
Figure 5.5.3-1 shows the interaction when the SMS-GMSC sends Report-SM-
Delivery-Status to the HSS.
Figure 5.5.3-1: MT-SMS Delivery Failure
1\. The HSS receives a Report-SM-Delivery-Status from the SMS-GMSC indicating
the MT-SMS target nodes at which MT-SMS delivery was unsuccessful.
2-3. The HSS reads and updates the Message Waiting Data stored in the EPS-UDR.
4\. The HSS acknowledges the receipt of the delivery status to the SMS-GMSC.
5\. If during step 3 the UE-not-reachable flag for UDM was modified from false
to true, the HSS subscribes to notification on UE-Reachability for SMS at the
UDM, using the Nudm_EE_Subscribe service operation as defined in 3GPP TS
23.502 [5].
6-7. The UDM checks that the UE is registered in an AMF and SMSF for 3GPP and
non-3GPP accesses. The UDM then queries the 5GS-UDR to see whether the UE-
Reachability event has already been subscribed at the registered AMF(s) (i.e.
whether URRP-AMF flag is set).
8-9. If not already subscribed, the UDM subscribes to UE-Reachability
notification at the AMF(s) using the Namf_EE service.
NOTE: As defined in 3GPP TS 23.502 [5], the UDM can trigger UE Reachability
Notification Request procedure with two different AMFs for a UE which is
connected to 5G Core Network over 3GPP access and non-3GPP access
simultaneously.
10-11. The UDM stores the received EE-Subscription in the 5GS-UDR and if steps
8-9 were performed, the UDM sets the relevant URRP-AMF flags in the 5GS-UDR.
12\. The UDM acknowledges the subscription to the HSS.
### 5.5.4 SMS Alerting
Figure 5.5.4-1 shows the interaction when the UE becomes available.
Figure 5.5.4-1: SMS Alerting
1\. The UDM receives a Notification from the AMF or an SMSF Registration.
2-3. The UDM queries the 5GS-UDR to see whether any NF (e.g. the HSS) has
subscribed to notifications on UE-reachability for SMS events.
4\. The UDM acknowledges the message received in step 1.
5\. If the HSS has subscribed to UE reachability for SMS notification, the UDM
notifies the HSS as described in 3GPP TS 23.502 [5].
6-7. The UDM updates (clears) the relevant reachability flag. And, if the HSS
has been notified in step 5, the UDM also deletes the (one-time) EE-
subscriptions of UE reachability for SMS in the 5GS-UDR.
Steps 8 to 11 are skipped if the HSS has not been notified in step 5.
8\. The HSS reads Message Waiting Data from the EPS-UDR.
9-10. The HSS sends Alert-SC to all SMS-GMSCs stored in the MWD.
11\. The HSS removes the SMS-GMSCs from the MWD stored in the EPS-UDR and
clears the relevant UE-not-reachable flags from the EPS-UDR.
12\. The HSS acknowledges receipt of the Notification to the UDM.
### 5.5.5 MT-SMS Routing Information Retrieval Over Nudr
Figure 5.5.5-1 shows the interaction when the SMS-GMSC retrieves routing
information from the HSS for MT-SMS delivery when the HSS uses the Nudr SBI.
Figure 5.5.5-1: SMS Routing Info Retrieval over Nudr
1\. The HSS receives a request for routing information from the SMS-GMSC via
MAP or S6c.
2\. The HSS queries the EPS-UDR via Ud to read the registered MME/MSC, the
registered SGSN and the UE-not-reachable flags for MME/MSC, SGSN and UDM.
3-4. If the UE-not-reachable flag for UDM is not set and unless the user is
known not to be registered in 5GC, the HSS retrieves the registered SMSF
addresses for 3GPP and non-3GPP accesses (if any) from the 5GS-UDR.
5\. The HSS returns the relevant MT-SMS target node addresses registered in
HSS and/or UDM to the SMS-GMSC and the procedure is terminated.
Otherwise, if there is no MT-SMS target node address registered in HSS nor in
UDM, a negative response (Absent Subscriber SM) is sent to the SMS-GMSC and
the procedure continues with steps 8 to 11 in figure 5.5.2-1.
### 5.5.6 Support for SMS over IP
#### 5.5.6.1 General
In deployment scenarios where 2G/3G/4G accesses are available, SMS over IP is
supported as described in 3GPP TS 23.204 [18], and the interactions between
HSS and UDM are those defined in clauses 5.5.2, 5.5.3 and 5.5.4.
For MT-SMS delivery over 5G NAS in deployment scenarios where support for SMS
over IP is also required but 2G/3G/4G accesses are not supported, the MAP-C
and/or Diameter S6c refence points with the SMS-GMSC and the MAP-J and/or
Diameter S6c reference points with the IP-SM-GW are exposed by the UDM. The
UDM and the HSS (IMS) need to interact for the registration of the IP-SM-GW
address as defined in clause 5.5.6.2. Clauses 5.5.6.3 and 5.5.6.4 define the
interworking between the UDM and the HSS (IMS) during delivery failure and
alert procedures.
#### 5.5.6.2 IP-SM-GW registration and SMS routing information retrieval in
5GC only deployments
Figure 5.5.6.2-1 shows the interaction for the registration of the IP-SM-GW
address in the UDM and subsequent SMS routing information retrieval.
Figure 5.5.6.2-1: IP-SM-GW registration in UDM and SMS routing info retrieval
in 5GC only deployments
1\. The IP-SM-GW registers its address in HSS (IMS) via Sh as defined in 3GPP
TS 23.204 [18]. If the EPS-UDR is used, the HSS (IMS) stores the IP-SM-GW
address in the EPS-UDR.
2\. The HSS forwards the IP-SM-GW registration to the UDM using a
Nudm_UECM_IPSMGWRegistration request. The request includes the address of the
IP-SM-GW to be registered in the UDM. If the 5GS-UDR is used, the UDM stores
the IP-SM-GW address in the 5GS-UDR.
3\. The UDM confirms the IP-SM-GW registration with a successful
Nudm_UECM_IPSMGWRegistration response. After successful registration of the
IP-SM-GW address, the UDM checks whether message waiting data are stored and
alerts all SCs using procedures described in 3GPP TS 23.204 [18].
4\. The UDM receives a request for routing information from the SMS-GMSC via
MAP or Diameter. If the 5GS-UDR is used, the UDM queries the 5GS-UDR to read
the registered SMSF and/or IP-SM-GW, if any. Routing information is provided
to SMS-GMSC from IP-SM-GW or UDM.
The options shown are based on the options for MT SMS procedure described in
clause 6.4 of 3GPP TS 23.204 [18], considering a 5GC only deployment where UDM
is present and HLR/HSS serving 2G/3G/4G accesses is not deployed. Steps 4a-4c
correspond to 3a-3c; step 4d corresponds to 3d; and steps 4e-4f correspond to
3e-3f, respectively, as shown in figure 6.4 of 3GPP TS 23.204 [18].
Figure 5.5.6.2-2 shows the interaction for the deregistration of the IP-SM-GW
address in the UDM.
Figure 5.5.6.2-2: IP-SM-GW deregistration in UDM and SMS routing info
retrieval in 5GC only deployments
1\. The IP-SM-GW deregisters its address in HSS (IMS) via Sh as defined in
3GPP TS 23.204 [18]. If the EPS-UDR is used, the HSS (IMS) removes the IP-SM-
GW address from the EPS-UDR.
2\. The HSS forwards the IP-SM-GW deregistration request to the UDM using a
Nudm_UECM_IPSMGWDeregistration request. If the 5GS-UDR is used, the UDM
removes the IP-SM-GW address from the 5GS-UDR.
3\. The UDM confirms the IP-SM-GW deregistration with a successful
Nudm_UECM_IPSMGWDeregistration response.
4 - 5. If the UDM receives a request for routing information from the SMS-GMSC
via MAP or Diameter, the UDM checks if there is an IP-SM-GW address registered
for the UE. If the 5GS-UDR is used, the UDM queries the 5GS-UDR to read the
registered SMSF and/or IP-SM-GW, if any. If an IP-SM-GW address is not
present, the UDM follows the MT SMS procedures defined in clause 4.13.3 of
3GPP TS 23.502 [5] and 3GPP TS 23.040 [17].
#### 5.5.6.3 MT SMS delivery failure in 5GC only deployments
Figure 5.5.6.3-1 shows the interactions for the unsuccessful MT SMS delivery
case in a 5GC only deployment requiring SMSoIP.
Figure 5.5.6.3-1: MT SMS delivery failure in 5GC only deployments supporting
SMSoIP
1 - 7. The message delivery fails after the IPâ€‘SMâ€‘GW has tried all selectable
domains, and the IP-SM-GW forwards the received unsuccessful Delivery report
to the SMSâ€‘GMSC, as described in steps 1-16 in clause 6.5a of 3GPP TS 23.204
[18].
8\. The IP-SM-GW sends a Report SM Delivery Status message to the UDM with
accurate results from different domains. If the 5GS-UDR is used, the UDM
records the corresponding MWD in the 5GS-UDR.
9\. The IP-SM-GW subscribes to the HSS (IMS) for a one-time notification of
the UE being reachable again.
10\. The HSS (IMS) records the subscription and subscribes to notification on
UE Reachability for SMS over IP event at the UDM, using the Nudm_EE_Subscribe
service operation.
11 - 12. The UDM checks whether UE Reachability has already been subscribed at
the registered AMF(s) (i.e. whether URRP-AMF flag is set), querying 5GS-UDR if
applicable. If not already subscribed, the UDM subscribes to UE Reachability
notification at the AMF(s) using the Namf_EE service.
If 5GS-UDR is used, the UDM stores the received EE-Subscription from HSS (IMS)
in the 5GS-UDR, and if subscription to AMF is performed in this step, the UDM
sets the relevant URRP-AMF flag in the 5GS-UDR.
13\. The UDM acknowledges the subscription of the HSS (IMS).
14\. The SMS-GMSC sends a Report SM Delivery Status message to the UDM. The
UDM shall ignore the information provided in this report.
#### 5.5.6.4 Alert Service Centre in 5GC only deployments
Figure 5.5.6.4-1 shows the interactions when the UE becomes available in a 5GC
only deployment requiring SMSoIP.
Figure 5.5.6.4-1: Alert Service Centre procedure in 5GC only deployments
supporting SMSoIP
The steps described below are based on the procedure described in clause 6.5b
of 3GPP TS 23.204 [18], considering a 5GC only deployment.
1\. MT SMS procedure is unsuccessful as described in clause 5.5.6.3.
2\. At any time after the unsuccessful SM termination procedure, the UE may
become available due to registration in IMS (step 2a). After the IMS
registration is finished, the procedure continues as described in step 3.
At any time after the unsuccessful SM termination procedure, the UDM can
receive a notification from AMF indicating that the UE is reachable again or
an AMF registration (step 2b). The UDM checks whether any NF (e.g. the HSS)
has subscribed to notification on UE Reachability for SMS over IP events,
querying 5GS-UDR if applicable. If the HSS has subscribed to such
notification, the UDM notifies the HSS (step 2c). As the IP-SM-GW has
subscribed to the event of UE being reachable again as described in clause
5.5.6.3, the HSS shall notify the IP-SM-GW (step 2d). If the UE is already
registered in IMS, the IP-SM-GW shall then send a Ready for SM message to the
UDM (step 2e) and the procedure continues as described in step 3. Otherwise,
the IP-SM-GW discards the notification message.
3\. The UDM checks the user\'s MWD. If MWD is not null, the UDM sends an Alert
Service Centre message to the SMSâ€‘IWMSC.
4\. The SMSâ€‘IWMSC forwards the Alert Service Centre procedure to the SMSâ€‘SC.
5\. Upon receipt of the Alert Service Centre message, the SMSâ€‘SC re-attempts
to send the stored Short Message.
## 5.6 Common Network Exposure Scenarios
### 5.6.1 General
As specified in 3GPP TS 23.501 [2] and 3GPP TS 23.502 [5], a combined SCEF+NEF
can configure monitoring events applicable to both EPC and 5GC using only 5GC
procedures towards UDM. In this case, the SCEF+NEF indicates that the
monitoring event is also applicable to EPC together with the SCEF identity,
i.e. the event must be reported both by 5GC and EPC.
If the HSS and UDM are deployed as separate network entities as defined in
this specification, UDM uses HSS services to configure the monitoring event in
EPC. For events requiring reporting from MME towards SCEF or HSS, the UDM
requests the configuration of the monitoring event in the EPC to the HSS as
defined in clause 5.6.2.
Common exposure scenarios are applicable for users having both EPC and 5GC
subscription.
The status of specific monitoring events that are detected locally at the HSS
and UDM (e.g. IMEI/PEI change, roaming status change) is kept synchronized
between UDM and HSS as defined in clause 5.6.3 avoiding the need to configure
those events in UDM and HSS.
### 5.6.2 Configuration of Monitoring Events in MME
Figure 5.6.2-1 shows the scenario where the UDM receives a request from a
combined SCEF+NEF to configure a monitoring event that needs to be reported by
EPC (e.g. location change).
Figure 5.6.2-1: Configuration of Monitoring Events in MME
1\. The UDM receives a request from a combined SCEF+NEF to configure a
monitoring event for a UE. The request indicates that the subscription applies
also to EPC and the monitoring event is to be reported by the MME (e.g.
location change). The request includes the notification addresses of both the
NEF and the SCEF.
2\. The UDM configures the monitoring event for the UE in 5GC. If the 5GS UDR
is used, the UDM stores the configuration of the monitoring event for the UE
in the 5GS-UDR. The UDM contacts the corresponding NF within the 5GC (e.g.
AMF, SMF) as required by the monitoring event.
3\. Unless the subscription information related to the UE indicates that the
UE has no EPC subscription data, then the UDM requests the HSS to configure
the monitoring event for the UE in EPC using a Nhss_EventExposure_Subscribe
operation. In addition to the UDM notification address, the UDM provides the
SCEF notification address (i.e. SCEF Id).
4\. The HSS configures the monitoring event for the UE in EPC using the
procedures defined in 3GPP TS 23.682 [16].
5\. The HSS replies to the UDM with the result of the subscription request.
6\. The UDM replies to the combined SCEF+NEF including confirmation that the
subscription was also successful in EPC domain.
7\. At a later stage, the monitoring event is detected for the UE in the EPC
domain. The event may be detected at the MME (e.g. location change) or at the
HSS (e.g. UE reachability for SMS).
8\. The monitoring event is reported to the SCEF+NEF. The MME notifies the
event as defined in 3GPP TS 23.682 [16] by using the SCEF notification address
provided by the HSS in step 4, if applicable. If the monitoring event is
detected at the HSS or reported by the MME to the HSS, the HSS notifies the
monitoring event to UDM using the Nhss_EE_Notify service operation. The UDM
then notifies NEF using the Nudm_EE_Notify service operation.
NOTE: The notification of monitoring events from HSS (e.g. reachability for
SMS) using SBA interfaces supersedes the option of HSS using diameter S6t.
Only the events reported by MME will keep diameter T6a interface towards SCEF.
### 5.6.3 Synchronization of Status of Monitoring Event between HSS and UDM
The status of some specific monitoring events that are detected locally at the
HSS and UDM (e.g. IMEI(SV)/PEI change, roaming status change) is kept
synchronized between UDM and HSS as defined in this clause. This is, when the
HSS detects e.g. that the IMEI(SV) for a UE changes (e.g. during an Update
Location in EPS), the HSS informs the UDM about the IMEI(SV) change which
stores the new IMEI(SV)/PEI accordingly and when UDM detects e.g. that the
IMEI(SV)/PEI for a UE changes (e.g. during an AMF registration procedure in
5GC), the UDM informs HSS about the IMEI(SV)/PEI change as described in
section 5.4.6.
HSS and UDM can store the last IMEI(SV)/PEI and Roaming Status even when the
UE is not currently located/registered in EPS or 5GC access respectively. If
the UE has never registered in 5GC and last PEI is not stored, UDM shall
notify HSS about the new PEI received and retrieve the last IMEI stored in HSS
to notify the change of PEI/IMEI event when applicable.
NOTE: The synchronization of the status of these monitoring events shall be
enabled bled in both HSS and UDM based on local policieswhenever common
exposure is supported or last known IMEI is required in HSS/UDM.
This allows that the subscriptions to these specific monitoring events are
applied in both domains when the PEI type is IMEI(SV). The UDM is capable of
notifying these events taking place in EPS to the combined SCEF+NEF using SBI
procedures.
Figure 5.6.3-1 shows the scenario where the UDM receives a request from a
combined SCEF+NEF to subscribe to a monitoring event in 5GC and EPC that is
reported by the UDM.
Figure 5.6.3-1: Synchronization of Status of Monitoring Events between HSS and
UDM
1\. The UDM receives a request from a combined SCEF+NEF to configure a
monitoring event for a UE. The request indicates that the subscription applies
also to EPC (e.g. IMEI(SV)/PEI change) and UDM is expected to report the
event.
2\. The UDM stores in the 5GS-UDR the monitoring event together with the
notification address (e.g., the NEF notification address) of the combined
SCEF+NEF.
3\. The UDM replies to the combined SCEF+NEF including a confirmation that the
configuration of the event was also successful in EPC domain.
NOTE: A UDM that supports interworking with EPC relies on the HSS to
synchronize the status of these monitoring events in the EPC domain with the
UDM (i.e. the UDM does not need to subscribe to the monitoring event towards
the HSS) for UEs that have subscription data in EPC and 5GC.
4\. At a later stage, the HSS detects the event (e.g. IMEI(SV) change) for the
UE in the EPC domain (e.g. during an Update Location Request procedure).
5\. The HSS synchronizes with the UDM about the event using the
Nudm_UECM_Update service operation.
6\. The UDM stores the information received from HSS (e.g. a new PEI for the
UE) in the 5GS-UDR and checks if a related subscription to the related
monitoring event exists.
7\. The UDM notifies the NEF accordingly.
8\. Alternatively, the monitoring event may be detected by the UDM.
9\. The UDM notifies the NEF accordingly.
10\. The UDM synchronizes with the HSS about the event using the
Nhss_UECM_Update service operation.
11\. The HSS stores the status of the monitoring event received from the UDM
in the EPS-UDR.
# 6 Network Function Service procedures
## 6.1 HSS Services
### 6.1.1 General
The following table illustrates the HSS Services.
Table 6.1.1-1: NF services provided by HSS
NF service Service Operations Operation Semantics Example Consumer(s)
* * *
UE Authentication Get Request/Response UDM UECM SNDeregistration
Request/Response UDM Update Request/Response UDM SDM Get Request/Response UDM
Subscribe Subscribe/Notify UDM Unsubscribe  
Notify  
EE Subscribe Subscribe/Notify UDM Unsubscribe  
Notify
### 6.1.2 Nhss_UEAuthentication service
#### 6.1.2.1 Nhss_UEAuthentication_Get service operation
**Service operation name:** Nhss_UEAuthentication_Get
**Description:** Requester NF gets the authentication vector from HSS. For AKA
based authentication, this operation can be also used to recover from
synchronization failure situations.
**Inputs, Required:** IMSI, authentication method, serving network name.
**Inputs, Optional:** Synchronization Failure indication and related
information (i.e. RAND/AUTS).
**Outputs, Required:** Authentication vector.
**Outputs, Optional:** None.
### 6.1.3 Nhss_UECM service
#### 6.1.3.1 Nhss_UECM_SNDeregistration service operation
**Service operation name:** Nhss_UECM_SNDeregistration.
**Description:** The NF consumer requests the HSS to initiate cancel location
to the Serving Node registered in HSS serving the UE in EPS and/or PS, if any.
**Inputs, Required:** IMSI, deregistration reason.
**Inputs, Optional:** None.
**Outputs, Required:** Result Indication.
**Outputs, Optional:** None.
#### 6.1.3.2 Nhss_UECM_Update service operation
**Service operation name:** Nhss_UECM_Update.
**Description:** The NF consumer informs the HSS about an update in the UE
Context (e.g. a change in the IMEI).
**Inputs, Required:** IMSI.
**Inputs, Optional:** IMEI(SV), serving PLMN.
**Outputs, Required:** Result Indication.
**Outputs, Optional:** None.
### 6.1.4 Nhss_SDM service
#### 6.1.4.1 Nhss_SDM_Get service operation
**Service operation name:** Nhss_SDM_Get
**Description:** The consumer NF gets the subscriber data indicated by the
requested data type from HSS. In this release, only the PGW-C+SMF FQDN for
S5/S8/S2b interface information is supported as requested data type.
**Inputs, Required:** IMSI, requested data.
**Inputs, Optional:** None.
**Outputs, Required:** The consumer NF gets the requested subscription data
**Outputs, Optional:** None.
#### 6.1.4.2 Nhss_SDM_Notification service operation
**Service or service operation name: N** hss_SDM_Notification
**Description:** The HSS notifies NF consumer of the updates of the subscriber
data indicated by the \"subscription data Type\" input. In this release, only
the PGW-C+SMF FQDN for S5/S8/S2b interface information is supported as
subscription data type.
**Inputs, Required:** IMSI, Subscription data type(s).
**Inputs, Optional:** None _._
**Outputs, Required:** Result Indication.
The HSS invokes this service operation under the following cases:
\- When the PGW-C+SMF FQDN for S5/S8/S2b interface information is updated at
the HSS, the updated information is notified to the NF consumer that has
subscribed for the specific subscription data type to be notified.
**Outputs, Optional:** None.
#### 6.1.4.3 Nhss_SDM_Subscribe service operation
**Service operation name:** Nhss_SDM_Subscribe
**Description:** The NF consumer subscribes for updates to the subscriber data
indicated by the \'subscription data type\' input. The HSS shall check the
requested consumer is authorized to subscribe to requested updates. In this
release, only the PGW-C+SMF FQDN for S5/S8/S2b interface information is
supported as subscription data type.
**Inputs, Required:** IMSI, Subscription data type(s).
**Inputs, Optional:** None.
**Outputs, Required:** None.
**Outputs, Optional:** None.
#### 6.1.4.4 Nhss_SDM_Unsubscribe service operation
**Service operation name:** Nhss_SDM_Unsubscribe
**Description:** The NF consumer unsubscribes from updates to the subscriber
data indicated by the \'subscription data type\' input. In this release, only
the PGW-C+SMF FQDN for S5/S8 interface information is supported as
subscription data type.
**Inputs, Required:** IMSI, Subscription data type(s).
**Inputs, Optional:** None.
**Outputs, Required:** None.
**Outputs, Optional:** None.
### 6.1.5 Nhss_EE service
#### 6.1.5.1 Nhss_EE_Subscribe service operation
**Service operation name:** Nhss_EE_Subscribe.
**Description:** The NF consumer request the HSS to subscribe to notifications
for monitoring events as described in 3GPP TS 23.682 [16] (e.g. location
change).
**Inputs, Required:** IMSI, monitoring event type(s), notification address.
**Inputs, Optional: -**
**Outputs, Required:** Result Indication, Subscription ID.
**Outputs, Optional:** None.
#### 6.1.5.2 Nhss_EE_Unsubscribe service operation
**Service operation name:** Nhss_EE_Unsubscribe.
**Description:** The NF consumer request the HSS to delete the subscription of
a monitoring event.
**Inputs, Required:** Subscription ID.
**Inputs, Optional: -**
**Outputs, Required:** Operation execution result indication _._
**Outputs, Optional:** None.
#### 6.1.5.3 Nhss_EE_Notify service operation
**Service operation name:** Nhss_EE_Notify.
**Description:** The HSS reports the monitoring event to the consumer that has
previously subscribed.
**Inputs, Required:** Event ID, Notification Correlation Information, time
stamp.
**Inputs, Optional:** Event specific parameters list.
**Outputs, Required:** None _._
**Outputs, Optional:** None.
## 6.2 UDM Services
### 6.2.1 General
The following table illustrates the UDM Services.
Table 6.2.1-1: NF services provided by UDM
NF service Service Operations Operation Semantics Example Consumer(s)
* * *
UECM P-CscfRestorationTrigger Request/Response HSS Get Request/Response HSS
AMFDeregistration Request/Response HSS Update Request/Response HSS MT
ProvideDomainSelectionInfo Request/Response HSS ProvideUserState
Request/Response HSS ProvideLocationInfo Request/Response HSS
Provide5GSRVCCInfo Request/Response HSS EventExposure Subscribe
Subscribe/Notify HSS Notify  
UEAU GetHssAv Request/Response HSS SDM Get Request/Response HSS Subscribe
Subscribe/Notify HSS Unsubscribe  
Notify  
PP Update Request/Response HSS
### 6.2.2 Nudm_UECM service operation
#### 6.2.2.1 Nudm_UECM_P-CscfRestorationTrigger service operation
**Service operation name:** Nudm_UECM_P-CscfRestorationTrigger
**Description:** Requester NF (HSS) triggers the UDM to notify all NFs (AMF,
SMF) that have previously subscribed to receive notifications for P-CSCF
restoration.
**Inputs, Required:** SUPI.
**Inputs, Optional:** None.
**Outputs, Required:** None.
**Outputs, Optional:** None.
#### 6.2.2.2 Nudm_UECM_Get service operation
See 3GPP TS 23.502 [5] clause 5.2.3.2.4.
#### 6.2.2.3 Nudm_UECM_AMFDeregistration service operation
**Service operation name:** Nudm_UECM_AMFDeregistration.
**Description:** The NF consumer requests the UDM to initiate deregistration
of the AMF serving the UE, if any.
**Inputs, Required: SUPI** , deregistration reason.
**Inputs, Optional:** None.
**Outputs, Required:** Result Indication.
**Outputs, Optional:** None.
#### 6.2.2.4 Nudm_UECM_Update service operation
See 3GPP TS 23.502 [5] clause 5.2.3.2.5.
### 6.2.3 Nudm_MT Service
#### 6.2.3.1 Nudm_MT_ProvideDomainSelectionInfo Service
**Service operation name:** Nudm_MT_ProvideDomainSelectionInfo
**Description:** Provides the UE information for terminating domain selection
of IMS voice in 5G to the consumer NF (HSS).
**Inputs, Required:** SUPI.
**Inputs, Optional:** None.
**Outputs, Required:** Success/Failure indication.
**Outputs, Optional:** Indication of supporting IMS voice over PS Session or
not, Time stamp of the last radio contact with the UE, Current RAT type.
#### 6.2.3.2 Nudm_MT_ProvideUserState service operation
**Service operation name:** Nudm_MT_ProvideUserState
**Description:** Provides the UE\'s 5GS PS User State to the consumer NF
(HSS).
**Inputs, Required:** SUPI.
**Inputs, Optional:** None.
**Outputs, Required:** Success/Failure indication.
**Outputs, Optional:** 5GS User State.
#### 6.2.3.3 Nudm_MT_ProvideLocationInfo service operation
**Service operation name:** Nudm_MT_ProvideLocationInfo
**Description:** Provides the UE\'s 5GS location information to the consumer
NF (HSS).
**Inputs, Required:** SUPI, Current Location Indicator, Serving Node
Indication, Local Time Zone Indication, and RAT-Type requested Indicator.
**Inputs, Optional:** None.
**Outputs, Required:** Success/Failure indication.
**Outputs, Optional:** 5GS location information.
#### 6.2.3.4 Nudm_MT_Provide5GSRVCCInfo Operation
**Service operation name:** Nudm_MT_ProvideSRVCCInfo
**Description:** Provides the UE PS to CS SRVCC capability for the UE to the
consumer NF (HSS).
**Inputs, Required:** SUPI.
**Inputs, Optional:** None.
**Outputs, Required:** Success/Failure indication.
**Outputs, Optional:** Indication of the UE supporting SRVCC capability or
not, If the 5GS supports 5G-SRVCC, an STN-SR and a C-MSIDSN.
### 6.2.4 Nudm_EE Service
#### 6.2.4.1 Nudm_EventExposure_Subscribe service operation
See 3GPP TS 23.502 [5] clause 5.2.3.5.2.
When used by the HSS in MT-SMS delivery failure scenarios (see clause 4.6.3)
the subscribe request shall be a one-time subscription for UE-reachability for
SMS and shall indicate whether it is applicable to 3GPP access, Non3GPP access
or both.
#### 6.2.4.2 Nudm_EventExposure_Notify service operation
See 3GPP TS 23.502 [5] clause 5.2.3.5.4.
When used by the HSS in SMS Alerting scenarios (see clause 4.6.4) the notify
request shall indicate whether it is applicable to 3GPP access or Non3GPP
access.
### 6.2.5 Nudm_UEAuthentication service
#### 6.2.5.1 Nudm_UEAuthentication_GetHssAv service operation
**Service operation name:** Nudm_UEAuthentication_GetHssAv
**Description:** Requester NF gets the authentication vector from UDM. For AKA
based authentication, this operation can be also used to recover from
synchronization failure situations.
**Inputs, Required:** SUPI, authentication method (e.g. EAP-AKA\', EPS-AKA,
IMS-AKA, GBA-AKA), serving network name.
**Inputs, Optional:** Synchronization Failure indication and related
information (i.e. RAND/AUTS).
**Outputs, Required:** Authentication vector.
**Outputs, Optional:** None.
### 6.2.6 Nudm_SDM service operations
#### 6.2.6.1 Nudm_SDM_Get service operation
See 3GPP TS 23.502 [5] clause 5.2.3.3.2.
#### 6.2.6.2 Nudm_SDM_Subscribe service operation
See 3GPP TS 23.502 [5] clause 5.2.3.3.4.
#### 6.2.6.3 Nudm_SDM_Unsubscribe service operation
See 3GPP TS 23.502 [5] clause 5.2.3.3.5.
#### 6.2.6.4 Nudm_SDM_Notify service operation
See 3GPP TS 23.502 [5] clause 5.2.3.3.3.
### 6.2.7 Nudm_PP service operations
#### 6.2.7.1 Nudm_PP_Update service operation
**Service operation name:** Update
**Description:** Removes, provides or modifies the STN-SR, CMSISDN, if the 5GS
support 5G-SRVCC.
**Inputs, Required:** None.
**Inputs, Optional:** SUPI, STN-SR, CMSISDN.
**Outputs, Required:** Success/Failure indication.
**Outputs, Optional:** None.
## 6.3 UDR Services
The UDM and optionally the HSS shall make use of the Nudr_DataRepository Query
service operations specified in 3GPP TS 23.502 [5] to retrieve Authentication
Subscription Data. If the subscribed authentication method is 5G_AKA or
EAP_AKA_PRIME, the AuthenticationSubscriptionData shall include an indicator
indicating whether for the identified subscriber authentication vector
generation is to be performed by the HSS.
#
# Foreword
This Technical Report has been produced by the 3rd Generation Partnership
Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
In the present document, modal verbs have the following meanings:
**shall** indicates a mandatory requirement to do something
**shall not** indicates an interdiction (prohibition) to do something
The constructions \"shall\" and \"shall not\" are confined to the context of
normative provisions, and do not appear in Technical Reports.
The constructions \"must\" and \"must not\" are not used as substitutes for
\"shall\" and \"shall not\". Their use is avoided insofar as possible, and
they are not used in a normative context except in a direct citation from an
external, referenced, non-3GPP document, or so as to maintain continuity of
style when extending or modifying the provisions of such a referenced
document.
**should** indicates a recommendation to do something
**should not** indicates a recommendation not to do something
**may** indicates permission to do something
**need not** indicates permission not to do something
The construction \"may not\" is ambiguous and is not used in normative
elements. The unambiguous constructions \"might not\" or \"shall not\" are
used instead, depending upon the meaning intended.
**can** indicates that something is possible
**cannot** indicates that something is impossible
The constructions \"can\" and \"cannot\" are not substitutes for \"may\" and
\"need not\".
**will** indicates that something is certain or expected to happen as a result
of action taken by an agency the behaviour of which is outside the scope of
the present document
**will not** indicates that something is certain or expected not to happen as
a result of action taken by an agency the behaviour of which is outside the
scope of the present document
**might** indicates a likelihood that something will happen as a result of
action taken by some agency the behaviour of which is outside the scope of the
present document
**might not** indicates a likelihood that something will not happen as a
result of action taken by some agency the behaviour of which is outside the
scope of the present document
In addition:
**is** (or any other verb in the indicative mood) indicates a statement of
fact
**is not** (or any other negative verb in the indicative mood) indicates a
statement of fact
The constructions \"is\" and \"is not\" do not indicate requirements.
# 1 Scope
The Technical Report studies and performs evaluations of potential
architecture enhancements to support Edge Computing (EC) in the 5G Core
network (5GC). Specifically, two objectives are included:
**Objective 1:** To study the potential system enhancements for enhanced Edge
Computing support, including:
\- Discovery of IP address of application server deployed in Edge Computing
environment;
NOTE 1: This study will not consider application layer solutions.
\- 5GC enhancements to support for seamless change of application server
serving the UE;
\- How to efficiently (with a low delay) provide local application servers
with information on e.g. the QoS condition of the data path;
\- Supporting for traffic steering in N6-LAN deployed in Edge Computing
environment, including support for end-user traffic sent to the central N6
interface to the DN after having been processed by local application
server(s);
NOTE 2: The output of the traffic steering related study should cover common
N6-LAN deployment, considering the additional features for N6-LAN deployed in
Edge Computing environment.
\- Supporting PSA change when the application server does not support
notifications of UE IP address change;
\- Supporting I-SMF insertion or reselection based on AF request to route the
traffic to application server deployed in Edge Computing environment.
**Objective 2:** To provide deployment guidelines for typical Edge Computing
use cases, e.g. URLLC, V2X, AR/VR/XR, UAS, 5GSAT, and CDN etc, including:
\- Deployment guidelines based on the existing Rel-15/16 Edge Computing
enablers, such as LADN, in TS 23.501 [2] and TS 23.502 [3];
\- Additional deployment guidelines related to any 5GS Edge Computing
enhancements defined as part of the first objective.
# 2 References {#references-1}
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or nonâ€‘specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
[1] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[2] 3GPP TS 23.501: \"System Architecture for the 5G System\".
[3] 3GPP TS 23.502: \"Procedures for the 5G System\".
[4] 3GPP TS 23.503: \"Policy and Charging Control Framework for the 5G
System\".
[5] 3GPP TR 23.758: \"Study on application architecture for enabling Edge
Applications\".
[6] 3GPP TS 22.261: \"Service requirements for the 5G system\".
[7] IETF RFC 7871: \"Client Subnet in DNS Queries\".
[8] IETF RFC 1546: \"Host Anycasting Service\".
[9] IETF RFC 1034: \"Domain Names - implementation and specification\".
[10] IETF RFC 7858: \"Specification for DNS over Transport Layer Security
(TLS)\".
[11] IETF RFC 8484: \"DNS Queries over HTTPS (DoH)\".
[12] 3GPP TS 23.558: \"Architecture for enabling Edge Applications\".
[13] IETF RFC 792: \"INTERNET CONTROL MESSAGE PROTOCOL\".
[14] IETF RFC 7157: \"IPv6 Multihoming without Network Address Translation\".
[15] IETF RFC 1122: \"Requirements for Internet Hosts - Communication Layer\".
[16] 3GPP TS 38.300: \"NR; Overall description; Stage-2\".
[17] IETF RFC 8311: \"Relaxing Restrictions on Explicit Congestion
Notification (ECN) Experimentation\".
[18] IETF draft draft-ietf-tsvwg-l4s-arch-06: \" Low Latency, Low Loss,
Scalable Throughput (L4S) Internet Service: Architecture\".
[19] IETF draft draft-ietf-tsvwg-ecn-l4s-id-10: \"Identifying Modified
Explicit Congestion Notification (ECN) Semantics for Ultra-Low Queuing Delay
(L4S)\".
[20] 3GPP TS 23.222: \"Common API Framework for 3GPP Northbound APIs\".
[21] 3GPP TS 33.122: \"Security aspects of Common API Framework (CAPIF) for
3GPP northbound APIs\".
[22] 3GPP TS 32.421: \"Subscriber and equipment trace; Trace concepts and
requirements\".
[23] 3GPP TS 28.552: \"Management and orchestration; 5G performance
measurements\".
[24] 3GPP TS 28.533: \"Management and orchestration; Architecture framework\".
[25] IETF RFC 7556: \"Multiple Provisioning Domain Architecture\".
[26] IETF RFC 6731: \"Improved Recursive DNS Server Selection for Multi-
Interfaced Nodes\".
[27] IETF RFC 8684: \"TCP Extensions for Multipath Operation with Multiple
Addresses\".
[28] IETF RFC 7681: \"Email Exchange of Secondary School Transcripts\".
[29] IETF RFC 4191: \"Default Router Preferences and More-Specific Routes\".
[30] 3GPP TS 29.503: \"5G System; Unified Data Management Services; Stage 3\".
[31] 3GPP TS 29.508: \"Session Management Event Exposure Service; Stage 3\".
[32] IETF RFC 4861: \"Neighbor Discovery for IP version 6 (IPv6)\".
[33] IETF RFC 8106: \"IPv6 Router Advertisement Options for DNS
Configuration\".
[34] IETF RFC 8094: \"DNS over Datagram Transport Layer Security (DTLS) \".
[35] 3GPP TS 32.422: \"Telecommunication management; Subscriber and equipment
trace; Trace control and configuration management\".
[36] 3GPP TS 28.622: \"Telecommunication management; Generic Network Resource
Model (NRM) Integration Reference Point (IRP); Information Service (IS)\".
[37] 3GPP TS 32.423: \"Telecommunication management; Subscriber and equipment
trace; Trace data definition and management\".
[38] 3GPP TS 33.501: \"Security architecture and procedures for 5G System\".
[39] 3GPP TS 38.413: \"NG-RAN; NG Application Protocol (NGAP)\".
[40] 3GPP TS 24.501: \"Non-Access-Stratum (NAS) protocol for 5G System (5GS);
Stage 3\".
[41] 3GPP TS 29.518: \"5G System; Access and Mobility Management Services;
Stage 3\".
[42] 3GPP TS 29.244: \"Interface between the Control Plane and the User Plane
nodes\".
[43] IETF RFC 8300: \"Network Service Header (NSH)\".
# 3 Definitions of terms and abbreviations
## 3.1 Terms
For the purposes of the present document, the terms given in TR 21.905 [1] and
the following apply. A term defined in the present document takes precedence
over the definition of the same term, if any, in TR 21.905 [1].
**Edge Application Server:** An Application Server resident in the Edge
Hosting Environment.
**Edge Hosting Environment:** An environment providing support required for
Edge Application Server\'s execution.
NOTE: The above terminologies are same as those used in TR 23.758 [5].
## 3.2 Abbreviations
For the purposes of the present document, the abbreviations given in TR 21.905
[1] and the following apply. An abbreviation defined in the present document
takes precedence over the definition of the same abbreviation, if any, in TR
21.905 [1].
EAS Edge Application Server
# 4 Architectural Assumptions and Principles
## 4.1 Architecture Assumptions
The following architecture figures show 5GS and Edge Application Servers
hosted in Edge Hosting Environment.
Figure 4.1-1: Accessing Edge Application Server with UL CL/BP
Figure 4.1-2: Accessing Edge Application Server without UL CL/BP
NOTE: These figures show the relationship between the EAS and 5GC defined in
TS 23.501 [2]. The application layer architecture for enabling edge computing
is out of the scope of this study.
## 4.2 Connectivity Models for Edge Computing
5GC supports at least following three connectivity models to enable Edge
Computing:
\- Distributed Anchor Point: the PDU Session anchor is moved far out in the
network, to the local sites. It is the same for all the user PDU session
traffic. Re-anchoring (SSC#2 and SSC#3) is used to optimize traffic routing
for all applications when moving long distances.
\- Session Breakout: The PDU session has a PDU Session anchor in a central
site and a PDU Session anchor in the local site. Only one of them provides the
IP anchor point. The Edge Computing application traffic is selectively
diverted to the local PDU Session anchor using UL Classifier or multihoming BP
technology. Re-anchoring of the local PDU Session anchor is used to optimize
traffic routing for locally diverted traffic as the user moves.
\- Multiple PDU sessions: Edge Computing applications use a specific PDU
session with the PDU Session anchor in the local site. The rest of
applications use a PDU Session with a central PDU Session anchor. The mapping
between applications and PDU sessions is steered by the URSP rules. Re-
anchoring (SSC#2 and SSC#3) is used to optimize traffic routing for Edge
Computing applications as the user moves.
These three connectivity models are illustrated in the figure below:
Figure 4.2-1: 5GC Connectivity Models for Edge Computing
## 4.3 General Requirements and Assumptions
The architecture for support of Edge Computing in 5GC shall be based on the
following architecture principles:
\- The architecture shall support scenarios where UEs are unaware of Edge
Computing.
\- The architecture shall support scenarios where UEs are aware of Edge
Computing.
\- The architecture shall support scenarios where applications are unaware of
Edge Computing.
\- The architecture shall support scenarios where applications are aware of
Edge Computing.
NOTE: Different features and optimisation may apply if UEs and/or applications
are aware or unaware of edge computing.
\- It shall be possible for Application Clients in the UE to use Edge
Computing without any specific edge computing logic in the Application Client.
\- The 5GC shall only support the edge computing hosting Environment beyond
the PSA/UPF.
\- The edge computing hosting environment may be under the control of the
operator or under the control of third parties.
\- It shall be possible for an edge computing hosting environment to connect
to several PLMNs.
\- It shall be possible for an edge computing hosting environment to have no
connectivity with the central data network.
\- It shall be possible for an edge computing hosting environment to have
connectivity with the central data network.
\- The architecture should support one PLMN that is connected to several
providers of edge computing host environments.
\- A PLMN operator shall continue to have the possibility to provide edge
computing service differentiation (e.g. by enabling/disabling the Edge
Computing features).
\- The architecture used for 5GC Edge Computing shall continue to leverage on
already developed features in 3GPP Rel-15 and Rel-16.
\- The architecture should leverage on widely used IP mechanisms, e.g. DNS,
when applicable. Any solution based on DNS needs to consider that DNS traffic
may be encrypted between the UE and the DNS Resolver in the operator or 3rd
party network.
\- Solutions shall build on the 5G System architectural principles as in TS
23.501 [2], including flexibility and modularity for newly introduced
functionalities.
\- 5G System shall enable edge computing support for all connectivity models
in the 5G system including the ones listed in clause 4.2.
# 5 Key Issues
## 5.1 Key Issue #1: Discovery of Edge Application Server
### 5.1.1 General description
In Edge Computing deployment, one application service might be served by
multiple Edge Application Servers typically deployed in different sites. These
multiple Edge Application Server instances that host same content or service
may use a single IP address (anycast address) or different IP addresses.
Before an application/UE starts to connect to the service, it is very
important for the application/UE to discover the IP address of one suitable
Edge Application Server (e.g. the closest one), so that the traffic can be
locally routed to the Edge Application Server via UL CL/BP mechanisms, and
service latency, traffic routing path and user service experience can be
optimized. Also once a discovered Edge Application Server becomes non-
optimized (e.g. after the UE moves far away), a new Edge Application Server
may be used to replace the old one to serve the application/UE.
The reselection of an Edge Application Server can be triggered by events
either in the 5GS or in the application layer. For example, in the first case
it can be triggered by a User Plane change initiated by the network such as a
mobility event (e.g. handover), or a failure event which ultimately is a 5GS
criterion. In the second case it can be initiated due to an Edge Application
Server may become congested or unavailable. This requirement depends on
whether the application can tolerate a change of Application server instance.
The following aspects shall be studied to support the efficient discovery of
Edge Application Sever:
\- How can a UE discover a suitable Edge Application Server to serve the
application/UE?
\- Consider scenarios (if any) for which the UE needs to be aware that there
is an application server in the Edge Hosting Environment and scenarios (if
any) for which the UE does not need to be aware that there is an application
server in the Edge Hosting Environment.
\- What information (if any) can be used to assist such a discovery mechanism?
\- What (if any) additional information may need to be discovered about the
EAS through such a discovery mechanism?
NOTE 1: Any potential additional information required for supporting use cases
for application layer under the scope of SA WG6 work can be considered in SA
WG6.
\- Whether and if yes how to support UE rediscovery of Edge Application Server
when the previous Edge Application Server becomes non-optimal or unavailable
to the UE?
\- Whether the need to ensure the discovery of Edge Application Server and PSA
UPF selection and reselection are jointly carried out? If so, how?
NOTE 2: Application level aspects details on above access management,
application server switching, announcing the status of an Edge Application
Server, etc. that do not relate with how 5GS steers traffic to Edge
Application Server are managed on the application level and out of scope of
this study.
NOTE 3: For sake of easy implementation, solutions should preferable be based
on existing mechanisms (e.g. DNS, SFC techniques) and industry practices to
avoid or at least minimize impact on applications and UEs. Additionally, the
outcome from SA WG6 FS_EDGEAPP may be considered if impacts to 5GC are
identified.
NOTE 4: Discovery mechanisms should not limit MNOs to specific hosting models
and should preferably work for any of the hosting models, e.g.:
\- The MNO is in control of the edge and provides the edge computing
infrastructure, the connectivity and the application platform, and manages the
Edge Application Servers.
\- The MNO hosts its own or a 3rd party application platform on its edge
computing infrastructure. MNO provides the routing and IP network stitching
between the connectivity and the platform which exposes APIs for application
management.
\- The MNO provides distributed connectivity to a DN, and cloud providers host
the application servers on their application platform on the edge.
NOTE 5: This key issue focuses on network layer solutions that impact 5GS NFs.
However this does not exclude any upper layer solution to be adopted by
operator or service provider.
If the solutions to this key issue use DNS the following aspects should also
be considered:
\- How can DNS resolution take into account different PSAs for different
applications?
\- Does the 5GC needs to assist the DNS resolution?
## 5.2 Key Issue #2: Edge relocation
### 5.2.1 Description
With edge computing being deployed for 5G systems, UE mobility and application
server relocation need to be considered when designing solutions for optimal
deployment of edge solutions. For example, as the UE moves across the 5G
system, the UE location may change and require the network and the edge to
deal with the change of UE location. 3GPP Rel-16 specifications already
address some of these aspects and the key issue is to study potential
improvements.
Clause 6.5.2 of TS 22.261 [6] contains requirements that are related to this
key issue. SA WG1 defined the term Service Hosting Environment that has been
translated and broadened in SA WG2 work in the present TR to Edge Hosting
Environment as the environment providing support required for Edge Application
Server\'s execution. The requirements from SA WG1 are thus being interpreted
as applying to the Edge Hosting Environment.
The following scenarios of UE mobility and application server relocation will
be investigated:
\- Change of the serving Edge Application Server with no change of DNAI. This
includes:
\- Change of the Edge Application Server e.g. due to the serving Edge
Application Server becoming congested or being in outage condition. This
assumes EAS IP address change.
\- Change of the DNAI depending on the location of the UE to better serve the
UE. This may imply EAS IP address change but in some cases the old EAS may be
kept as long as the UE transaction is not over.
The following scenarios of UE mobility and application service relocation will
be investigated:
\- Potential improvements of the coordination of change of the Edge
Application Server and (local) PSA to support seamless change, e.g. preventing
or reducing packet loss.
NOTE 1: It is expected that change of the EAS with no change to the EAS IP
address (e.g. due to load balancing, server maintenance) is handled by edge
orchestration, and is outside the scope of this key issue, whereas change of
EAS with a change to the EAS IP address is in the scope of this key issue.
This key issue will study the following aspects in order to support service
continuity:
\- What triggers should be considered, and which functional entities trigger
the changes to support service continuity for the scenarios described above.
\- Whether existing SA WG2 mechanisms (e.g. ULCL/BP insertion/relocation, SSC
mode 2/3, AF influence on traffic routing, and LADN) suffice or whether there
are gaps to be addressed that could introduce improvements in Quality of
Experience compared to existing solutions.
\- How to handle changes of the (local) PSA when applications do not support
the change of client address.
\- How to handle change of the serving EAS (without UE mobility) to support
seamless change, e.g. preventing or reducing packet loss.
\- How to handle coordination of change of the Edge Application Server and PSA
to support seamless change, e.g. preventing packet loss. This should consider
the already specified mechanisms in TS 23.502 [3] clause 4.3.6.3
\"Notification of User Plane Management Events\".
\- Evaluate and determine whether and how seamless change of Edge Application
Server can be enabled considering:
\- Different Edge hosting models described in the key issue #1.
\- Stateful and Stateless applications.
## 5.3 Key Issue #3: Network Information Provisioning to Local Applications
with low latency
### 5.3.1 Description
With edge computing deployment, it is expected that a set of edge computing
functions or edge application servers running on edge hosting environment will
need to interact with the 5GS to access to 5GS functionality and information,
and/or to provide information to 5GS for the provisioning of connectivity
services supporting edge computing. The interaction for exposure of network
information between the 5GS and the edge computing functions need to be
studied.
As part of the study, latency of network exposure needs to be considered.
Current network exposure mechanism in 5GS is designed based on NEF and other
control plane NFs, e.g. AMF, SMF, PCF etc. For applications deployed in edge
hosing environments, the Edge Application Servers or Application Functions may
be locally deployed, but in current Rel-16, some Control Plane NFs involved in
network exposure, e.g. NEF and PCF, are likely deployed centrally to avoid
frequently relocation. This may result in a less than efficient network
exposure path in terms of latency.
For some network information to be exposed, the long exposure latency is
tolerable. However, some real time network information, e.g. network
congestion condition or real-time user path latency, can change very
frequently. If this information needs to be delivered to Application servers
or Application Functions timely, undesirable latency may make the information
obsolete cause applications to adjust their behaviour (e.g. adjust the
resolution of video stream, or switch levels of driving automation) based on
out-of-date network information.
Examples of existing QoS information that may need to be exchanged quickly
between network and Application Functions (e.g. Edge Application Servers)
include:
1\. The AF may subscribe to receive QoS congestion condition notifications.
2\. The AF may request 5GC to monitor QoS status (e.g. over-the-air and/or
end-to-end data path) and receive QoS measurement reports.
This key issue addresses exposure of information to Application Functions
deployed in the edge (e.g. Edge Application Servers), including:
\- Which information that have already existed in Rel-16 needs to be exposed
with low latency to the edge computing functions by the 5GS?
\- How does the 5GC determine whether a network information need to be exposed
with low latency?
\- How to expose the network information to the application functions deployed
in the edge with low latency?
\- Whether and how to maintain the exposure when the UE moves out of the
coverage of NF(s) supporting the exposure?
NOTE 1: This study does not discuss solution related to NG-RAN exposing
information to edge computing functions or servers via direct reference
points.
NOTE 2: This study does not disclose RAN private data (e.g. RAN details) to
the edge computing functions or servers.
## 5.4 Key Issue #4: Consecutive traffic steering in different N6-LAN
### 5.4.1 Description
NOTE 1: This key issue is not addressed within Rel-17 timeframe.
For some of edge computing use case scenarios, although Application Servers
are deployed in the local N6-LAN, centralized deployed Application Server(s)
may still be required for other processing. In such edge computing scenarios:
\- UL traffic related to an application may be first steered over local N6-LAN
to Application Server(s) for local-processing, and then further steered to the
central Application Server(s).
\- DL traffic related to an application may be first routed via Application
Server(s) in the central N6-LAN, then steered to Application Server(s) in
local N6-LAN for local-processing, and finally provided to the UE.
1) The following aspects will be studied in this key issue:
\- How to steer application traffic for processing at different locations
(e.g. at the local Application first and then at the central application
server(s)/or UE, or at the central application server first and then at the
local application server), e.g. via DN/internet, back via the 5GC or using
multiple PDU sessions.
NOTE 2: Different alternatives can apply depending on whether the application
traffic expected to be further processed at the central Application Server(s)
(for UL traffic) or local Application Server (s) (for DL traffic) relates with
all or part of the UE application traffic.
2) Depending on the architecture for the item 1) above:
a) Whether and how is the 5GC made aware that (UL/DL) application traffic
needs to be processed via the local N6-LAN and the central N6-LAN;
b) How to provide the 5GC with information about service functions in N6-LAN
(both local and central) that application traffic needs to travel through,
e.g. service function order and location;
c) How can local 5GC NF(s) distinguish the UL traffic and the DL traffic that
need to be processed via either the local N6-LAN or the central N6-LAN, or
both.
Solutions defined for this key issue should consider:
\- How to guarantee proper enforcement of the Policy Rules, QoS handling,
Packet marking, packet buffering and rest of UPF functions.
\- How to guarantee proper usage reporting for usage monitoring and charging.
## 5.5 Key Issue #5: Activating the traffic routing towards Local Data Network
per AF request
### 5.5.1 Description
In order to activate the traffic routing towards Local (access to) Data
Network, the SMF should be configured with the requested DNAI. For ETSUN case,
either SMF or I-SMF should be configured with the requested DNAI.
For some of edge computing use case scenarios, the SMF or I-SMF of the PDU
Session may not be configured with the requested DNAI. In this case the
mechanism to activate the traffic routing towards the Local Data Network
should be studied.
The key issue aims at studying the following:
\- Whether Rel-16 ETSUN solution is sufficient to support the use case above
and if there is a gap.
\- If Rel-16 ETSUN solution is not sufficient (there is a gap), study
potential solutions on how to activate the traffic routing towards Local Data
Network when the SMF does not support the requested DNAI, or for ETSUN case
both SMF and I-SMF do not support the requested DNAI in the AF request.
# 6 Solutions
## 6.0 Mapping of Solutions to Key Issues
Table 6.0-1: Mapping of Solutions to Key Issues
Solutions Key Issues
* * *
                                                                                                                                  1            2   3   5
#1: Provisioning URSP configuration to the UE to establish PDU Sessions for
edge applications X  
#2: Local DNS based edge server address discovery X  
#3: DNS AF X  
#4: Providing the DNS authoritative server with IP addressing information
about where the UE is located X  
#5: Server Discovery using DNS, IP Routing and URSP X  
#6: Discovery of EAS based on DNS X  
#7: SMF/I-SMF selection based on DNAI X  
#8: Edge Application Server discovery using anycast DNS X  
#9: Assist DNS resolution without connectivity between local and central data
network X  
#10: DNS for Distributed Anchor X  
#11: DNS over HTTP X  
#12: PDU session re-anchoring X X #13: 5GC support for UE selection of the DNS
to use X  
#14: IP address discovery for the Service Switch mechanism- DNS handling in
both UPF and EC X  
#15: IP address discovery for the Service Switch mechanism-DNS handling in UPF
X  
#16: Edge Configuration Server Based Discovery X  
#17: Provisioning EC Parameters including EAS information to the UE X  
#18: Mapping the AS IP address to Edge Server IP address X  
#19: Edge Application Server discovery using an Address Resolution Function X  
#20: DNS Inspector based EAS Discovery X  
#21: Provisioning URSP configuration to the UE to establish PDU Sessions for
edge applications based on Provisioning Domains X X  
#22: DNS based EAS discovery supporting session breakout. X  
#23: DNS for AS Discovery at Edge Relocation X  
#24: Support of edge relocation, triggering of new DNS query by the UE X  
#25: Seamless Change of Edge for Stateful Applications X  
#26: Persistent address allocation for mobile UEs that need MEC access X  
#27: Reducing packet loss during EAS relocation X  
#28: Supporting application server change based on AF notification X X  
#29: CN-based edge relocation X  
#30: UE Agnostic EAS IP address replacement for traffic subject to edge
computing X  
#31: Application Relocation with UE assistance X  
#32: UE DNS cache flush X X  
#33: IP preserving PSA relocation X  
#34: Local DN notification to the UE during ULCL operations X  
#35: Edge relocation considering with user plane latency requirement (SMF
decision) X  
#36: Edge relocation considering with user plane latency requirement (AF
decision) X  
#37: AF-based EAS End-Point-Address update via External Parameter Provisioning
X  
#38: EAS change with reducing packet loss in uplink X  
#39: EAS relocation coordinated with PSA change X  
#40: Seamless change of Edge Application Sever for stateful applications by
caching application status information in NEF X  
#41: Network Information Provisioning using the IP path X  
#42: Providing selected radio information to an App requiring it X  
#43: Low Latency exposure API by using the distributed CAPIF framework feature
X  
#44: Network Information Exposure to Local AF with Low Latency X  
#45: Using AS or NAS message notify UE\'s application layer X  
#46: Local NEF Deployment for network information exposure to Local AF with
Low Latency X  
#47: User Plane based Network Information Provisioning X  
#48: QoS monitoring information exposure based on unstructured data
transmission mechanism X  
#49: Network Information Provisioning to EAS with low latency based on User
Plane X  
#50: Activating the traffic routing towards Local Data Network per AF request
X #51: Edge Relocation for all connectivity models X  
#52: Service Continuity at EAS relocation with PSA coexistence in session
break-out scenarios X  
#53: Service Continuity at Edge Relocation with DNS triggered insertion of
BP/ULCL and Edge PSA X  
#54: EAS relocation for SSC mode 3 PDU Session X  
#55: Multiple AFs X  
#56: Edge NEF based Network Information Provisioning X
## 6.1 Solution #1: Provisioning URSP configuration to the UE to establish PDU
Sessions for edge applications
This solution is for Key Issue #1, which addresses Edge AS discovery including
aspects related to:
\- What information (if any) can be used to assist such a discovery mechanism?
In the current study architecture assumption, the UE may need to establish
connectivity with specific characteristics, e.g. to a specific slice or to a
dedicated DN or in SSC mode 2/3, in order to perform any further action, e.g.
discovery of Edge Application Servers (EAS).
This solution proposes to provision URSP rules to the UE to establish the
appropriate PDU Session before performing Edge AS discovery. The Edge AS
discovery is not covered in this solution. The solution assumes a locally
distributed UPF with IP anchor is used to access the Edge services. The
solution can be used for connectivity model \"multiple PDU sessions\" as
described in clause 4.2.
### 6.1.1 Description
In order to enable the communication to perform Edge AS discovery and further
communication with the selected EAS via the appropriate PDU Session, the 5GC
may provision policy configuration consisting of URSP rules, which could be
locally configured on the UE or provisioned by UE Configuration Update
Procedure according to TS 23.502 [3].
At Registration (initial or mobility), the UE may include the UE Policy
Container in order to receive the URSP rules from the 5GC.
Additionally, in order to update the URSP rules due to UE mobility, the
Application Function (AF) may subscribe to UE location information from the
5GC.
The solution relies on the UE Configuration Update Procedure in clause 4.2.4.3
in TS 23.502 [3] to provision the URSP rules to the UE thus the same
limitations apply. This means that in roaming scenario the H-PCF is in control
to update the policy to the UE, and the AF must belong to or have an agreement
with HPLMN.
### 6.1.2 Procedures
#### 6.1.2.1 Policy configuration provisioning procedure
Figure 6.1.2.1-1 shows the procedure to provision URSP configuration to the UE
for purposes related to performing Edge AS Discovery and further communication
with the selected EAS.
In Step 0a the application layer, acting as AF, uses the Nnef_ServiceParameter
service to provide URSP influence parameters for the edge application traffic
(identified by IP address of the EAS or FQDN of the Edge service) to the NEF.
The AF may also indicate Spatial Validity Condition defining a geographical
zone identifier(s) where the policy requirements are applicable.
NOTE 1: The AF is not able to influence to the Location Criteria in the URSP
when the UE is roaming.
The AF sends the request to the NEF. The AF indicates whether the URSP
influence parameters apply to an individual UE, group of UEs or any UE.
1\. When the UE performs (initial or mobility) Registration to 5GC as in TS
23.502 [3] clause 4.2.2.2.2, the UE may include the UE Policy Container in the
Registration Request as specified in TS 23.502 [3].
2\. UE Policy Association Establishment as in TS 23.502 [3] clause 4.16.11,
with the following changes:
The PCF determines the URSP rules based on the URSP influence parameters as
requested by the AF in step 0. The URSP rules includes DNN, S-NSSAI and other
relevant network parameters to be used for matching Edge application traffic,
e.g. traffic from Edge Application clients installed on the UE to Edge
Application Servers. If the AF provided Spatial Validity Conditions in Step 0,
the PCF generates Location Criteria based on the Spatial Validity Conditions,
and includes corresponding Location Criteria in the RSD part in the URSP
rules. The PCF can use a dedicated Policy Section for the URSP rules that are
specific for a particular Edge DN, as specified in TS 23.503 [4]. In step 2b,
the PCF stores the URSP rules to the UDR as part of UE\'s Policy Set entry as
described in clause 6.1.2.4 in TS 23.503 [4]. The PCF uses the UE
Configuration Update Procedure (TS 23.502 [3] clause 4.2.4.3) to provide URSP
rules to the UE.
In alternative to steps 0-2, the operator may configure the URSP locally in
the UE.
3\. When the UE needs to send traffic destined to an edge service the UE
triggers the Edge AS discovery by sending a DNS query for an FQDN of the edge
service. The details for this step are out of scope of this solution. After
this, the Application Client sends an application layer service request to an
IP address of the EAS in the Edge Hosting Environment.
If the FQDN in the DNS Query, or the EAS IP address in the application layer
service request matches with the destination address in the Traffic descriptor
part of the URSP rule as provisioned in Step 1, the UE, based on URSP rule
matching (step 3b), establishes a new PDU session (step 3c) in order to enable
User Plane communication (step 3d) with the DN where the DNS Server or the
Edge Application Server resides. It is assumed that the DNS address
configuration provided during the PDU session establishment can be used to
send the DNS Query.
NOTE 2: Based on the Location Criteria in the URSP rule the same FQDN in the
DNS Query may trigger establishment of PDU Session to either a local Data
Network or to a remote/central Data Network. In both cases, the authoritative
DNS nameserver that holds the DNS record for the FQDN is the same.
4a. (optional) the AF may subscribe to UE location notifications; the
notifications may be used by the AF to trigger AF request as in Step 0 to
update the URSP influence parameters to edge applications for the UE.
4b. (optional) if multiple location specific URSP rules are used in Step 0,
i.e. the Location Criteria in the RSD part is configured so that different
rules applies per UE location. As specified in TS 23.503 [4], the UE may need
to re-evaluate the application association with a PDU session e.g. when the UE
location does not match anymore with the Location Criteria. If the re-
evaluation leads to a change of the application to PDU Session association,
the UE may enforce such changes in a timely manner based on implementation,
e.g. immediately or when UE enters CM-IDLE state.
Figure 6.1.2.1-1: Policy configuration provisioning procedure
### 6.1.3 Impacts on services, entities and interfaces
The proposed solution is based on Rel-16 procedures but some enhancements may
be needed to make it possible for the AF to configure the edge service FQDNs
on session basis to the URSP rules, such as:
\- Enhance the NEF service Nnef_ServiceParameter to allow the AF to influence
PCF decisions for URSP rules for one UE, group of UEs, or any UE. The AF can
use the service to provide parameters without the need to have the UE
registered in the network. These parameters are stored in the UDR and then
provided to the PCF serving the AMF, when UE registers in the AMF. The PCF
determines the URSP rules based on the URSP influence parameters and stores
the URSP rules to the UDR as part of UE\'s Policy Set entry as described in
clause 6.1.2.4 in TS 23.503 [4]. The PCF can assign a Policy Section
Identifier that is specific to the Edge DN when the PCF stores the URSP rules
to the UDR. The new parameters of the Nnef_ServiceParameter service include
the FQDN or list of IP addresses of the EAS in the AF Request.
\- Include the Spatial Validity Condition in the AF Request.
\- PCF needs to be able to retrieve and get notified for the URSP influence
parameters for the Edge services from the UDR.
## 6.2 Solution #2: Local DNS based edge server address discovery
### 6.2.1 Introduction
This solution addresses the Key Issue #1: Discovery of Edge Application
Server.
This solution is based on assumption:
\- Application Clients in the UE to use Edge Computing without any specific
edge computing logic in the Application Client.
### 6.2.2 Functional Description
Figure 6.2.2-1 Example for architecture
NOTE: UPF-1 and UPF-3 in the Figure 6.2.2-1 can be ULCL/BP or PSA. The local
DNS can be deployed in EC environment or out of EC environment.
As shown in Figure 6.2.2-1, the serving area of the Edge Computing Service
includes a list of local serving area (e.g. local Serving Area_1 and Local
Serving Area_2). The Edge Computing Service is provided by different Edge
Server in different local serving area. DNS is deployed locally and
authoritatively to provide the Address Inquiry Service for Edge Server in the
local serving area. The local DNS is provisioned to the UE during PDU Session
related procedure via ePCO. The local DNS is not provisioned to the UE by the
DHCP server when the DHCP server is not aware of the UE location. The local
DNS can be provisioned to the UE by the DHCP server when the DHCP server is
aware of the UE location, e.g. the DHCP server is collocated with the SMF.
The mapping table between local DNS and its serving areas is preconfigured at
the SMF.
In order to support ULCL/BP, it is assumed there is connectivity between the
local DNS and central DNS. The local DNS address is provided to the UE and
both the DNS inquiry from the EC applications and DNS inquiry from the non-EC
applications are targeted to the local DNS. The local DNS works as the
authoritative DNS for the EC applications and returns the EC Server\'s address
to the UE for the EC applications directly. The local DNS connects with the
central DNS, which is the authoritative DNS for non-EC applications, to
perform DNS inquiry for the non-EC applications.
Figure 6.2.2-2 DNS Inquiry Example for UL CL/BP
For supporting SSC mode 2/3, the connectivity between the local DNS and
central DNS is not required. The EC applications has its dedicated DNN. The
local DNS can handle the DNS inquiry from the EC applications.
Figure 6.2.2-3 DNS Inquiry Example for SSC mode 2/3
### 6.2.3 Procedures
#### 6.2.3.1 Procedure for Edge Server discovery when service start-up
Figure 6.2.3.1-1 Procedure for Edge Server discover when service start-up
During existing registration procedure or UCU procedure, a dedicated DNN is
configured for the applications which can use Edge Computing service via UE
policy
1\. When there is pending service requirement for applications which can use
Edge Computing and the UE is located at a local serving area of EC service, UE
initiates a PDU session setup procedure.
In this step, based on the UE location, the SMF performs as follow:
\- Setup the PDU session which is able to access the Edge Server, which may
apply ULCL, Multi-homing or not.
\- Configures a local DNS address for the UE. The local DNS address is
provided to the UE via the ePCO in the PDU Session Establishment Accept.
3\. If there is no store IP address for the requested FQDN, the Application
Client invokes the UE kernel to trigger a DNS request with the FQDN to the DNS
address acquired from the network in step2.
4\. The Local DNS sends the DNS responses including the Edge Server\'s address
corresponding to the requested FQDN. The UE stores the DNS query record, e.g.
including FQDN and corresponding IP address.
#### 6.2.3.2 Procedure for provisioning local DNS Server Address in the case
of ULCL/BP
Figure 6.2.3.1-1 illustrates the procedure for configuring the DNS server
address to the UE, in the case of ULCL /BP is used for the PDU session. The
edge DN should have connectivity with central DN because the edge and central
DN are the same DN, as specified in TS 23.501 [2] clause 5.6.4.
Figure 6.2.3.2-1: Procedure for Local DNS address provisioning to UE in the
case of ULCL or BP
1\. During UE mobility, the UE performs Service Request or Registration
procedure if CM-IDLE. If UE is CM-Connected and mobility occurs, Handover
procedure is performed.
2\. The AMF invokes Nsmf_PDUSession_UpdateSMContext as specified in TS 23.502
[3].
3\. Based on the UE location information received from the step 2 and the
mapping table between local DNS and its serving areas, the SMF performs
Addition of additional PDU Session Anchor and Branching Point or ULCL
procedure, or performs Change of additional PDU Session Anchor for IPv6 multi-
homing or ULCL, or Simultaneous change of ULCL or Branching Point and
additional PSA. Above procedures follows as specified in clause 4.3.5 in TS
23.502 [3]
In this step, SMF may determines to update the address of the DNS server
handling UE requests based on the UE location.
For ULCL case, SMF configures the ULCL UPF routing rules during this
procedure. The traffic routing rules include filtering out the DNS request
packet by examining the destination IP address as the local DNS address
configured on the UE, or the port number is 53, and offloading DNS request to
edge Data Network.
4\. The local DNS address is provided to the UE via the ePCO in the PDU
Session Modification Command. The UE updates the DNS server address
accordingly.
For IPv6 multi-homing, the SMF can also provide DNS address to UE through RA
message; in case of conflict with DNS addressing received over ePCO the DNS
address received from ePCO has a higher priority than the DNS address received
from RA/RS message.
NOTE 1: The local DNS can work as the authoritative DNS for the applications
using EC service. The local DNS has connection with the authoritative DNS and
can work as DNS Resolver for applications non-using EC service.
NOTE 2: The per FQDN control of the DNS resolution is done by the local DNS
whereas SMF controls the usage of the EC services per application through the
provisioning of the traffic routing rules in UL CL / BP. Both configurations
need to be aligned so that users enjoy certain Application at the edge: the
SMF configures the PDU Session ULCL /BP (and UE related rules for BP) Traffic
steering rules whereas, it is the Local DNS Resolver that controls whether the
DNS Resolution for the Application FQDN in a PDU Session is resolved into a
local EAS.
#### 6.2.2.3 Procedure for provisioning local DNS Server Address in the case
of SSC mode 2/3
Figure 6.2.3.2-1 illustrates the procedure for configuring the DNS server
address for EDN to the UE, in the case of SSC mode 2/3 in the multiple PDU
session connectivity model.
Figure 6.2.3.2-1: Procedure for DNS address provisioning in the case of SSC
mode 2/3
1\. During UE mobility, the UE performs Service Request or Registration
procedure if CM-IDLE. If UE is CM-Connected and mobility occurs, Handover
procedure is performed.
2\. The AMF invokes Nsmf_PDUSession_UpdateSMContext as specified in TS 23.502
[3].
3\. Based on the UE location information received from the step 2 and the
mapping table between the local DNS and its serving areas, the SMF determines
Change of SSC mode 2 PDU Session Anchor or Change of SSC mode 3 PDU Session
Anchor procedure as specified in clause 4.3.5 in TS 23.502 [3].
In this step, SMF determines to update the local DNS server address based on
the UE location.
5\. In the case of SSC mode 2, SMF performs step 2 to step 3 as specified in
clause 4.3.5.1 of TS 23.502 [3]. The local DNS address is provided to the UE
via the ePCO in the PDU Session Establishment Accept. The UE updates the DNS
server address accordingly.
6\. In the case of SSC mode 3, SMF performs step 2 as specified in clause
4.3.5.2 and clause 4.3.5.3 of TS 23.502 [3]. The local DNS address is provided
to the UE via the ePCO in the PDU Session Establishment Accept. The UE updates
the DNS server address accordingly. The DNS address from ePCO has a higher
priority than from DHCP, if any.
### 6.2.4 Impacts on existing entities and interfaces
**SMF:**
\- Configure the local DNS address for the UE based on UE location.
\- Preconfigure the mapping table between local DNS and its serving areas.
## 6.3 Solution #3: DNS AF
### 6.3.1 Description
The solution addresses Key Issue #1: Discovery of Edge Application Server in
this TR. The UE is Edge Computing Service agnostic.
The proposed solution supports the \"Session Breakout\" connectivity model
with dynamic insertion of local PSA for Edge Computing. The role of DNS AF is
to assist a) the selection of a suitable EAS for the user location, and b) the
proper setting of break-out point in relation to the selected EAS, when the UE
PSA is centralized.
DNS AF also plays a role when the \"Distributed Anchor Point\" connectivity
model is an option for the PDU Session, but the UE PSA is centralized at
start. That role is b) to assist the re-anchoring to a Distributed anchor
point on-demand (for more details on such a solution see 6.12 (DNS triggered
Session re-anchoring).
In the \"Distributed Anchor point\" or \"Multiple sessions\" connectivity
models assuming that the UE PSA is optimally chosen relative to the UE current
position from start, DNS AF is not involved in the DNS resolution. For more
details on such a solution see 6.10 (DNS for Distributed Anchor).
The Operator deploys a new DNS component. That component is from now on
referred to as DNS AF, and it is deployed in the MNO network before the NAT.
The DNS AF holds an EC Translation Table that maps a given user location and
application FQDN into the preferred PDU session anchor(s) (PSA(s)), including
information of DNAI and corresponding subnet (or full IP address) of each N6
access to the DN after NAT. It also has the IP address ranges that may be used
by the UE in the communication with the AS(s) needed to configure the ULCL.
An example EC Translation Table thus contains:
\- A list of FQDNs for which EC related SLA exists, and
\- For each FQDN,
\- Mapping between a set of Tracking Area IDs to one or more DNAIs,
\- Mapping between each DNAI and subnet representing the DNAI in the DNS
resolution (ECS),
\- An EAS steering profile (e.g., sets of destination IP address ranges),
\- Optionally the QoS requirements for the given service.
The DNS AF is involved in the DNS communication of the UEs authorized for edge
services, e.g., at session establishment the SMF sends the DNS AF address to
the UE (in the PCO field). The DNS AF receives the UE DNS request for an FQDN
related to an Edge AS, authorizes the UE/service, gets UE location information
and determines first at least one suitable local PDU session anchor (PSA)
point for that UE location and application. The Mobile Core assists (e.g. the
PCF) then the discovery of most suitable Application Server for the PSA(s) by
adding the corresponding N6 access location as ECS option to the DNS request
or by forwarding the DNS request to a DNS serving the location of the UE. At
that stage, it is up to the Service Provider to select a suitable EAS that
matches the given location(s). The Service Provider may feed information back
to the Mobile Network on whether the selection has been tailored to the
information provided, by using the ECS option. The Mobile Core then inserts
the ULCL and sets up the traffic steering accordingly.
### 6.3.2 Procedures
#### 6.3.2.1 High-level procedure using ECS option
Figure 6.3.2.1-1 below shows an example sequence for this solution that
includes the following steps
When the UE sets up a PDU session, 5G Core existing mechanisms are used to
guarantee that, if for that user PDU session Edge Computing can be applied,
the UE DNS queries are sent to the DNS AF. One such method is e.g., sending to
the UE at PDU session setup the DNF AF address DNS server in the PCO field.
Otherwise, DNS AF is skipped.
As a prerequisite for the flow below the is that a PDU session for e.g.
\"Internet\" DNN is established and the operator has configured the UPFs to
send DNS request to the DNS AF.
Figure 6.3.2.1-1: High-level sequence diagram of EAS discovery and dynamic
traffic steering by the MNO in the DNS AF solution
1\. Once the PDU Session has been established, an application (that in this
flow happens to be an edge computing application) may trigger the setup of an
\"Application session\" to an Application Server. Typically, the Application
Server is known by a domain name, and so that needs to be translated into an
IP address. UE will send a DNS Query with the Application FQDN. That query is
sent to the DNS AF if for that user PDU session Edge Computing can be applied.
2\. The DNS AF checks whether there is an SLA in place for that application.
To do that, it looks for the Application FQDN received in the DNS Query in the
SLA based Translation Table:
a) If there is no match (meaning that the FQDN in the DNS request is not
included in the EC Translation Table, there is not agreement, and the DNS AF
forwards the DNS request to the MNO DNS which resolves that as usual.
b) If there is a match, the DNS AF retrieves the User Location from the
Control Plane by using e.g., the exposure APIs of the NEF. The identification
of the UE needed in the request is the UE IP address in the DNS request. In
the case of overlapping IPs, the UE IP address may not be unique. A solution
to this is to have a separate DNS AF entity for each individual sub-domain,
and thus the domain ID may be used in addition to the UE IP to identify the
UE. See also Steps 3a and 3b in Figure 6.3.2.2-1.
The DNS AF is deployed before the NAT.
With the UE Location and the FQDN, the DNS AF obtains the preferred locations
for the N6 Access to the DN for that application and the corresponding subnets
(or full IP addresses) after NAT using the SLA based EC Translation Table.
These subnet(s) (or full IP addresses) are then added as one \"ECS\" options
in the DNS Query as in RFC 7871 [7]. ECS stands for EDNS Client Subnet, where
EDNS is Extension Mechanisms for DNS. The query is then forwarded to the MNO
DNS. The original DNS request by the UE is temporarily buffered in case it
needs to be resent later e.g., in failure cases. The DNS AF acts as a DNS
Forwarder in order to be in the path for the response.
Any ECS received from the stub resolver in the UE is removed by the DNS AF, as
in this solution, it is not the client address but network addresses that are
provided in the ECS. The ECS received from the stub resolver in the UE either
contains information which is not appropriate to do a proper EAS selection as
it refers to the centralized PSA or could well be a private address.
3\. The DNS request is forwarded to the MNO DNS. MNO DNS resolves the DNS
query as usual and the DNS Query reaches the DNS Hierarchy.
4\. The ECS option in the DNS Query can be used by the Service Provider DNS to
tailor the DNS response. The ECS option in the response is built according to
RFC 7871 [7]:
\- FAMILY, SOURCE PREFIX-LENGTH, and ADDRESS are copies from the ECS option in
the query,
\- SCOPE PREFIX LENGTH can be set for example to 0 so no caching is done.
Else, if even if the ECS option have been considered, the response is not
tailored to any of them, no ECS option is sent back in the response.
5\. The DNS response is sent, and reaches the MNO DNS, that sends it back to
the DNS AF, that acted as forwarder. That is, if an iterative DNS resolution
is used, this always happens above the DNS AF. This is needed in order to
convey the necessary information about the selected EAS address as well as
possible ECS information to the DNS AF.
6\. The DNS AF checks the response and whether that includes an ECS Option. If
so, it determines the DNAI that corresponds to the received ECS (that is, the
identifier of the N6 access to the DN), and uses the AS address received to
determine the AS site selected and applicable AS IP ranges. If the ECS option
is not included, the DNS AF may decide the DNAI based on other information
such as FQDN and local configuration.
7\. The DNS AF uses the 3GPP Exposure APIs to Update the CP Policies to
request traffic steering for the selected AS IP ranges or IP address(es) to
the selected PSA anchor.
8\. The DNS Response is sent to the UE once those actions have been completed
(the ECS option is removed before).
9\. The application traffic starts towards the IP Address received. That
traffic is diverted by the ULCL and sent via the selected PSA to the N6 access
to the DN that is topologically close to the AS (assuming the Service Provider
selection was correct).
The procedure above assumes that the setup of traffic steering based on the
received DNS response was successful. The DNS AF starts a timer after the
initiation of the traffic steering in Step 6 waiting for notification from the
SMF of the changes of the user plane for the given session. If no notification
is received before the timer expires then it is considered that the Dynamic
ULCL insertion and configuration in step 6 above has failed for causes related
to the specific N6 access location selected, then e.g. a new request could be
sent including the ECS but excluding that specific N6 access location. The
process above would repeat from step 3. Or as an alternative, e.g. the process
above would repeat from step 3 without sending the ECS Option.
The above procedure supports insertion of more than one local UPFs to handle
different applications. This is because there can be different mapping
possibilities for different FQDNs in the Translation Table, so different DNS
requests from the same UE may result in different N6 access selections and
configuration of corresponding ULCL/PSAs assisted by the DNS AF. Therefore,
the DNS traffic for the FQDNs for which there is an SLA for EC is always
routed towards the DNS AF. The DNS AF maintains an Application session towards
the PCF including all DNAI that have been configured for a given UE PDU
session, and uses this information in the routing decision for subsequent DNS
requests.
#### 6.3.2.2 Detailed procedure using ECS option
The detailed description Figure 6.3.2.1-1 is depicted in Figures 6.3.2.2-1 and
6.3.2.2.-2and described below. The pre-requisites are those described in
clause 6.3.2.1.
Figure 6.3.2.2-1: Detailed sequence diagram of EAS discovery and dynamic
traffic steering by the MNO in the DNS AF solution. First part, until the
receipt of the UE location by the DNS AF
1\. Once the PDU Session has been established, an application (that in this
flow happens to be an edge computing application) may trigger the setup of an
\"Application session\" to an edge Application Server. Typically, the
Application Server is known by a domain name, and so that needs to be
translated into an IP address. UE will send a DNS Query with the Application
FQDN. That query is sent to the DNS AF if for that user PDU session Edge
Computing can be applied.
2\. DNS AF extracts UE IP & FQDN and checks whether App (FQDN) in under SLA
agreement for Edge. If edge breakout is needed, then it buffers the DNS
request. The DNS AF also checks whether an App Session Context exits for this
IP in PCF, meaning that there is edge breakout already applied for an UE
session. This information could be used in the decision of which ECS option
are selected and sent in the DNS query in step 15.
3a - 3b. [Conditional] If there are more than one PCFs, DNS AF needs to
contact BSF to find PCF for the session first (else that interaction is not
needed. DNS AF needs to be deployed before NAT. The IP address is complemented
with a Domain Id in overlapping IPs scenarios.
3c) DNS AF sends to PCF a Npcf_PolicyAuthorization_Create request (Subscribe
if the session already exists), by which the DNS AF initiates a network access
information request for the PDU session (identified by the UE IP address). An
afAppId decorated with the AppId corresponding to the FQDN allows PCF to
authorize this request for a specific PDU Session and application.
4\. The PCF authorizes the request and creates/updates the individual App
session context
5\. The PCF checks whether NetLoc feature is supported by the SMF.
6\. If the request is authorized and NetLoc feature is supported, then PCF
responds with a 201 created message.
7\. If not created already, then the DNS AF creates the APP session context
for this IP address and starts a timer to monitor time until UE location
response.
8\. PCF requests user location from the SMF via
Npcf_SMPolicyControlUpdateNorify message
9\. SMF responds with a 201- Created.
10\. If latest Location is not available, SMF invokes Namf_EventExposuire
service with Onetime Report type as in TS 29.518 [41], clause 5.3.1.
11\. SMF sends UE location info to PCF in a NPcf_SMPolicyControlUpdate
message.
12\. PCF responds with a 200 OK message.
13\. PCF sends UE location info via Npcf_PolicyAuthorization Notify message to
the DNS AF.
14\. DNS AF responds with 204 No Content.
Figure 6.3.2.2-2: Detailed sequence diagram of EAS discovery and dynamic
traffic steering by the MNO in the DNS AF solution. Second part.
15\. UE Location and FQDN are input to the Translation Table (if session
context indicates an ULCL/PSA already in the path, it is also considered in
the decision). The output: ECS option to be used for the DNS query.
16\. As step 3 in Figure 6.3.2.1-1.
17\. As step 4 in Figure 6.3.2.1-1.
18\. As step 5 in Figure 6.3.2.1-1.
19\. If an ECS is received, AF Influence on routing is triggered: The steering
Policy (target DNAI and steering profile) is determined from the ECS &FQDN&
SLA info from the Translation table. The DNS response is buffered. If SLA
states QoS specific needs that is also identified at this stage.
20\. DNS AF sends to PCF a Npcf_PolicyAuthorization Update request requesting
Update traffic routing to the target DNAI, steering profile and QoS specific
needs. An actVal is also specified as a timer to monitor inactivity of the
given EC service.
21\. PCF decides the policies and provisions the corresponding PCC rules to
the SMF which instruct SMF to steer the corresponding user traffic to the
provided DNAI.
22\. SMF selects the ULCL/PSA & Insert/Update as in clause 4.3.5.4 of TS
23.502 [3]. Usage reporting for those Flows is activated at the local PSA to
track activity.
23\. When ready, SMF notifies the DNS AF of the DNAI change.
24\. The DNS Response is sent to the UE once those actions have been completed
(the ECS option is removed before). The application traffic starts towards the
IP Address received. That traffic is diverted by the ULCL and sent via the
selected PSA to the N6 access to the DN that is topologically close to the AS
(assuming the Service Provider selection was correct).
NOTE: Steps 25-29 below describe the reverse procedure i.e., removing the
local ULCL/PSA for an EC application).
25\. Inactivity triggers ULCL/Local PSA removal in the SMF as in TS 23.502
[3].
26\. When ready, SMF notifies the DNS AF of the DNAI change.
27\. DNS AF deletes the APP session context for this PDU session and this EC
app.
#### 6.3.2.3 High-level procedure using DNS forwarding
As an alternative to the procedure described in Figure 6.3.2.1-1, in step 3
the DNS AF, based on user location and SLA, forwards the request to a DNS
serving the location of the UE. In this case, the response does not include
the ECS. The DNS AF needs to determine based on the DNS response and the SLA
the most suitable local PSA and then proceeds as from step 6 in Figure
6.3.2.1-1.
### 6.3.3 Impacts on services, entities and interfaces
The DNS AF may act as an MNO internal AF, and use available 5GC APIs to
communicate with the CN entities to authenticate UEs/services, to infer UE
location and to trigger traffic steering, as described in the detailed flows
in clause 6.3.2.2.
The DNS AF should be defined as a 3GPP NF and its usage of existing 5GC
procedures should be described in the 3GPP specifications.
PCF and Npcf should be updated to be able to convey and infer the AppId
corresponding to the FQDN from afAppId and thus to authorize the procedure for
a specific PDU Session.
Inactivity triggers ULCL/Local PSA removal in the SMF as in TS 23.502 [3]
An actVal is also specified as part of Nnef_TrafficInfluence API (and
corresponding PCC rules) as a timer to monitor inactivity of the given EC
service.
## 6.4 Solution #4: Providing the DNS authoritative server with IP addressing
information about where the UE is located
### 6.4.1 Description
This solution is based on following principles:
\- The solution supports the different EAS and application deployment
described in KI 1 (e.g. the EAS and/or the App may be owned/operated by the
MNO or by a third party);
\- The solution assumes no impact on the Application itself; and
\- The solution is transparent to the UE: the UE issues plain DNS requests
targeting the FQDN of the Application and receives the corresponding IP
addressing information; The UE neither needs to know whether the Application
is to be reached \"locally\" or \"centrally\" (and does not need to know pure
network aspects such as DNAI) nor needs to know EAS and/ or Application
ownership aspects (e.g. the EAS is owned by the MNO or by a third party);
\- the solution supports following models: Distributed Anchor Point, Session
Breakout and Multiple PDU sessions. The solution applies regardless of whether
the DNS server is contacted via the unique PSA of the PDU session or via a
local PSA of the PDU Session (Session Breakout model).
Many Authoritative (DNS) Name servers today return different responses based
on the perceived topological location of the user. They determine the address
to return to the DNS client based on
\- IP addressing information about the client: this may correspond to the
source IP address of the DNS request or to the edns-client-subnet (ECS) EDNS0
option described in RFC 7871 [7] \"Client Subnet in DNS Queries\", and
\- topological information about the different (e.g. EAS) servers that support
the FQDN (or shorter domain) targeted by the DNS request.
The solution is described assuming the Authoritative (DNS) Nameserver may be
operated by a 3rd party (so an entity distinct from the MNO) who for the
target domain of a DNS request may also operate the corresponding different
(e.g. EAS) servers.
The goal is to provide the Authoritative (DNS) Nameserver with addressing
information about the initiator (the UE) of the DNS request that refers to an
IP address / prefix related to where the UE is currently located and not with
the IP address / Prefix of the UE.
The Authoritative (DNS) Nameserver may get such addressing information:
\- in the source address of the DNS request: this may correspond to:
\- NAT enforcement at the local UPF or to;
\- usage of a local Prefix as Source Prefix for DNS traffic issued by a UE
that supports IPV6 multi-homing.
\- in an edns-client-subnet (ECS) also called DNS IP subnet option (RFC 7681
[28]) added by a local resolver:
\- this local DNS resolver may be involved by the local UPF upon control of
the SMF; or
\- this local DNS resolver may be involved due to a DNS server configuration
option sent by the SMF to the UE within a Router Advertisement (in this case
the DNS requests from the UE directly target the local DNS resolver).
When secured DNS (DoT) is supported on the DNN, the entity (stand-alone DNS
resolver in the case 2a/2b of clause 6.4.2 or DNS forwarder co-located within
UPF in case 2c of clause 6.4.2) adding an edns-client-subnet (ECS) DNS IP
subnet option (according to RFC 7681 [28]) in DNS requests from the UE shall
terminate the TLS interface with the UE. This entity may also have local
policies to remove an edns-client-subnet (ECS) DNS IP subnet option (according
to RFC 7681 [28]) that the UE would have provided.
For deployments where the local DNS resolver / DNS forwarder is reachable by
an anycast address, it is not needed to update the UE with the DNS server
address (and security parameters when DoT applies) when ULCL or IPV6 BP
insertion/change happens. Otherwise the SMF may need to update the UE
according to the most local DNS resolver / DNS forwarder.
NOTE: The most local DNS resolver (and the proper authoritative server) are
not always reachable via the most local PSA (see also Figure 6.4.2-4).
There is no need to configure the DNS resolver or the DNS forwarder with
whether a local N6 interface of the PDU Session allows to contact an EAS
serving the FQDN target of a DNS request (such request may not relate to Edge
Computing services). The authoritative server simply ignores an edns-client-
subnet (ECS) DNS IP subnet option that does not correspond to any
configuration for the target FQDN.
The solution describes the Pre-established ULCL/Local PSA insertion and does
not currently address the dynamic insertion of a more local UPF based on DNS
interactions with the UE.
Editor\'s note: It is FFS whether the solution can support insertion of a more
local UPF based on DNS interactions with the UE. It could support UPF
notifications to the SMF about DNS responses referring to some IP address
ranges IF the DNS exchanges are sent in clear or if the UPF terminates TLS
exchanges with the UE related with DoT.
### 6.4.2 Procedures
The solution differentiates following phases:
\- Configuration phase run once per PDU Session or once when a local UPF (UL
CL / BP) is inserted:
The solution does not address how PDU Session(s) used by the UE are
established but assumes such PDU has been established.
\- Execution phase run each time a UE issues a DNS request targeting the FQDN
of an App.
**Configuration phase:**
00\. The SMF keeps track of the DNS server address sent to the UE at PDU
Session establishment or when UL CL / BP is inserted (e.g. in PCO or via
DHCP).
0\. The SMF configures the most local UPF(s) serving the PDU Session with:
\- a PDR identifying the traffic targeting the DNS server(s) whose address(es)
have been provided to the UE;
\- (at the UPF acting as PSA) a FAR that may ask the UPF to carry out one of
following actions:
\- Tunnel DNS requests from the UE towards the address of a local DNS resolver
(N6 tunnelling as defined in TS 23.501 [2] clause 5.6.7);
\- NAT the DNS requests from the UE in order that the source address of the
request refers to the local PSA and not to the UE IP address / Prefix and/or
to. The solution does not assume that UPF NATing is controlled over N4. UPF
NATing corresponds to local policies in the UPF that are related to the
network instance.
\- apply a local DNS forwarder that is to add a DNS IP subnet option.
The UPF that is/are configured as above may e.g. be:
\- in the case of Distributed Anchor Point or of Multiple PDU sessions: the
PSA of the PDU Session;
\- in the case of Session Breakout: a UPF acting as UL CL for the PDR
mentioned above and a UPF acting as local PSA for the FAR mentioned above.
NOTE 1: The most local UPF(s) serving the PDU Session corresponds to the
unique PSA in case of distributed anchor or multiple PDU Session and to the
most local UL CL and PSA in case of Session Breakout.
0\. The DNS server address may correspond to an anycast address that
corresponds to a local DNS resolver;
(UE that supports IPV6) The SMF configures the UE with a new DNS server
address corresponding to a local DNS resolver via an unsolicited Router
Advertisement.
**Execution phase:**
1 The UE issues a DNS request targeting the FQDN of an App
(service.example.com in the figures). The PDU Session in which to send the DNS
request is controlled by URSP rules. The DA of the DNS request is the DNS
server address of this PDU Session configured by the 5GC (SMF) to the UE. If
the UE uses IPv6, the DA of the DNS request is the most recent DNS server
address associated with this PDU Session sent via unsolicited Router
Advertisement.
2a The UPF based on the N4 session configuration received from SMF in step 0,
forwards the request after having NATed it (e.g. UPF invoking NAT per local
policies related with the network instance). This allows to reach a possibly
remote DNS resolver with a source address identifying the UE location. If IPV6
multi-homing is supported on the PDU Session, this is replaced by the SMF
sending to the UE rules according to RFC 4191 [29] to use as source prefix the
UE Prefix associated with the local traffic offload.
2b The UPF acting as PSA based on the N4 session configuration received from
SMF in step 0, forwards (via N6 tunnels) the request to a (local) DNS
resolver.
NOTE 2: This forwarding does not change the inner destination address within
the tunnel i.e. it does not change the address of the DNS server as set by the
UE.
2c The UPF based on the N4 session configuration received from SMF in step 0,
processes the request in a co-located DNS forwarder and then forwards the
request to a DNS resolver. The co-located DNS forwarder uses a locally
configured value to populate the edns-client-subnet option.
NOTE 3: The UPF in steps 2a, 2b and 2c above can correspond to a local PSA
associated with an UL CL or can be the \"central\" (unique) UPF in case no
traffic offload takes place for the PDU Session. In the case of distributed
anchor, NAT or tunnelling is not needed as the IP address of the UE identifies
where the UE is located. The solution nevertheless works with the DNS resolver
using the actual UE address.
NOTE 4: Other IP forwarding techniques than tunnelling are possible in case 2b
(e.g. the DNS server address provided to the UE is an anycast address).
NOTE 5: When the UPF in steps 2a, 2b and 2c above corresponds to a local PSA
associated with an UL CL, it is FFS whether and how this solution supports the
scenario where the edge computing hosting environment has no connectivity with
the central data network.
3 The local resolver adds a preconfigured addressing information in an edns-
client-subnet (ECS) EDNS0 option (RFC 7871 [7]):
\- in deployments along case 2a) the local resolver uses the source address
(or Prefix) of the DNS request to populate the edns-client-subnet option;
\- in deployments along case 2b) the local resolver uses a locally configured
value to populate the edns-client-subnet option.
4 the Authoritative DNS Server can use the EDNS Client Subnet option to
provide an answer depending on where the UE is located. The UE location may
not be the only parameter taken into account as the authoritative server may
consider other aspects such as the relative capacity and (over)load of the EAS
etc. The policies of the Authoritative DNS Server may thus be configured by an
application provider that may be the MNO or may be a third party with which
the MNO has an agreement.
Figure 6.4.2-1: DNS handling with UL CL and NAT
NOTE6: The NAT may be co-located with a local PSA or may be located on N6
between the PSA and the DNS resolver.
Figure 6.4.2-2: DNS handling with UL CL and no NAT but a local DNS resolver
NOTE7: The UPF applying tunnelling in Figure 6.4.2-2 is a (local) PSA.
Figure 6.4.2-3: DNS handling with an integrated DNS forwarder
The DNS handling with a DNS forwarder integrated in the UPF may be leveraged
in the case where a very local EAS is deployed in a site with no DNS
capability i.e. in a site closer to the UE than the site where DNS resolvers
are deployed. This is depicted in following Figure 6.4.2-4.
Figure 6.4.2-4: Deployment with an EAS more local than the DNS Resolver
In the deployment of the Figure 6.4.2-4, the SMF when it has inserted the very
local UPF0 can control over N4 (via modified FAR) the DNS forwarder in UPF1 to
add a edns-client-subnet option indicating UE presence over the local N6
supported by UPF0 (with an IP address / Prefix referring to the local N6
interface of the UPF0).
### 6.4.3 Impacts on services, entities and interfaces
\- for the Authoritative DNS Server: use the EDNS Client Subnet option to
provide an answer that may depend on the UE location.
\- for the local DNS resolver: adds a preconfigured addressing information in
an edns-client-subnet (ECS) EDNS0 option that is determined:
\- in deployments along case 2a) using the source address (or Prefix) of the
incoming DNS request;
\- in deployments along case 2b) unconditionally using a locally configured
value.
\- for SMF and UPF: using existing Rel-16 mechanisms for traffic NATing /
tunnelling over N6. If Anycast addresses for the DNS Resolver are not used,
the SMF may need to update the UE according to the most local DNS resolver.
\- for the option 2c (local DNS forwarder): UPF to support a local DNS
forwarder that can add an edns-client-subnet (ECS) EDNS0 option based on N4
requests from the SMF (using modified FAR).
## 6.5 Solution #5: Server Discovery using DNS and IP Routing
### 6.5.1 Description
This contribution derives its procedures on UE behaviour, provisioning of
distance metrics, guidelines on the UE address to be used in DNS client subnet
option RFC 7871 [7] and flow sequence with classic DNS [9], DoT [10] and DoH
[11].
Connectivity models 1, 2 and 3 (distributed anchor point, session breakout,
multiple PDU sessions) are supported. In all connectivity models, MNOs can
utilize and scale existing DNS servers independent of edge compute topology.
The MNO may also deploy DNS infrastructure more locally to improve DNS
resolution latency. MNO DNS infrastructure can use DNS best practices for
query latency, resilience, mitigating DDoS etc with this architecture.
Connectivity models 1, 3 use standard IP anycast routing to reach an
application server. Session breakout (model 2) requires installing AF
influenced routes in UPF-ULCL to steer application traffic to a local UPF-PSA
(described in clause 6.5.2.5).
Hosting models identified in clause 5.1 are supported in this solution.
Private edge hosted resources maybe secured via zero trust models with per
application session authorization, or with VPNs and may have no direct access
to central DN. Client subnet (RFC 7871 [7]) information for UE location is
based on the egress address at UPF-PSA. Provisioning of DNS backend with MNO
OAM information is managed with specific authorization and access to the
private domain.
The UE does not need any additional mechanisms or awareness to select a server
in the Edge Hosting Environment. DNS provisioning and client subnet (RFC 7871
[7]) mechanisms representing the DNAI, IP subnet at UPF PSA result in the
selection of EAS as provisioned.
Application layer mechanisms to optimize URL handling or reselect EAS are
transparent in this proposal. Application layer hints for optimization (DNS
prefetch, TCP preconnect) operate seamlessly since no change is made at the
UE. An application with multiple services (URLs) and resources in different
DNs can be served over the same PDU session.
When a UE re-attaches and accesses application resources from a new IP
subnet/DNAI (i.e., new UPF-PSA), the previously discovered addresses (IP
anycast) are reachable. Standard IP anycast routes (model 1,3) and AF
influenced routes (model 2) are used to route. No additional DNS queries are
needed and thus reduces application latency and jitter during this phase.
EAS rediscovery when a previous EAS becomes sub-optimal or unavailable relies
on the application layer redirect to a new resource instance (URL), followed
by DNS resolution and anycast forwarding as in the initial discovery process.
IP anycast routing (standard and AF influenced) provide network support for
fast re-routing, load balancing and failure mitigation without per UE/flow
control plane intervention.
A locally distributed UPF with IP anchor is used to access the Edge services.
The sum of these provide a complete set of procedures for EAS selection:
1\. Rel-16 procedures are used to setup the PDU session (clause 6.5.2.1).
2\. PDU session /UPF-PSA (step 1) is used to send DNS query/response. Clause
6.5.2.2 describes the DNS behaviour at UE.
3\. First DNS resolver adds source IP Address in DNS request in DNS Client
Subnet Option (RFC 7871 [7]) to provide DNS location. The source IP address is
the address for the DNS packet at the UPF-PSA egress interface. Details are in
clause 6.5.2.3.
4\. The authoritative DNS server uses distance, other metrics for selecting
the closest server. Via SLA, configuration, OAM, or subscription, the AF is
provisioned or collects these metrics. UE source IP address (at UPF-PSA
egress) and corresponding metrics collected is used by AF to configure DNS
backend.
5\. Flow sequences for classic, DoT (clause 6.5.2.5) and DoH (clause 6.5.2.6)
describe the flow sequences using the procedures in steps 1 - 4.
### 6.5.2 Procedures
#### 6.5.2.1 Establishing PDU Session (assuming existing 5GS capabilities are
used)
This solution assumes that Rel-16 procedures are used to setup the PDU
session. For example, during UE initial or mobility registration, URSP policy
could be provisioned that along with S-NSSAI and other parameters allow SMF to
setup appropriate PDU session and UPF-PSA.
When the UE needs to send traffic destined to an edge service, the UE triggers
the Edge AS discovery by sending a DNS query for an FQDN of the edge service.
The details for this step are described in clause 6.5.2.2. After this, the
Application Client sends an application layer service request to an IP address
of the EAS in the Edge Hosting Environment.
#### 6.5.2.2 DNS behaviour at UE
A UE can perform discovery by performing the following procedures:
1\. Application Client attempts to access a resource at a certain URI:
a. Resource request is handled by the UE operating system;
b. UE extracts the domain name;
c. If needed, UE performs PDU Session establishment with activation of user
plane resources;
d. UE performs DNS query for the IP address associated with the domain name.
2\. The UE performs DNS query for the IP address associated with domain name:
a. The DNS query is sent to either:
i. the DNS resolver configured in the UE;
ii. the DNS resolver provided by the serving MNO in step 1c.
b. The DNS resolver recursively queries root nameservers & authoritative
nameservers to retrieve the IP address(es) currently associated with that
domain name.
With some existing extensions to DNS, the authoritative (DNS) nameserver may
return different responses based on the perceived topological location of the
user. This is described in clause 6.5.2.3.
c. This information is recursively returned to the DNS resolver, which
responds to the requesting UE with the resolved IP address.
NOTE 1: This complete sequence of queries is not necessarily performed every
time a request is made. At each step, a DNS server may respond with a cached
copy of the information.
NOTE 2: In the case of Edge Computing, the returned IP address is likely to be
an IP Anycast address, contrary to the way server IP addresses are discovered
via application-layer solution (e.g. by HTTPS). This allows a single IP
address to be resolved to the most local server to the source UE identified by
the IP anycast destination address.
3\. The UE attempts to access a resource at a certain IP address (e.g. HTTP
PUT, GET, POST).
a. The UE creates and sends a packet to the destination IP address as
discovered in step (2) of this solution;
b. IP routing takes place to determine the most suitable path for the packet
on a hop-by-hop basis;
c. In the case of IP anycast, a single destination address may have multiple
routing paths to two or more endpoint destinations;
d. The routing differs between IPv4 (which uses Border Gateway Protocol (BGP))
and IPv6 (which supports Anycast natively) but, in both cases, the system will
route the anycast packet to the \"nearest\" host with the anycast address.
NOTE 3: \"nearest\" is determined in terms of metrics which may be based on
other parameters than geographic location (e.g. lowest cost, least congested,
shortest time).
As a result, the UE accesses the resource from the \"closest\" server.
DNS stub resolvers for DoH and DoT (encrypted DNS modes) may be set per
application or system wide by the UE OS DNS resolver and this behavior varies
from OS to OS. A wide range of UE DNS stub resolver with different TTL/caching
at OS or application layer should work seamlessly over a PDU session to a DNS
network resolver located at an MNO (central or local) or a 3rd Party Provider
(3PP) location. To support this, the application address should be provisioned
such that DNS will answer with the same address for a wide network area and
over a large time period.
Anycast addresses provisioned by the application domain and dynamic N6 routing
allows:
a) Consistent DNS answer over a wide network area and a long time period; thus
permitting various UE DNS operation modes, UE mobility and access to network
DNS resolver over different PDU session connection modes.
b) Dynamic N6 routing to select EAS/ server instance corresponding to
application domain service provisioning for an application anycast address.
#### 6.5.2.3 UE IP Address in DNS Client Subnet Option
Many Authoritative (DNS) Nameservers today return different responses based on
the perceived topological location of the user. They determine the address to
return to the DNS client based on
\- IP addressing information about the client: this may correspond to the
source IP address of the DNS request or to the edns-client-subnet (ECS) EDNS0
option described in RFC 7871 [7] \"Client Subnet in DNS Queries\", and
\- topological information about the different (e.g. EAS) servers that support
the FQDN (or shorter domain) targeted by the DNS request.
The solution is described assuming the Authoritative (DNS) Nameserver may be
operated by a 3rd party (so an entity distinct from the MNO) who for the
target domain of a DNS request may also operate the corresponding different
(e.g. EAS) servers.
The goal is to provide the Authoritative (DNS) Nameserver with the IP address
of the UE at the UPF-PSA egress interface.
If the UE is assigned an externally non-routable IP address (IPv4 NAT, non-
topological IPv4 or IPv6), the UPF-PSA rewrites the UE IP address with an IP
address routable to the UPF-PSA. A table between the UE assigned IP address,
mapped routable IP address is kept at UPF-PSA and no per-UE state is required.
TLS context (for DoT), HTTPS context (DoH) is transparent with the address
mapping. If DNS is used within a IPSec VPN, IP header checksum is recalculated
at the UPF-PSA. The IP address of the PDU session of UE seen by DNS and EAS
are those at UPF-PSA external interface.
The MNO DNS (acting as a DNS resolver) will use the UE source IP address seen
at egress UPF-PSA for DNS client subnet option, RFC 7871 [7]. This source IP
address is representative of UE location /N6 interface and can thus be used by
the authoritative DNS server in determining the best EAS (based on the
provisioned information at the DNS backend - clause 6.5.2.4).
#### 6.5.2.4 Provisioning Metrics in AF
Via SLA, configuration, OAM, or subscription, the AF is provisioned/collects
the metrics that are used to provision the DNS authoritative server. The DNS
selects the most optimal EAS when the DNS authoritative server for the FQDN is
provisioned with the IP subnet /DNAI from where the UE DNS query is
originating and the closest LDN. This also applies to cases in which the
Authoritative (DNS) Nameserver may be operated by a 3rd party. It is assumed
there is SLA between the parties and the details are outside the scope of the
3GPP.
The AF could subscribe to metric information available in OAM and use to
provision the DNS server for an FQDN. This information could be made available
to the AF via SLA and/or OAM configuration. The N6 IP address/subnet
information that gets provisioned here corresponds to the IP address
information that is subsequently sent in the DNS query with client subnet
option, RFC 7871 [7]. During application server selection over the established
PDU session, a UE DNS query gets an answer with anycast address for the
application and corresponding to the subnet location in ECS. N6 measurements
from OAM may be used by the application domain but how the AF/ application
domain controllers configure the DNS backend is out of scope.
Application domain controller also uses N6 network measurements provided by
OAM, along with other application domain policy for server load balancing,
failures, DDoS mitigation, etc. Anycast IP route information is derived and
pushed to N6 routers corresponding to EAS instances provisioned by the
application domain. This is used by N6 routers to forward application packets
from the UE to the \"closest\" application server (determined in terms of
geographic location or other parameters such as lowest cost, least congested,
shortest time). These procedures are in the N6 network and application domain
and have no direct procedure impacts to 5GC.
#### 6.5.2.5 AF Influenced Routes for Session Breakout
AF signals routes that it wants to influence after it has configured the EAS,
services in DNs and configured the ADNS with respective FQDN and resolution to
service IP address (anycast address).
Figure 6.5.2.5-1: AF Influenced Route
The sequence described here is based on flow in TS 23.502 [3], clause 4.3.6.2
- AF influenced traffic routing for sessions not identified by a UE address.
Route information corresponding to the services configured at a DNAI in the
application domain is provisioned.
1\. AF orchestrates and configures application in EAS (and AS) at various data
center locations. The service is exposed via DNS using anycast service address
(srv-IP-addr) and DNAI. The AF configures information at the ADNS
(Authoritative DNS) with service/FQDN and address resolution to srv-IP-addr.
2\. AF sends Nnef_TrafficInfluence_Create service operation to NEF. The
message includes anycast service address (srv-IP-addr) and a list of DNAI at
which it is configured.
NOTE: FQDN is not provided since it is not necessary for AF influenced
routing.
3\. NEF performs the necessary authorization control and adds S-NSSAI (slice
information).
3a. The NEF sends AF information request to the UDR to be stored (data
set/subset/ key) as in TS 23.502 [3], clause 4.3.6.
3b. NEF sends response to AF.
4\. PCF(s) that have subscribed to modifications of AF Traffic Influence data
set/subset are notified.
5\. PCF determines if existing PDU sessions are affected by the new AF Traffic
Influence data set.
For each of these PDU session, PCF updates the SMF with new PCC rules.
6\. When a PCC rule is received, SMF takes actions to (re)configure the user
plane:
\- For PDU session modification where central UPF-PSA has been established,
SMF adds ULCL and local UPF-PSA.
\- For new PDU session, SMF may establish central UPF-PSA as well as ULCL and
local UPF-PSA.
\- If PCC rule is updated due to failure, SMF may reselect local UPF-PSA/ULCL.
The configuration sequence above may be used for publicly accessible
applications or for private applications. For example, private deployments
with VPNs would expose the VPN connectivity gateway only. For private
deployments with zero trust and more granular access, each service with access
is exposed separately (e.g., address of DoH, address of each application
service(s)).
The flow sequence below illustrates UE DNS and application access following
registration and PDU session setup.
Figure 6.5.2.5-2: Traffic Steering at ULCL
The figure above describes the sequence of steps for registration and PDU
session establishment/modification:
1\. UE registers with the AMF using procedures in TS 23.502 [3], clause 4.2.
In addition, the UE is either configured, or dynamically provided with URSP
rules that indicate the slice (S-NSSAI) to use for edge applications or
subsets of applications.
2\. UE launches application, selects S-NSSAI for the PDU session.
UE initiates PDU session establishment request with S-NSSAI.
3\. AMF selects an SMF and sends Nsmf_PDUSession_CreateSMContext request to
the SMF.
4\. SMF selects PCF and requests policy for the PDU session with S-NSSAI using
Npcf_SMPolicy_Control interface.
5\. PCF fetches policy for the PDU session. This includes a list of service IP
addresses for the DNAI.
6\. PCF responds to SMF with Npcf_SMPolicyControl Response.
7\. SMF selects UPF as described in TS 23.502 [3], clause 4.3.2.2.1.
8\. SMF programs UPF(s) over N4 interface.
SMF provisions the UPF-PSA (local and central) as specified in TS 23.502 [3].
UPF-ULCL is additionally provisioned with FAR traffic filters for destination
address corresponding to the list of service IP addresses. The action is to
forward to local UPF-PSA.
9\. PDU session establishment is completed as described in TS 23.502 [3],
clause 4.3.2.2.1.
10\. UE sends DNS Query as an application message over the established PDU
session.
If no rules are corresponding to DNS destination address, the message is
forwarded to the central UPF-PSA. If there is a rule with destination address
(e.g., DoH in private network), the ULCL forwards the request to the local
UPF-PSA.
For VPNs all application messages will be forwarded to the matched destination
address.
No inspection of DNS message (query /response) is necessary and thus supports
Do53 (classic), DoT and DoH.
DNS response with A/AAA record srv-IP1 is received by UE.
11\. UE sends application request with destination address of \"srv-IP1\".
UPF-ULCL checks rules for match with \"srv-IP1\" and forwards to local UPF-PSA
on successful match.
#### 6.5.2.6 Flow Sequence Classic DNS and DoT
The application in UE contacts the DNS stub server to resolve the FQDN for the
application. The DNS query is resolved by the authoritative DNS server for the
domain of the FQDN. The sequence in flow diagram below uses standard DNS (both
plain and DoT) with no impact to the UE.
Figure 6.5.2.6-1: DNS to resolve EAS address
1\. Following PDU session setup /application launch with a Uniform Resource
Locator (URL) in UE, the FQDN portion of the URL is used by the UE to initiate
a DNS query (clause 6.5.2.1). Details of how the UE handles the request is in
clause 6.5.2.2.
This request is sent over the established PDU user plane and over N6. DNS
query packet has topologically correct UE source address when DNS resolver
gets it (see clause 6.5.2.3).
2\. DNS resolver forwards the DNS query to an authoritative DNS server for
that FQDN. The DNS resolver adds a client subnet option, RFC 7871 [7] with the
UE IP address/prefix to assist the authoritative server to select an EAS that
is \"close\" to the IP subnet from which the query originated.
(in case of Distributed Anchors or of usage of a local PSA) Source IP address
of DNS query packet at UPF-PSA egress is representative of UE location /N6
interface and is used to derive location appropriate A/AAAA records.
3\. The DNS authoritative server translates and returns a list of IP addresses
for EAS which the UE may try. DNS server matches client subnet identifier with
record for FQDN to srv-IP-addr (EAS) and returns A or AAAA resource record
(RR). The DNS resolvers on path may cache the response.
4\. Application uses the IP address in DNS response to route the application
request packet. If the address is a unicast address, the N6 network forwards
it to EAS. If it is an anycast address, the N6 network selects the best
instance of EAS servers based on dynamic IP route information in N6.
#### 6.5.2.7 Flow Sequence for DoH
Figure 6.5.2.7-1: DoH to resolve EAS address
1\. Following PDU session setup /application launch with a Uniform Resource
Locator (URL) in UE, the FQDN portion of the URL is used by the UE to initiate
a DoH request (clause 6.5.2.1). Details of how the UE handles the request is
in clause 6.5.2.2.
This request is sent over the established PDU user plane and over N6. DoH
packet has topologically correct UE source address when DoH server gets it
(see clause 6.5.2.3).
2\. DoH server creates the DNS query to an authoritative DNS server for that
FQDN. The DoH server adds a client subnet option, RFC 7871 [7] with the UE IP
address/prefix to assist the authoritative DNS server to select an EAS that is
\"close\" to the IP subnet from which the DoH request originated.
(in case of Distributed Anchors or of usage of a local PSA) Source IP address
of HTTPS packet at UPF-PSA egress is representative of UE location /N6
interface and is used to derive the location appropriate A/AAAA records.
3\. The DNS authoritative server translates and returns a list of IP addresses
for EAS which the UE may try. DNS authoritative server matches client subnet
identifier (or UE IP address seen at UPF-PSA egress in DoH) with record for
FQDN to srv-IP-addr (EAS) and returns A or AAAA resource record (RR).
DoH server returns the results received from DNS to the UE.
4\. Application uses the IP address in DNS response to route the application
request packet. If the address is a unicast address, the N6 network forwards
it to EAS. If it is an anycast address, the N6 network selects the best
instance of EAS servers based on dynamic IP route information in N6.
### 6.5.3 Impacts on services, entities and interfaces
AF, NEF, UDR and PCF should support traffic influenced routing in TS 23.501
[2], clause 5.6.7. PCF should store the routes per DNAI and provide it SMF
during the session establishment process.
SMF and UPF-ULCL use existing Rel 16 procedures to install traffic filters
using N4 interface.
UPF-PSA should rewrite non-topological IP source address to topologically
correct IP address in outgoing packets (source IP address may be topologically
incorrect as a result of NAT or assigning non-topological IPv4 /IPv6 addresses
to the UE). UPF maintains table to maps incoming packet destination IP address
to that of the original outgoing IP address. The translation is done for non-
topological source address in all packets including Do53 (UDP), DoT (TCP) and
DoH (HTTPS)/other application packets.
The DNS resolver in 5GC should support adding the source IP address observed
in incoming DNS query packets as client subnet option (RFC 7871 [7]) when it
forwards a DNS query. This functionality may be implicit in Rel 15 and Rel 16
but should be specified since it affects DNS client id for UE location.
The UE should be configured to use URSP procedures to setup the PDU session
prior to sending a DNS query.
The application domain should provision anycast application addresses for EAS
and in DNS so that a wide range of UE DNS resolvers and different PDU session
connection modes in 5GC can be supported. N6 transport provider should support
dynamic IP route updates corresponding to application domain service
provisioning for an application anycast address. Both, anycast and dynamic IP
routing are widely deployed in CDN and application networks. Anycast
application addresses and N6 routing have no other direct impact to 5GC
procedures.
## 6.6 Solution #6: Discovery of EAS based on DNS
### 6.6.1 Description
This solution addresses the key issue#1: Discovery of EAS, by reusing the DNS
mechanism without additional impacts on UE.
This solution is compatible with the two deployment options of DNS servers as
shown in Figure 6.6.1-1:
\- The DNS servers can be centrally deployed by MNO and responsible for
resolving the FQDN received from UE into the IP address of a suitable EAS.
In this solution, it is assumed that centralized DNS server stores the
knowledge of edge computing platforms deployment based on e.g. configuration.
The centralized DNS server may perform recursive DNS query with other DNS
servers, if needed.
\- The DNS servers can be locally deployed within edge hosting environment and
responsible for resolving the FQDN received from UE into the IP address of an
EAS within the Local DN.
This solution applies for \"Distributed PSA\" PDU session (by not inserting
ULCL/BP) and \"Session Breakout\" PDU session(by inserting ULCL/BP). If UE has
multiple PDU sessions, the solution applies for each of the PDU sessions.
Figure 6.6.1-1: Two deployment options of DNS servers
To resolve the requested FQDN into the IP address of an EAS optimized to
current UE location, the 5GC should either provide information on UE\'s
location as specified by RFC 7871 [7] to the centralized DNS server or select
an appropriate localized DNS server to resolve the DNS query locally.
The solution uses the SMF as a DNS forwarder. For this purpose the SMF for PDU
session with only remote PSA needs to receive all DNS requests from the UE(s)
and then to forward them (to a DNS Server/Resolver).
The SMF controls the UPF(s) via existing N4 procedures to receive over N4 all
DNS requests from the UE(s).
The SMF may obtain the FQDNs supported by EAS corresponding to each DNAI by AF
influence traffic routing procedure or by configuration. The SMF may also be
configured with the following information:
\- The mapping relationship between the DNAI and the IP address accessing to
edge computing platform for N6 (e.g., the subnet after NAT).
\- The address of localized DNS server serving each DNAI.
The UE is configured with a DNS server by the SMF during PDU session
establishment. When the UE issued a DNS query to the configured DNS server,
the SMF selects DNAI based on UE location, the received DNS query and DNAIs
supporting the FQDN, then:
\- If DNS query is received from UPF, the SMF, determines the IP address
corresponding to the selected DNAI and sends DNS query to centralized DNS
server including this IP address as specified in the ECS option of RFC 7871
[7]. The SMF may select ULCL/BP and a new PDU Session Anchor (local PSA) for
this PDU session based on the IP address and/or FQDN of the EAS included in
the DNS response.
\- Based on local policy the SMF may configure filter rules on the ULCL (e.g.
the destination of IP address, destination port number and optional FQDNs) or
the BP (e.g. the new IP prefix @ local PSA and optional FQDNs) in order to
route the subsequent DNS queries from UE to local PSA.
\- In the case of IPv6 multi-homing, the SMF notifies the UE of the
availability of the new IP prefix @ PSA2 using an IPv6 Router Advertisement
message (RFC 4861 [32]). Optionally, in this RA message, the SMF may notify UE
the new address of DNS server (RFC 8106 [33]) and indicate the UE to contact
with DHCP server to get the DNS-related configuration information (RFC 4861
[32]), which is used to select DNS server for a target FQDN (RFC 6731[26]).
\- Also, the SMF sends IPv6 multi-homed routing rule along with the IPv6
prefix to the UE to influence the selection of the source Prefix for the
subsequent DNS queries(RFC 4191 [29]) as described in TS 23.501 [2] clause
5.8.2.2.2. The SMF may re-configure the UE for the Source IP prefix @ PSA1.
\- If DNS query whose destination address is the address of the centralized
DNS server is received from ULCL, the local PSA, reroutes the DNS query to the
localized DNS server based on the N6 routing rule configured by SMF.
\- If DNS query is received from BP, the local PSA forwards the DNS query to
the corresponding DNS server based on the destination address.
NOTE 1: The localized DNS server may be part of Edge Hosting Environment.
NOTE 2: The address of centralized DNS server and localized DNS server may be
anycast address.
### 6.6.2 Procedures
The discovery of EAS based on DNS mechanism can be described in the Figure
6.6.2-1.
Figure 6.6.2-1: Two scenarios for the discovery of EAS based on DNS
1\. The SMF may obtain the FQDNs served by EASs corresponding to each DNAI by
configuration, or the AF may provide DNAIs along with the FQDNs served by the
EASs during AF influence traffic routing procedure (FQDN is a new parameter to
the AF influence to the traffic routing procedure).
The SMF may also be configured with the following information:
\- The mapping relationship between the DNAI and the IP address accessing to
edge computing platform for N6 (e.g. the subnet after NAT, this requires co-
ordinated management between the SMF and NAT server).
\- The address of localized DNS server serving each DNAI. An anycast IP
address may be used for the localized DNS servers.
2\. During PDU Session Establishment procedure, the PCF provides the PCC rules
to the SMF. The PCC rules may include the FQDNs served by EASs corresponding
to each DNAI if provided in the AF requests in step 1.
The SMF selects a PDU Session Anchor (PSA1) for the PDU session and indicates
PSA1 to perform DNS packet detection based on the e.g. destination address,
destination port number and optional FQDNs, and forward UE DNS query message
to the SMF.
3\. The UE sends a DNS query in the uplink including the FQDN of requested
application. The PSA1 UPF detects the DNS query and forwards it over N4 to the
SMF.
Based on UE\'s location (e.g. cell ID, or TAI) and optionally the knowledge of
FQDNs served by EASs, the SMF selects DNAI wherein the EASs serving the
requested FQDN may exist.
4\. Based on configuration, the SMF determines the IP address corresponding to
the selected DNAI and sends DNS query to centralized DNS server including this
IP address as EDNS Client Subnet (ECS) extension specified in RFC 7871 [7].
The centralized DNS server determines the IP address of EAS that can serve the
FQDN according to the ECS option and other local policies, and returns DNS
Response including the IP address of the EAS to remote PSA via SMF.
5a. The SMF may select ULCL/BP and a new PDU Session Anchor (Local PSA2) for
this PDU session based on the IP address and/or FQDN of the EAS included in
the response from DNS server to ensure the selected Local PSA and EAS are
corresponding to same DNAI. Addition of additional PSA and UL CL/BP described
in clause 4.3.5.4 of TS 23.502 [3] may be performed. Based on local policy the
SMF may configure filter rules on the ULCL (e.g. the destination of IP
address, destination port number and optional FQDNs) or the BP (e.g. the new
IP prefix @ PSA2 and optional FQDNs) in order to route those subsequent DNS
queries targeting a FQDN supported by the DNAI to local PSA2.
5b. In the case of IPv6 multi-homing, the SMF notifies the UE of the
availability of the new IP prefix @ PSA2 using an IPv6 Router Advertisement
message (RFC 4861 [32]). Optionally, in this RA message, the SMF may notify UE
the new address of DNS server (RFC 8106 [33]) and indicate the UE to contact
with DHCP server to get the DNS-related configuration information (RFC 4861
[32]), which is used to select DNS server for a target FQDN (RFC 6731[26]).
Also, the SMF sends IPv6 multi-homed routing rule along with the IPv6 prefix
to the UE to influence the selection of the source Prefix for the subsequent
DNS queries(RFC 4191 [29]) as described in TS 23.501 [2] clause 5.8.2.2.2. The
SMF may re-configure the UE for the Source IP prefix @ PSA1.
6\. The SMF sends DNS response including the IP address of the EAS to UE via
the PSA1.
7\. In the case of IPv6 multi-homing, if the DNS-related information is
configured on UE, the UE decides the DNS server to use for the subsequent DNS
queries. Otherwise, the UE uses the DNS server address provided in the PCO
during PDU session establishment. Further, the UE selects the source IP prefix
based on the IPv6 multi-homed routing rule provided by SMF.
The UE subsequently sends a DNS query in the uplink including the FQDN of
requested application. If the ULCL detects the DNS query based on detection
information provided by SMF then it forwards it to the local PSA2 or the PSA1.
In the case of IPv6 multi-homing, the BP forwards it to the local PSA2 or the
PSA1 based on the traffic filter rules configured by SMF.
8a. If DNS query whose destination address is the address of the centralized
DNS server is received from ULCL, the local PSA2, reroutes the DNS query to
the localized DNS server based on the N6 routing rule configured by SMF and
receives the DNS Response including the IP address of the EAS from the
localized DNS server.
NOTE: If the address of centralized DNS server and localized DNS server are
anycast address, the local PSA2 reroutes the DNS query based on the anycast
mechanism. Otherwise, the local PSA2 needs to replace the destination address
of DNS query by the address of localized DNS server and the source address of
the DNS Response by the address of centralized DNS server.
8b. If DNS query whose destination address is the address of the centralized
DNS server is received from BP, the local PSA2 forwards the DNS query to the
centralized DNS server and receives the DNS Response including the IP address
of the EAS from the centralized DNS server.
9\. The local PSA2 sends the DNS Response to UE via ULCL/BP.
### 6.6.3 Impacts on services, entities and interfaces
If AF influenced traffic routing procedure is used to provide per- DNAI FQDN
information to SMF:
**AF:**
\- FQDN is a new parameter to the AF influence to the traffic routing
procedure.
**PCF:**
\- PCC rule is enhanced to contain the FQDN and corresponding DNAI(s).
**SMF:**
\- Optionally, SMF is configured with (or obtains from AF) the DNAIs in which
a specific FQDN can be served.
\- Configured with ECS option information per DNAI.
\- Adds ECS option in DNS query message.
\- Forwards DNS messages between UE and Centralized DNS server.
\- Dynamically inserts ULCL/BP and local PSA and configures the traffic
routing rule to ULCL/BP for subsequent DNS queries targeting FQDNs supported
by the DNAI.
Local PSA:
\- Configured with the IP address of Local DNS server.
\- Replaces target IP address of DNS query message with the IP of Local DNS
server.
\- Keeps a context during the DNS request handling in order to be able to
regenerate the address of the DNS server that the UE had put in its request
when sending the DNS Response to the UE.
## 6.7 Solution #7: SMF/I-SMF selection based on DNAI
### 6.7.1 Solution description
#### 6.7.1.1 General
This solution addresses the Key Issue #1: Discovery of Edge Application
Server. This solution is applicable for both Session Breakout Connection Model
and Multiple PDU sessions Connection Model defined in clause 4.2.
In this solution it is assumed DNS Resolver is deployed in Edge Hosting
Environment. The DNS Resolver is used to determine whether the DNS request is
handled by local DNS server in the Edge Hosting Environment or by
authoritative DNS server outside of the Edge Hosting Environment.
The Application Functions uses AF influence traffic mechanism to activate the
traffic routing towards the Edge Hosting Environment. The AF request
information is stored in the UDR as DataSet \"Application Data\" and Data
Subset \"AF traffic influence request information\" as described in TS 23.502
[3]. In this solution the UDR notifies AM-PCF about the AF traffic influence
request information and AM-PCF further sends the AF traffic influence request
information to AMF. So the AMF can select SMF or I-SMF based on the requested
DNAI(s).
Editor\'s note: It is FFS why the AMF would need the DNAI to select a (I-)SMF
whereas in Rel-16 it can select the (I-)SMF based on the TA currently serving
the UE.
The SMF then configures the I-UPF to route the DNS query message towards the
Edge Hosting Environment.
The AF traffic influence request information includes application ID
corresponding to FQDN in UPF(ULCL) or DNS server address as traffic
descriptor. The SMF configures the I-UPF(ULCL) so when the UE sends DNS query
with the target FQDN or target DNS server address, the I-UPF(ULCL) can route
the DNS query message towards the Local PSA and the DNS resolver in Edge
Hosting Environment. The DNS resolver determines to use the local DNS server
or authoritative DNS server to discover the EAS IP address.
NOTE: The traffic descriptor with application ID corresponding to FQDN
requires visibility of DNS in the ULCL and does not support encrypted DNS.
In order to support the case when an edge computing hosting environment has no
connectivity with the central data network, a local DNS server can be deployed
in the edge.
### 6.7.2 Procedures
#### 6.7.2.1 SMF selection based on AF influence Request
Figure 6.7.2.1-1 SMF selection based on AF influence Request
This procedure is example to illustrate how to select an SMF based on AF
influence traffic routing request. After the PDU Session is established the
SMF activate the traffic routing towards the Edge Hosting Environment.
1\. The AM-PCF subscribe DataSet \"Application Data\" and Data Subset \"AF
traffic influence request information\" in the UDR.
2\. The AF traffic influence request information storage in the UDR is
created/modified/released by the NEF per AF request. The Application Function
can be deployed in the Edge Hosting Environment or in the Central Environment.
3\. The UDR sends the Nudr_DM_Notify to AM-PCF, including the AF traffic
influence request information. The AM-PCF stores the AF traffic influence
request information locally.
4\. The UE perform registration procedure in the network.
5\. The AMF establishes AM association towards the AM-PCF. If the UE is the
targeting of AF request the AM-PCF sends Npcf_AMPolicyControl_Create Response
includes the AF traffic influence request information. The AF traffic
influence request information contains the S-NSSAI, DNN, the DNAI list
requested by AF, etc.
6\. The UE establishes PDU Session with the S-NSSAI and the DNN.
7\. The AMF performs SMF selection for the PDU Session, taking into account
the DNAI(s) requested by AF. The NRF provides the candidate SMF profiles for
S-NSSAI and the DNN to AMF. The SMF profiles includes the supported DNAI list.
The AMF selects an SMF which supports the DNAI(s) requested by the AF. If AF
requests a list of DNAI, the AMF may determine which DNAI(s) needs to be taken
into account based on the UE location. In the case of ETSUN, the AMF selects
an I-SMF which supports the DNAI(s) requested by AF.
8\. The AMF continue the PDU Session establishment procedure. For Multiple PDU
Session connectivity model the SMF selects the PSA UPF based on the DNAI(s) of
interest for this PDU Session.
9\. The SMF activates the traffic routing influence towards the Edge Hosting
Environment. For Session Breakout Connection Model the SMF selects I-UPF
acting as ULCL or BP based on the DNAI(s) of interest for this PDU Session.
The I-UPF is configured with rules in which the traffic descriptor includes
the requested DNS Server address or the requested application ID corresponding
to an FQDN. Then the I-UPF(ULCL/BP) can route the DNS query message including
the requested FQDN or requested DNS Server address towards the Edge Hosting
Environment.
#### 6.7.2.2 DNS request procedure
When the UE sends DNS request, the I-UPF(ULCL) can detect the DNS query
message targeting particular FQDN or DNS Server address and route the DNS
query request towards Edge Hosting Environment. The DNS Resolver is used to
determine whether the DNS request is resolved by local DNS server or should be
forwarded to authoritative DNS server. The DNS Resolver is not controlled by
SMF. The DNS Resolver can be deployed within the Edge Hosting Environment or
outside of the Edge Hosting Environment.
Figure 6.7.2.2-2 DNS request procedure
1\. The UE sends DNS query request message over the user plane path.
2\. The ULCL detects based on PDR the DNS query request message including the
requested FQDN or requested DNS Server address and routes the DNS query
request message towards the Local PSA.
3\. The Local PSA forwards the DNS query request to the DNS Resolver.
Based on local configuration the DNS Resolver determines whether the DNS
request is resolved by local DNS server or should be forwarded to
authoritative DNS server. If local DNS server is used then step 4a and step 4b
are performed. If authoritative DNS server is used then step 5a and 5b are
performed.
4a. The DNS Resolver forwards the DNS request to local DNS server.
4b. The local DNS server response with address information of the Edge
Application Server. The source address of the DNS response is the original DNS
server address that has been used by the UE.
NOTE: How to communicate between the DNS Resolver and local DNS server is not
specified.
5a. The DNS Resolver adds its local address in an EDNS Client Subnet option
and forwards the DNS request together with the EDNS Client Subnet option of
RFC 7871 to the authoritative DNS server.
5b. The authoritative DNS server uses the EDNS Client Subnet option to
determine the address information of the Edge Application Server in the Edge
Hosting Environment and send the DNS request response.
6\. The DNS Resolver forwards the DNS response to the Local PSA via N6
interface.
7\. The Local PSA forwards the DNS response to ULCL.
8.. The ULCL forwards the DNS response to the UE.
### 6.7.3 Impacts on services, entities and interfaces
**AM-PCF:**
1\. Subscribe the AF traffic influence request modification in UDR.
2\. Receives the AF traffic influence request from the UDR.
3\. Sends the new/updated AF traffic influence request to AMF.
**AMF:**
1\. Receives the new/updated AF traffic influence request from the AM-PCF.
2\. Select I-SMF or SMF supporting the requested DNAI(s) based on AF traffic
influence information received from the AM-PCF.
**NRF:**
1\. Store the supported DNAI in the service profile of the I-SMF/SMF.
## 6.8 Solution #8: Edge Application Server discovery using anycast DNS
### 6.8.1 Solution description
#### 6.8.1.1 General
This solution addresses the Key Issue #1: Discovery of Edge Application Server
(EAS). UE is Edge Computing Service agnostic and discovery is performed by the
MNO. The MNO need to construct their DNS service using IP anycast technology
so that all DNS servers in the edge hosting environment and all central DNS
servers present a unified anycast IP address. 5GS decides to insert a UL CL
(and thus additional PDU Session Anchor) in the data path of the PDU Session
to create a new data path for the matched DNS requests and divert them locally
to LDNS. LDNS is deployed in the edge hosting environment and provides DNS
service for EASs in the same LDN. When an EAS is deployed in the edge hosting
environment, its DNS entry needs to be written to the LDNS, of which the IP
address is the same as the one for ordinary Internet access.
This solution applies for any of the three connectivity model (i.e,
\"Distributed Anchor Point\" or \"Session Breakout\" or \"Multiple PDU
sessions\".
This solution applies for either scenario where the edge computing hosting
environment has or does not have connectivity with the central DN.
NOTE 1: How to make sure the recursive DNS system present a unified IP using
IP anycast mechanism is outside the scope of SA WG2.
NOTE 2: UE is agnostic to any change of DNS server in the anycast DNS system,
because the IP address of DNS always keeps the same.
### 6.8.2 Procedures
This procedure is an example to illustrate the solution.
The central UPF is configured with PDRs of EASs\' FQDN and/or URL; SMF is
configured with the corresponding ULCL insertion policy with the detection as
the trigger by pre-configuration or by AF traffic-influence procedure.
Edge UPF is configured with pre-defined ULCL or obtains ULCL information from
N4 massage, as well as N6 traffic profiles.
When UE initially establishes a session, it anchors on a central UPF (PSA1).
Figure 6.8.2-1 Edge Application Server Discovery Using Anycast DNS
1\. UE initiates DNS request for an edge application.
2\. The central UPF detects it\'s a DNS request for some specific application
which might be deployed in edge hosting environment, then holds the DNS
request. The detection is made by traffic filters.
3\. The central UPF reports the detected event to SMF, and SMF checks the
location of the UE.
4a. [Conditional] If UE is not in any LDN, SMF responds to the central UPF
with an indication to release the traffic holding.
4b. [Conditional] If UE is in some LDN, SMF decides to insert an uplink
classifier (UL CL) and/or IPv6 multi-homing breakout point (thus additional
PSA2) in the data plane for the UL traffic. The decision is based on location
of the UE and the matched edge application. At the same time, SMF responses to
the central UPF with an indication to delete the held request packets.
5a. [Conditional] If step 4a is executed, the central UPF continue to forward
the DNS request to the original central DNS.
5b. [Conditional] If step 4b is executed, UE will issue another DNS request
based on timeout-resend mechanism. The edge UPF detects the DNS request for
the edge application and diverts it to the LDNS according to the UL CL rule.
6a. [Conditional] If step 5a is executed, the central DNS responses the IP
address of the central AS to UE.
6b. [Conditional] If step 5b is executed, LDNS responses the IP address for
the EAS to the UE.
7a. [Conditional] If step 6a is executed, Application traffic starts between
UE and the central AS.
7b. [Conditional] If step 6b is executed, Application traffic starts between
UE and the EAS.
NOTE: It is assumed timeout-resend mechanism is always available for DNS
client, as usually is.
### 6.8.3 Impacts on services, entities and interfaces
This solution has impacts on SMF and the central UPF.
SMF shall support the addition of the holding-action related indication in N4
notification response massage, as well as corresponding procedures.
The central UPF shall support holding of UL traffic, and releasing holding or
deleting the held traffic according to the instruction from SMF, as well as
corresponding procedures.
No impacts to UE, AN, and other NFs.
## 6.9 Solution #9: Assist DNS resolution without connectivity between local
and central data network
KI#1 on Discovery of Edge Application Server involves aspects related to
assisting the DNS resolution.
The proposed solution supports the \"Session Breakout\" connectivity model
with dynamic insertion of local PSA for Edge Computing.
In particular, the solution considers the scenario determined by the following
requirement in clause 4.3 (General Requirements and Assumption):
\- It shall be possible for an edge computing hosting environment to have no
connectivity with the central data network.
### 6.9.1 Description
In the scenario considered by this solution, the UE has established a PDU
Session with a DN to perform communication with Edge Application Servers (EAS)
deployed in local Data Networks (LDNs). For the edge application,
Authoritative DNS Server(s) are reachable via the LDNs. A DNS Resolver in the
central DN is used to forward a DNS query from the UE to the Authoritative DNS
Server. The address of the DNS Resolver is provided to the UE via PCO during
the PDU Session Establishment.
If direct connectivity between the central DN and the LDNs is supported, the
DNS Resolver forwards the DNS query to the Authoritative DNS Server directly.
The proposed solution addresses the scenario where direct connectivity between
the DNS Resolver and the LDNs is not supported: in this case the DNS Resolver,
acting as an AF, requests the 5GC to forward the DNS query. A relevant
scenario where the is no connectivity between the DNS Resolver and the LDNs is
depicted in Figure 6.9.1-1. In this scenario the local DN belongs to an
Enterprise and the DNS Resolver is in the operator\'s network (i.e. N6
network). In this case maintaining direct connectivity (e.g. a VPN) between
the operator\'s network and the LDN for all the LDNs of a multiplicity of
Enterprises is complex/expensive.
Figure 6.9.1-1: \"no connectivity\" scenario
NOTE: The ADNS in this scenario may be located in a private DN reachable from
a multiplicity of local N6 interfaces and local DNs belonging to the
Enterprise.
This solution 9 describes a specific interaction between DNS Resolver and SMF
that can be used as part of other solutions, e.g. solution 22 option 2b (where
the DNS Resolver is a LDNSR), to implement DNS query forwarding via 5GC
Control Plane without connectivity between the DNS Resolver and the local
Authoritative DNS Server.
### 6.9.2 Procedures
#### 6.9.2.1 DNS query forwarding via 5GC
Figure 6.9.2.1-1 shows the procedure to support the application layer in
forwarding via 5GC Control Plane the DNS query and the related DNS response.
The procedure applies in non-roaming and LBO scenarios. The procedure applies
when the DNS resolver has no direct interface with the authoritative server.
In step 0, the UE establishes a PDU Session to perform communication for an
edge application. Via UPF1, the PDU provides connectivity to the DN where the
DNS Resolver resides. Via UPF2, the PDU Session may provide also connectivity
to a local N6 to the local DN where EAS and Authoritative DNS Server are
deployed.
1\. Via the UP of the PDU Session, the UE sends (step 1a) a DNS query to
resolve the FQDN of a EAS. Via UPF1, the DNS query is forwarded to the DNS
Resolver. Based on the knowledge of the UE location, the DNS Resolver selects
the Authoritative DNS Server (based on configuration in the DNS resolver,
which maps the UE location to the Authoritative DNS IP address) and needs to
forward the DNS query. Since there is no direct connectivity between the DNS
Resolver and the local DN, the DNS Resolver acts as AF (step 1b) to request
the forwarding via 5GC.
NOTE 1: How the DNS Resolver gets the information on the UE location is not in
the scope of this solution. The DNS Resolver can get this is information from
the AF, which can get it by subscribing for UE location change notification
from the 5GS.
2\. Acting as an AF, the DNS Resolver invokes an SMF service operation to
request forwarding the DNS query to the local DN. The parameters of the SMF
service operation are the UP packet used to send the DNS query and a
destination identifier. The destination identifier can be e.g. a DNAI of the
local N6 if the AF interacts directly with the SMF, or an AF-Service-ID (see
TS 23.501 [2], clause 5.6.7) if the AF interacts with the SMF via NEF. The AF
indicates also an address for notifications on the DNS response. The
implementation of the SMF service operation (and of the related NEF service
operation) is discussed in clause 6.9.3.
NOTE 2: AF influence on traffic routing in Rel-16 applies only to non-roaming
and LBO scenarios. The same applies also for the proposed solution, which
assumes that the AF is in the V-PLMN. In the LBO scenario, the address of the
DNS Resolver is assigned by the V-SMF to the UE.
NOTE 3: The AF can determine the SMF ID and map the GPSI to the UE IP address
as described in clause 6.9.2.2.
3\. If not yet inserted, the SMF inserts UPF2 and configured the ULCL and
local PSA. Via N4, the SMF sends the DNS query to the UPF2 and configures the
UPF2 to forward the DNS query to the local N6 and to intercept the DNS
response and forward it to the SMF. Control of User Plane Forwarding in order
to forward traffic to/from the SMF is described in TS 23.501 [2], clauses
5.8.2.5.1 and 5.8.2.5.2 and in TS 29.244 [42], clause 5.3: the SMF can create
a PDI (packet detection information) in a PDR with a filter that matches e.g.
with dst IP address = DNS resolver address and src IP address = L-DNS server
address; the UPF forwards the matching packets to the tunnel towards SMF.
4\. The UPF2 intercepts the DNS response by matching the PDI configured by the
SMF in step 2and forwards it to the SMF.
5\. The SMF forwards the DNS response to the address for notifications
provided by the AF in step 2. This can be done by a notification. The
implementation of the notification to the AF (and the related NEF service
operation) is discussed in clause 6.9.3. The DNS Resolver forwards the DNS
response to the UE via UP of the PDU Session.
Figure 6.9.2.1-1: DNS query forwarding via 5GC
#### 6.9.2.2 Mapping of GPSI to UE IP address
The AF subscribes to the NEF on \"PDU Session Status\" events for the UE (TS
23.502 [3] Table 4.15.3.1-1); the AF uses the GPSI to identify the UE (TS
23.502 [3] clause 5.2.6.2.2 Nnef_EventExposure_Subscribe operation). The AF
subscribes to receive the notifications directly from the SMF. The
subscription can be done contextually with AF influence on traffic routing (TS
23.502 [3] clause 4.3.6.1).
At PDU Session establishment the SMF notifies the LDNSR AF on the
PduSessionStatus including the SMF ID, the UE IP address (TS 29.508 [31]
clause 4.2.2.2) and the GPSI. Finally, the AF stores the association between
GPSI and UE IP address and the SMF ID. This option does not have any new
requirement to 3GPP specifications.
### 6.9.3 Impacts on services, entities and interfaces
The proposed solution introduces new SMF and NEF service operation to request
forwarding of UP packets via 5GC and uses notifications to carry UP packets to
the AF:
\- Step 2, implementation of the SMF service operation and of the related NEF
service operation:
\- The SMF service operation can be implemented as an extension of
Nsmf_PDUSession_SendMOData (TS 23.502 [3] clause 5.2.8.2.12) or as a new SMF
service operation.
\- The NEF service can be implemented as an as an extension of the
Nnef_TrafficInfluence service operation (TS 23.502 [3] clause 5.2.6.7), or as
an extension of the Nnef_NIDD service operation (TS 23.502 [3] clause
5.2.6.14) or as a new NEF service operation.
The parameters of the SMF and NEF service operations need to include the UP
packet used to send the DNS query, the destination identifier (e.g. a DNAI of
the local N6 if the AF interacts directly with the SMF, or an AF-Service-ID if
the AF interacts with the SMF via NEF) and an address for notifications on the
DNS response.
\- Step 5, implementation of the notification to the AF and the related NEF
service operation:
\- The notification to the AF from the SMF can be implemented as an extension
of the Nsmf_EventExposure service operation or as a new SMF service operation.
\- The notification to the AF from the NEF can be implemented as an extension
of the Nnef_EventExposure service operation or as a new NEF service
operation..
## 6.10 Solution #10: DNS for Distributed Anchor
### 6.10.1 Solution description
The solution addresses Key Issue #1: Discovery of Edge Application Server. The
UE is Edge Computing Service agnostic.
The proposed solution supports the Distributed Anchor connectivity model, and
complements solution 3 that covers \"Session Breakout\" connectivity model
with dynamic insertion of the Local PSA.
With Edge Computing, Applications Servers can be distributed and be deployed
at the edge of the cellular networks. In this scenario, the Edge Application
Server that is topologically closest to the UE should be selected. The Edge
Application server that is closest to the PDU session PSA in IP distance is
the one closest to the UE.
This solution is based on the following:
\- 3GPP UEs have a DNS Stub Resolver in their OS that originates DNS queries
as required by the Applications in the UE to obtain an Application Server
address from the Application FQDN. The DNS client can also be in the
Application client or the Browser (e.g. a DoH client).
\- The Mobile Network can propose to which DNS server (aka DNS Resolver) that
DNS client in the UE should send the DNS queries of the applications on that
PDU session to. At PDU session establishment, the Mobile Network can provide
the address of a DNS server that is close to the PSA.
\- The DNS queries that are sent over that PDU session are addressed to the
proposed DNS Resolver but might also be sent to another DNS Resolver depending
on the UE Application client, Browser and/or OS configuration.
\- DNS responses can be tuned to the address of the DNS resolver. By placing
the DNS near the PSA, the DNS request can be solved to an Application server
which is close to that PSA (assumption is that iterative mode is used for
resolution from DNS Resolver as recommended by IETF).
As an alternative, if the Operator DNSs are not distributed to match the PSAs,
the Mobile Network can steer the UE to send the DNS queries to a central DNS.
lie. The query is then forwarded for resolution and the DNS can tune the
response and select and Application Server which is close to that PSA.
This description includes procedures for the two DNS deployment examples of
the Figure below. In both examples, the DNS Resolver needs to be placed after
the NAT. They are for the scenario of an MNO DNS.
Figure 6.10.1-1: Alternative Deployments of Operator DNS
These DNS deployments are similar to deployments described in other solutions,
e.g. solution 4.
### 6.10.2 Procedures
#### 6:10.2.1 High Level Procedure using DNS Distribution
Figure 6.10.2.1-1 below shows an example sequence for this solution that
includes the following steps:
When the UE establishes a PDU session, 5G Core existing mechanisms are used to
provide the UE with a local DNS that is close to the PSA.
Figure 6.10.2.1-1: High-level sequence diagram of EAS discovery with
Distributed anchor and central DNS
1\. Once the PDU Session has been established, an application may want to
setup a connection to an edge Application Server. Typically, the Application
Server is known by a domain name identified by Application FQDN) that needs to
be translated into an IP address. UE sends a DNS Query with the Application
FQDN. In this sequence, the query is sent to the Local DNS whose address is
provided at Session Establishment procedure and forwarded as needed for
resolution to the DNS hierarchy.
2\. DNS can tune the response to the address of the DNS requester. Since the
query was sent to a DNS near the PSA, the IP address in DNS answer
corresponding to DNS request can be resolved to an Application server which is
close to that PSA.
3\. The DNS response is sent back to the MNO DNS and from there to the UE.
4\. The application traffic starts towards the IP Address received.
The solution sequence is the same if UE Application client, Browser or OS are
configured to use another DNS Resolver than the one proposed at session
establishment. By using an Anycast IP, the request can be routed to the DNS
instance that is closest to the PSA. The DNS may be configured to apply ECS
Option anyway (see clause 6.10.2.2.).
This DNS procedure is similar to what is described in other solutions (e.g.,
solution 5).
#### 6.10.2.2 High Level procedure using ECS Option
Figure 6.10.2.2-1 below shows an example sequence for this solution that
includes the following steps:
When the UE establishes a PDU session, 5G Core existing mechanisms are used to
provide the UE with the address of the MNO DNS.
Figure 6.10.2.2-1: High-level sequence diagram of EAS discovery with
Distributed anchor and central DNS
1\. Once the PDU Session has been established, an application may want to
setup a connection to an edge Application Server. Typically, the Application
Server is known by a domain name identified by Application FQDN that needs to
be translated into an IP address. UE sends a DNS Query with the Application
FQDN. In this sequence, the query is sent to the MNO DNS server whose address
is provided at PDU Session Establishment procedure.
2\. The MNO DNS adds an ECS corresponding to the user IP address (if the ECS
had been provided by the stub resolver in the UE, that is overwritten (UE ECS
may refer to a private address for example).
3\. The DNS request is forwarded to the DNS Hierarchy for resolution.
4\. The ECS option in the DNS Query can be used by DNS to tailor the DNS
response. When that is done, and if the Authoritative DNS Server has
considered the received ECS, ECS is sent also in the response according to RFC
7871.
5\. The DNS response is sent back to the MNO DNS and from there to the UE.
6\. The application traffic starts towards the Application Server IP Address
received.
The solution sequence is the same if Application client, Browser or OS are
configured to use another DNS Resolver than the one proposed at session
establishment. That DNS Resolver adds an ECS corresponding to the user IP
address.
This DNS procedure is similar to what is described in other solutions (e.g.,
solution 5).
### 6.10.3 Impacts on services, entities and interfaces
For non-distributed DNS Deployments, it assumes that the DNS supports RFC
7871. No impact to 3GPP defined network functions or services.
## 6.11 Solution #11: DNS over HTTP
### 6.11.1 Solution description
#### 6.11.1.1 General
This solution addresses the Key Issue #1: Discovery of Edge Application Server
(EAS). The UE is Edge Computing Service agnostic. The applications in the UEs
need to support DNS over HTTPS (DoH). The receiver of a DoH request is more
than a DNS over HTTPS server, it acts as an AF towards the 5GC. When the AF
receives a discovery requests from a UE, it acts as an AF to retrieve location
of the UE, and if needed influence routing. The AF is referred to as DoH AF.
DoH AF may be provided by the MNO or some Edge Service Provider (having an SLA
with the MNO).
This solution supports the Session Breakout connectivity model with dynamic
insertion of the Local PSA. It can be used for the Distributed anchor
connectivity model and by establishing a new PDU session instead of inserting
an ULCL it can support the multiple session connectivity model.
NOTE: How the DoH AF knows about what EASs that exists is outside the scope of
SA WG2.
#### 6.11.1.2 Configuration of the UE
With regards to the Configuration of the UE, two models are assumed:
1\. The user downloads an edge data network application. From the user\'s
perspective, this is like any other app. The application itself contains
necessary configuration data to run in an edge data network. The typical case
for this model is that the Edge service is provided over the Internet DNN and
slice.
2\. The UE is a specific device for edge services. Since it is a special
device, it may already have the necessary application software and associated
configurations, or the UE is configured to download the application software
and associated configurations from a pre-configured site. The typical case for
this model is that the Edge service is provided over a dedicated DNN and
slice.
URSP Rules in 5GC is used to configure the UE\'s usage of DNNs and slices.
#### 6.11.1.3 Example deployment architecture
The figure 6.11.1.3-1 illustrates an example deployment architecture. The
architecture can be used as a reference for the procedures in clause 6.11.2. A
local PSA is associated with a certain DNAI which connects to a local DN. The
local DN is a subnet of the DN. The local DN/subnet serves a certain area,
which is defined as an Area of interest, i.e. a number of TAs. The DNS in the
local DN/subnet resolves the addresses to the EASs.
Figure 6.11.1.3-1 Example of a deployment architecture
### 6.11.2 Procedures
Figure 6.11.2-1 Edge Application Server Discovery
There is a trigger to execute an application (UE internal or by a user). If no
established PDU session can be used, the UE establishes a new PDU session to a
DNN and slice for this application. That PDU session is used for the
communication described below:
1\. The EAS is identified by a FQDN, the AS-FQDN. The application in the UE
does a discovery request using DoH to discover the EAS. The DoH AF
authenticates and authorizes the UE for this application.\ There are several
ways how to route the HTTPS connection to the DoH AF:
\- the DoH AF has a set IP addresses, or an IP anycast address known by the
application or lower layer in the UE;
\- the DoH AF has a FQDN, the DoH-FQDN. The DoH-FQDN is resolved to a DoH AF.
2\. The DoH AF determines the location of the UE using either NEF or PCF APIs.
3\. The DoH AF finds a suitable EAS. The DoH AF uses the ECS option (see RFC
7871 [7]) in a DNS query. ECS stands for EDNS Client Subnet, where EDNS is
Extension Mechanisms for DNS. The subnet the DoH AF uses in the DNS query is a
subnet that reflects the location of the UE (i.e. not derived from the UE\'s
IP address) based on local configuration. As an alternative, the DoH AF may
use HTTP redirect to forward the request to another DoH AF serving the
location of the UE. In this case, the local DoH AF may do the DNS query
without adding the ECS.
4\. DoH AF decides if it wants to influence routing so that the 5GC may
include an uplink classifier (UL CL) and/or IPv6 multihoming Branching Point.
The decision is based on location of the UE and selected EAS. Current UE PSA,
may very well be good enough.
5\. Depending on how the application is built, i.e. if UE or network should
initiate QoS flow establishment and if a certain QoS flow is needed for the
application. DoH AF may initiate establishment of a QoS flow for this
application.
6\. DoH AF responds with the address of the AS.
7\. Depending on how the application is built, the UE may initiate a QoS flow
establishment.
8\. Application traffic starts between Application Client and Edge Application
Server.
### 6.11.3 Impacts on services, entities and interfaces
This solution has no impacts on existing 5GC procedures.
## 6.12 Solution #12: PDU session re-anchoring
### 6.12.1 Solution description
This solution addresses the Key Issue #1: Discovery of Edge Application Server
(EAS), and Key Issue #5: Activating the traffic routing towards Local Data
Network per AF request. The UE is Edge Computing Service agnostic.
The proposed solution supports the \"Distributed Anchor Point\" connectivity
model. It is assumed that at PDU session establishment the SMF selects a
central PSA, but local PSA is available to the SMF, and re-anchoring is used
to transition to the \"Distributed Anchor Point\" model. This solution is
applicable to PDU Sessions SC#2 and SSC#3.
Re-anchoring could happen based on different triggers, e.g.:
1\. The UE issues a DNS query related to an EC service. The SMF will get
information from LDNSR that a local PSA is needed.
2\. Application AF initiates a traffic influence request to PCF (through the
NEF in the case of external AF), upon which the PCF initiates a routing
request for the PDU session to the SMF. Based on the requested target DNAI the
SMF initiates re-anchoring.
1\. above is related to KI#1 and 2. above is related to KI#5.
For 1 above, LDNSR is involved and the applicable principles agreed for
Solution #22 apply (for aspects that remain open in that solution, the
decisions taken for Solution #22 will also apply to solution #12). Solution
#12 differs from Solution #22 on the action that may be enforced by the SMF:
when LDNSR notifies that an Edge AS is preferred, in solution #12 the action
by SMF is to re-anchor the PDU Session to a more distributed PSA. That can be
SSC mode 2 or SSC mode 3. With this re-anchoring alternative, all traffic in
the PDU Session is broken out locally independently on the application.
Solution #12 for 1 above supports two alternative procedures:
\- A procedure similar to that in Solution #22: when LDNSR gets a DNS query
for an EC FQDN, it manipulates the DNS so that an EAS is selected according to
the candidate DNAI/Local PSA (this is referred to as \"Early DNS handling\").
\- A simpler procedure where the LDNSR notifies to SMF on DNS Query and drops
the query after the re-anchoring as an alternative mechanism specific to
Solution #12 (this is referred to as \"late DNS handling\").
This solution could work with \"Early DNS handling\" only, however, that is
not efficient if the Session is SSC#2 and the session is going to be teared
down. In that case, the delivery of the DNS response is not guaranteed if the
PDU session is released.
For SSC#2 sessions \"late DNS handling\" is applied. For SSC#3 sessions, any
\"Early DNS handling\" or \"Late DNS handling\" may be applied.
The following re-anchoring scenarios can be differentiated:
a Support of KI#1, Re-anchoring without change of SMF where the SMF has full
control over the re-anchoring. This is the case when the re-anchoring can be
done using one of the following existing 5GC procedures for PSA change:
\- SSC mode 3 with IPv6 Multi-homed PDU Session (clause 4.3.5.3 of TS 23.502
[3]).
\- SSC mode 3 with multiple PDU Sessions (clause 4.3.5.2 of TS 23.502 [3]),
without SMF Reallocation.
b Support of KI#1 and KI#5, re-anchoring with re-selection of SMF where the
SMF may have or may not have full control over the selected re-anchored DNAI.
In b, old SMF sends \"use SMF (set) for next PDU session\" or \"use DNAI for
next PDU session\" indication to the AMF in the
Nsmf_PDUSession_SMContextStatusNotify message. The AMF uses this information
when selecting an SMF for the new PDU session.
Example use cases of re-anchoring where AMF does re-selection of SMF (the
existing or new SMF) that could use the described functionality is listed
below.
1\. KI#1, The selected DNAI is supported by SMF but only SSC mode 2 is
supported.
2\. KI#5, Requested DNAI is outside the SMF service area. PDU session is SSC#2
or SSC#3.
### 6.12.2 Procedures
#### 6.12.2.1 EAS Discovery triggered re-anchoring, KI#1
Procedure for KI#1. The trigger for re-anchoring is the discovery (DNS) for EC
server by UE. The PDU Session is SSC#3 or SCC#2. The SMF supports Edge PSAs.
The solution for Edge AS Discovery using DNS requires a new functionality, an
enhanced DNS Forwarder here referred to as \"LDNSR\".
LDNSR is a stand-alone NF (e.g., an internal AF). Solution #22 agreed
principles apply to Solution #12. EC AS-FQDN is known by the system and a DNS
Query is what will trigger a re-anchoring.
This is shown in Figure 6.12.2.2.1-1 below.
Steps that are specific to \"Early DNS handling\" are numbered as X.a whereas
steps specific to \"Late DNS handling\" are numbered using X.b.
Figure 6.12.2.1-1 Re-anchoring without change of SMF during Edge Application
Server Discovery using LDNSR
0\. PDU Session establishment. The UE PDU session is established by SMF with
UPF1 (central PSA). 5G Core existing mechanisms are used to guarantee that, if
for that user PDU session Edge Computing can be applied, the UE DNS queries
are sent to the LDNSR (this is the same mechanism than solution 22).
1\. The application in the UE does a DNS discovery request to discover the
EAS. The DNS request is (at least for EC AS-FQDNs) handled via central PSA
(UPF1) by the LDNSR. This is the same mechanism than solution 22.
2\. The LDNSR checks whether the FQDN in the DNS Query is an FQDN for which it
needs to provide a specific handling. Such EC FQDNs may have been obtained
e.g. from SMF as defined for solution 22. That handling may correspond to
either Late or Early DNS handling (added LDNSR configuration information wrt
solution 22).
2a. If Early DNS handling applies, LDNSR applies one of the Options described
in Solution #22 clause 6.22.1.4 to convey UE IP location information for a
selected DNAI/Edge PSA to the authoritative DNS server.
2b. If late DNS handling applies, then LDNSR buffers the DNS request.
NOTE 1: in the case of SSC mode 2 re-anchoring, \"late DNS handling\" applies,
(the DNS response in 2a. may not be delivered to the UE if the PDU Session
termination happened before).
3\. Then, LDNSR informs SMF, which may trigger session re-anchoring. LDNSR
provides only the FQDN in the DNS Query, if Late DNS handling (in this case,
it also requests notification after any PDU session update). And it also
provides the IP address of the EAS selected by DNS if Early DNS handling..
3a The DNS response is forwarded to the UE. The UE connects to the Edge AS via
the Central PSA (UPF1).
NOTE 2: the UE may receive the DNS response forwarding before or after SSC
mode 3 procedures take place . if it takes place before, it is likely that the
Application interaction will take place on the old PDU Session.
4\. SMF decides on re-anchoring. This is similar to the decision taken by SMF
to insert an UL CL/BP in solution #22. SMF shall select a UPF/PSA closest to
the user. If latest UE Location is not available and needed by the SMF, SMF
can get UE location from AMF by invoking Namf_EventExposure service with
OneTime Report type (as in TS 29.518 [41], clause 5.3.1). The selected Edge AS
may be considered if available.
4b. Late DNS handling. The SMF notifies back to LDNSR, and the DNS processing
can resume. A notification indicating that the session is being re/anchored,
triggers LDNSR to drop the DNS request. Else, the DNS query is simply
forwarded (with no LDNSR intervention) for resolution.
5\. SMF initiates Change of PDU Session Anchor to the PSA selected in step 3
using one of the following methods:
\- SSC mode 3 with IPv6 Multi-homed PDU Session (clause 4.3.5.3 of TS 23.502
[3]).
\- SSC mode 3 with multiple PDU Sessions (clause 4.3.5.2 of TS 23.502 [3]).
\- SSC mode 2, clause 4.3.5.1 of TS 23.502 [3].
with the following modifications for SSC mode 2 and SSC mode 3 with SMF
reallocation:
\- SMF sends a \"use DNAI for next PDU session\" indication to the AMF by
invoking the Nsmf_PDUSession_SMContextStatusNotify message. The indication
contains the actual DNAI to be used for SMF selection by AMF for the next PDU
Session from the UE on the same (DNN, S-NSSAI).
\- This indication is then stored and used by AMF and conveyed to new SMF as
described in steps 4-9 in clause 6.12.2.2..
For the new PDU session, the UE may be configured with either the Local DNS or
the C-DNS server address, see Solution #10.
NOTE 3: Further re-anchoring (to a central UPF) may be triggered if EC
application terminates. In that case, LDNSR will be provided again as the DNS
for the PDU Session.
NOTE 4: As for all use of SSC modes 2 and 3, all IP traffic on the PDU session
is affected since UE IP address is changed from an UE IP address corresponding
to the old PSA (in this case central PSA) to an UE IP address corresponding to
the new PSA (in this case local PSA).
6\. Once the new PDU Session has been established, the Application client may
be notified by the OS that a new connection is available. The Application may
be prepared to handle OS notifications at new connection and take further
actions. If SSC#3, the application may build service continuity on dual legs,
e.g.: it can move flows gradually to the new connection trying to minimize
e.g. the impact on the latency.
6a. Early DNS handling. When the AS IP address is known to the UE, the
application may start connecting to the Edge AS via the new Edge PSA. Else,
step 8 will be triggered immediately.
NOTE 5: In the case of \"late DNS handling\" (i.e. DNS drop) the UE has not
received a DNS response when the application client is notified that the new
connection is available. It is reasonable to assume that the Application
client issues a new traffic request and the UE sends a new DNS Query over the
new PSA (step8). In the case of \"Early DNS handling\", the UE may have
received an AS IP. It may depend on the application whether that AS IP address
is reused over the new PDU Session.
NOTE 6: In the case of SSC Mode 2 Change of PDU Session Anchor, the LDNSR
cannot answer to the UE so dropping the DNS query is the only choice.
7\. The UE sends a DNS query to obtain the IP address of the AS on the new PDU
Session via the Edge PSA.
8\. DNS response includes an EAS that is closest to PSA (with DNS state of the
art many Authoritative (DNS) Name servers already today return different
responses based on the perceived topological location of the user).
9\. The Application Traffic is sent to the selected Edge AS over the new Edge
PSA.
#### 6.12.2.2 Re-anchoring with AMF re-selecting different SMF, KI#5
The procedure is shown in Figure 6.12.2.2-1 below.
Figure 6.12.2.2-1 Re-anchoring with re-selection of SMF
0\. PDU Session establishment. The UE PDU session is established using SMF1.
1\. SMF1 receives a trigger related to the UE PDU session that leads to a
decision on re-anchoring for this PDU session. An example of such trigger is a
PCC rule possibly derived from a Nnef_TrafficInfluence API.
2\. SMF1 decides on re-anchoring for this PDU session. That decision could
either be based on SLA information locally configured in SMF, or on the PCCs
received from PCF for the PDU Session. SMF1 determines that SSC mode 2 or SSC
mode 3 with SMF reallocation is to be used.
3\. SMF1 initiates a Change PDU Session Anchor using one of the following
methods:
\- SSC mode 3 with multiple PDU Sessions (clause 4.3.5.2 of TS 23.502 [3])
with SMF Reallocation request; or
\- SSC mode 2 with different PDU Sessions (clause 4.3.5.1 of TS 23.502 [3]).
4\. In both cases in step 3, SMF1 may send a \"use DNAI for next PDU session\"
indication to the AMF by invoking the Nsmf_PDUSession_SMContextStatusNotify
message. The indication contains the actual DNAI to be used for SMF selection
by AMF for the next PDU Session from the UE on the same (DNN, S-NSSAI). The
AMF stores the indication.
NOTE 1: The AMF internally stores the information indicating \"use DNAI for
next PDU session\" related to the data network e.g. per (DNN, S-NSSAI) and the
access technology e.g. 3GPP or non-3GPP access in the case of a UE
establishing multiple PDU Sessions to the same Data Network. How the
information is stored is based on implementation and the information is not be
transferred outside, e.g. to support the UE context transfer between AMFs for
AMF relocation.
5\. SMF1 sends the Namf_Communication_N1N2MessageTransfer message to AMF for
PDU Session reestablishment.
6\. The UE issues a new PDU Session establishment request on the same (DNN,
S-NSSAI).
7\. If AMF received the \"use DNAI for next PDU session\" indication from SMF1
in Step 4 for a PDU Session requested by the same UE on the same (DNN,
S-NSSAI), then the AMF will use the received DNAI when selecting the new SMF.
The AMF selects new SMF2 for the next PDU session establishment.
If the AMF doesn\'t already have the information of which SMF can serve the
requested DNAI(s), it invokes the NF discovery request with NRF which provides
the list of SMF supporting the requested DNAI(s).
8\. AMF issues Nsmf_PDUSession_CreateSMContext Request including the DNAI.
9\. SMF2 considers the received DNAI from AMF when selecting a PSA for the
session.
NOTE 2: Usage reporting for the relevant EC flows may be activated to track
activity. Further re-anchoring (to a central UPF) may be triggered if EC
application terminates.
### 6.12.3 Impacts on services, entities and interfaces
\- SMF:
\- KI#1, common to solution #22: ensure UE DNS requests for EC AS-FQDN reach
LDNSR, e.g., select LDNSR and configure UE with the address of LDNSR as the
DNS server during PDU session establishment via PCO.
\- KI#1, common to solution #22: it may provide (this is conditioned to
Solution #22 ENs, and the provisioning alternative selected) LDNSR with the
FQDNs for which LDNSR needs to provide a specific handling to match with the
FQDN in the DNS Queries from the UE.
\- In the case of early DNS handling support: specific handling is same as
described in Solution #22.
\- KI #1: In the case of late DNS handling support: specific handling needs to
include new options: buffer & notify on DNS query, and then either drop or
forward (without further LDNSR intervention) when the session notification is
received.
\- KI #1, re-anchoring decision triggered by LDNSR notification, providing the
\"SMF (set) for next PDU session\" indication to AMF (extending Solution #22
possible actions at LDNSR notification).
\- KI #5, The re-anchoring decision and procedures including conveying the
\"DNAI for next PDU session\" to AMF as described in clause 6.12.2.2.
\- AMF:
\- KI#1, using SMF (set) information received from former SMF in the selection
of the new SMF.
\- KI#5, using DNAI information received from former SMF in the selection of
the new SMF and conveying the DNAI.
\- LDNSR, only for KI#1:
\- Common to solution #22: Processing UE DNS queries and notifications to SMF
of specific AS-FQDN in the UE DNS messages (Early DNS handling).
\- Extending Solution #22: adding new options for DNS handlings in LDNSR for
\"Late DNS handling\": buffering the UE DNS query, getting indication from SMF
about dropping a DNS request or forwarding for resolution without further
LDNSR intervention.
## 6.13 Solution #13: 5GC support for UE selection of the DNS to use
### 6.13.1 Description
#### 6.13.1.1 Overview
The operator may negotiate with a Third party (typically a Corporate
represented by an AF) dedicated DNN(s) and/or S-NSSAI(s) for the traffic of
UE(s) of this third party. UE(s) of the third party may be identified by a
group identifier.
This solution addresses policies that the third party would want to get
enforced for the traffic of a specific UE or a group of UE(s) of this third
party including for cases where traffic of UE(s) of this third party is
subject to traffic offload.
The applications (FQDN(s)) reached by UE(s) of this third party may correspond
to:
a) Corporate applications only reachable via a specific (DNN, S-NSSAI)
negotiated with the operator ; corresponding URSP rules (URSP rules referring
to domains of these corporate applications) shall only point to this specific
(DNN, S-NSSAI).
b) Corporate applications reachable via a (DNN, S-NSSAI) but only in some
location (DNAI) ; e.g. the corporate applications are only accessible when the
UE is in some location corresponding to the corporate premises.
c) Internet applications not reachable via a specific (DNN, S-NSSAI)
negotiated with the operator but that should be only reachable via a general
purpose (DNN, S-NSSAI); e.g. traffic of UE(s) of this third party targeting
Internet applications is not to be sent to a specific (DNN, S-NSSAI)
negotiated with the operator as this traffic is not expected to cross the
Intranet of the corporate.
d) Internet applications reachable via both a specific (DNN, S-NSSAI)
negotiated with the operator and via a general purpose (DNN, S-NSSAI) for
which the third party may want to set preferences between these 2 kinds of
connectivity. These preferences may depend on the UE location,
e) etc.
The cases a), b), etc. above may correspond to different corporate that have
different policies.
In the case of the usage of a specific (DNN, S-NSSAI) negotiated with the
operator, the third party may wish to control the DNS resolver used by the UE
(the IP address of the DNS server sent to the UE and the corresponding
security related information).
Some configuration of URSP upon AF request is already (in Rel-16) possible for
5G VN group data but here the data configuration is not meant for 5G VN group
members but to corporate users or users of a specific application that are not
meant to only communicate with each other.
The solution relates to KI 1 and addresses how an AF can provide the 5GC with
information about the relative precedence of data (PDU) Sessions (e.g.
relative precedence of (DNN, S-NSSAI)) to use to reach different domains (sets
of FQDN) possibly depending on the DNAI where traffic of this PDU Session may
be offloaded.
The solution relies on:
\- 5GC can get from AF information on the domains (set of FQDN(s)) supported
on a DN / local access to a DN (DNAI); these domains may be associated with a
set of DN priority information. This information may be translated by NEF and
is stored in UDR for further possible PCF consumption. This is further
described in clause 6.13.2.1; The DN priority information indicates the
relative priority (DN priority value) of one or any (DNN, S-NSSAI) for the
domains (set of FQDN(s)) indicated by the AF.
The AF can associate the same set of FQDN(s) with different DN priority values
for different (DNN, S-NSSAI).
NOTE 1: this is to cover case d) above where the AF of a corporate would try
to configure the following for the UE(s) of this corporate: internet
applications are reachable with lower priority via a specific corporate (DNN,
S-NSSAI) negotiated with the operator and are reachable with Higher priority
via a general purpose (DNN, S-NSSAI) (generic Internet access of the
operator).
Information on the domains (set of FQDN(s)) supported on a DN / local access
to a DN (DNAI) is later on called \"DN priorities for appDomains\". It
consists of a list of rules that each associates a FQDN filter with DN
priority information:
\- A FQDN filter corresponds to a (possibly set of) FQDN (with possible
wildcarding such as such as \"*.example.com\") and is associated with a
filtering priority.
NOTE 2: How the different elements of the \"DN priorities for appDomains\" are
used is described for the URSP alternative at the end of clause 6.13.1.2.
The filtering priority is used when detecting a FQDN: it allows to define a
rule targeting FQDN = toto.example.com with higher detection / filtering
priority than a rule targeting FQDN = *.example.com. The DN priority is to
select between different (DNN, S-NSSAI) that may be associated with traffic
identified by the FQDN filter.
\- one or more set of DN priority information that each may correspond to:
\- a (DNN, S-NSSAI). This may be provided by the AF or determined by the NEF
based on the AF identity when it is not provided by the AF and the AF provides
only one instance of DN priority information.
\- a default DN priority value to be used for the FQDN(s) identified by the
FQDN filter when DN priority for DNAI is not provided or does not apply.
\- for the \"DNS alternative\" in clause 6.13.1.3: a default DNS Server
configuration information; this information is optional and is associated with
the default DN priority above.
\- a list of DN priority for DNAI that each associate a DN priority value and
a DNAI for the FQDN(s) identified by the FQDN filter / rule when the DNAI
applies to the PDU Session.
\- for the \"DNS alternative\" in clause 6.13.1.3: an optional list of DNS
Server configuration information each associated with a DNAI and a DN priority
for DNAI described above.
The DNS Server configuration information corresponds to the DNS Server related
information sent to the UE. It may include the address of the DNS server as
well as DNS server security information as specified in TS 24.501 [40] and TS
33.501 [38]. This information is associated to the (DNN, S-NSSAI) and specific
to the FQDN filter in same \"DN priorities for appDomains\" rule and may apply
only for specific (DNN, S-NSSAI) negotiated with the operator.
NOTE 3: the DNAIs that apply to a session may depend among other on the DNN
and S-NSSAI, the user location and network topology.
\- An optional spatial Validity condition that indicate where the rule is to
apply. This may correspond to a geographical area (i.e. geographical zone
identifier) or a (set of) DNAI.
NOTE 4: For example, for a DN related with corporate access, the FQDN(s)
corresponding to corporate services can be associated with a higher DN
priority value than FQDN(s) for internet-based services (when the corporate
also has an access to the Internet thus allowing also access to internet based
services). The AF(s) corresponding to different corporate or different
services can\'t co-ordinate the DN priority values between themselves. The co-
ordination between DN priority values set by different AF is done by the PCF
as explained in clause 6.13.2.1
This \"DN priorities for appDomains\" information may be used by 5GC at 2
levels:
1) URSP alternative: to set the Rule Precedence of URSP rules whose Traffic
descriptor / Domain descriptor corresponds to such domains (sets of FQDN). The
solution uses the existing Rel-16 URSP rules without change for UE
perspective. Only change is how the PCF derive the URSP rules based on \"DN
priorities for AppDomains\". URSP(s) delivered to UE(s) follow Rel-16
specifications; UE use URSP(s) for matching a PDU Session, as defined in
Rel-16.
2) DNS alternative: DNS configuration on the UE i.e. which DNS server a multi
Homed UE will consider for a DNS look-up.
The solution addresses following Connectivity Models:
\- Multiple PDU sessions including some more local PDU Sessions and PDU
Sessions to corporate DN: the information on the domains (set of FQDN(s))
supported on a DN may then be received from a third party DN and has to be
mapped with operator policies.
\- Session Breakout.
#### 6.13.1.2 URSP Alternative
The alternative is defined to allow the AF to influence PCF decisions for URSP
rules for one UE, a group of UEs, etc... as described in Solution #1
On the UE interface this alternative reuses Rel-16 interface (URSP configured
by the PCF) without change for UE perspective (or with changes as specified in
solution 1 about UE taking into account URSP when resolving a FQDN via DNS).
The difference with Rel-16 lies on the fact that the AF API can provide
guidance on URSP building that:
\- is not related with 5G VN group;
\- allows the AF to provide different rules for the same domains (sets of
FQDN(s)) with different DN priority values for different (DNN, S-NSSAI):
typically a DN priority value for the (DNN, S-NSSAI) dedicated to the
corporate that the AF represents and another DN priority value for any other
(DNN, S-NSSAI).
As described in 6.13.1.1, AF may provide DN priority information specific to a
DNAI. If so, PCF determines the DNAIs applicable for the PDU session to build
the URSPs. Any Spatial Validity conditions in terms of a (set of) DNAIs
provided by AF are adapted to fit the Location Criteria in the RSD part
supported in Rel-16 URSP rules.
The PCF acquires Application Data related with appDomains from the UDR as
described clause 6.13.2.1. The PCF uses these Application Data to compose the
URSP rules for the UE as follows for each \"DN priorities for appDomains\"
filtering rule:
\- the FQDN filter is used to set the Destination FQDNs or a regular
expression in the Domain descriptor in the Traffic descriptor in the URSP rule
(defined in TS 23.503 [4] Table 6.6.2.1-2);
\- the filtering rule priority is used to set the Rule precedence value of the
URSP rule (defined in TS 23.503 [4] Table 6.6.2.1-2),
\- DNN and S-NSSAI are used to set the DNN selection and Network Slice
selection Route selection components in the Route Selection Descriptor of the
URSP rule, respectively (defined in TS 23.503 [4] Table 6.6.2.1-3);
\- the DN priority that results of DNAI applicability evaluation is used to
set the Route Selection Descriptor Precedence in the Route Selection
Descriptor (defined in TS 23.503 [4] Table 6.6.2.1-3);
\- DNAI or geographical zone identifier in the spatial Validity conditions, if
any, are mapped to the list of Cell IDs, RAN node IDs or TAI list in the
Location Criteria in the Route Selection Descriptor of the URSP rule (defined
in TS 23.503 [4] Table 6.6.2.1-3).
The PCF stores the composed URSP rules of the UE to the UDR as part of UE\'s
Policy Set entry and updates the UE as described in clause 6.1.2.4 in TS
23.503 [4].
An example of How the DN priority per appDomain can influence the URSP rule
generation in PCF is the following:
A corporate wishes for the UE its employees (members of a group for corporate
users) that:
\- They use a specific DNN (and slice) \"My-corporate-URLLC\" when the UE try
reach the App corresponding to the FQDN = robot-control.corporate.com.
\- They use a specific DNN (and slice) \"My-corporate\" when the UE try reach
any other App corresponding to a FQDN *.corporate.com.
\- They preferably use another DNN for other Internet applications: they can
use the specific DNN \"My-corporate\" but with lower priority.
\- With the exception that when traffic offload to DNAI xx takes place, the
members of a group for corporate users should now use specific DNN \"My-
corporate\" for all applications (this is because in this case a direct and
cheaper connectivity to the Internet via the corporate Intranet is used).
The corporate via a NEF API associates following DN priorities for appDomains
rules with the Group of corporate users (assuming The higher the value of the
precedence / priority value, the lower the priority is and priorities may have
a value in 1,2,3).
\- For FQDN filter = robot-control.corporate.com and filtering priority = 1:
\- DNN (and slice) \"My-corporate-URLLC\", with high default DN priority = 1.
\- For FQDN filter = domain *.corporate.com and filtering priority = 2:
\- DNN (and slice) \"My-corporate\" with high default DN priority = 1.
\- For FQDN filter = domain *.*.com and filtering priority = 3 (other domains
(filter with lower rule priority)):
\- DNN (and slice) \"My-corporate\" with low default DN priority =3 , (this
means that any operator defined DNN (and slice) for the default FQDN filter =
domain *.*.com supersedes DNN (and slice) \"My-corporate\".
\- DNN (and slice) \"My-corporate\" with high DN priority =1 for DNAI xx.
#### 6.13.1.3 DNS Alternative
A UE that has multiple PDU Sessions will receive multiple DNS server address
and needs to know which of these DNS servers it needs to use to translate a
target FQDN.
NOTE 1: RFC 6731 [26] specifies how a DHCP server can express preferences and
domains for DNS server information it provides to DHCP clients. However, RFC
6731 [26] does not specify how the DHCP server acquires specific knowledge of
domains and networks. An administrator may choose to utilize the different
preference values, for instance by manual configuration (RFC 6731 [26] clause
3). And 3GPP has not defined whether and how to use RFC 6731 [26] (for example
considering Session Breakout and Multiple PDU sessions defined in clause 4.2
of this TR).
NOTE 2: In the case of multiple PDU Sessions for a UE, information on
(different) DNS servers that the UE can use are advertised on each of these
different PDU Sessions. This currently may use NAS (PCO), RA (Router
Advertisement messages), or DHCP to transfer this information to the UE but
3GPP currently does not define how to guide the UE to select the right DNS
server (considering e.g. relative priorities). Clause 7.1.4 further clarifies
the procedure and includes recommendations that have been agreed for normative
phase (as per clause 9.1)
At PDU Session establishment, the PCF transforms this DN priorities for
appDomains information into PDU Session related Policy used by SMF to send DNS
configuration information to the UE. This transformation is described in
6.13.2.3.
UE applies the received DNS configuration (including DNS priorities) in a UE
host-wide way: they are used by a UE that does not apply URSP to determine
which DNS to use.
The DNS configuration received from the SMF does not provide the trigger to
establish PDU Sessions but it provides the DNS priorities after/during the PDU
session establishment.
The UE uses the DNS information received from the SMF (NAS, DHCP, etc...) to
configure its IP stack.
NOTE 3: whether the EAS information associated with the old DNS configuration
needs be cleaned is to be solved as part of KI 2.
The DNS Alternative is specifically meant for a UE that has access to one DNN
(one single PDU Session) but is multi-homed (per IPV6 multihoming) or because
an UL CL has been inserted to the PDU Session.
### 6.13.2 Procedures
#### 6.13.2.1 Configuring DN priorities for appDomain information on PCF
Figure 6.13.2.1-1: Configuring DN priorities for appDomains information on PCF
1\. An Application Function (AF) invokes NEF API (e.g. Nnef_ServiceParameter
API) to communicate DN priorities for appDomains (as defined in clause 6.13.1)
to Network Exposure Function (NEF). This information may be associated
(\"target\") with an individual UE or with a group of UE (for example all
UE(s) of a corporate) or with any UE.
2\. The NEF may translate the AF identity into a target (DNN, S-NSSAI). The
NEF stores the information (after possible translation by NEF) including in
the UDR (corresponding data set and subset are indicated in step 5).
3\. The UDR responds to NEF.
4\. The NEF responds to the AF.
5\. The PCF may acquire (GET or SUBSCRIBE to notifications on change of)
Application Data from UDR including the DN priorities for appDomains
information.
The PCF(s) that have subscribed to notification on modifications of AF
requests (Data Set = Application Data; Data Subset = DN priorities for
appDomains,) receive(s) a Nudr_DM_Notify notification of data change from the
UDR. Internal Group Identifier or SUPI may be used as Data Key to cover the
case where the AF requests \"targets\" an individual UE or a group of UE.
6\. the PCF applies this information to determine policies to build URSP or
policies related with DNS priority selection in the UE.
The PCF may receive different policies from different AF (e.g. receive
policies from a third party AF corresponding a corporate group of users and
also apply policies applying to any UE received from different AF(s) managing
Edge computing application deployments). The PCF needs to build an unique map
of relative priorities between (DNN, S-NSSAI) for a given domain (range of
FQDN) (to be sent to the UE as URSP, see clause 6.13.2.2 or as information
sent to the SMF for a PDU Session see clause 6.13.2.3). For this purpose, the
PCF considers local policies to resolve the potential conflicts, policies that
take into account the identity of the AF that has provided a DN priorities for
appDomains policy.
#### 6.13.2.2 Usage of DN priorities for appDomains information to configure
URSP
1\. The UE Registers.
2\. The AMF selects a PCF and establishes an AM Policy Association with the
PCF by invoking Npcf_AMPolicyControl_Create operation (providing the IMSI
Group of the UE.
All steps above are as for TS 23.502 [3] clause 4.2.2.2.2 (with no intended
changes).
3\. If the PCF does not have relevant policy data (e.g. policy data related
with for the Group the UE is belonging to), it sends a corresponding request
to the UDR by invoking Nudr_DataRepository_Query operation. The PCF may also
request notifications from the UDR about changes on the corresponding policy
information (including DN priorities for appDomains for an IMSI group by
invoking Nudr_DataRepository_Subscribe.
4\. The UDR responds to the PCF with Nudr_DataRepository_Query response
including DN priorities for appDomains that includes the list specific domains
(and networks).
The DN priorities for appDomains information configured on PCF by mechanisms
described in the clause 6.13.2.2 and recalled above may be used to generate
USRP sent to the UE; URSPs sent to UE are Rel-16 URSPs.
#### 6.13.2.3 SMF influence on UE preferences between multiple Recursive DNS
Servers
This clause applies to the DNS Alternative.
Figure 6.13.2.3-1 illustrates the SMF influence on UE preferences between
multiple Recursive DNS Servers and the delivery of DNS Configuration
information to UE as part of PDU Session Establishment procedure (defined in
TS 23.502 [3] clause 4.3.2).
Figure 6.13.2.3-1: SMF influence on preferences and domains and networks for
multiple Recursive DNS Servers.
1\. The UE initiates a UE Requested PDU Session Establishment procedure to a
(DNN, S-NSSAI).
2\. The AMF selects an SMF and sends Nsmf_PDUSession_CreateSMContext Request
to SMF.
3\. SMF selects a PCF.
4\. SMF establishes a SM Policy Association with the PCF by invoking
Npcf_SMPolicyControl_Create operation providing the (DNN, S-NSSAI) of the PDU
Session.
All steps above are as for TS 23.502 [3] clause 4.3.2.2.1 (with no intended
changes)
5\. If the PCF does not have policy data for the (DNN, S-NSSAI) of the PDU
Session, it sends a corresponding request to the UDR by invoking
Nudr_DataRepository_Query operation. The PCF may request notifications from
the UDR about changes on the corresponding policy information (including DN
priorities for appDomains mapping to DNN and S-NSSAI) by invoking
Nudr_DataRepository_Subscribe.
6\. The UDR responds to the PCF with Nudr_DataRepository_Query response
including DN priorities for appDomains that includes the list specific domains
(and networks).
Steps 5 and 6 may be omitted if the PCF had subscribed to notification of this
data change as defined in step 4 of TS 23.502 [3] Figure 4.3.6.2-1or in step 5
of Figure 6.13.2.1-1.
PCF decides on DNS preferences for (DNN, S-NSSAI) using the DN priorities for
appDomains information received from UDR but also local policies (see also
step 7 and clause 6.13.2.1). The output of this decision is called DNS
Configuration information. The PCF can then use the DNS Configuration
information to provide it to SMF.
7\. The PCF responds to the SMF with Npcf_SMPolicyControl_Create response
including DNS Configuration information.
The PCF is responsible to transform \"DN priorities for appDomains\"
information into \"DNS configuration information\" to be provided to SMF as
part of PCC rules. \"DNS configuration information\" has the same format than
DN priorities for appDomains\", but:
\- with DN priority values that have been normalized based on PCF locally
configured policies related with (DNN, S-NSSAI);
\- with only information suitable for (DNN, S-NSSAI) of the PDU Session.
Editor\'s note: It is FFS if and how roaming can be supported, e.g. how to
support URSP in LBO roaming, or how to support AF influence for traffic
routing in HR roaming.
Editor\'s note: It is FFS whether \"DN priorities for appDomains\" with no DNS
configuration are provided, and if so, how that should be interpreted by SMF.
8\. SMF communicates the DNS Configuration information in PDU Session
Establishment Response by:
\- including DNS Configuration information in Extended PCO IE (8.a). in this
case it may include DNS server security information as specified in TS 23.501
[2] clause 5.6.10.1; or
\- when acting as DHCP server by including in DHCP RDNSS option when
communicating with UE using DHCP (8.b); or
\- in RA (per RFC 8106).
If PCC does not apply to a PDU Session, the SMF determines locally the DNS
Configuration information.
The SMF may take into account DNS configuration information into account when
selecting a LDNSR for a PDU Session.
Editor\'s note: How SMF transforms the DNS Configuration information form the
PCF into the DNS Configuration information provided to the UE needs to be
described (handling of DNAI conditions at the UE is not possible).
If the PCF determines that DNS Configuration information has changed (because
e.g. DN priorities for appDomains information has changed) it can provide a
new DNS Configuration information as part of a Npcf_SMPolicyControl_Update.
The SMF may provide the corresponding information to the UE:
\- Via NAS PCO sent in a network initiated PDU Session modification procedure;
or
\- Via Router Advertisement (\'RA\' per IETF RFC 8106) (in IPv6 case);
\- Via DHCP FORCERENEW and DHCP INFORM defined in DHCP reconfigure extension
(RFC 3203) that are subject to authentication of DHCP message as defined in
RFC 3118 forcing the UE to get again the DNS configuration via DHCP. This
alternative may not be supported by the UE in which case the SMF may be unable
to transfer an update of DNS Configuration information unless it executes a
SSC mode 3 procedure.
### 6.13.3 Impacts on services, entities and interfaces
\- NEF: new API information to support and to convert into policy data stored
in UDR:
The NEF service Nnef_ServiceParameter is enhanced to allow the AF to influence
PCF decisions for URSP rules. In addition to the enhancements described in
Solution #1, the service is enhanced in this solution to allow the AF to
provide the \"DN priorities for appDomains\" described in clause 6.13.1.1.
\- UDR: new Application Data format (DN priorities for appDomains) to manage.
\- PCF: retrieve new UDR Application Data; and:
\- either (DNS alternative) (SM PCF) determines DNS Configuration information
to be provided to SMF via PDU Session level policy data;
\- or (URSP alternative) (AM PCF) uses it as guidance to build the URSPs to
send to the UE. URSPs sent to UE are Rel-16 URSPs.
\- SMF: (DNS alternative) send DNS Configuration information via PCO / DHCP /
Router Advertisement to the UE.
\- UE: (DNS alternative) new DNS Configuration information for the PDU
Session.
The content of the DNS configuration that is provided to the UE has the same
format as the DHCP RDNSS option (when sent in PCO or via the DHCP RDNSS option
or as defined in RFC 8106 in IPv6 case).
## 6.14 Solution #14: IP address discovery for the Service Switch mechanism -
DNS handling in both UPF and EC
### 6.14.1 Description
#### 6.14.1.1 Introduction
This solution can apply to key issue 1.
In certain deployment, the third party has their own Service Switch to
allocate the IP address of application server to the UE, based on UE\'s
requested content in the application layer, server distribution information
and other internal policies. The Service Switch has the whole knowledge of its
application server distribution in the application provider\'s own DC and the
EC.
NOTE: Regards to the application server deployed in the EC, the Service Switch
only knows the information of application servers in the EC for its own
applications, but not for applications which belong to other application
providers.
In this approach, the DNS deployed in the mobile network resolves the IP
address of the Service Switch based on the DNS request, and sends the IP
address of the Service Switch within the DNS response. And then, the UE sends
the HTTP request to the Service Switch and gets the IP address of the
application server in the HTTP response. In most cases, the messages between
the UE and Service Switch or application server are based on HTTS protocol.
Figure 6.14.1.1-1 shows how this mechanism works.
Figure 6.14.1.1-1: Current Service Switch mechanism
The solution assumes the Service Switch is pre-configured with the mapping
information between the IP address range supported by PSA (not the PSA
information) and EAS information based on the agreement between the MNO and
service provider.
For the connectivity models defined in clause 4.2, the analysis of applying
Service Switch mechanism is as follows:
\- Distributed Anchor Point:
The Service Switch could get the knowledge that the UE can be served by the
edge network based on the UE\'s IP address, if the Service Switch can store
the mapping relationship between the PSA UPF\'s IP address range and the
corresponding edge network.
The 5GC may apply NAT to the DNS requests from the UE in order to protect the
user privacy. In this case, the IP address range in the mapping information
configured in the Service Switch should correspond to the IP address range
after the NAT.
Service Switch mechanism can apply to this connectivity model without any
additional impacts on the existing procedures compared with other solutions
for the Distributed Anchor model.
\- Session Breakout:
The Service Switch can\'t get the information about the edge network based on
the UE\'s IP address, so the solution for this connectivity model needs
further enhancements to support the Service Switch mechanism.
The detailed solution for supporting Service Switch mechanism based on this
connectivity model is introduced in this contribution.
\- Multiple PDU sessions:
Edge Computing applications use a specific PDU session with the PDU Session
anchor in the local site. Since the Service Switch mechanism aims to support
the server distribution in both edge network and cloud DC, it is not relevant
with this connectivity model.
After the above analysis, the solution in the following clauses is proposed
for supporting Service Switch mechanism for Session Breakout connectivity
model for key issue 1.
#### 6.14.1.2 Solution description
The solution is used to solve session breakout connectivity model for the
scenario that the application servers are deployed both in the edge network
and application provider\'s central DC for the Service Switch mechanism. The
network architecture for this scenario is shown in Figure 6.14.1.2-1.
Figure 6.14.1.2-1: Deployment architecture for Service Switch mechanism
In Figure 6.14.1.2-1, Service Switch has the knowledge of both the cloud
application servers and EAS including their IP address, load status and
content distribution. In order for the Service Switch to allocate the IP
address of the EAS to the UE, it needs to have some assistance in the HTTP
request in step 3 shown in Figure 6.14.1.2-1.
In this contribution, it proposes to route the step 3 to the edge network.
Then the edge network replaces the source address of the HTTP request to the
external address of the edge network. Then the Service Switch knows that there
is an edge network serving the UE\'s request. The Service Switch also needs to
decide whether and which EAS has the content the UE is requesting.
In order to divert step 3 to Edge network, following enhancements are needed:
In step 2, the I-UPF duplicates the DNS response message before forwarding the
DNS response message to the UE. The I-UPF sends the duplicated DNS response
message to the Edge network. Then the DNS handling function deployed as an ME
service in the Edge network checks the DNS message. If it matches certain
condition, the DNS handling function will extract the IP address, i.e., IP
address of Service Switch, from the DNS response message. The DNS handling
function working as the Edge AF to send the IP address to the SMF via NEF as a
new traffic steering rule. The SMF will configure the new traffic steering
rule in the I-UPF.
NOTE 1: The Detection of the packets needs to be supported as a ME service in
the Edge network.
NOTE 2: The address(es) of Service Switch are dynamically changed by the
service provider, so it\'s hard to preconfigure the address(es) of Service
Switch in the network as the traffic steering rules.
In step 3, when the UE sends the HTTP request to the Service Switch, the
message will be diverted to the edge network. Then the edge network will
replace the source address of the message with the external address of Edge
network, and then send it to the Service Switch. The Service Switch will make
the decision on the server allocation based on the source address information
of the HTTP request.
Mostly, the application layer protocol between the UE and server (including
the Service Switch and application server) is HTTPS. This solution can also
apply when the application layer is based on HTTPS protocol.
The solution is briefly introduced in Figure 6.14.1.2-2. The detailed
procedure is shown in clause 6.14.2.
Figure 6.14.1.2-2: Brief introduction of the solution
### 6.14.2 Procedures
Figure 6.14.2-1: Procedure for Service Switch mechanism
0\. The PDU session with I-UPF supporting ULCL or BP is established.
1\. After the establishment of the PDU session, the UE sends the DNS request
to the DNS server in order to get the IP address of the Service Switch.
2a. The DNS server sends to the I-UPF the DNS response message including the
IP address of the Service Switch.
2b. The I-UPF replicates the DNS response message and forwards the replicated
DNS response message to the Edge network.
The DNS handling function deployed as a ME service in the Edge network checks
the packet. If certain criterion such as FQDN is matched, the IP address is
extracted from the DNS response message.
2c. The AF function in the Edge network sends the request to the SMF via NEF
to configure the IP address extracted from the DNS response message as new
traffic steering rule as steps defined in clause 4.3.6.2 in TS 23.502 [3].
2d. The I-UPF sends the original DNS response message to the UE after step 2c,
or after the buffer timer expires.
3\. The UE sends the HTTP request, the destination address of which is the
Service Switch, to the I-UPF. The I-UPF diverts the HTTP request to the Edge
network. The ME service in the Edge network will replace the source address of
the message with the external address of the Edge network. And then it sends
the message to the Service Switch.
4\. The Service Switch decides which server can best serve the UE based on the
source address and the requested content within the HTTP request message. The
Service Switch sends the HTTP response message including the IP address of EAS
to the Edge network, and then the Edge network forwards the response message
to the UE.
5\. The UE accesses the EAS based on the IP address contained within the HTTP
response message.
NOTE 1: Steps 2c, 3 and 4 are related with special handling in EC and are
introduced in the procedure to show the end-to-end procedures to support the
Service Switch mechanism. These steps have no impacts on the existing network
functionalities.
NOTE 2: Application filters for diverting the application traffic to the EASs
may be configured in the I-UPF/ULCL at step 0 or at step 2c. If the
application filters are configured at step 2c, the AF function in the Edge
network could also include the FQDN and DNAI in the request message to the
NEF/SMF. SMF also decides to configure the EAS IP address(es) as the new
traffic steering rule at I-UPF based on the FQDN and DNAI. The mapping
information between the FQDN and DNAI to the EAS IP addresses could be
preconfigured in the SMF.
### 6.14.3 Impacts on services, entities and interfaces
The solution requires the insertion of I-UPF supporting ULCL or BP during the
PDU session establishment. It has the following impacts:
I-UPF needs to support following DNS handling functionalities:
\- Supporting the duplication of the DNS response message.
\- Forwarding the copy of DNS response message to the Edge network.
The following DNS handling functionalities are supported in the EC:
\- DNS response message detection;
\- Trigger the SMF to configure the new traffic steering rule in the ULCL UPF.
No impacts on UE, AN, AF, other control plane NFs and application layer.
## 6.15 Solution #15: IP address discovery for the Service Switch mechanism-
DNS handling in UPF
### 6.15.1 Description
This solution can apply to key issue 1. The Service Switch mechanism is
described in solution#14. As analysis in solution #14, for the scenario that
the content is distributed in both EAS and cloud DC, the solution is needed
for Service Switch mechanism for Session Breakout connectivity model for key
issue 1. The network architecture of Session Breakout connectivity model for
Service Switch mechanism is shown in Figure 6.15.1-1.
Figure 6.15.1-1: Deployment architecture for Service Switch mechanism
In this solution, it proposes some enhancements on the existing procedures in
Figure 6.15.1-1. As analysis in solution#14, the basic idea is to exact the IP
address within the DNS response message. If certain criterion such as FQDN is
matched, the network sets the IP address as the new traffic steering rules.
The detailed procedures are shown in clause 6.15.2.
### 6.15.2 Procedures
#### 6.15.2.1 Option 1: Supporting DNS handling function in UPF anchor
This option applies to the scenario that I-UPF (ULCL or BP) isn\'t inserted
during the PDU session establishment.
Figure 6.15.2.1-1: Procedure for Service Switch mechanism-Option 1
0\. The PDU session is established.
1\. After the establishment of the PDU session, the UE sends the DNS request
to the DNS server in order to get the IP address of the Service Switch.
2a. The DNS server sends to the UPF anchor 1 the DNS response message
including the AS IP address, i.e., IP address of the Service Switch.
2b. The DNS handling function deployed in UPF anchor 1 checks the DNS response
message. If certain criterion such as FQDN is matched, the IP address is
exacted from the DNS response message. UPF anchor 1 further decides the DNAI
based on the FQDN. If the UPF can\'t decide the DNAI, it may send the FQDN to
the SMF in step 2c.
2c. The UPF anchor 1 sends the IP address exacted from the DNS response
message and DNAI and FQDN to the SMF in order to request the SMF to insert
I-UPF and set the traffic steering rules for diverting the traffic for both
the Service Switch and EASs.
2d. If the SMF agrees to modify the PDU session, it modifies the PDU session
with insertion of I-UPF and sets the traffic steering rules. If the SMF
rejects the request, it sends the ACK message to the UPF anchor 1.
2e. After receiving the SMF response, the UPF anchor 1 forwards the DNS
response message to the UE.
3\. The UE sends the HTTP request, the destination address of which is AS IP
address within the DNS response message, i.e. IP address of the Service
Switch, to the I-UPF. If the new traffic steering rule is successfully
configured in step 2d, the I-UPF diverts the HTTP request to the Edge network.
The ME service in the Edge network will replace the source address of the
message with the external address of the Edge network. And then it forwards
the message to the Service Switch.
4\. The Service Switch decides which server can best serve the UE based on the
source address and the requested content within the HTTP request message. The
Service Switch sends the HTTP response message including the IP address of the
edge server to the Edge network, and then the Edge network forwards the
response message to the UE.
5\. The UE accesses the edge server based on the IP address contained within
the HTTP response message.
NOTE 1: Step 3 and step 4 are related with special handling in EC and are
introduced in the procedure to show the end-to-end procedures to support the
Service Switch mechanism.
NOTE 2: Step 1 to step 2e can also be used to support general DNS solutions.
#### 6.15.2.2 Option 2: Supporting DNS handling function in I-UPF(ULCL or BP)
This option applies to the scenario that the I-UPF (ULCL or BP) is inserted
during the PDU session establishment.
Figure 6.15.2.2-1: Procedure for Service Switch mechanism-Option 2
0\. The PDU session with I-UPF supporting ULCL or BP is established.
1\. After the establishment of the PDU session, the UE sends the DNS request
to the DNS server in order to get the IP address of the Service Switch.
2a. The DNS server sends to the I-UPF the DNS response message including the
IP address of the Service Switch.
2b. The DNS handling function deployed in I-UPF checks the DNS response
message. If certain criterion such as FQDN is matched, the IP address is
extracted from the DNS response message. If the I-UPF could set the new
traffic steering rule without SMF trigger, it configures the new traffic
steering rule and reports to SMF. Otherwise, I-UPF sends the request to SMF to
trigger the update of the traffic steering rule.
2c.The I-UPF sends the request to SMF to trigger the update of the traffic
steering rule including the IP address exacted from the DNS response message.
2d. If the SMF agrees to configure the new traffic steering rule, it modifies
the PDU session with the new traffic steering rule. If the SMF rejects the new
traffic steering rule, it sends the ACK message to the I-UPF.
2e. After receiving the SMF response, the I-UPF forwards the DNS response
message to the UE.
3\. The UE sends the HTTP request, the destination address of which is the
Service Switch, to the I-UPF. If the new traffic steering rule is successfully
configured in step 2d, the I-UPF diverts the HTTP request to the Edge network.
The ME service in the Edge network will replace the source address of the
message with the external address of the Edge network. And then it forwards
the message to the Service Switch.
4\. The Service Switch decides which server can best serve the UE based on the
source address and the requested content within the HTTP request message. The
Service Switch sends the HTTP response message including the IP address of the
edge server to the Edge network, and then the Edge network forwards the
response message to the UE.
5\. The UE accesses the edge server based on the IP address contained within
the HTTP response message.
NOTE: Application filters for diverting the application traffic to the EASs
could be configured in the I-UPF/ULCL in step 0 or in step 2c-2d. If the
application filters are not configured in step 0, the I-UPF could include the
FQDN and DNAI in the request message to the SMF in step 2c. SMF also decides
to configure the EAS IP address(es) as the new traffic steering rule at I-UPF
based on the FQDN and DNAI. The mapping information between the FQDN and DNAI
to the EAS IP addresses could be preconfigured in the SMF.
### 6.15.3 Impacts on services, entities and interfaces
**Option 1:**
Impacts to UPF for supporting following DNS handling functionalities:
\- Check DNS response message;
\- If certain criterion such as FQDN is matched, the IP address contained in
the DNS response message is extracted;
\- Send the request to the SMF including the IP address and FQDN contained in
the DNS response message in order to insert the I-UPF and sets the new traffic
steering rules for diverting the traffic for both the Service Switch and EASs.
Impacts to SMF:
\- The SMF receives the request from UPF, decides whether to insert the I-UPF
and configures the new traffic steering rules in the I-UPF.
No impacts to UE, AN, AF, other control plane NFs and application layer.
Don\'t require the deployment of LDNS in EC. The DNS handling functionalities
are similar with part of LDNSR functionalities in sol#22.
**Option 2:**
Impacts to I-UPF for supporting DNS handling functionalities:
\- Check DNS response messages;
\- If certain criterion such as FQDN is matched, the IP address contained in
the DNS response message is extracted;
\- If the I-UPF could set the new traffic steering rule without SMF trigger,
it configures the new traffic steering rule and reports to SMF;
Otherwise, I-UPF sends the request to the SMF to request to set the extracted
IP address as the new traffic steering rule. The I-UPF could also include the
FQDN and DNAI to the SMF to set the traffic steering rule for the EASs.
Impacts to SMF:
\- Receive the request from UPF to set the new traffic steering rules
\- Decides whether to configure the new traffic steering rules in the I-UPF
No impacts to UE, AN, AF, other control plane NFs and application layer.
Don\'t require the deployment of LDNS in EC. The DNS handling functionalities
are similar with part of LDNSR functionalities in sol#22.
## 6.16 Solution #16: Edge Configuration Server Based Discovery
### 6.16.1 Introduction
This solution addresses Key Issue #1, \"Discovery of Edge Application Server\"
and focuses on the scenario where UE needs to be provisioned with information
about the Edge Hosting Environment.
NOTE: This is not a general solution; it is a solution to support the case
where the UE hosts an Edge Enabler Client (EEC) as defined in TS 23.558 [12]
and the UE has the capability to deliver the ECS address information to EEC.
Key Issue #1, NOTE 3 states \"For sake of easy implementation, solutions
should preferable be based on existing mechanisms (e.g. DNS, SFC techniques)
and industry practices to avoid or at least minimize impact on applications
and UEs. Additionally, the outcome from SA WG6 FS_EDGEAPP may be considered if
impacts to 5GC are identified.\" This solution is based on solutions that have
been specified as part of SA WG6\'s EDGEAPP work.
In TS 23.558 [12], SA WG6 has introduced functional entities called the Edge
Configuration Servers and Edge Enabler Servers (EES). The Edge Configuration
Server does not necessarily reside in the Edge Data Network. Edge Enabler
Servers do reside in the Edge Data Network.
When deployed, the Edge Configuration Server provides UE Applications (i.e.
Edge Enabler Clients) with configuration information related to Edge Data
Network(s). Once the UE Application (i.e. the UE\'s Edge Enabler Client) has
contact information for the Edge Enabler Server, the UE Application can obtain
additional configuration information to enable the exchange of Application
Data Traffic with the Edge Application Server; this is described in TS 23.558
[12].
TS 23.558 [12] specifies that the Edge Enabler Client has been pre-configured
or discovered the address (e.g. URI) of the Edge Configuration Server. TS
23.558 [12] states \"_ECS address information can be pre-configured with the
EEC, configured by an edge-aware Application Client, configured by the user,
provisioned by MNO through 5GC procedure, or derived from HPLMN identifier for
non-roaming scenario or from VPLMN identifier for roaming scenario_.\" TS
23.558 [12] also notes that \"_5GC provision of ECS configuration information
to the UE is in scope of SA WG2_.\"
This solution describes how UE Applications (i.e. an EEC (Edge Enabler
Client)) can discover contact information for the Edge Configuration
Server(s). Once a UE Application (i.e. the Edge Enabler Client) has contact
information for an Edge Configuration Server, SA WG6 procedures, such as those
in TS 23.558 [12], can be used to interact with the Edge Configuration Server,
EES, and obtain contact information for Edge Application Servers.
### 6.16.2 Functional Description
The solution proposes how the UE may get Edge Configuration Server Information
from the network.
The principle is that the UE may get Edge Configuration Server Information
from the SMF during the PDU Session Establishment. The Edge Configuration
Server Information may be carried in the procedure in the PCO.
Edge Configuration Server Information consists of one or more FQDNs and/or IP
Address(es) of Edge Configuration Servers
The UE obtains, from the Edge Configuration Server, additional configuration
information to enable the exchange of Application Data Traffic with the Edge
Application Server. Existing Rel-16 mechanisms and/or other solutions to Key
Issue #1 can be used to route UE initiated traffic to the appropriate Edge
Application Server instance.
#### 6.16.2.1 Functional Description
Edge Configuration Server Information may be provided by the SMF to the UE
during the PDU Session Establishment procedure in the PCO. During PDU Session
Establishment, the UE may provide an indication of Requesting Edge
Configuration Server Information to retrieve the Edge Configuration Server
Information. The indication of Requesting Edge Configuration Server
Information is provided during PDU Session Establishment because not all UEs
will support SA WG6 Edge Enabler Clients. Additionally, when the UE does host
SA WG6 Edge Enabler Client(s), not all of the UE\'s PDU Sessions can make use
of Edge Configuration Server Information. Thus, not all UEs and not all PDU
Sessions can make use of Edge Configuration Server Information. The indication
of Requesting Edge Configuration Server Information is needed so that the
network knows that the UE supports the feature and so that the network knows
what PDU Session the Edge Configuration Server Information should be
associated with.
The H-SMF may derive the Edge Configuration Server Information based on local
configuration, the UE\'s location, and/or UE subscription information received
from the UDM. In HR sessions, the Edge Configuration Server Information comes
from the H-SMF. The UE\'s subscription information may include identities of
Edge Configuration Servers that the UE may access. For example, some UEs might
have a relationship with a 3^rd^ party and the network wants those UEs to be
able to discover ECS(s) that are deployed by the 3^rd^ party. If the Edge
Configuration Server Information changes (e.g. due to, local configuration
change, or a change of UE location), the SMF may use the PDU Session
Modification procedure to send the updated Edge Configuration Server
Information to the UE in the PCO.
NOTE 1: When the Edge Configuration Server Information comes from the HPLMN
(H-SMF) (i.e. in a home routed scenario), any Edge Configuration Server
Information that is associated with the VPLMN needs to come from the HPLMN.
For example, the information that the H-SMF sends to the UE may be based on
the VPLMN the UE is registered with and/or the UE\'s subscription information.
The ECS Information that is sent to the UE might point the UE to ECS(s) that
are managed by the home operator, visited operator, or a 3rd party.
NOTE 2: The UE might use a HR session to get ECS Information and access to the
ECS to get information about an EAS that is accessible via the VPLMN. After
that, since the HR session cannot be used to access to a EAS in VPLMN in this
release, the UE needs to establish a new LBO PDU Session to access the EAS in
VPLMN. In this case the new PDU Session has to be established to a different
(DNN, S-NSSAI) that is configured in the UDM to be eligible to LBO deployment
with the current VPLMN of the UE.
NOTE 3: In LBO scenarios, the SMF may send the UE Edge Configuration Server
Information.
The Edge Configuration Server Information sent to the UE in the PCO
corresponds to the IP address (and possibly port) of the ECS and/or to the
FQDN of the ECS.
### 6.16.3 Procedures
This clause describes how the solution interacts with SA WG6 procedures. Only
step 1 impacts SA WG2 specifications. There is no impact on SA WG6
specifications.
Figure 6.16.3-1 Procedure for Edge Configuration Server Based Discovery
1\. During PDU Session Establishment, the SMF provides Edge Configuration
Server Information (one or more FQDNs and/or IP Address(es) of Edge
Configuration Servers) to the UE. The UE may provide an indication of
Requesting Edge Configuration Server Information in the PDU Session
Establishment Request. As described in clause 6.16.2.1, the SMF derives the
Edge Configuration Server Information based on local configuration, the UE\'s
Location, or the UE\'s subscription information.
NOTE: TS 23.558 [12] states that the following cardinality rule applies on the
EDGE-4 reference point between the EEC (Edge Enabler Client) and ECS (Edge
Configuration Servers): \"One EEC may communicate with one or more ECS(s)
concurrently\".
2\. The UE contacts the Edge Configuration Server in order to be provisioned
with information about available edge computing services, including the
addresses/identities of Edge Enabler Server(s). This procedure occurs at the
application layer and is described in clause 8.3 of TS 23.558 [12].
3\. The UE initiates procedures as described in TS 23.558 [12].
### 6.16.4 Impacts on services, entities and interfaces
UE:
\- Provides an indication of Requesting Edge Configuration Server Information
to the AMF during Registration.
\- Receives Edge Configuration Server Information from the AMF during the
(re-)Registration and UE Configuration Update procedures.
\- UE may be provided with the ECS IP address and/or ECS FQDN and requires
enhancement to the UE (e.g. OS or OS and AT Commands) to support delivery the
ECS IP address or FQDN received in NAS signalling to the EEC inside the UE.
UDM/UDR (if the alternative to have ECS address stored in UDM/UDR is pursued):
\- A UE\'s subscription information may include Edge Configuration Server
Information (i.e. one or more FQDNs and/or IP Address(es) of Edge
Configuration Servers).
SMF:
\- May receive an indication of Requesting Edge Configuration Server
Information from the UE during PDU Session Establishment.
\- Sends Edge Configuration Server Information to the UE during the PDU
Session Establishment procedures.
\- Receives Edge Configuration Server information from the UDM/UDR during PDU
Session Establishment (when Nudm_SDM_Get is invoked) (if the alternative to
have ECS address stored in UDM/UDR is pursued).
## 6.17 Solution #17: Provisioning EC Parameters to the roaming UE related to
PDU Sessions for edge applications
### 6.17.1 Description
This is a solution for Key Issue #1 \"Discovery of Edge Application Server\"
in particular related to:
\- How can a UE discover a suitable Edge Application Server to serve the
application/UE?
\- What information (if any) can be used to assist such a discovery mechanism?
This solution proposes for the PCF in the serving PLMN (i.e. V-PCF) to
provision Edge Computing Parameters (EC Parameters) to the roaming UE related
to PDU Sessions for edge applications. Therefore, the UE can establish the PDU
Session suitable to perform EAS discovery based on the EC Parameters when the
UE is roaming. An AF provides the EC Parameters influence information by using
the Service specific parameter provisioning procedure as specified in clause
4.15.6.7 of TS 23.502 [3].
Edge computing enables operator and 3rd party services to be hosted close to
the UE\'s access point of attachment, so as to achieve an efficient service
delivery through the reduced end-to-end latency and load on the transport
network as described in clause 5.13 of TS 23.501 [2]. Therefore, it is
considered appropriate that UE\'s serving network for roaming scenario obtains
the edge computing related information from the AF that locally locates and
provides it to the UE. In this regard, this solution is proposed to complement
Solution #1 defined in clause 6.1 by addressing the roaming scenario with the
following differences from Solution #1:
1\. An AF providing the edge computing related information is the AF that
belongs to or has an agreement with VPLMN.
2\. The contents of the edge computing related information provided by the AF
are same to the URSP influence parameters in Solution #1 defined in clause
6.1, but influence the EC Parameters set by V-PCF instead of influencing the
URSP.
3\. The V-PCF (i.e. UE Policy PCF in the VPLMN) obtains the AF provided edge
computing related information from the UDR and determines the EC Parameters
for the target UE(s) that are roaming UE(s).
4\. The EC Parameters include DNN, S-NSSAI and other relevant network
parameters (i.e. PDU Session Type and SSC Mode) to be used for matching Edge
application traffic identified by IP address of the EAS or FQDN of the Edge
service.
If the AF provided Spatial Validity Conditions, the PCF generates Location
Criteria based on the Spatial Validity Conditions, and includes corresponding
Location Criteria in the EC Parameters.
5\. The V-PCF provisions the EC Parameters to the targeted UE by using the UE
Configuration Update procedure for transparent UE Policy delivery as specified
in clause 4.2.4.3 of TS 23.502 [3], if allowed by the HPLMN of the targeted
UE.
If the UE supports EC Parameters provisioning, the UE indicates its EC
Parameters support to the V-PCF in the UE Policy Container during registration
procedure when the UE is roaming. If it is received, the V-PCF shall take it
into account for the determination on whether to provide the EC Parameters to
the UE. The V-PCF does not provide EC Parameters to the UE if the UE does not
indicate support for EC Parameters.
The V-PCF can provide the EC Parameters (i.e. URSP of VPLMN) valid for the
edge computing service (e.g. the current area of the UE based on the UE
location information).
6\. In order to enable the communication to perform Edge AS discovery and
further communication with the selected EAS via the appropriate PDU Session,
the UE has to establish the appropriate PDU Session before performing Edge AS
discovery as described in Solution #1 defined in clause 6.1.
When the UE is roaming and has the EC Parameters (i.e. URSP provided by the
VPLMN), the UE first checks whether there is matching between the FQDN in the
DNS Query or the EAS IP address in the application layer service request and
the destination address in the Traffic Descriptor part of the EC Parameters
provisioned to the UE if HPLMN allows VPLMN to provide it to the UE and if
HPLMN indicates EC Parameters provisioned by VPLMN takes precedence over URSP
provisioned by HPLMN.
\- If the matching exists, the UE establishes a new PDU Session based on EC
Parameter matching.
\- Otherwise, the UE uses the URSP which means the UE establishes a new PDU
Session based on URSP matching.
If HPLMN allows VPLMN to provide it to the UE and if there is no precedence
indication, URSP of HPLMN takes precedence over EC Parameters.
7\. The UE can communicate with the DN where the DNS Server or the Edge
Application Server resides.
The AF that sends the AF request including edge computing related information
and the EAS that the traffic is routed to/from the UE can be same or
different.
Updating or removing an existing AF request specified in clause 4.15.6.7 of TS
23.502 [3] is also applied to this solution. The PCF can modify the EC
Parameters based on the edge computing related information updated or deleted
by the AF and provide the modified EC Parameters to the targeted UE. The UE
applies the modified EC Parameters.
The solution can be used for \"Multiple PDU sessions\" connectivity models
described in clause 4.2.
### 6.17.2 Procedures
#### 6.17.2.1 Provisioning EC Parameters the roaming UE related to PDU
Sessions for edge applications
For the procedure to provision EC Parameters to the roaming UE related to PDU
Sessions for edge applications and applying the EC Parameters, the procedure
illustrated in Figure 6.1.2.1-1 for Solution #1 can be applied with the
following differences and by taking the description in clause 6.17.1 into
account:
\- All NFs are located in the visited network in Figure 6.1.2.1-1.
\- URSP or URSP rule corresponds to EC Parameters.
### 6.17.3 Impacts on services, entities and interfaces
AF:
\- Provides a request for service parameter provisioning related to the edge
computing.
V-PCF:
\- Determines the EC Parameters based on the edge computing related
information obtained from the UDR.
\- Provisions the EC Parameters to the roaming UE.
UE when roaming:
\- Indicates its EC Parameters support to the PCF during registration
procedure.
\- Uses the EC Parameters to determine the PDU Session for edge applications.
## 6.18 Solution #18: Mapping the AS IP address to Edge Server IP address
### 6.18.1 Description
This solution addresses the Key Issue #1: Discovery of Edge Application
Server.
There are a lot of DNS mechanisms defined in IETF, if the DNS is running in
the way of \"DNS over X (DoX)\" in which the DNS may run over the HTTPS or TLS
instead of UDP at the port of 53, the 5G network cannot \"change\" the DNS
query and DNS response, and cannot steer the UE to access the local EAS.
We propose a new solution, based on this solution, the network does not change
the DNS query and DNS response, but the 5G network will try to match and map
the destination AS IP address (IPas) to a local EAS IP address (L-IPas) via 3
DNS operations (PTR, SRV and A/AAAA query).It is assumed that the FQDN for an
AS does not change frequently (in fact, a FQDN for an AS does not change at
all in a very long time), but the IP address for the FQDN can be change
frequently because there are a lot of physical servers to support the same
FQDN AS. Keeping the same FQDN of the AS, if an IPas can be matched to a
L-IPas with the same FQDN in the EC DNS Server, the SMF will command the UPF
to Reverse NAT operation, i.e. change the target IPas to L-IPas for the UL
data and change source L-IPas back to the IPas for the DL data, since the
normal NAT operation is changing the source IPue to an external IP address
(EIPue) for the UL and changing the source target EIPue back to IPue.
In this way, we can provide a mechanism to map and steer the accessing to the
AS to access to a local EAS server. To make this solution to work, the EC DNS
Server is configured the mapping between the AS IP address and its FQDN to a
local EAS IP address.
### 6.18.2 Procedures
#### 6.18.2.1 Server Discovery without UL CL
Figure 6.18.2.1-1 Server Discovery without UL CL
1\. UE establishes a PDU Session with the PSA.
2\. The UE performs the DNS query for an AS, and gets the IP address (IPas)
for the AS server. The DNS query and response can be encrypted and cannot be
steered or changed by the 5G network.
3\. The UE sends out an UL TCP packet with 5tuples (Source IPue, Destination
IPas, Source PORTue, Destination PORTas, TCP).
4\. If the PSA identify the UL IP packet is the first packet of an IP flow ,
the PSA buffers this UL IP packet, gets the destination IP address (IPas) for
the UE UL packet, and sends an PTR Query(IPas) to the DNS server and gets a
list of FQDNs(ASx) for the IPas.
NOTE: The DNS Server in Step 4 can be different with the DNS Server in step 2.
5\. The PSA performs the DNS SRV query (ASx, Destination PORTas, TCP) to the
EC DNS Server and gets a list of local EAS (L-AS) FQDN from the EC DNS Server.
6\. The PSA performs the A or AAAA Query (L-AS FQDN) and gets the local EAS IP
address L-IPas.
7\. The PSA reports the mapping between the IPas and L-IPas to the SMF and SMF
commands the PSA to perform the reverse NAT operation.
8\. The PSA performs the R-NAT and changes the (buffered) UL destination IPas
to L-IPas.
9\. The PSA sends the changed UL packet to the EAS.
10\. The EAS responses with a DL packet with the 5 tuples (Source L-IPas,
Destination IPue, Source PORTas, Destination PORTue, TCP).
11\. The PSA performs the R-NAT and change the DL source L- IPas to IPas.
12\. The PSA forwards the DL packet to the UE.
13\. The PSA continues to perform the functions as described in steps 8 to 12.
#### 6.18.2.2 Server Discovery with UL CL
Figure 6.18.2.2-1 Server Discovery with UL CL
1\. Step1 is the same as the steps 1 to 6 of the procedure in clause 6.18.2.1.
2\. The PSA reports the mapping between the IPas and L-IPas.
3\. The SMF decides to select an UL CL to route the UE packet to the EAS
(L-IPas) based on the UE location (e.g. Cell ID) and EAS association
information.
4\. The SMF decides to select a PSA2 to route the UE packet to the EAS(
L-IPas).
5\. The buffered UL IP packet is data forwarded to the UL CL.
6\. The SMF commands the UL CL to route the IP packet with destination IPas to
PSA2.
7\. The SMF commands the PSA2 to perform the R-NAT with destination IPas.
8\. The PSA2 performs the R-NAT and changes the UL destination IPas to L-IPas.
9\. The PSA sends the changed UL packet to the EAS.
10\. The EAS responses with a DL packet with the 5 tuples (Source L-IPas,
Destination IPue, Source PORTas, Destination PORTue, TCP).
11\. The PSA2 performs the R-NAT and changes the DL source L- IPas to IPas.
12\. The DL packet is forwarded to the UL CL then to the UE.
13\. The PSA2 continues to perform the functions as described in steps 8 to
12.
NOTE: The SMF can alternatively command the UL CL to perform the R-NAT in step
7, in such case, the UL CL will execute the NAT in steps 8, 11 and 13, i.e.
changes the UL destination IPas to L-IPas and changes the DL source L- IPas to
IPas.
### 6.18.3 Impacts on services, entities and interfaces
EC DNS Server:
\- the SRV records for EAS and SRV query.
\- the A/AAAA records for EAS and A/AAAA query.
PSA:
\- PTR, SRV, A/AAAA DNS query.
\- R-NAT for UL and DL IP packets.
SMF:
\- Command UPF to performance R-NAT.
UL CL:
\- R-NAT for UL and DL IP packets.
## 6.19 Solution #19: Edge Application Server discovery using an Address
Resolution Function
### 6.19.1 Description
The principle of this solution is shown in Figure 6.19.1-1 below.
Figure 6.19.1-1
An _Address Resolution Function_ (ARF) is deployed, which operates as a DNS
Server/Proxy and receives all DNS queries from the UE via the user plane. The
ARF determines the location of the UE via a control-plane interface with 5GC
and forwards a received DNS query to a DNS server based on the determined UE
location. For example, if the UE is determined to be inside the Local Data
Network-2 (L-DN-2) Service Area, all DNS queries of the UE are forwarded to
the L-DN-2 DNS Server. If the UE is determined to be outside of any L-DN
Service Area, all DNS queries of the UE are forwarded to a Cloud DNS Server.
Each DNS Server in an L-DN can resolve the hostnames for all Edge Application
Servers supported in this L-DN. The Cloud DNS Server can resolve the hostnames
for all Application Servers deployed in the cloud (e.g. on the Internet). For
this purpose, the Cloud DNS Server applies recursive DNS resolution and
communicates with additional DNS servers on the Internet.
Instead of forwarding the received DNS queries to a DNS server, the ARF may be
configured with the FQDNs and IP addresses of the Application Servers deployed
in all or some L-DNs. In this case, the ARF does not forward a received DNS
query to another DNS server, but may respond itself to a DNS query should the
ARF possesses the necessary information.
Although the ARF is shown outside 5GC, it can be deployed as a function inside
5GC.
The details of the solution are specified in the next clause.
### 6.19.2 Procedures
#### 6.19.2.1 General Procedure for ARF-based Solution
The solution is based on the procedure depicted in Figure 6.19.2-1 and enables
the 5G network:
a) to detect when a UE attempts to discover the IP address of an Application
Server and to provide to UE the IP address of the physically closest
Application Server (i.e. of an Application Server located in an local Data
Network (L-DN)); and
b) to insert a local UPF (operating as BP/ULCL and PSA) to the data path after
the IP address of an Application Server located in an L-DN is provided to UE.
Figure 6.19.2-1
0\. The ARF possesses information about the L-DNs deployed in the 5G network.
This information may be received from an EDN Configuration Server (EDN CS), as
the one defined by SA WG6 in TR 23.758 [5], or may be received from the
Operations, Administration and Management (OAM) system, or may be configured
in the ARF via other means.
The information in the ARF about an L-DN includes the L-DN Service Area, the
address of the L-DN DNS Server, the Data Network Access Identifier (DNAI)
associated with the L-DN, etc. The information in the ARF about an L-DN may
also contain the FQDNs and IP addresses of the Application Servers deployed in
this L-DN (so, the ARF can operate also as an L-DN DNS server). This case can
be especially useful when the L-DNs and the ARF are operated by the same
network operator.
1\. The UE performs a normal 5G registration to register with the 5G network.
2\. The UE requests the establishment of a PDU Session, e.g. in order to
access the Internet via the 5G network.
The SMF selects an ARF as the DNS server for this PDU Session and provides to
UE the address of this ARF as the address of the DNS server. The SMF may
decide to select an ARF as a DNS Server for this PDU Session because the UE
subscription data indicates that the UE is allowed to access edge computing
services via this PDU Session. UE is configured with a DNS server as the
selected ARF during PDU session establishment by SMF via PCO. The SMF may not
select an ARF as a DNS server for the PDU Session when, for example, the PDU
Session is used to access IMS services and the IMS functions are deployed
outside of an EDN.
In this step, the SMF selects the UPF/PSA of the PDU Session (called the
central UPF) that provides access to an external Data Network (DN), such as
the Internet. The SMF may receive PCC rules from PCF which indicate that some
traffic of the UE should be routed to an L-DN via a local UPF, not via the
central UPF. However, the SMF does not insert a local UPF to the data path of
the PDU Session because the SMF does not know if the UE will later initiate
traffic that should be routed to an L-DN.
3\. After the SMF knows the IP address assigned to UE for the PDU Session
(e.g. after responding to a DHCPv4 request from the UE, or after receiving a
Neighbor Solicitation including the IPv6 address of the UE as part of a
Duplicate Address Detection procedure), the SMF provides to the selected ARF
the UE\'s IP address and the UE\'s identity (e.g. SUPI or external
identifier). This UE identity enables the ARF to monitor the UE\'s location
(see step 5 below).
4\. The ARF subscribes with SMF for receiving the new IP address of the UE, if
this IP address changes later. This enables the ARF to always have the correct
IP address of the UE.
5\. The ARF initiates the monitoring of UE\'s location either 1) by
subscribing with NEF for location monitoring events and receiving location
reports for this UE or 2) by utilizing the location services (LCS) of the 5GS
and contacting directly the Gateway Mobile Location Centre (GMLC) via the Le
reference point.
From the received location reports and from the L-DN information received in
step 0, the ARF can determine if the UE is located inside an L-DN Service Area
or not. Initially, it is assumed that the UE is not located in an L-DN Service
Area. Therefore, every DNS query received by ARF from the UE is forwarded to
the Cloud DNS Server.
6\. The UE moves to a new location and enters an L-DN Service Area. This is
identified by the ARF e.g. after receiving a location report from NEF.
7\. The ARF determines that the UE is now located inside an L-DN Service Area
and it is configured to forward subsequent DNS queries from the UE to the L-DN
DNS Server (not to the Cloud DNS Server).
8\. An Application Client in the UE wants to start communication with an
Application Server with a hostname (or FQDN) app1.example.com. To resolve the
hostname into an IP address, the UE sends a DNS query including the FQDN. This
DNS query is sent to the ARF via the UPF.
9\. Since the ARF has determined that the UE is located inside an L-DN Service
Area, the ARF (operating as a DNS resolver) forwards the DNS query to the L-DN
DNS server.
If the ARF contains the FQDNs and IP addresses of the Application Servers
deployed in L-DNs, the ARF may resolve locally the hostname/FQDN into an IP
address and can return the IP address to the UE itself, instead of forwarding
the DNS query to the L-DN DNS server.
**CASE A: The L-DN DNS Server provides an IP address**
10\. The L-DN DNS server resolves the FQDN into the IP address \"a.b.c.d\" and
sends a DNS Reply to ARF, which forwards the DNS Reply to UE. The DNS Reply
from the L-DN DNS server indicates that there is an Application Server in the
L-DN identified by the requested FQDN/hostname. The ARF forwards the DNS Reply
back to the UE.
11\. The ARF triggers the 5G core network to insert a local UPF in the PDU
Session data path that provides local access to the L-DN and will route the
traffic between the Application Client in the UE and the Application Server in
the L-DN (the Edge Application Server). For this purpose, the ARF sends a
Policy Authorization Create request to PCF indicating that the uplink traffic
(sent from UE) to the destination IP address \"a.b.c.d\" should be routed via
a certain DNAI (e.g. DNAI-2). The PCF creates an associated PCC rule and sends
a notification to SMF including this PCC rule.
12\. The SMF selects a local UPF that can provide access via DNAI-2 and
configures this UPF to route the uplink traffic (sent from UE) to the
destination IP address \"a.b.c.d\" via DNAI-2. All other traffic is routed by
the local UPF to the central UPF.
NOTE 1: Later, when the ARF determines that the UE exits the L-DN Service
Area, the ARF can send a Policy Authorization Delete request to PCF, which can
delete the associated PCC rule and inform the SMF. This can trigger the SMF to
remove the local UPF from the data path of the PDU Session.
13\. At this point, user-plane communication takes place between the
Application Client in the UE and the edge Application Server in the EDNL-DN
via the local UPF.
NOTE 2: The ARF may send the DNS Reply to UE, not in step 10b, but after step
11c when the 5G core has initiated the insertion of the local UPF in the data
path.
**CASE B: The L-DN DNS Server does not provide an IP address**
10\. The L-DN DNS server cannot resolve the FQDN into an IP address because
there is no Application Server in the L-DN identified by the provided FQDN.
Therefore, the L-DN DNS server responds with a DNS Reply containing no answer
(no IP address).
11\. The ARF forwards the DNS query to a cloud DNS server or resolves the FQDN
by using its own DNS information. As a result, the FQDN is resolved to the IP
address \"e.f.g.h\".
12\. The ARF sends the DNS Reply to UE.
13\. At this point, user-plane communication takes place between the
Application Client in the UE and the cloud Application Server via the central
UPF.
When the PDU Session is released, the SMF sends to the ARF a message to delete
the UE context created in step 3 and, thus, to stop monitoring the location of
this UE (unless the same UE has other active PDU Sessions associated with this
ARF).
#### 6.19.2.2 Procedure for UPF-based Solution
The solution is based on the procedure depicted in Figure 6.19.2-2, with the
following difference comparing with the procedure in clause 6.19.2.1:
a) the ARF is supported in the UPF; and
b) the N4 interface is reused for the interaction between the ARF and the SMF.
Figure 6.19.2.2-1
A function in the EDN, such as the Edge Enabler Server specified in TR 23.578,
provides \"traffic influence\" information for the Edge Application Server in
the EDN. This traffic influence information is provided to NEF and then stored
to UDR, according to existing procedures. The traffic influence information
specifies how selected traffic should be routed by 5GC.
The traffic influence information stored in UDR can be used by the PCF to
create associated PCC rules for the selected traffic.
1\. The UE performs a normal 5G registration to register with the 5G network.
2\. The UE requests the establishment of a PDU Session, e.g. in order to
access the Internet via the 5G network. Whether the UE is outside or inside of
an EDN Service Area is determined by the AMF (based on the location
information received from the access network) and is forwarded to SMF, which
decides not to insert a local UPF in the data path of the PDU Session.
NOTE 1 The AMF should be able to determine when the UE is inside or outside an
EDN area and, for this purpose, the AMF should be configured with information
about the EDNs deployed in the 5G network.
The SMF subscribes with the AMF to be notified when the UE enters or exists an
EDN Service Area.
In addition, the UE receives the address of a DNS Server. When the UE is
outside of an EDN Service Area, the UE receives the address of the Cloud DNS
Server, so all DNS queries of the UE are sent to the Cloud DNS Server.
3\. The UE moves to a new location and enters an EDN Service Area. If the UE
is in CONNECTED state, or as soon as the UE transits to the CONNECTED state,
the AMF receives new location information for the UE and identifies that the
UE has entered an EDN Service Area. This information is propagated to SMF with
a Notify message.
4\. The SMF configures the UPF to forward subsequent DNS queries from the UE
to the EDN DNS Server in the EDN where the UE is located. The SMF should be
configured to know the address of the EDN DNS Server in each EDN. If there is
already local PSA in the data path, the local UPF can be configured to forward
subsequent DNS queries from the UE to the EDN DNS Server.
The SMF also subscribes with UPF to receive a notification (as the one sent
later in step 11a), when the EDN DNS Server provides an answer to a DNS query.
5\. An Application Client in the UE wants to start communication with an
Application Server with a hostname (or FQDN) _app1.example.com_. To resolve
the hostname into an IP address, the UE sends a DNS query including the FQDN.
6\. The UPF detects the DNS query from the UE and (based on the configuration
in step 4) it forwards the DNS query to the EDN DNS Server.
CASE A
10\. The EDN DNS server resolves the FQDN into the IP address \"a.b.c.d\" and
sends a DNS Reply to UPF.
11\. The UPF forwards the DNS Reply to UE (step 11b) but it also notifies the
SMF that the UE attempts to communicate with IP address \"a.b.c.d\" in an EDN
based on the subscription from the SMF.
12\. After receiving the notification in step 11a, the SMF determines if it
has a PCC rule (received from PCF during step 2) with traffic influence
information for the traffic destined to IP address \"a.b.c.d\". One such PCC
rule is illustrated (see PCC Rule-2 in step 2), which indicates that traffic
to IP address \"a.b.c.d\" should be routed via DNAI-2.
If the SMF finds a PCC rule with traffic influence information for the traffic
destined to IP address \"a.b.c.d\", the SMF applies the PCC rules, i.e.
selects a local UPF that can provide access via DNAI-2 and configures this UPF
to route the uplink traffic (sent from UE) to the destination IP address
\"a.b.c.d\" via DNAI-2. All other traffic is routed by the local UPF to the
central UPF.
NOTE 2: Later, when the SMF determines that the UE exits the EDN Service Area,
the SMF may remove the local UPF from the data path of the PDU Session and can
configure the UPF to forward subsequent DNS queries from the UE to a cloud DNS
Server.
13\. At this point, user-plane communication takes place between the
Application Client in the UE and the edge Application Server in the EDN via
the local UPF.
CASE B
10\. The EDN DNS server cannot resolve the FQDN into an IP address because
there is no Application Server in the EDN identified by the provided FQDN.
Therefore, the EDN DNS server responds with a DNS Reply containing no answer
(no IP address).
11\. The UPF forwards the DNS query to a cloud DNS server or resolves the FQDN
by using its own DNS information (cache). As a result, the FQDN is resolved to
the IP address \"e.f.g.h\".
12\. The UPF sends the DNS Reply to UE.
13\. At this point, user-plane communication takes place between the
Application Client in the UE and the cloud Application Server via the central
UPF.
### 6.19.3 Impacts on services, entities and interfaces
This solution has no impact on the UE and no impact on the DNS protocol.
SMF:
For the standalone ARF-based solution, the SMF needs to select an ARF as the
DNS server for a PDU Session and to provide to UE the address of this ARF as
the address of the DNS server. Also, the SMF needs to provide to ARF the UE\'s
identity and the UE\'s IP address, as shown in step 3 of Figure 6.19.2-1.
\- For the UPF-based solution:
\- Configuring the UPF with the address of L-DNS server serving the DNAI
available to UE\'s location and configures the UPF to forward subsequent DNS
queries from the UE to the EDN DNS Server in the EDN where the UE is located.
\- Optionally, subscribing with UPF to receive a notification for answer to a
DNS query.
\- Dynamically inserting ULCL and local PSA and optionally configures the
traffic routing rule to UPF for subsequent DNS queries targeting FQDNs
supported by the DNAI.
UPF:
\- For the standalone ARF-based solution, no impact on the UPF.
\- For the UPF-based solution:
\- Configured with the address of L-DNS server serving the DNAI available to
UE\'s location and the uplink forwarding rules to route subsequent DNS queries
for FQDNs.
\- Forwarding of DNS message based on the configuration.
\- Notifying the SMF with answer to a DNS query.
NOTE: In the standalone ARF-based solution the ARF needs to be configured with
the deployed Local DNs and their service areas.
## 6.20 Solution #20: DNS Inspector based EAS Discovery with UL CL
### 6.20.1 Description
This solution addresses KI#1: Discovery of Edge Application Server.
The solution is based on a \"DNS Inspector\" functionality which assists in
correctly resolving UE\'s DNS requests into IP addresses of EASs. The DNS
Inspector in Figure 6.20.1-1 is depicted as a stand-alone logical
functionality that can be reached via the UL CL/BP UPF. It can be located in
the UL CL/BP UPF, the SMF, the local DN or can be a stand-alone 5GC network
function.
NOTE: This solution can be a complementary option for other solutions after
the UL CL/BP UPF is inserted for the PDU Session.
Figure 6.20.1-1: EAS Discovery with DNS Inspector
### 6.20.2 Procedures
Figure 6.20.2-1: EAS Discovery procedure using DNS Inspector
1\. UE sends DNS Request to the Cloud DNS. The IP address of Cloud DNS can be
either configured in UE as the default DNS Server or retrieved during the PDU
Session Establishment procedure.
2\. The UL CL/BP UPF forwards all DNS requests coming from N3 to the DNS
Inspector (using an UL classifier rule that detects a port 53 destination).
There is no stalling of the packet and no state to be maintained.
3\. The DNS Inspector behaves as follows:
a. It modifies the packet\'s destination IP address (corresponding to a
default DNS server) to that of the L-DNS and stores the original IP address
(Default-DNS-IP) for later processing.
b. It modifies the packet\'s source IP address (corresponding to UE\'s IP
address) to its own (i.e. the DNS Inspector\'s) IP address and stores the
original source IP address (UE-IP) for later processing.
4\. The DNS Inspector then forwards the modified DNS request to the L-DNS and
processes as follows:
\- If the L-DNS can resolve the IP address for the requested FQDN of EAS, step
5 is skipped, it responds to DNS Inspector with the desired IP address of the
local EAS.
\- If the L-DNS cannot resolve the IP address for the requested FQDN of EAS
and the L-DNS is not connected to the C-DNS, step 5 is skipped, it responds to
DNS Inspector with DNS Response without including the IP address of EAS or
indicating that it could not resolve the FQDN.
\- If the L-DNS cannot resolve the IP address for the requested FQDN of EAS
but it is connected to a C-DNS, it communicates with the C-DNS to recursively
resolve the EAS IP address as described in step 5.
5\. L-DNS recursively resolves the DNS request to the DNS server in the cloud
(C-DNS), the C-DNS responds with the cloud EAS IP address to the L-DNS.
6\. L-DNS sends DNS Response to DNS Inspector including the resolved IP
address of local EAS or cloud EAS or empty value.
Option a (DNS Inspector receives a DNS Response including the resolved IP
address):
7\. If the DNS Response from L-DNS containing the resolved IP address, the DNS
inspector replaces the source IP and destination IP address of the DNS
response with the stored C-DNS IP address and UE-IP respectively and forwards
the response to the UL CL/BP UPF.
8\. The UL CL/BP UPF forwards any packets arriving from the DNS Inspector to
the UE.
Option b (DNS Inspector receives a DNS Response including empty value):
7\. If the L-DNS response does not provide the desired IP address, the DNS
inspector forwards the original DNS request (the one that had originally
arrived from the UL CL/BP UPF) back to the UL CL/BP UPF.
8\. The UL CL/BP UPF forwards the original DNS Request from DNS Inspector to
the PSA1 which allocated the IP address for UE via N9.
9\. The C-DNS responds to UE with a DNS Response by including the cloud EAS IP
address.
After the UE receives a DNS Response containing an IP address of an
application server, the subsequent application traffic will automatically be
routed by the UL CL/BP UPF towards an EAS in the local DN or to an application
server in the cloud, depending on the destination IP address.
### 6.20.3 Impacts on services, entities and interfaces
The DNS inspector is a new function whose impact on the SMF or the UPF (in
addition to supporting the DNS Inspector functionality) depends on its
location.
DNS Inspector (new function):
\- Receive and store the original DNS Request from UL CL/BP UPF;
\- Modify the source and destination IP addresses of the UE originated DNS
Request;
\- Modify the source and destination IP addresses of the L-DNS responded DNS
Response if the EAS IP address is included and send the DNS Response to UL
CL/BP UPF;
\- Forward the UE originated DNS Request to UL CL/BP UPF if the EAS IP address
is not included in the DNS Response from L-DNS.
If the DNS Inspector is located in the UPF:
UPF impact:
\- Support DNS Inspector functionality.
If the DNS Inspector is located in the SMF:
SMF impact:
\- Support DNS Inspector functionality.
UL CL/BP UPF impact (configuration):
\- Detect DNS Request coming from N3 and forwards it to DNS Inspector.
\- Receive DNS Request coming from DNS Inspector and forward it to remote PSA.
\- Receive DNS Response coming from DNS Inspector and forward it to UE.
## 6.21 Solution #21: Provisioning URSP configuration to the UE to establish
PDU Sessions for edge applications based on Provisioning Domains
This solution addresses Edge AS discovery by including Provisioning Domain
(PvD) information in the URSP rules, through PvD Descriptors, for PvD-Aware
UEs.
This solution proposes to provision URSP rules in the UE to establish the
appropriate PDU Session before performing Edge AS discovery. The Edge AS
discovery is not covered in this solution. The solution assumes a locally
distributed UPF with IP anchor is used to access the Edge services. The
solution can be used for connectivity model \"multiple PDU sessions\" as
described in clause 4.2.
Provisioning Domains (PvDs) may be configure on UEs by PCF through enhanced
URSP rules. Enhanced URSP rules associated with PvDs can be
added/updated/removed to/from UE upon UE relocation, which may enable UE
applications to select a new PvD, corresponding to a new Data Network (e.g.,
Local Data Network) in some cases, to communicate with the same or a different
service instance on the same or different DN after UE relocation.
According to RFC 7556 [25], a Provisioning Domain (PvD) is a consistent set of
network configuration information used for nodes (e.g., UEs) that may be
attached to multiple networks simultaneously. PvD enable PvD-aware nodes to
use consistently the correct set of configuration elements to serve a specific
service request.
The proposal enables the 5GS to associate PvD to traffic routing rules based
on DNAI, leveraging existing 5GS functionality. Furthermore, the proposal
enables UEs that have not yet established a PDU Session, to avail from PvD
without the need for a Routing Advertisement, which it would have required the
establishment of a PDU Session.
### 6.21.1 Description
In order to enable the communication to perform Edge AS discovery and further
communication with the selected EAS via the appropriate PDU Session, the 5GC
may provision policy configuration consisting of URSP rules, which could be
locally configured on the UE or provisioned by UE Configuration Update
Procedure according to TS 23.502 [3].
In addition to existing URSP parameters, this contribution proposes that the
AF includes information regarding Provisioning Domains that enables the UPF to
select a PSA associated to specific DNAIs, by associating PvD IDs to DNAIs.
At Registration (initial or mobility), the UE may include the UE Policy
Container in order to receive the URSP rules from the 5GC. Furthermore, for
PvD-aware UEs, these rules include PvD descriptors and associated PvD IDs. As
specified in RFC756, Provisioning Domain contain information such as IP
address(es) of the DNS server(s), Name of the HTTP proxy server (if available)
and DNS suffixes associated with the data network.
A PvD-aware UE is a UE that supports application that contains code and/or
application-specific configuration information explicitly aware of the notion
of PvD and/or specific types of PvD elements or properties. Whether or not a
UE is PvD-aware is based on the UE subscription.
Additionally, in order to update the URSP rules due to UE mobility, the
Application Function (AF) may subscribe to UE location information from the
5GC.
### 6.21.2 Procedures
#### 6.21.2.1 Policy configuration provisioning procedure
Figure 6.21.2.1-1 shows the procedure to provision URSP configuration,
including PvD descriptors and associated PvD IDs, to the UE for purposes
related to performing Edge AS Discovery and further communication with the
selected EAS.
In step 0 the application layer, acting as AF, provides the policy
requirements for the edge application traffic (e.g. PvD Descriptors and
corresponding PvD ID with associated list of DNAI(s) and DNN(s), etc.) to the
PCF. The AF may also indicate a Location Criteria where the policy is
applicable. The AF may send the request via NEF (NEF is not shown in the
figure). The AF included the UE address to signal the selection of a relevant
PCF as described in TS 23.502, clause 4.3.6.4. The PCF discovery is not
impacted.
1\. When the UE performs (initial or mobility) Registration to 5GC as in TS
23.502 [3] clause 4.2.2.2.2, the UE may include the UE Policy Container in the
Registration Request as specified in Rel-16.
2\. UE Policy Association Establishment as in TS 23.502 [3] clause 4.16.11.
The AMF selects a PCF based on the UE Address (e.g., SUPI) as described in TS
23.501, clause 6.3.7. The AMF may decide to establish UE Policy Association
with the PCF based on the UE Policy Container received at Registration. In the
UE Policy Association Establishment procedure step 8, the PCF performs the UE
Configuration Update Procedure (TS 23.502 [3] clause 4.2.4.3) to provide URSP
rules to the UE based on policy subscription related information and UE
location information. The PCF determines the URSP rules based on the policy
requested by the AF in step 0. The URSP rules includes PvD Descriptors and
corresponding PvD IDs and other relevant network parameters to be used for
matching Edge application traffic, e.g. traffic from Edge Application clients
installed on the UE to Edge Application Servers. If the AF provided one or
more Location Criteria in Step 0, the PCF includes corresponding Location
Criteria in the RSD part in the URSP rules. The PCF can use a dedicated Policy
Section for the URSP rules that are specific for a particular Edge DN, as
specified in Rel-16. It is assumed that the PCF that provides the UE policy
association services to AMF in Step 2 has access to the information provided
in the AF Request in step 0.
In alternative to steps 0-2, the operator may configure the URSP locally in
the UE.
3\. When the UE needs to send traffic destined to an edge service the UE
triggers the Edge AS discovery by sending a DNS query for an FQDN of the edge
service. The details for this step are out of scope of this solution. After
this, the Application Client sends an application layer service request to an
IP address of the EAS in the Edge Hosting Environment.
A PvD-Aware UE matches applications against PvDs descriptors provided in the
URSP rule and it provides the relevant PvD ID during the Application Level
Service Request.
If the FQDN in the DNS Query, or the EAS IP address in the application layer
service request matches with the destination address or PvD ID, in the Traffic
descriptor part of the URSP rule as provisioned in Step 1, the UE , based on
URSP rule matching (step 3b), establishes a new PDU session (step 3c) in order
to enable User Plane communication (step 3d) with the DN where the DNS Server
or the Edge Application Server resides. It is assumed that the DNS address
configuration provided during the PDU session establishment can be used to
send the DNS Query. If the PvD ID is included in the Application Level Service
Request, and no available PDU Session matches this rule, the UE establishes a
new PDU Session and it includes the PvD ID.
NOTE: Based on the Location Criteria or PvD Descriptor in the URSP rule the
same FQDN in the DNS Query may trigger establishment of PDU Session to either
a local Data Network or to a remote/central Data Network. In both cases, the
authoritative DNS nameserver that holds the DNS record for the FQDN is the
same. In addition, the SMF may use the PvD ID to determine the associated DNAI
and select the relevant PSA.
4\. (optional) the AF, may subscribe to UE location notifications; the
notifications may be used by the AF to trigger AF request as in Step 0 to
update the policy related to edge applications for the UE.
Alternatively to step 4, multiple location specific URSP rules may be used in
Step 0, i.e. the Location Criteria in the RSD part is configured so that
different rules applies per UE location.
Figure 6.21.2.1-1: Policy configuration provisioning procedure
### 6.21.3 Impacts on services, entities and interfaces
The proposed solution is based on Rel-16 procedures but some enhancements may
be needed to make it possible for the AF to configure the edge service FQDNs
on session basis to the URSP rules, such as:
\- Include the FQDN or list of IP addresses of the EAS in the AF Request and
PvD descriptors and PvD IDs associated to relevant DNAIs.
\- The AF provides the Address(es) of UE(s) for which specific PCFs need to be
used to ensure that the relevant PCF is used during the AM Policy Association.
\- The PCF needs to determine the URSP rules based on the information received
by the AF requests; for instance the EAS IP address or FQDN, PvD Descriptors
and corresponding IDs and the Location Criteria.
\- The SMF uses the PvD ID to determine the associated DNAI and relevant PSA.
\- The UE matches applications against PvDs descriptors provided in the URSP
rule and it provides the relevant PvD ID in the PDU Session Establishment
request.
## 6.22 Solution #22: DNS based EAS discovery supporting session breakout
This solution is for Key Issue #1 on DNS based EAS discovery supporting
session breakout.
### 6.22.1 Description
Solution #22 introduces LDNSR, which is a new function that allows
coordination of the EAS Discovery using DNS and the 5GC connectivity. LDNSR
facilitates that it is possible to select with DNS an EAS closer to the edge,
and it allows Dynamic ULCL/BP/Local PSA insertion.
The following principles should be applied for this solution:
\- The LDNSR may get the FQDNs for which it provides a specific handling to
match with the FQDN in the DNS Queries from the UE.
\- The FQDNs are provided to the UDR by the relevant AF through the
TrafficInfluence service operation.
NOTE 1: The sentence above does not mean that the LDNSR gets the FQDN(s)
directly from the UDR. Whether LDNSR gets the FQDN(s) from UDR or from SMF is
still undecided. Getting them from UDR would assume that the LDNSR is fully
trusted and thus fully part of 5GC (this excludes LDNSR operated by a 3rd
party).
\- At PDU session establishment, the SMF selects the LDNSR serving the PDU
session and configure the LDNSR to the UE as the DNS Server for the PDU
Session if used. The SMF may select the LDNSR based on the (DNN, S-NSSAI) of
the PDU Session and on the PSA selected for the PDU Session. This selection
may use NRF discovery or may be based on SMF local configuration. The LDNSR
may register onto the NRF.
\- The LDNSR maintains a PDU session context during the lifetime of the PDU
session and needs to be made aware of the release of the PDU Session.
NOTE 2: How the LDNSR maintains a PDU session context bound to the User PDU
Session will be determined in normative phase. There are two ways being
proposed, one is using the LDNSR subscribing as AF for PDU Session Status from
the SMF, and the other is using new Nldnsr services invoked by the SMF.
\- The LDNSR supports to inform SMF with IP addressing information of EAS
selected by DNS, which may trigger SMF to perform local UPF
insertion/relocation if needed.
NOTE 3: How the LDNSR informs SMF will be determined in normative phase. There
are two ways being proposed, one is using the SMF service, and the other is
using AF influence on traffic routing procedure.
#### 6.22.1.1 Deployment assumption of the solution
Centralized DNS (C-DNS) server is centrally deployed by MNO or 3rd party and
responsible for resolving the UE DNS queries into a suitable Edge Application
Server (EAS) IP address.
Localized DNS (L-DNS) resolvers/servers may be locally deployed within edge
hosting environment, and responsible for resolving the UE DNS queries into a
suitable EAS IP address within the Local DN. The L-DNS resolvers/servers may
or may not have connectivity with C-DNS server depending on the deployment.
The L-DNS resolvers/servers may be deployed by MNO or 3rd parties.
NOTE 1: The C-DNS server and/or L-DNS resolvers/servers may use an anycast
address.
NOTE 2: The C-DNS server or L-DNS resolvers/servers may contact any other DNS
servers for recursive queries, which is out of control of 5GS and not
described in the solution apart that the authoritative DNS server may support
the DNS ECS option. The C-DNS server or L-DNS resolvers/servers can be
different from the authoritative DNS server for the target domain name.
Figure 6.22.1.1-1: Target deployment scenario of the solution
The solution requires a new Functionality, an enhanced DNS Forwarder here
referred to as \"LDNSR\". LDNSR supports Edge AS Discovery using DNS using
knowledge of the 5GC connectivity of the UE.
The LDNSR is a stand-alone 5GC NF with SBA interfaces with SMF and UP external
interfaces with UPF (to exchange DNS traffic with the UE) and with external UP
interfaces with DNS entities on the DN. LDNSR is deployed before an (optional)
NAT.
#### 6.22.1.2 PDU session establishment
When the UE sets up a PDU session a PSA is allocated: this PSA may be a
central PSA.
ULCL/BP/local PSA insertion can be triggered by user traffic (\"dynamic
ULCL/BP/Local PSA insertion\") or by other means before user traffic (\"pre-
established ULCL/BP/Local PSA insertion\"):
\- Pre-established ULCL/BP/Local PSA insertion can be done before the UE sends
out actual DNS queries or traffic to be locally routed, e.g. at PDU Session
establishment or be triggered by AF influence on routing related PCC rules.
SMF sets up filters in ULCL/BP for steering to Local PSA of both the edge
application traffic and the DNS messages towards L-DNS.
When the L-DNS resolvers/servers do not have connectivity with C-DNS servers,
specific mechanisms need to nevertheless support DNS translation for domains
not corresponding to the edge resources (DNS requests not targeting the edge
application domain). Alternative options are further described in clause
6.22.2.
NOTE 1: Encrypted DNS traffic requires that only L3/L4 filters can be used in
ULCL/BP (e.g. DNS Query destination IP address is used) for DNS traffic
detection/ steering. Same filters can be used at all locations if Anycast
addresses are used for L-DNS.
\- Dynamic ULCL/BP/Local PSA insertion is triggered by the DNS messages
related with EAS FQDN resolution. It requires LDNSR involvement and different
modes are possible. LDNSR behaviour is described below.
NOTE 2: The pre-established option can be combined with options using LDNSR if
it is not wanted that all DNS traffic is handled in the L-DNS in deployment.
At PDU Session establishment, the SMF decides the LDNSR serving the UE and
provides it to the UE as the PDU Session DNS Server. The interaction between
SMF and LDNSR is as described in clause 6.22.2.
#### 6.22.1.3 DNS resolution with Pre-established UL CL/BP/L-PSA
5G core functions (PCF, UDR) can be configured by AF traffic influence routing
with the list of DNAIs and IP addresses where the edge application servers are
deployed and the traffic filters corresponding to the service to be steered.
These apply to all services to be steered including DNS messages. The traffic
filters may include the IP address or FQDN of the Local DN deployed service or
L-DNS IP address.
Traffic can be steered based on ULCL/BP filters for all DNS messages (DoH,
DoT, Do53), and traffic to applications (to EAS).
In the configuration phase, traffic filters for each Local DN deployed service
and the DNAI are configured using AF traffic influenced routes. PCF stores the
list of traffic filters for each DNAI. This uses 3GPP Rel-16 mechanisms.
During PDU session establishment, traffic filters are installed in ULCL/BP
using 3GPP Rel-16 mechanisms.
The UE may be configured with local DNS resolver IP address per UE
interface(e.g. per (DNN, S-NSSAI) using PCO, or use application specific DNS
configurations (DoH, VPN), This may be further refined by other solutions.
The pre-established traffic filters are used to steer DNS requests to the
closest Local DN or DNAI for EAS discovery. The L-DNS may add an edns-client-
subnet (ECS) EDNS0 option before using recursive requests to reach an
authoritative DNS server for the target domain.
#### 6.22.1.4 DNS resolution before and after Dynamic UL CL/BP/L-PSA insertion
The LDNSR is configured as DNS server to the UE during PDU session
establishment by SMF via PCO.
LDNSR have visibility of the DNS parameters. If DoT [10], DoH 11] or DNS over
DTLS[x1] is used, LDNSR terminates the DNS security. The LDNSR is operated by
the serving PLMN. LDNSR does not apply if the security (e.g. for DoT) of the
interaction between the UE and its DNS server shall be terminated in a 3rd
party (corporate) domain.
NOTE: UL CL/BP/L-PSA insertion in HR case is not supported in Release 17.
The EAS discovery can happen in two phases:
**\- Phase 1: Before Dynamic UL CL/BP/L-PSA insertion**
**Option 1:** LDNSR receives UL DNS query, inserts an ECS option, which
includes an IP address/prefix obtained from SMF, into the DNS query and sends
to C-DNS. The ECS option is related with the user location and possibly the
requested FQDN.
**Option 2a:** LDNSR receives UL DNS query, and it forwards the UL DNS Query
to a L-DNS. The L-DNS address is related with the user location and possibly
requested FQDN.
**Option 2b:** LDNSR receives UL DNS query determines the L-DNS address but
cannot send traffic to the L-DNS directly. This is further described in clause
6.22.2.
For the above options, SMF maps user location into DNAI/Local PSA for the
Application Traffic. That may reuse existing information defined in Release
16:
\- Information of the topology of UPFs and N6 accesses to the DNs.
\- Application Layer information received via AF influence on routing API.
\- PDU Session information, e.g. any PDU Session Local PSA.
And then, depending on the option, SMF provides to LDNSR either a L-DNS
(options 2a&b) or ECS (option 1) related to the selected DNAI/Local PSA.
For above options, the SMF is informed by the LDNSR when conditions on the DNS
response are met. These conditions are set by the SMF. Upon such information
the SMF triggers UL CL/L-PSA insertion. In order to support different
scenarios, LDNSR may inform SMF based on, EAS IP address in DNS response
and/or FQDN.
As an optimization and if DNS request is sent in clear, SMF may optionally
configure UL CL to local route some subsequent DNS queries based on FQDNs
supported by the Local DN/DNAI. This corresponds to option 3 described as part
of phase 2 below.
**\- Phase 2: After Dynamic UL CL/BP/L-PSA is inserted**
Unless configured to be locally routed (see option 3), LDNSR receives
subsequent DNS Queries.
For queries related to that same FQDN from same UE, LDNSR can follow the
procedure as described in Options 1&2 above (e.g. when previous decisions
should be reconsidered).
For requests related to new FQDNs, the process is as described in Phase 1\.
The information of the already inserted UL CL/BP/ Local PSA can also be
considered in Option 1 & 2 above.
When LDNSR is configured to apply UE redirect for an FQDN, ULCL has also been
configured by SMF to locally divert to Local PSA the DNS Queries to L-DNS
(e.g. on Destination IP address).
**Option 3:**
**Option 3a:** the SMF notifies the UE with the address of local DNS resolver
or L-DNS server through PCO in PDU session modification command. And SMF is
responsible for the DNS address selection based on location, subscription
and/or local policy. The ULCL forwards the DNS query to the local PSA based
solely on inspection of L3/L4 information on packet header. UPF(PSA) routes
the DNS query to the local DNS resolver or L-DNS server. The DNS query can be
processed in local DNS resolver or L-DNS server based on current DNS
mechanism. The local DNS resolver or L-DNS server may do recursive DNS
resolution to other DNS servers.
**Option 3b:** If in Phase 1, the SMF has configured that a FQDN query can be
locally routed on the UL CL, then the subsequent DNS queries for the FQDN will
be locally routed to the Local DNS Resolver. The local DNS resolver receives
and handles the DNS Query that is addressing LDNSR: modifies the packet\'s
destination IP address (corresponding to LDNSR) to that of the L-DNS and
stores the original IP address (LDNSR IP) and the packet\'s source IP address
(corresponding to UE\'s IP address) to its own (i.e. the local DNS
resolver\'s) IP address and stores the original source IP address (UE IP) for
later processing. The local DNS resolver then forwards the modified DNS
request to the L-DNS, if the L-DNS can resolve the IP address, it responds to
the local DNS resolver with the IP address of EAS; otherwise, it does
recursive DNS resolution.
NOTE 1: Option 3b assumes that either ULCL steering is based on L4 information
(i.e. DNS port number) or ULCL has visibility of the DNS traffic (i.e. FQDN in
the DNS Query message) The UPF may be instructed by the SMF to apply different
forwarding of non-ciphered UL DNS traffic based on the target domain of the
DNS request. To support this the UPF would only need to support FQDN domain
based PDR..
NOTE 2: The Local DNS Resolver can be deployed in an operator-controlled
domain.
The above options for the EAS discovery using LDNSR can be described in Figure
6.22.1.4-1.
Figure 6.22.1.4-1: Options for the EAS discovery using LDNSR for PDU session
breakout
### 6.22.2 Procedures
Figure 6.22.2-1: DNS resolving in session breakout scenario
The AF may provide EAS deployment information to UDR via
Nnef_TrafficInfluence, this includes FQDNs, IP addresses/prefixes, Local DNS
resolver/server IP address per DNAI. Multiple AF(s) may provide the
information.
The SMF gets the information from PCF (PCC rule) during PDU session
establishment. During PDU Session Establishment procedure, the address of
C-DNS server or LDNSR is provided by SMF via PCO to UE (LDNSR is provided if
Dynamic UL CL/L-PSA insertion applies). Steps 1 - 6 are processed for each DNS
request if UL CL/BP is not inserted or if UL CL/BP is not configured to
locally route DNS query to local PSA after insertion.
For the \"pre-established\" ULCL/BP/L-PSA scenario, the SMF performs UL
CL/BP/L-PSA selection and insertion based on UE location and sets up uplink
filter rule on UL CL/BP. Steps 1 and 8 are processed for each DNS request if
UL CL/BP is configured to route DNS query to Local PSA. Also Steps 1 and 8 are
processed for each DNS request in the dynamic case for option 3. Step7 m ay
happen any time, and among other, it may update the Local DNS Revolver/L-DNS
in the UE. The procedures in 6.22.1.3 may be used to configure L-DNS address
in UE using PCO during PDU Session Establishment.
At PDU session establishment, the SMF selects the LDNSR based on SMF local
configuration or using NF selection mechanism provided by NRF and informs the
LDNSR for the PDU Session and provides it to the UE as the PDU Session DNS
Server. The LDNSR needs to maintain a PDU session context during the lifetime
of the PDU session that may also be created at this stage.
The SMF may provide to the LDNSR
Option 1: The ECS option (IP address corresponding to DNAI available to UE\'s
location).
Option 2a: The address of L-DNS server serving the DNAI available to UE\'s
location.
Option 2b: An indication to forward DNS query with FQDN(s) corresponding to
DNAI which has no direct connectivity to LDNSR.
Based on the UE location, at PDU session establishment and during UE mobility
the SMF may provide the LDNSR with ECS option and L-DNS server address for the
relevant FQDNs.
The SMF may also provide the IP range(s) that shall trigger the LDNSR to
notify SMF when the IP address (of EAS) in DNS response is within one of these
the IP range(s). LDNSR could also be instructed to notify SMF when certain
FQDN in the DNS response is matched. When receiving the DNS query, the LDNSR
will fetch the forwarding parameters from the SMF (option 1 and 2a) or forward
the DNS query to the SMF (option 2b) in step 3 of the following procedure.
1\. The UE sends a DNS query including the requested FQDN.
2\. If an ULCL/BP exists and the DNS query matches the uplink filter rule on
UL CL/BP to route the DNS query to Local PSA, then step 3 to 6 are skipped.
Otherwise the PSA1 UPF forwards the received DNS query to the LDNSR.
3\. Based on the configuration received from the SMF for the FQDN in the DNS
query, the LDNSR determines the forwarding parameters:
Option 1: The IP address to add as ECS DNS option. This IP address may
correspond to the DNAI/Local PSA selected by the SMF for the UE location and a
target domain.
Option 2a (with direct connectivity between LDNSR and L-DNS): The address of
L-DNS server towards which to propagate a DNS request. This L-DNS address may
correspond to the DNAI associated by the SMF with the UE location and a target
domain.
Option 2b (without direct connectivity between LDNSR and L-DNS): The LDNSR
requests the SMF to forward a DNS query; step 4 is skipped and the procedure
continues with step 5.
The LDSNR may have these forwarding parameters as part of the instructions
received from SMF before or may fetch these forwarding parameters from the SMF
by providing the FQDN to the SMF in this step.
4a-4b: Option 1: The LDNSR adds the IPv4 subnet or IPv4 address or IPv6 prefix
provisioned by SMF in step 3 as ECS option as specified in RFC 7871 and sends
it to C-DNS server. The C-DNS returns the DNS response including EAS IP
address.
4c-4d: Option 2a (with direct connectivity between LDNSR and L-DNS): the LDNSR
sends the DNS query to the L-DNS server provisioned by SMF and get the DNS
response including the EAS IP address.
For both 4a-4b and 4c-4d, after receiving the DNS response, the LDNSR may
inform SMF with IP address of EAS and FQDN if certain criteria set by SMF are
matched, e.g., the IP address of EAS in DNS response is within the IP range(s)
indicated by SMF, or the FQDN is matched. Then, SMF may decide whether to
trigger the insertion of the ULCL/Local PSA.
NOTE 1: The interacts between SMF and LDNSR should be reduced to save the
connectivity resource between them.
5a. The SMF decides DNAI and performs UL CL/L-PSA selection and set up. The
DNAI and UL CL/Local PSA2 are selected based on the information provided by
LDNSR to ensure the selected local PSA and EAS are corresponding to same DNAI.
Option 2b: If the LDNSR requested the SMF to forward the DNS query in step 3,
the SMF sends the DNS query to the local DNS server via a selected UPF3. The
SMF configures UPF3 to forward the DNS response from the local DNS server to
the LDNSR to the SMF. When receiving the DNS response, the SMF forwards it to
the LDNSR. After receiving the DNS response, the LDNSR may notify the SMF with
IP address of EAS as in option 1 and 2a. The SMF may perform insertion/update
of the ULCL/L-PSA2 based on this notification as in option 1 and 2a.
NOTE 2: In this step of Option 2b, the SMF and the UPF3 do not need to
understand the DNS query and DNS response (that may be ciphered e.g. by TLS) .
The L-PSA2 may be different from the UPF3 previously selected to forward the
DNS query.
Optionally, the SMF may configure the L-DNS address into ULCL to be diverted
to L-PSA. In order to redirect subsequent DNS queries directly to the L-DNS,
the LDNSR acts as an iterative DNS server and redirects the DNS Query to the
L-DNS selected for the UE Location by responding with a referral to the UE.
This triggers the UE to send a new DNS query towards the L-DNS.
As an optimization, the SMF may configure uplink forwarding rules on UL CL to
route the traffic and (if the SMF is configured to determine that the DNS
traffic is not encrypted) subsequent DNS queries for FQDNs corresponding to
the DNAI to the Local PSA2 (as option 3a in step 7).
5b. In the case of IPv6 multi-homing, the SMF notifies the UE of the
availability of the new IP prefix @ PSA2 using an IPv6 Router Advertisement
message (RFC 4861 [32]). Optionally, in this RA message, the SMF may notify UE
the new address of DNS server (RFC 8106 [33]) and indicate the UE to contact
with DHCP server to get the DNS-related configuration information (RFC 4861
[32]), which is used to select DNS server for a target FQDN (RFC 6731 [26]).
Also, the SMF sends IPv6 multi-homed routing rule along with the IPv6 prefix
to the UE to influence the selection of the source Prefix for the subsequent
DNS queries(RFC 4191 [29]) as described in TS 23.501 [2] clause 5.8.2.2.2. The
SMF may re-configure the UE for the Source IP prefix @ PSA1.
6\. The LDNSR sends DNS response to UE via PSA1.
In the case of IPv6 multi-homing, if the DNS-related information is configured
on UE, the UE decides the DNS server to use for the subsequent DNS queries.
Otherwise, the UE uses the DNS server address provided in the PCO during PDU
session establishment. Further, the UE selects the source IP prefix based on
the IPv6 multi-homed routing rule provided by SMF.
7\. The SMF may send PDU session modification command with the local DNS
resolver/L-DNS server address via ePCO to the UE. And then the UE updates the
DNS server address accordingly.
8\. Option 3a and \"pre-established\" case: Based on the uplink forwarding
rules, if an ULCL exists and the query matches the uplink filter rule on UL
CL, the UL CL route the DNS query to local PSA2, and then local N6 routing
forwards to Local DN. If no filter is present in ULCL, the DNS request is
routed to PSA-1. AF influenced routes with anycast service address may be used
to provision PCF which is then used during PDU session establishment to setup
traffic filters in ULCL. All application traffic including Do53, DoT and DoH
requests are steered using this mechanism.
The DNS query may be routed to a local DNS resolver/L-DNS which then resolves
the DNS Query or forwards it for resolution. It may derive an ECS option
(using locally configured value or the source address/prefix of the received
DNS request), then send the DNS query to Authoritative DNS server using the
ECS option. Alternatively, the DNS query may be routed to C-DNS via Local N6
or DN. The deployment should ensure the DNS query packet has topologically
correct UE source address when DNS resolver gets it, e.g. via NAT in Local DN.
See Figure 6.22.1.4-1.
The local DNS resolver or C-DNS server sends DNS response to the UE by
retracing the forward path.
Option 3b:
a. The local DNS resolver modifies the packet\'s destination IP address
(corresponding to LDNSR) to that of the L-DNS and stores the original IP
address (LDNSR-IP) and the packet\'s source IP address (corresponding to UE\'s
IP address) to its own (i.e. the local DNS resolver\'s) IP address and stores
the original source IP address (UE-IP) for later processing.
b. The local DNS resolver then forwards the modified DNS request to the L-DNS
and processes as follows:
\- If the L-DNS can resolve the IP address for the requested FQDN of EAS, it
responds to the local DNS resolver with the desired IP address of the local
EAS.
\- If the L-DNS cannot resolve the IP address for the requested FQDN of EAS
but it is connected to a C-DNS, it communicates with the C-DNS to recursively
resolve the EAS IP address.
NOTE 3: Option 1 and 2 can be still applicable in Phase 2 if the requested
FQDN is not configured to be local routed on the UL CL or the DNS traffic is
encrypted.
NOTE 4: Option 3 can be applied when SMF is configured to know that there is
connectivity between local DN and central DN.
When the PDU Session is released, the LDNSR removes the corresponding UE
context for the PDU session (UE IP address).
### 6.22.3 Impacts on services, entities and interfaces
**UE:**
\- In the case of IPv6 multi-homing, the UE receives the DNS-related
configuration information for the PDU Session and selects the DNS server to be
used for DNS queries of a specific FQDN.
**SMF:**
\- Selects LDNSR and configures UE with the address of LDNSR as the DNS server
during PDU session establishment via PCO.
\- the SMF provides the LDNSR with:
\- Option 1: the IP address to add as ECS DNS option.
\- Option 2a + 2b: the address of L-DNS server towards which to propagate a
DNS request.
\- Option 2b (without direct connectivity between LDNSR and L-DNS) the
requirement (with relevant filters) to forward a DNS request to the SMF.
\- Conditions on the DNS response that request LDNSR to notify the SMF.
\- Dynamically (upon LDNSR notifications) may insert ULCL and/or local PSA and
optionally configures the traffic routing rule to ULCL/BP for subsequent DNS
queries targeting FQDNs supported by the DNAI.
\- Option 2b: forwards the DNS query and response between the LDNSR and the
DNS server in the Local DN.
\- In the case of IPv6 multi-homing, the SMF indicates the UE to contact the
DHCP server to get the DNS-related configuration information for the PDU
Session.
**UPF:**
UPF as an ULCL:
\- Optionally, the ULCL is configured with uplink forwarding rules to route
the traffic and DNS queries for FQDNs ranges to the Local PSA2 (assuming DNS
traffic is not ciphered).
**LDNSR:**
\- LDNSR is a standalone Network Function.
\- performs the role of a DNS Resolver and performs interactions with the SMF
via service based interface.
\- the LDNSR is configured by the SMF with information as defined in the SMF
impacts.
\- The handling of DNS message in the LDNSR:
\- Option 1: the LDNSR adds ECS option in DNS query message.
\- Option 2a + 2b: the LDNSR redirects the DNS query to the L-DNS.
\- Option 2b: the LDNSR forwards the DNS query to the SMF and receives the DNS
response from SMF.
\- The LDNSR may be provided with the IP range(s) and indicated by SMF to
notify the IP address of EAS (in DNS response) to SMF if the IP address of EAS
in DNS response matches the IP range(s). The LDNSR may also notify the IP
address and FQDN in the DNS response to SMF if FQDN is matched.
**Local DNS Resolver:**
\- Option 3b: Store the original DNS Request from UE, generate a DNS Request
by modifying the source and destination IP addresses of the UE originated DNS
Request and send the DNS Request to L-DNS Server.
NOTE 1: Whether the IP address modification in DNS Request as proposed in
option3b can be used in deployment or not is subject to local regulations.
NOTE 2: Potential impacts on AF, NEF, UDR and PCF related with potential
induced changes on Nnef_TrafficInfluence will be determined in the normative
phase.
## 6.23 Solution #23: DNS for AS Discovery at Edge Relocation
### 6.23.1 Solution description
The solution addresses Key Issue #2: Edge Relocation. The UE is Edge Computing
Service agnostic.
This solution supports the Distributed Anchor connectivity model and describes
Discovery of Edge Application Server at edge relocation due to PDU Session re-
anchoring. The description includes both, SSC#3 and SSC#2 modes and it is
aligned to and complements:
\- Solution #10 for DNS based Discovery of Edge Application Server for
Distributed Anchor connectivity model.
Like Solution #10, this solution supports encrypted DNS, and both MNO and 3rd
party DNS Resolvers.
With Edge Computing, Applications Servers can be distributed and be deployed
at the edge of the cellular networks. In this scenario, the Edge Application
Server that is topologically closest to the UE should be selected. The Edge
Application server that is closest to the PSA in IP distance is the one
closest to the UE. At Edge Relocation due to PDU Session re-anchoring, there
might be another Edge Application Server that is closets to the new PSA.
This solution assumes Solution #10 to discover with DNS an AS that is closest
to the PSA. Assuming that solution, at PDU Session re-anchoring, a new DNS
query for the Application FQDN can trigger the reselection of an AS that is
closets to the new PSA.
Detailed procedures describe this solution at PDU Session re-anchoring with
SSC#3 and SSC#2.
### 6.23.2 Procedures
#### 6.23.2.1 High Level procedure for SSC#2
At mobility, if another UPF is closer to the UE, the PDU Session can be re-
anchored with that UPF and get a new PSA. This solution allows to discover if
there is an Edge Application server that is now the closest to the new PSA.
If the PDU Session is SSC#2, the former PDU session is removed when the new
PDU Session with a new PSA is established. The IP traffic is sent over the new
PDU session as soon as the new PDU session is established. The trigger of a
new DNS can be multiple, but it can be accelerated by having the OS notifying
the Application clients of the new IP connection (OSs and many Application
clients are designed already today to use this information in the wifi-3GPP
access changes). A new DNS request will also be sent for the Application FQDN
if, for example, the AS is not available through the new PSA, the AS is
designed to send frequent queries or if the TTL of the previous DNS has
expired.
NOTE: The UE DNS Stub Resolver cache is assumed to be removed when the former
PDU session is removed. Else, the new DNS query will be sent out for
resolution depending on the TTL received in previous DNS response for the same
FQDN.
Figure 6.23.2.1-1 below shows an example sequence for this solution that
includes the following steps:
When the UE sets up a PDU session, 5G Core existing mechanisms are used to
provide the UE with the address of the DNS. The address provided depends on
the DNS distribution selected as has been described in Solution #10. The DNS
queries sent over the new PDU session are addressed to that DNS Resolver but
might also be sent to another DNS Resolver depending on the Application
client, the Browser or UE OS configuration.
Figure 6.23.2.1-1 Example flow for DNS resolution
1\. Once the PDU Session has been established, an application may want to
setup a connection to an edge Application Server. Typically, the Application
Server is known by a domain name, and so that needs to be translated into an
IP address. UE sends a DNS Query with the Application FQDN and the response is
tuned to the PSA1 (see solution #10 for further details).
2\. The application traffic starts towards AS#1.
3\. At some point the UE moves, the core network identifies the need to select
a new anchor and triggers the anchor change.
4\. The PDU session is SSC mode2, and so, a new session is re-established to
the same DN and the previous session is discontinued. The existing PDU session
is released before the new one is established. The Detailed procedure for the
multiple PDU Sessions case is described in TS 23.502 [3] clause 4.3.5.1.
5\. The Application could attempt to send traffic to AS#1 over the new PDU
Session. Impact on the session continuity depends among other on the transport
protocol (e.g. QUIC connections are not tied to the IP, but TCPs are) and the
application built in support for that.
6\. At some point the Application triggers a new DNS request for the
Application FQDN. The new DNS request could be sent for example if the
application client supports OS notifications of the new IP connection.
7\. The DNS Query with the Application FQDN is sent over the new PDU Session
and the response is tuned to the PSA2 (see solution #10 for further details).
8\. The application traffic starts towards AS#2.
#### 6.23.2.2 High Level procedure for SSC#3
At mobility, if another UPF is closer to the UE, the PDU Session can be re-
anchored with that UPF and get a new PSA. This solution allows to discover if
there is an Edge Application server that is now the closest to the new PSA.
If the PDU Session is SSC#3, the two PSAs coexist for a period of time and the
traffic is moved to the new PDU session gradually. The UE starts using the IP
address /prefix associated with the new PDU Session for the new traffic flows
(or even proactively for existing traffic flows where possible (if it has the
mechanisms (outside 3GPP scope)). As the first PDU session is still available,
there is the option of having the Application Server instructing the
application client to facilitate the move. The application behaviour can
change at re-anchoring and optimize the move if the situation is known to the
application layer e.g. with SMF notification of PSA change. A new DNS request
will also be sent for the Application FQDN if, the application client supports
OS notifying the Application clients of the new IP connection (OSs and many
Application clients are designed already today to use this information in the
wifi-3GPP access changes), the former AS is not available through the new PSA,
the AS is designed to send frequent queries or if the TTL of the previous DNS
has expired.
NOTE: The UE DNS Stub Resolver cache is assumed to be bound to the former IP
connection, and not considered for the new DNS Queries, which are sent over
the new PDU Session. Else, the new DNS query will be sent out for resolution
depending on the TTL of a previous DNS response for the same FQDN.
Figure 6.23.2.3-1 below shows an example sequence for this solution including
an example for how a stateful application can build service continuity. The
sequence includes the following steps:
The UE has a PDU session established and the application traffic has started
towards an AS#1 that is closets to the PSA, that has been discovered using DNS
mechanisms as described in Solution #10.
Figure 6.23.2.2-1: Example sequence of DNS resolution
1\. At some point, the UE moves, the core network identifies the need to
select a new anchor and triggers the anchor change. The PDU session is SSC
mode3, and so, a new session is established with the selected new anchor, but
the former session will be maintained and coexist with the new one for a
LifeTime \"T\" before it is removed. A timer is started for that purpose. The
detailed procedure for the multiple PDU Sessions case is described in TS
23.502 [3] clause 4.3.5.2.
2\. The Application traffic can continue on the former PDU Session as it is
still available.
3\. At some point the Application triggers a new DNS request for the
Application FQDN. A new DNS request will be sent for example if the
application client supports OS notifications of the new IP connection (OSs and
many Application clients are designed already today to use this information in
the WiFi-3GPP access changes.
4\. The UE sends a DNS Query with the Application FQDN. That query is sent
over the new PDU Session and it is resolved to an AS#2 that is closets to the
new PSA (as described in Solution #10).
5\. A stateless application would start using the new AS#2. Stateful
applications can leverage that the two sessions can coexist with SSC#3 to
build service continuity. In this sequence, the application client informs the
application server of the AS change. The AS#1 can then take control of the
context migration and instruct the application client move to AS#2. As an
alternative, the application client could multicast traffic to AS#1 and AS#2
during the context migration and until AS#2 can take over.
6\. The application traffic is sent towards the AS#2 that is closer to the new
PSA.
7\. The old PDU Session is released by the UE or by the CP at Timer expiry.
### 6.23.3 Impacts on services, entities and interfaces
For non-distributed DNS Deployments, it assumes that the DNS supports RFC
7871. No impact to 3GPP defined network functions or services.
Stateful Applications may design service continuity on the coexistence of two
sessions enabled by SSC#3.
## 6.24 Solution #24: Support of edge relocation, triggering of new DNS query
by the UE
### 6.24.1 Solution description
The solutions address Key Issue #2: Edge relocation.
The solution in this clause is a complement to application controlled server
relocation, where the application layer triggers the UE to move from one
server to another.
The assumption for these solutions is that the UE is using DNS to find an edge
application server. As the UE moves, the PSA may change. At this point the UE
may need to do a new discovery of the application server.
The three connectivity models, distributed anchor, multiple session and
session breakout (using ULCL or BP). From an edge relocation point of view
multiple sessions and distributed anchor are similar.
Distributed anchor and multiple sessions, regardless if SSC mode 2 or 3 is
used (clause 4.3.5.1-3 of TS 23.502 [3]):
\- When the UE moves, the network will trigger the UE to establish a new PDU
session. This can prevent the edge applications in the UE to use the old EAS
information but cannot guarantee to issue a new discovery according to
solution to KI#1, i.e. the UE to do DNS query to find a suitable edge
application server in the new PSA.
NOTE 1: How the edge application in the UE gets aware that a new discovery is
needed and that possible cached DNS results in the UE cannot be used is a UE
internal matter.
Session breakout there are 2 cases, IPv6 multi homing with a BP or ULCL
(clause 4.3.5.7 of TS 23.502 [3]):
\- For BP, as the UE moves, the network sets up a new local PSA. The UE gets a
new IPv6 prefix (and routing rules) and removal of old prefix. This triggers
the UE to remove the old EAS information bound to the old prefix.
NOTE 2: How the edge application in the UE gets aware that a new discovery is
needed and that possible cached DNS results in the UE cannot be used is a UE
internal matter.
\- For ULCL, the UE is not aware that local breakout is used for a specific
application traffic flow. Hence, when the network moves the local PSA, the UE
is not aware that change has been made. There are several ways to indicate to
the UE that there has been a PSA change and the edge applications need to do a
new discovery by means of solution to KI#1.
1) Edge application servers subscribes to PSA change in 5GC, and by
application specific means the edge application server indicates to the edge
application that a new discovery is needed.
2) The SMF indicates according to solution #32 and #34 that a new discovery is
needed via NAS signalling
3) The SMF blocks traffic by filtering in UPF to old server(s).
Application/transport timers will trigger error that indirectly this can
trigger the edge application to do a new discovery when the application issues
another DNS query for EAS.
4) The SMF blocks traffic by filtering in UPF and has a rule to send a ICMP
unreachable code 7 response. This can trigger error to disconnect the socket
connection bound to the old EAS.
NOTE 3: How the edge application in the UE gets aware that a new discovery is
needed and that possible cached DNS results in the UE cannot be used is a UE
internal matter.
NOTE 4: SA WG3 needs to evaluate any potential threats by using ICMP and
whether and how to enforce the recommendation regarding security aspect of
ICMP as described in TS 33.501 [38].
### 6.24.2 Procedures
#### 6.24.2.1 Distributed anchor and multiple sessions, SSC mode 3
Figure 6.24.2.1-1
0\. UE has a PDU session supporting SCC mode 3. UE has discovered and selected
a AS.
1\. Application traffic ongoing with the discovered O-AS.
2\. 5GC triggers move of PSA using SSC mode 3, e.g. due to UE mobility. UE
sets up a new PDU session for this and gets a DNS server address from 5GC.
3\. When the UE\'s application queries DNS request based on the application
logic, UE can issue a discovery of a new AS due to SSC mode 2/3 procedure.
4\. Once new AS address is received, the UE can start using the new AS based
on UE\'s application implementation.
NOTE: Any AS state synchronization is outside the scope of this solution.
#### 6.24.2.2 IPv6 multi homing with a BP
Figure 6.24.2.2-1
0\. UE has a PDU session supporting IPv6 multi homing. The 5GC has installed a
IPv6 BP and UE has a prefix for this. UE has discovered and selected an edge
AS for this prefix (this using any method as per KI#1 solutions using IPv6 BP
and DNS).
1\. Application traffic ongoing with the discovered O-AS.
2\. 5GC triggers move of PSA using IPv6 BP, e.g. due to UE mobility. This by
sending a new prefix and removing old prefix to UE, as part of this the UE
gets a DNS server address from 5GC for the new prefix. UE can drop traffic to
O-AS that is bound to the old prefix.
3\. The application of UE can trigger a discovery of a new AS due to new IPv6
prefix and removal of old prefix based on its implementation, and since new
DNS configuration is received as part of the IPv6 prefix provisioning, the UE
should not use the DNS cache so that the UE can issue a new DNS request to
discover the AS to be used on the new PDU session when the UE\'s application
queries the new DNS.
4\. Once new AS address is received, the UE can start using the new AS.
NOTE: Any AS state synchronization is outside the scope of this solution.
#### 6.24.2.3 Session breakout using ULCL, UE is not aware of change of PSA
for a flow
Figure 6.24.2.3-1: ICMP triggered discovery
The pre-requisite for the flow is that UE has a PDU session, it has discovered
an edge application server (AS) and the network has inserted an ULCL with a
local PSA that will break out the application traffic to the AS.
1\. UE has ongoing application traffic with Old AS via Old PSA and ULCL.
2\. SMF insert a new ULCL and a new local PSA. It also prepares for generating
an ICMP message (happening in step 4) by e.g. one of the following mechanisms:
\- SMF installs a forwarding rule in UPF to forward any IP packet destine to
Old AS to be forwarded to SMF, and SMF generates the ICMP packet to be sent to
the UE via UPF.
\- N4 is updated by e.g. SMF installs a PDR to match any IP packet destined to
Old AS. This is linked to a FAR with an Application Action that indicates that
ICMP shall be sent.
3\. UE sends an IP packet, which is caught in UPF and depending on how step 4
is done the packet may be forwarded to SMF.
4\. SMF or UPF generates an ICMP Destination unreachable message with code 3
(Port Unreachable) or 7 (destination host unknown).
5\. When UE has received the ICMP Destination unreachable message, it is
expected that the UE follows TTL and follows RFC 1122 [15] for hard errors.
6\. UE uses the new AS for the application traffic.
NOTE: SA WG3 needs to evaluate any potential threats by using ICMP and whether
and how to enforce the recommendation regarding security aspect of ICMP as
described in TS 33.501 [38].
### 6.24.3 Impacts on services, entities and interfaces
UE\'s application need make sure that a new discovery is done for edge
application servers based on different triggers and not use any cached result.
Depending on solution for ULCL, SMF to generate ICMP, or UPF to generate ICMP
based on new N4 functionality.
## 6.25 Solution #25: Seamless Change of Edge for Stateful Applications
### 6.25.1 Description
This solution addresses Edge Relocation (Key Issue #2) for stateful
applications. LDN may be relocated due to UE mobility /DNAI change or may be
the application domain initiated. Stateful applications store client
information on the server/persistence layer while stateless applications do
not. Thus, stateless applications are not directly affected by relocation of
UE/LDN since a datagram service can be between UE and any (valid) EAS
instance.
Current application sessions (e.g., HTTPS session) already use context data to
verify the integrity of HTTPS connection and identify the client/user (for
stateful sessions) independent of the IP address. Thus, when a UE moves to a
new location/DNAI, this \"context data\" identifies the user independent of IP
address (e.g., IP1 and IP2 in Figure A below).
Stateful applications must consider the cases where a UE moves (new IP
access/DNAI) results in selecting a new edge (LDN). In this solution, the UE
continues to be served by the old LDN where its data is stored. The rationale
is that not all UE mobility requires edge relocation. It may be that the old
LDN is close enough, or that closer LDNs may be overloaded, or that each LDN
may not host every application. The AF determines the appropriate change in
EAS/LDN based on UE mobility, but also managing congestion, site outage,
mitigation of DDoS attacks, and other administrative policy. To keep the edge
for a stateful application \"sticky\" while also being resilient to
server/site failures, procedures described in 6.25.2.1 are used. Two methods
are described: the first option considers that the EAS is aware and ensures
forwarding to same server instance by redirecting to a specific anycast server
address. In the second option, the application domain is not aware and 5GC
assists by storing \"flow state\" and transferring it on handover to the new
path.
Relocation between one server instance and another in the same LDN is not
visible to 5GC since the application gateway at the edge is responsible for
selecting and forwarding internally in the LDN. EAS shown in the figures below
represents the application gateway at an LDN. The relocation procedures in
6.25.2.2 discuss how to move from one LDN to another.
The application domain (AF) evaluates and may determine that an edge
relocation is necessary based on various factors (latency to UE IP
access/DNAI, load balancing, site outages, etc.). When a new edge is selected,
the state is copied to servers in the new edge. Following client data
mirroring, the old edge requests the UE to redirect to the new edge.
UE mobility that results in the selection of new UPF-PSA inevitably
experiences some jitter. When selecting a new UPF-PSA, the UE can rely on URSP
or configured information to inform 5GC to select appropriate UPF. No
additional DNS queries (and resulting delay) during handover is experienced
since IP anycast destination addresses are valid from new IP access/DNAI.
Application layer optimizations such as DNS prefetch and preload work as
expected.
PDU sessions with SSC mode 3 minimize packet loss as a result of UPF
relocation. Typically, out-of-order packet delivery is resolved with minimum
latency by end-system buffers at UE and by reliable transport protocols (QUIC,
TCP). For highly latency sensitive applications, QUIC and its zero RTT IP
transport re-establishment with a new IP address (new UPF-PSA) minimizes
latency and jitter.
### 6.25.2 Procedures
Procedures for making an edge \"sticky\" for Stateful Applications (clause
6.25.2.1) and Edge Relocation (clause 6.25.2.2) are described below.
#### 6.25.2.1 Sticky Edge for Stateful Applications
This procedure describes how edge for stateful applications can be \"sticky\"
so that the UE is served from the location (EAS/LDN) where its state is
persisted while any relocation procedures are considered. Two methods are
described: the first option considers that the EAS is aware and ensures
forwarding to same server instance by redirecting to a specific anycast server
address. In the second option, the application domain is not aware and 5GC
assists by storing \"flow state\" and transferring it on handover to the new
path.
Application transport (e.g., TCP, QUIC) manages sequencing and reordering
using buffers in the UE and EAS. The application transport congestion
controller handles recovery from lost packets and network congestion E2E to
minimize intermediate buffering latency and this is transparent to 5GC.
Applications that are highly sensitive to latency and packet loss may use
forward error correction (e.g., network coding for QUIC) from E2E.
**Method 1: Application Domain aware procedure:**
The LDN /destination address for the service uses the same IP anycast address
across a wide area. Since IP anycast routing from the new UPF-PSA/N6 network
segments does not have flow state, a new edge/LDN may be selected. To ensure
that the initially selected LDN continues to serve, the EAS in current LDN
sends a URL for local anycast address that primarily selects that instance,
except in cases of failure. This solution is as follows:
\- DNS procedure is used for obtaining IP anycast server address (e.g., as in
clause 6.5). Thus, the application can be identified globally or across a wide
area by a single URL/IP anycast address. N6 routing selects \"closest\" out of
many candidate LDN.
e.g., global URL (app.net) is translated to anycast address (A-IP). A-IP is
routed in N6 to EAS1 (i.e., application gateway in LDN1).
\- Once EAS is selected for stateful applications, the EAS immediately issues
an application-level redirect with a local URL. DNS translation for this local
URL is an IP anycast address that selects the same LDN, except in cases of
failures.
e.g., local URL (ldn1.op1.app.net) that DNS translates to anycast address
(L1-IP). In N6 network, L1-IP always selects LDN1 (EAS1) except in cases of
failures. The local anycast address is used to reselect EAS server if the
initially selected instance fails.
**Method 2: 5GC Assisted procedure:**
If the application domain is not aware of forwarding flow state, 5GC assists
by storing the \"flow state\" and transferring it to the new path during
handover. The \"flow state\" in this case consists of a 3-tuple (destination
IP, port, protocol) and segment route list:
\- The UPF-PSA sends the flow state to the SMF a 3-tuple (destination IP,
port, protocol and segment route) for each flow. Step 1 describes details.
\- During handover, the SMF installs \"flow state\" in new UPF-PSA to
facilitate forwarding to the same server instance. Step 6 describes details.
Other steps are not impacted in this procedure.
Figure 6.25.2.1-1: EAS for Stateful Applications
1\. Server discovery.
UE attaches, establishes PDU session to UPF-PSA and launches application. DNS
query results in an anycast destination address A-IP.
UE sends an application message with the destination address (A-IP). Routers
in N6 network select LDN1 (best/ \"closest\" LDNs for A-IP) and forwards the
packet.
If EHE is not aware of sticky flow state: the UPF-PSA (current) selects the
segment route list to forward to LDN1. The UPF-PSA sends 3-tuple of the flow
(destination IP, port, protocol) and segment route list to the SMF as \"flow
state\".
2\. The application is stateful; (EAS1)/ LDN1 issues a redirect with URL
(ldn1.op1.app.net).
This redirect/URL translation selects (EAS1) LDN1 for all subsequent packets,
except in the case of failure or other explicit redirect from the application
domain.
3\. UE sends DNS query for domain name ldn1.op1.app.net; and gets the answer
with A record with L1-IP. L1-IP is an anycast address that N6 translates to
(EAS1) LDN1 unless there is a site failure (in which case, other LDN in the
set are options).
4\. UE sends application messages with anycast destination address (L1-IP).
Routers in N6 network select (EAS1) LDN1 (preferred address for L1-IP) and
forward the packet. N6 routers forward to LDN1.
5\. UE hands over to new (R)AN and UPF-PSA using procedures in TS 23.502 [3].
The UE now has IP address UE-IP2. The assumption in this solution is that UPF
anchor change is needed to keep the user plane path short as the UE moves.
6\. UE (UE-IP2) continues to send application messages with anycast
destination address (L1-IP). Routers in N6 network do not have flow state, but
since (EAS1) LDN1 is preferred address for anycast destination L1-IP, packets
are forwarded to this destination.
If EHE is not aware of sticky flow state: SMF sends \"flow state\" over N4 to
UPF-PSA (new). UPF-PSA forwards flow from UE matching 3-tuple (destination IP,
port, protocol) with segment route.
The application domain may initiate Edge Relocation sequence at any point as
described in clause 6.25.2.2.
#### 6.25.2.2 Edge Relocation
When a UE moves further from the initially selected LDN, it may be necessary
to relocate the edge - i.e., select a new LDN. The application domain is in
the best position to make this decision since it is responsible for handling
the end-to-end application flows. For making this decision, the application
domain takes service aspects, application domain aspects and connectivity.
The sequence of relocation in figure below is for a set of resources served at
LDN1 (EAS1) and relocated to LDN2 (EAS2). The sequence below illustrates
method 1 (application domain aware).
Figure 6.25.2.2-1: UE Mobility with Edge Relocation
1\. UE attaches, establishes PDU session to PSA1 with address UE-IP1 and
launches the application.
If it is PDU connectivity model 2 (session breakout), SMF inserts ULCL1 and
traffic filters.
UE launches the application, requests DNS resolution of FQDN with anycast
address, and redirect (steps 1 - 4 in clause 6.25.2.1).
2\. UE initiates application message with LDN1 (EAS1) and gets redirected with
local anycast address of LDN1 (EAS1) (defined in clause 6.25.2.1, steps 2-4).
3\. EAS1 notifies AF of UE\'s IP address using application domain signalling
(details are out of scope).
If the AF evaluates that there is a better LDN than the initially selected, AF
may start server relocation procedures.
In this step, AF determines that no server relocation is necessary.
4\. UE handover to new (R)AN, new UPF-PSA using procedures in TS 23.502 [3].
The UE now has IP address UE-IP2.
If it is PDU connectivity model 2 (session breakout), SMF inserts ULCL2 and
traffic filters.
The SMF may remove old UPFs after a timer delay during which time steps 5
onwards may be executed. This allows the minimization of loss of packets in
flight.
5\. The UE continues to send application messages with new IP address (UE-IP2)
and anycast destination address L1-IP (previously selected LDN/EAS).
Application context data (e.g., http context, TLS context) is used to identify
the application session independent of IP address. So when UE IP address is
changed from UE-IP1 to UE-IP2, the application context data in application
messages is used to identify that it is the same application session.
NOTE: In request-response sequences, EAS is immediately aware of the new
source address UE-IP2 address (source address in request message). However,
for communication patterns such as pub-sub, multicast, etc. (e.g., multicast
video delivery), the UE sends a new message (subscribe, multicast status
report change, etc.) to inform and initiate forwarding to the new UE location
(UP-IP2).
6\. LDN1/EAS1 notifies AF of UE\'s new IP address (UE-IP2) using some
application domain signalling (details are out of scope here). AF re-evaluates
LDN and in this case initiates relocation to LDN2 (EAS2.
7\. AF, LDN1/EAS1 and LDN2/EAS2 initiate mechanisms to transfer UE context and
related data (details are out of scope).
8\. When LDN2/EAS2 has mirrored application state, LDN1/EAS1 sends application
layer redirect message with URL of LDN2 (EAS2).
9\. UE requests DNS to translate URL. DNS returns anycast address L2-IP.
10\. The UE sends application messages with source IP address UE-IP2 and
destination address L2-IP. L2-IP is programmed in N6 to route to EAS2 unless
there is a site or other large failure. Thus, N6 routers forward packets to
EAS2.
The solution assumes that application state is replicated between EAS1 and
EAS2 for the duration of the server relocation process (steps 7 - 10).
Applications use various replication mechanisms (strict state machine
replication, replicated data types to eventual consensus) based on application
needs to keep the data synchronized. Details are application dependent and
transparent to 5GC.
If method 2 (5GC assisted) were used in the sequence above, the latest \"flow
state\" that SMF has is transferred during handover to the new path (step 4).
The SMF/UPF would keep \"flow state\" and transferring on handover.
Application layer redirects (steps 1, 8) would result in new \"flow state\"
transfer to SMF but is otherwise transparent.
### 6.25.3 Impacts on services, entities and interfaces
If the application domain (AF, LDN/EAS) is aware of the need to maintain
sticky flow state, it should support redirection of application flows and
mirroring of data. The solution also expects the application to provision
authoritative DNS records corresponding to a global anycast address and a
local anycast address that may be a failure group with priority to route to
selected LDN.
If the application domain is not aware of N6 flow state, 5GC assist option can
be deployed. The UPF-PSA should support segment routes. The SMF should get
\"flow state\" during initial forwarding and transfer to new UPF-PSA to
facilitate forwarding to the same server instance.
## 6.26 Solution #26: Persistent address allocation for mobile UEs that need
MEC access
### 6.26.1 Description
By allocating persistent addresses for mobile UEs that need MEC access, this
solution addresses the following aspect of KI#2: Edge relocation, since the
problem of UE IP address change no longer exists:
\- Whether existing SA WG2 mechanisms (e.g. ULCL/BP insertion/relocation, SSC
mode 2/3, AF influence on traffic routing, and LADN) suffice or whether there
are gaps to be addressed that could introduce improvements in Quality of
Experience compared to existing solutions.
\- How to handle changes of the (local) PSA when applications do not support
the change of client address.
### 6.26.2 Procedures
The 5GC allocates an address pool for persistent IP address allocation. This
pool can be used for scenarios besides MEC. If address allocation is done by
an external DHCP server on the DN, the server should cover multiple local DNs
and maintain an address pool for persistent IP address allocation across the
local DNs.
During a UE\'s PDU registration, the SMF allocates an address from the
persistent address pool if requested by the UE and allowed by the subscription
policy, or if the SMF determines that a persistent address should be allocated
(e.g. for the purpose of MEC access).
Suppose DHCP is used for address allocation and a persistent address is needed
for the UE. If the SMF acts as the DHCP server it allocates an address from
the persistent address pool. If the SMF acts as the DHCP relay for an external
DHCP server, it specifies the persistent address pool in the DHCP messages
relayed to the external DHCP server.
When a UE is anchored to a UPF and the address is not allocated from the local
pool of the UPF, the UPF advertises a host route for the address into the DN.
When a UE is de-anchored from a UPF and the UPF previously advertised a host
route for the UE address into the DN, the UPF withdraws the host route for the
address from the DN.
## 6.27 Solution #27: Reducing packet loss during EAS relocation
### 6.27.1 Solution description
#### 6.27.1.1 General
This solution addresses the Key Issue #2: Edge relocation. In this solution
both the AF and SMF can trigger the EAS relocation with/without PDU Session
re-anchoring.
This solution applies to both Session Breakout and Multiple PDU Session
scenarios:
\- For Session Breakout model, the AF can trigger the EAS relocation due to
internal information such as congestion condition and it is assumed that the
local PSA is not changed. The AF can also trigger the EAS relocation during
the UE mobility when the SMF determines to relocate the local PSA and notifies
the AF of the UP change. In this case the SMF notifies the AF in early
notification about the target DNAI list which are available in the current
location and supported by the SMF, so the AF may select a target DNAI to
perform EAS relocation. In this case the UE IP address may be changed (multi-
homing) or keep unchanged (ULCL).
\- For Multiple PDU Session model, the AF or SMF can also trigger the PDU
Session re-anchoring for PDU Session with SSC mode 2 and SSC mode 3. In this
case the UE IP address is changed.
When the EAS is relocated, the EAS IP address may remain the same or may need
to be changed.
NOTE 1: The EAS address can be e.g. an Anycast IP address in which case the
destination IP address remains the same from the UE point of view. When IP
Anycast address is used, during UE mobility, the session context migration
between source and target EAS can be handled by EC platform.
Follows are the options to handle EAS IP address change:
**Option 1a** :Application layer mechanism is used to notify the UE with the
new EAS IP address, for example via HTTP redirection, this solution has been
supported by Rel-15/16 5GS specification, while the details of the mechanism
are out scope of SA WG2. In the meantime the selected target DNAI, the new EAS
IP address (if the EAS address is changed) and the N6 traffic routing
information is provided in the Nnef_TrafficInfluence_AppRelocationInfo by AF
to SMF so the SMF can update the traffic steering rules in the ULCL/BP, select
a new local PSA and send N6 traffic routing information in the local PSA. The
EAS relocation is triggered after the SMF sends late notification to the AF
and the old EAS receives last packet using the old EAS IP address.
**Option 1b** : When the SMF receives the new EAS IP address, the SMF sends
the new EAS IP address to UE in the ePCO via NAS message (i.e. PDU Session
Modification Command). This option is further described in solution #28 and
#31. To enable this option, the following additional information needs to be
included in Nnef_TrafficInfluence_AppRelocationInfo from AF to NEF in the
response message of Early Notification:
\- Support of UE awareness of EAS IP address change.
**Option 1c** : When the SMF receives a new EAS IP address or detects the DNS
Re-resolution is needed, the SMF sends a NAS message (i.e. PDU Session
Modification Command) to the UE to trigger DNS Re-resolution for some IP
segment, subnet info, a list of FQDNs or DNS suffixes. This option is further
described insolution#32. To enable this option, the following additional
information needs to be included in Nnef_TrafficInfluence_AppRelocationInfo
from AF to NEF in the response message of Early Notification:
\- Support of UE awareness of EAS IP address change.
**Option 1d** : When the SMF receives the new EAS IP address, it configures
the local PSA UPF to enforce the EAS IP address replacement. To enable this
option, the AF needs to send the Anchor/Source EAS IP address and Serving
Local EAS IP address per DNAI to SMF via AF Influence procedure. This option
is further described in solution #29 and #30. To enable this option, the
following additional information needs to be included in
Nnef_TrafficInfluence_AppRelocationInfo from AF to NEF in the response message
of Early Notification:
\- Support of EAS IP address Replacement.
In order to prevent packet loss in the uplink, following options can be
applied:
**Option 2a** : Old and new EAS handles its own IP packets respectively.
Scenario 1: EAS IP address is changed:
\- The AF influences the SMF to request the new ULCL/BP to forward uplink data
with old EAS IP address or old IPv6 prefix towards the old ULCL/BP and then to
old EAS, and forward the uplink data with new EAS IP address or new IPv6
prefix towards the new PSA. The new PSA buffers the uplink data.
Scenario 2: EAS IP address remains the same:
\- The AF influences the SMF to request the new ULCL/BP to forward uplink data
with the EAS IP address towards the new PSA. The new PSA buffers the uplink
data.
**Option 2b** : New EAS handles IP packet destine for the old EAS:
NOTE 2: When EAS IP address is changed how to route the IP packets with old
EAS IP address to the new EAS is out of scope of 3GPP.
\- This is option is further described in solution #38: uplink data is
forwarded from old local PSA to new local PSA. The ULCL sends End Marker to
target local PSA to ensure in-order UL handling at target local PSA. This
requires the new EAS to process the packets destined to old EAS. To enable
this option, the following additional information needs to be included in
Nnef_TrafficInfluence_AppRelocationInfo from AF to NEF in the response message
of Early Notification:
\- Support of processing IP packets across different EASs.
After the EAS relocation is completed, via Late Notification response, the AF
notifies the SMF and the SMF requests the new PSA to forward all uplink data
to new EAS.
### 6.27.2 Procedures
The procedure is based on the procedure in TS 23.502 [3], clause 4.3.5.7, with
the differences as described below.
Figure 6.27.2-1 Call flow to reducing the packet loss during EAS relocation
1\. The SMF sends early notification to AF. This message may sent via NEF. The
SMF may include the target DNAI list towards the AF.
2\. The AF may determine the target DNAI from the target DNAI list, prepares
the EAS relocation and determines the new EAS IP address. The Old EAS continue
to serve the UE.
3\. The AF sends Nnef_TrafficInfluence_AppRelocationInfo to SMF. This message
may be sent via NEF. This message may include the selected target DNAI and the
new EAS IP address (if the EAS address is changed) in the N6 traffic routing
information towards the new EAS. This message may also include an indication
to indicate the support of seamless edge application relocation and the need
to buffer the uplink data in the local PSA.
When EAS IP address is changed and EAS IP address replacement solution is
used, the AF sends the source EAS IP address and target EAS IP address to the
SMF, and SMF further provides the source and target EAS IP address to L-PSA2
for EAS IP address replacement. If EAS IP address replacement solution is
used, step 10a and 10b can be skipped.
For Multiple PDU Session model, the SMF may initiate PDU Session re-anchoring
procedure for SSC mode 2 and SSC mode 3. The following step 4 to step 8 are
skipped.
For Session Breakout model, the following step 4 to step 8 are performed.
4\. Based on the target DNAI if the SMF determines the L-PSA needs to be
relocated the SMF selects a local PSA2 and establishes an N4 session. The SMF
sends new N6 traffic routing information to the local PSA2. Based on the
indication in step 3, the SMF also indicates local PSA2 to buffer the uplink
data.
5\. The SMF sends N4 Session Modification to old ULCL/BP 1 to allocate
resource for forwarding tunnel.
6\. Based on the target DNAI if the SMF determines the ULCL/BP needs to be
relocated the SMF selects a new ULCL/BP 2 and establishes an N4 session. The
SMF establishes data forwarding tunnel from new ULCL/BP 2 to old ULCL/BP 1.
The SMF sends the new traffic steering rules to the new ULCL/BP 2. Depending
on the information in Step 3, the uplink data using the old EAS IP address (in
the case of ULCL) or old UE IPv6 prefix (in the case of BP) can be steered to
the ULCL/BP 1 via forwarding tunnel. The uplink data with new EAS IP address
(in the case of ULCL) or new UE IPv6 prefix (in the case of BP) is forwarded
to PSA2.
In the case of BP, the SMF may send a new UE IPv6 prefix and the new routing
rules to the UE as described in TS 23.502 [3] clause 4.3.5.7.
7\. The SMF sends N2 PDU session modification to RAN to so uplink packets can
be sent to new ULCL/BP 2.
8\. The UE sends uplink data to RAN node and then towards the new ULCL/BP 2.
The UE still use the old EAS IP address or old UE IPv6 prefix so all uplink
data is routed to old ULCL/BP 1 via the forwarding tunnel. The old ULCL/BP 1
forwards the uplink data to PSA1 and then forwards to old EAS.
9\. The SMF sends late notification to the AF to indicate the successful user
plane relocation. This message may be sent via NEF.
For option 1a and 2a, step 10 is performed. Step 11-13 are skipped.
10a. [Optional], The old EAS may send new EAS IP address to the UE via
application mechanism, for example the HTTP redirection.
10b. [Optional], The UE may use the old EAS IP address to send the last packet
notification to the old EAS. The UE then can start to use the new EAS IP
address as target IP address.
10c. After the AF received the late notification in step 9 or after the old
EAS received the packet notification in step 10b (if this optional step is
used), the application layer performs the EAS relocation. The UE context is
relocated from the old EAS to new EAS. The old EAS stops to serve the UE.
10d. If the EAS address was notified to the UE in Step 10a, the UE start to
use new EAS IP or new UE IPv6 prefix and sends uplink data with new EAS IP
address or new UE IPv6 prefix towards the RAN and then forward to new ULCL/BP
2 and PSA2.
10e. The PSA2 buffers the uplink data as indicated by SMF in step 4.
For option 1b or option 1c, step 11 is performed. Step 12-13 are skipped.
11a. The SMF sends a NAS message to the UE and includes the new EAS IP address
or a DNS re-solution indication. The UE may start to use the new EAS IP
address or trigger DNS query procedure to retrieve new EAS IP address.
11b. The UE starts to use new EAS IP and sends uplink data with the new EAS IP
address towards the RAN which is then forwarded to the new ULCL/BP 2 and PSA2.
11c. The PSA2 buffers the uplink data as indicated by SMF in step 4.
For option 1d, step 12 is performed.
12a. After the AF received the late notification in step 9, the application
layer performs the EAS relocation
12b. The UE sends uplink data with old EAS IP address and PSA2 replaces it
with the new EAS IP address. The new EAS sends downlink data with the new EAS
IP address and PSA2 replaces it with the old EAS IP address.
For Option 2b, step 13 is performed.
13a. The PSA1 forwards the uplink data with old EAS IP address towards the
PSA2.
13b. The PSA2 buffers the uplink data with the old EAS IP address and uplink
data with new EAS IP address.
13c. The ULCL2 may send End marker towards PSA1 via the ULCL1. The PSA1
forwards the End marker towards the PSA2 to ensure in-order UL transferring
13d. The ULCL2 may send Flow End marker towards PSA1 via the ULCL1. The PSA1
forwards the Flow End marker towards the old EAS to trigger EAS relocation. In
this case the step 10a is performed after step 10e.
14\. After successful relocation the AF sends
Nnef_TrafficInfluence_AppRelocationInfo to SMF to indicate the successful
application relocation. This message may be sent via NEF.
15\. The SMF sends N4 Session Modification to local PSA2 to start the uplink
data forwarding.
16\. The local PSA2 forwards the buffered uplink data towards the new EAS.
17\. The new uplink data are transferred via new ULCL/BP 2 and local PSA2 to
new EAS.
18\. The new downlink data are transferred via new ULCL/BP 2 and local PSA2 to
the RAN and UE.
19\. The SMF release the old ULCL/BP 1.
20\. The SMF release the old local PSA1.
### 6.7.3 Impacts on services, entities and interfaces
UE:
\- (Options 1b and 1c) handle information provided via NAS signalling to
perform application layer operations (i.e. use the new EAS IP address in
option 1b and trigger DNS re-resolution in option 1c).
AF:
\- For early notification the AF provides the selected target DNAI, new EAS IP
address to the SMF. The AF provides an indication to indicate the support of
seamless edge application relocation and the need to buffer the uplink data in
the local PSA.
SMF:
\- (Options 1a, 2a, and 2b) Request the local PSA to buffer the uplink data
before application relocation.
\- (Options 1a, 2a, and 2b) Request the local PSA to forward the buffered
uplink data to new EAS after application relocation complete.
\- For early notification the SMF sends the target DNAI list to the AF so the
AF can select one target DNAI.
\- (Options 1b and 1c) Provide the UE with the new EAS IP address or a DNS re-
resolution indication.
\- (Option 1d) Configure the local PSA UPF to enforce the EAS IP address
replacement.
\- (Options 1a, 1b, 1c and 2a) Support the establishment of N9 forwarding
tunnel between the old BP and the new BP.
Local PSA:
\- (Options 1a, 2a, and 2b) Support the uplink data buffering.
\- (Options 1d) Support EAS IP address replacement.
UPF acting as a BP:
\- (Options 1a, 1b, 1c and 2a) Support the N9 forwarding tunnel between the
old BP and the new BP.
## 6.28 Solution #28: Supporting application server change based on AF
notification
### 6.28.1 Description
The solution addresses Key Issue #2: Edge relocation.
The solution is also for Key Issue #1, which addresses Edge AS discovery
including aspects related to:
\- Whether and if yes how to support UE rediscovery of Edge Application Server
when the previous Edge Application Server becomes non-optimal or unavailable
to the UE?
The solution is to support the application change independent of UE mobility.
During the PDU session establishment, the SMF subscribes to the AF (optionally
via an NEF) based on UE subscription and operator\'s policy, in order to get
the notification on application change, especially, the application server\'s
IP address change. According to this subscription, the AF sends a notification
to the SMF (optionally via an NEF) after the application server successfully
is changed. This notification triggers the SMF to determine the user plane
reconfiguration.
In addition, the changed IP address of application server may be send to the
SMF with the notification. If the SMF supports to send the changed IP address
which is acquired with AF notification to the UE via NAS PCO in the case that
application layer solutions are not applicable or limited in any deployment
environments, this solution also supports the discovery of application server
by getting quickly the changed IP address and provides the improvements in
Quality of Experience.
### 6.28.2 Procedures
The following procedure addresses SMF subscription and AF notification to
support the change of application server serving the UE.
Figure 6.28.2-1: AF notification on the change of application server serving
the UE
1\. The UE initially registers to the network.
2\. The UE performs a PDU session establishment procedures. Optionally, the UE
may inform the network of their capability to support NAS PCO solution.
3\. The UE has an established PDU Session.
4\. The AF request with traffic routing information is sent to the Core
network per application. The information of the capability for application
relocation exposure to the core network may be included.
5\. The PCF generates PCC rules based on the AF request and provides the PCC
rules to the SMF. The PCC rules may include the information of the capability
for application relocation exposure to the core network.
6\. The SMF may decide to subscribe the event on the application server change
to the AF, based on UE subscription, operator\'s policy and/or the information
for Application relocation exposure capability received in step 5. It is
subscribed either directly to the AF or via an NEF.
NOTE 1: It is assumed to find out AF based on the pre-configuration or the
information received through step 4 and step 5, in the case of multiple AFs.
7\. Regardless of UE mobility, the application server serving the UE is
changed. Especially, the IP address is changed.
8\. Depending on SMF subscription in step 3, the AF may notify the application
change and optionally the changed IP address. It is notified either directly
to the SMF or via an NEF.
9\. The SMF determines whether the user plane reconfiguration is needed. If
needed, the SMF triggers the corresponding procedures for the user plane
reconfiguration.
10\. If the SMF supports to send the changed IP address which is acquired with
AF notification to the UE via NAS PCO, the SMF may send it to the UE. The UE
NAS layer forwards it to the upper application layer, and the UE application
layer can immediately recognize the changed AS IP address and use it.
NOTE 2: It is assumed that the UE internally provides the interface to provide
new EAS\'s information from NAS layer to the application.
NOTE 3: It is assumed the new EAS address provided by NAS layer is same as the
one provided by application layer (if provided).
11\. If the SMF triggers the UPF addition, relocation, or removal, the user
plane reconfiguration is performed.
The following procedure addresses the improvements on \"Notification of user
plane management event\" specified in TS 23.502 [3], in order to use above AF
notification together.
Figure 6.28.2-2: Improvements of Release 16 \"Notification of user plane
management event\"
It assumes that the SMF has subscribed to the AF as described in step 3 of
Figure 6.28.2-1.
In addition to those steps as explained in clause 4.3.6.3 of TS 23.502 [3],
the below steps are applicable.
Step 2d/e/f: AF may provide the changed AS IP address with the response on
successful application relocation.
Step 4d/e/f: AF may provide the changed AS IP address with the response on
successful application relocation.
After getting the changed AS IP address from AF, the SMF may send it to the UE
via NAS PCO. The UE NAS layer forwards it to the upper application layer, and
the UE application layer can immediately recognize the changed AS IP address
and use it.
### 6.28.3 Impacts on services, entities and interfaces
SMF:
\- subscribes the event on application server change to the AF (directly or
via NEF).
\- sends the changed AS IP address received from AF to the UE via NAS PCO.
AF:
\- provides the changed AS IP address after the successful application
relocation based on SMF subscription (directly or via NEF).
UE:
\- NAS layer receives and forwards AS IP address sent by the network to the
upper layer.
\- informs the network of their capability to support NAS PCO solution.
\- (depending on UE capability) Impact on UE kernel, operation system kernel
(e.g. Android kernel) to support to identify and exchange the AS IP address.
\- (depending on UE implementation) Impact on HTTP adaption layer when it is
applied.
\- (depending on UE implementation) Impact on Edge Enabler Client, when it is
applied.
\- Application client recognizes the new EAS IP address provided by the lower
layer and switches to the new EAS.
## 6.29 Solution #29: CN-based edge relocation
### 6.29.1 General
The solution addresses Key Issue #2: Edge Relocation. The UE is unaware of the
edge relocation.
This solution supports the Session Breakout model at edge application server
relocation after the UE accessing the edge application to support the service
continuity. The enhancement for packet loss is not considered in this
solution.
The edge application relocation may happen in the following scenarios:
1) the application server change is triggered by the user plane management
notification with PSA relocation/DNAI change e.g. due to UE mobility;
2) the application server change initiated from the application side e.g. due
to the serving Edge Application Server becoming congested or being in outage
condition. The application can decide whether the edge application server
relocation is transparent or not to the UE, without impacting the user
experience for the application.
The main CN behaviour, after getting information for the edge application
server relocation at edge relocation, is to perform application server IP
address replacement at edge application server relocation:
\- For UL traffic, the destination IP address is replaced with the target edge
application server IP address within core network;
\- For DL traffic, the source IP address is replaced back with the source edge
application server IP address within core network.
### 6.29.2 Procedures
#### 6.29.2.1 Procedure for edge relocation triggered by CN
Figure 6.29.2.1-1: Procedure for edge relocation triggered by CN
The AF can get the information of whether server changes and the target
application server based on the user plane management notification.
1\. The AF request with traffic routing information is sent to the Core
network per application, it may include the domain name of the application,
the application relocation possibility indication and the \'AF acknowledgement
to be expected\' indication.
2\. The PCF generates PCC rules based on the AF request and provides the PCC
rules to the SMF. The PCC rules include the domain name of the application.
This step may happen during establishment of the PDU Session or during
modification of the PDU Session.
3\. The SMF determines to relocate the ULCL/L-PSA. The ULCL/L-PSA relocation
may be triggered by UE mobility.
4\. Based on the AF subscription, the SMF sends an early notification to the
AF, including the corresponding target DNAI(s).
5\. Application server relocation is triggered by the notification received in
step 4 based on the target DNAI(s). The AF can get the information of target
application server.
6\. The AF sends a positive response to the early notification to the SMF. In
the positive response, the AF includes the indication to indicate the
application server relocation is transparent to the UE, and the information of
target application server (the information of target application server may be
information on the target application server for the application (e.g. the IP
address of the target application server and the FQDN of the target
application server)).
7\. The SMF configures the new ULCL and new L-PSA.
8\. The SMF makes decision, based on the information on the information
received in step 6, to steer the traffic of the application traffic to and
from the target application server.
9\. Based on the decision in step 8, the SMF updates the ULCL2 or BP UPF2,
which can be standalone or co-located with L-PSA2, with the forwarding rule
for steering the traffic to and from the target application server. On
receiving the packets for the application, the ULCL UPF executes the edge
application server IP address replacement based on the traffic forwarding rule
as described in clause 6.29.2.4.
#### 6.29.2.2 Procedure for edge relocation triggered by application
Figure 6.29.2.2-1: Procedure for edge relocation triggered by application
The AF can get the information of whether server changes and the target
application server for the edge relocation triggered by application.
1a. PDU session is established with the PSA UPF and breakout with the
ULCL1/L-PSA1.
1b. The AF request with traffic routing information is sent to the Core
network per application.
1c. Edge application server relocation is triggered by the application due to
the serving Edge Application Server becoming congested or being in outage
condition.
2\. The AF updates the AF request for the edge application relocation. It
includes the indication to indicate the application server relocation is
transparent to the UE, the information of target application server (the
information of target application server may be information on the target
application server for the application (e.g. the IP address of the target
application server and the FQDN of the target application server)).
3\. The PCF updates the PCC rule with the information received in step 2 to
the SMF. If the ULCL/PSA relocation is not triggered by the edge application
relocation, step 4 to step 7 are skipped.
4\. The SMF determines to relocate the ULCL/L-PSA based on the edge
application relocation.
5\. Based on the AF subscription, the SMF sends an early notification to the
AF, including the corresponding target DNAI(s).
6\. The AF sends a positive response to the early notification to the SMF.
7\. The SMF configures the new ULCL and new L-PSA.
8-9. The same as step 8 to step 9 in clause 6.29.2.1.
#### 6.29.2.3 Procedure for edge relocation triggered by application with
application relocation exposure
Figure 6.29.2.3-1: Procedure for edge relocation triggered by application with
application relocation exposure
The AF can get the information of whether server changes and the target
application server for the edge relocation triggered by application.
1\. PDU session is established with the PSA UPF and breakout with the
ULCL1/L-PSA1.
2\. The AF request with traffic routing information is sent to the Core
network per application. The information of the capability for application
relocation exposure to the core network is included.
3\. The PCF generates PCC rules based on the AF request and provides the PCC
rules to the SMF. The PCC rules include the information of the capability for
application relocation exposure to the core network.
4\. The SMF subscribes to the AF for the Application relocation exposure event
based on the information for Application relocation exposure capability
received in step 3.
5\. Edge application server relocation is triggered by the application due to
the serving Edge Application Server becoming congested or being in outage
condition.
6\. The AF notifies the event for the edge application relocation to the SMF.
It includes the indication to indicate the application server relocation is
transparent to the UE, the information of target application server (the
information of target application server may be information on the target
application server for the application (e.g. the IP address of the target
application server and the FQDN of the target application server)). If the
ULCL/PSA relocation is not triggered by the edge application relocation, step
7 to step 10 are skipped.
7\. The SMF determines to relocate the ULCL/L-PSA based on the edge
application relocation.
8\. Based on the AF subscription, the SMF sends an early notification to the
AF, including the corresponding target DNAI(s).
9\. The AF sends a positive response to the early notification to the SMF.
10\. The SMF configures the new ULCL and new L-PSA.
11-12. The same as step 8 to step 9 in clause 6.29.2.1.
#### 6.29.2.4 Target AS IP address replacement procedures
Figure 6.29.2.4-1: Target AS IP address replacement
1\. The SMF makes the decision to steer the traffic of the application traffic
to and from the target application server. The decision is made based on the
information for the edge application server relocation at edge relocation.
1a. The edge application server relocation can be triggered by the user plane
management notification as described clause 6.29.2.1. In this case, the
information for the edge application server relocation is received via the
notification response, which is Nsmf_EventExposure_AppRelocationInfo(notifId,
ackResult(afStatus, trafficRoute), supi, Target AS information).
1b. The edge application server relocation can be initiated from the
application side as described clause 6.29.2.2. In this case, the information
for the edge application server relocation is received via the AF update
message, which is Nnef_TrafficInfluence_Update request (afTransId, Target AS
information).
1c. If the application relocation exposure is provided by the AF and the SMF
can get the notification from the AF for the edge application server
relocation as described clause 6.29.2.3. In this case, the information for the
edge application server relocation is received via the AF notification, which
is Naf_EventExposure_AppRelocationInfo_Notify(Target AS information).
2\. Based on the information on the information received in step 1, the SMF
configures the traffic forwarding rule to the ULCL UPF to steer the traffic of
the application traffic to and from the target application server. If the ULCL
UPF relocation happens, the related traffic forwarding rule(s) is(are)
configured on the new ULCL UPF.
3\. On receiving the packets, the ULCL UPF executes the edge application
server IP address replacement based on the traffic forwarding rule configured
in step 2:
\- For UL traffic, the destination IP address is replaced with the target
application server IP address at the local UPF;
\- For DL traffic, the source IP address is replaced back with the source
application server IP address at the local UPF.
### 6.29.3 Impacts on services, entities and interfaces
SMF:
\- Decides and configures the rule for the steering of the traffic of the
application traffic to and from the target application server based on the
edge application server relocation information received from AF.
\- For 6.29.2.3, additionally, subscribes to the AF for the Application
relocation exposure event.
AF:
\- Provides the edge application server relocation information to CN, the
information includes the indication to indicate the application server
relocation is transparent to the UE and the information of target application
server.
\- For 6.29.2.3, additionally, exposes the edge relocation capability to the
CN and notifies the edge application server relocation event to the SMF.
UPF:
\- Enforces the edge application server IP address replacement based on the
traffic forwarding rule for the steering of the traffic of the application
traffic to and from the target application server.
## 6.30 Solution #30: UE Agnostic EAS IP address replacement for traffic
subject to edge computing
### 6.30.1 Description
This solution addresses KI#2: Edge relocation, following aspect is covered:
\- How to handle change of the serving EAS (without UE mobility) to support
seamless change, e.g. preventing or reducing packet loss.
This solution assumes:
1) The EC application can handle the runtime session context mirroring for
connection based Protocol (e.g. TCP and DTLS over UDP) with different IP
addresses.
2) There is at least one Anchor EAS for each EC service for a specific service
area serving several local DNs.
3) AF is configured to know the Anchor EAS IP address(es).
4) The Anchor EAS IP address is returned to the UE during the EASdiscovery
procedure for the EC service.
5) Anchor EAS may serve several neighbouring Local DNs, when the UE moves
within these Local DNs, network should not trigger the UE to re-discover the
Anchor EAS.
6) AF can manage the runtime context mirroring between Local EAS and Anchor
EAS and between source Local EAS and target Local EAS in order to guarantee
the service continuity. The runtime context mirroring between source EAS and
target EAS remains during the period of EAS migration (from EAS migration
preparation to migration completion) to prevent/reduce UL/DL packet loss,
which also means during the transition period, the source Local EAS continues
to serve the UE.
7) EASs are able to synchronize the protocol states, e.g., TCP states such as
port number and sequence number.
8) OTT application signalling cannot notify UE about the target EAS IP address
or HTTP redirect is not supported by application.
### 6.30.2 Procedures
#### 6.30.2.1 Example EAS IP address replacement procedures for different
scenarios
##### 6.30.2.1.1 EAS IP address replacement in the middle of EC Session
Figure 6.30.2.1.1-1: EAS IP address replacement in the middle of EC Session
1\. UE requests to establish a PDU Session.
2\. UE discovers the IP address of the application server for the EC service,
and the Anchor EAS IP address is returned to the UE via EAS Discovery
procedure.
3\. UE communicates with the Anchor EAS.
4\. AF Influence happens, the EAS IP address replacement information is sent
to the SMF and the SMF reconfigures the UL CL UPF and Local PSA with EAS IP
address replacement information. Or UE moves to an area where the Local PSA
has been configured to enforce EAS IP address replacement. FARs \"Outer Header
Creation\" and \" Outer Header Removal\" are reused for such an instruction
from SMF to UPF.
UL CL is configured by SMF to forward the destination IP address in the UL
packet equals to the Anchor EAS IP address to Local PSA.
Local PSA is configured by SMF to enforce the \"Outer Header Creation\" and \"
Outer Header Removal\" as described in step 6.
Detailed enhancement to the AF Influence procedure is described in clause
6.30.2.2.1.
5\. Early Notification procedure with enhancement described in clause
6.30.2.2.4 is triggered, SMF notifies AF about the current serving EAS IP
address (Anchor EAS IP address for this scenario), AF triggers to mirror the
runtime context between Anchor EAS and Local EAS. Once the Local EAS is ready,
AF responds to SMF about the Local EAS IP address. SMF reconfigures Local PSA
for EAS IP address replacement between Anchor PSA and Local PSA.
6\. Local PSA starts to perform \"Outer Header Creation\" and \" Outer Header
Removal\" FARs as instructed by SMF, which results in EAS IP address
replacement:
\- For UL traffic, the destination IP address is replaced with the Local EAS
IP address at Local PSA;
\- For DL traffic, the source IP address is replaced back with the Anchor EAS
IP address at Local PSA.
NOTE: In this solution, the PSA UPF need not to understand the logic of EAS IP
address replacement.
7\. Late Notification procedure with enhancement described in clause
6.30.2.2.4 is triggered, SMF notifies AF about the start of the EAS IP address
replacement. AF decides when and how to stop the Anchor EAS from serving the
UE.
##### 6.30.2.1.2 UE moves among EC Environments with DNAI and EAS IP address
Change
Figure 6.30.2.1.2-1: EAS IP address replacement procedure after DNAI and Local
EAS IP address change
1\. For UL traffic, the destination IP address is replaced with the Source
Local EAS IP address at Local PSA; for DL traffic, the source IP address is
replaced back with the Anchor EAS IP address at Local PSA.
2\. Early Notification happens, the SMF notifies AF about the source EAS IP
address and source and target DNAI, AF initiates runtime session context
migration from source Local EAS to target Local EAS. When the resource in
target Local EAS is ready, the AF responds with target Local EAS IP address to
SMF. SMF decides whether to relocate UL CL and Local PSA and configures the
EAS IP address replacement using \"Outer Header Creation\" and \" Outer Header
Removal\" in Local PSA2 if PSA relocation happens.
Detailed enhancement to the User Plane Management procedure is described in
clause 6.30.2.2.4.
3\. Local PSA2 starts to perform \"Outer Header Creation\" and \" Outer Header
Removal\" FARs as instructed by SMF, which results in EAS IP address
replacement:
\- For UL traffic, the destination IP address is replaced with the Target
Local EAS IP address at Local PSA;
\- For DL traffic, the source IP address is replaced back with the Anchor EAS
IP address at Local PSA.
4\. Late Notification procedure with enhancement described in clause
6.30.2.2.4 is triggered, SMF notifies AF about the start of the EAS IP address
replacement. AF decides when and how to stop the Anchor EAS from serving the
UE.
##### 6.30.2.1.3 EAS IP address Change under same DNAI due to EAS migration
Figure 6.30.2.1.3-1: EAS IP address Change under same DNAI due to EAS
migration
1\. For UL traffic, the destination IP address is replaced with the Source
Local EAS IP address at Local PSA; for DL traffic, the source IP address is
replaced back with the Anchor EAS IP address at Local PSA.
2\. AF triggered EAS migration without DNAI change as described in clause
6.30.2.2.5 with enhancement.
3\. Local PSA starts to perform \"Outer Header Creation\" and \" Outer Header
Removal\" FARs as instructed by SMF, which results in EAS IP address
replacement again:
\- For UL traffic, the destination IP address is replaced with the Target
Local EAS IP address;
\- For DL traffic, the source IP address is replaced back with the Anchor EAS
IP address.
##### 6.30.2.1.4 From EC to Non-EC Environment due to UE Mobility
Figure 6.30.2.1.4-1: From EC to Non-EC Environment due to UE Mobility
1\. Local PSA performs \"Outer Header Creation\" and \" Outer Header Removal\"
FARs as instructed by SMF, which results in EAS IP address replacement:
\- For UL traffic, the destination IP address is replaced with the Local EAS
IP address;
\- For DL traffic, the source IP address is replaced back with the Anchor EAS
IP address.
2\. Due to UE Mobility to a Non-EC environment, Early Notification is
triggered, target DNAI is set to empty value, AF knows the UE moves out of EC
environment and mirrors the runtime session context from local EAS to Anchor
EAS. Once ready, the AF responds to SMF and SMF removes UL CL and Local PSA
for the PDU Session.
3\. UL and DL traffic goes through Remote PSA, no EAS IP address replacement
happens at Remote PSA.
#### 6.30.2.2 Impacts to existing 5GS procedures
##### 6.30.2.2.1 AF Influence procedure
Figure 6.30.2.2.1-1: Processing AF requests to influence traffic routing for
Sessions not identified by an UE IP address
The EAS IP address replacement information needs to be included in steps 2,
3a, 4, 5 and 6 in the AF Influence procedure described above.
The SMF need to maintain the following EAS IP address replacement information:
\- Anchor EAS IP address: This is the IP address discovered by UE during EAS
discovery procedure, from UE viewpoint, this IP address doesn\'t change during
the lifetime of a PDU Session, as such, re-discovery of EAS is not needed for
the PDU Session.
\- Serving Local EAS IP address per DNAI: For each target DNAI pointing to a
local DN, where the outbound traffic will be routed to, the AF provides the IP
address of a Local EAS in the local DN, which will be used for replacement in
5GC.
##### 6.30.2.2.2 EAS IP address discovery
During the EAS IP address discovery procedure (based on the conclusion of
KI#1), the Anchor EAS IP addresses is returned to UE, UE will always use this
Anchor EAS IP address as the destination IP address for this EC service before
another round of EAS discovery procedure is triggered by 5GC.
When the solution described in this solution is not deployed in the edge of
5GS, the traffic for this service is always between UE and the Anchor EAS;
otherwise, the traffic for this service is always between UE and one of the
local EASs by replacing the EAS IP address in Local PSA UPF.
##### 6.30.2.2.3 Initial EAS IP address replacement in Local PSA UPF
In Local PSA UPF:
\- For uplink traffic, the destination IP address equalling to Anchor EAS IP
address is replaced with the Serving Local EAS IP address;
\- For downlink traffic, the source IP address of the current Serving Local
EAS is replaced with the Anchor EAS IP address for the UE.
##### 6.30.2.2.4 Triggering the EAS IP Address Replacement in Local PSA UPF
after DNAI Change
Figure 6.30.2.2.4-1 (Figure 4.3.6.3-1 in TS 23.502 [3]): Notification of user
plane management event
The current serving EAS IP address for an EC service and source DNAI are
included in steps 2a, 2b 2c.
For the target DNAI, the AF selects the target EAS and the target EAS IP
address needs to be included in steps 2d, 2e, 2f for Early Notification, or in
step 4d, 4e, 4f for Late Notification.
SMF needs to send the \"Outer Header Creation\" and \" Outer Header Removal\"
FARs to Local PSA UPF as described in step 6 of clause 6.30.2.2.1, and Local
PSA UPF starts the EAS IP address replacement as described in clause
6.30.2.2.3.
SMF needs to notify the AF about the start of EAS IP address replacement in
Late Notification.
##### 6.30.2.2.5 AF triggered EAS migration in 5GC
For load balancing purpose, the AF may move some UE(s) from the source EAS to
target EAS in the same local DN identified by the DNAI.
For the abnormal condition of EAS, the AF may move all the UEs being served by
the source EAS to a target EAS in the same local DN.
The AF influence content information defined in clause 5.6.7.1 (table 5.6.7-1)
of TS 23.501 [2] needs to include following additional information:
\- List of UE IP address and port number: The IP address and port number of
the UE(s) whose traffic should be moved from source EAS to target EAS in the
same local DN identified by DNAI.
\- Source EAS IP address for the impacted DNAI: The IP address of source EAS
in local DN identified DNAI which is currently serving the UE(s).
\- Target EAS IP address for the impacted DNAI: The IP address of target EAS
in local DN identified DNAI which the edge application traffic will be moved
to.
Figure 6.30.2.2.5-1: Handling an AF request targeting individual UE(s) IP
address to the relevant PCF
Depending on the AF deployment (see TS 23.501 [2], clause 6.2.10), the AF may
send the AF request to PCF directly, in which case step 1 is skipped, or via
the NEF.
1\. [Conditional] If the AF sends the AF request via NEF, the AF sends
Nnef_TrafficInfluenceCreate/Update/Delete Request targeting an individual UE
address to the NEF. This request corresponds to an AF request to influence
traffic routing that targets an individual UE address.
When NEF receives an AF request from AF, the NEF ensures the necessary
authorization control, as described in clause 4.3.6.1, mapping from the
information provided by the AF into information needed by the 5GC. The NEF
responds to the AF.
2\. [Conditional] AF/NEF consumes Nbsf_Management_Discovery service operation
(providing at least the UE address) to find out the address of the relevant
PCF if the PCF address is not available on the NEF based on local
configuration, otherwise step 1 is skipped.
NOTE: The AF/NEF finds the BSF based on local configuration or using the NRF.
3\. BSF provides the PCF address in the Nbsf_Management_Discovery response to
AF/NEF.
4\. If step 1 was performed, NEF invokes the Npcf_PolicyAuthorization service
to the PCF to transfer the AF request. If an AF sends the AF request directly
to the PCF, AF invokes Npcf_PolicyAuthorization service and the PCF responds
to the AF.
5\. The PCF updates the SMF with corresponding new PCC rule(s) with PCF
initiated SM Policy Association Modification procedure as described in clause
4.16.5.2. When a PCC rule is received from the PCF, the SMF may take
appropriate actions, when applicable, to reconfigure the User plane of the PDU
Session, such as:
\- Adding, replacing or removing UPF(s) in the data path, e.g. to act as UL
CL, Branching Point, and/or PDU Session Anchor e.g. as described in clause
4.3.5.
\- Allocate a new Prefix to the UE (when IPv6 multi-Homing applies).
\- Updating the UPF regarding the target DNAI with new traffic steering rules.
\- Subscribe to notifications from the AMF for an Area Of Interest via
Namf_EventExposure_Subscribe service operation.
\- Updating the Local PSA UPF with \"Outer Header Creation\" and \" Outer
Header Removal\" FARs to re-enforce the updated replacing EAS IP address(es)
per DNAI and replace the source EAS IP address with the target EAS IP address
for the specific DNAI for specific UEs identified by list of target UE
identifier(s), or the list of UE IP address and port number.
### 6.30.3 Impacts on services, entities and interfaces
AF:
\- Receives source EAS IP address and source DNAI;
\- Sends the EAS IP address replacement information to 5GC.
PCF/NEF:
\- Forwards source EAS IP address and source DNAI to AF;
\- Forwards the EAS IP address replacement information to SMF.
SMF:
\- Notifies the source EAS IP address and source DNAI to AF (via PCF/NEF);
\- Notifies the start of EAS IP address replacement to AF (via PCF/NEF);
\- Receives and stores the EAS IP address replacement information and use it
to derive \"Outer Header Creation\" and \"Outer Header Removal\" FARs to be
sent to the UPF;
\- Adds the Anchor EAS IP address into the packet forwarding filter.
EAS
\- Impact on the protocol layers for state synchronization e.g. TCP sequence
numbering.
## 6.31 Solution #31 Application Relocation with UE assistance
### 6.31.1 General
UE may have a communication with an EAS. When UE moves, new UPF may be
selected (i.e. ULCL insertion or new PDU Session with new UPF for SSC mode
2/3) and a new EAS may be available at the new edge computing environment
which can be accessed via the new UPF. To better serve the UE, the EAS
relocation is needed. The EAS relocation may also be initiated from the
application side, e.g. due to the load condition of the EAS.
If application has state, the EAS relocation need to be coordinated with UE to
avoid packet loss. Also during EAS relocation, the application state will be
synchronized between old EAS and new EAS.
Considering in many cases, the application runs over connection based
transport layer, e.g. for HTTP based application, it usually runs over TCP.
The transport layer has states, which are usually managed by OS of the EAS.
Between the old EAS and the new EAS it is difficult to synchronize the
transport layer state of the application. In this solution, it assumes that
only the application layer state is transferred from old EAS to the new EAS.
The transport layer state does not need to be synchronized.
The proposed solution support EAS relocation especially when it does not
support notifications of EAS change to UE via application layer, and EAS
change notification is delivered to UE via ePCO of NAS message.
### 6.31.2 Procedure for EAS relocation
Figure 6.31.2-1: Application Relocation with UE assistance
1\. If the EAS relocation for this application needs coordination from 5GC,
the AF subscribes to late and early notification. The AF request may include
the application relocation possibility indication and the \'AF acknowledgement
to be expected\' indication. The AF request may also indicate no DNAI change
to 5GC for this application if the service continuity need to be supported.
2\. The PCF generates PCC rules based on the AF request and provides the PCC
rules to the SMF. This step may happen during establishment of the PDU Session
or during modification of the PDU Session.
3\. The SMF determines to select a new UPF, e.g. a new ULCL/L-PSA is to be
inserted. The trigger of the new ULCL/L-PSA insertion may be triggered due to
UE mobility.
4\. Based on the subscription, the SMF may send an early notification to the
AF, including the corresponding DNAI.
5\. The AF may select a new EAS based on the new DNAI. This step may be
triggered by step 4, or by application layer events, e.g. load condition of
the old EAS. In the latter case, the AF may select a new EAS and determine the
DNAI(s) based on local configuration or relocation-related information (e.g.
delay and UE location info) obtained from 5GC (e.g. SMF).
6\. Based on the trigger of the EAS relocation, the AF gives a feedback to
SMF.
6a. If the EAS relocation is triggered by SMF notification, the AF sends a
positive response to the early notification to the SMF.
In the positive response, the AF includes information to be provided to the
UE, including either the address of the new EAS or indication for application
server relocation, corresponding DNAI and its FQDN selected by the AF. The AF
may further include a UE port number, if available. The UE port number
identifies a port at the UE side that the UE uses to connect to the source
EAS. The AF also provides a relocation timer to indicate expected maximum time
for application relocation.
6b. If the EAS relocation is triggered by EAS, the AF request for the edge
application relocation is sent to the PCF. It includes the information of
target application server (the information of target application server may be
the information on the target application server for the application (e.g. the
IP address of the target application server), or the indication for
application server relocation (e.g. a trigger for UE re-initiating DNS Query
for the application) , corresponding DNAI and the FQDN of the target
application server). The AF also provides a relocation timer to indicate
expected maximum time for application relocation.
The PCF updates the PCC rule with the information received to the SMF.
7\. If a new DNAI is received, the SMF insert the new ULCL and new L-PSA,
which is better serves the new EAS.
NOTE 1: If I-SMF is involved in the PDU Session, the I-SMF receives the
configuration information (e.g. new DNAI) for ULCL/L-PSA, the detailed
procedure is defined in TS 23.502 [3].
8\. The SMF sends a PDU Session Modification Request NAS message with AS
change notification information in ePCO to UE. In the AS change notification
information, the SMF includes either the new EAS address or trigger for UE
initiating DNS query, and its FQDN. If the AF response includes a UE port
number, the SMF includes the UE port number in the AS change notification. The
FQDN and/or the UE port number are used to identify which application needs to
change EAS. If PDU is of SSC mode 3, the SMF may use the relocation timer
provided by the AF when calculating the PDU Session Address Lifetime of the
existing PDU Session to be relocated.
NOTE 2: How to exchange the new EAS\'s information (new EAS address and its
FQDN and/or the UE port number) with the application client is the UE internal
implementation.
NOTE 3: It is assumed the new EAS address provided by NAS layer is same as the
one provided by application layer (if provided).
NOTE 4: Providing the new EAS address in the NAS layer can synchronize the
path change at 5GS network. That means only when the path to the new EAS is
available, the new EAS address is provided to the UE.
9\. When the UE receives the ePCO of AS change notification information within
the PDU Session Modification Command message, it delivers the information to
upper layer per the received information, e.g. UE port number.
If trigger for new DNS query has been received, UE first discovers the new EAS
via DNS. The UE establishes a new connection with the new EAS. The UE may send
the application layer UE identifier to the new EAS via the new connection. The
application layer UE identifier is used to associate the new connection with
the received application state from old EAS. For the traffic to the new EAS
address it is steered to the new EAS at the ULCL2.
10\. The UE sends PDU Session Modification Ack NAS message to SMF.
11\. The SMF sends a late notification to the AF.
12\. The AF starts to synchronize the application state from the old EAS to
the new EAS if it is needed. The details of how the application state is
synchronized is out of scope of 3GPP specification.
13\. The AF sends a positive response to the late notification to the SMF
after the application state synchronization.
If packet loss less is required, the AF includes an indication for UE to
suspend uplink data temporarily in step 6, and SMF includes the indication in
step 8. The UE stop sending uplink packets to the application.
Correspondingly, in step 13, the AF includes a Resume indication, and the SMF
forwards the Resume indication to UE. After UE receives Resume indication, the
UE restart to send uplink packets of the application. The UE may buffer the
uplink packets after receives Suspend indication.
NOTE 5: The UE drops packets in the case of buffer overflow.
### 6.31.3 Impacts on services, entities and interfaces
AF:
\- AF provides either EAS IP address or indication for application server
relocation, and FQDN to UE via SMF.
\- AF indicates UE to suspend or resume the uplink traffic via SMF.
SMF/PCF/NEF:
\- SMF/PCF/NEF support the transferring of the EAS IP address, indication for
application server relocation, the suspend/resume indication to UE.
UE:
\- Support to receive the new EAS\'s information (new EAS address and its FQDN
and/or the UE port number, and the indication for UE to suspend uplink data)
in NAS layer.
\- Support re-establish connection with target EAS based on received new EAS
IP of target EAS in NAS layer.
\- Support suspend and resume the uplink transferring of application data in
NAS layer.
\- Impacts to NAS layer, OS layer and application are foreseen, so as in their
interfaces.
\- Application client layer recognizes the new EAS IP address provided by the
lower layer and switches to the new EAS use it.
## 6.32 Solution #32: UE DNS cache flush
### 6.32.1 Description
The solution addresses Key Issue #2: Edge relocation.
The solution is also for Key Issue #1, which addresses Edge AS discovery
including aspects related to:
\- Whether and if yes how to support UE rediscovery of Edge Application Server
when the previous Edge Application Server becomes non-optimal or unavailable
to the UE?
If ULCL is used to access the edge network, the UE is unaware of the ULCL
insertion/removal/change. An application may be deployed in multiple edge
networks, and the UE may already have connected to an application server in
one edge network, and cached the related DNS record locally. When UE moves,
the application located at the old edge network may be not optimized for UE to
visit. In this case, if the new edge network has the same application server,
it may be preferred that the new application server in the new edge network is
selected by the UE.
However, since the UE already has the IP address of the current edge
application server it will continue to use this IP address unless the path to
current edge application is broken or the stored DNS cache is expired.
Breaking before making would be a crude trigger for re-discovery, thus a
better trigger is needed for re-discovery. Thus the UE triggers a re-discovery
according to the following:
\- When DNAI changes, i.e. the ULCL is changed or removed, the SMF sends a DNS
re-resolution indication to UE. This DNS resolution indication tells UE to
rediscover the application server in the indicated area. After receiving the
DNS re-resolution indication, if UE wants to re-establish a connection to an
edge application server associated with the DNS re-resolution indication, the
UE will trigger a new DNS query . By this, the path between the UE and the
application server may be optimized.
The AF provides the DNS Suffix and/or FQDNs supported by a local DN (i.e. the
AF is supported in which corresponding DNAI) via AF influence on traffic
routing as defined in TS 23.502 [3], clause 4.3.6. The information is stored
in UDR, and provisioned to SMF by PCF. The IP ranges of each DNAI can also be
configured at the SMF locally. During L-PSA insertion/removal/ change, the SMF
uses this information to determine the DNS Suffix, FQDNs or IP ranges that
will be included as the associated area information (see step 2 of clause
6.32.2) within the NAS message. So that UE can remove DNS record(s), which are
related to the local DN to be removed or inserted.
NOTE: The SMF is not required to be aware the DNS records which have been
stored in UE\'s DNS cache.
### 6.32.2 Procedures
Figure 6.32.2-1: CN instructed UE DNS cache flush
1\. The UE connected to the application server located in an edge computing
network accessed via ULCL1. So the original data path from UE to application
server is via ULCL1. When the UE moves, and SMF sees that the path using ULCL1
is no optimised, it decides that a new PSA (PSA2) is needed. It may already at
this stage insert a new ULCL (ULCL2) and may keep or remove old ULCL1.
2\. The SMF sends DNS re-resolution indication to UE via PDU Session
Modification Command. The indication may contain be associated with an area
information, which is indicated by the IP segment, subnet info, a list of
FQDNs or DNS suffixes. So that the UE knows which application the indication
is about.
If the area information is not included, it means all the DNS cache
information is cleaned.
3\. The UE either remove or replace (i.e. with the new DNS record) the DNS
records stored locally. If the area information is included in the DNS re-
resolution indication, the UE only remove or replace the DNS records
corresponding to that area information.
The active connection between the UE and the EAS is not impacted. This
operation triggers UE to reselect EAS when UE initiates a new connection with
EAS.
4\. The UE discovers a new EAS according to KI#1 using ULCL. If ULCL was not
inserted in step 1, a new ULCL will be inserted according to KI#1.
The UE connects to the new application server located in the edge computing
network corresponding ULCL2.
### 6.32.3 Impacts on services, entities and interfaces
\- SMF: send DNS re-resolution indication and area information to UE in PDU
session modification command when DNAI changes. The area information can be
the DNS Suffix, FQDNs or IP ranges. The DNS Suffix or FQDNs are received from
AF. The IP ranges are configured at the SMF locally.
\- UE: rediscover application server and store new DNS records based on DNS
re-resolution indication and area information received from network.
## 6.33 Solution #33: IP preserving PSA relocation
### 6.33.1 Description
This solution describes a IP preserving PSA relocation where the application
context including L4 network context can be transferred between the EAS(es).
In this solution the two PDU Sessions are used temporarily with the same UE IP
address.
Figure 6.33.1-1: Scenarios for PSA relocation with preserving the same IP
address
The common assumptions for both scenario A and scenario B as described in the
figure are as follows:
1\. EAS#1 and EAS#2 are located in the same Data Network, identified by DNN,
S-NSSAI in 5G System.
2\. EAS#1 and EAS#2 are different instances of the same EAS.
3\. Application context relocation from EAS#1 to EAS#2 is supported. The
application context relocation includes the upper layer network context (e.g.
TCP context or high layer context). The context transfer can be done directly
from EAS#1 to EAS#2 or by some other enabler network functions (e.g. EES).
NOTE. How to transfer the application layer context is out-of-scope of this
study.
4\. User Plane event notification can be used for triggering the application
relocation, but is not required. If the user plane event notification is used,
it can be used by source/target EAS or by other enabler AF (e.g. source EES
and target EES) or via central AF (e.g. an orchestrator).
5\. The IP address range of the PSA-UPF#1 and PSA-UPF#2 are the same. It is
assumed that the application data traffic towards the UE can reach to the PSA-
UPF either by Proxy-ARP functionalities of PSA-UPF or by N6 routing
information (i.e. the tunnel between the EAS to the PSA-UPF).
6\. The upper layer context of the UE can be maintained after PSA-UPF
relocation.
Scenario A (Intra-DNAI PSA relocation with the upper layer network context
transfer) of the Figure 6.33.2-1 assumes the following:
1\. This scenario shares the common assumptions.
2\. EAS#1 and EAS#2 are located in the same datacentre. It is assumed to have
the same DNAI when their locations are topologically identified as DNAI by the
5G Core Network.
Scenario B (Inter-DNAI PSA relocation with the upper layer network context
transfer) of the Figure 6.33.1-1 assumes the followings:
1\. This scenario shares the common assumptions.
2\. EAS#1 and EAS#2 are located in different datacentres with having different
DNAI(s) in the same DN. It is assumed to have the different DNAIs when their
locations are topologically identified as DNAI(s) by the 5G Core Network.
This solution assumes that a single SMF manages two PDU Sessions.
Editor\'s note: It is FFS whether or how to support two PDU Sessions are
served by two different SMFs.
### 6.33.2 Procedures
#### 6.33.2.1 PSA relocation triggered by UP event notification
This procedure explains the PSA relocation triggered by UP event notification.
In this procedure, the UE IP address used for the first PDU Session is
allocated to the UE for the second PDU Session. The upper layer network
context bound to the first PDU Session is preserved during the procedure.
Figure 6.33.2.1-1: PSA relocation (triggered by UP event notification)
1\. The UE establishes the PDU Session successfully.
2\. The source AF (e.g. EES) or central AF sends AF influenced traffic
steering request the PCF directly or via NEF/UDR. The AF requests includes the
request for preserving IP address and upper layer context of the UE. When AMF
invokes PDUSession_Update_SMContext API during the Registration procedure,
N2/Xn handover procedure, or Service Request procedure, the SMF checks whether
a triggering condition of the UP event notification is met.
3\. If the triggering condition for UP event notification is met, the SMF
notifies the user plane event to the source AF. The source AF (e.g. EES or
EAS) initiates the context relocation preparation procedure among the source
AF, target AF, source EAS and target EAS as described in the step A. If the
source AF and the target AF supports the application context transfer
(including TCP context transfer) and decides to perform the application
relocation with preserving the IP address and the upper layer context, the AF
replies the SMF with sending the IP address preservation indicator and the
upper layer retain indicator to the SMF in the AppRelocationInfo message.
NOTE 1: The step A can start either after receiving the early notification or
after receiving the late notification.
4\. If the SMF decides to relocate the PSA with preserving IP address and the
upper layer context, the SMF selects the PSA2 based on the DNAI and the PDU
Session Modification Command to the UE via AMF. The message includes the IP
preservation required and the upper layer context control information to the
UE. The upper layer control information may include whether to preserve the
upper layer context when releasing this PDU Session.
5\. If the UE receives the cause that the PDU Session to be re-established
from the SMF and the IP preservation required, the UE sends the PDU Session
Establishment request to establish the second PDU Session with related with
the first PDU Session. The UE sends the IP preservation request and UE IP
address that is allocated by the SMF and used for the first PDU Session. If
SMF determines that the requested IP address can be allocated and routable
with the PSA-UPF2, the SMF allocates the requested IP address and establishes
the N4 Session with the PSA-UPF2. The SMF sends the IP address to the UE in
the PDU Session Establishment Accept to the UE via AMF.
6\. The SMF sends the late notification to the source AF. The SMF sends the
late notification to the target AF if the AppRelocationInfo indicates the AF
change indication and the target notification endpoint address is included in
the step 3-2). In the step B-1, Source AF, Target AF, S-EAS and T-EES performs
the application context transfer procedure. After the application context
transfer procedure is performed, the source AF sends the AppRelocationInfo to
the SMF.
NOTE 2: The step B-1 can be performed after the step A. The detailed of the
step B-1 and the step B-2 is application layer procedure that is out-of-scope
of this study.
NOTE 3: After completion of the application context transfer, the source AF
may indicates the application context transfer completion to the application
layer client (e.g. EEC) in the UE as described in the step B-2.
7\. The UE may request to release the first PDU Session. The SMF releases the
PDU session either after receiving AppRelocationInfo or after the retain timer
expires or after receiving the PDU Session Release request from the UE. If the
SMF decides to relocate the PSA with preserving IP address and the upper layer
context in step 4, the SMF includes an indicator that upper layer network
context bound to the first PDU Session of the UE is preserved. If the UE
receives the indicator, the UE forwards the indicator to the high layer to
preserve the upper layer network context (such as TCP context) bound to the
first PDU Session so that the context be continuously used for the second PDU
Session. If the UE does not receive such an indicator, the high layer of the
UE release all the upper layer context bound to the first PDU Session when the
first PDU Session is released.
#### 6.33.2.2 PSA relocation (without UP event notification)
This procedure explains the PSA relocation (without UP event notification). In
this procedure, the UE IP address used for the first PDU Session is allocated
to the UE for the second PDU Session. The upper layer network context bound to
the first PDU Session is preserved during the procedure.
Figure 6.33.2.2-1: PSA relocation (without UP event notification)
1\. This step is the same as the step 1 of the Figure 6.33.2.1-1.
2\. This step is the same as the step 2 of the Figure 6.33.2.1-1.
3\. If the triggering condition for UP event notification is met, the SMF
decides the PSA relocation.
4\. If the SMF decides to relocate the PSA with selecting the PSA2 based on
the DNAI change, the SMF sends the PDU Session Modification Command to the UE
via AMF. The message includes the IP preservation required and the upper layer
context control information to the UE. The upper layer control information may
include whether to preserve the upper layer context when releasing this PDU
Session and indicates to trigger of the application context relocation.
NOTE 1: When the UE receives the upper layer context control information. The
application layer of the UE can send the context relocation request to the
Source AF (e.g. EES) in step A-1 to trigger the application context
relocation.
5\. This step is the same as the step 5 of the Figure 6.33.2.1-1.
NOTE 2: The steps A and B are the same as the steps A and B of the Figure
6.33.2.1-1.
6\. This step is the same as the step 7 of the Figure 6.33.2.1-1.
### 6.33.3 Impacts on services, entities and interfaces
The following 5GC Control Functions are impacted:
\- SMF: The SMF supports the same IP address allocation with different PSA-UPF
based on the PCC rules or AF request.
\- NEF: The AF influenced traffic steering request support more information
elements.
\- PCF: The PCF supports the upper layer context preserving information
elements.
\- UE:
The supports the upper layer context preservation if indicated by the SMF.
Impact on UE to support to identify IP preservation and exchange the upper
layer network context control.
## 6.34 Solution #34: Local DN notification to the UE during ULCL operations
### 6.34.1 Description
This solution provides a solution for local DN notification to the UE for
KI#2.
This solution assumes that local DN configuration is locally configured in the
SMF or local DN configuration is configured in the PCF. The local DN
configuration includes the following information:
\- Local DN identifier (e.g. DNAI).
\- Local DN service area: Tracking area list or cell list, LADN DNN, Present
Reporting Area.
\- IP address range.
\- Indicator whether Local DNS is deployed in the local DN.
\- Local DNS address, and domain name applied for the local DNS server.
\- Service Provider Identifier (e.g. Edge Computing Service Provider
identifier).
\- Indicator to support the application relocation across the local DN(es).
\- Indicator to notify the local DN information to the UE. An example of local
DN configuration is described in the figure.
Figure 6.34.1-1: Example local DN configuration for local PSA relocation
In figure 6.34.1-1, Local DN A is configured as described in the figure. PSA-
UPF #1 is a local PSA-UPF to connect the UE to the local DN A. In the local DN
A, EAS#1 with 10.10.10.1 and EAS#2 with 10.10.10.2 are instantiated and used.
Local DN B is configured as described in the figure. PSA-UPF#2 is a local PSA-
UPF to connect the UE to the local DN B. In the local DN B, EAS#1 with
10.10.20.1 and EAS#2 with 10.10.20.2 are instantiated and used.
As shown in Figure 6.34.1-2, the UE connects to the local DN and central DN
with one PDU Session using ULCL solution of 5GC. One Layer 4 context (for TCP
connection between the UE and the EAS#1 in local DN) has been established and
the second Layer 4 context (for TCP connection between the UE and the AS#1 in
central DN) has been established. Both TCP connections are bound to the same
network interface corresponding to the PDU Session #1.
Figure 6.34.1-2: An example of local DN binding context
When the SMF performs the local PSA relocation from local DN 1 to local DN2 in
a network deployments configured as described in the Figure 6.34.1-1, the UE
needs to refresh the connection with EAS#1 (10.10.10.1 in local DN1) so that
the UE can connect to the EAS#1 (10.10.20.1 in local DN 2). However, the
current ULCL operation (i.e. insertion/relocation/deletion of ULCL and
additional PSA-UPF as described in TS 23.501 [2] 5.6.4.2) does not provide any
indication to the UE. Therefore, the old connection tears down after
experiencing error case.
To solve this scenario, it is proposed that the SMF sends the local DN binding
context control information to the UE to control whether the upper layer
context information such as DNS cache and/or Layer 4 context in High Layer OS
should be refreshed or not. The information also need to include local DN
configuration information so that the UE identify the context related with the
local DN. To deliver the local DN configuration and local DN context control
information to the UE, the SMF performs the PDU Session Modification Procedure
when it updates the ULCL UPF. Local DN notification information required to be
transferred to the UE includes the following information:
1) Local DN identifier (e.g. DNAI).
2) Local DN event: local DN inserted/relocated/removed.
3) Local DN configuration: IP address range, local DNS server address, IP
3-tuple (IP address, port and protocol number).
4) Local DN binding context control: L4 binding context refresh/maintain
indicator, DNS cache refresh indicator.
### 6.34.2 Procedures
#### 6.34.2.1 Overview of local DN notification
The procedure describes when the local DN notification is sent to the UE and
how the local DN binding context control information is used by the UE.
Figure 6.34.2.1-1: Overview of local DN notification
1\. If the UE requests to establish a new PDU Session, the SMF selects the
PSA-UPF0, establishes the N4 Session with PSA-UPF0, makes the tunnel between
the (R)AN and PSA-UPF0 and sends the PDU Session Establishment Accept to the
UE. After successful establishment of the PDU Session, the UE can make network
interface corresponding with the PDU Session.
2\. The UE can connect a TCP connection with the server in the central DN. A
TCP context is established in the upper layer (e.g. the High Layer OS) in the
UE and the TCP context is bound to the network interface associated with the
PDU Session established in the step 1. This is illustrated as (A).
3\. The SMF decides to insert ULCL UPF and local PSA-UPF, selects the local
PSA-UPF1, and establishes the N4 Session with ULCL UPF and local PSA-UPF1 and
sends the uplink classifier information (e.g. IP 3-tuple information including
destination IP address, port and protocol number) to the ULCL-UPF. The SMF
sends the local DN information to the UE. The local DN information includes an
indication of the addition of a local DN, the identifier of the local DN (e.g.
DNAI-A), IP address range of the local DN, local DNS address, domain name for
the local DN, uplink classifier information (e.g. IP 3-tuple) sent to the ULCL
UPF. If the UE receives the local DN information, the UE stores them and uses
the received information to control (e.g. refresh or maintain) the local DN
binding context (e.g. DNS cache and/or L4 context).
4\. The UE can perform DNS resolution procedure based on the application\'s
request for EAS#1 FQDN. The UE can query a DNS request to resolve the IP
address for EAS#1 to the local DNS server advertised in the step 3 or a DNS
server in the central DN.
5\. The UE can connect to the EAS#1 with the IP address discovered via DNS
query procedure and establish a TCP context that is illustrated in (B).
6\. If the SMF detects the DNAI change caused by the UE movement or if the SMF
receives the AF influenced traffic steering enforcement control information
from the PCF, the SMF decides to relocate the local PSA-UPF and performs the
local PSA relocation procedure.
During this procedure, the SMF sends the local DN notification to the UE. The
local DN notification includes the removal of the local DN with local DN
identifier (e.g. DNAI-A), addition of a new local DN with local DN identifier
(e.g. DNAI-B) and the configuration of local DN2.
When sending the local DN notification to the UE, the SMF also sends the local
DN binding context control information related with the local DN. The local DN
binding context control information includes Layer 4 context refresh indicator
and DNS cache refresh indicator for the removed local DN (e.g. local DN 1
identified by DNAI-A).
If the UE receives the Local DN binding context control information, the UE
forwards the control information to the High Layer OS within the UE to handle
the control information properly. For example, if the control information
includes Layer 4 context refresh indication, the UE removes the Layer 4
context (e.g. the TCP context) that was established with the local DN1. If the
control information includes the DNS refresh indicator, the DNS cache
information related with local DN 1 is removed. The removed DNS cache can
include the IP addresses belonging to the local DN1 or DNS domain name
belonging to the domain name of local DN or information discovered from the
local DNS server in the local DN 1.
7\. The application can try to re-establish the TCP connection with the EAS#1
due to the removal of the exiting TCP context. If the discovered DNS cache for
EAS#1 is removed, the UE performs another DNS query procedure for EAS#1. The
new DNS query resolves the IP address of EAS#1 belonging to the local DN 2.
8\. If the application requests to establish the TCP connection with EAS#1
instance is discovered in local DN2, a new TCP connection is established with
the EAS#1 in local DN 2 through PSA-UPF2.
9\. Based on the UE movement or AF request to remove the local PSA-UPF, the
SMF decides to remove the local PSA-UPF2. The SMF can send the local DN
notification with the local DN binding context control information to the UE
based on the PCC rules sent by the PCF or local SMF decision. The local DN
information includes the removal of local DN 2 identified by DNAI-B. The local
DN binding context control information includes the Layer 4 context refresh
indicator and DNS cache refresh indicator. The high layer OS of the UE moves
the TCP context and DNS cache information related with the local DN 2.
#### 6.34.2.2 Procedure for local DN notification control by PCF during local
PSA insertion/relocation/removal
The local DN configuration as described in clause 6.34.2.1 is configured in
the SMF or in the PCF.
The PCF decides to create a PCC rules including the local DN notification
control information and sends it to the SMF during the SMPolicyAssociation is
established or modified. The local DN notification control information
includes the following:
\- Identifier of local DN (e.g. DNAI).
\- Indicator whether to notify the local DN information to the UE.
\- Local DN binding context control information (e.g. DNS cache control and/or
Layer 4 context control).
\- Local DN configuration: this information can be pre-configured in the SMF
or sent by PCF to SMF.
If the SMF receives the PCC rules including local DN notification control
information and detects the UE moves into the service area of the local DN
identified by DNAI, the SMF decides to perform the ULCL UPF and local UPF
insertion procedure based on AF influenced traffic steering enforcement
control information and decides to whether to notify the local DN notification
to the UE based on the local DN notification control information provided by
the PCF. If the local DN notification control information indicates the local
DN notification should be delivered the UE, the SMF performs the PDU Session
Modification procedure to deliver the Local DN notification information with
the Local DN binding context information to the UE.
Figure 6.34.2.2-1: local UPF insertion/relocation with local DN notification
to the UE (PCF controlled)
1\. During the UE requests a PDU Session Establishment, the UE may include the
local DN notification support indicator. The SMF receives the local DN
notification control information if it is provided by the PCF through
SMPolicyAssociation establishment/modification procedure. The SMF selects the
PSA-UPF0 and establishes N4 Session with the PSA-UPF0. Based on the capability
of the UE, the subscription information retrieved from the UDM and the local
DN notification control policy provided by the PCF, the SMF decides to accept
the request of PDU Session Establishment and sends the PDU Session
Establishment Accept to the UE via AMF. After the SMF receives the RAN tunnel
information from the (R)AN via AMF, the SMF modifies N4 session for the PSA-
UPF0.
2\. When AMF invokes PDUSession_Update_SMContext API during the Registration
procedure, N2/Xn handover procedure, or Service Request procedure, the SMF
checks whether the UE is located in the service area of local DN identified by
DNAI. Alternatively if the PCF sends AF influenced traffic control enforcement
control information in PCC rules including the local DN notification control
information with performing the SMPolicyAssociation modification procedure to
the SMF, the SMF determines to insert a ULCL UPF and/or local PSA-UPF. The
message may include the local DN binding context control information as well.
3\. After the SMF decides to add additional PSA-UPF (including ULCP UPF and
local PSA-UPF), the SMF modifies N4 Session with PSA1, establishes a N4
Session with ULCL, modifies N4 Session with PSA0 to update the downlink data
traffic, and modifies N4 Session with PSA1. If the SMF receives the local DN
notification control information from the PCF in the step 1 or step 2, it
initiates the PDU Session Modification Procedure to send the local DN
notification the UE. If the PCC rules include the indication of the local DN
binding context control information, the SMF decides to include which
indicators included in the upper layer network context control information
based on the scenarios. For example, if the SMF decides to relocate the local
PSA-UPF from the local DN1 to the local DN 2, the SMF includes the L4 session
refresh indicator and/or DNS cache refresh/maintain indicator.
4\. The procedure of triggering condition for local PSA relocation is the same
described in the step 2
5\. After the SMF decides to relocate local PSA-UPF (from PSA1 to PSA2), the
SMF establishes N4 Session with PSA2 (new), modifies N4 Session with ULCL UPF.
If the SMF receives the local DN notification control information in the PCC
rules from the PCF in the step 1,2 or 4, the SMF performs the PDU Session
Modification procedure to send the local DN notification to the UE. After
performing the PDU Session modification procedure, the SMF releases the N4
Session for PSA-UPF1.
#### 6.34.2.3 Procedure for AF requested local DN notification control during
local PSA relocation
This procedure describes the AF requested local DN notification control during
PSA relocation.
Figure 6.34.2.3-1: AF requested local DN info notification control during
local PSA relocation
1\. The PDU Session Establishment procedure is performed
2\. The procedure for the addition of additional PSA is performed.
3\. In step 3A, the Source AF or the central AF can subscribe the UP event
notification by sending AF request for AF Influence Traffic Steering. If the
AF request is requested via NEF, the NEF stores the AF request to the UDR and
the UDR notifies the PCF. Alternatively, the AF can request PCF directly. If
the PCF receives the AF request, the PCF sends the AF influenced traffic
steering enforcement control information in PCC rules to the SMF with
SMPolicyAssociation modification procedure. The PCF includes the local DN
notification control information in the PCC rules. The PCF may send the
indicator whether to allow the AF requested local DN binding context control
information.
In step 3B, when AMF invokes PDUSession_Update_SMContext API during the
Registration procedure, N2/Xn handover procedure, or Service Request
procedure, the SMF checks whether the UE is located in the service area of
local DN identified by DNAI.
4\. The SMF decides to add an additional PSA-UPF and a ULCL UPF based on the
triggers described in the step 3. If the AF request includes the subscription
for the UP event notification, the SMF sends the early notification to the
source AF in the step X-1. The AF responds the SMF with sending the
AppRelocationInfo with positive response in the step X-2.
The AppRelocationInfo message may include the AF requested upper layer control
information with the indicator for request of refreshing the L4 context or
refreshing the local DNS cache. The AF includes the refreshing L4 context if
the layer 4 connection to the EAS has to be re-established after the
application relocation procedure. The AF includes the refreshing the local DNS
cache if local DNS is deployed in the local DN. The SMF establishes the N4
Session with local PSA-UPF1.
5\. If the SMF decides to relocate the local PSA, the SMF modifies N4 Session
with ULCL UPF. If local DN binding context control information is included and
the PCC rules received in the step 3 allows the AF requested local DN control
is allowed, the SMF decides the contents of local DN notification including
the local DN binding context control information based on the information
received from the PCF and AF request from the AF. After performing the PDU
Session modification procedure, the SMF releases the N4 Session for PSA-UPF1.
### 6.34.3 Impacts on services, entities and interfaces
The following 5GC Control Functions are impacted:
\- SMF: The SMF supports to send the local DN notification information to the
UE using PDU Session Modification during the local PSA
insertion/relocation/delete procedure.
\- PCF: The PCF should support PCC rule for local DN notification control
information.
\- UE: The UE supports to handle the local DN notification control (such as
refresh/maintain DNS cache information related with the local DN or
remove/maintain Layer 4 context related with local DN) if it received by the
SMF.
## 6.35 Solution #35: Edge relocation considering with user plane latency
requirement (SMF decision)
### 6.35.1 Description
This solution can provide a solution for enabling an edge computing relocation
with considering user plane low latency, when required by the edge application
server (EAS) and/or the edge enabler server (EES).
In the existing mechanisms in Rel-16 5G System, the SMF can decide whether to
relocate the PSA-UPF using various information including locally configured
topology information. However, the existing mechanisms have not considered the
user plane latency between the UE and the PSA-UPF.
When the UE moves across the Edge Data Network Service Area that can be
identified by DNAI, the SMF may decide to relocate the PSA-UPF using its
locally configured topology information. However, PSA-UPF relocation may cause
unnecessary service interruption due to the change of IP address of the UE
even for the case that the serving UPF is able to satisfy the required user
plane latency without relocation of PSA-UPF.
To address this trade-off, this solution provides the enhancement of AF
influence so that the EAS or EES acting as AF can provide the user plane
latency requirements to the SMF so that the SMF decides to relocate the PSA-
UPF based on the user plane latency requirements.
The followings are assumed in this solutions:
\- This solution assumes the application architecture described in TR 23.758
[5] clause 6.2.
\- This solution applies to the 5GS architecture assumptions (both with
ULCL/BP as in Figure 4.1-1 and without ULCL/BP as in Figure 4.1-2) as
described in clause 4.1 of this document.
\- The user plane latency requirement is known to AF (i.e. EAS or EAS).
\- The estimated user plane latency between the UE and the potential PSA-UPF
is known to the SMF.
NOTE: How the estimation can be done either by SMF local
computation/configuration or by using the estimation of the user plane latency
from NWDAF. It is outside scope of this study.
### 6.35.2 Procedures
The procedure is the same as the existing procedure defined in the TS 23.502
[3] clause 4.3.6.2 with additional parameters sent by AF and required SMF
behaviour.
Figure 6.35.2-1: AF request with user plane latency requirements (SMF
decision)
1\. The AF (e.g. EAS or EES) decides to sends AF traffic influence request. In
addition to the input parameters described in TS 23.502 [3], clause 5.2.6.7,
this request includes the user plane latency requirements. The user plane
latency requirement may include the following information:
\- Maximum allowed user plane latency: The value of this information is the
target user plane latency. The SMF uses this value to ensure the user plane
latency between the UE to the PSA-UPF. The SMF uses this value to decide
whether to relocate the PSA-UPF to satisfy the user plane latency after the
potential relocation.
\- Shortest user plane latency preference: This indicator is sent by the AF to
the SMF to denote AF preference for the shortest user plane latency, so that
the SMF (re-)selects the PSA-UPF with the minimum user plane latency when
(re-)selecting the PSA-UPF (or UPF).
2\. This step is the same as the step 2 of Figure 4.3.6.2-1 in TS 23.502 [3]
clause 5.2.6.7.
3\. This step is the same as the step 3 of Figure 4.3.6.2-1 in TS 23.502 [3]
clause 5.2.6.7.
4\. This step is the same as the step 4 of Figure 4.3.6.2-1 in TS 23.502 [3]
clause 5.2.6.7.
5\. This step is the same as the step 5 of Figure 4.3.6.2-1 in TS 23.502 [3]
clause 5.2.6.7. For your information, the related information (i.e. AF
influenced Traffic Steering Enforcement Control and Traffic Steering
Enforcement Control) in PCC rules are defined in TS 23.503 [4] clause 6.3.1.
In addition with the existing PCC information, the maximum allowed user plane
latency and/or the shortest data path delay preference is/are sent to the SMF.
6\. When a PCC rule is received from the PCF, the SMF may take appropriate
actions to reconfigure the User plane of the PDU Session as describes in the
step 6 of Figure 4.3.6.2-1 in TS 23.502 [3]. After this step, when the UE
performs handover or moves across the Area Of Interest related with DNAI, the
SMF decides whether to re-selects the PSA-UPF. When considering PSA-UPF
relocation, the SMF chooses the PSA-UPF satisfying the user plane latency or
the PSA-UPF with the shortest user plane latency among multiple PSA-UPFs.
### 6.35.3 Impacts on services, entities and interfaces
The following 5GC Control Functions are impacted:
\- SMF: The SMF decides to re-select UPF based on the user plane latency
requirements.
\- NEF: The NEF should support the new parameters (i.e. user plane latency
requirements).
\- PCF: The PCF should support new parameters in PCC rule.
\- AF: EAS and EES acts as AF can use this new capability.
## 6.36 Solution #36: Edge relocation considering user plane latency
requirement (AF decision)
### 6.36.1 Description
This solution shares the same architecture assumptions as described in the
solution #35. In the solution #35, the SMF decides to relocate PSA-UPF
relocation based on information of the AF request.
In contract with the solution #35, the 5GC allows AF to decide relocation
based on the estimated user plane latency in this solution. With this
solution, it is possible that the application context relocation should be
performed together with PSA-UPF relocation.
### 6.36.2 Procedures
The first procedure is the same as the existing procedure defined in the TS
23.502 [3] clause 4.3.6.2 with additional parameters sent by AF and required
SMF behaviour.
Figure 6.36.2-1: AF request for user plane latency
1\. The AF (e.g. EAS or EES) decides to send AF traffic influence request with
the subscription request for UP event notification described in TS 23.501 [2]
clause 5.6.7.1 and \"AF acknowledge to be expected\" described in TS 23.501
[2] 5.6.7.2. In this solution, the subscription request may include the
request for the report of the estimated user plane latency for corresponding
target DNAI(s).
2\. This step is the same as the step 2 of Figure 4.3.6.2-1 in TS 23.502 [3].
3\. This step is the same as the step 3 of Figure 4.3.6.2-1 in TS 23.502 [3].
4\. This step is the same as the step 4 of Figure 4.3.6.2-1 in TS 23.502 [3].
5\. This step is the same as the step 5 of Figure 4.3.6.2-1 in TS 23.502 [3].
For your information, the related information (i.e. AF influenced Traffic
Steering Enforcement Control and Traffic Steering Enforcement Control) in PCC
rules are defined in TS 23.503 [4] clause 6.3.1. In addition to the existing
PCC information, in this solution, the request for the report of estimated
user plane latency for corresponding target DNAI(s) is sent to the SMF.
6\. This step is the same as the step 6 of Figure 4.3.6.2-1 in TS 23.502 [3]
clause 5.2.6.7. With this step, the SMF is configured with the AF notification
trigger condition.
The second procedure as described in the Figure 6.36.2-2 is performed when the
SMF detects that the AF notification trigger condition is met. This procedure
is the similar to the existing procedure defined in the TS 23.502 [3] clause
4.3.6.3 with additional parameters and the corresponding behaviour of each
NFs.
Figure 6.36.2-2: AF decision on application relocation based on the user plane
latency
1\. This step is corresponding to step 1 of Figure 4.3.6.3-1 in TS 23.502 [3]
with following additions. If the SMF detects trigger condition for user plane
path change event and if the SMF is configured to report the estimated user
plane latency information per DNAI(s), the SMF sends the target DNAI(s) and
their estimated user plane latency information between the UE and the PSA-UPF
corresponding to the target DNAI.
NOTE 1: It is assumed that the SMF can calculate the estimated user plane
latency either by its local computation or by NWDAF.
NOTE 2: How the estimation can be done either by SMF local
computation/configuration or by using the estimation of the user plane latency
from NWDAF. It is outside scope of this study.
2\. This step is corresponding to the early notification as described in the
step 2a, 2b (via NEF) or 2c (directly to AF) of Figure 4.3.6.3-1 in TS 23.502
[3].
3\. When receiving the early notification via NEF or directly from SMF, the
EAS (or EAS) acting as AF decides whether to relocate the application context
to target EES (or EAS) with considering the estimated user plane latency. The
EAS (or EAS) decides to relocate the application context to target EES (or
EAS). If the estimated user plane latency between the UE and the PSA-UPF
corresponding to the target DNAI does not satisfy the required user plane
latency, the EES (or EAS) does not perform application (context) relocation.
4\. This step is corresponding to the Nnef_TrafficInfluence_AppRelocation_Info
service operation as described in the step 2d and 2e of Figure 4.3.6.3-1 in TS
23.502 [3]. If the AF (i.e. EES or EAS) decides the application (context)
relocation and the PSA-UPF relocation is needed, it sends the positive
response to the SMF (either via NEF or directly). Otherwise, the AF sends the
negative response to the SMF.
5\. This step is corresponding to the step 3 of Figure 4.3.6.3-1 in TS 23.502
[3].
6\. This step is corresponding to the late notification as described in the
step 4a and 4b (via NEF) or 4c (directly to AF) of Figure 4.3.6.3-1 in TS
23.502 [3].
7\. This step is corresponding to the Nnef_TrafficInfluence_AppRelocationInfo
service operation as described in the same as the step 4d and 4e (via NEF) or
4f (directly to SMF) of Figure 4.3.6.3-1 in TS 23.502 [3].
### 6.36.3 Impacts on services, entities and interfaces
The following 5GC Control Functions are impacted:
\- SMF: The SMF is enhanced to provide the estimated user plane information to
the AF either directly or via (NEF).
\- NEF: The NEF is enhanced to support the new parameter for AF request and
AppRelocationInfo.
\- PCF: The PCF should support new parameters in PCC rule.
\- AF: EAS and EES acting as AF is able to decide the application (context)
relocation by using this new capability.
## 6.37 Solution #37: AF-based EAS End-Point-Address update via External
Parameter Provisioning
### 6.37.1 Description
This solution addresses Key Issue #2: Edge Relocation.
In this solution the PCF gets updated EAS End-Point Address information from
AF when Applications are migrated, or End-Point address are re-allocated. The
AF communicates this to the PCF via a NEF Service Specific Parameter
Provisioning operation. The AF pushes the new (i.e., changed) EAS End-Point
Address to the UDR via the NEF. If the NEV Service Specific Parameter
provisioning procedure is successful as described in TS 23.502 [3], clause
4.15.6.7, the UDR notifies the NF (e.g., the PCF) the new EAS End-Point
Address information.
When the PCF decides to update UP policies to reflect the EAS end-point
change, the PCF determines whether the UE supports EAS End-Point Address push,
based on the UE capabilities provided during the establishment of the relevant
PDU Session, and whether the new EAS End-point Address should be pushed to the
UE or it can wait. The PCF may, in addition to current considerations outlined
in TS 23.502 [3], clause 4.2.4.3 (UE Configuration Update procedure for
transparent UE Policy delivery) take into account, whether the application and
the particular UE context (e.g., UE location) warrants an immediate update, or
the update can be delayed till the UE contacts the 5GC again, e.g., through a
Mobility Registration procedure.
As an alternative, in this solution the SMF gets updated EAS End-Point Address
information from the AF when Applications are migrated, or End-Point address
are re-allocated. The AF communicates this to the SMF via a NEF Specific
Parameter Provisioning Service. The AF pushes the new (i.e., changed) EAS End-
Point Address to the UDM via the NEF. If the External Parameter provisioning
procedure is successful as described in TS 23.502 [3], clause 4.15.6.2, the
UDM notifies the NF (e.g., the SMF) the new EAS End-Point Address information.
The SMF determines whether the new EAS End-point Address should be pushed to
the UE or it can wait. If the information should be pushed to the UE, the SMF
provides the information to the UE using PDU Session modification procedure as
described in TS 23.502 [3], clause 4.15.6.2.
### 6.37.2 Procedures
#### 6.37.2.1 EAS-End Point update via Service Specific information
Provisioning Procedures
EAS-End Point update via an Service Specific information Provisioning
Procedure
Figure 6.37.2.1-1: Service Specific Information Provisioning
0c. [Conditional] The SMF request the establishment of a SM Policy Association
and if provided by the UE, the SMF may indicates whether the UE is capable of
supporting EAS-End-Point-Address push. If the UE supports EAS-End-Point-
Address push, the PCF may subscribe notification of EAS-End-Point-Address
changes.
1\. The AF (e.g., the EAS) determines that a EAS-End-Point-Address update is
required. The AF, e.g. using UE location information obtained through
monitoring events provided by the 5GC, chooses an appropriate DNAI in
accordance to the needs of the service and it invokes a
ServiceParameter_Create operation to provide the new EAS_End-Point address, in
addition to other Service Parameters already specified in TS 23.502 [3],
clause 4.15.6.7.
2 to 6. According to TS 23.502 [3], clause 4.15.6.7.
If the PCF has decided that the EAS End-point Address should be pushed, the
PCF uses a UE Configuration Update mechanism to do so as outlined in fig.
6.37.2-2.
UE Configuration Update Procedure
Figure 6.37.2.1-2: UE Configuration Update procedure for access and mobility
management related parameters
0a. The PCF receives a notification from the UDR to indicate that the EAS End-
Point Address associated to a particular PDU Session has changed.
0b. [Conditional] The SMF decides to update UE configuration or trigger UE re-
registration to push the new EAS End-Point Address information. The SMF may
take the Application characteristics and a particular UE context to decide
whether an immediate update is required, or it can wait till the UE re-
reregisters.
1-3 Same as in TS 23.502 [3], clause 4.2.4.3.
3a. Upon receipt of UE policies, the new EAS End-Point Address, and
corresponding Application ID, are delivered to the UE upper layers.
4-5 is the same as TS 23.502 [3], clause 4.2.4.3 (UE Configuration Update for
transparent UE Policy delivery).
#### 6.37.2.2 EAS-End Point update via SMF-associated parameters Provisioning
Procedures
Figure 6.37.2.2-1: External Parameter Provisioning
0\. [Conditional, SMF may subscribe to EAS-End-Point-Address changes] A NF
can, e.g., through the AMF, subscribe to UDM notifications.
0a-to 0c. According to TS 23.502 [3], clause 4.15.6.2.
0d. [Conditional] The AF (e.g., the EAS) determines that a EAS-End-Point-
Address update is required. The AF, e.g. using UE location information
monitoring information provided by the 5GC, chooses an appropriate DNAI in
accordance to the needs of the service.
1\. This step is according to TS 23.502 [3], clause 4.15.6.2, with the
following addition:
\- If the NF is SMF, and if the SMF decides the UE supports EAS End-Point
Address push based on the UE capabilities provided during the establishment of
the relevant PDU Session and the new EAS End-point Address should be pushed to
the UE, the SMF provides EAS End-point-address to the UE using PDU Session
modification procedure as described in TS 23.502 [3], clause 4.15.6.2 and
clause 4.3.3.
2 to 7. According to TS 23.502 [3], clause 4.15.6.2.
### 6.37.3 Impacts on services, entities and interfaces
The proposed solution foresees impacts on the following Nodes or/and
Functionality:
AF:
\- The AF determines that an EAS-End-Point-Address information update is
required and it informs the 5GC using the Nnef_Parameter_Provision service
operation.
PCF:
\- Subscribes to EAS End-Point Address change. Using the Nudm_SDM_Subscribe
request service operation;
\- Upon receipt of a Nudm_Notify notification service operation, indicating
EAS End-point Address change, the PCF decides to update the policy using a UCU
procedure.
\- The PCF may use application information and UE context to decide when UE
Policy update is triggered
SMF:
\- Subscribes to EAS End-Point Address change. Using the Nudm_SDM_Subscribe
request service operation;
\- Upon receipt of a Nudm_Notify notification service operation, indicating
EAS End-point Address change, the SMF decides to provide the information to
the UE using PDU Session modification procedure.
UE:
\- The UE receives the EAS End-Point Address information in the NAS Layer and
delivers it to the application layer. Impacts to NAS layer, OS layer and
application are foreseen, so as in their interfaces.
\- The application layer in the UE replaces or sets the new EAS-Point Address
(e.g., using the FQDN provided in the EAS End-Point address information)
received from the AF (through the 5GC system).
## 6.38 Solution #38: EAS change with reducing packet loss in uplink
### 6.38.1 Description
The proposal solution addresses the KI#2: Edge relocation, in particular on
potential improvements of the coordination of change of the Edge Application
Server and (local) PSA to support seamless change, e.g. preventing or reducing
packet loss.
The procedure of \"Change of additional PDU Session Anchor for IPv6 multi-
homing or UL CL\" was defined in clause 4.3.5.6 of TS 23.502 [3]. It can
happen after e.g. Xn based handover and UL CL has changed. During the
procedure, the on-fly uplink packets, from UL CL to source PSA and source EAS
, which are to be sent to N6 or are being transmitted over N6, may be lost if
the source EAS stops to handle packets during EAS relocation before all
packets are received by the source EAS.
NOTE 1: This solution assumes the UE related contexts, including application
layer contexts and transporting layer contexts (e.g. TCP), if any, can be
transferred from old EAS to new EAS by EAS relocation mechanisms, to ensure
the packets can be handled seamlessly by the new EAS to avoid service
interruption. The solution assumes the packet with original EAS IP address can
be handled by the new EAS after the relocation of the EAS server application,
this can be achieved e.g. with use of Anycast EAS IP address or by design of
EAS to allow it to handle IP address targeting to a different EAS of same
service, but details are out of scope of 3GPP.
NOTE 2: This solution also applies to relocation of those EASs using
forwarding tunnel from target UL CL to source UL CL after simultaneous change
of UL CL/L-PSA as described in clause 4.3.5.7 of TS 23.502 [3]. To avoid
impact on service continuity, this solution proposes to enhance the procedure
to support preventing or reducing packet loss with the following mechanism: UL
packets are buffered in the target PSA until the target EAS is ready to handle
the incoming application traffic.
Furthermore, this solution proposes to perform one of two options to enable
in-order packet delivery:
**Option 1:**
Establish a forwarding tunnel between source PSA and target PSA to avoid loss
of uplink packets that are transferring between (target) UL CL and source PSA.
SMF may also instruct (target) UL CL to send an End Maker between (target) UL
CL - source PSA - target PSA to ensure in-order UL transferring on target PSA.
This option can ensure packet lossless and in-order delivery within 5GS.
**Option 2:**
Introduce an AF-defined Flow End Maker between (target) UL CL and source local
DN/EAS to trigger EAS relocation. With that, it can be guaranteed that no
uplink packets sending over the old path before the EAS relocation starts. As
other user plane packet, the Flow End Marker should be a user plane packet
with EAS IP as the destination IP address.
This option can ensure packet lossless between UE and EAS, including N6
interface.
### 6.38.2 Procedures
#### 6.38.2.1 Procedures for preventing packet loss in uplink with change of
additional PSA
Based on the procedure specified in clause 4.3.5.6 of TS 23.502 [3], Figure
6.38.2.1-1 illustrates the procedure of edge relocation with preventing packet
loss and in-order packet delivery in uplink.
Figure 6.38.2.1-1: Procedure of preventing packet loss in uplink
If seamless Edge relocation is needed, the AF influence traffic routing is
enhanced to indicate the \'seamless Edge relocation\' requirement (i.e.
including a \'seamless Edge relocation\' indication) to PCF. The PCF generates
a PCC rule(s) based on the AF request and the PCC rule(s) sent to the SMF
includes the \'seamless Edge relocation\' indication.
For Option 1, if seamless Edge relocation is needed, the SMF binds the
application flow to a dedicated QoS Flow.
1\. The SMF decides to change the local PSA of a PDU Session with UL CL.
2\. The SMF sends an early notification to the AF after target PSA (i.e. PSA2)
is selected and waits for a notification response from the AF. The AF may
reply in positive to the notification of step 2a by indicating that buffering
of uplink traffic in the PSA2 is required if the \'seamless Edge relocation\'
indication was not set and the AF requests the same treatment on demand.
For Option 2, the response includes Flow End Marker information, which
contains an AF-defined Flow End Marker packet.
3\. The SMF configures the PSA2 as specified in step 2 in clause 4.3.5.6 of TS
23.502 [3], and indicates the PSA2 to buffer uplink traffic. PSA1 (i.e. source
PSA) keeps receiving downlink traffic from EAS1 and send it to the UE until it
is released in step 9.
For Option 1, the SMF also obtains the forwarding tunnel info from PSA2.
4\. For Option 1, the SMF sends an N4 Session Modification Request to the PSA1
to establish forwarding tunnel towards PSA2. The PSA1 starts to forward the
received uplink packets to the PSA2 via the tunnel.
5\. The SMF sends an N4 Session Modification Request to the UL CL to update
the UL CL rules regarding to the traffic flows that the SMF tries to move from
PSA1to PSA2. The N4 Session Modification Request message contains the
identifications of traffic filter that needs to be updated and the tunnel ID
of PSA2.
For Option 1, if an \'seamless Edge relocation\' indication is included in the
PCC rule, the SMF also indicates the UL CL to send End Marker per QoS Flow to
the PSA1 before it starts to forward the traffic to the PSA2 to ensure the
packets are in-order delivered from PSA2 to EAS2.
For Option 2, the SMF provides the Flow End Marker received in step 2 to the
UL CL and indicates the UL CL to send it to the PSA1 before it starts to
forward the traffic to the PSA2.
6\. For Option 1, if an \'seamless Edge relocation\' indication is included in
the PCC rule, the End Marker is sent from UL CL to the PSA1 then PSA2. When
the End Marker is received, the PSA2 knows that no more uplink packet from the
old path for the QoS Flow.
7\. For Option 2, the Flow End Marker is sent from UL CL to PSA1 then routed
to source Local DN/EAS as other user plane packets. When the Flow End Marker
is received, the source EAS knows that no more uplink packets from the UE. The
source EAS stops to handle packets and EAS relocation can be started.
8\. The SMF sends a Late Notification to the AF. When EAS relocation is
completed, the AF sends a notification response to the SMF.
9\. The SMF updates the PSA2 by indicating the PSA2 to send the buffered
uplink packets. The SMF releases PSA1.
For Option 1, the forwarded packets received before the End Marker packet will
be sent to EAS before those received directly from UL CL.
#### 6.38.2.2 Procedures for preventing packet loss in uplink with
simultaneous change of UL CL and additional PSA
Based on the procedure specified in clause 4.3.5.7 of TS 23.502 [3], Figure
6.38.2.2-1 illustrates the procedure of edge relocation with preventing packet
loss and in-order packet delivery in uplink.
Figure 6.38.2.2-1: Procedure of preventing packet loss in uplink
If seamless Edge relocation is needed, the AF influence traffic routing is
enhanced to indicate the \'seamless Edge relocation\' requirement (i.e.
including a \'seamless Edge relocation\' indication) to PCF. The PCF generates
a PCC rule(s) based on the AF request and the PCC rule(s) sent to the SMF
includes the \'seamless Edge relocation\' indication.
For Option 1, if seamless Edge relocation is needed, the SMF binds the
application flow to a dedicated QoS Flow.
1\. The SMF decides to change the UL CL and local PSA of a PDU Session.
2\. The SMF sends an early notification to the AF after target PSA (i.e. PSA2)
is selected and waits for a notification response from the AF. The AF may
reply in positive to the notification of step 2a by indicating that buffering
of uplink traffic in the PSA2 is required if the \'seamless Edge relocation\'
indication was not set and the AF requests the same treatment on demand.
For Option 2, the response includes Flow End Marker information, which
contains an AF-defined Flow End Marker packet.
3\. The SMF configures the PSA2 as specified in step 2 in clause 4.3.5.7 of TS
23.502 [3], and indicates the PSA2 to buffer uplink traffic. PSA1 (i.e. source
PSA) keeps receiving downlink traffic from EAS1 and send it to the UE until it
is released in step 12.
For Option 1, the SMF also obtains the forwarding tunnel info from PSA2.
4\. The SMF establishes Target UL CL (i.e. UL CL2) and an N9 forwarding tunnel
between the Source UL CL (i.e. UL CL1) and UL CL2 as specified in step 3 in
clause 4.3.5.7 of TS 23.502 [3].
5\. The SMF updates PSA0 for downlink traffic as specified in step 4 in clause
4.3.5.7 of TS 23.502 [3].
6\. The SMF updates RAN as specified in step 6 in clause 4.3.5.7 of TS 23.502
[3].
7\. For Option 1, the SMF sends an N4 Session Modification Request to the PSA1
to establish forwarding tunnel towards PSA2. The PSA1 starts to forward the
received uplink packets to the PSA2 via the tunnel.
8\. The SMF sends an N4 Session Modification Request to the UL CL2 to update
the UL CL rules regarding to the traffic flows that the SMF tries to move from
PSA1 to PSA2. The N4 Session Modification Request message contains the
identifications of traffic filter that needs to be updated and the tunnel ID
of PSA2.
For Option 1, if an \'seamless Edge relocation\' indication is included in the
PCC rule, the SMF also indicates the UL CL2 to send End Marker per QoS Flow to
the PSA1 before it starts to forward the traffic to the PSA2 to ensure the
packets are in-order delivered from PSA2 to EAS2.
For Option 2, the SMF provides the Flow End Marker received in step 2 to the
UL CL2 and indicates the UL CL2 to send it to the PSA1 before it starts to
forward the traffic to the PSA2.
9\. For Option 1, if a \'seamless Edge relocation\' indication is included in
the PCC rule, the End Marker is sent from UL CL2 to the PSA1 then PSA2. When
the End Marker is received, the PSA2 knows that no more uplink packet from the
old path for the QoS Flow.
10\. For Option 2, the Flow End Marker is sent from UL CL2 to PSA1 via ULCL1
then routed to source Local DN/EAS as other user plane packets. When the Flow
End Marker is received, the source EAS knows that no more uplink packets from
the UE. The source EAS stops to handle packets and EAS relocation can be
started.
11\. The SMF sends a Late Notification to the AF. When EAS relocation is
completed, the AF sends a notification response to the SMF.
12\. The SMF updates the PSA2 by indicating the PSA2 to send the buffered
uplink packets. The SMF releases PSA1.
For Option 1, the forwarded packets received before the End Marker packet will
be sent to EAS before those received directly from UL CL2.
### 6.38.3 Impacts on services, entities and interfaces
SMF:
\- Configure the target PSA to buffer uplink packets and to forward them when
EAS relocation is completed.
\- For Option 1, configure the source PSA to establish an N9 tunnel between
the target PSA to forward uplink traffic, and optionally, configure the
(target) UL CL to send End Marker when it stops to forward uplink packets to
the source PSA and configure the target PSA to send the packets to the target
EAS in-order based on the End Marker.
\- For Option 2, forward Flow End Marker received in PCC rules to the source
PSA.
UPF acting as a (target) UL CL:
\- For Option 1, optionally send the End Marker per QoS Flow to the source PSA
then target PSA before it starts to forward the traffic to the target PSA.
\- For Option 2, forward Flow End Marker received from SMF to the source PSA
then source Local DN/EAS before it starts to forward the traffic to the target
PSA.
UPF acting as a source PSA:
\- For Option 1, establish an N9 tunnel between the target PSA, and forward
uplink packets from (target) UL CL to the target PSA.
UPF acting as a target PSA:
\- Buffer uplink packets until EAS relocation is completed.
\- For Option 1, optionally send the packets to the target EAS in-order based
on the End Marker.
AF:
\- Optionally, include a \'seamless Edge relocation\' indication in the AF
request sent to the PCF.
\- Optionally, indicating that buffering of uplink traffic in the target PSA
is required in Early Notification response to SMF.
\- For Option 2, include Flow End Marker information in positive AF response
sent to the SMF.
PCF:
\- Optionally, include the \'seamless Edge relocation\' indication in the PCC
rule sent to the SMF.
## 6.39 Solution #39: EAS relocation coordinated with PSA change
This solution is for Key Issue #2 on Edge relocation.
### 6.39.1 Description
This solution addresses KI #2 and enables the change of PSA, in coordination
with the EAS relocation, by re-using some concepts of the MA-PDU session and
path-switching mechanism based on MPTCP that was defined during ATSSS study.
As defined in TS 23.501 [2], clause 5.32, the support of MA-PDU session is
enabled using MPTCP functionality, i.e. MPTCP on the UE and MPTCP Proxy on the
PSA. In summary, the UE and the UPF may establish 2 MPTCP sub-flows (or data
paths) from 2 different ANs (e.g. 5G and WiFi). The MPTCP Proxy on the UPF
establishes a TCP session with e.g. the destination server. DL data is sent
from the server to the UPF via the TCP session. The MPTCP Proxy uses one of
the MPTCP sub-flows to forward data to the UE. The same is done in the UL
direction, i.e. UE sends data using either of the MPTCP sub-flows and the
MPTCP Proxy forwards this data to the server via the TCP session. This is
illustrated in Figure 6.39.1.1-1 extracted from TS 23.501 [2], clause 4.2.10.
Figure 6.39.1-1: Non-roaming and Roaming with Local Breakout architecture for
ATSSS support
In this solution the ATSSS mechanism for MA-PDU session using MPTCP protocol
is enhanced to enable an MPTCP Session on the UE to be associated to multiple
PSAs (i.e. multiple MPTCP Proxys). Having a sub-flow with a first PSA1 and
then establishing another sub-flow, for the same MPTCP session, with a target
PSA2 enables the support of PSA change.
The Edge Application Server may be relocated as well due to UE mobility and
the change of PSA. In order to have a coordinated change of PSA and EAS, a 2
phases mechanism is proposed, i.e. a preparation and completion phase.
Coordinating the PSA change and EAS relocation allows an efficient relocation,
transparent to the UE\'s application layer.
Once the decision to change the PSA is taken in the network, the AF is
informed. Based on this information, a decision may be taken from an entity
out of the 3GPP scope to relocate the EAS. A first phase is defined where the
EAS relocation (e.g. select the target EAS, transfer UE\'s application
context, etc) is started. During this phase, the 3GPP network also prepares
the PSA change, e.g. selects the target PSA2, instantiates MPTCP Proxy if not
already running, transfers the UE\'s MPTCP context to the target PSA2, and
establishes a sub-flow between the UE and the target PSA2, etc.). This
preparation phase enables the last phase, i.e. the relocation completion, to
be finalized very quickly, without disturbing the data exchange.
The completion phase, (e.g. enabling the usage of the MPTCP sub-flow to the
target PSA2, establishment of a TCP session toward the target EAS, etc.) may
be triggered upon receipt of AF response to a Late Notification and it may
then finalize the PSA change and EAS relocation very quickly, without
disturbing the data exchange.
To align with the IETF MPTCP architecture, it is proposed that the UE that
supports MPTCP functionality is communicated with a virtual host with MPTCP
proxy functionality distributed in two PSA UPFs. In this solution, at the same
time, only one MPTCP subflow is used as a regular path to transmit user data
and the other one is used as a backup path.
Figure 6.39.1-2: MPTCP functionality in UE and MPTCP proxy functionality in a
virtual host in CN side
An MPTCP Control Block, as defined [27], contains variables that track the
progress and state of an MPTCP Session and a set of linked TCP control blocks
that correspond to the subflows that have been established. The MPTCP Session
context, transferred during the preparation phase, includes the variables to
track the progress and state of the MPTCP Session but does not include the
linked TCP control blocks as these are related to the subflows which remain on
the initial PSA1. i.e. are not transferred to the target PSA2.
The MPTCP Session context needs to be transferred on the target PSA2 during
the preparation phase to enable the creation of a new subflow from the target
PSA2 toward the peer UE. However, since data transfer has potentially
continued during the preparation phase, the MPTCP Session sequence number may
need to be updated at the completion phase, prior to start using the subflow
created from the target PSA2.
The receive window is transferred to the target MPTCP Proxy as part of the
MPTCP Context and is expected to be re-used by the target MPTCP proxy however,
its value may be modified on target PSA2 based on the target PSA2 capacities
(e.g. available memory for receive buffer). As specified in [27], the receive
window is sent with every packet thus the receiving UE may adapt to the new
value, if needed.
The MPTCP Session context transfer has no impact on MPTCP operations and
neither MPTCP architecture, i.e. starting a new subflow, data transfer over
subflows, closing a subflow, changing subflow priority, are not modified. It
is still possible to have one or multiple subflows associated to the same
MPTCP Session. The MPTPC Session transfer is transparent to the UE\'s
application layer.
### 6.39.2 Procedures
#### 6.39.2.1 PSA change and EAS relocation coordination
Figure 6.39.2.1-1 illustrates the procedure for PSA change and EAS relocation
coordination. It is assumed that the AF is interacting with the source and
target EASs, or with another entity interacting with those EASs. The AF then
interacts with 5GC NFs to coordinate the PSA change and EAS relocation.
Figure 6.39.2.1-1: PSA change and EAS relocation coordination
1\. UE establishes an MA-PDU session with MPTCP steering mode.
2\. UE is assigned with an IP address (IP\@2a), which is associated with PSA1,
to be used with MPTCP functionality. IP\@2a is allocated by PSA1, and provided
by the SMF via SM NAS message.
3\. An MPTCP sub-flow is created, using IP\@2a on UE\'s side. The MPTCP Proxy
on PSA1 establishes a TCP session with the EAS1. Data is exchanged from the UE
to the PSA1 over the MPTCP sub-flow. PSA1 forwards this UL data to the EAS1
over the TCP connection. The reverse is done in DL direction, i.e. EAS1 sends
data for the UE over the TCP connection with PSA1. MPTCP Proxy forwards this
data to the UE over the MPTCP sub-flow.
4\. UE moves. The preparation phase can be triggered by either SMF or AF.
a. SMF decides to insert/change UL CL and allocate another UPF/PSA2. The AF,
which has previously registered to UE mobility events, is informed that the UE
has moved and that a new PSA has been selected. This triggers the EAS
relocation preparation phase. AF informs SMF that EAS relocation is in
preparation phase.
b. The AF is informed of UE mobility through obtaining the information of UE
location. The AF triggers EAS1 relocation to EAS2.
The AF interacts with the source and target EASs, or to another entity
interacting with the EASs, to start the EAS relocation. EAS may stop or slow-
down data transmission. This is at the application level and specified only to
illustrate the relocation coordination. The interaction between the AF and
EASs is out-of-scope of 3GPP.
5\. If the preparation phase is triggered by AF, when the AF triggers the EAS
relocation, it also notifies the SMF with the new DNAI and EAS2 IP address.
SMF inserts/change UL CL and to allocate a new PSA2 based on the new DNAI.
NOTE: The AF may receive the target DNAI list from the SMF through early
notification before step 5b. An EAS may connect to a group of EASs within the
edge domain. The interaction of EASs is application specific and is out of the
scope of this specification.
6\. SMF interacts with PSA1 to obtain the MPTCP context related to the MPTCP
session with the UE. The MPTCP context includes e.g. security keys, tokens,
MPTCP session sequence number. Information related to the sub-flow on PSA1 is
not transferred to PSA2 since this sub-flow may not be used by PSA2.
7\. SMF provides the obtained MPTCP context and UE\'s PDU Session IP address
to the selected PSA2 for PSA change.
8\. SMF provides a new IP address (IP\@2b) to the UE which is associated with
PSA2. The IP address (IP\@2b) is allocated by PSA2.
9\. MPTCP Proxy on PSA2 receiving the already existing MPTCP context
establishes a new sub-flow with the UE, using IP\@2b. The sub-flow is created
using the MP_JOIN option with B=1, indicating to the UE that the subflow
should be treated as backup path and it should not be used to send data,
unless there are no usable subflows. The sub-flow is created in advance,
during the relocation preparation phase. At this point, UE has two sub-flows
associated to the same MPTCP session. The first sub-flow is with PSA1 and the
second sub-flow is with PSA2.
10\. AF informs the SMF that the EAS relocation is completed and provides the
information to reach the target EAS. This triggers the relocation completion
phase. SMF interacts with PSA1 to obtain the latest information related to
data transfer (e.g. MPTCP sequence number). SMF informs PSA2 to complete the
PSA change. SMF provides PSA2 with the information to reach the target EAS and
provides the latest information from PSA1. SMF also informs PSA1 to complete
the PSA change and the MPTCP Proxy on PSA1 updates the MPTCP sub-flow\'s
priority by cleanly retiring its use using the \"REMOVE_ADDR\" option
indicating that this sub-flow shall not be used or terminates the sub-flow.
The MPTCP session may be silently discarded on PSA1, allowing the UE to
preserve the MPTCP session.
11\. PSA2 establishes a TCP session with the target EAS. This TCP session is
associated with the MPTCP session and sub-flow toward IP\@2b.
12\. MPTCP Proxy on PSA2 completes the change of PSA by changing the MPTCP
sub-flow\'s priority MP_PRIO option with B=0. This means that the UE may start
using this sub-flow.
13\. SMF informs the AF that UE\'s PSA change is completed.
### 6.39.3 Impacts on services, entities and interfaces
SMF:
\- Send PSA relocation indication to AF.
\- Receive EAS relocation preparation completed indication from AF.
\- Send PSA relocation preparation to UPF.
\- Send PSA relocation completion to UPF.
\- Query UPF/PSA to get MPTCP Session context.
\- Send MPTCP session context to target UPF/PSA.
\- SMF assigns new subflow address/prefix for PSA2.
\- Decide whether allow a MPTCP PDU Session for the UE based on the UE\'s
capability and the requested (S-NSSAI, DNN) or local policy.
UPF acting as a source local PSA:
\- Provide MPTCP Session context to SMF.
\- Terminate the initial sub-flow with the UE when PSA relocation is
completed.
UPF acting as a target local PSA:
\- Save MPTCP Session context locally.
\- Create a new \"backup\" MPTCP sub-flow to be associated with the saved
MPTCP Session.
\- Change MPTCP subflow\'s priority using MP_PRIO option B=0 to activate the
MPTCP subflow.
UE:
\- Handle one IP assignment for subflow toward PSA1 at establishment of MPTCP-
enabled PDU Session and another IP assignment for the second subflow towards
PSA2.
\- Support MPTCP and interactions with MPTCP Proxy functionality in UPF.
\- Indicate its MPTCP capability in the PDU Session establishment request.
## 6.40 Solution #40: Seamless change of Edge Application Sever for stateful
applications by caching application status information in NEF
### 6.40.1 Description
This solution is for key issue#2, which addresses Edge relocation related to:
Evaluate and determine whether and how seamless change of Edge Application
Server can be enabled considering:
\- Different Edge hosting models described in the key issue #1.
\- Stateful and Stateless applications.
This solution proposes a solution to support seamless change of Edge
Application Sever for stateful applications by caching application status
information in NEF.
There are some pre-assumptions for this solution.
\- A NEF may be deployed at the edge of the network, and the NEF\'s service
area cover multiple EASs.
\- AF is an entity to support the control plane communication between EAS and
5GS (i.e. NEF). Therefore one AF may related with one or more EAS(s) and the
communication between AF and EAS(s) is out of 3GPP scope. In this solution ,
one AF is responsible for one EAS.
\- The stateful applications are deployed both on the Source-EAS(S-AF from
control plane perspective) and Target-EAS(T-AS from control plane
perspective).
\- AF has the knowledge that which applications is stateful and the service
continuity should be guaranteed. AF can also know which applications is
currently visited by UE through application layer communication.
In this solution, NEF is pre-configured with relationship between DNAI and AF
address, may also including EAS address. Therefore the NEF has the whole
picture of which AF/EAS is close to the local PSA UPF, and suitable AF can be
selected for retrieving and configuring applications status information.
Firstly the S-AF will subscribe the user plane management event notification
as described in TS 23.502 [3] clause 4.3.6.2. Then UE mobility may trigger the
PSA UPF relocation, which is controlled by SMF, and the serving EAS/AF may
also change for low latency requirement.
SMF will send the early notification to NEF according to the S-AF request. In
this early notification, the UE ID , DNAI of T-UPF, and UE IP address can be
sent to NEF. When NEF gets the early notification, the NEF will be triggered
to retrieve stateful application status information from S-AF. The S-AF
retrieves application status information from S-EAS based on UE ID (e.g.
GPSI), UE IP address and AF local configuration. The application status
information are cached in NEF. The status information may include: UE GPSI, UE
IP address @ S-UPF, application ID, application address @ S-EAS, application
context.
After UPF relocation procedure, SMF will send the late notification to NEF,
including UE ID, DNAI corresponding to T-UPF, UE IP address\@T-UPF. The late
notification triggers NEF to send the application status information cached
from S-AF, to configure in T-AF, which is selected based on UE GPSI, and DNAI
of Target UPF. The application status information may be updated by NEF before
sent to T-AF. The update includes changing UE IP address from \@S-UPF to
\@T-UPF.
### 6.40.2 Procedures
The relocation mechanism of Edge Application Sever for stateful applications
is described in Figure 6.40.2-1.
Figure 6.40.2-1: relocation mechanism of Edge Application Sever for stateful
applications
0\. Source AF subscribes to NEF for user plane management event
notifications(both early and late notification) and request application status
caching. If NEF gets the application status caching indication, the NEF can
retrieve the application status from Source AF, based on SMF\'s early
notification.
NOTE 1: AF may subscribe to NEF for stateful application relocation with
specific Application ID, while for other stateful or stateless applications,
this application relocation method cannot be used and service continuity is
depending on application layer.
1\. Due to UE mobility, the UPF is relocated and SMF sends a notification via
NEF to Source AF according to the AF request. SMF notifies the NEF of the DNAI
of the T-UPF, UE IP address\@S-UPF, SUPI, by invoking
Nsmf_EventExposure_Notify service operation.
2-3. The NEF retrieve the application status from Source AF. When the NEF
receives Nnef_TrafficInfluence_AppRelocationInfo, the NEF triggers to cache
the corresponding application status information per UE per PDU session if
included. The information may include: UE GPSI, DNAI of the T-UPF ,UE IP
address @ S-UPF, application ID, application address @ S-EAS, application
context.
NOTE 2: If no edge application server relocation is triggered, the application
status information will not be included in the
Nnef_TrafficInfluence_AppRelocationInfo message.
4\. The NEF reply the SMF\'s early notification.
5\. SMF enforces the change of a UPF.
6\. SMF sends the late notification to NEF with DNAI of the T-UPF, SUPI, UE IP
address\@T-UPF, by invoking Nsmf_EventExposure_Notify service operation.
7\. When the NEF receives Nsmf_EventExposure_Notify, NEF find the T-AF/EAS
based on DNAI of the T-UPF, and NEF also find the application status
information per UE per PDU session based on UE GPSI, DNAI of T-UPF. NEF can
update the application status information by changing UE IP address from
\@S-UPF to \@T-UPF.
NEF send the Nnef_EventExposure_Notify to T-AF with the application status
information.
8\. Target AF retrieves the corresponding application based on the application
id in the received application status information, and configure the
corresponding application context. Then Target AF replies to NEF.
9\. NEF receives Nnef_TrafficInfluence_AppRelocationInfo, the NEF triggers the
appropriate Nsmf_EventExposure_AppRelocationInfo message.
10\. When UE begin to re-visit the application, the application will continue
from the last time the UE accessing the application in Source AF.
### 6.40.3 Impacts on services, entities and interfaces
NEF:
\- Pre-Configured with the relationship between DNAI of local PSA UPF and
AF/EAS.
\- Caches application status information, UE ID, UE IP address when AF
provides.
\- Sends application status information to AF.
\- Receives early and late notification from SMF to retrieve application
status from specific AF.
AF:
\- Provides indication for application status caching to NEF.
\- Provides application status to NEF.
\- Receives the application status from NEF, find specific application status
and configure the corresponding application.
SMF:
\- Sends early and late notification to NEF to trigger NEF caching application
status information.
## 6.41 Solution #41: Network Information Provisioning using the IP path
### 6.41.1 Solution description
The solutions address Key Issue #3: Network Information Provisioning to Local
Applications with low latency.
This solution uses ECN and later L4S to provide information about network
status to the UE and AS.
The advantage of using ECN or L4S are that they are not 3GPP access specific
but can be used by any access.
One of the key causes of latency in the network are queues. This fact is
recognized by IETF draft draft-ietf-tsvwg-l4s-arch-06 [18], and referenced
document in the draft. RAN, UPF and routers all have queues that can build up
during high load of the network. To get low latency for EC traffic, the queue
length needs to be held short.
#### 6.41.1.1 Use of IP based congestion notification
Traffic that requires low latency will have their own QoS flow, e.g. QoS flow
with 5QI=80. RAN will not admit more traffic than what it expects it can
handle without getting the low latency traffic to be congested. Congestion in
this sense will mean that RAN cannot sustain the required latency because of
rare unforeseen events, like e.g. interference or fading. To provide fast
information (feedback) with low latency, RAN will use ECN, which is a very
fast indication to the endpoints that the network has trouble fulfilling the
required characteristics (latency vs. bandwidth). See TS 38.300 [16] and RFC
8311 [17].
By ECN, the application is immediately notified of any potential congestion
(of this low latency traffic), and the application can adjust its flow
accordingly.
The endpoints can make use of other back off algorithms than standard TCP,
e.g. DCTCP. DCTCP and other scalable TCP-like methods have known compatibility
issues with classic TCP when sharing the same queue, but separate queues can
be employed in RAN for TCP and DCTCP if decided to be supported. A streaming
application may use RTP. Here RTP receiver can take ECN into consideration
when sending RTCP feedbacks to the source See RFC 8311 [17].
NOTE: Endpoints that do not support ECN will have to be informed by packet
drops about a congested situation. For TCP this will lead to that the dropped
packet needs to be re-sent.
IETF is working on improving ECN the L4S as with will improve the
characteristics of ECN.
L4S is best described in IETF draft draft-ietf-tsvwg-l4s-arch-06 [18], and
IETF draft draft-ietf-tsvwg-ecn-l4s-id-10 [19].
L4S utilizes a separate queue for L4S traffic to support co-existence with
classic ECN.
L4S Uses ECN bits in the IP header, but the setting of the EC (Explicit
Congestion) code points does not mean congestion as for classical ECN. It
rather means queues are getting longer, the longer a queue the more frequent
notifications in the EC codepoint allowing endpoints to adjust their BW based
on the frequency. This will result in queues for L4S traffic not to build up.
See IETF draft draft-ietf-tsvwg-ecn-l4s-id-10 [19].
### 6.41.2 Procedures
#### 6.41.2.1 Example, use of ECN with TCP
Figure 6.41.2.1-1: Use of ECN with TCP
0\. PDU session is established to low latency Edge Computing DNN. A QoS flow
for ECN traffic is established.
1\. An ECN capable TCP connection is established by UE and EAS indicating ECN
support to each other.
2\. Application traffic over TCP.
3\. RAN in 5GS detect incipient congestion on the e low latency QoS flows and
starts to indicate congestion on these QoS flows (how and when RAN detect
incipient congestion RAN implementation specific).
4\. The EAS sends an IP packet towards the UE. The packet will travel
trough5GS.
5\. When IP packet is received in RAN, RAN congestion (CE) marks the packet.
6\. The TCP stack in UE feedbacks the indicated congestion to the EAS.
7\. EAS reduces its traffic towards the UE.
### 6.41.3 Impacts on services, entities and interfaces
UE, AS and NG-RAN implementations need to support ECN. Applications may need
to be able to use the feedback provided by IP protocol layer.
NOTE: No further updates of the RAN specifications are expected as a result of
the EC study. Any further specification enhancements are expected to be driven
by other studies.
UE:
\- Support marking and feedbacks the indicated congestion to the EAS.
## 6.42 Solution #42: Providing selected radio information to an App requiring
it
### 6.42.1 Description
#### 6.42.1.1 Overview
This solution addresses Key Issue #3: Network Information Provisioning to
Local Applications with low latency.
An APP (Local Application) running on a network edge EAS may need information
that are determined/known in NG-RAN, e.g.:
\- Information on current available Radio conditions for the UE e.g. UE Radio
conditions, RSRP, Radio Throughput, RAN DL (PDCP) buffer in overflow status.
\- PLMN information, which contains data about the underlying mobile network
that the APP is actually using to exchange traffic with the UE.
\- UE location information.
\- etc.
APP(s) running on the network edge EAS need such data and/or Events in (near)
Real Time.
The solution does not consider the App configuring a NG RAN, just the App
retrieving information about an UE served by a NG RAN.
For this release, per the constraint expressed in the FS_enh_EC Study Item, no
RAN protocol modification is allowed thus in order to be able to provide
useful RAN information about the UE, the best solution is to get RAN
information that the management system can currently report.
This solution is based on following principles:
\- it is not expected that raw information handled by the NG RAN (or by MnS
producer for NG RAN) is directly provided to the APP as the network may want
to protect / hide sensitive information: an intermediate entity (the local
NEF) is needed to run policies on RAN related information being exposed to the
APP;
\- the APP may only know how to address the UE over the DN (addressing
information the APP uses to reach a UE e.g. the UE IP address + N6 tunnelling
information) and is not expected to know the SUPI of the UE;
\- the APP does not know and is generally not willing to know which NG RAN
entities currently serve the UE; furthermore, it generally does not want to be
bothered with Hand-Over information;
\- the solution strives to reuse as much as possible existing 3GPP mechanisms:
\- 3GPP Rel-16 specifications allow an AF (Application Function) managing the
EAS (Edge Application Server deployed locally to support Edge Computing) to
subscribe to notifications of UE \"UP path change\" where it can get the
mapping between addressing information to reach a UE and the 5GC identifier of
this UE e.g. SUPI;
\- The actual APIs that allow the APP to request information from the EC AF
(AF dedicated to Edge Computing) is considered not to be under scope of SA
WG2.
At high level the solution works with following high-level steps:
1\. The UE invokes an APP running on an EAS;
2\. The APP requests (RAN) information about a UE, providing what it knows
about the UE i.e. addressing information to reach a UE (e.g. the UE IP address
+ N6 tunnelling information) as well as the APP URI where it expects to
receive such (RAN) information.
This APP request is handled by the EC (Edge Computing) AF.
3\. The EC AF determines a local NEF based on the EAS source of the request
and determines the SUPI/ GPSI of the UE based on UE addressing information:
\- The EC AF terminates the Nnef_TrafficInfluence_Notify API (API as defined
for Rel-16 in TS 23.502 [3] clause 5.2.6.7); the EC AF can thus map addressing
information to reach a UE into the SUPI or the GPSI of this UE;
\- the EC AF is thus assumed to be operated by the PLMN while the App and the
EAS (data centre) may be operated by a third party.
4\. The EC AF Configures a local NEF to get relevant information from MnS
producer for NG RAN and to answer to the APP request: the EC AF provides:
\- Data delivery information (proxying the application request thus providing
also the URI where the local NEF is to deliver the output information towards
the APP) needed by the local NEF to deliver the requested information via an
API to the APP;
\- the APP or EAS identity needed by the local NEF to determine the operator
policies related with data that the operator is willing to share with the EAS
/ Edge App;
\- information needed to get information (MnS output) from MnS producer (this
is further detailed in further sub- clauses as it may correspond to 2
different variants).
5\. The local NEF receives MnS API output from MnS producer (how it receives
MnS output is further detailed in further clauses as it may correspond to 2
different variants).
6\. (based on local policies related with the APP identity) The local NEF
makes any necessary control, filtering or parameter translation within the
information received from NG RAN.
7\. The local NEF sends the updated / filtered Requested RAN Info to the
target (determined using Data delivery information) i.e. to the App on the
EAS.
The solution thus introduces a local NEF which acts both as a NEF (sending
information to an APP) and invoke the MnS services provided by a MnS (SA WG5
defined) entity to receive OAM output information from NG RAN.
The EC AF and the local NEF are owned by the operator.
The local NEF is an entity specified by SA WG2 but that uses MnS services
defined by SA WG5 specifications to receive information from MnS producer in
NG RAN.
There are 2 variants of the solution depending on the way the local NEF
receives MnS output from MnS producer:
\- Variant relying on local NEF interrogating the MnS producer for usage of
MDT tracing, see clause 6.42.1.2;
\- Variant relying on local NEF interrogating the MnS producer for NG RAN.
These 2 variants differ on the way the local NEF interacts with NG RAN as a
MnS consumer of OAM information from NG RAN
NOTE: It is intended to only have one variant specified in Release 17.
#### 6.42.1.2 Variant relying on usage of MDT tracing
This variant relies on usage of Rel-16 defined MDT tracing.
A In high level step 4 of 6.42.1.1, the EC AF:
a) configures the local NEF to invoke MnS provided by a Trace Collection
Entity (that is to receive tracing output from NG RAN), and then to deliver
the collected information to the APP after proper filtering of the
information; this step (interface from central NEF to local NEF) is in scope
of SA WG2 and will require CT groups to define an API;
b) configures Tracing Requirement on the (SUPI of the) UE. To do so, the EC AF
acts as a MnS consumer (consumer of 5GS OAM tracing i.e. triggering the MnS
5GS OAM subsystem to initiate a MDT trace). Such Tracing Requirements are
configured in the UDM/UDR and passed by the 5GC to the NG RAN serving the UE
per existing signalling trace configuration defined in Rel-16 TS 23.501 [2]
clause 5.25.1, This step is meant to reuse SA WG5 Rel-16 specifications. Any
information on this step is only indicative (to show how the solution works)
and is not meant for any 3GPP specification change.
B In high level step 5 of 6.42.1.1, the local NEF invoke MnS provided by Trace
Collection Entity:
a) receives RAN REPORT corresponding to tracing requests handled by NG RAN.
For this purpose, the local NEF acts as a consumer of RAN REPORT NOTIFICATION
(SBA) defined by SA WG5 MnS framework. This step is meant to reuse SA WG5
Rel-16 specifications. Any information on this step is only indicative (to
show how the solution works) and is not meant for any 3GPP specification
change.
NOTE: The mechanism described in this solution is not expected to load
\"central OAM entities\" as the recipient of the RAN REPORT is the local NEF
and not \"central OAM entities\". The interface between TCE and the local NEF
is Service Based but defined by SA WG5 MnS framework. This solution relies on
a distributed TCE system deployed in the network and the operator allows
Tracing information be exposed to the local NEF and 3rd party.
3GPP Rel-16 specifications (TS 32.422 [35]) about streaming trace (especially
for MDT) are reused, allowing the EC AF to trigger Tracing via OAM.3GPP Rel-16
mechanisms to transfer Tracing (MDT) Requirements configured in the UE
subscriptions data (in UDM/UDR) to the NG RAN currently serving the UE are
reused \"as is\".
#### 6.42.1.3 Variant relying on local NEF interrogating the MnS producer for
NG RAN
NOTE 1: This variant is not pursued as it requires the EC AF to know which NG
RAN entities is currently serving the UE and to be bothered with Hand-Over
information
In this variant the local NEF directly contacts the MnS producer for NG RAN to
get the information requested by the App. To do so, it needs to be told which
MnS producer for NG RAN to contact and for which User ID;
A In high level step 4 of 6.42.1.1, the EC AF configures the local NEF to
collect information directly from the MnS producer for NG RAN:
a) the EC AF gets from the AMF (and subscribes to the AMF on) the identity of
the NG RAN currently serving the UE together with the NGAP identifier of the
UE over N2;
b) the EC AF Configures the local NEF with the requested information, the APP
identity, the URI where to deliver the filtered collected information, the
identity of the NG RAN to contact and the NGAP ID of the UE on the N2
interface of this NG RAN. The EC AF needs to update the local NEF when one of
following information changes: the identity of the NG RAN to contact or the
NGAP ID of the UE on the N2 interface of this NG RAN.
B In high level step 5 of 6.42.1.1:
a) the local NEF, acting as a MnS consumer, contacts the MnS producer for NG
RAN to fetch the Requested information providing the NGAP ID of the UE on the
N2 interface of this NG RAN as identifier of the UE.
NOTE 2: The interaction between local NEF and MnS for NG RAN is assume reuse
existing SA WG5 defined interface without additional requirements.
### 6.42.2 Procedures
#### 6.42.2.1 Variant relying on usage of MDT tracing
Figure 6.42.2.1-1: Variant relying on usage of MDT tracing
0a). (pre-requisite) the UE has established a PDU session (where traffic
offload may apply) and the EC (Edge Computing) AF has subscribed to the SMF
event \"UP path change\" as defined in TS 23.502 [3] clause 5.2.8.3.1.
0b). In the notification corresponding to the SMF event \"UP path change\" the
SMF provides (as defined in TS 23.502 [3] clauses 5.2.8.3.1 and 5.2.8.3.2) the
EC (Edge Computing) AF with:
\- Event ID, Notification Correlation Information, UE ID (SUPI and if
available GPSI), PDU Session ID, time stamp.
\- As it is for \"UP path change\", the notifications contain also:
\- The Target DNAI (corresponds to the Edge Environment that hosts edge
Application).
\- addressing information to reach a UE:
\- UE IP address / Prefix.
\- N6 traffic routing information.
NOTE 1: It is assumed that the EC AF is managed by the operator so that it can
receive the SUPI.
1\. The UE invokes an APP running on a EAS,
2\. The APP sends a request for information about the UE. The APP provides:
\- The Requested RAN Info Type (= e.g. request for throughput, UE location,
etc.). The request may correspond to a one-shot information GET or to a
SUBSCRIBE request to receive notifications
\- The target UE identified by addressing information to reach the UE on the
local N6 (which maps to the UE IP address / Prefix + N6 traffic routing
information of the notification in step 2).
\- a URI (Notification Target Address) where the APP wishes to receive the
corresponding notifications and possibly an NCI (Notification Correlation Id)
to help the APP to retrieve the proper APP context corresponding to the
notifications it will receive due to this request.
NOTE 2: The way for the UE to invoke the APP and for the APP sends requests
for information to the EC AF about a UE is out of scope of SA WG2.
3\. The EAS forwards the request to the EC AF (which is acting as manager of
the edge Computing deployments): the EC AF receives at least:
\- The Requested 5G RAN Info Type;
\- addressing information to reach the UE on the local N6;
\- Data delivery information that contains at least the Notification Target
Address / URI where the collected NG RAN related information is to be
delivered but may also contain a Correlation identifier (NCI);
\- the DNAI (to indicate the instance of Edge Environment); and
\- the APP or EAS identity.
The EC AF determines a local NEF based on the EAS source of the request and
determines the SUPI/ GPSI of the UE based on UE addressing information.
The EC AF determines / validates the APP identity provided in step 4 to the
local NEF: if the EAS is managed by the operator (and trusted), the APP
identity is the final APP identity as validated by the EAS; Otherwise the APP
identity is the EAS identity as validated by the EC AF.
NOTE 3: The mechanisms to validate the identity of the APP / of the EAS are
defined by SA WG3;
In this solution the EC AF is assumed to be owned by the operator (it receives
the SUPI) and to have access to (e.g. be configured with) a mapping from DNAI
to local NEF.
4a The EC AF configures the local NEF to receive tracing output from MnS
producer for NG RAN), and then to deliver the collected information to the APP
after proper filtering of the information: the EC AF invokes Create local NEF
reporting, providing the local NEF with the association between a Trace
Reference and:
Data delivery information (proxying the application request thus providing
also the URI where the local NEF is to deliver the output information towards
the APP) needed by the local NEF to deliver the requested information via an
API to the proper APP;
\- the APP or EAS identity needed by the local NEF to determine the operator
policies related with data that the operator is willing to share with the EAS
/ Edge App.
4b The EC AF asks 5GC for trace (Requested RAN Info Type, Trace Reference)
about the UE identified by its SUPI/GPSI.
This uses a Create MOI (as defined in TS 28.622 [36] and TS 32.422 [35]):
providing (Trace Reference , SUPI, TraceConsumer (URI of the Trace Reporting
MnS consumer for the streaming trace reporting = URI of the local TCE), Job
type (Immediate-MDT+Trace), TraceReportingFormat = Streaming). This step is
meant to reuse SA WG5 Rel-16 specifications. Any information on this step is
only indicative (to show how the solution works) and is not meant for any 3GPP
specification change.
4c. The Tracing Requirements are propagated via the 5GC to the NG RAN
currently serving the UE. If the UE moves between NG RAN(s) (Hand-Over), the
Tracing Requirements are provided to the new NG RAN serving the UE.
The Tracing Requirements are transferred to AMF as part of subscription data
per Rel-16 specs (as part of subscription data defined in Table 5.2.3.3.1-1 of
Rel-16 TS 23.502 [3]) and then transferred from AMF towards the NG RAN over
NGAP as defined in Rel-16 in TS 38.413 [39] and TS 23.501 [2] clause 5.25.1.
5 The local NEF receives tracing information from MnS producer for TCE defined
by SA WG5 MnS framework.
The TCE reports the captured Trace Records (defined in TS 32.423 [37], clause
5. \'Trace streaming format\'). This step is meant to reuse SA WG5 Rel-16
specifications. Any information on this step is only indicative (to show how
the solution works) and is not meant for any 3GPP specification change.
6\. (based on local policies related with the APP identity) The local NEF
makes any necessary control, filtering or parameter translation within the
information received from NG.
7\. The local NEF sends the updated / filtered Requested RAN Info to the
target (determined using Data delivery information) i.e. to the App on the
EAS.
### 6.42.3 Impacts on services, entities and interfaces
Impacts common to the 2 variants:
\- Addition of the local NEF in the architecture:
\- The local NEF is configured by the EC AF.
\- the local NEF acts as a consumer of OAM (MnS) information that translates
this information into Notifications sent to the configured URI (of the App).
\- The local NEF is to apply operator policies to NG RAN information sent to
the EAS / App. and acts as:
\- Upgrade of the role of the EC related AF: this AF is based on an App/EAS
request to determine and configure a local NEF.
Impacts of the Tracing variant:
\- the EC related AF, acting as a MnS client is to request tracing from MnS
producer for TCE. No 3GPP SA WG5 specification change is meant. The tracing
variant does NOT require any interaction with SA WG5 as Rel-16 SA WG5
specifications are reused \"as is\".
Impacts of the Variant relying on local NEF interrogating the NG RAN:
\- The AMF supports a new event id corresponding to the reporting of the
identity of the NG RAN currently serving the UE together with the NGAP
identifier of the UE over N2.
\- the EC AF is able to derive the URI where MnS services of the MnS producer
for NG RAN may be invoked from the N2 identity of this NG RAN.
The reporting mechanism does not require RAN (NGAP or air interface) change
and MnS producer for NG RAN change.
## 6.43 Solution #43: Low Latency exposure API by using the distributed CAPIF
framework feature
### 6.43.1 Introduction
This solution addresses KI#3 and proposes as solution for low latency exposure
of RAN QoS information e.g. latency/packet delay and congestion condition. The
solution proposes a distributed deployment of the CAPIF framework where the
PSA UPF is the Service API provider exposing a service API directly to the API
invoker (AF/Edge Application) and the NEF provides the CAPIF Core Function
e.g. the API discovery functionality and the initial authentication,
authorization of the API Invoker. The CAPIF Core Function and related
functionality does not have any latency constrains, therefore the CAPIF Core
Function can remain centrally deployed in the network e.g. in a centralized
node NEF.
Figure 6.43.1-1: Low latency exposure solution for RAN QoS information to and
edge application
Editor\'s note: As for the solution the EAS gets information from the PSA UPF,
it is FFS which RAN information the EAS can get via the PSA UPF.
### 6.43.2 Functional Description
In this solution it is proposed that the PSA UPF can be the Service API
provider and the CAPIF Core Function could remain deployed in a centralized
NEF. The following principles are used:
\- It assumed that the UE and Edge application have established a session, and
this triggers the Edge application to invoke the service API for RAN QoS
Information.
Editor\'s note: The service API can probably be similar to
Nnef_AFsessionWithQoS but may need adaptions to support Edge Application
scenario.
\- The specified features of CAPIF in TS 23.222 [20] will be reused:
\- The Service API provider (i.e. PSA UPF) will request the CAPIF core
function (located e.g. in the NEF) to publish the service API using CAPIF-4.
\- The Edge Application will request to get onboarded to use the service API.
This will trigger authentication and authorization procedure according to TS
33.122 [21]. The Edge Application and CAPIF Core Function will negotiate
security method to be used on CAPIF-2e, the interface between the Edge
Application and Service API Provider (e.g. the PSA UPF).
\- The API Invoker (Edge App) will discover the service API by querying the
CAPIF Core Function. The address of the Service API provider is provided to
the API Invoker during the discovery, based on e.g. UE IP address, Flow
descriptor and GPSI.
NOTE: The Nnef_AFsessionWithQoS uses the IP address and flow descriptor to
support QoS Monitoring for URLLC, but alternatively the NEF should be able to
use the GPSI to locate the serving node by using e.g. Namf_location service.
\- The Edge application will trigger authentication and authorization to use
the Service API according to TS 33.122 [21]. The Edge Application and CAPIF
Core Function will negotiate security method to be used on CAPIF-2e, the
interface between the Edge Application and Service API Provider (e.g. the PSA
UPF).
\- The Edge Application will trigger the establishment of a secure connection
(CAPIF-2e) to the Service API provider (e.g. the PSA UPF) according to TS
33.122 [21].
\- The Service API utilization information reporting used for charging will
follow the principle described in TS 23.222 [20].
\- Other Service API managements functions are according to CAPIF-5 in TS
23.222 [20].
### 6.43.3 Procedures
The procedure below is according to TS 23.222 [20] and TS 33.122 [21] and
should be seen as an overview of the proposed solution. The details are found
in the listed specifications.
Figure 6.43.3-1: High level procedure using the CAPIF framework for
establishing a low latency service API between PSA UPF and AF/Edge Application
0\. The Service API provider (PSA UPF) publish the service API. There is an
established connection between the UE and the AF/Edge Application.
1-2. The Service API Invoker (AF/Edge Application) request the CAPIF core
function e.g. hosted in the central NEF to onboard and receive an API Invoker
ID. An Invoker profile is created in the CAPIF Core Function.
3-4. The AF/Edge Application queries the CAPIF Core Function for the
interested Service API and gets a response with e.g. interface details to the
PSA UPF e.g. IP address, port number, URI), protocols, version, data format.
Either the UE IP address, Flow descriptor or GPSI is included in the query in
order to find the correct PSA UPF serving the UE.
5-6. The AF/Edge Application requests the CAPIF Core Function to get
authorized to use the Service API
7-9. After being authorized by the CAPIF Core Function to use the service API,
the AF/Edge Application requests the PSA UPF to invoke the Service API. The
PSA UPF checks locally whether the AF/Edge Application is authorized, and if
needed check with the CAPIF Core Function. An end-to-end security between the
PSA UPF and Edge Application Server is set-up.
10\. The AF/Edge Application and PSA UPF directly use the service API to e.g.
subscribe and get notified on QoS status information.
### 6.43.4 Impacts on existing entities and interfaces
PSA UPF:
\- Support the features required to be a Service API provider according to the
CAPIF framework.
NEF:
\- Support CAPIF-3 and CAPIF-4 towards PSA UPF.
## 6.44 Solution #44: Network Information Exposure to Local AF with Low
Latency
### 6.44.1 Description
This solution can apply to key issue 3.
The Radio Network Information may be used by the mobile edge applications to
optimize the existing services and to provide new type of services that are
based on up to date information on radio conditions. For example, if the video
server could get the knowledge that the network congestion happens, it can
adjust the coding algorithm accordingly to the impacted UEs so as to further
improve the user\'s service experience.
The granularity of the radio network information may be adjusted based on
parameters such as information per cell, per UE, or be requested over period
of time.
In this solution, the NEF-edge is introduced. The architecture is shown in
Figure 6.44.1-1.
Figure 6.44.1-1: Information exposure architecture
In Figure 6.44.1-1, the NEF-edge is deployed close to the edge network in
order to fulfil the timely radio network information exposure to the edge
network. The NEF-edge has the connection with the AF in the edge network, MnS
producer as defined in TS 28.533 [24], and the NEF-central deployed in the
core network. In this solution, MnS producer is distributed close to RAN and
could handle the RAN management domain to support low latency exposure to the
edge network. What information can be exposed to the edge network is based on
the operator\'s policy and configuration. Other 5GC control plane NFs are not
shown in the figure.
NOTE: The interaction between NEF-edge and MnS producer follows the MnS
services defined in SA WG5. SA WG5 spec doesn\'t limit the authorized MnS
consumer for the consumption of MnS producer services. It supports the use
cases where 3GPP Network Element (NE) reports management data (Trace, PM,
Analytics and proprietary) to any authorized MnS consumer.\"
The NEF-edge has the following functionalities:
1\. Receiving the information subscription from the AF in the edge network.
2\. Authenticating the AF request and deciding whether to forward the
information subscription message to the NEF-central.
3\. If the requested information is related with the radio network
information, NEF-edge checks which information could be exposed to the AF
based on the operator policy and the agreement with the AF, and sends the
information subscription to the MnS producer.
If the requested information is related with the core network event defined in
TS 23.502 [3], the NEF-edge forwards the information subscription to the NEF-
central.
4\. Receiving the exposed information from the MnS producer, or NEF-central.
5\. Forwarding the information to the AF in the edge network.
### 6.44.2 Procedures
Figure 6.44.2-2: Event exposure procedure
1\. The AF subscribes to one or several Event(s) (identified by Event ID) and
provides the associated notification endpoint of the AF by sending
Nnef_EventExposure_Subscribe request. If the event(s) is related with certain
UE, the UE IP address or UE ID, e.g., SUPI or GPSI, is also included.
Event Reporting Information defines the type of reporting requested (e.g. one-
time reporting, periodic reporting or event based reporting, for Monitoring
Events). If the reporting event subscription is authorized by the NEF-edge,
the NEF-edge records the association of the event trigger and the requester
identity. The subscription may also include Maximum number of reports and/or
Maximum duration of reporting IE.
2a. The NEF-edge decides whether the event is related with the radio network
information. If the event ID is related with the radio network information,
the NEF-edge further checks whether the AF is allowed to perform the requested
service operation by checking AF\'s identifier (i.e. AF ID).
If the event ID is related with radio network information, and the AF request
is authorized and accepted by the NEF-edge, the NEF-edge further decides which
information related with radio network information could be exposed to the AF
based on the operator policy and the agreement with the AF. If GPSI is
included in step1, the NEF-edge also maps GPSI to SUPI. If the NEF-edge could
fulfil all the functions above without the interaction with NEF-central it
skips step 2b and performs step 3.
If the event ID is not related with radio network information, or the NEF-edge
can\'t perform the authentication and the information mapping, it performs
step 2b.
2b. The NEF-edge sends Nnef_EventExposure_Subscribe request to NEF-central.
If the event ID is related with radio network information, the NEF-central
checks whether the AF is allowed to perform the requested service operation
and sends the response the NEF-edge. The NEF-central also performs the
information mapping if needed, e.g. mapping the UE IP address to SUPI. If the
AF request is accepted, it performs step 3.
If the event ID is not related with radio information, the NEF-central
performs the procedure defined in clause 4.15.3.2.3 in TS 23.502 [3].
3\. The NEF-edge invokes management services provided by MnS producer. If the
event(s) is related with certain UE, the UE ID, e.g., SUPI, is also included.
MnS producer determines the gNB and gets the RAN information related with the
Event ID.
4\. The MnS producer sends the response to the NEF-edge.
5\. The NEF-edge acknowledges the execution of Nnef_EventExposure_Subscribe to
the AF that initiated the request.
6\. The MnS producer monitors the subscribed information, and notifies the
NEF-edge when certain event happens via management services defined in TS
28.533 [24].
7\. The NEF-edge forwards to the AF the reporting event received in step 6.
### 6.44.3 Impacts on services, entities and interfaces
NEF-edge functionality is similar with common NEF functionality with the
following additional enhancements:
\- Authenticate whether the AF request should be accepted.
\- Interaction with MnS producer for RAN related information event exposure.
\- Interaction with NEF deployed in the core network for the non-RAN related
event exposure.
NEF: Interaction with NEF-edge for the exposure of non-RAN related
information.
No impacts on UE, RAN, UPF, and other core network NFs.
## 6.45 Solution #45: Using NAS message notify UE\'s application layer
### 6.45.1 Description
The solution applies to Key Issue #3 \"Network Information Provisioning to
Local Applications with low latency\".
To guarantee the user experience, the UE shall be able to be notified the
change of network information (such as the change of QoS when an alternative
QoS applies to RAN) quickly so that the application layer behaviour can be
adjusted as soon as possible. To realize it, as the figure-6.45.1-1
illustrated, when change of QoS happens (a kind of network information), RAN
can use NAS message to notify UE (Optionally, UE can adjust the application
behaviour promptly if available). Upon receiving the notification from 3GPP
network, the UE notifies to with EAS the change.
Figure-6.45.1-1 5GS notify the change of network information (QoS) to UE
For the non-mobility case, the change of QoS will be delivered to UE via NAS
message (e.g. PDU Session modification request).
The Change of QoS is aware by SMF using existing QoS Notification control
defined in clause 5.7.2.4 in TS 23.501 [2]:
\- For QoS flow with non-AQP, \"GFBR can no longer be guaranteed\" for a QoS
flow.
\- For QoS flow with AQP, Change in the QoS parameters (i.e. 5QI, GFBR, MFBR)
for a QoS flow.
The SMF can notify other network information and UE reacts accordingly using
the same mechanism as change of QoS.
NOTE 1: For using the NAS message, it assumes the AMF and SMF can be localized
to guarantee a prompt notification.
NOTE 2: How the UE notify the network information to EAS via application layer
is out of 3GPP scope.
### 6.45.2 Procedures
##### 6.45.2.1 notify the change of QoS using NAS message
Figure-6.45.2-1: 5GS notify the change of QoS using NAS message
1\. When change of QoS happens, step 1will be used to notify UE the change of
QoS quickly. For step 1, the detailed procedure has been described in TS
23.502 [3] clause 4.3.3.2 UE or network requested PDU Session Modification.
2\. UE interacts with EAS via user-plane to notify the change of QoS. EAS can
further notify it to AF.
NOTE: As the interface between UE and EAS is not even defined by SA WG6, step
3 is out of 3GPP scope.
### 6.45.3 Impacts on services, entities and interfaces
UE:
\- Acquire the network information (e.g. change of QoS) using NAS message
(existing mechanism in Relâ€‘16).
\- Notify network information to EAS via application layer (out of 3GPP
scope).
SMF:
\- Support to notify the network information using NAS message. Specifically,
SMF can notify to UE that \"GFBR can no longer be guaranteed\" or \"resumed\"
for a QoS flow without AQP using NAS message.
NOTE: The message and mechanism used for the notification is same as
notification of change of AQP for a QoS flow.
## 6.46 Solution #46: Local NEF Deployment for network information exposure to
Local AF with Low Latency
### 6.46.1 Description
This solution is for key issue#3,which addresses Network Information
Provisioning to Local Applications with low latency including aspects related
to:
\- How to expose the network information to the application functions deployed
in the edge with low latency?
\- Whether and how to maintain the exposure when the UE moves out of the
coverage of NF(s) supporting the exposure?
This solution proposes to deploy Local NEF at the edge of the network and
exposes real-time network information e.g. network congestion condition or
real-time user path latency, to Local AF. Local AF refers to the applications
which are deployed in edge hosting environments.
In R15, there is a mechanism to select the proper local UPF and implement
traffic offloading to local DN by using ULCL/BP or LADN. In this solution, the
local UPF is enhanced to support real-time network information exposure to
local NEF, through a new control-plane interface, i.e. Nx. There are two
alternative definitions for the Nx interface.
1) Nx interface is N4-like interface, which may support the simplified PFCP
protocol for association establishment, and information exposure between Local
UPF and Local NEF.
2) Nx interface is SBI interface, which may require the UPF supporting NF
event exposure service (the same as other CP NF event exposure services)to
report the real-time information to Local NEF.
**The selection of local UPF for local NEF:** The local AF provides real-time
information exposure requirement to local NEF. The address of local NEF is
configured in local AF or it might be obtained using NRF-based discovery
procedures. This requirement may include real-time network information
indication, application description, UE IP address, DNAI(s). When the local
NEF accept this requirement, it may find the corresponding SMF through BSF,
PCF if any, based on UE IP address. The SMF may find the suitable local UPF
based on the DNAIs. Then SMF transfer the corresponding local UPF address or
local UPF ID through PCF if any, BSF to local NEF, or directly to local NEF.
The detailed is in Figure 6.46.2-1.
When local NEF gets the local UPF ID, the local NEF may request the NRF to get
the local UPF address. And then the local NEF may establish PFCP association
with the local UPF, or alternatively invoke the UPF event exposure service.
After the establishment of Nx, the local UPF may retrieve the real-time
information based on local NEF requirement and expose the information through
Nx. The local NEF or local UPF may trigger the release of Nx.
For SBI interface, the local NEF may subscribe the UPF event exposure service
and get the real-time information in time. For example if the real-time
information is real-time user path latency, the UPF may expose this
information after the calculation of PDB.
The exposure maintenance when UE moves out of the local UPF coverage.
When UE moves out of the local UPF coverage, there are following cases:
\- For ULCL case, when the local UPF is reallocated but the remote PSA UPF and
the SMF keep the same ,the UE IP address is not changed while the DNAI is
changed. The old local UPF may trigger the release of Nx association when the
SMF trigger the N4 session release. And after the local UPF reallocation, the
SMF notifies the local NEF with the new local UPF ID or address, and the local
NEF can trigger another Nx establishment with the new local UPF.
\- For Branching Point or LADN case. When the local UPF is reallocated but the
SMF keeps the same, the UE IP address is changed. Therefore for the local AF,
this is a new user and therefore the local AF may trigger a new real-time
information exposure requirement to local NEF and the local NEF triggers
another Nx establishment with the new local UPF. For the old local UPF, when
the UE moves out of the coverage of old local UPF, the SMF may trigger the N4
release, and at the same time, the old local UPF should trigger the Nx
release.
\- When UE moves out of the local UPF coverage, and the SMF also changes. It
is obvious that the UE IP address is changed and local AF may trigger a new
real-time information exposure requirement to local NEF, and the previous
association between old local UPF and local NEF is released.
### 6.46.2 Procedures
The selection of local UPF for local NEF is described in Figure 6.46.2-1.
Figure 6.46.2-1: The association establishment between local UPF and local NEF
0a. The local NEF informs the NRF of its NF profile, e.g., NFType and
locality.
0b. The NRF acknowledges the registration.
0c. The AF may use the NRF to find a specific local NEF, e.g., using locality
or LADN DNN or DNAI info associated to a relevant AF or EAS.
0d. The NRF provides the relevant local NEF instances (and associated IP
Addresses or FQDN) according to the input query parameters and internal
policies.
1\. Local AF requests targeting an individual UE by a UE address through Local
NEF. Local AF may also provide some real-time information requirement
indication in the AF request.
2-3. When the Local NEF gets the AF request, the Local NEF analyses the AF
request and determines that the association between local NEF and local UPF is
needed to be established, in order to retrieve real-time information from
corresponding local UPF.
Local NEF consumes Nbsf_Management_Discovery service operation (providing at
least the UE address) to find out the address of the relevant PCF. This is
described in TS 23.502 [3], clause 4.3.6.4.
4\. Local NEF invokes the Npcf_PolicyAuthorization service to the PCF to
transfer the Local AF request, which including that a suitable local UPF ID or
address is needed.
5-6. PCF determines if existing PDU sessions are impacted by the AF request.
For each of these PDU sessions, the PCF updates the SMF with corresponding PCC
rules by invoking Npcf_SMPolicyControl_UpdateNotify service operation.
If the AF request includes a notification reporting request for UPF, the PCF
includes in the PCC rules the information required for reporting the event,
including the Notification Target Address pointing to the NEF or AF and the
Notification Correlation ID containing the AF Transaction Internal ID.
7\. SMF reports the corresponding local UPF ID or address to local NEF through
Nsmf_EventExposure_Notify. The corresponding local UPF refers to the PSA UPF
of the PDU session corresponding to a LADN or local PSA UPF under UL CL or
Branching Point scenario.
8\. Local NEF gets the UPF address by local configuration or sending
Nnrf_NFDiscovery_Request to NRF based on local UPF ID, if the UPF is
provisioned previously in NRF.
9\. The local NEF trigger the Nx session establishment with local UPF.
10\. If the Nx interface is N4-like interface, the local NEF may send Session
Modification Request to retrieve real-time information from local UPF. If the
Nx interface is SBI interface, the local NEF invoke Nupf_Event
Exposure_Subscribe service operation to subscribe real-time information in
UPF.
Local NEF requests local UPF for network information exposure for per UE\'s
specific PDU session or even service flow, based on UE IP address and/or
application flow information (IP tuple 5). Local NEF forwards indication to
local UPF for exposing the network information, for example, QoS congestion
status notification, QoS profile for service flow, UPF load information, or
end to end delay of specific service flow, etc.
Local NEF may also send other information including the life time of the
connection between local NEF and local UPF.
11\. UPF finds the corresponding QoS flow by querying the UE IP address and
application flow information, and response local NEF the corresponding
information according to the network information exposure indication.
12\. Local UPF replies to the local NEF with the subscribed real-time network
information by Nupf_Event Exposure_Notify/Session modification Response.
13\. Local NEF reports the real-time network information to local AF through
Nnef_EventExposure_Notify.
### 6.46.3 Impacts on services, entities and interfaces
Local UPF:
\- Establish control plane connection with local NEF, and expose specified
real-time network information to local NEF.
\- The local UPF is expected to support SBI interface and the
UPF_EventExposure Service, which can facilitate the information exposure from
local UPF to local NEF.
Local NEF:
\- Establish control plane connection with local UPF, through N4-like
interface or SBI interface.
\- SBI interface with NRF to register, deregister and update L-NEF profile.
SMF:
\- Support to report corresponding local PSA UPF ID or address to local NEF.
Local AF:
\- Discovers local NEF through NRF.
## 6.47 Solution #47: User Plane based Network Information Provisioning
### 6.47.1 Description
This solution addresses the Key Issue #3: Network Information Provisioning
(NIP) to Local Applications with low latency.
Typically, there are two types of Network information Provisioning, one is
CP(control plane) based NIP, another is the user plane based NIP. Normally, CP
based NIP is also called out-of-band NIP and UP based NIP is called in-band
NIP.
CP based NIP can be well controlled by the operator, e.g. access control,
charging, usage rating controll etc, but this out-of-band NIP also intrduces
some complexity:
1) the application will need to create a second communication channel to
communicate with 5G network;
2) synchronization and combination of different information from different
bands (CP and user data bands) in different time scale and volume scale are
sometime very hard;
3) the CP-based NIP can not provide frequent changed NIP, otherwise it will
introduce a lot of singalling to the 5G network.
While the UP based NIP provides some charming features:
1) provide frequent changed NIP;
2) provide real-time NIP;
3) synchronization the NIP and user data in the same time scale;
4) normally, the UL direction is less user data, the free \"space\" within the
MTU can accommodate the NIP to the application. e.g. the TCP ACK packet
normally is 40 bytes, and there are 1500-40 =1460 bytes free space potentially
can be used by the NIP ( normally the MTU is 1500 or 1280).
One basic mechanism is using the the Option Field of the IP header or TCP
header of the DL to transport the NIP command from the EAS to the 5G
network(e.g. UPF) or to the UE and using the the Option Field of the IP header
or TCP header of the UL to transprot the NIP response from the 5G network or
the UE to the EAS. The Option Field of the IP header or TCP header can provide
40 bytes.
But if the length of the NIP request or response is larger than 40 bytes, the
NIP data can be splitted into small part and each part is delivered in the
Option Field, but this will introduce some implementation complexity to
assemble parts into a message, and alternative mechanism is using the data
field of the ICMP ECHO packet.
NOTE: The UE can provide some radio related information in the IP/TCP header
in the application layer.e.g. the Radio is in congestion state based on the
received ECN from the RAN as defined in TS 38.300 [16] clause 12.2. The RAN
can provide some radio information in the UL GTP-U header to the UPF.
### 6.47.2 Procedures
The procedure supports the real-time response mode (in an ICMP ECHO packet) or
in the piggyback mode (in an IP/TCP Option Field). The procedure also supports
the one time request/reponse NIP, one request with multiple reponses and the
subscribe/multiple notify mode NIP.
Figure 6.47.2-1: UP-based NIP from the 5G
1\. UE establishes a PDU Session and gets an UE IP address, UE uses the IP
address to access the EAS.
2\. The EAS decides to get the NIP(e.g. radio information) of the UE to do
some app optimization (e.g. adaptive codec change).
3\. The EAS and 5G node(e.g. UPF or the UE) negotiate the security algorithm
and key using the same method to integrity protection of transport network
information between the 5G node and EAS.
NOTE 1: As defined in TS 23.501 [2] clause 5.33.3, the UPF can get QoS
monitoring information from the RAN via the GTP-U header. The same mechanism
can be reused to get new radio information if the RAN can provide these
information to the UPF via the UL GTP-U header.
NOTE 2: The detailed security procedure is to be defined by SA WG3 if needed.
NOTE 3: This solution is only applicable if the integrity protection over user
plane is used. Otherwise, the recommendation regarding security aspects of
ICMP as described in TS 33.501 [38] is enforced.
4\. The EAS includes the Network Information Provisioning request in the
Option field of the DL IP/TCP header or the EAS generates a ICMP ECHO packet
and include the request in the data field of ICMP ECHO.
5\. The DL IP/TCP or the generated ECHO packet are forwarded to the 5G
Node(e.g. UPF in the figure).
6\. The 5G Node checks the DL IP/TCP or the generated ECHO packet whether the
target of the NIP request is 5G Node. If there is a MAC for the NIP request,
the MAC should be verified.
If the DL packet is the IP/TCP and the target of EAS request in the Option
field is the \"5G Node\" (e.g. \"UPE/UE\"), the 5G Node will remove the Option
field of the IP/TCP packet and forward the IP/TCP packet to the Application as
in Step 8, if there is no option field or the option field is not for NIP or
the target of EAS request in the Option field is not the 5G Node, the 5G Node
continues to forward the DL IP/TCP packet without any change to the
UE/Application as in step 8.
If the DL packet is the ICMP ECHO and the target of EAS request in the data
field is the 5G Node, and, the 5G Node discards this ICMP ECHO without
forwarding to the Application and responds with an ICMP ECHO Reply to the EAS
as an UL UE packet. Otherwise, the 5G Node continues to forward the DL ICMP
ECHO packet without any change to the Application as in Step 8.
7\. If there is a NIP for the 5G Node, and the 5G Node decides to immediately
to provide NI to the EAS, the 5G Node can generate an ICMP ECHO with the
provided NI in the data field and sends this ICMP ECHO packet to the EAS. The
5G Node can determine whether the EAS has received the response by the ICMP
ECHO reply message and can resend the ICMP ECHO to the EAS after no ECHO Reply
is received after a short time.
8\. The IP/TCP packet is forwarded to the Application.
9\. There is a UL IP/TCP packet from the Application.
10\. If there is a NIP for the 5G Node, and 5G Node decides to provide the NI
to the EAS with the UL IP/TCP packet, the 5G Node also includes the Network
Information Provisioning request in the Option field of the DL IP/TCP header.
If the adding of the option field to the UL IP/TCP packet will introduce IP
fragment, the 5G Node can delay and then includes the NIP to the next UL
IP/TCP packet without introducing IP fragment.
11\. If there is a NIP for the 5G Node, and the 5G Node determines to get
other NI from other NF(s), the 5G Node will ask the AMF/SMF to provide these
NI from other NF(s), the AMF/SMF can query and get the NI via the SBI.
12a. If the NI is provided by the AMF/SMF, the 5G Node decides to immediately
sends the NI to the EAS by the ICMP ECHO as described in step 7.
Steps 12b and 12c are similar with the steps 9 and 10 to provide the NI to the
EAS in the Option field of the UL IP/TCP packet.
13\. The UE and EAS continue the UL/DL packets.
14\. If new network information available ( e.g. the throughput of the radio
is changed) and if the EAS has requested the 5G Node to provide the changed NI
to the EAS if available, the 5G Node needs to \"notify\" the new NI to the
EAS.
Steps 15a\~15b are similar as the steps 7\~10 and are used to provide the new
NI to the EAS by ECHO or Option field in real time or in piggyback mode.
### 6.47.3 Impacts on services, entities and interfaces
EAS:
\- Handle the NIP in the User plane.
UE/UPF:
\- Handle the NIP in the User plane.
## 6.48 Solution #48: QoS monitoring information exposure based on
unstructured data transmission mechanism
### 6.48.1 Description
This solution addresses the Key Issue #3: Efficient Network Information
Provisioning to Local Applications.
In this solution, unstructured data transmission mechanism is reused for UPF
to send the QoS monitoring information to local applications. The difference
is that the unstructured data is the QoS monitoring information received from
RAN. The UPF forwards the QoS monitoring information to the destination in the
data network over the N6 PtP tunnel using UDP/IPv6 encapsulation. The IPv6
address and UDP port used for encapsulation is provided by SMF along with the
QoS monitoring rule. The IPv6 address and UDP port is provided by AF while
requesting QoS monitoring.
The detailed QoS monitoring information depends on the AF request. It could be
e.g. the packet delay, packet rate and so on. To calculate the packet delay,
the QoS monitoring mechanism for URLLC can be re-used. The UPF supports the
capability to calculate the packet rate based on description in clause
5.8.2.11.4 in TS 23.501 [2].
### 6.48.2 Procedures
Figure 6.48.2-1: unstructured data transmission based QoS monitoring
information exposure
1\. The AF sends QoS monitoring request to PCF, the message includes QoS
parameters to be measured and the notification target address (+notification
correlation ID). The notification target address includes IPv6 address and UDP
port of the tunnel end in the edge hosting environment.
2\. The PCF invokes the Npcf_SMPolicyControl_UpdateNotify request to SMF to
send QoS monitoring policy and notification target address (+notification
correlation ID).
3\. The SMF sends N4 rule includes QoS monitoring rule and notification target
address (+notification correlation ID) to UPF.
4\. QoS monitoring procedure.
5\. When the QoS monitoring information is received from RAN, the UPF
constructs unstructured data to include the QoS monitoring information and
notification correlation ID received in step 3. In order to make the AF
understand the QoS monitoring information, the UPF includes the information
and notification correlation ID in a NSH (Network Service Header) as defined
in IETF RFC 8300 [43].
NOTE: This would require CT3 to define a dedicated 3GPP container within the
NSH framework.
6\. The UPF encapsulates the unstructured data using the IPv6 address and UDP
port received in step 3 and forwards the unstructured data to the destination
in the data network over the N6 PtP tunnel.
### 6.48.3 Impacts on services, entities and interfaces
Impacts on existing NFs are as follows:
PCF:
\- Receives the notification target address (+notification correlation ID)
from AF. The notification target address includes IPv6 address and UDP port of
the tunnel end in the edge hosting environment.
\- Sends the notification target address (+notification correlation ID) to
SMF.
SMF:
\- Includes the notification target address (+notification correlation ID) in
N4 rule.
UPF(PSA):
\- Generates the unstructured data including the QoS monitoring information
and notification correlation ID.
\- Encapsulates the unstructured data using IPv6 address and UDP port in the
notification target address and forwards the data over the N6 PtP tunnel.
AF:
\- Sends the notification target address (+notification correlation ID) to
PCF. The notification target address includes IPv6 address and UDP port of the
tunnel end in the edge hosting environment.
## 6.49 Solution #49: Network Information Provisioning to EAS with low latency
based on User Plane
### 6.49.1 Description
In this solution, the network information is sent via user plane in the core
network to the Local PSA and then further sent to the AF via a Local NEF.
The solution supports only providing information about UE defined in Rel-16 as
part of QoS monitoring
Figure 6.49.1-1: Local NEF-based exposure
In Figure 6.49.1-1, a Local NEF is deployed in the Edge. The Local NEF can be
co-located with the Local PSA or standalone, or as part of Edge Hosting
Environment. The interface between local PSA and local NEF (i.e. Nx interface)
could reuse N4 protocol.
The solution targets reporting QoS monitoring results as defined in Rel-16 TS
23.502 [3] towards the EAS/application.
**1\. Event subscription**
The AF responsible for the EAS subscribes the event by invoking
Nnef_AFsessionWithQoS service to the local NEF and then the local NEF
subscribes the event via the central NEF or PCF with the notification endpoint
to the local NEF. The notification endpoint can be used to identify the
associated AF subscription event in the local NEF. The local NEF needs to
indicate the PCF that the local event notification is needed. Based on the
indication of local event notification and operator\'s policy, the PCF can
determine whether only local event notification or both local and central
event notification are required. The PCF shall include an indication of local
event notification or an indication of duplicated event notification and the
notification endpoint of the local NEF within the PCC rule and provide to the
SMF.
**2\. Supported Events and notification procedure**
For the QoS monitoring, when the SMF receives such kind of PCC rule, the SMF
sends the QoS monitoring request to the RAN and N4 rules with notification
endpoint of the local NEF to the Local PSA. Upon the detection of the QoS
monitoring event, the Local PSA sends the notification to the notification
endpoint of the Local NEF. The Local PSA may also send the notification to the
SMF if the duplicate notification is needed.
**3\. Mobility supporting**
During UE mobility, the UPF and DNAI may be re-selected. To ensure the low
latency exposure, the Local NEF should be also re-selected. The AF may
consider one or more of following parameters to reselect a local NEF: UE
location, AF Identifier, NEF Service Area, and DNAI, in additional to other
parameters listed in TS 23.501 [2], clause 6.3.14. The new AF initiates a new
AF session with required QoS and QoS monitoring is established and the old AF
revokes the AF session and QoS monitoring is removed.
The new L-NEF can be determined with the assistance of 5GC (e.g. SMF, NEF) and
the new EAS will trigger QoS monitoring to new L-NEF.
### 6.49.2 Procedures
Figure 6.49.2-1: Network Information Provisioning to Local Applications with
low latency based on User Plane
1\. The UE establishes a PDU session with Local PSA as defined in clause
4.3.2.2.1 of TS 23.502 [3].
2\. The AF initiates an AF session with required QoS procedure as defined in
clause 4.15.6.6 of TS 23.502 [3].
In the request, the AF may also subscribe to local notification of QoS
monitoring and provide the associated notification endpoint of the AF to the
local NEF. For the QoS monitoring, the AF shall include the corresponding QoS
monitoring parameters.
In the request, the Local NEF indicates the PCF that local notification is
required and the notification endpoint of the Local NEF is provided to the
PCF. If the NEF is deployed, the subscription is performed via the NEF.
The PCF makes the policy decision. The PCF generates the PCC rule based on the
service information.
If the local notification of QoS monitoring is subscribed, the PCF includes
the QoS monitoring policy, notification endpoint of the Local NEF and the
indication of local event notification within the PCC rule.
Based on the operator\'s policy, the PCF may determine that the duplicated
notification is required, i.e. both local notification to the AF and central
notification to the PCF is required. In this case, the PCF includes the
indication of duplicated event notification within the PCC rule instead.
3\. PCF initiates the PDU session modification procedure as defined in clause
4.3.3.2 of TS 23.502 [3], step 1b, 3b, 4-8b.
In the case of local notification of QoS monitoring, the SMF includes the QoS
Monitoring indication in the request to the UPF. The SMF may also include the
indication of local event notification or duplicated event notification in the
request.
4\. If the QoS monitoring is enabled, the Local PSA calculates the UL, DL or
round trip packet delay of the QoS Flow as defined in clause 5.33.3 of TS
23.501 [2]. When the reporting trigger(s) is satisfied, e.g. the measured
packet delay value exceeds the reporting threshold, or the reporting period
expires, or the PDU Session is released, the event is detected.
5\. The Local PSA sends the event notification to the notification endpoint of
the Local NEF carrying UL, DL or round trip packet delay measurement report.
If the duplicated event notification indication is received, the Local PSA
sends the notification to the SMF as well as defined in TS 23.501 [2].
6\. The Local NEF sends the event notification to the notification endpoint of
the AF.
7\. If due to mobility, UE moves to another area where DNAI changes. The PSA
relocation and EAS relocation are performed.
8\. The new AF initiates a new AF session with required QoS to the new local
NEF or the one indicated by 5GC (e.g. SMF or NEF). QoS monitoring is
established by executing steps 2-4.
9\. The old AF revokes the AF session with the old local NEF and QoS
monitoring is removed for the old QoS flow.
### 6.49.3 Impacts on services, entities and interfaces
AF:
\- Subscribe local notification of QoS Monitoring.
\- Re-select Local NEF based on UE location, AF Identifier, NEF Service Area,
and DNAI.
PCF:
\- Subscribe local notification of QoS Monitoring.
SMF:
\- Subscribe local notification of QoS Monitoring (from UPF to Local NEF).
\- Support Local NEF selection.
UPF:
\- report local notification of QoS Monitoring to local NEF.
NEF:
\- Support Local NEF selection.
Local NEF:
\- Receive local notification of QoS Monitoring and transfer it to the AF.
## 6.50 Solution #50: Activating the traffic routing towards Local Data
Network per AF request
### 6.50.1 Description
The following solution corresponds to the key issue #5 on activating the
traffic routing towards Local Data Network per AF request as specified in
clause 5.5. This solution is applicable for Session Breakout Connection Model
(for SSC Mode 1 PDU sessions).
The AF uses AF influence traffic mechanism to activate the traffic routing
towards the requested DNAI. The AMF performs I-SMF selection. In order to
select a proper I-SMF, the AMF selects an I-SMF based on requested DNAI(s).
The solution assumes the supported DNAI list is stored in the SMF profile in
NRF or locally configured in AMF. After receiving the AF influenced Traffic
Steering Enforcement Control in the PCC rule, if the SMF determines it cannot
serve the requested DNAI, it sends the requested DNAI to the AMF in e.g.
Nsmf_PDUSession_SMContextStatusNotify. This option can be applied to existing
PDU session.
Figure 6.50.1-1: Non-roaming architecture with I-SMF insertion to the PDU
Session in reference point representation, with UL CL/BP
### 6.50.2 Procedure
#### 6.50.2.1 I-SMF insertion for existing PDU Session
Figure 6.50.2.1-1: Solution - I-SMF insertion for existing PDU Session
1\. AF provides the target DNAI (s) (List of DNAIs, indicates to access the
target Local DN, which is identified by DNAIs), N6 traffic routing info to the
SM_PCF and the AF will subscribe to the SMF exposure event. This procedure is
same as the steps 1-4 defined clause 4.3.6.2 in TS 23.502 [3].
2\. Void.
3a. The SM_PCF updates the SMF with corresponding new PCC rule(s) including
the DNAI(s) for the PDU sessions by invoking Npcf_SMPolicyControl_UpdateNotify
service operation. The service procedure is described in the step 5 in clause
4.3.6.2 of TS 23.502 [3].
Based on the received DNAI(s) information, the SMF may subscribe to the UE
mobility event notification from the AMF (e.g. UE moving into or out of Area
of Interest).
The SMF determines the target DNAI(s) which are applicable to the current UE
location.
The SMF may decide the target DNA(s) finally when the SMF receives the
Nsmf_TraficInfluence_AppRelocationInfo request if the AF acknowledge is
expected.
3b. Void.
3c. The SMF invokes a Nsmf_PDUSession_SMContextStatusNotify(target DNAI(s) for
existing PDU session) service operation if it (or the associated old I-SMF)
can not serve the target DNAI(s), and the content of the message includes the
target DNAI(s), the PDU Session ID. This message triggers the AMF to select a
suitable I-SMF for the PDU Session.
If there is an I-SMF serving the PDU session, the SMF invokes
Nsmf_PDUSession_StatusNotify and then the I-SMF invokes
Nsmf_PDUSession_SMContextStatusNotify message to send the target DNAI(s) for
existing PDU session to AMF.
4\. The AMF may select a new I-SMF which can serve the target DNAI for the
existing PDU Session.
If the AMF doesn\'t have the knowledge which DNAIs the I-SMF/SMF can serve the
target DNAI based on local configuration, it invokes the NF discovery request
with NRF which provides the list of SMFs supporting the requested DNAI(s). If
the AMF receives more than one requested DNAI(s), the AMF selects a new I-SMF
which can serve all the DNAI(s) associated with this PDU Session. If the AMF
can\'t find such I-SMF, the AMF determines to select an I-SMF which serves the
target DNAI(s) per operator\'s policy.
5\. The AMF sends a Nsmf_PDUSession_CreateSMContext Request to the new I-SMF,
the request message includes the target DNAI(s).
6\. The new I-SMF retrieves SM Context from the old I-SMF (in the case of
I-SMF change) or SMF (in the case of I-SMF insertion) by invoking
Nsmf_PDUSession_Context Request.
7\. The new I-SMF selects a new I-UPF based on the received SM context, e.g.
target DNAI, S-NSSAI, and UE location information.
8\. The new I-SMF initiates a N4 Session Establishment to the new I-UPF.
9\. The new I-SMF invokes Nsmf_PDUSession_Update Request (in the case of I-SMF
insertion) or Nsmf_PDUSession_Create Request (in the case of I-SMF change)
towards the SMF. The SMF initiates N4 Session Modification toward the PSA1.
And The SMF responds Nsmf_PDUSession_Create Response or Nsmf_PDUSession_Update
Response to the new I-SMF.
10\. If the AF has subscribed to user plane management event notifications,
the SMF notifies the AF of the PSA change by invoking
Nsmf_EventExposure_Notify service operation.
11\. The new I-SMF sends a Nsmf_PDUSession_CreateSMContext Response to the
AMF.
12\. In the case of I-SMF reselection, the AMF sends
Nsmf_PDUSession_ReleaseSMContext Request to old I-SMF for the release of
resources in old I-SMF.
13\. Add a PDU Session Anchor and Branching Point or UL CL controlled by
I-SMF. The same procedure is performed as described in clause 4.23.9.1-1
starting from step 3 in TS 23.502 [3].
Steps 6 to 13 are per Rel-16 specifications; Other ETSUN related procedures
are not modified.
The SMF removes the target DNAI(s) from the AMF when the SMF determines that
there is no applicable DNAI(s) for the current UE location by invoking the
Nsmf_PDUSession_StatusNotify service operation. The AMF remove the I-SMF
according to the ETSUN related procedures.
### 6.50.3 Impacts on services, entities and interfaces
AMF:
1\. Receives the target DNAI(s) from SMF.
2\. Selects I-SMF supporting the target DNAI.
SMF:
1\. Sends target DNAI(s) to AMF and triggers it to select an I-SMF can serve
the target DNAI.
2\. Register the supported DNAI list in NRF.
NRF:
1\. Store the supported DNAI list in the service profile of the I-SMF/SMF.
## 6.51 Solution #51: Edge Relocation for all connectivity models
### 6.51.1 Solution description
The solution addresses Key Issue #2: Edge Relocation. The UE is Edge Computing
Service agnostic.
This solution supports all connectivity models and describes Discovery of Edge
Application Server at edge relocation due to PDU Session re-anchoring. The
description applies to PDU session re-anchoring with SSC#3, SSC#2 modes and
session breakout PDU sessions (with and without co-existence with previous
Edge PSA).
This is a solution for Edge Relocation for all connectivity models. It shows
it is possible to have the same behaviour towards the network independent of
connectivity model and network support, and so, it is possible to support all
network variants in the same application client.
For session breakout scenarios, Edge Relocation refers to the relocation of
the local PSA selected for the edge application traffic.
Extensions can still be defined on top to optimize the solution for each
connectivity model as options. The following solutions customize this solution
to a specific connectivity model:
\- Solution #23, Distributed anchor, including both, SSC#3 and SSC#2 modes.
\- Solution #52, session break-out scenarios with PSA coexistence.
\- Solution #53, session breakout scenarios, Dynamic UCL/Local PSA insertion
with PSA coexistence.
This solution is aligned to and complements DNS based solutions for KI#1 like:
\- Solution #10 for DNS based Discovery of Edge Application Server for
Distributed Anchor connectivity model.
\- Solution #22 for DNS based EAS Discovery supporting Session Breakout.
Like Solution #10 and Solution #22, this solution supports encrypted DNS.
With Edge Computing, Applications Servers can be distributed and be deployed
at the edge of the cellular networks. In this scenario, the Edge Application
Server that is topologically closest to the UE should be selected. The Edge
Application server that is closest to the PSA in IP distance is the one
closest to the UE. At Edge Relocation, there might be another Edge Application
Server that is closets to the new PSA.
Other solutions, e.g. Solution #10, show how to discover with DNS an AS that
is closest to the PSA. Assuming that solution, at Edge PSA change, a new DNS
query for the Application FQDN can be triggered for the reselection of an AS
that is closest to the new PSA.
The detailed procedure below describes this solution that applies to all SSC#3
and SSC#2 and session breakout PDU session re-anchoring, leading to edge
relocation (with and without co-existence with previous Edge PSA).
The PSA in the procedures below is the PSA selected for the Application
Traffic.
### 6.51.2 Procedures
#### 6.51.2.1 High Level procedure for any connectivity model
At mobility, if another UPF is closer to the UE, the PDU Session can be re-
anchored with that UPF and get a new PSA. This solution allows to discover the
closest Edge Application server to the new PSA.
The generic connectivity, independent of SSC-mode and connectivity model is
described below:
The UE starts using the IP address /prefix associated with the new PSA (if
this is available) for the new traffic flows (or even proactively for existing
traffic flows where possible (if it has the mechanisms (outside 3GPP scope)).
If the connection to the first Application Server is still available, there is
the option of having the Application Server instructing the application client
to facilitate the move.
The application behaviour can change at re-anchoring and optimize the move if
the situation is known to the application layer e.g. with SMF notification of
PSA change. A new DNS request will also be sent for the Application FQDN if,
the application client supports OS notifying the Application clients of the
new IP connection (OSs and many Application clients are designed already today
to use this information in the wifi-3GPP access changes) or some form of
application internal redirect (e.g. HTTPS redirect), the former AS is not
available through the new PSA, the AS is designed to send frequent queries or
if the TTL of the previous DNS has expired.
NOTE 1: The UE DNS Stub Resolver cache is assumed to be bound to the former IP
connection, and not considered, when a new IP connection is established, for
the new DNS Queries, which are sent via the new PSA. Else, the new DNS query
will be sent out for resolution depending on the TTL of a previous DNS
response for the same FQDN (e.g. with ULCL). If the TTL is short enough the
application client can query frequently to identify new AS locations, an
alternative is also that the AS via AF/exposure will get notification that a
new DNS query is needed and will trigger the client with application internal
signalling. As long as there is connectivity to both the old and the new PSA-
UPF and different AS IP address ranges are used, there is no need for an
immediate discovery of the new AS.
Figure 6.51.2.1-1 below shows an example sequence for this solution including
an example for how a stateful application can build service continuity. The
sequence includes the following steps:
The UE has a PDU session established with an Edge PSA and the application
traffic has started via this Edge PSA towards an AS#1 that is closest to the
PSA, that has been discovered using DNS mechanisms e.g. as described in
Solution #10 or Solution #22.
Figure 6.51.2.1-1: EAS reselection at Edge Relocation - sequence
1\. At some point, the UE moves, the core network identifies the need to
select a new anchor and triggers the anchor change. The PDU Session may be
updated or a new PDU session may be established (depending e.g. on EC
connectivity model) with the selected new anchor. The former PSA may be
maintained and coexist with the new one for a LifeTime \"T\" before it is
removed, if so, a timer is started for that purpose. The detailed procedure
for the multiple PDU Sessions case is described in TS 23.502 [3] clause
4.3.5.2.
2\. The Application traffic can continue on the former PDU Session Anchor if
that is still available. The UE/application may establish an L4 connection to
the EAS (Edge AS#1) over the new PDU session (IP#2). For example, the
UE/application may be in the middle of data transfer and changing application
servers may incur additional delays for DNS lookup, TLS security negotiation
and cannot take advantage of connection migration in L4 that support it (e.g.
QUIC).
3\. At some point the Application may trigger that a new DNS request for the
Application FQDN shall be sent. A new DNS request will be triggered if the
application client supports OS notifications of the new IP connection (OSs and
many Application clients are designed already today to use this information in
the WiFi-3GPP access changes. It may also be triggered by an application
internal redirect (e.g. HTTPS redirect), or by loss of connectivity, only to
mention some reasons.
NOTE 2: Application triggers for new DNS resolution results in a network DNS
lookup only after application DNS cache timer expiry. For data transfer prior
to network DNS lookup, the application may use cached application server (Edge
AS#1). How applications maintain cached entries varies, e.g. Google Chrome
flush them if a new default interface is used (as with SSC#3).
4\. The UE may send a DNS Query with the Application FQDN. That query is sent
over the new PSA and it is resolved to an AS#2 that is closets to the new PSA
(e.g. as described in Solution #10). With dynamic insertion of ULCL/ BP and
Local PSA based on DNS queries, the query might not be sent over the New PSA,
but be modified by 5GC to pretend to be sent over a selected new PSA (e.g. as
described in solution #22).
NOTE 3: AS#1 and AS#2 can\'t share same IP address (e.g. Anycast) in Session
Breakout Scenarios if parallel connectivity over old and new PSA is needed.
NOTE 4: With dynamic insertion of ULCL/BP and Local PSA based on DNS queries,
DNS queries may be part of Step1.
5a. A stateless application would start using the new AS#2. A stateful
application may now start to use AS#2 for signalling purposes (e.g. to trigger
a context migration from AS#1).
5b. Stateful applications can leverage that parallel connectivity can coexist
over two different PSAs (if old PSA is available after #1 above) to build
service continuity with low latency optimizations. As an alternative, the
application client could multicast traffic to AS#1 and AS#2 during the context
migration and until AS#2 can take over. AS#1 may also, by application internal
signalling, trigger the application client to move the connection to AS#2
(these are application internal mechanisms).
6\. The application traffic is sent towards the AS#2 that is closer to the new
PSA.
7\. The old PSA is released by CP at timer expiry. The timer should be set to
as long enough to assure the context has successfully transferred from AS#1 to
AS#2.
8\. Only traffic to AS#2 is sent from the application client.
### 6.51.3 Impacts on services, entities and interfaces
No impact. The solution maps to existing functionality and flows in TS 23.502
[3].
## 6.52 Solution #52: Service Continuity at EAS relocation with PSA
coexistence in session break-out scenarios
### 6.52.1 General
The solution addresses Key Issue #2: Edge Relocation. The UE is Edge Computing
service agnostic, so it is unaware of the edge relocation.
This solution supports the service continuity for the Session Breakout model,
where the 5GC UP control provides multiple active Local PSAs for the UE PDU
session. This is then similar to SSC mode #3 solution used for the Distributed
anchor model as described in solution#23 and thus provides the same
flexibility and advantages for the seamless EAS migration.
Service continuity while re-connecting the UE to the new EAS is made possible
by e.g., the following transport and application layer features:
\- HTTP re-direct to the new EAS IP address.
\- The Edge Computing Application in the UE is notified about the new EAS IP
for the same service session. UE Application may communicate in parallel with
both EAS-es if needed.
\- The UE application client is notified of a new UE IPv6 prefix available
(IPv6 case) and based on this trigger it may initiate a new AS discovery e.g.,
by a new DNS query using its new prefix.
This solution follows the principles of Generic solution for Edge Relocation
for all connectivity models (Solution #51), detailing the particularities for
this scenario:
\- Runtime coordination between the 5GC and the application (AF) during the
establishment of the New PSA.
\- Application signalling to notify Edge Computing Application in the UE about
the new EAS IP selected.
The edge application relocation may happen in the following scenarios:
1\. The application server change is triggered by the 5GC wanting to change
the local PSA of the UE. This could happen because of e.g., UE mobility. That
can be notified to the application server side via AF by user plane management
notification of PSA relocation/DNAI change.
2\. The application server change is initiated from the application side e.g.
for load rebalancing reasons due to the serving Edge Application Server
becoming congested. The CN role in this case is to ensure connectivity to the
new EAS by setting up a proper ULCL/BP and Local PSA.
### 6.52.2 Procedures
#### 6.52.2.1 Procedure for edge relocation triggered by the 5GC
The procedure below assumes that the runtime coordination between the 5GC and
the application (AF) is enabled. The coordination provides the notification
and control of old and new ULCL/BP and Local PSA.
Figure 6.52.2.1-1: Procedure for edge relocation triggered by the 5GC
1\. Before or during the edge application connection, the AF may send a
request to influence traffic routing for Sessions or an individual UE address
(see TS 23.502 [3] 4.3.6.2 and 4.6.3.4.) That request provides Traffic
Filters, DNAIs and N6 traffic routing info. The application steering
information could be provided by other means (e.g. as part of an SLA and as
needed e.g. for Solution #3) In addition, subscription to DNAI change
notification is sent to the Core network including the domain name of the
application and the \'AF acknowledgement to be expected\' indication. This
procedure is similar as the steps 1-4 defined clause 4.3.6.2 in TS 23.502 [3].
In addition, the AF also includes in the steering request a new keepExisting
indication, indicating that in the case of UP path changes to the specified
DNAI(s) the existing UP path should also be temporarily kept (i.e. session
continuity upon UL CL relocation is to be used) for the UE during and after
the setup of a new UP path and optionally AF may also provide input for how
long to keep the former PSA. As an alternative, AF could indicate which
minimum time interval can be considered for inactivity of former path.
2\. The PCF generates PCC rules based on the AF request and provides the PCC
rules to the SMF. The PCC rules include the keepExisting indication and
additional information as well. This step may happen during establishment of
the PDU Session or during modification of the PDU Session depending on whether
the request was targeting an ongoing PDU session or not.
It is assumed that the edge application connection is set up using one of the
mechanisms proposed for EAS discovery and selection (e.g., Solution 3);
originally, the traffic flows towards the Old EAS through the Source BP/ULCL
and Source UPF(PSA2) that are set up based on the PCC rules for this
application.
3\. The SMF determines that relocation of Source BP/ULCL and Source UPF (PSA2)
is needed. The relocation may be triggered by UE mobility.
4\. Based on the AF subscription, the SMF sends an early notification to the
AF, including the corresponding source and target DNAI. The SMF does not
proceed until it receives a positive response from the AF, as described in TS
23.501 [2] clause 5.6.7.
5\. Based on target DNAI of the notification received in step 4 the AF (or
some other control logic triggered by the AF) determines that application
server relocation is needed, and it determines the new Edge AS..
6\. The AF sends a Nsmf_EventExposure_AppRelocationInfo service operation to
the SMF for this UE, as described in clause 4.3.6.3 of TS 23.502 [3].
NOTE 1: At this point the Old EAS still handles the edge application
connection (but the instantiation of the New EAS and the context migration
could have been started).
In this message, the AF acknowledges the notification and may provide N6
traffic routing information associated to the target DNAI.
7\. The SMF determines that for this session, it needs to perform a
simultaneous change of BP or UL CL and additional PSA for a PDU Session (as
described in clause 4.3.5.7 of TS 23.502 [3]. The SMF infers from the
keepExisting indication in the PCC rule that session continuity upon UL CL
relocation is to be used and sets up the Target BP/ULCL and Target UPF (PSA2)
determined in Step 3 and configures the filters based on the steering
information already available (see step 1). To support session continuity
during UL CL relocation and EAS migration a temporary N9 forwarding tunnel is
established between the Source ULCL and Target ULCL. described in TS 23.501
[2] clause 5.6.4.2. Current Source BP/ULCL and Source UPF (PSA2) are kept and
a timer is started with a value that considers the information received from
the AF.
NOTE 2: Alternatively, the SMF could set inactivity timers for the traffic
through the Source BP/ULCL and Source UPF (PSA2) to remove them after a period
of inactivity. The inactivity timer has a value equal or bigger than any
minimum time interval to be considered for inactivity of former path provided
by the AF, if any (i.e. all active traffic flowing on it ceases to exist for a
configurable period of time). Or AF could send an explicit notification that
the former connection is no longer needed.
8\. After Target BP/ULCL and Target UPF (PSA3) have been activated (Steps 2-8
in Figure 4.3.5.7-1 in TS 23.502 [3]), the SMF sends event exposure to AF
(late notification) about the new UP path. If that goes to NEF, then NEF
translates it to Nnef_TraffcInfluence_Notify to the AF, as specified in clause
4.3.6.3 of TS 23.502 [3].
NOTE 3: UE traffic can still reach the old EAS through the Source BP/ULCL and
Source UPF (PSA2). This is useful especially while EAS relocation is being
completed and allows the switch to the New EAS to happen when it better suits
the application.
9\. Context migration between old and new EAS completes.
NOTE 4: This step may happen any time after step 5, and it may go before steps
6-8.
10\. After both steps 8 and 9 are completed, Application client is instructed
for when and how to switch to the New EAS, using Application Layer procedures.
There may be instructions sent to the application client for how to proceed:
e.g. continue to use the Old EAS, send traffic to both, or some other
application specific procedure. Any traffic to the New EAS goes via Target
BP/ULCL and Target UPF (PSA3) as provisioned in step 7.
UE application traffic starts to new EAS starts on the path through the Target
BP/ULCL and Target UPF (PSA3).
11\. The SMF removes the Source BP/ULCL and Source UPF (PSA2) after the timer
started in step 7 expires.
#### 6.52.2.2 Procedure for edge relocation triggered by the application
The procedure is similar to the one described in clause 6.52.2.1, with minor
modifications.
It is assumed that the AF can get the information of whether EAS relocation is
needed based on e.g., the edge notification from the edge application itself,
from the application layer management system or some other; the AF also
receives information about the Target DNAI, the UE IP addresses of the ongoing
PDU sessions impacted by the EAS relocation and the target EAS related IP
address(es).
When the EAS change does not involve change of DNAI, that can be handled fully
by the application layer (e.g. following steps 9, 10 and 11 as in the
procedure above).
When the EAS change involves change of DNAI, that needs to be handled in
coordination with the 5GC as described in the following procedure:
Figure 6.52.2.2-1: Procedure for edge relocation with PSA change triggered by
the application
Steps 1-2 in the procedures in Figures 6.52.2.1-1 and 6.52.2.2-1, are
identical, resulting in application connection to Old EAS, through the Source
BP/ULCL and Source UPF(PSA2).
3\. The AF may determine that an EAS change is needed which requires change of
DNAI:
4\. The AF invokes the Nnef_TrafficInfluence service separately for each
individual UE IP address if influence is done via NEF, or sends an
Npcf_PolicyAuthorization Create/Update service request, as described in clause
4.3.6.4 of TS 23.502 [3], using BSF to locate the PCF for each individual UE.
The AF also includes the new keepExisting indication and time information in
the message, if not already done in Step 1.
Alternatively, an optimization step can be used to reduce the signalling needs
for Step 6, since the application triggered server relocation events may in
general involve multiple UEs. In Step 6 the AF invokes a Nnef_TrafficInfluence
service as described in clause 4.3.6.2 of TS 23.502 [3]. where the DNAI
specifies the Target UE Identifier(s) and traffic descriptors further reduce
the scope of the target traffic to be influenced, represented by the
combination of DNN and optionally S-NSSAI, and application identifier or
traffic filtering information.
5\. The PCF then triggers a PCC update to the SMF for the Target DNAI to use
for the given PDU session (as in Step3).
6\. The PCC change triggers SMF to decide on whether change of PSA is
possible/convenient. and if so, it determines the Target ULCL/BP and UPF.
7\. SMF early notification to AF can trigger EAS relocation.
Steps 8-12 are identical with Steps 4-11 from Figure 6.52.2.1-1.
### 6.52.3 Impacts on services, entities and interfaces
SMF: Getting and interpreting keepExisting indication indicating that in the
case of UP path changes to the specified DNAI(s) the existing UP path should
also be temporarily kept (i.e. session continuity upon ULCL relocation is to
be used as well as the timing indication related to keeping the old UP path.
AF: Sending keepExisting indication as well as timing indication to SMF
related to the current UP path.
NEF: Getting and conveying keepExisting and timing indication to SMF (when
communication is done via NEF).
## 6.53 Solution #53: Service Continuity at Edge Relocation with DNS triggered
insertion of BP/ULCL and Edge PSA
### 6.53.1 General
The solution addresses Key Issue #2: Edge Relocation. The UE is Edge Computing
service agnostic, so it is unaware of the edge relocation. This solution
supports the service continuity for the Session Breakout model, where the 5GC
UP control provides multiple active Local PSAs for the UE PDU session. This is
then similar to SSC mode #3 solution used for the Distributed anchor model as
described in solution#23 and thus provides the same flexibility and advantages
for the seamless EAS migration.
The solution complements solutions for dynamic ULCL/BP and Local PSA insertion
(e.g. Solution #22) where Dynamic ULCL/BP and Local PSA insertion is triggered
by the DNS messages for EAS FQDN resolution. That solution requires
involvement of a function that coordinates EAS discovery using DNS and the 5GC
connectivity for the application. This functionality is referred to as LDNSR
in this solution and is described among other in Solution#22.
This solution is based on the method \"Simultaneous change of Branching Point
or UL CL and additional PSA for a PDU Session\" introduced for Rel-16 and
described in clause 4.3.5.7 of TS 23.502 [3] and focuses on the CN actions
needed to setup a new ULCL/BP and Local PSA to support the service continuity.
This solution follows the principles of Generic solution for Edge Relocation
for all connectivity models (Solution #51), with the particularities of the
scenario of Dynamic ULCL/BP and Local PSA insertion:
This solution follows the principles of Generic solution for Edge Relocation
for all connectivity models (Solution #51), with the particularities of the
scenario of Dynamic ULCL/BP and Local PSA insertion:
\- The PDU session update to insert the new PSA happens in coordination with
the EAS selection via DNS or via the proposed enhancement in the 5GC-AF
runtime coordination.
Service continuity while re-connecting the UE to the new EAS is made possible
by e.g., the following application features:
\- Coordination at the Application Layer that allows an Application Client to
inform the Application Server of a new EAS IP address (obtained via DNS),
which may trigger EAS service context migration including providing
instructions the Application client for the switch to the new EAS.
\- Coordination at the Application Layer that allows an Application Server to
inform the Application Client of a new EAS IP address and trigger EAS service
context migration and provide instructions to the Application Client for a
smooth switch to the new EAS.
The procedure for the two variants of the solution are further described
below:
1) Edge Relocation procedure.
2) Edge Relocation procedure optimized with coordination via AF.
### 6.53.2 Procedures
#### 6.53.2.1 Edge Relocation Procedure
Figure 6.53.2.1-1: Edge Relocation procedure
For simplicity, the LDNSR is shown as a UPF function. LDNSR Placement in an
standalone NF after UPF would also be possible.
The procedure is as follows:
1\. The PDU Session is established.
2\. Dynamic BP/ULCL & Local PSA insertion is triggered by the DNS messages
with LDNSR involvement. LDNSR functionality includes selecting the traffic
filters for the BP/ULCL considering the EAS in the DNS response and any local
configuration for the EC Application. The Domain configuration in SMF includes
domain preferences for edge relocation, like whether source PSA and target PSA
need to coexist for some time to facilitate EAS relocation.
The traffic flows towards the Old EAS through the Source BP/ULCL and Source
UPF(PSA2).
3\. The SMF determines that simultaneous change of Source BP/ULCL and Source
UPF (PSA2) is needed. The relocation may be triggered by UE mobility.
4\. The SMF determines that session continuity upon BP/ULCL relocation is to
be used, that is, at change of BP/ULCL & Local PSA, the Target UPF (PSA3) and
the Source (PSA2) need to coexist for some time. Then (as described in clause
4.3.5.7 of TS 23.502 [3]):
\- A temporary N9 forwarding tunnel is established so that traffic can
continue to Old EAS via Source (PSA2). This is described in clause 5.6.4.2 of
TS 23.501 [2].
\- Current Source BP/ULCL and Source UPF (PSA2) are kept and a timer is
started (the SMF could set inactivity timers for the traffic through the
Source BP/ULCL and Source UPF (PSA2) to remove them after a period of
inactivity). The filters in target BP/ULCL are provisioned to support session
continuity during EAS relocation.
The UE traffic continues to reach the old EAS through the Source BP/ULCL and
Source UPF (PSA2). This is useful especially while EAS relocation is being
completed and allows the application client to switch to the new when it
better suits the application (e.g. in coordination with the EAS(s)).
5\. At some point, the UE sends a new DNS Query for the Application domain
name resolution. The DNS Query is sent via target BP/ULCL & PSA1 to LDNSR.
LDNSR influences the DNS resolution to force a DNS response with an EAS that
is closest to target UPF (PSA3). The DNS response includes the new EAS
selected and triggers LDNSR to request a PDU session update to provision the
traffic filters in the target BP/ULCL. The filters are selected considering
the EAS IP address in the DNS response and any local configuration for the EC
Application.
6\. Coordination via Application Layer allows the Application Client to inform
the Application Server of the new EAS IP address obtained using DNS, which may
trigger EAS service context migration. There may be instructions sent to the
application client for how to proceed: e.g. continue to use the Old EAS, send
traffic to both, or some other application specific procedure. Any traffic to
the New EAS goes via Target BP/ULCL and Target UPF (PSA3) as provisioned in
step 5.
7\. The Application client is instructed using Application Layer procedures to
switch to New EAS.
8\. The SMF removes the Source BP/ULCL and Source UPF (PSA2) after the timer
started in step 4 expires.
#### 6.53.2.2 Edge Relocation procedure optimized with coordination via AF
This solution is intended for the case when source PSA and target PSA shall
coexist and its purpose is to make EAS relocation no to depend on when the UE
will be sending a new DNS query. Solution #24 proposes an alternative for the
case when the source PSA and target PSA do not need to coexist at Edge
relocation. In addition, this solution facilitates New EAS selection by
Application Layer providing additional information (an IP subnet that is
representative of the N6 interface of the target UPF).
Clause 6.53.2.1 shows Dynamic ULCL/BP and Local PSA update at edge relocation
triggered by the DNS messages. This solution extends now the coordination of
the 5GC connectivity and the Application layer to use also UP Path change
notifications at Edge Relocation. This functionality with additional
coordination is proposed to be part of SMF.
Figure 6.53.2.2-1: Edge Relocation procedure optimized with coordination via
AF
For simplicity, the LDNSR is shown as a UPF function. LDNSR Placement in an
standalone NF after UPF would also be possible.
In this procedure, the AF subscribes to notifications of UP Path change.
Subscription should happen any time before Step 3 (TS 23.502 [3] clauses
4.3.6.2 and 4.6.3.4. specify the applicable procedures for session(s) or
individual IP addresses (e.g. subscription could be triggered by user
application traffic start)).
Then, the procedure is as follows:
1\. The PDU Session is established.
2\. Dynamic BP/ULCL & Local PSA insertion is triggered by the DNS messages for
Application Domain name resolution. That requires involving LDNSR whose
functionality is described e.g. in Solution#22. The Domain configuration also
includes application preferences for edge relocation, like whether source PSA
and target PSA need to coexist for some time to facilitate EAS relocation.
The traffic flows towards the Old EAS through the Source BP/ULCL and Source
UPF(PSA2).
3\. The SMF determines that simultaneous change of Source BP/ULCL and Source
UPF (PSA2) is needed. The relocation may be triggered by UE mobility.
4\. Based on the AF subscription, the SMF sends an early notification to the
AF that is including the corresponding source and target DNAI. For the target
DNAI, SMF includes also an IP subnet. This subnet is representative of the N6
interface of the target UPF (PSA3) (i.e. it is similar to the ECS added by
LDNSR to DNS queries of EC Domains).The SMF does not proceed until it receives
a positive response from the AF, as described in TS 23.501 [2] clause 5.6.7.
5\. Based on the information received in step 4, the AF determines that EAS
relocation is needed, and it determines the new Edge AS. As an example, AF
could use DNS and include the received IP subnet as ECS in the DNS query to
resolve into the EAS that is closets to the target UPF (PSA3).
6\. The AF sends a Nsmf_EventExposure_AppRelocationInfo service operation to
the SMF for this UE, as described in clause 4.3.6.3 of TS 23.502 [3]. In this
message, the AF acknowledges the notification. AF may provide N6 traffic
routing information associated to the target DNAI. If an IP subnet was
received, AF also provides the IP address of the selected EAS. SMF may update
the Session based on the seleted EAS. At this stage the new path is not yet
established, and any further application action may be on hold till late
nofication is received.
7\. The SMF infers from the domain preferences for edge relocation of the
application(s) steered via BP/ULCL & Local PSA in this PDU Session, that at
change of BP/ULCL & Local PSA, the Target UPF (PSA3) and the Source UPF (PSA2)
need to coexist for some time, that is that session continuity upon ULCL
relocation is to be used (as described in clause 4.3.5.7 of TS 23.502 [3]):
\- A temporary N9 forwarding tunnel is established so that traffic can
continue to Old EAS via Source (PSA2). This is described in TS 23.501 [2],
clause 5.6.4.2.
\- Current Source BP/ULCL and Source UPF (PSA2) are kept and a timer is
started (the SMF could set inactivity timers for the traffic through the
Source BP/ULCL and Source UPF (PSA2) to remove them after a period of
inactivity). The traffic filters in target BP/ULCL are provisioned to support
session continuity during EAS relocation:
The UE traffic continues to reach the old EAS via the Source UPF (PSA2). This
will be useful especially while EAS relocation is being completed and allows
the application client to switch to the new when it better suits the
application (e.g. in coordination with the EAS(s)).
8\. After Target BP/ULCL and Target UPF (PSA3) have been activated (Steps 2-8
in Figure 4.3.5.7-1 in TS 23.502 [3]), the SMF sends event exposure to AF
(late notification) about the new UP path. If NEF is used, then this
translates to Nnef_TraffcInfluence_Notify to the AF, as specified in clause
4.3.6.3 of TS 23.502 [3].
9\. Context migration between old and new EAS completes.
10\. Application client is instructed for when and how to switch to the New
EAS, using Application Layer procedures.
11\. The SMF removes the Source BP/ULCL and Source UPF (PSA2) after the timer
started in Step 7 expires.
### 6.53.3 Impacts on Existing Nodes and Functionality
1\. Impacts related to Dynamic ULCL/BP and Local PSA update at edge relocation
triggered by the DNS messages a are described for Solution #22.2. Impacts
related to Extensions for service continuity as described in this solution for
the Basic Procedure (clause 6.53.2.1):
\- SMF may be configured with the Application preferences for PSA coexistence
at edge relocation.
3\. Impacts related to Extensions for service continuity as described in this
solution to optimize the edge relocation procedure (clause 6.53.2.2):
\- SMF to determine, at edge relocation, the IP subnet that is representative
of the N6 interface of the target UPF (PSA) for the target DNAI and to include
it in the Nsmf_EventExposure_Notify (early) the AF.
\- AF to determine, when Nsmf_EventExposure_Notify (early) is received with
the IP subnet, the New EAS IP address and include it in the
Nsmf_EventExposure_AppRelocationInfo service operation to the SMF.
\- SMF take into account for the PDU Session Update the Application
preferences for whether PSAs should coexist for the Application and the EAS
received in the Nsmf_EventExposure_AppRelocationInfo.
## 6.54 Solution #54: EAS relocation for SSC mode 3 PDU Session
This solution is for Key Issue #2 on EAS relocation after PDU session re-
establishment for SSC mode 3 PDU session.
### 6.54.1 Description
The AF (e.g. Old EAS) subscribes to UP path change notification. After the PDU
Session re-establishment of the SSC mode 3 PDU Session, the SMF sends UP Path
change notification to the AF, providing the new DNAI of the PDU Session
Anchor UPF of the new PDU Session. The AF reselects target EAS based on the
new DNAI and triggers context relocation between old EAS and new EAS.
### 6.54.2 Procedures
Figure 6.54.2-1: EAS relocation after SSC mode 3 PDU Session re-establishment
1\. The AF (e.g. Old EAS) subscribes to UP path change notification regarding
the PDU session to SMF. This may be triggered by the UE establishing
connection with the old EAS.
NOTE 1: In this procedure, as an example, the Old EAS acting as AF interacts
with 5GC directly. It is possible that the Old EAS interacts with 5GC via an
AF. The details of which entity interacts with 5GC and which entity (AF or old
EAS) reselects the target EAS are up to implementation.
2\. When UE moves, the SMF decides to re-establish PDU Session to the same DNN
for the SSC mode 3 PDU Session. This may be because the UE has moved out of
the service area of the UPF of the old PDU Session. The SMF1 determines the
target DNAI.
3\. If the AF has subscribed to Early notification, the SMF1 sends early
notification to the AF. The target DNAI determined by the SMF1 is sent to AF.
4\. The AF prepares the EAS relocation.
5\. The AF responds to the early notification.
6\. The SMF1 sends PDU Session Modification Command to UE via AMF. During the
procedure (step 2 of clause 4.3.5.2 of TS 23.502 [3]), the SMF1 sends PCF ID
and SM Policy Association ID, and optionally target DNAI if SMF is to be
changed, to AMF.
7\. The UE initiates a new PDU Session establishment to the same DNN, during
which (In step 3 of clause 4.3.2.2.1 of TS 23.502 [3]), the AMF sends the PCF
ID and SM Policy Association ID to the SMF2. The SMF2 selects the same PCF for
the new PDU Session and sends the SM Policy Association ID to PCF. If the AF
has subscribed to UP path change notification for the old PDU Session before,
the PCF sends the Notification URI of the AF for the UP Path change
notification to SMF2.
8\. After the new PDU Session to the same DNN has been established, the SMF2
sends UP Path change notification to the AF that subscribed for this event.
The notification includes the DNAI(s) corresponding to the UPF of the new PDU
Session and the IP address of the new PDU Session.
NOTE 2: This only applies to the case in which the SMF does not change for the
new PDU Session.
9\. The AF (or old EAS) starts context migration between old EAS and the
target EAS.
10\. The AF (or old EAS) redirects the UE to the target EAS based on
application mechanism or via NAS notification. The UE establishes connection
with target EAS.
NOTE 3: Service continuity can be achieved based on TCP connection termination
mechanism (i.e. four-way handshake). During the old TCP connection termination
procedure, the UE and the old EAS can determine the packets that have not been
acknowledged by the receiver side. The UE and the target EAS then can continue
sending these packets over the newly established connection between the UE and
the target EAS.
### 6.54.3 Impacts on services, entities and interfaces
SMF:
\- Sends PCF ID and SM Policy Association ID to AMF when it triggers SSC mode
3 PDU Session Re-establishment and SMF is to be changed.
\- Receive PCF ID and SM Policy Association ID from AMF during PDU Session
Establishment.
\- Select PCF based on PCF ID received from AMF, and provide SM Policy
Association ID to PCF.
AMF:
\- Receive PCF ID and SM Policy Association ID from SMF when it triggers SSC
mode 3 PDU Session Re-establishment.
\- Send PCF ID and SM Policy Association ID to SMF during PDU Session re-
establishment.
PCF:
\- The PCF associate the new PDU Session with the existing SM Policy
Association per received SM Policy Association ID.
UE:
\- Informs the network of their capability to support NAS PCO solution if use
NAS notification to redirect to target EAS.
\- NAS layer receives and forwards EAS IP address sent by the network to the
upper layer if use NAS notification to redirect to target EAS.
## 6.55 Solution #55: Multiple AFs
### 6.55.1 Description
This solution addresses scenarios where Edge Application Server(s) and
Application Function are located at the Edge Data Network, thus implying
multiple AF instances i.e. one (or more) local AF(s) and also a central AF.
Application Function here acts as control plane entity managing one or more
EAS and responsible to interact with 5GC. In such deployment scenarios: as
part of initial PDU session establishment, a central AF may be involved,
however, due to relocation to Edge DNAI and corresponding EAS relocation, a
new local AF serving the Edge Applications may be selected.
There are a few additional details that needs to be addressed in such multiple
AF deployments, such as: how to relocate AF, how SMF provides to new AF
required notification of user plane management events such as PSA relocation,
etc.
### 6.55.2 Procedures
Detail procedure involving multiple AF scenarios are provided in the below
figure 6.55.2-1.
Figure 6.55.2-1: Procedures to AF Relocation
0\. AF1 is interacting with SMF/5GC e.g. as part of initial PDU Session
establishment procedure.
1\. AF1 decides to relocate to local AF i.e. to AF2 which serves local EAS
located in the target DNAI. There could be multiple triggers for AF1 to
relocate AF e.g. due to decision to relocate to local /another Edge
Application Server due to change in DNAI, EAS load balancing, etc.
2\. AF1 initiates AF relocation information transfer with AF2, this is to
provide to AF2 information such as: application status, UE ID, PDU session
Information(e.g. the UE (IP) address, the current DNAI serving the UE, N6
traffic routing information), etc. Any application context transfer details
are out of scope of SA2. Subsequently, AF1 may cancel its earlier request by
Nnef_TrafficInfluence_Delete service operation providing the corresponding AF
Transaction Id.
3a: AF2, based on the information received from AF1, sends via NEF,
Nnef_TrafficInfluence_ Create request to the UE ID provided by AF1. It
includes AF Transaction ID, UE ID, PDU session information, DNN, S-NSSAI if
available and/or received from AF1.
3b. Alternatively, AF1 sends to NEF, Nnef_TrafficInfluence_update request, and
includes application status, the target AF information (e.g. AF2 ID, IP
address), UE ID.
4: NEF stores the AF1/AF2 requested information in the UDR (Data Set =
Application Data; Data Subset = AF traffic influence request information, Data
Key = AF Transaction Internal ID, S-NSSAI and DNN or SUPI).
5: NEF acknowledges to AF1/AF2 by sending Nnef_TrafficInfluence_update
response message.
6\. UDR notifies to PCF with Nudr_DM_Notify of the changed subscription.
Steps 4 to 6 are per R16 specifications.
7\. PCF determines that existing PDU Session is impacted by the AF1/AF2
request, and so it updates the SMF with corresponding new PCC rule(s) by
invoking Npcf_SMPolicyControl_UpdateNotify service operation.
If the AF request includes a notification reporting request for UP path
change, the PCF includes in the PCC rule(s) the information required for
reporting the event, including the Notification Target Address pointing to the
NEF or AF and the Notification Correlation ID containing the AF Transaction
Internal ID.
8\. Based on the updated PCC rules received from PCF, SMF may decide to
reconfigure user plane e.g. change in DNAI, PSA relocation and so on.
9-10. SMF sends Nsmf_EventExposure_Notify indicating the changes in the user
plane management information to AF1/AF2, based on information received in step
7, either directly or via NEF.
11\. The AF1 transfers the UP management information to AF2, as receives in
step 9-10 (if the target of notification is AF1).
### 6.55.3 Impacts on services, entities and interfaces
SMF:
\- Updates to procedure on AF requests to influence traffic routing.
AF:
\- AF relocation information transfer between AFs e.g. UE ID, PDU session
Information, current DNAI serving the UE, etc.
\- determination of the target AF for the received target DNAI.
\- Updates to procedure on AF requests to influence traffic routing.
## 6.56 Solution #56: Edge NEF based Network Information Provisioning
This solution is for Key Issue #3 on Efficient Network Information
Provisioning to Local Applications.
### 6.56.1 Description
Edge NEF is an effective way to solve the issue of efficient network
information provisioning to local applications in the edge environment. It can
be deployed at the edge for reducing the latency of network information
provisioning. However, the relationship between central NEF and edge NEF is
not clearly described. Several issues illustrated below has to be addressed:
\- How to insert/remove edge NEF with the support of the central NEF?
\- How to notify the existence of edge NEF to the NF within the 5GC?
\- How to authorize the edge NEF to obtain the network information for certain
AF with the support of the central NEF?
In order to shorten the path between NF(e.g. SMF) which can provide the
network information and the AF, the edge NEF can be deployed either within the
Operator domain but near the edge (e.g. near or within the UPF) or within the
domain of ECSP. No matter where the edge NEF locates, the Operator has the
full control over the edge NEF. The insertion of edge NEF should be made aware
by the NF within the 5GC so that the NF can send the network information
directly to the edge NEF. Since the edge server belonging to different ECSP
may be deployed within a same edge area. The edge NEF need to know which edge
server needs to be provisioned. In addition, different edge server may require
service from edge NEF regarding different type of network information. The
differentiation of network information provisioning also needs to be
implemented.
In order to solve the aforementioned issue, this contribution proposes a
solution for the management of edge NEF.
### 6.56.2 Procedures
#### 6.56.2.1 Edge NEF-based Network Information Provisioning
Figure 6.56.2.1-1 illustrates the procedure for edge NEF-based network
information provisioning. The central NEF can have the functionality of the
configuration of edge NEF and the authorization of certain network information
provisioning type data which can be directly delivered to the edge NEF.
Figure 6.56.2.1-1: Edge NEF based Network Information Provisioning
1\. Upon the request of a local AF (using e.g. the DNAI), the Central NEF
determines whether to insert an edge NEF. Alternatively, the Central NEF sends
notification regarding the insertion of edge NEF to the local AF. Local AF can
decide whether to use the edge NEF via sending a response to the Central NEF.
2\. The edge NEF can be inserted either within the MNO domain (e.g. near the
UPF) or within the 3rd party domain. If inserted in the 3rd party domain, the
Central NEF needs to conduct authentication with the AF before the insertion.
The edge NEF is always owned/operated by the Operator.
3\. The Central NEF configures the edge NEF either within the MNO domain or
within the 3rd party domain.
4\. The Central NEF send parameterExposure enable request (e.g.
Nsmf_EventExposure_Subscribe through UDM) to SMF. The request information
contains edge NEF ID, AF ID and Network information provisioning type, for
example, UE route change information, etc.
NOTE 1: To support the SMF send network information directly to edge NEF, it
is required that SMF is deployed near the edge area.
5\. SMF conducts route change for the UE by modifying the UPF.
6\. SMF sends Nsmf_EventExposure_notify including DNAI and N6 routing
information to the edge NEF. Upon the receipt of the message, the edge NEF
forwards the information to the corresponding AF using
Nnef_EventExposure_Notify.
7\. AF requests for QoS related parameter from the 5GC. This triggers QoS
monitoring for specific UE per Rel-16 specifications.
8\. UPF sends QoS-related data (e.g. round-trip delay) to the SMF via the N4
report message.
9\. SMF sends Nsmf_EventExposure_Notify including the QoS-related data to the
edge NEF. Upon the receipt of the message, the edge NEF forwards the
information to the corresponding AF using Nnef_EventExposure_Notify.
10\. The central NEF can optionally sends parameterExposure disable request
(e.g. Nsmf_EventExposure_Unsubscribe through UDM) to SMF. After receiving this
message, the SMF will send event exposure related message to the Central NEF.
11\. The Central NEF sends parameterExposure enable request to MnS producer.
The request information contains edge NEF ID, AF ID and Network information
provisioning type, for example, radio network information.
12\. The MnS producer send the radio network information to the edge NEF
following certain radio network information exposure policy.
NOTE 2: The MnS server discover may need certain OAM configuration
information.
13\. The central NEF can remove the edge NEF.
### 6.56.3 Impacts on services, entities and interfaces
Central NEF:
\- manages the edge NEF (i.e. insertion and removal of edge NEF).
\- sends message to NF (i.e. SMF) in order to notify the NF to send network
related information directly to the edge NEF.
\- Notify the local AF regarding the information of inserted edge NEF.
# 7 Overall Evaluation
## 7.1 Evaluation of Solutions for Key Issue #1
### 7.1.1 General evaluation criteria
The following criteria will be used for evaluation of the solutions proposed
to KI#1. The following points shall be evaluated:
1\. Use of collaborative scenarios, i.e. application providers and operators
cooperating to offer customers the best of the services possible so that
operator networks handle enough information to facilitate placing those
customers at the edge.
a) UEs be provided and making use of proper rules (e.g. URSP) that will help
quick discovery and selection of servers, and to facilitate mobility and
continuity.
\- Extension of URSP rules to include additional configuration information.
b) Insertion of breakout points (ULCL) in situations in which the available
support from UE is scarce/null or UE IP address preservation is needed in
mobility.
c) Application Providers facilitating information related to edge servers
deployed (i.e. FQDNs/IP addresses accessible through specific DNAIs).
d) Use of relevant rules based on Application Service Provider information for
dynamic insertion of ULCL/Edge PSA when needed.
e) Use of address resolvers, DNS-like, in these collaborative scenarios,
located in the user plane path, making use of the information provided by the
Application Service Provider (i.e. FQDN, IP address, DNAI, validity period,
etc). The address resolvers to act as secure proxies if the resolvers (under
SLA) sit outside the operator boundary.
Scope of the DNS hierarchy (e.g. include or not Internet DNS resolvers, etc)
as to avoid ECS leakage outside the system.
Description of limitations derived from UEs OSs as well as handling of cache
management, for cases of EAS instance address changes, either using flushing
or other means.
2\. Use of UE information, subscription data and/or network
configuration/status information, together with Application Service Provider
information for session anchoring at session establishment with provision of
relevant address resolver/secured proxy based on anchor used.
3\. Introduction of the network functionality, which can be combined with
other NFs, able to hold/retrieve information provided by the cooperating
Application Service Provider, acting as address resolver/secure proxy,
contributing to decisions on anchor point selection, and helping with rules
setting in the case of breakout scenarios.
4\. Adherence to concepts and principles used in 5GC, e.g. SBA and modularity.
5\. Privacy considerations according to regulatory requirements.
### 7.1.2 Privacy Considerations
Traffic of Applications that use encrypted messaging, including for DNS
resolution, cannot be inspected on path to reconfigure the user plane for an
optimal path. Thus, configuration of parameters and procedures to establish an
optimal PDU session may not be applicable in this case.
For various scenarios, 5GC and application providers may have different levels
of trust and agreements to cater to regulatory requirements and privacy of
data. When privacy regulations require data to be located within an area,
transfer of data to 3rd party provider should be bounded to that area. One
common point to handle this is with policies at external boundaries in the
routing domain (N6 interface). There should be no direct impacts to the
solutions proposed here.
When data privacy concerns require that no data, including DNS traffic may be
observed in-transit between the UE and the network DNS resolver in a 3rd
party/application domain, solutions for selecting the DNS resolver as well as
for forwarding application data should not reveal any additional information
than in the packet headers. Thus, in all cases, E2E encryption of DNS and
application packets is required.
In privacy mode, DNS stub resolvers in the UE may be per application, or
implemented in the OS per policy domain or system wide and these resolvers may
have different behaviour of TTL and caching. When the network DNS resolver is
in 3rd party network, fine grained coordination across 5GC and application
domain is not studied. Dynamic insertion of UL CL / BP is possible by using
existing Rel-16 mechanisms. Whether LDNSR could be used in this case is
further determined in solution#22.
The operator may protect the UE by allowing the UE IP address to be routable
only inside the operator network and the operator can only provide UE location
information to the DNS of the 3rd party by NATing the DNS requests with a
source IP address that refers to the location of NAT server as shown in
solution #4 (Figure 6.4.2-1: DNS handling with UL CL and NAT, in which NAT
server is on the N6 path). A UE IPv6 address routable only in operator network
would be translated similar to IPv4 NAT translation. DNS or application
traffic may only be steered by ULCL using traffic filters that are established
per destination (application) address or port. The \"closest\" server is
selected with dynamic routes in N6 if the application uses anycast destination
addresses.
### 7.1.3 Evaluation for Key Issue #1: ECS address provisioning
Solution #16 deals with the case where the UE hosts an Edge Enabler Client and
Application Clients as described by SA WG6 in TS 23.558 [12]. As discussed in
Solution #16, SA WG6 has introduced functional entities called Edge
Configuration Servers and Edge Enabler Servers (EES) which can be used by UE
Applications to discover Edge Application Servers. SA WG6 has agreed that ECS
address information can be provisioned by MNO through a 5GC procedure and that
such 5GC procedure is in SA WG2 scope. Solution #16 describes how UE
Applications can discover contact information for Edge Configuration Servers.
Thus, when paired with the features specified by SA WG6 in TS 23.558 [12],
Solution #16 may be considered an enablement to \"discover a suitable Edge
Application Server to serve the application/UE\".
But in order to deliver the ECS information via NAS to EEC, UE requires a new
UE capability (e.g.: enhancement in UE OS/kernel). Not all of the UE is
guaranteed to support this capability. The solution will not work for the UEs
that do not support this UE capability.
In S2-2008359, SA6 stated \"Regarding Solution #16, SA6 recommends the 5GS
sending the ECS address information to the UE as suitable for complementing
the EDGEAPP solutions for UEs hosting an EEC and with the capability to
deliver the information received from 5GC to the EEC.\".
### 7.1.4 Evaluation for Key Issue #1: DNS based solutions for Multiple PDU
Sessions
The Multiple Session connectivity model enables that Edge Computing
applications can use a specific PDU session with the PDU Session anchor in the
local site whether the rest of applications use a PDU Session with a central
PDU Session anchor. The mapping between applications and PDU sessions is
steered by the URSP rules.
Using DNS for EAS Discovery, also the mapping between the DNS and PDU sessions
needs to be carefully considered
From evaluation of solutions #1, #4, #5 (URSP part), #13 and #21 the following
is concluded:
For an EC Use Case to work on multiple sessions connectivity model using URSP
rules, the solution involves:
\- The UE, and how it handles the application requests and related DNS queries
and the relation of that to user defined DNS settings, URSP rules and the
established PDU sessions and their settings.
\- The URSPs traffic and route selection descriptors.
\- The mapping rules between AF request parameters and URSP rules parameters
in UE such as relationship between DNAI and DNN.
The recommendation is to define the URSPs so that Domain Descriptors are used
to steer the DNS and the Application traffic into PDU sessions.
The following clarifications are therefore required on how the Domain
descriptors in URSP are used on the UE:
\- When a UE issues a DNS request targeting the FQDN of an App, the PDU
Session in which to send the DNS request is controlled by URSP rules.
\- The UE should be able to use URSP procedures to setup the PDU session prior
to sending a DNS query
\- The DA of the DNS request is the DNS server address of this PDU Session
configured by the 5GC (SMF) to the UE by one of available means.
It is understood that Rel-16 UEs support the behaviour described in the 3
bullets above.
The UE should be able to (re)evaluate the application association with a PDU
session based on Location Criteria generated per AF requested Spatial Validity
Condition.
The solution is not guaranteed to work, when the UE doesn\'t support URSP rule
provisioned from PCF, when the DNS Server at the UE has been configured by the
user, when the Application Client generates the DNS Query outside of DNS
libraries in the OS with DoT, DoH or other over the top mechanisms. For the
last two cases, the DNS resolvers or servers in the third party may take the
source IP address of the DNS request as the location information of UE, which
may correspond to the local/remote PSA UPF or other entities (e.g. a NAT
server) on the N6 interface. Such guidelines should be captured to cover these
scenarios.
NOTE 1: This can correspond to devices doing tethering, or to devices deployed
for specific corporate purposes.
In addition, as a pre-requisite:
\- The configuration in SMF for the parameters in the PDU Session
Establishment Request shall assist SMF to select the right UPF/PSAs for the
PDU Session.
Editor\'s note: The list of the new configuration data in the SMF needs to be
detailed, possibly in the conclusions clause.
Solution #1 proposing to Enhance the NEF service to allow the AF to influence
PCF decisions for URSP rules is recommended for normative phase. The
enhancements shall support the recommendations above.
Solution #1 fulfils the mechanisms to enable AF to influence PCF decision for
URSP rules.
Solution #1 has no impact to existing UE configuration and is based on Rel-16
UE behaviour. URSP rules are not applicable to session breakout scenarios
(e.g.: UL CL situation).
NOTE 2: The UE is not aware of whether the DNS request is for Edge computing
or not.
How AF can guide PCF to send proper URSP rules needs to be defined.
### 7.1.5 Evaluation for Key Issue #1: Solutions for Distributed Anchors
Many solutions propose using DNS for EAS discovery for distributed anchor
connectivity model.
A DNS based mechanism for EAS discovery supports the different EAS deployments
described in KI#1. It has no impact on the Application itself and keeps UE
unaware of the application deployment (at edge or at central DN) and
application ownership (e.g. the EAS is owned by the MNO or by a third party)
aspects. The TR includes DNS based solutions for the other connectivity models
as well, and so, applications can be developed to rely on DNS for EAS
discovery and be agnostic of the operator connectivity model chosen.
Distributed anchor part of Solutions #2, #4, #5 and #10 describe DNS based
working solutions for EAS discovery for distributed anchor connectivity model.
These solutions are using DNS state of the art: many Authoritative (DNS) Name
servers already today return different responses based on the perceived
topological location of the user, either using the source IP address of the
DNS query or ECS when received according to RFC 7871 [7].
A pre-requisite for solutions in the distributed anchor point scenario is to
anchor the UE according to subscription policies.
The goal is to provide to DNS addressing information related to the UE
topological location. These solutions show that in 5GC that can be achieved
by:
A. Providing a DNS for the PDU Session that is near the PSA, the DNS request
can be solved to an Application server which is closest to that PSA. Solution
alternatives:
\- The 5GC(SMF) provides a DNS that is closest to the PSA
\- The 5GC(SMF) provides an Anycast DNS address
B. Including in the DNS Query an ECS that is representative of the UE location
/N6 interface, DNS can provide an EAS that is closest to the PSA. Solution
alternatives:
\- The 5GC(SMF) provides a DNS that supports RFC 7871 [7] and adds an ECS that
is representative of the UE location /N6 interface, e.g. based on the user IP
address after (an optional) NAT.
The above summary plus a selection of procedures from solutions #2, #4, #5 and
#10 are to be promoted into normative phase. Procedures from these solutions
that illustrate recommended solution versions are: 6.2.3.1, 6.5.2.6, 6.5.2.7,
6.10.2.1 and 6.10.2.2.
These solutions solve KI#1 under certain conditions that are to be documented
together with the solutions in normative phase:
\- These solutions require the corresponding geographical resolution support
by the Authoritative (DNS) nameserver.
\- These solutions are guaranteed to work if the operator provided DNS
settings are used by the UE for the DNS Query. If the OS, user or applications
may override the operator-provided DNS settings, the DNS resolvers or servers
in the third party could only get the location related information based on
the source IP address of the request which may corresponds to the information
of the anchor UPF. Such guidelines should be captured to cover scenarios where
the OS, user or applications may override the operator-provided DNS settings.
\- When UE DNS Queries are sent to another DNS Resolver instead (that depends
on the UE Application client, Browser and/or OS configuration) if that is
centrally deployed and it does not support RFC 7871 [7], the selected AS might
not be closest to the User PSA. Complementary application layer mechanisms may
be needed to reselect AS based on the source IP address of the user
application traffic.
\- UE IP address may be subject to privacy restrictions, in which case, it
shall not be sent to authoritative DNS/ DNS resolvers outside the network
operator within ECS or as UE source IP address. UE source IP address could be
hidden by NATing the DNS request.
Solution #12 thus provides an alternative to DNS triggered dynamic
establishment of UL CL/BP and local PSA for Session breakout connectivity
model described in Solution #22. It triggers re-anchoring of a SSC mode 2/3
PDU Session to change the PDU Session connectivity from central to distributed
anchor, by leveraging on SSC mode 2 and SSC mode 3 enablers. The two
solutions, Solution #12 and Solution #22, make use of new LDNSR and are
aligned. When triggering a new PDU session, the old PDU session will be
released immediately or later, depending on the SSC mode of the old PDU
Session, which means other services on the old PDU sessions need to be either
migrated or released together. The Solution #12 includes an alternative that
is more suitable for SSC#2 that is dropping the DNS message. In this case, the
application client in the UE is assumed to support the OS notification of the
new connection and based on that to send a new DNS query as soon as the new
connection is available.
Solution #14 is an application layer solution to discover an Edge AS with no
impact on 5GC when used with distributed anchor connectivity model. It is up
to the application provider to adopt or not this mechanism if desired. 5GC
does not preclude this option. This solution may be mentioned during normative
phase as a complement to DNS based discovery for distributed anchor
connectivity. The solution assumes the Service Switch is pre-configured the
mapping information between the IP address range supported by PSA and EAS
information based on the agreement between the MNO and service provider. The
solution does not provide a description of the procedure for this connectivity
model, so no procedure of this solution for Distributed anchor model is
recommended into normative. Then, regarding the rest of the solutions for KI#1
and Distributed Connectivity model:
Solutions #6 should not be promoted into normative for this scenario, but it
should be evaluated with the rest of solutions for session breakout
connectivity model.
Solution #18 addresses the scenario where DNS might not be able to return an
AS that is closest to the user location. Unless EC App flows can be
differentiated on L3 level, the proposal implies buffering, mapping and
remapping and resolving in UPF all first packet of flows showing a new
destination IP, which will impact latency and throughput. It is also unclear
how it coexists with application layer solutions for service continuity: UPF
may overwrites any new target EAS selected at App layer for that app client,
which could break procedures for seamless AS relocation for load balancing,
resilience or to adapt to edge relocation. This solution relies on IETF
standards, but reverse DNS lookup is not critical to the normal function of
the internet, and so, it is not universally adopted, which questions the
effectiveness of the solution. Rapid mapping/remapping of PTR, SRV and A/AAAA
is not well-suited to DNS, and will also require cache flushing throughout the
DNS hierarchy. This solution is not recommended into normative.
### 7.1.6 Evaluation for Key Issue #1: Solutions for Session Breakout
Solution #2, #3,#4,#5,#6,#8,#9,#10,#11,#12,#14,#15,#19,#20,#22 describe
solutions for DNS based EAS discovery for session breakout case. Solution #22
is considered as merged main ideas from other solutions and is recommended as
baseline for normative phase.
## 7.2 Evaluation of Solutions for Key Issue #2
### 7.2.1 Evaluation for Key Issue #2: Reducing packet loss during EAS
relocation
In Solution #27, if L4 connection between UE and EAS is kept, when the SMF has
established the forwarding tunnel between the source UL CL and the target UL
CL, the SMF sends Late Notification to the AF to trigger the EAS relocation.
The new PSA buffers the uplink data until the AF indicates the successful
application relocation. This can help to reduce packets loss when the target
EAS is not ready. However, EAS relocation is triggered by late notification
from the SMF and the application layer notification from UE. This ensures that
there is no uplink packets from the UE towards the old EAS after the EAS
relocation. Therefore, Solution #27 can help to reduce packet loss during EAS
relocation by supporting uplink buffer in new local PSA.
In Solution #38, similar as solution#27 the new PSA buffers the uplink data
until the AF indicates the successful application relocation. In addition, two
options are proposed to resolve the packet loss issue.
For Option 1, a forwarding tunnel between source PSA and target PSA is
established. Before the EAS relocation is started and the old EAS stops to
serve the UE, the old PSA stops sending packets over N6 and forwards the
received uplink packets to the new PSA via the forwarding tunnel. This can
ensure packet lossless within 5GS. The End-Marker introduced can help to
ensure in-order delivery. Therefore, the forwarding tunnel between the old PSA
and new PSA in Option 1 in Solution#38 can avoid the on-fly packet loss over
N3/N9 and reduce packets loss over N6.
For Option 2, in order to ensure packet lossless between UE and EAS, the
packet in user plane need to be enhanced to include Flow End Marker.
Therefore, with user plane enhanced (i.e. by use of the extension header of
the uplink packets) the Option 2 in Solution #38 can avoid the on-fly packet
loss over N3/N9 and N6. Option 2 needs the coordination between the 5G and
application in user plane.
If stateful L4 mechanisms (e.g. TCP) are used, the above packet forwarding
between source PSA and target PSA requires the EC environment to support
migrating of L4 contexts.
Solution #27 and #38 buffer packets while the server is being relocated so
that packets can be delivered even if with higher latency. If L4
flows/congestion control is based on measured latency, additional buffering
may distort estimates of latency and throughput.
For these solutions, the assumption is that, either the application client has
lost communication to source EAS and it tries to connect to target EAS
instead. Or the communication to source EAS is still possible, but the
application client tries to set up a connection over the new PSA with the
target EAS which it is not yet ready.
For the second case, alternatives to packet buffering in the core would be for
example, to postpone at the application client the sending of packets to the
target EAS till it is ready (notified via application layer coordination), or
to buffer the packets in the target EAS, which postpones processing till it is
prepared.
Buffering of packets in the 5GC may be applied to all connectivity models.
Whether Buffering of uplink packets applies or not to the traffic of certain
application depends on the specific application requirement.
### 7.2.2 Evaluation for Key Issue #2: UE DNS cache renewal and EAS
reselection by UE
For Session breakout:
**Issue 1: DNS cache renewal.**
For the EASs to which the UE has no ongoing connection, the UE may have stored
DNS cache for these EASs. For this case, after ULCL insertion/change/removal,
the cached records may be outdated.
Solution #24 uses ICMP unreachable message to trigger UE reselection of EAS.
It assumes that either the TTL of the stored DNS record is very low or only
one EAS IP address is stored for the FQDN. This gives restriction to operator
deployment. Besides, a short TTL will cause the UE to re-discover EAS IP
address frequently and consumes bandwidth and causes application layer delay.
In addition, there are concerns on usage of ICMP message in the solution for
security reasons. And it\'ll add delay for the connection establishment with
the EAS as well. Hence, Solution #24 is not recommended for Issue 1.
Solution #32 and Solution #34 (clause 6.34.2.1) support Issue 1 too. In these
2 solutions, a DNS context control information, i.e. DNS cache flush
indication and its associated information (for example, domain names and IP
address range), within NAS message is sent to UE to enable the UE to
remove/renew the cached records.
**Issue 2: EAS relocation**
For the EASs to which the UE has ongoing connection, the UE may need be
triggered to reselect a new EAS address due to a new EAS is more suitable to
serve the UE.
Solution #53, clause 6.35.2.1 suggests that UE reselects a new EAS after ULCL
insertion. If connectivity is available towards the source PSA-UPF when a
target PSA-UPF is selected, and towards the source AS when the target AS has
been selected, then there is no immediate need to change the AS. For these
situations the timeout for the DNS cache (if low enough, which is reasonable
to have for an application layer DNS cache and for TTL in the DNS entries).
Solution #24, #31, #32 and #34 can be used as triggers to trigger UE to
reselect EAS.
Solution #24 is not very friendly to support EAS relocation, it is a hard
switch from old EAS to new EAS, the application may experience packet loss and
delay due to the packet to old EAS is routed to SMF. Hence, it is not
recommended to use ICMP to trigger the EAS reselection.
Instead, Solution #31/#32/34 can trigger the UE to reselect EAS too, and they
are more friendly. The UE can still connect to the old EAS while the new EAS
is selected for new connections. If the N9 tunnel is established between old
ULCL and new ULCL, the application layer can have a smooth switch from old EAS
to new EAS, packet loss can be avoided.
How the context is migrated between the old EAS and new EAS, and when the UE
starts to send packets to the new EAS are left for conclusion in other
contributions.
For SSC mode 2/3:
For SSC mode 2/3 case, the UE will receive a new IP address. The new IP
address can be used as a trigger to remove the DNS cache, and to reselect a
new EAS.
How the context is migrated between the old EAS and new EAS, and when the UE
starts to send packets to the new EAS are left for conclusion in other
contributions.
For PSA coexistence at edge re-allocation:
Solution #31 proposes that AF provides indication of the expected time for
application relocation that can be used for the calculation of the PDU Session
Address Lifetime of the PDU Session. Solution #52 is proposing to include
indications to SMF that can be used to decide on the need of the N9 forwarding
tunnel and the decision to remove it. Both have identified there may be a
value in assisting SMF control of the connection coexistence with application
information.
**Impact of Application Layer DNS caching:**
Some application may have DNS caching at the application layer. DNS caching at
the application layer results in name resolution using previously cached
entries that will result in no new DNS network lookups until the application
cache timer expires.
Since cache timeout values on the caching UE application side can be
significant, the following behavior may happen:
\- Applications may determine to flush its local caching before the cache
timer expires.
\- Applications using connection oriented transport establish connection
towards new EAS when:
(a) an application layer redirect is sent with the URL/FQDN of the new EAS; or
(b) an application uses anycast destination addresses that are routed to the
new \'closest\' EAS. No new procedures are required for KI#2 in this case; or
(c) establish new connection to new EAS after DNS caching is flushed by the
applications or cache timer expires.
\- Applications not using connection oriented transport (e.g., multicast or
subscribe/ notify communication patterns) should be responsible for detecting
connection change (e.g., notification from UE connection manager). The
application should take appropriate actions to indicate new IP address (e.g.,
in IGMP/MLD membership report message; new subscribe message).
### 7.2.3 Evaluation for Key Issue #2: AF based EAS rediscovery
Solution #51 uses Rel-16 EC enablers to solve KI#2 EAS rediscovery for all
connectivity. This solution shows how using Rel-16 PSA coexistence, the
application can build its own migration solution and minimize the impact on
the latency. If at EAS Rediscovery both, EAS and PSA change:
\- The decision for when to send traffic to target EAS can be taken by the
application client considering application specific aspects, like for example,
the time interval between packets. Solutions which multicast the packets to
former and new EAS, or solutions that perform delta context updates between
EASs in one or another direction, all are possible. An application-controlled
procedure can best minimize the latency. There is no need to assume any
specific solution.
\- When there are multiple applications using the same PDU Session, only when
connectivity over former and new PSA coexist, can each application control its
own migration, and can it be adapted to the specific application needs.
Solution #51 introduces no impacts on Rel\'16 NFs or procedures and puts
requirements on the application (e.g. the application is design to build
service continuity and EAS migration on the coexistence of the two
connectivity legs).
In solution #25, #27 (EAS Reselection part), #28, #31, #37, #52, #53 (clause
6.53.2.2), #54, the new EAS can be selected by AF. After that the new EAS
address need be notified to UE.
For all these possible solutions, there are 2 different ways to inform the UE
of the new EAS IP address:
\- Alt A: the EAS IP address is notified to UE via application layer
signalling. This option doesn\'t have any impact on the 5GC and has already
been supported by some applications. It includes: Sol #25, #27, #53, and #54.
\- Alt B: The EAS IP address is notified to 5GC, and the 5GC sends the new EAS
IP address to UE via NAS signalling and UE needs the capability to deliver the
received EAS IP address to application client. This option has impact on both
UE and 5GC.It includes: Sol #28, #31 and #37.
### 7.2.4 Evaluation for Key Issue #2: Edge relocation considering user plane
latency
There are two solutions on edge relocation considering user plane latency.
When the UE moves across the Edge Data Network Service Area that can be
identified by DNAI, the SMF may decide to relocate the PSA-UPF using its
locally configured topology information. However, PSA-UPF relocation may cause
unnecessary service interruption due to the change of IP address of the UE
even for the case that the serving UPF is able to satisfy the required user
plane latency without relocation of PSA-UPF. To solve this trade-off, the
solution #35 and the solution #36 are discussed.
The solution #35 proposes the edge relocation considering user plane latency
requirement such as maximum allowed user plane latency and shortest user plane
latency preference requested by AF and based on the request, the SMF may
decide the PSA relocation decision.
The solution #36 proposes the mechanism for the AF to decide the PSA
relocation based on the report of the estimated latency reported by the SMF.
The PSA relocation should be decided by the 5GC(i.e. SMF) not the AF, hence
this solution is not recommended into normative phase.
This is an enhancement to the SMF decision to change a PDU Session PSA that
applies to all connectivity models. When several applications use the same PDU
Session, some mechanism is needed to solve conflicts between application
requests.
### 7.2.5 Evaluation for Key Issue #2: EAS IP address replacement in 5GC
There are two main solutions (Sol#29 and Sol#30), intended to make the UE
unaware of the EAS change. Both solutions use AF influence procedure to
influence SMF to configure UPF for the EAS IP address replacement information,
while the two solutions have following difference:
(1) For the network function enforcing the EAS IP address replacement,
Solutions #29 proposes to use UL CL, while Solution #30 proposes to use local
PSA UPF. Since UL CL was designed for traffic offloading to the local DN and
all traffic (both destine for central DN and local DN), if UL CL is further
enhanced to enforce EAS IP address replacement , which would require higher
traffic processing capability in UL CL and cause heavy load. In order to avoid
such situation in UL CL, a more suitable candidate would be local PSA UPF as
proposed in Solution #30.
(2) On the naming of being replaced EAS IP address (source or anchor EAS), the
naming itself doesn\'t make much difference, but as Sol#30 works under the
assumption that one Anchor EAS deployed for each EC service and AF is
configured to know the Anchor EAS IP address, it says, the Anchor EAP IP
address is the one discovered by UE. While in this description is missing from
Sol#29, there is no dependency on the Anchor EAS, the relocation happens
between general source EAS and target EAS.
(3) On AF notifying 5GC about its capability of supporting UE awareness
solution (i.e. EAS IP address replacement approach) as proposed in Sol#29,
since such solution category would require the EC platform (e.g. AF, EAS) to
support some special handling on runtime session context migration and
synchronization, this indication is foreseen to be required, which can also be
used for merging the solutions with UE awareness and UE awareness as proposed
in Sol#27 update. This enhancement can be easily applied to any other
solutions addressing the EAS IP address. The solution #27 also supports the UE
unawareness solution with referring to Sol#30 with enhancement of AF notifying
the 5GC about EAS IP address replacement capability which is similar with the
EAS capability indication (i.e. the application server relocation is
transparent to the UE) as proposed in Sol#29, this part can be adopted as an
enhancement for Sol#30.
For the UE to be fully unaware of the EAS change, the L4 context needs to be
possible to keep, which means this solution requires that the L4 context is
migrated between source and target EAS. Whether TCP/TLS/QUIC context transfer
(between EAS) is realistic remains to be seen, as that requires touching the
baseline layers below the application and considering there are not existing
IETF specs addressing this issue.
EAS IP address replacement is an enhancement to EAS rediscovery variants where
UE does not take an active role and can be used on any connectivity model.
This enabler precludes to build service continuity and smooth EAS migration on
the simultaneous connectivity to old and new EAS that is using 5GC SSC#3 or
simultaneous change of BP/ULCL & Local PSA (clause 4.3.5.7 of TS 23.502 [3])
to allow for PSA coexistence. Whether EAS IP address replacement applies or
not to the traffic of certain application depends on the specific application
and its priority for low latency or for UE un-awareness of the EAS reselection
(latency is minimized using dual connectivity e.g. as described in Solution
#51).
### 7.2.6 Evaluation for Key Issue #2: Solution #27
Solution#27 provides a merged approach for Edge relocation. In this solution
the PSA relocation can be triggered either by SMF or by the AF. After the PSA
relocation the AF performs EAS relocation. EAS context can be transferred from
old EAS to new EAS to maintain the connectivity in application layer. However
this solution doesn\'t assume the concurrent connectivity in application layer
to both old EAS and new EAS.
Solution #27 applies to the connectivity model of \"Session Breakout\" and
\"Multiple PDU Sessions\" and solves the following issues:
\- change of EAS with EAS IP address change and local PSA change;
\- preventing or reducing packet loss.
Solution#27 can be applied when EAS IP address is changed or EAS IP address is
unchanged (Unicast case). There are four options to handle the new EAS IP
address change:
\- Option 1a: application layer mechanism to notify the new EAS IP address to
the UE. This option replies on application layer capability and doesn\'t have
any impact on the 5GS system, but not all application protocols support the
capability of redirection. Enabling this option would be out of 3GPP
operator\'s control.
\- Option 1b: NAS layer mechanism to notify the new EAS IP address to UE. This
option has impact on UE(Modem, OS and application client). Enabling this
option relies on the changes to OS and application client, which is out of
3GPP operator\'s control and may negatively impact the time to market for the
EC enhancement feature.
\- Option 1c: NAS layer mechanism to trigger DNS Re-resolution. This option
has impact on UE(Modem, OS and application client). Enabling this option
relies on the changes to OS and application client, which is out of 3GPP
operator\'s control and may negatively impact the time to market for the EC
enhancement feature.
\- Option 1d: EAS IP address replacement in local PSA UPF with using AF
influence mechanism. This option impacts 5GC but has no impact on UE. Enabling
this feature requires the EC platform to support the runtime context migration
among EASs, which can be controlled by operator via SLA with EC service
provider.
After the EAS relocation the AF notifies the SMF to start the uplink packet
delivery (including the buffered packet) to the new EAS. There are two options
to prevent or reduce the uplink data loss:
\- Option 2a: The target PSA UPF needs to buffer the UL packets for EC
session. Source and target EAS handles its own IP packets respectively. This
option relies on the application layer to notify the source EAS the last
uplink packet so the target EAS can start context transfer.
\- Option 2b: The target PSA UPF also needs to buffer the UL packets for EC
session and it further requires the temporary forwarding tunnel between source
PSA UPF and target PSA UPF for the purpose of forwarding the packets towards
the old EAS, which requires the new EAS can process the old EAS\'s IP packets.
When the EAS IP address is changed, how to route the UL IP packet with the
destination IP address of old EAS can be left to N6 routing deployment in
operator\'s network.
### 7.2.7 Evaluation for Key Issue #2: other sub-issues for edge relocation
In Solution #26, the UE is allocated with a persistent address by the SMF
during PDU session establishment, and N6 routing is based on host routes in
the DN. This solution relies on the DN has an appropriate routing mechanism so
that the UE IP can be re-anchored on the new PSA. The solution will cause the
fragmentation of the routing table then a huge routing table in routers in DN,
considering the routing table will become per IP address not per IP prefix
after UE moves. Furthermore, with UL CL, the UE can already be allocated with
a IP address anchored on remote PSA, which can keep unchanged during local PSA
relocation. Hence Solution#26 is not recommended in normative work.
In Solution #40, the application layer context transferring is go via NEF.
Considering the context transferring is under discussion in SA WG6. It is
recommended to decide whether this is need during normative phase after SA WG6
solution is stable.
Soluiton#55 addresses scenarios where Edge Application Server(s) and
Application Function are located at the Edge Data Network, thus implying
multiple AF instances i.e. one (or more) local AF(s) and also a central AF.
Application Function here acts as control plane entity managing one or more
EAS and responsible to interact with 5GC. In such deployment scenarios: as
part of initial PDU session establishment, a central AF may be involved
initially, however, due to relocation to Edge DNAI and corresponding EAS
relocation, a new local AF serving the Edge Applications may be selected.
To address multiple AF requirements, certain aspects were addressed as part of
URLLC work item in Release-16, however during EC study phase certain
additional aspects are discussed in solution#55. For example, updates to
procedure on AF requests to influence traffic routing, indication to SMF of AF
migration to a target AF and AF relocation information transfer between AFs.
Release-16 specification on AF influence procedure does not provide details on
AF relocation. For example, SMF is not provided target AF information, and SMF
does not send notification to target AF i.e. instead of sending to source AF.
In Rel-16, we only have this Nnef_TrafficInfluence_AppRelocationInfo which is
provided by AF, and in response to Nnef_TrafficInfluence_Notify message, where
AF may provide target AF ID.
Updates to procedure on AF request to influence traffic routing involves
target AF info e.g. AF ID in trafficInfluence request to SMF (via PCF), target
AF subscribing to notification on the same PDU session i.e. it needs to get
e.g. subscription trigger and UE ID from source AF, and so on.
Solution#55 does not discuss any application Context transfer details, which
is assumed to be out of SA2 scope and may be discussed other places e.g. in
SA6.
### 7.2.8 Evaluation for Key Issue #2: Solution #39
Solution #39 is a network-based solution and UE application layer is agnostic
with EAS relocation. It does not dependent on any application layer mechanism.
The solution relies on MPTCP proxy on UPF and requests relocation of MPTCP
contexts when UPF relocation happens. There are concerns raised on whether the
MPTCP context relocation is feasible or not, and potential issues on how to
make the relocation seamless. It was concluded Solution #39 is not recommended
in normative work in this study.
## 7.3 Evaluation of solutions for Key Issue #5
There are two solutions on KI#5. One difference is in solution#50 the target
DNAI(s) is applied to existing PDU session, while in solution#12 the requested
DNAI(s) is applied to subsequent new PDU session. In both solutions the target
DNAI(s) is sent to AMF via Nsmf_PDUSession_SMContextStatusNotify service
operation. After the AMF receives the target DNAI(s) it can insert a proper
I-SMF for current PDU session (solution#50), or select a proper new I-SMF/SMF
which can serve the requested DNAI(s) for subsequent PDU session
(solution#12).
## 7.4 Evaluation of solutions for Key Issue #3
Key Issue #3 is for Network Information Provisioning to Local Applications
with low latency. Currently, there are 9 solutions to solve this KI. Based on
how the information is subscribed and provided, they could be categorized as
Table 7.4-1:
Table 7.4â€‘1 Candidate Solutions
Solution OAM-based UPF-based User packet-based
* * *
#41: Network Information Provisioning using the IP path x #42: Providing
selected radio information to an App requiring it x  
#43: Low Latency exposure API by using the distributed CAPIF framework feature
x  
#44: Network Information Exposure to Local AF with Low Latency x  
#45: Using AS or NAS message notify UE\'s application layer x #46: Local NEF
Deployment for network information exposure to Local AF with Low Latency x  
#47: User Plane based Network Information Provisioning x #48: QoS monitoring
information exposure based on unstructured data transmission mechanism x  
#49: Network Information Provisioning to EAS with low latency based on User
Plane x  
#56: Edge NEF based Network Information Provisioning x
**Solutions #45**
Solution #45 exposes the RAN info via Control Plane. It requires both AMF and
SMF are deployed locally, which is a limitation to deployment, and also causes
frequent AMF relocation or SMF/I-SMF changes. This solution can hardly apply
to PDU sessions with remote UPF (e.g. Session breakout case) since a localized
SMF is needed. Furthermore, application layer mechanism is needed to carry the
information from UE to EAS.
In addition, it should be considered that this solution mimics the Rel-15 QoS
Notification Control and Rel-16 Alternative QoS Profile feature (see TS 23.501
[2] clauses 5.7.1.2a, 5.7.2.4.1b and 5.7.2.4.2). The main difference is that
while in Rel-15/16 the RAN notifies the AF and the UE (both via CN, and for
the UE, via NAS signalling) of a change of QoS, in Solution #45 the RAN
notifies only the UE (via CN and existing NAS signalling) who, in turn
notifies the AF via application layer signalling (that is, from 3GPP
perspective, via UP). This implies that:
\- this solution does not have any 3GPP impacts;
\- if implemented and used together with Rel-15/16 it may lead to
contradictory notifications to the AF (one received via Rel-15/16 signalling
from the CN and another one via UP from the UE).
Considering the above analysis, Solution #45 does not bring any additional
benefit in terms of low latency exposure.
**User plane-based solutions (Solutions #43, #46, #47, #48 and #49)**
The other solutions (#43, #46, #47, #48,#49) expose the network information
via user plane, which could achieve the \"low latency\".
Solution #47 adds subscription info and network information in the options of
TCP/IP header or ICMP packets, which current IETF specifications do not
support. IP options is not widely used in current network deployment. Many
routers will drop those IP packets with option fields. Besides, ICMP protocol
is not recommended between UE and UPF as described in TS 33.501, Annex P. In
addition, Solution #47 is based on the exposure of the UE radio conditions
(e.g., RSRP, RAN DL (PDCP) buffer in overflow status, Radio congestion state,
etc.). Such radio related parameters are rather dynamic and by the time they
are provided to the EAS it may already be outdated. This make them rather
useless for any sort of QoS adaptation and/or UE/EAS relocation.
Solution #46 and #49 reuse the current subscribing method but notification via
UPF to the EAS. The UPF needs to support to communicate with EAS via a local
NEF.
Solution #43 reuses current CAPIF mechanism to expose the information, CAPIF
API exposing function is integrated in the UPF. This solution can be
considered as one deployment option of solution #46 and #49 by integrating
local NEF (which acts as the CAPIF API exposing function) into UPF.
Solution #48 reuses current subscribing method but UPF exposes the information
via unstructured packet to the AF.
# 8 Deployment Guideline
NOTE: Deployment Guideline issues are not addressed within Rel-17 timeframe.
# 9 Conclusions
## 9.1 Conclusions for Key Issue #1
### 9.1.1 Conclusions for Key Issue #1: DNS based solutions for Multiple PDU
Sessions
Solution #1 proposing to Enhance the NEF service(s) to allow the AF to
influence PCF decisions for URSP rules, is endorsed for normative phase. In
order to allow AF to guide PCF determination and delivery to UE(s) of proper
URSP rules, clause 6.13.1.2 of solution 13 are also endorsed for normative
phase.
NOTE 1: The solution 1 and 13 apply also in other deployment models:
Distributed Anchors and Breakout.
The recommendation to define the URSPs so that Domain Descriptors are used to
steer the DNS and the Application traffic into PDU sessions is to be captured
in normative phase too, so as the clarifications that are required on how the
Domain descriptors in URSP are used on the UE (see clause 7.1).
The solution is not guaranteed to work when the UE doesn\'t support URSP rule
provisioned from PCF, when the DNS Server at the UE has been configured by the
user or when the Application Client generates the DNS Query outside of the DNS
libraries in the OS with DoT, DoH or other over the top mechanisms.
NOTE 2: This can correspond to devices doing tethering, or to devices deployed
for specific corporate purposes.
If the OS, user or applications overrides the operator-provided DNS settings,
the DNS resolvers or servers in the third party may take the source IP address
of the DNS request as the location information of UE, which may correspond to
the local/remote PSA UPF or other entities (e.g. a NAT server) on the N6
interface. These limitations and informative guidelines shall be captured to
cover scenarios where the OS, user or applications may override the operator-
provided URSP or DNS settings. The guidelines should assume no restriction on
the OS, user or application.
### 9.1.2 Conclusions for Key Issue #1: Distributed Anchors
Distributed anchor part of Solutions #2,#4, #5 and #10 describe DNS based
working solutions for EAS discovery for distributed anchor connectivity model
and the following selection of procedures from solutions #2, , #5 and #10 are
to be promoted into normative phase: Clauses 6.2.3.1, 6.5.2.6, 6.5.2.7,
6.10.2.1 and 6.10.2.2.
NOTE 1: Clauses 6.5.2.6 and 6.5.2.7 are included based on the understanding
they no more refer to \"Translate FQDN using LDN/N6 path information\" and to
\"uses distance/closeness metrics\". All the clauses above are included with
the understanding that usage of Anycast addressing is only one option and that
its usage may depend on the deployment, especially on the willingness of the
third party application host to control the selection of the EAS used to reach
an application.
These solutions solve KI#1 under certain conditions. These conditions should
be documented together with the solutions in normative phase. They are listed
in clause 7.1.5. Conditions include that in some cases, UE IP address can be
subject to privacy restrictions and shall not be sent to Authoritative DNS /
DNS Resolvers outside the network operator neither within ECS nor as Source IP
address of the DNS Query (UE source IP address could be protected by NATing
the DNS request.
Decision for anchoring of the UE in the distributed anchor point scenario for
EC shall be described as:
\- using subscription policy information to set proper UE policy (e.g. URSP
via usage of dedicated DNN); and/or
NOTE 2: Normative work about how to set proper UE policies (URSP) is defined
in clause 9.1.1.
\- to apply proper policies at session (SMF) level applying PCC rules
determined based on Nnef_TrafficInfluence and on the user subscription.
The following aspects from Solution #12 are recommended for normative work:
\- For SSC mode 2/3 PDU Session with central PSA UPF, when LDNSR receive DNS
response from DNS server, it may trigger the SMF to release old PDU Session
and establish new PDU Session using SSC mode 2/3 PSA change procedures.
Solution #14 is an application layer solution to discover an Edge AS with no
impact on 5GC when used with distributed anchor connectivity model. 5GC does
not preclude this option. This mechanism may be informatively mentioned during
normative phase as a complement to DNS based discovery for distributed anchor
connectivity. The solution assumes the Service Switch is pre-configured with
the mapping information between the IP address range supported by PSA (not the
PSA information) and EAS information based on the agreement between the MNO
and service provider.
Solutions #6 and #18 are not recommended into normative.
### 9.1.3 Conclusions for Key Issue #1: ECS address provisioning
The following principles are agreed for supporting ECS address provisioning
for UE(s) supporting an EEC:
\- The UE indicates whether it supports the capability of transferring to the
EEC the ECS address received from the 5GC via NAS.
\- Based on the operator policy and the UE\'s capability, the SMF provides the
ECS address(es) to the UE during PDU Session establishment procedure if the UE
indicated that it supports transferring the ECS address received from the 5GC
to the EEC.
\- The 5GC may derive the Edge Configuration Server Information based on local
configuration, the UE\'s location, and/or UE subscription information.
NOTE 1: The ECS (Edge Configuration Server) and EEC (Edge Enable Client) are
defined in TS 23.558 [12].
NOTE 2: Solution #16 says that the UE\'s subscription information may include
identities of Edge Configuration Servers that the UE may access. Whether an AF
may provide ECS Identities to the UDM may be considered during the normative
phase.
### 9.1.4 Conclusions for Key Issue #1: Session Breakout
For Session Breakout connectivity mode, Sol#22 is recommended as basis for DNS
based EAS discovery in normative phase.
NOTE: For option 3b, modification of destination IP address as proposed in
this option is allowed or not is subject to local regulations.
## 9.2 Conclusions for Key Issue #2
### 9.2.1 Conclusions for Key Issue #2: Reducing packet loss during EAS
relocation
Buffering uplink packets in the target PSA until receiving the indication of
successful EAS relocation from the AF as proposed in Solution #27 and Solution
#38 is recommended for normative phase. The old EAS may continue to serve the
UE until the successful EAS relocation is done in order to reduce the packet
loss. When the EAS relocation starts is out of scope of 3GPP.
This solution may be applied to all connectivity models. Whether Buffering of
uplink packets applies to the application traffic depends on the application
requirement.
NOTE: How 5GC gets the application requirement and in what granularity are to
be decided in normative phase.
This new enabler is an alternative to application layer mechanisms that
prevent packet loss.
### 9.2.2 Conclusions for Key Issue #2: UE based EAS rediscovery
A new DNS query may be performed to reselect a new EAS. For reselection of a
new EAS, the old EAS information in the UE should not be reused. For UE based
EAS rediscovery, it is concluded:
\- For session breakout case, the SMF may provide EAS rediscovery indication
and its optional associated impact field within NAS message to UE as described
in Solution #32 and #34 (only DNS cache related part). The SMF makes the
decision based on information provided by AF or based on SMF\'s local
configuration. The impacted field includes information DNS Suffix (i.e. domain
name), FQDNs or IP address ranges of the local DN, which is used to identify
the impacted DNS records. Without the impacted field the UE applies the EAS
rediscovery indication to all applications associated with the PDU Session.
Based on the received EAS rediscovery indication and its associated impact
field, when a new connection to EAS need to be established, the UE re-
discovers the new EAS according to KI#1 without reusing the cached old EAS
information. This does not impact the application client.
NOTE 1: For session breakout using BP, the old EAS information associated with
the old IPv6 prefix in UE should not be used when UE reselects a new EAS if
the EAS rediscovery is indicated. Whether the indication can be indicated in
the RA message is determined in normative phase.
NOTE 2: If connectivity is available to the source EAS, then the application
can select a new EAS after the DNS caching is flushed by the applications or
cache timer expires.
NOTE 3: The application can continue to be served by the old EAS until the UE
Application Layer DNS cache timer expires or the applications determines to
tear down the old EAS connection or DNS client in the UE flushes the DNS
cache.
NOTE 4: This EAS rediscovery indication does not impact the UE Application
Layer DNS caching.
NOTE 5: This EAS rediscovery indication is not required to be applied to the
EAS where the EAS address to the UE is not changed.
NOTE 6: The usage of optional associated impact field should be re-evaluated
in normative work.
\- For SSC mode 2, the UE can removes the old EAS information associated with
the released PDU Session and can reselect a new EAS after the UE receives a
new IP address.
\- For SSC mode 3, the UE can remove the old EAS information associated with
the released PDU Session and can reselect a new EAS after the UE receives a
new IP address.
### 9.2.3 Conclusions for Key Issue #2: AF based EAS rediscovery
Solution #51 solves KI#2 EAS rediscovery for all connectivity models using
Rel-16 enablers specified within the scope of SA2 with and depends on
application implementation. Whether the requirements to application layer are
feasible can be further discussed in normative phase.
The AF may reselect a new EAS for UE due to UP path change notification or by
its internal trigger, e.g. load balance. When the new EAS is reselected, the
UE is informed with the new EAS address via the application layer signalling,
which is out of scope of 3GPP.
If the EAS relocation is triggered by AF, the AF may provide the target DNAI
and target N6 traffic routing information to the SMF as described in
solution#27. The SMF may decide to perform DNAI change and uses the
information to establish a Local PSA for the new DNAI.
Furthermore, sending EAS IP address by 5GS to UE is not recommended to be
specified in normative work.
### 9.2.4 Conclusions for Key Issue #2: Edge relocation considering user plane
latency
Regarding the issues for edge relocation considering the user plane latency
requirements, the solution #35 is recommended as baselines for the normative
phase.
This is an enhancement to the SMF decision logic for changing the PSA that
applies to all connectivity models.
NOTE: When several applications use the same PDU session some mechanism is
needed to solve any conflicts.
### 9.2.5 Conclusions for Key Issue #2: EAS IP address replacement in 5GC
To solve the issue of change of EAS with EAS IP address change with or without
PSA change, to keep UE unaware of the EAS change, it is concluded to use
solution #30 as baseline for normative work with the enhancement of EAS
capability indication (i.e. supporting EAS IP address replacement) as proposed
in solutions #29 and #27.
NOTE 1: Whether Anchor EAS is used will be determined in normative phase.
This enabler is an enhancement to EAS rediscovery variants where UE does not
take an active role and can be used on any connectivity model.
Besides the EAS IP address replacement in the (Local) PSA the solution assumes
TCP/TLS/QUIC context transfer between EASs.
NOTE 2: The feasibility of this requirement i.e. TCP/TLS/QUIC context transfer
between EAS is unclear and whether third party platforms would support this
TCP/TLS/QUIC context transfer between EAS is unknown/not clear.
Whether EAS IP address replacement applies or not to the traffic of certain
application depends on the specific application and its priority for low
latency or for UE un-awareness of the EAS reselection.
### 9.2.6 Conclusions for Key Issue #2: Other sub-issues for edge relocation
\- Solution #26 are not recommended in normative work.
\- Whether AF context transferring can be done via NEF is to be decided during
normative phase after SA WG6 solution is stable.
\- Solution #55 is applicable to AF relocation scenarios and provides updates
to procedure on AF request to influence traffic routing i.e. those
enhancements as explained in the evaluation clause 7.2.7, for scenarios where
EAS relocation also results in corresponding AF relocation. Solution #55
(excluding the context transfer between AFs) is therefore recommended for
normative work.
### 9.2.7 Conclusions for Key Issue #2: Solution #39
Solution #39 is not recommended in normative work in this study.
### 9.2.8 Conclusions for Key Issue #2: Connection coexistence at Edge
Relocation
It is recommended for normative phase to consider enhancing the runtime
coordination so AF can provide guidance to SMF in relation to former and new
connection coexistence at Edge Relocation.
NOTE: Solution #31 and Solution #52 include proposals in this area.
## 9.3 Conclusions for Key Issue #5
The SMF uses Nsmf_PDUSession_SMContextStatusNotify operation to send the
target DNAI(s) to the AMF to assistant the I-SMF/SMF selection. The AMF then
uses the target DNAI(s) for I-SMF/SMF selection for existing or subsequent PDU
Session. Clause 6.12.2.2 in Solutions #12 and solution#50 are recommended into
normative with below considerations:
\- Normative work for KI5 shall only impact N11 (AMF-SMF interface) and N16a
(to relay information). No PCF impact and no N4 impact are to be considered.
\- There is no I-SMF chaining induced by these solutions.
\- SMF decides whether it is required to send the target DNAI to the AMF for
triggering I-SMF (re)selection.
\- AMF may retrieve from NRF, the SMF profiles that indicates supported DNAI.
, and considers the last DNAI received from the SMF to decide the proper
I-SMF/SMF. The AMF does not need to have policies related to potential
conflicts if a UE would need to be simultaneously served by different DNAI(s).
\- Nsmf_PDUSession_SMContextStatusNotify operation is used by normative
extensions due to these solutions. The notification is used to inform AMF:
DNAI for the current PDU Session for I-SMF selection (situation of sol 50)/
DNAI for the subsequent PDU Session for SMF selection (situation of solution
12).
## 9.4 Conclusions for Key Issue #3
The following principles abstracted from solutions #43, #46, #48, and #49 are
recommended as the baseline for normative work:
1\. Local PSA UPF generated QoS monitoring results based on RAN reporting via
GTP-U packets as defined in TS 23.501 [2], clause 5.33.3.
2\. The AF subscribes low latency exposure of QoS monitoring results via Local
NEF/NEF and PCF.
3\. Local PSA UPF exposes the QoS monitoring results to local AF via local
NEF.
4\. The address of the local NEF may be obtain using NRF-based discovery
procedures.
NOTE 1: Local PSA UPF can expose the QoS monitoring results to local AF via
N6. How to deliver the information on N6 is out of scope.
NOTE 2: Exposure for edge computing applications can be supported with a
(potentially locally) deployed NEF/SMF and existing interface for exposing
Notification Control and QoS monitoring, in the case the SMF can be locally
deployed and the added latency by the SMF and the extra routing path does not
make the overall exposure latency exceed the required exposure latency.
NOTE 3: Sending QoS monitoring information that has not been properly
integrated over time incurs the risk that the application may over-react to
instantaneous radio events/conditions leading to service instability.
Solutions #45 and #47 are not recommended for normative phase.
#
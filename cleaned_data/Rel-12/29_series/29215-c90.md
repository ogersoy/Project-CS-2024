# Foreword
This Technical Specification has been produced by the 3^rd^ Generation
Partnership Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# 1 Scope
The present document provides the stage 3 specification of the S9 reference
point for the present release. The functional requirements of stage 2
specification for the S9 reference point are contained in 3GPP TS 23.203 [2].
The S9 reference point lies between the PCRF in the home PLMN (also known as
H-PCRF) and the PCRF in the visited PLMN (also known as V-PCRF).
Whenever it is possible the present document specifies the requirements for
the protocols by reference to specifications produced by the IETF within the
scope of Diameter. Where this is not possible extensions to Diameter are
defined within the present document.
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
  * References are either specific (identified by date of publication, > edition number, version number, etc.) or non‑specific.
  * For a specific reference, subsequent revisions do not apply.
  * For a non-specific reference, the latest version applies. In the > case of a reference to a 3GPP document (including a GSM document), > a non-specific reference implicitly refers to the latest version > of that document _in the same Release as the present document_.
[1] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[2] 3GPP TS 23.203: \"Policy and Charging Control Architecture\"
[3] 3GPP TS 29.212: \"Policy and Charging Control (PCC); Reference points\".
[4] 3GPP TS 29.213: \"Policy and charging control signalling flows and Quality
of Service (QoS) parameter mapping\"
[5] 3GPP TS 29.214: \"Policy and charging control over Rx reference point\"
[6] IETF RFC 3588: \"Diameter Base Protocol\".
[7] 3GPP TS 29.229: \"Cx and Dx interfaces based on the Diameter protocol;
Protocol details\"
[8] IETF RFC 4960: \"Stream Control Transmission Protocol\".
[9] 3GPP TS23.003: \"Numbering, addressing and identification\".
[10] 3GPP TS 23.261: \"IP flow mobility and seamless Wireless Local Area
Network (WLAN) offload; Stage 2\".
[11] 3GPP TS 23.335: \"User Data Convergence (UDC); Technical realization and
information flows; Stage 2\".
[12] 3GPP TS 29.335: \"User Data Convergence (UDC); User Data Repository
Access Protocol over the Ud interface; Stage 3\".
[13] 3GPP TS 23.216: \"Single Radio Voice Call Continuity (SRVCC); Stage 2\".
[14] Broadband Forum TR-203: \"Interworking between Next Generation Fixed and
3GPP Wireless Access\".
[15] Broadband Forum TR-134: \"Policy Control Framework\".
[16] Broadband Forum TR-146: \"Subscriber Sessions\".
[17] DSL Forum TR-059: \"DSL Evolution -- Architecture. Requirements for the
Support of QoS-Enabled IP Services\", September 2003
[18] 3GPP TS 23.402: \"Architecture Enhancements for non-3GPP accesses\".
[19] IETF RFC 4006: \"Diameter Credit Control Application\".
[20] 3GPP TS 23.007: \"Restoration Procedures\".
[21] Void.
[22] 3GPP TS 29.274: \"3GPP Evolved Packet System. Evolved GPRS Tunnelling
Protocol for EPS (GTPv2)\".
[23] 3GPP2 X.S0057-B: \"E-UTRAN -- eHRPD Connectivity and Interworking: Core
Network Aspects\".
# 3 Definitions and abbreviations
## 3.1 Definitions
For the purposes of the present document, the terms and definitions given in
TR 21.905 [1] and the following apply. A term defined in the present document
takes precedence over the definition of the same term, if any, in TR 21.905
[1].
**Home Routed Access: Roaming scenario where the** PCEF is located in the
HPLMN. In a Home Routed roaming scenario, the UE obtains access to the packet
data network from the HPLMN.
**IP-CAN session:** association between a UE and an IP network.\ The
association is identified by one or more UE IPv4 addresses/ and/or IPv6 prefix
together with a UE identity information, if available, and a PDN represented
by a PDN ID (e.g. an APN). An IP-CAN session incorporates one or more IP-CAN
bearers. Support for multiple IP-CAN bearers per IP-CAN session is IP-CAN
specific. An IP-CAN session exists as long as the related UE IPv4 address
and/or IPv6 prefix are assigned and announced to the IP network.
**Visited Access (also known as local breakout):** Roaming scenario where the
PCEF is located in the VPLMN. In a Visited Access Roaming scenario, the UE
obtains access to the packet data network from the VPLMN.
## 3.2 Abbreviations
For the purposes of the present document, the abbreviations given in TR 21.905
[1] and the following apply. An abbreviation defined in the present document
takes precedence over the definition of the same abbreviation, if any, in TR
21.905 [1].
ADC Application Detection and Control
AF Application Function
AN-Gateway Access Network Gateway
AVP Attribute-Value Pair
BBERF Bearer Binding and Event Reporting Function
H-AF Home AF
H-PCRF Home PCRF
HPLMN Home PLMN
HR Home-Routed
HRPD High Rate Packet Data
HSGW HRPD Serving Gateway
OCS Online charging system
OFCS Offline charging system
PCC Policy and Charging Control
PCEF Policy and Charging Enforcement Function
PCRF Policy and Charging Rule Function
S-GW Serving Gateway
TDF Traffic Detection Function
UDC User Data Convergence
UDR User Data Repository
VA Visited Access
V-AF Visited AF
V-PCRF Visited PCRF
VPLMN Visited PLMN
# 4\. S9 Reference Point
## 4.1 Overview
The S9 reference point is used in roaming scenarios involving a HPLMN and a
VPLMN. Two main roaming scenarios are considered: visited access (PCEF in
VPLMN and AF in VPLMN or HPLMN) and home-routed access (PCEF in HPLMN and AF
in the HPLMN).
Two Diameter applications are used over the S9 reference point: S9 and Rx. The
purpose of the S9 Diameter application is to install PCC rules or QoS rules
generated in the HPLMN into the VPLMN and transport the events that may occur
in the VPLMN to the HPLMN. Additionally, the S9 Diameter application is used
to install ADC rules generated in the HPLMN into the VPLMN and transport the
application detection and control information from the VPLMN to the HPLMN,
when the H-PCRF and the V-PCRF both support the Application Detection and
Control feature. When the AF is in the VPLMN, Rx is used over the S9 reference
point to exchange service session information from the V-PCRF to the H-PCRF.
The AF exchanges session information with the H-PCRF or V-PCRF as specified in
3GPP TS 29.214 [5]. The PCRF (H-PCRF and/or V-PCRF) exchanges PCC rules and
QoS rules with the PCEF and BBERF respectively as specified in 3GPP TS 29.212
[3]. Additionally, the PCRF (H-PCRF and/or V-PCRF) exchanges ADC rules (for
solicited application reporting) and application detection notifications with
the TDF as specified in 3GPP TS 29.212 [3].
NOTE: In case of TDF and visited access, the V-PCRF extracts ADC Rules from
the received PCC Rules.
Signalling flows related to all the PCC reference points (Gx, Gxx, Rx, Sd and
S9) are specified in 3GPP TS 29.213 [4].
Diameter messages over the S9 reference point shall make use of SCTP [8].
## 4.2 Reference model
The S9 reference point is defined between the V-PCRF and the H-PCRF for home
routed access and visited access.
NOTE 1: AN-Gateway refers to the S-GW when the Gxc applies and to a trusted
non-3GPP access gateway when Gxa applies. Refer to Annexes A.5 and H.2 of 3GPP
TS 23.203 [2] for application of AN-Gateways.
The relationships between the different functional entities involved in the
home routed access are depicted in figure 4.2.1 and 4.2.1a.
Figure 4.2.1: S9 reference point at the PCC architecture for roaming with home
routed access with SPR
NOTE 2: The PCEF may support Application Detection and Control feature.
With the UDC-based architecture, as defined in 3GPP TS 23.335 [11] and applied
in 3GPP TS 23.203 [2], the UDR replaces SPR and the Ud reference point
provides access to the subscription data in the UDR. The Ud interface as
defined in 3GPP TS 29.335 [12] is the interface between the PCRF and the
UDR.The relationships between the different functional elements are depicted
in figure 4.2.1a. When UDC architecture is used, SPR and Sp, whenever
mentioned in this document, are replaced by UDRand Ud.
Figure 4.2.1a: S9 reference point at the PCC architecture for roaming with
home routed access with UDR
NOTE 3: The PCEF may support Application Detection and Control feature.
The relationships between the different functional entities involved in the
visited access are depicted in figure 4.2.2 and figure 4.2.2a.
Figure 4.2.2: S9 reference point at the PCC architecture for roaming with
visited access with SPR
NOTE 4: The PCEF may support Application Detection and Control feature.
With the UDC-based architecture, as defined in 3GPP TS 23.335 [11] and applied
in 3GPP TS 23.203 [2], the UDR replaces SPR and the Ud reference point
provides access to the subscription data in the UDR. The Ud interface as
defined in 3GPP TS 29.335 [12] is the interface between the PCRF and the UDR.
The relationships between the different functional elements are depicted in
figure 4.2.2a. When UDC architecture is used, SPR and Sp, whenever mentioned
in this document, are replaced by UDR and Ud.
Figure 4.2.2a: S9 reference point at the PCC architecture for roaming with
visited access with UDR
NOTE 5: AF can be located in both VPLMN and HPLMN for the visited access.
For a visited access, the VPLMN may use an OCS proxy between the PCEF/TDF and
the OCS.
NOTE 6: The H-PCRF can optionally send the addresses of the proxy/OCS to the
V-PCRF.
NOTE 7: The UDC Application Informational Model related to the PCRF is not
specified in this Release.
NOTE 8: The PCEF may support Application Detection and Control feature.
NOTE 9: PCEF is located in the Gateway node implementing the IP access to the
PDN. Refer to Annexes of 3GPP TS 23.203 [2] for application to specific IP-CAN
types.
NOTE 10: Refer to annexes A.5 and H.2 of 3GPP TS 23.203 [2] for application of
AN-Gateways.
## 4.3 Functional elements
### 4.3.1 H-PCRF
##### 4.3.1.0 General
The H-PCRF (Home Policy and Charging Rules Function) is a functional element
that encompasses policy control decision and flow based charging control
functionalities in the HPLMN.
The H-PCRF provides functions for both home routed access and visited access.
The H-PCRF selects the bearer control mode applicable for the user or IP-CAN
session. Policy decisions based on the bearer control mode are made in the
H-PCRF.
Usage monitoring as defined in 3GPP TS 29.212 [3] is controlled by the H-PCRF.
The H-PCRF shall check whether PCC Rules or QoS Rules have to be provided
based on the information received from the V-PCRF.
NOTE: The H-PCRF can use the Called-Station-Id AVP for that purpose. When this
AVP is absent, the H-PCRF provides QoS rules that are not related to any IP-
CAN session. When it is present, if it identifies a Visited Network, the PCC
rules will be provided. If it is present and identifies a Home Network, the
QoS rules will be provided.
When provisioning PCC/QoS rules over the S9 reference point, the H-PCRF is
responsible for assigning packet filter identifiers for rules provisioned as a
result of UE initiated resource modification. For E-UTRAN access with UE
initiated resource modification procedure, the H-PCRF shall either authorize
the same QoS as requested or reject the request if the requested QoS cannot be
authorized.
##### 4.3.1.1 Home routed access
The H-PCRF shall provision QoS Rules to the V-PCRF via the S9 reference point,
PCC Rules to the PCEF via the Gx reference point, and if applicable, provision
ADC rules to the TDF via the Sd reference point. The H-PCRF ensures that the
QoS Rules provisioned are aligned with the PCC Rules. It is PCRF\'s
responsibility to coordinate the PCC rules and QoS rules, if applicable, with
ADC rules in order to ensure consistent service delivery.
Based on home operator policy, the H-PCRF may allow a request for ponsored
data connectivity, reject a request for sponsored data connectivity, or
terminate the AF session associated with sponsored data connectivity.
The H-PCRF PCC Rule decisions may be based on one or more of the following:
\- Information obtained from the AF via the Rx reference point.
\- Information obtained from the V-PCRF via the S9 reference point.
> NOTE: The above may include information obtained from the BBERF via the Gxx
> reference point.
\- Information obtained from the PCEF via the Gx reference point.
\- Information obtained from the SPR via the Sp reference point.
\- Information obtained from the TDF via the Sd reference point.
\- PCRF pre-configured information.
The H-PCRF provisions event triggers to the V-PCRF, PCEF and TDF.
##### 4.3.1.2 Visited Access
The H-PCRF shall provision PCC Rules to the V-PCRF via the S9 reference point.
The H-PCRF may provision QoS Rules to the V-PCRF via the S9 reference point
for case 2a when the available QoS Rules are not related to any IP-CAN
session.
The H-PCRF shall reject request for sponsored data connectivity when the AF is
located in the HPLMN.
NOTE 0: Sponsored connectivity for a roaming subscriber with visited access is
not supported in this release as specified in 3GPP TS 23.203 [2].
The H-PCRF PCC/QoS Rule decisions may be based on one or more of the
following:
\- Information obtained from the AF when located in the home network.
\- Information obtained from the V-PCRF via the S9 reference point.
> NOTE 1: The above may include information obtained from the AF when the AF
> is located in the VPLMN and information obtained from the PCEF, BBERF and
> TDF.
>
> NOTE 2: Information obtained from the AF only applies for PCC Rule
> decisions.
\- Information obtained from the SPR via the Sp reference point.
\- PCRF pre-configured information.
The H-PCRF provisions event triggers to the V-PCRF.
### 4.3.2 V-PCRF
##### 4.3.2.0 General
The V-PCRF (Visited Policy and Charging Rules Function) is a functional
element that encompasses policy control decision and flow based charging
control functionalities in the VPLMN.
The V-PCRF provides functions for both home routed access and visited access.
For E-UTRAN access with UE initiated resource modification procedure, the
V-PCRF shall validate the QoS based on operator policies in the request from
the BBERF/PCEF before interacting with the H-PCRF.
#### 4.3.2.1 Home routed access
The V-PCRF shall request QoS Rules and report events to the H-PCRF via the S9
interface.
The V-PCRF validates the QoS parameters received within the QoS Rules based on
operator policies. The V-PCRF informs the H-PCRF if the QoS validation failed.
The V-PCRF shall provision QoS Rules to the BBERF via the Gxx reference point.
#### 4.3.2.2 Visited access
The V-PCRF shall request PCC Rules from and report events to the H-PCRF using
the S9 reference point.
The V-PCRF may request QoS Rules from the H-PCRF using the S9 reference point
when the available QoS Rules are not related to any IP-CAN session.
If the V-PCRF receives the PCC Rules from the H-PCRF, the V-PCRF extracts the
QoS Rules from the PCC Rules, validates the former, and if QoS validation is
successful, the V-PCRF shall provision the PCC Rules to the PCEF via the Gx
reference point and the QoS Rules to the BBERF via the Gxx reference point. If
the QoS validation fails the V-PCRF shall provide the acceptable QoS to the
H-PCRF. The H-PCRF may provide back an acceptable QoS to the V-PCRF or may
reject the request. Upon reception of the successful response from the H-PCRF,
the V-PCRF shall provision the PCC Rules to the PCEF and the QoS Rules to the
BBERF, if H-PCRF reject the request the V-PCRF shall reject the corresponding
request from the PCEF/BBERF. If the QoS validation applies to the Default
Bearer QoS or APN-AMBR, the procedures described in clauses 4.5.1.5 and
4.5.1.6 shall apply respectively. For case 2a, there may be additional
specific rules to be installed at the BBERF for the sole purpose of allowing
the tunnel between the BBERF and the PCEF not directly related with any
service.
If the V-PCRF receives the PCC Rules containing application identifiers from
the H-PCRF, and there is a TDF deployed in the visited network, the V-PCRF
shall derive corresponding ADC rules and provide those ADC rules to the TDF.
If the V-PCRF receives PCC Rules containing application identifiers from the
H-PCRF and the PCEF in the visited network supports Application and Detection
Control feature, the V-PCRF shall provide those PCC rules to the PCEF
supporting Application Detection and Control feature.
If the V-PCRF receives application detection notifications from a PCEF or a
TDF, the V-PCRF shall provide those notifications to the H-PCRF if the H-PCRF
has subscribed to the Event-Trigger AVP with the value
APPLICATION_START/APPLICATION_STOP and the Mute-Notification AVP is not
included in the corresponding PCC rule with application identifier; otherwise,
the V-PCRF may handle it locally.
When the AF is located in the VPLMN, the V-PCRF shall exchange Rx messages
with the H-PCRF over the S9 reference point.
The V-PCRF shall reject request for sponsored data connectivity when the AF is
located in the VPLMN.
NOTE:1 Sponsored connectivity for a roaming subscriber with visited access is
not supported in this release as specified in 3GPP TS 23.203 [2].
NOTE 2: Through roaming agreement, the HPLMN operator may allow the VPLMN
operator to operate the V-PCRF without interaction with H-PCRF (i.e. no S9 is
used). In such case, only static policies will be applied in V-PCRF based on
roaming agreements. The VPCRF may also interact with the AF in the VPLMN in
order to generate PCC Rules for services delivered via the VPLMN. V-PCRF uses
locally configured policies according to the roaming agreement with the HPLMN
operator as input for PCC Rule decision.
## 4.4 PCC, QoS and IP flow mobility routing Rules
### 4.4.1 PCC Rule definition
The purpose of the PCC Rule is defined in 3GPP TS 29.212 [3]. PCC Rules are
sent over S9 interface for visited access.
There are two different types of PCC rules as defined in 3GPP TS 29.212 [3]:
\- Dynamic PCC rules. Dynamically provisioned by the H-PCRF to the V-PCRF via
the S9 interface. These PCC rules may be either predefined or dynamically
generated in the H-PCRF. Dynamic PCC rules can be installed, modified and
removed at any time.
\- Predefined PCC rules. Preconfigured in the PCEF. Predefined PCC rules can
be activated or deactivated by the H-PCRF at any time via the V-PCRF using S9
interface. Predefined PCC rules may be grouped allowing the H-PCRF to
dynamically activate a set of PCC rules in the PCEF via the V-PCRF using S9
interface. The H-PCRF should activate the predefined PCC rules based on the
roaming agreement. The V-PCRF may accept or reject the H-PCRF decision
according to visited operator policy.
The content of a PCC Rule is the same as defined in 3GPP TS 29.212 [3]. The
rule name within a PCC Rule shall be used to reference to a PCC Rule in the
communication between the H-PCRF and the V-PCRF.
### 4.4.2 QoS Rule definition
The purpose of the QoS Rule is defined in 3GPP TS 29.212 [3]. QoS Rules are
sent over S9 interface for home routed access and visited access.
The content of a QoS Rule is the same as defined in 3GPP TS 29.212 [3]. The
rule name within a QoS Rule shall be used to reference to a QoS Rule in the
communication between the H-PCRF and the V-PCRF.
### 4.4.2a IP flow mobility routing Rule definition
The purpose of the IP flow mobility routing Rule is defined in 3GPP TS 29.212
[3]. IP flow mobility routing Rules are sent over S9 interface for visited
access.
The content of an IP flow mobility routing Rule is the same as defined in 3GPP
TS 29.212 [3]. The routing rule identifier within an IP flow mobility routing
Rule generated by the PCEF shall be used to reference to an IP flow mobility
routing Rule in the communication between the H-PCRF and the V-PCRF.
### 4.4.2b Void
### 4.4.3 Operations on PCC rules
PCC Rules operations are defined in 3GPP TS 29.212 [3]. This clause clarifies
how those operations are implemented on the S9 interface.
For dynamic PCC rules, the V-PCRF validates the QoS parameters requested
within the PCC Rules, before accepting the installation or modification of PCC
Rules. If the QoS validation fails the V-PCRF shall provide the acceptable QoS
to the H-PCRF. Upon reception of the successful response from the H-PCRF, the
V-PCRF shall provision the PCC Rules to the PCEF, if H-PCRF reject the request
the V-PCRF shall reject the corresponding request from the PCEF/BBERF.
For the Visited Access case, the H-PCRF may activate predefined PCC rules in
the V-PLMN's PCEF. In that case, the V-PCRF shall validate, based on roaming
agreements, that the H-PCRF is allowed to perform a particular operation on a
particular PCC Rule.
### 4.4.4 Operations on QoS Rules
Dynamic QoS Rules operations are defined in 3GPP TS 29.212 [3].
For QoS rules, the V-PCRF validates the QoS parameters requested within the
QoS Rules, before accepting the installation or modification of QoS Rules. If
the QoS validation fails the V-PCRF shall provide the acceptable QoS to the
H-PCRF. Upon reception of the successful response from the H-PCRF, the V-PCRF
shall provision the QoS Rules to the BBERF, if H-PCRF reject the request the
V-PCRF shall reject the corresponding request from the PCEF/BBERF.
### 4.4.5 Operations on IP flow mobility routing Rules
IP flow mobility routing Rules operations are defined in 3GPP TS 29.212 [3].
This clause clarifies how those operations are implemented on the S9
interface.
For the Visited Access case, the H-PCRF receives IP flow mobility routing
rules from the V-PCRF if and only if the H-PCRF has subscribed either the
AN_GW_CHANGE or the IP-CAN_CHANGE event trigger at the V-PCRF. In that case,
the H-PCRF shall update the affected PCC rules based on the IP flow mobility
routing rules and provide them to the V-PCRF.
### 4.4.6 Void
## 4.5 PCC procedures over S9 Reference Point
### 4.5.1 General
In this release, there are two protocols running over the S9 interface: the S9
protocol and the Rx protocol.
\- The Rx protocol is working as specified in 3GPP TS 29.214 [5].
\- The S9 protocol is defined in clause 5 in this document. The S9 protocol
allows establishment, modification and termination of Diameter S9 sessions.
There is an S9 session per UE between each H-PCRF and V-PCRF pair. An S9
session can contain zero, one or several S9 subsessions. The S9 subsession
scope is per PDN connection. An S9 subsession can be established, modified and
terminated.
When the V-PCRF receives a request that should be sent to the HPLMN, the
V-PCRF places the information within a S9 subsession level if it only applies
to a particular PDN connection. Otherwise, the information is placed at S9
session level.
There are three distinct network scenarios for an IP-CAN as defined in 3GPP TS
29.213 [4]:
1\. No Gateway Control session is needed. GTP is used for S5/S8, S2a and S2b
reference points.
2\. Gateway Control session is needed. Two subcases can be distinguished:
> 2a) S2c reference point (and then DSMIPv6 protocol) is used by a trusted
> non-3GPP access to access the EPC. Each Gateway Control Session applies for
> all IP-CAN sessions using the same CoA.
>
> 2b) Trusted non-3GPP accesses that use S2a reference point (PMIPv6 or MIPv4
> protocol is used) or 3GPP access that uses PMIPv6 over S5/S8 reference
> points. Each Gateway Control Session applies for one IP-CAN session.
The S9 reference point is used for case 1 in VA scenario and, for cases 2a and
2b for both HR and VA scenarios.
NOTE: The cases described above are often referred through the document as
cases 1, 2a or 2b.
#### 4.5.1.1 S9 Session Establishment
When the V-PCRF receives a CCR command with CC-Request-type AVP set to the
value \"INITIAL_REQUEST\" from the PCEF/BBERF that can not be associated with
any existing S9 session to the H-PCRF for that UE (based on the Subscription-
Id AVP), the V-PCRF shall establish a new S9 session according to the
procedures specified in clause 4.5.2.1 or 4.5.3.1 for home-routed and visited
access respectively.
NOTE: In a network scenario that deploys case 1 as defined in clause 4.5.1, S9
session is only needed in the visited access case and the procedures described
in clause 4.5.3 apply.
#### 4.5.1.2 S9 Session Termination
The V-PCRF shall initiate a termination of the S9 session when it receives a
trigger that originates the removal of the last existing S9 subsession
associated with the referred S9 session. The V-PCRF terminates the S9 session
following the procedures described in clause 4.5.2.3 or clause 4.5.3.3.
When the H-PCRF determines that the S9 session shall be terminated, the
procedures described in clause 4.5.2.4 and 4.5.3.4 apply.
NOTE: In a network scenario that deploys case 1 as defined in clause 4.5.1,
only the procedures described in clause 4.5.3 apply.
#### 4.5.1.3 Event Triggers
##### 4.5.1.3.1 Provisioning of Event Triggers
Provisioning of event triggers may be performed by either the V-PCRF or the
H-PCRF. The V-PCRF may receive requests to subscribe to event triggers from
the H-PCRF, from the PCEF (VA case) , from the TDF (VA case) or due to an
internal or other external event. The H-PCRF may receive subscription request
from the PCEF (i.e. In the HR case, the H-PCRF derives the event triggers from
the Event-Report-Indication AVP from the PCEF), or due to an internal or
external event (e.g. due to an Rx interaction with the AF).
When the H-PCRF wants to subscribe or unsubscribe to event trigger(s) in the
VPLMN, the H-PCRF shall provide to the V-PCRF one or several event triggers by
including them within the Event-Trigger AVP. Event Triggers may apply to a
specific S9 Subsession(s) or to a specific S9 session. Event Triggers provided
for a specific S9 session apply to S9 subsession(s) within the specified S9
session.
\- When Event Triggers are provided for a specific S9 subsession(s), the
H-PCRF includes Subsession-Decision-Info AVP for each of the affected S9
subsession. Each Subsession-Decision-Info AVP includes the Subsession-Id AVP
and the list of event triggers within the Event-Trigger AVP.
\- When Event Triggers are provided for a specific S9 session(s), the H-PCRF
includes the list of event triggers within the Event-Trigger AVP at command
level.
The H-PCRF adds new event triggers or removes previously provided event
triggers to the V-PCRF by providing the new complete list of applicable event
triggers.
The H-PCRF may provision event triggers to the V-PCRF using both a RAR and a
CCA command. However, for the Home Routed case, the H-PCRF shall provision the
IP-CAN_CHANGE event trigger to the V-PCRF at the command level in the initial
CCA command.
When the V-PCRF receives event triggers from the H-PCRF, the V-PCRF stores
them locally as S9-related and proceeds as follows:
\- In both the Home-Routed and Visited Access cases, the V-PCRF shall
provision the event triggers over the associated Gxx session to the BBERF
using the Gateway Control and QoS Rules Provisioning or Gateway Control
Session Establishment procedure described in 3GPP TS 29.212 [3] clauses 4a.5.1
and 4a.5.2.
\- Additionally, in the Visited Access case, the V-PCRF may also provision the
event triggers over the associated Gx session to the PCEF using the PCC
Provisioning procedures described in 3GPP TS 29.212 [3] clause 4.5.3. The
V-PCRF may also provision the corresponding relevant event triggers over the
associated TDF session to the TDF using the ADC Rule Provisioning procedure as
described in 3GPP TS 29.212 [3] clause 4b.5.3.
For the Visited Access case, the H-PCRF may remove all previously provided
event triggers by providing the Event-Trigger AVP set to the value
NO_EVENT_TRIGGERS. The H-PCRF includes within the Subsession-Decision-Info AVP
the affected Subsession-Id AVP and the list of event triggers within the
Event-Trigger AVP. When an Event-Trigger AVP is provided with this value, no
other Event-Trigger AVP shall be provided in the CCA or RAR command. Upon
reception of an Event-Trigger AVP with this value from the H-PCRF, if there
are no other locally handled event triggers, the V-PCRF shall provide the
Event-Trigger AVP set to the value NO_EVENT_TRIGGERS to the BBERF and PCEF; if
there are locally handled event triggers, the V-PCRF shall update the event
triggers at the BBERF and the PCEF to remove those triggers previously
installed based on requests from the H-PCRF. The V-PCRF shall not inform
H-PCRF of any subsequent event except for those events that are always
subscribed with no provision.
When the PCEF in the Visited Access case subscribes or unsubscribes to one or
several event triggers with the V-PCRF, the V-PCRF stores them locally as Gx-
related events and then provision them over the associated Gxx session
(identified using the Gateway Control Session to IP-CAN session linking
procedure described in 3GPP TS 29.212 [3] clause 4a.5.6) to the BBERF using
the Gateway Control and QoS Rules Provisioning procedure described in 3GPP TS
29.212 [3] clause 4a.5.2.
When the TDF in theVisited Access case subscribes or unsubscribes to one or
several event triggers with the V-PCRF, the V-PCRF stores them locally as Sd-
related events and then provision them over the associa ted Gxx session to the
BBERF using the Gateway Control and QoS Rules Provisioning procedure described
in 3GPP TS 29.212 [3] clause 4a.5.2 or Gx session to the PCEF using the PCC
rules Provisioning procedure described in 3GPP TS 29.212 [3] clause 4.5.2.
The V-PCRF may also provision event triggers to the BBERF/PCEF/TDF due to an
internal or external trigger or using the Provisioning of Event Triggers
procedure as described in 3GPP TS 29.212 [3] clauses 4a.5.3, clause 4.5.3 and
clause 4b.5.3.
##### 4.5.1.3.2 Reporting of deployed Event Triggers
The V-PCRF may receive a report of an event trigger that is deployed at the
BBERF or at the PCEF (VA case) or at the TDF (VA case).
In the VA case, when the event trigger reported by the BBERF corresponds to a
Gx-related event trigger (i.e. a subscription from the PCEF), the V-PCRF
notifies the PCEF as described in 3GPP TS 29.212 [3] clause 4.5.2.1.
In the VA case, when the event trigger reported by the BBERF or PCEF
corresponds to an Sd-related event trigger (i.e. a subscription from the TDF),
the V-PCRF notifies the TDF as described in 3GPP TS 29.212 [3] clause 4b.5.8.
NOTE: The V-PCRF always reports the UE_IP_ADDRESS_ALLOCATE and
UE_IP_ADDRESS_RELEASE to the TDF.
When the event trigger reported by the BBERF, the PCEF (in VA case) or TDF (in
VA case) corresponds to a S9-related (i.e. a subscription from the H-PCRF)
event trigger or is always reported even though the V-PCRF has not provisioned
it and the value is applicable for the S9 reference point as indicated in
clause 5.4, the V-PCRF notifies the H-PCRF using the procedures as described
in clause 4.5.2.1 in home routed case or the PCC Rule Request procedure as
described in clause 4.5.3.1 for visited access case.
When the event trigger reported by the BBERF/PCEF corresponds to a V-AF-
related event trigger, the V-PCRF shall inform the V-AF using the RAR command
including the Specific-Action AVP as described in 3GPP TS 29.214 [5] clauses
4.4.6.1, 4.4.6.2 and 4.4.6.3.
#### 4.5.1.4 Multiple BBERF scenarios
The multiple BBERF scenarios happen when there is a change or an addition of
BBERF and the H-PCRF and the V-PCRF needs to handle more than one BBERF
related with the sameIP-CAN session.
The V-PCRF shall follow the procedures defined in clauses 4.5.2.5 and 4.5.3.5
respectively for the home routed and visited access cases.
#### 4.5.1.5 Provisioning and validation of Default EPS Bearer authorized QoS
The default EPS Bearer QoS handling only applies to case 2b in HR scenario,
and case 1, case 2a and case 2b in the VA scenario.
For IP-CAN types that support multiple IP-CAN bearers, the V-PCRF may provide
the Default-EPS-Bearer-QoS AVP in the Subsession-Enforcement-Info AVP within
the CCR command to the H-PCRF.
The H-PCRF may provision the authorized QoS for the default EPS bearer within
the corresponding S9 subsession in the CCA command including the Subsession-
Decision-Info AVP for the S9 subsession within the S9 session. The S9
Subsession-Decision-Info AVP contains the Default-EPS-Bearer-QoS AVP.
Besides the H-PCRF may provision the authorized QoS for the default EPS bearer
without receiving a request from the V-PCRF, e.g. in response to an internal
trigger within the H-PCRF or upon interaction with the SPR. The H-PCRF shall
send a RAR command including the Subsession-Decision-Info AVP with the
Default-EPS-Bearer-QoS AVP for the S9 subsession within the S9 session.
The V-PCRF shall validate the Default-EPS-Bearer-QoS AVP in case it is
received in the CCA or RAR command.
If the QoS validation fails and there is a default EPS bearer QoS value
already authorized for that IP-CAN session, the V-PCRF shall retain the
existing default EPS bearer QoS without any modification and reject the
request using a CCR/RAA command respectively to the H-PCRF. The CCR/RAA shall
include the Subsession-Enforcement-Info AVP for the affected S9 subsession
that includes the S9 subsession identifier within the Subsession-Id AVP, the
Default-EPS-Bearer-QoS AVP to indicate the retained value, and the Event
Trigger set to DEFAULT-EPS-BEARER-QOS_MODIFICATION_FAILURE.
If the QoS validation fails as part of the IP-CAN session establishment
procedure, the V-PCRF shall derive the acceptable default EPS bearer QoS based
on operator policies and reject the request using a CCR command to the H-PCRF.
The CCR shall include the Subsession-Enforcement-Info AVP for the affected S9
subsession that includes the S9 subsession identifier within the Subsession-Id
AVP, the Default-EPS-Bearer-QoS AVP to indicate the acceptable value, and the
Event Trigger set to DEFAULT-EPS-BEARER-QOS_MODIFICATION_FAILURE.
The H-PCRF may provide back an acceptable default EPS bearer QoS or may reject
the request. If the H-PCRF rejects the request the V-PCRF shall reject the
corresponding request from the PCEF/BBERF.
Upon reception of the subsequent CCA command, if the procedure was initiated
by the PCEF/BBERF and default EPS bearer QoS is acceptable, the V-PCRF shall
provide the negotiated default EPS bearer QoS in the response to the
PCEF/BBERF.
NOTE: In order to avoid loops in the QoS negotiation process, it is
recommended that the H-PCRF provides a default EPS bearer QoS acceptable by
the Visited Network.
#### 4.5.1.6 Provisioning of Authorized QoS per APN
The Authorized QoS per APN handling only applies to case 2b in HR scenario,
and case 1, case 2a and case 2b in the VA scenario.
At S9 Session/Subsession Establishment/Modification, the V-PCRF may include
the APN-AMBR (if received from the BBERF for case 2b or PCEF for case 1 and
case 2a in VA scenario) in the QoS-Information AVP of the Subsession-
Enforcement-Info AVP, using the APN-Aggregate-Max-Bitrate-UL AVP and/or the
APN-Aggregate-Max-Bitrate-DL AVP within the CCR command to the H-PCRF.
Upon receiving the subscribed APN-AMBR from the V-PCRF, the H-PCRF shall
provision the authorized QoS per APN within the CCA command. The authorized
QoS per APN shall be provisioned in the QoS-Information AVP of Subsession-
Decision-Info AVP, using the APN-Aggregate-Max-Bitrate-UL AVP and/or the APN-
Aggregate-Max-Bitrate-DL AVP. When APN-Aggregate-Max-Bitrate-UL AVP and/or the
APN-Aggregate-Max-Bitrate-DL AVP are provided, the Max-Requested-Bandwidth
values, and the Guaranteed-Bitrate values shall not be included.
Besides the H-PCRF may provision the authorized APN-AMBR without receiving a
request from the V-PCRF, e.g. in response to an internal trigger within the
H-PCRF or upon interaction with the SPR. The H-PCRF shall send a RAR command
including the Subsession-Decision-Info AVP with the QoS-Information AVP for
the S9 subsession.
If the APN-AMBR is changed, the H-PCRF shall provision the authorized APN-AMBR
for each IP-CAN session for that APN by including the Subsession-Decision-Info
AVP with the QoS-Information AVP for each affected S9 subsession.
The V-PCRF shall validate the APN-AMBR in case it is received in the CCA or
RAR command. If the QoS validation fails and there is an APN-AMBR value
already authorized for that IP-CAN session, the V-PCRF shall retain the
existing APN-AMBR without any modification and reject the request using a
CCR/RAA command respectively to the H-PCRF. The CCR/RAA shall include the
Subsession-Enforcement-Info AVP for the affected S9 subsession that includes
the S9 subsession identifier within the Subsession-Id AVP, the QoS-Information
AVP to indicate the retained value, and the Event Trigger set to APN-
AMBR_MODIFICATION_FAILURE.
If the QoS validation fails as part of the IP-CAN session establishment
procedure, the V-PCRF shall derive the acceptable APN-AMBR based on operator
policies and reject the request using a CCR command to the H-PCRF. The CCR
shall include the Subsession-Enforcement-Info AVP for the affected S9
subsession that includes the S9 subsession identifier within the Subsession-Id
AVP, the QoS-Information AVP to indicate the acceptable value, and the Event
Trigger set to APN-AMBR_MODIFICATION_FAILURE.
The H-PCRF may provide back an acceptable APN-AMBR or may reject the request.
If the H-PCRF rejects the request the V-PCRF shall reject the corresponding
request from the PCEF/BBERF.
Upon reception of the subsequent CCA command, if the procedure was initiated
by the PCEF/BBERF and the APN-AMBR is acceptable, the V-PCRF shall provide the
negotiated APN-AMBR in the response to the PCEF/BBERF.
NOTE: In order to avoid loops in the QoS negotiation process, it is
recommended that the H-PCRF provides an APN-AMBR acceptable by the Visited
Network.
#### 4.5.1.7 Bearer Control Mode Selection
The H-PCRF derives the selected bearer control mode based on the received
Network-Request-Support AVP, access network information, subscriber
information and operator policy.
\- If the bearer control mode that H-PCRF derives is applicable for the S9
session of the user, the H-PCRF includes the bearer control mode within
Bearer-Control-Mode AVP at the command level.
\- If the bearer control mode that H-PCRF derives is applicable for a specific
IP-CAN session, the H-PCRF includes the Subsession-Decision-Info AVP for the
affected S9 subsession corresponding to the IP-CAN session. The subsession-
Decision-Info AVP includes allocated S9 subsession identifier within the
Subsesssion-Id AVP and the bearer control mode within the Bearer-Control-Mode
AVP.
#### 4.5.1.8 Access Network Information Reporting
This procedure takes place when the multi access PDN connectivity is
supported.
The V-PCRF shall report the access network information of the UE to the
H-PCRF, e.g. the IP-CAN type, RAT type (if applicable), at the command level
for case 2a and if there is no S9 subsession established.
Otherwise, the V-PCRF shall report the access network information of the IP-
CAN session to the H-PCRF only in the corresponding S9 subsession except
during S9 session establishment where the V-PCRF shall report the access
network information at both the command and S9 subsession levels.
NOTE : The V-PCRF provides the access network information at the command level
during S9 session establishment for backwards compatibility reasons, in case
the H-PCRF does not support the multi access PDN connectivity.
### 4.5.2 Home-Routed access
#### 4.5.2.1 S9 Session/Subsession establishment/modification
The V-PCRF interacts with the H-PCRF in the following instances:
1) Upon Gateway Control Session establishment over Gxx:
When the V-PCRF receives a CCR command with a CC-Request-Type AVP set to
\"INITIAL_REQUEST\" from the BBERF over Gxx, the V-PCRF determines whether
case 2a or case 2b applies as defined in 3GPP TS 29.213 [4] and applies the
following procedures apply:
\- If case 2a applies,
\- If there is not an already established S9 session for this roaming user,
the V-PCRF shall send to the H-PCRF a CCR command with the CC-Request-Type AVP
set to the value \"INITIAL_REQUEST\" to establish a new S9 session. The CCR
command from the V-PCRF to the H-PCRF shall include those attributes provided
by the BBERF to the V-PCRF at the Diameter CCR command level, defined in
clause 4a.5.1 of 3GPP TS 29.212 [3].
\- Otherwise, if there is an already established S9 session for this roaming
user, the procedures in clause 4.5.2.5 shall be applied.
\- If case 2b applies,
\- If there is not an already established S9 session for this roaming user,
the V-PCRF shall send to the H-PCRF a CCR command with the CC-Request-Type AVP
set to the value \"INITIAL_REQUEST\" to establish a new S9 session. The V-PCRF
shall include the Subsession-Enforcement-Info AVP within the CCR command with
a new S9 subsession identifier assigned by the V-PCRF within the Subsession-Id
AVP, the Subsession-Operation AVP set to the value \"ESTABLISHMENT\". The
V-PCRF shall map the Gxx session-id(s) to the corresponding subsession-id(s)
in the S9 session. In addition, the V-PCRF shall include those attributes
provided by the BBERF that allows the H-PCRF to identify the Subsession as
defined in 3GPP TS 29.212 [3].
\- If an existing S9 session for the roaming user is already established with
the H-PCRF, the V-PCRF shall update the existing session by sending a CCR with
the CC-Request-Type AVP set to the value "UPDATE_REQUEST" to the H-PCRF.
\- If an S9 subsession does not exist for the PDN connection corresponding to
the gateway control session establishment, the V-PCRF shall include the
Subsession-Enforcement-Info AVP within the CCR command with a new S9
subsession identifier assigned by the V-PCRF within the Subsession-Id AVP, the
Subsession-Operation AVP set to the value \"ESTABLISHMENT\". The V-PCRF shall
map the Gxx session-id(s) to the corresponding subsession-id(s) in the S9
session.
\- In all cases, the CCR command from the V-PCRF to the H-PCRF shall include,
at subsession level, those attributes provided by the BBERF to the V-PCRF, as
defined in clause 4a.5.1 of 3GPP TS 29.212 [3].
\- If the V-PCRF detects that an S9 subsession already exists for a particular
PDN connection linked to a different gateway control session (i.e. different
Gxx session-id), the V-PCRF shall follow the procedures in clause 4.5.2.5.
2) Upon Gateway Control Session modification over Gxx by receiving a Gateway
Control and QoS rules request
If the V-PCRF receives a CCR command with a CC-Request-Type AVP set to
\"UPDATE_REQUEST\" from the BBERF over Gxx, the V-PCRF shall send a CCR
command with a CC-Request-Type AVP set to \"UPDATE_REQUEST\" to the H-PCRF
including the updated information.
In case 2a, the V-PCRF shall include the attributes provided by the BBERF at
the CCR command level.
In case 2b, the V-PCRF shall modify the corresponding S9 subsession by
including the Subsession-Enforcement-Info AVP within the CCR command that
contains the allocated S9 subsession identifier within the Subsession-Id AVP,
the Subsession-Operation AVP set to the value \"MODIFICATION\". In addition,
the V-PCRF shall provide the Subsession-Id AVP to allow the H-PCRF to identify
the subsession for which QoS Rules are requested. The V-PCRF shall include the
attributes provided by the BBERF within the Subsession-Enforcement-Info AVP.
> If the V-PCRF receives a CCR command with a CC-Request-Type AVP set to
> \"UPDATE_REQUEST\" and the Event-Trigger AVP set to
> \"RESOURCE_MODIFICATION_REQUEST\", the V-PCRF may validate the QoS in the
> request. If the QoS validation fails, the V-PCRF shall reply to the BBERF
> over Gxx with a CCA command including the Gx experimental result code
> DIAMETER_ERROR_INITIAL_PARAMETERS.
The QoS rules are provisioned by the H-PCRF as follows:
\- In case 2a, the H-PCRF shall provision QoS Rules in the CCA command by the
QoS-Rule-Install AVP at the command level.
\- In case 2b, the H-PCRF shall provision QoS Rules within the corresponding
S9 subsession by issuing the CCA command and including the Subsession-
Decision-Info AVP for the S9 subsession within the S9 session. Each S9
Subsession-Decision-Info AVP contains the QoS-Rule-Install AVP.
If the H-PCRF is, due to incomplete, erroneous or missing information (e.g.
subscription related information not available or authorized QoS exceeding the
subscribed bandwidth) not able to:
1) Provision a policy decision to a specific subsession as response to the
request sent by the V-PCRF, the H-PCRF shall send a CCA command including the
Experimental-Result AVP at the command level with the Experimental-Result-Code
AVP set to DIAMETER_ERROR_SUBSESSION (5470), including the Subsession-
Decision-Info AVP with the rejected Subsession-Id(s) within the Subsession-Id
AVP and the appropriate error within either the Experimental-Result-Code AVP
or Result-Code AVP.
2) Provision a policy decision to any of the S9 subsession(s) or provision a
policy decision at the command level, the H-PCRF shall reject the request
using a CCA command with the DIAMETER_ERROR_INITIAL_PARAMETERS (5140) within
the Experimental-Result-Code AVP.
When the V-PCRF receives a CCA command where S9 specific subsession(s) contain
a specific Result-Code or Experimental-Result-Code AVP from the H-PCRF, the
V-PCRF shall reply to the BBERF over the respective Gxx with a CCA command
including the same result code.
When the V-PCRF receives a CCA command with an error code within the
Experimental-Result-Code AVP or Result-Code AVP at the command level, the
V-PCRF shall reply to the BBERF over the respective Gxx interface with a CCA
command including the same result code.
The V-PCRF shall validate the QoS Rules contained in the CCA. If the QoS
validation fails the V-PCRF shall perform the following:
1) Send a CCR command to the H-PCRF with the CC-Request-Type AVP set to
"UPDATE_REQUEST" and
a) In case 2a, include the QoS-Rule-Report AVP to indicate the QoS Rules that
were not accepted, including Rule-Failure-Code AVP set to
UNSUCCESSFUL_QOS_VALIDATION value and the QoS-Information AVP to indicate the
acceptable QoS.
b) In case 2b, include the QoS-Rule-Report AVP within the Subsession-
Enforcement-Info AVP to indicate the QoS Rules that were not accepted,
including Rule-Failure-Code AVP set to UNSUCCESSFUL_QOS_VALIDATION value and
the QoS-Information AVP to indicate the acceptable QoS. The V-PCRF shall
include the S9 subsession specific information within the CCR command that
includes the S9 subsession identifier within the Subsession-Id AVP.
> 2) Upon reception of the subsequent CCA command from the H-PCRF, the V-PCRF
> shall reply to the BBERF over Gxx with a CCA command. If the validation of
> the answer from the H-PCRF is successful, the V-PCRF shall include the
> acceptable QoS in the QoS rules. Otherwise, the V-PCRF shall reply to the
> BBERF over Gxx with a CCA command including the Gx experimental result code
> DIAMETER_ERROR_INITIAL_PARAMETERS.
NOTE: In order to avoid loops in the QoS negotiation process, it is
recommended that the H-PCRF provides a QoS acceptable by the Visited Network.
#### 4.5.2.2 Provision of QoS Rules by the H-PCRF
The H-PCRF may decide to provision QoS Rules without obtaining a request from
the V-PCRF, e.g. in response to information provided to the H-PCRF via the Rx
reference point, or in response to an internal trigger within the H-PCRF, or
from a trigger by the SPR. The H-PCRF may also decide to provision QoS rules
in response to a request for PCC Rules received by the H-PCRF from the PCEF
that is linked with a former Gateway Control session establishment.
To provision QoS Rules without a request from the V-PCRF, the H-PCRF shall do
the following:
\- In case 2a, send a RAR command including the QoS rules to be provisioned
within the QoS-Rule-Install AVP at the command level.
\- In case 2b, send a RAR command including the Subsession-Decision-Info AVP
for each of the S9 subsessions within the S9 session. Each Subsession-
Decision-Info AVP contains the QoS rules to be provisioned within the QoS-
Rule-Install AVPs.
The V-PCRF shall validate the QoS Rules contained within each S9 subsession
within the RAR command.
If the QoS validation fails the V-PCRF shall send a reject in the RAA command
to the H-PCRF. The V-PCRF includes:
\- In case 2a, a DIAMETER_PCC_RULE_EVENT (5142) experimental result code, the
QoS-Rule-Report AVP to indicate the QoS Rules that were not accepted,
including Rule-Failure-Code AVP set to UNSUCCESSFUL_QOS_VALIDATION value and
the QoS-Information AVP to indicate the acceptable QoS.
\- In case 2b, the Subsession-Enforcement-Info AVP for each rejected S9
subsession. The Subsession-Enforcement-Info AVP with the rejected Subsession-
Id(s) and a DIAMETER_PCC_RULE_EVENT (5142) experimental result code, including
the QoS-Rule-Report AVP to indicate the QoS Rules that were not accepted,
including Rule-Failure-Code AVP set to UNSUCCESSFUL_QOS_VALIDATION value and
the QoS-Information AVP to indicate the acceptable QoS.
If the QoS validation succeeds, the V-PCRF shall initiate the Gateway Control
and QoS Rules Provision procedure over Gxx as defined in 3GPP TS 29.212 [3] by
sending an RAR command to the BBERF including the parameters from the RAR
command received from the H-PCRF. When the V-PCRF receives the RAA from the
BBERF(s), the V-PCRF responds to the H-PCRF as follows:
\- in case 2a, the V-PCRF shall send a corresponding RAA command to the H-PCRF
including the corresponding result code.
\- in case 2b, the V-PCRF shall send a corresponding RAA command to the H-PCRF
including the S9 Subsession-Enforcement-Info AVP for each specific S9
subsession with the corresponding result code.
#### 4.5.2.3 S9 Session/Subsession Termination Initiated by the V-PCRF
This procedure is triggered by a Gateway Control Session Termination procedure
over Gxx interface. When the V-PCRF receives a CCR command with a CC-Request-
Type AVP set to "TERMINATION_REQUEST" from the BBERF over Gxx, it shall
acknowledge this message by sending the CCA command to the BBERF as defined in
3GPP TS 29.212 [3]. If in addition to the Gateway Control Session being
terminated, one or more Gateway Control Sessions corresponding to the PDN
connection for case 2b or to the user for case 2a exist the V-PCRF shall
follow the procedures for Multiple BBERF Handling described in clause 4.5.2.5;
otherwise the V-PCRF shall do the following:
1) Terminate the S9 session, if as a consequence of the Gateway Control
Session Termination over Gxx, the last S9 subsession for that roaming user is
terminated. In order to do that, the V-PCRF shall terminate the related S9
session by sending a CCR command with a CC-Request-Type AVP set to
"TERMINATE_REQUEST" to the H-PCRF.
> When the H-PCRF receives the CCR, it shall acknowledge this message by
> sending a CCA to the V-PCRF.
2) Update the S9 session, if there are remaining S9 subsessions for the
roaming user. The V-PCRF shall modify the related S9 session by sending a CCR
with a CC-Request-Type AVP set to "UPDATE_REQUEST" to the H-PCRF. The V-PCRF
shall include in the CCR the Subsession-Enforcement-Info and set the
Subsession-Operation AVP to "TERMINATION" for each S9 subsession of a
particular UE that is terminated.
When the H-PCRF receives the CCR, it shall acknowledge this message by sending
a CCA to the V-PCRF. The H-PCRF shall include the Subsession-Decision-Info AVP
within the CCA command with the removed Subsession-Id AVP and the Result-Code
AVP.
On receipt of the CCA command, the V-PCRF shall remove the session information
stored for that Gateway Control Session.
#### 4.5.2.4 S9 Session/Subsession Termination Initiated by the H-PCRF
The H-PCRF may request the termination of a S9 session/subsession to the
V-PCRF.
The H-PCRF decides to terminate a S9 session/subsession due to an internal
trigger or trigger from the SPR. The following cases can be distinguished:
\- If the H-PCRF considers that the S9 session has to be terminated, the
H-PCRF shall send an RAR command to the V-PCRF indicating the termination of
the S9 session by including the Session-Release-Cause AVP at command level.
The V-PCRF shall send a corresponding RAA command to the H-PCRF.
\- If the H-PCRF considers that the S9 subsession has to be terminated, the
H-PCRF shall send an RAR command to the V-PCRF indicating the termination of
the S9 subsession by including the Session-Release-Cause AVP within the
Subsession-Decision-Info AVP. When the V-PCRF receives the RAR command it
shall answer it by issuing the corresponding RAA command.
The V-PCRF shall trigger the termination of the corresponding Gateway Control
session(s) over Gxx interface by applying the Request of Gateway Control
session termination procedures as defined in 3GPP TS 29.212 [3] clause 4a.5.4.
#### 4.5.2.5 Multiple BBERF Handling
##### 4.5.2.5.1 General
In the management of multiple BBERF for home routed scenario, the H-PCRF
distinguishes between the case of handover and the case of IP flow mobility.
If the H-PCRF receives the indication of IP flow mobility (e.g.
ROUTING_RULE_CHANGE event trigger) from the active Gx session, then the clause
4.5.2.5.3 will apply, otherwise the clause 4.5.2.5.2 will apply.
##### 4.5.2.5.2 Handling of multiple BBERFs associated with the same IP-CAN
session during handover
The H-PCRF distinguishes two types of BBERFs: primary and non-primary
according to 3GPP TS 29.212 [3]. The V-PCRF interacts with the H-PCRF in the
following instances:
1) Upon Gateway Control Session establishment over Gxx:
When the V-PCRF has received a CCR for Gateway Control Session Establishment
from a new BBERF that is related with an existing gateway control session, the
V-PCRF modifies the S9 session by sending a CCR command to inform the H-PCRF
of the new Gateway Control Session. The V-PCRF shall include the Multiple-
BBERF-Action AVP set to the value \"ESTABLISHMENT\" and the AN-GW-Address AVP
to distinguish the information from the new BBERF and to allow the H-PCRF
operating on any of the BBERF separately.
\- If case 2a applies, the Multiple-BBERF-Action AVP and the AN-GW-Address AVP
are included at command level.
\- If case 2b applies, the Multiple-BBERF-Action AVP and the AN-GW-Address AVP
are included in the Subsession-Enforcement-Info AVP that contains the
allocated S9 subsession identifier within the Subsession-Id AVP and the
Subsession-Operation AVP set to the value \"MODIFICATION\".
When the H-PCRF receives the CCR command, the H-PCRF shall apply the
procedures defined in 3GPP TS 29.212 [3] to detect if the new BBERF is primary
or not and will act accordingly by answering with a CCA command. Within the
CCA command the H-PCRF may include new decisions at either the command level
for case 2a or at the subsession level for case 2b for the affected BBERF.
If the same changes are applied to all BBERFs, the H-PCRF shall not include
AN-GW-Address AVP within the CCA command. If different decisions are applied
to different BBERFs, the H-PCRF shall include, in the CCA command, the AN-GW-
Address AVP that was included in the CCR command and the associated QoS rules
and event triggers for that BBERF. The H-PCRF shall provide the updated QoS
rules and event triggers to the remaining BBERF(s) within RAR command(s) by
initiating the QoS rule provision procedure for each of the remaining
BBERF(s). In each RAR command, the H-PCRF shall include the AN-GW-Address AVP
in order to identify the target BBERF.
2) Upon Gateway Control Session modification over Gxx:
When the V-PCRF receives a CCR command from any of the BBERFs for Gateway
Control Session modification, the V-PCRF shall follow the same procedures as
described above for Gateway Control Session Establishment case and include AN-
GW-Address AVP within the CCR command to the H-PCRF. The H-PCRF also follows
the same procedures in determining whether to include AN-GW-Address AVP or not
in the CCA command.
3) Upon QoS rule provisioning:
When provisioning different QoS rules, the H-PCRF shall include the different
QoS rules within separate RAR commands, and shall also include the AN-GW-
Address AVP with the value set to the BBERF address to indicate the actual
BBERF where the rules are to be applied. The H-PCRF may also include
subscription for any event trigger by including the Event-Trigger AVP with the
corresponding value. For case 2a, the AN-GW-Address AVP is included at the
command level; for case 2b, the AN-GW-Address AVP is included at the
subsession level.
When provisioning the same QoS rules to all the BBERFs, the H-PCRF shall
include the QoS rules within the same RAR command without including the AN-GW-
Address AVP.
> 4) Upon Gateway Control Session termination over Gxx:
>
> When the V-PCRF receives a CCR command from any of the BBERFs for Gateway
> Control Session Termination, the V-PCRF shall modify the S9 session by
> sending CCR command to inform the H-PCRF the Gateway Control Session
> terminated. The V-PCRF shall include the Multiple-BBERF-Action AVP set to
> the value \"TERMINATION\" and the AN-GW-Address AVP to identify the BBERF
> initiating the termination.
\- For case 2a, the Multiple-BBERF-Action AVP and the AN-GW-Address AVP are
included at the command level.
\- For case 2b, the Multiple-BBERF-Action AVP and the AN-GW-Address AVP are
included in the Subsession-Enforcement-Info AVP that contains the allocated S9
subsession identifier within the Subsession-Id AVP and the Subsession-
Operation AVP set to the value \"MODIFICATION\".
When the H-PCRF receives the CCR command, the H-PCRF shall delete the QoS
rules related to the BBERF identified by the AN-GW-Address AVP.
NOTE: For case 2b the old BBERF always initiates the termination of the
Gateway Control Session.
> 5) Upon Request of Gateway Control Session Termination:
>
> When the H-PCRF decides to request the termination of a Gateway Control
> Session in the VPLMN for case 2a, the H-PCRF shall send an RAR command to
> request the V-PCRF terminated the Gateway Control session. The H-PCRF shall
> include the Multiple-BBERF-Action AVP set to the value \"TERMINATION\" and
> the AN-GW-Address AVP to identify the BBERF corresponding to the Gateway
> Control Session at the command level. The V-PCRF acknowledges this request
> by sending the RAA command.
>
> The V-PCRF shall trigger the termination of the corresponding Gateway
> Control session(s) over Gxx interface by applying the Request of Gateway
> Control session termination procedures as defined in 3GPP TS 29.212 [3]
> clause 4a.5.4. Then the V-PCRF shall apply the procedure \"Upon Gateway
> Control Session termination over Gxx\" in this clause.
##### 4.5.2.5.3 Handling of two BBERFs with flow mobility within the same IP-
CAN session
For IP flow mobility, the H-PCRF does not distinguish primary and non-primary
BBERF according to 3GPP TS 29.212 [3]. The H-PCRF and V-PCRF behaves as
described in subclause 4.5.2.5.2 with the exception that the H-PCRF does not
perform any procedure to detect if the new BBERF is primary or not and applies
the procedure described in 3GPP TS 29.212 [3] to detect that IP flow mobility
applies and that the UE is connected to multiple BBERF.
NOTE: IP flow mobility routing rules can be defined in case 2b only for PMIP-
based 3GPP accesses.
#### 4.5.2.6 Deferred Session Linking Handling
This procedure takes place at Initial IP-CAN Session Establishment and during
the inter-system BBERF relocation for case 2b.
NOTE: The deferred leg linking indication assists the PCRF to avoid linking
the Gateway Control Session with an obsolete Gx Session at initial IP-CAN
Session Establishment.
When the V-PCRF receives a CCR for Gateway Control Session Establishment
including Session-Linking-Indicator AVP set to the value
\"SESSION_LINKING_DEFERRED\" from a new BBERF related with an existing Gateway
Control session (i.e. the new Gateway Control session has the same values in
the Subscription-Id AVP and Called-Station-Id AVP as the existing Gateway
Control session), the V-PCRF shall establish a new S9 subsession by sending a
CCR command including the Subsession-Enforcement-Info AVP with a new S9
subsession identifier assigned by the V-PCRF within the Subsession-Id AVP, the
Subsession-Operation AVP set to the value \"ESTABLISHMENT\" and the Session-
Linking-Indicator AVP set to the value \"SESSION_LINKING_DEFERRED\". The
V-PCRF shall keep the mapping between the new Gateway Control session and the
new S9 subsession.
After the H-PCRF receives the CCR command as described above from the V-PCRF,
the H-PCRF applies the same deferred session linking procedure as described in
clause 4a.5.6 of 3GPP TS 29.212 [3] except that the Gateway Control Session is
replaced by the S9 subsession.
#### 4.5.2.7 Session Linking Handling When Multiple PDN Connection to a single
APN is supported
This procedure takes place in case 2b.
When the V-PCRF receives a CCR for Gateway Control Session Establishment with
the PDN Connection ID included in the PDN-Connection-ID AVP in addition to the
user identity included in Subscription-Id AVP and the PDN ID included in
Called-Station-Id AVP, the following procedures are applied:
\- If there is not an already established S9 session for this roaming user,
the V-PCRF shall send to the H-PCRF a CCR command with the CC-Request-Type set
to the value \"INITIAL_REQUEST\" to establish a new S9 session. The V-PCRF
shall include the Subsession-Enforcement-Info AVP within the CCR command with
a new S9 subsession identifier assigned by the V-PCRF within the Subsession-Id
AVP, PDN Connection ID within the PDN-Connection-ID AVP, the user identity
within the Subscription-Id AVP, the PDN ID within the Called-Station-Id AVP
and the Subsession-Operation AVP set to the value \"ESTABLISHMENT\". The
V-PCRF shall keep the mapping between new Gateway Control Session and the new
S9 subsession. When the H-PCRF receives the CCR for IP-CAN Session
Establishment from the PCEF that has the same values in the Subscription-Id
AVP, Called-Station-Id AVP and PDN-Connection-ID AVP as the new S9 subsession,
the H-PCRF shall link the Gx session with the new S9 subsession.
\- If an existing S9 session for the roaming user is already established and
if no Gateway Control Session for the same PDN ID exists or at least one
Gateway Contro Session for same PDN ID exists but the IP-CAN type received in
the the CCR command has not been modified, the V-PCRF sends a CCR command to
the H-PCRF to establish a new S9 subsession by including the Subsession-
Enforcement-Info AVP that contains a new S9 subsession identifier within the
Subsession-Id AVP, PDN Connection ID within the PDN-Connection-ID AVP, the
user identity within the Subscription-Id AVP, the PDN ID within the Called-
Station-Id AVP and the Subession-Operation AVP set to the value
\"ESTABLISHMENT\". The V-PCRF shall keep the mapping between new Gateway
Control Session and the new S9 subsession. When the H-PCRF receives the CCR
for IP-CAN Session Establishment from the PCEF that has the same values in the
Subscription-Id AVP, Called-Station-Id AVP and PDN-Connection-ID AVP as the
new S9 subsession, the H-PCRF shall link the Gx session with the new S9
subsession.
\- If at least one Gateway Control Session for same PDN ID exists and the IP-
CAN type received in the CCR command has been modified, the V-PCRF assumes
that this constitutes an inter-system BBERF relocation. The V-PCRF sends a CCR
command to the H-PCRF to establish a new S9 subsession by including the
Subsession-Enforcement-Info AVP that contains a new S9 subsession identifier
within the Subsession-Id AVP, PDN Connection ID within the PDN-Connection-ID
AVP, the user identity within the Subscription-Id AVP, the PDN ID within the
Called-Station-Id AVP and the Subession-Operation AVP set to the value
\"ESTABLISHMENT\". The V-PCRF shall keep the mapping between the new Gateway
Control Session and the new S9 subsession. When the H-PCRF receives the CCR
for IP-CAN Session Modification from the PCEF that has the same values in the
Subscription-Id AVP, Called-Station-Id AVP and PDN-Connection-ID AVP as the
new S9 subsession, the H-PCRF shall link the Gx session with the new S9
subsession.
### 4.5.3 Visited Access
#### 4.5.3.1 Request PCC and QoS Rules
The V-PCRF shall request for PCC or QoS rules from the H-PCRF in the following
instances:
1) A Diameter CCR command as defined in clause 4.5.1 of 3GPP TS 29.212 [3] is
received by the V-PCRF from the PCEF requesting PCC for a roaming user and/or
informing that an installed event trigger has been detected in this case the
affected PCC Rules are included by the PCEF.
2) A Diameter CCR command as defined in clause 4a.5.1 of 3GPP TS 29.212 [3] is
received by the V-PCRF from the BBERF requesting QoS Rules for a roaming user
and/or informing that an installed event trigger has been detected in this
case the affected QoS Rules are included by the BBERF. The procedures within
clause 4.5.3.5 shall be applied if during a multiple BBERF scenario the
request is coming from a non-primary BBERF.
3) A Diameter CCR command as defined in clause 4b.5.1 of 3GPP TS 29.212 [3] is
received by the V-PCRF from the TDF requesting ADC Rules for a roaming user
and/or informing that an installed event trigger has been detected; in this
case the affected ADC Rules are included by the TDF.
If the CCR command also includes the Event-Trigger AVP set to
\"RESOURCE_MODIFICATION_REQUEST\", the V-PCRF may validate the QoS in the
request. If the QoS validation fails, the V-PCRF shall reply to the PCEF/BBERF
over Gx/Gxx with a CCA command including the Gx experimental result code
DIAMETER_ERROR_INITIAL_PARAMETERS. Otherwise, the V-PCRF shall store the
information received in the CCR command from the BBERF/PCEF and send a new
request over S9 as follows:
\- If an existing S9 session for the roaming user does not already exist with
the H-PCRF, the V-PCRF shall establish a new S9 session with the H-PCRF by
sending a CCR command with the CC-Request-Type AVP set to the value
"INITIAL_REQUEST", to the H-PCRF.
\- If an existing S9 session for the roaming user is already established with
the H-PCRF, the V-PCRF shall update the existing session by sending a CCR
command with the CC-Request-Type AVP set to the value \"UPDATE_REQUEST\" to
the H-PCRF.
The V-PCRF shall include within the CCR command those attributes provided by
the BBERF and PCEF and TDF as defined in clause 4a.5.1 and 4.5.1 and 4b.5.1 of
3GPP TS 29.212 [3] respectively.
\- In case 2a if the original CCR command is received from the BBERF, the
V-PCRF shall include the attributes provided by the BBERF at the Diameter CCR
command level. If the original CCR command is received from the PCEF, the
V-PCRF shall include the attributes provided by the PCEF at the S9 subsession
level by including the Subsession-Enforcement-Info AVP with the corresponding
Subsession-Id AVP.
\- In case 1 or case 2b, the V-PCRF shall refer the request to the
corresponding S9 subsession by including, within the CCR command the
Subsession-Enforcement-Info AVP with the corresponding Subsession-Id AVP and
shall also include those attributes provided by the BBERF (for case 2b)/PCEF
(for case 1).
For case1, case 2a and case 2b,
\- If new subsessions are created the V-PCRF shall include within the
Subsession-Enforcement-Info AVP, the Subsession-Id AVP set to the value of a
new subsession identifier, the Subsession-Operation AVP set to the value
\"ESTABLISHMENT\". For case 1, the V-PCRF shall map the Gx session-id(s) to
the corresponding subsession-id(s) in the S9 session. For case 2a and case 2b,
the V-PCRF shall map the Gxx and Gx session-id(s) to the corresponding
subsession-id(s) in the S9 session.
NOTE: For case 2a, a new subsession will be created only when the original
received Diameter CCR from the PCEF indicates an establishment request for a
new Gx session. This is applicable also to case 2b although alternatively, the
new subsession might be created upon the reception of the gateway control
session establishment and be further modified when the corresponding IP-CAN
session establishment arrives to the V-PCRF.
\- If already existing subsessions are modified the V-PCRF shall set the
Subsession-Operation AVP value within the Subsession-Enforcement-Info AVP to
\"MODIFICATION\".
If the H-PCRF is, due to incomplete, erroneous or missing information (e.g.
subscription related information not available or authorized QoS exceeding the
subscribed bandwidth) not able to:
1) Provision a policy decision to one or more of the S9 subsession(s) within
the CCR command sent by the V-PCRF, the H-PCRF shall send a CCA command
including the S9 specific experimental result code DIAMETER_ERROR_SUBSESSION
(5470) at the command level. For each of the rejected subsessions, the H-PCRF
shall include the Subsession-Decision-Info AVP with the rejected Subsession-Id
within the Subsession-Id AVP and the appropriate error code within either the
Experimental-Result-Code AVP or Result-Code AVP. For each of the successful
subsessions, the H-PCRF shall include the Subsession-Decision-Info AVP with
the corresponding Subsession-Id AVP and any PCC rules to be provisioned.
2) Provision a policy decision to a CCR command sent by the V-PCRF with no S9
subsession information, the H-PCRF shall reject the request using a CCA
command with the DIAMETER_ERROR_INITIAL_PARAMETERS (5140) within the
Experimental-Result-Code AVP.
NOTE: CCR command with no subsession information is only used in case 2a.
When the V-PCRF receives a CCA command with an error code within the
Experimental-Result-Code AVP or Result-Code AVP at the command level, the
V-PCRF shall reply to the BBERF over the corresponding gateway control session
with a CCA command including the same result code.
When the V-PCRF receives a CCA command including QoS rules at command level,
with no subsession information and indicating success status at the command
level, the V-PCRF shall validate the QoS rules contained in the CCA. If the
QoS validation fails the V-PCRF shall send a CCR command to the H-PCRF
including the QoS-Rule-Report AVP to indicate the QoS Rules that were not
accepted, the Rule-Failure-Code AVP set to UNSUCCESSFUL_QOS_VALIDATION and the
QoS-Information AVP to indicate the acceptable QoS. Upon reception of the
subsequent CCA command from the H-PCRF, the V-PCRF shall reply to the BBERF
over Gxx with a CCA command. If the validation of the answer from the H-PCRF
is successful, the V-PCRF shall include the acceptable QoS in the QoS rules.
Otherwise, the V-PCRF shall reply to the BBERF over Gxx with a CCA command
including the Gx experimental result code DIAMETER_ERROR_INITIAL_PARAMETERS.
NOTE: In order to avoid loops in the QoS negotiation process, it is
recommended that the H-PCRF provides a QoS acceptable by the Visited Network.
When the V-PCRF receives a CCA command including QoS rules at command level,
with no subsession information and indicating success status at the command
level and if the QoS validation is successful, the V-PCRF shall follow the
procedures described in 3GPP TS 29.212 [3] to provision the QoS rules to the
BBERF. If after provisioning the QoS rules to the BBERF, the V-PCRF receives a
notification from the BBERF informing that an operation on one or more QoS
rule has failed, the V-PCRF shall immediately inform the H-PCRF. The V-PCRF
shall send a CCR command with the CC-Request-Type AVP set to the value
UPDATE_REQUEST to the H-PCRF including the QoS-Rule-Report AVP to indicate the
QoS rules that were affected at the command level. The H-PCRF may decide to
reinstall, modify or remove the affected QoS rules as described in this clause
or terminate the S9 session/subsession as described in clause 4.5.3.4.
When the V-PCRF receives a CCA command where the S9 specific subsession
contains a specific error code within a Result-Code or Experimental-Result-
Code AVP from the H-PCRF, the V-PCRF shall inform the trigger(s) of the
related CCR command (i.e. BBERF and/or PCEF and/or TDF) with a CCA command
including the same result code.
When the V-PCRF receives a CCA command where the S9 specific subsession
indicates success status, the V-PCRF shall validate the PCC rules contained in
the CCA. If the validation fails, the V-PCRF shall send a CCR command to the
H-PCRF including Subsession-Enforcement-Info AVP with the corresponding
Subsession-Id and include the Charging-Rule-Report AVP to indicate the PCC
Rules that were not accepted, the Rule-Failure-Code AVP set to
UNSUCCESSFUL_QOS_VALIDATION, and the QoS-Information AVP to indicate the
acceptable QoS. Upon reception of the subsequent CCA command, if the
validation of the answer is not successful, the V-PCRF shall reply to the PCEF
over Gx and the BBERF if applicable over Gxx with a CCA command including the
Gx experimental result code DIAMETER_ERROR_INITIAL_PARAMETERS. Otherwise, the
V-PCRF shall act as if the QoS validation is successful.
NOTE: In order to avoid loops in the QoS negotiation process, it is
recommended that the H-PCRF provides a QoS acceptable by the Visited Network.
When the V-PCRF receives a CCA command where the S9 specific subsession
indicates success status and if the QoS validation is successful, the V-PCRF
shall derive QoS rules based on the PCC rules received for case 2a and case
2b. The V-PCRF shall map the S9 subsession to the corresponding Gx and Gxx and
follow the procedures described in 3GPP TS 29.212 [3] to provision the PCC/QoS
rules to the PCEF and BBERF respectively using, if the PCEF/BBERF sent the
original CCR command, CCA command or, if the PCEF/BBERF did not send the
original CCR command, RAR command.
NOTE: Provisioning rules within RAR command can be needed for those cases when
the V-PCRF receives CCR command related with a particular event from only the
BBERF or only the PCEF or the TDF. For example, an event-trigger such as
QOS_CHANGE can trigger only the BBERF to send the CCR command while an event-
trigger such as OUT_OF_CREDIT can trigger only the PCEF to send the CCR
command.
When there is a TDF deployed in the visited network and the V-PCRF receives a
CCA command where the S9 specific subsession indicates success status, the
V-PCRF shall derive ADC rules based on the received PCC rules with application
identifiers as defined in subclause 4.5.3.10.5. The V-PCRF shall map the S9
subsession to the corresponding TDF session and follow the procedures
described in 3GPP TS 29.212 [3] to provision the ADC rules to the TDF
respectively using, if the TDF sent the original CCR command, CCA command or,
if the TDF did not send the original CCR command, RAR command.
If after provisioning the rules to the PCEF/BBERF/TDF, the V-PCRF receives a
notification from the PCEF (case 1, 2a, 2b) or the BBERF (case 2a and 2b) or
TDF or all the PCEF, the BBERF and the TDF informing that an operation on a
PCC/Qo/ADC S rule has failed, the V-PCRF shall inform the H-PCRF. The V-PCRF
shall send a CCR command with the CC-Request-Type AVP set to the value
UPDATE_REQUEST to the H-PCRF including the Charging-Rule-Report AVP to
indicate the PCC rules that were affected at the subsession level by including
the Subsession-Enforcement-Info AVP identifying the affected S9 subsession
within the Subsession-Id AVP, the Subsession-Operation AVP set to the value
"MODIFICATION". The H-PCRF may decide to reinstall, modify or remove the
affected PCC rules as described in this clause or terminate the S9
session/subsession as described in clause 4.5.3.4.
#### 4.5.3.2 PCC and QoS Rules Provisioning
The H-PCRF shall provision, via the S9 reference point, PCC and QoS rules
rules, using one of the following procedures:
\- PULL procedure (Provisioning solicited by the V-PCRF): In response to a
request for PCC rules being made by the V-PCRF, as described in the preceding
section, to provide QoS rules for case 2a where no corresponding PCC rules are
sent, the H-PCRF shall provision QoS rules in the CCA by including the QoS-
Rule-Install AVP at the command level; for other cases, the H-PCRF shall
provision PCC rules and in the CCA command by including the Charging-Rule-
Install AVP within the Subsession-Decision-Info AVP on the S9 subsession(s)
that requested for PCC rules or in response to a request for PCC Rules being
made by the V-PCRF, as described in the preceding section instance.
\- PUSH procedure (Unsolicited provisioning from the H-PCRF). The H-PCRF may
decide to provision (install, modify ore remove) PCC Rules without obtaining a
request from the V-PCRF, e.g. in response to information provided to the
H-PCRF from the AF (either in the visited or in the home network), or in
response to an internal trigger within the H-PCRF, or from a trigger by the
SPR. To install or modify QoS Rules without a request from the V-PCRF for case
2a when there are no related PCC rules, the H-PCRF shall provision QoS rules
in the RAR by including the QoS-Rule-Install AVP at the command level; to
provision PCC Rules without a request from the V-PCRF, the H-PCRF shall
include these PCC Rules in an RAR command by including the Charging-Rule-
Install AVP on the related S9 subsessions within the Subsession-Decision-Info
AVP. To remove installed PCC Rules without a request from the V-PCRF, the
H-PCRF shall include these PCC Rules in a RAR command by including the
Charging-Rule-Remove AVP on the related S9 subsessions within the Subsession-
Decision-Info AVP.
The V-PCRF shall validate the QoS information contained within the PCC rules
of the CCA/RAR command. If the QoS validation fails or other error conditions
occur for PCC rules provisioned within the CCA command from the H-PCRF, the
V-PCRF shall follow the procedures specified in clause 4.5.3.1 for error
handling. Otherwise, if the QoS validation fails or other error conditions
occur when provisioning PCC rules using the RAR command, the procedures below
apply.
If the QoS information is provisioned at the command level and the validation
fails, the V-PCRF shall respond back to the H-PCRF by issuing an RAA command
that includes, at the command level, the DIAMETER_PCC_RULE_EVENT (5142)
experimental result code, the QoS-Rule-Report AVP to indicate the QoS Rules
that were not accepted, the Rule-Failure-Code AVP set to
UNSUCCESSFUL_QOS_VALIDATION, and the QoS-Information AVP to indicate the
acceptable QoS.
If the QoS information is provisioned at the command level and the validation
is successful, the V-PCRF shall follow the procedures described in 3GPP TS
29.212 [3] to provision the QoS rules to the BBERF. If after provisioning the
rules to the BBERF, the V-PCRF receives a notification from the BBERF
informing that an operation on a QoS rule has failed, the V-PCRF shall
immediately inform the H-PCRF. The V-PCRF shall send a RAA command to the
H-PCRF including the QoS-Rule-Report AVP to indicate the QoS rules that were
affected at the command level. The H-PCRF may decide to reinstall, modify or
remove the affected Rules as described in this clause or terminate the S9
session/subsession as described in clause 4.5.3.4. If the provisioning of the
rules was successful, the V-PCRF shall inform the H-PCRF by sending a RAA
command containing, at the command level, the information included in the
notification received from the BBERF.
If the QoS information is provisioned at the subsession level and the
validation for all subsession fails, the V-PCRF shall send a RAA command to
the H-PCRF, including the Subsession-Enforcement-Info AVP for each rejected S9
subsession. Each Subsession-Enforcement-Info AVP includes the rejected
Subsession-Id, a DIAMETER_PCC_RULE_EVENT (5142) experimental result code, the
Charging-Rule-Report AVP to indicate the PCC Rules that were not accepted, the
Rule-Failure-Code AVP set to UNSUCCESSFUL_QOS_VALIDATION, and the QoS-
Information AVP to indicate the acceptable QoS.
If the QoS information is provisioned at the subsession level and the
validation for one or more subsession is successful, the V-PCRF shall
provision the validated rules to the PCEF/BBERF first. For all validated PCC
rules, the V-PCRF derives QoS rules based on the PCC rules for case 2a and
case 2b. The V-PCRF follows the procedures specified in 3GPP TS 29.212 [3] to
provision the rules to the BBERF/PCEF.
If after provisioning the rules to the PCEF/BBERF, the V-PCRF receives a
notification from either the PCEF (case 1, 2a, 2b) or the BBERF (case 2a and
2b) informing that an operation on a PCC/QoS rule has failed, the V-PCRF shall
inform the H-PCRF.
After obtaining the QoS validation and rules installation (if applicable)
result, the V-PCRF shall send a RAA command to the H-PCRF and for each
subsession, include the Subsession-Enforcement-Info AVP with the Subsession-Id
AVP. In addition, for each subsession, the Subsession-Enforcement-Info shall
include,
\- if the QoS validation failed at the V-PCRF, a DIAMETER_PCC_RULE_EVENT
(5142) experimental result code, the Charging-Rule-Report AVP to indicate the
PCC Rules that were not accepted, the Rule-Failure-Code AVP set to
UNSUCCESSFUL_QOS_VALIDATION, and the QoS-Information AVP to indicate the
acceptable QoS.
\- if the V-PCRF received notification from the BBERF/PCEF indicating failure
in provision, the Experimental-Result-Code AVP or Result-Code AVP received
from the PCEF if available or from the BBERF otherwise, the Charging-Rule-
Report AVP to indicate the failed PCC Rules and any other additional
information received from the BBERF/PCEF.
\- if the provision was successful, the result-code and other information
received from the PCEF/BBERF.
If the TDF is deployed in the visited network and the V-PCRF receives PCC
rule(s) with application identifier(s) from the H-PCRF within CCA command, and
if a Sd session towards the TDF in the VPLMN is already established, the
V-PCRF shall map the S9 subsession to the corresponding Sd session and follow
the procedures specified in 3GPP TS 29.212 [3] to provision the ADC rules
extracted from the PCC rules as defined in subclause 4.5.3.10.5. to the TDF.
If a Sd session towards the TDF in the VPLMN is not yet established, the
V-PCRF shall also initiate Sd session establishment specified in subclause
4.5.3.10.1 before ADC rule provisioning.
NOTE: PCC Rules provisioning in this case is only applicable to the solicited
application reporting.
After obtaining the ADC rules installation result from the TDF, the V-PCRF
shall send a RAA command to the H-PCRF and, for each subsession, shall include
the Subsession-Enforcement-Info AVP with the Subsession-Id AVP. In addition,
for each subsession, the Subsession-Enforcement-Info shall include:
\- if the V-PCRF received a notification from the TDF indicating a
provisioning failure within the ADC-Rule-Report, the V-PCRF shall include this
information within the Charging-Rule-Report AVP to indicate the failed PCC
Rules, and any other additional information received from the TDF.
\- if the provisioning was successful, the result-code and other information
received from the TDF.
The result code or the experimental result code at the RAA command level shall
be set to the following value:
\- DIAMETER_SUCCESS (2001), if all subsessions have been provisioned
successfully;
\- DIAMETER_ERROR_SUBSESSION (5470), if one or more S9 subsessions have
failed.
For failed PCC rules, the H-PCRF may decide to reinstall, modify or remove the
affected PCC Rules as described in this clause or terminate the S9
session/subsession as described in clause 4.5.3.4.
#### 4.5.3.3 S9 Session/Subsession Termination Initiated by V-PCRF.
When the V-PCRF receives an indication of an IP-CAN Session Termination from
the PCEF or an indication of Gxx session termination from the BBERF, the
V-PCRF shall acknowledge the received message by sending the CCA command to
the PCEF or the BBERF as defined in 3GPP TS 29.212 [3]. In addition, the
V-PCRF shall indicate to the H-PCRF one of the following actions:
1) Terminate the S9 session, if in case 2a, the Gxx session is removed or in
case 1 or case 2b, the last S9 subsession for the roaming user is removed. The
V-PCRF shall terminate the S9 session with the H-PCRF by sending a CCR with
the CC-Request-Type AVP set to the value 'TERMINATION_REQUEST".
2) Update the S9 session for the roaming user, if there are remaining S9
subsessions for the roaming user. The V-PCRF shall update the existing S9
session with the H-PCRF by sending a CCR command with CC-Request-type AVP set
to value "UPDATE-REQUEST" that includes the Subsession-Enforcement-Info AVP
with the removed S9 subsession identifier within the Subsession-Id AVP, the
Subsession-Operation AVP set to the value "TERMINATION".
NOTE: In case 2b, when the V-PCRF receives a Gxx session termination request
from the BBERF (i.e. a CCR command with CC-Request-Type AVP set to value
"TERMINATION_REQUEST") , it handles it as specified in 3GPP TS 29.212 [3]
without impacting S9.
When receiving the CCR command, the H-PCRF shall perform the following steps:
1) Identify the removed PCC Rules associated to the terminated S9 session or
S9 subsession;
2) If an IP-CAN session is terminated, check whether the H-AF and/or V-AF
shall be informed and if the H-AF and/or V-AF needs to be informed, send an
ASR command as defined in clause 4.4.6.1 of 3GPP TS 29.214 [5]
The H-PCRF answers to the V-PCRF by issuing a CCA command.
#### 4.5.3.4 S9 Session/Subsession Termination Initiated by the H-PCRF.
The H-PCRF may decide to terminate an S9 session or S9 subsession based on an
internal trigger or a trigger from the SPR. When any of these triggers are
met, the H-PCRF shall initiate a S9 session or S9 subsession termination by
sending an RAR command to the V-PCRF as defined in clause 4.5.2.4.
The V-PCRF shall trigger the termination of corresponding IP-CAN session(s) by
applying the PCRF-Initiated IP-CAN session termination procedure for non-
roaming case as defined in 3GPP TS 29.213 [4] clause 4.2.3.1.
#### 4.5.3.5 Multiple BBERF Handling
The V-PCRF distinguishes two types of BBERF: primary and non-primary according
to 3GPP TS 29.212 [3].
The V-PCRF shall ensure that the QoS rules are aligned with the PCC rules on
all BBERFs as specified in TS 29.212 [3] clause 4a.5.7
When the V-PCRF receives a CCR command for Gateway Control Session
Establishment from a new BBERF that is related with an existing Gateway
Control Session, the V-PCRF determines whether case 2a or case 2b applies as
defined in 3GPP TS 29.213 [4] and applies the following procedures:
\- If case 2a applies, the V-PCRF modifies the S9 session by sending a CCR
command including the attributes provided by the new BBERF at the Diameter CCR
command level.
\- If case 2b applies and if the H-PCRF has subscribed to either the
AN_GW_CHANGE or the IP-CAN_CHANGE event trigger, the V-PCRF modifies the S9
session by sending a CCR command including the attributes provided by the new
BBERF in the Subsession-Enforcement-Info AVP that contains the allocated S9
subsession identifier within the Subsession-Id AVP and the Subsession-
Operation AVP set to the value \"MODIFICATION\"; otherwise, the V-PCRF shall
not contact the H-PCRF.
When, due to handover, the V-PCRF receives an IP CAN session modification from
the PCEF with the event trigger set to AN_GW_CHANGE the V-PCRF shall send a
CCR message to the H-PCRF with the Event-Trigger AVP at subsession level set
to AN_GW_CHANGE, provided the H-PCRF has subscribed to this event-trigger. If
the CCR message from the PCEF also includes the IP-CAN_CHANGE event-trigger,
the V-PCRF shall reclassify the primary/ non-primary BBERFs based on the
received IP-CAN type, and shall include this trigger as well at subsession
level in the CCR message sent to the H-PCRF, provided the H-PCRF has
subscribed to it. If there is any subsequent request coming from the primary
BBERF, the V-PCRF shall act according to the normal procedures specified in
clause 4.5.3 and corresponding subclauses.
If the H-PCRF has not subscribed to either the AN_GW_CHANGE or the IP-
CAN_CHANGE event, the V-PCRF shall not inform the H-PCRF of this scenario and
should solve it according to local policies and roaming agreements.
#### 4.5.3.6 Rx Over S9
##### 4.5.3.6.1 General
The interaction between the V-AF and the V-PCRF is in accordance with 3GPP TS
29.214 [5]. The V-PCRF may act as a Diameter Proxy or client/server to send
the Rx messages between the V-AF and the H-PCRF except as noted below.
If the Subscription-Id AVP is received in the AAR command and the IMSI can not
be extracted or if the Subscription-ID AVP is not received in the AAR command,
the V-PCRF may alternatively determine the Destination-Realm based on session
binding within the V-PCRF.
NOTE: With the session binding, for Rx over S9 reference point interactions
the V-PCRF can find the UE Identity that is received from Gx/Gxx reference
point and use it to construct the EPC Home Network Realm/Domain, as indicated
in 3GPP TS 23.003 [9], clause 19.2, and use it as Destination-Realm.
If the IP-Domain-Id is received in the AAR command from the V-AF, the V-PCRF
may remove it from the AAR command before forwarding the AAR command to the
H-PCRF if the session binding is performed. In this case, if the Subscription-
Id AVP is used to assist in the session binding, in order to allow the H-PCRF
to perform session binding, the V-PCRF may add Subscription-Id AVP and Called-
Station-Id AVP received over Gx/Gxx reference point to the AAR command before
sending the AAR command to the H-PCRF.
The V-PCRF may process the initial or modified Service Information received
from the V-AF according to the operator policy to decide whether the request
is accepted or not. If the service information provided by the V-AF is
rejected, the V-PCRF shall send the AAA to reject the request with the
Experimental-Result-Code AVP set to the value
REQUESTED_SERVICE_NOT_AUTHORIZED. In this case, the V-PCRF shall not forward
the AAR to the H-PCRF.
The V-PCRF shall not forward the AAR message from the V-AF to the H-PCRF if
the processing of the request results in any of the specific values of the "Rx
specific Experimental-Result-Code" per clause. 5.5 of 3GPP TS 29.214 [5].
##### 4.5.3.6.2 Event Handling
###### 4.5.3.6.2.1 V-AF Subscription to Notification of Signalling Path Status
A V-AF may subscribe to notifications of the status of the AF Signalling
transmission path by including the Specific-Action AVP with the corresponding
value as described in section 4.4.5 of 3GPP TS 29.214 [5].
When the V-PCRF receives an AAR command for the establishment of the AF
signalling session from the V-AF, the V-PCRF, depending on operator policy,
may not forward the AAR message to the H-PCRF. In this case, the V-PCRF
handles the AF signalling session locally and shall acknowledge the AAR
command by sending an AAA command to the V-AF and follow the procedures
described in subclause 4.4.5 of 3GPP TS 29.214 [5]. Otherwise, the V-PCRF
proxies the AAR to the H-PCRF.
###### 4.5.3.6.2.2 Reporting of Signalling Path Status
If the V-PCRF is handling the AF signalling session locally with the V-AF
(i.e. the V-PCRF is not proxying the AF signalling session to the H-PCRF) and
subscribed to the signalling path status specific actions
(\"INDICATION_OF_LOSS_OF_BEARER\" and/or "INDICATION_OF_RELEASE_OF_BEARER"),
and the V-PCRF is notified of the loss or release of resources associated to
the PCC Rules corresponding with V-AF Signalling IP Flows, the V-PCRF shall
inform the V-AF about the Loss of the Signalling Transmission Path by sending
a Re‑Authorization Request (RAR) command to the V-AF per section 4.4.6.3 of
3GPP TS 29.214 [5].
The V-PCRF shall send a CCR message to the H-PCRF over the S9 interface
reporting this event trigger only if the H-PCRF has previously subscribed to
the corresponding event trigger.
###### 4.5.3.6.2.3 Reporting IP-CAN Type Change Notification
If the V-PCRF is handling the AF signalling session locally with the V-AF
(i.e. the V-PCRF is not proxying the AF signalling session to the H-PCRF) and
the V-AF has subscribed for change notification in UE\'s IP-CAN type and RAT
type, then the V-PCRF shall send a RAR command when there is a change in the
UE\'s IP-CAN type or RAT type (if the IP-CAN type is 3GPP-GPRS) per section
4.4.6.4 of 3GPP TS 29.214 [5].
The V-PCRF shall send a CCR message to the H-PCRF over the S9 interface
reporting this event trigger only if the H-PCRF has previously subscribed to
the corresponding event trigger.
#### 4.5.3.7 Deferred Session Linking Handling
This procedure takes place at initial IP-CAN Session Establishment and during
the inter-system BBERF relocation for case 2b.
NOTE: The deferred leg linking indication assists the PCRF to avoid linking
the Gateway Control Session with an obsolete Gx Session at initial IP-CAN
Session Establishment.
When the V-PCRF receives a CCR for Gateway Control Session Establishment
including Session-Linking-Indicator AVP set to the value
\"SESSION_LINKING_DEFERRED\" from a new BBERF related with an existing Gateway
Control session (i.e. the new Gateway Control session has the same values in
the Subscription-Id AVP and Called-Station-Id AVP as the existing Gateway
Control session), the V-PCRF shall acknowledage by sending a CCA to the BBERF
and shall not send the CCR to the H-PCRF to update the S9 session immediately.
If the V-PCRF receives the CCR for IP-CAN session modification that has the
same values in the Subscription-Id AVP and Called-Station-Id AVP as the new
Gateway Control session, the V-PCRF shall link the new Gateway Control session
with the existing Gx session, and then send a CCR to H-PCRF to modify the S9
subsession by including the Subsession-Enforcement-Info AVP within the CCR
command that contains the already allocated S9 subsession identifier within
the Subsession-Id AVP, the Subsession-Operation AVP set to the value
\"MODIFICATION\". The V-PCRF shall keep the mapping between the new Gateway
Control session, the existing Gx session and the S9 subsession. The Multiple
BBERF handling procedures described in clause 4.5.3.5 are also applicable now.
If the V-PCRF receives the CCR for IP-CAN session establishment that has the
same values in the Subscription-Id AVP and Called-Station-Id AVP as the new
Gateway Control session, the V-PCRF shall link the new Gateway Control session
with the new Gx session, and then send a CCR command to H-PCRF to establish a
new S9 subsession by including the Subsession-Enforcement-Info AVP within the
CCR command that contains a new S9 subsession identifier within the
Subsession-Id AVP, the Subsession-Operation AVP set to the value
\"ESTABLISHMENT\". The V-PCRF shall keep the mapping between the new Gateway
Control session, the new Gx session and the new S9 subsession.
#### 4.5.3.8 Session Linking Handling When Multiple PDN Connection to a single
APN is supported
This procedure takes place in case 2b.
When the V-PCRF receives a CCR for Gateway Control Session Establishment with
the PDN Connection ID included in the PDN-Connection-ID AVP in addition to the
user identity included in Subscription-Id AVP and the PDN ID included in
Called-Station-Id AVP, the following procedures are applied:
\- If there is not an already established S9 session for this roaming user,
the V-PCRF shall send to the H-PCRF a CCR command with the CC-Request-Type set
to the value \"INITIAL_REQUEST\" to establish a new S9 session. The V-PCRF
shall include the Subsession-Enforcement-Info AVP within the CCR command with
a new S9 subsession identifier assigned by the V-PCRF within the Subsession-Id
AVP and the Subsession-Operation AVP set to the value \"ESTABLISHMENT\". The
PDN Connection ID shall not be sent to the H-PCRF. When the V-PCRF receives
the CCR for IP-CAN Session Establishment from the PCEF that has the same
values in the Subscription-Id AVP, Called-Station-Id AVP and PDN-Connection-ID
AVP as the new Gateway Control Session, the V-PCRF shall link the new Gateway
Control Session with the Gx session. The V-PCRF shall keep the mapping between
the new Gateway Control Session, the new Gx session and the new S9 subsession.
\- If an existing S9 session for the roaming user is already established and
if no Gateway Control Session for the same PDN ID exists or at least one
Gateway Control Session for same PDN ID exists but the IP-CAN type received in
the CCR command has not been modified, and the PDN Connection ID received in
the CCR command is different the V-PCRF sends a CCR command to H-PCRF to
establish a new S9 subsession by including the Subsession-Enforcement-Info AVP
within the CCR command that contains a new S9 subsession identifier within the
Subsession-Id AVP and the Subsession-Operation AVP set to the value
\"ESTABLISHMENT\". The PDN Connection ID shall not be sent to the H-PCRF. When
the V-PCRF receives the CCR for IP-CAN Session Establishment from the PCEF
that has the same values in the Subscription-Id AVP, Called-Station-Id AVP and
PDN-Connection-ID AVP as the new Gateway Control Session, the V-PCRF shall
link the new Gateway Control Session with the Gx session. The V-PCRF shall
keep the mapping between the new Gateway Control Session, the new Gx session
and the new S9 subsession.
\- If at least one Gateway Control Session for same PDN ID exists and the IP-
CAN type received in the CCR command has been modified, the V-PCRF assumes
that this constitutes an inter-system BBERF relocation.
\- If the Framed-IP-Address AVP and/or Framed-IPv6-Prefix AVP are received,
the V-PCRF link the new Gateway Control session with the existing Gx session
where the Framed-IP-Address AVP and/or Framed-IPv6-Prefix AVP are equal and
the PDN ID are matched and then shall send a CCR command to H-PCRF to modify
the S9 subsession by including the Subsession-Enforcement-Info AVP within the
CCR command that contains the already allocated S9 subsession identifier
within the Subsession-Id AVP and the Subsession-Operation AVP set to the value
\"MODIFICATION\". The V-PCRF shall keep the mapping between the new Gateway
Control session, the Gx session and the S9 subsession.
\- If the Framed-IP-Address AVP and/or Framed-IPv6-Prefix AVP are not
received, the V-PCRF shall not link the new Gateway Control Session with any
Gx session and shall not contact with the H-PCRF immediately. When the V-PCRF
receives a CCR command for IP-CAN Session Modification that has the same
values in the Subscription-Id AVP, Called-Station-Id AVP and PDN-Connection-ID
AVP as the new Gateway Control Session, the V-PCRF shall link the new Gateway
Control Session with the Gx sesssion, and then shall send a CCR command to
H-PCRF to modify the S9 subsession by including the Subsession-Enforcement-
Info AVP within the CCR command that contains the already allocated S9
subsession identifier within the Subsession-Id AVP and the Subsession-
Operation AVP set to the value \"MODIFICATION\". The V-PCRF shall keep the
mapping between the new Gateway Control session, the Gx session and the S9
subsession.
#### 4.5.3.9 IP flow mobility support
This procedure takes place if the IP flow mobility is applied as described in
3GPP TS 23.261 [10]
When the V-PCRF receives a CCR command for IP-CAN Session establishment with
the Routing-Rule-Install AVP from the PCEF, the V-PCRF shall send a CCR
command to H-PCRF to establish a new S9 subsession by including the
Subsession-Enforcement-Info AVP within the CCR command that contains a new S9
subsession identifier within the Subsession-Id AVP and the Subsession-
Operation AVP set to the value \"ESTABLISHMENT\". If and only if the H-PCRF
has subscribed either the AN_GW_CHANGE or the IP-CAN_CHANGE event trigger, the
Routing-Rule-Install AVP is included in the Subsession-Enforcement-Info.
When the V-PCRF receives a CCR command for IP-CAN Session modification with
the Routing-Rule-Install AVP and/or Routing-Rule-Remove AVP, the Event-Trigger
AVP set to ROUTING_RULE_CHANGE from the PCEF, if and only if the H-PCRF has
subscribed either the AN_GW_CHANGE or the IP-CAN_CHANGE event trigger, the
V-PCRF shall send a CCR command to H-PCRF to modify the S9 subsession by
including the Subsession-Enforcement-Info AVP within the CCR command that
contains the Routing-Rule-Install AVP and/or Routing-Rule-Remove AVP, the
Event-Trigger AVP set to ROUTING_RULE_CHANGE, the already allocated S9
subsession identifier within the Subsession-Id AVP and the Subsession-
Operation AVP set to the value \"MODIFICATION\".
If the H-PCRF has not subscribed either the AN_GW_CHANGE or the IP-CAN_CHANGE
event trigger, the V-PCRF shall handle the IP flow mobility locally as
described in 3GPP TS 29.212 [3].
#### 4.5.3.10 Application Detection and Control
This procedure takes place if Application Detection and Control feature with
solicited or unsolicited application reporting is support as defined in clause
5.4.1.
##### 4.5.3.10.1 General
For the solicited application reporting, the H-PCRF may decide that the
application detection and control shall be initiated based on roaming
policies. In order to do that, the H-PCRF shall provision new PCC rules as
described in clause 4.5.3.2.
If the PCEF indicates support of Application Detection and Control feature
during the IP-CAN session establishment, the V-PCRF shall provision the PCC
rules received from the H-PCRF as described in 3GPP TS 29.212 [3], clause
4.5.2 by sending RAR/CCA command.
Otherwise, if the TDF is deployed in the visited network, the V-PCRF shall
initiate the TDF session establishment by sending TSR command as defined in
3GPP TS 29.212 [3], clause 4b.5.1.1 and provision ADC rules extracted from the
PCC Rules received from the H-PCRF as defined in subclause 4.5.3.10.5. The
V-PCRF shall keep the mapping between the TDF session and S9 subsession.
If the H-PCRF removes all the PCC rules, from which the corresponding ADC
Rules were extracted, with the Charging-Rule-Remove AVP of the IP-CAN
session(e.g. subscriber profile changes) , the V-PCRF shall initiate the TDF
session termination by sending RAR command as defined in 3GPP TS 29.212 [3],
clause 4b.5.4.
If the ABC feature as described in subclause 5b.4.1 of 3GPP TS 29.212 [3]
applies, the V-PCRF may provide the maximum allowed bit rate which applies to
the TDF session to the TDF at the command level by including the QoS-
Information AVP in the TSR, CCA or RAR. Only the Max-Requested-Bandwidth-UL
AVP and the Max-Requested-Bandwidth-DL AVP shall be used.
NOTE: In order to avoid down-link packets being discarded in PCEF when TDF
performs charging, the V-PCRF will set the Maximum downlink bit rate to the DL
APN-AMBR.
If the V-PCRF receives the Charging-Information AVP, Online AVP, Offline AVP
from the H-PCRF and/or 3GPP-Charging‑Characteristics AVP from the PCEF, the
V-PCRF shall provide them to the TDF in the TSR command.
For unsolicited application reporting, the TDF initiates the TDF session
establishment by sending a CCR command as defined in 3GPP TS 29.212 [3] if the
TDF session correponding to the detected application does not exist. The
parameters described in clause 4b.5.1.1 of 3GPP TS 29.212 [3] may also be
included in the CCR command. The V-PCRF shall keep the mapping between the TDF
session and S9 subsession. If the S9 subsession is terminated by the V-PCRF or
the H-PCRF or the IPv4 address of a dual stack IP-CAN session is released and
there is an active IPv4 address related TDF session for the corresponding S9
subsession, the V-PCRF shall initiate the TDF session termination by sending
RAR command as defined in 3GPP TS 29.212 [3].
##### 4.5.3.10.2 Void
##### 4.5.3.10.3. Void
##### 4.5.3.10.4. Application Detection Information
If the V-PCRF receives a notification from the PCEF supporting Application
Detection and Control feature or the TDF with the Application-Detection-
Information AVP, informing that the corresponding application has been
detected and, if the H-PCRF has subscribed the
APPLICATION_START/APPLICATION_STOP and Mute-Notification AVP is not included
in the corresponding PCC rule with application identifier, the V-PCRF shall
inform the H-PCRF. The V-PCRF shall send a CCR command with the CC-Request-
Type AVP set to the value UPDATE_REQUEST to the H-PCRF including the
Application-Detection-Information AVP, as received from the PCEF or TDF, at
the subsession level by including the Subsession-Enforcement-Info AVP
identifying the affected S9 subsession within the Subsession-Id AVP, the
Subsession-Operation AVP set to the value "MODIFICATION". The H-PCRF may then
decide to reinstall, modify or remove the PCC rules as described in clause
4.5.3.1. Otherwise, if the Flow-Information AVP is included in the
Application-Detection-Information, the V-PCRF may provision a new PCC rule to
the PCEF and a corresponding QoS rule to the BBERF, if applicable, based on
service data flow descriptions in the Flow-Information and the QoS information
from the corresponding PCC rule previously provisioned by the H-PCRF.
When the V-PCRF receives a CCA command where the S9 specific subsession
contains a specific error code within a Result-Code or Experimental-Result-
Code AVP from the H-PCRF, the V-PCRF shall inform the trigger(s) of the
related CCR command (i.e. PCEF and/or TDF) with a CCA command including the
same result code.
For unsolicited application reporting, the Application Detection Information
is only reported from the TDF.
##### 4.5.3.10.5. ADC Rule Derivation
If the TDF is deployed in the VPLMN, when the V-PCRF receives the PCC rule
with application identifier from the H-PCRF, the V-PCRF shall derive the ADC
rule from the PCC rule as follows:
\- The V-PCRF allocates the value of ADC-Rule-Name AVP and keeps the mapping
between the value of ADC-Rule-Name AVP and value of PCC-Rule-Name AVP.
\- The V-PCRF sets the TDF-Application-Identifier AVP, the Flow-Status AVP,
the Monitoring-Key AVP, the Max-Requested-Bandwidth-UL AVP, the Max-Requested-
Bandwidth-DL AVP, the Redirect-Information AVP, the Service-Identifier AVP,
the Rating-Group AVP, the Reporting-Level AVP, the Online AVP, the Offline AVP
and the Metering-Method AVP as the values in the corresponding AVPs of the PCC
rule if available.
\- The V-PCRF sets the Precedence AVP based on the value received in the PCC
rule.
\- The V-PCRF does not include the Qos-Class-Identifier AVP, Allocation-
Retention-Priority AVP, the Guaranteed-Bitrate-UL AVP and the Guaranteed-
Bitrate-DL AVP in the QoS-Information AVP of the ADC rule regardless if they
are included in the PCC rule.
\- The V-PCRF may include the Mute-Notification AVP in the ADC rule if it is
included in the PCC rule.
### 4.5.4 IMS Emergency services
The S9 interface is not applicable for IMS Emergency services.
In case 2a, the V-PCRF upon reception of a CCR command with a CC-Request-Type
AVP set to \"INITIAL_REQUEST\" from the PCEF over Gx shall check if the
Called-Station-Id AVP includes a PDN identifier that matches one of the
Emergency APNs from the configurable list specified in 3GPP TS 29.212 [3]. If
the V-PCRF identifies that the request for PCC Rules is restricted to
Emergency services then shall send a CCA command to the PCEF to provision PCC
Rules and then the V-PCRF may provision QoS Rules to the BBERF as specified in
3GPP TS 29.212 [3].
NOTE: In case 2a, the V-PCRF detects that an IP-CAN session is for Emergency
Services at reception of the request for PCC Rules for Emergency purposes over
Gx.
# 5\. S9 Protocol
## 5.1 Protocol Support
The S9 application is defined as a vendor specific Diameter application, where
the vendor is 3GPP and the Application-ID for the S9 Application in the
present release is 16777267. The vendor identifier assigned by IANA to 3GPP
(http://www.iana.org/assignments/enterprise-numbers) is 10415.
NOTE: A route entry can have a different destination based on the application
identification AVP of the message. Therefore, Diameter agents (relay, proxy,
redirection, translation agents) must be configured appropriately to identify
the 3GPP S9 application within the Auth-Application-Id AVP in order to create
suitable routeing tables.
Due to the definition of the commands used in the S9 protocol, there is no
possibility to skip the Auth-Application-Id AVP and use the Vendor-Specific-
Application-Id AVP instead. Therefore the S9 application identification shall
be included in the Auth-Application-Id AVP.
With regard to the Diameter protocol defined over the S9 interface, the H-PCRF
acts as a Diameter server, in the sense that it is the network element that
handles PCC/QoS rule requests for a particular realm. The V-PCRF acts as the
Diameter client, in the sense that it is the network element requesting
PCC/QoS rules to the H-PCRF.
A Diameter S9 session used in the S9 protocol shall combine all Gx and Gxx
Diameter sessions for a particular UE.
## 5.2 Initialization, maintenance and termination of connection and session
The initialization and maintenance of the connection between each
V-PCRF/H-PCRF pair is defined by the underlying protocol. Establishment and
maintenance of connections between Diameter nodes is described in IETF RFC
3588 [6].
After establishing the transport connection, the V-PCRF and the H-PCRF shall
advertise the support of the S9 specific Application by including the value of
the application identifier in the Auth-Application-Id AVP and the value of the
3GPP (10415) in the Vendor-Id AVP of the Vendor-Specific-Application-Id AVP
contained in the Capabilities‑Exchange-Request and Capabilities-Exchange-
Answer commands. The Capabilities-Exchange-Request and Capabilities-Exchange-
Answer commands are specified in the Diameter Base Protocol (RFC 3588 [6]).
The termination of the S9 Diameter session can be initiated either by the
V-PCRF or H-PCRF, as specified in subclauses 4.5.2 and 4.5.3.
In case of roaming, when S9 protocol is used for 3GPP accesses, a V-PCRF shall
use, by default, the IMSI (MNC and MCC values) of the user provided over
Gxc/Gx to construct the EPC Home Network Realm/Domain, as indicated in 3GPP TS
23.003 [9], clause 19.2, and use it as Destination-Realm. However the V-PCRF
may alternatively determine the Destination-Realm based on slocal
configuration within the V-PCRF. This configuration follows specific roaming
agreement between the visited and the home operators.
## 5.3 S9 specific AVPs
Table 5.3.1 describes the Diameter AVPs defined for the S9 reference point,
their AVP Code values, types, possible flag values, whether or not the AVP may
be encrypted and the applicability of the AVPs to charging control, policy
control or both. The Vendor-Id header of all AVPs defined in the present
document shall be set to 3GPP (10415).
Table 5.3.1: S9 specific Diameter AVPs
| AVP Flag rules (note 1) |  |  |  |  |  |  |  |  |   
---|---|---|---|---|---|---|---|---|---|---  
Attribute Name | AVP Code | Clause defined | Value Type (note 2) | Must | May | Should not | Must not | May Encr. | Acc. type | Applicability (note 3)  
DRA-Deployment | 2206 | 5.3.7 | Enumerated | V | P |  | M | Y | Non-3GPP-EPS 3GPP-EPS | PC EPC-routed  
Multiple-BBERF-Action | 2204 | 5.3.6 | Enumerated | M,V | P |  |  | Y | All | PC  
Subsession-Decision-Info | 2200 | 5.3.1 | Grouped | M,V | P |  |  | Y | All | Both  
Subsession-Enforcement-Info | 2201 | 5.3.2 | Grouped | M,V | P |  |  | Y | All | Both  
Subsession-Id | 2202 | 5.3.3 | Unsigned32 | M,V | P |  |  | Y | All | Both  
Subsession-Operation | 2203 | 5.3.4 | Enumerated | M,V | P |  |  | Y | All | Both  
DRA-Binding | 2208 | 5.3.x | Enumerated | V | P |  | M | Y | Non-3GPP-EPS 3GPP-EPS | PC EPC-routed  
NOTE 1: The AVP header bit denoted as 'M', indicates whether support of the AVP is required. The AVP header bit denoted as 'V', indicates whether the optional Vendor-ID field is present in the AVP header. For further details, see RFC 3588 [6]. NOTE 2: The value types are defined in RFC 3588 [6]. NOTE 3: AVPs marked with “CC” are applicable to charging control, AVPs marked with “PC” are applicable to policy control and AVPs marked with “Both” are applicable to both charging control and policy control. |  |  |  |  |  |  |  |  |  |   
### 5.3.1 Subsession-Decision-Info
The Subsession-Decision-Info AVP (AVP code 2204) is of type Grouped, and it is
used to manage PCC/QoS rules and event information within an S9 subsession
from the H-PCRF to the V-PCRF.
The information contained within this grouped AVP pertains only to the
subsession identified by the Subsession-Id AVP.
The Session-Release-Cause AVP is only applicable when the Subsession-Decision-
Info AVP is provided in a RAR.
The Result-Code AVP and Experimental-Result-Code AVP are only applicable when
the Subsession-Decision-Info AVP is provided in a CCA. The Result-Code AVP or
Experimental-Result-Code AVP may be provided to inform the V-PCRF of possible
errors when processing subsession information that was provided in a
corresponding CCR command.
AVP Format:
Subsession-Decision-Info ::= \
{ Subsession-Id }
0*2[ AN-GW-Address ]
[ Result-Code ]
[ Experimental-Result-Code ]
*[ Charging-Rule-Remove ]
*[ Charging-Rule-Install ]
[ Event-Report-Indication ]
*[ QoS-Rule-Install ]
*[ QoS-Rule-Remove ]
**[ Default-EPS-Bearer-QoS ]**
**[ Framed-Ipv6-Prefix ]**
***[ Usage-Monitoring-Information ]**
[ Session-Release-Cause ]
[ Bearer-Control-Mode ]
*[ Event-Trigger ]
**[ Revalidation-Time ]**
[ Online ]
[ Offline ]
*[ QoS-Information ]
*[ AVP ]
### 5.3.2 Subsession-Enforcement-Info
The Subsession-Enforcement-Info AVP (AVP code 2201) is of type Grouped, and it
is used to set up and tear down subsessions, provide information about the
subsession, request PCC/QoS rules and report on PCC/QoS rules and related
events. This information is sent from the V-PCRF to the H-PCRF. The
information contained within this grouped AVP pertains only to the subsession
identified by the Subsession-Id AVP.
The following AVPs are only applicable when the Subsession-Enforcement-Info
AVP is provided within a CCR: Subsession-Operation AVP, Bearer-Identifier AVP,
Bearer-Operation AVP, Packet-Filter-Information AVP, Packet-Filter-Operation
AVP, Framed-IP-Address AVP, Framed-IPv6-Prefix AVP, Called-Station-ID AVP,
PDN-Connection-ID AVP, Bearer-Usage AVP, TFT-Packet-Filter-Information AVP,
Online AVP, Offline AVP, Application-Detection-Information AVP, Routing-Rule-
Install AVP, Routing-Rule-Remove AVP and Credit-Management-Status AVP.
The following AVPs are only applicable when the Subsession-Enforcement-Info
AVP is provided within an RAA: Result-Code AVP and Experimental-Result-Code
AVP.
The other AVPs are applicable when the Subsession-Enforcement-Info AVP is
provided in either a CCR or RAA.
IP-CAN-Type AVP, RAT-Type AVP, 3GPP-SGSN-MCC-MNC AVP, 3GPP-SGSN-Address AVP,
3GPP-SGSN-IPv6-Address AVP, RAI AVP, 3GPP-User-Location-Info AVP, 3GPP2-BSID
AVP and User-CSG-Information AVP are only applicable when the MAPCON feature
is supported as described in clause 5.4.1.
The Result-Code AVP or Experimental-Result-Code AVP may be provided to inform
the H-PCRF of possible errors when processing subsession information that was
provided in a corresponding RAR command.
Subsession-Enforcement-Info ::= \
{ Subsession-Id }
[ Subsession-Operation ]
0*2[ AN-GW-Address ]
[ Bearer-Identifier ]
[ Bearer-Operation ]
*[ Packet-Filter-Information ]
**[ Packet-Filter-Operation ]**
[ QoS-Information ]
[ Framed-IP-Address ]
[ Framed-IPv6-Prefix ]
*[ CoA-Information ]
[ Called-Station-Id ]
**[ PDN-Connection-ID ]**
[ Bearer-Usage ]
*[ TFT-Packet-Filter-Information ]
[ Online ]
[ Offline ]
[ Result-Code ]
[ Experimental-Result-Code ]
*[ Charging-Rule-Report ]
[ Credit-Management-Status ]
*[ QoS-Rule-Report ]
***[ Application-Detection-Information ]**
**[ IP-CAN-Type ]**
**[ RAT-Type ]**
**[ 3GPP-SGSN-MCC-MNC ]**
**[ 3GPP-SGSN-Address ]**
**[ 3GPP-SGSN-IPv6-Address ]**
**[ RAI ]**
**[ 3GPP-User-Location-Info]**
**[ 3GPP2-BSID ]**
**[ User-CSG-Information ]**
**[ Default-EPS-Bearer-QoS ]**
**[** Network-Request-Support ]
**[ Routing-Rule-Install ]**
**[ Routing-Rule-Remove ]**
**[ User-Location-Info-Time ]**
[ Logical-Access-ID ]
[ Physical-Access-ID ]
***[ Usage-Monitoring-Information ]**
[ Multiple-BBERF-Action ]
*[ Event-Trigger ]
[ Access-Network-Charging-Address ]
*[ Access-Network-Charging-Identifier-Gx ]
[ Session-Linking-Indicator ]
[ HeNB-Local-IP-Address ]
[ UE-Local-IP-Address ]
[ UE-Local-IPv6-Prefix ]
[ UDP-Source-Port ]
> [ AN-GW-Status ]
*[ AVP ]
### 5.3.3 Subsession-Id
The Subsession-Id AVP (AVP code 2202) is of type Unsigned32, and it is used to
uniquely identify a subsession within the S9 session. The Subsession-Id AVP
shall be selected by the V-PCRF.
### 5.3.4 Subsession-Operation
The Subsession-Operation AVP (AVP code 2203) is of type of Enumerated, and it
indicates the operation to be performed on the subsession.
The following values are defined:
TERMINATION (0)
> This value is used to indicate that a subsession is being terminated.
ESTABLISHMENT (1)
> This value is used to indicate that a new subsession is being established.
MODIFICATION (2)
> This value is used to indicate that an existing subsession is being
> modified.
### 5.3.5 Void
### 5.3.6 Multiple-BBERF-Action
The Multiple-BBERF-Action AVP (AVP code 2204) is of type Enumerated, and it
indicates that the Gateway Control Session in the VPLMN is established or
terminated in the multiple BBERFs scenario.
The following values are defined:
ESTABLISHMENT (0)
This value shall be used to indicate that the Gateway Control Session in the
VPLMN is established in the multiple BBERFs scenario.
TERMINATION (1)
This value shall be used to indicate that the Gateway Control Session in the
VPLMN is terminated in the multiple BBERFs scenario.
### 5.3.7 DRA-Deployment
The DRA-Deployment AVP (AVP code 2206) is of type Enumerated and is used by
the V-DRA (proxy) to indicate to the H-PCRF that whether the DRA is deployed
in the visited network.
The following values are defined:
DRA_Deployed (0)
This value indicates that the DRA is deployed.
### 5.3.8 DRA-Binding
The DRA-Binding AVP (AVP code 2208) is of type of Enumerated, and it indicates
that the action to be done on the DRA binding information.
The following values are defined:
DRA_BINDING_DELETION (0)
> This value is used to indicate the DRA binding information in the DRA shall
> be deleted.
## 5.4 S9 re-used AVPs
The S9 reference point re-uses all of the Gx and Gxx AVPs specified in 3GPP TS
29.212 [3], including the AVPs re-used by Gx and Gxx as specified in clauses
5.4 and 5a.4 of 3GPP TS 29.212 [3] with exceptions noted below.
3GPP-RAT-Type AVP, QoS-Rule-Base-Name AVP and TDF-Information AVP are not
applicable for the S9 reference point.
The event trigger value PGW_TRACE_CONTROL is not applicable for the S9
reference point.
Reused AVPs marked with a supported feature (e.g. \"Rel9\", \"Rel10\",
\"MAPCON\", \"IFOM\", \"SADC\", \"USADC\", \"vSRVCC\", \"EPC-routed\" or
\"NSWO\") are applicable as described in clause 5.4.1.
### 5.4.1 Use of the Supported-Features AVP on the S9 reference point
The Supported-Features AVP is used during session establishment to inform the
destination host about the required and optional features that the origin host
supports. The client shall, in the first request of a Diameter session
indicate the set of supported features.. The server shall, in the first answer
within the Diameter session indicate the set of features that it has in common
with the client and that the server shall support within the same Diameter
session. Any further command messages shall always be compliant with the list
of supported features indicated in the Supported-Features AVPs during session
establishment. Features that are not advertised as supported shall not be used
to construct command messages for that Diameter session. Unless otherwise
stated, the use of the Supported-Features AVP on the S9 reference point shall
be compliant with the requirements for dynamic discovery of supported features
on the Cx reference point as defined in clause 7.2.1 of 3GPP TS 29.229 [7].
The base functionality for the S9 reference point is the 3GPP Rel-8 standard
and a feature is an extension to that functionality. If the origin host does
not support any features beyond the base functionality, the Supported-Features
AVP shall be absent from the S9 commands. As defined in clause 7.1.1 of 3GPP
TS 29.229 [7], when extending the application by adding new AVPs for a
feature, the new AVPs shall have the \'M\' bit cleared and the AVP shall not
be defined mandatory in the command ABNF.
As defined in 3GPP TS 29.229 [7], the Supported-Features AVP is of type
grouped and contains the Vendor-Id, Feature-List-ID and Feature-List AVPs. On
the S9 reference point, the Supported-Features AVP is used to identify
features that have been defined by 3GPP and hence, for features that are
defined in this document, the Vendor-Id AVP shall contain the vendor ID of
3GPP (10415). If there are multiple feature lists defined for the S9 reference
point, the Feature-List-ID AVP shall differentiate those lists from one
another.
On receiving an initial request application message, the destination host
shall act as defined in clause 7.2.1 of 3GPP TS 29.229 [7]. The following
exceptions apply to the initial CCR/CCA command pair:
\- If the V-PCRF supports post-Rel-8 S9 functionality,the CCR shall include
the features supported by the V-PCRF within Supported-Features AVP(s) with the
\'M\' bit cleared.
NOTE 1: One instance of Supported-Features AVP is needed per Feature-List-ID
\- If the CCR command does not contain any Supported-Features AVP(s) and the
H-PCRF supports Rel-8 S9 functionality, the CCA command shall not include the
Supported-Features AVP. In this case, both V-PCRF and H-PCRF shall behave as
specified in this document.
\- If the CCR command contains the Supported-Features AVP(s), the H-PCRF shall
include the Supported-Features AVP(s) in the CCA command, with the \'M\' bit
cleared, indicating only the features that both the V-PCRF and H-PCRF support.
NOTE 2: The client will always declare all features that are supported
according to table 5.4.1.1. When more than one feature identifying a release
is supported by both V-PCRF and H-PCRF, the V-PCRF will work according to the
latest common supported release.
Once the V-PCRF and H-PCRF have negotiated the set of supported features
during session establishment, the set of common features shall be used during
the lifetime of the Diameter session.
The table below defines the features applicable to the S9 interfaces for the
feature list with a Feature-List-ID of 1.
Table 5.4.1.1: Features of Feature-List-ID 1 used in S9
+-------------------+-------------------+-----+-------------------+ | Feature bit | Feature | M/O | Description | +-------------------+-------------------+-----+-------------------+ | 0 | Rel9 | M | This feature | | | | | indicates the | | | | | support of base | | | | | 3GPP Rel-9 S9 | | | | | functionality, | | | | | including the | | | | | AVPs and | | | | | corresponding | | | | | procedures | | | | | supported by the | | | | | base 3GPP Rel-8 | | | | | S9 standard, but | | | | | excluding those | | | | | features | | | | | represented by | | | | | separate feature | | | | | bits. AVPs | | | | | introduced with | | | | | this feature are | | | | | marked with | | | | | \"Rel9\" as | | | | | described in | | | | | clause 5.4. | +-------------------+-------------------+-----+-------------------+ | 1 | Rel10 | M | This feature | | | | | indicates the | | | | | support of base | | | | | 3GPP Rel-10 S9 | | | | | functionality, | | | | | including the | | | | | AVPs and | | | | | corresponding | | | | | procedures | | | | | supported by the | | | | | Rel8 and Rel9 | | | | | standard, but | | | | | excluding those | | | | | features | | | | | represented by | | | | | separate feature | | | | | bits. AVPs | | | | | introduced with | | | | | this feature are | | | | | marked with | | | | | \"Rel10\" as | | | | | described in | | | | | clause 5.4. | +-------------------+-------------------+-----+-------------------+ | 2 | MAPCON | O | This feature | | | | | indicates support | | | | | for the feature | | | | | of multi access | | | | | PDN connectivity | | | | | as described in | | | | | clause 4.5.1.8 | +-------------------+-------------------+-----+-------------------+ | 3 | IFOM | O | This feature | | | | | indicates support | | | | | for the feature | | | | | of IP flow | | | | | mobility as | | | | | described in | | | | | clause 4.5.2.5 | +-------------------+-------------------+-----+-------------------+ | 4 | SADC | O | This feature | | | | | indicates support | | | | | for Application | | | | | Detection and | | | | | Control feature | | | | | with solicited | | | | | application | | | | | reporting. This | | | | | shall be set in | | | | | case either | | | | | \"ADC\" feature | | | | | bit is set over | | | | | the Gx interface | | | | | as described in | | | | | clause 5.4.1 of | | | | | 3GPP | | | | | TS 29.212 [3] | | | | | or there is TDF | | | | | supporting | | | | | solicited | | | | | application | | | | | reporting in the | | | | | network. | +-------------------+-------------------+-----+-------------------+ | 5 | USADC | O | This feature | | | | | indicates support | | | | | for Application | | | | | Detection and | | | | | Control feature | | | | | with unsolicited | | | | | application | | | | | reporting. This | | | | | shall be set in | | | | | case there is TDF | | | | | supporting | | | | | unsolicited | | | | | application | | | | | reporting in the | | | | | network. | +-------------------+-------------------+-----+-------------------+ | 6 | vSRVCC | O | This feature | | | | | indicates support | | | | | for the vSRVCC | | | | | feature (see | | | | | 3GPP T | | | | | S 23.216 [13]). | +-------------------+-------------------+-----+-------------------+ | 7 | EPC-routed | O | This feature | | | | | indicates support | | | | | for interworking | | | | | with Fixed | | | | | Broadband Access | | | | | networks when the | | | | | traffic is routed | | | | | via the EPC | | | | | network as | | | | | defined in Annex | | | | | A. | +-------------------+-------------------+-----+-------------------+ | 8 | NSWO | O | This feature | | | | | indicates support | | | | | for interworking | | | | | with Fixed | | | | | Broadband Access | | | | | networks when the | | | | | traffic is | | | | | offloaded to the | | | | | Fixed Broadband | | | | | access network as | | | | | defined in Annex | | | | | A. | +-------------------+-------------------+-----+-------------------+ | 9 | NetLoc | O | This feature | | | | | indicates the | | | | | support of the | | | | | Access Network | | | | | Information | | | | | Reporting. | +-------------------+-------------------+-----+-------------------+ | 10 | TimeBasedUM | O | This feature | | | | | indicates support | | | | | for Time based | | | | | Usage Monitoring | | | | | Control. This | | | | | shall be set in | | | | | case the | | | | | \"TimeBasedUM\" | | | | | feature bit is | | | | | set either over | | | | | the Gx interface | | | | | as described in | | | | | subclause 5.4.1 | | | | | of 3GPP | | | | | TS 29.212 [3] | | | | | or over the Sd | | | | | interface as | | | | | described in | | | | | 5b.4.1 of 3GPP | | | | | TS 29.212 [3]. | | | | | If the PCEF or | | | | | TDF supports this | | | | | feature, the | | | | | behaviour shall | | | | | be as specified | | | | | in corresponding | | | | | subclauses of | | | | | 3GPP | | | | | TS 29.212 [3]. | +-------------------+-------------------+-----+-------------------+ | 11 | P | O | This feature | | | endingTransaction | | indicates support | | | | | for the race | | | | | condition | | | | | handling as | | | | | defined in 3GPP | | | | | TS 29.213 [4] | +-------------------+-------------------+-----+-------------------+ | 12 | ABC | O | This feature | | | | | indicates support | | | | | for Application | | | | | Based Charging as | | | | | defined in the | | | | | 3GPP | | | | | TS 29.212 [3]. | | | | | This shall only | | | | | be set in case | | | | | "ABC" feature is | | | | | set over the Sd | | | | | and/or Gx | | | | | interface as | | | | | described in the | | | | | 3GPP | | | | | TS 29.212 [3]. | +-------------------+-------------------+-----+-------------------+ | 13 | SGW-Rest | O | This feature | | | | | indicates the | | | | | support of SGW | | | | | Restoration | | | | | procedures as | | | | | defined in 3GPP | | | | | TS 23.007 [20]. | +-------------------+-------------------+-----+-------------------+ | Feature bit: The | | | | | order number of | | | | | the bit within | | | | | the | | | | | **Feature-List | | | | | AVP where the | | | | | least significant | | | | | bit is assigned | | | | | number "0".** | | | | | | | | | | **Feature: A | | | | | short name that | | | | | can be used to | | | | | refer to the bit | | | | | and to the | | | | | feature, e.g. | | | | | \"EPS\".** | | | | | | | | | | **M/O: Defines if | | | | | the | | | | | implementation of | | | | | the feature is | | | | | mandatory (\"M\") | | | | | or optional | | | | | (\"O\") in this | | | | | 3GPP Release.** | | | | | | | | | | Description: A | | | | | clear textual | | | | | description of | | | | | the feature. | | | | +-------------------+-------------------+-----+-------------------+
## 5.5 S9 Messages
### 5.5.1 S9 Application
S9 Messages are carried within the Diameter Application(s) described in
subclause 5.1.
Existing Diameter command codes from the Diameter base protocol RFC 3588 [6]
and the Diameter Credit Control Application RFC 4006 [19] are used with the S9
specific AVPs specified in clause 5.3. The Diameter Credit Control Application
AVPs and AVPs from other Diameter applications that are re-used are defined in
clause 5.4. Due to the definition of these commands there is no possibility to
skip the Auth-Application-Id AVP and use the Vendor-Specific-Application-Id
AVP instead. Therefore the S9 application identifier shall be included in the
Auth-Application-Id AVP.
NOTE: Some of the AVPs included in the messages formats below are in bold to
highlight that these AVPs are used by this specific protocol and do not belong
to the original message definition in the DCC Application RFC 4006 [19] or
Diameter Base Protocol RFC 3588 [6].
### 5.5.2 CC-Request (CCR) Command
The CCR command, indicated by the Command-Code field set to 272 and the \'R\'
bit set in the Command Flags field, is sent by the V-PCRF to the H-PCRF in
order to request PCC or QoS rules. The CCR command is also sent by the V-PCRF
to the H-PCRF in order to indicate bearer or PCC/QoS rule related events.
Message Format:
\ ::= \
\
{ Auth-Application-Id }
{ Origin-Host }
{ Origin-Realm }
{ Destination-Realm }
{ CC-Request-Type }
{ CC-Request-Number }
[ Destination-Host ]
[ Origin-State-Id ]
*[ Subscription-Id ]
[ Framed-IP-Address ]
[ Framed-IPv6-Prefix ]
***[ Supported-Features ]**
**[ QoS-Information ]**
***[ QoS-Rule-Report ]**
**0*2 [ AN-GW-Address ]**
**[ Network-Request-Support ]**
***[ Packet-Filter-Information ]**
**[ Packet-Filter-Operation ]**
***[ Subsession-Enforcement-Info ]**
**[ IP-CAN-Type ]**
**[ RAT-Type ]**
[ Termination-Cause ]
[ User-Equipment-Info ]
**[ QoS-Negotiation ]**
**[ QoS-Upgrade ]**
**[ 3GPP-SGSN-MCC-MNC ]**
**[ 3GPP-SGSN-Address ]**
**[ 3GPP-SGSN-IPv6-Address ]**
**[ RAI ]**
**[ 3GPP-User-Location-Info]**
**[ 3GPP-MS-TimeZone ]**
**[ 3GPP2-BSID ]**
***[ Event-Trigger]**
**[ Multiple-BBERF-Action ]**
**[ User-CSG-Information ]**
*[ Proxy-Info ]
*[ Route-Record ]
*[ AVP ]
NOTE: Multiple instances of the Subscription-Id AVP in the CCR command
correspond to multiple types of identifier for the same subscriber, for
example IMSI and MSISDN.
### 5.5.3 CC-Answer (CCA) Command
The CCA command, indicated by the Command-Code field set to 272 and the \'R\'
bit cleared in the Command Flags field, is sent by the H-PCRF to the V-PCRF in
response to the CCR command. It is used to provision PCC/QoS rules and event
triggers for the subsession/session
Message Format:
\ ::= \
\
{ Auth-Application-Id }
{ Origin-Host }
{ Origin-Realm }
[ Result-Code ]
[ Experimental-Result ]
{ CC-Request-Type }
{ CC-Request-Number }
***[ Supported-Features]**
***[ QoS-Rule-Install ]**
***[ QoS-Rule-Remove ]**
***[ QoS-Information ]**
**[ Bearer-Control-Mode ]**
***[ Event-Trigger ]**
**[ Charging-Information ]**
***[ Subsession-Decision-Info ]**
***[ CSG-Information-Reporting ]**
0*2[ AN-GW-Address ]
**[ Origin-State-Id ]**
**[ Error-Message ]**
**[ Error-Reporting-Host ]**
*[ Failed-AVP ]
*[ Proxy-Info ]
*[ Route-Record ]
*[ AVP ]
### 5.5.4 Re-Auth-Request (RAR) Command
The RAR command, indicated by the Command-Code field set to 258 and the \'R\'
bit set in the Command Flags field, is sent by the H-PCRF to the V-PCRF in
order to provision QoS/PCC rules and event triggers for the
subsession/session.
Message Format:
\ ::= \
\
{ Auth-Application-Id }
{ Origin-Host }
{ Origin-Realm }
{ Destination-Realm }
{ Destination-Host }
{ Re-Auth-Request-Type }
[ Origin-State-Id ]
***[ QoS-Rule-Install ]**
***[ QoS-Rule-Remove ]**
***[ QoS-Information ]**
***[ Event-Trigger ]**
***[ Subsession-Decision-Info ]**
**0*2[ AN-GW-Address ]**
**[ Session-Release-Cause ]**
[ HeNB-Local-IP-Address ]
[ UE-Local-IP-Address ]
[ UDP-Source-Port ]
*[ Proxy-Info ]
[ Called-Station-Id ]
*[ Route-Record ]
*[ AVP]
### 5.5.5 Re-Auth-Answer (RAA) Command
The RAA command, indicated by the Command-Code field set to 258 and the \'R\'
bit cleared in the Command Flags field, is sent by the V-PCRF to the H-PCRF in
response to the RAR command.
Message Format:
\ ::= \
\
{ Origin-Host }
{ Origin-Realm }
[ Result-Code ]
[ Experimental-Result ]
[ Origin-State-Id ]
[ Framed-IP-Address ]
[ Framed-IPv6-Prefix ]
**[ IP-CAN-Type ]**
**[ RAT-Type ]**
**[ 3GPP-SGSN-MCC-MNC ]**
**[ 3GPP-SGSN-Address ]**
**[ 3GPP-SGSN-IPv6-Address ]**
**[ RAI ]**
**[ 3GPP-User-Location-Info ]**
**[ 3GPP-MS-TimeZone ]**
**[ 3GPP2-BSID ]**
**[ QoS-Information ]**
***[ QoS-Rule-Report ]**
**0*2[ AN-GW-Address ]**
***[ Subsession-Enforcement-Info ]**
**[ User-CSG-Information ]**
[ Error-Message ]
[ Error-Reporting-Host ]
*[ Failed-AVP ]
*[ Proxy-Info ]
*[ AVP ]
### 5.5.7 Trigger-Establishment-Request (TER) Command
The TER command, indicated by the Command-Code field set to 8388656 and the
\'R\' bit set in the Command Flags field, is sent by the H-PCRF to the V-PCRF
in order to trigger the S9 Session Establishment. It is also sent by the
H-PCRF to the V-DRA in order to remove the DRA binding information created
during the S9 Session Establishment Trigger procedure.
Message Format:
\ ::= \
\
{ Auth-Application-Id }
{ Origin-Host }
{ Origin-Realm }
{ Destination-Realm }
{ Destination-Host }
[ Auth-Session-State ]
[ Origin-State-Id ]
**[ Subscription-Id ]**
**[ Called-Station-Id ]**
**[ UE-Local-IP-Address ]**
**[ HeNB-Local-IP-Address ]**
[DRA-Binding ]
**[ UDP-Source-Port ]**
*[ Proxy-Info ]
*[ Route-Record ]
*[ AVP ]
### 5.5.8 Trigger-Establishment-Answer (TEA) Command
The TEA command, indicated by the Command-Code field set to 8388656 and the
\'R\' bit cleared in the Command Flags field, is sent by the V-PCRF to the
H-PCRF in response to the TER command.
Message Format:
\ ::= \
\
{ Origin-Host }
{ Origin-Realm }
[ Result-Code ]
[ Experimental-Result ]
[ Origin-State-Id ]
**[ DRA-Deployment ]**
[ Error-Message ]
[ Error-Reporting-Host ]
*[ Failed-AVP ]
*[ Proxy-Info ]
*[ AVP ]
## 5.6 S9 specific Experimental-Result-Code AVP values
### 5.6.1 General
RFC 3588 [6] specifies the Experimental-Result AVP containing Vendor-ID AVP
and Experimental-Result-Code AVP. The Experimental-Result-Code AVP (AVP Code
298) is of type Unsigned32 and contains a vendor-assigned value representing
the result of processing a request. The Vendor-ID AVP shall be set to 3GPP
(10415).
### 5.6.2 Success
Result Codes that fall within the Success category are used to inform a peer
that a request has been successfully completed.
The Result-Code AVP values defined in Diameter BASE RFC 3588 [6] shall be
applied.
### 5.6.3 Permanent Failures
Errors that fall within the Permanent Failures category shall be used to
inform the peer that the request failed, and should not be attempted again.
The Result-Code AVP values defined in Diameter BASE RFC 3588 [6] and 3GPP TS
29.212 [3] are applicable. Also the following specific S9 Experimental-Result-
Codes values are defined:
DIAMETER_ERROR_SUBSESSION (5470)
> This error shall be used when one or more S9 subsessions within the answer
> contains an unsuccessful Result-Code or Experimental-Result-Code value. The
> Result Code specific to the request related to the subsession is specified
> within the corresponding Subsession-Decision-Info or Subsession-Enforcement-
> Info AVP.
DIAMETER_ERROR_ONGOING_SESSION_ESTABLISHMENT (5471)
> This error shall be used within the TEA command by the V-PCRF when the
> V-PCRF receives a TER command from the H-PCRF to trigger an S9 session
> establishment for the EPC-routed traffic while the S9 session is being
> established for the NSWO traffic by the V-PCRF initiated by the BPCF.
### 5.6.4 Transient Failures
Errors that fall within the transient failures category are used to inform a
peer that the request could not be satisfied at the time it was received, but
may be able to satisfy the request in the future.
The Result-Code AVP values defined in Diameter Base RFC 3588 [6] and 3GPP TS
29.212 [3] are applicable.
Additional handling for the following Experimental-Result-Code defined in 3GPP
TS 29.212 [3] is specified:
DIAMETER_PENDING_TRANSACTION (4144)
This error shall be used when a PCRF that supports the PendingTransaction
feature receives an incoming request on a session while it has an ongoing
transaction on the same session and cannot handle the request as described in
Clause 8.2 of 3GPP TS 29.213 [4]. If the error is specific to a subset of the
S9 subsessions, this Experimental-Result-Code shall be included within the
corresponding Subsession-Decision-Info or Subsession-Enforcement-Info AVP. In
this case, the DIAMETER_ERROR_SUBSESSION Experimental-Result-Code shall be
included at the command level. Otherwise, if this error is applicable to the
session level, this Experimental-Result-Code shall be included at the command
level.
###### ## Annex A (normative): Access specific aspects, Fixed Broadband Access
interworking with EPC
# A.1 Scope
This annex defines access specific aspects procedures for the use of S9a
between the BPCF and the PCRF in the non-roaming case or between the BPCF and
the V-PCRF in the roaming case and the S9 between V-PCRF and H-PCRF.
# A.2 Definitions and abbreviations
## A.2.1 Definitions
**UE local IP address** is defined as: either the public IPv4 address and/or
IPv6 address/IPv6 network prefix assigned to the UE by the BBF domain in the
no-NAT case, or the public IPv4 address assigned by the BBF domain to the
NATed RG that is used for this UE.
**H(e)NB local IP address** is defined as: either the public IPv4 address
and/or IPv6 address/IPv6 network prefix assigned to the H(e)NB by the BBF
domain in the no-NAT case, or the public IPv4 address assigned by the BBF
domain to the NATed RG that is used for this H(e)NB.
**Non-seamless WLAN offload (NSWO)** is defined as: a capability of routing
specific IP flows over the WLAN access without traversing the EPC as defined
in subclause 4.1.5 of 3GPP TS 23.402 [18].
**Non-seamless WLAN offload APN (NSWO-APN)** is defined as: an APN allowing
the BPCF to indicate to PCRF that for subscribers of a certain HPLMN the IP-
CAN session is related to NSWO traffic.
**EPC-routed traffic** is defined as**:** User plane traffic that is routed
via a PDN GW in EPC as part of a PDN Connection. EPC-routed traffic applies to
non-roaming, roaming with home routed and roaming with visited access cases.
## A.2.2 Abbreviations
The following abbreviations are relevant for this annex only:
BBF Broadband Forum
BPCF Broadband Policy Control Function
NA(P)T Network Address (Port) Translation
NSWO Non-Seamless WLAN offload
NSWO-APN Non-Seamless WLAN offload APN
RG Residential Gateway
# A.3 Reference points and Reference model
## A.3.0 General
For Fixed Broadband Access network interworking, the applied scenarios of case
1, case 2a and case 2b are defined in subclause E.4.1 in 3GPP TS 29.213 [4].
## A.3.1 S9a Reference Point
The S9a reference point is located between the PCRF in the PLMN and BPCF in
the Fixed Broadband Access Network (BPCF) for the non-roaming case and between
the the PCRF in the VPLMN (V-PCRF) and the BPCF in the Fixed Broadband Access
Network (BPCF) for the roaming case. The S9a reference point enables transfer
of dynamic QoS control policies from the (V-)PCRF to the BPCF for the purpose
of allocation of QoS resources in the Fixed Broadband Access Network.
Two Diameter applications are used over the S9a reference point: S9a and S9a*.
The purpose of the S9a Diameter application is to transfer QoS rules from the
(V-)PCRF to the BPCF in the EPC-Routed scenario. The purpose of the S9a*
Diameter application is to transfer PCC rules from the (V-)PCRF to the BPCF in
the NSWO scenario.
## A.3.2 S9 Reference Point
In addition to the specification of the S9 reference point defined in clause
4, this reference point is used to trigger the V-PCRF to initiate the S9a
session establishment. The S9 interface is enhanced to carry from the H-PCRF
to the V-PCRF the UE local IP address, the H(e)NB local IP address the UDP
source port number, if available, and the ePDG IP address derived from the
ePDG IP address IE as defined in subclause 7.2.1 of 3GPP TS 29.274 [22] (for
GTP-based S2b access) or used as the IPSec tunnel endpoint with the UE (for
untrusted S2c access), or the PDN GW IP address used as the endpoint of the
DSMIPv6 IPv4 user plane tunnel or the DSMIPv6 IPv6 user plane tunnel with the
UE (for trusted S2c access).
## A.3.3 Reference Model
The relationships between the different functional entities involved in the
non-roaming for EPC-routed are depicted in figure A.3.3.1 and A.3.3.2.
Figure A.3.3.1: S9a reference point at the Policy and Charging Control (PCC)
architecture for non-roaming case with SPR
Figure A.3.3.2: S9a reference point at the Policy and Charging Control (PCC)
architecture for non-roaming case with UDR
The relationships between the different functional entities involved in the
home routed access for EPC-routed traffic are depicted in figure A.3.3.3 and
A.3.3.4.
Figure A.3.3.3: S9, S9a reference points at the PCC architecture for roaming
with home routed access with SPR
Figure A.3.3.4: S9, S9a reference points at the PCC architecture for roaming
with home routed access with UDR
The relationships between the different functional entities involved in the
visited access for EPC routed traffic are depicted in figure A.3.3.5 and
figure A.3.3.6.
Figure A.3.3.5: S9, S9a reference points at the PCC architecture for roaming
with visited access with SPR
Figure A.3.3.6: S9, S9a reference points at the PCC architecture for roaming
with visited access with UDR
The relationships between the different functional entities involved in the
non-roaming for NSWO traffic are depicted in figure A.3.3.7 and A.3.3.8.
Figure A.3.3.7: S9a reference points at the PCC architecture for non-roaming
with SPR
Figure A.3.3.8: S9a reference points at the PCC architecture for non-roaming
with UDR
The relationships between the different functional entities involved in the
roaming case for NSWO traffic are depicted in figure A.3.3.9 and A.3.3.10.
Figure A.3.3.9: S9, S9a reference points at the PCC architecture for roaming
with SPR
Figure A.3.3.10: S9, S9a reference points at the PCC architecture for roaming
with UDR
# A.4 Functional Elements
## A.4.0 PCRF
The PCRF functionality defined in subclause E.4.1 of 3GPP TS 29.212 [3] shall
apply. For the purpose of Fixed Broadband Access Interworking for EPC-routed
traffic the PCRF functionalities defined here are applicable:
\- Send the QoS rules to the BPCF over S9a to request admission control in the
fixed broadband access network.
\- Send to the BPCF the UE local IP address, UDP source port number if
available, ePDG IP Address used as IPSec tunnel endpoint with the UE and P-GW
IP address for the WLAN scenario to allow the Fixed Broadband Access network
to identify UE traffic.
\- Send to the BPCF the H(e)NB Local IP address and UDP source port number if
available for the H(e)NB scenario. This allows the Fixed Broadband Access
network to identify IP flows corresponding to the IPSec tunnel from the H(e)NB
to the SeGW which transports H(e)NB UE traffic.
\- Be able to be configured with the relation of IP address ranges to Fixed
Broadband Access network, to allow BPCF discovery.
For the NSWO scenario, the following PCRF functionalities are applicable:
\- Handle incoming request of S9a* session establishment.
\- Perform session binding of the AF session information received via Rx with
an existing S9a* session using the UE local IP address and the IMSI (if
available).
\- For the unsolicited application reporting, link the TDF session with an
existing S9a* session using the UE local IP address and PDN information if
available.
\- Send the PCC rules to the BPCF over S9a to allocated QoS resources in the
fixed broadband access network.
## A.4.1 V-PCRF
The V-PCRF functionality defined in subclause 4.3.2 shall apply. For the
purpose of Fixed Broadband Access Interworking for the EPC-routed traffic the
V‑PCRF functionalities defined here are applicable:
\- If an S9a Session Establishment request is received from the BPCF, the
V-PCRF shall initiate an S9 Session/Subsession Establishment procedure towards
the H-PCRF.
\- If an S9a Session Termination is received from the BPCF, the V-PCRF shall
initiate an S9 Session/Subsession Termination towards the H-PCRF.
\- For home routed roaming case, in case 1:
> \- If an S9 Session/Subsession Establishment trigger is received from the
> H-PCRF, then the V-PCRF shall initiate an S9a Session Establishment trigger
> towards the BPCF and an S9 Session/Subsession Establishment towards the
> H-PCRF.
\- For the WLAN scenario, if an S9 Session/Subsession Termination is received
from the H-PCRF, then the V-PCRF shall initiate an S9a Session Termination
procedure towards the BPCF.
\- For the H(e)NB scenario, if an S9 Session Termination is received from the
H-PCRF for the last UE connected to a H(e)NB local IP address and there is no
S15 session linked with the S9a session, then the V-PCRF shall initiate an S9a
Session Termination procedure towards the BPCF. Otherwise it shall initiate an
S9a Session Modification procedure.
\- If an S9 Session Modification is received from the H-PCRF, then the V-PCRF
shall trigger an S9a Session Establishment, Modification or Termination
towards the BPCF.
NOTE: For H(e)NB scenario, when the V-PCRF receives an S9 Session Modification
that corresponds to a change of the H(e)NB local IP address and there are no
more UEs connected to the previous H(e)NB the V-PCRF will terminate the S9a
session related to that H(e)NB address
\- For both home routed and visited access roaming cases, in case 2a, case 2b:
\- If a Gateway Control Session establishment from the BBERF (ePDG) occurs and
there is no S9a session established, then the V-PCRF shall initiate an S9a
session establishment with the BPCF and an S9 session establishment with the
H-PCRF.
\- If the last Gateway Control Session from the BBERF (ePDG) is terminated,
then the V-PCRF shall initiate an S9a Session Termination towards the BPCF and
an S9 Session Termination towards the H-PCRF.
\- For visited access roaming case, in case 1:
\- If an IP-CAN Session Establishment from the PCEF occurs and there is no S9a
session established, then the V-PCRF shall initiate an S9a session
establishment with the BPCF and an S9 session establishment with the H-PCRF.
\- For the WLAN scenario, if the last IP-CAN Session from the PCEF is
terminated, then the V-PCRF shall initiate an S9a Session Termination towards
the BPCF and an S9 Session Termination towards the H-PCRF.
\- For the H(e)NB scenario, if the last IP-CAN Session for the last UE
connected to a H(e)NB is terminated and there is no S15 session linked to the
S9a session, then the V-PCRF shall initiate an S9a Session Termination towards
the BPCF and an S9 Session Termination towards the H-PCRF. Otherwise, the
V-PCRF shall initiate an S9a Session Modification Request towards the BPCF.
For the NSWO scenario, the following V-PCRF functionalities are applicable:
\- For the roaming scenario, the V-PCRF shall handle incoming request of S9a*
session procedures;
\- If an S9a* Session Establishment request is received for a roaming user
over the S9a reference point, then the V‑PCRF shall conclude that the IP‑CAN
session is used for NSWO.
## A.4.2 H-PCRF
The H-PCRF functionality defined in subclause 4.3.1 shall apply. For the
purpose of Fixed Broadband Access interworking for the EPC-routed traffic, the
H‑PCRF functionalities defined here are applicable:
\- For case 1, if an IP-CAN Session Establishment is received over Gx then, if
this is the first IP-CAN session for this UE, the H-PCRF shall trigger an S9
Session Establishment to the V-PCRF.
\- For case 1, if an IP-CAN Session Termination is received over Gx then if
this is the last IP-CAN session for this UE, the H-PCRF shall initiate an S9
session Termination Request to the V-PCRF.
\- If PCC Rules are generated, the H-PCRF shall send QoS rules to the V-PCRF
to request admission control over S9.
\- If a PCEF-Initiated IP-CAN Session Modification Procedure occurs over Gx to
update the UE local IP Address and UDP port number for WLAN scenario, then the
H-PCRF shall initiate an S9 Session Modification procedure including these
data towards the V-PCRF.
\- If a PCEF-Initiated IP-CAN Session Modification Procedure occurs over Gx to
update the H(e)NB local IP Address and UDP port number for H(e)NB scenario,
then the H-PCRF shall check whether there is an S9 Session already established
for that subscriber based on H(e)NB local IP Address. If it is already
established, the H-PCRF shall link the Gx session to the S9 Session
corresponding to the H(e)NB local IP Address. Otherwise, H-PCRF shall initiate
an S9 Session Establishment procedure including these data towards the V-PCRF.
For the NSWO scenario, in case of roaming, the H-PCRF shall determine the
applicable PCC rules based on home operator policy for the specific UE when it
receives the S9 session establishment/modification request from V-PCRF with
the NSWO-APN.
## A.4.3 BPCF
The BPCF is the policy control entity in the Fixed Broadband Access network.
The complete specification of the BPCF is defined in BBF TR-134 [15] and BBF
TR-203 [14] and it is out of the scope of 3GPP.
For the purpose of interworking with 3GPP network for the EPC-routed traffic
the BPCF is expected to:
\- Perform admission control in fixed access or delegate admission control
decision to other BBF nodes. Based on the admission control, the BPCF accepts
or rejects the request received over S9a reference point. The BPCF may include
the acceptable QoS in the reply if the request is rejected.
\- Translate the 3GPP QoS rules as received over the S9a reference point into
access specific QoS parameters applicable in the Fixed Broadband access
network.
\- Support PCRF-triggered establishment of S9a session.
\- Support BPCF-initiated establishment of S9a session.
> NOTE: Admission control, QoS and IP-flow support in the Fixed Broadband
> Access Network are described in DSL TR-059 [17] and BBF TR-146 [16] and are
> out of the scope of 3GPP.
The functionality of the BPCF in a roaming scenario is the same as in a non-
roaming scenario.
For the NSWO traffic, the BPCF is expected to:
\- Perform admission control in fixed access or delegate admission control
decision to other BBF nodes. Based on the admission control, the BPCF accepts
or rejects the request received over S9a reference point. The BPCF may include
the acceptable QoS in the reply if the request is rejected.
\- Translate the 3GPP PCC rules as received over the S9a reference point into
access specific QoS parameters applicable in the Fixed Broadband access
network.
\- Support BPCF-initiated establishment, modification and termination of S9a*
session.
NOTE: Admission control, QoS and IP-flow support in the Fixed Broadband Access
Network are described in DSL TR-059 [17] and BBF TR-146 [16] and are out of
the scope of 3GPP.
The functionality of the BPCF in a roaming scenario is the same as in a non-
roaming scenario.
# A.5 PCC procedures over S9a Reference Point
## A.5.1 Session Establishment over S9a
### A.5.1.1 EPC-Routed traffic
#### A.5.1.1.1 S9a Session Establishment Trigger by PCRF
For GTP/PMIP-based S2b of the WLAN scenario, when PCRF or V-PCRF receives the
Gateway Control Session Establishment from the BBERF (ePDG) or IP-CAN session
establishment from the PCEF, (V-) PCRF shall trigger an S9a session
establishment procedure from the BPCF.
For trusted and untrusted S2c of the WLAN scenario, when PCRF or V-PCRF
receives the Gateway Control Session Establishment from the BBERF (ePDG) or
IP-CAN session establishment from the PCEF, (V-) PCRF determines if an S9a
session is already present for this user. If not, the (V-) PCRF shall trigger
an S9a session establishment procedure from the BPCF.
For case 1, when the UE is roaming with the home routed case and GTP-based S2b
is used, if the V-PCRF receives the S9 Session/Subsession Establishment
Trigger from the H-PCRF, the V-PCRF shall trigger S9a session establishment
procedure from the BPCF.
For case 2a, when the UE is roaming with the home routed case and trusted S2c
is used, if the V-PCRF receives the S9 Session Establishment Trigger from the
H-PCRF, the V-PCRF shall trigger S9a session establishment procedure from the
BPCF.
For H(e)NB scenario, when (V-)PCRF receives the Gateway Control Session
Establishment from the BBERF or IP-CAN session establishment from the PCEF, or
S15 Session Establishment from the HNB (for CS Support), (V-)PCRF determines
if an S9a session is already present for this H(e)NB Local IP Address. If not,
the V-PCRF shall trigger an S9a session establishment procedure from BPCF. For
case 1 when the UE is roaming with the home routed case and, the V-PCRF
receives the S9 Session/Subsession Establishment Trigger from the H-PCRF, the
V-PCRF determines if an S9a session is already present for that H(e)NB Local
IP Address. If an S9a session is not already established, the (V-) PCRF shall
trigger an S9a session establishment procedure from the BPCF. If an S9a
session is already established and the UE is connected to the network via the
H(e)NB, the (V-) PCRF shall update the S9a session with the QoS rules if they
were provided from the H-PCRF.
NOTE: Depending on the deployment there can be one or multiple H-PCRF(s) that
establish an S9 session for a given H(e)NB address. The V-PCRF can link more
than one S9 session to the same S9a session, i.e. upon reception of a TER
command, the V-PCRF can generate a RAR command when the S9a session exists.
Upon reception of a TER command or a RAR command, that does not include QoS
rules it is expected that the BPCF will generate a CCR command in order to ask
for the QoS rules related to that S9a session.
NOTE: How the BPCF relates S9a sessions received from different PCRFs.is out
of the scope of 3GPP.
The (V-) PCRF shall send a TER command to BPCF to trigger S9a session
establishment procedure. The (V-) PCRF shall include the Auth-Session-State
AVP set to NO_STATE_MAINTAINED. The (V-) PCRF may include its own address
within the PCRF-Address AVP.
For WLAN scenario the (V-) PCRF shall include the UE local IP address, within
the UE-Local-IP-Address AVP the UDP Source Port within the UDP-Source-Port AVP
if available, the PDN information within the Called-Station-ID AVP if
available and the IMSI within the Subscription-Id.
For the H(e)NB scenario the (V-) PCRF shall include H(e)NB Local IP address
within the HeNB-Local-IP-Address AVP, the UDP Source Port within the UDP-
Source-Port AVP if available and the PDN information within the Called-
Station-ID AVP if available.
The BPCF shall reply (V-) PCRF with a TEA command, and initiate the S9a
Session establishment procedure as described in clause A.5.1.1.2. PCRF
determines whether the S9a session triggered by the TER command has been
established based on the identification information (i.e. the UE Local IP
address and UDP Source Port if NA(P) T is detected for WLAN scenario or H(e)NB
Local IP address and UDP Source Port if NA(P)T is detected for the H(e)NB
scenario).
#### A.5.1.1.2 S9a Session Establishment
Upon request of an S9a Session Establishment Trigger by the (V-) PCRF, the
BPCF shall send a CCR command with the CC-Request-Type AVP set to the value
\"INITIAL_REQUEST\".
For WLAN scenario the BPCF shall include the UE local IP address within UE-
Local-IP-Address AVP, the UDP Source Port within UDP-Source-Port AVP, if
available, the PDN information within the Called-Station-ID AVP if available
and the IMSI within the Subscription-Id AVP.
For the H(e)NB scenario the BPCF shall include H(e)NB Local IP address within
HeNB-Local-IP-Address AVP, the UDP Source Port within UDP-Source-Port AVP, if
available and the PDN information within the Called-Station-ID AVP if
available.
For the roaming case, the V-PCRF shall initiate the S9 Session Establishment
procedure according to clause A.6.1.1.2.
To acknowledge the CCR command initiated by the BPCF, the (V-) PCRF shall send
a CCA command including the result code within Result-Code AVP. The (V-) PCRF
provides the QoS-Rule-Install AVP to include the applicable QoS Rules and, if
available, the ePDG IP address derived from the ePDG IP address IE as defined
in subclause 7.2.1 of 3GPP TS 29.274 [22] (for GTP-based S2b acces) or used as
the IPSec tunnel endpoint with the UE (for untrusted S2c access) within AN-GW-
Address AVP or, if available, the PDN GW IP address (for trusted S2c access)
used as the endpoint of the DSMIPv6 IPv4 user plane tunnel with the UE within
3GPP-GGSN-Address AVP (IPv4 address) or used as the endpoint of the DSMIPv6
IPv6 user plane tunnel with the UE within the 3GPP-GGSN-IPv6-Address AVP (IPv6
address).
### A.5.1.2 NSWO traffic
#### A.5.1.2.1 S9a* Session Establishment
For NSWO scenario, when the BPCF receives the trigger that a UE is accessing
over Fixed Broadband access network and policy interworking with PCRF is
supported, the BPCF shall send a CCR command with the CC-Request-Type AVP set
to the value \"INITIAL_REQUEST\".
The BPCF shall include the local UE IP address within UE-Local-IP-Address AVP
or UE-Local-IPv6-Prefix AVP, the NSWO-APN within Called-Station-Id AVP and the
IMSI within the Subscription-Id AVP.
The PCRF shall check if the policy control is performed for NSWO traffic for
that UE based on operator policies (e.g. network where the UE is offloading).
The PCRF shall provide the result in a CCA command within Result-Code AVP. If
policy control is not performed, then the PCRF shall indicate
DIAMETER_AUTHORIZATION_REJECTED in the CCA command.
## A.5.2 Session Termination over S9a
### A.5.2.1 EPC-Routed Traffic
#### A.5.2.1.1 S9a Session Termination initiated by the (V-) PCRF
This procedure is performed when the (V-) PCRF knows that the 3GPP UE released
the last PDN connection and request the BPCF to release the S9a session for
the WLAN scenario and for the H(e)NB scenario. This occurs in the following
cases:
\- When the (V-) PCRF receives a Gateway Control Session Termination from the
BBERF that corresponds to the last Gxx session linked to the S9a session.
NOTE: BBERF refers to both ePDG and S-GW.
\- For the WLAN scenario, when the PCRF receives an IP-CAN session termination
from the PCEF or decides to terminate the IP-CAN session that corresponds to
the last active IP-CAN session.
For the H(e)NB scenario, when the PCRF receives an IP-CAN session termination
from the PCEF or decides to terminate the IP-CAN session that corresponds to
the last active IP-CAN session for the last subscriber connected to the H(e)NB
and there is no S15 session linked to the S9a session.
\- For the H(e)NB scenario, when the ( V-)PCRF receives an S15 Session
Termination that corresponds to a H(e)NB address for which an S9a session
exists.
\- For the roaming case in WLAN scenario, when the V-PCRF receives an S9
Session/Subsession Termination initiated by the H-PCRF.
\- For the roaming case in H(e)NB scenario, when the V-PCRF receives an S9
Session Termination that corresponds to the last UE connected to that H(e)NB.
\- For the roaming case in H(e)NB scenario, when the V-PCRF receives an S9
Session Modification that corresponds to a change of the H(e)NB local IP
address and there are no more UEs connected to the previous H(e)NB.
NOTE: In this case the V-PCRF will initiate a new S9a Session Establishment if
there is no S9a Session related to the new H(e)NB local IP address.
The PCRF shall send an RAR command including the Session-Release-Cause AVP to
the BPCF. When the BPC Freceives the RAR command, it shall acknowledge the
command by sending an RAA command to the PCRF.
The BPCF shall send a CCR command with the CC-Request-Type AVP set to the
value \"TERMINATION_REQUEST\".
To acknowledge the CCR command, the (V-) PCRF shall send a CCA command
including the result code within Result-Code AVP.
### A.5.2.2 NSWO Traffic
#### A.5.2.2.1 S9a* Session Termination initiated by the BPCF
This procedure is initiated by the BPCF to terminate an S9a* session when the
BPCF knows that the 3GPP UE is no longer attached via Fixed Broadband access
network.
The BPCF shall send a CCR command with the CC-Request-Type AVP set to the
value \"TERMINATION_REQUEST\".
To acknowledge the CCR command, the (V-) PCRF shall send a CCA command
including the result code within Result-Code AVP.
#### A.5.2.2.2 S9a* Session Termination initiated by the (V-) PCRF
If the PCRF decides to terminate the S9a* session due to an internal trigger
or trigger from the SPR, the PCRF shall send an RAR command including the
Session-Release-Cause AVP to the BPCF. The BPCF shall acknowledge the command
by sending an RAA command to the PCRF.
The BPCF shall send a CCR command with the CC-Request-Type AVP set to the
value \"TERMINATION_REQUEST\".
To acknowledge the CCR command, the (V-) PCRF shall send a CCA command
including the result code within Result-Code AVP.
## A.5.3 Session Modification over S9a
### A.5.3.1 EPC-Routed traffic
#### A.5.3.1.1 S9a Session Modification initiated by the (V-) PCRF
The (V-) PCRF may initiate an S9a Session Modification by sending a RAR
command to the BPCF in the following conditions.
\- For WLAN scenario in the non-roaming case, solicited by the BBERF/PCEF when
the Local IP Address and or UDP port is changed or
  * For H(e)NB scenario for CS services, solicited by the HNB GW, when the (V-) PCRF receives an S15 Session Modification or
\- For both WLAN scenario and H(e)NB scenario in the non-roaming case, the
PCRF decides to update the QoS information to the BPCF (e.g. subscription
change, AF requests, etc) or
\- When the (V-) PCRF receives a Gateway Control Session Termination from the
BBERF (ePDG) that does not correspond to the last Gxx session linked to the
S9a session or
\- When the PCRF receives an IP-CAN session termination from the PCEF or
decides to terminate the IP-CAN session and it does not corresponds to the
last active IP-CAN session linked to that S9a session or
\- For the H(e)NB scenario, when the PCRF receives an IP-CAN session
termination from the PCEF or decides to terminate the IP-CAN session that
corresponds to the last active IP-CAN session for the last subscriber
connected to the H(e)NB and there is an active S15 session linked to the S9a
session. or
\- For WLAN scenario in the roaming case, the H-PCRF initiates an S9 Session
Modification procedure or
\- For H(e)NB scenario in the roaming case, the H-PCRF initiates an S9 Session
Establishment and there is an S9a session already created for that H(e)NB or
\- For H(e)NB scenario in the roaming case, the H-PCRF initiates an S9
SessionTermination procedure and there are more UEs already connected to the
network via the related H(e)NB or there is an S15 session active for that
H(e)NB.
NOTE: For H(e)NB scenario, the V-PCRF will not initiate an S9a Session
Modification upon reception of an S9 Session Modification if only the HeNB-
Local-IP-Address AVP and/or UDP-Source-Port AVP is changed.
NOTE: For H(e)NB scenario, the V-PCRF will initiate an S9a Session
Modification upon reception of an S9 Session Establishment Trigger if there is
an existing S9a session already established for that H(e)NB address.
The (V-) PCRF may provide the local UE IP Address within UE-Local-IP-Address
AVP (WLAN scenario) or the H(e)NB Local IP address within HeNB-Local-IP-
Address AVP (H(e)NB scenario), the UDP source port within UDP-Source-Port AVP
and corresponding event triggers, if available by including the Event-Report-
Indication AVP in the RAR command. If the QoS information needs to be updated
to the BPCF, the PCRF shall include QoS-Rule-Install AVP and/or QoS-Rule-
Remove AVP.
The BPCF shall perform QoS validation and shall include the result of the
procedure in the RAA command in a Result-Code or Experimental-Result-Code AVP.
#### A.5.3.1.2 S9a Session Modification initiated by the BPCF
The BPCF may initiate an S9a Session Modification by sending a CCR command in
order to indicate a QoS Rule failure (e.g. release of resources) to the (V-)
PCRF.
The CCR shall include the QoS-Rule-Report AVP indicating the QoS rules that
were not accepted and the Rule-Failure-Code AVP indicating the failure cause
at command level.
The (V-) PCRF shall include the result of the procedure in the CCA command.
### A.5.3.2 NSWO traffic
#### A.5.3.2.1 S9a* Session Modification initiated by the (V-) PCRF
The (V-) PCRF may initiate an S9a* Session Modification by sending a RAR
command to the BPCF in the following conditions:
  * The (H-) PCRF decides to update the policy information to the BPCF based on operator policies, subscription change or an AF request or
  * The (V-) PCRF decides to update the policy information to the BPCF based on a TDF request.
The (V-) PCRF may include in the RAR command the Charging-Rule-Install AVP
and/or Charging-Rule-Remove AVP.
The BPCF shall perform QoS validation and shall include the result of the
procedure in the RAA command in a Result-Code or Experimental-Result-Code AVP.
#### A.5.3.2.2 S9a* Session Modification initiated by the BPCF
The BPCF may initiate an S9a* Session Modification by sending a CCR command in
order to indicate a PCC Rule failure (e.g. release of resources) to the (V-)
PCRF.
The CCR shall include the Charging-Rule-Report AVP indicating the PCC rules
that were not accepted and the Rule-Failure-Code AVP indicating the failure
cause at command level.
The (V-) PCRF shall include the result of the procedure in the CCA command,
## A.5.4 Handling of QoS information
### A.5.4.1 EPC-routed traffic
When the (V-) PCRF provides QoS rules in a CCA/RAR command to the BPCF, and if
the Fixed Broadband access network cannot accept the QoS required for the QoS
rules, the BPCF includes the QoS-Rule-Report AVP to indicate the QoS Rules
that were not accepted including Rule-Failure-Code AVP set to
UNSUCCESSFUL_QOS_VALIDATION value and may additionally provide the acceptable
QoS to the (V-) PCRF in the CCR/RAA command.
The BPCF shall include the DIAMETER_PCC_RULE_EVENT (5142) experimental result
code, the QoS-Rule-Report AVP to indicate the QoS Rules that were not
accepted, including Rule-Failure-Code AVP set to UNSUCCESSFUL_QOS_VALIDATION
value. The BPCF may also include the QoS-Information AVP to indicate the
acceptable QoS.
### A.5.4.2 NSWO traffic
When the (V-) PCRF provides PCC rules in a CCA/RAR command to the BPCF, and if
the Fixed Broadband access network cannot accept the QoS required for the PCC
rules, the BPCF includes the Charging -Rule-Report AVP to indicate the PCC
Rules that were not accepted including Rule-Failure-Code AVP set to
UNSUCCESSFUL_QOS_VALIDATION value and may additionally provide the acceptable
QoS to the (V-) PCRF in the CCR/RAA command.
The BPCF shall include the DIAMETER_PCC_RULE_EVENT (5142) experimental result
code, the Charging-Rule-Report AVP to indicate the PCC Rules that were not
accepted, including Rule-Failure-Code AVP set to UNSUCCESSFUL_QOS_VALIDATION
value. The BPCF may also include the QoS-Information AVP to indicate the
acceptable QoS.
# A.6 PCC procedures over S9 Reference Point
## A.6.1 Session Establishment over S9
### A.6.1.1 EPC-Routed Traffic
#### A.6.1.1.1 S9 Session Establishment Triggered by H-PCRF
When the H-PCRF receives an IP-CAN Session establishment from the PCEF
including either the H(e)NB-Local-IP-Address AVP or UE-Local-IP-Address AVP
and the user is roaming in a Visited Network, the H-PCRF determines if an S9
session exists for this IP-CAN session. If the S9 session is not already
established, the H-PCRF shall trigger an S9 session establishment procedure
from the V-PCRF.
The H-PCRF shall send a TER command to V-PCRF to trigger the S9 session
establishment procedure. The H-PCRF shall include in the TER command the IMSI
within the Subscription-Id AVP, the UDP port within UDP-Source-Port AVP if
available and the PDN information within the Called-Station-ID AVP if
available. The H-PCRF shall include the Auth-Session-State AVP set to
NO_STATE_MAINTAINED.
For WLAN scenario, the H-PCRF shall also include the UE local IP address
within the UE-Local-IP-Address AVP.
For H(e)NB scenario, the H-PCRF shall also include the H(e)NB Local IP address
within the HeNB-Local-IP-Address AVP.
The V-PCRF shall reply the H-PCRF with a TEA command, and initiate the S9a
Session establishment procedure as described in subclause A,5,1.1 (when no S9a
session exists) or the S9a Session modification procedure as described in
subclause A.5.3.1.1 (when there already exists an S9a session) .
When the V-PCRF receives a TER command from the H-PCRF to trigger an S9
session establishment procedure for the EPC-routed traffic for a user, if the
V-PCRF determines that the S9 session is being established for the NSWO
traffic for the user by the V-PCRF, the V-PCRF.shall send a TEA command
including the Experimental-Result AVP with the Experimental-Result. Code AVP
set to DIAMETER_ERROR_ONGOING_SESSION_ESTABLISHMENT (5471) to the H-PCRF. When
the H-PCRF receives this error, it shall send a RAR command to V-PCRF to
trigger an S9 subsession establishment procedure after the S9 session of the
user is established as defined in subclause A.6.3.1.0.
#### A.6.1.1.2 S9 Session Establishment
When the V-PCRF receives one of the following triggers
\- a Gateway Control Session Establishment from the BBERF (ePDG) with UE Local
IP address
\- an IP-CAN Session Establishment from the PCEF with UE Local IP address
\- a Gateway Control Session Establishment from the BBERF(S-GW) with H(e)NB IP
address
\- an IP-CAN Session Establishment from the PCEF with H(e)NB IP address
\- an S9a Session Establishment from the BPCF
then the V-PCRF determines if an S9 session is already present for that
subscriber. If the S9 session is not already established, the V-PCRF initiates
an S9 Session Establishment Procedure. Otherwise, it initiates an S9
Subsession Establishment Procedure as described in subclause A.6.3.1.2.
The V-PCRF shall send a CCR command following current S9 procedures including
the information received over Gx, Gxx or S9a.
If the procedure is initiated by the BPCF the V-PCRF shall map the S9a
session-id to the corresponding S9 session-id. If the procedure is initiated
by the BBERF/PCEF, the V-PCRF shall map the Gxx/Gx session-id to the
corresponding S9 session-id (case 2a) or S9 subsession-id (case 1 and case
2b).
If the procedure is initiated by the BBERF or PCEF, the V-PCRF shall initiate
the S9a session establishment trigger procedures as described in subclause
A.5.1.1.1 and keep the mapping between the S9a session-id and the S9 session-
id (case 2a) or S9 subsession-id (case 2b and H(e)NB scenario).
To acknowledge the CCR command, the H-PCRF shall send a CCA command including
the result code within Result-Code AVP. The H-PCRF provides the QoS-Rule-
Install AVP to include the applicable QoS Rules and, if available, the ePDG IP
address derived from the ePDG IP address IE as defined in subclause 7.2.1 of
3GPP TS 29.274 [22] (for S2b access) or used as the IPSec tunnel endpoint with
the UE (for untrusted S2c access) within AN-GW-Address AVP or, if available,
the PDN GW IP address (for trusted S2c access) within 3GPP-GGSN-Address AVP
used as the endpoint of the DSMIPv6 IPv4 user plane tunnel with the UE (IPv4
address) or used as the endpoint of the DSMIPv6 IPv6 user plane tunnel with
the UE within the 3GPP-GGSN-IPv6-Address AVP (IPv6 address).
### A.6.1.2 NSWO Traffic
When the V-PCRF receives an S9a* Session Establishment from the BPCF, then the
V-PCRF determines if an S9 session is already present for that subscriber. If
the S9 session is not already established, the V-PCRF initiates an S9 Session
Establishment Procedure in order to establish an S9 subsession below;
otherwise, the V-PCRF initiates an S9 Session Modification Procedure as
described in subclause A.6.3.2.2.
The V-PCRF shall send a CCR command following current S9 session establishment
procedures including the information received over S9a reference point.
The V-PCRF shall map the S9a* session to the corresponding S9 subsession.
The H-PCRF shall acknowledge the request using a CCA command.
## A.6.2 Session Termination over S9
### A.6.2.1 EPC-Routed traffic
#### A.6.2.1.1 S9 Session Termination initiated by the H-PCRF
This procedure is initiated by the H-PCRF to terminate an S9 session when the
last IP-CAN session related to a subscriber is terminated. The procedure
described in subclause 4.5.2.4 shall apply. The V-PCRF shall apply the
corresponding S9a session procedure according to subclause A.5.
The V-PCRF shall send a CCR command with the CC-Request-Type AVP set to the
value \"TERMINATION_REQUEST\".
To acknowledge the CCR command, the H-PCRF shall send a CCA command including
the result code within Result-Code AVP.
#### A.6.2.1.2 S9 Session Termination initiated by the V-PCRF
This procedure is initiated by the V-PCRF to terminate an S9 session when the
V-PCRF receives a Gateway Control Session Termination from the BBERF
corresponding to the last PDN connection related to a subscriber. The
procedure described in subclause 4.5.2.3 shall apply. The V-PCRF shall
initiate the corresponding S9a session procedure as described in subclause
A.5.
The V-PCRF shall send a CCR command with the CC-Request-Type AVP set to the
value \"TERMINATION_REQUEST\".
To acknowledge the CCR command, the H-PCRF shall send a CCA command including
the result code within Result-Code AVP.
### A.6.2.2 NSWO Traffic
#### A.6.2.2.1 S9 Session Termination initiated by the V-PCRF
This procedure is initiated by the V-PCRF to terminate an S9 session when the
V-PCRF receives an S9a* Session Termination procedure from the BPCF and it
corresponds to the last S9 subsession for the roaming user.
The V-PCRF shall send a CCR command with the CC-Request-Type AVP set to the
value \"TERMINATION_REQUEST\".
To acknowledge the CCR command, the H-PCRF shall send a CCA command including
the result code within Result-Code AVP.
#### A.6.2.2.2 S9 Session Termination initiated by the H-PCRF
If the H-PCRF decides to terminate the IP-CAN session for the NSWO traffic due
to an internal trigger or trigger from the SPR, and if the H-PCRF considers
that the S9 session has to be terminated, the H-PCRF shall send an RAR command
to the V-PCRF indicating the termination of the S9 session by including the
Session-Release-Cause AVP at command level. The V-PCRF shall send a
corresponding RAA command to the H-PCRF.
The V-PCRF shall trigger S9a* Session Termination procedure as defined in
subclause A.5.2.2.2.
## A.6.3 Session Modification over S9
### A.6.3.1 EPC-Routed traffic
#### A.6.3.1.0 S9 subsession establishment triggered by H-PCRF
When the H-PCRF receives an IP-CAN Session establishment from the PCEF
including either the H(e)NB-Local-IP-Address AVP or UE-Local-IP-Address AVP
and the user is roaming in a Visited Network, the H-PCRF determines if an S9
session exists for this IP-CAN session. If the S9 session is not established,
the S9 session establishment procedure as described in subclause A.6.1.1.1
applies. If the S9 session is already established, the H-PCRF shall trigger an
S9 subsession establishment procedure from the V-PCRF.
The H-PCRF shall send a RAR command to V-PCRF to trigger the S9 subsession
establishment procedure. The H-PCRF shall include in the RAR command the IMSI
within the Subscription-Id AVP, the PDN information within the Called-Station-
ID AVP if available and the UDP port within UDP-Source-Port AVP if available.
For WLAN scenario, the H-PCRF shall also include the UE local IP address
within the UE-Local-IP-Address AVP.
For H(e)NB scenario, the H-PCRF shall also include the H(e)NB Local IP address
within the HeNB-Local-IP-Address AVP.
The V-PCRF shall reply the H-PCRF with a RAA command, and initiate the S9a
Session establishment procedure as described in subclause A,5,1.1 (when no S9a
session exists) or the S9a Session modification procedure as described in
subclause A.5.3.1.1 (when there already exists an S9a session).
#### A.6.3.1.1 S9 Session Modification initiated by the H-PCRF
The H-PCRF may initiate an S9 Session Modification by sending a RAR command in
the following cases:
\- An IP-CAN Session Modification is triggered by the PCEF
\- In response to information provided to the H-PCRF via the Rx reference
point
\- From a trigger from the SPR
\- Based on internal policies
  * An IP-CAN Session Establishment. In this case, the procedure described in subclause A.6.3.1.0 applies.
The H-PCRF may provide the local UE IP Address (WLAN scenario), the H(e)NB
Local IP address (H(e)NB scenario), the UDP port and corresponding event
triggers, if provided by the PCEF by including the Event-Report-Indication AVP
within the Subsession-Decision-Info AVP (case 1) when this information has
changed in the RAR command.
If the QoS information is changed, the H-PCRF may include QoS rules within the
QoS-Rule-Install AVP at command level (case 2a) or within the Subsession-
Decision-Info AVP (case 1, case 2b).
The V-PCRF shall initiate the corresponding S9a session procedure according to
subclause A.5.
When the RAR command includes QoS rules, the V-PCRF shall validate the QoS
information contained within the QoS rules using the current procedures.
#### A.6.3.1.2 S9 Session Modification initiated by the V-PCRF
When the V-PCRF receives one of the following triggers:
\- an S9a Session Establishment from the BPCF.
\- an S9a Session Modification from the BPCF (e.g. when the BBF network cannot
sustain the allocated bandwidth) according to subclause A.5.3.1.2
\- a Gateway Control Session Establishment from the BBERF (case 2b, case 2a)
and there is an S9 Session established
\- a Gateway Control Session Modification from the BBERF (case 2b, case 2a)
\- a Gateway Control Session Termination from the BBERF that does not
correspond to the last S9 subsession (applicable only to WLAN, case 2b)
NOTE: In the above scenarios, BBERF refers to both ePDG and SGW.
\- an IP-CAN Session Establishment from the PCEF and there is an S9 session
established
\- an IP-CAN Session Modification from the PCEF
\- an IP-CAN Session Termination from the PCEF that does not correspond to the
last S9 subsession
then the V-PCRF shall send a CCR command following current S9 procedures
including the information received over Gx, Gxx or S9a.
NOTE: For H(e)NB scenario, when the S9 Session Modification is generated by
the BPCF, the V-PCRF modifies all the S9 sessions affected by the S9a session
modification.
### A.6.3.2 NSWO traffic
#### A.6.3.2.1 S9 Session Modification initiated by the H-PCRF
Solicited in response to information provided to the H-PCRF via the Rx
reference point or from a trigger from the SPR or based on internal policies,
the H-PCRF may initiate an S9 Session Modification procedure by sending a RAR
command.
If the H-PCRF considers that the S9 subsession has to be terminated, the
H-PCRF shall send an RAR command to the V-PCRF indicating the termination of
the S9 subsession by including the Session-Release-Cause AVP within the
Subsession-Decision-Info AVP.
If the QoS information is changed, the H-PCRF may install or modify PCC rules
by including the Charging-Rule-Install AVP or remove the PCC rules by
including the Charging-Rule-Remove AVP within the Subsession-Decision-Info
AVP.
#### A.6.3.2.2 S9 Session Modification initiated by the V-PCRF
The V-PCRF initiates an S9 session modification by sending a CCR command
following the current S9 session modification procedures including the
information received over S9a reference point in the following cases:
\- the V-PCRF receives an S9a* Session Establishment from the BPCF as
described in subclause A.5.1.2.1 and an existing S9 session for the roaming
user already exists with the H-PCRF
\- the V-PCRF receives an S9a* Session Modification from the BPCF (e.g. when
the BBF network cannot sustain the allocated bandwidth) according to subclause
A.5.3.2.2
\- the V-PCRF receives an S9a* Session Termination from the BPCF as described
in subclause A.5.2.2.1 and it does not correspond to the last S9 subsession
## A.6.4 Provisioning and validation of QoS information
### A.6.4.1 EPC-Routed traffic
When the H-PCRF provides QoS rules to the V-PCRF and the V-PCRF cannot accept
the QoS required for the QoS rules, the V-PCRF includes the QoS-Rule-Report
AVP to indicate the QoS Rules that were not accepted including Rule-Failure-
Code AVP set to UNSUCCESSFUL_QOS_VALIDATION value and may additionally propose
the acceptable QoS to the H-PCRF as per normal S9 procedures.
### A.6.4.2 NSWO traffic
When the H-PCRF provides PCC rules to the V-PCRF and the V-PCRF cannot accept
the QoS required for the PCC rules, the V-PCRF includes the Charging -Rule-
Report AVP to indicate the PCC Rules that were not accepted including Rule-
Failure-Code AVP set to UNSUCCESSFUL_QOS_VALIDATION value and may additionally
propose the acceptable QoS to the H-PCRF as per normal S9 procedures.
# A.7 S9a Protocol
## A.7.1 Protocol support
The S9a application is defined as a vendor specific Diameter application,
where the vendor is 3GPP and the Application-ID for the S9a Application in the
present release is 16777319. The vendor identifier assigned by IANA to 3GPP
(http://www.iana.org/assignments/enterprise-numbers) is 10415.
NOTE: A route entry can have a different destination based on the application
identification AVP of the message. Therefore, Diameter agents (relay, proxy,
redirection, translation agents) must be configured appropriately to identify
the 3GPP S9a application within the Auth-Application-Id AVP in order to create
suitable routeing tables.
Due to the definition of the commands used in the S9a protocol, there is no
possibility to skip the Auth-Application-Id AVP and use the Vendor-Specific-
Application-Id AVP instead. Therefore the S9a application identification shall
be included in the Auth-Application-Id AVP.
## A.7.2 Initialization, maintenance and termination of connection and session
The initialization and maintenance of the connection between each
BPCF/(V-)PCRF pair is defined by the underlying protocol. Establishment and
maintenance of connections between Diameter nodes is described in IETF RFC
3588 [6].
After establishing the transport connection, the BPCF and the (V-)PCRF shall
advertise the support of the S9a specific Application by including the value
of the application identifier in the Auth-Application-Id AVP and the value of
the 3GPP (10415) in the Vendor-Id AVP of the Vendor-Specific-Application-Id
AVP contained in the Capabilities‑Exchange-Request and Capabilities-Exchange-
Answer commands. The Capabilities-Exchange-Request and Capabilities-Exchange-
Answer commands are specified in the Diameter base protocol (IETF RFC 3588
[6]).
The termination of the Diameter S9a session over S9a reference point can be
initiated by the (V-)PCRF, as specified in subclause A.5.2.1.1.
## A.7.3 S9a specific AVPs
### A.7.3.1 General
Table A.7.3.1.1 describes the Diameter AVPs defined for the S9a Diameter
application over S9a reference point, their AVP Code values, types, possible
flag values, whether or not the AVP may be encrypted, what access types (e.g.
3GPP-GPRS, etc.) the AVP is applicable to, the applicability of the AVPs to
charging control, policy control or both, and which supported features the AVP
is applicable to. The Vendor-Id header of all AVPs defined in the present
document shall be set to 3GPP (10415).
Table A.7.3.1.1: S9a specific Diameter AVPs
|  |  |  | AVP Flag rules (NOTE 1) |  |  |  |  |  |   
---|---|---|---|---|---|---|---|---|---|---  
Attribute Name | AVP Code | Clause defined | Value Type (NOTE 2) | Must | May | Should not | Must not | May Encr. | Acc. type (NOTE 3) | Applicability  
PCRF-Address | 2207 | A.7.3.1.1 | DiameterIdentity | V,M | P |  |  | Y |  | PC EPC-routed  
NOTE 1: The AVP header bit denoted as 'M', indicates whether support of the AVP is required. The AVP header bit denoted as 'V', indicates whether the optional Vendor-ID field is present in the AVP header. For further details, see IETF RFC 3588 [6]. NOTE 2: The value types are defined in IETF RFC 3588 [6]. NOTE 3: S9a protocol applies only when the UE is making use of a fixed broadband access network. |  |  |  |  |  |  |  |  |  |   
#### A.7.3.1.1 PCRF-Address
The PCRF-Address AVP (AVP code 2207) is of type DiameterIdentity and is used
by the (V)-PCRF to indicate its own address in the TER command so that the
BPCF can address the (V)-PCRF during the S9a session establishment procedure.
NOTE: The value in the Origin-Host AVP of the TER command can be replaced by
the proxy agent between the (V)-PCRF and the BPCF.
## A.7.4 S9a re-used AVPs
### A.7.4.1 General
Table A.7.4.1.1 lists the Diameter AVPs re-used by the S9a reference point
from other reference points (e.g. Gx, Gxx, S9 reference points) and other
existing Diameter Applications, reference to their respective specifications,
short description of their usage within the S9a reference point, the
applicability of the AVPs to a specific access, and which supported features
the AVP is applicable to. When reused from S9 reference point, the specific
clause in the present specification is referred. Other AVPs from existing
Diameter Applications, except for the AVPs from Diameter base protocol, do not
need to be supported. The AVPs from Diameter base protocol are not included in
table A.7.4.1.1, but they are re-used for the S9a reference point. Unless
otherwise stated, re-used AVPs shall maintain their \'M\', \'P\' and \'V\'
flag settings. Where RADIUS VSAs are re-used, unless otherwise stated, they
shall be translated to Diameter AVPs as described in IETF RFC 4005 with the
exception that the 'M' flag shall be set and the 'P' flag may be set.
Table A.7.4.1.1: S9a re-used Diameter AVPs
+-------------+-------------+-------------+-------------+-------------+ | Attribute | Reference | Description | Acc. type | Ap | | Name | | | | plicability | | | | | | | | | | | | Note 1 | +-------------+-------------+-------------+-------------+-------------+ | Called | IETF | The address | N | PC | | -Station-Id | RFC 4005 | the user is | on-3GPP-EPS | | | | | connected | | | | | | to in the | 3GPP-EPS | | | | | 3GPP | | | | | | network | | | | | | (i.e. the | | | | | | PDN | | | | | | i | | | | | | dentifier). | | | +-------------+-------------+-------------+-------------+-------------+ | CC-Req | IETF RFC | The number | N | PC | | uest-Number | 4006 [9] | of the | on-3GPP-EPS | | | | | request for | | | | | | mapping | 3GPP-EPS | | | | | requests | | | | | | and answers | | | +-------------+-------------+-------------+-------------+-------------+ | CC-R | IETF RFC | The type of | N | PC | | equest-Type | 4006 [9] | the request | on-3GPP-EPS | | | | | (initial, | | | | | | update, | 3GPP-EPS | | | | | t | | | | | | ermination) | | | +-------------+-------------+-------------+-------------+-------------+ | E | 3GPP | When sent | N | PC | | vent-Report | TS 2 | from the | on-3GPP-EPS | | | -Indication | 9.212 [3] | PCRF to the | | | | | | BPCF, it is | 3GPP-EPS | | | | | used to | | | | | | report an | (NOTE x) | | | | | event | | | | | | coming from | | | | | | the PCEF or | | | | | | BBERF and | | | | | | the | | | | | | relevant | | | | | | info to the | | | | | | BPCF. | | | | | | | | | | | | The | | | | | | following | | | | | | values for | | | | | | the | | | | | | included | | | | | | Ev | | | | | | ent-Trigger | | | | | | are | | | | | | applicable: | | | | | | UE_LOCA | | | | | | L_IP_ADDR | | | | | | ESS_CHANGE | | | | | | (43), | | | | | | H | | | | | | (E)NB_LOCA | | | | | | L_IP_ADDR | | | | | | ESS_CHANGE | | | | | | (44). | | | | | | | | | | | | The | | | | | | following | | | | | | AVPs which | | | | | | are | | | | | | included in | | | | | | E | | | | | | vent-Report | | | | | | -Indication | | | | | | are | | | | | | ap | | | | | | plicable to | | | | | | S9a | | | | | | interface: | | | | | | | | | | | | UE-Local- | | | | | | IP-Address, | | | | | | HeNB-Local | | | | | | -IP-Address | | | | | | and | | | | | | UDP-S | | | | | | ource-Port. | | | | | | | | | | | | BPCF does | | | | | | not | | | | | | subscribe | | | | | | the | | | | | | n | | | | | | otification | | | | | | of | | | | | | following | | | | | | event | | | | | | trigger | | | | | | values: | | | | | | UE_LOCAL | | | | | | _IP_ADDRE | | | | | | SS_CHANGE, | | | | | | H( | | | | | | E)NB_LOCAL | | | | | | _IP_ADDRE | | | | | | SS_CHANGE. | | | +-------------+-------------+-------------+-------------+-------------+ | QoS- | 3GPP | Defines the | N | PC | | Information | TS 2 | QoS | on-3GPP-EPS | | | | 9.212 [3] | information | | | | | | that can be | | | | | | accepted by | | | | | | the BPCF. | | | +-------------+-------------+-------------+-------------+-------------+ | QoS-R | 3GPP | It is used | N | PC | | ule-Install | TS 2 | to | on-3GPP-EPS | | | | 9.212 [3] | activate, | | | | | | install or | 3GPP-EPS | | | | | modify QoS | | | | | | rules as | | | | | | instructed | | | | | | from the | | | | | | PCRF to the | | | | | | BPCF. Only | | | | | | QoS-Rule- | | | | | | Definition, | | | | | | QoS | | | | | | -Rule-Name, | | | | | | QoS-Rul | | | | | | e-Base-Name | | | | | | , | | | | | | 3GPP-GG | | | | | | SN-Address, | | | | | | 3 | | | | | | GPP-GGSN-IP | | | | | | v6-Address, | | | | | | AN | | | | | | -GW-Address | | | | | | and | | | | | | UDP- | | | | | | Source-Port | | | | | | are | | | | | | applicable. | | | +-------------+-------------+-------------+-------------+-------------+ | QoS- | 3GPP | It is used | N | PC | | Rule-Remove | TS 2 | to | on-3GPP-EPS | | | | 9.212 [3] | deactivate | | | | | | or remove | 3GPP-EPS | | | | | QoS rules | | | | | | in the | | | | | | BPCF. | | | +-------------+-------------+-------------+-------------+-------------+ | QoS- | 3GPP | It is used | N | PC | | Rule-Report | TS 2 | to report | on-3GPP-EPS | | | | 9.212 [3] | the status | | | | | | of the QoS | 3GPP-EPS | | | | | Rules. | | | +-------------+-------------+-------------+-------------+-------------+ | Session-Re | 3GPP | Indicate | N | PC | | lease-Cause | TS 2 | the reason | on-3GPP-EPS | | | | 9.212 [3] | of | | | | | | termination | 3GPP-EPS | | | | | initiated | | | | | | by the | | | | | | PCRF. | | | +-------------+-------------+-------------+-------------+-------------+ | Subs | IETF RFC | The | N | PC | | cription-Id | 4006 [9] | ide | on-3GPP-EPS | | | | | ntification | | | | | | of the | | | | | | s | | | | | | ubscription | | | | | | (i.e. IMSI) | | | +-------------+-------------+-------------+-------------+-------------+ | Support | 3GPP | If present, | N | PC | | ed-Features | TS 2 | this AVP | on-3GPP-EPS | | | | 9.229 [7] | informs the | | | | | | destination | 3GPP-EPS | | | | | host about | | | | | | the | | | | | | features | | | | | | that the | | | | | | origin host | | | | | | requires to | | | | | | s | | | | | | uccessfully | | | | | | complete | | | | | | this | | | | | | command | | | | | | exchange | | | +-------------+-------------+-------------+-------------+-------------+ | HeNB-Local | 3GPP | Contains | 3GPP-EPS | PC | | -IP-Address | TS 2 | the H(e)NB | | | | | 9.212 [3] | local IP | | | | | | address | | | +-------------+-------------+-------------+-------------+-------------+ | UE-Local | 3GPP | Contains | N | PC | | -IP-Address | TS 2 | the UE | on-3GPP-EPS | | | | 9.212 [3] | local IP | | | | | | address | | | +-------------+-------------+-------------+-------------+-------------+ | UDP- | 3GPP | Contains | N | PC | | Source-Port | TS 2 | the UDP | on-3GPP-EPS | | | | 9.212 [3] | source port | | | | | | number in | 3GPP-EPS | | | | | the case | | | | | | that NA(P)T | | | | | | is detected | | | | | | for | | | | | | supporting | | | | | | i | | | | | | nterworking | | | | | | with Fixed | | | | | | Broadband | | | | | | access | | | | | | network | | | +-------------+-------------+-------------+-------------+-------------+ | NOTE 1: | | | | | | AVPs marked | | | | | | with "PC" | | | | | | are | | | | | | applicable | | | | | | to policy | | | | | | control. | | | | | | | | | | | | NOTE 2: | | | | | | Event | | | | | | trigger | | | | | | value | | | | | | UE_LOCAL | | | | | | _IP_ADDRE | | | | | | SS_CHANGE, | | | | | | UE-Local | | | | | | -IP-Address | | | | | | AVP and | | | | | | UDP- | | | | | | Source-Port | | | | | | AVP are | | | | | | applicable | | | | | | to the | | | | | | No | | | | | | n-3GPP-EPS. | | | | | | Event | | | | | | trigger | | | | | | value | | | | | | H( | | | | | | E)NB_LOCAL | | | | | | _IP_ADDRE | | | | | | SS_CHANGE, | | | | | | H | | | | | | (e)NB-Local | | | | | | -IP-Address | | | | | | AVP and | | | | | | UDP- | | | | | | Source-Port | | | | | | AVP are | | | | | | applicable | | | | | | to the | | | | | | 3GPP-EPS. | | | | | +-------------+-------------+-------------+-------------+-------------+
## A.7.5 S9a specific Experimental-Result-Code AVP values
### A.7.5.1 General
IETF RFC 3588 [6] specifies the Experimental-Result AVP containing Vendor-ID
AVP and Experimental-Result-Code AVP. The Experimental-Result-Code AVP (AVP
Code 298) is of type Unsigned32 and contains a vendor-assigned value
representing the result of processing a request. The Vendor-ID AVP shall be
set to 3GPP (10415).
### A.7.5.2 Success
Result Codes that fall within the Success category are used to inform a peer
that a request has been successfully completed.
The Result-Code AVP values defined in Diameter base protocol, IETF RFC 3588
[6], shall be applied.
### A.7.5.3 Permanent Failures
Errors that fall within the Permanent Failures category shall be used to
inform the peer that the request failed, and should not be attempted again.
The Result-Code AVP values defined in Diameter base protocol, IETF RFC 3588
[6], and 3GPP TS 29.212 [3] are applicable.
### A.7.5.4 Transient Failures
Errors that fall within the transient failures category are used to inform a
peer that the request could not be satisfied at the time it was received, but
may be able to satisfy the request in the future.
No transient failure is identified in this release.
### A.7.6 S9a Messages
### A.7.6.1 S9a Application
S9a Messages are carried within the Diameter Application(s) described in
subclause A.7.1.
Existing Diameter command codes from the Diameter base protocol, IETF RFC 3588
[6], and the Diameter Credit Control Application, IETF RFC 4006 [9], are used
with the S9a specific AVPs specified in subclause A.7.3. The Diameter Credit
Control Application AVPs and AVPs from other Diameter applications that are
re-used are defined in subclause A.7.4. Due to the definition of these
commands there is no possibility to skip the Auth-Application-Id AVP and use
the Vendor-Specific-Application-Id AVP instead. Therefore the S9a application
identifier shall be included in the Auth-Application-Id AVP.
NOTE: Some of the AVPs included in the messages formats below are in bold to
highlight that these AVPs are used by this specific protocol and do not belong
to the original message definition in the DCC Application, IETF RFC 4006 [9],
or Diameter base protocol, IETF RFC 3588 [6].
### A.7.6.2 CC-Request (CCR) Command
The CCR command, indicated by the Command-Code field set to 272 and the \'R\'
bit set in the Command Flags field, is sent by the BPCF to the PCRF in order
to initiate an S9a session establishment and to request QoS rules. The CCR
command is also sent by the BPCF to the PCRF in order to indicate QoS rule
related events.
Message Format:
\ ::= \
\
{ Auth-Application-Id }
{ Origin-Host }
{ Origin-Realm }
{ Destination-Realm }
{ CC-Request-Type }
{ CC-Request-Number }
[ Destination-Host ]
[ Origin-State-Id ]
[ Subscription-Id ]
[ Called-Station-Id ]
***[ Supported-Features ]**
**[ QoS-Information ]**
***[ QoS-Rule-Report ]**
**[ UE-Local-IP-Address ]**
**[ HeNB-Local-IP-Address ]**
[ Termination-Cause ]
*[ Proxy-Info ]
*[ Route-Record ]
*[ AVP ]
### A.7.6.3 CC-Answer (CCA) Command
The CCA command, indicated by the Command-Code field set to 272 and the \'R\'
bit cleared in the Command Flags field, is sent by the PCRF to the BPCF in
response to the CCR command. It is used to provision QoS rules for the S9a
session
Message Format:
\ ::= \
\
{ Auth-Application-Id }
{ Origin-Host }
{ Origin-Realm }
[ Result-Code ]
[ Experimental-Result ]
{ CC-Request-Type }
{ CC-Request-Number }
***[ Supported-Features]**
***[ QoS-Rule-Install ]**
***[ QoS-Rule-Remove ]**
**[ Event-Report-Indication ]**
**[ Origin-State-Id ]**
**[ Error-Message ]**
**[ Error-Reporting-Host ]**
*[ Failed-AVP ]
*[ Proxy-Info ]
*[ Route-Record ]
*[ AVP ]
### A.7.6.4 Re-Authorization-Request (RAR) Command
The RAR command, indicated by the Command-Code field set to 258 and the \'R\'
bit set in the Command Flags field, is sent by the PCRF to the BPCF in order
to provision QoS rules and address information for the S9a session.
Message Format:
\ ::= \
\
{ Auth-Application-Id }
{ Origin-Host }
{ Origin-Realm }
{ Destination-Realm }
{ Destination-Host }
{ Re-Auth-Request-Type }
[ Origin-State-Id ]
***[ QoS-Rule-Install ]**
***[ QoS-Rule-Remove ]**
**[ Event-Report-Indication ]**
**[ Session-Release-Cause ]**
*[ Proxy-Info ]
*[ Route-Record ]
*[ AVP ]
### A.7.6.5 Re-Authorization-Answer (RAA) Command
The RAA command, indicated by the Command-Code field set to 258 and the \'R\'
bit cleared in the Command Flags field, is sent by the BPCF to the PCRF in
response to the RAR command.
Message Format:
\ ::= \
\
{ Origin-Host }
{ Origin-Realm }
[ Result-Code ]
[ Experimental-Result ]
[ Origin-State-Id ]
**[ QoS-Information ]**
***[ QoS-Rule-Report ]**
[ Error-Message ]
[ Error-Reporting-Host ]
*[ Failed-AVP ]
*[ Proxy-Info ]
*[ AVP ]
### A.7.6.6 Trigger-Establishment-Request (TER) Command
The TER command, indicated by the Command-Code field set to 8388656 and the
\'R\' bit set in the Command Flags field, is sent by the PCRF to the BPCF in
order to trigger the S9a Session Establishment.
Message Format:
\ ::= \
\
{ Auth-Application-Id }
{ Origin-Host }
{ Origin-Realm }
{ Destination-Realm }
{ Destination-Host }
[ Auth-Session-State ]
[ Origin-State-Id ]
**[ Subscription-Id ]**
**[ Called-Station-Id ]**
**[ PCRF-Address ]**
**[ UE-Local-IP-Address ]**
**[ HeNB-Local-IP-Address ]**
**[ UDP-Source-Port ]**
*[ Proxy-Info ]
*[ Route-Record ]
*[ AVP ]
### A.7.6.7 Trigger-Establishment-Answer (TEA) Command
The TEA command, indicated by the Command-Code field set to 8388656 and the
\'R\' bit cleared in the Command Flags field, is sent by the BPCF to the PCRF
in response to the TER command.
Message Format:
\ ::= \
\
{ Origin-Host }
{ Origin-Realm }
[ Result-Code ]
[ Experimental-Result ]
[ Origin-State-Id ]
[ Error-Message ]
[ Error-Reporting-Host ]
*[ Failed-AVP ]
*[ Proxy-Info ]
*[ AVP ]
# A.8 S9a* Protocol
## A.8.1 Protocol support
The S9a* application is defined as a vendor specific Diameter application,
where the vendor is 3GPP and the Application-ID for the S9a* Application in
the present release is 16777320. The vendor identifier assigned by IANA to
3GPP (http://www.iana.org/assignments/enterprise-numbers) is 10415.
NOTE: A route entry can have a different destination based on the application
identification AVP of the message. Therefore, Diameter agents (relay, proxy,
redirection, translation agents) must be configured appropriately to identify
the 3GPP S9a* application within the Auth-Application-Id AVP in order to
create suitable routeing tables.
Due to the definition of the commands used in the S9a* protocol, there is no
possibility to skip the Auth-Application-Id AVP and use the Vendor-Specific-
Application-Id AVP instead. Therefore the S9a* application identification
shall be included in the Auth-Application-Id AVP.
## A.8.2 Initialization, maintenance and termination of connection and session
The initialization and maintenance of the connection between each
BPCF/(V-)PCRF pair is defined by the underlying protocol. Establishment and
maintenance of connections between Diameter nodes is described in IETF RFC
3588 [6].
After establishing the transport connection, the BPCF and the (V-)PCRF shall
advertise the support of the S9a* specific Application by including the value
of the application identifier in the Auth-Application-Id AVP and the value of
the 3GPP (10415) in the Vendor-Id AVP of the Vendor-Specific-Application-Id
AVP contained in the Capabilities‑Exchange-Request and Capabilities-Exchange-
Answer commands. The Capabilities-Exchange-Request and Capabilities-Exchange-
Answer commands are specified in the Diameter base protocol (IETF RFC 3588
[6]).
The termination of the Diameter S9a* session over S9a reference point may be
initiated by the BPCF and PCRF, as specified in subclauses A.5.2.2.1 and
A.5.2.2.2.
## A.8.3 S9a* specific AVPs
### A.8.3.1 General
Table A.8.3.1 describes the Diameter AVPs defined for the S9a* Diameter
application over S9a reference point, their AVP Code values, types, possible
flag values, whether or not the AVP may be encrypted, what access types (e.g.
3GPP-GPRS, etc.) the AVP is applicable to, the applicability of the AVPs to
charging control, policy control or both, and which supported features the AVP
is applicable to. The Vendor-Id header of all AVPs defined in the present
document shall be set to 3GPP (10415).
Table 5.3.1: S9a* specific Diameter AVPs
|  |  |  | AVP Flag rules (NOTE 1) |  |  |  |  |  |   
---|---|---|---|---|---|---|---|---|---|---  
Attribute Name | AVP Code | Clause defined | Value Type (NOTE 2) | Must | May | Should not | Must not | May Encr. | Acc. type (NOTE 3) | Applicability  
UE-Local-IPv6-Prefix | 2205 | A.8.3.1 | Octetstring | V,M | P |  |  | Y |  | PC NSWO  
NOTE 1: The AVP header bit denoted as 'M', indicates whether support of the AVP is required. The AVP header bit denoted as 'V', indicates whether the optional Vendor-ID field is present in the AVP header. For further details, see RFC 3588 [6]. NOTE 2: The value types are defined in RFC 3588 [6]. NOTE 3: S9a* protocol applies only when the UE is making use of a fixed broadband access network. |  |  |  |  |  |  |  |  |  |   
#### A.8.3.1.1 UE-Local-IPv6-Prefix AVP
The UE-Local-IPv6-Prefix AVP (AVP code 2205) is of type OctetString, and it
indicates the UE local IPv6 prefix allocated to the user. The encoding of the
value within this AVP shall be as defined for Framed-IPv6-Prefix AVP in IETF
RFC 3162[15], clause 2.3. The \"Reserved\", \"Prefix-Length\" and \"Prefix\"
fields shall be included in this order.
## A.8.4 S9a* re-used AVPs
### A.8.4.1 General
Table A.8.4.1.1 lists the Diameter AVPs re-used by the S9a* Diameter
Application from other reference points (e.g. Gx, Gxx, S9 reference points)
and other existing Diameter Applications, reference to their respective
specifications, short description of their usage within the S9a reference
point, the applicability of the AVPs to a specific access, and which supported
features the AVP is applicable to. When reused from S9 reference point, the
specific clause in the present specification is referred. Other AVPs from
existing Diameter Applications, except for the AVPs from Diameter base
protocol, do not need to be supported. The AVPs from Diameter base protocol
are not included in table A.8.4.1.1, but they are re-used for the S9a
reference point. Unless otherwise stated, re-used AVPs shall maintain their
\'M\', \'P\' and \'V\' flag settings. Where RADIUS VSAs are re-used, unless
otherwise stated, they shall be translated to Diameter AVPs as described in
IETF RFC 4005 with the exception that the 'M' flag shall be set and the 'P'
flag may be set.
Table A.8.4.1.1: S9a* re-used Diameter AVPs
+-------------+-------------+-------------+-----------+-------------+ | Attribute | Reference | Description | Acc. type | Ap | | Name | | | | plicability | | | | | | | | | | | | Note 1 | +-------------+-------------+-------------+-----------+-------------+ | Called | IETF | It is set | | PC | | -Station-Id | RFC 4005 | to a fixed | | | | | | value and | | | | | | indicates | | | | | | that the | | | | | | S9a* | | | | | | session is | | | | | | related to | | | | | | NSWO | | | | | | traffic | | | | | | (i.e. | | | | | | conveys the | | | | | | NSWO-APN). | | | | | | It is a | | | | | | fixed value | | | | | | set by the | | | | | | operator. | | | | | | The naming | | | | | | convention | | | | | | is left to | | | | | | operator's | | | | | | imp | | | | | | lementation | | | | | | decision. | | | +-------------+-------------+-------------+-----------+-------------+ | CC-Req | IETF RFC | The number | | PC | | uest-Number | 4006 [9] | of the | | | | | | request for | | | | | | mapping | | | | | | requests | | | | | | and answers | | | +-------------+-------------+-------------+-----------+-------------+ | CC-R | IETF RFC | The type of | | PC | | equest-Type | 4006 [9] | the request | | | | | | (initial, | | | | | | update, | | | | | | t | | | | | | ermination) | | | +-------------+-------------+-------------+-----------+-------------+ | QoS- | 3GPP | Defines the | | PC | | Information | TS 2 | QoS | | | | | 9.212 [3] | information | | | | | | that can be | | | | | | accepted by | | | | | | the BPCF. | | | +-------------+-------------+-------------+-----------+-------------+ | Charging-R | 3GPP TS | It is used | | PC | | ule-Install | 2 | to | | | | | 9.212 [3] | activate, | | | | | | install or | | | | | | modify PCC | | | | | | rules at | | | | | | Fixed | | | | | | Broadband | | | | | | access | | | | | | network. | | | | | | Only | | | | | | Cha | | | | | | rging-Rule- | | | | | | Definition, | | | | | | Charging | | | | | | -Rule-Name, | | | | | | C | | | | | | harging-Rul | | | | | | e-Base-Name | | | | | | are | | | | | | applicable. | | | +-------------+-------------+-------------+-----------+-------------+ | Charging- | 3GPP | It is used | | PC | | Rule-Remove | TS 2 | to | | | | | 9.212 [3] | deactivate | | | | | | or remove | | | | | | PCC rules | | | | | | in the | | | | | | BPCF. | | | +-------------+-------------+-------------+-----------+-------------+ | Charging- | 3GPP | It is used | | PC | | Rule-Report | TS 2 | to report | | | | | 9.212 [3] | the status | | | | | | of the PCC | | | | | | Rules. | | | +-------------+-------------+-------------+-----------+-------------+ | Session-Re | 3GPP | Indicate | | PC | | lease-Cause | TS 2 | the reason | | | | | 9.212 [3] | of | | | | | | termination | | | | | | initiated | | | | | | by the | | | | | | PCRF. | | | +-------------+-------------+-------------+-----------+-------------+ | Subs | IETF RFC | The | | PC | | cription-Id | 4006 [9] | ide | | | | | | ntification | | | | | | of the | | | | | | s | | | | | | ubscription | | | | | | (i.e. IMSI) | | | +-------------+-------------+-------------+-----------+-------------+ | Support | 3GPP | If present, | | PC | | ed-Features | TS 2 | this AVP | | | | | 9.229 [7] | informs the | | | | | | destination | | | | | | host about | | | | | | the | | | | | | features | | | | | | that the | | | | | | origin host | | | | | | requires to | | | | | | s | | | | | | uccessfully | | | | | | complete | | | | | | this | | | | | | command | | | | | | exchange | | | +-------------+-------------+-------------+-----------+-------------+ | TDF- | 3GPP | It contains | | PC | | Information | TS 2 | the | | | | | 9.212 [3] | information | | | | | | about the | | | | | | TDF that | | | | | | shall | | | | | | handle the | | | | | | application | | | | | | detection | | | | | | and | | | | | | reporting | | | | | | for that | | | | | | IP-CAN | | | | | | Session | | | +-------------+-------------+-------------+-----------+-------------+ | UE-Local | 3GPP | Contains | | PC | | -IP-Address | TS 2 | the UE | | | | | 9.212 [3] | local IP | | | | | | address | | | +-------------+-------------+-------------+-----------+-------------+ | NOTE 1: | | | | | | AVPs marked | | | | | | with "PC" | | | | | | are | | | | | | applicable | | | | | | to policy | | | | | | control. | | | | | | | | | | | | NOTE 2: | | | | | | S9a* | | | | | | protocol | | | | | | applies | | | | | | only when | | | | | | the UE is | | | | | | making use | | | | | | of a fixed | | | | | | broadband | | | | | | access | | | | | | network to | | | | | | offload the | | | | | | traffic. | | | | | | This is not | | | | | | notified | | | | | | over the | | | | | | interface. | | | | | +-------------+-------------+-------------+-----------+-------------+
## A.8.5 S9a* specific Experimental-Result-Code AVP values
### A.8.5.1 General
IETF RFC 3588 [6] specifies the Experimental-Result AVP containing Vendor-ID
AVP and Experimental-Result-Code AVP. The Experimental-Result-Code AVP (AVP
Code 298) is of type Unsigned32 and contains a vendor-assigned value
representing the result of processing a request. The Vendor-ID AVP shall be
set to 3GPP (10415).
### A.8.5.2 Success
Result Codes that fall within the Success category are used to inform a peer
that a request has been successfully completed.
The Result-Code AVP values defined in Diameter base protocol, IETF RFC 3588
[6], shall be applied.
### A.8.5.3 Permanent Failures
Errors that fall within the Permanent Failures category shall be used to
inform the peer that the request failed, and should not be attempted again.
The Result-Code AVP values defined in Diameter base protocol, IETF RFC 3588
[6], and 3GPP TS 29.212 [3] are applicable.
### A.8.5.4 Transient Failures
Errors that fall within the transient failures category are used to inform a
peer that the request could not be satisfied at the time it was received, but
may be able to satisfy the request in the future.
No transient failure is identified in this release.
## A.8.6 S9a* Messages
### A.8.6.1 S9a* Application
S9a* Messages are carried within the Diameter Application(s) described in
subclause A.8.1.
Existing Diameter command codes from the Diameter base protocol, IETF RFC 3588
[6], and the Diameter Credit Control Application, IETF RFC 4006 [9], are used
with the S9a* specific AVPs specified in subclause A.8.3. The Diameter Credit
Control Application AVPs and AVPs from other Diameter applications that are
re-used are defined in subclause A.8.4. Due to the definition of these
commands there is no possibility to skip the Auth-Application-Id AVP and use
the Vendor-Specific-Application-Id AVP instead. Therefore the S9a* application
identifier shall be included in the Auth-Application-Id AVP.
NOTE: Some of the AVPs included in the messages formats below are in bold to
highlight that these AVPs are used by this specific protocol and do not belong
to the original message definition in the DCC Application, IETF RFC 4006 [9],
or Diameter base protocol, IETF RFC 3588 [6].
### A.8.6.2 CC-Request (CCR) Command
The CCR command, indicated by the Command-Code field set to 272 and the \'R\'
bit set in the Command Flags field, is sent by the BPCF to the PCRF in order
to initiate an S9a* session establishment and to request PCC rules. The CCR
command is also sent by the BPCF to the PCRF in order to indicate PCC rule
related events.
Message Format:
\ ::= \
\
{ Auth-Application-Id }
{ Origin-Host }
{ Origin-Realm }
{ Destination-Realm }
{ CC-Request-Type }
{ CC-Request-Number }
[ Destination-Host ]
[ Origin-State-Id ]
[ Subscription-Id ]
[ Called-Station-Id ]
***[ Supported-Features ]**
***[ Charging-Rule-Report ]**
**[ UE-Local-IP-Address ]**
[ UE-Local-IPv6-Prefix ]
**[ QoS-Information ]**
**[ TDF-Information ]**
[ Termination-Cause ]
*[ Proxy-Info ]
*[ Route-Record ]
*[ AVP ]
### A.8.6.3 CC-Answer (CCA) Command
The CCA command, indicated by the Command-Code field set to 272 and the \'R\'
bit cleared in the Command Flags field, is sent by the PCRF to the BPCF in
response to the CCR command. It is used to provision PCC rules for the S9a
session.
Message Format:
\ ::= \
\
{ Auth-Application-Id }
{ Origin-Host }
{ Origin-Realm }
[ Result-Code ]
[ Experimental-Result ]
{ CC-Request-Type }
{ CC-Request-Number }
***[ Supported-Features]**
***[ Charging-Rule-Install ]**
***[ Charging-Rule-Remove ]**
**[ Origin-State-Id ]**
**[ Error-Message ]**
**[ Error-Reporting-Host ]**
*[ Failed-AVP ]
*[ Proxy-Info ]
*[ Route-Record ]
*[ AVP ]
### A.8.6.4 Re-Authorization-Request (RAR) Command
The RAR command, indicated by the Command-Code field set to 258 and the \'R\'
bit set in the Command Flags field, is sent by the PCRF to the BPCF in order
to provision PCC rules and address information for the S9a session.
Message Format:
\ ::= \
\
{ Auth-Application-Id }
{ Origin-Host }
{ Origin-Realm }
{ Destination-Realm }
{ Destination-Host }
{ Re-Auth-Request-Type }
[ Origin-State-Id ]
***[ Charging-Rule-Install ]**
***[ Charging-Rule-Remove ]**
**[ Session-Release-Cause ]**
*[ Proxy-Info ]
*[ Route-Record ]
*[ AVP ]
### A.8.6.5 Re-Authorization-Answer (RAA) Command
The RAA command, indicated by the Command-Code field set to 258 and the \'R\'
bit cleared in the Command Flags field, is sent by the BPCF to the PCRF in
response to the RAR command.
Message Format:
\ ::= \
\
{ Origin-Host }
{ Origin-Realm }
[ Result-Code ]
[ Experimental-Result ]
[ Origin-State-Id ]
**[ QoS-Information ]**
***[ Charging-Rule-Report ]**
[ Error-Message ]
[ Error-Reporting-Host ]
*[ Failed-AVP ]
*[ Proxy-Info ]
*[ AVP ]
###### ## Annex B (normative): Access specific aspects, Fixed Broadband Access
network convergence
# B.1 Scope
This annex defines access specific aspects of S9 procedures for supporting
Non-Seamless WLAN Offload (NSWO) traffic from a 3GPP UE in the fixed broadband
access network convergent scenario. In the convergent scenario, the PCRF
controls directly the network element(s) in the fixed broadband access without
the mediation of a different policy server, such as the Broadband Policy
Control Function (BPCF).
# B.2 Definitions and abbreviations
## B.2.1 Definitions
The definitions in the following are relevant for this Annex only.
**UE local IP address** is defined as either the public IP address assigned to
the UE by the Broadband Forum domain in the no-NAT case, or the public IP
address assigned by the Broadband Forum domain to the NATed RG.
**IP-CAN session** as defined in subclause 3.1 applies with the following
clarifications for fixed broadband access. The term UE corresponds to the
device that accesses the services provided by the network (i.e. either RG, or
3GPP UE or fixed end-device), the PDN identifies the IP network where the
device gets IP connectivity and the UE identity information may be the IMSI,
the user-name or the access line identifier (if available). In a Fixed
Broadband Access an IP-CAN session corresponds to a Subscriber IP Session
defined in Broadband Forum TR-146 [16].
NOTE: The PDN connection concept and APN are not applicable to a Subscriber IP
session for a fixed device.
## B.2.2 Abbreviations
The following abbreviations are relevant for this annex only:
BBF Broadband Forum
NSWO Non-Seamless WLAN offload
NSWO-APN Non-Seamless WLAN offload APN
RG Residential Gateway
# B.3 Reference points and Reference model
## B.3.1 General
For Fixed Broadband Access network convergence, the applied scenarios are
defined in Annex F.4.1 in 3GPP TS 29.213 [4].
## B.3.2 S9 Reference Point
The S9 reference point defined in clause 4.1 applies.
## B.3.3 Reference Model
For Fixed Broadband Access network convergence, the reference architecture in
Figures B.3.3-1 and Figure B.3.3-2 applies with the following conditions:
\- The roaming architecture is not applicable to fixed devices and RGs in the
scenario of Fixed Broadband Access network convergence.
\- PCEF resides in the IP Edge in the Fixed Broadband Access network.
NOTE 1: Either SPR or UDR is used in this architecture.
NOTE 2: Gxx reference point is not used.
Figure B.3.3-1: S9 reference point at the PCC architecture for roaming with
SPR
Figure B.3.3-2: S9 reference point at the PCC architecture for roaming with
UDR
# B.4 Functional Elements
## B.4.1 V-PCRF
The V-PCRF functionality defined in subclause 4.3.2.0 and subclause 4.3.2.2
for case 1 and visited access shall apply.
## B.4.2 H-PCRF
The H-PCRF functionality defined in subclause 4.3.1.0 and subclause 4.3.1.2
for case 1 and visited access shall apply with following exceptions:
\- No negotiation of IP-CAN bearer control mode applies.
\- Subscriptions to changes of IP-CAN type, RAT type or Access Network
Information do not apply.
# B.5 PCC procedures over S9 Reference Point
## B.5.0 General
The following exceptions apply for S9 session procedures in the scenario of
Fixed Broadband Access network convergence:
\- Gxx reference point is not used.
\- S9 reference point is only applicable for the NSWO traffic from the 3GPP
UE.- No provisioning of IP flow mobility routing information over S9 reference
point is performed.
## B.5.1 Session Establishment over S9
The S9 session establishment procedure in subclause 4.5.1.1 applies with the
following exceptions or restrictions as described in Annex B.5.0.
## B.5.2 Session Termination over S9
The procedures for case 1 described in subclause 4.5.1.2 apply with the
exceptions or restrictions as described in Annex B.5.0.
## B.5.3 Session Modification over S9
S9 session modification procedures described in subclause 4.5.3.1 and
subclause 4.5.3.2 for case 1 apply with the exceptions or restrictions as
described in Annex B.5.0.
S9 subsession termination procedures described in subclause 4.5.3.3 and
subclause 4.5.3.4 for case 1 apply with the exceptions or restrictions as
described in Annex B.5.0
## B.5.4 Provisioning and validation of QoS information
The provisioning and validation of QoS information in subclause 4.5.3.1 and
subclause 4.5.3.2 applies with the exceptions or restrictions as described in
Annex B.5.0.
###### ## Annex C (normative): Access specific aspects, EPC-based eHRPD Access
# C.1 General
In case of EPC-based eHRPD access the BBERF is located in the HRPD Serving
Gateway (HSGW) as defined in 3GPP2 X.S0057 [23].
# C.2 IPv6 prefix provisioning
For the home-routed access scenario, when the H-PCRF receives a CCR command
with the CC-Request-Type set to the value \"UPDATE_REQUEST\", the IP-CAN-Type
AVP set to the value \"Non-3GPP-EPS\", the RAT-Type AVP set to the value
\"EHRPD\" and the Multiple-BBERF-Action AVP set to the value \"ESTABLISHMENT\"
from the V-PCRF, and if the UE has acquired an IPv6 prefix via the 3GPP
access, the H-PCRF shall provide the IPv6 prefix of the UE to the V-PCRF by
including the Framed-Ipv6-Prefix AVP in Subsession-Decision-Info AVP within
the CCA command.
For the visited access scenario, when the V-PCRF receives a CCR command with
the CC-Request-Type set to the value \"INITIAL_REQUEST\", the IP-CAN-Type AVP
set to the value \"Non-3GPP-EPS\", the RAT-Type AVP set to the value \"EHRPD\"
from a new BBERF and at least one Gateway Control Session for the same user
identity and PDN ID exists, and if the UE has acquired an IPv6 prefix via the
3GPP access, the V-PCRF shall provide the IPv6 prefix of the UE to the BBERF
by including the Framed-Ipv6-Prefix AVP in the CCA command after the V-PCRF
receives the CCA command from the H-PCRF.
NOTE: In order to allow the V-PCRF to link the new Gateway Control session to
an S9 subsession based on the information received in the CCR command from the
BBERF, it is assumed that there is only a single IP-CAN session per PDN ID and
user identity.
#
# Foreword
This Technical Report has been produced by the 3^rd^ Generation Partnership
Project (3GPP).
The contents of the present document are subject to continuing work within the
TSG and may change following formal TSG approval. Should the TSG modify the
contents of the present document, it will be re-released by the TSG with an
identifying change of release date and an increase in version number as
follows:
Version x.y.z
where:
x the first digit:
1 presented to TSG for information;
2 presented to TSG for approval;
3 or greater indicates TSG approved document under change control.
y the second digit is incremented for all changes of substance, i.e. technical
enhancements, corrections, updates, etc.
z the third digit is incremented when editorial only changes have been
incorporated in the document.
# 1 Scope
The present document investigates the IMS H.248 profiles requirements and
procedures to support the stage 2 requirements specified in 3GPP TS 33.328 [2]
for Extended IMS media plane security features.
This includes in particular the following aspects:
  1. Provide end-to access edge protection of session based messaging (MSRP) traffic using TLS and certificates fingerprints exchanged over SDP;
  2. Provide end-to-end protection of session based messaging (MSRP) traffic using TLS;
  3. Provide end-to access edge protection of BFCP based traffic, using TLS and certificates fingerprints exchanged over SDP;
  4. Provide optional support of TLS protection of BFCP and MSRP based traffic at the Conference Server.
  5. Analyse requirements and procedures for end-to-end TCP bearer connection control and related NAT traversal support.
NOTE: this aspect is not specific to media security and may result in
normative work via another work item.
  1. Provide support of TCP-based IP transport connections for TLS security sessions, which includes possible NAT traversal support during the TCP connection establishment phase, possible correlations between the establishment (and release) events of TCP connections with TLS session establishment (and release).
  2. Provide end-to access edge protection of T.38 fax using DTLS.
This study will cover:
\- Identification of the key issues and the main design considerations that
should drive the definition of stage 2 requirements and procedures for the Iq,
Ix and Mp profiles;
\- Identification of the requirements and procedures for the Iq, Ix and Mp
profiles for support of end-to-access edge and end-to-end media security for
session-based messaging (MSRP [6]) and conferencing (BFCP [16]);
\- Identification of the requirements and procedures for the Iq profile for
support of end-to-access edge media security for T.38 fax over UDPTL/UDP
transport;
\- Identification of the ITU-T H.248 extensions necessary to fulfil the 3GPP
requirements and identification of potential missing gaps that should be taken
into account by ITU-T Q3/16;
\- Conclusions and Recommendations for the normative work.
The results of this study will be used to identify the changes required in the
3GPP specifications to support Extended IMS media plane security.
# 2 References
The following documents contain provisions which, through reference in this
text, constitute provisions of the present document.
\- References are either specific (identified by date of publication, edition
number, version number, etc.) or non‑specific.
\- For a specific reference, subsequent revisions do not apply.
\- For a non-specific reference, the latest version applies. In the case of a
reference to a 3GPP document (including a GSM document), a non-specific
reference implicitly refers to the latest version of that document _in the
same Release as the present document_.
[1] 3GPP TR 21.905: \"Vocabulary for 3GPP Specifications\".
[2] 3GPP TS 33.328: \"IMS Media Plane Security\".
[3] 3GPP TS 23.228: \"IP Multimedia Subsystem (IMS); Stage 2\".
[4] 3GPP TS 24.247: \"Messaging service using the IP Multimedia (IM) Core
Network (CN) subsystem; Stage 3\".
[5] 3GPP TS 24.229: \"IP multimedia call control protocol based on Session
Initiation Protocol (SIP) and Session Description Protocol (SDP); Stage 3\".
[6] IETF RFC 4975: \"The Message Session Relay Protocol (MSRP)\".
[7] IETF RFC 5246: \"The Transport Layer Security (TLS) Protocol Version
1.2\".
[8] IETF RFC 6135: \"An Alternative Connection Model for the Message Session
Relay Protocol (MSRP)\".
[9] IETF RFC 6714: \"Connection Establishment for Media Anchoring (CEMA) for
the Message Session Relay Protocol (MSRP)\".
[10] IETF RFC 4976: \"Relay Extensions for the Message Sessions Relay Protocol
(MSRP)\".
[11] IETF RFC 6043: \"MIKEY-TICKET: Ticket-Based Modes of Key Distribution in
Multimedia Internet KEYing (MIKEY)\".
[12] IETF RFC 4145: \"TCP-Based Media Transport in the Session Description
Protocol (SDP)\".
[13] IETF draft-ietf-simple-msrp-sessmatch-10: \"Session Matching Update for
the Message Session Relay Protocol (MSRP)\".
[14] IETF RFC 4572: \"Connection-Oriented Media Transport over the Transport
Layer Security (TLS) Protocol in the Session Description Protocol (SDP)\".
[15] IETF RFC 5763: \"Framework for Establishing a Secure Real-time Transport
Protocol (SRTP) Security Context Using Datagram Transport Layer Security
(DTLS)\".
[16] IETF RFC 4582: \"The Binary Floor Control Protocol (BFCP)\".
[17] IETF RFC 4583: \"Session Description Protocol (SDP) Format for Binary
Floor Control Protocol (BFCP) Streams\".
[18] GSM Association RCC.07: \"Rich Communication Suite 5.1 Advanced
Communications Services and Client Specification, Version 2.0, 03 May 2013\".
[19] OMA-TS-SIMPLE_IM-V2_0-20120731-C: \"Instant Messaging using SIMPLE
Candidate Version 2.0 -- 31 Jul 2012\".
[20] IETF RFC 793: \"Transmission Control Protocol\".
[21] 3GPP TS 24.147: \"Conferencing using the IP Multimedia (IM), Core Network
(CN) subsystem; Stage 3\".
[22] ETSI TS 183 018 V3.5.2 (2010-01): \"Telecommunications and Internet
converged Services and Protocols for Advanced Networking (TISPAN); Resource
and Admission Control: H.248 Profile Version 3 for controlling Border Gateway
Functions (BGF) in the Resource and Admission Control Subsystem (RACS);
Protocol specification\".
[23] ITU-T Recommendation H.248.37 (06/2008): \"Gateway control protocol: IP
NAPT traversal package\".
[24] ITU-T Recommendation H.248.84 (07/2012): \"Gateway control protocol: NAT
traversal for peer-to-peer services\".
[25] 3GPP TR 33.830: \"Feasibility study on IMS firewall traversal\".
[26] ITU-T Recommendation T.38 (09/2010): \"Procedures for real-time Group 3
facsimile communication over IP networks\".
[27] 3GPP TS 26.114: \"IP Multimedia Subsystem (IMS); Multimedia telephony;
Media handling and interaction\".
[28] IETF RFC 6347: \"Datagram Transport Layer Security Version 1.2\".
[29] IETF RFC 7345: \"UDP Transport Layer (UDPTL) over Datagram Transport
Layer Security (DTLS)\".
[30] OMA-TS-CPM_Conversation_Function-V2_0-20130926-D: \"CPM Conversation
Functions\".
Editor´s Notes: Spec is not yet public. Reference to be updated once OMA makes
new version public.
[31] GSM Association RCC.07: \"Rich Communication Suite 5.1 Advanced
Communications Services and Client Specification, Version 3.0, 25 September
2013\".
[32] GSM Association RCS-e: \"RCS-e - Advanced Communications: Services and
Client Specification, Version 1.2.2, 04 July 2012\".
[33] ITU-T Recommendation H.248.78 (03/2013): \"Gateway control protocol:
Bearer-level application level gateway\".
Editor\'s Note: The above document is currently under revision by ITU-T. The
latest draft of revised H.248.78 is available from the following link:\
http://wftp3.itu.int/av-arch/avc-site/2013-2016/1403_Gen/TD-12.zip
[34] 3GPP TS 23.334: \"IMS Application Level Gateway (IMS-ALG) -- IMS Access
Gateway (IMS-AGW) interface: Procedures descriptions\".
[35] 3GPP TS 29.334: \"IMS Application Level Gateway (IMS-ALG) -- IMS Access
Gateway (IMS-AGW); Iq Interface; Stage 3\".
[36] Draft ITU-T Recommendation H.248.89 (03/2014): \"Gateway control
protocol: TCP support packages\".
Editor\'s Note: The above document cannot be formally referenced until it is
published as an ITU-T Recommendation. It is available from the following
link:\ http://wftp3.itu.int/av-arch/avc-site/2013-2016/1403_Gen/TD-13.zip
[37] IETF RFC 5128: \"State of Peer-to-Peer (P2P) Communication across Network
Address Translators (NATs)\".
[38] IETF RFC 3329: \"Security Mechanism Agreement for the Session Initiation
Protocol (SIP)\".
[39] IETF RFC 7092: \"A Taxonomy of Session Initiation Protocol (SIP) Back-to-
Back User Agents\".
[40] Draft ITU-T Recommendation H.248.91 (03/2014): \"Guidelines on the use of
H.248 capabilities for transport security in TLS networks in H.248 Profiles\".
Editor\'s Note: The above document cannot be formally referenced until it is
published as an ITU-T Recommendation. It is available from the following
link:\ http://wftp3.itu.int/av-arch/avc-site/2013-2016/1403_Gen/TD-15.zip
[41] Draft ITU-T Recommendation H.248.90 (03/2014): \"Gateway control
protocol: H.248 packages for control of transport security using TLS\".
Editor\'s Note: The above document cannot be formally referenced until it is
published as an ITU-T Recommendation. It is available from the following
link:\ http://wftp3.itu.int/av-arch/avc-site/2013-2016/1403_Gen/TD-14.zip
[42] Draft ITU-T Recommendation H.248.93 (03/2014): \"Gateway control
protocol: H.248 packages for control of transport security using DTLS\".
Editor\'s Note: The above document cannot be formally referenced until it is
published as an ITU-T Recommendation. It is available from the following
link:\ http://wftp3.itu.int/av-arch/avc-site/2013-2016/1403_Gen/TD-16.zip
[43] Draft ITU-T Recommendation H.248.92 (03/2014): \"Gateway control
protocol: Stream endpoint interlinkage package\".
Editor\'s Note: The above document cannot be formally referenced until it is
published as an ITU-T Recommendation. It is available from the following
link:\ http://wftp3.itu.int/av-arch/avc-site/2013-2016/1403_Gen/TD-17.zip
[44] 3GPP TS 29.162: \"Interworking between the IM CN subsystem and IP
networks\".
[45] IETF draft-schwarz-mmusic-sdp-for-gw-01: \"SDP codepoints for gateway
control\".
Editor\'s Note: The above document cannot be formally referenced until it is
published as an RFC.
[46] IETF RFC 4279: \"Pre-Shared Key Ciphersuites for Transport Layer Security
(TLS)\".
[47] IETF RFC 4567: \"Key Management Extensions for Session Description
Protocol (SDP) and Real Time Streaming Protocol (RTSP)\".
[48] IETF RFC 3830: \"MIKEY: Multimedia Internet KEYing\".
# 3 Definitions and abbreviations
## 3.1 Definitions
For the purposes of the present document, the terms and definitions given in
3GPP TR 21.905 [1] and the following apply.\ A term defined in the present
document takes precedence over the definition of the same term, if any, in
3GPP TR 21.905 [1].
**Application:** This term, when used in the context of \"application-
agnostic\" or \"application-aware\", refers to the IP application protocol on
top of a \"L4 transport protocol\" (e.g., \"TCP\", \"UDP\") with or without a
\"transport security protocol\" (e.g., \"TLS\", \"DTLS\").
**End-to-access edge security:** This term refers to media protection
extending between an IMS UE and the first IMS core network node in the media
path without being terminated by any intermediary.
**End-to-end security:** This term refers to media protection extending
between two IMS UEs without being terminated by any intermediary.
**L3/L4 level NAT traversal** : NAT traversal support limited to protocol
layers L3 and L4 (network and transport layer).
**L4+ level NAT traversal** : NAT traversal support above the IP transport
layer.
**MSRP IWF \"media plane\"** : the modification of MRSP message header
elements (with the TCP payload; a single MRSP message is carried by a TCP
packet).
**MSRP IWF \"signalling plane\"** : the modification of SDP lines (related to
MSRP \"session-mode\" service) within SIP messages.
**Network Address Translation (NA(P)T):** see definition in 3GPP TS 23.228
[3].
**NAT-PT/NAPT-PT:** see definition in 3GPP TS 23.228 [3].
**Local (near-end) NAPT control:** see definition in 3GPP TS 23.334 [34].
**Remote (far-end) NAT traversal:** see definition in 3GPP TS 23.334 [34].
**NAPT control and NAT traversal** : see definition in 3GPP TS 23.334 [34]
**Convention:**
Wherever the **term NAT** is used in this specification, it may be replaced by
**NA(P)T or NA(P)T-PT.**
**TCP modes of operation:**
> **TCP merge mode:** see definition in ITU-T H.248.84 [24]).
>
> **TCP proxy mode:** see definition in ITU-T H.248.84 [24]).
>
> **TCP proxy variants:** see definition in ITU-T H.248.89 [36]).
>
> **TCP relay mode:** see definition in ITU-T H.248.84 [24]).
**TLS-client:** the entity that initiates a TLS session establishment to a
server (see IETF RFC 5246 [7]).
**TLS-server** : the entity that responds to requests for TLS session
establishment from clients (see IETF RFC 5246 [7]).
**TLS endpoint** : either a TLS-client or a TLS-server.
For the purposes of the present document, the following terms and definitions
given in IETF RFC 3830 [48] apply:
**Crypto Session (CS)**
**Initiator**
**Responder**
For the purposes of the present document, the following terms and definitions
given in IETF RFC 6043 [11] apply:
**Traffic-Encrypting Key (TEK)**
**TEK Generation Key (TGK)**
**Ticket**
## 3.2 Abbreviations
For the purposes of the present document, the abbreviations given in TR 21.905
[1] and the following apply.\ An abbreviation defined in the present document
takes precedence over the definition of the same abbreviation, if any, in TR
21.905 [1].
BFCP Binary Floor Control Protocol
CPM Converged IP Messaging
CS Crypto Sessione2ae security End-to-access-edge security
e2e security End-to-end security
FoIP Facsimile over IPIMS-AGW IMS Access Media Gateway
IMS-ALG IMS Application Level Gateway
IM CN IMS Core Network
KMS Key Management Service
L3/L4 NAT-T NAT traversal at protocol layers L3 and/or L4
L4+ NAT-T NAT traversal at protocol layers above L4
MIKEY Multimedia Internet KEYing
MSRP Message Session Relay Protocol
MSRP IWF MSRP Interworking Function
NAPT Network Address Port Translation
NA(P)T Network Address and optional Port Translation
NA(P)T-PT NAT Address (and optional Port) Translation and Protocol Translation
NAT Network Address Translation
NAT-T NAT traversal
PSK Pre-Shared Key
RCS Rich Communication Suite
TEK Traffic Encryption Key
TGK TEK Generation Key
# 4 Key issues and Design considerations for Extended IMS media plane security
features
## 4.1 Media security for Session based messaging (MSRP)
### 4.1.1 General design considerations
IMS messaging concepts and procedures are specified in 3GPP TS 23.228 [3] (see
clause 5.16), 3GPP TS 24.247 [4] and 3GPP TS 24.229 [5].
3GPP TS 33.328 [2] specify IMS media plane security mechanisms for session
based messaging (MSRP) for both e2ae protection and e2e protection. Integrity
and confidentiality protection for MSRP based media is achieved by TLS
protection.
NOTE: Immediate messaging (i.e. page-mode messaging) is out of the scope of
eMEDIASEC.
The salient points of MSRP based media security are: (see 3GPP TS 33.328 [2]
for a comprehensive description):
a) support of e2ae protection or e2e protection of MSRP-based media is
optional for UEs and the network. If an IMS UE and IMS-AGW supports e2ae
protection of MSRP-based media, they shall support IMS media integrity and
confidentiality protection. If IMS media plane security is used, the IMS media
confidentiality protection should be used, while the use of IMS media
integrity protection is optional.
b) indications of UE and network support for e2ae security for MSRP are
exchanged between the UE and the P-CSCF during the IMS registration in the
same way as for RTP based media. MSRP media security uses its own indications
\"e2ae-security for MSRP supported by the UE\" and \"e2ae-security for MSRP
supported by the network\". If both the IMS UE and the network indicate
support for e2ae security for MSRP during the IMS registration, then the IMS
UE (for an IMS originating session set-up) or the P-CSCF (for an IMS
terminating session set-up) shall request e2ae security for MSRP media streams
to be established, unless e2e security is used. If compatibility with GSMA RCS
5.1 [18] is desired, the indication of support for e2ae security during the
IMS registration is not a necessary prerequisite for the use of e2ae security.
c) for e2ae protection of MSRP based media when TLS based media security is
provided between the IMS UE and the IMS-AGW:
  * when the SIP-level MSRP session setup is completed, the TCP transport connection and corresponding TLS security session shall be established between the IMS UE and the IMS-AGW;
  * key management is based on the ciphersuites and session keys negotiated via the TLS handshake protocol between the UE and the IMS-AGW. Mutual authentication during the TLS handshake protocol is achieved using certificates, with the certificate fingerprints being transmitted using the SDP fingerprint attribute in the SIP/SDP offer-answer exchange between the UE and the P-CSCF (IMS-ALG);
  * the IMS-ALG needs to be enhanced to be able to terminate the key management protocol, as well as handle indications, which are specific to e2ae security and are inserted in SIP messages.
  * the IMS-AGW needs to be enhanced to be able to originate and terminate TLS protected MSRP messages. The Iq interface between the IMS-ALG and the IMS-AGW needs to be enhanced to be able to transport parameters related to the management of TLS cryptographic contexts.
  * media security context update is not used with e2ae security.
d) For e2e protection of MSRP based media when TLS based media security is
provided between an IMS UE and a remote IMS or non-IMS UE or MRFP (conference
server):
  * media security is achieved through the same KMS and ticket concept that is used for RTP traffic as specified in 3GPP TS 33.328 [2]. The key management mechanisms are defined by MIKEY-TICKET [11]. The established key is used to setup a TLS-PSK tunnel between the two parties. TLS protected media packets are then forwarded transparently by any nodes present in the media path (e.g. IMS-AGW, TrGW);
\- e2e protected MSRP sessions are set-up without IMS-ALG support, which means
that such sessions can be set-up in networks not providing the IMS-ALG
functionality in the P-CSCF.
### 4.1.2 Assumptions and limitations for MSRP support
IMS session-based messaging is supported as specified in 3GPP TS 24.247 [4]
and 3GPP TS 24.229 [5], i.e. using:
\- from Rel-6 onwards:
\- the Message Session Relay Protocol (MSRP) as defined in IETF RFC 4975 [6];
\- additionally, from Rel-8 onwards:
\- MSRP as extended by IETF RFC 6135 [8] (mandatory support);
\- MSRP as extended by IETF RFC 6714 [9] (mandatory support).
The following MSRP recommendations are not required to be supported per
existing 3GPP specifications:
\- IETF RFC 4976 [10] (MSRP relay) defines a MSRP protocol extension
\- draft-ietf-simple-msrp-sessmatch-10 [13] (Session Matching Update for MSRP)
-- obsolete
However, IETF draft-ietf-simple-msrp-sessmatch-10 [13] is used by some of the
GSMA and OMA specifications that extend IMS for MSRP messaging.
Table 4.1.2-1 summarizes in which 3GPP, GSMA and OMA specifications those MSRP
extensions are used.
Table 4.1.2-1: MSRP usage in 3GPP, GSMA and OMA
+----------+----------+----------+----------+----------+----------+ | | IETF RFC | IETF RFC | IETF RFC | IETF | IETF RFC | | | 4975 | 4976 | 6135 | dra | 6714 | | | [6] | [10]\ | [8]\ | ft-ietf- | [9]\ | | | | (MSRP | (Alt | simple-m | (CEMA | | | (MSRP) | relay) | ernative | srp-sess | for | | | | | co | match-10 | MSRP) | | | | | nnection | [13] | | | | | | model | | | | | | | for | (Session | | | | | | MSRP) | Matching | | | | | | | Update | | | | | | | for | | | | | | | MSRP) | | +----------+----------+----------+----------+----------+----------+ | **3GPP | x | - | x | - | x | | TS | | | | | | | 24.247 | | | | | | | [4] | | | | | | | (Rel-8 | | | | | | | on | | | | | | | wards)** | | | | | | +----------+----------+----------+----------+----------+----------+ | **OMA- | x | - | x | x | - | | TS-SIMPL | | | | | | | E_IM-V2 | | | | | | | [19]** | | | | | | +----------+----------+----------+----------+----------+----------+ | **O | X | - | x | NOTE 1 | x | | MA-TS-CP | | | | | | | M_Conv\ | | | | | | | _Fnct-V2 | | | | | | | [30]** | | | | | | +----------+----------+----------+----------+----------+----------+ | **GSMA | X | - | x | x | - | | RCS-e | | | | | | | [32]** | | | | | | +----------+----------+----------+----------+----------+----------+ | **GSMA | X | - | x | x | - | | RCC.07 | | | | | | | RCS 5.1 | | | | | | | v2 | | | | | | | [18]** | | | | | | +----------+----------+----------+----------+----------+----------+ | **GSMA | X | - | x | x | x | | RCC.07 | | | | | | | RCS 5.1 | | | | (NOTE 2) | (NOTE 2) | | v3 | | | | | | | [31]** | | | | | | +----------+----------+----------+----------+----------+----------+ | NOTE 1: | | | | | | | Inte | | | | | | | rworking | | | | | | | with | | | | | | | s | | | | | | | essmatch | | | | | | | is | | | | | | | ad | | | | | | | dressed. | | | | | | | | | | | | | | NOTE 2: | | | | | | | Ap | | | | | | | plicable | | | | | | | variant | | | | | | | in UE is | | | | | | | de | | | | | | | termined | | | | | | | via | | | | | | | device | | | | | | | config | | | | | | | uration. | | | | | | +----------+----------+----------+----------+----------+----------+
IETF RFC 6135 [8] (\"COMEDIA for MSRP\") enables support of MSRP clients
located behind firewalls by enabling the SIP/SDP level negotiation of the TCP
connection setup direction (by using the IETF RFC 4145 [12] \"a=setup:\"SDP
attribute).
IETF RFC 6714 [9] (\"CEMA for MSRP\") defines a mechanism enabling
intermediate nodes (e.g. MGW) to pass MRSP messages without having to modify
them, and also enabling MGWs to pass TLS encrypted MSRP messages
transparently. The applicability of the related MSRP procedural modifications
is negotiated on SIP level via the new SDP attribute \"a=msrp-cema\". If the
negotiation indicates that not both peers support the MSRP procedural
modifications, a fallback to IETF RFC 4975 [6] applies and a MGW needs to
behave as MSRP B2BUA to pass MSRP; for TLS-encrypted MSRP, the MGW also needs
to decrypt and re-encrypt TLS (TLS B2BUA). IETF draft-ietf-simple-msrp-
sessmatch-10 [13] provides an alternative mechanism to avoid that a MGW that
passes MSRP messages needs to modify them, which was obsoleted in IETF RFC
6714 [9].
There are a number of IETF RFCs and documents, related to the (SIP based)
application control of MSRP-(over-TLS-)over-TCP connections. Figure 4.1.2.1
aims to provide an overview over MSRP related IETF standards.
Figure 4.1.2.1: Overview of IETF document concerning NAT-T supported
MSRP-(over-TLS-)over-TCP services, as typically used in SIP-based application
control signalling
The present study will investigate e2ae and e2e security for MSRP
implementations supporting IETF RFC 4975 [6] in combination with IETF RFC 6135
[8] (\"COMEDIA for MSRP\") and either IETF RFC 6714 [9] (\"CEMA for MSRP\") or
draft-ietf-simple-msrp-sessmatch-10 [13].
Scenarios without support of IETF RFC 6135 [8] (e.g. for support of pre-Rel-8
3GPP UEs) should be considered only as an option within the 3GPP H.248
profiles.
### 4.1.3 Scenarios in scope
TLS shall be supported over TCP transport (see IETF RFC 793 [20]). Support of
TLS over other reliable transport protocol e.g. SCTP is not required and thus
not considered as part of eMEDIASEC.
The following scenarios shall be supported as part of eMEDIASEC:
a) TLS to non-TLS interworking for e2ae protection of MSRP-based media:
  * e2ae only applies to the IMS-AGW; application of e2ae security is not visible to the TrGW or MRFP.
  * this corresponds to an MSRP session between an IMS UE with e2ae security applied, towards another IMS UE without e2ae applied or a non-IMS UE or an MRFP;
  * this can also correspond to a local MSRP session with e2ae applied for both UEs, where the figure only depicts a \'half call model\".
Figure 4.1.3.1: TLS (IMS Access Network) to non-TLS (IMS Core Network)
interworking for e2ae protection of MSRP-based media
NOTE 1: Whether the IMS-AGW is MSRP-agnostic or MSRP-aware is explained in a
dedicated clause and thus not depicted in the figure.
NOTE 2: TLS-based protection can also be used inside the core network. In this
case, when e2ae security is used, TLS is established also from the IMS-AGW
towards the IMS Core Network and the two TLS sessions are independent. This
use case is noted not to be in the scope of the stage 2 specification 3GPP TS
33.328 [2] and therefore this use case is also not in the scope of this study.
b) Transparent TLS packets forwarding for e2e protection of MSRP-based media:
  * this corresponds to an MSRP session between an IMS UE and e.g. another IMS or non-IMS UE or an MRFP with e2e security applied;
  * the MGW can be an IMS-AGW or a TrGW.
Figure 4.1.3.2: Transparent TLS packets forwarding for e2e protection of MSRP-
based media
c) TLS to non-TLS interworking for e2e protection of MSRP-based media:
  * the MRFP (conference server) can support TLS for MSRP, i.e. originate/terminate TLS traffic with e2e media security from/to a remote MSRP sender/receiver;
  * the MRFP can also communicate with other remote bearer connection endpoints, with or without e2e media security; if TLS is also used towards other remote endpoints, each TLS session is independent from the other (i.e. different keys).
Figure 4.1.3.3: TLS to non-TLS interworking for e2e protection of MSRP-based
media at the MRFP
In the above scenarios, the IMS UE (with e2ae or e2e security applied) may be
located behind a remote firewall/NAT device. i.e. NAT-Traversal should be
considered.
NOTE 3: Support of NAT traversal (at layers L4/L3) is basically agnostic to
any higher layer (i.e., L4+) security sessions, hence not specific to
eMEDIASEC.
### 4.1.4 MSRP-agnostic vs. MSRP-aware mode
Table 4.1.4-1 shows the eMEDIASEC relevant IETF documents from perspective of
end-to-end connectivity aspects (such as NAT-T), independent of media security
usage or not.
Table 4.1.4-1: MSRP awareness concerning end-to-end user plane connectivity
+-------+-------+-------+-------+-------+-------+-------+-------+ | | Origi | MSRP | Se | MGW | Contr | MSRP | Su | | | nator | c | ssion | needs | oller | r | pport | | | of | lient | mat | to | needs | elays | of | | | TCP | takes | ching | i | to | supp | exte | | | conne | d | at | nsert | m | orted | nsion | | | ction | estin | MSRP | own | odify | | is | | | setup | ation | c | ad | SDP | | negot | | | | ad | lient | dress | path | | iated | | | | dress | be | into | attr | | | | | | for | tween | path | ibute | | | | | | TCP | SDP | in | | | | | | | conne | path | MSRP | | | | | | | ction | and | mes | | | | | | | setup | To | sages | | | | | | | from | -Path | | | | | | | | | in | | | | | | | | | MSRP | | | | | | | | | mes | | | | | | | | | sages | | | | | | | | | inc | | | | | | | | | ludes | | | | | | | | | ad | | | | | | | | | dress | | | | | | | | | i | | | | | | | | | nform | | | | | | | | | ation | | | | | +-------+-------+-------+-------+-------+-------+-------+-------+ | * | SDP | SDP | Yes | Yes | Yes | Yes | - | | _IETF | of | MSRP | | | | | | | RFC | ferer | path | | | | | | | 4975 | | attr | | | | | | | [ | | ibute | | | | | | | 6]__| | | | | | | | | | | | | | | | | |__(MS | | | | | | | | | RP)__| | | | | | | | +-------+-------+-------+-------+-------+-------+-------+-------+ | * | Negot | De | Yes | | | | | |_ IETF | iated | pends | (fal | | | | | | RFC | via | on | lback | | | | | | 6135 | IETF | wh | to | | | | | | \ | RFC | ether | IETF | | | | | | [8]\ | 4145 | other | RFC | | | | | | (A | \ | exten | 4975 | | | | | | ltern | [12] | sions | [6] | | | | | | ative | SDP | below | if | | | | | | conne | setup | are | setup | | | | | | ction | attr | used | attr | | | | | | model | ibute | in | ibute | | | | | | for | | c | is | | | | | | MS | | ombin | mis | | | | | | RP)**| | ation | sing) | | | | | +-------+-------+-------+-------+-------+-------+-------+-------+ | ** | De | SDP | No | No | Yes | Yes | No | | draft | pends | MSRP | | | | | (no | | -ietf | on | path | | | | | i | | -simp | wh | attr | | | | | ntero | | le-ms | ether | ibute | | | | | perab | | rp-se | IETF | | | | | | ility | | ssmat | RFC | | | | | | with | | ch-10 | 4975 | | | | | | IETF | | [1 | [6] | | | | | | RFC | | 3]** | is | | | | | | 4975 | | | used | | | | | | [6] | | **(Se | in | | | | | | MSRP | | ssion | c | | | | | | c | | Mat | ombin | | | | | | lient | | ching | ation | | | | | | if | | U | | | | | | | MSRP | | pdate | | | | | | | un | | for | | | | | | | aware | | MS | | | | | | | MGW | | RP)** | | | | | | | is | | | | | | | | | be | | | | | | | | | tween | | | | | | | | | them) | +-------+-------+-------+-------+-------+-------+-------+-------+ | * | Negot | SDP | Yes | No | No | Yes, | Yes, | | _IETF | iated | c | | | | by | via | | RFC | via | -line | | (Yes | | fal | new | | 6714\ | IETF | and | | if | | lback | SDP | | (CEMA | RFC | m | | fal | | to | CEMA | | for | 4145 | -line | | lback | | IETF | attr | | MSRP) | \ | | | to | | RFC | ibute | | [ | [12] | | | IETF | | 4975 | | | 9]_ * | SDP | | | RFC | | [6] | | | | setup | | | 4975 | | | | | | attr | | | [6] | | | | | | ibute | | | o | | | | | | (Par | | | ccurs | | | | | | allel | | | and | | | | | | usage | | | is | | | | | | of | | | suppo | | | | | | IETF | | | rted) | | | | | | RFC | | | | | | | | | 4975 | | | | | | | | | [6] | | | | | | | | | is | | | | | | | | | man | | | | | | | | | dated | | | | | | | | | ) | | | | | | | +-------+-------+-------+-------+-------+-------+-------+-------+
Based on the assumptions and limitations identified in clause 4.1.2 and the
Table 4.1.4-1, it is concluded that:
a) the IMS-AGW shall support application-agnostic interworking for TLS-based
e2ae scenarios, i.e. transparent forwarding of application (i.e. MSRP) data;
  * this suffices for support of e2ae security of MSRP based media when IETF RFC 6714 [9] or draft-ietf-simple-msrp-sessmatch-10 [13] is supported by both ends (e.g. between Rel-8 onwards IMS UEs);
b) the IMS-AGW may support application-aware interworking for TLS-based e2ae
scenarios, i.e. modifying the Path parameter in application (i.e. MSRP) data:
\- this enables to support e2ae security of MSRP based media when neither IETF
RFC 6714 [9] nor draft-ietf-simple-msrp-sessmatch-10 [13] are supported by
both ends (e.g. interoperation with pre-Rel-8 IMS UEs only supporting IETF RFC
4975 [6].
Besides, the IMS-AGW and TrGW shall support application-agnostic (i.e.
transparent) forwarding of TLS packets for e2e scenarios.
The MRFP is already MSRP aware prior to eMEDIASEC.
## 4.2 Media security for conferencing (BFCP)
### 4.2.1 General design considerations
IMS conferencing concepts and procedures are specified in 3GPP TS 23.228 [3],
3GPP TS 24.147 [21] and 3GPP TS 24.229 [5].
3GPP TS 33.328 [2] specifies IMS media plane security mechanisms for BFCP as
used in IMS conferencing for both e2ae protection and e2e protection.
Integrity and confidentiality protection for BFCP media is achieved by TLS
protection.
The salient points of BFCP based media security are (see 3GPP TS 33.328 [2]
for a comprehensive description):
a) e2ae security shall be supported in the same way as for MSRP (see clause
4.1.1), with only the following differences:
\- e2ae security for BFCP uses individual indications \"e2ae-security for BFCP
supported by the UE\" and \"e2ae-security for BFCP supported by the network\"
during the IMS registration;
\- In the SDP, security for a BFCP media stream is specified by using the
transport \"TCP/TLS/BFCP\".
b) e2e protection of BFCP media may be supported between the IMS UE and MRFP
(conference server) in a similar way as for MSRP-based traffic, i.e. using a
TLS tunnel established with MIKEY-TICKET .
\- 3GPP TS 33.328 [2], Annex G, describes two completely different
conferencing security solutions. One solution is described in G.2 -- this is
the solution that uses SRTP/SDES for RTP based traffic, and does not specify
the usage of TLS for TCP-based traffic (MSRP and BFCP). If a conference server
according to that specific solution would use TLS as described in Annex G.2,
NOTE 3 (shown also in Annex B below), then this is outside of what is
specified by 3GPP for this solution. Consequently, usage of TLS in the context
of the solution described in 3GPP TS 33.328 [2], Annex G.2 should not be part
of the stage 3 specifications.
\- The other conferencing security solution is described in 3GPP TS 33.328
[2], Annex G.3 and uses security with MIKEY-TICKET key management for all
media flows between the UE and conference server. In case of TLS this means
TLS based on shared secret established with MIKEY-TICKET.
### 4.2.2 Assumptions and limitations for BFCP support
BFCP as used for IMS conferencing is supported as specified in 3GPP TS 24.147
[21] and 3GPP TS 24.229 [5], i.e. using:
\- from Rel-7 onwards:
\- the Binary Floor Control Protocol (BFCP) as defined in IETF RFC 4582 [16];
\- the Session Description Protocol (SDP) Format for Binary Floor Control
Protocol (BFCP) Streams as defined in IETF RFC 4583 [17] (mandatory support).
IETF RFC 4583 [17] also enables support of BFCP clients located behind
firewalls by enabling the SIP/SDP level negotiation of the TCP connection
setup direction (by using the IETF RFC 4145 [12] \"a=setup:\" and
\"a=connection:\" SDP attributes).
IETF RFC 4582 [16] and IETF RFC 4583 [17] require that the SDP offerer acts as
the TLS client, the SDP answerer as the TLS server, regardless of its role
(initiator or responder) in the TCP establishment procedure.
IETF RFC 4582 [16]:
> \"Which party, the client or the floor control server, acts as the TLS
> server depends on how the underlying TCP connection is established. For
> example, when the TCP connection is established using an SDP offer/answer
> exchange [7], the answerer (which may be the client or the floor control
> server) always acts as the TLS server.\"
IETF RFC 4583 [17]:
> \"When TLS is used, once the underlying TCP connection is established, the
> answerer acts as the TLS server regardless of its role (passive or active)
> in the TCP establishment procedure.\"
The SDP answerer can be the Conference Server/MRFC (e.g. user calling into a
conference) or the UE (e.g. user getting invited to a conference). As a
result, the IMS-AGW (for e2ae media security) and the Conference Server (for
e2e media security) may act as a TLS server or TLS client, depending on which
entity initiates the SDP Offer.
Figure 4.2.2.1 aims to provide an overview over related IETF standards.
Figure 4.2.2.1: Overview of IETF document concerning NAT-T supported
BFCP-(over-TLS-)over-TCP services, as typically used in SIP-based application
control signalling
The present study will investigate e2ae and e2e security for BFCP
implementations supporting IETF RFC 4582 [16] in combination with IETF RFC
4583 [17] (\"SDP Format for BFCP streams\").
### 4.2.3 Scenarios in scope
The same scenarios and requirements apply for BFCP-based media security as
described for MSRP-based media security in clause 4.1.3, with only the
following differences:
  * this corresponds to a BFCP session between an IMS UE and an MRFP, i.e. and never a session between two UEs;
  * only the IMS UE (with e2ae or e2e security applied) may be located behind a remote firewall/NAT device, i.e. the use case where both peers are behind a NAT is not considered.
I.e. the following BFCP-based media security scenarios shall be supported:
a) TLS to non-TLS interworking for e2ae protection of BFCP-based media (at the
IMS-AGW);
b) Transparent TLS packets forwarding for e2e protection of BFCP-based media
(at the IMS-AGW or TrGW);
c) TLS to non-TLS interworking for e2e protection of BFCP-based media (at the
MRFP).
### 4.2.4 BFCP-agnostic vs. BFCP-aware mode
The IMS-AGW shall support application-agnostic interworking for TLS-based e2ae
scenarios, i.e. transparent forwarding of application (i.e. BFCP) data.
The IMS-AGW and TrGW shall support application-agnostic (i.e. transparent)
forwarding of TLS packets for e2e scenarios.
The MRFP is already BFCP aware prior to eMEDIASEC.
## 4.3 TLS procedures
### 4.3.1 Introduction -- Media/transport security sessions at Mb
The (H.248 controlled IP) bearer is generally comprised by an IP _security
session_ and an underlying TCP-based IP _transport connection_ in case of
media/transport security (at e.g. IMS Mb).
The bearer establishment is divided in the two main phases (Fig. 4.3.1.1) of
(I) _TCP connection establishment_ and (II) _IP security session
establishment_ , particularly in case of connection-oriented transport
protocols (such as TCP) or/and IP bearer path coupled security control
protocols (such as key exchange protocols, TLS).
Figure 4.3.1.1: Successful establishment of IP security sessions (at Mb)
It could be noted:
  * Precondition of (II) IP security session establishment (see clause 4.3.3) is a successfully established IP transport connection (NOTE).
  * Establishment of the (I) TCP connection (see clause 4.4) implies optional NAT traversal (NAT-T) support (see clause 4.4), under the condition of remote NAT devices in the IP bearer path.
NOTE: IETF RFC 793 [20] allows the TCP sender to deliver data already during
the TCP connection establishment phase, which could be a TLS _ClientHello_
message here. The MGW can principally buffer or discard such initial TCP data.
The \"buffer option\" is not recommended due to well-known TCP security attack
scenarios. Thus, the option of \"early\" TLS session establishment can be
supported, but is discouraged due to the indicated security issues, TCP NAT
traversal, etc.
### 4.3.2 H.248 bearer type indication \"TLS\"
The MGW needs to be indicated to apply bearer type \"TLS\" in order to reserve
and prepare TLS resources associated with the H.248 termination or stream
endpoint.
NOTE 1: This procedure is similar to the Q.1950 defined BNC procedure (at Mc /
Mn).
NOTE 2: This indication can be combined with an indication about the
underlying transport protocol and the application protocol (e.g. if the
\"transport\" parameter of the SDP \"m=\"-line is used to encode this
indication).
### 4.3.3 TLS security session establishment
#### 4.3.3.1 TLS client/server role assignment
##### 4.3.3.1.1 General
TLS is a client/server protocol, i.e. there are different state transitioning
behaviours (and hence procedures) at client and server side during the
establishment phase of a TLS security session.
A MGW that terminates the TLS protocol layer (i.e., a TLS endpoint) thus
either needs to be indicated to act as TLS client or TLS server.
Furthermore, TLS is designed to be independent from IP transport protocols
(IETF RFC 5246 [7]) (e.g., TLS-over-TCP, TLS-over-SCTP). Thus, any (if at all)
client/server role usage at IP transport protocol layer is basically
independent of the TLS role usage.
##### 4.3.3.1.2 Application agnostic TLS-over-TCP
Status: there is not yet any signalling element at application control
protocol level for the indication/negotiation of TLS client/server roles
between the two TLS endpoints. The basic RFC for SDP for TLS security session
control (IETF RFC 4572 [14]) is silent on the TLS client/server role
assignments and TLS security session establishment directions.
In the present study it will be assumed for MSRP that the TCP related SDP
\"a=setup\" attribute is used in SIP/SDP signalling to determine the TLS
client and server roles in addition to the TCP client and server roles, see
clause 4.3.3.1.3.
NOTE: IETF RFC 5763 [15] (DTLS-SRTP) uses the IETF RFC 4145 [12] SDP
\"a=setup\" attribute to determine the DTLS client and server roles, has been
quoted as additional argument for this solution, although that RFC is not
applicable for TLS over TCP.
##### 4.3.3.1.3 Application aware scenario \"MSRP-over-TLS-over-TCP\"
MSRP itself is a client/server protocol at application protocol level.
Status: the core RFC for MSRP IETF RFC 4975 [6] describes MSRP-over-TLS usage
and supports a TLS peer-to-peer authentication model (clause 14.4) besides TLS
client/server relationship, but the RFC is lacking information on TLS security
session establishment.
In the present study it will be assumed that the TCP related SDP \"a=setup\"
attribute is used in SIP/SDP signalling to determine the TLS client and server
roles for MSRP in addition to the TCP client and server roles.
NOTE: Clients only supporting MSRP according to RFC IETF RFC 4975 [6] will not
use the SDP \"a=setup\" attribute, but will assign the TCP client role to the
SDP offerer. However, in 3GPP, OMA and GSMA the support of IETF RFC 6135 [8]
(\"COMEDIA for MSRP\") is mandated, and the \"a=setup\" attribute will thus be
used.
IETF RFC 4145 [12] defines a mechanism for using SDP to negotiate whether an
UE is responsible for establishing a TCP connection. Such UE is called
\"active\", while the UE listening for an incoming TCP connection is called
\"passive\". The SDP \"a=setup:\" attribute is used to negotiate the
\"active\" and \"passive\" roles. When UEs are located behind NATs, in order
for TCP connections to traverse such NATs, the TCP connection establishments
need to be initiated by the UE behind the NAT i.e. the UE needs to be
\"active\".
When TLS is used to secure a TCP connection, IETF RFC 4572 [14] defines a
mechanism how to determine TLS roles (TLS client and TLS server), also using
the SDP setup attribute. According to the procedures, the \"active\" UE will
act as TLS client (responsible to send the TLS ClientHello message), and the
\"passive\" UE will act as TLS server.
The result of using the SDP \"a=setup:\" attribute both for negotiating the
TCP role and the TLS role is that it is not possible to negotiate the roles
independently from each other. Hence, if two UEs become \"active\", they will
also both act as TLS clients, and try to establish the TLS association towards
each other. Unfortunately, TLS does not define procedures for handling such
situation, and the TLS association establishment will fail. For that reason, a
TLS B2BUA is needed, meaning it will act as a TLS server towards both UEs.
This will prevent TLS encryption end-to-end, as the TLS B2BUA will have to
decrypt traffic received from one UE, and re-encrypt it before forwarding it
towards the other UE.
Annex D defines a mechanism which removes the need for a TLS B2BUA for the
purpose described above.
##### 4.3.3.1.4 Application aware scenario \"BFCP-over-TLS-over-TCP\"
BFCP itself is a client/server protocol at application protocol level (with
the floor control client and floor control server roles).
IETF RFC 4583 [17] (SDP Format for BFCP Streams) contains an explicit TLS
server role assignment for the SDP answerer in Clause 8; \"_When TLS is used,
once the underlying TCP connection is established, the answerer acts as the
TLS server regardless of its role (passive or active) in the TCP establishment
procedure._ \"
NOTE: IETF RFC 4583 [17] uses the TCP related IETF RFC 4145 [12] SDP
\"a=setup\" attribute only to determine the TCP client and server roles.
The implications of this rule for opposite direction offer-answer
renegotiations while a TLS session is established were clarified by IETF and
3GPP CT WG1 as follows:
> _Unless a new TLS session is negotiated, subsequent SDP offers and answers
> will not impact the previously negotiated TLS roles._
#### 4.3.3.2 Start of TLS security session establishment
There are two fundamental options:
1\. The start of TLS security session establishment is _immediately_ initiated
by the TLS client side as soon as the underlying IP transport connection is
successfully established (i.e., when the local TCP connection endpoint is
transitioned to TCP state \"ESTAB\").\ There are two variants in case of Iq,
Ix and Mp:
\- The MGW notifies firstly the MGC, which then triggers the MGW for TLS
security session establishment (if TLS client side);
\- The MGW autonomously starts TLS security session establishment (if TLS
client side), and optionally notifies additionally the MGC (if requested);
2\. The start of TLS security session establishment is decoupled from the
underlying TCP connection establishment (e.g., TLS establishment might be
principally delayed (by the MGC) versus TCP connection establishment, or TLS
usage could be principally enabled during active communication, i.e. a later
point in time).
See clause 5.1.1.1 concerning the required variant for Rel-12.
### 4.3.4 TLS security session release
#### 4.3.4.1 TLS-to-TCP relations
There are two fundamental combinations, a TLS security session release may
lead also to the release of the underlying TCP transport connection:
1\. Release of TLS plus TCP: normal case, the end-to-end communication service
is terminated.
2\. Release of TLS without TCP, e.g., due to
a. TLS failure scenario (see TLS alert protocol) with immediate TLS session
release;
b. TLS session resumption scenarios;
c. TCP connection reuse.
Option 1 is the supported variant for Rel-12.
#### 4.3.4.2 MGW: stimuli for TLS security session release
The trigger for TLS security session release may origin from multiple sources
from perspective of the MGW, such as the MGC, the remote TLS endpoint, from
the underlying TCP layer, or due to TLS protocol failures.
All options are supported for Rel-12.
### 4.3.5 TLS protocol profile
#### 4.3.5.1 Configuration
The TLS protocol profile (TLS versions, ciphersuites, keys, compression
methods, certificates, supported TLS procedures...) for IMS media plane
security is specified in Annex M of 3GPP TS 33.328 [2].
The IMS-AGW (or MRFP) shall be provisioned with the set of the TLS profile
parameters applicable in the TLS domain. The IMS-AGW shall autonomously
negotiate the TLS protocol configurations with the peer TLS node based on the
locally provisioned parameters.
#### 4.3.5.2 TLS protocol profile awareness at MGC level
Any information about the preferred TLS protocol profile is not signalled at
call control level (via SIP SDP offer/answer). There is the assumption that
the remote TLS endpoint (UE) is compliant to the TLS protocol profile
according to Annex M of 3GPP TS 33.328 [2]. Thus, the TLS session negotiation
procedure (based on TLS handshake protocol), during TLS session establishment,
between the IMS-AGW (or MRFP) and remote UE should not fail due to
inconsistencies with respect to the TLS protocol profile.
Thus, the IMS-ALG (or MRFC) does not need to know or audit the detailed TLS
capabilities of the IMS-AGW (or MRFP), e.g. supported TLS versions,
ciphersuites, etc.
## 4.4 TCP procedures
### 4.4.1 H.248 bearer type indication \"TCP\"
The MGW needs to be indicated to apply bearer type \"TCP\" in order to reserve
and prepare TCP resources associated with the H.248 termination or stream
endpoint.
NOTE 1: This procedure is similar to the Q.1950 defined BNC procedure (at Mc /
Mn).
NOTE 2: This indication can be combined with an indication about the
application protocol (e.g. if the \"transport\" parameter of the SDP
\"m=\"-line is used to encode this indication).
### 4.4.2 TCP connection establishment
#### 4.4.2.1 TCP client/server role assignment
##### 4.4.2.1.1 SIP level negotiation of TCP server and client role by MGC
A MGC (e.g. a MRFC) that controls a MGW that handles TCP streams may need to
determine for each TCP stream
\- if the MGW shall act as TCP client for that TCP stream;
\- if the MGW shall act as TCP server for that TCP stream; or
\- if the MGW shall just forward TCP packets for that TCP stream.
NOTE 1: There are a number of TCP related MGW functions which are not really
dependent on TCP role awareness. E.g., a MGW that only modifies port numbers
(i.e. port translation (PT)) when forwarding TCP packets would be TCP aware
(due to the implicit, TCP specific checksum update), but does not require
information about the TCP client and server role. The MGW just requires
knowing that it can pass TCP connection establishmentrelated TCP packets.
The MGC controlling a MGW that needs to be explicitly configured to act as TCP
client or server uses the IETF RFC 4145 [12] SDP \"a=setup\" attribute in
SIP/SDP signalling to determine the client and server role; if the \"a=setup\"
attribute is omitted by the SDP offerer, the offerer automatically becomes the
TCP client.
MSRP clients only supporting MSRP according to IETF RFC 4975 [6] will not use
the SDP \"a=setup\" attribute, but will assign the TCP client role to the SDP
offerer. However, in 3GPP, OMA and GSMA the support of IETF RFC 6135 [8]
(\"COMEDIA for MSRP\") is mandated, and the \"a=setup\" attribute will thus be
used. According to IETF RFC 6135 [8], the SDP offerer is mandated to use
either the \"actpass\" or \"active\" value of the \"a=setup\" attribute. The
\"holdconn\" value shall not be sent by offerer or answerer.
NOTE 2: The IETF RFC 4145 [12] SDP \"a=connection\" attribute shall not be
used according to IETF RFC 6135 [8].
According to IETF RFC 4583 [17], \"the management of the TCP connection used
to transport BFCP is performed using the \'setup\' and \'connection\' (SDP)
attributes\".
An MGC can either act as SDP offerer or answerer (e.g. an MRF) or, it can
modify and forward SDP (e.g. IBCF, IMS-ALG).
An MGC acting as SDP offerer shall use a=setup \"actpass\" attribute value in
SDP offers in order to allow a remote UA located behind a NAT to send an SDP
answer with an a=setup \"active\" attribute to enable NAT traversal (see also
RFC 6135 [8]). The MGW can thus receive an incoming TCP connection
establishment request packet after the MGC has sent the offer and hence needs
to be prepared to act as TCP server. If the MGC receives a=setup \"passive\"
attribute in the SDP answer, the MGW needs to act as TCP client.
An MGC acting as SDP answerer can determine immediately if the controlled MGW
will need to act as TCP server or client according to the a=setup attribute
related procedures in IETF RFC 4145 [12], except when it receives a=setup
\"holdconn\". For a=setup \"holdconn\", the MGC does not need to request the
MGW to reserve any new resources at this stage.
For an MGC that forwards a received SDP offer and does not modify the a=setup
attribute, the following applies if a new connection is requested in the SDP
offer (by including the connection attribute with value \"new\" or omitting
this attribute):
a) If the MGC receives and forwards an a=setup attribute with value
\"actpass\" in the SDP offer, the attached MGW will need to be prepared to
receive a TCP connection establishment packet at the termination towards the
SDP answerer. The MGW may forward such a received TCP connection establishment
packet on the termination towards the SDP offerer, only modifying IP
addresses, port numbers and checksums (i.e. performing NAPT for TCP).
a1) If the MGC then receives and forwards an a=setup attribute with value
\"active\" in the SDP answer (see Figure 4.4.2.1.1.1):
\- If a TCP connection establishment packet has already been received, and the
attached MGW did not forward that TCP connection establishment packet on the
termination towards the SDP offerer, the MGW shall start a separate TCP
connection establishment on the termination towards the SDP offerer.
> NOTE 3: Starting a separate TCP connection establishment only at this stage
> delays the establishment of the user plane connection.
\- If no TCP connection establishment packet has been received, the attached
MGW will need to continue to be prepared to receive a TCP connection
establishment packet at the termination towards the SDP answerer. The MGW
shall either forward such a received TCP connection establishment packet on
the termination towards the SDP offerer, only modifying IP addresses, port
numbers and checksums (i.e. performing NAPT for TCP), or shall start a
separate TCP connection establishment on the termination towards the SDP
offerer.
> NOTE 4: It may be decided to support only one these possibilities when
> defining H.248 procedures.
>
> NOTE 5: It is more likely that the TCP connection establishment packet is
> being received before the SDP answer, as intermediate SIP entities may need
> to process the message.
a2) If the MGC then receives and forwards an a=setup attribute with value
\"passive\" in the SDP answer (see Figure 4.4.2.1.1.2), the attached MGW will
need to be prepared to receive a TCP connection establishment packet at the
termination towards the SDP offerer. The MGW shall either forward such a
received TCP connection establishment packet on the termination towards the
SDP answerer, only modifying IP addresses, port numbers and checksums (i.e.
performing NAPT for TCP), or shall start a separate TCP connection
establishment on the termination towards the SDP answerer.
> NOTE 6: It may be decided to support only one these possibilities when
> defining H.248 procedures.
>
> NOTE 7: Starting a separate TCP connection establishment may speed up the
> establishment of the user plane connection if e2ae security is applied at
> the corresponding call leg.
a3) If the MGC then receives an a=setup attribute with value \"holdconn\" in
the SDP answer, no TCP connection will be established.
b) If the MGC receives and forwards an a=setup attribute with value \"active\"
in the SDP offer (see Figure 4.4.2.1.1.3), the MGC will receive an a=setup
attribute with value \"passive\" or \"holdconn\" in the SDP answer.
b1) When the MGC has forwarded the SDP answer with the attribute value
\"passive\", the attached MGW will need to be prepared to receive a TCP
connection establishment packet at the termination towards the SDP offerer.
The MGW shall either forward such a received TCP connection establishment
packet on the termination towards the SDP answerer, only modifying IP
addresses, port numbers and checksums (i.e. performing NAPT for TCP), or shall
start a separate TCP connection establishment on the termination towards the
SDP answerer.
> NOTE 8: Starting a separate TCP connection establishment may speed up the
> establishment of the user plane connection if e2ae security is applied at
> the corresponding call leg.
b2) If the MGC receives an a=setup attribute with value \"holdconn\" in the
SDP answer, no TCP connection will be established.
c) If the MGC receives and forwards an a=setup attribute with value
\"passive\" in the SDP offer (see Figure 4.4.2.1.1.4), the attached MGW will
need to be prepared to receive a TCP connection establishment packet at the
termination towards the SDP answerer. The MGW shall forward such a received
TCP connection establishment packet on the termination towards the SDP
offerer, only modifying IP addresses, port numbers and checksums (i.e.
performing NAPT for TCP). The MGC will receive an a=setup attribute with value
\"active\" or \"holdconn\" in the SDP answer.
c1) For value \"active\", no reconfiguration of the MGW is required
c2) For value \"holdconn\", no TCP connection shall be established.
d) If the MGC receives and forwards an a=setup attribute with value
\"holdconn\" in the SDP offer, no TCP connection will be established.
NOTE 9: Value \"passive\" in the SDP offer and value \"holdconn\" are not
applicable for MSRP. They can occur in exceptional cases for BFCP.
An MGC that forwards a received SDP offer and modifies the a=setup attribute,
behaves as described for an SDP answerer at the termination towards the SDP
offerer, and as described for an SDP offerer at the termination towards the
SDP answerer.
NOTE 10: TS 24.229 [5] does not define any IMS-ALG or IBCF procedures to
modify the \"a=setup\" attribute. According to current specifications, those
entities can thus not change the directionality of TCP connection setups
between interconnected SDP offer/answer entities. Updates of TS 24.229 [5]
would be required to enable this behavior.
NOTE 11: Changing the TCP setup direction from \"active\" to \"actpass\" or
\"passive\" at the P-CSCF (IMS-ALG) serving the answerer might enable direct
MSRP communication (without a server) between two peers behind firewalls (see
Figure 4.4.2.1.1.5). However, e2e security will not work, as the TLS setup
direction is also negotiated with the a=setup SDP attribute (see clause
4.3.3.1.3).
Figure 4.4.2.1.1.1: TCP connection setup when \"actpass\" is offered and
answerer selects \"active\"
Figure 4.4.2.1.1.2: TCP connection setup when \"actpass\" is offered and
answerer selects \"passive\"
Figure 4.4.2.1.1.3: TCP connection setup when \"active\" is offered
Figure 4.4.2.1.1.4: TCP connection setup when \"passive\" is offered
Figure 4.4.2.1.1.5: TCP connection setup when IMS-ALG changes setup direction
##### 4.4.2.1.2 H.248 control of TCP connection establishment at MGC by MGW
TCP is a client/server protocol, i.e. there are different state transitioning
behaviours (and hence procedures, called TCP OPEN) at client and server side
during the establishment phase of a TCP transport connection. Figure
4.4.2.1.2.1 illustrates principle involvement of the MGW in the end-to-end TCP
connection. The remote TCP endpoints X and Y provide client or server role
assignments, whereas the MGW local terminations are involved in TCP at
different levels (e.g. dependent on TCP modes \"relay\", \"merge\" and
\"proxy\", see ITU-T Recommendation H.248.84 [24] and H.248.89 [36]).
Figure 4.4.2.1.2.1: MGW: TCP to TCP interworking
In sub clause 4.4.2.1.1, the potential need for the following interactions
between MGC and MGW has been identified:
1\. Reserving TCP terminations and requesting related IP addresses and port
numbers;
2\. Prepare a termination to receive an incoming TCP connection establishment
(TCP SYN);
3\. Request that a TCP connection establishment (TCP SYN) is sent on a
termination (outgoing TCP connection establishment);
4\. Allow sending a TCP connection establishment request;
5\. Request a MGW to perform TCP state aware handling according to TCP proxy
mode (rather than forwarding TCP packets, only modifying their port numbers
and checksums as legacy implementations do);
6\. Indicate to a MGW whether to use TCP connection establishment requests
(TCP SYN) received at one termination as a trigger to send TCP connection
establishment on the other termination in the same context.
However, interactions 1 and 2 can be combined: Any new TCP termination is
immediately prepared to receive an incoming TCP connection establishment (TCP
SYN).
Only for a delayed establishment of the TCP connection to enable a remote
source transport address filtering as described in clause 4.4.2.2,
interactions 1 and 2 are separated. Purpose of initial filtering are security
concerns, but at the cost of likely delayed TCP connection setup as the first
TCP SYN is likely to be received before remote source information is received
in SDP and interaction 2 is triggered; the TCP connection establishment will
proceed as usual after the remote peer repeats sending the TCP SYN (\"which is
normal TCP behaviour\").
Interaction 4 is only required if the MGW decides whether to start a TCP
connection establishment autonomously, rather than waiting for a TCP
connection establishment from the peer termination. However, if the MGC
selects the corresponding option, this interaction is not required and the MGC
can simply send indication 3 to trigger the MGW to send a TCP connection
establishment request. However, the MGW may need to check when receiving
interaction 3 if it already sent a TCP connection establishment before (if the
MGW autonomously forwards TCP connection establishment requests).
As an alternative to interaction 6, this behavior could be based on H.248
profile (by defining default values for provisioned H.248 signalling
elements):
\- For an intermediate MGC (e.g. IBCF, IMS/ALG) that forwards a received SDP
offer without modifying the a=setup attribute, an attached MGW (TrGW/AGW) that
uses the TCP connection establishment requests (TCP SYN) received at one
termination as a trigger to send TCP connection establishment at another
termination in the same context is advantageous, as it allows to speed up TCP
connection establishment and allows for a MGW that does not require TCP role
awareness. This is also the expected behavior for the current versions of the
Ix and Iq profiles.
\- An MGC that interworks several call legs and acts independently as SDP
offerer or answerer towards them (e.g. MRFC), requires a MGW that does not
autonomously forward received TCP connection establishment requests.
NOTE: An H.248 profile may specify a predefined behaviour by defining default
values for provisioned H.248 signalling elements. H.248 profiles are not
allowed to modify the semantic and syntax of H.248 information elements.
Should the IMS-ALG or IBCF procedures in TS 24.229 [5] be enhanced to allow a
modification of the \"a=setup\" attribute, the IBCF, IMS/ALG behavior could
either be changed not to allow a dynamic forwarding, or a signalling
interaction could be used.
The following H.248 signalling indications are agreed to be required:
1\. Reserving TCP terminations and requesting related IP addresses and port
numbers. The termination shall be prepared to receive an incoming TCP
connection establishment (TCP SYN).
2\. Request that a TCP connection establishment (TCP SYN) is sent on a
termination.
3\. Only for Ix and Iq: Request a MGW to perform TCP state aware handling
according to TCP proxy mode.
4\. Optional for MGC and MGW to support, and only for Ix and Iq: Indicate to a
MGW whether to use TCP connection establishment requests (TCP SYN) received at
one termination as a trigger to send TCP connection establishment on the other
termination in the same context.
5\. Optional for MGC and MGW to support, and only for Ix and Iq: Reserving TCP
terminations and requesting related IP addresses and port numbers. The
termination shall ignore any incoming TCP connection establishment (TCP SYN).
6\. Optional for MGC and MGW to support, and only for Ix and Iq: Indicate to
the MGW to accept incoming TCP connection establishment (TCP SYN) only from
indicated remote address.
#### 4.4.2.2 Start of TCP connection establishment
There are inherent different establishment scenarios for each TCP endpoint,
primarily due to its properties of connection-orientation and client/server
asymmetry. The different TCP establishment steps follow different state
transitioning scenarios (TCP passive open, active open, simultaneous), see
IETF RFC 793 [20].
The MGC controls the start of TCP connection establishment (see clause
4.4.2.1). The start is normally tightly coupled to the creation of local TCP
resources (i.e., the first ADD.req command), but could be also delayed (i.e.,
a subsequent MODify.req cycle), e.g. in order
\- to address possible TCP security attack scenarios (e.g. source port
filtering is only possible once the remote address information has been
received in SDP),
NOTE 1: Filtering of remote source transport addresses is supported at the Ix
and Iq interface, but not at the Mp interface.
\- to support a resource management concept in separating the reservation and
preparation phase of local TCP resources from the phase of TCP connection
establishment, or/and
NOTE 2: SIP level SDP offer/answer procedures might be decoupled from gateway
control procedures.
NOTE 3: The \"two-stage resource reservation\" procedures as defined by ETSI
TS 183 018 [22], clause 5.17.1.11, could be principally applied.
\- to support NAT-T scenarios (due to end-to-end TCP connectivity aspects).
NOTE 4: Example, a H.248 connection model with two TCP enabled stream
endpoints. The start of TCP connection establishment at one termination shall
be delayed as long as a parallel L3/L4 NAT-T procedure at the other
termination is ongoing.
Delayed TCP connection establishment has the disadvantage that the TCP
connection setup is frequently delayed until the remote repeats sending the
TCP SYN (when the first TCP SYN is dropped). However, delayed establishment
should not jeopardize finally a successful call due to the timing framework of
the concerned TCP-based communication services (instant messaging, conference
control).
The following procedures are supported for Rel-12:
\- immediate TCP connection establishment is mandatory to support;
\- delayed TCP connection establishment (i.e. indicating to the MGW to reserve
TCP terminations but ignore any incoming TCP connection establishment, and, at
a later stage indicate to the MGW to accept incoming TCP connection
establishment (TCP SYN) only from indicated remote address) is optional to
support and only applicable for the Ix and Iq interfaces.
#### 4.4.2.3 L3/L4 level NAT traversal support
In order to reach end-to-end TCP connectivity, remote NAT traversal (NAT-T)
support by the MGW might be required. The two major L3/L4 NAT-T mechanisms for
TCP (from H.248 MGW perspective) are:
1\. _Latching_ on remote IP source transport address information (according
ITU-T H.248.37 [23]); and
2\. support of simultaneous opening of TCP connection by both interconnected
peers (see e.g. TCP merge mode according ITU-T H.248.84 [24]).
Both NAT-T variants may be applied individually or combined. The dedicated
usage is dependent on a number of service and network properties, such as
\- existence and position of remote NAT devices in the media plane;
\- single or multiple NAT devices;
\- type of remote NAT devices (e.g., the distinction between \"BEHAVE-
compliant\" and \"legacy\" types by IETF WG BEHAVE);
NOTE 1: IETF working group BEHAVE (_Behaviour Engineering for Hindrance
Avoidance_ , see http://tools.ietf.org/wg/behave/ )
\- the level of information by the MGC about the media plane \"NAT
architecture\"; and
\- end-to-end application control.
NOTE 2: It has to be noted that above information reflects the status of
Rel-12 only. E.g., the IMS firewall traversal studies by 3GPP TR 33.830 [25],
future media multiplexing models, additional support of ICE-based NAT-T (see
3GPP TS 23.228 [3] Annex G), bearer-level application gateway support, etc.
may demand for further NAT-T capabilities in future 3GPP releases.
Procedures for the support of simultaneous opening of TCP connection by both
interconnected peers are documented in:
\- clause 4.4.2.1.1 and specifically in Figure 4.4.2.1.1.5 (TCP connection
setup when IMS-ALG changes the setup direction); this includes corresponding
procedures updates for the IMS-ALG to modify the \"a=setup\" attribute to
change the directionality of TCP connection setups between interconnected SDP
O/A entities;
\- clause 4.4.4 (TCP Interworking in the MGW, i.e. merging the two TCP
connection establishment requests in the MGW).
Latching enables a TCP client behind a remote NAT to establish a TCP
connection with a MGW. The TCP client behind the NAT needs to establish the
TCP connection.
Simultaneous opening of TCP connection by both interconnected peers enables
end-to-end communication between two peers located behind remote NATs. This is
of interest for MSRP, but not for BFCP, as BFCP is only used from a client
towards a server in the network. However, MSRP is also frequently used between
a client and a server.
Simultaneous opening of TCP connection by both interconnected peers cannot be
used for end-to-end media security for MSRP unless related issues outlined in
clause 4.3.3.1.3 are resolved.
Simultaneous opening of TCP connection by both interconnected peers is only
possible if the a=setup SDP attribute is modified by the controller.
It is agreed to support the simultaneous opening of TCP connection by both
interconnected peers as an optional feature for the IMS-ALG and IMS-AGW at the
H.248 Iq profile for Rel-12. This requires support of the new following
capabilities:
\- the IMS-ALG may support changing the TCP setups direction for NAT traversal
between two UEs located behind remote firewall/NATs;
\- the IMS-AGW may support receiving TCP connection establishment requests
from both sides;
\- the IMS-AGW may support merging the two TCP connection establishment
requests.
NOTE 3: Latching on remote IP source transport address information is already
supported by the H.248 Iq profile.
### 4.4.3 TCP connection release
#### 4.4.3.1 TLS-to-TCP relations
There are TCP connection segments with and without TLS from MGW perspective.
The overlying TLS protocol (in case of H.248 TLS/TCP stream
endpoint/termination) may impact TCP connection release, see clause 4.3.4.1.
#### 4.4.3.2 MGW: stimuli for TCP connection release
The trigger for TCP connection release may origin from multiple sources from
perspective of the MGW, such as the MGC, the remote TCP endpoint and the
overlying TLS endpoint.
### 4.4.4 TCP Interworking in the MGW
The previous clause focuses on aspects of single TCP-enabled stream endpoints
(so called \"half call\" model), i.e. from perspective of the MGW on the
external bearer interface. IMS H.248 profiles support following connection
models at IP layer:
\- Ix: (IP, IP);
\- Iq: (IP, IP) and (IP, IP, IP);
NOTE 1: See connection models in clause 5.4 in 3GPP TS 29.334 [35]. The (TCP,
TCP, TCP) is not applicable to the PS-CS access transfer function (because
only supporting RTP-based media).
\- Mp: (IP), (IP, IP) and (IP, IP, IP).
NOTE 2: The single IP termination model is not used for the TCP-based
applications in scope of this TR. Thus, the (TCP) connection model as well is
out of scope.
which relates to (TCP, TCP) and (TCP, TCP, TCP) connection models.
There is consequently MGW internal interworking function between the TCP
enabled stream endpoints. There are some high level TCP interworking models
defined in ITU-T Recommendation H.248.84 [24] and draft ITU-T Recommendation
H.248.89 [36]: TCP relay, TCP merge and TCP proxy mode, which provide a
possible characterization of principal behaviour to be provided by the MGW.
All three TCP modes are applicable for the (TCP, TCP) connection model,
whereas (TCP, TCP, TCP) interconnection implies the TCP proxy mode (see clause
13.3.1 in ITU-T H.248.84 [24]).The MGW behaviour (i.e. TCP mode) could be the
same or different during the establishment and data transfer phase (e.g., an
initial TCP merge mode could become a TCP relay mode).
A primary concern is TCP flow control handling (by the MGW) during the active
TCP data transfer phase, due to its cost factor in terms of MGW resources
(memory, CPU time), control complexity (e.g., sliding window algorithms) and
performance impact (e.g., TCP transfer delay). It is therefore desirable that
a MGW interconnecting two TCP terminations (or TCP-enabled stream endpoints)
forwards TCP flow control related information between the terminations in
order to avoid negative impacts on the end-to-end TCP throughput, and to avoid
delays caused by buffering of TCP payloads. The details of related procedures
can be left to the MGW implementation.
A MGW that only modifies IP addresses, port numbers and performs the
corresponding TCP checksum update when forwarding TCP packets (i.e. that
provides NAPT for TCP) has no impact on TCP flow control and has only minimal
MGW resource requirements. This mode of operation (that relates to the TCP
relay mode) should be enabled when possible.
However, for an IMS‑AGW that performs e2ae security, this mode of operation is
not possible (the TCP \"proxy\" mode may be appropriate instead):
\- On the access side, a TLS handshake needs to be performed once the TCP
connection is established. This requires the exchange of extra TCP packets to
transport the TLS handshake on the access side. Further, payload data received
on the core network side while the TLS handshake is not yet completed need to
be buffered.
\- The TLS encryption adds an extra TLS header to the TCP payload. Unencrypted
payload data received on the core network termination in IP packets with
maximum allowed size thus may need to be fragmented.
In the following, impacts of changing the TCP setup direction at an IMS‑AGW
that does not perform e2ae security (compare to clause 4.4.2.1.1) will be
investigated. Changing the TCP setup direction from \"active\" to \"actpass\"
or to \"passive\" at the P‑CSCF (IMS‑ALG) serving the answerer might enable
direct MSRP communication (without a server) between two peers behind
firewalls. In this scenario, the IMS‑AGW needs to receive incoming TCP
connection requests (TCP SYN) on both terminations (see figure 4.4.2.1.1.5).
The normal TCP connection establishment call flow is depicted in figure 7 of
IETF RFC 793 [20]:
TCP A TCP B
1\. CLOSED LISTEN
2\. SYN-SENT --> \\ \--> SYN-RECEIVED
3\. ESTABLISHED \\\ \ \\\ \--> ESTABLISHED
5\. ESTABLISHED --> \\\\ \--> ESTABLISHED
Basic 3-Way Handshake for Connection Synchronization
TCP also allows simultaneous connection establishment attempts by both peers,
as depicted in figure 8 of IETF RFC 793 [20] (this could support NAT
traversal, see IETF RFC 5128 [37]): clause 3.4 on \"TCP hole punching\"):
TCP A TCP B
1\. CLOSED CLOSED
2\. SYN-SENT --> \\ ...
3\. SYN-RECEIVED \\ \\ \--> SYN-RECEIVED
5\. SYN-RECEIVED --> \\\ ...
6\. ESTABLISHED \\\ \\\ \--> ESTABLISHED
Simultaneous Connection Synchronization
A simple implementation of the IMS‑AGW could rely on the TCP procedures to
handle simultaneous connection setups: when receiving the first TCP SYN at one
termination, the IMS‑AGW waits to receive the TCP SYN at the other termination
in the same context and then forwards both TCP SYN requests at the opposite
terminations, using the source IP addresses and TCP ports of the TCP SYN
requests received at each termination as destination for the TCP SYN request
sent at the same termination. From that point onward, the IMS‑AGW can forward
all TCP packets.
NOTE 3: The TCP relay mode (which is by default the mode supported so far in
the 3GPP IMS H.248 profiles) would possibly allow the simultaneous connection
setups to be resolved by the e2e peers themselves without the MGW intervening
in that process. This approach may however not always work reliably for the
reasons explained in IETF RFC 5128 [37] clause 3.4. The TCP merge mode
provides a higher service reliability and performance.
Alternative implementations could perform a separate TCP three-way handshake
on both terminations, but try to forward subsequent TCP packets, adjusting
their sequence numbers. However, if data are received at one termination
before the TCP connection establishment is completed at the opposite
termination, those data will need to be buffered.
NOTE 4: If the receipt of the data is acknowledged on each call leg
separately, there is a risk that flow control mechanisms at both call legs
will come out of synch.
## 4.5 MGC information baseline for gateway control decisions
The SIP/SDP signalling provides the primary information for gateway control
decisions (H.248 signalling) by the MGC. Additional MGC-local policies may
provide complementary information for TCP (and TLS) bearer control.
## 4.6 Media security for T.38 fax over UDPTL/UDP transport
### 4.6.1 General design considerations
Facsimile over IP (FoIP) transmission is transported over the UDPTL/UDP
transport in IMS, as specified in Annex L of 3GPP TS 26.114 [27].
3GPP TS 33.328 [2] specifies IMS media plane security mechanisms for T.38 fax
over UDPTL/UDP transport (see ITU-T Recommendation T.38 [26]) for e2ae
protection.
The salient points of T.38 based media security are (see 3GPP TS 33.328 [2]
for a comprehensive description):
a) e2ae security shall be supported in the same way as for MSRP (see clause
4.1.1), with the following differences:
\- e2ae security for T.38 fax uses individual indications \"e2ae-security for
T.38 supported by the UE\" and \"e2ae-security for T.38 supported by the
network\" during the IMS registration;
\- DTLS (see IETF RFC 6347 [28]) is used instead of TLS for confidentiality
and integrity protection. In the SIP/SDP, security for a T.38 media stream is
specified by using the transport \"UDP/TLS/UDPTL\"; the usage of UDPTL over
DTLS is defined in IETF RFC 7345 [29].
### 4.6.2 Assumptions and limitations for T.38 fax support
#### 4.6.2.1 T.38 transport
Facsimile over IP (FoIP) transmission is supported as specified in Annex L of
3GPP TS 26.114 [27], over the UDPTL/UDP transport. Support of FoIP over other
T.38 transport modes (e.g. based on TCP or RTP) is not required and thus not
considered as part of eMEDIASEC.
#### 4.6.2.2 Establishment directions of SIP session and DTLS session
The SDP offerer/answerer role and the DTLS client/server role are basically
decoupled (in IETF).
IETF RFC 7345 [29]:
\"_The offerer SHOULD assign the SDP \"setup\" attribute with a value of
\"actpass\", unless the offerer insists on being either the sender or receiver
of the DTLS ClientHello message, in which case the offerer can use either a
value of \"active\" (the offerer will be the sender of ClientHello) or
\"passive\" (the offerer will be the receiver of ClientHello). The offerer
MUST NOT assign an SDP \"setup\" attribute with a \"holdconn\" value. If the
offerer assigns the SDP \"setup\" attribute with a value of \"actpass\" or
\"passive\", the offerer MUST be prepared to receive a DTLS ClientHello
message before it receives the SDP answer.\ If the answerer accepts the
offered UDPTL over DTLS transport connection, in the associated SDP answer the
answerer MUST assign an SDP \"setup\" attribute with a value of either
\"active\" or \"passive\", according to the procedures in [RFC4145]. The
answerer MUST NOT assign an SDP \"setup\" attribute with a value of
\"holdconn\". If the answerer assigns an SDP \"setup\" attribute with a value
of \"active\" value, the answerer MUST initiate a DTLS handshake by sending a
DTLS ClientHello message on the negotiated media stream, towards the IP
address and port of the offerer._ \"
IETF RFC 7345 [29] mandates the SIP/SDP level negotiation of the entity that
shall initiate the DTLS handshake (by using the IETF RFC 4145 [12] \"a=setup\"
SDP attribute). The SDP offerer should request the SDP answerer to provide the
DTLS client/server role assignment or it could select the DTLS client role or
the DTLS server role.
The SDP answerer can be the UE (UE terminated FoIP session) or the IMS-AGW (UE
originated FoIP session). As a result, the IMS-AGW may act as a DTLS server or
client.
#### 4.6.2.3 Framework for e2ae security
The present study investigates e2ae security for FoIP implementations
supporting DTLS per IETF RFC 6347 [28] in combination with IETF RFC 7345 [29].
### 4.6.3 Scenarios in scope
There are always two _T.38 endpoints_ (i.e. T.38 protocol terminations)
involved either located in IP terminals or IP gateways. T.38 endpoints use
either \"UDPTL/DTLS/UDP\" or \"UDPTL/UDP\" transport.
The following scenarios shall be supported as part of eMEDIASEC:
a) DTLS to non-DTLS interworking for e2ae protection of T.38-based media:
  * e2ae only applies to the IMS-AGW; application of e2ae security is not visible to the TrGW or IM-MGW.\ The IMS-AGW does not provide any T.38 endpoint function, only an interworking function below the UDPTL layer;
  * the primary use case corresponds to a T.38 fax session between an IMS UE with e2ae security applied, towards/from:
1) an IM-MGW (remote PSTN/CS fax);
2) a TrGW (the remote T.38 endpoint is located behind the TrGW in another IP
network);
3) it might possibly be towards another IMS (or non-IMS) UE without e2ae
applied but this scenario is not common.
Figure 4.6.3.1: DTLS (IMS Access Network) to non-DTLS (IMS Core Network)
interworking for e2ae protection of T.38-based media
### 4.6.4 Consideration of application awareness of IMS-AGW
The required IMS-AGW behaviour in all scenarios of clause 4.6.3 relates to an
\"_application-agnostic_ packet processing\", i.e., the IMS-AGW shall be
unaware of the application protocol carried by DTLS (for terminations with
transport security) and by UDP (for terminations without transport security).
Any indication of facsimile protocols (such as \"UDPTL\") is not required and
should be avoided.
The following SDP \"proto\" field values are required for the two H.248
terminations:
\- for e2ae: \"UDP/DTLS\" and \"udp\".
Editor\'s Note: The IANA registry is lacking so far an entry for \"UDP/DTLS\".
The effort of such an IANA registry request is still in work, see IETF draft-
schwarz-mmusic-sdp-for-gw [45].
# 5 IMS-ALG/ IMS-AGW interface (Iq)
## 5.1 Requirements
### 5.1.1 End-to-access edge security for TCP-based media using TLS
#### 5.1.1.1 General requirements
#### 5.1.1.2 Specific requirements for session based messaging (MSRP)
##### 5.1.1.2.1 General
TLS is used to protect MSRP based traffic. Key management for e2ae protection
of MSRP relies on exchanging certificates and transmission of the fingerprints
of these certificates over SIP (SDP). For IMS session based messaging traffic,
the IMS-AGW shall send TLS protected MSRP packets to and accept TLS protected
MSRP packets from the served UE as requested by the IMS-ALG. The IMS-AGW shall
send MSRP packets to and accept MSRP packets from the network.
##### 5.1.1.2.2 Certificate fingerprints based solution for TLS and key
management
According to 3GPP TS 33.328 [2], the key management solution for e2ae
protection of MSRP based media is based on the ciphersuites and session keys
negotiated via the TLS handshake protocol between the UE and the IMS-AGW. The
TLS protocol secures the actual media.
The key management mechanism for e2ae protection of MSRP traffic shall be
based on certificates and the transmission of certificate fingerprints as
defined in IETF RFC 4975 [6].
##### 5.1.1.2.3 Mutual authentication and authorization of TLS endpoints
Mutual authentication during the TLS handshake is achieved using certificates,
with the certificate fingerprints being transmitted using the SDP fingerprint
attribute in the SDP offer-answer exchange between the UE and the P-CSCF (IMS
ALG).
This approach is specified in IETF RFC 4975 [6]. \"TCP/TLS/MSRP\" is used as
the protocol identifier in the m-line of the SDP, and the \"a=fingerprint\"
attribute is used to provide the fingerprint of the certificate.
Mutual authentication between the IMS UE and the IMS-AGW relies on secure
transport of certificate fingerprints using SIP signalling integrity
protection. If the fingerprints of the certificates used for the TLS handshake
match the fingerprints transmitted via SIP signalling, then the TLS endpoints
can be sure that TLS is really established between the nodes that exchanged
the SIP signalling.
##### 5.1.1.2.4 Functional extension of the Iq interface for e2ae protection
for MSRP
For each MSRP media stream to be set-up with e2ae security the P-CSCF (IMS-
ALG) shall:
\- always include the IMS-AGW in the media path and allocate the required
resources for the media stream in the IMS-AGW;
\- request a certificate fingerprint from the IMS-AGW;
\- include the certificate fingerprint received from the IMS-AGW in the SDP it
sends to the IMS UE;
\- send the certificate fingerprint received in the SDP from the IMS UE (as
described in IETF RFC 4975 [6]) to the IMS-AGW;
\- determine via SDP negotiation if the IMS‑AGW needs to act as TLS client or
TLS server using the IETF RFC 4145 [12] \"a=setup\" SDP attribute as follows:
\- if the IMS‑ALG send an \"a=setup:active\" SDP attribute in an SDP answer
towards the UE, the IMS‑AGW shall act as TLS client;
\- if the IMS‑ALG send an \"a=setup:passive\" SDP attribute in an SDP answer
towards the UE, the IMS‑AGW shall act as TLS server;
\- if the IMS‑ALG receives an \"a=setup:active\" SDP attribute in an SDP
answer from the UE, the IMS‑AGW shall act as TLS server;
\- if the IMS‑ALG receives an \"a=setup:passive\" SDP attribute in an SDP
answer from the UE, the IMS‑AGW shall act as TLS client;
NOTE: Clients only supporting MSRP according to IETF RFC 4975 [6] will not use
the SDP \"a=setup\" attribute, but will assign the TLS client role to the SDP
offerer. However, in 3GPP, OMA and GSMA the support of IETF RFC 6135 [8] is
mandated, and the \"a=setup\" attribute will thus be used.
\- if the IMS‑AGW needs to act as TLS client, instruct the IMS‑AGW to start
the TLS session establishment once the TCP connection is established towards
the UE;- indicate that transport \"TCP/TLS/MSRP\" (for application-aware MSRP
interworking) or \"TCP/TLS\" (for application-agnostic interworking) is used
for the access termination;
\- indicate that transport \"TCP/MSRP\" (for application-aware interworking)
or \"TCP\" (for application-agnostic interworking) is used for the core
termination;
\- instruct the IMS-AGW to perform state-aware TCP handling by including
information about the TCP setup direction;
\- determine via SDP negotiation using the IETF RFC 4145 [12] \"a=setup\" SDP
attribute if the IMS‑AGW needs to act as TCP client or TCP server for the
terminations towards the core network and towards the access network.
\- indicate to the IMS-AGW how to perform the TCP connection establishment by:
\- either instructing the IMS‑AGW to start a TCP connection establishment on
any terminations where it needs to act as TCP client; or
\- indicating to the IMS‑AGW to use an incoming TCP connection establishment
request at one termination as a trigger to send a TCP connection establishment
request at the interconnected termination in the same context (support of this
alternative is optional for the IMS-AGW and IMS‑ALG).
For each MSRP media stream to be set-up with e2ae security the IMS-AGW shall:
\- upon request from the IMS-ALG, select an own certificate for the media
stream, uniquely associate its own certificate with the media stream, and send
the fingerprint of its own certificate to the IMS-ALG;
\- uniquely associate the certificate fingerprint received from the IMS‑ALG
with the corresponding MSRP media stream and subsequently use the certificate
fingerprint (as described in IETF RFC 4975 [6]) to verify the establishment of
the TLS session of the corresponding media stream to belong to the served
user;
\- if the verification of the remote certificate fingerprint during the TLS
session establishment fails, regard the remote TLS endpoint as not
authenticated, terminate the TLS session and report the unsuccessful TLS
session setup to the IMS-ALG;
\- negotiate the TLS protocol configurations with the TLS peer based on
locally provisioned TLS profile parameters;
\- when the TLS session has been established, convert unprotected MSRP packets
to protected MSRP packets and vice versa;
\- send the protected MSRP packets to the UE and receive protected MSRP
packets from the UE, as described in clause 5.2;
\- be capable to support both the TLS server and TLS client roles;
\- when being instructed to start the TLS session setup, act as a TLS client
and establish the TLS session as soon as the underlying TCP bearer connection
is established.
\- release the underlying TCP bearer connection as soon as the TLS session is
released
\- upon instruction of the IMS-ALG to perform state-aware TCP handling, not
forward any TCP establishment request received on one termination towards the
interconnected termination.
\- upon corresponding instructions from the IMS‑ALG, start a TCP connection
establishment on the indicated termination by sending a TCP SYN.
\- upon corresponding instruction from the IMS‑ALG, use an incoming TCP
connection establishment request at one termination as trigger to send a TCP
connection establishment request at the interconnected termination in the same
context (support is optional for the IMS-AGW).
##### 5.1.1.2.5 Specific MSRP based media e2ae protection requirements for
IMS-ALG
The \"mediasec\" header field parameter may be used in the Security-Client,
Security-Server, or Security-Verify header fields defined in IETF RFC 3329
[38] to indicate that a header field applies to the media plane. To support
end-to-access-edge media security for MSRP using TLS and certificate
fingerprints, the P-CSCF (IMS-ALG) is required to support msrp-tls-name =
\"msrp-tls\"; End-to-access-edge media security for MSRP using TLS and
certificate fingerprints, as specified in 3GPP TS 24.229 [5] clause 7.2A.7.
If the P-CSCF indicated support for the end-to-access-edge media security for
MSRP using TLS and certificate fingerprints during registration under the
conditions specified in 3GPP TS 24.229 [5], the P-CSCF (IMS-ALG) shall strip
the SDP \"a=3ge2ae:requested\" attribute and the SDP fingerprint attribute
from the end-to-access-edge protected MSRP based media of the received SDP
offer.
Upon sending an SDP answer to the SDP offer from the served UE, for each end-
to-access-edge protected MSRP based media of the SDP offer from the served UE
which is accepted in the SDP answer, the P-CSCF shall:
\- indicate the MSRP over TLS transport protocol according to IETF RFC 4975
[6], IETF RFC 6714 [9] and the TLS profile defined in 3GPP TS 33.328 [2]; and
\- include the SDP fingerprint attribute according to IETF RFC 4572 [14] and
the TLS profile defined in 3GPP TS 33.328 [2].
If the served UE indicated support for the end-to-access-edge media security
for MSRP using TLS and certificate fingerprints during registration, and the
P-CSCF indicated support for the end-to-access-edge media security for MSRP
using TLS and certificate fingerprints during registration,
1) upon receiving an SDP offer from remote user with an MSRP based media, for
each end-to-access-edge protected MSRP based media, i.e. an MSRP based media
except those for which the result of the SDP offer / answer exchange results
in the application of an end-to-end security mechanism, the P-CSCF (IMS-ALG)
shall remove any SDP fingerprint attribute, offer MSRP over TLS transport
protocol according to IETF RFC 4975 [6], IETF RFC 6714 [9] and the profile
defined in 3GPP TS 33.328 [2], include the SDP fingerprint attribute according
to IETF RFC 4572 [14] and the profile defined in 3GPP TS 33.328 [2], include
the SDP \"a=3ge2ae:applied\" attribute and
2) upon receiving an SDP answer to the SDP offer from remote user, for each
accepted end-to-access-edge protected MSRP based media, the P-CSCF shall
remove the SDP fingerprint attribute.
#### 5.1.1.3 Specific requirements for conferencing (BFCP)
##### 5.1.1.3.1 General
A conference server may send and receive cryptographically protected media
streams to and from participants as specified in 3GPP TS 33.328 [2].
Once the conference URI has been created, the participants (including the
conference creator himself) join the conference using one of the methods
specified in 3GPP TS 24.147 [21].
##### 5.1.1.3.2 Security for conferencing based on SIP signalling security
When participating in conferences, IMS UEs may use e2ae security for MSRP, as
specified in 3GPP TS 33.328 [2] and/or for BFCP, as specified in the
following.
For BFCP that may be used in conferences, e2ae security shall be supported in
the same way as for MSRP with only the following differences:
1) e2ae security for BFCP uses individual indications \"e2ae-security for BFCP
supported by the UE\" and \"e2ae-security for BFCP supported by the network\"
during registration. The syntax is to be defined in 3GPP TS 23.334 [34].
2) In SDP, security for a BFCP media stream is specified by using the
transport \"TCP/TLS/BFCP\".
##### 5.1.1.3.3 Specific BFCP based media e2ae protection requirements for
IMS-ALG.
The \"mediasec\" header field parameter may be used in the Security-Client,
Security-Server, or Security-Verify header fields defined in IETF RFC 3329
[38] to indicate that a header field applies to the media plane. To support
end-to-access-edge media security for BFCP using TLS and certificate
fingerprints, the IMS-ALG is required to support bfcp-tls-name = \"bfcp-tls\"
; End-to-access-edge media security for BFCP using TLS and certificate
fingerprints, as specified in specified in 3GPP TS 24.229 [5] clause 7.2A.7.
If the P-CSCF indicated support for the end-to-access-edge media security for
BFCP using TLS and certificate fingerprints during registration under the
conditions specified in 3GPP TS 24.229 [5], the P-CSCF (IMS-ALG) shall strip
the SDP \"a=3ge2ae:requested\" attribute and the SDP fingerprint attribute
from the BFCP based media of the received SDP offer.
Upon sending an SDP answer to the SDP offer from the served UE, for each end-
to-access-edge protected BFCP based media of the SDP offer from the served UE
which is accepted in the SDP answer, the P-CSCF (IMS-ALG) shall:
\- indicate the BFCP over TLS transport protocol according to IETF RFC 4583
[17] and the TLS profile defined in 3GPP TS 33.328 [2]; and
\- include the SDP fingerprint attribute according to IETF RFC 4572 [14] and
the TLS profile defined in 3GPP TS 33.328 [2].
If the served UE indicated support for the end-to-access-edge media security
for BFCP using TLS and certificate fingerprints during registration, and the
P-CSCF indicated support for the end-to-access-edge media security for BFCP
using TLS and certificate fingerprints during registration:
1) upon receiving an SDP offer from remote UE with an BFCP based media, for
each end-to-access-edge protected BFCP based media, i.e. a BFCP based media
except those for which the result of the SDP offer / answer exchange results
in the application of an end-to-end security mechanism, the P-CSCF (IMS-ALG)
shall remove any SDP fingerprint attribute, offer BFCP over TLS transport
protocol according to IETF RFC 4583 [17] and the profile defined in 3GPP TS
33.328 [2], include the SDP fingerprint attribute according to IETF RFC 4572
[14] and the profile defined in 3GPP TS 33.328 [2] and include the SDP
\"a=3ge2ae:applied\" attribute and
2) upon receiving an SDP answer to the SDP offer from remote user, for each
accepted end-to-access-edge protected BFCP based media, the P-CSCF (IMS-ALG)
shall remove the SDP fingerprint attribute.
### 5.1.2 End-to-end security for TCP-based media using TLS
#### 5.1.2.1 General requirements
A pre-requisite for support of e2e security is that the TLS message is passed
transparently by any node present in the media path (i.e. TLS transparent
forwarding).
For e2e security protected media sessions, the IMS-ALG shall:
  * at SIP level forward the SDP with unmodified transport protocol;
  * at H.248 level not provide any media related information to the corresponding terminations, indicate only \"TCP\" as transport, and configure the IMS-AGW to pass media.
#### 5.1.2.2 Specific requirements for session based messaging (MSRP)
None.
Editor\'s Note: The scenario where both terminals of an e2e security protected
media session are located behind firewalls/NATs is FFS.
#### 5.1.2.3 Specific requirements for conferencing (BFCP)
None.
### 5.1.3 End-to-access edge security for UDP-based media using DTLS
#### 5.1.3.1 General requirements
T.38 fax using UDPTL/UDP transport shall be secured e2ae between IMS UE and
IMS-AGW by usage of DTLS (IETF RFC 6347 [28]). The transport protocol
identifier \"UDP/TLS/UDPTL\" and the usage of UDPTL over DTLS are defined in
IETF RFC 7345 [29].
The solution leverages IMS control plane security by using self-signed
certificates and exchanging the certificate fingerprints via SIP/SDP. Usage of
the \"P-Asserted-Identity\" header provides secure identification of the other
endpoint. The solution is almost identical to MSRP e2ae security specified in
this document, but uses DTLS instead of TLS for confidentiality and integrity
protection.
#### 5.1.3.2 Specific requirements for T.38 fax over UDPTL/UDP transport
The \"mediasec\" header field parameter may be used in the Security-Client,
Security-Server, or Security-Verify header fields defined in IETF RFC 3329
[38] to indicate that a header field applies to the media plane. To support
end-to-access-edge media security for UDPTL using DTLS and certificate
fingerprints, the IMS-ALG is required to support udptl-dtls-name = \"udptl-
dtls\" ; End-to-access-edge media security for UDPTL using DTLS and
certificate fingerprints, as specified in in 3GPP TS 24.229 [5] clause 7.2A.7.
If the P-CSCF indicated support for the end-to-access-edge media security for
UDPTL over DTLS and certificate fingerprints during registration under the
conditions specified in 3GPP TS 24.229 [5], the P-CSCF (IMS-ALG) shall strip
the SDP \"a=3ge2ae:requested\" attribute and the SDP fingerprint attribute
from the UDPTL based media of the received SDP offer.
Upon sending an SDP answer to the SDP offer from the served UE, for each end-
to-access-edge protected UDPTL based media of the SDP offer from the served UE
which is accepted in the SDP answer, the P-CSCF (IMS-ALG) shall:
\- indicate the UDPTL over DTLS transport protocol according to IETF RFC 7345
[29] and the DTLS profile defined in 3GPP TS 33.328 [2]; and
\- include the SDP fingerprint attribute according to IETF RFC 4572 [14] and
the DTLS profile defined in 3GPP TS 33.328 [2].
NOTE: the DTLS protocol profile is specified by 3GPP SA WG3.
If the served UE indicated support for the end-to-access-edge media security
for UDPTL using DTLS and certificate fingerprints during registration, and the
P-CSCF indicated support for the end-to-access-edge media security for UDPTL
using DTLS and certificate fingerprints during registration:
1) upon receiving an SDP offer from remote UE with an UDPTL based media, for
each end-to-access-edge protected UDPTL based media, i.e. a UDPTL based media
except those for which the result of the SDP offer / answer exchange results
in the application of an end-to-end security mechanism, the P-CSCF (IMS-ALG)
shall remove any SDP fingerprint attribute, offer UDPTL over DTLS transport
protocol according to IETF RFC 7345 [29] and the profile defined in 3GPP TS
33.328 [2], include the SDP fingerprint attribute according to IETF RFC 4572
[14] and the profile defined in 3GPP TS 33.328 [2] and include the SDP
\"a=3ge2ae:applied\" attribute; and
2) upon receiving an SDP answer to the SDP offer from remote user, for each
accepted end-to-access-edge protected UDPTL based media, the P-CSCF (IMS-ALG)
shall remove the SDP fingerprint attribute.
### 5.1.4 MSRP handling
#### 5.1.4.1 General
The IMS-ALG and IMS-AGW may support MSRP handling. If they support MSRP
handling, they shall apply the procedures as specified in the present clause
5.1.4.
The IMS‑AGW may operate either in MSRP agnostic and MSRP aware mode (see
clause 4.1.4). The MSRP agnostic modes relates to \"transparent forwarding of
MSRP messages\" by the IMS-AGW.
The IMS-AGW shall support application-agnostic MSRP handling.
NOTE 1: Application-agnostic MSRP handling suffices when IETF RFC 6714 [9] or
IETF draft-ietf-simple-msrp-sessmatch-10 [13] is supported by both ends (e.g.
between Rel-8 onwards IMS UEs) and no MSRP relays are used.
NOTE 2: The expired IETF draft-ietf-simple-msrp-sessmatch-10 [13] is still
used in some OMA CPM and GSMA RCS related specification versions.
The IMS-AGW may in addition support application-aware MSRP interworking, as
described in clause 5.1.4.5.
NOTE 3: Application-aware MSRP interworking enables direct communication:
\- between an MSRP client applying IETF RFC 6714 [9] and an MSRP client
applying IETF RFC 4975 [6] without extensions by either IETF RFC 6714 [9] or
IETF draft-ietf-simple-msrp-sessmatch-10 [13].
\- between an MSRP client applying IETF draft-ietf-simple-msrp-sessmatch-10
[13] and an MSRP client applying IETF RFC 4975 [6] without extensions by
either IETF RFC 6714 [9] or IETF draft-ietf-simple-msrp-sessmatch-10 [13].
\- between an MSRP client applying IETF RFC 6714 [9] and an MSRP client
applying draft-ietf-simple-msrp-sessmatch-10 [13].
\- between two MSRP clients applying IETF RFC 4975 [6] without extensions by
either IETF RFC 6714 [9] or IETF draft-ietf-simple-msrp-sessmatch-10 [13].
However, to address these scenarios, application aware MSRP interworking can
also be applied in other network elements than the IMS-ALG and IMS-AGW, for
instance in an CPM Participating Function or CPM Interworking Function as
defined in OMA-TS-CPM_Conversation_Function-V2 [30].
NOTE 4: MSRP relays external to the IMS-AGW are not supported in the present
release.
The IMS-ALG procedures depend on whether the IMS-AGW applies application-
agnostic MSRP interworking or application-aware MSRP interworking, and on the
MSRP extensions applied on the interconnected call legs. The support of
related procedures in clauses 5.1.4.2 to 5.1.4.4 below are all optional, but
the IMS-ALG shall support at least one of them.
However the procedures in subclauses 5.1.4.4 and 5.1.4.5 shall not be applied
for media with e2e media security.
Table 5.1.4.1-1: Behaviour of MSRP clients and related IMS-ALG and IMS-AGW
procedures for MSRP with different extensions.
+----------+----------+----------+----------+----------+----------+ | IETF | MSRP | Session | IMS-AGW | IMS-ALG | Support | | d | client | matching | needs to | needs to | of | | ocument: | takes | at MSRP | insert | modify | e | | | des | client | own | SDP path | xtension | | | tination | between | address | a | is | | | address | SDP path | into | ttribute | ne | | | for TCP | and | \"T | | gotiated | | | co | \"T | o‑Path\" | | | | | nnection | o-Path\" | in MSRP | | | | | setup | in MSRP | messages | | | | | from | messages | | | | | | | includes | | | | | | | address | | | | | | | inf | | | | | | | ormation | | | | +----------+----------+----------+----------+----------+----------+ | **IETF | SDP MSRP | Yes | Yes | Yes | - | | RFC 4975 | path | | | | | | [6]** | a | | | | | | | ttribute | | | | | +----------+----------+----------+----------+----------+----------+ | * | SDP MSRP | No | No | Yes | No | | _Expired | path | | | | | | dra | a | | | | | | ft-ietf- | ttribute | | | | | | simple-m | | | | | | | srp-sess | | | | | | | match-10 | | | | | | | [13]__| | | | | | +----------+----------+----------+----------+----------+----------+ |__IETF | SDP | Yes | No | No | Yes, via | | RFC 6714 | c-line | | | | SDP CEMA | | [9]_ * | and | | (Yes if | | a | | | m-line | | fallback | | ttribute | | | | | to IETF | | | | | | | RFC 4975 | | | | | | | [6] | | | | | | | occurs | | | | | | | and is | | | | | | | su | | | | | | | pported) | | | +----------+----------+----------+----------+----------+----------+
#### 5.1.4.2 IMS-ALG procedures to support IETF RFC 6714 with application
agnostic MSRP handling by the IMS-AGW
A peer applying IETF RFC 6714 [9] will include the \"a=msrp-cema\" SDP
attribute in the first SDP offer it sends.
If the \"a=msrp-cema\" SDP attribute is contained in an SDP offer, the IMS-
ALG:
\- shall ensure that the IMS-AGW performs application agnostic MSRP handling
by not configuring the IMS-AGW to apply application-aware MSRP interworking;
\- shall indicate \"TCP\" or \"TCP/TLS\" (if media security is applied) as
transport protocol to the IMS‑AGW;
\- shall forward the \"a=path\" attribute and the \"a=msrp-cema\" SDP
attribute in the SDP offer without modification; and
\- shall forward the \"a=path\" SDP attribute in the corresponding SDP answer
without modification (even if the \"a=msrp-cema\" SDP attribute is not
contained in the answer).
NOTE: If the \"a=msrp-cema\" SDP attribute is not contained in the SDP answer
and the \"a=path\" SDP attribute is not modified, the offerer will discover a
mismatch and send a new SDP offer without the \"a=msrp-cema\" SDP attribute
according to IETF RFC 6714 [9] procedures. The situation should only occur if
an MSRP IWF according to clause C.2 is acting as SDP offerer.
If the \"a=msrp-cema\" SDP attribute is not contained in an SDP offer, the IMS
ALG shall either apply the procedures in clause 5.1.4.3 or clause 5.1.4.4 (if
supported).
#### 5.1.4.3 IMS-ALG procedures to support IETF draft-ietf-simple-msrp-
sessmatch with application agnostic MSRP handling by the IMS-AGW
A peer applying the expired IETF draft-ietf-simple-msrp-sessmatch-10 [13] will
not include the \"a=msrp-cema\" SDP attribute in the SDP it sends, and will
only compare the session-id part of the first MSRP URI in the SDP \"a=path\"
attribute with the session-id part of the first MSRP URI in the \"To-Path\"
header field of the first received MSRP packet.
If the \"a=msrp-cema\" SDP attribute is not contained in an SDP offer, the
IMS-ALG:
\- shall ensure that the IMS-AGW performs application agnostic MSRP handling
by not configuring the IMS-AGW to apply application-aware MSRP interworking;
\- shall indicate \"TCP\" or \"TCP/TLS\" (if e2ae media security is applied)
as transport protocol to the IMS‑AGW; and
\- shall replace the IP address and TCP port in the only entry of the
\"a=path\" SDP attribute in a received SDP offer or answer with the IP address
and port allocated for the media stream at the IMS-AGW before forwarding the
SDP.
#### 5.1.4.4 IMS-ALG procedures for application aware MSRP interworking by the
IMS-AGW
The IMS ALG:
\- shall provide the SDP \"a=path\" attribute, as received in SIP/SDP
signalling, to the IMS‑AGW as \"MSRP Path\" with the remote descriptor of the
corresponding call leg;
\- shall ensure that the IMS-AGW performs application aware MSRP interworking
by configuring the IMS-AGW to apply application-aware MSRP interworking; and
\- shall indicate \"TCP/MSRP\" or \"TCP/TLS/MSRP\" (if e2ae media security is
applied) as transport protocol to the IMS‑AGW.
If interworking between an MSRP client applying IETF RFC 6714 [9] and an MSRP
client applying IETF RFC 4975 [6] without extensions by either IETF RFC 6714
[9] or IETF draft-ietf-simple-msrp-sessmatch-10 [13] needs to be supported,
the IMS ALG should:
\- when receiving an SDP offer including the \"a=msrp-cema\" SDP attribute,
include the \"a=msrp-cema\" SDP attribute in the SDP answer on that call leg;
\- when sending an SDP offer, include the \"a=msrp-cema\" SDP attribute; and
\- if the \"a=msrp-cema\" SDP attribute is not contained in a received SDP
answer and the SDP c/m-line address information does not match the \"a=path\"
attribute, send a new SDP offer without the \"a=msrp-cema\" SDP attribute
according to IETF RFC 6714 [9] procedures.
NOTE: The second SDP offer can be omitted if the IMS-ALG knows that there is
no SBC in the path (e.g. between the IMS-ALG and the UE).
#### 5.1.4.5 Application-aware MSRP interworking at the IMS-AGW
The IMS‑AGW shall apply application-aware MSRP interworking if being
instructed from the IMS-ALG.
To apply application-aware MSRP interworking, the IMS-AGW:
\- shall modify the MSRP \"To-Path\" parameter in application (i.e. MSRP) data
by replacing the IP address and TCP port of the only entry with the
corresponding information in the \"MSRP path\" provided by the IMS_ALG while
retaining the MSRP session ID part of the entry as received in the MSRP \"To-
Path\"; and
\- shall forward the MSRP data without further modification.
NOTE: MSRP session matching will be performed only by the MSRP clients.
## 5.2 Procedures
### 5.2.1 End-to-access edge security for TCP-based media using TLS
#### 5.2.1.1 Generic procedures
Figure 5.2.1.1.1: H.248 Context Model
Figure 5.2.1.1.1 depicts the context model used in the subsequent clauses.
#### 5.2.1.2 Specific procedures for session based messaging (MSRP)
##### 5.2.1.2.1 Indicating support of e2ae security during registration.
Support for e2ae security for MSRP is indicated during registration by the UE
using the Security-Client header field with a \"mediasec=msrp-tls\" parameter
and by the P‑CSCF (IMS‑ALG) using the Security-Server header field with a
\"mediasec=msrp-tls\" parameter.
NOTE: For compatibility with RCS 5.1 [18, 31], the indication of support for
e2ae security during registration is not a necessary prerequisite for the use
of e2ae security, but it helps to avoid certain error cases.
##### 5.2.1.2.2 IMS UE originating procedures for e2ae
###### 5.2.1.2.2.1 Incoming TCP bearer establishment triggers an outgoing TCP
bearer establishment.
Figure 5.2.1.2.2.1.1 shows an example call flow for the originating session
set-up procedures for one MSRP media stream using e2ae security, where an
incoming TCP bearer establishment triggers an outgoing TCP bearer
establishment.
Figure 5.2.1.2.2.1.1: Originating example call flow for e2ae security for MSRP
where an incoming TCP bearer establishment triggers an outgoing TCP bearer
establishment
The IMS UE A performs an IMS originating session set-up according to 3GPP TS
23.228 [3], with modifications as described in 3GPP TS 33.328 [2].
The procedure in the above figure for requesting e2ae security for a media
stream is described step-by-step with an emphasis on the additional aspects
for IMS-ALG and IMS-AGW of media protection using TLS.
1\. IMS UE A sends an SDP offer for a media stream containing cryptographic
information, together with an \"a=3ge2ae:requested\" SDP attribute for the
MSRP-related SDP m-line, to the P‑CSCF (IMS‑ALG). For e2ae protection of MSRP
the cryptographic information contained in the SDP offer consists of the
fingerprint of the certificate of IMS UE A in accordance to IETF RFC 4975 [6].
For each media stream that uses transport \"TCP/TLS/MSRP\", the P‑CSCF
(IMS‑ALG) checks for the presence of the \"a=3ge2ae:requested\" SDP attribute.
If that indication is present and the P‑CSCF (IMS‑ALG) indicated support of
e2ae-security for MSRP during registration, the P‑CSCF (IMS‑ALG) allocates the
required resources, includes the IMS‑AGW in the media path and proceeds as
specified in this clause.
NOTE 1: An operator can choose to terminate TLS in the IMS‑AGW according to
the following steps for all media streams that are signalled in SIP INVITE
messages with transport TCP/TLS/MSRP and a certificate fingerprint attribute,
even if the UE did not indicate support for e2ae security during registration
and did not indicate usage of e2ae security for the respective media streams
in the INVITE. This can lead to session failures for pre-Rel-12 IMS UEs or
non-IMS UEs due to a mismatch of security parameters sent by the network and
expected by the UE, but on the other hand, it will ensure compatibility with
GSMA RCS 5.1 [18, 31], which specifies that TLS for MSRP is always terminated
in the network.
2.-4. The IMS-ALG uses the \"Reserve AGW Connection Point\" procedure to
request a termination for \"TCP\" media (for application-agnostic
interworking) or \"TCP/MSRP\" media (for application-aware interworking)
towards the core network. To indicate that the IMS-AGW shall operate in TCP
Proxy mode, the IMS-ALG provides \"a=setup:actpass\" attribute. The IMS-ALG
sets the interlinkage topology on the termination T2 to configure the IMS-AGW
to use the TCP connection establishment request (TCP SYN) received at the
termination T2 as a trigger to send a TCP connection establishment on the
termination T1.
NOTE 2: If \"a=setup:passive\" is received in the SDP answer in step 12, the
IMS-ALG then needs to set the interlinkage topology on the termination T1 (not
depicted).
5.-7. The IMS-ALG uses the \"Reserve And Configure AGW Connection Point\"
procedure to request a termination for \"TCP/TLS\" media (for application-
agnostic interworking) or \"TCP/TLS/MSRP\" media (for application-aware
interworking) towards the access network. In the remote descriptor, it
provides the IP address, port and fingerprint attribute received from the UE
containing the fingerprint of the UE´s certificate in accordance to IETF RFC
4975 [6]. This instructs the IMS‑AGW to verify during the subsequent TLS
handshake with the IMS UE that the fingerprint of the certificate passed by
the IMS UE during this TLS handshake matches the fingerprint passed by the
P‑CSCF (IMS‑ALG) to the IMS‑AGW. In turn, the IMS‑AGW communicates the
fingerprint of the certificate it is going to use for setting up protection
for this media stream to the P‑CSCF (IMS‑ALG). To indicate that the IMS-AGW
shall operate in TCP Proxy mode, the IMS-ALG provides \"a=setup:actpass\"
attribute.
NOTE 3: These steps could be combined with steps 16.-18. This saves H.248
signalling interactions but can delay the TCP connection setup.
8\. The P‑CSCF (IMS‑ALG) changes the transport from \"TCP/TLS/MSRP\" to
\"TCP/MSRP\" in the SDP offer, removes the \"a=3ge2ae:requested\" SDP
attribute and the fingerprint SDP attribute, and inserts the address
information received from the IMS-AGW.
9\. The P‑CSCF (IMS‑ALG) forwards the SDP offer.
10\. The remote peer chooses to become the active party in the TCP connection
establishment and sends a TCP SYN to establish the TCP connection. If the
P-CSCF (IMS-ALG) indicated to the IMS-AGW at step 2 that it shall ignore any
incoming TCP connection establishment requests (TCP SYN), e.g. to enable a
remote source transport address filtering, or if the P-CSCF (IMS-ALG) did not
indicate to the IMS-AGW at step 2 that it shall latch onto the required
destination address via the source address/port of the incoming media, the
IMS-AGW shall drop the TCP SYN received from the remote peer.\ If the TCP SYN
is not answered before a timer expiry, the remote peer will send the TCP SYN a
second time (step 10\'). The IMS‑AGW will answer a repeated TCP SYN if it is
received after step 13 (step 10\').\ The IMS-AGW answers the TCP SYN and the
remote peer completes the TCP connection establishment.
11\. The IMS-AGW uses the TCP SYN received at the termination T2 (at step 10
or step 10\' if the TCP SYN is dropped at step 10) as a trigger to send a TCP
SYN towards the UE to establish a TCP connection (effectively making the IMS-
AGW acting as the TCP client towards the UE). The UE answers the TCP SYN and
the IMS-AGW completes the TCP connection establishment.
12\. The P‑CSCF (IMS‑ALG) receives the SDP answer.
13.-15. The IMS-ALG uses the \"Configure AGW Connection Point\" procedure to
configure the termination towards the core network with remote address
information. If the P-CSCF (IMS-ALG) indicated to the IMS-AGW at step 2 that
it shall ignore any incoming TCP connection establishment requests (TCP SYN),
the IMS-ALG indicates to the IMS-AGW to accept incoming TCP connection
establishment (TCP SYN) only from the indicated remote transport address.
NOTE 4: For \"a=setup:active\" in the SDP answer, these steps could possibly
be skipped if the P-CSCF (IMS-ALG) indicated to the IMS-AGW at step 2 that it
shall latch onto the required destination address via the source address/port
of the incoming media, as the IMS-AGW will then use the address information in
the TCP SYN when replying.
16.-18. The IMS-ALG uses the \"Configure AGW Connection Point\" procedure to
configure the termination towards the access network with the request to
establish the TLS session once the TCP connection is established (effectively
making the IMS-AGW acting as the TLS client), in accordance with the
information in the \"a=setup\" attribute in the SDP answer.
19\. The P‑CSCF (IMS‑ALG) modifies the SDP answer before sending it to the UE
A. The P‑CSCF (IMS‑ALG) sets the transport to \"TCP/TLS/MSRP\" and includes
the fingerprint of the IMS‑AGW´s certificate in accordance to IETF RFC 4975
[6].
20\. The P-CSCF (IMA-ALG) then sends the updated SDP answer to IMS UE A. After
receiving this message IMS UE A completes the media security setup.
21\. Upon completion of the TCP connection establishment, the IMS-AGW starts
the establishment of the TLS session.
###### 5.2.1.2.2.2 IMS-ALG requests sending an outgoing TCP bearer
establishment.
Figure 5.2.1.2.2.2.1 shows an example call flow for the originating session
set-up procedures for one MSRP media stream using e2ae security, where the
IMS-ALG requests sending an outgoing TCP bearer establishment.
Figure 5.2.1.2.2.2.1: Originating example call flow for e2ae security for MSRP
where the IMS-ALG requests sending an outgoing TCP bearer establishment
The IMS UE A performs an IMS originating session set-up according to 3GPP TS
23.228 [3], with modifications as described in 3GPP TS 33.328 [2].
The procedure in the above figure for requesting e2ae security for a media
stream is described step-by-step with an emphasis on the additional aspects
for IMS-ALG and IMS-AGW of media protection using TLS.
1\. As step 1 in figure 5.2.1.2.2.1.1.
2.-4. As steps 2-4 in figure 5.2.1.2.2.1.1 with the exception that the IMS-ALG
does not set the interlinkage topology on the termination T2.
5.-7. As steps 5-7 in figure 5.2.1.2.2.1.1.
8\. As step 8 in figure 5.2.1.2.2.1.1.
9\. As step 9 in figure 5.2.1.2.2.1.1.
10\. As step 10 in figure 5.2.1.2.2.1.1.
NOTE: The incoming TCP SYN does not trigger the sending of an outgoing TCP
SYN, and step 11 in figure 5.2.1.2.2.1.1 thus does not apply.
11\. As step 12 in figure 5.2.1.2.2.1.1.
12.-14. As steps 13-15 in figure 5.2.1.2.2.1.1.
15.-17. As steps 16-18 in figure 5.2.1.2.2.1.1 with the exception that the
IMS-ALG uses the \"Configure AGW Connection Point\" procedure also to
configure the termination towards the access network with the request to
establish the TCP connection (effectively making the IMS-AGW acting as the TCP
client), in accordance with the information in the \"a=setup\" attribute in
the SDP answer.
18\. The IMS-AGW sends a TCP SYN towards the UE to establish a TCP connection.
The UE answers with a TCP SYN ACK and the IMS‑AGW replies with a TCP ACK,
completing the TCP connection establishment.
19\. As step 21 in figure 5.2.1.2.2.1.1.
20\. As step 19 in figure 5.2.1.2.2.1.1.
21\. As step 20 in figure 5.2.1.2.2.1.1.
##### 5.2.1.2.3 IMS UE terminating procedures for e2ae
###### 5.2.1.2.3.1 Incoming TCP bearer establishment triggers an outgoing TCP
bearer establishment.
Figure 5.2.1.2.3.1.1 shows an example call flow for the terminating session
set-up procedures for one MSRP media stream using e2ae security, where an
incoming TCP bearer establishment triggers an outgoing TCP bearer
establishment.
Figure 5.2.1.2.3.1.1: Terminating example call flow for e2ae security for MSRP
where an incoming TCP bearer establishment triggers an outgoing TCP bearer
establishment
The IMS UE B performs an IMS terminating session set-up according to 3GPP TS
23.228 [3], with modifications as described in 3GPP TS 33.328 [2].
The procedure in the above figure for requesting e2ae security for a media
stream is described step-by-step with an emphasis on the additional aspects
for IMS-ALG and IMS-AGW of media protection using TLS.
1\. The P‑CSCF (IMS‑ALG) receives an SDP offer for an MSRP media stream. For
each MSRP media stream offered with transport \"TCP/MSRP\", if both the IMS UE
and P‑CSCF (IMS‑ALG) indicated support for e2ae-security for MSRP during
registration, the P‑CSCF (IMS‑ALG) allocates the required resources, includes
the IMS‑AGW in the media path and proceeds as specified in this clause.
NOTE 1: An operator can choose to terminate TLS in the IMS‑AGW according to
the following steps for all media streams that are signalled in SIP INVITE
messages with transport TCP/MSRP, even if the UE did not indicate support for
e2ae security during registration. This can lead to session failures for pre-
Rel-12 IMS UEs or non-IMS UEs due to a mismatch of security parameters sent by
the network and expected by the UE, but on the other hand, it will ensure
compatibility with GSMA RCS 5.1 [18, 31], which recommends to always use e2ae
security for MSRP on the terminating leg.
2.-4. The IMS-ALG uses the \"Reserve AGW Connection Point\" procedure to
request a termination for \"TCP/TLS\" media (for application-agnostic
interworking) or \"TCP/TLS/MSRP\" media (for application-aware interworking)
towards the access network. In turn, the IMS‑AGW communicates the fingerprint
of the certificate it is going to use for setting up protection for this media
stream to the P‑CSCF (IMS‑ALG). To indicate that the IMS-AGW shall operate in
TCP Proxy mode, the IMS-ALG provides \"a=setup:actpass\" attribute. The IMS-
ALG sets the interlinkage topology on the termination T1 to configure the IMS-
AGW to use the TCP connection establishment request (TCP SYN) received at the
termination T1 as a trigger to send a TCP connection establishment on the
termination T2.
NOTE 2: If \"a=setup:passive\" is received in the SDP answer in step 13, the
IMS-ALG then needs to sets the interlinkage topology on the termination T2
(not depicted).
5.-7. The IMS-ALG uses the \"Reserve And Configure AGW Connection Point\"
procedure to request a termination for \"TCP\" media (for application-agnostic
interworking) or \"TCP/ MSRP\" media (for application-aware interworking)
towards the core network. To indicate that the IMS-AGW shall operate in TCP
Proxy mode, the IMS-ALG provides \"a=setup:actpass\" attribute.
8\. The P‑CSCF (IMS‑ALG) changes the transport from \"TCP/ MSRP\" to
\"TCP/TLS/MSRP\" in the SDP offer, adds the \"a=3ge2ae:applied\" SDP attribute
and the fingerprint SDP attribute received from the IMS-AGW, and inserts the
address information received from the IMS-AGW.
9\. The P‑CSCF (IMS‑ALG) forwards the SDP offer.
10\. The UE B chooses to become the active party in the TCP connection
establishment and sends a TCP SYN to establish the TCP connection. If the
P-CSCF (IMS-ALG) indicated to the IMS-AGW at step 2 that it shall ignore any
incoming TCP connection establishment requests (TCP SYN), e.g. to enable a
remote source transport address filtering, or if the P-CSCF (IMS-ALG) did not
indicate to the IMS-AGW at step 2 that it shall latch onto the required
destination address via the source address/port of the incoming media, the
IMS-AGW shall drop the TCP SYN received from the UE.\ If the TCP SYN is not
answered before a timer expiry, the UE will send the TCP SYN a second time
(step 10\'). The IMS‑AGW will answer a repeated TCP SYN if it is received
after step 14 (step 10\').\ The IMS-AGW answers the TCP SYN and the remote
peer completes the TCP connection establishment.
11\. The IMS-AGW uses the TCP SYN received at the termination T1 (at step 10
or step 10\' if the TCP SYN is dropped at step 10) as a trigger to send a TCP
SYN towards the core network to establish a TCP connection (effectively making
the IMS-AGW acting as the TCP client towards the core network). The remote
peer answers the TCP SYN and the IMS-AGW completes the TCP connection
establishment.
12\. Upon completion of the TCP connection establishment, the UE B starts the
establishment of the TLS session. The IMS-AGW needs to wait until step 14 to
verify the received fingerprint.
13\. The P‑CSCF (IMS‑ALG) receives the SDP answer. It contains the fingerprint
attribute with the UE´s certificate in accordance to IETF RFC 4975 [6].
14.-16. The IMS-ALG uses the \"Configure AGW Connection Point\" procedure to
configure the termination towards the UE B with remote address information. In
the remote descriptor, it also provides fingerprint attribute received from
the UE. This instructs the IMS‑AGW to verify during the subsequent TLS
handshake with the IMS UE that the fingerprint of the certificate passed by
the IMS UE during this TLS handshake matches the fingerprint passed by the
P‑CSCF (IMS‑ALG) to the IMS‑AGW. If the P-CSCF (IMS-ALG) indicated to the IMS-
AGW at step 2 that it shall ignore any incoming TCP connection establishment
requests (TCP SYN), the IMS-ALG indicates to the IMS-AGW to accept incoming
TCP connection establishment (TCP SYN) only from the indicated remote
transport address.
17\. The P‑CSCF (IMS‑ALG) modifies the SDP answer before sending it to the
core network. The P‑CSCF (IMS‑ALG) sets the transport to \"TCP/ MSRP\" and
removes the SDP fingerprint attribute.
18\. The P-CSCF (IMA-ALG) then sends the updated SDP answer to core network.
###### 5.2.1.2.3.2 IMS-ALG requests sending an outgoing TCP bearer
establishment.
Figure 5.2.1.2.3.2.1 shows an example call flow for the terminating session
set-up procedures for one MSRP media stream using e2ae security, where the
IMS-ALG requests sending an outgoing TCP bearer establishment.
Figure 5.2.1.2.3.2.1: Terminating example call flow for e2ae security for MSRP
where the IMS-ALG requests sending an outgoing TCP bearer establishment
The IMS UE B performs an IMS originating session set-up according to 3GPP TS
23.228 [3], with modifications as described in 3GPP TS 33.328 [2].
The procedure in the above figure for requesting e2ae security for a media
stream is described step-by-step with an emphasis on the additional aspects
for IMS-ALG and IMS-AGW of media protection using TLS.
1\. As step 1 in figure 5.2.1.2.3.1.1.
2.-4. As steps 2-4 in figure 5.2.1.2.3.1.1 with the exception that the IMS-ALG
does not set the interlinkage topology on the termination T1.
5.-7. As steps 7-7 in figure 5.2.1.2.3.1.1.
8\. As step 8 in figure 5.2.1.2.3.1.1.
9\. As step 9 in figure 5.2.1.2.3.1.1.
10\. As step 10 in figure 5.2.1.2.3.1.1.
NOTE: The incoming TCP SYN does not trigger the sending of an outgoing TCP
SYN, and step 11 in figure 5.2.1.2.2.1.1 thus does not apply.
11\. As step 12 in figure 5.2.1.2.3.1.1.
12\. As step 13 in figure 5.2.1.2.3.1.1.
13.-15. As steps 14-16 in figure 5.2.1.2.3.1.1.
16.-18. The IMS-ALG uses the \"Configure AGW Connection Point\" procedure to
configure the termination towards the core network with the request to
establish the TCP connection, in accordance with the information in the
\"a=setup\" attribute in the SDP answer.
19\. The IMS-AGW sends a TCP SYN towards the core network to establish a TCP
connection. The remote peer answers with a TCP SYN ACK and the IMS‑AGW replies
with a TCP ACK, completing the TCP connection establishment.
20\. As step 17 in figure 5.2.1.2.3.1.1.
21\. As step 18 in figure 5.2.1.2.3.1.1.
#### 5.2.1.3 Specific procedures for conferencing (BFCP)
##### 5.2.1.3.1 Indicating support of e2ae security during registration.
Support for e2ae security for MSRP is indicated during registration by the UE
using the Security-Client header field with a \"mediasec=bfcp-tls\" parameter
and by the P‑CSCF (IMS‑ALG) using the Security-Server header field with a
\"mediasec=bfcp-tls\" parameter.
##### 5.2.1.3.2 IMS UE originating procedures for e2ae
Figure 5.2.1.3.2.1 shows the originating session set-up procedures for one or
more BFCP media stream(s) using e2ae security.
Figure 5.2.1.3.2.1: Originating example call flow for e2ae case
The IMS UE A performs an IMS originating session set-up according to 3GPP TS
23.228 [3], with modifications as described in 3GPP TS 33.328 [2].
The procedure in the above figure for requesting e2ae security for a media
stream is described step-by-step with an emphasis on the additional aspects
for IMS-ALG and IMS-AGW of media protection using TLS.
1\. IMS UE A sends an SDP offer for a media stream containing cryptographic
information, together with an \"a=3ge2ae:requested\" SDP attribute for the
BFCP-related SDP m-line, to the P‑CSCF (IMS‑ALG). For e2ae protection of BFCP
the cryptographic information contained in the SDP offer consists of the
fingerprint of the certificate of IMS UE A in accordance to IETF RFC 4975 [6].
For each media stream that uses transport \"TCP/TLS/BFCP\", the P‑CSCF
(IMS‑ALG) checks for the presence of the \"a=3ge2ae:requested\" SDP attribute.
If that indication is present and the P‑CSCF (IMS‑ALG) indicated support of
e2ae-security for BFCP during registration, the P‑CSCF (IMS‑ALG) allocates the
required resources, includes the IMS‑AGW in the media path and proceeds as
specified in this clause.
2.-4. The IMS-ALG uses the \"Reserve AGW Connection Point\" procedure to
request a termination for \"TCP\" media towards the core network. To indicate
that the IMS-AGW shall operate in TCP Proxy mode, the IMS-ALG provides
\"a=setup:actpass\" attribute. The IMS-ALG sets the interlinkage topology on
the termination T2 to configure the IMS-AGW to use the TCP connection
establishment request (TCP SYN) received at the termination T2 as a trigger to
send a TCP connection establishment on the termination T1.
NOTE 1: If \"a=setup:passive\" is received in the SDP answer in step 13, the
IMS-ALG then needs to set the interlinkage topology on the termination T1 (not
depicted).
5.-7. The IMS-ALG uses the \"Reserve And Configure AGW Connection Point\"
procedure to request a termination for \"TCP/TLS\" media towards the access
network. In the remote descriptor, it provides the IP address, port and
fingerprint attribute received from the UE containing the fingerprint of the
UE´s certificate in accordance to IETF RFC 4975 [6]. This instructs the
IMS‑AGW to verify during the subsequent TLS handshake with the IMS UE that the
fingerprint of the certificate passed by the IMS UE during this TLS handshake
matches the fingerprint passed by the P‑CSCF (IMS‑ALG) to the IMS‑AGW. In
turn, the IMS‑AGW communicates the fingerprint of the certificate it is going
to use for setting up protection for this media stream to the P‑CSCF
(IMS‑ALG). To indicate that the IMS-AGW shall operate in TCP Proxy mode, the
IMS-ALG provides \"a=setup:actpass\" attribute.
8\. The P‑CSCF (IMS‑ALG) changes the transport from \"TCP/TLS/BFCP\" to
\"TCP/BFCP\" in the SDP offer, removes the \"a=3ge2ae:requested\" SDP
attribute and the fingerprint SDP attribute, and inserts the address
information received from the IMS-AGW.
9\. The P‑CSCF (IMS‑ALG) forwards the SDP offer.
10\. The remote peer chooses to become the active party in the TCP connection
establishment and sends a TCP SYN to establish the TCP connection. If the
P-CSCF (IMS-ALG) indicated to the IMS-AGW at step 2 that it shall ignore any
incoming TCP connection establishment requests (TCP SYN), e.g. to enable a
remote source transport address filtering, or if the P-CSCF (IMS-ALG) did not
indicate to the IMS-AGW at step 2 that it shall latch onto the required
destination address via the source address/port of the incoming media, the
IMS-AGW shall drop the TCP SYN received from the remote peer.\ If the TCP SYN
is not answered before a timer expiry, the remote peer will send the TCP SYN a
second time (step 10\'). The IMS‑AGW will answer a repeated TCP SYN if it is
received after step 14 (step 10\').\ The IMS-AGW answers the TCP SYN and the
remote peer completes the TCP connection establishment.
11\. The IMS-AGW uses the TCP SYN received at the termination T2 (at step 10
or step 10\' if the TCP SYN is dropped at step 10) as a trigger to send a TCP
SYN towards the UE to establish a TCP connection (effectively making the IMS-
AGW acting as the TCP client towards the UE). The UE answers the TCP SYN and
the IMS-AGW completes the TCP connection establishment.
12\. Upon completion of the TCP connection establishment, the UE B starts the
establishment of the TLS session. The IMS-AGW needs to wait until step 14 to
verify the received fingerprint.
13\. The P‑CSCF (IMS‑ALG) receives the SDP answer.
14.-16. The IMS-ALG uses the \"Configure AGW Connection Point\" procedure to
configure the termination towards the core network with remote address
information. If the P-CSCF (IMS-ALG) indicated to the IMS-AGW at step 2 that
it shall ignore any incoming TCP connection establishment requests (TCP SYN),
the IMS-ALG indicates to the IMS-AGW to accept incoming TCP connection
establishment (TCP SYN) only from the indicated remote transport address.
NOTE 2: For \"a=setup:active\" in the SDP answer, these steps could possibly
be skipped if the P-CSCF (IMS-ALG) indicated to the IMS-AGW at step 2 that it
shall latch onto the required destination address via the source address/port
of the incoming media, as the IMS-AGW will then use the address information in
the TCP SYN when replying.
17\. The P‑CSCF (IMS‑ALG) modifies the SDP answer before sending it to the UE
A. The P‑CSCF (IMS‑ALG) sets the transport to \"TCP/TLS/BFCP\" and includes
the fingerprint of the IMS‑AGW´s certificate in accordance to IETF RFC 4975
[6].
18\. The P-CSCF (IMA-ALG) then sends the updated SDP answer to IMS UE A. After
receiving this message IMS UE A completes the media security setup.
##### 5.2.1.3.3 IMS UE terminating procedures for e2ae
Figure 5.2.1.3.3.1 shows the terminating session set-up procedures for one or
more BFCP media stream(s) using e2ae security.
Figure 5.2.1.3.3.1: Terminating example call flow for e2ae case
The IMS UE B performs an IMS terminatingsession set-up according to 3GPP TS
23.228 [3], with modifications as described in 3GPP TS 33.328 [2].
The procedure in the above figure for requesting e2ae security for a media
stream is described step-by-step with an emphasis on the additional aspects
for IMS-ALG and IMS-AGW of media protection using TLS.
1\. The P‑CSCF (IMS‑ALG) receives an SDP offer for an MSRP media stream. For
each BFCP media stream offered with transport \"TCP/BFCP\", if both the IMS UE
and P‑CSCF (IMS‑ALG) indicated support for e2ae-security for BFCP during
registration, the P‑CSCF (IMS‑ALG) allocates the required resources, includes
the IMS‑AGW in the media path and proceeds as specified in this clause.
2.-4. The IMS-ALG uses the \"Reserve AGW Connection Point\" procedure to
request a termination for \"TCP/TLS\" media towards the access network. The
IMS-ALG configures the IMS-AGW with the request to start the establishment of
the TLS session once the TCP connection is established (effectively making the
IMS-AGW acting as the TLS client). To indicate that the IMS-AGW shall operate
in TCP Proxy mode, the IMS-ALG provides \"a=setup:actpass\" attribute. The
IMS-ALG sets the interlinkage topology on the termination T1 to configure the
IMS-AGW to use the TCP connection establishment request (TCP SYN) received at
the termination T1 as a trigger to send a TCP connection establishment on the
termination T2.\ The IMS‑AGW communicates the fingerprint of the certificate
it is going to use for setting up protection for this media stream to the
P‑CSCF (IMS‑ALG).
NOTE: If \"a=setup:passive\" is received in the SDP answer in step 13, the
IMS-ALG then needs to sets the interlinkage topology on the termination T2
(not depicted)
5.-7. The IMS-ALG uses the \"Reserve And Configure AGW Connection Point\"
procedure to request a termination for \"TCP\" media towards the core network.
To indicate that the IMS-AGW shall operate in TCP Proxy mode, the IMS-ALG
provides \"a=setup:actpass\" attribute.
8\. The P‑CSCF (IMS‑ALG) changes the transport from \"TCP/ BFCP\" to
\"TCP/TLS/BFCP\" in the SDP offer, adds the \"a=3ge2ae:applied\" SDP attribute
and the fingerprint SDP attribute received from the IMS-AGW, and inserts the
address information received from the IMS-AGW.
9\. The P‑CSCF (IMS‑ALG) forwards the SDP offer.
10\. The UE B chooses to become the active party in the TCP connection
establishment and sends a TCP SYN to establish the TCP connection. If the
P-CSCF (IMS-ALG) indicated to the IMS-AGW at step 2 that it shall ignore any
incoming TCP connection establishment requests (TCP SYN), e.g. to enable a
remote source transport address filtering, or if the P-CSCF (IMS-ALG) did not
indicate to the IMS-AGW at step 2 that it shall latch onto the required
destination address via the source address/port of the incoming media, the
IMS-AGW shall drop the TCP SYN received from the UE.\ If the TCP SYN is not
answered before a timer expiry, the UE will send the TCP SYN a second time
(step 10\'). The IMS‑AGW will answer a repeated TCP SYN if it is received
after step 14 (step 10\').\ The IMS-AGW answers the TCP SYN and the remote
peer completes the TCP connection establishment.
11\. The IMS-AGW sends a TCP SYN towards the core network to establish a TCP
connection. The remote peer answers the TCP SYN and the IMS-AGW completes the
TCP connection establishment.
12\. Upon completion of the TCP connection establishment, the IMS-AGW starts
the establishment of the TLS session. The IMS-AGW needs to wait until step 14
to verify the received fingerprint.
13\. The P‑CSCF (IMS‑ALG) receives the SDP answer. It contains the fingerprint
attribute with the UE´s certificate in accordance to IETF RFC 4975 [6].
14.-16. The IMS-ALG uses the \"Configure AGW Connection Point\" procedure to
configure the termination towards the UE B with remote address information. In
the remote descriptor, it also provides fingerprint attribute received from
the UE. This instructs the IMS‑AGW to verify during the TLS handshake with the
IMS UE (see step 12) that the fingerprint of the certificate passed by the IMS
UE during this TLS handshake matches the fingerprint passed by the P‑CSCF
(IMS‑ALG) to the IMS‑AGW. If the P-CSCF (IMS-ALG) indicated to the IMS-AGW at
step 2 that it shall ignore any incoming TCP connection establishment requests
(TCP SYN), the IMS-ALG indicates to the IMS-AGW to accept incoming TCP
connection establishment (TCP SYN) only from the indicated remote transport
address.
17\. The P‑CSCF (IMS‑ALG) modifies the SDP answer before sending it to the
core network. The P‑CSCF (IMS‑ALG) sets the transport to \"TCP/ BFCP\" and
removes the SDP fingerprint attribute.
18\. The P‑CSCF (IMS‑ALG) then sends the updated SDP answer to core network.
### 5.2.2 End-to-end security for TCP-based media using TLS
#### 5.2.2.1 Generic procedures
If the IMS-ALG receives any SDP containing media lines with TCP/TLS based
transport (i.e. either \"TCP/TLS/MSRP\" or \"TCP/TLS/BFCP\" as transport
protocol) and no request for end-to-access-edge security, the IMS-ALG shall:
  * follow the procedure of 3GPP TS 23.334 [34], clause 6.2.1 (IMS-ALG/IMS-AGW interactions at session establishment) apart from the IMS-ALG providing \"TCP\" to the IMS-AGW as transport protocol and not providing any other media related information to the corresponding terminations and configuring the IMS-AGW to pass media transparently;
  * forward the SDP with unmodified transport protocol for those media lines.
#### 5.2.2.2 Specific procedures for session based messaging (MSRP)
None.
Editor\'s Note: The scenario where both terminals of an e2e security protected
media session are located behind firewalls/NATs is FFS.
#### 5.2.2.3 Specific procedures for conferencing (BFCP)
None.
### 5.2.3 End-to-access edge security for UDP-based media using DTLS
#### 5.2.3.1 Generic procedures
##### 5.2.3.1.1 Context model
Figure 5.2.3.1.1.1: H.248 context model
Figure 5.2.3.1.1.1 depicts the context model used in the subsequent clauses.
#### 5.2.3.2 Specific procedures for T.38 fax over UDPTL/UDP transport
##### 5.2.3.2.1 Indicating support of e2ae security during registration
Support for the e2ae security for T.38 fax over UDPTL/UDP transport is
indicated during registration by the IMS UE and the P‑CSCF (IMS‑ALG) using the
Security-Client, Security-Server or Security-Verify header fields with a
\"mediasec=udptl‑dtls\" header field parameter (defined in 3GPP TS 24.229 [5]
clause 7.2A.7).
##### 5.2.3.2.2 IMS UE originating procedures for e2ae
Figure 5.2.3.2.2.1 shows the originating session set-up procedure for one or
more UDPTL media stream(s) using e2ae security.
Figure 5.2.3.2.2.1: Originating example call flow for e2ae case
The IMS UE‑A and the P‑CSCF (IMS‑ALG) perform an IMS originating session set-
up according to 3GPP TS 23.228 [3], with modifications as described in 3GPP TS
33.328 [2] and 3GPP TS 24.229 [5].
The procedure in the above figure for requesting e2ae‑security for a media
stream is described step‑by‑step with an emphasis on the additional aspects
for the P‑CSCF (IMS‑ALG) and IMS‑AGW of media protection using DTLS.
1\. The IMS UE‑A sends an SDP offer for a media stream containing
cryptographic information, together with an \"a=3ge2ae:requested\" SDP
attribute for the UDPTL related SDP m-line and with an \"a=setup:actpass\" SDP
attribute, to the P‑CSCF (IMS‑ALG). For e2ae protection of UDPTL the
cryptographic information contained in the SDP offer consists of the
fingerprint of the certificate of IMS UE‑A in accordance to IETF RFC 4572
[14].
For each media stream that uses transport \"UDP/TLS/UDPTL\", the P‑CSCF
(IMS‑ALG) checks for the presence of the \"a=3ge2ae:requested\" SDP attribute.
If this indication is present and the P‑CSCF (IMS‑ALG) indicated support of
e2ae‑security for UDPTL during registration, the P‑CSCF (IMS‑ALG) determines
that e2ae security is applicable and proceeds as specified in this clause.
NOTE 1: As specified in IETF RFC 7345 [29] the \"setup\" SDP attribute is used
for negotiation of DTLS roles.
2.-4. The P‑CSCF (IMS‑ALG) uses the \"Reserve AGW Connection Point\" procedure
to request a termination for \"UDP\" media towards the core network.
NOTE 2: The bearer type indication for application-agnostic mode would be the
result of an \"UDPTL\" (SIP call control) to \"UDP\" (gateway control)
mapping.
5\. The P‑CSCF (IMS‑ALG) changes the transport from \"UDP/TLS/UDPTL\" to
\"UDPTL\" in the SDP offer, removes the \"a=3ge2ae:requested\" SDP attribute,
the fingerprint SDP attribute and the \"a=setup\" SDP attribute, and inserts
the address information received from the IMS‑AGW (see step 4).
6\. The P‑CSCF (IMS‑ALG) forwards the SDP offer.
7\. The P‑CSCF (IMS‑ALG) receives the SDP answer.
8.-10. The P‑CSCF (IMS‑ALG) uses the \"Configure AGW Connection Point\"
procedure to configure the termination towards the core network with remote
address information.
11.-13. The P‑CSCF (IMS‑ALG) uses the \"Reserve and Configure AGW Connection
Point\" procedure to request a termination for \"UDP/DTLS\" media towards the
access network. The P‑CSCF (IMS‑ALG) requests the IMS‑AGW to start DTLS
security session and requests the fingerprint of the IMS‑AGW´s certificate. In
the remote descriptor, the P‑CSCF (IMS‑ALG) provides the IP address, the port
and the fingerprint attribute received from the IMS UE‑A containing the
fingerprint of the UE´s certificate in accordance to IETF RFC 4572 [14]. This
instructs the IMS‑AGW to verify during the subsequent DTLS handshake with the
IMS UE‑A (see step 16) that the fingerprint of the certificate passed by the
IMS UE‑A during the DTLS handshake matches the fingerprint passed by the
P‑CSCF (IMS‑ALG) to the IMS‑AGW. In turn, the IMS‑AGW sends the fingerprint of
the certificate it is going to use for setting up protection for this media
stream to the P‑CSCF (IMS‑ALG).
NOTE 3: As specified in IETF draft-schwarz-mmusic-sdp-for-gw [45] the bearer
type indication for application-agnostic mode would be the result of an
\"UDP/TLS/UDPTL\" (SIP call control) to \"UDP/DTLS\" (gateway control)
mapping.
14\. The IMS‑AGW starts the establishment of the DTLS session.
15\. The IMS UE‑A and the IMS‑AGW exchange the remaining messages of the DTLS
handshake. When the IMS‑AGW receives the certificate of the IMS UE‑A via DTLS,
the IMS‑AGW checks whether the fingerprint of the certificate of the IMS UE‑A
received via DTLS matches the certificate fingerprint received in the
a=fingerprint SDP attribute in step 11. In this message flow, the check is
successful and thus session set‑up continues.
16\. The P‑CSCF (IMS‑ALG) modifies the SDP answer before sending it to the IMS
UE‑A. The P‑CSCF (IMS‑ALG) sets the transport to \"UDP/TLS/UDPTL\", includes
the \"a=setup:active\" SDP attribute and includes the fingerprint of the
IMS‑AGW´s certificate received in step 13.
17\. The P‑CSCF (IMS‑ALG) sends the updated SDP answer to the IMS UE‑A. Upon
reception of SDP answer with the fingerprint of the IMS‑AGW´s certificate the
IMS UE‑A completes the media security setup.
##### 5.2.3.2.3 IMS UE terminating procedures for e2ae
Figure 5.2.3.2.3.1 shows the terminating session set‑up procedures for one or
more UDPTL media stream(s) using e2ae security.
Figure 5.2.3.2.3.1: Terminating example call flow for e2ae case
The P‑CSCF (IMS‑ALG) and IMS UE‑B perform an IMS terminating session set‑up
according to 3GPP TS 23.228 [3], with modifications as described in 3GPP TS
33.328 [2] and 3GPP TS 24.229 [5].
The procedure in the above figure for requesting e2ae security for a media
stream is described step‑by‑step with an emphasis on the additional aspects
for P‑CSCF (IMS‑ALG) and IMS‑AGW of media protection using DTLS.
1\. The P‑CSCF (IMS‑ALG) receives an SDP offer for an UDPTL media stream. For
each UDPTL media stream offered with transport \"UDPTL\", if both the IMS UE‑B
and the P‑CSCF (IMS‑ALG) indicated support for e2ae‑security for UDPTL during
registration, the P‑CSCF (IMS‑ALG) determines that e2ae security is applicable
and proceeds as specified in this clause.
2.-4. The P‑CSCF (IMS‑ALG) uses the \"Reserve AGW Connection Point\" procedure
to request a termination for \"UDP/DTLS\" media towards the access network.
The P‑CSCF (IMS‑ALG) requests from the IMS‑AGW the fingerprint of the
IMS‑AGW´s certificate. In turn, the IMS‑AGW communicates the fingerprint of
the certificate it is going to use for setting up protection for this media
stream to the P‑CSCF (IMS‑ALG).
NOTE 1: As specified in IETF draft-schwarz-mmusic-sdp-for-gw [45] the bearer
type indication for application-agnostic mode would be the result of an
\"UDP/TLS/UDPTL\" (SIP call control) to \"UDP/DTLS\" (gateway control)
mapping.
5.-7. The P‑CSCF (IMS‑ALG) uses the \"Reserve and Configure AGW Connection
Point\" procedure to request a termination for \"UDP\" media towards the core
network.
NOTE 2: The bearer type indication for application-agnostic mode would be the
result of an \"UDPTL\" (SIP call control) to \"UDP\" (gateway control)
mapping.
8\. The P‑CSCF (IMS‑ALG) changes the transport from \"UDPTL\" to
\"UDP/TLS/UDPTL\" in the SDP offer, adds an \"a=3ge2ae:applied\" SDP attribute
and an \"a=setup:actpass\" SDP attribute, inserts the address information and
the fingerprint attribute with the IMS‑AGW´s certificate received from the
IMS‑AGW in step 4.
NOTE 3: As specified in IETF RFC 7345 [29] the \"setup\" SDP attribute is used
for negotiation of DTLS roles.
9\. The P‑CSCF (IMS‑ALG) forwards the SDP offer.
10\. The IMS UE‑B chooses to become the active party in the DTLS connection
establishment and starts the establishment of the DTLS session.
11\. The IMS‑AGW and the IMS UE‑B exchange further the remaining messages of
the DTLS handshake. The IMS‑AGW verifies during the subsequent DTLS handshake
with the IMS UE‑B that the fingerprint of the certificate passed by the IMS
UE‑B during this DTLS handshake matches the fingerprint passed by the P‑CSCF
(IMS‑ALG) (see step 13).
12\. The P‑CSCF (IMS‑ALG) receives the SDP answer. It contains the fingerprint
attribute with the IMS UE‑B´s certificate in accordance to IETF RFC 4572 [14]
and the \"a=setup:active\" SDP attribute.
13.-15. The P‑CSCF (IMS‑ALG) uses the \"Configure AGW Connection Point\"
procedure to configure the termination towards the IMS UE‑B with remote
address information. In the remote descriptor, it also provides fingerprint
attribute received from the IMS UE‑B.
16\. The P‑CSCF (IMS‑ALG) modifies the SDP answer before sending it to the
core network. The P‑CSCF (IMS‑ALG) sets the transport to \"UDPTL\" and removes
the SDP fingerprint attribute and the SDP \"setup\" attribute from the SDP
answer.
17\. The P‑CSCF (IMS‑ALG) sends the updated SDP answer to the core network.
# 6 IBCF/ TrGW interface (Ix)
## 6.1 Requirements
### 6.1.1 End-to-end security for TCP-based media using TLS
#### 6.1.1.1 General requirements
A pre-requisite for support of e2e security is that the TLS message is passed
transparently by any node present in the media path (i.e. TLS transparent
forwarding).
For e2e security protected media sessions, the IBCF shall:
\- at SIP level forward the SDP with unmodified transport protocol;
\- at H.248 level not provide any media related information to the
corresponding terminations, indicate only \"TCP\" as transport, and configure
the TrGW to pass media.
#### 6.1.1.2 Specific requirements for session based messaging (MSRP)
The same procedures as in clause 5.1.4 apply.
#### 6.1.1.3 Specific requirements for conferencing (BFCP)
None.
## 6.2 Procedures
### 6.2.1 End-to-end security for TCP-based media using TLS
#### 6.2.1.1 Generic procedures
If the IBCF receives any SDP containing media lines with TCP/TLS based
transport (i.e. either \"TCP/TLS/MSRP\" or \"TCP/TLS/BFCP\" as transport
protocol) it shall:
  * follow the procedure of 3GPP TS 29.162 [44], Figure 10.2.5.3 (IBCF and TrGW interactions at session establishment), where the IBCF does not offer transcoding;
  * provide \"TCP\" to the TrGW as transport protocol;
  * forward the SDP with unmodified transport protocol for those media lines.
#### 6.2.1.2 Specific procedures for session based messaging (MSRP)
None.
#### 6.2.1.3 Specific procedures for conferencing (BFCP)
None.
# 7 MRFC/ MRFP interface (Mp)
## 7.1 Requirements
### 7.1.1 End-to-end security for TCP-based media using TLS
#### 7.1.1.1 General requirements
An MRFC and MRFP may support end-to-end security protection of session based
messaging (MSRP) and conferencing (BFCP) as specified in 3GPP TS 33.328 [2],
Annex G3.
MSRP and BFCP traffic shall be protected using a TLS tunnel established with
MIKEY-TICKET procedures.
According to 3GPP TS 33.328 [2], the e2e protection of the session based
messaging (MSRP) and conferencing (BFCP) is based on the Key Management
Service (KMS) achieved through the KMS and a \"ticket\" concept:
\- The session initiator requests keys and a ticket from the KMS. The ticket
contains the keys in a protected format. The initiator then sends the ticket
to the recipient.
\- The recipient presents the ticket to the KMS and the KMS returns the keys
on which the media security shall be based.
The e2e protection of the TCP based media relies on the usage of TLS (see IETF
RFC 5246 [7]), according to the TLS profile specified in Annex M of 3GPP TS
33.328 [2].
The end-to-end security protection of session based messaging (MSRP) and
conferencing (BFCP) is based on the pre-shared key ciphersuites for TLS
(specified in IETF RFC 4279 [46] and with the profile defined in Annex H of
3GPP TS 33.328 [2]) and the MIKEY-TICKET mechanism (specified in IETF RFC 6043
[11] with the profiling of the tickets and procedures given in 3GPP TS 33.328
[2].
The Pre-Shared Key (PSK) is the Traffic-Encrypting Key (TEK) associated with
the Crypto Session (CS) that shall be used in the TLS handshake.
NOTE 1: The Security Parameters Index (SPI) in the CS points to a TEK
Generation Key (TGK) that is used to derive the TEK for the crypto session
using the CS ID (and some other parameters). The SPI could also point to a TEK
directly.
If the MRFC and the MRFP support and are configured to use the e2e protection
of the TCP based media using the pre-shared key ciphersuites for TLS and the
MIKEY-TICKET mechanism, the following functional requirements apply.
The list of pre-shared key ciphersuites for TLS supported by the MRFP shall be
preconfigured in the MRFC.
The MRFC acting as the session initiator shall:
\- prepare the media security offer in the SDP body of the SIP INVITE request;
\- include a single crypto session of type TLS in the TRANSFER_INIT message
according to procedures specified in 3GPP TS 33.328 [2]; and
NOTE 2: Depending on the KMS and a local policy, the MRFC will either interact
with the KMS to obtain keys and the MIKEY-TICKET ticket usable for the served
UE or will create the ticket by itself. In the latter case, MIKEY-TICKET mode
3 as specified in IETF RFC 6043 [11] is used, and the MRFC will then perform
all key and ticket generation functions otherwise performed by the KMS.
\- insert in the SDP offer the SDP key management protocol attribute \"a=key-
mgmt\" specified in IETF RFC 4567 [47] which indicates use of the MIKEY-TICKET
ticket and contains the TRANSFER_INIT message.
Upon receipt of the SIP response with the SDP answer the MRFC shall check that
the responder is authorized before completing the media security setup. If the
MRFC notices that the other endpoint is not as expected, the MRFC shall abort
the session setup. Otherwise the MRFC shall derive the PSK and shall send it
to the MRFP.
Upon receipt of the SIP INVITE request with the SDP offer containing the media
security offer and the SDP key management protocol attribute \"a=key-mgmt\"
specified in IETF RFC 4567 [47] which indicates use of the MIKEY-TICKET ticket
and contains the TRANSFER_INIT message the MRFC shall:
\- check if it is authorized to resolve the ticket and if that is the case the
MRFC interacts with the KMS to resolve the ticket and receive keys;
\- include the MIKEY-TICKET response in the generated TRANSFER_RESP message;
\- insert in the SDP answer the SDP key management protocol attribute \"a=key-
mgmt\" specified in IETF RFC 4567 [47] which indicates use of the MIKEY-TICKET
ticket and contains the TRANSFER_RESP message; and
\- shall derive the PSK and shall send it to the MRFP.
The MRFC acting as the session initiator or the session responder shall:
\- determine via SDP negotiation as specified in IETF RFC 4145 [12] if the
MRFP needs to act as TCP client or server;
\- request the MRFP to start the TCP connection establishment if the MRFP
needs to act as TCP client;
\- determine via SDP negotiation if the MRFP needs to act as TLS client or
server as specified in the clauses below;
NOTE 3: The determination of the TLS client/server role relies on different
rules for MSRP and BFCP.
\- if the MRFP needs to act as TLS client, request the MRFP to start the TLS
session setup once the TCP connection is established towards the served UE;
and
\- apply additional specific procedures specified for the MSRP in clause
7.1.1.2 or for the BFCP in clause 7.1.1.3.
The MRFP shall:
\- upon request from the MRFC, start a TCP connection establishment by sending
a TCP SYN;
\- release the underlying TCP bearer connection as soon as the TLS session is
released;
\- be capable to support both the TLS server and TLS client roles;
\- when being instructed to start the TLS session setup, act as a TLS client
and establish the TLS session as soon as the underlying TCP bearer connection
is established;
\- uniquely associate the PSK received from the MRFC with the corresponding
TCP based media stream;
\- use the received PSK in the TLS handshake; and
\- apply additional specific procedures specified for the MSRP in clause
7.1.1.2 or for the BFCP in clause 7.1.1.3.
#### 7.1.1.2 Specific requirements for session based messaging (MSRP)
For the each MSRP media stream requiring e2e security, the MRFC shall:
a) indicate \"TCP/TLS/MSRP\" as transport protocol when requesting resources
from the MRFP; and
b) determine via SDP negotiation if the MRFP needs to act as TLS client or TLS
server as specified in IETF RFC 4572 [14] using the IETF RFC 4145 [12]
\"a=setup\" SDP attribute as follows:
\- if the MRFC sends the \"a=setup:active\" SDP attribute in the SDP answer
towards the UE, the MRFP shall act as TLS client;
\- if the MRFC sends the \"a=setup:passive\" SDP attribute in the SDP answer
towards the UE, the MRFP shall act as TLS server;
\- if the MRFC receives the \"a=setup:active\" SDP attribute in the SDP answer
from the UE, the MRFP shall act as TLS server; and
\- if the MRFC receives the \"a=setup:passive\" SDP attribute in the SDP
answer from the UE, the MRFP shall act as TLS client.
NOTE: Since the \"a=setup:\" SDP attribute is used for the negotiation of the
client/server roles for both protocols, TCP and TLS, then the assignment of a
particular endpoint role (client or server) also applies for both protocols
(e.g. the TLS server role assignment means also the TCP server role
assignment).
The MRFP shall send the TLS protected MSRP packets to the served UE and shall
accept the TLS protected MSRP packets from the served UE as requested by the
MRFC.
#### 7.1.1.3 Specific requirements for conferencing (BFCP)
For the each BFCP media stream requiring e2e security, the MRFC shall:
a) indicate \"TCP/TLS/BFCP\" as transport protocol when requesting resources
from the MRFP; and
b) determine via SDP negotiation (see IETF RFC 4583 [17]) if the MRFP needs to
act as TLS client or TLS server as follows:
\- if the MRFC receives an initial SDP offer from the served UE, the MRFP
shall act as TLS server; or
\- if the MRFC sends an initial SDP offer towards the served UE, the MRFP
shall act as TLS client.
The MRFP shall send the TLS protected BFCP packets to the served UE and shall
accept the TLS protected BFCP packets from the served UE as requested by the
MRFC.
There is never a BFCP session between two UEs, therefore only the IMS UE might
be located behind a remote firewall/NAT device, i.e. the use case where both
peers are behind a NAT need not be considered for the Mp interface, see clause
4.2.3.
## 7.2 Procedures
### 7.2.1 End-to-end security for TCP-based media using TLS
#### 7.2.1.1 Generic procedures
##### 7.2.1.1.1 Ad-hoc Conferences
IMS conferencing concepts and procedures are specified in 3GPP TS 23.228 [3],
3GPP TS 24.147 [21] and 3GPP TS 24.229 [5]. An ad-hoc conference starts
without any prior booking or reservation when a user initiates the conference,
for further definition of ad-hoc conference, see 3GPP TS 24.147 [21]. Further
participants can then be added to the conference without any prior reservation
of resources, through either, a \"dial-in\" scenario where the end user calls
the conference or by a method of \"dial-out\" where the conference calls the
participant.
When participating in conferences, the IMS UEs and the conference server may
use the e2e security of the session based message conferencing (MSRP) and
conferencing (BFCP) using a TLS tunnel established with the MIKEY-TICKET
mechanism (specified in IETF RFC 6043 [11] with the profiling of the tickets
and procedures given in 3GPP TS 33.328 [2]. The conference focus shall verify
that the UE identity (KMS UID) specified in the MIKEY-TICKET exchange is
authorized to join the conference.
NOTE: e2e security between IMS UE and conference server does not imply e2e
security between two IMS UEs.
#### 7.2.1.2 Specific procedures for session based messaging (MSRP)
##### 7.2.1.2.1 General
When receiving an SDP offer for MSRP media, the MRFC:
\- shall provide the received SDP \"a=path\" attribute to the MRFP as part of
the remote descriptor of the corresponding call leg;
\- shall indicate \"TCP/MSRP\" or \"TCP/TLS/MSRP\" (if e2e media security is
applied) as transport protocol to the MRFP;
\- if the \"a=msrp-cema\" SDP attribute is not contained in an SDP offer,
should use the IP address and port within the first entry of the \"a=path\"
SDP attribute in received SDP to configure the remote address and port at the
IMS-AGW;
NOTE 1: It is the normal MRFC procedure to configure the received SDP
\"c=\"-line and \"m=\"-line IP address and TCP port information as the remote
address and port at the MRFP. The SDP \"c=\"-line and \"m=\"-line address and
port information will match the \"a=path\" address information unless there is
an MSRP relay in the path.
\- shall request the MRFP to allocate an IP address, TCP port and MSRP session
ID and provide this information in an MSRP \"a=path\" attribute;
\- shall include the MSRP \"a=path\" attribute received from the MRFP in the
SDP answer it sends; and
\- if the SDP offer included an \"a=msrp-cema\" SDP attribute, shall include
an \"a=msrp-cema\" SDP attribute in the SDP answer.
When sending an SDP offer for MSRP media, the MRFC:
\- shall request the MRFP to allocate an IP address, TCP port and MSRP session
ID and provide this information in an MSRP \"a=path\" attribute;
\- shall indicate \"TCP/MSRP\" or \"TCP/TLS/MSRP\" (if e2e media security is
applied) as transport protocol to the MRFP;
\- shall include the MSRP \"a=path\" attribute received from the MRFP in the
SDP offer it sends; and
\- should include an \"a=msrp-cema\" SDP attribute in the SDP offer.
When receiving the corresponding SDP answer for MSRP media, the MRFC:
\- shall provide the received SDP \"a=path\" attribute to the MRFP; and
\- if the \"a=msrp-cema\" SDP attribute is not contained in an SDP offer,
should use the IP address and TCP port within the first entry of the
\"a=path\" SDP attribute in received SDP to configure the remote address and
port at the IMS-AGW
When the MRFP is configured to handle MSRP media and is requested to allocate
an IP address, TCP port and MSRP session ID, it shall provide this information
in an MSRP \"a=path\" attribute and shall store this information. When the
MSRP then receives MSRP packets, it shall compare the session ID part of the
received MSRP packets with the stored session ID.
NOTE 2: Comparing only the session ID, but not the address information is in
accordance with IETF draft-ietf-simple-msrp-sessmatch-10 [13], but also
compatible with peers using IETF RFC 4975 [6] without extensions or in
combination with IETF RFC 6714 [9]. No procedures to indicate the method of
session matching (according to IETF RFC 4975 [6] or IETF draft-ietf-simple-
msrp-sessmatch-10 [13]) to the MRFP are defined.
The MRFP shall include the URL(s) received in the \"a=path\" SDP attribute
from the MRFC in the \"To-Path\" header field of MSRP packets it sends.
##### 7.2.1.2.2 IMS UE originating procedures (\"dial-in\" scenario) for e2e
Figure 7.2.1.2.2.1 shows the \"dial-in\" conference procedure for one MSRP
session using TLS and KMS based security.
NOTE 1: In the shown example it is assumed that the UE-A and the MRFC/MRFP
support IETF RFC 6714 [9].
Figure 7.2.1.2.2.1: Originating (\"dial-in\") example call flow for e2e case
The IMS UE-A and the MRFC performs an IMS \"dial-in\" conference session set-
up according to 3GPP TS 23.228 [3], 3GPP TS 24.147 [21] and with modifications
described in 3GPP TS 33.328 [2].
The procedure in the above figure for requesting e2e security for a media
stream is described step-by-step with an emphasis on the additional aspects
for the MRFC and the MRFP of the MSRP based media e2e protection using TLS and
KMS.
1\. Depending on the KMS and a local policy, the IMS UE-A will either interact
with the KMS to obtain keys and a MIKEY-TICKET ticket usable for the MRFC, or
it will create the ticket by itself. In the latter case, MIKEY-TICKET mode 3
as specified in IETF RFC 6043 [11] is used, and the IMS UE-A will then perform
all key and ticket generation functions otherwise performed by the KMS.
The IMS UE-A generates the TRANSFER_INIT message according to IETF RFC 6043
[11] containing the ticket associated with the MRFC. The identities of the
initiator/IMS UE-A and the responder/MRFC in the message shall be the KMS UIDs
derived from the URI\'s in the To and From header fields in the SIP initial
INVITE request.
A single Crypto Session is included in the TRANSFER_INIT message as described
in Annex H.3 of 3GPP TS 33.328 [2]. The protocol type in the Crypto Session
shall be set to TLS.
The IMS UE-A creates the SDP offer with an MSRP based media over TLS transport
protocol and inserts the SDP attribute \"a=key-mgmt\" specified in IETF RFC
4567 [47] which indicates use of the MIKEY-TICKET ticket and contains the
TRANSFER_INIT message encapsulated in the key management attribute and with an
\"a=setup:actpass\" SDP attribute.
2\. The IMS UE-A sends the INVITE request with the SDP offer.
NOTE 2: For the IMS UE-A located in its home service area the INVITE request
will be sent to the MRFC via the P-CSCF, the S-CSCF and the AS.
NOTE 3: If the P-CSCF supports e2ae security, the P-CSCF (IMS-ALG) checks for
the presence of the indication \"e2ae-security requested by UE\". As the
indication is not present, the P-CSCF forwards the SDP offer towards the
S-CSCF. The S-CSCF performs the required procedures according to 3GPP TS
23.228 [3] and forwards the SDP offer to the AS/MFRC.
3\. Upon reception of the SIP INVITE request with the SDP offer containing the
media stream that uses \"TCP/TLS/MSRP\" transport protocol, the MRFC checks
for the presence of the key management protocol \"a=key-mgmt\" SDP attribute.
If it indicates the usage of the MIKEY the MRFC extracts the key management
data from the keymgmt-data field and \"base64\" decodes them to reconstruct
the original TRANSFER_INIT message. The MRFC checks if it is authorized to
resolve the ticket and if that is the case the MRFC interacts with the KMS to
resolve the ticket and receive keys.
4\. - 6. The MRFC uses the \"Reserve And Configure IMS resources\" procedure
to request a termination for \"TCP/TLS/MSRP\" media with the request to
establish the TLS session once the TCP connection is established (effectively
making the MRFP acting as the TLS client), in accordance with the information
in the \"a=setup\" attribute that will be sent in the SDP answer. The MRFC
provides the IP address and port received from the IMS UE-A and the derived
Pre-Shared Key (PSK) key i.e. the Traffic-Encrypting Key (TEK) associated with
the Crypto Session (CS) that will be used by the MRFP in the TLS handshake.
7\. The MRFP sends a TCP SYN towards the IMS UE-A to establish a TCP
connection. The IMS UE-A answers with a TCP SYN ACK and the MRFP replies with
a TCP ACK, completing the TCP connection establishment.
8\. Upon completion of the TCP connection establishment, the MRFP starts the
establishment of the TLS session using the received PSK to set-up a TLS-PSK
tunnel to protect the MSRP messages.
9\. The MRFC includes the MIKEY-TICKET response in the TRANSFER_RESP message
created according to IETF RFC 6043 [11]. The MRFC inserts the SDP key
management protocol attribute \"a=key-mgmt\" specified in IETF RFC 4567 [47]
which indicates use of the MIKEY-TICKET ticket and contains the \"base64\"
encoded TRANSFER_RESP message. The TRANSFER_RESP message includes the
information required for the generation of keys.
10\. The MRFC sends the 200 OK final response (or 18x provisional response)
with the SDP answer for the MSRP session towards the IMS UE-A.
After receiving the SIP 200 OK final response (or 18x provisional response)
with the SDP answer the IMS UE-A extracts the key management data from the
keymgmt-data field and \"base64\" decodes them to reconstruct the original
TRANSFER-RESP message. The IMS UE-A verifies the TRANSFER-RESP message
according to IETF RFC 6043 [11] and then verifies that the authenticated
identity of the recipient corresponds to the policy for the call before
completing the media security set-up.
##### 7.2.1.2.3 IMS UE terminating procedures (\"dial-out\" scenario) for e2e
Figure 7.2.1.2.3.1 shows the \"dial-out\" conference procedure for one MSRP
session using TLS and KMS based security.
NOTE: In the shown example it is assumed that the UE-B and the MRFC/MRFP
support IETF RFC 6714 [9].
Figure 7.2.1.2.3.1: Terminating (\"dial-out\") example call flow for e2e case
The MRFC and the IMS UE-B performs an IMS \"dial-out\" conference session set-
up according to 3GPP TS 23.228 [3], 3GPP TS 24.147 [21] and with modifications
described in 3GPP TS 33.328 [2].
The procedure in the above figure for requesting e2e security for a media
stream is described step-by-step with an emphasis on the additional aspects
for the MRFC and the MRFP of the MSRP based media e2e protection using TLS and
KMS.
1\. The MRFC receives a trigger to create an ad-hoc conference. Depending on
the KMS and a local policy, the MRFC will either interact with the KMS to
obtain keys and a MIKEY-TICKET ticket usable for the IMS UE-B, or it will
create the ticket by itself. In the latter case, MIKEY-TICKET mode 3 as
specified in IETF RFC 6043 [11] is used, and the MRFC will then perform all
key and ticket generation functions otherwise performed by the KMS.
The MRFC generates the TRANSFER_INIT message according to IETF RFC 6043 [11].
The identities of the initiator and the responder in the message shall be the
KMS UIDs derived from the URI\'s in the To and From header fields in the SIP
initial INVITE request.
A single Crypto Session is included in the TRANSFER_INIT message as described
in Annex H.3 of 3GPP TS 33.328 [2]. The protocol type in the Crypto Session
shall be set to TLS.
2\. - 4. The MRFC uses the \"Reserve IMS resources\" procedure to request a
termination for \"TCP/TLS/MSRP\" media towards the IMS UE-B.
5\. The MRFC creates the SDP offer with an MSRP based media over TLS transport
protocol and inserts the SDP attribute \"a=key-mgmt\" specified in IETF RFC
4567 [47] which indicates the use of the MIKEY-TICKET ticket and contains the
TRANSFER_INIT message encapsulated in the key management attribute and with an
\"a=setup:actpass\" SDP attribute.
6\. The MRFC sends the INVITE request with the SDP offer towards the IMS UE-B.
7\. Upon reception of the SIP INVITE request with the SDP offer containing the
media stream that uses transport \"TCP/TLS/MSRP\", the IMS UE-B checks if it
is authorized to resolve the ticket and if that is the case the IMS UE-B
interacts with the KMS to resolve the ticket and receive keys.
8\. The IMS UE-B includes the MIKEY-TICKET response in the TRANSFER_RESP
message created according to IETF RFC 6043 [11]. The IMS UE-B inserts the SDP
key management protocol attribute \"a=key-mgmt\" specified in IETF RFC 4567
[47] which indicates use of the MIKEY-TICKET ticket and contains the
TRANSFER_RESP message.
The IMS UE-B sends the 200 OK final response (or 18x provisional response)
with the SDP answer for the MSRP session.
9\. - 11. After receiving the SIP 200 OK final response (or 18x provisional
response) with the SDP answer the MRFC extracts the key management data from
the keymgmt-data field and \"base64\" decodes them to reconstruct the original
TRANSFER-RESP message. The MRFC verifies the TRANSFER-RESP message according
to IETF RFC 6043 [11] and then verifies that the authenticated identity of the
recipient corresponds to the policy for the call before completing the media
security set-up.
The MRFC uses the \"Configure IMS resources\" procedure to configure the
termination towards the IMS UE-B with the IP address and port received from
the IMS UE-B and the derived Pre-Shared Key (PSK) key i.e. the Traffic-
Encrypting Key (TEK) associated with the Crypto Session (CS) that will be used
by the MRFP in the TLS handshake.
12\. The IMS UE-B sends a TCP SYN towards the MRFP to establish a TCP
connection. The MRFP answers with a TCP SYN ACK and the IMS UE-B replies with
a TCP ACK, completing the TCP connection establishment.
13\. Upon completion of the TCP connection establishment, the IMS UE-B starts
the establishment of the TLS session using the received PSK to set-up a TLS-
PSK tunnel to protect the MSRP messages.
#### 7.2.1.3 Specific procedures for conferencing (BFCP)
##### 7.2.1.3.1 IMS UE originating procedures (\"dial-in\" scenario) for e2e
Figure 7.2.1.3.1.1 shows the \"dial-in\" conference procedure for one BFCP
session using TLS and KMS based security.
Figure 7.2.1.3.1.1: Originating (\"dial-in\") example call flow for e2e case
The IMS UE-A and the MRFC perform an IMS \"dial-in\" conference session set-up
according to 3GPP TS 23.228 [3], 3GPP TS 24.147 [21] and with modifications
described in 3GPP TS 33.328 [2].
The procedure in the above figure for requesting e2e security for a media
stream is described step-by-step with an emphasis on the additional aspects
for the MRFC and the MRFP of the BFCP based media e2e protection using TLS and
KMS.
1\. As step 1 in clause 7.2.1.2.2.
2\. As step 2 in clause 7.2.1.2.2 with the exception that SDP offer indicates
\"TCP/TLS/BFCP\" as transport protocol.
3\. As step 3 in clause 7.2.1.2.2.
4\. - 6. As steps 4 - 6 in clause 7.2.1.2.2 with the exception that the MRFC
requests a termination for \"TCP/TLS/BFCP\" media using the \"Configure BFCP
Termination\" procedure and the MFRC does not request the MRFP to start a TLS
connection establishment (i.e. to take a TLS client role).
7\. As step 7 in clause 7.2.1.2.2.
8\. As step 9 in clause 7.2.1.2.2.
9\. As step 10 in clause 7.2.1.2.2 with the exception that an SDP answer
indicates \"TCP/TLS/BFCP\" as transport protocol.
10\. Upon completion of a TCP connection establishment and reception of the
SDP answer with a key management data, the IMS UE-A starts the establishment
of a TLS session, in accordance to IETF RFC 4583 [17], using received PSK to
set-up a TLS-PSK tunnel to protect BFCP messages.
##### 7.2.1.3.2 IMS UE terminating procedures (\"dial-out\" scenario) for e2e
Figure 7.2.1.3.2.1 shows the \"dial-out\" conference procedure for one BFCP
session using TLS and KMS based security.
Figure 7.2.1.3.2.1: Terminating (\"dial-out\") example call flow for e2e case
The MRFC and the IMS UE-B perform an IMS \"dial-out\" conference session set-
up according to 3GPP TS 23.228 [3], 3GPP TS 24.147 [21] and with modifications
described in 3GPP TS 33.328 [2].
The procedure in the above figure for requesting e2e security for a media
stream is described step-by-step with an emphasis on the additional aspects
for the MRFC and the MRFP of the BFCP based media e2e protection using TLS and
KMS.
1\. As step 1 in clause 7.2.1.2.3.
2\. - 4. As steps 4 - 6 in clause 7.2.1.2.3 with the exception that the MRFC
requests a termination for \"TCP/TLS/BFCP\" media.
NOTE 1: The Remote BFCP Connection Address information element is mandatory in
the \"Configure BFCP Termination\" procedure, see 3GPP TS 23.333 and thus this
procedure cannot be used to request the BFCP termination. A new Mp procedure
to request a BFCP termination in the MRFP needs to be specified to enable a
\"dial-out\" conference session set-up scenario for BFCP based media. Addition
of a new procedure is not specific for e2e media security and thus will be
done outside the Extended IMS media plane security feature.
5\. As step 5 in clause 7.2.1.2.3 with the exception that SDP offer indicates
\"TCP/TLS/BFCP\" as transport protocol.
6\. As step 6 in clause 7.2.1.2.3 with the exception that SDP offer indicates
\"TCP/TLS/BFCP\" as transport protocol.
7\. As step 7 in clause 7.2.1.2.3.
8\. As step 8 in clause 7.2.1.2.3 with the exception that SDP answer indicates
\"TCP/TLS/BFCP\" as transport protocol.
9\. - 11. The MRFC requests the MRFP to start a TLS session establishment once
a TCP connection is established and to configure the termination towards the
IMS UE-B with the IP address and port received from the IMS UE-B and the
derived Pre-Shared Key (PSK) i.e. the Traffic-Encrypting Key (TEK) associated
with the Crypto Session (CS) that will be used by the MRFP in the TLS
handshake.
NOTE 2: The Local BFCP Connection Address Request information element is
mandatory in the \"Configure BFCP Termination\" procedure, see 3GPP TS 23.333,
but the Local BFCP Connection Address was already requested and received from
the MRFP within steps 2 - 4, sent to the IMS UE (see step 6), and thus this
procedure cannot be used to configure the BFCP termination with the remote
BFCP connection address. A new Mp procedure to configure a BFCP termination in
the MRFP needs to be specified to enable a \"dial-out\" conference session
set-up scenario for BFCP based media. Addition of a new procedure is not
specific for e2e media security and thus will be done outside the Extended IMS
media plane security feature.
12\. As step 12 in clause 7.2.1.2.3.
13\. Upon completion of a TCP connection establishment the MRFP starts a TLS
session establishment using received PSK to set-up a TLS-PSK tunnel that will
protect BFCP messages.
NOTE 3: For the BFCP the TLS session set-up is always initiated by the SDP
offerer (see IETF RFC 4583 [17]).
# 8 3GPP- ITU-T H.248 requirements gap analysis
## 8.1 Relevant ITU-T Recommendations
### 8.1.1 Capabilities related to TCP bearer support
Relevant ITU-T Recommendations of the H.248.x-series:
\- TCP bearer type: ITU-T H.248.89 [36], primarily with respect to support of
TCP-to-TCP interworking resulting in \"TCP proxy\" mode.
### 8.1.2 Capabilities related to NAT-T support
Relevant ITU-T Recommendations of the H.248.x-series:
\- L3/L4 level NAT traversal: ITU-T H.248.84 [24] with respect to support of
\"TCP merge\" mode;
\- L4+ level NAT traversal: ITU-T H.248.78 [33] with respect to support of a
bearer-level application gateway for MSRP-over-(TLS/)TCP traffic (related to
the MSRP IWF \"media plane\" in Annex C).
### 8.1.3 Capabilities related to media security support
Relevant ITU-T Recommendations of the H.248.x-series:
\- TLS bearer type: ITU-T H.248.90 [41] covers all aspects related the control
of TLS sessions via H.248;
\- DTLS bearer type: ITU-T H.248.93 [42] covers all aspects related the
control of DTLS sessions via H.248 (present working assumption: the very
majority of \"TLS package elements\" could be reused for DTLS control as
well).
### 8.1.4 Capabilities related to support of MGW autonomous behaviour
Relevant ITU-T Recommendations of the H.248.x-series:
\- Interlinkage capability: ITU-T H.248.92 [43] with respect to the
establishment and release of TCP bearer connections, TLS and DTLS security
sessions, and combined TLS/TCP bearer handling.
## 8.2 Scope of ITU-T \"(D)TLS transport security\"
The TLS and TLS/TCP related work items are primarily driven from the legacy
infrastructure of existing implementations, i.e., related to the plethora of
IETF RFCs in that area. The major requirements are collected by ITU-T H.248.91
[40].
It could be concluded that the ITU-T scope is wider than 3GPP Rel-12.
## 8.3 Status gap analysis
There is not yet any new stage 2 requirement (for H.248) identified within
work item [eMEDIASEC], which would be missing in the ITU-T work. A minimum
[eMEDIASEC] service (with scope on Rel-12) could be actually realized with a
subset of the ITU-T capabilities.
# 9 Conclusions and recommendations
This technical report analyses requirements and procedures for the Iq, Ix and
Mp IMS H.248 profiles for support of
\- end-to-end TCP bearer connection control and related NAT traversal;
\- e2ae media security of TCP-based media (MSRP, BFCP) and UDP-based media
(T.38 fax over UDPTL/UDP transport) using (D)TLS;
\- e2e media security of TCP-based media (MSRP, BFCP);
\- protection of TCP-based (MSRP, BFCP) media at the MRF.
It is concluded that these procedures and requirements can be realized with
the ITU-T H.248 capabilities outlined in clause 8.
It is recommended to 3GPP that the necessary details within this report be
used as a basis for further normative work within the Release 12 timeframe. It
is further recommended that Stage 2 and Stage 3 work be specified within
existing specifications as defined within Annex A.
###### ### Annex A: Impacts on existing specifications
Table A.1 identifies the existing specifications that require modification to
support TCP bearer connection control and related NAT-traversal support
(limited to the IMS H.248 profile aspects).
Table A.2 identifies the existing specifications that require modification to
support extended IMS media plane security (limited to the IMS H.248 profile
aspects).
Table A.1: Impacts for TCP bearer connection control and related NAT-traversal
support\ (IMS H.248 profiles aspects)
+------------------------+----------------+-------------------------+ | Existing Specification | Responsible WG | Brief summary of | | | | impacts | +------------------------+----------------+-------------------------+ | 3GPP TS 23.334 | CT4 | Requirements and | | | | procedures for: | | | | | | | | - TCP bearer support | | | | (based on clause | | | | 4.4); | | | | | | | | - Optional support of | | | | delayed TCP | | | | connection | | | | establishment | | | | (based on clause | | | | 4.4.2.2 and | | | | 4.4.2.1.2); | | | | | | | | - Optional support of | | | | simultaneous | | | | opening of TCP | | | | connection by both | | | | interconnected | | | | peers (based on | | | | clause 4.4.2.3); | | | | | | | | - Optional support of | | | | MSRP-aware | | | | interworking (based | | | | on clause 4.1.4). | +------------------------+----------------+-------------------------+ | 3GPP TS 23.333 | CT4 | Requirements and | | | | procedures for: | | | | | | | | - TCP bearer support | | | | (based on clause | | | | 4.4). | +------------------------+----------------+-------------------------+ | 3GPP TS 29.334 | CT4 | Corresponding H.248 | | | | capabilities. | +------------------------+----------------+-------------------------+ | 3GPP TS 29.333 | CT4 | Corresponding H.248 | | | | capabilities. | +------------------------+----------------+-------------------------+
Table A.2: Impacts for extended IMS media plane security\ (IMS H.248 profiles
aspects)
+------------------------+----------------+-------------------------+ | Existing Specification | Responsible WG | Brief summary of | | | | impacts | +------------------------+----------------+-------------------------+ | 3GPP TS 23.334 | CT4 | Requirements and | | | | procedures for: | | | | | | | | - TLS session control | | | | (based on clause | | | | 4.3); | | | | | | | | - E2ae media security | | | | for TCP-based media | | | | (based on clauses | | | | 5.1.1 and 5.2.1) | | | | | | | | - E2e media security | | | | for TCP-based media | | | | (based on clauses | | | | 5.1.2 and 5.2.2) | | | | | | | | - E2ae media security | | | | for UDP-based media | | | | (based on clauses | | | | 5.1.3 and 5.2.3) | +------------------------+----------------+-------------------------+ | 3GPP TS 29.162 | CT3 | Requirements and | | | | procedures for: | | | | | | | | - E2e media security | | | | for TCP-based media | | | | (based on clauses | | | | 6.1 and 6.2) | +------------------------+----------------+-------------------------+ | 3GPP TS 23.333 | CT4 | Requirements and | | | | procedures for: | | | | | | | | - E2e media security | | | | for TCP-based media | | | | (based on clauses | | | | 7.1 and 7.2) | +------------------------+----------------+-------------------------+ | 3GPP TS 29.334 | CT4 | Corresponding H.248 | | | | capabilities. | +------------------------+----------------+-------------------------+ | 3GPP TS 29.238 | CT4 | Corresponding H.248 | | | | capabilities. | +------------------------+----------------+-------------------------+ | 3GPP TS 29.333 | CT4 | Corresponding H.248 | | | | capabilities. | +------------------------+----------------+-------------------------+
###### ### Annex B: Release 12 requirements and procedures for extended media
security
The Rel-12 requirements from 3GPP TS 33.328 [2] version 12.3.0, regarding
extended media security are copied and Rel-12 new text additions are shown in
this Annex as underlined text. For completeness, in some chapters, the text of
3GPP TS 33.328, version 11.0.0 is shown without underlines.
This Annex will not be updated to align with possible future versions of 3GPP
TS 33.328 [2].\ 3GPP TS 33.328 [2] overrides any text in this Annex.
This Annex shows the clause numbers and titles of 3GPP TS 33.328 [2], which
contain relevant requirements for the present document.
NOTE 1: The requirements and procedure descriptions in this annex, which are
covered in the main body of the present document, are marked with yellow
background.
NOTE 2: Text which is not copied from 3GPP TS 33.328 [2] is represented by
_italic characters_.
**33.328: 1 Scope**
[The media plane security for MSRP, used in session-based messaging, is based
on TLS. TLS is also used to protect BFCP. Key management solutions for MSRP
and BFCP security are defined in this specification.]{.underline}
[Two normative Annexes to the present document address IMS media plane
security for immediate messaging and conferencing, respectively. The media
plane security for session-based messaging is addressed in the main body of
this specification.]{.underline}
[]{.underline}
**33.328: 2 References**
...
[[21] IETF RFC 4975: \"The Message Session Relay Protocol
(MSRP)\".]{.underline}
[[22] 3GPP TS 33.310: \"Network Domain Security (NDS); Authentication
Framework (AF)\".]{.underline}
[[23] IETF RFC 4582: \"The Binary Floor Control Protocol
(BFCP)\".]{.underline}
[[24] IETF RFC 6714: \"Connection Establishment for Media Anchoring (CEMA) for
the Message Session Relay Protocol (MSRP)".]{.underline}
[[25] 3GPP TS 24.147: \"Conferencing using the IP Multimedia (IM), Core
Network (CN) subsystem\".]{.underline}
[[26] IETF RFC 4575: \"A Session Initiation Protocol (SIP) Event Package for
Conference State\".]{.underline}
[[27] GSM Association, Rich Communication Suite 5.1 Advanced Communications
Services and Client Specification, Version 1.0, August 2012.]{.underline}
[[34] ITU-T recommendation T.38 (09/2010): \"Procedures for real-time Group 3
facsimile communication over IP networks\".]{.underline}
> [[35] 3GPP TS 26.114: \"IP Multimedia Subsystem (IMS); Multimedia telephony;
> Media handling and interaction\".]{.underline}
>
> [[36] IETF RFC 6347: \"Datagram Transport Layer Security Version
> 1.2\".]{.underline}
>
> [[37] RFC 7345-00 \"UDP Transport Layer (UDPTL) over Datagram Transport
> Layer Security (DTLS)\".]{.underline}
[]{.underline}
**33.328: 4 IMS media plane security overview,\ 33.328: 4.1.1 General**
...[TLS is used to protect MSRP based traffic. Key management for e2ae
protection of MSRP relies on exchanging certificates and transmission of the
fingerprints of these certificates over SDP. E2e protection can be achieved
through the same KMS and ticket concept that is used for RTP traffic. The
established key is used to setup a TLS-PSK tunnel between the two
parties.]{.underline}
[Editor´s Note: Using the certificate fingerprint mechanism to provide e2e
protection is ffs]{.underline}
**33.328: 4.1.2.1 SDES based solution**
[Wordings like "e2e security using SDES" as used in the following refer to
security for RTP based media, as SDES does only apply to protecting
RTP.]{.underline}
**33.328: 4.1.2.3 Certificate fingerprints based solution for TLS**
[Key management solution for **e2ae** protection of MSRP based media is based
on the ciphersuites and session keys negotiated via the TLS handshake between
the UE and the IMS Access Gateway (GW). The TLS record protocol secures the
actual media. Mutual authentication during the TLS handshake is achieved using
certificates, with the certificate fingerprints being transmitted using the
SDP fingerprint attribute in the SDP offer-answer exchange between the UE and
the P-CSCF (IMS ALG).]{.underline}
[This approach is specified in RFC 4975 [21]. \"TCP/TLS/MSRP\" is used as the
protocol identifier in the m-line of the SDP, and the \"a=fingerprint\"
attribute is used to provide the fingerprint of the certificate.]{.underline}
**33.328: 4.2 IMS media plane security architecture\ 33.328: 4.2.1 General**
[A pre-requisite]{.underline} for [support of]{.underline} **e2e** security
[is that media packets are forwarded transparently]{.underline} by [any nodes
present]{.underline} in the media path [(SRTP packets in case of secure RTP
and TLS packets in case of secure MSRP). This implies that transcoding of RTP
streams is no longer possible.]{.underline}
[]{.underline}
**33.328: 5 IMS media plane security features\ 33.328: 5.1 General**
...[For the protection of real-time traffic, an]{.underline} IMS UE may
support SDES based media plane security mechanisms and/or KMS based media
plane security mechanism. When an IMS UE supports SDES media plane security
mechanisms it shall support procedures for e2ae IMS media plane security and
it may support e2e IMS media plane security.
[For **e2ae** protection of MSRP, an IMS UE may support the TLS based media
plane security mechanism as defined in section 4.1.2.3.]{.underline}
[For **e2e** protection of MSRP, an IMS UE may support the KMS based media
plane security mechanism.]{.underline}
**33.328: 5.2 Media integrity protection**
The use of IMS media integrity protection [for RTP]{.underline} is optional,
except that RTCP shall be integrity protected using SRTCP, in accordance with
RFC 3711 [9].
[The use of IMS media integrity protection for MSRP is optional.]{.underline}
**33.328: 5.3 Media confidentiality protection**
[When IMS media plane security is used for MSRP, TLS transforms with null
encryption should not be used.]{.underline}
**33.328: 5.4.1 Authentication and authorization for e2ae protection**
...[In the TLS solution, mutual authentication between the IMS UE and the IMS
Access GW relies on secure transport of certificate fingerprints using SIP
signalling integrity protection. If the fingerprints of the certificates used
for the TLS handshake match the fingerprints transmitted via SIP signalling,
then the TLS endpoints can be sure that TLS is really established between the
nodes that exchanged the SIP signalling]{.underline}. ...
_(Rel-12 additions in_ _33.328, 5.4.2_ _do not seem related to extended media
security.)_
**33.328: 5.5.4 Security properties for e2ae protection using TLS**
[Based on secure mutual authentication leveraged by the integrity protection
of the SIP signalling messages (cf. clause 5.4.1), TLS provides secure
derivation of session keys to protect the media.]{.underline}
[Similarly as for e2ae protection using SDES, in addition to SIP signalling
security, also the Iq interface for signalling between the P-CSCF (IMS-ALG),
and the media node terminating MSRP/TLS towards the UE, i.e. the IMS Access
GW, needs to be secured, cf. clause 6.2.1.3.]{.underline}
**33.328: 6.1.2 Media security mechanisms for session based messaging (MSRP)**
[In this specification, protection for session based messaging means
protection for IMS traffic using the Message Session Relay Protocol (MSRP) as
defined in RFC 4975 [21] and RFC 6714 [24].]{.underline}
[The integrity and confidentiality protection for IMS traffic using MSRP is
achieved by TLS protection.]{.underline}
[Key management mechanisms for MSRP, as used in this specification, are
described in clause 6.2.\ ]{.underline}
_The following requirements are applicable for e2ae session based messaging
(MSRP)._
**33.328: 6.2.1 Key management mechanisms for e2ae protection\ 33.328: 6.2.1.1
Endpoints for e2ae protection**
... [For IMS session based messaging traffic, the IMS Access GW shall send TLS
protected MSRP packets to and accept TLS protected MSRP packets from the
served UE as requested by the P-CSCF (IMS-ALG). The IMS Access GW shall send
MSRP packets to and accept MSRP packets from the network \-- whether these
packets are specifically protected by TLS is up to the policies of the
operator.]{.underline}
[NOTE: From the IMS access gateway in the direction towards the network, plain
TCP may be used on the next hops, assuming that the interfaces are protected
e.g. using IPsec or physical protection. Optionally, TLS may be used. The IMS
access gateway relays between the TLS connection towards the originating IMS
UE and the connection in the direction towards the terminating IMS UE. Usage
of TLS from the IMS access gateway towards the network is not covered by this
specification.]{.underline}
[]{.underline}
**33.328: 6.2.1.2 Key management protocol for e2ae protection**
... [The key management mechanism for e2ae protection of MSRP traffic shall be
based on certificates and the transmission of certificate fingerprints as
defined in RFC 4975 [21].]{.underline}
[]{.underline}
**33.328: 6.2.1.3.2 Functional extension of the Iq interface for e2ae
protection for MSRP**
[For each MSRP media stream to be set-up with e2ae security the P-CSCF (IMS-
ALG) shall send the certificate fingerprint received from the IMS UE over the
Iq interface to the IMS Access GW in a way that the IMS Access GW is able to
uniquely associate the fingerprint with a media stream.]{.underline}
[Vice versa, for each MSRP media stream to be set-up with e2ae security IMS
Access GW shall send the fingerprint of its certificate over the Iq interface
to the P-CSCF (IMS-ALG) in a way that the IMS Access GW is able to uniquely
associate the fingerprint with a media stream.]{.underline}
[For protection of session based messaging traffic, the IMS Access GW shall,
upon reception of a certificate fingerprint, use the certificate fingerprint
(as described in RFC 4975 [xx]) to verify the establishment of the TLS session
to belong to the served user. When the TLS session has been established, the
IMS Access GW shall be prepared to convert unprotected MSRP packets to
protected MSRP packets and vice versa and send the packets to the UE or
receive them from the UE, as described in clause 7.]{.underline}
[The integrity of the fingerprints sent over the Iq interface is required. The
Iq interface shall be protected by NDS/IP [5]. If cryptographic protection is
applied to the Iq interface then integrity protection shall be used. (See also
NOTE in 6.2.1.3.1.)]{.underline}
[]{.underline}
**33.328: 6.2.3 Key management mechanisms for e2e protection using KMS\
33.328: 6.2.3.1 General**
[The KMS based security mechanism may be used for **e2e** protection of both
real-time traffic and session based messaging (MSRP),]{.underline} ...
**33.328:** **6.2.3.5 Authentication of public identities in REQUEST_INIT and
RESOLVE_INIT**
_Rel-12 additions in 33.328, 6.2.3.5 do not seem related to extended media
security covered by this TR, but copied here for completeness._
... [If a caller requests a ticket based on the identity of the expected
responder, the call will most likely fail if the IMS network decides to divert
the call to another destination. To handle call diversion it is recommended to
set the allowed recipient in tickets to the wildcarded identity ?@?. This
doesn't affect the security of the solution since keys returned by the KMS are
always forked based on the resolver's identity.]{.underline} ...
[]{.underline}
**33.328:** **7.1.1 Indication of support for e2ae security for RTP based
media**
NOTE 1: The names \"e2ae-security supported by UE\" and \"e2ae-security
supported by network\" of the above indications are just placeholders for the
purposes of this specification. Their syntax is defined in the corresponding
stage 3 specification. [These names refer to the RTP case only. Separate names
for MSRP and BFCP are introduced from Rel-12 onwards, cf. clause 7.1.2 and
Annex Y of the present document.]{.underline}
[]{.underline}
**33.328: 7.1.2 Indication of support for e2ae security for MSRP**
[Support for e2ae security for MSRP is indicated during registration in the
same way as for RTP based media, cf. clause 7.1.1. It is done independently
from the indication of support for e2ae security for RTP based media, and uses
its own indications\" e2ae- security for MSRP supported by the UE\" and\"
e2ae-security for MSRP supported by the network\" (the syntax is to be defined
in the corresponding stage 3 specification).]{.underline}
[NOTE 1: The policies of the IMS UE and the network concerning the use of e2ae
security for MSRP are independent from the policies concerning the use of e2ae
security for RTP based media.]{.underline}
[NOTE 2: For compatibility with RCS 5.1, the indication of support for e2ae
security during registration is not a necessary prerequisite for the use of
e2ae security, but it helps to avoid certain error cases, cf. Clause 7.2.1 and
Clause 7.3.1.]{.underline}
[]{.underline}
_The requirements for the procedures of_ _e2ae_ _session based messaging
(clause 5.2.1.2 in this TR) are specified in 33.328._
**33.328: 7.2.1 IMS UE originating procedures for e2ae**
... [If both IMS UE and network indicated support for e2ae security for MSRP
during registration, then the IMS UE shall request e2ae security for MSRP
media streams to be established as described in this clause, unless the IMS UE
initiates a procedure for e2e security for an MSRP media stream.]{.underline}
In Step 1: [For e2ae protection of MSRP the cryptographic information
contained in the SDP Offer consists of the fingerprint of the certificate of
IMS UE A in accordance to RFC 4975 [21].]{.underline}
In Step 2: [For each media stream that uses transport "RTP/SAVP", "RTP/SAVPF"
or "TCP/TLS/MSRP", the]{.underline} P-CSCF (IMS-ALG) checks for the presence
of the indication \"e2ae-security requested by UE\".\ If the indication is
present and the P-CSCF (IMS-ALG) indicated support of e2ae-security [for the
respective protocol (RTP and/or MSRP)]{.underline} during registration, the
P-CSCF (IMS-ALG) allocates the required resources[,]{.underline} includes the
IMS Access GW in the media path and proceeds as specified in this clause. If
the indication is not present [for an SRTP media stream]{.underline} the
P-CSCF (IMS-ALG) proceeds [for this media stream]{.underline} as described in
[clause 7.2.2 or clause 7.2.3 of the present specification.]{.underline}
[ If the indication is not present for an MSRP media stream offered with
transport "TCP/TLS/MSRP", the P-CSCF (IMS-ALG) proceeds for this media stream
as described in clause 7.2.3 of the present specification or in]{.underline}
TS 23.228 [3] [ and skips the further steps in the present
subclause]{.underline}.
In Step [3. The P-CSCF (IMS-ALG) modifies the SDP offer before sending it
towards the S-CSCF. ...\ For e2ae protection of MSRP, the P-CSCF (IMS-ALG)
shall change the transport from "TCP/TLS/MSRP" to "TCP/MSRP" in the SDP Offer
(cf., however, NOTE 4), stores the received fingerprint of the IMS UE A
certificate and removes it as well as the indication \"e2ae-security requested
by UE\" from the description of the media stream in the SDP Offer if
present.]{.underline}
In Step [7. The P-CSCF (IMS-ALG) and the IMS Access GW exchange the
cryptographic information.\ For e2ae protection of MSRP the cryptographic
information communicated by the P-CSCF (IMS-ALG) to the IMS Access GW consists
of the fingerprint of the UE´s certificate in accordance to RFC 4975
[21].]{.underline} The P-CSCF (IMS-ALG) [instructs the IMS Access GW to verify
during the subsequent TLS handshake with the IMS UE (see step 9) that the
fingerprint of the certificate passed by the IMS UE during this TLS handshake
matches the fingerprint passed by the P-CSCF (IMS-ALG) to the IMS Access GW.
In turn, the IMS Access GW communicates the fingerprint of the certificate it
is going to use for setting up protection for this media stream to the P-CSCF
(IMS-ALG).]{.underline}
> In Step 8. [The P-CSCF (IMS-ALG) modifies the SDP Answer before sending it
> to the IMS UE A. ...\ For e2ae protection of MSRP, the P-CSCF (IMS-ALG)
> shall set the transport to "TCP/TLS/MSRP" , remove any fingerprint
> attributes in the SDP Answer, if present, and include the fingerprint of the
> IMS Access GW´s certificate in accordance to RFC 4975 [21].]{.underline}
>
> In Step 9. [RTP]... [In case of MSRP, when the full session setup has been
> completed, the TCP and TLS connection shall be established between the IMS
> UE and the IMS Access GW. When subsequently media are sent from or to the
> IMS UE, the IMS Access GW performs the required TLS specific cryptographic
> operations on the media.]{.underline}
[NOTE 4: In case cryptographic protection is also used in the core network,
the IMS Access GW will also perform the necessary functions for this
additional cryptographic protection. A network may have for example the policy
to use TLS for MSRP also inside the core network. In this case, when e2ae
security is used, TLS has to be established also from the IMS Access GW
towards the core network. This may require enhancements to the procedure
described above but is outside of the scope of this
specification.]{.underline}
[]{.underline}
**33.328: 7.3.1 UE terminating procedures for e2ae**
[RTP...] [If both IMS UE and network indicated support for e2ae-security for
MSRP during registration and the P-CSCF (IMS-ALG) receives an SDP Offer for an
MSRP media stream using transport "TCP/MSRP" (i.e. no TLS) from the S-CSCF,
then the P-CSCF (IMS-ALG) shall establish e2ae-security for the MSRP media
stream]{.underline} as described in this clause.
In Step 1. The S-CSCF in the terminating network receives an SDP Offer for an
RTP media stream [with transport "RTP/AVP" or "RTP/AVPF" or an MSRP stream
with transport "TCP/MSRP"]{.underline} from the originating network.
In Step 3. [For each MSRP media stream offered with transport "TCP/MSRP", if
both the IMS UE and P-CSCF (IMS-ALG) indicated support for e2ae-security for
MSRP during registration, the P-CSCF (IMS-ALG) proceeds for this media stream
as described in this clause and allocates the required resources, includes the
IMS Access GW in the media path for establishing the TLS towards the IMS UE
and retrieves from the IMS Access GW the fingerprint of the certificate the
IMS Access GW is going to use for setting up security for this media stream.
Otherwise the P-CSCF (IMS-ALG) continues as described for media streams
without IMS media plane security.]{.underline}
> [For each MSRP media stream offered with transport "TCP/TLS/MSRP" the P-CSCF
> (IMS-ALG) proceeds as specified in clause 7.3.3 of the present specification
> or in TS 23.228 [3].]{.underline}
In Step 4. [For e2ae protection of an MSRP media stream the P-CSCF (IMS-ALG)
sets the transport to "TCP/TLS/MSRP" in the SDP Offer, removes any fingerprint
attributes for this media stream and includes the fingerprint of the IMS
Access GW´s certificate in accordance to RFC 4975 [21] as well as an
indication that e2ae security is offered by the network. The P-CSCF (IMS-ALG)
then sends the updated SDP Offer to IMS UE B.]{.underline}
In Step 5. [For e2ae protection of MSRP, the IMS UE B includes in the SDP
Answer the fingerprint of the UE´s certificate in accordance to RFC 4975
[21].]{.underline}
In Step 6. The P-CSCF (IMS-ALG) communicates [the cryptographic information
contained in the SDP Answer to the IMS Access GW.]{.underline} ... [\ For e2ae
protection of MSRP, the cryptographic information communicated to the IMS
Access GW consists on the fingerprint of the IMS UE B certificate in
accordance to RFC 4975 [21]. The P-CSCF (IMS-ALG) instructs the IMS Access GW
to verify during the subsequent TLS handshake with the IMS UE (see step 9)
that the fingerprint of the certificate passed by the IMS UE during this TLS
handshake matches the fingerprint passed by the P-CSCF (IMS-ALG) to the IMS
Access GW.].]{.underline}
In Step 7. The P-CSCF (IMS-ALG) [modifies the SDP Answer before sending it to
the S-CSCF. ...\ For e2ae protection of MSRP, the P-CSCF (IMS-ALG) changes the
transport from "TCP/TLS/MSRP" to "TCP/MSRP" in the SDP Answer (cf., however,
NOTE 4) . Further, it removes the fingerprint of the IMS UE B
certificate.]{.underline} The P-CSCF (IMS-ALG) then sends the SDP Answer to
the S-CSCF.
In Step 9. [In case of MSRP, when the full session setup has been completed,
the TCP and TLS connection shall be established between the IMS UE and the IMS
Access GW. When subsequently media are sent from or to the IMS UE, the IMS
Access GW performs the required TLS specific cryptographic operations on the
media.]{.underline}
[NOTE 4: A network may have the policy to use TLS for MSRP also inside the
core network. So TLS from the direction of the core network may be terminated
at the IMS Access GW. This may require enhancements to the procedure described
above but is outside of the scope of this specification.]{.underline}
[NOTE 5: It is left to stage 3 specifications whether the IMS UE takes the
role of TLS client or TLS server. These alternatives are equivalent from a
security point of view.]{.underline}
[]{.underline}
_The requirements for the procedures of_ _e2e_ _session based messaging
(clause 5.2.2.1 and 5.2.2.2 in this TR) and e2e conferencing (clause 5.2.2.3
in this TR) are specified in 33.328._
**33.328: 7.2.3 IMS UE originating procedures for e2e using KMS**
NOTE 2: E2e protected RTP [or MSRP]{.underline} sessions are set-up without
IMS-ALG support, which means that such sessions can be set-up in networks not
providing the IMS-ALG functionality in the P-CSCF.
In Step 8 (last): [IMS UE-A derives]{.underline} the [media]{.underline}
session [keys]{.underline} and [initiates]{.underline} the media [plane
security. For an RTP]{.underline} session [this means sending]{.underline} and
[receiving SRT(C)P streams and for an MSRP]{.underline} session [this means
setting up a TLS-PSK tunnel to protect the MSRP messages.]{.underline}
**33.328: 7.3.3 IMS UE terminating procedures for e2e using KMS**
... [IMS UE-B derives]{.underline} the [media]{.underline} session
[keys]{.underline} and [initiates]{.underline} the media [plane security. For
an RTP]{.underline} session [this means sending and receiving
SRT(C)P]{.underline} streams [and for an MSRP]{.underline} session [this means
setting up a TLS-PSK tunnel to protect the MSRP messages]{.underline}.
**33.328: Annex B (Normative): KMS based key management\ 33.328: B.1 UE
originating procedures**
> In Step 10. ... [In the RTP case, the number of Crypto Sessions included in
> the TRANSFER_INIT message should match the number of RTP streams (both
> incoming and outgoing) as described in RFC 4567 [12]. The protocol type in
> the Crypto Session shall be set to SRTP.]{.underline}
>
> [In the MSRP case, a single Crypto Session is included in the TRANSFER_INIT
> message as described in Annex X.3. The protocol type in the Crypto Session
> shall be set to TLS.]{.underline}
In Step 12. The initiator derives the media session keys and initiates the
media plane security. [For an RTP session this means sending and receiving
SRT(C)P streams and for an MSRP session this means setting up a TLS-PSK tunnel
to protect the MSRP messages.]{.underline}
**33.328: B.2 UE terminating procedures**
Step 10. The responder derives the media session keys and initiates the media
plane security. [For an RTP session this means sending and receiving SRT(C)P
streams and for an MSRP session this means setting up a TLS-PSK tunnel to
protect the MSRP messages.]{.underline}
**33.328: Annex F (normative): IMS media plane security for immediate
messaging\ 33.328: F.2 Security for immediate messaging based on SIP
signalling security**
[Security for immediate messaging based on IMS signalling security shall be
provided by the SIP signalling protection mechanisms specified in TS 33.203
[4].]{.underline}
[NOTE1: The usage of the "P-Asserted-Identity" header provides secure
identification of the sender of a message by the receiver, unless the sender
has chosen to hide its identity, in which case the receiver will not learn the
sender's identity.]{.underline}
[NOTE2: SIP messages between the UE and the P-CSCF (IMS-ALG) can be
confidentiality-protected either by the confidentiality mechanisms of IPsec or
TLS as defined in TS 33.203 [4], or by confidentiality provided by the
underlying access network, according to clause 6.2.1.2 of the present
specification. The IMS UE is aware of the established protection mechanism,
but the P-CSCF takes the final decision.]{.underline}
[NOTE3: The IMS UE can be aware of the protection mechanism for immediate
messaging on the first hop only, and there is no way for the IMS UE to ensure
the use of protection mechanisms on further hops. Moreover, nodes in the IMS
core (in particular the P- and S-CSCF) will have access to the clear text
message content.]{.underline}
[NOTE4: Application servers may be used for storing instant messages for a
user that is currently not registered or for distributing instant messages to
multiple recipients. In this solution, such application servers have access to
the message content and must be trusted.]{.underline}
[]{.underline}
**33.328: Annex G (normative): IMS media plane security for conferencing\
33.328: G.1 General aspects**
[A conference server may send and receive cryptographically protected media
streams to and from participants as specified in clauses G.2 and G.3. In doing
so, the conference server shall use individual keys per participant (and per
media stream).]{.underline}
[NOTE: This means the conference server does not use group keys. This way, a
participant is only able to decrypt media sent to him during his presence in
the conference (but not media sent out by the media server to other
participants, e.g. before the participant joined or after he left the
conference).]{.underline}
[Once the conference URI has been created, the participants (including the
conference creator himself) join the conference using one of the methods
specified in TS 24.147 [25]:]{.underline}
[- The participant sends a SIP INVITE directly to the conference URI (how the
participant learns of the SIP URI is out of scope)]{.underline}
[- The conference creator or conference focus sends a SIP REFER to participant
which triggers the participant to send a SIP INVITE to the conference
URI]{.underline}
[- The conference creator instructs the conference focus (either via SIP REFER
or via the external interface) to send a SIP INVITE to the
participant]{.underline}
[Regardless of the method chosen the end result is always that a SIP INVITE is
sent from the participant to the conference URI or vice versa. From a media
security perspective, this situation is no different from a point-to-point
call between two UEs.]{.underline}
[The conference creator or a conference participant may subscribe to the
conference event package as described in RFC 4575 [26] using the stored
conference URI. Whenever there is a change to the conference state the
subscription service will notify the subscribers by sending a NOTIFY
request.]{.underline}
[]{.underline}
**33.328: G.2 Security for conferencing based on SIP signalling security**
[Two cases are considered in this subclause: e2ae security between UE and IMS
Access GW and e2e security between UE and conference server.]{.underline}
_[e2ae security:]{.underline}_
[When participating in conferences, IMS UEs may use e2ae security for RTP
based traffic and/or for MSRP, as specified in the main body of the present
document, and/or for BFCP, as specified in the following.]{.underline}
[For BFCP that may be used in conferences, e2ae security shall be supported in
the same way as for MSRP, as specified in the main body of the present
document. The only differences are:]{.underline}
> [1) e2ae security for BFCP uses individual indications \"e2ae-security for
> BFCP supported by the UE\" and \"e2ae-security for BFCP supported by the
> network\" during registration (the syntax is to be defined in the
> corresponding stage 3 specification); compare clause 7.1.2 .]{.underline}
>
> [2) In the SDP, security for a BFCP media stream is specified by using the
> transport "TCP/TLS/BFCP",]{.underline}
[NOTE 1: Application of e2ae security for RTP, MSRP and/or BFCP is not visible
to the conference server, which has therefore no assurance on how the
communication is secured over the access networks. The conference server
itself is assumed to be an MRF that is part of the IMS core network.
Protection of the interfaces of the conference server to other entities of the
IMS core can therefore rely on the security provided inside the IMS core (e.g.
by means of IPsec).]{.underline}
_[e2e security:]{.underline}_
[The conference server may support e2e security using SDES for RTP based media
between IMS UE and conference server as specified in clauses 7.2.2 and 7.3.2
of the present document. Usage of this type of security by the conference
server, i.e. accepting it when offered in incoming SDP offers (dial-in case)
and offering it in outgoing SDP offers (dial-out case) is subject to the
policies of the conference server.]{.underline}
[NOTE 2: e2e security between IMS UE and conference server does not imply e2e
security between two IMS UEs.]{.underline}
[It is outside the scope of the solution in the present clause whether the
conference server supports TLS for MSRP according to RFC 4975 [21] and/or for
BFCP according to RFC 4582 [23].]{.underline}
[NOTE 3: The conference server can request TLS for MSRP and/or for BFCP in SDP
offers it sends in outgoing SDP offers (dial-out case) and accept and perform
TLS when it is specified in incoming SDP offers (dial-in case). This depends
on the policies of the conference server. If the conference server is
configured not to use TLS, then MSRP and/or BFCP can still be protected by TLS
over the access network between an IMS Access GW and a participant according
to clause 7 and/ or the present clause of the present document, if the
participant and the network have negotiated using this protection over the
access network.]{.underline}
[NOTE 4: When the conference server uses SRTP/SDES for RTP based media, it has
no assurance where this protection is terminated and how the communication is
secured on the subsequent hops.]{.underline}
> [By means of the "P-Asserted-Identity" header, the conference server has
> assurance about the identity of the participants. A conference server may
> reject users trying to dial-in anonymously. In the dial-out case, by means
> of re-targeting an INVITE by the conference server may be answered by a user
> different from the invited user. The conference server may cancel the
> invitation of a participant if this participant's identity is not revealed,
> or if the participant is not allowed to join the conference according to the
> conference policies.]{.underline}
**33.328: G.3 Security for conferencing based on MIKEY-TICKET\ 33.328: G.3.1
Conference creation and policy control**
[The KMS based conferencing solution relies on an external interface between
the conference creator and the AS/MRFC for creating and managing conferences.
The interface should enable the conference creator to create new conference
URIs, set and update the list of authorized conference participants, and
change other conference settings. It may also be possible to allow other
conference participants to change the conference policy. The interface is not
considered part of IMS and will not be standardized. It would typically be
implemented as a web page or as a specific application on the UE.]{.underline}
[]{.underline}
[Figure Y1: Conference creation and policy control via external
interface]{.underline}
**33.328: G.3.2 User joining a secure conference**
[RTP and MSRP traffic shall be protected using MIKEY-TICKET in the same way as
specified in Clause 7.2.3 and 7.3.3. The only difference being that one of the
UEs is replaced by the conference focus. BFCP traffic shall be protected in
the same way as MSRP traffic, i.e. using a TLS tunnel established with MIKEY-
TICKET. In the SDP, security for BFCP is specified by using the transport
"TCP/TLS/BFCP".]{.underline}
[The conference focus shall verify that the UE identity (KMS UID) specified in
the MIKEY-TICKET exchange is authorized to join the conference.]{.underline}
**33.328: G.3.3 Subscribing to conference event package**
[Upon receipt of a SUBSCRIBE request, the conference notification service
shall verify that the sender is an authorized conference participant and,
provided the verification is successful, establish the subscription to the
conference state information. The state information carried in NOTIFY requests
shall be confidentiality and integrity protected using the pre-shared key
variant of S/MIME as described in Annex I.]{.underline}
[]{.underline}
**33.328: Annex H (normative): Setup of TLS-PSK using MIKEY-TICKET**
[Although MIKEY-TICKET [14] only specifies how to establish key data and
algorithm settings for the SRTP protocol, it can easily be extended to carry
the security parameters needed for setting up almost any kind of security
protocol. This Annex describes how MIKEY-TICKET is used to establish a PSK to
be used in a TLS-PSK handshake.]{.underline}
**\ 33.328: H.1 The TLS Prot Type**
[A Crypto Session (CS) in MIKEY-TICKET defines a security association for a
specific security protocol, and contains all the required security parameters,
such as key data and algorithm settings. Each CS is represented by an entry in
the CS ID map info field of the HDR payload. Such an entry has the following
format (assuming the GENERIC-ID map type is used):]{.underline}
> [0 1 2 3]{.underline}
>
> [0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0
> 1]{.underline}
>
>
> [+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+]{.underline}
>
> [! CS ID ! Prot type !S! #P ! Ps (OPTIONAL) \~]{.underline}
>
>
> [+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+]{.underline}
>
> [! Session Data Length ! Session Data (OPTIONAL) \~]{.underline}
>
>
> [+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+]{.underline}
>
> [! SPI Length ! SPI (OPTIONAL) \~]{.underline}
>
>
> [+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+]{.underline}
[]{.underline}
  * [ CS ID (8 bits): defines the CS ID to be used for the crypto session]{.underline}
  * [Prot Type (8 bits): defines the security protocol to be used for the crypto session. Shall be set to TLS.]{.underline}
  * [S (1 bit): flag that MAY be used by the Session Data. This flag is not used for the Prot Type TLS. The value must be set to \'0\', but shall be ignored by the receiver.]{.underline}
  * [#P (7 bits): indicates the number of security policies provided for the crypto session. For the Prot Type TLS, this value shall be set to 0. No security policy is required since negotiation of parameters is included in the TLS handshake.]{.underline}
  * [Ps (variable length): lists the policies for the crypto session. Since #P=0 for the Prot Type TLS, this field is omitted.]{.underline}
  * [Session Data Length (16 bits): the length of Session Data (in bytes). For the Prot Type TLS, the length shall be set to 0 as no additional session data is required.]{.underline}
  * [Session Data (variable length): contains session data for the crypto session. Since length is 0 for the Prot Type TLS, this field is omitted.]{.underline}
  * [SPI Length (8 bits): the length of SPI (in bytes). For the Prot Type TLS, the length can be set arbitrarily.]{.underline}
  * [SPI (variable length): the SPI corresponding to the session key to be used for the crypto session. The SPI identifies a specific TGK/GTGK that is used to derive the TEK for the crypto session (the SPI could also identify a TEK directly).]{.underline}
> [Editor's note: Setting #P=0 in both the init and response message is not
> allowed according to RFC 6043. There are two possible ways to get around
> this problem. Either we ignore the restriction in RFC 6043 (which really
> doesn\'t matter) or we specify a dummy Security Policy for TLS which does
> not contain any values.]{.underline}
>
> [Editor's note: The Prot Type TLS must be registered with IANA and the value
> is therefore TBD.]{.underline}
[]{.underline}
**33.328: H.2 Establishing a TLS connection**
[A CS with Prot Type TLS contains the necessary parameters to perform a TLS-
PSK handshake and establish a TLS connection over a reliable transport
association (such as a TCP connection). It is assumed that the transport
association can be used to identify the CS (e.g. a TCP connection maps to a
certain m line in the SDP which in turn maps to a CS). The parameters that
need to be input to the TLS implementation are the following:]{.underline}
  * [TLS client/server role: the role of each peer is negotiated by means outside of MIKEY-TICKET (e.g. as part of the establishment of the transport association in SDP). Typically, the client (server) in the transport protocol assumes the role of client (server) in the TLS protocol.]{.underline}
  * [The TLS ciphersuites shall be of type TLS_PSK and TLS shall be profiled as specified in TS 33.310 Annex E [AA] with the exception that ciphersuites using Diffie-Hellman shall not be used.]{.underline}
  * [PSK identity: this value is not used. The PSK identity is set to the empty string by the client and is ignored by the server.]{.underline}
  * [PSK identity hint: this value is not used. The identity hint is an optional value provided by the server in the server hello message.]{.underline}
  * [PSK: The PSK is the TEK associated with the CS. The SPI in the CS points to a TGK or GTGK from which the TEK is derived using the CS ID (and some other parameters). The SPI could also point to a TEK directly.]{.underline}
> []{.underline}
**33.328: H.3 Usage with SDP**
[The TLS CS defined above can be used to establish a TLS connection using the
PSK-TLS ciphersuite. The only piece missing is to show how an m-line using a
protocol of the form X/TLS/Y (e.g., TCP/TLS/MSRP or TCP/TLS/BFCP) is mapped to
such a CS.]{.underline}
[RFC 5246 describes how the key-mgmt attribute is used to perform a MIKEY-
TICKET exchange in SDP and how an m-line can be mapped to set of SRTP CSs (one
for each SSRC). If the key-mgmt attribute is used at session level then the
MIKEY-TICKET exchange contains CSs for all the m-lines in the SDP and the
mapping is based on the order of the m-lines. If the key-mgmt attribute is
used at the media level then the CSB only contains the CSs for that m-line.
Mixing of session and media level attributes is allowed by 5246 but the
expected behaviour is not well defined. Another restriction is that the
offerer must know how many SSRCs that the answerer will use for a particular
m-line.]{.underline}
[The mapping between an X/TLS/Y m-line and a TLS CS is done in the same way as
the mapping between and SRTP m-line and a set of SRTP CSs. The only difference
is that there is exactly one CS per m-line. ]{.underline}
[]{.underline}
**33.328: Annex I (normative): Pre-shared key MIME protection**
[Editor's Note: This Annex was added to enable other clauses to refer to it.
It will be filled with text later.]{.underline}
[]{.underline}
**33.328: Annex J: IANA considerations\ 33.328: J.1 IANA assignments**
**[This clause defines several new values for the namespace Prot Type defined
in IETF RFC 3830 [11]. IANA is requested to record the assignments in Table X
to the namespace Prot Type in the MIKEY payload registry. The Prot Types can
be used by any MIKEY mode.]{.underline}**
[Table J: Prot Type (Additions)]{.underline}
* * *
[Type]{.underline} [Value]{.underline} [Comments]{.underline}
[TLS]{.underline} [TBD1]{.underline} [TLS-PSK]{.underline} []{.underline}
[]{.underline} []{.underline} [PSK S/MIME]{.underline} [TBD2]{.underline} [See
Annex Y]{.underline} []{.underline} []{.underline} []{.underline} [Application
Specific]{.underline} [TBD3]{.underline} [Application Specific]{.underline}
[]{.underline} []{.underline} []{.underline}
* * *
[]{.underline}
**[TLS: This Prot Type provides a pre-shared key (TEK) to be used in pre-
shared key ciphersuites for (D)TLS as specified in Annex H.]{.underline}**
**[PSK S/MIME: This Prot Type provides a pre-shared key (TEK) to be used to
protect MIME content as specified in Annex Y.]{.underline}**
**[Application Specific: This Prot Type provides pre-shared key(s) to be used
in an application specific security protocol. Security policies (SP payloads)
shall not be associated with the Crypto Session (CS).]{.underline}**
[Editor's note: The values TBD1, TBD2, and TBD3 will later be replaced with
values assigned by IANA.]{.underline}
[]{.underline}
**33.328: Annex L (normative): IMS media plane security for T.38 fax\ **
**33.328: L.1 Introduction**
[The transmission of fax over IP networks is specified in the ITU-T
recommendation T.38 [34] and uses either TCP or UDP for transport. T.38 allows
transmission of fax over IP networks in real time and allows interworking with
the legacy PSTN T.30 fax protocol. For the TCP transport, IFP (Internet Fax
Protocol) is encapsulated in TPKT. For the UDP transport, IFP data is
encapsulated in either UDPTL (UDP Transport Layer) or RTP. The purpose of
UDPTL and RTP is to provide sequence numbering and packet redundancy (to cope
with packet loss).]{.underline}
[UDPTL (UDP Transport Layer) is the predominant means for transporting T.38.
For IMS, a profile of T.38 fax is specified in Annex L of TS 26.114 [27]. This
profile only supports UDPTL/UDP transport. The packet structure for UDPTL
based T.38 fax is shown in Figure L-1.]{.underline}
[]{.underline}
[Figure L--1: Packet structure for UDPTL based T.38 fax transmission
[34]]{.underline}
[A T.38 fax call is established in SIP/SDP similar to how an audio or
messaging session is established. Figure L-2 shows how the SDP media line is
constructed in case of UDPTL/UDP transport.]{.underline}
[]{.underline}
> m=image 49170 udptl t38
>
> a=...
[Figure L-2: Example SDP offer forT.38 fax transmission using UDPTL/UDP
transport\ (non-relevant parts of the SDP offer have been
excluded)]{.underline}
[]{.underline}
**33.328: L.2 Use cases**
[As fax has a special legal status in many countries and enjoys continuing
support, specification of secure fax is important. As most faxes are still
connected to PSTN, the primary use case is seen as a fax call between an IMS
UE and a PSTN/CS fax terminal. In order to support this use case media
protection needs to start at the IMS UE and be terminated before or at the
PSTN GW. Fax calls between two IMS UEs is another possibility but is not as
common, and in this case there exist other alternatives like attaching the fax
in an email or instant message using ITU-T recommendation T.37.]{.underline}
[]{.underline}
**33.328: L.3 e2ae security for T.38 fax using DTLS**
[T.38 fax using UDPTL/UDP transport shall be secured e2ae between IMS UE and
IMS-AGW by usage of DTLS (RFC 6347 [36]). The transport protocol identifier
\"UDP/TLS/UDPTL\" and the usage of UDPTL over DTLS are defined in
[37].]{.underline}
[The solution leverages IMS control plane security by using self-signed
certificates and exchanging the certificate fingerprints via SIP/SDP. Usage of
the \"P-Asserted-Identity\" header provides secure identification of the other
endpoint. The solution is almost identical to MSRP e2ae security specified in
this document, but uses DTLS instead of TLS for confidentiality and integrity
protection.]{.underline}
[Support for e2ae security for T.38 shall be indicated during registration in
the same way as specified for RTP and MSRP based media. The indication shall
be done independently from the indication of support for e2ae security for RTP
or MSRP based media, and shall use its own indications \"e2ae-security for
T.38 supported by the UE\" and \"e2ae-security for T.38 supported by the
network\" (the syntax is to be defined in the corresponding stage 3
specification).]{.underline}
[The originating IMS UE shall set the transport identifier to
\"UDP/TLS/UDPTL\" and include the SDP fingerprint attribute in the SDP offer.
Moreover, the IMS UE adds an SDP attribute \"e2ae-security requested by UE\"
indicating the request for e2ae security to the description of the T.38 fax
call. The network shall insert the IMS access gateway into the media path and
properly terminate DTLS, using its own certificate (the fingerprint of this
certificate is returned to the originating IMS UE in the SDP answer). From the
IMS access gateway in the direction towards the terminating IMS UE, plain UDP
may be used on the next hops, assuming that the interfaces are
protected.]{.underline}
[Editor's Note: The reference [UDPTL-DTLS] should be updated once it becomes
an approved RFC.]{.underline}
[]{.underline}
###### ### Annex C: Interworking between sessmatch and CEMA
# C.1 Scope
The present Annex describes procedures for the interworking between MSRP with
the CEMA extension, IETF RFC 6714 [9], and MSRP with the sessmatch extension,
IETF draft-ietf-simple-msrp-sessmatch-10 [13].\ Further information on those
MSRP extensions is provided in clauses 4.1.2 and 4.1.4. Both, the interworking
between different networks that each uses only one of these extensions and the
interworking between terminals using different extensions within one network
are being considered.
# C.2 MSRP Interworking Function
If any entity (e.g. a session border controller (SBC)) that exchanges IP
addresses and ports of user plane IP packets but does not manipulate the MSRP
protocol layer is in the user plane between an MSRP client using the sessmatch
extension and an MSRP client using the CEMA extension, those clients cannot
interoperate. This is explained in the subsequent figures C.2.1 and C.2.2.
NOTE 1: For the purpose of this Annex, the term \"session border controller\"
(SBC) refers to SIP/SDP level B2BUA in combination with a user plane gateway
that terminates or modifies the IP and TCP layers but does not modify the MSRP
protocol layer. The SBC thus is a \"media relay signalling/media plane B2BUA\"
according to IETF RFC 7092 [39].\ An SBC can be one entity (integrated SBC) or
comply with the H.248 gateway model (decomposed SBC). An IBCF with a TrGW or
an IMS-ALG with an IMS-AGW can thus act as an SBC.
NOTE 2: If no SBC is between them, an MSRP client using the sessmatch
extension and an MSRP client using the CEMA extension can interoperate.
Figure C.2.1: MSRP Communication Failure between MSRP CEMA client and MSRP
sessmatch client if SBC without MSRP user plane manipulation capabilities
modifies SDP a=path attribute
Figure C.2.2: MSRP Communication Failure between MSRP CEMA client and MSRP
sessmatch client if SBC without MSRP user plane manipulation capabilities does
not modify SDP a=path attribute
As a consequence, an interworking function that manipulates the MSRP protocol
layer in the user plane is required to enable communication between an MSRP
CEMA client and MSRP sessmatch client if any SBC without MSRP user plane
manipulation capabilities are in the path. This is shown in figure C.2.3.
The MSRP interworking function (MSRP IWF) manipulates the SDP \"a=path\"
attribute (part of MSRP IWF \"signalling plane\") as well as the MSRP \"To-
Path\" in the user plane (part of MSRP IWF \"media plane\") by inserting its
own address information.
NOTE 3: For the purpose of this Annex, the term \"MSRP interworking function\"
(MSRP IWF) refers to SIP/SDP level B2BUA in combination with a user plane
gateway that terminates or modifies the IP, TCP and MSRP layers, and which
manipulates the SDP \"a=path\" attribute as well as the MSRP \"To-Path\" in
the user plane by inserting its own address information. The MSRP IWF thus is
a \"media termination signalling/media plane B2BUA\" according to IETF RFC
7092 [39]. An MSRP IWF can be one entity or comply with the H.248 gateway
model. However, the relationship of the MGW part of the MSRP IWF (the MSRP IWF
\"media plane\") (for an MSRP IWF that complies with the H.248 gateway model)
and the bearer-level application level gateway (B-ALG) function, as described
by ITU-T H.248.78 [33], is not considered in this annex.\ The MSRP
interworking function\" (MSRP IWF) can reside in a CPM Participating Function
or CPM Interworking Function as defined in OMA-TS-CPM_Conversation_Function-V2
[30], in an IMS-ALG and IMS-AGW, or in an IBCF and TrGW.
NOTE 4: As an alternative to deploying some dedicated MSRP interworking
functions in a network, all SBC in a network could be enhanced to become MSRP
IWFs (making the MSRP sessmatch or CEMA extensions obsolete).
**Figure C.2.3: MSRP Interworking function enables Communication between MSRP
CEMA client and MSRP sessmatch client when SBC without MSRP user plane
manipulation capabilities are in the path**
In figure C.2.3 SBC 1 does not manipulate the SDP \"a=path\" attribute (as
appropriate for the MSRP CEMA extension according to table 4.1.4-1), but SBC 2
manipulates the SDP \"a=path\" attribute (as appropriate for the MSRP
sessmatch extension according to table 4.1.4-1), clause C.3 discusses how the
SBC select the appropriate behaviour.
The MSRP IWF can determine in one of the following ways which MSRP variant to
use at a call leg:
1\. based on configuration (e.g. if located at a network boundary);
2\. based on UE capabilities stored when the UE registers (e.g. if the MSRP
IWF is located in the P-CSCF); or
NOTE 5: Appropriate SIP signalling extensions to convey the related UE
capabilities during registration would need to be standardised.
3\. in a dynamic manner during the session setup using the \"a=msrp-cema\" SDP
attribute.
The MSRP IWF \"signalling plane\" part that uses variant 3 above applies the
following procedure:
\- When receiving an SDP offer, the MSRP IWF uses the MSRP CEMA extension
towards the corresponding call leg if the \"a=msrp-cema\" SDP attribute is
within the SDP offer, otherwise the MSRP IWF uses the MSRP sessmatch
extension.
\- When sending an SDP offer, the MSRP IWF includes the \"a=msrp-cema\" SDP
attribute; when receiving the corresponding SDP answer, the MSRP IWF uses the
MSRP CEMA extension toward the corresponding call leg if the \"a=msrp-cema\"
SDP attribute is within the SDP answer and otherwise the MSRP sessmatch
extension. If the \"a=msrp-cema\" SDP attribute is not contained in the SDP
answer and the SDP c/m-line address information does not match the \"a=path\"
attribute, the MSRP IWF sends a new SDP offer without the \"a=msrp-cema\" SDP
attribute according to IETF RFC 6714 [9] procedures.
NOTE 6: If the MSRP IWF received an SDP offer containing the \"a=msrp-cema\"
SDP attribute, it can wait until receiving the SDP answer before determining
if it needs to insert an MSRP B2BUA into the user plane; if receiving an SDP
answer without the \"a=msrp-cema\" SDP attribute, the MSRP IWF inserts an MSRP
B2BUA into the user plane and provides appropriate information within the
second SDP offer it sends.
NOTE 7: IETF RFC 6714 [9] procedures request that an MSRP endpoint falls back
to IETF RFC 4975 [6] behaviour rather than using the MSRP sessmatch extension
when not receiving \"a=msrp-cema\" SDP attribute. However, an MSRP IWF
applying the MSRP sessmatch extension can interoperate with an IETF RFC 4975
MSRP endpoint if no SBC is between them. (The MSRP IWF could not interoperate
with an IETF RFC 4975 MSRP endpoint with an SBC is between them even if
falling back to IETF RFC 4975 [6].)
NOTE 8: The second SDP offer can be omitted if the MSRP IWF knows that here is
no SBC in the path (e.g., between P‑CSCF (IMS‑ALG) acting as MSRP IWF and the
UE).
# C.3 Procedures for SBC without User Plane MSRP B2BUA
As shown in clause C.2 and table 4.1.4-1 SBCs without MSRP user plane
manipulation capabilities need to manipulate the SDP \"a=path\" attribute for
MSRP sessmatch clients, and must not modify the SDP \"a=path\" attribute for
MSRP CEMA clients.
If only one type of MSRP client is supported in a network, SBCs can be
configured with the appropriate behaviour. Otherwise, MSRP clients need to
determine dynamically the appropriate behaviour.
SBCs can use the following algorithm to determine the appropriate behaviour in
a dynamic manner:
\- When the \"a=msrp-cema\" SDP attribute is contained in an SDP offer, the
SBC does not modify the \"a=path\" attribute in the SDP offer. The SBC then
also does not modify the \"a=path\" SDP attribute in the corresponding SDP
answer (even if the \"a=msrp-cema\" SDP attribute is not contained in the
answer).
NOTE: If the \"a=msrp-cema\" SDP attribute is not contained in the SDP answer
and the \"a=path\" SDP attribute is not modified, the offerer will discover a
mismatch and send a new SDP offer without the \"a=msrp-cema\" SDP attribute
according to IETF RFC 6714 [9] procedures. The situation should only occur if
an MSRP IWF according to clause C.2 is acting as SDP offerer.
\- When the \"a=msrp-cema\" SDP attribute is not contained in an SDP offer,
the SBC modifies the \"a=path\" attribute in the SDP offer. The SBC then also
modifies the \"a=path\" SDP attribute in the corresponding SDP answer.
###### ### Annex D: Preventing TLS establishment collision without a TLS B2BUA
This annex defines a solution, which allows both UEs to establish TCP
connections, while only one UE acts as TLS client, by allowing both the
\"active\" and \"passive\" UE to initiate TCP connections, while only the
\"active\" UE acts as TLS client (according to the procedure in IETF RFC 4572
[14]). This will remove the need for a TLS B2BUA in the network, as there will
be no TLS establishment collision.
In order to know whether the UE support the suggested mechanism, an indicator
will have to be defined to indicate that the UE that supports the procedures
in IETF RFC 6135 [8], and is located behind firewalls, supports the
establishment of a TCP connection even if it became \"passive\" as part of the
TCP connection setup direction negotiation, as defined in IETF RFC 4145 [12].
NOTE 1: If the proposed solution is agreed, the new indicator should be
defined during development of the 3GPP stage 3 technical specifications. For
example it could be a SIP media feature tag which UEs can include in SIP
requests to inform support of the mechanism.
NOTE 2: The solution defined in this Annex was not further discussed nor
agreed upon in 3GPP CT WG1 (the major impacts are on the UE and the SIP/SDP
signalling plane).
###### ### Annex E: Example end-to-end network scenario
# E.1 Scope
The aspects of NAT traversal, multiple IP address realms, trusted/untrusted
network domains, TCP bearer connection establishment performance, etc. require
the consideration of end-to-end scenarios. This Annex provides an example,
which allows to point out such characteristics. Primary scope are TCP related
aspects, less TLS considerations. Thus, the example scenario is application
agnostic.
The same example end-to-end network scenario is distributed over two clauses
in order not to overload the illustrations (clause E.2 introduces the example
end-to-end configuration from perspective of IP address domains and clause E.3
provides then the aspects of TCP bearer connection establishment).
# E.2 Aspect of IP realms
Figure E.2.1 depicts the example end-to-end network scenario for a TCP-based
communication service between two parties X and Y. Each IP host (as UE) is
located in a home network domain, connected via a NAT device to the access
network (AN) domain and an IMS-AGW. The TCP bearer path is traversing three
TrGWs at core network (CN) level. Resulting in eight IP realms in overall due
to the assumption of enforced NA(P)T functions in all five MGWs. Thus, there
are seven network elements within the end-to-end media path which provide a
_NA(P)T function_ (two NAT devices and five MGWs). _NAT traversal support
functions_ are provided by all five MGWs (thus, NAT-T support is a local
function from MGW perspective).
The two TCP endpoints of the end-to-end TCP bearer path are located in IP
hosts X and Y. The end-to-end TCP bearer path is divided in six TCP bearer
connection segments. Each MGW interconnects two TCP bearer connection segments
(see clause 4.4.4).
L3/L4 level NAT traversal aspects:
\- UE~X~: example of \"TCP simultaneous open\" (i.e., H.248.84 \"TCP merge\"
mode support) in order to traverse NAT~X~;
\- UE~Y~: located behind NAT~Y~, which for instance allows to traverse it in
both directions, i.e., also in network-to-UE direction;
L4+ level NAT traversal aspects:
\- When media \'MSRP\', then the IMS-AGWs could be required to provide an
bearer-level application gateway function (as described in ITU-T H.248.78
[33]) in order to address the problem indicated in Annex C.
Media security aspects:
\- UE~Y~: example of enabled e2ae media security, i.e., a TLS security session
between MGW~5~ and UE~Y~;
Network operator perspective:
\- one UE might be located in a non-3GPP defined network, which is
interconnected by an IBCF/TrGW 3GPP core network. This example configuration
is not shown in Figure E.2.1.
Figure E.2.1: Example end-to-end network scenario\ (Here: partitioning in
(eight) network domains with respect to IP address realms)
# E.3 Aspect of TCP bearer connection establishment
Figure E.3.1 illustrates again the same end-to-end network configuration. This
clause focuses on the TCP bearer connection only (aspects related to TLS as
well as IP application protocols are excluded from the discussion here).
Further, only the communication establishment phase is considered.
MGC-local policies (see clause 4.5) are illustrated in Figure E.3.1. For
instance, MGC~1~ could know the address translation behaviour of NAT~X~ (NAT
policy) and know security issues with home network domain X (e.g., due to a
recently located security attack from this domain) (security policy). And
MGC~2~ might be absolutely unaware of the specific behaviour of NAT~Y~ (NAT
policy).
Whether the call is initiated by UE~X~ or UE~Y~ or by both in parallel is not
considered. Thus, the SIP-level SDP Offer/Answer cycles and H.248 command
request/reply cycles are just indicated at high-level in Figure E.3.1.
Discussion:
\- L3/L4 level NAT-T is resulting in following TCP modes (during TCP bearer
connection establishment) in the five MGWs:
\- TCP merge mode: MGW~1~;
> NOTE 1: This is just one option, actually the TCP merge function could be
> principally provided by all five MGWs, see H.248.84 [24]. It should be also
> emphasized that the call establishment direction is not outlined in this
> example.
\- TCP relay mode: MGW~2~, MGW~3~, MGW~4~;
\- TCP proxy mode: MGW~5~\ (in more detail: the TCP proxy variant would be
\"L4+ aware\" (due to TLS session termination) and possibly \"lightweight\"
(dependent on TCP bearer connection establishment configuration));
\- End-to-end TCP bearer connection:
\- there are thus effectively two TCP bearer connection segments (UE~X~ to
MGW~5~ and MGW~5~ to UE~Y~) due to the nature of \"TCP proxy\" behaviour;
\- the TCP bearer connection establishment process is normally immediately
started, as early as possible (in order to minimize end-to-end connectivity
establishment delay), but the IMS-AGWs in the example here might shortly delay
that process (dependent on SDP Offer/Answer signalling, single or two-stage
H.248 command cycles (see below) and potential security attacks (see e.g.
clause 12 on security considerations in H.248.89 [36]));
\- TCP flow control aspects:
\- see clause E.4;
\- SDP Offer/Answer:
\- 3GPP TS 24.229 [5] limits the indication and negotiation of the media
configuration to a single end-to-end cycle;
\- the indicated SIP servers (as P-CSCF/IMS-ALG and IBCF) acting as SIP B2BUA,
i.e., could break the end-to-end SDP Offer/Answer negotiations.
\- H.248 command request/reply cycles (MGC to MGW):
\- triggered by incoming SIP messages;
\- creation of H.248 context and TCP-enabled H.248 termination could be
a) already started with the \"initial SDP offer\", and then concluded in a
2^nd^ cycle with the SDP answer (NOTE), or
b) in a single cycle when all relevant information would be available.
\- it\'s up to the MGC to trade-off \"early media connectivity\" versus
\"signalling cycles, etc\"
\- TLS security session: at this high-level of the example,
\- the TLS session establishment direction might be the same or the opposite
as the TCP bearer connection establishment direction (e.g., dependent on IP
application protocol);
\- the TLS session establishment process is considered to be tightly coupled
to the TCP bearer connection establishment process (in Rel-12).
NOTE 2: The two H.248 cycles relate to an ADD and MODIFY phase. The actual TCP
bearer connection establishment may be delayed till the MODIFY step.
Figure E.3.1: Example end-to-end network scenario - Aspect of TCP bearer
connection establishment\ (Signalling cycles are only indicated at high level)
# E.4 Aspects of TCP flow control
## E.4.1 Overview
TCP flow control is considered in more detail for the example in Figure E.3.1.
TCP flow control handling by MGWs is dependent on the TCP mode.
## E.4.2 TCP flow control during establishment phase
### E.4.2.1 Without early application data
The scenario where the L4+ protocol (e.g., TLS) is just starting to send TCP
data when the TCP endpoint is in connection state \"ESTAB\", i.e., after the
establishment phase. The MGWs does consequently not need to buffer any TCP
data.
TCP flow control becomes effectively only the handling of TCP SN/AN numbers by
the MGWs:
\- TCP merge mode (MGW~1~): according to H.248.84 [24] (i.e., TCP SN/AN
numbers are adapted in order to realize a TCP simultaneous open);
\- TCP relay mode (MGW~2~, MGW~3~, MGW~4~): pure forwarding of TCP packets;
\- TCP proxy mode (MGW~5~): TCP SN/AN number handling according TCP three-way
handshake procedures at each TCP endpoint;
### E.4.2.2 With early application data
As indicated in clause 4.3.1, a remote TCP endpoint (here UE~X~ and UE~Y~)
could principally send TCP application data already during the establishment
phase. Clause 4.3.1 is also indicating that the MGW could just discard such
data (i.e., not buffering). In more detail:
\- TCP merge mode (MGW~1~): discard data (note: the TCP simultaneous open
provided according to H.248.84 [24] is based on the manipulation of TCP SN
numbers and not the TCP AN numbers);
\- TCP relay mode (MGW~2~, MGW~3~, MGW~4~): pure forwarding of TCP packets,
also TCP packets with piggybacked data;
\- TCP proxy mode (MGW~5~): discard data.
It is immanent that a TCP proxy discarding TCP data has to indicate such
\"loss\" via TCP AN acknowledgement process towards the remote TCP endpoint.
## E.4.3 TCP flow control during active data transfer phase
There will be following TCP modes in this example after successful end-to-end
TCP bearer connection establishment, resulting in following TCP flow control
behaviour:
\- TCP relay mode (MGW~1~, MGW~2~, MGW~3~, MGW~4~): pure forwarding of TCP
packets;
\- TCP proxy mode (MGW~5~): the concrete TCP flow control behaviour for TCP
proxies (and its TCP proxy variants) is out of scope of standards, rather
implementation specific (NOTE).
NOTE: For instance, MGW~5~ could provide following TCP flow control
behaviour:\ a) during TLS security session establishment: normal TCP flow
control (incl. buffering) towards TLS endpoint in UE~Y~;\ b) after successful
TLS security session establishment: either TCP flow control (\"most
expensive\") or trying to optimize by minizing the buffering of data
(\"conditional option\").
###### ### Annex F: Example traffic flow (communication establishment phase)
# F.1 Scope
The purpose of this Annex is to illustrate example traffic flows in control
plane (i.e., signalling flows for H.248, but also SIP) and user plane (i.e.,
IP packet flows at the level of TCP and TLS, thus, upper protocol layers are
not considered).
The traffic flow examples provide complementary information to the main body
of this TR, but does not represent specific stage 2 procedural information.
In order not to overload the examples, the example of TCP bearer connection
establishment without TLS (i.e., non-TLS to non-TLS interworking) is subject
of a self-contained clause F.2. clause F.3 indicates an example for TLS
security session establishment.
Figure F.1.1 depicts the general H.248 Context model:
Figure F.1.1: H.248 Context Model for the example of an end-to-end TCP media
path\ between UE~X~ and UE~Y~
# F.2 TCP bearer connection establishment (example)
Figure F.2.1 illustrates a typical traffic flow at the establishment phase of
an end-to-end TCP bearer connection. Only the general principles are high-
lighted; and L4+ protocols (such as possibly TLS) are omitted in this example.
The example represents therefore an application protocol agnostic scenario.
There are many variations of this example, dependent on L3/L4 level NAT-T, L4+
level NAT-T, TCP interworking (TCP modes), SIP level SDP offer/answer, etc.
Figure F.2.1: Establishment of end-to-end TCP connection (example traffic
flows)
Some information to the example of Figure F.2.1:
1\. The IMS-ALG receives an SDP offer in SIP signalling for TCP-based media.
The TCP bearer connection establishment direction is not yet decided.
2\. The IMS-ALG sends a H.248 ADD request command to create the first TCP-
enabled termination. Only minimum information could be provided to the IMS-AGW
as neither the TCP bearer connection establishment directions towards UE~X~
and UE~Y~ is yet decided.
3\. The IMS-AGW creates the termination T1.
4\. The IMS-AGW replies to IMS-ALG with a H.248 ADD reply command and provides
the local source IP transport address of the termination.
5., 6., 7. Similar steps for termination T2 (it should be reiterated that this
is only one example option).
8\. The IMS-ALG modifies the SDP offer (option).
9\. The IMS-ALG forwards the new SDP offer to the succeeding node (in
direction towards UE~Y~).
10\. The SDP answer is received by IMS-ALG. In this example UE~Y~ selects the
TCP server role.
11\. The IMS-ALG decides the TCP mode which includes a possible modification
of the SDP answer. In this example a \"TCP proxy\" mode is determined with an
incoming TCP bearer connection establishment at T1 and an outgoing TCP bearer
connection establishment at T2.
12\. The IMS-ALG sends a H.248 MOD request command to complete the information
for the outgoing termination T2 and the request of initiating a TCP bearer
connection establishment procedure.
13\. The IMS-ALG forwards the new SDP answer to towards UE~X~.
14\. The IMS-AGW configures the termination T2.
15\. The IMS-AGW replies to IMS-ALG with a H.248 MOD reply command.
16\. TCP three-way handshake (NOTE)
17\. Established state of TCP bearer connection segment towards UE~Y~.
18\. The IMS-ALG sends a H.248 MOD request command to complete the information
for the termination T1 and the preparation of an incoming TCP bearer
connection establishment procedure.
19\. The IMS-AGW configures the termination T1.
20\. The IMS-AGW replies to IMS-ALG with a H.248 MOD reply command.
21\. TCP three-way handshake (NOTE).
22\. Established state of TCP bearer connection segment towards UE~X~.
23\. The IMS-AGW has internally the cut-through of the TCP connection legs
completed.
24\. Optional: the IMS-AGW notifies the successfully established end-to-end
TCP bearer connection. The IMS-ALG is aware of successful L3/L4 NAT traversal
functions and end-to-end L4 media connectivity.
25\. The actual TCP data transfer phase may start.
NOTE 1: The two TCP three-way handshake procedures (16 and 21) are decoupled
in this example due to the TCP proxy mode (see 11). Thus, an example where the
end-to-end TCP bearer connection is separated in two segments (e.g., in case
of e2ae media security).
NOTE 2: See clause 5.2 for the actual call flows and H.248 signalling
elements.
# F.3 TLS security session establishment (example)
See clause 5.2.
#